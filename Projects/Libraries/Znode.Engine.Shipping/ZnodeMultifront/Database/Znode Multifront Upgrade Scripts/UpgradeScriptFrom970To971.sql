IF EXISTS (SELECT TOP 1 1 FROM Sys.Tables WHERE Name = 'ZnodeMultifront')
BEGIN 
IF EXISTS (SELECT TOP 1 1 FROM ZnodeMultifront where BuildVersion =   971 and VersionName = 'Znode_Multifront_9_7_1_GA' )
BEGIN 
PRINT 'Script is already executed....'
 SET NOEXEC ON 
END 
END
ELSE 
BEGIN 
  SET NOEXEC ON
END 
INSERT INTO [dbo].[ZnodeMultifront] ( [VersionName], [Descriptions], [MajorVersion], [MinorVersion], [LowerVersion], [BuildVersion], [PatchIndex], [CreatedBy], 
[CreatedDate], [ModifiedBy], [ModifiedDate]) 
VALUES ( N'Znode_Multifront_9_7_1_GA', N'Upgrade GA Release by 971',9,7,1,971,0,2, GETDATE(),2, GETDATE())
GO 
SET ANSI_NULLS ON
GO


DECLARE @PimAttributeId INT=(SELECT PimAttributeId FROM ZnodePimAttribute WHERE IsCategory = 0 AND AttributeCode='OutOfStockOptions');
DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
INSERT INTO dbo.ZnodeOmsOrderAttribute
(OmsOrderLineItemsId,AttributeCode,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AttributeValueCode)
SELECT DISTINCT OLI.OmsOrderLineItemsId,PA.AttributeCode,ADV.AttributeDefaultValueCode,2,@GetDate,2,@GetDate,ADV.AttributeDefaultValueCode
FROM ZnodeOmsOrder O WITH (NOLOCK)
INNER JOIN ZnodeOmsOrderDetails OD WITH (NOLOCK) ON O.OmsOrderId=OD.OmsOrderId
INNER JOIN ZnodeOmsOrderLineItems OLI WITH (NOLOCK) ON OD.OmsOrderDetailsId=OLI.OmsOrderDetailsId
INNER JOIN View_LoadManageProduct LMP WITH (NOLOCK) ON LMP.AttributeCode ='SKU' AND OLI.Sku=LMP.AttributeValue
INNER JOIN ZnodePimAttribute PA WITH (NOLOCK) ON PA.PimAttributeId=@PimAttributeId
INNER JOIN ZnodePimAttributeValue AV WITH (NOLOCK) ON AV.PimAttributeId=@PimAttributeId AND lmp.PimProductId=av.PimProductId
INNER JOIN ZnodePimProductAttributeDefaultValue AVL WITH (NOLOCK) ON AVL.PimAttributeValueId=AV.PimAttributeValueId
INNER JOIN ZnodePimAttributeDefaultValue ADV WITH (NOLOCK) ON ADV.PimAttributeId=PA.PimAttributeId
	AND ADV.PimAttributeDefaultValueId=AVL.PimAttributeDefaultValueId
WHERE NOT EXISTS (SELECT * FROM ZnodeOmsOrderAttribute zoal WHERE oli.OmsOrderLineItemsId=zoal.OmsOrderLineItemsId
					AND zoal.AttributeCode='OutOfStockOptions');

UPDATE OLI
SET OLI.BundleQuantity=BPE.AssociatedProductBundleQuantity
FROM ZnodeOmsOrderLineItems OLI
INNER JOIN ZnodeOmsOrderDetails OD ON OD.OmsOrderDetailsId=OLI.OmsOrderDetailsId
INNER JOIN ZnodeOmsOrder O ON O.OmsOrderId=OD.OmsOrderId
INNER JOIN View_LoadManageProduct LMP ON LMP.AttributeCode ='SKU' AND OLI.Sku=LMP.AttributeValue
INNER JOIN ZnodePublishProduct PP ON LMP.PimProductId=PP.PimProductId
INNER JOIN ZnodeOmsOrderLineItemRelationshipType OLIRT WITH (NOLOCK) ON OLIRT.OrderLineItemRelationshipTypeId=OLI.OrderLineItemRelationshipTypeId
	AND OLIRT.Name='Bundles'
INNER JOIN
(
	SELECT VersionId,AssociatedZnodeProductId,ROW_NUMBER() OVER (PARTITION BY AssociatedZnodeProductId ORDER BY VersionId DESC) As Rn,AssociatedProductBundleQuantity
	FROM ZnodePublishBundleProductEntity
) BPE ON BPE.AssociatedZnodeProductId=PP.PublishProductId AND BPE.Rn=1
WHERE OLI.BundleQuantity IS NULL;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertSaveCartLineItemsForReOrder')
	DROP PROC Znode_InsertSaveCartLineItemsForReOrder
GO


CREATE PROCEDURE [dbo].[Znode_InsertSaveCartLineItemsForReOrder] 
(
	@OmsOrderId INT, 
	@OmsSavedCartId INT ,
	@UserId INT ,
	@OmsOrderLineItemsId INT = 0,
	@Status BIT = 0 OUT
)
AS 
BEGIN 
BEGIN TRY 
  SET NOCOUNT ON 
  DECLARE @TBL_ZnodeOmsSavedCartLineItem TABLE (OmsSavedCartLineItemId INT , RowId INT  )
  DECLARE @GetDate DATETIME = dbo.FN_getDate() 
  DECLARE @AddOnOrderLineItemRelationshipTypeId INT = (SELECT TOP 1 OrderLineItemRelationshipTypeId 
															FROM ZnodeOmsOrderLineItemRelationshipType
															WHERE Name = 'Addons')

   DECLARE @BundleOrderLineItemRelationshipTypeId INT = (SELECT TOP 1 OrderLineItemRelationshipTypeId 
															FROM ZnodeOmsOrderLineItemRelationshipType
															WHERE Name = 'Bundles')

   CREATE TABLE #ZnodeOmsOrderLineItems_temp (OmsOrderLineItemsId INT ,ParentOmsOrderLineItemsId INT,OmsOrderDetailsId INT , SKU  NVARCHAr(2000),
   OrderLineItemRelationshipTypeID INT ,AutoAddonSKU NVARCHAR(400),Custom1 NVARCHAR(MAX),Custom2 NVARCHAR(MAX),Custom3 NVARCHAR(MAX),Custom4 NVARCHAR(MAX)
   ,Custom5 NVARCHAR(MAX), GroupId nvarchar(MAX),ProductName NVARCHAr(2000), Description nvarchar(MAX),Quantity NUMERIC(28,6), ROWID INT, ParentRowID INT)

  IF EXISTS (SELECT TOP 1 OmsOrderDetailsId  FROM ZnodeOmsOrderDetails WHERE  OmsOrderId =  @OmsOrderId AND IsActive =1 )
  BEGIN 

	  ;WITH CTE_OrderData AS
	  (
		  SELECT MIN(OmsOrderLineItemsId) AS OmsOrderLineItemsId, MIN(ParentOmsOrderLineItemsId) AS ParentOmsOrderLineItemsId,OmsOrderDetailsId,SKU,OrderLineItemRelationshipTypeID,AutoAddonSKU,
			  Custom1,Custom2,Custom3,Custom4,
			  Custom5,GroupId,ProductName,Description,SUM(Quantity) AS Quantity
		  FROM ZnodeOmsOrderLineItems WITH (NOLOCK)
		  WHERE  OmsOrderDetailsId = (SELECT TOP 1 OmsOrderDetailsId  FROM ZnodeOmsOrderDetails WHERE  OmsOrderId =  @OmsOrderId AND IsActive =1 ) 
		  GROUP BY OmsOrderDetailsId,SKU,OrderLineItemRelationshipTypeID,AutoAddonSKU,
			Custom1,Custom2,Custom3,Custom4, Custom5,GroupId,ProductName,Description
	  )
	  INSERT INTO #ZnodeOmsOrderLineItems_temp
	  SELECT *
		,Row_number()Over(Order By OmsOrderLineItemsId )  RowId, NULL ParentRowId
	  FROM CTE_OrderData
	  ORDER BY OmsOrderLineItemsId 

  END

  ELSE 
  BEGIN
		;WITH CTE_OrderData AS
		  (
			  SELECT MIN(OmsOrderLineItemsId) AS OmsOrderLineItemsId, MIN(ParentOmsOrderLineItemsId) AS ParentOmsOrderLineItemsId,
				  ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
				  ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4,
				  ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description,SUM(ZOO.Quantity) AS Quantity
			  FROM ZnodeOmsOrderLineItems ZOO WITH (NOLOCK)
			  WHERE ( ZOO.OmsOrderLineItemsId = @OmsOrderLineItemsId OR ZOO.ParentOmsOrderLineItemsId = @OmsOrderLineItemsId ) 
			  GROUP BY ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
				ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4, ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description
		 )
		 INSERT INTO #ZnodeOmsOrderLineItems_temp
		 SELECT *,Row_number()Over(Order By OmsOrderLineItemsId )   RowId, NULL ParentRowId
		 FROM CTE_OrderData

		INSERT INTO #ZnodeOmsOrderLineItems_temp 
		SELECT MIN(ZOO.OmsOrderLineItemsId) AS OmsOrderLineItemsId,MIN(ZOO.ParentOmsOrderLineItemsId) AS ParentOmsOrderLineItemsId,
		ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
		ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4,
		ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description,SUM(ZOO.Quantity) AS Quantity
		,0 RowId, NULL ParentRowId
		FROM ZnodeOmsOrderLineItems ZOO WITH (NOLOCK)
		WHERE ZOO.OmsOrderLineItemsId = (SELECT TOP 1 ParentOmsOrderLineItemsId FROM #ZnodeOmsOrderLineItems_temp TY WHERE TY.ParentOmsOrderLineItemsId IS NOT NULL 
		AND TY.OrderLineItemRelationshipTypeID <> @AddOnOrderLineItemRelationshipTypeId )
		AND ZOO.ParentOmsOrderLineItemsId  IS NULL 
		AND NOT EXISTS(SELECT * FROM #ZnodeOmsOrderLineItems_temp tem WHERE tem.OmsOrderLineItemsId = ZOO.OmsOrderLineItemsId )
		GROUP BY ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
			ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4,ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description;

  END

     DECLARE @TBL_OmsSavedCartOld TABLE(SKU NVARCHAR(2000), OmsSavedCartLineItemId INT ,ParentSKU NVARCHAR(2000) , ParentOmsSavedCartLineItemId INT ,AddOnSKU NVARCHAR(2000), OmsSavedCartLineItemIdAddOn NVARCHAR(2000) ,PersonalizeCode NVARCHAR(1200), PersonalizeValue  NVARCHAr(max)  )

	 DECLARE @TBL_OmsSavedCartNew TABLE(SKU NVARCHAR(2000), OmsSavedCartLineItemId INT ,ParentSKU NVARCHAR(2000) , ParentOmsSavedCartLineItemId INT ,AddOnSKU NVARCHAR(2000), OmsSavedCartLineItemIdAddOn NVARCHAR(2000) ,PersonalizeCode NVARCHAR(1200), PersonalizeValue  NVARCHAr(max)  )

	 
	 SELECT SKU , OmsOrderLineItemsId, ParentOmsOrderLineItemsId, OrderLineItemRelationshipTypeID,Quantity 
	 INTO #ZnodeOmsSavedCartLineItemOld
	 FROM #ZnodeOmsOrderLineItems_temp a 

	 SELECT OmsOrderLineItemsId, PersonalizeCode, PersonalizeValue  
	 INTO #ZnodeOmsPersonalizeCartItemOld
	 FROM ZnodeOmsPersonalizeItem a WITH (NOLOCK)
	 WHERE EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsOrderLineItems_temp t WHERE t.OmsOrderLineItemsId = a.OmsOrderLineItemsId)

	 SELECT SKU , OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OrderLineItemRelationshipTypeID, Quantity
	 INTO #ZnodeOmsSavedCartLineItemNew
	 FROM ZnodeOmsSavedCartLineItem a WITH (NOLOCK)
	 WHERE OmsSavedCartId = @OmsSavedCartId 


	 SELECT OmsSavedCartLineItemId, PersonalizeCode, PersonalizeValue   
	 INTO #ZnodeOmsPersonalizeCartItemNew
	 FROM ZnodeOmsPersonalizeCartItem a WITH (NOLOCK)
	 WHERE EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsSavedCartLineItemNew t WHERE t.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)

	 INSERT INTO @TBL_OmsSavedCartOld (SKU,OmsSavedCartLineItemId,ParentSKU,ParentOmsSavedCartLineItemId)
	 SELECT SKU , OmsOrderLineItemsId,(SELECT TOP 1 SKU FROM #ZnodeOmsSavedCartLineItemOld TBL_B WHERE TBL_B.OmsOrderLineItemsId = ISNULL(TBL_A.ParentOmsOrderLineItemsId,0)  ) ParentSKU
				, ParentOmsOrderLineItemsId
	 FROM #ZnodeOmsSavedCartLineItemOld TBL_A
	 WHERE OrderLineItemRelationshipTypeId IS NOT NULL AND OrderLineItemRelationshipTypeId <> @AddOnOrderLineItemRelationshipTypeId

	 ;With Cte_UpdateOld AS 
	 (
		SELECT ParentOmsOrderLineItemsId , SUBSTRING((SELECT ','+SKU FROM #ZnodeOmsSavedCartLineItemOld t WHERE t.ParentOmsOrderLineItemsId = a.ParentOmsOrderLineItemsId FOR XML PATH('') ),2,4000)  SKU
		     , SUBSTRING((SELECT ','+CAST(OmsOrderLineItemsId AS NVARCHAR(max)) FROM #ZnodeOmsSavedCartLineItemOld t WHERE t.ParentOmsOrderLineItemsId = a.ParentOmsOrderLineItemsId FOR XML PATH('') ),2,4000)  OmsSavedCartLineItemId
		FROM #ZnodeOmsSavedCartLineItemOld a 
		WHERE a.OrderLineItemRelationshipTypeId = @AddOnOrderLineItemRelationshipTypeId
	 )
	 UPDATE TBL_O
	 SET TBL_O.AddOnSKU =  TBL_ON.SKU
		,TBL_O.OmsSavedCartLineItemIdAddOn =  TBL_ON.OmsSavedCartLineItemId
	 FROM @TBL_OmsSavedCartOld TBL_O 
	 INNER JOIN Cte_UpdateOld TBL_ON ON (TBL_ON.ParentOmsOrderLineItemsId  = TBL_O.OmsSavedCartLineItemId )

	  INSERT INTO @TBL_OmsSavedCartNew (SKU,OmsSavedCartLineItemId,ParentSKU,ParentOmsSavedCartLineItemId)
	  SELECT SKU , OmsSavedCartLineItemId,(SELECT TOP 1 SKU FROM #ZnodeOmsSavedCartLineItemNew TBL_B WHERE TBL_B.OmsSavedCartLineItemId = ISNULL( TBL_A.ParentOmsSavedCartLineItemId,0)   ) ParentSKU
				, ParentOmsSavedCartLineItemId
	  FROM #ZnodeOmsSavedCartLineItemNew TBL_A
	  WHERE OrderLineItemRelationshipTypeId IS NOT NULL AND OrderLineItemRelationshipTypeId <> @AddOnOrderLineItemRelationshipTypeId
	 
	 ;With Cte_UpdateNew AS 
	 (
		SELECT ParentOmsSavedCartLineItemId , SUBSTRING((SELECT ','+SKU FROM #ZnodeOmsSavedCartLineItemNew t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId FOR XML PATH('') ),2,4000)  SKU
		     , SUBSTRING((SELECT ','+CAST(OmsSavedCartLineItemId AS NVARCHAR(max)) FROM #ZnodeOmsSavedCartLineItemNew t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId FOR XML PATH('') ),2,4000)  OmsSavedCartLineItemId
		FROM #ZnodeOmsSavedCartLineItemNew a 
		WHERE a.OrderLineItemRelationshipTypeId = @AddOnOrderLineItemRelationshipTypeId
	 )	 
	 UPDATE TBL_O
	 SET TBL_O.AddOnSKU =  TBL_ON.SKU
		,TBL_O.OmsSavedCartLineItemIdAddOn =  TBL_ON.OmsSavedCartLineItemId
	 FROM @TBL_OmsSavedCartNew TBL_O 
	 INNER JOIN Cte_UpdateNew TBL_ON ON (TBL_ON.ParentOmsSavedCartLineItemId  = TBL_O.OmsSavedCartLineItemId )

	  UPDATE TBL_O
	  SET TBL_O.PersonalizeCode = SUBSTRING((SELECT ','+TBL_ON.PersonalizeCode FROM #ZnodeOmsPersonalizeCartItemNew TBL_ON WHERE TBL_ON.OmsSavedCartLineItemId  = TBL_O.ParentOmsSavedCartLineItemId   FOR XML PATH ('')),2,4000) 
		,TBL_O.PersonalizeValue =  SUBSTRING((SELECT ','+TBL_ON.PersonalizeValue FROM #ZnodeOmsPersonalizeCartItemNew TBL_ON WHERE TBL_ON.OmsSavedCartLineItemId  = TBL_O.ParentOmsSavedCartLineItemId   FOR XML PATH ('')),2,4000)  
	  FROM @TBL_OmsSavedCartNew TBL_O 
	

	  UPDATE TBL_O
	  SET TBL_O.PersonalizeCode = SUBSTRING((SELECT ','+TBL_ON.PersonalizeCode FROM #ZnodeOmsPersonalizeCartItemOld TBL_ON WHERE  TBL_ON.OmsOrderLineItemsId  = TBL_O.ParentOmsSavedCartLineItemId  FOR XML PATH ('')),2,4000)
		,TBL_O.PersonalizeValue =  SUBSTRING((SELECT ','+TBL_ON.PersonalizeValue FROM #ZnodeOmsPersonalizeCartItemOld TBL_ON WHERE  TBL_ON.OmsOrderLineItemsId  = TBL_O.ParentOmsSavedCartLineItemId  FOR XML PATH ('')),2,4000) 
	  FROM @TBL_OmsSavedCartOld TBL_O 

	  UPDATE a 
	  SET   a.PersonalizeCode = ISNULL((SELECT TOP 1 PersonalizeCode FROM @TBL_OmsSavedCartOld RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeCode)
	  ,a.PersonalizeValue = ISNULL((SELECT TOP 1 PersonalizeValue FROM @TBL_OmsSavedCartOld RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeValue)
	  FROM @TBL_OmsSavedCartOld a 
	  WHERE a.ParentOmsSavedCartLineItemId IS NOT NULL 

	  UPDATE a 
	  SET   a.PersonalizeCode = ISNULL((SELECT TOP 1 PersonalizeCode FROM @TBL_OmsSavedCartNew RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeCode)
	  ,a.PersonalizeValue = ISNULL((SELECT TOP 1 PersonalizeValue FROM @TBL_OmsSavedCartNew RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeValue)
	  FROM @TBL_OmsSavedCartNew a 
	  WHERE a.ParentOmsSavedCartLineItemId IS NOT NULL 

	 UPDATE a 
	 SET  a.Quantity =  a.Quantity+d.Quantity 
	 FROM ZnodeOmsSavedCartLineItem a 
	 INNER JOIN @TBL_OmsSavedCartNew b ON (b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	 INNER JOIN @TBL_OmsSavedCartOld c ON (c.SKU = b.SKU AND c.ParentSKU = b.ParentSKU AND ISNULL(c.AddOnSKU,'-1') = ISNULL(b.AddOnSKU,'-1') AND ISNULL(c.PersonalizeCode,'-1') = ISNULL(b.PersonalizeCode,'-1') AND ISNULL(c.PersonalizeValue,'-1') = ISNULL(b.PersonalizeValue,'-1')) 
	 INNER JOIN #ZnodeOmsSavedCartLineItemOld d ON (d.OmsOrderLineItemsId = c.OmsSavedCartLineItemId)

	 ;WITH CTE_UpdateOrder 
	 AS 
	 (
	   SELECT Sequence,  ROW_NUMBER()Over(order BY OmsSavedCartLineItemId ASC) RowId
	   FROM ZnodeOmsSavedCartLineItem WITH (NOLOCK)
	   WHERE  OmsSavedCartId = @OmsSavedCartId
	 
	 ) 
	 UPDATE CTE_UpdateOrder 
	 SET Sequence =RowId


	 DECLARE @DeletedId TABLE (OmsSavedCartLineItemId INT )

	
	 DELETE  FROM #ZnodeOmsOrderLineItems_temp OUTPUT DELETED.OmsOrderLineItemsId INTO @DeletedId WHERE OmsOrderLineItemsId IN (SELECT c.OmsSavedCartLineItemId FROM ZnodeOmsSavedCartLineItem a 
	 INNER JOIN @TBL_OmsSavedCartNew b ON (b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	 INNER JOIN @TBL_OmsSavedCartOld c ON (c.SKU = b.SKU AND c.ParentSKU = b.ParentSKU AND ISNULL(c.AddOnSKU,'-1') = ISNULL(b.AddOnSKU,'-1') AND ISNULL(c.PersonalizeCode,'-1') = ISNULL(b.PersonalizeCode,'-1') AND ISNULL(c.PersonalizeValue,'-1') = ISNULL(b.PersonalizeValue,'-1')) 
	 INNER JOIN #ZnodeOmsSavedCartLineItemOld d ON (d.OmsOrderLineItemsId = c.OmsSavedCartLineItemId))


	 DELETE FROM #ZnodeOmsOrderLineItems_temp WHERE ParentOmsOrderLineItemsId IN (SELECT OmsSavedCartLineItemId FROM @DeletedId)

	 DELETE TR FROM #ZnodeOmsOrderLineItems_temp TR WHERE NOT EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsOrderLineItems_temp YU WHERE TR.OmsOrderLineItemsId = YU.ParentOmsOrderLineItemsId  ) 
	 AND TR.ParentOmsOrderLineItemsId IS NULL 

   UPDATE #ZnodeOmsOrderLineItems_temp 
   SET ParentRowId = (SELECT TOP 1 RowId FROM #ZnodeOmsOrderLineItems_temp a WHERE a.OmsOrderLineItemsId = #ZnodeOmsOrderLineItems_temp.ParentOmsOrderLineItemsId ) 
	BEGIN TRANSACTION ReorderSaveCart
		INSERT INTO ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId,CustomText,CartAddOnDetails
											,Sequence,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AutoAddon,OmsOrderId,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId
											,ProductName,Description)
		OUTPUT INSERTED.OmsSavedCartLineItemId,INSERTED.Sequence  INTO @TBL_ZnodeOmsSavedCartLineItem
		SELECT NULL,@OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId,NULL CustomText, NULL CartAddOnDetails
											,RowId,@UserId,@GetDate,@UserId,@GetDate,AutoAddonSKU,NULL OmsOrderId,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId
											,ProductName,Description
		FROM #ZnodeOmsOrderLineItems_temp 
		ORDER BY OmsOrderLineItemsId 

            
		  UPDATE ab 
		  SET ab.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_ZnodeOmsSavedCartLineItem av WHERE av.RowId = b.ParentRowId   )
		  FROM ZnodeOmsSavedCartLineItem ab 
		  INNER JOIN @TBL_ZnodeOmsSavedCartLineItem a ON (a.OmsSavedCartLineItemId = ab.OmsSavedCartLineItemId ) 
		  INNER JOIN #ZnodeOmsOrderLineItems_temp b ON  (b.RowId = a.RowId  ) 

		  INSERT INTO ZnodeOmsPersonalizeCartItem (OmsSavedCartLineItemId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL)
		  SELECT c.OmsSavedCartLineItemId,PersonalizeCode,PersonalizeValue,@UserId,@GetDate,@UserId,@GetDate,DesignId,ThumbnailURL
		  FROM ZnodeOmsPersonalizeItem  a 
		  INNER JOIN #ZnodeOmsOrderLineItems_temp b ON (a.OmsOrderLineItemsId = b.OmsOrderLineItemsId)
		  INNER JOIN @TBL_ZnodeOmsSavedCartLineItem c ON (c.RowId = b.RowId )

		  UPDATE ZOSCLI1 set Quantity = null
		  from ZnodeOmsSavedCartLineItem ZOSCLI1
		  where ParentOmsSavedCartLineItemId is null and OmsSavedCartId = @OmsSavedCartId
		  and Quantity is not null
		  and not exists(select * from ZnodeOmsSavedCartLineItem ZOSCLI where OrderLineItemRelationshipTypeId = @BundleOrderLineItemRelationshipTypeId and ZOSCLI1.OmsSavedCartLineItemId = ZOSCLI.ParentOmsSavedCartLineItemId )

		  UPDATE ZnodeOmsSavedCart
		  SET ModifiedDate = GETDATE()
		  WHERE OmsSavedCartId = @OmsSavedCartId
	COMMIT TRANSACTION ReorderSaveCart
   SET @status = 1 
   
END TRY 
BEGIN CATCH 
	ROLLBACK TRANSACTION ReorderSaveCart
	SELECT ERROR_MESSAGE()
	SET @status = 0 

	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertSaveCartLineItemsForReOrder @OmsOrderId = '+CAST(@OmsOrderId AS VARCHAR(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@OmsSavedCartId='+CAST(@OmsSavedCartId AS VARCHAR(50))+',@OmsOrderLineItemsId='+CAST(@OmsOrderLineItemsId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
    SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
    EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_InsertSaveCartLineItemsForReOrder',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishProductPricingBySku')
	DROP PROC Znode_GetPublishProductPricingBySku
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishProductPricingBySku]
(   
    @SKU              VARCHAR(MAX),
    @PortalId         INT,
    @currentUtcDate   VARCHAR(100), -- this date is required for the user date r
    @UserId           INT          = 0, -- userid is optional
	@ProfileId        INT          = 0, 
	@OmsOrderId		  INT        = 0,
	@IsFetchPriceFromOrder  BIT          = 0,
    @PublishProductId TransferId READONLY,
	@IsDebug          BIT          = 0

	)
AS 
   /* 
    --Summary: Retrive Price of product from pricelist
    --Input Parameters:
    --UserId, SKU(Comma separated multiple), PortalId
    --Conditions :
    --1. If userId is null then check for PriceList having sku associated to profile which is associated to Portal having  PortalId and  having higher Precedence and valid ActivationDate and ExpirationDate for PriceList  and SKU also.
    --Unit Testing : 
    --EXEC Znode_GetPublishProductPricingBySku_2 @SKU = 'apple,apr234' , @PortalId = 34 , @currentUtcDate = '2016-09-17 00:00:00.000';
    --2. If There is no any PriceList having given sku associated to profile  then check for  
    --PriceList associated portal having PortalId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
    --Unit Testing : 
    --EXEC Znode_GetPublishProductPricingBySku_2 @SKU = 'apple,apr234' , @PortalId = 34 , @currentUtcDate = '2016-09-17 00:00:00.000';
    --3. If userId is not null then check for PriceList having sku associated to User having UserId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
    --4. If There is no any PriceList having given sku associated to user  then check for  
    --PriceList associated Account having UserId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
    --5. If There is no any PriceList having given sku associated to account  then check for  
    --PriceList associated Profile having PortalId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
    --6. If There is no any PriceList having given sku associated to Profile  then check for  
    --PriceList associated Portal having PortalId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
    --7. If in each case Precedence is same then get PriceList according to higher PriceListId ActivationDate and ExpirationDate for PriceList and SKU also.
    --8. Also get the Tier Price, Tier Quantity of given sku.
    --Unit Testing   
    --Exec Znode_GetPublishProductPricingBySku_r  @SKU = 'SKUPN2345B',@PortalId = 1, @currentUtcDate = '2020-09-07 00:00:00.000',@OmsOrderId=12,@IsFetchPriceFromOrder=1
	*/
    
     BEGIN
         BEGIN TRY
             SET NOCOUNT ON;
			 DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
             CREATE TABLE #Tlb_SKU 
             (
				SKU        VARCHAR(100),
				SequenceNo INT IDENTITY
             );

			 CREATE INDEX Idx_#Tlb_SKU ON #Tlb_SKU(SKU)
			  
			 DECLARE @DefaultLocaleId INT = dbo.FN_GETDEFAULTLocaleId()

			 IF @SKU = '' 
			 BEGIN 
				INSERT INTO #Tlb_SKU(SKU)
				SELECT SKU
				FROM ZnodePublishProductDetail a
				INNER JOIN @PublishProductId b ON (b.Id = a.PublishProductId )
				WHERE LocaleId = @DefaultLocaleId

			 END 
			 ELSE 
			 BEGIN
				INSERT INTO #Tlb_SKU(SKU)
				SELECT Item FROM Dbo.split(@SKU, ',');
			 END 

            -- DECLARE #TLB_SKUPRICELIST TABLE
          CREATE TABLE #TLB_SKUPRICELIST
		     (SKU          VARCHAR(100),
              RetailPrice  NUMERIC(28, 6),
              SalesPrice   NUMERIC(28, 6),
              PriceListId  INT,
              TierPrice    NUMERIC(28, 6),
              TierQuantity NUMERIC(28, 6),
			  ExternalId NVARCHAR(2000),
			  Custom1 NVARCHAR(MAX),
			  Custom2 NVARCHAR(MAX),
			  Custom3 NVARCHAR(MAX)
             );
             DECLARE @PriceListId INT, @PriceRoundOff INT;
             SELECT @PriceRoundOff = CONVERT( INT, FeatureValues)
             FROM ZnodeGlobalSetting
             WHERE FeatureName = 'PriceRoundOff';
		
             --Retrive portal wise pricelist  
			 CREATE TABLE #Tbl_PortalWisePriceList  
			 (PriceListId    INT,
              ActivationDate DATETIME,
              ExpirationDate DATETIME NULL,
              Precedence     INT,
			  SKU NVARCHAR(300)
             );
             --Retrive price for respective pricelist   
             Create TABLE  #Tbl_PriceListWisePriceData 
             (
				  PriceListId    INT,
				  SKU            VARCHAR(300),
				  SalesPrice     NUMERIC(28, 6),
				  RetailPrice    NUMERIC(28, 6),
				  UomId          INT,
				  UnitSize       NUMERIC(28, 6),
				  ActivationDate DATETIME,
				  ExpirationDate DATETIME NULL,
				  TierPrice      NUMERIC(28, 6),
				  TierQuantity   NUMERIC(28, 6),
				  TierUomId      INT,
				  TierUnitSize   NUMERIC(28, 6), 
				  ExternalId NVARCHAR(2000),
				  Custom1 NVARCHAR(MAX),
				  Custom2 NVARCHAR(MAX),
				  Custom3 NVARCHAR(MAX)
             );
			
			Create table #Tbl_SKUWisePriceList(PriceListId INT, SKU NVARCHAR(300))

			INSERT INTO #Tbl_SKUWisePriceList(PriceListId,SKU) 
			SELECT  PriceListId,SKU from ZnodePrice ZP where exists(Select SKU from #Tlb_SKU SKU where SKU.SKU = ZP.SKU )
			Union
			SELECT PriceListId,SKU  from ZnodePriceTier ZPT where exists(Select SKU from #Tlb_SKU SKU where SKU.SKU = ZPT.SKU )
			 
			 --1. If userId is null then check for PriceList having sku associated to profile which is associated to Portal having  PortalId and  having higher Precedence and valid ActivationDate and ExpirationDate for PriceList  and SKU also.
            IF @UserId = 0
                 BEGIN
					INSERT INTO #Tbl_PortalWisePriceList( PriceListId, ActivationDate, ExpirationDate, Precedence,SKU )
					SELECT a.PriceListId, ActivationDate, ISNULL(ExpirationDate, @GetDate), b.Precedence,tsw.SKU
					FROM ZnodePriceList AS a INNER JOIN ZnodePriceListProfile AS b ON a.PriceListId = b.PriceListId INNER JOIN ZnodePortalProfile AS c
						ON b.PortalProfileId = c.PortalProfileID AND  c.IsDefaultAnonymousProfile = 1 INNER JOIN ZnodePortalunit AS zupu ON a.CultureId = zupu.CultureId 
						inner join #Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
					WHERE @CurrentUtcDate BETWEEN a.ActivationDate AND ISNULL(a.ExpirationDate, @GetDate) AND c.PortalId = @PortalId
					ORDER BY b.Precedence;
		
			 
            --2. If There is no any PriceList having given sku associated to profile  then check for PriceList associated portal having PortalId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
			IF Exists (Select top 1 1  FROM #Tbl_SKUWisePriceList tspl where NOT Exists (SELECT TOP 1 1 FROM #Tbl_PortalWisePriceList tpwl
				WHERE tspl.SKU = tpwl.SKU))
                         BEGIN
							INSERT INTO #Tbl_PortalWisePriceList( PriceListId, ActivationDate, ExpirationDate, Precedence,SKU )
							SELECT a.PriceListId, ActivationDate, ISNULL(ExpirationDate, @GetDate), b.Precedence,tsw.SKU
							FROM ZnodePriceList AS a INNER JOIN ZnodePriceListPortal AS b ON a.PriceListId = b.PriceListId
							INNER JOIN ZnodePortalunit AS zupu ON a.CultureId = zupu.CultureId   
							inner join #Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
							AND NOT EXISTS (Select TOP 1 1 FROM  #Tbl_PortalWisePriceList tpwl WHERE tpwl.SKU = tsw.SKU )
							WHERE @CurrentUtcDate BETWEEN a.ActivationDate 
							AND ISNULL(a.ExpirationDate, @GetDate) AND b.PortalId = @PortalId
							ORDER BY b.Precedence
							;
							--Delete from #Tbl_SKUWisePriceList where PriceListId in (Select PriceListId from  #Tbl_PortalWisePriceList )
						
                         END;
                 END;
             --3. If userId is not null then check for PriceList having sku associated to User having UserId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
             ELSE
                 BEGIN
				 
                     INSERT INTO #Tbl_PortalWisePriceList (PriceListId, ActivationDate, ExpirationDate, Precedence,SKU )
                            SELECT a.PriceListId, ActivationDate,ISNULL(ExpirationDate, @GetDate), b.Precedence,tsw.SKU
                            FROM ZnodePriceList AS a INNER JOIN ZnodePriceListUser AS b ON a.PriceListId = b.PriceListId
                                 INNER JOIN ZnodePortalunit zupu ON a.CultureId = zupu.CultureId AND zupu.PortalId = @PortalId  
								 inner join #Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
								 AND NOT EXISTS (Select TOP 1 1 FROM  #Tbl_PortalWisePriceList tpwl WHERE tpwl.SKU = tsw.SKU )
                            WHERE @CurrentUtcDate BETWEEN a.ActivationDate AND ISNULL(a.ExpirationDate, @GetDate) AND b.UserID = @UserId
							ORDER BY b.Precedence ;

                --4. If There is no any PriceList having given sku associated to user  then check for PriceList associated Account having UserId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
				IF Exists (Select top 1 1  FROM #Tbl_SKUWisePriceList tspl where NOT Exists (SELECT TOP 1 1 FROM #Tbl_PortalWisePriceList tpwl
				WHERE tspl.SKU = tpwl.SKU))
						BEGIN
							INSERT INTO #Tbl_PortalWisePriceList( PriceListId, ActivationDate, ExpirationDate, Precedence,SKU )
								   SELECT a.PriceListId, ActivationDate, ISNULL(ExpirationDate, @GetDate), c.Precedence,tsw.SKU
								   FROM ZnodePriceList AS a INNER JOIN ZnodePriceListAccount AS c ON a.PriceListId = c.PriceListId
										INNER JOIN ZnodeUser AS d ON c.Accountid = d.Accountid INNER JOIN ZnodePortalunit AS zupu ON a.CultureId = zupu.CultureId   
										AND zupu.PortalId = @PortalId
										inner join #Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
										AND NOT EXISTS (Select TOP 1 1 FROM  #Tbl_PortalWisePriceList tpwl WHERE tpwl.SKU = tsw.SKU )
								   WHERE @CurrentUtcDate BETWEEN a.ActivationDate AND ISNULL(a.ExpirationDate, @GetDate) AND d.UserID = @UserId
									ORDER BY c.Precedence
							--Delete from #Tbl_SKUWisePriceList where PriceListId in (Select PriceListId from  #Tbl_PortalWisePriceList )
						 END;
                     -- 5. If There is no any PriceList having given sku associated to account  then check for PriceList associated Profile having PortalId and having higher   Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
				IF Exists (Select top 1 1  FROM #Tbl_SKUWisePriceList tspl 
				where NOT Exists (SELECT TOP 1 1 FROM #Tbl_PortalWisePriceList tpwl
				WHERE tspl.SKU = tpwl.SKU))

                         BEGIN
                             INSERT INTO #Tbl_PortalWisePriceList(PriceListId,ActivationDate,ExpirationDate,Precedence,SKU)
                                    SELECT a.PriceListId, ActivationDate, ISNULL(ExpirationDate, @GetDate), b.Precedence,tsw.SKU
                                    FROM ZnodePriceList AS a
                                         INNER JOIN ZnodePriceListProfile AS b ON a.PriceListId = b.PriceListId 
										 INNER JOIN ZnodePortalProfile AS c ON b.PortalProfileId = c.PortalProfileId  AND c.PortalId = @PortalId                                          
                                         INNER JOIN ZnodePortalunit zupu ON a.CultureId = zupu.CultureId AND zupu.PortalId = @PortalId 
										 inner join #Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
										 AND NOT EXISTS (Select TOP 1 1 FROM  #Tbl_PortalWisePriceList tpwl WHERE tpwl.SKU = tsw.SKU )
                                    WHERE @CurrentUtcDate BETWEEN a.ActivationDate AND ISNULL(a.ExpirationDate, @GetDate) 
									AND EXISTS (SELECT TOP 1 1 FROM dbo.ZnodeUserProfile zup WHERE c.ProfileId = zup.ProfileId AND (IsDefault = 1 OR   @ProfileId <> 0)
									AND (( zup.UserId = @UserId OR  @ProfileId <> 0) AND (ZUP.ProfileId = @ProfileId OR @ProfileId = 0 )));  
					     END;
                   ---6. If There is no any PriceList having given sku associated to Profile  then check for priceList associated Portal having PortalId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
						IF Exists (Select top 1 1 FROM #Tbl_SKUWisePriceList tspl 
						WHERE NOT Exists (SELECT TOP 1 1 FROM #Tbl_PortalWisePriceList tpwl WHERE tspl.SKU = tpwl.SKU))

                         BEGIN
							INSERT INTO #Tbl_PortalWisePriceList( PriceListId, ActivationDate, ExpirationDate, Precedence,SKU )
							SELECT a.PriceListId, ActivationDate, ISNULL(ExpirationDate, @GetDate), b.Precedence,tsw.SKU
							FROM ZnodePriceList AS a INNER JOIN ZnodePriceListPortal AS b ON a.PriceListId = b.PriceListId
								INNER JOIN ZnodePortalunit AS zupu ON a.CultureId = zupu.CultureId AND  zupu.PortalId = b.PortalId    
								inner join #Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
								AND NOT EXISTS (Select TOP 1 1 FROM  #Tbl_PortalWisePriceList tpwl WHERE tpwl.SKU = tsw.SKU )
								WHERE @CurrentUtcDate BETWEEN a.ActivationDate AND ISNULL(a.ExpirationDate, @GetDate) AND b.PortalId = @PortalId
							    ORDER BY b.Precedence;
						 END;
						 
				--IF Exists (Select top 1 1  FROM #Tbl_SKUWisePriceList tspl where NOT Exists (SELECT TOP 1 1 FROM #Tbl_PortalWisePriceList tpwl
				--WHERE tspl.SKU = tpwl.SKU))
				--BEGIN
				
				--	INSERT INTO #Tbl_PortalWisePriceList( PriceListId, ActivationDate, ExpirationDate, Precedence,SKU )
				--	SELECT a.PriceListId, ActivationDate, ISNULL(ExpirationDate, @GetDate), b.Precedence,tsw.SKU
				--	FROM ZnodePriceList AS a INNER JOIN ZnodePriceListProfile AS b ON a.PriceListId = b.PriceListId INNER JOIN ZnodePortalProfile AS c
				--	ON b.ProfileId = c.ProfileId AND  c.IsDefaultAnonymousProfile = 1 INNER JOIN ZnodePortalunit AS zupu ON a.CurrencyId = zupu.CurrencyId
				--	inner join #Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
				--	AND NOT EXISTS (Select TOP 1 1 FROM  #Tbl_PortalWisePriceList tpwl WHERE tpwl.SKU = tsw.SKU )
				--	WHERE @CurrentUtcDate BETWEEN a.ActivationDate AND ISNULL(a.ExpirationDate, @GetDate) AND c.PortalId = @PortalId;
				--END

                 END;
			
             SET @PriceListId = 0;
             -- Check Activation date and expiry date 
			
			 If (@OmsOrderId>0  and  @IsFetchPriceFromOrder=1)
			   begin 
			      EXEC Znode_GetOrderPricList @OmsOrderId=@OmsOrderId,@SKU=@SKU,@PublishProductId=@PublishProductId;
		       end


             else 
			 begin
				 IF EXISTS( SELECT TOP 1 1 FROM #Tbl_PortalWisePriceList)
					 begin
						 -- Declare  @d datetime
						 -- SET @d = @GetDate
						 -- Select ISNULL(ActivationDate,@d)  , ISNULL( ExpirationDate,@GetDate ),b.Precedence,* from ZnodePriceList  a inner join ZnodePriceListPortal b on a.PriceListId = b.PriceListId where @d between ISNULL(ActivationDate,@d) 
						 -- and ISNULL(ExpirationDate,@GetDate ) --and a.PriceListId <>  80
						 -- Order by ISNULL(ActivationDate,@d)  , ISNULL( ExpirationDate,@GetDate ) ,  b.Precedence DESC 
						 --	Retrive pricelist wise price
					   
					   SET @PriceListId =( SELECT TOP 1 PriceListId FROM #Tbl_PortalWisePriceList ORDER BY Precedence  );

					   INSERT INTO #Tbl_PriceListWisePriceData( PriceListId, SKU, SalesPrice, RetailPrice, UomId, UnitSize, ActivationDate, ExpirationDate, TierPrice, TierQuantity, TierUomId, TierUnitSize , ExternalId ,Custom1,Custom2,Custom3)
					   SELECT ZP.PriceListId, ZP.SKU, ZP.SalesPrice, ZP.RetailPrice, ZP.UomId, ZP.UnitSize, ISNULL(ZP.ActivationDate, @CurrentUtcDate), ISNULL(ZP.ExpirationDate, @GetDate), ZPT.Price, ZPT.Quantity, ZPT.UomId, ZPT.UnitSize, ZP.ExternalId,
					   ZPT.Custom1,ZPT.Custom2,ZPT.Custom3
					   FROM [ZnodePrice] AS ZP 
					   INNER JOIN #Tlb_SKU AS TSKU ON (ZP.SKU = TSKU.SKU )
					   LEFT OUTER JOIN ZnodePriceTier AS ZPT ON ZP.SKU = ZPT.SKU AND ZP.PriceListId = ZPT.PriceListId
					   WHERE ZP.PriceListId = @PriceListId

					   -- Check Activation date and expiry date 
						INSERT INTO #TLB_SKUPRICELIST( PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId,Custom1,Custom2,Custom3 )
						   SELECT DISTINCT  PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId,Custom1,Custom2,Custom3
						   FROM #Tbl_PriceListWisePriceData
						   WHERE @currentUtcDate BETWEEN ActivationDate AND ISNULL(ExpirationDate, @GetDate);
					   
					  
						INSERT INTO #TLB_SKUPRICELIST( PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId ,Custom1,Custom2,Custom3)
						   SELECT PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId,Custom1,Custom2,Custom3
						   FROM #Tbl_PriceListWisePriceData
						   WHERE SKU NOT IN(SELECT SKU FROM #TLB_SKUPRICELIST) and ActivationDate is null 
				
					 end;
						 -- Retrive data as per precedance from ZnodePriceListPortal table  
					
				 ELSE
					 BEGIN
						 SET @PriceListId =( SELECT TOP 1 PriceListId FROM #Tbl_PortalWisePriceList ORDER BY Precedence  );

						 --Retrive pricelist wise price  
						 INSERT INTO #Tbl_PriceListWisePriceData( PriceListId, SKU, SalesPrice, RetailPrice, UomId, UnitSize, ActivationDate, ExpirationDate, TierPrice, TierQuantity, TierUomId, TierUnitSize, ExternalId ,Custom1,Custom2,Custom3)
						 SELECT ZP.PriceListId, ZP.SKU, ZP.SalesPrice, ZP.RetailPrice, ZP.UomId, ZP.UnitSize, ISNULL(ZP.ActivationDate, @CurrentUtcDate), 
								ISNULL(ZP.ExpirationDate, @GetDate), ZPT.Price, ZPT.Quantity, ZPT.UomId, ZPT.UnitSize, zp.ExternalId,Custom1,Custom2,Custom3
						 FROM [ZnodePrice] AS ZP INNER JOIN #Tlb_SKU AS TSKU ON ZP.SKU = TSKU.SKU LEFT OUTER JOIN ZnodePriceTier AS ZPT ON ZP.SKU = ZPT.SKU AND 
								   ZP.PriceListId = ZPT.PriceListId WHERE ZP.PriceListId = @PriceListId; 

						 -- Check Activation date and expiry date 
						INSERT INTO #TLB_SKUPRICELIST( PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId ,Custom1,Custom2,Custom3)
						SELECT PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId,Custom1,Custom2,Custom3
						FROM #Tbl_PriceListWisePriceData WHERE @currentUtcDate BETWEEN ActivationDate AND ISNULL(ExpirationDate, @GetDate);
					
						INSERT INTO #TLB_SKUPRICELIST( PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId ,Custom1,Custom2,Custom3)
						SELECT PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId,Custom1,Custom2,Custom3
						FROM #Tbl_PriceListWisePriceData
						WHERE SKU NOT IN ( SELECT SKU FROM #TLB_SKUPRICELIST) and ActivationDate is null;

					 END;
				 SELECT SKU,
						ROUND(RetailPrice, @PriceRoundOff) AS RetailPrice,
						ROUND(SalesPrice, @PriceRoundOff) AS SalesPrice,
						ROUND(TierPrice, @PriceRoundOff) AS TierPrice,
						ROUND(TierQuantity, @PriceRoundOff) AS TierQuantity,
						ZCC.CurrencyCode  AS CurrencyCode,    
						ZC.Symbol AS CurrencySuffix,  ZC.CultureCode,
						TSPL.ExternalId,
						Custom1,Custom2,Custom3
				 FROM #TLB_SKUPRICELIST AS TSPL
					  INNER JOIN ZnodePriceList AS ZPL ON TSPL.PriceListId = ZPL.PriceListId
					  INNER JOIN ZnodeCulture AS ZC ON ZPL.CultureId = ZC.CultureId    
					  LEFT JOIN ZnodeCurrency AS ZCC ON ZC.CurrencyId = ZCC.CurrencyId   
					  ORDER BY TierQuantity ASC;
			end
         END TRY
         BEGIN CATCH
              DECLARE @Status BIT ;
			SET @Status = 0;
			DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishProductPricingBySku @SKU = '+@SKU+',@PortalId = '+CAST(@PortalId AS VARCHAR(10))+',@currentUtcDate = '+@currentUtcDate+',@UserId='+CAST(@UserId AS VARCHAR(100))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
			SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
			EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetPublishProductPricingBySku',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetSkuPricebyCatalog')
	DROP PROC Znode_GetSkuPricebyCatalog
GO

CREATE PROCEDURE [dbo].[Znode_GetSkuPricebyCatalog]
(   @WhereClause		NVARCHAR(max),
    @Rows				INT            = 100,
    @PageNo				INT            = 1,
    @Order_BY			VARCHAR(1000)  = '',
    @RowsCount			INT  out,
	@LocaleId			INT			   = 0,
	@Sku                VARCHAR(MAX),
	@PortalId		    INT = 0,
	@currentUtcDate     VARCHAR(200) = '',
	@PublishProductId   ProductForSortPrice READONLY,
	@IsInStock			varchar(5) ,
	@IsSorting			Bit = 1 
)		
AS 
/*
    Summary: This procedure is used to find the PriceList by catalog 
	Unit Testing: 
	
    @IsInStock --- for 1 - In stock data , for 0 - out off stock data , for -1 - all data

	declare @p7 int
	set @p7=NULL
	declare @p12 dbo.ProductForSortPrice
	insert into @p12 values(947,N'SimpleProduct',N'DisablePurchasing',0)
	insert into @p12 values(948,N'SimpleProduct',N'DisablePurchasing',0)
	insert into @p12 values(949,N'SimpleProduct',N'DisablePurchasing',0)
	insert into @p12 values(950,N'SimpleProduct',N'DisablePurchasing',0)
	insert into @p12 values(951,N'SimpleProduct',N'DisablePurchasing',0)
	insert into @p12 values(953,N'SimpleProduct',N'DisablePurchasing',0)
	insert into @p12 values(957,N'SimpleProduct',N'DisablePurchasing',0)
	insert into @p12 values(1002,N'SimpleProduct',N'DisablePurchasing',0)
	insert into @p12 values(1003,N'SimpleProduct',N'DisablePurchasing',0)
	insert into @p12 values(1004,N'SimpleProduct',N'DisablePurchasing',0)
	insert into @p12 values(1005,N'SimpleProduct',N'DisablePurchasing',0)
	insert into @p12 values(1026,N'BundleProduct',N'DisablePurchasing',0)
	insert into @p12 values(1030,N'BundleProduct',N'DisablePurchasing',1)
	insert into @p12 values(1039,N'GroupedProduct',N'DontTrackInventory',0)
	insert into @p12 values(1013,N'BundleProduct',N'AllowBackOrdering',0)
	insert into @p12 values(1031,N'SimpleProduct',N'DisablePurchasing',0)
	insert into @p12 values(1032,N'SimpleProduct',N'DisablePurchasing',0)
	insert into @p12 values(1042,N'SimpleProduct',N'DisablePurchasing',0)

	exec sp_executesql N'Znode_GetSkuPricebyCatalog  @WhereClause,@Rows,@PageNo,@Order_By,@RowCount OUT
	,@LocaleId,@Sku,@PortalId,@currentUtcDate,@PublishProductId,@IsInStock',N'@WhereClause nvarchar(4000),
	@Rows int,@PageNo int,@Order_By nvarchar(15),@RowCount int output,@LocaleId int,
	@Sku nvarchar(4000),@PortalId int,@currentUtcDate datetime,@PublishProductId [dbo].[ProductForSortPrice] 
	READONLY,@IsInStock nvarchar(2)',@WhereClause=N'',@Rows=16,@PageNo=1,@Order_By=N'retailprice asc',@RowCount=@p7 output,
	@LocaleId=1,@Sku=N'',@PortalId=1,@currentUtcDate='2017-11-30 00:00:00',@PublishProductId=@p12,@IsInStock=N'1'
	select @p7

	GO

	declare @p7 int
	set @p7=NULL
	declare @p12 dbo.TransferId
	insert into @p12 values(947)
	insert into @p12 values(948)
	insert into @p12 values(949)
	insert into @p12 values(950)
	insert into @p12 values(951)
	insert into @p12 values(953)
	insert into @p12 values(957)
	insert into @p12 values(1002)
	insert into @p12 values(1003)
	insert into @p12 values(1004)
	insert into @p12 values(1005)
	insert into @p12 values(1026)
	insert into @p12 values(1030)
	insert into @p12 values(1039)
	insert into @p12 values(1013)
	insert into @p12 values(1031)
	insert into @p12 values(1032)
	insert into @p12 values(1042)

	exec sp_executesql N'Znode_GetSkuPricebyCatalog  @WhereClause,@Rows,@PageNo,@Order_By,@RowCount OUT
	,@LocaleId,@Sku,@PortalId,@currentUtcDate,@PublishProductId,@IsInStock',N'@WhereClause nvarchar(4000),
	@Rows int,@PageNo int,@Order_By nvarchar(15),@RowCount int output,@LocaleId int,
	@Sku nvarchar(4000),@PortalId int,@currentUtcDate datetime,@PublishProductId [dbo].[TransferId] 
	READONLY,@IsInStock nvarchar(2)',@WhereClause=N'',@Rows=16,@PageNo=1,@Order_By=N'retailprice asc',@RowCount=@p7 output,
	@LocaleId=1,@Sku=N'',@PortalId=1,@currentUtcDate='2017-11-30 00:00:00',@PublishProductId=@p12,@IsInStock=N'1'
	select @p7

*/


     BEGIN
     BEGIN TRY
	 SET NOCOUNT ON;
			 DECLARE @ProductIdForPricing   TransferId 
             DECLARE @SQL NVARCHAR(MAX);
			 DECLARE @TBL_PricebyCatalog TABLE (SKU NVARCHAR(4000),RetailPrice numeric(28,6),RowId INT,CountNo INT,ProductType nvarchar(200),OutOfStockOptions nvarchar(200),SalesPrice numeric(28,6))
			 CREATE TABLE #TBL_PricebyCatalogforAssociateProduct  (PimProductId int ,AssociatedProductId int,ParentSKU NVARCHAR(300),
			 ChildSKU NVARCHAR(300),RetailPrice  numeric(28,6),AssociatedProductDisplayOrder int , TypeOfProduct nvarchar(100),SalesPrice  numeric(28,6))
			 DECLARE @DefaultLocaleId INT = dbo.FN_GetDefaultLocaleId()
			 
			 DECLARE @tbl_PricingSku TABLE (sku nvarchar(200),RetailPrice numeric(28,6),SalesPrice numeric(28,6),TierPrice numeric(28,6),
						TierQuantity numeric(28,6),CurrencyCode varchar(200),CurrencySuffix varchar(2000),CultureCode VARCHAR(100), ExternalId NVARCHAR(2000),Custom1 NVARCHAR(MAX),Custom2 NVARCHAR(MAX),
			  Custom3 NVARCHAR(MAX))
			  
			 CREATE TABLE #tbl_PricingSkuOfAssociatedProduct (sku nvarchar(200),RetailPrice numeric(28,6),SalesPrice numeric(28,6),TierPrice numeric(28,6),
						TierQuantity numeric(28,6),CurrencyCode varchar(200),CurrencySuffix varchar(2000),CultureCode VARCHAR(100), ExternalId NVARCHAR(2000),Custom1 NVARCHAR(MAX), Custom2 NVARCHAR(MAX),
			  Custom3 NVARCHAR(MAX))				
			
			Select [Id],[ProductType],[OutOfStockOptions],--[CallForPricing] ,
			 Convert(varchar(300),'') SKU into #PublishProductId from @PublishProductId
			
			UPDATE PDI SET PDI.SKU = ZPPD.SKU 
						from #PublishProductId PDI inner join
						ZnodePublishProductDetail ZPPD On PDI.ID = ZPPD.PublishProductId
		
					--Read price for all products
					--Start
					INSERT INTO @ProductIdForPricing SELECT id FROM @PublishProductId
	 
					INSERT INTO @tbl_PricingSku (sku,RetailPrice ,SalesPrice,TierPrice,TierQuantity,CurrencyCode,CurrencySuffix,CultureCode, ExternalId ,Custom1,Custom2,Custom3)	
					EXEC Znode_GetPublishProductPricingBySku   @SKU=@Sku ,@PortalId=@portaliD  ,@currentUtcDate=@currentUtcDate,@UserId=2,@PublishProductId=@ProductIdForPricing
					--End
					
					--Read Associate Products price only
					--Start

					INSERT INTO #TBL_PricebyCatalogforAssociateProduct (PimProductId ,AssociatedProductId, ParentSKU,ChildSKU,AssociatedProductDisplayOrder,TypeOfProduct ) 
					SELECT ZPP.PublishProductId PublishedId,ZPP1.PublishProductId, PDI.SKU,ChildZPPD.SKU,ZPXML.DisplayOrder ,'ConfigurableProduct'
					from #PublishProductId PDI 
					INNER JOIN ZnodePublishProduct ZPP ON PDI.id = ZPP.PublishProductId
					INNER JOIN ZnodePublishAssociatedProduct ZPXML ON (ZPP.PimProductId = ZPXML.ParentPimProductId) 	
					INNER JOIN ZnodePublishProduct ZPP1 ON ZPXML.PimProductId = ZPP1.PimProductId				
					Left Outer JOIN ZnodePublishProductDetail ChildZPPD On ZPP1.PublishProductId = ChildZPPD.PublishProductId
					WHERE PDI.ProductType = 'ConfigurableProduct' AND ZPXML.IsConfigurable = 1

					INSERT INTO #TBL_PricebyCatalogforAssociateProduct (PimProductId ,AssociatedProductId, ParentSKU,ChildSKU, TypeOfProduct ) 
					SELECT ZPP.PublishProductId,ZPP1.PublishProductId, PDI.SKU,ChildZPPD.SKU,'GroupedProduct'
					FROM #PublishProductId PDI 
					INNER JOIN ZnodePublishProduct ZPP ON PDI.id = ZPP.PublishProductId
					INNER JOIN ZnodePublishAssociatedProduct ZPXML ON (ZPP.PimProductId = ZPXML.ParentPimProductId) 	
					INNER JOIN ZnodePublishProduct ZPP1 ON ZPXML.PimProductId = ZPP1.PimProductId	
					Left Outer JOIN ZnodePublishProductDetail ChildZPPD On ZPP1.PublishProductId = ChildZPPD.PublishProductId
					WHERE PDI.ProductType = 'GroupedProduct' AND ZPXML.IsGroup = 1

				

					DELETE FROM @ProductIdForPricing 
					INSERT INTO @ProductIdForPricing 
					SELECT Distinct AssociatedProductId 
					FROM #TBL_PricebyCatalogforAssociateProduct 
					where AssociatedProductId is not null 

					INSERT INTO #tbl_PricingSkuOfAssociatedProduct (sku,RetailPrice ,SalesPrice,TierPrice,TierQuantity,CurrencyCode,CurrencySuffix,CultureCode, ExternalId,Custom1,Custom2,Custom3 )	
					EXEC Znode_GetPublishProductPricingBySku   @SKU=@Sku ,@PortalId=@portaliD  ,@currentUtcDate=@currentUtcDate,@UserId=2,@PublishProductId=@ProductIdForPricing
								

					update PLC SET PLC.RetailPrice = PLCA.RetailPrice , PLC.SalesPrice = PLCA.SalesPrice 
					FROM #TBL_PricebyCatalogforAssociateProduct PLC 
					INNER JOIN #tbl_PricingSkuOfAssociatedProduct PLCA on PLC.ChildSKU = PLCA.sku
 
		
					SELECT DISTINCT sku,RetailPrice,SalesPrice  INTO #tbl_PricingSku FROM   @tbl_PricingSku 
					UNION  ALL 
					SELECT item sku,NULL RetailPrice  ,NULL SalesPrice FROM dbo.split(@Sku,',') SP  
					WHERE NOT EXISTS (SELECT TOP 1 1  FROM @tbl_PricingSku TBSP WHERE TBSP.sku = Sp.Item) AND @Sku <> ''
					UNION ALL 
					SELECT a.SKU , NULL RetailPrice , NULL SalesPrice  FROM ZnodePublishProductDetail  a INNER JOIN @PublishProductId b ON (b.Id = a.PublishProductId) 
					WHERE LocaleId = @DefaultLocaleId AND NOT EXISTS (SELECT TOP 1 1  FROM @tbl_PricingSku TBSP WHERE TBSP.sku = a.SKU) 
					AND @Sku = ''
							
					Update PBC SET PBC.RetailPrice = 
						(Select min(Isnull(RetailPrice, SalesPrice)) from #TBL_PricebyCatalogforAssociateProduct PCBA  
						where PCBA.ParentSKU =PBC.SKU and PCBA.ParentSKU is not null)
					FROM #tbl_PricingSku  PBC  where 
					EXISTS (Select TOP 1 1  from #TBL_PricebyCatalogforAssociateProduct PCBA  where PCBA.ParentSKU =PBC.SKU and PCBA.TypeOfProduct = 'GroupedProduct')
			      
				 	Update PBC SET PBC.RetailPrice = 
						(Select TOP 1 Isnull(RetailPrice ,SalesPrice) from #TBL_PricebyCatalogforAssociateProduct PCBA  where PCBA.ParentSKU =PBC.SKU
						 and PCBA.ParentSKU is not null and PCBA.ChildSKU is not null
					Order by AssociatedProductDisplayOrder)
					from #tbl_PricingSku  PBC  where 
					Exists (Select TOP 1 1  from #TBL_PricebyCatalogforAssociateProduct PCBA  where PCBA.ParentSKU =PBC.SKU and PCBA.TypeOfProduct = 'ConfigurableProduct')
					and PBC.RetailPrice IS null 
			

 			    If @IsSorting = 1 
				BEGIN
					SET @Order_BY = Replace (@Order_BY,'RetailPrice', 'Case when SalesPrice is not null then SalesPrice else RetailPrice end ')
					
					SET @SQL = 
					';WITH CTE_GetFilteredList AS
					(
						SELECT DISTINCT A.sku,A.RetailPrice,SalesPrice , '+dbo.Fn_GetPagingRowId(@Order_BY,'A.SKU DESC ')+',Count(*)Over() CountNo
						FROM #tbl_PricingSku A 
						WHERE 1=1
						'+dbo.Fn_GetFilterWhereClause(@WhereClause)+'
					)
					SELECT TOP '+Cast(@Rows AS VARCHAR(10))+' SKU,RetailPrice,SalesPrice,RowId,CountNo
					FROM CTE_GetFilteredList
					'+CASE WHEN @Order_BY = '' THEN '' ELSE ' ORDER BY '+ @Order_BY END
					--dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows)+
					
				END
				Else 
				BEGIN
				
					SET @SQL = 
					';WITH CTE_GetFilteredList AS
					(
						SELECT DISTINCT A.sku,A.RetailPrice,A.SalesPrice ,'+dbo.Fn_GetPagingRowId(@Order_BY,'A.SKU DESC ')+',Count(*)Over() CountNo
						FROM #tbl_PricingSku A 
						WHERE 1=1
						'+dbo.Fn_GetFilterWhereClause(@WhereClause)+'
					)
					SELECT TOP '+Cast(@Rows AS VARCHAR(10))+' SKU,RetailPrice,SalesPrice , RowId,CountNo
					FROM CTE_GetFilteredList'
					--'+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows)
					--CASE WHEN @Order_BY = '' THEN '' ELSE ' ORDER BY '+ @Order_BY END
				END
		   

			INSERT INTO @TBL_PricebyCatalog(SKU,RetailPrice,SalesPrice,RowId,CountNo)
			EXEC sys.sp_sqlexec @SQL
        	
			DECLARE @TBL_PricebyCatalogFinalResult TABLE ( SKU NVARCHAR(4000), RetailPrice numeric(28,6),SalesPrice numeric(28,6) , RowId INT,CountNo INT, PublishProductId int  )
	
			IF ( @IsInStock = '-1' )  
			BEGIN 
				INSERT INTO @TBL_PricebyCatalogFinalResult ( SKU,RetailPrice,SalesPrice, RowId ,CountNo,PublishProductId )
				SELECT PBC.SKU,RetailPrice,SalesPrice, RowId ,CountNo,PPI.ID
				FROM @TBL_PricebyCatalog  PBC LEft Outer JOIN #PublishProductId PPI On PBC.SKU = PPI.SKU 
			END
			ELSE IF ( @IsInStock = '1' )
			BEGIN	
				  INSERT INTO @TBL_PricebyCatalogFinalResult ( SKU,RetailPrice,SalesPrice, RowId ,CountNo,PublishProductId )			
					  SELECT PBC.SKU,RetailPrice,SalesPrice, RowId ,CountNo,PPI.ID
					  FROM @TBL_PricebyCatalog  PBC LEft Outer JOIN #PublishProductId PPI On PBC.SKU = PPI.SKU 
					  WHERE EXISTS ( SELECT TOP 1 1 FROM [dbo].[ZnodeInventory] I WHERE I.SKU = PPI.SKU AND 1 =
					  (case when PPI.OutOfStockOptions = 'DisablePurchasing' and I.Quantity < 1 then 0 else 1 end))
					  Union All 
					  SELECT PBC.SKU,RetailPrice,SalesPrice, RowId ,CountNo,PPI.ID
					  FROM @TBL_PricebyCatalog  PBC LEft Outer JOIN #PublishProductId PPI On PBC.SKU = PPI.SKU 
					  WHERE NOT EXISTS ( SELECT TOP 1 1 FROM [dbo].[ZnodeInventory] I WHERE I.SKU = PPI.SKU AND 1 =
					  (case when PPI.OutOfStockOptions = 'DisablePurchasing' and I.Quantity < 1 then 0 else 1 end))
			END
			ELSE IF ( @IsInStock = '0' )
			BEGIN
		
				  INSERT INTO @TBL_PricebyCatalogFinalResult ( SKU,RetailPrice,SalesPrice, RowId ,CountNo,PublishProductId )			
					  SELECT PBC.SKU,RetailPrice,SalesPrice, RowId ,CountNo,PPI.ID
					  FROM @TBL_PricebyCatalog  PBC LEft Outer JOIN #PublishProductId PPI On PBC.SKU = PPI.SKU 
					  WHERE EXISTS ( SELECT TOP 1 1 FROM [dbo].[ZnodeInventory] I WHERE I.SKU = PPI.SKU 
					  AND  PPI.OutOfStockOptions = 'DisablePurchasing' 
					  GROUP BY I.SKU HAVING SUM(I.Quantity ) < 1   )
					  Union all 
					  SELECT PBC.SKU,RetailPrice,SalesPrice,RowId ,CountNo,PPI.ID
					  FROM @TBL_PricebyCatalog  PBC LEft Outer JOIN #PublishProductId PPI On PBC.SKU = PPI.SKU 
					  WHERE NOT EXISTS ( SELECT TOP 1 1 FROM [dbo].[ZnodeInventory] I WHERE I.SKU = PPI.SKU 
					  AND  PPI.OutOfStockOptions = 'DisablePurchasing' 
					  GROUP BY I.SKU HAVING SUM(I.Quantity ) < 1   )

			END

			SET @RowsCount =ISNULL((SELECT TOP 1 CountNo FROM @TBL_PricebyCatalogFinalResult),0)

			SELECT SKU,RetailPrice,SalesPrice,PublishProductId FROM @TBL_PricebyCatalogFinalResult
			--Order by Isnull(RetailPrice,SalesPrice)
			
		END TRY
		BEGIN CATCH
		DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetSkuPricebyCatalog @WhereClause = '
			 +CAST(@WhereClause AS VARCHAR(MAX))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))
			 +',@Order_BY='+@Order_BY+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@LocaleId='+CAST(@LocaleId AS VARCHAR(20))
			 +',@PortalId= '+cast(@PortalId as varchar(200))+',@currentUtcDate= '
			 +@currentUtcDate+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status,ERROR_MESSAGE();                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetSkuPricebyCatalog',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;

		END CATCH

	END

GO

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'Products','GetAssociatedBundleProducts',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'Products' and ActionName = 'GetAssociatedBundleProducts')

INSERT INTO ZnodeMenuActionsPermission (MenuId,ActionId,AccessPermissionId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select TOP 1 MenuId from ZnodeMenu where MenuName='PIM'), 
(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Products' and ActionName= 'GetAssociatedBundleProducts'),1,2,getdate(),2,getdate()
where exists(select TOP 1 MenuId from ZnodeMenu where MenuName='PIM') and
exists(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Products' and ActionName= 'GetAssociatedBundleProducts')
and not exists(select * from ZnodeMenuActionsPermission where MenuId = (select TOP 1 MenuId from ZnodeMenu where MenuName='PIM')
and ActionId =(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Products' and ActionName= 'GetAssociatedBundleProducts'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
SELECT (select TOP 1 MenuId from ZnodeMenu where MenuName='Products'), 
(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Products' and ActionName= 'GetAssociatedBundleProducts'),1,2,getdate(),2,getdate()
where exists(select TOP 1 MenuId from ZnodeMenu where MenuName='Products') and
exists(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Products' and ActionName= 'GetAssociatedBundleProducts')
and not exists(select * from ZnodeMenuActionsPermission where MenuId = (select TOP 1 MenuId from ZnodeMenu where MenuName='Products')
and ActionId =(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Products' and ActionName= 'GetAssociatedBundleProducts'))

GO

UPDATE ZnodeState SET StateName = dbo.Fn_CamelCase(ltrim(rtrim(replace(StateName,'','')))) 
WHERE StateName like '%'

UPDATE ZnodeState SET StateName = dbo.Fn_CamelCase(ltrim(rtrim(StateName))) 

UPDATE ZnodeState SET StateName = replace(dbo.Fn_CamelCase(ltrim(rtrim(replace(StateName,'-',' - ')))),' - ','-') 
where StateName like '%-%'

UPDATE ZnodeState SET StateName = replace(dbo.Fn_CamelCase(ltrim(rtrim(replace(StateName,'(',' ( ')))),' ( ','(') 
where StateName like '%(%'

UPDATE ZnodeState SET StateName = replace(dbo.Fn_CamelCase(ltrim(rtrim(replace(StateName,'[',' [ ')))),' [ ','[') 
where StateName like '%[%'

UPDATE ZnodeState SET StateName = replace(dbo.Fn_CamelCase(ltrim(rtrim(replace(StateName,'(','( ')))),'( ','(')
where StateName like '%(%'UPDATE ZnodeState SET StateName = dbo.Fn_CamelCase(ltrim(rtrim(replace(StateName,substring(StateName,1,1),''))))
WHERE CountryCode = 'MX'

GO

UPDATE ZnodeState SET StateName = dbo.Fn_CamelCase(ltrim(rtrim(replace(StateName,'','')))) 
WHERE StateName like '%' and  countrycode ='mx'

UPDATE ZnodeState SET StateName = dbo.Fn_CamelCase(ltrim(rtrim(StateName))) 

UPDATE ZnodeState SET StateName = replace(dbo.Fn_CamelCase(ltrim(rtrim(replace(StateName,'-',' - ')))),' - ','-') 
where StateName like '%-%'

UPDATE ZnodeState SET StateName = replace(dbo.Fn_CamelCase(ltrim(rtrim(replace(StateName,'(',' ( ')))),' ( ','(') 
where StateName like '%(%'

UPDATE ZnodeState SET StateName = replace(dbo.Fn_CamelCase(ltrim(rtrim(replace(StateName,'[',' [ ')))),' [ ','[') 
where StateName like '%[%'


UPDATE ZnodeState SET StateName = dbo.Fn_CamelCase(ltrim(rtrim(replace(StateName,substring(StateName,1,1),''))))
WHERE CountryCode = 'MX' and substring(StateName,1,1) not like '%[a-Z]%'


UPDATE ZnodeState SET StateName = replace(dbo.Fn_CamelCase(ltrim(rtrim(replace(StateName,'(','( ')))),'( ','(')
where StateName like '%(%'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemBundle')
	DROP PROC Znode_InsertUpdateSaveCartLineItemBundle

GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemBundle]
 (
	 @SaveCartLineItemType TT_SavecartLineitems READONLY  
	,@Userid  INT = 0
	,@OrderLineItemRelationshipTypeIdBundle INT
	,@OrderLineItemRelationshipTypeIdAddon INT
 )
AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 
    --Declared the variables
    DECLARE @GetDate datetime= dbo.Fn_GetDate(); 
   
	DECLARE @OmsInsertedData TABLE (OmsSavedCartLineItemId INT ) 	
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId INT,BundleProductIds VARCHAR(600) ,PersonalizeCode NVARCHAR(MAX),PersonalizeValue NVARCHAR(MAX),DesignId NVARCHAR(MAX), ThumbnailURL NVARCHAR(MAX))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.BundleProductIds
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(MAX)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(MAX)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(MAX)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(MAX)' ) AS ThumbnailURL
	FROM @SaveCartLineItemType a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col) 

	CREATE TABLE #NewBundleSavecartLineitemDetails 
	(
		GenId INT IDENTITY(1,1),RowId	INT	,OmsSavedCartLineItemId	INT	 ,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	INT
		,SKU	NVARCHAR(MAX) ,Quantity	NUMERIC(28,6)	,OrderLineItemRelationshipTypeID	INT	,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	INT	,AutoAddon	VARCHAR(MAX)	,OmsOrderId	INT	,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX)
	)
	
	--Getting new save cart data(bundle product)
	INSERT INTO #NewBundleSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU 
	FROM @SaveCartLineItemType a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
	 
	--Getting new bundle product save cart data
	INSERT INTO #NewBundleSavecartLineitemDetails 
	SELECT   Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, BundleProductIds
				,Quantity, @OrderLineItemRelationshipTypeIdBundle, CustomText, CartAddOnDetails, Sequence
				,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU  
	FROM @SaveCartLineItemType  a 
	WHERE BundleProductIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, BundleProductIds
	,Quantity,  CustomText, CartAddOnDetails, Sequence ,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
		
	--Getting new Bundle products save cart data if addon is present for any line item
	INSERT INTO #NewBundleSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
	,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
			WHEN  GroupProductIds <> '' THEN GroupProductIds 
			WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU 
	FROM @SaveCartLineItemType  a 
	WHERE AddOnValueIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU

    CREATE TABLE #OldBundleSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old bundle save cart data if present for same SKU in the new save cart data for bundle product		 
	INSERT INTO #OldBundleSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM ZnodeOmsSavedCartLineItem a   
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.BundleProductIds,'')   )   
    AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle   

	--Getting the old save cart Parent data
	INSERT INTO #OldBundleSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b 
	INNER JOIN #OldBundleSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
	AND  b.OrderLineItemRelationshipTypeID IS NULL 

	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldBundleSavecartLineitemDetails

	DELETE a FROM #OldBundleSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldBundleSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 

	--Getting the old bundle product save cart addon data for old line items if present
	INSERT INTO #OldBundleSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b 
	INNER JOIN #OldBundleSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
	AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon	

		------Merge Addon for same product
		IF EXISTS(SELECT * FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
		BEGIN

			INSERT INTO #OldValueForAddon 
			SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
			FROM ZnodeOmsSavedCartLineItem b 
			INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
			WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
			AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
									( SELECT  ', ' + SKU FROM    
										( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
											WHERE a.ParentOmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
											FOR XML PATH('')
									), 1, 2, ''
									) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a WHERE a.ParentOmsSavedCartLineItemId is not null and OrderLineItemRelationshipTypeID<>1

		SELECT distinct a.BundleProductIds SKU, STUFF(
										( SELECT  ', ' + x.AddOnValueIds FROM    
										( SELECT DISTINCT b.AddOnValueIds FROM @SaveCartLineItemType b
											WHERE a.SKU=b.SKU ) x
											FOR XML PATH('')
										), 1, 2, ''
									) AddOns
		INTO #AddOnAdded
		FROM @SaveCartLineItemType a

		if NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
		begin
			DELETE FROM #OldBundleSavecartLineitemDetails
		end

		END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @SaveCartLineItemType ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldBundleSavecartLineitemDetails a WHERE	
	ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
	AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN 
		
		DELETE FROM #OldBundleSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
		BEGIN 

			 DECLARE @parenTofAddon INT  = 0 
			 SET @parenTofAddon = (SELECT TOP 1 ParentOmsSavedCartLineItemId 
			 FROM #OldBundleSavecartLineitemDetails a
			 WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
			 AND (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem  t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId AND   t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			  )

			 DELETE FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId <> @parenTofAddon  AND ParentOmsSavedCartLineItemId IS NOT NULL  

			 DELETE FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldBundleSavecartLineitemDetails m)
			 AND ParentOmsSavedCartLineItemId IS  NULL  
		 
			 IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			  BEGIN 
				DELETE FROM #OldBundleSavecartLineitemDetails
			  END 
			IF (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem   WHERE ParentOmsSavedCartLineItemId =@parenTofAddon AND   OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			BEGIN 
				DELETE FROM #OldBundleSavecartLineitemDetails
			END 

		 END 
		 ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		 BEGIN 
		    DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM ZnodeOmsSavedCartLineItem a 
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
			OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		 END 
		 ELSE IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  BEGIN 
		    DELETE FROM #OldBundleSavecartLineitemDetails
		  END 
		   ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		      AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  = '' )
		 BEGIN 
		   DELETE FROM #OldBundleSavecartLineitemDetails
		 END 

	END 
	
	--Getting the personalise data for old save cart if present
	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		DELETE FROM #OldBundleSavecartLineitemDetails
	END 
	ELSE 
	BEGIN 
		 IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) <>
		     (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM ZnodeOmsSavedCartLineItem WHERE ParentOmsSavedCartLineItemId IS nULL and OmsSavedCartLineItemId in (select OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails)  )
		 BEGIN 
		   
			   DELETE FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
			   SELECT OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			   AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
			   OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			   AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		 
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) <>
		     (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM ZnodeOmsSavedCartLineItem WHERE ParentOmsSavedCartLineItemId IS nULL and OmsSavedCartLineItemId in (select OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails)  )
		 BEGIN 
		   
			   DELETE n FROM #OldBundleSavecartLineitemDetails n WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
			   OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
		
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		        AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldBundleSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
		       AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		 BEGIN 
		     DELETE FROM #OldBundleSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		 END 
		END 

	IF EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails )
	BEGIN 
		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU not having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*
			FROM @SaveCartLineItemType a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on ( a.BundleProductIds = b.SKU or a.SKU = b.sku)
			WHERE isnull(cast(a.PersonalisedAttribute AS varchar(max)),'') = ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId
			FROM #OldBundleSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
		)
		DELETE a FROM #OldBundleSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*, 
				a.PersonalizeCode
				,a.PersonalizeValue
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on ( a.BundleProductIds = b.SKU )
			WHERE isnull(a.PersonalizeValue,'') <> ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId, b.PersonalizeCode, b.PersonalizeValue
			FROM #OldBundleSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
			WHERE NOT EXISTS(SELECT * FROM cte c WHERE b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and b.PersonalizeCode = c.PersonalizeCode 
								and b.PersonalizeValue = c.PersonalizeValue )
		)
		DELETE a FROM #OldBundleSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)


		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,b.ParentOmsSavedCartLineItemId , a.BundleProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on a.BundleProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM #OldBundleSavecartLineitemDetails b1 
		WHERE NOT EXISTS(SELECT * FROM cte c WHERE (b1.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or b1.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId))
		AND EXISTS(SELECT * FROM cte)

		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.BundleProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on a.BundleProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE c1
		FROM cte a1		  
		INNER JOIN #OldBundleSavecartLineitemDetails b1 on a1.SKU = b1.SKU
		INNER JOIN #OldBundleSavecartLineitemDetails c1 on (b1.ParentOmsSavedCartLineItemId = c1.OmsSavedCartLineItemId OR b1.OmsSavedCartLineItemId = c1.OmsSavedCartLineItemId)
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c WHERE a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and a1.PersonalizeValue = c.PersonalizeValue)

		--Updating the cart if old and new cart data matches	
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5,
		a.ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldBundleSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewBundleSavecartLineitemDetails ty ON (ty.SKU = b.SKU)
		WHERE a.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon

		 UPDATE a
		 SET a.Quantity = a.Quantity+s.AddOnQuantity,
		 a.ModifiedDate = @GetDate
		 FROM ZnodeOmsSavedCartLineItem a
		 INNER JOIN #OldBundleSavecartLineitemDetails b ON (a.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		 INNER JOIN @SaveCartLineItemType S on a.OmsSavedCartId = s.OmsSavedCartId and a.SKU = s.AddOnValueIds
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon

		 --UPDATE Ab SET ab.Quantity = a.Quantity   
   --      FROM ZnodeOmsSavedCartLineItem a  
   --      INNER JOIN ZnodeOmsSavedCartLineItem ab ON (ab.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)  
   --      INNER JOIN @SaveCartLineItemType b ON (a.OmsSavedCartId = b.OmsSavedCartId  )   
		 --WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle  

		 UPDATE Ab 
		 SET Ab.Quantity = Ab.Quantity+ty.Quantity,
		 Ab.Custom1 = ty.Custom1,
		 Ab.Custom2 = ty.Custom2,
		 Ab.Custom3 = ty.Custom3,
		 Ab.Custom4 = ty.Custom4,
		 Ab.Custom5 = ty.Custom5,
		 ab.ModifiedDate = @GetDate  
         FROM ZnodeOmsSavedCartLineItem a  
         INNER JOIN ZnodeOmsSavedCartLineItem ab ON (ab.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)  
         INNER JOIN @SaveCartLineItemType b ON (a.OmsSavedCartId = b.OmsSavedCartId  ) 
		 INNER JOIN #NewBundleSavecartLineitemDetails ty ON (ty.SKU = b.SKU)  
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle  
		 AND EXISTS(SELECT * FROM #OldBundleSavecartLineitemDetails ov WHERE a.OmsSavedCartLineItemId = ov.OmsSavedCartLineItemId)  

	END 
	--Inserting the new save cart data if old and new cart data not match
	ELSE 
	BEGIN 
			
		UPDATE #NewBundleSavecartLineitemDetails
		SET ParentSKU = (SELECT TOP 1 SKU FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID IS NULL )
		WHERE OrderLineItemRelationshipTypeID  = @OrderLineItemRelationshipTypeIdAddon 
		AND EXISTS (SELECT TOP 1 1 FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle) 
		
		--Getting the new save cart data and generating row no. for new save cart insert
		SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU  
		 INTO #InsertNewBundleSavecartLineitem   
		 FROM  #NewBundleSavecartLineitemDetails  
		 GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU   
		 ORDER BY RowId, Id   
   
		--Removing the line item having Quantity <=0 
		DELETE FROM #InsertNewBundleSavecartLineitem WHERE Quantity <=0  

		;WITH Add_Dup AS
		(
			SELECT  Min(NewRowId)NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID 
			FROM  #InsertNewBundleSavecartLineitem
			GROUP BY SKU ,ParentSKU  ,OrderLineItemRelationshipTypeID
			HAVING OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon	
		)
		DELETE FROM #InsertNewBundleSavecartLineitem
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM Add_Dup WHERE Add_Dup.NewRowId = #InsertNewBundleSavecartLineitem.NewRowId)
		AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		--Updating the rowid INTo new save cart line item AS new line item is merged INTo existing save cart item
		 ;WITH VTTY AS   
		(  
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
			   FROM #InsertNewBundleSavecartLineitem m  
			INNER JOIN  #InsertNewBundleSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU   
			WHERE m.OrderLineItemRelationshipTypeID IN ( @OrderLineItemRelationshipTypeIdAddon , @OrderLineItemRelationshipTypeIdBundle)   
		)   
		UPDATE m1   
		SET m1.RowId = TYU.RowId  
		FROM #InsertNewBundleSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  
      
		--Deleting the new save cart line item if cart line item is merged
		;WITH VTRET AS   
		(  
			SELECT RowId,id,Min(NewRowId)NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID   
			FROM #InsertNewBundleSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU  ,OrderLineItemRelationshipTypeID  
			Having  SKU = ParentSKU  AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		)   
		DELETE FROM #InsertNewBundleSavecartLineitem WHERE NewRowId  IN (SELECT NewRowId FROM VTRET)   
     
	   --Inserting the new cart line item if not merged in existing save cart line item
       INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description)  
       OUTPUT INSERTED.OmsSavedCartLineItemId  INTO @OmsInsertedData 
	   SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description   
       FROM  #InsertNewBundleSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU 
		INTO #Cte_newData 
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
		AND a.ParentOmsSavedCartLineItemId IS nULL  
		AND  EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) 
  
		--------------------------------------------------------------------------------------------------------

		SELECT  MIN(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU  
		INTO #ParentOmsSavedCartId
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #ParentOmsSavedCartId  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon   
		AND  EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) 
		AND  a.sequence in (SELECT  MIN(ab.sequence) FROM ZnodeOmsSavedCartLineItem ab WHERE a.OmsSavedCartId = ab.OmsSavedCartId and 
		 a.SKU = ab.sku and ab.OrderLineItemRelationshipTypeId is not null  ) 

		-----------------------------------------------------------------------------------------------------

		SELECT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(Order BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #NewBuldleProduct
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( CASE WHEN EXISTS (SELECT TOP 1 1 FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle) THEN 0 ELSE 1 END = b.id OR b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c on b.sku = c.sku and b.OmsSavedCartId=c.OmsSavedCartId and b.Id = 1
		WHERE ( CASE WHEN EXISTS (SELECT TOP 1 1 FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle) THEN 0 ELSE 1 END = ISNULL(a.ParentOmsSavedCartLineItemId,0) OR ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  AND c.ParentOmsSavedCartLineItemId IS NULL

	   ;WITH table_update AS 
	   (
		 SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId  ) RowIdNo
		 FROM ZnodeOmsSavedCartLineItem a
		 WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		 AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
		 AND a.ParentOmsSavedCartLineItemId IS NULL  
		 AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewBundleSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
		 AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
	   )
		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewBuldleProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId) 
			FROM #NewBuldleProduct  r  
			WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )    IS NOT NULL 
	 
  
		;WITH Cte_Th AS   
		(             
			  SELECT RowId    
			 FROM #InsertNewBundleSavecartLineitem a   
			 GROUP BY RowId   
			 HAVING COUNT(NewRowId) <= 1   
		)   
		UPDATE a SET a.Quantity =  NULL,
			a.ModifiedDate = @GetDate   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		 AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE Ab SET ab.Quantity = a.Quantity,
			ab.ModifiedDate = @GetDate   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN ZnodeOmsSavedCartLineItem ab ON (ab.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)  
		INNER JOIN @SaveCartLineItemType b ON (a.OmsSavedCartId = b.OmsSavedCartId  )   
		WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle  

		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewBundleSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		AND OrderLineItemRelationshipTypeId IS NOT NULL     
       
	   ;WITH Cte_UpdateSequence AS   
		 (  
		   SELECT OmsSavedCartLineItemId ,Row_Number()Over(Order By OmsSavedCartLineItemId) RowId , Sequence   
		   FROM ZnodeOmsSavedCartLineItem   
		   WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewBundleSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		 )   
		UPDATE Cte_UpdateSequence  
		SET  Sequence = RowId  
			
		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN ZnodeOmsSavedCartLineItem b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS not nULL
		and b.OmsSavedCartLineItemId = (select min(OmsSavedCartLineItemId) FROM @OmsInsertedData d WHERE b.OmsSavedCartLineItemId = d.OmsSavedCartLineItemId)
	 
		DELETE FROM ZnodeOmsPersonalizeCartItem	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
			
		----Inserting saved cart item personalise value FROM given line item
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
			   ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			   WHEN NOT MATCHED THEN 
				INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
				VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
  
		
		END 
END TRY
BEGIN CATCH 
  SELECT ERROR_MESSAGE()
END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemConfigurable')
	DROP PROC Znode_InsertUpdateSaveCartLineItemConfigurable

GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemConfigurable]
 (
	 @SaveCartLineItemType TT_SavecartLineitems READONLY  
	,@Userid  INT = 0 
	,@OrderLineItemRelationshipTypeIdConfigurable INT
	,@OrderLineItemRelationshipTypeIdAddon INT	
)
AS 
BEGIN 
BEGIN TRY 
 SET NOCOUNT ON 
	--Declared the variables
    DECLARE @GetDate datetime= dbo.Fn_GetDate(); 
   
	DECLARE @OmsInsertedData TABLE (OmsSavedCartLineItemId INT, OmsSavedCartId INT,SKU NVARCHAr(max),GroupId  NVARCHAr(max),ParentOmsSavedCartLineItemId INT,OrderLineItemRelationshipTypeId INT  ) 
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId INT,ConfigurableProductIds VARCHAR(600) ,PersonalizeCode NVARCHAR(MAX),PersonalizeValue NVARCHAR(MAX),DesignId NVARCHAR(MAX), ThumbnailURL NVARCHAR(MAX))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.ConfigurableProductIds
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(MAX)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(MAX)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(MAX)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(MAX)' ) AS ThumbnailURL
	FROM @SaveCartLineItemType a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  

	 CREATE TABLE #NewConfigSavecartLineitemDetails 
	 (
		 GenId INT IDENTITY(1,1),RowId	INT	,OmsSavedCartLineItemId	INT	 ,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	INT
		,SKU	NVARCHAR(MAX) ,Quantity	NUMERIC(28,6)	,OrderLineItemRelationshipTypeID	INT	,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	INT	,AutoAddon	VARCHAR(MAX)	,OmsOrderId	INT	,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX)
	)
	 
	--Getting new save cart data(configurable product)
	INSERT INTO #NewConfigSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU 
	FROM @SaveCartLineItemType a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
	 
	--Getting new configurable product save cart data
	INSERT INTO #NewConfigSavecartLineitemDetails 
	SELECT   Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, ConfigurableProductIds
				,Quantity, @OrderLineItemRelationshipTypeIdConfigurable, CustomText, CartAddOnDetails, Sequence
				,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU  
	FROM @SaveCartLineItemType  a 
	WHERE ConfigurableProductIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, ConfigurableProductIds
	,Quantity,  CustomText, CartAddOnDetails, Sequence ,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
	
	--Getting new configurable products save cart data if addon is present for any line item
	INSERT INTO #NewConfigSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
	,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
			WHEN  GroupProductIds <> '' THEN GroupProductIds 
			WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU 
	FROM @SaveCartLineItemType  a 
	WHERE AddOnValueIds <> ''
		GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
		 
		 SELECT * 
		INTO #ZnodeOmsSavedCartLineItem_NT
		FROM ZnodeOmsSavedCartLineItem a 
		WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId)

    CREATE TABLE #OldConfigSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old configurable save cart data if present for same SKU in the new save cart data for configurable product	 
	INSERT INTO #OldConfigSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM #ZnodeOmsSavedCartLineItem_NT a   
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.ConfigurableProductIds,'')   )   
    AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable   

	--Getting the old save cart Parent data
	INSERT INTO #OldConfigSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM #ZnodeOmsSavedCartLineItem_NT b 
	INNER JOIN #OldConfigSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
	AND  b.OrderLineItemRelationshipTypeID IS NULL 
		
	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldConfigSavecartLineitemDetails
		  
	DELETE a FROM #OldConfigSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldConfigSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 

	INSERT INTO #OldConfigSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM #ZnodeOmsSavedCartLineItem_NT b 
	INNER JOIN #OldConfigSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
	AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon
		
		------Merge Addon for same product
		IF EXISTS(SELECT * FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
		BEGIN
		
		
			INSERT INTO #OldValueForAddon 
			SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
			FROM #ZnodeOmsSavedCartLineItem_NT b 
			INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
			WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
			AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
									( SELECT  ', ' + SKU FROM    
										( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
											where a.OmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId AND OrderLineItemRelationshipTypeID = 1 ) x 
											FOR XML PATH('')
									), 1, 2, ''
									) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a where a.ParentOmsSavedCartLineItemId is not null AND OrderLineItemRelationshipTypeID<>1

		SELECT distinct a.ConfigurableProductIds SKU, STUFF(
										( SELECT  ', ' + x.AddOnValueIds FROM    
										( SELECT DISTINCT b.AddOnValueIds FROM @SaveCartLineItemType b
											where a.SKU=b.SKU ) x
											FOR XML PATH('')
										), 1, 2, ''
									) AddOns
		INTO #AddOnAdded
		FROM @SaveCartLineItemType a

			

		IF NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b ON a.SKU = b.SKU AND a.AddOns = b.AddOns )
		BEGIN
			   
			DELETE FROM #OldConfigSavecartLineitemDetails 
	
		END

	END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @SaveCartLineItemType ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldConfigSavecartLineitemDetails a WHERE	
	ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
	AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN 
		
		DELETE FROM #OldConfigSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		
		 IF EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
		 BEGIN 
		 
			 DECLARE @parenTofAddon  TABLE( ParentOmsSavedCartLineItemId INT  )  
			 INSERT INTO  @parenTofAddon 
			 SELECT  ParentOmsSavedCartLineItemId FROM #OldConfigSavecartLineitemDetails a  WHERE a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
			 AND (SELECT COUNT (DISTINCT SKU ) FROM  #ZnodeOmsSavedCartLineItem_NT  t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId AND   t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM  #NewConfigSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  

			 DELETE FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ParentOmsSavedCartLineItemId FROM  @parenTofAddon)   
					AND ParentOmsSavedCartLineItemId IS NOT NULL  
					AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

			 DELETE FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldConfigSavecartLineitemDetails m)
			 AND ParentOmsSavedCartLineItemId IS  NULL  
		 
			 IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldConfigSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewConfigSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			 BEGIN 
				DELETE FROM #OldConfigSavecartLineitemDetails 
			 END 
			 IF (SELECT COUNT (DISTINCT SKU ) FROM  #ZnodeOmsSavedCartLineItem_NT   WHERE ParentOmsSavedCartLineItemId IN (SELECT ParentOmsSavedCartLineItemId FROM @parenTofAddon)AND   OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewConfigSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			 BEGIN 
				DELETE FROM #OldConfigSavecartLineitemDetails 
			 END 

		 END 
		 ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		 BEGIN 
		 -- SELECT 3
		    DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM #ZnodeOmsSavedCartLineItem_NT a 
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable  )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
			OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		    
			 DELETE FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldConfigSavecartLineitemDetails m)
		    AND ParentOmsSavedCartLineItemId IS  NULL  

		 END
		 ELSE IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldConfigSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewConfigSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  BEGIN 
		    DELETE FROM #OldConfigSavecartLineitemDetails 
		  END  
		 ELSE IF  EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsSavedCartLineItem_NT Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		      AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  = '' )
		 BEGIN 
		   DELETE FROM #OldConfigSavecartLineitemDetails 
		 END 

		END 

	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	--Getting the personalise data for old save cart if present		
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		 DELETE FROM #OldConfigSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		 IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 BEGIN 
		    DELETE FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
		    SELECT OmsSavedCartLineItemId FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
		    AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
		    OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
		    AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 BEGIN 
		 
		   DELETE n FROM #OldConfigSavecartLineitemDetails n WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
		   OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
	
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		        AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldConfigSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
		       AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		 BEGIN 
		     DELETE FROM #OldConfigSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		 END 
		END 

	IF EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails )
	BEGIN
		--------If lineitem present in ZnodeOmsPersonalizeCartItem AND personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem AND personalize value is same for same line item then Quantity will added
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.ConfigurableProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldConfigSavecartLineitemDetails b ON a.ConfigurableProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE c1
		FROM cte a1		  
		INNER JOIN #OldConfigSavecartLineitemDetails b1 ON a1.SKU = b1.SKU
		INNER JOIN #OldConfigSavecartLineitemDetails c1 ON (b1.ParentOmsSavedCartLineItemId = c1.OmsSavedCartLineItemId OR b1.OmsSavedCartLineItemId = c1.OmsSavedCartLineItemId)
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c where a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId AND a1.PersonalizeValue = c.PersonalizeValue)

		--Updating the cart if old and new cart data matches
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5,
		a.ModifiedDate = @GetDate  
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldConfigSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewConfigSavecartLineitemDetails ty ON (ty.SKU = b.SKU)
		WHERE a.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon
		 
		 UPDATE a
		 SET a.Quantity = a.Quantity+s.AddOnQuantity,
		 a.ModifiedDate = @GetDate
		 FROM ZnodeOmsSavedCartLineItem a
		 INNER JOIN #OldConfigSavecartLineitemDetails b ON (a.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		 INNER JOIN @SaveCartLineItemType S ON a.OmsSavedCartId = s.OmsSavedCartId AND a.SKU = s.AddOnValueIds
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
	END 
	--Inserting the new save cart data if old and new cart data not match
	ELSE 
	BEGIN 
		--Getting the new save cart data and generating row no. for new save cart insert
		SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU  
		 INTO #InsertNewConfigSavecartLineitem   
		 FROM  #NewConfigSavecartLineitemDetails  
		 GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU   
		 ORDER BY RowId, Id   
       	    
		--Removing the line item having Quantity <=0 
		DELETE FROM #InsertNewConfigSavecartLineitem WHERE Quantity <=0  
  
		--Updating the rowid INTo new save cart line item as new line item is merged INTo existing save cart item
		 ;WITH VTTY AS   
		(  
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
			   FROM #InsertNewConfigSavecartLineitem m  
			INNER JOIN  #InsertNewConfigSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU   
			WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon   
		)   
		UPDATE m1   
		SET m1.RowId = TYU.RowId  
		FROM #InsertNewConfigSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  
           
		;WITH VTRET AS   
		(  
			SELECT RowId,id,Min(NewRowId)NewRowId ,SKU ,ParentSKU  ,OrderLineItemRelationshipTypeID  
			FROM #InsertNewConfigSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU  ,OrderLineItemRelationshipTypeID  
			Having  SKU = ParentSKU  AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		)   
		DELETE FROM #InsertNewConfigSavecartLineitem WHERE NewRowId  IN (SELECT NewRowId FROM VTRET)   
     
	   --Inserting the new cart line item if not merged in existing save cart line item
       INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,Sequence,	CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description)  
        OUTPUT INSERTED.OmsSavedCartLineItemId,INSERTED.OmsSavedCartId,inserted.SKU,inserted.GroupId,INSERTED.ParentOmsSavedCartLineItemId,INSERTED.OrderLineItemRelationshipTypeId  INTO @OmsInsertedData 
	   SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description   
       FROM  #InsertNewConfigSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU
		INTO   #Cte_newData
		FROM @OmsInsertedData a  
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			  
	
		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
		AND a.ParentOmsSavedCartLineItemId IS nULL   
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )

	---------------------------------------------------------------------------------------------------------------------

		SELECT  MIN(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU 
		INTO #Cte_newData1 
		FROM @OmsInsertedData a  
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData1  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon     
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
		AND  a.sequence in (SELECT  MIN(ab.sequence) FROM ZnodeOmsSavedCartLineItem ab where a.OmsSavedCartId = ab.OmsSavedCartId AND 
		 a.SKU = ab.sku AND ab.OrderLineItemRelationshipTypeId is not null  ) 
 
	---------------------------------------------------------------------------------------------------------------------------

		SELECT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(Order BY c.OmsSavedCartLineItemId  )RowIdNo
		INTO #NewConfigProduct
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c with (nolock) ON b.sku = c.sku AND b.OmsSavedCartId=c.OmsSavedCartId AND b.Id = 1 
		WHERE ( ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) AND c.ParentOmsSavedCartLineItemId is null
  
	   ;WITH table_update AS 
	   (
		 SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId  ) RowIdNo
		 FROM ZnodeOmsSavedCartLineItem a with (nolock)
		 WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		 AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
		 AND a.ParentOmsSavedCartLineItemId IS NULL  
		 AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewConfigSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
		 AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
	   )
		UPDATE a SET  
		a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 max(OmsSavedCartLineItemId) 
			FROM #NewConfigProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId) 
			FROM #NewConfigProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )    IS nOT NULL 

		;WITH Cte_Th AS   
		(             
			  SELECT RowId    
			 FROM #InsertNewConfigSavecartLineitem a   
			 GROUP BY RowId   
			 HAVING COUNT(NewRowId) <= 1   
		)   
		UPDATE a SET a.Quantity =  NULL,
			a.ModifiedDate = @GetDate   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		 AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewConfigSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		AND OrderLineItemRelationshipTypeId IS NOT NULL     
       
	   ;WITH Cte_UpdateSequence AS   
		(  
		   SELECT OmsSavedCartLineItemId ,Row_Number()Over(Order By OmsSavedCartLineItemId) RowId , Sequence   
		   FROM ZnodeOmsSavedCartLineItem   
		   WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewConfigSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		)   
		UPDATE Cte_UpdateSequence  
		SET  Sequence = RowId  

		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN ZnodeOmsSavedCartLineItem b with (nolock) ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId  AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS not nULL 
	
		DELETE FROM ZnodeOmsPersonalizeCartItem WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
		
		----Inserting saved cart item personalise value FROM given line item
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
			   ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			   WHEN NOT MATCHED THEN 
				INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
				VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
  
		
		END 




END TRY
BEGIN CATCH 
  SELECT ERROR_MESSAGE()
END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemGroup')
	DROP PROC Znode_InsertUpdateSaveCartLineItemGroup

GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemGroup]
 (
	 @SaveCartLineItemType TT_SavecartLineitems READONLY  
	,@Userid  INT = 0 
	,@OrderLineItemRelationshipTypeIdGroup INT
	,@OrderLineItemRelationshipTypeIdAddon INT
 )
AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 
	--Declared the variables
	DECLARE @GetDate datetime= dbo.Fn_GetDate(); 
	
	DECLARE @OmsInsertedData TABLE (SKU varchar(600),OmsSavedCartLineItemId INT ) 	
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId INT,GroupProductIds VARCHAR(600) ,PersonalizeCode NVARCHAR(MAX),PersonalizeValue NVARCHAR(MAX),DesignId NVARCHAR(MAX), ThumbnailURL NVARCHAR(MAX))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.GroupProductIds
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(MAX)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(MAX)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(MAX)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(MAX)' ) AS ThumbnailURL
	FROM @SaveCartLineItemType a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  

	CREATE TABLE #NewGroupSavecartLineitemDetails 
	(
		GenId INT IDENTITY(1,1),RowId	INT ,OmsSavedCartLineItemId	INT,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	int
		,SKU	NVARCHAR(MAX) ,Quantity	numeric(28,6)	,OrderLineItemRelationshipTypeID	INT ,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	INT ,AutoAddon	VARCHAR(MAX)	,OmsOrderId	INT ,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX)
	)
	 
	--Getting new save cart data(group product)
	INSERT INTO #NewGroupSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU 
	FROM @SaveCartLineItemType a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
	 
	--Getting new group product save cart data
	INSERT INTO #NewGroupSavecartLineitemDetails 
	SELECT   Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, GroupProductIds
				,Quantity, @OrderLineItemRelationshipTypeIdGroup, CustomText, CartAddOnDetails, Sequence
				,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU  
	FROM @SaveCartLineItemType  a 
	WHERE GroupProductIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, GroupProductIds
	,Quantity,  CustomText, CartAddOnDetails, Sequence ,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
		
	--Getting new group products save cart data if addon is present for any line item
	INSERT INTO #NewGroupSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
	,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
			WHEN  GroupProductIds <> '' THEN GroupProductIds 
			WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU 
	FROM @SaveCartLineItemType  a 
	WHERE AddOnValueIds <> ''
		GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
		 

	CREATE TABLE #OldGroupSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old group save cart data if present for same SKU in the new save cart data for group product	 	 
	INSERT INTO #OldGroupSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM ZnodeOmsSavedCartLineItem a with (nolock)  
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.GroupProductIds,'')   )   
	AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup   

	--Getting the old save cart Parent data
	INSERT INTO #OldGroupSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldGroupSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
	AND  b.OrderLineItemRelationshipTypeID IS NULL 

	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldGroupSavecartLineitemDetails

	DELETE a FROM #OldGroupSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldGroupSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 

	--Getting the old config product save cart addon data for old line items if present
	INSERT INTO #OldGroupSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldGroupSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
	AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		------Merge Addon for same product
		IF EXISTS(SELECT * FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
		BEGIN

			INSERT INTO #OldValueForAddon 
			SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
			FROM ZnodeOmsSavedCartLineItem b 
			INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
			WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
			AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
									( SELECT  ', ' + SKU FROM    
										( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
											where a.OmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
											FOR XML PATH('')
									), 1, 2, ''
									) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a where a.ParentOmsSavedCartLineItemId is not null and OrderLineItemRelationshipTypeID<>1

		SELECT distinct a.GroupProductIds SKU, STUFF(
										( SELECT  ', ' + x.AddOnValueIds FROM    
										( SELECT DISTINCT b.AddOnValueIds FROM @SaveCartLineItemType b
											where a.SKU=b.SKU ) x
											FOR XML PATH('')
										), 1, 2, ''
									) AddOns
		INTO #AddOnAdded
		FROM @SaveCartLineItemType a

		if not exists(select * FROM #AddOnsExists a INNER JOIN #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
		begin
			DELETE FROM #OldGroupSavecartLineitemDetails
		end

		END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @SaveCartLineItemType ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldGroupSavecartLineitemDetails a WHERE	
	ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
	AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN 
		
		DELETE FROM #OldGroupSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		
		 IF EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
		 BEGIN 
		 
			 DECLARE @parenTofAddon  TABLE( ParentOmsSavedCartLineItemId INT  )  
			 INSERT INTO  @parenTofAddon 
			 SELECT  ParentOmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails a
			 WHERE a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
			 AND (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem  t with (nolock) WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId AND   t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  
			 DELETE FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ParentOmsSavedCartLineItemId FROM  @parenTofAddon)   
						AND ParentOmsSavedCartLineItemId IS NOT NULL  
						AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

			 DELETE FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldGroupSavecartLineitemDetails m)
			 AND ParentOmsSavedCartLineItemId IS  NULL  
		 

		  IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  BEGIN 
		    DELETE FROM #OldGroupSavecartLineitemDetails
		  END 
		 IF (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem with (nolock)  WHERE ParentOmsSavedCartLineItemId IN (SELECT ParentOmsSavedCartLineItemId FROM @parenTofAddon)AND   OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  BEGIN 
		    DELETE FROM #OldGroupSavecartLineitemDetails
		  END 

		 END 
		 ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		 BEGIN 
		 -- SELECT 3
		    DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup  )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
			OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		    
			 DELETE FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldGroupSavecartLineitemDetails m)
		     AND ParentOmsSavedCartLineItemId IS  NULL  

		 END
		 ELSE IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  BEGIN 
		    DELETE FROM #OldGroupSavecartLineitemDetails
		  END 
		   ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		   AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  = '' )
			BEGIN 
			   DELETE FROM #OldGroupSavecartLineitemDetails
			END  
	END 

	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	--Getting the personalise data for old save cart if present	
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		DELETE FROM #OldGroupSavecartLineitemDetails
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 
		   
		DELETE FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
		SELECT OmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
		AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
		OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
		AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) <>
			(SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM ZnodeOmsSavedCartLineItem WHERE ParentOmsSavedCartLineItemId IS nULL and OmsSavedCartLineItemId in (select OmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails)  )
		BEGIN 
		 
		DELETE n FROM #OldGroupSavecartLineitemDetails n WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
		OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
		
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
			AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldGroupSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
			AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		BEGIN 
			DELETE FROM #OldGroupSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		END 
	END 
	
	IF EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails )
	BEGIN
		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU not having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*
			FROM @SaveCartLineItemType a 
					INNER JOIN #OldGroupSavecartLineitemDetails b on ( a.GroupProductIds = b.SKU or a.SKU = b.sku)
					where isnull(cast(a.PersonalisedAttribute AS varchar(max)),'') = ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId
			FROM #OldGroupSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
		)
		DELETE a FROM #OldGroupSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*, 
			a.PersonalizeCode
			,a.PersonalizeValue
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b on ( a.GroupProductIds = b.SKU or a.SKU = b.sku)
			where isnull(a.PersonalizeValue,'') <> ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId, b.PersonalizeCode, b.PersonalizeValue
			FROM #OldGroupSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
			WHERE NOT EXISTS(SELECT * FROM cte c where b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and b.PersonalizeCode = c.PersonalizeCode 
								and b.PersonalizeValue = c.PersonalizeValue )
		)
		DELETE a FROM #OldGroupSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,b.ParentOmsSavedCartLineItemId , a.SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b on a.SKU = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM #OldGroupSavecartLineitemDetails b1 
		WHERE NOT EXISTS(SELECT * FROM cte c where (b1.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or b1.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId))
		AND EXISTS(SELECT * FROM cte)

		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.SKU AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b on a.SKU = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE c1
		FROM cte a1		  
		INNER JOIN #OldGroupSavecartLineitemDetails b1 on a1.SKU = b1.SKU
		INNER JOIN #OldGroupSavecartLineitemDetails c1 on (b1.ParentOmsSavedCartLineItemId = c1.OmsSavedCartLineItemId OR b1.OmsSavedCartLineItemId = c1.OmsSavedCartLineItemId)
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c where a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and a1.PersonalizeValue = c.PersonalizeValue)

		--Updating the cart if old and new cart data matches
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5,
		a.ModifiedDate = @GetDate  
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldGroupSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewGroupSavecartLineitemDetails ty ON (ty.SKU = b.SKU)
		WHERE a.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon

		 UPDATE a
		 SET a.Quantity = a.Quantity+s.AddOnQuantity,
		 a.ModifiedDate = @GetDate
		 FROM ZnodeOmsSavedCartLineItem a
		 INNER JOIN #OldGroupSavecartLineitemDetails b ON (a.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		 INNER JOIN @SaveCartLineItemType S on a.OmsSavedCartId = s.OmsSavedCartId and a.SKU = s.AddOnValueIds
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon


	END 
	--Inserting the new save cart data if old and new cart data not match
	ELSE 
	BEGIN 
	   
		SELECT RowId, Id ,Row_number()Over(ORDER BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(ORDER BY NewId() ) Sequence ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU  
		 INTO #InsertNewGroupSavecartLineitem   
		 FROM  #NewGroupSavecartLineitemDetails  
		 GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU   
		 ORDER BY RowId, Id   
 
		--Removing the line item having Quantity <=0 
		DELETE FROM #InsertNewGroupSavecartLineitem WHERE Quantity <=0  
  
		--Updating the rowid into new save cart line item as new line item is merged into existing save cart item
		 ;WITH VTTY AS   
		(  
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
			   FROM #InsertNewGroupSavecartLineitem m  
			INNER JOIN  #InsertNewGroupSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU   
			WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon   
		)   
		UPDATE m1   
		SET m1.RowId = TYU.RowId  
		FROM #InsertNewGroupSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  

		;WITH VTRET AS   
		(  
			SELECT RowId,id,Min(NewRowId)NewRowId ,SKU ,ParentSKU, OrderLineItemRelationshipTypeId 
			FROM #InsertNewGroupSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU  ,OrderLineItemRelationshipTypeId
			HAVING SKU = ParentSKU AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		)   
		DELETE FROM #InsertNewGroupSavecartLineitem WHERE NewRowId  IN (SELECT NewRowId FROM VTRET)   
     
	   --Inserting the new cart line item if not merged in existing save cart line item
       INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description)  
       OUTPUT INSERTED.SKU,INSERTED.OmsSavedCartLineItemId  INTO @OmsInsertedData 
	   SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(ORDER BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description   
       FROM  #InsertNewGroupSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU 
		INTO  #Cte_newData
		FROM ZnodeOmsSavedCartLineItem a  with (nolock)
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID	  

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  ORDER BY b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
		AND a.ParentOmsSavedCartLineItemId IS nULL   
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
  
  -----------------------------------------------------------------------------------------------------------------------------------

		SELECT  MIN(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU  
		INTO #Cte_newData1
		FROM ZnodeOmsSavedCartLineItem a with (nolock)
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID	  

		 UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData1  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  ORDER BY b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon   
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
		AND  a.sequence in (SELECT  MIN(ab.sequence) FROM ZnodeOmsSavedCartLineItem ab where a.OmsSavedCartId = ab.OmsSavedCartId and 
		 a.SKU = ab.sku and ab.OrderLineItemRelationshipTypeId is not null  ) 


----------------------------------------------------------------------------------------------------------------------------

		SELECT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(ORDER BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #Cte_newAddon
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c with (nolock) on b.sku = c.sku and b.OmsSavedCartId=c.OmsSavedCartId and b.Id = 1
		WHERE ( ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) and c.ParentOmsSavedCartLineItemId is null

	   ;WITH table_update AS 
	   (
			 SELECT * , ROW_NUMBER()Over(ORDER BY OmsSavedCartLineItemId  ) RowIdNo
			 FROM ZnodeOmsSavedCartLineItem a with (nolock)
			 WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
			 AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
			 AND a.ParentOmsSavedCartLineItemId IS NULL  
			 AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewGroupSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
			 AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
	   )
		UPDATE a SET  
			a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #Cte_newAddon  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId)  FROM #Cte_newAddon  r  
			WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )    IS nOT NULL 

		;WITH Cte_Th AS   
		(             
			  SELECT RowId    
			 FROM #InsertNewGroupSavecartLineitem a   
			 GROUP BY RowId   
			 HAVING COUNT(NewRowId) <= 1   
		  )   
		UPDATE a SET a.Quantity =  NULL,
			a.ModifiedDate = @GetDate   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		 AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewGroupSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		AND OrderLineItemRelationshipTypeId IS NOT NULL     
       
	   ;WITH Cte_UpdateSequence AS   
		 (  
		   SELECT OmsSavedCartLineItemId ,Row_Number()Over(ORDER BY OmsSavedCartLineItemId) RowId , Sequence   
		   FROM ZnodeOmsSavedCartLineItem with (nolock)  
		   WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewGroupSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		 )   
		UPDATE Cte_UpdateSequence  
		SET  Sequence = RowId  
			
		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN @TBL_Personalise c ON a.SKU = c.GroupProductIds
		INNER JOIN ZnodeOmsSavedCartLineItem b WITH (NOLOCK) ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS NOT NULL  
	
		DELETE FROM ZnodeOmsPersonalizeCartItem	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
			
		----Inserting saved cart item personalise value FROM given line item
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
			   ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			   WHEN NOT MATCHED THEN 
				INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
				VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
  
		
		END 




END TRY
BEGIN CATCH 
  SELECT ERROR_MESSAGE()
END CATCH 
END


GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemQuantity')
	DROP PROC Znode_InsertUpdateSaveCartLineItemQuantity

GO


CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemQuantity](
	  @CartLineItemXML xml, @UserId int,@Status bit OUT )
AS 
   /* 
    Summary: THis Procedure is USed to save and edit the saved cart line item      
    Unit Testing 
	begin tran  
    Exec Znode_InsertUpdateSaveCartLineItem @CartLineItemXML= '<ArrayOfSavedCartLineItemModel>
  <SavedCartLineItemModel>
    <OmsSavedCartLineItemId>0</OmsSavedCartLineItemId>
    <ParentOmsSavedCartLineItemId>0</ParentOmsSavedCartLineItemId>
    <OmsSavedCartId>1259</OmsSavedCartId>
    <SKU>BlueGreenYellow</SKU>
    <Quantity>1.000000</Quantity>
    <OrderLineItemRelationshipTypeId>0</OrderLineItemRelationshipTypeId>
    <Sequence>1</Sequence>
    <AddonProducts>YELLOW</AddonProducts>
    <BundleProducts />
    <ConfigurableProducts>GREEN</ConfigurableProducts>
  </SavedCartLineItemModel>
  <SavedCartLineItemModel>
    <OmsSavedCartLineItemId>0</OmsSavedCartLineItemId>
    <ParentOmsSavedCartLineItemId>0</ParentOmsSavedCartLineItemId>
    <OmsSavedCartId>1259</OmsSavedCartId>
    <SKU>ap1534</SKU>
    <Quantity>1.0</Quantity>
    <OrderLineItemRelationshipTypeId>0</OrderLineItemRelationshipTypeId>
    <Sequence>2</Sequence>
    <AddonProducts >PINK</AddonProducts>
    <BundleProducts />
    <ConfigurableProducts />
    <PersonaliseValuesList>Address~Hello</PersonaliseValuesList>
  </SavedCartLineItemModel>
</ArrayOfSavedCartLineItemModel>' , @UserId=1 ,@Status=0
	rollback tran
*/
BEGIN
	BEGIN TRAN InsertUpdateSaveCartLineItem;
	BEGIN TRY
		SET NOCOUNT ON;
		DECLARE @GetDate datetime= dbo.Fn_GetDate();
		DECLARE @AddOnQuantity numeric(28, 6)= 0;
		DECLARE @IsAddProduct   BIT = 0 
		DECLARE @OmsSavedCartLineItemId INT = 0
		DECLARE @TBL_SavecartLineitems TABLE
		( 
			RowId int , OmsSavedCartLineItemId int, ParentOmsSavedCartLineItemId int, OmsSavedCartId int, SKU nvarchar(600), Quantity numeric(28, 6), OrderLineItemRelationshipTypeID int, CustomText nvarchar(max), 
			CartAddOnDetails nvarchar(max), Sequence int, AddOnValueIds varchar(max), BundleProductIds varchar(max), ConfigurableProductIds varchar(max), GroupProductIds varchar(max), PersonalisedAttribute XML, 
			AutoAddon varchar(max), OmsOrderId int, ItemDetails nvarchar(max),
			Custom1	nvarchar(max),Custom2 nvarchar(max),Custom3 nvarchar(max),Custom4
			nvarchar(max),Custom5 nvarchar(max),GroupId NVARCHAR(max) ,ProductName Nvarchar(1000) , Description NVARCHAR(max),AddOnQuantity NVARCHAR(max)
		);

		DECLARE @OrderLineItemRelationshipTypeIdAddon int =
		(
			SELECT TOP 1 OrderLineItemRelationshipTypeId
			FROM ZnodeOmsOrderLineItemRelationshipType
			WHERE [Name] = 'AddOns'
		);
		DECLARE @OrderLineItemRelationshipTypeIdSimple int =
		(
			SELECT TOP 1 OrderLineItemRelationshipTypeId
			FROM ZnodeOmsOrderLineItemRelationshipType
			WHERE [Name] = 'Simple'
		);
		DECLARE @OrderLineItemRelationshipTypeIdGroup int=
		(
			SELECT TOP 1 OrderLineItemRelationshipTypeId
			FROM ZnodeOmsOrderLineItemRelationshipType
			WHERE [Name] = 'Group'
		);
		DECLARE @OrderLineItemRelationshipTypeIdConfigurable int=
		(
			SELECT TOP 1 OrderLineItemRelationshipTypeId
			FROM ZnodeOmsOrderLineItemRelationshipType
			WHERE [Name] = 'Configurable'
		);
		 DECLARE @OrderLineItemRelationshipTypeIdBundle int=
		(
			SELECT TOP 1 OrderLineItemRelationshipTypeId
			FROM ZnodeOmsOrderLineItemRelationshipType
			WHERE [Name] = 'Bundles'
		);
		INSERT INTO @TBL_SavecartLineitems( RowId,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU, Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence, AddOnValueIds, BundleProductIds, ConfigurableProductIds, GroupProductIds, PersonalisedAttribute, AutoAddon, OmsOrderId, ItemDetails,
		Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,Description,AddOnQuantity )
			   SELECT DENSE_RANK()Over(Order BY Tbl.Col.value( 'SKU[1]', 'NVARCHAR(2000)' )) RowId ,Tbl.Col.value( 'OmsSavedCartLineItemId[1]', 'NVARCHAR(2000)' ) AS OmsSavedCartLineItemId, Tbl.Col.value( 'ParentOmsSavedCartLineItemId[1]', 'NVARCHAR(2000)' ) AS ParentOmsSavedCartLineItemId, Tbl.Col.value( 'OmsSavedCartId[1]', 'NVARCHAR(2000)' ) AS OmsSavedCartId, Tbl.Col.value( 'SKU[1]', 'NVARCHAR(2000)' ) AS SKU, Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(2000)' ) AS Quantity
			   , Tbl.Col.value( 'OrderLineItemRelationshipTypeID[1]', 'NVARCHAR(2000)' ) AS OrderLineItemRelationshipTypeID, Tbl.Col.value( 'CustomText[1]', 'NVARCHAR(2000)' ) AS CustomText, Tbl.Col.value( 'CartAddOnDetails[1]', 'NVARCHAR(2000)' ) AS CartAddOnDetails, Tbl.Col.value( 'Sequence[1]', 'NVARCHAR(2000)' ) AS Sequence, Tbl.Col.value( 'AddonProducts[1]', 'NVARCHAR(2000)' ) AS AddOnValueIds, ISNULL(Tbl.Col.value( 'BundleProducts[1]', 'NVARCHAR(2000)' ),'') AS BundleProductIds, ISNULL(Tbl.Col.value( 'ConfigurableProducts[1]', 'NVARCHAR(2000)' ),'') AS ConfigurableProductIds, ISNULL(Tbl.Col.value( 'GroupProducts[1]', 'NVARCHAR(Max)' ),'') AS GroupProductIds, 
			          Tbl.Col.query('(PersonaliseValuesDetail/node())') AS PersonaliseValuesDetail, Tbl.Col.value( 'AutoAddon[1]', 'NVARCHAR(Max)' ) AS AutoAddon, Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(Max)' ) AS OmsOrderId,
					  Tbl.Col.value( 'ItemDetails[1]', 'NVARCHAR(Max)' ) AS ItemDetails,
					  Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
					  Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
					  Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
					  Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
					  Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
					  Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
					  Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(Max)' ) AS ProductName,
					  Tbl.Col.value( 'Description[1]', 'NVARCHAR(Max)' ) AS Description, 
					  Tbl.Col.value( 'AddOnQuantity[1]', 'NVARCHAR(2000)' ) AS AddOnQuantity
			   FROM @CartLineItemXML.nodes( '//ArrayOfSavedCartLineItemModel/SavedCartLineItemModel' ) AS Tbl(Col);
			  

			  IF OBJECT_ID('tempdb..#TBL_SavecartLineitems') is not null
				drop table #TBL_SavecartLineitems

			 IF OBJECT_ID('tempdb..#OldValueForAddon') is not null
				drop table #OldValueForAddon

			  SELECT * INTO #TBL_SavecartLineitems FROM @TBL_SavecartLineitems
			

			UPDATE ZnodeOmsSavedCart
			SET ModifiedDate = GETDATE()
			WHERE OmsSavedCartId = (SELECT TOP 1  OmsSavedCartId FROM @TBL_SavecartLineitems)
				

			  UPDATE  @TBL_SavecartLineitems
			  SET 	Description = ISNUll(Description,'') 

			IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' )
			 BEGIN 				
				 IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
				 BEGIN 
				    SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0 )

					UPDATE ZnodeOmsSavedCartLineItem 
					SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0)
					, ModifiedDate = @GetDate
					WHERE ( OmsSavedCartLineItemId = @OmsSavedCartLineItemId  
					OR ParentOmsSavedCartLineItemId =  @OmsSavedCartLineItemId   ) 
					 
					--UPDATE ZnodeOmsSavedCartLineItem 
					--SET Quantity = (SELECT TOP 1 AddOnQuantity FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0)
					--WHERE ParentOmsSavedCartLineItemId = @OmsSavedCartLineItemId  
					--AND OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					UPDATE ZnodeOmsSavedCartLineItem 
					SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
					FROM ZnodeOmsSavedCartLineItem ZOSCLI
					INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
					WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					AND SCLI.BundleProductIds <> ''

					DELETE	FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0
				 END 
				  DECLARE @TBL_bundleProduct TT_SavecartLineitems 
				  INSERT INTO @TBL_bundleProduct 
				  SELECT *  
				  FROM @TBL_SavecartLineitems 
				  WHERE ISNULL(BundleProductIds,'') <> '' 
				
				  EXEC Znode_InsertUpdateSaveCartLineItemBundle @TBL_bundleProduct,@userId,@OrderLineItemRelationshipTypeIdBundle,@OrderLineItemRelationshipTypeIdAddon
				 
				  DELETE FROM  @TBL_SavecartLineitems WHERE ISNULL(BundleProductIds,'') <> '' 
				  SET @OmsSavedCartLineItemId = 0 
				END 
			IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' )
			    BEGIN 				
				 IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
				 BEGIN 

				   SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0 )
				 
				   	UPDATE ZnodeOmsSavedCartLineItem 
					SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
					, ModifiedDate = @GetDate
					WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId
					
					--UPDATE ZnodeOmsSavedCartLineItem 
					--SET Quantity = (SELECT TOP 1 AddOnQuantity FROM @TBL_SavecartLineitems WHERE  ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0)
					--WHERE ParentOmsSavedCartLineItemId = @OmsSavedCartLineItemId  
					--AND OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					UPDATE ZnodeOmsSavedCartLineItem 
					SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
					FROM ZnodeOmsSavedCartLineItem ZOSCLI
					INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
					WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					AND SCLI.ConfigurableProductIds <> ''

					DELETE	FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0
				 END 
				  DECLARE @TBL_Configurable TT_SavecartLineitems 
				  INSERT INTO @TBL_Configurable 
				  SELECT *  
				  FROM @TBL_SavecartLineitems 
				  WHERE ISNULL(ConfigurableProductIds,'') <> '' 

				  
				  EXEC Znode_InsertUpdateSaveCartLineItemConfigurable @TBL_Configurable,@userId,@OrderLineItemRelationshipTypeIdConfigurable,@OrderLineItemRelationshipTypeIdAddon
				  
				  DELETE FROM @TBL_SavecartLineitems 
				  WHERE ISNULL(ConfigurableProductIds,'') <> ''
				  SET @OmsSavedCartLineItemId = 0  
				END 
				IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' )
			    BEGIN 				
				 IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
				 BEGIN 
				   SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0 )
				   	UPDATE ZnodeOmsSavedCartLineItem 
					SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
					WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId
					
					--UPDATE ZnodeOmsSavedCartLineItem 
					--SET Quantity = (SELECT TOP 1 AddOnQuantity FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND  OmsSavedCartLineItemId <> 0)
					--WHERE ParentOmsSavedCartLineItemId = @OmsSavedCartLineItemId  
					--AND OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					UPDATE ZnodeOmsSavedCartLineItem 
					SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
					FROM ZnodeOmsSavedCartLineItem ZOSCLI
					INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
					WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					AND SCLI.GroupProductIds <> ''

					DELETE	FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0
				 END 
				  DECLARE @TBL_Group TT_SavecartLineitems 
				  INSERT INTO @TBL_Group 
				  SELECT *  
				  FROM @TBL_SavecartLineitems 
				  WHERE ISNULL(GroupProductIds,'') <> '' 

				
				  EXEC Znode_InsertUpdateSaveCartLineItemGroup @TBL_Group,@userId,@OrderLineItemRelationshipTypeIdGroup,@OrderLineItemRelationshipTypeIdAddon
				  
				  DELETE FROM @TBL_SavecartLineitems 
				  WHERE ISNULL(GroupProductIds,'') <> ''
				  SET @OmsSavedCartLineItemId = 0  
				END 
				 
                IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId <> 0  ) 
				 BEGIN 
				 
				   SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId <> 0 )
				   	UPDATE ZnodeOmsSavedCartLineItem 
					SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
					, ModifiedDate = @GetDate
					WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId
				
				 --   UPDATE ZnodeOmsSavedCartLineItem 
					--SET Quantity = (SELECT TOP 1 AddOnQuantity FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId <> 0)
					--WHERE ParentOmsSavedCartLineItemId = @OmsSavedCartLineItemId  
					--AND OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					UPDATE ZnodeOmsSavedCartLineItem 
					SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
					FROM ZnodeOmsSavedCartLineItem ZOSCLI
					INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = @OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
					WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					
					DELETE	FROM @TBL_SavecartLineitems WHERE OmsSavedCartLineItemId <> 0
				 END 
			 
			

			  DECLARE @OmsInsertedData TABLE (OmsSavedCartLineItemId INT )
			  DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT ,PersonalizeCode NVARCHAr(max),PersonalizeValue NVARCHAr(max),DesignId NVARCHAr(max), ThumbnailURL NVARCHAr(max))
			  INSERT INTO @TBL_Personalise
			  SELECT DISTINCT NULL 
							,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			  		  ,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
					  ,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(Max)' ) AS DesignId
					  ,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(Max)' ) AS ThumbnailURL
			  FROM (SELECT TOP 1 PersonalisedAttribute Valuex FROM  @TBL_SavecartLineitems TRTR  ) a 
			  CROSS APPLY	a.Valuex.nodes( '//PersonaliseValueModel' ) AS Tbl(Col) 
			  
			   ----To update saved cart item personalise value from given line item
			  DECLARE @TBL_Personalise1 TABLE (OmsSavedCartLineItemId INT ,PersonalizeCode NVARCHAr(max),PersonalizeValue NVARCHAr(max),DesignId NVARCHAr(max), ThumbnailURL NVARCHAr(max))
			  INSERT INTO @TBL_Personalise1
			  SELECT DISTINCT a.OmsSavedCartLineItemId 
					  ,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			  		  ,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
					  ,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(Max)' ) AS DesignId
					  ,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(Max)' ) AS ThumbnailURL
			  FROM (SELECT TOP 1 OmsSavedCartLineItemId,PersonalisedAttribute Valuex FROM  #TBL_SavecartLineitems TRTR ) a 
			  CROSS APPLY	a.Valuex.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  
		    
			
			  CREATE TABLE #tempoi (GenId INT IDENTITY(1,1),RowId	int	,OmsSavedCartLineItemId	int	 ,ParentOmsSavedCartLineItemId	int,OmsSavedCartId	int
									,SKU	nvarchar(max) ,Quantity	numeric(28,6)	,OrderLineItemRelationshipTypeID	int	,CustomText	nvarchar(max)
									,CartAddOnDetails	nvarchar(max),Sequence	int	,AutoAddon	varchar(max)	,OmsOrderId	int	,ItemDetails	nvarchar(max)
									,Custom1	nvarchar(max)  ,Custom2	nvarchar(max),Custom3	nvarchar(max),Custom4	nvarchar(max),Custom5	nvarchar(max)
									,GroupId	nvarchar(max) ,ProductName	nvarchar(max),Description	nvarchar(max),Id	int,ParentSKU NVARCHAR(max))
				   
			   INSERT INTO #tempoi
			   SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
					,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
					,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU 
			   FROM @TBL_SavecartLineitems a 
			   GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
					,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
					,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
			  
			   INSERT INTO #tempoi
			   SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
					,Quantity, @OrderLineItemRelationshipTypeIdSimple, CustomText, CartAddOnDetails, Sequence
					,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU 
			   FROM @TBL_SavecartLineitems  a 
			   WHERE ISNULL(BundleProductIds,'') =  '' 
			   AND  ISNULL(GroupProductIds,'') = ''	AND ISNULL(	ConfigurableProductIds,'') = ''
			   	   GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
					,Quantity,  CustomText, CartAddOnDetails, Sequence
					,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
			  
     		   INSERT INTO #tempoi
			   SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
					,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
					,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
					,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
					WHEN  GroupProductIds <> '' THEN GroupProductIds 
					WHEN BundleProductIds <> '' THEN BundleProductIds 
					 ELSE SKU END     ParentSKU 
			   FROM @TBL_SavecartLineitems  a 
			   WHERE AddOnValueIds <> ''
			   	   GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
					,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
					,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
           --hack
		
		 CREATE TABLE #OldValue (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
		 
		INSERT INTO #OldValue  
		SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	  	FROM ZnodeOmsSavedCartLineItem a   
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.SKU,'')   )   
        AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple   

			

		INSERT INTO #OldValue 
		SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
		FROM ZnodeOmsSavedCartLineItem b 
		INNER JOIN #OldValue c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
		AND  b.OrderLineItemRelationshipTypeID IS NULL 
		 
		DELETE a FROM #OldValue a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldValue b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NOT NULL 
		
		------Merge Addon for same product
		SELECT * INTO #OldValueForAddon from #OldValue
		
		INSERT INTO #OldValue 
		SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
		FROM ZnodeOmsSavedCartLineItem b 
		INNER JOIN #OldValue c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		
		
		------Merge Addon for same product
		IF EXISTS(SELECT * FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'') <> '' )
		BEGIN

			INSERT INTO #OldValueForAddon 
			SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
			FROM ZnodeOmsSavedCartLineItem b 
			INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
			WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
			AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

			SELECT distinct SKU, STUFF(
										( SELECT  ', ' + SKU FROM    
											( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
											  where a.OmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
											  FOR XML PATH('')
										), 1, 2, ''
									 ) AddOns
			INTO #AddOnsExists
			from #OldValueForAddon a where a.ParentOmsSavedCartLineItemId is not null and OrderLineItemRelationshipTypeID<>1

			SELECT distinct a.SKU, STUFF(
										 ( SELECT  ', ' + x.AddOnValueIds FROM    
											( SELECT DISTINCT b.AddOnValueIds FROM @TBL_SavecartLineitems b
											  where a.SKU=b.SKU ) x
											  FOR XML PATH('')
										 ), 1, 2, ''
									   ) AddOns
			INTO #AddOnAdded
			from @TBL_SavecartLineitems a

			if not exists(select * from #AddOnsExists a inner join #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
			begin
				delete from #OldValue
			end

		END

		IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_SavecartLineitems ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldValue a WHERE	
		ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  <> '' )
		BEGIN 
		
		DELETE FROM #OldValue 
		END 
		ELSE 
		BEGIN 
	    
		 IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  <> '' )
		 BEGIN 
		 
		 DECLARE @parenTofAddon  TABLE( ParentOmsSavedCartLineItemId INT  )  
		 INSERT INTO  @parenTofAddon 
		 SELECT  ParentOmsSavedCartLineItemId FROM #OldValue WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  

		 DELETE FROM #OldValue WHERE OmsSavedCartLineItemId NOT IN (SELECT ParentOmsSavedCartLineItemId FROM  @parenTofAddon)   
					AND ParentOmsSavedCartLineItemId IS NOT NULL  
					AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

		 DELETE FROM #OldValue WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldValue m)
		 AND ParentOmsSavedCartLineItemId IS  NULL  
		 
		 END 
		 ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldValue WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		 BEGIN 

		 -- SELECT 3
		    DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM ZnodeOmsSavedCartLineItem a 
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldValue WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple  )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldValue WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
			OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		    
			 DELETE FROM #OldValue WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldValue m)
		 AND ParentOmsSavedCartLineItemId IS  NULL  

		 END
		 ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldValue ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		      AND EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  = '' )
		 BEGIN 

		   DELETE FROM #OldValue
		 END 
		END 
			
	

		DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
		INSERT INTO @TBL_Personaloldvalues
		SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
		FROM ZnodeOmsPersonalizeCartItem  a 
		WHERE EXISTS (SELECT TOP 1 1 FROM #OldValue TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
		

		IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		   AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
		BEGIN 
		 DELETE FROM #OldValue
		END 
		ELSE 
		BEGIN 
		 IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldValue WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 BEGIN 
		   
		   DELETE FROM #OldValue WHERE OmsSavedCartLineItemId IN (
		   SELECT OmsSavedCartLineItemId FROM #OldValue WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
		   AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
		   OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldValue WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
		   AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		   
		
		   
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldValue WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 BEGIN 
		   
		   

		   DELETE n FROM #OldValue n WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
		   OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
		   
		  
		   
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		        AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldValue YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
		       AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldValue WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		 BEGIN 
		     DELETE FROM #OldValue WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		 END 


		  
		END 

		----delete old value from table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU not having personalise value for new cart item
		;with cte as
		(
			select distinct b.*
			FROM @TBL_SavecartLineitems a 
			Inner Join #OldValue b on ( a.SKU = b.sku)
			where isnull(cast(a.PersonalisedAttribute as varchar(max)),'') = ''
		)
		,cte2 as
		(
			select c.ParentOmsSavedCartLineItemId
			from #OldValue a
			inner join ZnodeOmsSavedCartLineItem c on a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId
			inner join ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		)
		delete a from #OldValue a
		inner join cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		inner join cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		----delete old value from table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU having personalise value for new cart item
		;with cte as
		(
			select distinct b.*, 
			Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
			FROM @TBL_SavecartLineitems a 
			Inner Join #OldValue b on ( a.SKU = b.sku)
			CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  
			where isnull(cast(a.PersonalisedAttribute as varchar(max)),'') <> ''
		)
		,cte2 as
		(
			select a.ParentOmsSavedCartLineItemId, b.PersonalizeCode, b.PersonalizeValue
			from #OldValue a
			inner join ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
			where not exists(select * from cte c where b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and b.PersonalizeCode = c.PersonalizeCode 
			                 and b.PersonalizeValue = c.PersonalizeValue )
		)
		delete a from #OldValue a
		inner join cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		inner join cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		;with cte as
		(
			SELECT b.OmsSavedCartLineItemId ,b.ParentOmsSavedCartLineItemId , a.SKU as SKU
					,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			  		,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
					,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(Max)' ) AS DesignId
					,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(Max)' ) AS ThumbnailURL
			FROM @TBL_SavecartLineitems a 
			Inner Join #OldValue b on a.SKU = b.SKU
			CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  
			Inner join ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		delete b1
		from #OldValue b1 
		where not exists(select * from cte c where (b1.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or b1.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId))
	    and exists(select * from cte)

		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
		;with cte as
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.SKU
					,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			  		,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
					,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(Max)' ) AS DesignId
					,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(Max)' ) AS ThumbnailURL
			FROM @TBL_SavecartLineitems a 
			Inner Join #OldValue b on a.SKU = b.SKU
			CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  
			Inner join ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		delete b1
		from cte a1		  
		Inner Join #OldValue b1 on a1.sku = b1.SKU
		where not exists(select * from ZnodeOmsPersonalizeCartItem c where a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and a1.PersonalizeValue = c.PersonalizeValue)

		IF EXISTS (SELECT TOP 1 1 FROM #OldValue )
		BEGIN 

		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5, 
		a.ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldValue b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #tempoi ty ON (ty.SKU = b.SKU)


		END 
		ELSE 
		BEGIN 
		
		
			   
    SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU  
     INTO #yuuete   
     FROM  #tempoi  
     GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails ,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU   
     ORDER BY RowId, Id   
       	
			     
    DELETE FROM #yuuete WHERE Quantity <=0  
  
     ;WITH VTTY AS   
    (  
    SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
       FROM #yuuete m  
    INNER JOIN  #yuuete TY1 ON TY1.SKU = m.ParentSKU   
    WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon   
    )   
	
    UPDATE m1   
    SET m1.RowId = TYU.RowId  
    FROM #yuuete m1   
    INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  
        
    ;WITH VTRET AS   
    (  
    SELECT RowId,id,Min(NewRowId) NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID  
    FROM #yuuete   
    GROUP BY RowId,id ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID
	Having  SKU = ParentSKU  AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdSimple
    )   
    
    DELETE FROM #yuuete WHERE NewRowId IN (SELECT NewRowId FROM VTRET)  
	
	

	
     
       INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description)  
       OUTPUT INSERTED.OmsSavedCartLineItemId  INTO @OmsInsertedData 
	   SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description   
       FROM  #yuuete  TH  

 
	 --;with Cte_newData AS   
  --  (  
    SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
	, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU  
	INTO #Cte_newData
    FROM ZnodeOmsSavedCartLineItem a  
    INNER JOIN #yuuete b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
    WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
	--	AND NOT EXISTS (SELECT TOP 1 1 FROM #OldValue TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		AND CASE WHEN EXISTS (SELECT TOP 1 1 FROM #yuuete TU WHERE TU.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple)  THEN ISNULL(a.OrderLineItemRelationshipTypeID,0) ELSE 0 END = 0 
     GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID
				
    --)   
	
  
    UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData  r  
    WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
    FROM ZnodeOmsSavedCartLineItem a  
    INNER JOIN #yuuete b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
    WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
    AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
    AND a.ParentOmsSavedCartLineItemId IS nULL   
  

    
    --;with Cte_newAddon AS   
    --(  
    SELECT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(Order BY c.OmsSavedCartLineItemId )RowIdNo
    INTO #Cte_newAddon
	FROM ZnodeOmsSavedCartLineItem a  
    INNER JOIN #yuuete b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( b.Id = 1  ))  
	INNER JOIN ZnodeOmsSavedCartLineItem c on b.sku = c.sku and b.OmsSavedCartId=c.OmsSavedCartId and b.Id = 1 
    WHERE ( ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
    AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  and c.ParentOmsSavedCartLineItemId is null
  --  )   
  


  --  SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId  ) RowIdNo
	 --FROM ZnodeOmsSavedCartLineItem a
	 --WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
  --   AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
  --   AND a.ParentOmsSavedCartLineItemId IS NULL  
	 --AND EXISTS (SELECT TOP 1 1  FROM  #yuuete ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
	 --AND EXISTS (SELECT TOP 1 1 FROM #Cte_newAddon TI WHERE TI.SKU = a.SKU)



   ;with table_update AS 
   (
     SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId  ) RowIdNo
	 FROM ZnodeOmsSavedCartLineItem a
	 WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
     AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
     AND a.ParentOmsSavedCartLineItemId IS NULL  
	 AND EXISTS (SELECT TOP 1 1  FROM  #yuuete ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
	 AND EXISTS (SELECT TOP 1 1 FROM #Cte_newAddon TI WHERE TI.SKU = a.SKU)
   )

    UPDATE a SET  
   --SELECT  a.OmsSavedCartLineItemId,
	a.ParentOmsSavedCartLineItemId =(SELECT TOP 1 max(OmsSavedCartLineItemId) 
	FROM #Cte_newAddon  r  
    WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU  GROUP BY r.ParentSKU, r.SKU  )   
    FROM table_update a  
    INNER JOIN #yuuete b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
    WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId) 
	  FROM #Cte_newAddon  r  
    WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU   GROUP BY r.ParentSKU, r.SKU  )    IS NOT NULL 
	 

	
	  
    ;with Cte_Th AS   
    (             
      SELECT RowId    
     FROM #yuuete a   
     GROUP BY RowId   
     HAVING COUNT(NewRowId) <= 1   
      )   
    UPDATE a SET a.Quantity =  NULL , a.ModifiedDate = @GetDate  
    FROM ZnodeOmsSavedCartLineItem a  
    INNER JOIN #yuuete b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
    WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
     AND a.OrderLineItemRelationshipTypeId IS NULL   
  
    UPDATE  ZnodeOmsSavedCartLineItem   
    SET GROUPID = NULL   
    WHERE  EXISTS (SELECT TOP 1 1  FROM #yuuete RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
    AND OrderLineItemRelationshipTypeId IS NOT NULL     
       ;With Cte_UpdateSequence AS   
     (  
       SELECT OmsSavedCartLineItemId ,Row_Number()Over(Order By OmsSavedCartLineItemId) RowId , Sequence   
       FROM ZnodeOmsSavedCartLineItem   
       WHERE EXISTS (SELECT TOP 1 1 FROM #yuuete TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
     )   
    UPDATE Cte_UpdateSequence  
    SET  Sequence = RowId  
	
	----To update saved cart item personalise value from given line item	
	if exists(select * from @TBL_Personalise1 where isnull(PersonalizeValue,'') <> '' and isnull(OmsSavedCartLineItemId,0) <> 0)
	Begin
		DELETE FROM ZnodeOmsPersonalizeCartItem 
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise1 yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )

		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise1 SOURCE
			   ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
		WHEN NOT MATCHED THEN 
				INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
				VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
	end		
	
	UPDATE @TBL_Personalise
	SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
	FROM @OmsInsertedData a 
	INNER JOIN ZnodeOmsSavedCartLineItem b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
	WHERE b.ParentOmsSavedCartLineItemId IS NOT NULL 
	
	DELETE FROM ZnodeOmsPersonalizeCartItem 
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
						
    MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
	USING @TBL_Personalise SOURCE
		   ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
	WHEN NOT MATCHED THEN 
		    INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
							,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
			VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
							,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
  
		
		 
END 

	
	SET @Status = 1;
	COMMIT TRAN InsertUpdateSaveCartLineItem;
	END TRY
	BEGIN CATCH
		SELECT ERROR_MESSAGE()	
		SET @Status = 0;
		DECLARE @Error_procedure varchar(1000)= ERROR_PROCEDURE(), @ErrorMessage nvarchar(max)= ERROR_MESSAGE(), @ErrorLine varchar(100)= ERROR_LINE(), @ErrorCall nvarchar(max)= 'EXEC Znode_InsertUpdateSaveCartLineItem @CartLineItemXML = '+CAST(@CartLineItemXML
 AS varchar(max))+',@UserId = '+CAST(@UserId AS varchar(50))+',@Status='+CAST(@Status AS varchar(10));

		SELECT 0 AS ID, CAST(0 AS bit) AS Status,ERROR_MESSAGE();
		ROLLBACK TRAN InsertUpdateSaveCartLineItem;
		EXEC Znode_InsertProcedureErrorLog @ProcedureName = 'Znode_InsertUpdateSaveCartLineItem', @ErrorInProcedure = @Error_procedure, @ErrorMessage = @ErrorMessage, @ErrorLine = @ErrorLine, @ErrorCall = @ErrorCall;
	END CATCH;
END;


GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemQuantityWrapper')
	DROP PROC Znode_InsertUpdateSaveCartLineItemQuantityWrapper

GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemQuantityWrapper]
(
	@CartLineItemXML xml, 
	@UserId int,
	@PortalId Int,
	@OmsCookieMappingId INT = 0 
)
AS 
   /* 
    Summary: THis Procedure is USed to save and edit the saved cart line item      
    Unit Testing 
	begin tran  
    Exec Znode_InsertUpdateSaveCartLineItem @CartLineItemXML= '<ArrayOfSavedCartLineItemModel>
  <SavedCartLineItemModel>
    <OmsSavedCartLineItemId>0</OmsSavedCartLineItemId>
    <ParentOmsSavedCartLineItemId>0</ParentOmsSavedCartLineItemId>
    <OmsSavedCartId>1259</OmsSavedCartId>
    <SKU>BlueGreenYellow</SKU>
    <Quantity>1.000000</Quantity>
    <OrderLineItemRelationshipTypeId>0</OrderLineItemRelationshipTypeId>
    <Sequence>1</Sequence>
    <AddonProducts>YELLOW</AddonProducts>
    <BundleProducts />
    <ConfigurableProducts>GREEN</ConfigurableProducts>
  </SavedCartLineItemModel>
  <SavedCartLineItemModel>
    <OmsSavedCartLineItemId>0</OmsSavedCartLineItemId>
    <ParentOmsSavedCartLineItemId>0</ParentOmsSavedCartLineItemId>
    <OmsSavedCartId>1259</OmsSavedCartId>
    <SKU>ap1534</SKU>
    <Quantity>1.0</Quantity>
    <OrderLineItemRelationshipTypeId>0</OrderLineItemRelationshipTypeId>
    <Sequence>2</Sequence>
    <AddonProducts >PINK</AddonProducts>
    <BundleProducts />
    <ConfigurableProducts />
    <PersonaliseValuesList>Address~Hello</PersonaliseValuesList>
  </SavedCartLineItemModel>
</ArrayOfSavedCartLineItemModel>' , @UserId=1 ,@Status=0
	rollback tran
*/
BEGIN
BEGIN TRAN InsertUpdateSaveCartLineItem;
BEGIN TRY
SET NOCOUNT ON;
	--Declared the variables
	DECLARE @GetDate datetime= dbo.Fn_GetDate();
	DECLARE @AddOnQuantity numeric(28, 6)= 0;
	DECLARE @IsAddProduct   BIT = 0 
	DECLARE @OmsSavedCartLineItemId INT = 0
	
	DECLARE @TBL_SavecartLineitems TABLE
	( 
		RowId int , OmsSavedCartLineItemId int, ParentOmsSavedCartLineItemId int, OmsSavedCartId int, SKU nvarchar(600), Quantity numeric(28, 6), OrderLineItemRelationshipTypeID int, CustomText nvarchar(max), 
		CartAddOnDetails nvarchar(max), Sequence int, AddOnValueIds varchar(max), BundleProductIds varchar(max), ConfigurableProductIds varchar(max), GroupProductIds varchar(max), PersonalisedAttribute XML, 
		AutoAddon varchar(max), OmsOrderId int, ItemDetails nvarchar(max),
		Custom1	nvarchar(max),Custom2 nvarchar(max),Custom3 nvarchar(max),Custom4
		nvarchar(max),Custom5 nvarchar(max),GroupId NVARCHAR(max) ,ProductName Nvarchar(1000) , Description NVARCHAR(max),AddOnQuantity NVARCHAR(max)
	);

	--Set the OrderLineItemRelationshipTypeId for Addons product
	DECLARE @OrderLineItemRelationshipTypeIdAddon int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'AddOns'
	);
	--Set the OrderLineItemRelationshipTypeId for simple product
	DECLARE @OrderLineItemRelationshipTypeIdSimple int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Simple'
	);
	--Set the OrderLineItemRelationshipTypeId for group product
	DECLARE @OrderLineItemRelationshipTypeIdGroup int=
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Group'
	);
	--Set the OrderLineItemRelationshipTypeId for Configurable product
	DECLARE @OrderLineItemRelationshipTypeIdConfigurable int=
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Configurable'
	);
	--Set the OrderLineItemRelationshipTypeId for Bundles product	
	DECLARE @OrderLineItemRelationshipTypeIdBundle int=
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Bundles'
	);

	-----Getting OmsSaveCartId FROM @OmsCookieMappingId
	DECLARE @OmsSavedCartId int
	--Getting OmsCookieMappingId on basis of @UserId and portalid if @UserId > 0 (Not a guest User)
	IF isnull(@OmsCookieMappingId,0)=0 and isnull(@UserId,0) <> 0  
	Begin
		SET @OmsCookieMappingId = (SELECT top 1 OmsCookieMappingId FROM ZnodeOmsCookieMapping with (nolock) where isnull(UserId,0) = @UserID AND isnull(PortalId,0) = @PortalId)
	END

	IF Not Exists(SELECT top 1 OmsCookieMappingId FROM ZnodeOmsCookieMapping with (nolock) Where OmsCookieMappingId = @OmsCookieMappingId)
	Begin
		INSERT INTO ZnodeOmsCookieMapping (UserId,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT case when @UserId = 0 then null else @UserId end ,@PortalId,@UserId,@GetDate,@UserId,@GetDate

		SET @OmsCookieMappingId = @@IDENTITY
	End
	----To get the oms savecartid on basis of @OmsCookieMappingId 
	SET @OmsSavedCartId = (SELECT top 1 OmsSavedCartId FROM ZnodeOmsSavedCart with (nolock) where OmsCookieMappingId = @OmsCookieMappingId)
	
	----If omssavecartid not present in ZnodeOmsSavedCart table then inserting new record to generated omssavecartid 
	IF isnull(@OmsSavedCartId,0) = 0
	BEGIN
		INSERT INTO ZnodeOmsSavedCart(OmsCookieMappingId,SalesTax,RecurringSalesTax,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT @OmsCookieMappingId,Null,Null,@UserId,@GetDate,@UserId,@GetDate

		SET @OmsSavedCartId = @@IDENTITY
	END

	--Fetching data FROM xml to table format and inserted into table @TBL_SavecartLineitems
	INSERT INTO @TBL_SavecartLineitems( RowId,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU, Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence, AddOnValueIds, BundleProductIds, ConfigurableProductIds, GroupProductIds, PersonalisedAttribute, AutoAddon, OmsOrderId, ItemDetails,
	Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,Description,AddOnQuantity )
	SELECT DENSE_RANK()Over(Order BY Tbl.Col.value( 'SKU[1]', 'NVARCHAR(2000)' )) RowId ,Tbl.Col.value( 'OmsSavedCartLineItemId[1]', 'NVARCHAR(2000)' ) AS OmsSavedCartLineItemId, Tbl.Col.value( 'ParentOmsSavedCartLineItemId[1]', 'NVARCHAR(2000)' ) AS ParentOmsSavedCartLineItemId, @OmsSavedCartId AS OmsSavedCartId, Tbl.Col.value( 'SKU[1]', 'NVARCHAR(2000)' ) AS SKU, Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(2000)' ) AS Quantity
	, Tbl.Col.value( 'OrderLineItemRelationshipTypeID[1]', 'NVARCHAR(2000)' ) AS OrderLineItemRelationshipTypeID, Tbl.Col.value( 'CustomText[1]', 'NVARCHAR(2000)' ) AS CustomText, Tbl.Col.value( 'CartAddOnDetails[1]', 'NVARCHAR(2000)' ) AS CartAddOnDetails, Tbl.Col.value( 'Sequence[1]', 'NVARCHAR(2000)' ) AS Sequence, Tbl.Col.value( 'AddonProducts[1]', 'NVARCHAR(2000)' ) AS AddOnValueIds, ISNULL(Tbl.Col.value( 'BundleProducts[1]', 'NVARCHAR(2000)' ),'') AS BundleProductIds, ISNULL(Tbl.Col.value( 'ConfigurableProducts[1]', 'NVARCHAR(2000)' ),'') AS ConfigurableProductIds, ISNULL(Tbl.Col.value( 'GroupProducts[1]', 'NVARCHAR(Max)' ),'') AS GroupProductIds, 
			Tbl.Col.query('(PersonaliseValuesDetail/node())') AS PersonaliseValuesDetail, Tbl.Col.value( 'AutoAddon[1]', 'NVARCHAR(Max)' ) AS AutoAddon, Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(Max)' ) AS OmsOrderId,
			Tbl.Col.value( 'ItemDetails[1]', 'NVARCHAR(Max)' ) AS ItemDetails,
			Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
			Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
			Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
			Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
			Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
			Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
			Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(Max)' ) AS ProductName,
			Tbl.Col.value( 'Description[1]', 'NVARCHAR(Max)' ) AS Description, 
			Tbl.Col.value( 'AddOnQuantity[1]', 'NVARCHAR(2000)' ) AS AddOnQuantity
	FROM @CartLineItemXML.nodes( '//ArrayOfSavedCartLineItemModel/SavedCartLineItemModel' ) AS Tbl(Col);
			  
	IF OBJECT_ID('tempdb..#TBL_SavecartLineitems') is not null
		DROP TABLE #TBL_SavecartLineitems

	IF OBJECT_ID('tempdb..#OldValueForAddon') is not null
		DROP TABLE #OldValueForAddon

	SELECT * INTO #TBL_SavecartLineitems FROM @TBL_SavecartLineitems
			
	UPDATE ZnodeOmsSavedCart
	SET ModifiedDate = GETDATE()
	WHERE OmsSavedCartId = (SELECT TOP 1  OmsSavedCartId FROM @TBL_SavecartLineitems)

	UPDATE  @TBL_SavecartLineitems
	SET 	Description = ISNUll(Description,'') 

	--Save cart execution code for bundle product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' )
	BEGIN 				
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
		BEGIN 
			SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0 )

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0)
			, ModifiedDate = @GetDate
			WHERE ( OmsSavedCartLineItemId = @OmsSavedCartLineItemId  
			OR ParentOmsSavedCartLineItemId =  @OmsSavedCartLineItemId   ) 

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
			FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
			INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
			WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
			AND SCLI.BundleProductIds <> ''

			--After update the existing cart with new save cart then deleting those records which are updated
			DELETE	FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0
		END 

		--Getting bundle save cart line item entries into table to pass for bundle prodcut sp
		DECLARE @TBL_bundleProduct TT_SavecartLineitems 
		INSERT INTO @TBL_bundleProduct 
		SELECT *  
		FROM @TBL_SavecartLineitems 
		WHERE ISNULL(BundleProductIds,'') <> '' 
				
		EXEC Znode_InsertUpdateSaveCartLineItemBundle @TBL_bundleProduct,@userId,@OrderLineItemRelationshipTypeIdBundle,@OrderLineItemRelationshipTypeIdAddon
				 
		DELETE FROM  @TBL_SavecartLineitems WHERE ISNULL(BundleProductIds,'') <> '' 
		SET @OmsSavedCartLineItemId = 0 
	END 
	--Save cart execution code for configurable product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' )
	BEGIN 				
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
		BEGIN 

			SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0 )
				 
			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
			, ModifiedDate = @GetDate
			WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
			FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
			INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
			WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
			AND SCLI.ConfigurableProductIds <> ''

			--After update the existing cart with new save cart then deleting those records which are updated
			DELETE	FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0
		END 
		--Getting bundle save cart line item entries into table to pass for configurable prodcut sp
		DECLARE @TBL_Configurable TT_SavecartLineitems 
		INSERT INTO @TBL_Configurable 
		SELECT *  
		FROM @TBL_SavecartLineitems 
		WHERE ISNULL(ConfigurableProductIds,'') <> '' 
		  
		EXEC Znode_InsertUpdateSaveCartLineItemConfigurable @TBL_Configurable,@userId,@OrderLineItemRelationshipTypeIdConfigurable,@OrderLineItemRelationshipTypeIdAddon
				  
		DELETE FROM @TBL_SavecartLineitems 
		WHERE ISNULL(ConfigurableProductIds,'') <> ''
		SET @OmsSavedCartLineItemId = 0  
	END 
	--Save cart execution code for group product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' )
	BEGIN 				
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
		BEGIN 
			--Updating the existing save cart for group product
			SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0 )
			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
			WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
			FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
			INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
			WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
			AND SCLI.GroupProductIds <> ''

			--After update the existing cart with new save cart then deleting those records which are updated
			DELETE	FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0
		END 
		--Getting bundle save cart line item entries into table to pass for group prodcut sp
		DECLARE @TBL_Group TT_SavecartLineitems 
		INSERT INTO @TBL_Group 
		SELECT *  
		FROM @TBL_SavecartLineitems 
		WHERE ISNULL(GroupProductIds,'') <> '' 
		
		EXEC Znode_InsertUpdateSaveCartLineItemGroup @TBL_Group,@userId,@OrderLineItemRelationshipTypeIdGroup,@OrderLineItemRelationshipTypeIdAddon
		
		--After update the existing cart with new save cart then deleting those records which are updated
		DELETE FROM @TBL_SavecartLineitems WHERE ISNULL(GroupProductIds,'') <> ''
		SET @OmsSavedCartLineItemId = 0  
	END 
	
	--This part is for updating the cart for existing line items for simple product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId <> 0  ) 
	BEGIN 
				 
		SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId <> 0 )
		UPDATE ZnodeOmsSavedCartLineItem 
		SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
		, ModifiedDate = @GetDate
		WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId

		UPDATE ZnodeOmsSavedCartLineItem 
		SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
		INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = @OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
		WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					
		DELETE	FROM @TBL_SavecartLineitems WHERE OmsSavedCartLineItemId <> 0
	END 
	--Save cart execution code for Simple product
	DECLARE @OmsInsertedData TABLE (OmsSavedCartLineItemId INT )
	--Inserting the personalise data into variable table @TBL_Personalise for inserting the personalise data for new products
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId int,SKU Varchar(600) ,PersonalizeCode NVARCHAr(max),PersonalizeValue NVARCHAr(max),DesignId NVARCHAr(max), ThumbnailURL NVARCHAr(max))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.SKU
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(Max)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(Max)' ) AS ThumbnailURL
	FROM @TBL_SavecartLineitems a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col) 
			  
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise1 TABLE (OmsSavedCartLineItemId INT ,PersonalizeCode NVARCHAr(max),PersonalizeValue NVARCHAr(max),DesignId NVARCHAr(max), ThumbnailURL NVARCHAr(max))
	INSERT INTO @TBL_Personalise1
	SELECT DISTINCT a.OmsSavedCartLineItemId 
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(Max)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(Max)' ) AS ThumbnailURL
	FROM (SELECT TOP 1 OmsSavedCartLineItemId,PersonalisedAttribute Valuex FROM  #TBL_SavecartLineitems TRTR ) a 
	CROSS APPLY	a.Valuex.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  
		    
			
	CREATE TABLE #NewSavecartLineitemDetails 
	(
		GenId INT IDENTITY(1,1),RowId	INT	,OmsSavedCartLineItemId	INT	 ,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	INT
		,SKU	NVARCHAR(MAX) ,Quantity	NUMERIC(28,6)	,OrderLineItemRelationshipTypeID	INT	,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	int	,AutoAddon	varchar(MAX)	,OmsOrderId	INT	,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX)
	)
	
	--Getting new save cart data
	INSERT INTO #NewSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU 
	FROM @TBL_SavecartLineitems a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
	
	--Getting new simple product save cart data
	INSERT INTO #NewSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, @OrderLineItemRelationshipTypeIdSimple, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU 
	FROM @TBL_SavecartLineitems  a 
	WHERE ISNULL(BundleProductIds,'') =  '' 
	AND  ISNULL(GroupProductIds,'') = ''	AND ISNULL(	ConfigurableProductIds,'') = ''
		GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity,  CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
			
	--Getting new Group,Bundle and Configurable products save cart data if addon is present for any line item
	INSERT INTO #NewSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
		,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
		WHEN  GroupProductIds <> '' THEN GroupProductIds 
		WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU 
	FROM @TBL_SavecartLineitems  a 
	WHERE AddOnValueIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
	
	CREATE TABLE #OldSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old save cart data if present for same SKU in the new save cart data for simple product	 
	INSERT INTO #OldSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM ZnodeOmsSavedCartLineItem a with (nolock)  
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.SKU,'')   )   
	AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple   

	--Getting the old save cart Parent data 
	INSERT INTO #OldSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
	AND  b.OrderLineItemRelationshipTypeID IS NULL 
		 
	DELETE a FROM #OldSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 
		
	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldSavecartLineitemDetails
		
	--Getting the old save cart addon data for old line items if present
	INSERT INTO #OldSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
	AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

	------Merge Addon for same product
	IF EXISTS(SELECT * FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'') <> '' )
	BEGIN

		INSERT INTO #OldValueForAddon 
		SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
		FROM ZnodeOmsSavedCartLineItem b with (nolock)
		INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
								( SELECT  ', ' + SKU FROM    
									( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
										where a.OmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
										FOR XML PATH('')
								), 1, 2, ''
								) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a where a.ParentOmsSavedCartLineItemId is not null and OrderLineItemRelationshipTypeID<>1

		SELECT distinct a.SKU, STUFF(
									( SELECT  ', ' + x.AddOnValueIds FROM    
									( SELECT DISTINCT b.AddOnValueIds FROM @TBL_SavecartLineitems b
										where a.SKU=b.SKU ) x
										FOR XML PATH('')
									), 1, 2, ''
								) AddOns
		INTO #AddOnAdded
		FROM @TBL_SavecartLineitems a

		IF NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
		BEGIN
			DELETE FROM #OldSavecartLineitemDetails
		END

	END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_SavecartLineitems ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldSavecartLineitemDetails a WHERE	
	ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN 
		
		DELETE FROM #OldSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
	    
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  <> '' )
		BEGIN 
		 
			DECLARE @parenTofAddon  TABLE( ParentOmsSavedCartLineItemId INT  )  
			INSERT INTO  @parenTofAddon 
			SELECT  ParentOmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  

			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ParentOmsSavedCartLineItemId FROM  @parenTofAddon)   
				AND ParentOmsSavedCartLineItemId IS NOT NULL  
				AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldSavecartLineitemDetails m)
			AND ParentOmsSavedCartLineItemId IS  NULL  
		 
		END 
		ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		BEGIN 

			DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple  )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
			OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		    
			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldSavecartLineitemDetails m)
			AND ParentOmsSavedCartLineItemId IS  NULL  

		END
		ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  = '' )
		BEGIN 

			DELETE FROM #OldSavecartLineitemDetails
		END 
	END 

	--Getting the personalise data for old save cart if present
	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)

	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		DELETE FROM #OldSavecartLineitemDetails
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 
		   
			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
			SELECT OmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
			OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		      
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 

			DELETE n FROM #OldSavecartLineitemDetails n WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
			OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
	   
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		BEGIN 
			DELETE FROM #OldSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		END 
	  
	END 

	--If already exists cart 
	IF EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails )
	BEGIN
		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU not having personalise value for new cart item
		;WITH cte AS
		(
			SELECT distinct b.*
			FROM @TBL_SavecartLineitems a 
			INNER JOIN #OldSavecartLineitemDetails b on ( a.SKU = b.sku)
			where isnull(cast(a.PersonalisedAttribute AS varchar(max)),'') = ''
		)
		,cte2 AS
		(
			SELECT c.ParentOmsSavedCartLineItemId
			FROM #OldSavecartLineitemDetails a
			INNER JOIN ZnodeOmsSavedCartLineItem c on a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		)
		DELETE a FROM #OldSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU having personalise value for new cart item
		;WITH cte AS
		(
			SELECT distinct b.*, 
				a.PersonalizeCode
				,a.PersonalizeValue
			FROM @TBL_Personalise a 
			INNER JOIN #OldSavecartLineitemDetails b on ( a.SKU = b.sku)
			where a.PersonalizeValue <> ''
		)
		,cte2 AS
		(
			SELECT a.ParentOmsSavedCartLineItemId, b.PersonalizeCode, b.PersonalizeValue
			FROM #OldSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
			WHERE NOT EXISTS(SELECT * FROM cte c where b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and b.PersonalizeCode = c.PersonalizeCode 
						and b.PersonalizeValue = c.PersonalizeValue )
		)
		DELETE a FROM #OldSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,b.ParentOmsSavedCartLineItemId , a.SKU AS SKU
				,a.PersonalizeCode
				,a.PersonalizeValue
				,a.DesignId
				,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldSavecartLineitemDetails b on a.SKU = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM #OldSavecartLineitemDetails b1 
		WHERE NOT EXISTS(SELECT * FROM cte c where (b1.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or b1.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId))
		AND EXISTS(SELECT * FROM cte)

		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
	
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.SKU
						,d.PersonalizeCode
				,d.PersonalizeValue
				,d.DesignId
				,d.ThumbnailURL
				FROM @TBL_SavecartLineitems a 
				INNER JOIN #OldSavecartLineitemDetails b on a.SKU = b.SKU
				INNER JOIN @TBL_Personalise d on d.SKU = a.SKU
				INNER JOIN ZnodeOmsPersonalizeCartItem  c  with (nolock)  on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
				WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM cte a1		  
		INNER JOIN #OldSavecartLineitemDetails b1 on a1.sku = b1.SKU
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c where a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and a1.PersonalizeValue = c.PersonalizeValue)

		--Updating the cart if old and new cart data matches 
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5, 
		a.ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewSavecartLineitemDetails ty ON (ty.SKU = b.SKU)

	END 
	--Inserting the new save cart data if old and new cart data not match
	ELSE 
	BEGIN 
	    --Getting the new save cart data and generating row no. for new save cart insert
		SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU  
		INTO #InsertNewSavecartLineitem   
		FROM  #NewSavecartLineitemDetails  
		GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails ,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU   
		ORDER BY RowId, Id   
       	
		--Removing the line item having Quantity <=0	     
		DELETE FROM #InsertNewSavecartLineitem WHERE Quantity <=0  
  
		--Updating the rowid into new save cart line item as new line item is merged into existing save cart item
		;WITH VTTY AS   
		(  
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
			FROM #InsertNewSavecartLineitem m  
			INNER JOIN  #InsertNewSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU   
			WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon   
		)   
		UPDATE m1   
		SET m1.RowId = TYU.RowId  
		FROM #InsertNewSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  
        
		--Deleting the new save cart line item if cart line item is merged
		;WITH VTRET AS   
		(  
			SELECT RowId,id,Min(NewRowId) NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID  
			FROM #InsertNewSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID
			Having  SKU = ParentSKU  AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdSimple
		)   
		DELETE FROM #InsertNewSavecartLineitem WHERE NewRowId IN (SELECT NewRowId FROM VTRET)  

		--Inserting the new cart line item if not merged in existing save cart line item
		INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description)  
		OUTPUT INSERTED.OmsSavedCartLineItemId  INTO @OmsInsertedData 
		SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description   
		FROM  #InsertNewSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU  
		INTO #ParentOmsSavedCartId
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		AND CASE WHEN EXISTS (SELECT TOP 1 1 FROM #InsertNewSavecartLineitem TU WHERE TU.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple)  THEN ISNULL(a.OrderLineItemRelationshipTypeID,0) ELSE 0 END = 0 
		GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #ParentOmsSavedCartId  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
		AND a.ParentOmsSavedCartLineItemId IS nULL   

		SELECT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(Order BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #NewSimpleProduct
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c on b.sku = c.sku and b.OmsSavedCartId=c.OmsSavedCartId and b.Id = 1 
		WHERE ( ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  and c.ParentOmsSavedCartLineItemId is null

		--Updating ParentOmsSavedCartLineItemId for newly added save cart line item
		;WITH table_update AS 
		(
			SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId  ) RowIdNo
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
			AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
			AND a.ParentOmsSavedCartLineItemId IS NULL  
			AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
			AND EXISTS (SELECT TOP 1 1 FROM #NewSimpleProduct TI WHERE TI.SKU = a.SKU)
		)
		UPDATE a SET  
		a.ParentOmsSavedCartLineItemId =(SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewSimpleProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewSimpleProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU   GROUP BY r.ParentSKU, r.SKU  )    IS NOT NULL 
	 
		;WITH Cte_Th AS   
		(             
			SELECT RowId    
			FROM #InsertNewSavecartLineitem a   
			GROUP BY RowId   
			HAVING COUNT(NewRowId) <= 1   
		)   
		UPDATE a SET a.Quantity =  NULL , a.ModifiedDate = @GetDate  
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		AND OrderLineItemRelationshipTypeId IS NOT NULL     

		;WITH Cte_UpdateSequence AS   
		(  
			SELECT OmsSavedCartLineItemId ,Row_Number()Over(Order By OmsSavedCartLineItemId) RowId , Sequence   
			FROM ZnodeOmsSavedCartLineItem with (nolock)  
			WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		)   
		UPDATE Cte_UpdateSequence  
		SET  Sequence = RowId  
	
		----To update saved cart item personalise value FROM given line item	
		IF EXISTS(SELECT * FROM @TBL_Personalise1 where isnull(PersonalizeValue,'') <> '' and isnull(OmsSavedCartLineItemId,0) <> 0)
		BEGIN
			DELETE FROM ZnodeOmsPersonalizeCartItem 
			WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise1 yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )

			MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
			USING @TBL_Personalise1 SOURCE
			ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			WHEN NOT MATCHED THEN 
			INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
							,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
			VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
							,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
		END		
	
		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN ZnodeOmsSavedCartLineItem b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS NOT NULL 
	
		DELETE FROM ZnodeOmsPersonalizeCartItem 
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
						
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
		ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
		WHEN NOT MATCHED THEN 
		INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
					,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
		VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
					,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
  
		
		 
	END 

	Declare @OutputTable Table (CartCount numeric(28,6))

	INSERT INTO @OutputTable
	EXEC [Znode_GetOmsSavedCartLineItemCount] @OmsCookieMappingId = @OmsCookieMappingId,@UserId=@UserId,@PortalId=@UserId
	

	SELECT CAST(1 AS bit) AS Status,@OmsSavedCartId AS SavedCartId,@OmsCookieMappingId AS CookieMappingId,CartCount
	FROM @OutputTable

COMMIT TRAN InsertUpdateSaveCartLineItem;
END TRY
BEGIN CATCH
	SELECT ERROR_MESSAGE()	
	DECLARE @Error_procedure varchar(1000)= ERROR_PROCEDURE(), @ErrorMessage nvarchar(max)= ERROR_MESSAGE(), @ErrorLine varchar(100)= ERROR_LINE(), @ErrorCall nvarchar(max)= 'EXEC Znode_InsertUpdateSaveCartLineItem @CartLineItemXML = '+CAST(@CartLineItemXML
	AS varchar(max))+',@UserId = '+CAST(@UserId AS varchar(50))+',@PortalId='+CAST(@PortalId AS varchar(10))+',@OmsCookieMappingId='+CAST(@OmsCookieMappingId AS varchar(10));

	SELECT 0 AS ID, CAST(0 AS bit) AS Status,ERROR_MESSAGE();
	ROLLBACK TRAN InsertUpdateSaveCartLineItem;
	EXEC Znode_InsertProcedureErrorLog @ProcedureName = 'Znode_InsertUpdateSaveCartLineItem', @ErrorInProcedure = @Error_procedure, @ErrorMessage = @ErrorMessage, @ErrorLine = @ErrorLine, @ErrorCall = @ErrorCall;
END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishCategory')
	DROP PROC Znode_GetPublishCategory

GO

CREATE PROCEDURE [dbo].[Znode_GetPublishCategory]
(   @PublishCatalogId INT,
    @UserId           INT,
    @VersionId        INT,
    @Status           BIT = 0 OUT,
    @IsDebug          BIT = 0,
	@LocaleId         TransferID READONLY
)
AS 
/*
       Summary:Publish category with their respective products and details 
	            The result is fetched in xml form   
       Unit Testing   
       Begin transaction 
       SELECT * FROM ZnodePIMAttribute 
	   SELECT * FROM ZnodePublishCatalog 
	   SELECT * FROM ZnodePublishCategory WHERE publishCAtegoryID = 167 


       EXEC [Znode_GetPublishCategory] @PublishCatalogId = 3,@VersionId = 0 ,@UserId =2 ,@IsDebug = 1 
     


       Rollback Transaction 
	*/
     BEGIN
         BEGIN TRAN GetPublishCategory;
         BEGIN TRY
             SET NOCOUNT ON;
			 DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
             DECLARE @LocaleIdIn INT= 0, @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId(), @Counter INT= 1, @MaxId INT= 0, @CategoryIdCount INT;
             DECLARE @IsActive BIT= [dbo].[Fn_GetIsActiveTrue]();
             DECLARE @AttributeIds VARCHAR(MAX)= '', @PimCategoryIds VARCHAR(MAX)= '', @DeletedPublishCategoryIds VARCHAR(MAX)= '', @DeletedPublishProductIds VARCHAR(MAX);
             --get the pim catalog id 
			 DECLARE @PimCatalogId INT=(SELECT PimCatalogId FROM ZnodePublishcatalog WHERE PublishCatalogId = @PublishCatalogId); 

             DECLARE @TBL_AttributeIds TABLE
             (PimAttributeId       INT,
              ParentPimAttributeId INT,
              AttributeTypeId      INT,
              AttributeCode        VARCHAR(600),
              IsRequired           BIT,
              IsLocalizable        BIT,
              IsFilterable         BIT,
              IsSystemDefined      BIT,
              IsConfigurable       BIT,
              IsPersonalizable     BIT,
              DisplayOrder         INT,
              HelpDescription      VARCHAR(MAX),
              IsCategory           BIT,
              IsHidden             BIT,
              CreatedDate          DATETIME,
              ModifiedDate         DATETIME,
              AttributeName        NVARCHAR(MAX),
              AttributeTypeName    VARCHAR(300)
             );
             DECLARE @TBL_AttributeDefault TABLE
             (PimAttributeId            INT,
              AttributeDefaultValueCode VARCHAR(100),
              IsEditable                BIT,
              AttributeDefaultValue     NVARCHAR(MAX)
			  ,DisplayOrder   INT
             );
             DECLARE @TBL_AttributeValue TABLE
             (PimCategoryAttributeValueId INT,
              PimCategoryId               INT,
              CategoryValue               NVARCHAR(MAX),
              AttributeCode               VARCHAR(300),
              PimAttributeId              INT
             );
             DECLARE @TBL_LocaleIds TABLE
             (RowId     INT IDENTITY(1, 1),
              LocaleId  INT,
              IsDefault BIT
             );
             DECLARE @TBL_PimCategoryIds TABLE
             (PimCategoryId       INT,
              PimParentCategoryId INT,
              DisplayOrder        INT,
              ActivationDate      DATETIME,
              ExpirationDate      DATETIME,
              CategoryName        NVARCHAR(MAX),
              ProfileId           VARCHAR(MAX),
              IsActive            BIT,
			  PimCategoryHierarchyId INT,
			  ParentPimCategoryHierarchyId INT ,
			   CategoryCode  NVARCHAR(MAX)             );


             DECLARE @TBL_PublishPimCategoryIds TABLE
             (PublishCategoryId       INT,
              PimCategoryId           INT,
              PublishProductId        varchar(max),
              PublishParentCategoryId INT ,
			  PimCategoryHierarchyId INT ,parentPimCategoryHierarchyId INT,
			  RowIndex INT
             );
             DECLARE @TBL_DeletedPublishCategoryIds TABLE
             (PublishCategoryId INT,
              PublishProductId  INT
             );
             DECLARE @TBL_CategoryXml TABLE
             (PublishCategoryId INT,
              CategoryXml       XML,
              LocaleId          INT
             );
             INSERT INTO @TBL_LocaleIds
             (LocaleId,
              IsDefault
             )
			  -- here collect all locale ids
             SELECT LocaleId,IsDefault FROM ZnodeLocale MT WHERE IsActive = @IsActive
			  AND (EXISTS (SELECT TOP 1 1  FROM @LocaleId RT WHERE RT.Id = MT.LocaleId )
			 OR NOT EXISTS (SELECT TOP 1 1 FROM @LocaleId ));

			 if object_id('tempdb..#CategoryData')is not null
				drop table #CategoryData

			 ------------for CategoryCode update
			SELECT ZPCAL.CategoryValue as CategoryCode,MAX(ZPC.PublishCategoryId) as PublishCategoryId ,ZPCA.PimCategoryId, ZPoC.PortalId
			INTO #CategoryData
			FROM ZnodePimCategoryAttributeValue ZPCA
			INNER JOIN ZnodePimCategoryAttributeValueLocale ZPCAL on ZPCA.PimCategoryAttributeValueId = ZPCAL.PimCategoryAttributeValueId
			INNER JOIN ZnodePimAttribute ZPA ON ZPCA.PimAttributeId = ZPA.PimAttributeId
			INNER JOIN ZnodePublishCategory ZPC on ZPCA.PimCategoryId = ZPC.PimCategoryId
			INNER JOIN ZnodePortalCatalog ZPoC on ZPC.PublishCatalogId = ZPoC.PublishCatalogId
			where ZPA.AttributeCode = 'CategoryCode' AND ZPC.PublishCatalogId = @PublishCatalogId
			AND EXISTS(SELECT * FROM ZnodeCMSWidgetCategory ZCWC WHERE ZPC.PublishCategoryId = ZCWC.PublishCategoryId )
			group by ZPCAL.CategoryValue, ZPCA.PimCategoryId, ZPoC.PortalId

			UPDATE ZCWC SET ZCWC.CategoryCode = CD.CategoryCode
			from ZnodeCMSWidgetCategory ZCWC
			INNER JOIN #CategoryData CD ON ZCWC.PublishCategoryId = CD.PublishCategoryId and ZCWC.CMSMappingId = CD.PortalId
			where ZCWC.TypeOFMapping = 'PortalMapping'
			----------

             INSERT INTO @TBL_PimCategoryIds(PimCategoryId,PimParentCategoryId,DisplayOrder,ActivationDate,ExpirationDate,IsActive,PimCategoryHierarchyId,ParentPimCategoryHierarchyId)
             SELECT DISTINCT ZPCH.PimCategoryId,ZPCH2.PimCategoryId  PimParentCategoryId,ZPCH.DisplayOrder,ZPCH.ActivationDate,ZPCH.ExpirationDate,ZPCH.IsActive ,ZPCH.PimCategoryHierarchyId,ZPCH.ParentPimCategoryHierarchyId
			 FROM ZnodePimCategoryHierarchy AS ZPCH 
			 LEFT JOIN ZnodePimCategoryHierarchy AS ZPCH2 ON (ZPCH2.PimCategoryHierarchyId = ZPCH. ParentPimCategoryHierarchyId ) 
			 WHERE ZPCH.PimCatalogId = @PimCatalogId; 
             -- AND IsActive = @IsActive ; -- As discussed with @anup active flag maintain on demo site 23/12/2016
			 --	SELECT * FROM @TBL_PimCategoryIds
			 -- here is find the deleted publish category id on basis of publish catalog
             INSERT INTO @TBL_DeletedPublishCategoryIds(PublishCategoryId,PublishProductId)
             SELECT ZPC.PublishCategoryId,ZPCP.PublishProductId 
			 FROM ZnodePublishCategoryProduct ZPCP
             INNER JOIN ZnodePublishCategory AS ZPC ON(ZPCP.PublishCategoryId = ZPC.PublishCategoryId AND ZPCP.PublishCatalogId = ZPC.PublishCatalogId)                                                  
             INNER JOIN ZnodePublishProduct ZPP ON(zpp.PublishProductId = zpcp.PublishProductId AND zpp.PublishCatalogId = zpcp.PublishCatalogId)
             INNER JOIN ZnodePublishCatalog ZPCC ON(ZPCC.PublishCatalogId = ZPCP.PublishCatalogId)
             WHERE ZPC.PublishCatalogId = @PublishCataLogId 
			 AND NOT EXISTS(SELECT TOP 1 1 FROM ZnodePimCategoryHierarchy AS TBPC WHERE TBPC.PimCategoryId = ZPC.PimCategoryId AND TBPC.PimCategoryHierarchyId = ZPC.PimCategoryHierarchyId
			 AND TBPC.PimCatalogId = ZPCC.PimCatalogId);

			 -- here is find the deleted publish category id on basis of publish catalog
             SET @DeletedPublishCategoryIds = ISNULL(SUBSTRING((SELECT ','+CAST(PublishCategoryId AS VARCHAR(50)) FROM @TBL_DeletedPublishCategoryIds AS ZPC
                                              GROUP BY ZPC.PublishCategoryId FOR XML PATH('') ), 2, 4000), '');
			 -- here is find the deleted publish category id on basis of publish catalog
             SET @DeletedPublishProductIds = '';
			 -- Delete the publish category id 
	
	        --   SELECT * FROM @TBL_DeletedPublishCategoryIds 

             EXEC Znode_DeletePublishCatalog @PublishCatalogIds = @PublishCatalogId,@PublishCategoryIds = @DeletedPublishCategoryIds,@PublishProductIds = @DeletedPublishProductIds; 
			
             MERGE INTO ZnodePublishCategory TARGET USING  @TBL_PimCategoryIds SOURCE ON
			 (
			 TARGET.PimCategoryId = SOURCE.PimCategoryId 
			 AND TARGET.PublishCatalogId = @PublishCataLogId 
			 AND TARGET.PimCategoryHierarchyId = SOURCE.PimCategoryHierarchyId
			 )
			 WHEN MATCHED THEN UPDATE SET TARGET.PimParentCategoryId = SOURCE.PimParentCategoryId,TARGET.CreatedBy = @UserId,TARGET.CreatedDate = @GetDate,
             TARGET.ModifiedBy = @UserId,TARGET.ModifiedDate = @GetDate,PimCategoryHierarchyId = SOURCE.PimCategoryHierarchyId,ParentPimCategoryHierarchyId=SOURCE.ParentPimCategoryHierarchyId
             WHEN NOT MATCHED THEN INSERT(PimCategoryId,PublishCatalogId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PimCategoryHierarchyId,ParentPimCategoryHierarchyId) 
			 VALUES(SOURCE.PimCategoryId,@PublishCatalogId,@UserId,@GetDate,@UserId,@GetDate,SOURCE.PimCategoryHierarchyId,SOURCE.ParentPimCategoryHierarchyId)
             OUTPUT INSERTED.PublishCategoryId,INSERTED.PimCategoryId,INSERTED.PimCategoryHierarchyId,INSERTED.parentPimCategoryHierarchyId INTO @TBL_PublishPimCategoryIds(PublishCategoryId,PimCategoryId,PimCategoryHierarchyId,parentPimCategoryHierarchyId);
			
    --         UPDATE TBPC SET PublishParentCategoryId = TBPCS.PublishCategoryId 
			 --FROM @TBL_PublishPimCategoryIds TBPC
    --         INNER JOIN @TBL_PimCategoryIds TBC ON(TBC.PimCategoryId = TBPC.PimCategoryId AND TBC.PimCategoryHierarchyId = TBPC.PimCategoryHierarchyId)
    --         INNER JOIN @TBL_PublishPimCategoryIds TBPCS ON(TBC.PimCategoryHierarchyId = TBPCS.parentPimCategoryHierarchyId  ) 
			 --WHERE TBC.parentPimCategoryHierarchyId IS NOT NULL;
           
		     -- here update the publish parent category id
             UPDATE ZPC SET [PimParentCategoryId] =TBPC.[PimCategoryId] 
			 FROM ZnodePublishCategory ZPC
             INNER JOIN ZnodePublishCategory TBPC ON(ZPC.parentPimCategoryHierarchyId = TBPC.PimCategoryHierarchyId  ) 
			 WHERE ZPC.PublishCatalogId =@PublishCatalogId
			 AND ZPC.ParentPimCategoryHierarchyId IS NOT NULL
			 AND TBPC.PublishCatalogId =@PublishCatalogId
			 ;
			 UPDATE a
			 SET  a.PublishParentCategoryId = b.PublishCategoryId
			FROM ZnodePublishCategory a 
			INNER JOIN ZnodePublishCategory b   ON (a.parentpimCategoryHierarchyId = b.pimCategoryHierarchyId)
			WHERE a.parentpimCategoryHierarchyId IS NOT NULL 
			AND a.PublishCatalogId =@PublishCatalogId
			AND b.PublishCatalogId =@PublishCatalogId

			UPDATE a set a.PublishParentCategoryId = NULL
			FROM ZnodePublishCategory a 
			WHERE a.parentpimCategoryHierarchyId IS NULL AND PimParentCategoryId IS NULL
			AND a.PublishCatalogId = @PublishCatalogId AND a.PublishParentCategoryId IS NOT NULL

			 --UPDATE ZPC SET [PimParentCategoryId] = TBPC.[PimCategoryId] 
			 --FROM ZnodePublishCategory ZPC
    --         INNER JOIN ZnodePublishCategory TBPC ON(ZPC.parentPimCategoryHierarchyId = TBPC.PimCategoryHierarchyId  ) 
			 --WHERE ZPC.PublishCatalogId =@PublishCatalogId
			 --AND ZPC.ParentPimCategoryHierarchyId IS NOT NULL ;

			 -- product are published here 
            --  EXEC Znode_GetPublishProducts @PublishCatalogId,0,@UserId,1,0,0;

             SET @MaxId =(SELECT MAX(RowId)FROM @TBL_LocaleIds);
			 DECLARE @TransferID TRANSFERID 
			 INSERT INTO @TransferID 
			 SELECT DISTINCT  PimCategoryId
			 FROM @TBL_PublishPimCategoryIds 

             SET @PimCategoryIds = SUBSTRING((SELECT ','+CAST(PimCategoryId AS VARCHAR(50)) FROM @TBL_PublishPimCategoryIds FOR XML PATH('')), 2, 4000);
			 
             WHILE @Counter <= @MaxId -- Loop on Locale id 
                 BEGIN
                     SET @LocaleIdIn =(SELECT LocaleId FROM @TBL_LocaleIds WHERE RowId = @Counter);
                   
				     SET @AttributeIds = SUBSTRING((SELECT ','+CAST(ZPCAV.PimAttributeId AS VARCHAR(50)) FROM ZnodePimCategoryAttributeValue ZPCAV 
										 WHERE EXISTS(SELECT TOP 1 1 FROM @TBL_PimCategoryIds TBPC WHERE TBPC.PimCategoryId = ZPCAV.PimCategoryId) GROUP BY ZPCAV.PimAttributeId FOR XML PATH('')), 2, 4000);
                
				     SET @CategoryIdCount =(SELECT COUNT(1) FROM @TBL_PimCategoryIds);

                     INSERT INTO @TBL_AttributeIds (PimAttributeId,ParentPimAttributeId,AttributeTypeId,AttributeCode,IsRequired,IsLocalizable,IsFilterable,IsSystemDefined,
					 IsConfigurable,IsPersonalizable,DisplayOrder,HelpDescription,IsCategory,IsHidden,CreatedDate,ModifiedDate,AttributeName,AttributeTypeName)
                     EXEC [Znode_GetPimAttributesDetails] @AttributeIds,@LocaleIdIn;

                     INSERT INTO @TBL_AttributeDefault (PimAttributeId,AttributeDefaultValueCode,IsEditable,AttributeDefaultValue,DisplayOrder)
                     EXEC [dbo].[Znode_GetAttributeDefaultValueLocale] @AttributeIds,@LocaleIdIn;

                     INSERT INTO @TBL_AttributeValue (PimCategoryAttributeValueId,PimCategoryId,CategoryValue,AttributeCode,PimAttributeId)
                     EXEC [dbo].[Znode_GetCategoryAttributeValueId] @TransferID,@AttributeIds,@LocaleIdIn;

					-- SELECT * FROM @TBL_AttributeValue WHERE PimCategoryId = 281


                     ;WITH Cte_UpdateDefaultAttributeValue
                     AS (
					  SELECT TBAV.PimCategoryId,TBAV.PimAttributeId,SUBSTRING((SELECT ','+AttributeDefaultValue FROM @TBL_AttributeDefault TBD WHERE TBAV.PimAttributeId = TBD.PimAttributeId
						AND EXISTS(SELECT TOP 1 1 FROM Split(TBAV.CategoryValue, ',') SP WHERE SP.Item = TBD.AttributeDefaultValueCode)FOR XML PATH('')), 2, 4000) DefaultCategoryAttributeValue
						FROM @TBL_AttributeValue TBAV WHERE EXISTS(SELECT TOP 1 1 FROM @TBL_AttributeDefault TBAD WHERE TBAD.PimAttributeId = TBAV.PimAttributeId))
					 
					 -- update the default value with locale 
                     UPDATE TBAV SET CategoryValue = CTUDFAV.DefaultCategoryAttributeValue FROM @TBL_AttributeValue TBAV 
					 INNER JOIN Cte_UpdateDefaultAttributeValue CTUDFAV ON(CTUDFAV.PimCategoryId = TBAV.PimCategoryId AND CTUDFAV.PimAttributeId = TBAV.PimAttributeId)
					 WHERE CategoryValue IS NULL ;
					 
					 -- here is update the media path  
                     WITH Cte_productMedia
                     AS (SELECT TBA.PimCategoryId,TBA.PimAttributeId,[dbo].[FN_GetThumbnailMediaPathPublish](SUBSTRING((SELECT ','+zm.PATH FROM ZnodeMedia ZM WHERE EXISTS
					    (SELECT TOP 1 1 FROM dbo.split(TBA.CategoryValue, ',') SP WHERE SP.Item = CAST(Zm.MediaId AS VARCHAR(50)))FOR XML PATH('')), 2, 4000)) CategoryValue
						FROM @TBL_AttributeValue TBA WHERE EXISTS(SELECT TOP 1 1 FROM [dbo].[Fn_GetProductMediaAttributeId]() FNMA WHERE FNMA.PImAttributeId = TBA.PimATtributeId))
                         
					 UPDATE TBAV SET CategoryValue = CTCM.CategoryValue 
					 FROM @TBL_AttributeValue TBAV 
					 INNER JOIN Cte_productMedia CTCM ON(CTCM.PimCategoryId = TBAV.PimCategoryId
					 AND CTCM.PimAttributeId = TBAV.PimAttributeId);

                     WITH Cte_PublishProductIds
					 AS (SELECT TBPC.PublishcategoryId,SUBSTRING((SELECT ','+CAST(PublishProductId AS VARCHAR(50))
					  FROM ZnodePublishCategoryProduct ZPCP 
					  WHERE ZPCP.PublishCategoryId = TBPC.publishCategoryId
					  AND ZPCP.PimCategoryHierarchyId = TBPC.PimCategoryHierarchyId
                      AND ZPCP.PublishCatalogId = @PublishCatalogId FOR XML PATH('')), 2, 8000) PublishProductId ,PimCategoryHierarchyId
					  FROM @TBL_PublishPimCategoryIds TBPC)
                          
					 UPDATE TBPPC SET PublishProductId = CTPP.PublishProductId FROM @TBL_PublishPimCategoryIds TBPPC INNER JOIN Cte_PublishProductIds CTPP ON(TBPPC.PublishCategoryId = CTPP.PublishCategoryId 
					 AND TBPPC.PimCategoryHierarchyId = CTPP.PimCategoryHierarchyId);

                     WITH Cte_CategoryProfile
                     AS (
							SELECT PimCategoryId,ZPCC.PimCategoryHierarchyId,
								SUBSTRING(( SELECT ','+CAST(ProfileId AS VARCHAR(50)) 
								FROM ZnodeProfile ZPC 
								INNER JOIN ZnodePimCategoryHierarchy ZPRCC ON(ZPRCC.PimCategoryHierarchyId = ZPCC.PimCategoryHierarchyId
								AND ZPRCC.PimCatalogId = ZPC.PimCatalogId) 
								WHERE ZPC.PimCatalogId = ZPCC.PimCatalogId FOR XML PATH('')), 2, 4000) ProfileIds
						   FROM ZnodePimCategoryHierarchy ZPCC 
						   WHERE EXISTS(SELECT TOP 1 1 FROM @TBL_PimCategoryIds TBPC 
						   WHERE TBPC.PimCategoryId = ZPCC.PimCategoryId AND ZPCC.PimCatalogId = @PimCatalogId 
						   AND ZPCC.PimCategoryHierarchyId = TBPC.PimCategoryHierarchyId)
						 )                          
						UPDATE TBPC SET TBPC.ProfileId = CTCP.ProfileIds FROM @TBL_PimCategoryIds TBPC 
						LEFT JOIN Cte_CategoryProfile CTCP ON(CTCP.PimCategoryId = TBPC.PimCategoryId AND CTCP.PimCategoryHierarchyId = TBPC.PimCategoryHierarchyId );
                     
					 UPDATE TBPC SET TBPC.CategoryName = TBAV.CategoryValue FROM @TBL_PimCategoryIds TBPC INNER JOIN @TBL_AttributeValue TBAV ON(TBAV.PimCategoryId = TBPC.PimCategoryId
                     AND EXISTS(SELECT TOP 1 1 FROM [dbo].[Fn_GetCategoryNameAttribute]() FNGCNA WHERE FNGCNA.PimAttributeId = TBAV.PimAttributeId));


					  UPDATE TBPC SET TBPC.CategoryCode = TBAV.CategoryValue FROM @TBL_PimCategoryIds TBPC INNER JOIN @TBL_AttributeValue TBAV ON(TBAV.PimCategoryId = TBPC.PimCategoryId
					 AND EXISTS(SELECT TOP 1 1 FROM dbo.Fn_GetCategoryCodeAttribute() FNGCNA WHERE FNGCNA.PimAttributeId = TBAV.PimAttributeId)
					 )


					DECLARE @UpdateCategoryLog  TABLE (PublishCatalogLogId INT , LocaleId INT ,PublishCatalogId INT  )
					INSERT INTO @UpdateCategoryLog
					SELECT MAX(PublishCatalogLogId) PublishCatalogLogId , LocaleId , PublishCatalogId 
					FROM ZnodePublishCatalogLog a 
					WHERE a.PublishCatalogId =@PublishCatalogId
					AND  a.LocaleId = @LocaleIdIn 
					GROUP BY 	LocaleId,PublishCatalogId 



					 -- here update the publish category details 
                     ;WITH Cte_UpdateCategoryDetails
                     AS (
					 SELECT TBC.PimCategoryId,PublishCategoryId,CategoryName, TBPPC.PimCategoryHierarchyId,CategoryCode
					 FROM @TBL_PimCategoryIds TBC
                     INNER JOIN @TBL_PublishPimCategoryIds TBPPC ON(TBC.PimCategoryId = TBPPC.PimCategoryId AND TBC.PimCategoryHierarchyId = TBPPC.PimCategoryHierarchyId)
					 )						
                     MERGE INTO ZnodePublishCategoryDetail TARGET USING Cte_UpdateCategoryDetails SOURCE ON(TARGET.PublishCategoryId = SOURCE.PublishCategoryId
					 AND TARGET.LocaleId = @LocaleIdIn)
                     WHEN MATCHED THEN UPDATE SET PublishCategoryId = SOURCE.PublishcategoryId,PublishCategoryName = SOURCE.CategoryName,LocaleId = @LocaleIdIn,ModifiedBy = @userId,ModifiedDate = @GetDate,CategoryCode=SOURCE.CategoryCode
                     WHEN NOT MATCHED THEN INSERT(PublishCategoryId,PublishCategoryName,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CategoryCode) VALUES
                     (SOURCE.PublishCategoryId,SOURCE.CategoryName,@LocaleIdIn,@userId,@GetDate,@userId,@GetDate,SOURCE.CategoryCode);

					 IF OBJECT_ID('tempdb..#Index') is not null
					BEGIN 
						DROP TABLE #Index
					END 
					CREATE TABLE #Index (RowIndex int ,PimCategoryId int , PimCategoryHierarchyId  int,ParentPimCategoryHierarchyId int )		
					insert into  #Index ( RowIndex ,PimCategoryId , PimCategoryHierarchyId,ParentPimCategoryHierarchyId)
					SELECT CAST(Row_number() OVER (Partition By TBL.PimCategoryId Order by ISNULL(TBL.PimCategoryId,0) desc) AS VARCHAR(100))
					,ZPC.PimCategoryId, ZPC.PimCategoryHierarchyId, ZPC.ParentPimCategoryHierarchyId
					FROM @TBL_PublishPimCategoryIds TBL
					INNER JOIN ZnodePublishCategory ZPC ON (TBL.PimCategoryId = ZPC.PimCategoryId AND TBL.PimCategoryHierarchyId = ZPC.PimCategoryHierarchyId)
					WHERE ZPC.PublishCatalogId = @PublishCatalogId

					UPDATE TBP SET  TBP.[RowIndex]=  IDX.RowIndex 
					FROM @TBL_PublishPimCategoryIds TBP INNER JOIN #Index IDX ON (IDX.PimCategoryId = TBP.PimCategoryId AND IDX.PimCategoryHierarchyId = TBP.PimCategoryHierarchyId)  

                     ;WITH Cte_CategoryXML
                     AS (SELECT PublishcategoryId,PimCategoryId,(SELECT ISNULL(TYU.PublishCatalogLogId,'') VersionId,TBPC.PublishCategoryId ZnodeCategoryId,@PublishCatalogId ZnodeCatalogId
																		,THR.PublishParentCategoryId TempZnodeParentCategoryIds,ZPC.CatalogName ,
																		 ISNULL(DisplayOrder, '0') DisplayOrder,@LocaleIdIn LocaleId,ActivationDate 
																		 ,ExpirationDate,TBC.IsActive,ISNULL(CategoryName, '') Name,ProfileId TempProfileIds,ISNULL(TBPC.PublishProductId, '') TempProductIds
																		 ,ISNULL(TBPC.RowIndex,1) CategoryIndex
																		 ,ISNULL(CategoryCode,'') CategoryCode
                        FROM @TBL_PublishPimCategoryIds TBPC 
						INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId= @PublishCatalogId)
						LEFT JOIN @UpdateCategoryLog TYU ON (TYU.PublishCatalogId = @PublishCatalogId AND TYU.LocaleId = @LocaleIdIn)
						INNER JOIN ZnodePublishCAtegory THR ON (THR.PimCategoryHierarchyId = TBPC.PimCategoryHierarchyId AND THR.PimCategoryId = TBPC.PimCategoryId AND THR.PublishCatalogId= @PublishCatalogId )
						INNER JOIN @TBL_PimCategoryIds TBC ON(TBC.PimCategoryId = TBPC.PimCategoryId AND TBC.PimCategoryHierarchyId = TBPC.PimCategoryHierarchyId) WHERE TBPC.PublishCategoryId = TBPCO.PublishCategoryId 
						FOR XML PATH('')) CategoryXml 
						FROM @TBL_PublishPimCategoryIds TBPCO),

                     Cte_CategoryAttributeXml
                     AS (SELECT CTCX.PublishCategoryId,'<CategoryEntity>'+ISNULL(CategoryXml, '')+ISNULL((SELECT(SELECT TBA.AttributeCode,TBA.AttributeName,ISNULL(IsUseInSearch, 0) IsUseInSearch,
                        ISNULL(IsHtmlTags, 0) IsHtmlTags,ISNULL(IsComparable, 0) IsComparable,(SELECT ''+TBAV.CategoryValue FOR XML PATH('')) AttributeValues,TBA.AttributeTypeName FROM @TBL_AttributeValue TBAV
                        INNER JOIN @TBL_AttributeIds TBA ON(TBAV.PimAttributeId = TBA.PimAttributeId) LEFT JOIN ZnodePimFrontendProperties ZPFP ON(ZPFP.PimAttributeId = TBA.PimAttributeId)
                        WHERE CTCX.PimCategoryId = TBAV.PimCategoryId AND TBAO.PimAttributeId = TBA.PimAttributeId FOR XML PATH('AttributeEntity'), TYPE) FROM @TBL_AttributeIds TBAO
                        FOR XML PATH('Attributes')), '')+'</CategoryEntity>' CategoryXMl FROM Cte_CategoryXML CTCX)

                     INSERT INTO @TBL_CategoryXml(PublishCategoryId,CategoryXml,LocaleId)
                     SELECT PublishCategoryId,CategoryXml,@LocaleIdIn LocaleId FROM Cte_CategoryAttributeXml;
                   
				     DELETE FROM @TBL_AttributeIds;
                     DELETE FROM @TBL_AttributeDefault;
                     DELETE FROM @TBL_AttributeValue;
                     SET @Counter = @Counter + 1;
                 END;

    --         UPDATE ZnodePublishCatalogLog SET PublishCategoryId = SUBSTRING((SELECT ','+CAST(PublishCategoryId AS VARCHAR(50)) FROM @TBL_CategoryXml
			 --GROUP BY PublishCategoryId																				
    --         FOR XML PATH('')), 2, 4000), IsCategoryPublished = 1 WHERE PublishCatalogLogId = @VersionId;

			 --UPDATE ZnodePublishCatalogLog 
			 --SET PublishCategoryId = (SELECT COunt(DISTINCT PublishCategoryId ) FROM ZnodePublishCategory WHERE PublishCatalogId =@PublishCatalogId), IsCategoryPublished = 1 
			 --WHERE EXISTS (SELECT TOP 1 1 FROM @UpdateCategoryLog TY WHERE TY.PublishCatalogLogId =  ZnodePublishCatalogLog.PublishCatalogLogId ) ;


			 UPDATE ZnodePublishCatalogLog 
			 SET PublishCategoryId = (SELECT COunt(DISTINCT PimCategoryId ) 
			 FROM @TBL_PublishPimCategoryIds WHERE PublishCatalogId =@PublishCatalogId), 
			 IsCategoryPublished = 1 
			 WHERE EXISTS (SELECT TOP 1 1 FROM @UpdateCategoryLog TY WHERE TY.PublishCatalogLogId =  ZnodePublishCatalogLog.PublishCatalogLogId ) ;
			 


             DELETE FROM ZnodePublishedXml WHERE PublishCataloglogId = @VersionId;
            
             INSERT INTO ZnodePublishedXml (PublishCatalogLogId,PublishedId,PublishedXML,IsCategoryXML,IsProductXML,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
             SELECT @VersionId PublishCataloglogId,PublishCategoryId,CategoryXml,1,0,LocaleId,@UserId,@GetDate,@UserId,@GetDate FROM @TBL_CategoryXml WHERE @VersionId <> 0;
             
			 SELECT CategoryXml  
			 FROM @TBL_CategoryXml 
			 

			 ------------for CategoryPublishId update
			SELECT ZPCAL.CategoryValue as CategoryCode,MAX(ZPC.PublishCategoryId) as PublishCategoryId ,ZPCA.PimCategoryId,ZPoC.PortalId
			INTO #CategoryData1
			FROM ZnodePimCategoryAttributeValue ZPCA
			INNER JOIN ZnodePimCategoryAttributeValueLocale ZPCAL on ZPCA.PimCategoryAttributeValueId = ZPCAL.PimCategoryAttributeValueId
			INNER JOIN ZnodePimAttribute ZPA ON ZPCA.PimAttributeId = ZPA.PimAttributeId
			INNER JOIN ZnodePublishCategory ZPC on ZPCA.PimCategoryId = ZPC.PimCategoryId
			INNER JOIN ZnodePortalCatalog ZPoC on ZPC.PublishCatalogId = ZPoC.PublishCatalogId
			where ZPA.AttributeCode = 'CategoryCode' AND ZPC.PublishCatalogId = @PublishCatalogId
			group by ZPCAL.CategoryValue, ZPCA.PimCategoryId, ZPoC.PortalId

			UPDATE ZCWC SET ZCWC.PublishCategoryId = CD.PublishCategoryId
			from ZnodeCMSWidgetCategory ZCWC
			INNER JOIN #CategoryData1 CD ON ZCWC.CategoryCode = CD.CategoryCode and ZCWC.CMSMappingId = CD.PortalId
			where ZCWC.TypeOFMapping = 'PortalMapping'
			----------------

			 --UPDATE ZnodePimCategory 
			 --SET IsCategoryPublish =1 
			 --WHERE pimCategoryId IN (SELECT PimCategoryId FROM @TBL_PimCategoryIds)

			 --UPDATE ZnodePimCategory 
			 --SET PublishStateId = Dbo.Fn_GetPublishStateIdForPreview()
			 --WHERE pimCategoryId IN (SELECT PimCategoryId FROM @TBL_PublishPimCategoryIds)

			 DECLARE @PublishStateIdForPreview INT = Dbo.Fn_GetPublishStateIdForPreview()

			 UPDATE ZPC
			 SET ZPC.PublishStateId = @PublishStateIdForPreview
			 FROM ZnodePimCategory ZPC
			 INNER JOIN ZnodePublishCategory ZPCC ON (ZPC.PimCategoryId = ZPCC.PimCategoryId)
			 WHERE ZPCC.PublishCategoryId IN (SELECT PublishCategoryId FROM @TBL_CategoryXml)
              
             COMMIT TRAN GetPublishCategory;
			 
         END TRY
         BEGIN CATCH
             SELECT ERROR_MESSAGE();
             DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishCategory @PublishCatalogId = '+CAST(@PublishCatalogId AS VARCHAR(50))+',@UserId ='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(50));
             SET @Status = 0;
             ROLLBACK TRAN GetPublishCategory;
             EXEC Znode_InsertProcedureErrorLog
                  @ProcedureName = 'Znode_GetPublishCategory',
                  @ErrorInProcedure = @Error_procedure,
                  @ErrorMessage = @ErrorMessage,
                  @ErrorLine = @ErrorLine,
                  @ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemBundle')
	DROP PROC Znode_InsertUpdateSaveCartLineItemBundle

GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemBundle]
 (
	 @SaveCartLineItemType TT_SavecartLineitems READONLY  
	,@Userid  INT = 0
	,@OrderLineItemRelationshipTypeIdBundle INT
	,@OrderLineItemRelationshipTypeIdAddon INT
 )
AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 
    --Declared the variables
    DECLARE @GetDate datetime= dbo.Fn_GetDate(); 
   
	DECLARE @OmsInsertedData TABLE (OmsSavedCartLineItemId INT ) 	
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId INT,BundleProductIds VARCHAR(600) ,PersonalizeCode NVARCHAR(MAX),PersonalizeValue NVARCHAR(MAX),DesignId NVARCHAR(MAX), ThumbnailURL NVARCHAR(MAX))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.BundleProductIds
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(MAX)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(MAX)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(MAX)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(MAX)' ) AS ThumbnailURL
	FROM @SaveCartLineItemType a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col) 

	CREATE TABLE #NewBundleSavecartLineitemDetails 
	(
		GenId INT IDENTITY(1,1),RowId	INT	,OmsSavedCartLineItemId	INT	 ,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	INT
		,SKU	NVARCHAR(MAX) ,Quantity	NUMERIC(28,6)	,OrderLineItemRelationshipTypeID	INT	,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	INT	,AutoAddon	VARCHAR(MAX)	,OmsOrderId	INT	,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX)
	)
	
	--Getting new save cart data(bundle product)
	INSERT INTO #NewBundleSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU 
	FROM @SaveCartLineItemType a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
	 
	--Getting new bundle product save cart data
	INSERT INTO #NewBundleSavecartLineitemDetails 
	SELECT   Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, BundleProductIds
				,Quantity, @OrderLineItemRelationshipTypeIdBundle, CustomText, CartAddOnDetails, Sequence
				,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU  
	FROM @SaveCartLineItemType  a 
	WHERE BundleProductIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, BundleProductIds
	,Quantity,  CustomText, CartAddOnDetails, Sequence ,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
		
	--Getting new Bundle products save cart data if addon is present for any line item
	INSERT INTO #NewBundleSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
	,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
			WHEN  GroupProductIds <> '' THEN GroupProductIds 
			WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU 
	FROM @SaveCartLineItemType  a 
	WHERE AddOnValueIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU

    CREATE TABLE #OldBundleSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old bundle save cart data if present for same SKU in the new save cart data for bundle product		 
	INSERT INTO #OldBundleSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM ZnodeOmsSavedCartLineItem a   
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.BundleProductIds,'')   )   
    AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle   

	--Getting the old save cart Parent data
	INSERT INTO #OldBundleSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b 
	INNER JOIN #OldBundleSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
	AND  b.OrderLineItemRelationshipTypeID IS NULL 

	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldBundleSavecartLineitemDetails

	DELETE a FROM #OldBundleSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldBundleSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 

	--Getting the old bundle product save cart addon data for old line items if present
	INSERT INTO #OldBundleSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b 
	INNER JOIN #OldBundleSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
	AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon	

		------Merge Addon for same product
		IF EXISTS(SELECT * FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
		BEGIN

			INSERT INTO #OldValueForAddon 
			SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
			FROM ZnodeOmsSavedCartLineItem b 
			INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
			WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
			AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
									( SELECT  ', ' + SKU FROM    
										( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
											WHERE a.ParentOmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
											FOR XML PATH('')
									), 1, 2, ''
									) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a WHERE a.ParentOmsSavedCartLineItemId is not null and OrderLineItemRelationshipTypeID<>1

		SELECT distinct a.BundleProductIds SKU, STUFF(
										( SELECT  ', ' + x.AddOnValueIds FROM    
										( SELECT DISTINCT b.AddOnValueIds FROM @SaveCartLineItemType b
											WHERE a.SKU=b.SKU ) x
											FOR XML PATH('')
										), 1, 2, ''
									) AddOns
		INTO #AddOnAdded
		FROM @SaveCartLineItemType a

		if NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
		begin
			DELETE FROM #OldBundleSavecartLineitemDetails
		end

		END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @SaveCartLineItemType ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldBundleSavecartLineitemDetails a WHERE	
	ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
	AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN 
		
		DELETE FROM #OldBundleSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
		BEGIN 

			 DECLARE @parenTofAddon INT  = 0 
			 SET @parenTofAddon = (SELECT TOP 1 ParentOmsSavedCartLineItemId 
			 FROM #OldBundleSavecartLineitemDetails a
			 WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
			 AND (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem  t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId AND   t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			  )

			 DELETE FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId <> @parenTofAddon  AND ParentOmsSavedCartLineItemId IS NOT NULL  

			 DELETE FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldBundleSavecartLineitemDetails m)
			 AND ParentOmsSavedCartLineItemId IS  NULL  
		 
			 IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			  BEGIN 
				DELETE FROM #OldBundleSavecartLineitemDetails
			  END 
			IF (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem   WHERE ParentOmsSavedCartLineItemId =@parenTofAddon AND   OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			BEGIN 
				DELETE FROM #OldBundleSavecartLineitemDetails
			END 

		 END 
		 ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) >= 1 
		 BEGIN 
		    DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM ZnodeOmsSavedCartLineItem a 
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
			OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		 END 
		 ELSE IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  BEGIN 
		    DELETE FROM #OldBundleSavecartLineitemDetails
		  END 
		   ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		      AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  = '' )
		 BEGIN 
		   DELETE FROM #OldBundleSavecartLineitemDetails
		 END 

	END 
	
	--Getting the personalise data for old save cart if present
	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		DELETE FROM #OldBundleSavecartLineitemDetails
	END 
	ELSE 
	BEGIN 
		 IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) <>
		     (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM ZnodeOmsSavedCartLineItem WHERE ParentOmsSavedCartLineItemId IS nULL and OmsSavedCartLineItemId in (select OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails)  )
		 BEGIN 
		   
			   DELETE FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
			   SELECT OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			   AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
			   OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			   AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		 
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) <>
		     (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM ZnodeOmsSavedCartLineItem WHERE ParentOmsSavedCartLineItemId IS nULL and OmsSavedCartLineItemId in (select OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails)  )
		 BEGIN 
		   
			   DELETE n FROM #OldBundleSavecartLineitemDetails n WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
			   OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
		
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		        AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldBundleSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
		       AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		 BEGIN 
		     DELETE FROM #OldBundleSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		 END 
		END 

	IF EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails )
	BEGIN 
		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU not having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*
			FROM @SaveCartLineItemType a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on ( a.BundleProductIds = b.SKU or a.SKU = b.sku)
			WHERE isnull(cast(a.PersonalisedAttribute AS varchar(max)),'') = ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId
			FROM #OldBundleSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
		)
		DELETE a FROM #OldBundleSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*, 
				a.PersonalizeCode
				,a.PersonalizeValue
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on ( a.BundleProductIds = b.SKU )
			WHERE isnull(a.PersonalizeValue,'') <> ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId, b.PersonalizeCode, b.PersonalizeValue
			FROM #OldBundleSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
			WHERE NOT EXISTS(SELECT * FROM cte c WHERE b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and b.PersonalizeCode = c.PersonalizeCode 
								and b.PersonalizeValue = c.PersonalizeValue )
		)
		DELETE a FROM #OldBundleSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)


		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,b.ParentOmsSavedCartLineItemId , a.BundleProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on a.BundleProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM #OldBundleSavecartLineitemDetails b1 
		WHERE NOT EXISTS(SELECT * FROM cte c WHERE (b1.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or b1.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId))
		AND EXISTS(SELECT * FROM cte)

		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.BundleProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on a.BundleProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE c1
		FROM cte a1		  
		INNER JOIN #OldBundleSavecartLineitemDetails b1 on a1.SKU = b1.SKU
		INNER JOIN #OldBundleSavecartLineitemDetails c1 on (b1.ParentOmsSavedCartLineItemId = c1.OmsSavedCartLineItemId OR b1.OmsSavedCartLineItemId = c1.OmsSavedCartLineItemId)
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c WHERE a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and a1.PersonalizeValue = c.PersonalizeValue)

		--Updating the cart if old and new cart data matches	
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5,
		a.ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldBundleSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewBundleSavecartLineitemDetails ty ON (ty.SKU = b.SKU)
		WHERE a.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon

		 UPDATE a
		 SET a.Quantity = a.Quantity+s.AddOnQuantity,
		 a.ModifiedDate = @GetDate
		 FROM ZnodeOmsSavedCartLineItem a
		 INNER JOIN #OldBundleSavecartLineitemDetails b ON (a.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		 INNER JOIN @SaveCartLineItemType S on a.OmsSavedCartId = s.OmsSavedCartId and a.SKU = s.AddOnValueIds
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon

		 --UPDATE Ab SET ab.Quantity = a.Quantity   
   --      FROM ZnodeOmsSavedCartLineItem a  
   --      INNER JOIN ZnodeOmsSavedCartLineItem ab ON (ab.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)  
   --      INNER JOIN @SaveCartLineItemType b ON (a.OmsSavedCartId = b.OmsSavedCartId  )   
		 --WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle  

		 UPDATE Ab 
		 SET Ab.Quantity = Ab.Quantity+ty.Quantity,
		 Ab.Custom1 = ty.Custom1,
		 Ab.Custom2 = ty.Custom2,
		 Ab.Custom3 = ty.Custom3,
		 Ab.Custom4 = ty.Custom4,
		 Ab.Custom5 = ty.Custom5,
		 ab.ModifiedDate = @GetDate  
         FROM ZnodeOmsSavedCartLineItem a  
         INNER JOIN ZnodeOmsSavedCartLineItem ab ON (ab.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)  
         INNER JOIN @SaveCartLineItemType b ON (a.OmsSavedCartId = b.OmsSavedCartId  ) 
		 INNER JOIN #NewBundleSavecartLineitemDetails ty ON (ty.SKU = b.SKU)  
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle  
		 AND EXISTS(SELECT * FROM #OldBundleSavecartLineitemDetails ov WHERE a.OmsSavedCartLineItemId = ov.OmsSavedCartLineItemId)  

	END 
	--Inserting the new save cart data if old and new cart data not match
	ELSE 
	BEGIN 
			
		UPDATE #NewBundleSavecartLineitemDetails
		SET ParentSKU = (SELECT TOP 1 SKU FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID IS NULL )
		WHERE OrderLineItemRelationshipTypeID  = @OrderLineItemRelationshipTypeIdAddon 
		AND EXISTS (SELECT TOP 1 1 FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle) 
		
		--Getting the new save cart data and generating row no. for new save cart insert
		SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU  
		 INTO #InsertNewBundleSavecartLineitem   
		 FROM  #NewBundleSavecartLineitemDetails  
		 GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU   
		 ORDER BY RowId, Id   
   
		--Removing the line item having Quantity <=0 
		DELETE FROM #InsertNewBundleSavecartLineitem WHERE Quantity <=0  

		;WITH Add_Dup AS
		(
			SELECT  Min(NewRowId)NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID 
			FROM  #InsertNewBundleSavecartLineitem
			GROUP BY SKU ,ParentSKU  ,OrderLineItemRelationshipTypeID
			HAVING OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon	
		)
		DELETE FROM #InsertNewBundleSavecartLineitem
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM Add_Dup WHERE Add_Dup.NewRowId = #InsertNewBundleSavecartLineitem.NewRowId)
		AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		--Updating the rowid INTo new save cart line item AS new line item is merged INTo existing save cart item
		 ;WITH VTTY AS   
		(  
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
			   FROM #InsertNewBundleSavecartLineitem m  
			INNER JOIN  #InsertNewBundleSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU   
			WHERE m.OrderLineItemRelationshipTypeID IN ( @OrderLineItemRelationshipTypeIdAddon , @OrderLineItemRelationshipTypeIdBundle)   
		)   
		UPDATE m1   
		SET m1.RowId = TYU.RowId  
		FROM #InsertNewBundleSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  
      
		--Deleting the new save cart line item if cart line item is merged
		;WITH VTRET AS   
		(  
			SELECT RowId,id,Min(NewRowId)NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID   
			FROM #InsertNewBundleSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU  ,OrderLineItemRelationshipTypeID  
			Having  SKU = ParentSKU  AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		)   
		DELETE FROM #InsertNewBundleSavecartLineitem WHERE NewRowId  IN (SELECT NewRowId FROM VTRET)   
     
	   --Inserting the new cart line item if not merged in existing save cart line item
       INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description)  
       OUTPUT INSERTED.OmsSavedCartLineItemId  INTO @OmsInsertedData 
	   SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description   
       FROM  #InsertNewBundleSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU 
		INTO #Cte_newData 
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
		AND a.ParentOmsSavedCartLineItemId IS nULL  
		AND  EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) 
  
		--------------------------------------------------------------------------------------------------------

		SELECT  MIN(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU  
		INTO #ParentOmsSavedCartId
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #ParentOmsSavedCartId  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon   
		AND  EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) 
		AND  a.sequence in (SELECT  MIN(ab.sequence) FROM ZnodeOmsSavedCartLineItem ab WHERE a.OmsSavedCartId = ab.OmsSavedCartId and 
		 a.SKU = ab.sku and ab.OrderLineItemRelationshipTypeId is not null  ) 

		-----------------------------------------------------------------------------------------------------

		SELECT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(Order BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #NewBuldleProduct
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( CASE WHEN EXISTS (SELECT TOP 1 1 FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle) THEN 0 ELSE 1 END = b.id OR b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c on b.sku = c.sku and b.OmsSavedCartId=c.OmsSavedCartId and b.Id = 1
		WHERE ( CASE WHEN EXISTS (SELECT TOP 1 1 FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle) THEN 0 ELSE 1 END = ISNULL(a.ParentOmsSavedCartLineItemId,0) OR ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  AND c.ParentOmsSavedCartLineItemId IS NULL

	   ;WITH table_update AS 
	   (
		 SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId  ) RowIdNo
		 FROM ZnodeOmsSavedCartLineItem a
		 WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		 AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
		 AND a.ParentOmsSavedCartLineItemId IS NULL  
		 AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewBundleSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
		 AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
	   )
		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewBuldleProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId) 
			FROM #NewBuldleProduct  r  
			WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )    IS NOT NULL 
	 
  
		;WITH Cte_Th AS   
		(             
			  SELECT RowId    
			 FROM #InsertNewBundleSavecartLineitem a   
			 GROUP BY RowId   
			 HAVING COUNT(NewRowId) <= 1   
		)   
		UPDATE a SET a.Quantity =  NULL,
			a.ModifiedDate = @GetDate   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		 AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE Ab SET ab.Quantity = a.Quantity,
			ab.ModifiedDate = @GetDate   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN ZnodeOmsSavedCartLineItem ab ON (ab.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)  
		INNER JOIN @SaveCartLineItemType b ON (a.OmsSavedCartId = b.OmsSavedCartId  )   
		WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle  

		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewBundleSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		AND OrderLineItemRelationshipTypeId IS NOT NULL     
       
	   ;WITH Cte_UpdateSequence AS   
		 (  
		   SELECT OmsSavedCartLineItemId ,Row_Number()Over(Order By OmsSavedCartLineItemId) RowId , Sequence   
		   FROM ZnodeOmsSavedCartLineItem   
		   WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewBundleSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		 )   
		UPDATE Cte_UpdateSequence  
		SET  Sequence = RowId  
			
		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN ZnodeOmsSavedCartLineItem b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS not nULL
		and b.OmsSavedCartLineItemId = (select min(OmsSavedCartLineItemId) FROM @OmsInsertedData d WHERE b.OmsSavedCartLineItemId = d.OmsSavedCartLineItemId)
	 
		DELETE FROM ZnodeOmsPersonalizeCartItem	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
			
		----Inserting saved cart item personalise value FROM given line item
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
			   ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			   WHEN NOT MATCHED THEN 
				INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
				VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
  
		
		END 
END TRY
BEGIN CATCH 
  SELECT ERROR_MESSAGE()
END CATCH 
END

GO

Update ZnodeActionMenu set MenuId = (select TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'General' and ControllerName = 'MyReports') 
where ActionId = (select top 1 ActionId from ZnodeActions where ControllerName='MyReports'and ActionName='List')

GO

UPDATE ZnodeApplicationSetting
SET Setting = '<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>PimDownloadableProductKeyId</name>      <headertext>Checkbox</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>ID</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>SKU</name>      <headertext>SKU</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>ProductId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>ProductId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Code</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>DownloadableProductKey</name>      <headertext>Product Key</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>150</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>ProductId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>ProductId</checkboxparamfield>      <iscontrol>y</iscontrol>      <controltype>Text</controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>DownloadableProductURL</name>      <headertext>Download URL</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>150</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>ProductId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>ProductId</checkboxparamfield>      <iscontrol>y</iscontrol>      <controltype>Text</controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>IsUsed</name>      <headertext>Is Used</headertext>      <width>40</width>      <datatype>Boolean</datatype>      <columntype>Boolean</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>LocaleId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>z-isused</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>Delete</format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>productId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>Id</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Delete</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/inventory/DeleteDownloadableProductKeys</manageactionurl>      <manageparamfield>PimDownloadableProductKeyId</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
where ItemName='ZnodePimDownloadableProductKeyForInventory'

GO

update ZnodeGlobalAttribute
set AttributeTypeId = (select top 1  AttributeTypeId from ZnodeAttributeType where AttributeTypeName = 'Text Area')
where AttributeCode = 'ContentSecurityPolicy'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetOmsSavedCartLineItemCount')
	DROP PROC Znode_GetOmsSavedCartLineItemCount

GO

CREATE PROCEDURE [dbo].[Znode_GetOmsSavedCartLineItemCount]
( 
	@OmsCookieMappingId INT ,
	@UserId INT NULL ,
	@PortalId INT NULL
)
AS 
   /*  
    Summary : This procedure is used to get the count of OmsSavedCartLineItem	 	 
Unit Testing:

    EXEC [Znode_GetOmsSavedCartLineItemCount] @OmsCookieMappingId=83503
	Create Index IX_ZnodeOmsCookieMapping_UserId_PortalId on ZnodeOmsCookieMapping(UserId,PortalId)
       
*/
BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
		Declare @QuantityOfOthersType Numeric(28,6) ,@QuantityOfBundles Numeric(28,6) ,@OmsSavedCartId int,
				@AddonRelationshipType int , @BundleRelationshipType int 


	    IF @OmsCookieMappingId = 0
		BEGIN
				IF isnull(@UserId,0) = 0
				BEGIN
					Select CAST(@QuantityOfOthersType AS varchar(10))
					Return
				End
			   Select TOP 1 @OmsCookieMappingId =   OmsCookieMappingId from ZnodeOmsCookieMapping WITH (NOLOCK) WHERE UserId = @UserId and PortalId = @PortalId 
		END

		IF Object_id('tempdb..#BundlesProductsQuantity') <>0 
		DROP TABLE #BundlesProductsQuantity

		IF Object_id('tempdb..#ZnodeOmsSavedCartLineItem') <>0 
		DROP TABLE #ZnodeOmsSavedCartLineItem


		Select @OmsSavedCartId = OmsSavedCartId from ZnodeOmsSavedCart  WITH (NOLOCK) WHERE OmsCookieMappingId =@OmsCookieMappingId
		Select @AddonRelationshipType = OrderLineItemRelationshipTypeId	 From ZnodeOmsOrderLineItemRelationshipType WITH (NOLOCK) Where Name = 'AddOns'
		Select @BundleRelationshipType = OrderLineItemRelationshipTypeId From ZnodeOmsOrderLineItemRelationshipType WITH (NOLOCK) Where Name = 'Bundles'
		Select Quantity, OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OrderLineItemRelationshipTypeId into #ZnodeOmsSavedCartLineItem
		from ZnodeOmsSavedCartLineItem  WITH (NOLOCK) where  OmsSavedCartId = @OmsSavedCartId  

		--Read quantity of all others type of products except Bundle type
		SELECT @QuantityOfOthersType  = Sum(ISNULL(Quantity,0)) FROM #ZnodeOmsSavedCartLineItem oscl WITH (NOLOCK)
        WHERE (ParentOmsSavedCartLineItemId IS NOT NULL AND OrderLineItemRelationshipTypeId not in  (@AddonRelationshipType ,@BundleRelationshipType) 
		AND OrderLineItemRelationshipTypeId IS NOT NUll)  

		--Read quantity of Bundle type from their parent Quantity only
		Select Distinct ParentOmsSavedCartLineItemId into #BundlesProductsQuantity FROM #ZnodeOmsSavedCartLineItem oscl WITH (NOLOCK) 
		where OrderLineItemRelationshipTypeId = @BundleRelationshipType
		If Exists (Select TOP 1 1 #BundlesProductsQuantity )
			SELECT @QuantityOfBundles = Sum(ISNULL(Quantity,0))   FROM #ZnodeOmsSavedCartLineItem oscl WITH (NOLOCK)
			Where Exists ( Select  TOP 1 1 From #BundlesProductsQuantity BPQ Where BPQ.ParentOmsSavedCartLineItemId = oscl.OmsSavedCartLineItemId ) 
			And (ParentOmsSavedCartLineItemId IS NULL AND OrderLineItemRelationshipTypeId IS NUll)  
		
		SET @QuantityOfOthersType = Isnull(@QuantityOfOthersType,0) + Isnull(@QuantityOfBundles,0)

		Select CAST(@QuantityOfOthersType AS varchar(15))

    END TRY
	BEGIN CATCH
		DECLARE @Status BIT ;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetOmsSavedCartLineItemCount '+ISNULL(CAST(@OmsCookieMappingId AS VARCHAR(50)),'''');
              			 
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_GetOmsSavedCartLineItemCount',
		@ErrorInProcedure = 'Znode_GetOmsSavedCartLineItemCount',
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
END CATCH;
END

GO

Update ZnodeApplicationSetting
Set Setting ='<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>AccountId</name>      <headertext>Checkbox</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>AccountId</name>      <headertext>Account ID</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>Name</name>      <headertext>Account Name</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>y</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>accountnamecolumn</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>ParentAccountName</name>      <headertext>Parent Account Name</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>PortalId</name>      <headertext>Portal ID</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>y</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>portalId</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
where ItemName ='ZnodeUserAccountList'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateQuoteLineItem')
	DROP PROC Znode_InsertUpdateQuoteLineItem

GO



CREATE PROCEDURE [dbo].[Znode_InsertUpdateQuoteLineItem]
(   
	@OmsQuoteId      INT ,
    @UserId          INT = 0,
	@OmsSavedCartId  INT = 0,
    @Status          BIT OUT ,
	@SKUPriceForQuote [dbo].[SKUPriceForQuote] ReadOnly
)
AS 
   /* 
    Summary: This Procedure is used to save and edit the quote line item      
    Unit Testing   
    Exec Znode_InsertUpdateQuoteLineItem 1071,1527,0
   
	*/
     BEGIN
         BEGIN TRAN A;
         BEGIN TRY
             SET NOCOUNT ON;
			 DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
			 DECLARE  @OmsQuoteLineItemId INT;
			 DECLARE @TempOmsQuoteLineItem TABLE (OmsQuoteLineItemId INT , OmsSavedCartLineItemId INT , ParentOmsSavedCartLineItemId INT  )
			 DECLARE @OrderLineItemRelationshipTypeIdBundle INT = (SELECT TOP 1 OrderLineItemRelationshipTypeId FROM ZnodeOmsOrderLineItemRelationshipType WHERE Name = 'Bundles')

			CREATE TABLE #ZnodeOmsSavedCartLineItem
			(OmsSavedCartLineItemId	int,
			ParentOmsSavedCartLineItemId	int,
			OmsSavedCartId	int,
			SKU	nvarchar(200),
			Quantity	numeric(28,	13) ,
			OrderLineItemRelationshipTypeId	int,
			CustomText	nvarchar(MAX),
			CartAddOnDetails	nvarchar(MAX),
			Sequence	int,
			CreatedBy	int,
			CreatedDate	datetime,
			ModifiedBy	int,
			ModifiedDate	datetime,
			AutoAddon	nvarchar(MAX),
			OmsOrderId	int,
			Custom1	nvarchar(MAX),
			Custom2	nvarchar(MAX),
			Custom3	nvarchar(MAX),
			Custom4	nvarchar(MAX),
			Custom5	nvarchar(MAX),
			GroupId	nvarchar(MAX),
			ProductName	nvarchar(2000),
			Description	nvarchar(MAX),
			Price numeric(28,6),
			ShippingCost numeric(28,6),
			InitialPrice numeric(28,6),
			InitialShippingCost numeric(28,6),
			IsPriceEdit bit)
			 
			IF (isnull(@OmsSavedCartId,0) <> 0)
			BEGIN
				INSERT INTO #ZnodeOmsSavedCartLineItem(OmsSavedCartLineItemId,ParentOmsSavedCartLineItemId,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId,CustomText,CartAddOnDetails,
				                                       Sequence,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AutoAddon,OmsOrderId,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,Description)
				SELECT a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId,a.OmsSavedCartId,a.SKU,a.Quantity,a.OrderLineItemRelationshipTypeId,a.CustomText,a.CartAddOnDetails,
				       a.Sequence,a.CreatedBy,a.CreatedDate,a.ModifiedBy,a.ModifiedDate,a.AutoAddon,a.OmsOrderId,a.Custom1,a.Custom2,a.Custom3,a.Custom4,a.Custom5,a.GroupId,a.ProductName,a.Description 				
				FROM ZnodeOmsSavedCartLineItem  a 
				WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeOmsQuoteLineItem ty WHERE ty.OmsQuoteId = @OmsQuoteId) and a.OmsSavedCartId=@OmsSavedCartId
				
			END
			ELSE
			BEGIN
				INSERT INTO #ZnodeOmsSavedCartLineItem(OmsSavedCartLineItemId,ParentOmsSavedCartLineItemId,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId,CustomText,CartAddOnDetails,
				                                       Sequence,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AutoAddon,OmsOrderId,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,Description)
				SELECT a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId,a.OmsSavedCartId,a.SKU,a.Quantity,a.OrderLineItemRelationshipTypeId,a.CustomText,a.CartAddOnDetails,
				       a.Sequence,a.CreatedBy,a.CreatedDate,a.ModifiedBy,a.ModifiedDate,a.AutoAddon,a.OmsOrderId,a.Custom1,a.Custom2,a.Custom3,a.Custom4,a.Custom5,a.GroupId,a.ProductName,a.Description 
				FROM ZnodeOmsSavedCartLineItem  a 
				INNER JOIN ZnodeOmsSavedCart b ON (b.OmsSavedCartId = a.OmsSavedCartId)
				INNER JOIN ZnodeOmsCookieMapping c ON (c.OmsCookieMappingId = b.OmsCookieMappingId)
				WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeOmsQuoteLineItem ty WHERE ty.OmsQuoteId = @OmsQuoteId) 
				AND c.UserId = @UserId
			END

			UPDATE ZOSLI set ZOSLI.Price = SPQ.Price, ZOSLI.ShippingCost = SPQ.ShippingCost, ZOSLI.InitialPrice = SPQ.InitialPrice,
			ZOSLI.InitialShippingCost = SPQ.InitialShippingCost, ZOSLI.IsPriceEdit = SPQ.IsPriceEdit
			FROM #ZnodeOmsSavedCartLineItem ZOSLI
			INNER JOIN @SKUPriceForQuote SPQ ON ZOSLI.OmsSavedCartLineItemId = SPQ.OmsSavedCartLineItemId

			--To update price and ShippingCost for child entries of bundle product
			UPDATE ZOSLI set ZOSLI.Price = SPQ.Price, ZOSLI.ShippingCost = SPQ.ShippingCost, ZOSLI.InitialPrice = SPQ.InitialPrice,
			ZOSLI.InitialShippingCost = SPQ.InitialShippingCost, ZOSLI.IsPriceEdit= SPQ.IsPriceEdit
			FROM #ZnodeOmsSavedCartLineItem ZOSLI
			INNER JOIN @SKUPriceForQuote SPQ ON ZOSLI.ParentOmsSavedCartLineItemId = SPQ.OmsSavedCartLineItemId
			WHERE ZOSLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle


			IF OBJECT_ID('Tempdb..#desupdate1') IS NOT NULL  
			DROP TABLE Tempdb..#desupdate1 
			select ZnodeProductId,des into #desupdate1 from (
									   SELECT  ZnodeProductId, CONCAT('QTY: ',cast(cast(AssociatedProductBundleQuantity as int) as varchar(5)),'| ',sku,' - ', productname, char(10) ) des  FROM ZnodePublishBundleProductEntity  ZPBPE1
											inner join ZnodePublishProductDetail ZPP  on  ZPBPE1.AssociatedZnodeProductId = ZPP.PublishProductId
											)asd group by ZnodeProductId, des


			IF OBJECT_ID('Tempdb..#desupdate') IS NOT NULL  
			DROP TABLE Tempdb..#desupdate 

			select ZPBPE.des, asd.* into #desupdate from (
				select VLMP.PimProductId PPI , ZOSCL.* from #ZnodeOmsSavedCartLineItem ZOSCL 
							inner join [dbo].[View_LoadManageProduct] VLMP on VLMP.AttributeCode ='SKU' and VLMP.AttributeValue= ZOSCL.sku
							inner join (select * from ZnodepimAttributevalue where PimAttributeId = 10 and  PimAttributeValueId in (
											select PimAttributeValueId from ZnodePimProductAttributeDefaultValue where PimAttributeDefaultValueId in (
											select PimAttributeDefaultValueId from ZnodePimAttributeDefaultValue where AttributeDefaultValueCode = 'BundleProduct' ))) BP
												on BP.PimProductId =  VLMP.PimProductId ) asd
						cross apply
						 (
						SELECT   *
						FROM    (SELECT ZnodeProductId, '<p><span style="font-family: Arial, Helvetica, sans-serif; font-size: 10px;">' +
							(SELECT  des +' </br> '  
											FROM #desupdate1 AS p 
											WHERE p.ZnodeProductId = a.ZnodeProductId
											FOR XML PATH(''))
							
						+ '</span></p>' AS des
									FROM #desupdate1 a
									GROUP BY ZnodeProductId)  ZPBPE1
						inner join ZnodePublishProduct ZPP on  ZPBPE1.ZnodeProductId = ZPP.PublishProductId

						WHERE   Zpp.PimProductId = asd.PPI
      
						) 
				   ZPBPE

			UPDATE ZOSLI set ZOSLI.Description = SPQ.des
			FROM #ZnodeOmsSavedCartLineItem ZOSLI
			INNER JOIN #desupdate SPQ ON ZOSLI.OmsSavedCartLineItemId = SPQ.OmsSavedCartLineItemId or ZOSLI.ParentOmsSavedCartLineItemId = SPQ.OmsSavedCartLineItemId


			
			MERGE INTO ZnodeOmsQuoteLineItem TARGET 
			USING #ZnodeOmsSavedCartLineItem  SOURCE 
			ON (1=0 )
			WHEN NOT MATCHED THEN 
			INSERT   (ParentOmsQuoteLineItemId,OmsQuoteId,SKU,Quantity,OrderLineItemRelationshipTypeId
						,CustomText,CartAddOnDetails,Sequence,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,GroupId,ProductName,Description, Price, ShippingCost,
						InitialPrice, InitialShippingCost, IsPriceEdit)
			 
			VALUES ( NULL,@OmsQuoteId,SOURCE.SKU,SOURCE.Quantity,SOURCE.OrderLineItemRelationshipTypeId
						,SOURCE.CustomText,SOURCE.CartAddOnDetails,SOURCE.Sequence,SOURCE.CreatedBy,SOURCE.CreatedDate,SOURCE.ModifiedBy,SOURCE.ModifiedDate,SOURCE.GroupId,SOURCE.ProductName,SOURCE.Description, SOURCE.Price, SOURCE.ShippingCost,
						SOURCE.InitialPrice, SOURCE.InitialShippingCost, SOURCE.IsPriceEdit ) 
			
			OUTPUT Inserted.OmsQuoteLineItemId , SOURCE.OmsSavedCartLineItemId,Source.ParentOmsSavedCartLineItemId  INTO @TempOmsQuoteLineItem ;


			UPDATE a
			SET a.ParentOmsQuoteLineItemId =( SELECT TOP 1 b1.OmsQuoteLineItemId FROM  @TempOmsQuoteLineItem b1 WHERE b.ParentOmsSavedCartLineItemId  = b1.OmsSavedCartLineItemId)  
			FROM ZnodeOmsQuoteLineItem  a 
			INNER JOIN @TempOmsQuoteLineItem b ON (b.OmsQuoteLineItemId = a.OmsQuoteLineItemId)
			WHERE b.ParentOmsSavedCartLineItemId IS NOT NULL 



			INSERT INTO ZnodeOmsQuotePersonalizeItem (OmsQuoteLineItemId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
														,DesignId,ThumbnailURL)
			SELECT b.OmsQuoteLineItemId,PersonalizeCode,PersonalizeValue,a.CreatedBy,a.CreatedDate,a.ModifiedBy,a.ModifiedDate
														,DesignId,ThumbnailURL
			FROM ZnodeOmsPersonalizeCartItem a  
			INNER JOIN @TempOmsQuoteLineItem b ON (b.OmsSavedCartLineItemId =  a.OmsSavedCartLineItemId )         


             SET @Status = 1;
             COMMIT TRAN A;
         END TRY
         BEGIN CATCH
        
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertUpdateQuoteLineItem @CartLineItemXML = '+CAST('' AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
			 ROLLBACK TRAN A;
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_InsertUpdateQuoteLineItem',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS (SELECT * 
  FROM sys.foreign_keys 
   WHERE object_id = OBJECT_ID(N'FK_ZnodeERPTaskScheduler_ZnodeERPTaskSchedulerSetting')
   AND parent_object_id = OBJECT_ID(N'dbo.ZnodeERPTaskScheduler')
)
BEGIN
	ALTER TABLE [dbo].[ZnodeERPTaskScheduler] DROP CONSTRAINT [FK_ZnodeERPTaskScheduler_ZnodeERPTaskSchedulerSetting]
END

GO

IF EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'TaskSchedulerSettingId'
AND Object_ID = Object_ID(N'dbo.ZnodeERPTaskScheduler'))
BEGIN
	ALTER TABLE dbo.ZnodeERPTaskScheduler DROP COLUMN TaskSchedulerSettingId;
END

GO

IF EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'RepeatTaskEvery'
AND Object_ID = Object_ID(N'dbo.ZnodeERPTaskScheduler'))
BEGIN
	ALTER TABLE dbo.ZnodeERPTaskScheduler DROP COLUMN RepeatTaskEvery;
END

GO

IF EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'RepeatTaskForDuration'
AND Object_ID = Object_ID(N'dbo.ZnodeERPTaskScheduler'))
BEGIN
	ALTER TABLE dbo.ZnodeERPTaskScheduler DROP COLUMN RepeatTaskForDuration;
END

GO

IF EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'ExpireDate'
AND Object_ID = Object_ID(N'dbo.ZnodeERPTaskScheduler'))
BEGIN
	ALTER TABLE dbo.ZnodeERPTaskScheduler DROP COLUMN [ExpireDate];
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'CronExpression'
AND Object_ID = Object_ID(N'dbo.ZnodeERPTaskScheduler'))
BEGIN
	ALTER TABLE dbo.ZnodeERPTaskScheduler ADD CronExpression  VARCHAR (100) NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'HangfireJobId'
AND Object_ID = Object_ID(N'dbo.ZnodeERPTaskScheduler'))
BEGIN
	ALTER TABLE dbo.ZnodeERPTaskScheduler ADD HangfireJobId  VARCHAR (100) NULL;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeleteERPConfigurator')
	DROP PROC Znode_DeleteERPConfigurator

GO

CREATE PROCEDURE [dbo].[Znode_DeleteERPConfigurator]
( @ERPConfiguratorId VARCHAR(2000),
  @Status            BIT OUT)
AS
   /* 
     Summary : Remove ERP Scheduler and Configurator details  
			   Here complete delete the ERP Scheduler and Configurator and their references without any check  
			   If passed @ERPConfiguratorId are matched with deleted count then data set return true other wise false 
			   dbo.Split function use to make comma seperated data in table rows 
			   1 ZnodeERPConfigurator
			   2 ZnodeERPTaskScheduler
     Unit Testing 
	 begin tran
     DEclare @Status bit = 1
     EXEC Znode_DeleteERPConfigurator  29 ,@Status =@Status OUT 
	 rollback tran
     SELECT @Status 
    
	*/
     BEGIN
         BEGIN TRAN DeleteERPConfigurator;
         BEGIN TRY
             SET NOCOUNT ON;
			  -- table hold the ERPConfigurator Id 
             DECLARE @TBL_DeletdERPConfiguratorId TABLE(ERPConfiguratorId INT);
			 
             INSERT INTO @TBL_DeletdERPConfiguratorId
			        -- dbo.Split function use to make comma separeted data in table rows
                    SELECT Item FROM dbo.split(@ERPConfiguratorId, ',') AS a;
             
             DELETE FROM ZnodeERPConfigurator
             WHERE EXISTS
             (
                 SELECT TOP 1 1
                 FROM @TBL_DeletdERPConfiguratorId AS TBDEC
                 WHERE TBDEC.ERPConfiguratorId = ZnodeERPConfigurator.ERPConfiguratorId
             );
             
             IF (SELECT COUNT(1) FROM @TBL_DeletdERPConfiguratorId) =
             (SELECT COUNT(1) FROM dbo.split(@ERPConfiguratorId, ',') AS SP) -- if both count are equal then data set return true other wise return false
                 BEGIN
                     SELECT 1 AS ID, CAST(1 AS BIT) AS [Status];
                     SET @Status = 1;
                 END;
             ELSE
                 BEGIN
                     SELECT 0 AS ID, CAST(0 AS BIT) AS [Status];
                     SET @Status = 0;
                 END;
             COMMIT TRAN DeleteERPConfigurator;
         END TRY
         BEGIN CATCH
             DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeleteERPConfigurator @ERPConfiguratorId = '+@ERPConfiguratorId+',@Status='+CAST(@Status AS VARCHAR(50));
             SELECT 0 AS ID,
                    CAST(0 AS BIT) AS [Status];
             SET @Status = 0;
             ROLLBACK TRAN DeleteERPConfigurator;
             EXEC Znode_InsertProcedureErrorLog
                  @ProcedureName = 'Znode_DeleteERPConfigurator',
                  @ErrorInProcedure = @Error_procedure,
                  @ErrorMessage = @ErrorMessage,
                  @ErrorLine = @ErrorLine,
                  @ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeleteERPTaskScheduler')
	DROP PROC Znode_DeleteERPTaskScheduler

GO

CREATE PROCEDURE [dbo].[Znode_DeleteERPTaskScheduler]
( @ERPTaskSchedulerId VARCHAR(500),
  @Status             BIT OUT)
AS 
   /* 
    Summary:Remove enrty from ERP Scheduler details with setting     
    Unit Testing 
	begin tran  
    DECLARE	@return_value int,
    @Status bit
    EXEC	@return_value = [dbo].[Znode_DeleteERPTaskScheduler]
	rollback tran
    @ERPTaskSchedulerId = N'10',
    @Status = @Status OUTPUT
    SELECT	@Status as N'@Status'
    SELECT	'Return Value' = @return_value
     
	*/
     BEGIN
         BEGIN TRY
             SET NOCOUNT ON;
             BEGIN TRAN A;
             DECLARE @DeletdERPTaskSchedulerId TABLE(ERPTaskSchedulerId INT);
             DECLARE @DeleteERPTaskSchedulerSetting TABLE(TaskSchedulerSettingId INT);
             INSERT INTO @DeletdERPTaskSchedulerId
                    SELECT Item
                    FROM dbo.split(@ERPTaskSchedulerId, ',') AS a;
             
             DELETE FROM ZnodeERPTaskScheduler
             WHERE EXISTS
             (
                 SELECT TOP 1 1
                 FROM @DeletdERPTaskSchedulerId AS a
                 WHERE a.ERPTaskSchedulerId = ZnodeERPTaskScheduler.ERPTaskSchedulerId
             );
             
             IF
             (
                 SELECT COUNT(1)
                 FROM @DeletdERPTaskSchedulerId
             ) =
             (
                 SELECT COUNT(1)
                 FROM dbo.split(@ERPTaskSchedulerId, ',') AS a
             )
                 BEGIN
                     SELECT 1 AS ID,
                            CAST(1 AS BIT) AS Status;
                 END;
             ELSE
                 BEGIN
                     SELECT 0 AS ID,
                            CAST(0 AS BIT) AS Status;
                 END;
             SET @Status = CAST(1 AS BIT);
             COMMIT TRAN A;
         END TRY
         BEGIN CATCH
             
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeleteERPTaskScheduler @ERPTaskSchedulerId = '+@ERPTaskSchedulerId+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		     ROLLBACK TRAN A;
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_DeleteERPTaskScheduler',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetERPTaskSchedulerDetail')
	DROP PROC Znode_GetERPTaskSchedulerDetail

GO

CREATE PROCEDURE [dbo].[Znode_GetERPTaskSchedulerDetail]
( @ERPTaskSchedulerId INT)
AS
  /*
    
    Summary:  List of erp task scheduler details by ERPTaskSchedulerId    		              
    Unit Testing         	
       EXEC Znode_GetERPTaskSchedulerDetail 1   
   */ 
	 BEGIN
         BEGIN TRY
             SET NOCOUNT ON;
             SELECT ERPTaskSchedulerId, 
					ISNULL(ERPConfiguratorId, 0) ERPConfiguratorId,
					SchedulerName, 
					SchedulerType,
					TouchPointName,
					SchedulerFrequency,
					StartDate,
					ZETS.CreatedBy,
					ZETS.CreatedDate,
					ZETS.ModifiedBy,
					ZETS.ModifiedDate,
					ZETS.IsEnabled,
					SchedulerCallFor,
					CronExpression,
					HangfireJobId
             FROM ZnodeERPTaskScheduler AS ZETS
             WHERE ZETS.ERPTaskSchedulerId = @ERPTaskSchedulerId;
         END TRY
         BEGIN CATCH
               DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetERPTaskSchedulerDetail @ERPTaskSchedulerId = '+CAST(@ERPTaskSchedulerId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		    
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetERPTaskSchedulerDetail',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateERPScheduler')
	DROP PROC Znode_InsertUpdateERPScheduler

GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateERPScheduler]
(   @SchedulerXML XML,
    @UserId       INT,
    @Status       BIT OUT)
AS
   /* 
    Summary: This procedure is used insert and update ERP scheduler data 
    		   Get average rating of products 
    		   Get Price / Inventory / SEO details .
    Unit Testing
	BEGIN TRAN   
     EXEC Znode_InsertUpdateERPScheduler 
	ROLLBACK TRAN

	*/
     BEGIN
         BEGIN TRY
             SET NOCOUNT ON;
             DECLARE @TBL_ERPTaskScheduler TABLE
             (ERPTaskSchedulerId    INT,
              SchedulerName         NVARCHAR(200),
			  SchedulerType			VARCHAR(20),	
              TouchPointName        NVARCHAR(200),
              SchedulerFrequency    NVARCHAR(100),
              StartDate             DATETIME,
              IsEnabled             BIT,
			  SchedulerCallFor      VARCHAR(200),
			  CronExpression		VARCHAR(100),
			  HangfireJobId			VARCHAR(100)
             );
             
			 DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
             DECLARE @ERPConfiguratorId INT=
             (
                 SELECT TOP 1 ERPConfiguratorId
                 FROM ZnodeERPConfigurator
                 WHERE IsActive = 1
             );
             DECLARE @ERPTaskShedulerId INT;
             INSERT INTO @TBL_ERPTaskScheduler
                    SELECT Tbl.Col.value('ERPTaskSchedulerId[1]', 'NVARCHAR(max)') AS ERPTaskSchedulerId,
                           Tbl.Col.value('SchedulerName[1]', 'VARCHAR(max)') AS SchedulerName,
						   Tbl.Col.value('SchedulerType[1]', 'NVARCHAR(max)') AS SchedulerType,
                           Tbl.Col.value('TouchPointName[1]', 'NVARCHAR(max)') AS TouchPointName,
                           Tbl.Col.value('SchedulerFrequency[1]', 'NVARCHAR(max)') AS SchedulerFrequency,
                           Tbl.Col.value('StartDate[1]', 'NVARCHAR(max)') AS StartDate,
                           Tbl.Col.value('IsEnabled[1]', 'NVARCHAR(max)') AS IsEnabled,
						   Tbl.Col.value('SchedulerCallFor[1]', 'NVARCHAR(max)') AS SchedulerCallFor,
						   Tbl.Col.value('CronExpression[1]', 'NVARCHAR(max)') AS CronExpression,
						   Tbl.Col.value('HangfireJobId[1]', 'NVARCHAR(max)') AS HangfireJobId
                    FROM @SchedulerXML.nodes('//ERPTaskSchedulerModel') AS Tbl(Col);

             UPDATE a
               SET
                   SchedulerName = b.SchedulerName,
				   SchedulerType = b.SchedulerType,
                   TouchPointName = b.TouchPointName,
                   SchedulerFrequency = b.SchedulerFrequency,
                   StartDate = b.StartDate,
                   IsEnabled = b.IsEnabled,
                   ModifiedBy = @UserId,
                   ModifiedDate = @GetDate,
				   CronExpression = b.CronExpression,
				   HangfireJobId = b.HangfireJobId
             FROM ZnodeERPTaskScheduler a
                  INNER JOIN @TBL_ERPTaskScheduler b ON(a.ERPTaskSchedulerId = b.ERPTaskSchedulerId);
             
             INSERT INTO ZnodeERPTaskScheduler
             (
              ERPConfiguratorId,
              SchedulerName,
			  SchedulerType,
              TouchPointName,
              SchedulerFrequency,
              StartDate,
              IsEnabled,
			  SchedulerCallFor,
              CreatedBy,
              CreatedDate,
              ModifiedBy,
              ModifiedDate,
			  CronExpression,
			  HangfireJobId
             )
                    SELECT @ERPConfiguratorId,
                           SchedulerName,
						   SchedulerType,
                           TouchPointName,
                           SchedulerFrequency,
                           StartDate,
                           IsEnabled,
						   SchedulerCallFor,
                           @UserId,
                           @GetDate,
                           @UserId,
                           @GetDate,
						   CronExpression,
						   HangfireJobId
                    FROM @TBL_ERPTaskScheduler
                    WHERE ERPTaskSchedulerId = 0;
             
			 SET @ERPTaskShedulerId = SCOPE_IDENTITY();

             SET @Status = CAST(1 AS BIT);
             SELECT
             (
                 SELECT TOP 1 CASE
                                  WHEN ISNULL(ERPTaskSchedulerId, 0) = 0
                                  THEN @ERPTaskShedulerId
                                  ELSE ERPTaskSchedulerId
                              END
                 FROM @TBL_ERPTaskScheduler
             ) AS Id,
             CAST(1 AS BIT) AS Status;
         END TRY
         BEGIN CATCH
            
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertUpdateERPScheduler @SchedulerXML = '+CAST(@SchedulerXML AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  select ERROR_MESSAGE();
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_InsertUpdateERPScheduler',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO
--PostScript Pending add above

IF NOT EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'ImportDuty'
AND Object_ID = Object_ID(N'dbo.ZnodeOmsOrderDetails'))
BEGIN
	ALTER TABLE ZnodeOmsOrderDetails ADD ImportDuty NUMERIC(28,6) NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'ImportDuty'
AND Object_ID = Object_ID(N'dbo.ZnodeOmsQuote'))
BEGIN
	ALTER TABLE ZnodeOmsQuote ADD ImportDuty NUMERIC(28,6) NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'ImportDuty'
AND Object_ID = Object_ID(N'dbo.ZnodeOmsTaxOrderDetails'))
BEGIN
	ALTER TABLE ZnodeOmsTaxOrderDetails ADD ImportDuty NUMERIC(28,6) NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'ImportDuty'
AND Object_ID = Object_ID(N'dbo.ZnodeOmsTaxOrderLineDetails'))
BEGIN
	ALTER TABLE ZnodeOmsTaxOrderLineDetails ADD ImportDuty NUMERIC(28,6) NULL;
END

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodeOmsTaxOrderSummary')
BEGIN
	CREATE TABLE [ZnodeOmsTaxOrderSummary] 
	(
		[OmsTaxOrderSummaryId] INT IDENTITY,
		[OmsOrderDetailsId] INT,
		[Tax] NUMERIC(28,6),
		[Rate] NUMERIC(28,6),
		[TaxName] VARCHAR(600),
		[TaxTypeName] VARCHAR(600),
		CONSTRAINT [PK_ZnodeOmsTaxOrderSummary] PRIMARY KEY CLUSTERED ([OmsTaxOrderSummaryId]) ,
		CONSTRAINT [FK_ZnodeOmsTaxOrderSummary_ZnodeOmsOrderDetails] FOREIGN KEY ([OmsOrderDetailsId]) REFERENCES [dbo].[ZnodeOmsOrderDetails] ([OmsOrderDetailsId])
	)
END

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodeOmsTaxQuoteSummary')
BEGIN
	CREATE TABLE [ZnodeOmsTaxQuoteSummary] 
	(
	[OmsTaxQuoteSummaryId] INT IDENTITY,
	[OmsQuoteId] INT,
	[Tax] NUMERIC(28,6),
	[Rate] NUMERIC(28,6),
	[TaxName] VARCHAR(600),
	[TaxTypeName] VARCHAR(600),
	CONSTRAINT [PK_ZnodeOmsTaxQuoteSummary] PRIMARY KEY CLUSTERED ([OmsTaxQuoteSummaryId]) ,
	CONSTRAINT [FK_ZnodeOmsTaxQuoteSummary_ZnodeOmsQuote] FOREIGN KEY ([OmsQuoteId]) REFERENCES [dbo].[ZnodeOmsQuote] ([OmsQuoteId])
	)
END



GO

IF NOT EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'ImportDuty'
AND Object_ID = Object_ID(N'dbo.ZnodeRmaReturnDetails'))
BEGIN
	ALTER TABLE ZnodeRmaReturnDetails ADD ImportDuty NUMERIC(28,6) NULL;
END



GO

IF NOT EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'AvataxIsTaxIncluded'
AND Object_ID = Object_ID(N'dbo.ZnodeTaxPortal'))
BEGIN
	ALTER TABLE ZnodeTaxPortal ADD AvataxIsTaxIncluded BIT;
END

GO

UPDATE  ZnodeEmailTemplateLocale SET Content = '<!DOCTYPE html><html><body><div>  <div style="font-family: Arial, Helvetica; font-size: 10px; text-align: left; color: #292a2a; border: solid 1px #c3c3c3; margin-top: 10px;">  <div>#StoreLogo# #SiteName#&nbsp;Customer Receipt</div>  <div style="padding: 10px;">  <div style="font-family: Verdana; color: #333333; font-size: 11px;">#ReceiptText#</div>  <table style="font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" border="0" width="100%" cellspacing="3" cellpadding="0">  <tbody>  <tr>  <td colspan="5"><hr /></td>  </tr>  <tr>  <td colspan="2" align="left" nowrap="nowrap" width="25%">  <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Order Information</div>  </td>  <td colspan="2" align="left" nowrap="nowrap">  <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Customer Service</div>  </td>  </tr>  <tr>  <td align="left" nowrap="nowrap" width="10%"><strong>Order Number:</strong></td>  <td align="left" nowrap="nowrap" width="30%">#OrderId#</td>  <td align="left" nowrap="nowrap" width="4%"><strong>E-Mail:</strong></td>  <td align="left" nowrap="nowrap">#CustomerServiceEmail#</td>  </tr>  <tr>  <td align="left" nowrap="nowrap"><strong>Order Date:</strong></td>  <td align="left" nowrap="nowrap">#OrderDate#</td>  <td align="left" nowrap="nowrap"><strong>Phone:</strong></td>  <td align="left" nowrap="nowrap">#CustomerServicePhoneNumber#</td>  </tr>  <tr>  <td style="vertical-align: top;" align="left" nowrap="nowrap"><strong>Promotion Code:</strong></td>  <td align="left" nowrap="nowrap">#PromotionCode#</td>  <td>&nbsp;</td>  <td>&nbsp;</td>  </tr>  <tr>  <td align="left" nowrap="nowrap"><strong>Payment Method:</strong></td>  <td align="left" nowrap="nowrap">#PaymentName#</td>  <td>&nbsp;</td>  <td>&nbsp;</td>  </tr>  <tr>  <td align="left" nowrap="nowrap"><strong>#CardTransactionLabel#</strong></td>  <td align="left" nowrap="nowrap">#CardTransactionID#</td>  <td>&nbsp;</td>  <td>&nbsp;</td>  </tr>  <tr>  <td align="left" nowrap="nowrap"><strong>#PurchaseNumberLabel#</strong></td>  <td align="left" nowrap="nowrap">#PONumber#</td>  <td>&nbsp;</td>  <td>&nbsp;</td>  </tr>  <tr>  <td colspan="4"><hr /></td>  </tr>  <tr>  <td style="font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2" align="left" nowrap="nowrap" width="45%">  <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Billing Address</div>  </td>  <td colspan="2" align="left">  <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Shipping Address</div>  </td>  </tr>  <tr>  <td colspan="2" align="Left" nowrap="nowrap">#BillingAddress#</td>  <td colspan="3" valign="top">#ShippingAddress#</td>  </tr>  <tr>  <td colspan="7">&nbsp;</td>  </tr>  </tbody>  </table>  <div data-info="#AddressItems#">  <table width="100%" cellspacing="0" cellpadding="3">  <tbody>  <tr>  <td style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;" colspan="6">Order Receipt</td>  </tr>  <tr>  <td style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;" colspan="6">#ShipmentNo#</td>  </tr>  <tr>  <td style="color: black; font-size: 10px;" colspan="6">#ShipTo#</td>  </tr>  <tr style="background-color: #eff3fb;">  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>SKU</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Item</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Description</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" align="center"><strong>Qty</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Price</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="2"><strong>Total</strong></td>  </tr>  <tr data-info="#LineItems#OmsOrderShipmentID##">  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="10%">#SKU#&nbsp;</td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#Name#</td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#Description#&nbsp;  <p>#ShortDescription#</p>  #UOMDescription#<br /><br />#Column1#</td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="center" width="5%">#Quantity#</td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="20%">#Price#</td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%" colspan="2">#ExtendedPrice#</td>  </tr>  <tr data-info="#AmountLineItems#OmsOrderShipmentID##">  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="5" align="right"><strong>#Title#</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" colspan="2" align="right" width="20%">#Amount#</td>  </tr>  <tr data-info="#GrandAmountLineItems#">  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="5" align="right"><strong>#Title#</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" colspan="2" width="20%">#Amount#</td>  </tr>  <tr data-info="#TaxSummaryHead#">  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" colspan="5" align="right"><strong>#TaxName#</strong></td>  <td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" align="center" width="8%"><strong>#Rates#</strong></td>  <td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" align="right"><strong>#Amount#</strong></td>  </tr>  <tr data-info="#TaxSummary#">  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" colspan="5" align="right">#TaxName#</td>  <td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" align="center" width="8%">#Rates#</td>  <td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" align="right">#Amount#</td>  </tr>  <tr>  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #292a2a; font-size: 11px; padding: 0 5px 5px 5px;" colspan="5" align="right"><strong>Total</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%" colspan="2"><strong>#TotalCost#</strong></td>  </tr>  </tbody>  </table>  <table id="RturnedItemTable" width="100%" cellspacing="0" cellpadding="3">  <tbody>  <tr>  <td style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;" colspan="6">Returned Item</td>  </tr>  <tr>  <td style="color: black; font-size: 10px;" colspan="6">&nbsp;</td>  </tr>  <tr style="background-color: #eff3fb;">  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>SKU</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Item</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Description</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" align="center"><strong>Qty</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Price</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Total</strong></td>  </tr>  <tr data-info="#ReturnLineItems#">  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="10%">#ReturnedSKU#&nbsp;</td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#ReturnedName#</td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#ReturnedDescription#&nbsp;  <p>#ReturnedShortDescription#</p>  #ReturnedUOMDescription#</td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="center" width="5%">#ReturnedQuantity#</td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="20%">#ReturnedPrice#</td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%">#ReturnedExtendedPrice#</td>  </tr>  <tr data-info="#AmountLineItems#OmsOrderShipmentID##">  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="5" align="right"><strong>#ReturnedTitle#</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%">#ReturnedAmount#</td>  </tr>  <tr data-info="#ReturnedGrandAmountLineItems#">  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="5" align="right"><strong>#ReturnedTitle#</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%">#ReturnedAmount#</td>  </tr>  <tr>  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #292a2a; font-size: 11px; padding: 0 5px 5px 5px;" colspan="5" align="right"><strong>Total</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%"><strong>#ReturnedTotalCost#</strong></td>  </tr>  </tbody>  </table>  </div>  <table style="width: 100%; padding: 10px; display: inline-block;" cellspacing="0" cellpadding="3">  <tbody>  <tr>  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2" align="left" nowrap="nowrap">  <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">#AdditionalInstructLabel#</div>  </td>  </tr>  <tr>  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2">  <div style="width: 675px;" align="justify">#AdditionalInstructions#</div>  </td>  </tr>  <tr>  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2">  <div style="margin-bottom: 5px;">&nbsp;</div>  </td>  </tr>  <tr>  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2" align="left" nowrap="nowrap">#FeedBack#</td>  </tr>  </tbody>  </table>  </div>  </div>  </div></body></html>'
WHERE EmailTemplateId = (SELECT top 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName = 'ResendOrderReceipt')
AND LocaleId = 1

UPDATE  ZnodeEmailTemplateLocale SET Content = '<!DOCTYPE html><html><body><p></p>  <div>  <div style="font-family: Arial, Helvetica; font-size: 10px; text-align: left; color: #292a2a; border: solid 1px #c3c3c3; margin-top: 10px;">  <div style="background-color: #eff3fb; color: #292a2a; font-size: 1.5em; font-weight: bold; padding: .5em; border-bottom: solid 1px #c3c3c3;">#StoreLogo# #SiteName# Customer Receipt</div>  <div style="padding: 10px;">  <div style="font-family: Verdana; color: #333333; font-size: 11px;">#ReceiptText#</div>  <table style="font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" border="0" width="100%" cellspacing="3" cellpadding="0">  <tbody>  <tr>  <td colspan="5"><hr /></td>  </tr>  <tr>  <td colspan="2" align="left" nowrap="nowrap" width="25%">  <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Order Information</div>  </td>  <td colspan="2" align="left" nowrap="nowrap">  <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Customer Service</div>  </td>  </tr>  <tr>  <td align="left" nowrap="nowrap" width="10%"><strong>Order Number:</strong></td>  <td align="left" nowrap="nowrap" width="30%">#OrderId#</td>  <td align="left" nowrap="nowrap" width="4%"><strong>E-Mail:</strong></td>  <td align="left" nowrap="nowrap">#CustomerServiceEmail#</td>  </tr>  <tr>  <td align="left" nowrap="nowrap"><strong>Order Date:</strong></td>  <td align="left" nowrap="nowrap">#OrderDate#</td>  <td align="left" nowrap="nowrap"><strong>Phone:</strong></td>  <td align="left" nowrap="nowrap">#CustomerServicePhoneNumber#</td>  </tr>  <tr>  <td style="vertical-align: top;" align="left" nowrap="nowrap"><strong>Promotion Code:</strong></td>  <td align="left" nowrap="nowrap">#PromotionCode#</td>  <td></td>  <td></td>  </tr>  <tr>  <td align="left" nowrap="nowrap"><strong>Payment Method:</strong></td>  <td align="left" nowrap="nowrap">#PaymentName#</td>  <td></td>  <td></td>  </tr>  <tr>  <td align="left" nowrap="nowrap"><strong>#CardTransactionLabel#</strong></td>  <td align="left" nowrap="nowrap">#CardTransactionID#</td>  <td></td>  <td></td>  </tr>  <tr>  <td align="left" nowrap="nowrap"><strong>#PurchaseNumberLabel#</strong></td>  <td align="left" nowrap="nowrap">#PONumber#</td>  <td></td>  <td></td>  </tr>  <tr>  <td align="left" nowrap="nowrap"><strong>AccountNumber:</strong></td>  <td align="left" nowrap="nowrap">#AccountNumber#</td>  <td></td>  <td></td>  </tr>  <tr>  <td align="left" nowrap="nowrap"><strong>ShippingMethod:</strong></td>  <td align="left" nowrap="nowrap">#ShippingName#</td>  <td></td>  <td></td>  </tr>  <tr>  <td align="left" nowrap="nowrap"><strong>Job / Project Name:</strong></td>  <td align="left" nowrap="nowrap">#JobName#</td>  <td></td>  <td></td>  </tr>  <tr>  <td colspan="4"><hr /></td>  </tr>  <tr>  <td style="font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2" align="left" nowrap="nowrap" width="45%">  <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Billing Address</div>  </td>  <td colspan="2" align="left">  <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Shipping Address</div>  </td>  </tr>  <tr>  <td colspan="2" align="Left" nowrap="nowrap">#BillingAddress#</td>  <td colspan="3" valign="top">#ShippingAddress#</td>  </tr>  <tr>  <td align="Left" nowrap="nowrap" colspan="2">&nbsp;</td>  <td valign="top" colspan="3"><hr /><span style="width: 130px; display: inline-block; font-weight: bold;">#LabelInHandDate#: </span>#InHandDate#<br /><span style="width: 130px; display: inline-block; font-weight: bold;">#LabelShippingConstraintsCode#: </span>#ShippingConstraintCode#<br /><br /></td>  </tr>  <tr>  <td colspan="7"></td>  </tr>  </tbody>  </table>  <div data-info="#AddressItems#">  <table width="100%" cellspacing="0" cellpadding="3">  <tbody>  <tr>  <td style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;" colspan="6">#ShipmentNo#</td>  </tr>  <tr>  <td style="color: black; font-size: 10px;" colspan="6">#ShipTo#</td>  </tr>  <tr style="background-color: #eff3fb;">  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>SKU</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Item</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Description</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" align="center"><strong>Qty</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Price</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="2"><strong>Total</strong></td>  </tr>  <tr data-info="#LineItems#OmsOrderShipmentID##">  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="10%">#SKU#</td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#Name#</td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#Description#  <p>#ShortDescription#</p>  #UOMDescription# <br /><br />#Column1#</td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="center" width="5%">#Quantity#</td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="20%">#Price#</td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%" colspan="2">#ExtendedPrice#</td>  </tr>  <tr data-info="#AmountLineItems#OmsOrderShipmentID##">  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="5" align="right"><strong>#Title#</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%" colspan="2">#Amount#</td>  </tr>  <tr data-info="#GrandAmountLineItems#">  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="5" align="right"><strong>#Title#</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%" colspan="2">#Amount#</td>  </tr>  <tr data-info="#TaxSummaryHead#">  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" colspan="5" align="right"><strong>#TaxName#</strong></td>  <td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" align="center" width="8%"><strong>#Rates#</strong></td>  <td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" align="right"><strong>#Amount#</strong></td>  </tr>  <tr data-info="#TaxSummary#">  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" colspan="5" align="right">#TaxName#</td>  <td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" align="center" width="8%">#Rates#</td>  <td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" align="right">#Amount#</td>  </tr>  <tr>  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #292a2a; font-size: 11px; padding: 0 5px 5px 5px;" colspan="5" align="right"><strong>Total</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%" colspan="2"><strong>#TotalCost#</strong></td>  </tr>  </tbody>  </table>  </div>  <table style="width: 100%; padding: 10px; display: inline-block;" cellspacing="0" cellpadding="3">  <tbody>  <tr>  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2" align="left" nowrap="nowrap">  <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">#AdditionalInstructLabel#</div>  </td>  </tr>  <tr>  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2">  <div style="width: 675px;" align="justify">#AdditionalInstructions#</div>  </td>  </tr>  <tr>  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2">  <div style="margin-bottom: 5px;"></div>  </td>  </tr>  <tr>  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2" align="left" nowrap="nowrap">#FeedBack#</td>  </tr>  </tbody>  </table>  </div>  </div>  </div></body></html>'
WHERE EmailTemplateId = (SELECT top 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName = 'OrderReceipt')
AND LocaleId = 1

UPDATE  ZnodeEmailTemplateLocale SET Content = '<p> </p><p>Customer Receipt -FR</p><div><div style="font-family: Arial, Helvetica; font-size: 10px; text-align: left; color: #292a2a; border: solid 1px #c3c3c3; margin-top: 10px;"><div style="background-color: #eff3fb; color: #292a2a; font-size: 1.5em; font-weight: bold; padding: .5em; border-bottom: solid 1px #c3c3c3;">#SiteName# Customer Receipt - FR</div><div style="padding: 10px;"><div style="font-family: Verdana; color: #333333; font-size: 11px;">#ReceiptText#</div><table style="font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" border="0" width="100%" cellspacing="3" cellpadding="0"><tbody><tr><td colspan="5"><hr /></td></tr><tr><td colspan="2" align="left" nowrap="nowrap" width="25%"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Order Information</div></td><td colspan="2" align="left" nowrap="nowrap"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Customer Service</div></td></tr><tr><td align="left" nowrap="nowrap" width="10%"><strong>Order Number:</strong></td><td align="left" nowrap="nowrap" width="30%">#OrderId#</td><td align="left" nowrap="nowrap" width="4%"><strong>E-Mail:</strong></td><td align="left" nowrap="nowrap">#CustomerServiceEmail#</td></tr><tr><td align="left" nowrap="nowrap"><strong>Order Date:</strong></td><td align="left" nowrap="nowrap">#OrderDate#</td><td align="left" nowrap="nowrap"><strong>Phone:</strong></td><td align="left" nowrap="nowrap">#CustomerServicePhoneNumber#</td></tr><tr><td style="vertical-align: top;" align="left" nowrap="nowrap"><strong>Promotion Code:</strong></td><td align="left" nowrap="nowrap">#PromotionCode#</td><td> </td><td> </td></tr><tr><td align="left" nowrap="nowrap"><strong>Payment Method:</strong></td><td align="left" nowrap="nowrap">#PaymentName#</td><td> </td><td> </td></tr><tr><td align="left" nowrap="nowrap"><strong>#CardTransactionLabel#</strong></td><td align="left" nowrap="nowrap">#CardTransactionID#</td><td> </td><td> </td></tr><tr><td align="left" nowrap="nowrap"><strong>#PurchaseNumberLabel#</strong></td><td align="left" nowrap="nowrap">#PONumber#</td><td> </td><td> </td></tr><tr><td align="left" nowrap="nowrap"><strong>AccountNumber:</strong></td><td align="left" nowrap="nowrap">#AccountNumber#</td><td> </td><td> </td></tr><tr><td align="left" nowrap="nowrap"><strong>ShippingMethod:</strong></td><td align="left" nowrap="nowrap">#ShippingName#</td><td> </td><td> </td></tr><tr><td colspan="4"><hr /></td></tr><tr><td style="font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2" align="left" nowrap="nowrap" width="45%"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Billing Address</div></td><td colspan="2" align="left"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Shipping Address</div></td></tr><tr><td colspan="2" align="Left" nowrap="nowrap">#BillingAddress#</td><td colspan="3" valign="top">#ShippingAddress#</td></tr><tr><td colspan="7"> </td></tr></tbody></table><div data-info="#AddressItems#"><table width="100%" cellspacing="0" cellpadding="3"><tbody><tr><td style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;" colspan="6">#ShipmentNo#</td></tr><tr><td style="color: black; font-size: 10px;" colspan="6">#ShipTo#</td></tr><tr style="background-color: #eff3fb;"><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>SKU</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Item</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Description</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" align="center"><strong>Qty</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Price</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Total</strong></td></tr><tr data-info="#LineItems#OmsOrderShipmentID##"><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="10%">#SKU# </td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#Name#</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#Description#            <p>#ShortDescription#</p>  #UOMDescription#        </td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="center" width="5%">#Quantity#</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="20%">#Price#</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%">#ExtendedPrice#</td></tr><tr data-info="#AmountLineItems#OmsOrderShipmentID##"><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="5" align="right"><strong>#Title#</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%">#Amount#</td></tr><tr data-info="#GrandAmountLineItems#"><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="5" align="right"><strong>#Title#</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%">#Amount#</td></tr><tr><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #292a2a; font-size: 11px; padding: 0 5px 5px 5px;" colspan="5" align="right"><strong>Total</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%"><strong>#TotalCost#</strong></td></tr></tbody></table></div><table style="width: 100%; padding: 10px; display: inline-block;" cellspacing="0" cellpadding="3"><tbody><tr><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2" align="left" nowrap="nowrap"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">#AdditionalInstructLabel#</div></td></tr><tr><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2"><div style="width: 675px;" align="justify">#AdditionalInstructions#</div></td></tr><tr><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2"><div style="margin-bottom: 5px;"> </div></td></tr><tr><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2" align="left" nowrap="nowrap">#FeedBack#</td></tr></tbody></table></div></div></div>'
WHERE EmailTemplateId = (SELECT top 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName = 'OrderReceipt')
AND LocaleId = 2

GO

INSERT INTO ZnodeGlobalAttribute(AttributeTypeId,AttributeCode,IsRequired,IsLocalizable,IsActive,DisplayOrder, HelpDescription,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsSystemDefined,GlobalEntityId)
SELECT (SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName = 'Text'),'BusinessIdentificationNumber',0,1,0,500,
NULL,2,GETDATE(),2,GETDATE(),0,(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Account')
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttribute WHERE  AttributeCode = 'BusinessIdentificationNumber' AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Account'))

INSERT INTO ZnodeGlobalAttributeLocale(LocaleId,GlobalAttributeId,AttributeName,Description,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 1,GlobalAttributeId,'Business Identification Number',NULL,2,GETDATE(),2,GETDATE()
FROM ZnodeGlobalAttribute a
WHERE AttributeCode = 'BusinessIdentificationNumber' AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Account') and
NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeLocale b WHERE a.GlobalAttributeId = b.GlobalAttributeId AND b.LocaleId = 1)

INSERT INTO ZnodeGlobalAttributeGroup(GroupCode, DisplayOrder, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, IsSystemDefined, GlobalEntityId)
SELECT 'BusinessIdentificationNumber', NULL, 2, GETDATE(), 2, GETDATE(), 0, (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Account')
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'BusinessIdentificationNumber' AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Account'))

INSERT INTO ZnodeGlobalAttributeGroupLocale(LocaleId,GlobalAttributeGroupId,AttributeGroupName,Description,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 1,GlobalAttributeGroupId,'Business Details',NULL,2,GETDATE(),2,GETDATE()
FROM ZnodeGlobalAttributeGroup a
WHERE a.GroupCode = 'BusinessIdentificationNumber' AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Account') and
NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeGroupLocale b WHERE a.GlobalAttributeGroupId = b.GlobalAttributeGroupId AND b.LocaleId = 1)

INSERT INTO ZnodeGlobalAttributeGroupMapper(GlobalAttributeGroupId,GlobalAttributeId,AttributeDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'BusinessIdentificationNumber'  AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Account')),
      (SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE  AttributeCode = 'BusinessIdentificationNumber' AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Account')),
	  NULL,	2,	GETDATE(),	2,	GETDATE()
WHERE NOT EXISTS(SELECT * FROM  ZnodeGlobalAttributeGroupMapper WHERE GlobalAttributeGroupId =  (SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'BusinessIdentificationNumber' AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Account'))
      AND  GlobalAttributeId = (SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE  AttributeCode = 'BusinessIdentificationNumber' AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Account')))

INSERT INTO ZnodeGlobalFamilyGroupMapper (GlobalAttributeFamilyId, GlobalAttributeGroupId, AttributeGroupDisplayOrder,CreatedBy, CreatedDate, ModifiedBy, ModifiedDate)
SELECT
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode = 'Account'),
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'BusinessIdentificationNumber' AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Account')), 999,
2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalFamilyGroupMapper where
GlobalAttributeFamilyId = (SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode = 'Account') and
GlobalAttributeGroupId = (SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'BusinessIdentificationNumber' AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Account'))
)


INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'BusinessIdentificationNumber' AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Account')),(SELECT TOP 1 InputValidationId FROM znodeattributeinputvalidation  WHERE Name = 'ValidationRule')
,NULL,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = (SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'BusinessIdentificationNumber' AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Account'))
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM znodeattributeinputvalidation  WHERE Name = 'ValidationRule'))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'BusinessIdentificationNumber' AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Account')),(SELECT TOP 1 InputValidationId FROM znodeattributeinputvalidation  WHERE Name = 'RegularExpression')
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = (SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'BusinessIdentificationNumber' AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Account'))
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM znodeattributeinputvalidation  WHERE Name = 'RegularExpression'))


INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'BusinessIdentificationNumber' AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Account')),(SELECT TOP 1 InputValidationId FROM znodeattributeinputvalidation  WHERE Name = 'MaxCharacters' AND AttributeTypeId = 5)
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = (SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'BusinessIdentificationNumber' AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Account'))
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM znodeattributeinputvalidation  WHERE Name = 'MaxCharacters' AND AttributeTypeId = 5) )


INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'BusinessIdentificationNumber' AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Account')),(SELECT TOP 1 InputValidationId FROM znodeattributeinputvalidation  WHERE Name = 'UniqueValue')
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = (SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'BusinessIdentificationNumber' AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Account'))
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM znodeattributeinputvalidation  WHERE Name = 'UniqueValue'))

DECLARE @AccountGlobalAttributeValue TABLE (AccountId INT,AccountGlobalAttributeValueId  INT)
INSERT INTO ZnodeAccountGlobalAttributeValue(AccountId,GlobalAttributeId,GlobalAttributeDefaultValueId,AttributeValue
,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
OUTPUT INSERTED.AccountGlobalAttributeValueId,INSERTED.AccountId INTO @AccountGlobalAttributeValue(AccountGlobalAttributeValueId,AccountId)
SELECT ZA.AccountId, (SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE  AttributeCode = 'BusinessIdentificationNumber' AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Account')),
	NULL,NULL,2,GETDATE(),2,GETDATE()
FROM ZnodeAccount ZA
WHERE NOT EXISTS(SELECT * FROM ZnodeAccountGlobalAttributeValue Z WHERE ZA.AccountId = Z.AccountId
	AND GlobalAttributeId = (SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE  AttributeCode = 'BusinessIdentificationNumber' AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Account'))
	)

INSERT INTO ZnodeAccountGlobalAttributeValueLocale(AccountGlobalAttributeValueId,LocaleId,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,GlobalAttributeDefaultValueId,MediaId,MediaPath)
SELECT AccountGlobalAttributeValueId,1,NULL,2,GETDATE(),2,GETDATE(),NULL,NULL,NULL
FROM @AccountGlobalAttributeValue

Update ZnodeGlobalAttributeGroupLocale set AttributeGroupName = 'Business Details'
where AttributeGroupName = 'Buisness Identification Number'

UPDATE ZnodeGlobalAttribute SET HelpDescription = 'The input saved against this field will be used by all the customer accounts associated with this Account.'
WHERE AttributeCode = 'BusinessIdentificationNumber'

UPDATE ZnodeGlobalAttributeGrouplocale 
SET AttributeGroupName = 'Business Details'
WHERE GlobalAttributeGroupId = (SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'BusinessIdentificationNumber')
AND LocaleId = 1

GO


UPDATE ZnodeTaxPortal SET AvataxIsTaxIncluded = 0 WHERE AvataxIsTaxIncluded IS NULL

IF EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME = 'AvataxIsTaxIncluded' AND TABLE_NAME = 'ZnodeTaxPortal')
BEGIN
	IF NOT EXISTS(SELECT * FROM SYS.default_constraints WHERE NAME = 'DF_ZnodeTaxPortal_AvataxIsTaxIncluded')
	BEGIN
		ALTER TABLE ZnodeTaxPortal ADD CONSTRAINT DF_ZnodeTaxPortal_AvataxIsTaxIncluded DEFAULT 0 FOR AvataxIsTaxIncluded
	END
END
GO
IF EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME = 'AvataxIsTaxIncluded' AND TABLE_NAME = 'ZnodeTaxPortal')
BEGIN
	ALTER TABLE ZnodeTaxPortal ALTER COLUMN AvataxIsTaxIncluded BIT NOT NULL
END


UPDATE ZnodeTaxRuleTypes SET ClassName = 'AvataxClient' WHERE ClassName = 'AvataxTaxSales' AND NAME = 'Avatax Tax Class'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishSingleCategoryJson')
	DROP PROC Znode_GetPublishSingleCategoryJson

GO

CREATE PROCEDURE [dbo].[Znode_GetPublishSingleCategoryJson]
(
	@PimCategoryId    INT, 
    @UserId           INT,
    @Status           int = 0 OUT,
	@IsDebug          BIT = 0,
	--@LocaleIds		  TransferId READONLY,
	@PimCatalogId     INT = 0, 
	@RevisionType varchar(50)= '',
	@IsAssociate      int = 0 Out 
)
AS 
/*
       Summary:Publish category with their respective products and details 
	            The result is fetched in xml form   
       Unit Testing   
	            During Catalog Publish Publish status should be updated 
				   
       Begin transaction 
       SELECT * FROM ZnodePIMAttribute 
	   SELECT * FROM ZnodePublishCatalog 
	   SELECT * FROM ZnodePublishCategory WHERE publishCAtegoryID = 167 

       EXEC [Znode_GetPublishSingleCategory] @PimCategoryId= 27 ,@UserId =2 ,@IsDebug = 1 
       Rollback Transaction 
	*/
     BEGIN
         
         BEGIN TRY
             SET NOCOUNT ON;
			 BEGIN TRAN GetPublishCategory
			 DECLARE @PublishCatalogLogId int , @PublishCataLogId int , @VersionId  int --,@PimCatalogId int 
			 
			 DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
             DECLARE @LocaleId INT= 0, @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId(), @Counter INT= 1, @MaxId INT= 0, @CategoryIdCount INT;
             DECLARE @IsActive BIT= [dbo].[Fn_GetIsActiveTrue]();
             DECLARE @AttributeIds VARCHAR(MAX)= '', @PimCategoryIds VARCHAR(MAX)= '', @DeletedPublishCategoryIds VARCHAR(MAX)= '', @DeletedPublishProductIds VARCHAR(MAX);
			 DECLARE @TBL_PublishCatalogId TABLE(PublishCatalogId INT,PimCatalogId  INT , VersionId INT )
 
			 INSERT INTO @TBL_PublishCatalogId  (PublishCatalogId,PimCatalogId,VersionId ) 
			 SELECT DISTINCT ZPCL.PublishCatalogId, ZPCL.PimCatalogId,ZPCL.PublishCatalogLogId
			 FROM ZnodePimCategoryHierarchy ZPCH 
			 INNER JOIN ZnodePublishCatalogLog  ZPCL  ON ZPCH.PimCatalogId = ZPCL.PimCatalogId and ZPCH.PimCategoryId = @PimCategoryId 
			 where  PublishCatalogLogId in (Select MAX (PublishCatalogLogId) from ZnodePublishCatalogLog ZPCL where 
			 ZPCH.PimCatalogId = ZPCL.PimCatalogId)
			 AND ZPCL.PimCatalogId = CASE WHEN @PimCatalogId <> 0 THEN @PimCatalogId ELSE ZPCL.PimCatalogId END

			 IF (NOT EXISTS (Select TOP 1 1 from @TBL_PublishCatalogId) 
			 OR NOT EXISTS (select TOP 1 1  from ZnodePimCategoryProduct ZPCP inner join ZnodePimCategoryHierarchy ZPCH ON ZPCP.PimCategoryId = ZPCH.PimCategoryId where ZPCP.PimCategoryId = @PimCategoryId  ))
			 AND NOT Exists(select * from ZnodePimCategoryHierarchy where PimCategoryId = @PimCategoryId  ) 
			 Begin
				Commit tran GetPublishCategory;
				SET @Status = 1  -- Category not associated or catalog not publish
				SET @IsAssociate   = 0 
				Return 0 ;
			 END 

             DECLARE @TBL_AttributeIds TABLE
             (PimAttributeId       INT,
              ParentPimAttributeId INT,
              AttributeTypeId      INT,
              AttributeCode        VARCHAR(600),
              IsRequired           BIT,
              IsLocalizable        BIT,
              IsFilterable         BIT,
              IsSystemDefined      BIT,
              IsConfigurable       BIT,
              IsPersonalizable     BIT,
              DisplayOrder         INT,
              HelpDescription      VARCHAR(MAX),
              IsCategory           BIT,
              IsHidden             BIT,
              CreatedDate          DATETIME,
              ModifiedDate         DATETIME,
              AttributeName        NVARCHAR(MAX),
              AttributeTypeName    VARCHAR(300)
             );
             DECLARE @TBL_AttributeDefault TABLE
             (
				  PimAttributeId            INT,
				  AttributeDefaultValueCode VARCHAR(100),
				  IsEditable                BIT,
				  AttributeDefaultValue     NVARCHAR(MAX),
				  DisplayOrder   INT
             );
             DECLARE @TBL_AttributeValue TABLE
             (
				  PimCategoryAttributeValueId INT,
				  PimCategoryId               INT,
				  CategoryValue               NVARCHAR(MAX),
				  AttributeCode               VARCHAR(300),
				  PimAttributeId              INT
             );
             DECLARE @TBL_LocaleIds TABLE
             (
				  RowId     INT IDENTITY(1, 1),
				  LocaleId  INT,
				  IsDefault BIT
             );
			 DECLARE @TBL_CategoryXml TABLE
             (PublishCategoryId INT,
			  PublishCatalogId  INT,
              CategoryXml       XML,
              LocaleId          INT,
			  VersionId		    INT
             );

             DECLARE @TBL_PimCategoryIds TABLE
             (
				  PimCategoryId       INT,
				  PimParentCategoryId INT,
				  DisplayOrder        INT,
				  ActivationDate      DATETIME,
				  ExpirationDate      DATETIME,
				  CategoryName        NVARCHAR(MAX),
				  ProfileId           VARCHAR(MAX),
				  IsActive            BIT,
				  PimCategoryHierarchyId INT,
				  ParentPimCategoryHierarchyId INT,
				  PublishCatalogId INT,
				  PimCatalogId  INT,
				  VersionId INT  ,
				  CategoryCode  NVARCHAR(MAX)          
			 );
             DECLARE @TBL_PublishPimCategoryIds TABLE
             (PublishCategoryId       INT,
              PimCategoryId           INT,
              PublishProductId        varchar(max),
              PublishParentCategoryId INT ,
			  PimCategoryHierarchyId INT ,
			  parentPimCategoryHierarchyId INT,
			  RowIndex INT
             );
             DECLARE @TBL_DeletedPublishCategoryIds TABLE
             (PublishCategoryId INT,
              PublishProductId  INT
             );
            
             INSERT INTO @TBL_LocaleIds
             (LocaleId,
              IsDefault
             )
			  -- here collect all locale ids
            SELECT LocaleId,IsDefault FROM ZnodeLocale MT WHERE IsActive = @IsActive

			----Getting all recursive category hirarchy
			;WITH GetCategoryHierarchy
			AS     
			(
				SELECT ZPCH.PimCategoryId,ZPCH2.PimCategoryId  PimParentCategoryId,ZPCH.DisplayOrder,ZPCH.ActivationDate,ZPCH.ExpirationDate,ZPCH.IsActive ,ZPCH.PimCategoryHierarchyId,ZPCH.ParentPimCategoryHierarchyId
				,PublishCatalogId,PCI.PimCatalogId,VersionId
				FROM ZnodePimCategoryHierarchy AS ZPCH 
				LEFT JOIN ZnodePimCategoryHierarchy AS ZPCH2 ON (ZPCH2.PimCategoryHierarchyId = ZPCH. ParentPimCategoryHierarchyId ) 
				Inner join @TBL_PublishCatalogId PCI on ZPCH.PimCatalogId = PCI.PimCatalogId 
				WHERE ZPCH.PimCategoryId = @PimCategoryId 
				union all
				SELECT ZPCH.PimCategoryId,ZPCH2.PimCategoryId  PimParentCategoryId,ZPCH.DisplayOrder,ZPCH.ActivationDate,ZPCH.ExpirationDate,ZPCH.IsActive ,ZPCH.PimCategoryHierarchyId,ZPCH.ParentPimCategoryHierarchyId
				,PCI.PublishCatalogId,PCI.PimCatalogId,PCI.VersionId
				FROM ZnodePimCategoryHierarchy AS ZPCH 
				inner join GetCategoryHierarchy c on c.PimCategoryHierarchyId = ZPCH.ParentPimCategoryHierarchyId
				inner JOIN ZnodePimCategoryHierarchy AS ZPCH2 ON (ZPCH2.PimCategoryHierarchyId = ZPCH. ParentPimCategoryHierarchyId ) 
				Inner join @TBL_PublishCatalogId PCI on ZPCH.PimCatalogId = PCI.PimCatalogId 
			)
			INSERT INTO @TBL_PimCategoryIds(PimCategoryId,PimParentCategoryId,DisplayOrder,ActivationDate,ExpirationDate,IsActive,PimCategoryHierarchyId,ParentPimCategoryHierarchyId,
			 PublishCatalogId,PimCatalogId,VersionId)
			 SELECT PimCategoryId,PimParentCategoryId,DisplayOrder,ActivationDate,ExpirationDate,IsActive ,PimCategoryHierarchyId,ParentPimCategoryHierarchyId,
				 PublishCatalogId,PimCatalogId,VersionId
			 FROM GetCategoryHierarchy;


			 MERGE INTO ZnodePublishCategory TARGET USING 
			 ( Select PC.PimCategoryId,
					  PC.PimCategoryHierarchyId,
					  PC.PimParentCategoryId,
					  PC.ParentPimCategoryHierarchyId,
					  PC.PublishCatalogId
					  FROM @TBL_PimCategoryIds PC ) 
			 SOURCE ON
			 (
				 TARGET.PimCategoryId = SOURCE.PimCategoryId 
				 AND TARGET.PublishCatalogId = SOURCE.PublishCatalogId 
				 AND TARGET.PimCategoryHierarchyId = SOURCE.PimCategoryHierarchyId
			 )
			 WHEN MATCHED THEN UPDATE SET TARGET.PimParentCategoryId = SOURCE.PimParentCategoryId,TARGET.CreatedBy = @UserId,TARGET.CreatedDate = @GetDate,
				TARGET.ModifiedBy = @UserId,TARGET.ModifiedDate = @GetDate,
			 PimCategoryHierarchyId = SOURCE.PimCategoryHierarchyId,ParentPimCategoryHierarchyId=SOURCE.ParentPimCategoryHierarchyId
             
			 WHEN NOT MATCHED THEN 
			 INSERT(PimCategoryId,PublishCatalogId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
			 ,PimCategoryHierarchyId,ParentPimCategoryHierarchyId) 
			 VALUES(SOURCE.PimCategoryId,SOURCE.PublishCatalogId,@UserId,@GetDate,@UserId,@GetDate,SOURCE.PimCategoryHierarchyId
			 ,SOURCE.ParentPimCategoryHierarchyId)

				OUTPUT INSERTED.PublishCategoryId,INSERTED.PimCategoryId,INSERTED.PimCategoryHierarchyId,
			 INSERTED.parentPimCategoryHierarchyId 
			 INTO @TBL_PublishPimCategoryIds(PublishCategoryId,PimCategoryId,PimCategoryHierarchyId,parentPimCategoryHierarchyId);
			     	    
			---- here update the publish parent category id
            UPDATE ZPC SET [PimParentCategoryId] =TBPC.[PimCategoryId] ,ZPC.PublishParentCategoryId = TBPC.PublishCategoryId
			FROM ZnodePublishCategory ZPC
            INNER JOIN ZnodePublishCategory TBPC ON(ZPC.parentPimCategoryHierarchyId = TBPC.PimCategoryHierarchyId  ) 
			WHERE ZPC.PublishCatalogId = TBPC.PublishCatalogId 
			AND TBPC.PublishCatalogId  in (Select PublishCatalogId from @TBL_PublishCatalogId)
			AND ZPC.ParentPimCategoryHierarchyId IS NOT NULL 
			AND EXISTS(SELECT * FROM @TBL_PimCategoryIds T WHERE ZPC.PimCategoryId = T.PimCategoryId ) ;

			--UPDATE a
			--SET  a.PublishParentCategoryId = b.PublishCategoryId
			--FROM ZnodePublishCategory a 
			--INNER JOIN ZnodePublishCategory b   ON (a.parentpimCategoryHierarchyId = b.pimCategoryHierarchyId)
			--WHERE a.parentpimCategoryHierarchyId IS NOT NULL 
			--AND a.PublishCatalogId = b.PublishCatalogId AND b.PublishCatalogId in (Select PublishCatalogId from @TBL_PublishCatalogId)
			--AND EXISTS(SELECT * FROM @TBL_PimCategoryIds T WHERE ZPC.PimCategoryId = T.PimCategoryId ) ;

			 -- product are published here 
            --  EXEC Znode_GetPublishProducts @PublishCatalogId,0,@UserId,1,0,0;
			
		     SET @MaxId =(SELECT MAX(RowId)FROM @TBL_LocaleIds);
			 DECLARE @TransferID TRANSFERID 
			 INSERT INTO @TransferID 
			 SELECT DISTINCT  PimCategoryId	 FROM @TBL_PublishPimCategoryIds 

             SET @PimCategoryIds = SUBSTRING((SELECT ','+CAST(PimCategoryId AS VARCHAR(50)) FROM @TBL_PublishPimCategoryIds FOR XML PATH('')), 2, 4000);
			 
             WHILE @Counter <= @MaxId -- Loop on Locale id 
                 BEGIN
                     SET @LocaleId =(SELECT LocaleId FROM @TBL_LocaleIds WHERE RowId = @Counter);
                   
				     SET @AttributeIds = SUBSTRING((SELECT ','+CAST(ZPCAV.PimAttributeId AS VARCHAR(50)) FROM ZnodePimCategoryAttributeValue ZPCAV 
										 WHERE EXISTS(SELECT TOP 1 1 FROM @TBL_PimCategoryIds TBPC WHERE TBPC.PimCategoryId = ZPCAV.PimCategoryId) GROUP BY ZPCAV.PimAttributeId FOR XML PATH('')), 2, 4000);
                
				     SET @CategoryIdCount =(SELECT COUNT(1) FROM @TBL_PimCategoryIds);

                     INSERT INTO @TBL_AttributeIds (PimAttributeId,ParentPimAttributeId,AttributeTypeId,AttributeCode,IsRequired,IsLocalizable,IsFilterable,IsSystemDefined,
					 IsConfigurable,IsPersonalizable,DisplayOrder,HelpDescription,IsCategory,IsHidden,CreatedDate,ModifiedDate,AttributeName,AttributeTypeName)
                     EXEC [Znode_GetPimAttributesDetails] @AttributeIds,@LocaleId;

                     INSERT INTO @TBL_AttributeDefault (PimAttributeId,AttributeDefaultValueCode,IsEditable,AttributeDefaultValue,DisplayOrder)
                     EXEC [dbo].[Znode_GetAttributeDefaultValueLocale] @AttributeIds,@LocaleId;

                     INSERT INTO @TBL_AttributeValue (PimCategoryAttributeValueId,PimCategoryId,CategoryValue,AttributeCode,PimAttributeId)
                     EXEC [dbo].[Znode_GetCategoryAttributeValueId] @TransferID,@AttributeIds,@LocaleId;

					 
			

                     ;WITH Cte_UpdateDefaultAttributeValue
                     AS (
					  SELECT TBAV.PimCategoryId,TBAV.PimAttributeId,SUBSTRING((SELECT ','+AttributeDefaultValue FROM @TBL_AttributeDefault TBD WHERE TBAV.PimAttributeId = TBD.PimAttributeId
						AND EXISTS(SELECT TOP 1 1 FROM Split(TBAV.CategoryValue, ',') SP WHERE SP.Item = TBD.AttributeDefaultValueCode)FOR XML PATH('')), 2, 4000) DefaultCategoryAttributeValue
						FROM @TBL_AttributeValue TBAV WHERE EXISTS(SELECT TOP 1 1 FROM @TBL_AttributeDefault TBAD WHERE TBAD.PimAttributeId = TBAV.PimAttributeId))
					 
					 -- update the default value with locale 
                     UPDATE TBAV SET CategoryValue = CTUDFAV.DefaultCategoryAttributeValue FROM @TBL_AttributeValue TBAV 
					 INNER JOIN Cte_UpdateDefaultAttributeValue CTUDFAV ON(CTUDFAV.PimCategoryId = TBAV.PimCategoryId AND CTUDFAV.PimAttributeId = TBAV.PimAttributeId)
					 WHERE CategoryValue IS NULL ;
					 
					 -- here is update the media path  
						WITH Cte_productMedia
						AS (
							SELECT TBA.PimCategoryId,TBA.PimAttributeId,
							Isnull(
							(STUFF((SELECT ','+zm.PATH FROM ZnodeMedia ZM WHERE EXISTS
							(SELECT TOP 1 1 FROM dbo.split(TBA.CategoryValue, ',') SP
							WHERE SP.Item = CAST(Zm.MediaId AS VARCHAR(50)))FOR XML PATH(''),Type).value('.', 'varchar(max)'), 1, 1,'')) ,'no-image.png')
							CategoryValue
							FROM @TBL_AttributeValue TBA WHERE EXISTS(SELECT TOP 1 1 FROM [dbo].[Fn_GetProductMediaAttributeId]() FNMA WHERE FNMA.PImAttributeId = TBA.PimATtributeId)
						)


					 UPDATE TBAV SET CategoryValue = CTCM.CategoryValue 
					 FROM @TBL_AttributeValue TBAV 
					 INNER JOIN Cte_productMedia CTCM ON(CTCM.PimCategoryId = TBAV.PimCategoryId
					 AND CTCM.PimAttributeId = TBAV.PimAttributeId);

                     WITH Cte_PublishProductIds
					 AS (SELECT TBPC.PublishcategoryId,SUBSTRING((SELECT ','+CAST(PublishProductId AS VARCHAR(50))
					  FROM ZnodePublishCategoryProduct ZPCP 
					  WHERE ZPCP.PublishCategoryId = TBPC.publishCategoryId
					  AND ZPCP.PimCategoryHierarchyId = TBPC.PimCategoryHierarchyId
                      AND ZPCP.PublishCatalogId in (Select PublishCatalogId from @TBL_PublishCatalogId)
					   FOR XML PATH('')), 2, 8000) PublishProductId ,PimCategoryHierarchyId
					  FROM @TBL_PublishPimCategoryIds TBPC)
                          
					 UPDATE TBPPC SET PublishProductId = CTPP.PublishProductId FROM @TBL_PublishPimCategoryIds TBPPC INNER JOIN Cte_PublishProductIds CTPP ON(TBPPC.PublishCategoryId = CTPP.PublishCategoryId 
					 AND TBPPC.PimCategoryHierarchyId = CTPP.PimCategoryHierarchyId);

                     WITH Cte_CategoryProfile
                     AS (
							SELECT PimCategoryId,ZPCC.PimCategoryHierarchyId,
									SUBSTRING(( SELECT ','+CAST(ProfileId AS VARCHAR(50)) 
									FROM ZnodeProfile ZPC 
									INNER JOIN ZnodePimCategoryHierarchy ZPRCC ON(ZPRCC.PimCategoryHierarchyId = ZPCC.PimCategoryHierarchyId
									AND ZPRCC.PimCatalogId = ZPC.PimCatalogId) 
									WHERE ZPC.PimCatalogId = ZPCC.PimCatalogId FOR XML PATH('')), 2, 4000) ProfileIds
						   FROM ZnodePimCategoryHierarchy ZPCC 
						   WHERE EXISTS(SELECT TOP 1 1 FROM @TBL_PimCategoryIds TBPC 
						   WHERE TBPC.PimCategoryId = ZPCC.PimCategoryId AND ZPCC.PimCatalogId in (Select PimCatalogId from @TBL_PublishCatalogId)
						   AND ZPCC.PimCategoryHierarchyId = TBPC.PimCategoryHierarchyId)
					   )                          
				      UPDATE TBPC SET TBPC.ProfileId = CTCP.ProfileIds 
					  FROM @TBL_PimCategoryIds TBPC 
					  LEFT JOIN Cte_CategoryProfile CTCP ON(CTCP.PimCategoryId = TBPC.PimCategoryId AND CTCP.PimCategoryHierarchyId = TBPC.PimCategoryHierarchyId );
               
					 UPDATE TBPC SET TBPC.CategoryName = TBAV.CategoryValue FROM @TBL_PimCategoryIds TBPC INNER JOIN @TBL_AttributeValue TBAV ON(TBAV.PimCategoryId = TBPC.PimCategoryId
                     AND EXISTS(SELECT TOP 1 1 FROM [dbo].[Fn_GetCategoryNameAttribute]() FNGCNA WHERE FNGCNA.PimAttributeId = TBAV.PimAttributeId))


					 UPDATE TBPC SET TBPC.CategoryCode = TBAV.CategoryValue FROM @TBL_PimCategoryIds TBPC INNER JOIN @TBL_AttributeValue TBAV ON(TBAV.PimCategoryId = TBPC.PimCategoryId
					 AND EXISTS(SELECT TOP 1 1 FROM dbo.Fn_GetCategoryCodeAttribute() FNGCNA WHERE FNGCNA.PimAttributeId = TBAV.PimAttributeId)
					 )

					 -- here update the publish category details 
                     ;WITH Cte_UpdateCategoryDetails
                     AS (
					 SELECT TBC.PimCategoryId,PublishCategoryId,CategoryName, TBPPC.PimCategoryHierarchyId,CategoryCode
					 FROM @TBL_PimCategoryIds TBC
                     INNER JOIN @TBL_PublishPimCategoryIds TBPPC ON(TBC.PimCategoryId = TBPPC.PimCategoryId AND TBC.PimCategoryHierarchyId = TBPPC.PimCategoryHierarchyId)
					 )						
                     MERGE INTO ZnodePublishCategoryDetail TARGET USING Cte_UpdateCategoryDetails SOURCE ON(TARGET.PublishCategoryId = SOURCE.PublishCategoryId
					 AND TARGET.LocaleId = @LocaleId)
                     WHEN MATCHED THEN UPDATE SET PublishCategoryId = SOURCE.PublishcategoryId,PublishCategoryName = SOURCE.CategoryName,LocaleId = @LocaleId,ModifiedBy = @userId,ModifiedDate = @GetDate,CategoryCode= SOURCE.CategoryCode
                     WHEN NOT MATCHED THEN INSERT(PublishCategoryId,PublishCategoryName,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CategoryCode) VALUES
                     (SOURCE.PublishCategoryId,SOURCE.CategoryName,@LocaleId,@userId,@GetDate,@userId,@GetDate,CategoryCode);


					DECLARE @UpdateCategoryLog  TABLE (PublishCatalogLogId INT , LocaleId INT ,PublishCatalogId INT  )
					INSERT INTO @UpdateCategoryLog
					SELECT MAX(PublishCatalogLogId) PublishCatalogLogId , LocaleId , PublishCatalogId 
					FROM ZnodePublishCatalogLog a 
					WHERE a.PublishCatalogId =@PublishCatalogId
					AND  a.LocaleId = @LocaleId 
					GROUP BY 	LocaleId,PublishCatalogId  

					-----------------------------------------------------------------
					IF OBJECT_ID('tempdb..#Index') is not null
					BEGIN 
						DROP TABLE #Index
					END 
					CREATE TABLE #Index (RowIndex int ,PimCategoryId int , PimCategoryHierarchyId  int,ParentPimCategoryHierarchyId int )		
					insert into  #Index ( RowIndex ,PimCategoryId , PimCategoryHierarchyId,ParentPimCategoryHierarchyId)
					SELECT CAST(Row_number() OVER (Partition By TBL.PimCategoryId Order by ISNULL(TBL.PimCategoryId,0) desc) AS VARCHAR(100))
					,ZPC.PimCategoryId, ZPC.PimCategoryHierarchyId, ZPC.ParentPimCategoryHierarchyId
					FROM @TBL_PublishPimCategoryIds TBL
					INNER JOIN ZnodePublishCategory ZPC ON (TBL.PimCategoryId = ZPC.PimCategoryId AND TBL.PimCategoryHierarchyId = ZPC.PimCategoryHierarchyId)
					WHERE ZPC.PublishCatalogId = @PublishCatalogId

					UPDATE TBP SET  TBP.[RowIndex]=  IDX.RowIndex 
					FROM @TBL_PublishPimCategoryIds TBP INNER JOIN #Index IDX ON (IDX.PimCategoryId = TBP.PimCategoryId AND IDX.PimCategoryHierarchyId = TBP.PimCategoryHierarchyId)  

					------------------------------------------------------------------
					If (@RevisionType like '%Preview%'  OR @RevisionType like '%Production%'  ) 
						Delete a from ZnodePublishCategoryEntity a Where 
						Exists(Select * from @TBL_PublishPimCategoryIds b where (a.ZnodeCategoryId = b.PublishCategoryId or a.ZnodeParentCategoryIds = '['+cast(b.PublishCategoryId as varchar(10))+']')) AND LocaleId = @LocaleId
						AND VersionId in (SELECT VersionId FROM ZnodePublishVersionEntity where RevisionType = 'PREVIEW')
					If (@RevisionType like '%Production%' OR @RevisionType = 'None')
						Delete a from ZnodePublishCategoryEntity a Where 
						Exists(Select * from @TBL_PublishPimCategoryIds b where (a.ZnodeCategoryId = b.PublishCategoryId or a.ZnodeParentCategoryIds = '['+cast(b.PublishCategoryId as varchar(10))+']')) AND LocaleId = @LocaleId
						AND VersionId in (SELECT VersionId FROM ZnodePublishVersionEntity where RevisionType = 'PRODUCTION')
				

					INSERT INTO ZnodePublishCategoryEntity
					(
						 VersionId,ZnodeCategoryId,
						 Name,CategoryCode,
						 ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds,
						 ProductIds,LocaleId,IsActive,DisplayOrder,
						 Attributes,
						 ActivationDate,ExpirationDate,CategoryIndex
					)
					OUTPUT INSERTED.ZnodeCategoryId,INSERTED.ZnodeCatalogId, INSERTED.LocaleId  , Inserted.VersionId
					INTO  @TBL_CategoryXml (PublishCategoryId,PublishCatalogId,localeId,VersionId) 
					SELECT ISNULL(TYU.VersionId,'') VersionId,TBPC.PublishCategoryId ZnodeCategoryId,
						   ISNULL(CategoryName, '') Name,ISNULL(CategoryCode,'') CategoryCode,
						   ZPC.PublishCatalogId, ZPC.CatalogName ,
						   Isnull('[' + THR.PublishParentCategoryId + ']',NULL) TempZnodeParentCategoryIds,
						   ISNULL('[' + TBPC.PublishProductId + ']', NULL)  TempProductIds,
						   @LocaleId LocaleId,TBC.IsActive,ISNULL(DisplayOrder, '0') DisplayOrder,
						      ISNULL(
									(
										SELECT TBA.AttributeCode,TBA.AttributeName,ISNULL(IsUseInSearch, 0) IsUseInSearch,
										ISNULL(IsHtmlTags, 0) IsHtmlTags,ISNULL(IsComparable, 0) IsComparable,
										TBAV.CategoryValue AttributeValues,TBA.AttributeTypeName 
										FROM @TBL_AttributeValue TBAV
										INNER JOIN @TBL_AttributeIds TBA ON(TBAV.PimAttributeId = TBA.PimAttributeId) 
										LEFT JOIN ZnodePimFrontendProperties ZPFP ON(ZPFP.PimAttributeId = TBA.PimAttributeId)
										WHERE TBC.PimCategoryId = TBAV.PimCategoryId  
										FOR JSON PATH) 
									, '[]')  ,
							ActivationDate,ExpirationDate,ISNULL(TBPC.RowIndex,1) CategoryIndex
						   --,ProfileId TempProfileIds

						FROM @TBL_PublishPimCategoryIds TBPC 
						INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId in  (Select PublishCatalogId from @TBL_PublishCatalogId))
						INNER JOIN ZnodePublishCategory THR ON (THR.PimCategoryHierarchyId = TBPC.PimCategoryHierarchyId AND THR.PimCategoryId = TBPC.PimCategoryId AND THR.PublishCatalogId =ZPC.PublishCatalogId  )
						LEFT JOIN @UpdateCategoryLog TY ON ( TY.PublishCatalogId IN (Select PublishCatalogId from @TBL_PublishCatalogId) AND TY.localeId = @LocaleId  )
						INNER JOIN @TBL_PimCategoryIds TBC ON(TBC.PimCategoryId = TBPC.PimCategoryId AND TBC.PimCategoryHierarchyId = TBPC.PimCategoryHierarchyId) 
						INNER JOIN ZnodePublishVersionEntity TYU ON (TYU.ZnodeCatalogId  = ZPC.PublishCatalogId AND TYU.IsPublishSuccess =1 AND TYU.LocaleId = @LocaleId )
						where 
						(	
							(TYU.RevisionType =  Case when  (@RevisionType like '%Preview%'  OR @RevisionType like '%Production%' ) then 'Preview' End ) 
							OR 
							(TYU.RevisionType =  Case when (@RevisionType like '%Production%' OR @RevisionType = 'None') then  'Production'  end )
						)


				     DELETE FROM @TBL_AttributeIds;
                     DELETE FROM @TBL_AttributeDefault;
                     DELETE FROM @TBL_AttributeValue;
                     SET @Counter = @Counter + 1;
                 END;
	

			Select PublishCategoryId ,VersionId	, 0 PimCatalogId, LocaleId,PublishCatalogId, '404test' SeoUrl
			into #OutPublish from @TBL_CategoryXml 

			Alter TABLE #OutPublish ADD Id int Identity 
			SET @MaxId =(SELECT COUNT(*) FROM #OutPublish);
			 --SET @PimCategoryIds = SUBSTRING((SELECT ','+CAST(PimCategoryId AS VARCHAR(50)) FROM @TBL_PublishPimCategoryIds FOR XML PATH('')), 2, 4000);
			Declare @ExistingPublishCategoryId  nvarchar(max), @PublishCategoryId  int 
			SET @Counter =1 
            WHILE @Counter <= @MaxId -- Loop on Locale id 
            BEGIN
				SELECT @VersionId = VersionId  ,
				@PublishCategoryId = PublishCategoryId 
				from #OutPublish where ID = @Counter

		----Single category publish. Category count update for verison for specific catalog
		if Exists (select count(1) from @TBL_PublishPimCategoryIds)
	    begin
			UPDATE ZnodePublishCatalogLog 
				SET PublishCategoryId = (select count(distinct a.PimCategoryId)
				from ZnodePublishCategory a 
				inner join ZnodePublishCatalog c on a.PublishCatalogId = c.PublishCatalogId
				inner join ZnodePimCategoryProduct b on  a.PimCategoryId = b.PimCategoryId 
				inner join ZnodePimCategoryHierarchy ZPCH ON b.PimCategoryId = ZPCH.PimCategoryId and c.PimCatalogId = ZPCH.PimCatalogId
				where a.PublishCatalogId = ZnodePublishCatalogLog.PublishCatalogId)
				,ModifiedDate = @GetDate
			FROM ZnodePublishCatalogLog
			WHERE ZnodePublishCatalogLog.PublishCatalogLogId = @VersionId 
			AND exists(select * from ZnodePublishCatalog ZPC where ZnodePublishCatalogLog.PublishCatalogId = ZPC.PublishCatalogId and ZPC.PimCatalogId = @PimCatalogId )
		end

		----Single category publish. Category count update in all associated catalog 
		if isnull(@PimCatalogId,0)=0 and isnull(@PimcategoryId,0)<>0
		begin
			if object_Id('tempdb..#temp_CatalogCategory') is not null
				drop table #temp_CatalogCategory

			select max(c.PublishCatalogLogId) PublishCatalogLogId, C.PublishCatalogId
			into #temp_CatalogCategory
			from ZnodePimCategoryProduct a
			inner join ZnodePimCategoryHierarchy ZPCH ON a.PimCategoryId = ZPCH.PimCategoryId
			inner join ZnodePublishCatalog b on ZPCH.PimCatalogId = b.PimCatalogId
			inner join ZnodePublishCatalogLog c on b.PublishCatalogId = c.PublishCatalogId
			where a.PimCategoryId = @PimcategoryId
			group by C.PublishCatalogId

		   UPDATE ZPCC 
				SET PublishCategoryId = (select count(distinct a.PimCategoryId)
				from ZnodePublishCategory a 
				inner join ZnodePublishCatalog c on a.PublishCatalogId = c.PublishCatalogId
				inner join ZnodePimCategoryProduct b on  a.PimCategoryId = b.PimCategoryId 
				inner join ZnodePimCategoryHierarchy ZPCH ON b.PimCategoryId = ZPCH.PimCategoryId and c.PimCatalogId = ZPCH.PimCatalogId
				where a.PublishCatalogId = ZPCC.PublishCatalogId)
				,ModifiedDate = @GetDate
			FROM ZnodePublishCatalogLog ZPCC
			WHERE exists(select * from #temp_CatalogCategory CC where ZPCC.PublishCatalogLogId = CC.PublishCatalogLogId )
		end

				SET @Counter  = @Counter  + 1  
			END

			SET @Status = 1 

			If  @RevisionType = 'PREVIEW'
				UPDATE ZnodePimCategory	SET IsCategoryPublish = 1,PublishStateId =  DBO.Fn_GetPublishStateIdForPreview()  WHERE PimCategoryId = @PimCategoryId 
			else 
				UPDATE ZnodePimCategory	SET IsCategoryPublish = 1,PublishStateId =  DBO.Fn_GetPublishStateIdForPublish()  WHERE PimCategoryId = @PimCategoryId 


			if object_Id('tempdb..##PublishCategoryDetails') is not null
				drop table ##PublishCategoryDetails
			Select PublishCategoryId,VersionId,LocaleId,PublishCatalogId INTO ##PublishCategoryDetails  from @TBL_CategoryXml 
			SET @IsAssociate     = 1  
			Commit TRAN GetPublishCategory;

         END TRY
         BEGIN CATCH
             SELECT ERROR_MESSAGE();
             DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishSingleCategoryJson @PimCategoryId= '+CAST(@PimCategoryId AS VARCHAR(50))+',@PublishCatalogId = '+CAST(@PublishCatalogId AS VARCHAR(50))+',@UserId ='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(50));
             SET @Status = 0 -- Publish Falies 

             ROLLBACK TRAN GetPublishCategory;
			 	SET @IsAssociate     =   0
				 SELECT ERROR_MESSAGE();
			 EXEC Znode_InsertProcedureErrorLog
                  @ProcedureName = 'Znode_GetPublishSingleCategoryJson',
                  @ErrorInProcedure = @Error_procedure,
                  @ErrorMessage = @ErrorMessage,
                  @ErrorLine = @ErrorLine,
                  @ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

UPDATE ZnodeApplicationSetting SET Setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>AccountId</name><headertext>Checkbox</headertext><width>0</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>AccountId</name><headertext>Account ID</headertext><width>0</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>AccountCode</name><headertext>Account Code</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>Name</name><headertext>Account Name</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>accountnamecolumn</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>ParentAccountName</name><headertext>Parent Account Name</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>PortalId</name><headertext>Portal ID</headertext><width>0</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>y</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>portalId</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName = 'ZnodeUserAccountList'

GO

Update ZnodeActionMenu set MenuId = (select TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'General' and ControllerName = 'MyReports') 
where ActionId = (select top 1 ActionId from ZnodeActions where ControllerName='MyReports'and ActionName='DynamicReport')

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetOmsOrderDetail')
	DROP PROC Znode_GetOmsOrderDetail

GO

CREATE PROCEDURE [dbo].[Znode_GetOmsOrderDetail]
( 
	@WhereClause NVARCHAR(MAX),
	@Rows        INT            = 100,
	@PageNo      INT            = 1,
	@Order_BY    VARCHAR(1000)  = '',
	@RowsCount   INT OUT			,
	@UserId	   INT = 0 ,
	@IsFromAdmin int=0,
	@SalesRepUserId int = 0 
 )
AS
    /*
     Summary : This procedure is used to get the oms order detils
			   Records are fetched for those users who placed the order i.e UserId is Present in ZnodeUser and  ZnodeOmsOrderDetails tables
	 Unit Testing:

    EXEC [Znode_GetOmsOrderDetail_SCT] 'PortalId =1',@Order_BY = '',@RowsCount= 0, @UserId = 0 ,@Rows = 50, @PageNo = 1

	declare @p7 int
	set @p7=4
	exec sp_executesql N'Znode_GetOmsOrderDetail_SCT @WhereClause, @Rows,@PageNo,@Order_By,@RowCount OUT,@UserId,@IsFromAdmin',N'@WhereClause nvarchar(30),@Rows int,@PageNo int,@Order_By nvarchar(14),@RowCount int output,@UserId int,@IsFromAdmin int',@WhereClause=N'(PortalId in(''1'',''4'',''5'',''6''))',@Rows=50,@PageNo=1,@Order_By=N'orderdate desc',@RowCount=@p7 output,@UserId=0,@IsFromAdmin=1
	select @p7



   */
BEGIN
    BEGIN TRY
	SET NOCOUNT ON;
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
		DECLARE @SQL NVARCHAR(MAX), @ProcessType  varchar(50)='Order'
		DECLARE @OrderLineItemRelationshipTypeId INT
		SET @OrderLineItemRelationshipTypeId = ( SELECT top 1 OrderLineItemRelationshipTypeId  FROM ZnodeOmsOrderLineItemRelationshipType where Name = 'AddOns' )

		----Verifying that the @SalesRepUserId is having 'Sales Rep' role
		IF NOT EXISTS
		(
			SELECT * FROM ZnodeUser ZU
			INNER JOIN AspNetZnodeUser ANZU ON ZU.UserName = ANZU.UserName
			INNER JOIN AspNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName
			INNER JOIN AspNetUserRoles ANUR ON ANU.Id = ANUR.UserId
			Where Exists(select * from AspNetRoles ANR Where Name = 'Sales Rep' AND ANUR.RoleId = ANR.Id) 
			AND ZU.UserId = @SalesRepUserId
		)   
		Begin
			SET @SalesRepUserId = 0
		End

		DECLARE @Fn_GetPaginationWhereClause VARCHAR(500) = dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows),
		@Fn_GetFilterWhereClause NVARCHAR(MAX) = ''
		set @Fn_GetFilterWhereClause=dbo.Fn_GetFilterWhereClause(@WhereClause)
			
		IF @Order_BY = ''
			set @Order_BY = 'OrderDate desc'

			set @Order_BY = replace(@Order_BY,'PortalId','ZODD.PortalId')
			set @Order_BY = replace(@Order_BY,'UserName','ISNULL(RTRIM(LTRIM(ZODD.FirstName)),'''')+'' ''+ISNULL(RTRIM(LTRIM(ZODD.LastName)),'''')')
			set @Order_BY = replace(@Order_BY,'email','ZODD.Email')
			set @Order_BY = replace(@Order_BY,'OrderState','case when ZOS.IsShowToCustomer=0 and '+cast( @IsFromAdmin as varchar(50))+' = 0 then ZOSC.Description else  ZOS.Description end')
			set @Order_BY = replace(@Order_BY,'PaymentStatus','ZOPS.Name')
			set @Order_BY = replace(@Order_BY,'PublishState','ZODPS.DisplayName')
			set @Order_BY = replace(@Order_BY,'StoreName','ZP.StoreName')

			Declare @Fn_GetPagingRowId NVARCHAR(MAX) = ' DENSE_RANK()Over('+ ' Order By '+CASE WHEN Isnull(@Order_BY,'') = '' THEN 'OmsOrderId DESC' ELSE @Order_BY + ',OmsOrderId DESC' END  + ') RowId '
						
			IF OBJECT_ID('tempdb..#TBL_RowCount') is not null
				DROP TABLE #TBL_RowCount

			IF OBJECT_ID('tempdb..#Portal') is not null
				DROP TABLE #Portal
			
			Create table #TBL_RowCount(RowsCount int )
			CREATE TABLE #tbl_GetRecurciveUserId  (ID INT IDENTITY(1,1) Primary key,UserId INT,ParentUserId INT)
			INSERT INTO #tbl_GetRecurciveUserId
			SELECT UserId,ParentUserId FROM dbo.Fn_GetRecurciveUserId (CAST(@UserId AS VARCHAR(50)),@ProcessType ) FNRU
			 
			set @Fn_GetFilterWhereClause = replace(@Fn_GetFilterWhereClause,'PortalId','ZODD.PortalId')
			set @Fn_GetFilterWhereClause = replace(@Fn_GetFilterWhereClause,'UserName','ISNULL(RTRIM(LTRIM(ZODD.FirstName)),'''')+'' ''+ISNULL(RTRIM(LTRIM(ZODD.LastName)),'''')')
			set @Fn_GetFilterWhereClause = replace(@Fn_GetFilterWhereClause,'email','ZODD.Email')
			set @Fn_GetFilterWhereClause = replace(@Fn_GetFilterWhereClause,'OrderState','case when ZOS.IsShowToCustomer=0 and '+cast( @IsFromAdmin as varchar(50))+' = 0 then ZOSC.Description else  ZOS.Description end')
			set @Fn_GetFilterWhereClause = replace(@Fn_GetFilterWhereClause,'PaymentStatus','ZOPS.Name')
			set @Fn_GetFilterWhereClause = replace(@Fn_GetFilterWhereClause,'PublishState','ZODPS.DisplayName')
			set @Fn_GetFilterWhereClause = replace(@Fn_GetFilterWhereClause,'StoreName','ZP.StoreName')

			
		
	
		set @Fn_GetPagingRowId = replace(@Fn_GetPagingRowId,'OmsOrderId','Zoo.OmsOrderId')
		
		
		set @Rows = @PageNo * @Rows

		CREATE TABLE #Portal (PortalId int,StoreName varchar(200))
		insert into #Portal
		select PortalId,StoreName
		from ZnodePortal

		SET @SQL = '
		SELECT top '+cast(@Rows as varchar(10))+' Zoo.OmsOrderId,Zoo.OrderNumber, ZODD.PortalId,ZP.StoreName ,ZODD.CurrencyCode,
		case when ZOS.IsShowToCustomer=0 and '+cast( @IsFromAdmin as varchar(50))+' = 0 then ZOSC.Description else  ZOS.Description end  OrderState,ZODD.ShippingId,ZODD.PaymentTypeId,ZODD.PaymentSettingId
		,ZOPS.Name PaymentStatus,ZPS.Name PaymentType,CAST(1 AS BIT) ShippingStatus ,ZODD.OrderDate,ZODD.UserId,ISNULL(RTRIM(LTRIM(ZODD.FirstName)),'''')
		+'' ''+ISNULL(RTRIM(LTRIM(ZODD.LastName)),'''') UserName ,ZODD.PaymentTransactionToken ,ZODD.OrderTotalWithoutVoucher as Total,ZODD.OmsOrderDetailsId,ZODD.PoDocument,
		ZODD.Email ,ZODD.PhoneNumber ,ZODD.SubTotal ,ZODD.TaxCost ,ZODD.ShippingCost,ZODD.BillingPostalCode,
		ZODD.ModifiedDate AS OrderModifiedDate,  ZODD.PaymentDisplayName  ,isnull(Zoo.ExternalId,0) ExternalId,ZODD.CreditCardExpMonth,ZODD.CultureCode--,ZODD.TotalAdditionalCost
		,ZODD.CreditCardExpYear,ZODD.CardType,ZODD.CreditCardNumber,ZODD.PaymentExternalId,ZODPS.DisplayName as PublishState,
		'''' ProductName, 0 CountId, CAST (0 as bit) IsInRMA, '+@Fn_GetPagingRowId+'
		INTO #Cte_OrderLineDescribe
		FROM ZnodeOmsOrder (nolock) ZOO 
		INNER JOIN ZnodeOmsOrderDetails (nolock) ZODD ON (ZODD.OmsOrderId = ZOO.OmsOrderId AND  ZODD.IsActive = 1)
		INNER JOIN ZnodePublishState ZODPS ON (ZODPS.PublishStateId = ZOO.PublishStateId)
		INNER JOIN #Portal ZP (nolock) ON ZODD.PortalId = ZP.PortalId
		LEFT JOIN ZnodePaymentType (nolock) ZPS ON (ZPS.PaymentTypeId = ZODD.PaymentTypeId )
		LEFT JOIN ZnodeOmsOrderStateShowToCustomer (nolock) ZOSC ON (ZOSC.OmsOrderStateId = ZODD.OmsOrderStateId)
		LEFT JOIN ZnodeOmsOrderState (nolock) ZOS ON (ZOS.OmsOrderStateId = ZODD.OmsOrderStateId)
		LEFT JOIN ZnodeOmsPaymentState (nolock) ZOPS ON (ZOPS.OmsPaymentStateId = ZODD.OmsPaymentStateId)
		WHERE (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and ZODD.UserId = SalRep.CustomerUserid) or '+cast(@SalesRepUserId as varchar(10))+' = 0 )  
		AND (EXISTS (SELECT TOP 1 1 FROM #tbl_GetRecurciveUserId FNRU WHERE FNRU.UserId = ZODD.UserId ) OR '+cast(@UserId as varchar(10))+'  =0 )'
		+ @Fn_GetFilterWhereClause+' 
		ORDER BY '+CASE WHEN Isnull(@Order_BY,'') = '' THEN 'OmsOrderId DESC' ELSE @Order_BY + ',OmsOrderId DESC' END +' 

		INSERT INTO #TBL_RowCount 
		SELECT count(*)
		FROM ZnodeOmsOrder (nolock) ZOO 
		INNER JOIN ZnodeOmsOrderDetails (nolock) ZODD ON (ZODD.OmsOrderId = ZOO.OmsOrderId AND  ZODD.IsActive = 1)
		INNER JOIN ZnodePublishState ZODPS ON (ZODPS.PublishStateId = ZOO.PublishStateId)
		INNER JOIN #Portal ZP (nolock) ON ZODD.PortalId = ZP.PortalId
		LEFT JOIN ZnodePaymentType (nolock) ZPS ON (ZPS.PaymentTypeId = ZODD.PaymentTypeId )
		LEFT JOIN ZnodeOmsOrderStateShowToCustomer (nolock) ZOSC ON (ZOSC.OmsOrderStateId = ZODD.OmsOrderStateId)
		LEFT JOIN ZnodeOmsOrderState (nolock) ZOS ON (ZOS.OmsOrderStateId = ZODD.OmsOrderStateId)
		LEFT JOIN ZnodeOmsPaymentState (nolock) ZOPS ON (ZOPS.OmsPaymentStateId = ZODD.OmsPaymentStateId)
		WHERE (EXISTS(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and ZODD.UserId = SalRep.CustomerUserid) or '+cast(@SalesRepUserId as varchar(10))+' = 0 )  
		AND (EXISTS (SELECT TOP 1 1 FROM #tbl_GetRecurciveUserId FNRU WHERE FNRU.UserId = ZODD.UserId ) OR '+cast(@UserId as varchar(10))+'  =0 )'
		+ @Fn_GetFilterWhereClause+' 
			
		Create index Ind_OrderLineDescribe_RowId on #Cte_OrderLineDescribe(RowId )

		SELECT OmsOrderId,OrderNumber,PortalId,StoreName,CurrencyCode,OrderState,ShippingId,
		PaymentTypeId,PaymentSettingId,PaymentStatus,PaymentType,ShippingStatus,OrderDate,UserId,UserName,PaymentTransactionToken,Total,
		PN OrderItem,a.OmsOrderDetailsId,CountId ItemCount, PoDocument AS PODocumentPath,IsInRMA ,
		Email,PhoneNumber,SubTotal,TaxCost,ShippingCost,BillingPostalCode,null ShippingPostalCode
		,OrderModifiedDate,PaymentDisplayName, 
		ExternalId,CreditCardExpMonth,CreditCardExpYear,CardType,CreditCardNumber,PaymentExternalId,CultureCode,PublishState --TotalAdditionalCost
		FROM #Cte_OrderLineDescribe a inner join (select OmsOrderDetailsId, min(ProductName) PN, sum(case when OmsOrderLineItemsId is null then 0 else 1 end ) CNT from ZnodeOmsOrderLineItems
		where ParentOmsOrderLineItemsId is not null group by OmsOrderDetailsId ) b on a.OmsOrderDetailsId = b.OmsOrderDetailsId
		' + @Fn_GetPaginationWhereClause +' order by RowId '

		--print @SQL
		EXEC(@SQL)
		Select @RowsCount= isnull(RowsCount  ,0) from #TBL_RowCount
		
		IF OBJECT_ID('tempdb..#TBL_RowCount') is not null
				DROP TABLE #TBL_RowCount

		IF OBJECT_ID('tempdb..#Portal') is not null
			DROP TABLE #Portal
		
    END TRY
    BEGIN CATCH
        DECLARE @Status BIT ;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetOmsOrderDetail @WhereClause = '''+ISNULL(CAST(@WhereClause AS VARCHAR(max)),'''''')+''',@Rows='''+ISNULL(CAST(@Rows AS VARCHAR(50)),'''''')+''',@PageNo='+ISNULL(CAST(@PageNo AS VARCHAR(50)),'''')+',
		@Order_BY='+ISNULL(@Order_BY,'''''')+',@UserId = '+ISNULL(CAST(@UserId AS VARCHAR(50)),'''')+',@RowsCount='+ISNULL(CAST(@RowsCount AS VARCHAR(50)),'''')+',@IsFromAdmin='+ISNULL(CAST(@IsFromAdmin AS VARCHAR(10)),'''');
              			 
        SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    

        EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_GetOmsOrderDetail',
		@ErrorInProcedure = 'Znode_GetOmsOrderDetail',
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
    END CATCH;
END;

GO

IF EXISTS(SELECT 1 FROM sys.views WHERE type='v' AND name='View_PimProducttextValue')
DROP VIEW View_PimProducttextValue;
GO

CREATE View View_PimProducttextValue 
With SchemaBinding 
AS
SELECT PimProductId ,AttributeCode , ZPAVL.AttributeValue ,ZPAVL.LocaleId
FROM dbo.ZnodePimAttribute ZPA
INNER JOIN dbo.ZnodePimAttributeValue ZPAV ON (ZPA.PimAttributeId = ZPAV.PimAttributeId)
INNER JOIN dbo.ZnodePimAttributeValueLocale ZPAVL ON (ZPAVL.PimAttributeValueId = ZPAV.PimAttributeValueId)
INNER JOIN dbo.ZnodeAttributeType ZTA ON (ZTA.AttributeTypeId = ZPA.AttributeTypeId)
WHERE ZPA.IsCategory =0 
AND IsShowOnGrid =1 
AND AttributeTypeName IN ('Text','Number','Datetime','Yes/No','Date')

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetFilterPimProductId')
	DROP PROC Znode_GetFilterPimProductId

GO	 


Create PROCEDURE [dbo].[Znode_GetFilterPimProductId]
(
  @WhereClause XML 
 ,@PimProductId TransferId READONLY 
 ,@LocaleId   INT,
 @IsProductNotIn BIT = 1
)
AS 
BEGIN 
SET NOCOUNT ON 

		DECLARE  @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleID()
		DECLARE @SQL NVARCHAR(MAX)
		DECLARE @InternalProductWhereClause NVARCHAR(MAX)

		DECLARE @WorkingProcess INT = 0 

		DECLARE @TBL_FilterClause TABLE (ID INT IDENTITY(1,1),AttributeValue NVARCHAR(MAX),AttributeCode NVARCHAr(MAX),PimAttributeId INT ,AttributeTypeName VARCHAR(300),AttributeCodeOrg VARCHAR(600))

		DECLARE @WhereClauseXML XML = @WhereClause 

		SET @SQL  = ''

		IF EXISTS (SELECT TOP 1 1 FROM @WhereClauseXml.nodes ( '//ArrayOfWhereClauseModel/WhereClauseModel'  ) AS Tbl(Col) 
		WHERE Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(MAX)')  LIKE  '% in (%')
		BEGIN 
			SET @WorkingProcess = 1

				INSERT INTO @TBL_FilterClause (AttributeValue,AttributeCode,AttributeTypeName,PimAttributeId,AttributeCodeOrg)
			SELECT  Tbl.Col.value ( 'attributevalue[1]' , 'NVARCHAR(MAX)') AS AttributeValue
			,Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(MAX)') AS AttributeValue,ZTY.AttributeTypeName,ZPA.PimAttributeId,AttributeCode AttributeCodeOrg
			FROM @WhereClauseXml.nodes ( '//ArrayOfWhereClauseModel/WhereClauseModel'  ) AS Tbl(Col)
			LEFT JOIN  ZnodePimAttribute ZPA  ON ((Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(MAX)')  LIKE '%in (%' OR dbo.Fn_Trim(REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(MAX)'),' = ',''),'''','')) 
												= ZPA.AttributeCode ) AND IsCategory = 0 
			AND ( ZPA.IsShowOnGrid = 1 OR ZPA.IsConfigurable =1  )  )
			LEFT JOIN ZnodeAttributeType ZTY ON (ZTY.AttributeTypeId = ZPA.AttributeTypeId)

		END 
		ELSE 
		BEGIN 

			INSERT INTO @TBL_FilterClause (AttributeValue,AttributeCode,AttributeTypeName,PimAttributeId,AttributeCodeOrg)
			SELECT  Tbl.Col.value ( 'attributevalue[1]' , 'NVARCHAR(MAX)') AS AttributeValue
			,Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(MAX)') AS AttributeValue,ZTY.AttributeTypeName,ZPA.PimAttributeId,AttributeCode AttributeCodeOrg
			FROM @WhereClauseXml.nodes ( '//ArrayOfWhereClauseModel/WhereClauseModel'  ) AS Tbl(Col)
			LEFT JOIN ZnodePimAttribute ZPA  ON (dbo.Fn_Trim(REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(MAX)'),' = ',''),'''','')) 
												= ZPA.AttributeCode AND ZPA.IsCategory = 0 
			AND ( ZPA.IsShowOnGrid = 1 OR ZPA.IsConfigurable =1  )  )
			LEFT JOIN ZnodeAttributeType ZTY ON (ZTY.AttributeTypeId = ZPA.AttributeTypeId)

		END 

		CREATE TABLE #TBL_PimProductId (PimProductId INT)

		CREATE TABLE #TBL_PimProductIdDelete (PimProductId INT )

		INSERT INTO #TBL_PimProductId (PimProductId )
		SELECT Id 
		FROM @PimProductId

		SELECT ZPAV.PimProductId ,PimAttributeValueId ,ZPAV.CreatedDate,ZPAV.ModifiedDate,TBLA.AttributeCodeOrg AttributeCode
		INTO #TBL_AttributeValueId 
		FROM  ZnodePimAttributeValue ZPAV 
		INNER JOIN @TBL_FilterClause TBLA ON (TBLA.PimAttributeId = ZPAV.PimAttributeId)
		INNER JOIN #TBL_PimProductId YT ON (YT.PimProductId = ZPAV.PimProductId OR NOT EXISTS (SELECT TOP 1 1 #TBL_PimProductId))

		DELETE FROM #TBL_PimProductId

		INSERT INTO #TBL_PimProductId (PimProductId )
		SELECT DISTINCT PimProductId 
		FROM #TBL_AttributeValueId

		IF @WorkingProcess =1 
		BEGIN 
				DECLARE @PimAttributeId_in TransferId 

				INSERT INTO @PimAttributeId_in 
				SELECT PimAttributeId
				FROM  @TBL_FilterClause 
				WHERE AttributeTypeName IN ('Simple Select','Multi Select') 
				AND AttributeCode LIKE '%in (%'

				CREATE TABLE #TBL_AttributeDefaultValue_in ( PimAttributeId INT ,
							AttributeDefaultValueCode VARCHAR(MAX),IsEditable INT,AttributeDefaultValue NVARCHAR(MAX),DisplayOrder INT,PimAttributeDefaultValueId INT,IsDefault Bit  )    
				INSERT INTO #TBL_AttributeDefaultValue_in(PimAttributeId,AttributeDefaultValueCode,IsEditable,AttributeDefaultValue,DisplayOrder,PimAttributeDefaultValueId,IsDefault)
				EXEC Znode_GetAttributeDefaultValueLocaleNew_TansferId @PimAttributeId_in, @LocaleId;
 
				DECLARE @WhereClauseInCom NVARCHAR(MAX) = (SELECT TOP 1 AttributeValue FROM @TBL_FilterClause WHERE AttributeCode LIKE '%in (%') 


			SET @SQL = '
			;With Cte_AttributeValue AS 
			(
			SELECT PimAttributeValueId 
			FROM ZnodePimAttributeValueLocale 
			WHERE AttributeValue '+@WhereClauseInCom+'
			UNION ALL 
			SELECT ZPADV.PimAttributeValueID 
			FROM ZnodePimProductAttributeDefaultValue ZPADV 
			INNER JOIN #TBL_AttributeDefaultValue_in TBL ON (TBL.PimAttributeDefaultValueId = ZPADV.PimAttributeDefaultValueId)
			WHERE TBL.AttributeDefaultValue '+@WhereClauseInCom+'
			)
   
			SELECT PimProductId 
			FROM #TBL_AttributeValueId ZPAV 
			INNER JOIN  Cte_AttributeValue CTAC ON (CTAC.PimAttributeValueId = ZPAV.PimAttributeVaLueId )
			GROUP BY PimProductId
			UNION ALL  
			SELECT PimProductId 
			FROM ZnodePimProduct a
			INNER JOIN ZnodePimFamilyLocale b ON (b.PimAttributeFamilyId = a.PimAttributeFamilyId) 
			WHERE b.AttributeFamilyName '+@WhereClauseInCom+'
			GROUP BY PimProductId
			UNION ALL 
			SELECT  TBLAV.PimProductId 
			FROM ZnodePimProduct TBLAV
			WHERE CASE WHEN TBLAV.IsProductPublish  IS NULL THEN ''Not Published'' 
					WHEN TBLAV.IsProductPublish = 0 THEN ''Draft''
					ELSE  ''Published'' END '+@WhereClauseInCom+'
			GROUP BY TBLAV.PimProductId 
			'
   
			DELETE FROM #TBL_PimProductIdDelete 
			INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
			EXEC (@SQL)
			DELETE FROM #TBL_PimProductId
			INSERT INTO #TBL_PimProductId
			SELECT PimProductId FROM #TBL_PimProductIdDelete
			INSERT INTO #TBL_PimProductId
			SELECT -1 
			WHERE NOT EXISTS (SELECT TOP 1 1  FROM #TBL_PimProductId)

			DELETE  FROM @TBL_FilterClause WHERE AttributeCode LIKE '% in (%'

			DROP TABLE #TBL_AttributeDefaultValue_in
			SET @WorkingProcess  = 0 
   
		END 

		IF EXISTS (SELECT TOP 1 1 FROM @TBL_FilterClause WHERE AttributeCode <> '' AND ISNULL(AttributeValue,'') = '')
		BEGIN 
  
				SET  @InternalProductWhereClause = STUFF( (  SELECT ' INNER JOIN #TBL_AttributeValueId AS ZPAVL'+CAST(ID AS VARCHAR(200))+
												' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
												' )'				
										FROM @TBL_FilterClause
										WHERE ISNULL(AttributeValue,'') = ''
										FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				----Change for configurable product varient page seach
				SET @SQL = ' 
							SELECT  TBLAV.PimProductId 
							FROM #TBL_AttributeValueId TBLAV '+@InternalProductWhereClause+' 
							WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId )
							GROUP BY TBLAV.PimProductId 
						'
  

				DELETE FROM #TBL_PimProductIdDelete 
				INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
				EXEC (@SQL)
				DELETE FROM #TBL_PimProductId
				INSERT INTO #TBL_PimProductId
				SELECT PimProductId FROM #TBL_PimProductIdDelete
				INSERT INTO #TBL_PimProductId
				SELECT -1 
				WHERE NOT EXISTS (SELECT TOP 1 1  FROM #TBL_PimProductId)
				DELETE FROM @TBL_FilterClause WHERE ISNULL(AttributeValue,'') = ''
				IF NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) AND EXISTS (SELECT TOP 1 1  FROM @PimProductId Having Max (ID) = 0 )
				BEGIN
				INSERT INTO  #TBL_PimProductId (PimProductId)
				SELECT 0 
			END
  
		END 

		IF EXISTS (SELECT TOP 1 1 FROM @TBL_FilterClause WHERE AttributeTypeName IN ('Simple Select','Multi Select') )
		BEGIN
			DECLARE @PimAttributeId TransferId 

			INSERT INTO @PimAttributeId 
			SELECT DISTINCT PimAttributeId
			FROM  @TBL_FilterClause WHERE AttributeTypeName IN ('Simple Select','Multi Select') 

			CREATE TABLE #TBL_AttributeDefaultValue ( PimAttributeId INT ,
						AttributeDefaultValueCode VARCHAR(MAX),IsEditable INT,AttributeDefaultValue NVARCHAR(MAX),DisplayOrder INT,PimAttributeDefaultValueId INT,IsDefault BIT  )    
			INSERT INTO #TBL_AttributeDefaultValue(PimAttributeId,AttributeDefaultValueCode,IsEditable,AttributeDefaultValue,DisplayOrder,PimAttributeDefaultValueId,IsDefault)
			EXEC Znode_GetAttributeDefaultValueLocaleNew_TansferId @PimAttributeId, @LocaleId;
 
			IF @DefaultLocaleId = @LocaleID AND  @WorkingProcess = 0 
			BEGIN 

				IF @IsProductNotIn = 1 AND EXISTS(SELECT * FROM @TBL_FilterClause WHERE AttributeCodeOrg = 'Brand')
				BEGIN
					SET  @InternalProductWhereClause = STUFF( (  SELECT ' INNER JOIN Cte_AttributeValue AS ZPAVL'+CAST(ID AS VARCHAR(200))+
													' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
													+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+
													'.LocaleId='+CAST(@LocaleID AS VARCHAR(200))+' )'				
											FROM @TBL_FilterClause
											WHERE AttributeTypeName IN ('Simple Select','Multi Select')
											AND AttributeValue <> ''
											AND AttributeValue IS NOT NULL
											FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				END
				ELSE IF @IsProductNotIn = 0  AND EXISTS(SELECT * FROM @TBL_FilterClause WHERE AttributeCodeOrg <> 'Brand')
				BEGIN
					SET  @InternalProductWhereClause = STUFF( (  SELECT ' INNER JOIN Cte_AttributeValue AS ZPAVL'+CAST(ID AS VARCHAR(200))+
													' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
													+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+
													'.LocaleId='+CAST(@LocaleID AS VARCHAR(200))+' )'				
											FROM @TBL_FilterClause
											WHERE AttributeTypeName IN ('Simple Select','Multi Select')
											AND AttributeValue <> ''
											AND AttributeValue IS NOT NULL
											FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				END
				ELSE
				BEGIN
					SET @InternalProductWhereClause = ''
				END
				
				SET @SQL = ' ;With Cte_AttributeValue AS 
							(
							SELECT TBLAV.PimAttributeValueId ,SUBSTRING((SELECT '',''+AttributeDefaultValue FROM #TBL_AttributeDefaultValue TTR 
							INNER JOIN ZnodePimProductAttributeDefaultValue ZPAVL ON (TTR.PimAttributeDefaultValueId = ZPAVL.PimAttributeDefaultValueId )
							WHERE ZPAVL.PimAttributeValueId = TBLAV.PimAttributeValueId  
							AND ZPAVL.LocaleId = '+Cast(@localeId AS VARCHAR(200))+'
							FOR XML PATH('''') ),2,4000) AttributeValue
								,  '+Cast(@localeId AS VARCHAR(200))+' LocaleId,TBLAV.AttributeCode,TBLAV.PimProductId
							FROM #TBL_AttributeValueId TBLAV
							'+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END+'
							GROUP BY TBLAV.PimAttributeValueId,TBLAV.AttributeCode,TBLAV.PimProductId
							)
  
						SELECT  TBLAV.PimProductId
						FROM #TBL_AttributeValueId TBLAV
						'+@InternalProductWhereClause+'	GROUP BY TBLAV.PimProductId '
			
				
			END 
			ELSE IF  @WorkingProcess = 0 
			BEGIN 

				SET  @InternalProductWhereClause = 
										STUFF( (  SELECT ' INNER JOIN Cte_AttributeValue AS ZPAVL'+CAST(ID AS VARCHAR(200))+
												' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
												' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+'  )'				
										FROM @TBL_FilterClause
										WHERE AttributeTypeName IN ('Simple Select','Multi Select')
										AND AttributeValue <> ''
										AND AttributeValue IS NOT NULL
										FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				SET @SQL = '  			 
							SELECT TBLAV.PimAttributeValueId,ZPAVL.PimAttributeDefaultValueId , ZPAVL.LocaleId ,COUNT(*)Over(Partition By TBLAV.PimAttributeValueId ,TBLAV.PimProductId ORDER BY TBLAV.PimAttributeValueId ,TBLAV.PimProductId  ) RowId
							INTO #temp_Table 
							FROM #TBL_AttributeValueId TBLAV 
							INNER JOIN ZnodePimProductAttributeDefaultValue ZPAVL ON (ZPAVL.PimAttributeValueId = TBLAV.PimAttributeValueId)
							WHERE (ZPAVL.LocaleId = '+Cast(@localeId AS VARCHAR(200))+' OR ZPAVL.LocaleId = '+Cast(@DefaultlocaleId AS VARCHAR(200))+')
				
							;with Cte_AttributeValue AS 
							(
							SELECT TBLAV.PimAttributeValueId ,SUBSTRING((SELECT '',''+AttributeDefaultValue FROM #TBL_AttributeDefaultValue TTR 
							INNER JOIN #temp_Table  ZPAVL ON (TTR.PimAttributeDefaultValueId = ZPAVL.PimAttributeDefaultValueId )
							WHERE ZPAVL.PimAttributeValueId = TBLAV.PimAttributeValueId  
							AND ZPAVL.LocaleId = CASE WHEN ZPAVL.RowId = 2 THEN '+CAST(@LocaleId AS Varchar(300))+' ELSE '+Cast(@DefaultLocaleId AS Varchar(300))+' END  
							FOR XML PATH('''') ),2,4000) AttributeValue,TBLAV.AttributeCode ,TBLAV.PimProductId 
							FROM #TBL_AttributeValueId TBLAV
							'+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END+'
							GROUP BY TBLAV.PimAttributeValueId,TBLAV.AttributeCode ,TBLAV.PimProductId 
							)
  
							SELECT   TBLAV.PimProductId
							FROM  #TBL_AttributeValueId TBLAV
							'+@InternalProductWhereClause+'	GROUP BY TBLAV.PimProductId '

			END 

			DELETE FROM #TBL_PimProductIdDelete 
			INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
			EXEC (@SQL)
			DELETE FROM #TBL_PimProductId
			INSERT INTO #TBL_PimProductId
			SELECT PimProductId FROM #TBL_PimProductIdDelete
 
			DROP TABLE #TBL_AttributeDefaultValue

		END 

		IF EXISTS (SELECT TOP 1 1 FROM @TBL_FilterClause WHERE AttributeTypeName IN ('Text','Number','Datetime','Yes/No','Date') )
		BEGIN  
   
				IF @DefaultLocaleId = @LocaleID AND @WorkingProcess = 0 
				BEGIN 
					SET  @InternalProductWhereClause = 
											STUFF( (  SELECT ' INNER JOIN View_PimProducttextValue AS ZPAVL'+CAST(ID AS VARCHAR(200))+
													' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
													' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+
													'.LocaleId='+CAST(@LocaleID AS VARCHAR(200))+' )'				
											FROM @TBL_FilterClause
											WHERE AttributeTypeName IN ('Text','Number','Datetime','Yes/No','Date')
											FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
 
					SET @SQL = '	SELECT  TBLAV.PimProductId 
								FROM #TBL_AttributeValueId TBLAV
								'+@InternalProductWhereClause+'
								'+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
											ELSE ' WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId   ) ' END 
								+' GROUP BY TBLAV.PimProductId '

			END 
			ELSE IF @WorkingProcess = 0 
			BEGIN 
				SET  @InternalProductWhereClause = 
										STUFF( (  SELECT ' INNER JOIN Cte_AttributeDetails AS ZPAVL'+CAST(ID AS VARCHAR(200))+
												' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
												' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+
												'.LocaleId = CASE WHEN ZPAVL'+CAST(ID AS VARCHAR(200))+'.RowId = 2 THEN  '+CAST(@LocaleId AS Varchar(300))+' ELSE '+Cast(@DefaultLocaleId AS Varchar(300))+' END  )'				
										FROM @TBL_FilterClause
										WHERE AttributeTypeName IN ('Text','Number','Datetime','Yes/No','Date')
										FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				SET @SQL = ' 
					;With Cte_AttributeDetails AS 
					(
					SELECT TBLAV.PimProductId,ZPAVL.AttributeValue,TBLAV.AttributeCode,ZPAVL.LocaleId ,COUNT(*)Over(Partition By TBLAV.PimProductId,TBLAV.AttributeCode ORDER BY TBLAV.PimProductId,TBLAV.AttributeCode  ) RowId
					FROM #TBL_AttributeValueId TBLAV 
					INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON (ZPAVL.PimAttributeValueId = TBLAV.PimAttributeValueId )
					WHERE (LocaleId = '+Cast(@DefaultLocaleId AS Varchar(300))+' OR LocaleId = '+CAST(@LocaleId AS Varchar(300))+' )'+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' AND EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END +'
					) 
					SELECT  TBLAV.PimProductId 
  					FROM #TBL_AttributeValueId TBLAV
					'+@InternalProductWhereClause+'
					GROUP BY TBLAV.PimProductId 
					'
			END 
			DELETE FROM #TBL_PimProductIdDelete 
			INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
			EXEC (@SQL)
			DELETE FROM #TBL_PimProductId
			INSERT INTO #TBL_PimProductId
			SELECT PimProductId FROM #TBL_PimProductIdDelete

		END 

		IF EXISTS (SELECT TOP 1 1 FROM @TBL_FilterClause WHERE AttributeTypeName IN ('Text Area') )
		BEGIN    
			IF @DefaultLocaleId = @LocaleID AND @WorkingProcess = 0 
			BEGIN 
				SET  @InternalProductWhereClause = 
											STUFF( (  SELECT ' INNER JOIN View_PimProductTextAreaValue AS ZPAVL'+CAST(ID AS VARCHAR(200))+
												' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
												' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+
												'.LocaleId='+CAST(@LocaleID AS VARCHAR(200))+' )'				
										FROM @TBL_FilterClause
										WHERE AttributeTypeName IN ('Text Area')
										FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
 
				SET @SQL = '
							SELECT  TBLAV.PimProductId 
							FROM #TBL_AttributeValueId TBLAV
							'+@InternalProductWhereClause+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END 
										+' GROUP BY TBLAV.PimProductId '
			END 
			ELSE IF @WorkingProcess = 0 
			BEGIN 
				SET  @InternalProductWhereClause = 
										STUFF( (  SELECT ' INNER JOIN Cte_AttributeDetails AS ZPAVL'+CAST(ID AS VARCHAR(200))+
												' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
												' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+
												'.LocaleId = CASE WHEN ZPAVL'+CAST(ID AS VARCHAR(200))+'.RowId = 2 THEN  '+CAST(@LocaleId AS Varchar(300))+' ELSE '+Cast(@DefaultLocaleId AS Varchar(300))+' END  )'				
										FROM @TBL_FilterClause
										WHERE AttributeTypeName IN ('Text Area')
										FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				SET @SQL = ' 
					;With Cte_AttributeDetails AS 
					(
					SELECT TBLAV.PimProductId,TBLAV.AttributeCode,ZPAVL.AttributeValue,ZPAVL.LocaleId ,COUNT(*)Over(Partition By TBLAV.PimProductId,TBLAV.AttributeCode ORDER BY TBLAV.PimProductId,TBLAV.AttributeCode  ) RowId
					FROM #TBL_AttributeValueId TBLAV 
					INNER JOIN ZnodePimProductAttributeTextAreaValue ZPAVL ON (ZPAVL.PimAttributeValueId = TBLAV.PimAttributeValueId )
					WHERE (LocaleId = '+Cast(@DefaultLocaleId AS Varchar(300))+' OR LocaleId = '+CAST(@LocaleId AS Varchar(300))+' )
	 
					) 
					SELECT  TBLAV.PimProductId 
  					FROM #TBL_AttributeValueId TBLAV
					'+@InternalProductWhereClause+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END 
										+' 
										GROUP BY TBLAV.PimProductId 	
										'
				END 
			DELETE FROM #TBL_PimProductIdDelete 
			INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
			EXEC (@SQL)
			DELETE FROM #TBL_PimProductId
			INSERT INTO #TBL_PimProductId
			SELECT PimProductId FROM #TBL_PimProductIdDelete

		END 
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_FilterClause WHERE AttributeCode  LIKE '%PublishStatus%' )
		BEGIN    
 
				SET @SQL = '
							SELECT  TBLAV.PimProductId 
							FROM ZnodePimProduct TBLAV
							WHERE CASE WHEN TBLAV.IsProductPublish  IS NULL THEN ''Not Published'' 
							WHEN TBLAV.IsProductPublish = 0 THEN ''Draft''
							ELSE  ''Published'' END '+(SELECT TOP 1 AttributeValue FROM @TBL_FilterClause WHERE AttributeCode LIKE '%PublishStatus%')+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' AND EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END 
										+' GROUP BY TBLAV.PimProductId '
  
				DELETE FROM #TBL_PimProductIdDelete 
				INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
				EXEC (@SQL)
				DELETE FROM #TBL_PimProductId
				INSERT INTO #TBL_PimProductId
				SELECT PimProductId FROM #TBL_PimProductIdDelete

		END 
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_FilterClause WHERE AttributeCode  LIKE '%AttributeFamily%' )
		BEGIN 

				;With Cte_attributeValue AS 
				(
					SELECT ZPAF.PimAttributeFamilyId,FamilyCode,AttributeFamilyName ,ZPFL.LocaleId
					FROM ZnodePimAttributeFamily ZPAF
					INNER JOIN ZnodePimFamilyLocale ZPFL ON (ZPFL.PimAttributeFamilyId = ZPAF.PimAttributeFamilyId) 
					WHERE ZPFL.LocaleId IN (@DefaultLocaleId,@LocaleId)
				) 
				, Cte_AttributeValueAttribute AS 
				(
					SELECT PimAttributeFamilyId,FamilyCode,AttributeFamilyName
					FROM Cte_attributeValue RTY 
					WHERE LocaleId = @LocaleId
				)
				, Cte_AttributeValueTht AS 
				(
					SELECT PimAttributeFamilyId,FamilyCode,AttributeFamilyName
					FROM Cte_AttributeValueAttribute
					UNION ALL 
					SELECT PimAttributeFamilyId,FamilyCode,AttributeFamilyName
					FROM Cte_attributeValue TYY  
					WHERE NOT EXISTS (SELECT TOP 1 1 FROM Cte_AttributeValueAttribute THE WHERE THE.PimAttributeFamilyId = TYY.PimAttributeFamilyId )
					AND TYY.LocaleId = @DefaultLocaleId
				)
				SELECT PimAttributeFamilyId,FamilyCode,AttributeFamilyName
				INTO #TBL_FamilyLocale
				FROM Cte_AttributeValueTht 


				SET @SQL = '
							SELECT  TBLAV.PimProductId 
							FROM ZnodePimProduct TBLAV 
							INNER JOIN #TBL_FamilyLocale THY ON (THY.PimAttributeFamilyId = TBLAV.PimAttributeFamilyId )
							WHERE AttributeFamilyName '+(SELECT TOP 1 AttributeValue FROM @TBL_FilterClause WHERE AttributeCode LIKE '%AttributeFamily%')+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' AND EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END 
										+' GROUP BY TBLAV.PimProductId '
  

			DELETE FROM #TBL_PimProductIdDelete 
			INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
			EXEC (@SQL)
			DELETE FROM #TBL_PimProductId
			INSERT INTO #TBL_PimProductId
			SELECT PimProductId FROM #TBL_PimProductIdDelete

		END 
	
		SET @SQL = '
		IF EXISTS ( SELECT TOP 1 1 FROM tempdb..sysobjects WHERE name = ''##Temp_PimProductId'+CAST(@@SPID AS VARCHAR(500))+''' )
		BEGIN 
			DROP TABLE ##Temp_PimProductId'+CAST(@@SPID AS VARCHAR(500))+'
		END 
		CREATE TABLE ##Temp_PimProductId'+CAST(@@SPID AS VARCHAR(500))+' (PimProductId INT )
		INSERT INTO  ##Temp_PimProductId'+CAST(@@SPID AS VARCHAR(500))+'
		SELECT PimProductId 
		FROM #TBL_PimProductId
		'
		EXEC (@SQL)
		DROP TABLE #TBL_PimProductId
		DROP TABLE #TBL_AttributeValueId
		DROP TABLE #TBL_PimProductIdDelete
 END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ManageProductList_XML')
	DROP PROC Znode_ManageProductList_XML

GO	 

CREATE  PROCEDURE [dbo].[Znode_ManageProductList_XML]
(   @WhereClause						 XML,
    @Rows								 INT           = 100,
    @PageNo								 INT           = 1,
    @Order_BY			 VARCHAR(1000) = '',
    @LocaleId			 INT           = 1,
    @PimProductId		 VARCHAR(2000) = 0,
    @IsProductNotIn	 BIT           = 0,
	@IsCallForAttribute BIT		   = 0,
	@AttributeCode      VARCHAR(max ) = '' ,
	@PimCatalogId   INT = 0,
	@IsCatalogFilter   BIT            = 0,
	@IsDebug            Bit		   = 0 )
AS
    
/*
		  Summary:-   This Procedure is used for get product List  
				    Procedure will pivot verticle table(ZnodePimattributeValues) into horizontal table with columns 
				    ProductId,ProductName,ProductType,AttributeFamily,SKU,Price,Quantity,IsActive,ImagePath,Assortment,LocaleId,DisplayOrder
        
		  Unit Testing
		  
exec Znode_ManageProductList_XML @WhereClause=N'',@Rows=50,@PageNo=1,@Order_By=N'',@LocaleId=1,@PimProductId=N'',@IsProductNotIn=1,@IsCallForAttribute=0,@AttributeCode=''
          select * from ZnodeAttributeType  WHERE AttributeValue LIKE '%&%'
		  UPDATE VieW_lOADMANAGEpRODUCT SET  AttributeValue = 'A & B'  WHERE AttributeValue LIKE '% and %' AND PimProductId = 158
    */

     BEGIN
         SET NOCOUNT ON;
         BEGIN TRY
		 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
             DECLARE @PimProductIds TransferId, --VARCHAR(MAX), 
					 @FirstWhereClause NVARCHAR(MAX)= '', 
					 @SQL NVARCHAR(MAX)= '' ,
					 @OutPimProductIds VARCHAR(max),
					 @ProductXML NVARCHAR(max) ;

             DECLARE @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId()
					 ,@RowsCount INT =0 ;
             DECLARE @TransferPimProductId TransferId 
			 DECLARE @TBL_AttributeDefaultValue TABLE
             (PimAttributeId            INT,
              AttributeDefaultValueCode VARCHAR(100),
              IsEditable                BIT,
              AttributeDefaultValue     NVARCHAR(MAX)
			  ,DisplayOrder INT 
			  ,PimAttributedefaultValueId INT 
             );
             DECLARE @TBL_AttributeDetails AS TABLE
             (PimProductId   INT,
              AttributeValue NVARCHAR(MAX),
              AttributeCode  VARCHAR(600),
              PimAttributeId INT,
			  AttributeDefaultValue NVARCHAR(MAX)
             );
			 Create table #TBL_AttributeDetailsLocale
             (PimProductId   INT,
              AttributeValue NVARCHAR(MAX),
              AttributeCode  VARCHAR(600),
              PimAttributeId INT
             );
			 DECLARE @TBL_MultiSelectAttribute TABLE (PimAttributeId INT , AttributeCode VARCHAR(600))
			
			 DECLARE @TBL_MediaAttribute TABLE (Id INT ,PimAttributeId INT ,AttributeCode VARCHAR(600) )
			 
			 DECLARE @TBL_ProductIds TABLE 
			 (
			  PimProductId INT,
			  ModifiedDate DATETIME  
			 )

			 DECLARE @FamilyDetails TABLE
             (
			  PimProductId         INT,
              PimAttributeFamilyId INT,
              FamilyName           NVARCHAR(Max)
             );
             DECLARE @DefaultAttributeFamily INT= dbo.Fn_GetDefaultPimProductFamilyId();
             DECLARE @ProductIdTable TABLE
             (PimProductId INT,
              CountId      INT,
              RowId        INT IDENTITY(1,1)
             );
          		
             IF EXISTS ( SELECT TOP 1 1 FROM @WhereClause.nodes ( '//ArrayOfWhereClauseModel/WhereClauseModel'  ) AS Tbl(Col)
			 WHERE LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''',''))))  =  'Brand'
                OR LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''','')))) = 'Vendor'
                OR LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''',''))))  =  'ShippingCostRules'
                OR LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''','')))) =  'Highlights') and @IsCallForAttribute=1
                 BEGIN
                DECLARE @AttributeCodeValue TABLE (AttributeValue NVARCHAr(max),AttributeCode NVARCHAR(max))

				INSERT INTO @AttributeCodeValue(AttributeValue,AttributeCode)
				SELECT  Tbl.Col.value ( 'attributevalue[1]' , 'NVARCHAR(max)') AS AttributeValue
						 ,Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)') AS AttributeCode
				FROM @WhereClause.nodes ( '//ArrayOfWhereClauseModel/WhereClauseModel'  ) AS Tbl(Col)
				WHERE LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''',''))))  =  'Brand'
                OR LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''',''))))  = 'Vendor'
                OR LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''',''))))  =  'ShippingCostRules'
                OR LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''',''))))  =  'Highlights'
		
				SET @SQL =   
				           ';WIth Cte_DefaultValue AS (
										  SELECT AttributeDefaultValueCode , ZPDF.PimAttributeId ,FNPA.AttributeCode
										  FROM ZnodePImAttributeDefaultValue ZPDF
										  INNER JOIN [dbo].[Fn_GetProductDefaultFilterAttributes] () FNPA ON ( FNPA.PimAttributeId = ZPDF.PimAttributeId) 
										)
										, Cte_productIds AS 
										(
										  SELECT a.PimProductId, c.AttributeCode , CTDV.AttributeDefaultValueCode AttributeValue,b.ModifiedDate 
										  FROM  ZnodePimAttributeValue a
										  LEFT JOIN ZnodePimAttribute c ON(c.PimAttributeId = a.PimAttributeId)
										  LEFT JOIN ZnodePimAttributeValueLocale b ON(b.PimAttributeValueId = a.PimAttributeValueId)  
										  INNER JOIN Cte_DefaultValue CTDV ON (CTDV.AttributeCode = c.AttributeCode 
										  AND EXISTS (SELECT TOP 1 1 FROM dbo.split(b.AttributeValue,'','') SP WHERE SP.Item = CTDV.AttributeDefaultValueCode) )
										  Union all 
										  
											SELECT a.PimProductId,c.AttributeCode,ZPADV.AttributeDefaultValueCode AttributeValue ,a.ModifiedDate 
											FROM ZnodePimProductAttributeDefaultValue ZPPADV
											INNER JOIN ZnodePimAttributeDefaultValue ZPADV ON (ZPPADV.PimAttributeDefaultValueId = ZPADV.PimAttributeDefaultValueId)
											LEFT JOIN ZnodePimAttributeValue a ON (a.PimAttributeValueId = ZPPADV.PimAttributeValueId )
											LEFT JOIN ZnodePimAttribute c ON ( c.PimAttributeId=a.PimAttributeId )
											INNER JOIN Cte_DefaultValue CTDV ON (CTDV.AttributeCode = c.AttributeCode )
										)										
										SELECT PimProductId ,ModifiedDate
										FROM Cte_productIds WHERE  AttributeCode '+(SELECT TOP 1 AttributeCode  FROM @AttributeCodeValue )+' AND 
										AttributeValue '+(SELECT TOP 1 AttributeValue  FROM @AttributeCodeValue )+' 
										GROUP BY PimProductId,ModifiedDate Order By ModifiedDate DESC ';


					 SET @Order_BY = CASE WHEN @Order_BY = '' THEN 'ModifiedDate DESC' ELSE @Order_BY END 
					 	
					 SET @WhereClause = CAST(REPLACE(CAST(@WhereClause AS NVARCHAR(max)),'<WhereClauseModel><attributecode>'+(SELECT TOP 1 AttributeCode  FROM @AttributeCodeValue )+'</attributecode><attributevalue>'+(SELECT TOP 1 AttributeValue   FROM @AttributeCodeValue )+'</attributevalue></WhereClauseModel>','') AS XML )
					
				     INSERT INTO @TBL_ProductIds ( PimProductId, ModifiedDate )
					 EXEC (@SQL);
			  					 
					
						 INSERT INTO @ProductIdTable( PimProductId )
						 SELECT PimProductId 
						 FROM @TBL_ProductIds
					

                     INSERT INTO @TransferPimProductId
					 SELECT PimProductId
                     FROM @ProductIdTable
                   
				   			  
     DELETE FROM @ProductIdTable;
   --  SET @WhereClause = CAST(REPLACE(CAST(@WhereClause AS NVARCHAR(MAX)), @FirstWhereClause, ' 1 = 1') AS XML);
                 END
	            ELSE IF @PimProductId <> ''
			    BEGIN 
		
				 INSERT INTO @TransferPimProductId(id)
				 SELECT Item 
				 FROM dbo.split(@PimProductId,',')
			    END 
		
			
	 DECLARE  @ProductListIdRTR TransferId
	 DECLARE @TAb Transferid 
	 --DECLARE @tBL_mainList TABLE (Id INT,RowId INT)
	 Create table #TBL_ProductMainList (Id INT,RowId INT)

	 	IF @PimProductId <> ''  OR   @IsCallForAttribute=1 --OR (CAST(@WhereClause AS NVARCHAR(max))= N'' AND @Order_by <> N'' AND @AttributeCode = N'')
		BEGIN 
	 SET @IsProductNotIn = CASE WHEN @IsProductNotIn = 0 THEN 1  
					 WHEN @IsProductNotIn = 1 THEN 0 END 
		END 
	
	 INSERT INTO @ProductListIdRTR
	 EXEC Znode_GetProductList  @IsProductNotIn,@TransferPimProductId, @PimCatalogId,@IsCatalogFilter
 
	 IF CAST(@WhereClause AS NVARCHAR(max))<> N''
	 BEGIN 
	 
	  SET @SQL = 'SELECT Distinct PimProductId FROM ##Temp_PimProductId'+CAST(@@SPID AS VARCHAR(500))

	  EXEC Znode_GetFilterPimProductId @WhereClause,@ProductListIdRTR,@localeId,@IsProductNotIn
	  
      INSERT INTO @TAB 
	  EXEC (@SQL)
	 
	 END 
	 
	

	 IF EXISTS (SELECT Top 1 1 FROM @TAb ) OR CAST(@WhereClause AS NVARCHAR(max)) <> N''
	 BEGIN 
	 
	 SET @AttributeCode = REPLACE(dbo.FN_TRIM(REPLACE(REPLACE(@order_by,' DESC',''),' ASC','')),'DisplayOrder','ProductName')
	 SET @order_by = REPLACE(@order_by,'DisplayOrder','ProductName')
	 INSERT INTO #TBL_ProductMainList(id,RowId)
	 EXEC Znode_GetOrderByPagingProduct @order_by,@rows,@PageNo, @TAb ,@AttributeCode,@localeId
	 
	 END 
	 ELSE 
	 BEGIN
	      
	 SET @AttributeCode = REPLACE(dbo.FN_TRIM(REPLACE(REPLACE(@order_by,' DESC',''),' ASC','')),'DisplayOrder','ProductName')
	 SET @order_by = REPLACE(@order_by,'DisplayOrder','ProductName')
	 INSERT INTO #TBL_ProductMainList(id,RowId)
	 EXEC Znode_GetOrderByPagingProduct @order_by,@rows,@PageNo, @ProductListIdRTR ,@AttributeCode,@localeId 
	 END 
          

  			 INSERT INTO @PimProductIds ( Id  )
			 SELECT DISTINCT id FROM #TBL_ProductMainList

			 DECLARE @TBL_PimProductIds transferId 
			 INSERT INTO @TBL_PimProductIds
			 SELECT id 
             FROM @PimProductIds
			 			 	
			 DECLARE @PimAttributeIds TransferId  
			 INSERT INTO @PimAttributeIds
			 SELECT PimAttributeId  
			 FROM [dbo].[Fn_GetProductGridAttributes]()
			 
			

			 INSERT INTO @TBL_AttributeDetails
             (PimProductId,
              AttributeValue,
              AttributeCode,
              PimAttributeId,
			  AttributeDefaultValue
             )
             EXEC Znode_GetProductsAttributeValue_newTesting
                  @TBL_PimProductIds,
                  @PimAttributeIds,
                  @localeId;
			
			
			UPDATE @TBL_AttributeDetails
			SET AttributeValue = ISNULL(AttributeValue,'')
			WHERE AttributeValue IS NULL 

----------------------------------------------------------------------------------------------------

			

		    declare @SKU SelectColumnList
			declare @TBL_Inventorydetails table (Quantity NVARCHAR(MAx),PimProductId INT)

			INSERT INTO @SKU
			SELECT AttributeValue 
			FROM @TBL_AttributeDetails
			WHERE AttributeCode = 'SKU'
 
 			INSERT INTO @TBL_Inventorydetails(Quantity,PimProductId)
			EXEC Znode_GetPimProductAttributeInventory @SKU--vishal

			 INSERT INTO @FamilyDetails
             (PimAttributeFamilyId,
              PimProductId
             )
             EXEC [dbo].[Znode_GetPimProductAttributeFamilyId]
                  @PimProductIds,
                  1;
             
		 UPDATE a
               SET
                   FamilyName = b.AttributeFamilyName
             FROM @FamilyDetails a
                  INNER JOIN ZnodePimFamilyLocale b ON(a.PimAttributeFamilyId = b.PimAttributeFamilyId
                                                       AND LocaleId = @LocaleId);
             UPDATE a
               SET
                   FamilyName = b.AttributeFamilyName
             FROM @FamilyDetails a
                  INNER JOIN ZnodePimFamilyLocale b ON(a.PimAttributeFamilyId = b.PimAttributeFamilyId
                                                       AND LocaleId = @DefaultLocaleId)
             WHERE a.FamilyName IS NULL
                   OR a.FamilyName = '';
           	
			INSERT INTO @TBL_AttributeDetails             (PimProductId,              AttributeValue,              AttributeCode,              PimAttributeId             )
			SELECT PimProductId ,FamilyName, 'AttributeFamily',NULL
			FROM @FamilyDetails 
			
			INSERT INTO @TBL_AttributeDetails             (PimProductId,              AttributeValue,              AttributeCode,              PimAttributeId             )
			SELECT a.ID PimProductId ,th.DisplayName, 'PublishStatus',NULL
			FROM @PimProductIds a 
			INNER JOIN ZnodePimProduct b ON (b.PimProductId = a.ID)
			LEFT JOIN ZnodePublishState th ON (th.PublishStateId = b.PublishStateId)

	  INSERT INTO #TBL_AttributeDetailsLocale (PimProductId ,PimAttributeId,AttributeCode )
			SELECT  TBLAD.PimProductId ,TBLAD.PimAttributeId,TBLAD.AttributeCode 
			FROM @TBL_AttributeDetails TBLAD 
			GROUP BY  TBLAD.PimProductId ,TBLAD.PimAttributeId,TBLAD.AttributeCode 
       					

	    UPDATE TBLPP 
		SET AttributeValue = CTDD.AttributeValue 
		FROM  @TBL_AttributeDetails CTDD 
		INNER JOIN #TBL_AttributeDetailsLocale TBLPP ON (TBLPP.PimProductId = CTDD.PimProductId AND TBLPP.AttributeCode  = CTDD.AttributeCode)
		WHERE TBLPP.AttributeValue IS NULL 

    	SET @ProductXML =  '<MainProduct>'+ STUFF( (  SELECT '<Product>'+'<PimProductId>'+CAST(TBAD.PimProductId AS VARCHAR(50))+'</PimProductId>'
																		+'<AvailableInventory>'+CAST(ISNULL(IDD.[Quantity],'') AS VARCHAR(50))+'</AvailableInventory>'
		+ STUFF(    (  SELECT '<'+TBADI.AttributeCode+'>'+CAST( (SELECT  ''+TBADI.AttributeValue FOR XML PATH('')) AS NVARCHAR(max))+'</'+TBADI.AttributeCode+'>'   
															FROM #TBL_AttributeDetailsLocale TBADI      
															 WHERE TBADI.PimProductId = TBAD.PimProductId 
															 ORDER BY TBADI.PimProductId DESC
															 FOR XML PATH (''), TYPE
																).value('.', ' Nvarchar(max)'), 1, 0, '')+'</Product>'	   

		FROM #TBL_AttributeDetailsLocale TBAD
		INNER JOIN #TBL_ProductMainList TBPI ON (TBAD.PimProductid = TBPI.id )
		LEFT JOIN @TBL_ProductIds TPT ON TBAD.PimProductId = TPT.PimProductId
		LEFT JOIN @TBL_InventoryDetails IDD ON (TBPI.id = IDD.PimProductId)
		GROUP BY TBAD.pimProductid, TPT.ModifiedDate,TBPI.RowId,IDD.Quantity
		ORDER BY TBPI.RowId 
		FOR XML PATH (''),TYPE).value('.', ' Nvarchar(max)'), 1, 0, '')+'</MainProduct>'
			--FOR XML PATH ('MainProduct'))
 

			SELECT  CAST(@ProductXML AS XML ) ProductXMl
		   
		     SELECT AttributeCode ,  ZPAL.AttributeName
			 FROM ZnodePimAttribute ZPA 
			 LEFT JOIN ZnodePiMAttributeLOcale ZPAL ON (ZPAL.PimAttributeId = ZPA.PimAttributeId )
             WHERE LocaleId = 1  
			 AND  IsCategory = 0 
			 AND ZPA.IsShowOnGrid = 1  
			 UNION ALL 
			 SELECT 'PublishStatus','Publish Status'

     IF EXISTS (SELECT Top 1 1 FROM @TAb )
	 BEGIN 

		  SELECT (SELECT COUNT(1) FROM @TAb) AS RowsCount   
	 END 
	 ELSE 
	 BEGIN
	 		  SELECT (SELECT COUNT(1) FROM @ProductListIdRTR) AS RowsCount   
	 END 
		;

             -- find the all locale values 
         END TRY
         BEGIN CATCH
		    SELECT ERROR_MESSAGE()
                DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ManageProductList_XML @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@LocaleId = '+CAST(@LocaleId AS VARCHAR(50))+',@PimProductId='+@PimProductId+',@IsProductNotIn='+CAST(@IsProductNotIn AS VARCHAR(50))+',@IsCallForAttribute='+CAST(@IsCallForAttribute AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_ManageProductList_XML',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;

         END CATCH;

     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishAssociatedAddonsJson')
	DROP PROC Znode_GetPublishAssociatedAddonsJson

GO

CREATE PROCEDURE [dbo].[Znode_GetPublishAssociatedAddonsJson]
(
	@PublishCatalogId NVARCHAR(MAX) = 0,
	@PimProductId    TransferId Readonly,
	@VersionId        INT           = 0,
	@UserId           INT,														 
	@PimCategoryHierarchyId int = 0, 
	@LocaleId       TransferId READONLY,
	@PublishStateId INT = 0, 
	@VersionIdString  VARCHAR(100)= '',
	@Status		   Bit  OutPut,
	@RevisionType Varchar(50)
)
AS 
   
/*
    Summary : If PimcatalogId is provided get all products with Addons and provide above mentioned data
              If PimProductId is provided get all Addons if associated with given product id and provide above mentioned data
    			Input: @PublishCatalogId or @PimProductId
    		    output should be in XML format
              sample xml5
    Begin transaction  
	 declare  @PimProductId TransferId 
	 Declare @Status bit 
	 insert into @PimProductId  values (768)

			Exec [_Znode_GetPublishAssociatedAddonsJson]
				@PublishCatalogId = 0 ,
				@PimProductId   = @PimProductId,
				@UserId =2,														 
				@VersionIdString = '',--'1662,1664,1663,1665',
				@Status	 =@Status Out,
				@RevisionType= 'Production'
				rollback transaction
				--select * from ZnodePublishVersionEntity 
   
	*/

BEGIN
    BEGIN TRY
    SET NOCOUNT ON 
		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
        DECLARE @LocaleIdIn INT, @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId()
		, @Counter INT= 1
		, @MaxRowId INT= 0;

    -- DECLARE @PimAddOnGroupId VARCHAR(MAX);

		CREATE TABLE #TBL_PublisshIds  (PublishProductId INT , PimProductId INT , PublishCatalogId INT)
		DECLARE @TBL_LocaleId TABLE (RowId    INT IDENTITY(1, 1),LocaleId INT);
		IF OBJECT_ID('tempdb..#VesionIds') is not null
		DROP TABLE #VesionIds
		Create Table #VesionIds(ZnodeCatalogId int , VersionId int , LocaleId int , RevisionType varchar(50) )

  		If @VersionIdString <> ''
		BEGIN
			Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)	
			SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType
			FROM ZnodePublishVersionEntity PV Inner join Split(@VersionIdString,',') S ON PV.VersionId = S.Item
		END
		Else 
		Begin
			If  (@RevisionType like '%Preview%'  OR @RevisionType like '%Production%')
			BEGIN
				Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)	
				SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV  where PV.IsPublishSuccess =1 
				AND PV.RevisionType ='Preview'
			END
			If  (@RevisionType like '%Production%' OR @RevisionType = 'None')
			BEGIN
				Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)	
				SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV  where PV.IsPublishSuccess =1 
				AND PV.RevisionType ='Production'
			END					
		End 

		IF (@PublishCatalogId IS NULL OR @PublishCatalogId = 0)
		BEGIN 
			INSERT INTO #TBL_PublisshIds 
			EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId,@userid,@PimProductId,1
		END 
		IF ISnull(@PimCategoryHierarchyId,0) <> 0 
		BEGIN 
			INSERT INTO #TBL_PublisshIds 
			EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId,@userid,@PimProductId,1,@PimCategoryHierarchyId 
		END 

		CREATE TABLE #TBL_PublishCatalogId (PublishCatalogId INT,PublishProductId INT,PimProductId  INT , VersionId INT ,LocaleId INT  );

		IF  ISnull(@PimCategoryHierarchyId,0) <> 0 
		BEGIN 
			INSERT INTO #TBL_PublishCatalogId 
			SELECT ZPP.PublishCatalogId , ZPP.PublishProductId,PimProductId, MAX(ZPCP.PublishCatalogLogId)  ,LocaleId 
			FROM ZnodePublishProduct ZPP 
			INNER JOIN ZnodePublishCatalogLog ZPCP ON (ZPCP.PublishCatalogId  = ZPP.PublishCatalogId)
			WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId   ) 
			AND ZPCP.Publishstateid = @PublishStateId
			GROUP BY ZPP.PublishCatalogId,ZPP.PublishProductId,PimProductId,LocaleId 
		END 
		ELSE 
		Begin
			INSERT INTO #TBL_PublishCatalogId  
			SELECT ZPP.PublishCatalogId , ZPP.PublishProductId,PimProductId,0  VersionId  ,0 LocaleId 
			FROM ZnodePublishProduct ZPP  
			WHERE EXISTS  (SELECT TOP 1 1 FROM #VesionIds ZPCP WHERE (ZPCP.ZnodeCatalogId  = ZPP.PublishCatalogId)) AND
			(EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId  
			AND  @PublishCatalogId = '0' )  OR (ZPP.PublishCatalogId =  @PublishCatalogId ))
		END
        DECLARE @TBL_AddonGroupLocale TABLE( PimAddonGroupId INT, DisplayType NVARCHAR(400),AddonGroupName NVARCHAR(MAX),LocaleId INT );
        INSERT INTO @TBL_LocaleId(LocaleId)
        SELECT LocaleId FROM ZnodeLocale MT  WHERE IsActive = 1 AND (EXISTS (SELECT TOP 1 1  FROM @LocaleId RT WHERE RT.Id = MT.LocaleId )
			OR NOT EXISTS (SELECT TOP 1 1 FROM @LocaleId ));
        SET @MaxRowId = ISNULL(( SELECT MAX(RowId) FROM @TBL_LocaleId ), 0);
    
        WHILE (@Counter <= @MaxRowId)
        BEGIN
            SET @LocaleIdIn =( SELECT LocaleId FROM @TBL_LocaleId WHERE RowId = @Counter );
            INSERT INTO @TBL_AddonGroupLocale (PimAddonGroupId, DisplayType, AddonGroupName)
            EXEC Znode_GetAddOnGroupLocale '', @LocaleIdIn;
	   		UPDATE @TBL_AddonGroupLocale SET LocaleId = @LocaleIdIn WHERE LocaleId IS NULL 
            SET @Counter = @Counter + 1;
        END;
		
		IF OBJECT_ID('tempdb..#AddonProductPublishedXML') is not null
		drop table #AddonProductPublishedXML
						
		SELECT  ZPPP.PublishProductId,ZPPP.PublishCatalogId,V.LocaleId,v.VersionId,
		ZPPP.[PublishProductId]  ZnodeProductId,
		ZPPP.[PublishCatalogId] ZnodeCatalogId,
		ZPP.PublishProductId  AssociatedZnodeProductId,
		ZPAOP.DisplayOrder DisplayOrder,
		ZPOPD.DisplayOrder AssociatedProductDisplayOrder,
		RequiredType ,
		DisplayType, 
		ISNULL((select ''+AddonGroupName for xml path('')),'') GroupName,
		ISnull(IsDefault,0) IsDefault
		INTO #AddonProductPublishedXML
		FROM [ZnodePimAddOnProductDetail] AS ZPOPD
		INNER JOIN [ZnodePimAddOnProduct] AS ZPAOP ON ZPOPD.[PimAddOnProductId] = ZPAOP.[PimAddOnProductId]
		INNER JOIN #TBL_PublishCatalogId ZPPP ON (ZPPP.PimProductId = ZPAOP.PimProductId )
		INNER JOIN #TBL_PublishCatalogId ZPP ON(ZPP.PimProductId = ZPOPD.[PimChildProductId] AND ZPP.PublishCatalogId = ZPPP.PublishCatalogId  )
		INNER JOIN #VesionIds V ON ZPPP.PublishCatalogId  = V.ZnodeCataLogId
		INNER JOIN @TBL_AddonGroupLocale TBAG ON (TBAG.PimAddonGroupId   = ZPAOP.PimAddonGroupId AND TBAG.LocaleId = V.LocaleId )
					
		If (isnull(@PublishCatalogId ,'') = '' and @VersionIdString = '') OR 
			(isnull(@PublishCatalogId ,'') = 0 and @VersionIdString = '')
		Begin 
			DELETE
			FROM ZnodePublishAddonEntity
			WHERE PublishAddonEntityId  IN (
											SELECT PublishAddonEntityId
											FROM ZnodePublishAddonEntity BP
											INNER JOIN #AddonProductPublishedXML A ON BP.ZnodeProductId =A.PublishProductId
												AND BP.ZnodeCatalogId = A.PublishCatalogId AND BP.VersionId = A.VersionId
											) 

			----Delete addon entries having parent data present but all addon removed
			DELETE ZPAE
			FROM ZnodePublishAddonEntity ZPAE
			WHERE EXISTS (SELECT * from [ZnodePimAddOnProduct] ZPAOP 
					INNER JOIN ZnodePublishProduct ZPPP ON (ZPPP.PimProductId = ZPAOP.PimProductId )
					WHERE ZPAE.ZnodeProductId = ZPPP.PublishProductId AND ZPAE.ZnodeCatalogId = ZPPP.PublishCatalogId)
			AND NOT EXISTS (SELECT * from [ZnodePimAddOnProductDetail] AS ZPOPD
					INNER JOIN [ZnodePimAddOnProduct] AS ZPAOP ON ZPOPD.[PimAddOnProductId] = ZPAOP.[PimAddOnProductId]
					INNER JOIN ZnodePublishProduct ZPPP ON (ZPPP.PimProductId = ZPOPD.PimChildProductId )
					WHERE ZPAE.ZnodeProductId = ZPPP.PublishProductId AND ZPAE.ZnodeCatalogId = ZPPP.PublishCatalogId)
		End 
					
		Insert into  ZnodePublishAddonEntity
		(VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,
			LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault)
		Select 
			VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,Isnull(AssociatedProductDisplayOrder,0),
			LocaleId,GroupName,DisplayType,DisplayOrder,1 IsRequired,RequiredType,IsDefault
		from #AddonProductPublishedXML
		
		SET @Status = 1;
            
    END TRY
    BEGIN CATCH
		SELECT ERROR_MESSAGE(),ERROR_PROCEDURE()
            
        SET @Status = 0;
        DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishAssociatedAddonsJson @PublishCatalogId = '+@PublishCatalogId+',@VersionId='+CAST(@VersionId AS VARCHAR(50))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
        SELECT 0 AS ID,
            CAST(0 AS BIT) AS Status;
        EXEC Znode_InsertProcedureErrorLog
            @ProcedureName = 'Znode_GetPublishAssociatedAddonsJson',
            @ErrorInProcedure = @Error_procedure,
            @ErrorMessage = @ErrorMessage,
            @ErrorLine = @ErrorLine,
            @ErrorCall = @ErrorCall;
    END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishSingleProductEntity')
	DROP PROC Znode_PublishSingleProductEntity

GO

CREATE PROCEDURE [dbo].[Znode_PublishSingleProductEntity]
(
    @PimProductId TransferId READONLY
   ,@RevisionType   Varchar(30) = ''
   ,@UserId int = 0
   ,@IsAutoPublish bit = 0 
   ,@ImportGUID Varchar(500) = '' 
)
AS
/*
	To publish all catalog product and their details
	Unit Testing : 
	*/
BEGIN
BEGIN TRY 
SET NOCOUNT ON
	Declare @Status Bit =0 
	Declare @Type varchar(50) = '',	@CMSSEOCode varchar(300);
	SET @Status = 1 

    DECLARE @PimProductId_Editable TransferId 
	DECLARE @PimAssociatedProductId TransferId  
			
	DECLARE @TBL_PublishIds TABLE (PublishProductId INT , PimProductId INT , PublishCatalogId INT)
	INSERT INTO @TBL_PublishIds 
	EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId= 0 ,@userid =@UserId ,@PimProductId = @PimProductId 

	-- To check associated Product
	EXEC Znode_PublishLatestAssociatedProduct @PublishCatalogId=0,@PimProductId=@PimProductId,@UserId=@UserId--,@PublishStateId=0

	DECLARE @TBL_PublishCatalogId TABLE(PublishCatalogId INT,PublishProductId INT,PimProductId  INT , VersionId INT,LocaleId INT ,RevisionType Varchar(50) );
		If  (@RevisionType like '%Preview%'  OR @RevisionType like '%Production%'  ) 
		Begin

			INSERT INTO @TBL_PublishCatalogId 
			SELECT Distinct ZPP.PublishCatalogId , ZPP.PublishProductId,PimProductId,ZPCP.VersionId, ZPCP.LocaleId  ,ZPCP.RevisionType
					 FROM ZnodePublishProduct ZPP 
					 Inner join ZnodePublishVersionEntity ZPCP ON (ZPCP.ZnodeCatalogId  = ZPP.PublishCatalogId AND ZPCP.RevisionType = 'PREVIEW')
					 WHERE (EXISTS (SELECT TOP 1 1 FROM @TBL_PublishIds SP WHERE SP.PimProductId = ZPP.PimProductId  ))
					 AND ZPCP.IsPublishSuccess = 1 
		End
		If (@RevisionType like '%Production%' OR @RevisionType = 'None')
			INSERT INTO @TBL_PublishCatalogId 
			SELECT Distinct ZPP.PublishCatalogId , ZPP.PublishProductId,PimProductId,ZPCP.VersionId, ZPCP.LocaleId  ,ZPCP.RevisionType
					 FROM ZnodePublishProduct ZPP 
					 Inner join ZnodePublishVersionEntity ZPCP ON (ZPCP.ZnodeCatalogId  = ZPP.PublishCatalogId AND ZPCP.RevisionType = 'PRODUCTION')
					 WHERE (EXISTS (SELECT TOP 1 1 FROM @TBL_PublishIds SP WHERE SP.PimProductId = ZPP.PimProductId  ))
					 AND ZPCP.IsPublishSuccess = 1 

			Truncate table ZnodePublishSingleProductErrorLogEntity 
	Begin Transaction 
	If @Type = 'ZnodePublishSingleProductEntity' OR @Type = ''
	Begin
	    	
		INSERT INTO @PimProductId_Editable
		SELECT distinct PimProductId FROM @TBL_PublishIds
		-- initiate single product publish 
		EXEC Znode_GetPublishSingleProductJson
		 @PublishCatalogId = 0,
		 @VersionId = 0 ,
		 @PimProductId = @PimProductId_Editable,
		 @UserId =@UserId ,
		 @TokenId = null ,
		 @RevisionType = @RevisionType , 
		 @Status  = @Status out 
	

		If @Status = 0 
			Rollback Transaction 
		
		INSERT INTO ZnodePublishSingleProductErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
		SELECT 'ZnodePublishProductEntity', '', Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
		@UserId , '' 

		If @Status  = 0 
		Begin
			SELECT 1 AS ID,@Status AS Status;
			Return 0 
		End
	End
	If @Type = 'ZnodePublishAddOnEntity' OR @Type = ''
	Begin
		Exec [Znode_GetPublishAssociatedAddonsJson]
				@PublishCatalogId = 0 ,
				@PimProductId   = @PimProductId,
				@UserId =@UserId,														 
				@VersionIdString = '',
				@Status	 =@Status Out,
				@RevisionType= @RevisionType 

			If @Status  = 0 
				Rollback Transaction 
		
			INSERT INTO ZnodePublishSingleProductErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ZnodePublishAddOnEntity', '', Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
			@UserId ,''

			If @Status  = 0 
			Begin
				SELECT 1 AS ID,@Status AS Status;
				Return 0 
			End
	End 
				
	If @Type = 'BundleAssociatedProducts' OR @Type = ''
	Begin
			Exec [Znode_GetPublishAssociatedProductsJson]

				@PublishCatalogId = 0 ,
				@PimProductId     = @PimProductId,
				@UserId =@UserId,														 
				@VersionIdString = '',
				@Status	 =@Status Out,
				@RevisionType= @RevisionType ,
				@ProductType = 'BundleProduct'

			If @Status  = 0 
				Rollback Transaction 
		
			INSERT INTO ZnodePublishSingleProductErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'BundleAssociatedProducts', '', Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
			@UserId ,''

			If @Status  = 0 
			Begin
				SELECT 1 AS ID,@Status AS Status;
				Return 0 
			End
	End 
	If @Type = 'GroupedAssociatedProducts' OR @Type = ''
	Begin
			Exec [Znode_GetPublishAssociatedProductsJson]

				@PublishCatalogId = 0 ,
				@PimProductId     = @PimProductId,
				@UserId =@UserId,														 
				@VersionIdString = '',
				@Status	 =@Status Out,
				@RevisionType= @RevisionType ,
				@ProductType = 'GroupedProduct'


			If @Status  = 0 
				Rollback Transaction 
		
			INSERT INTO ZnodePublishSingleProductErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'GroupedAssociatedProducts', '', Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
			@UserId ,''

			If @Status  = 0 
			Begin
				SELECT 1 AS ID,@Status AS Status;
				Return 0 
			End
	End 
	If @Type = 'ConfigurableAssociatedProducts' OR @Type = ''
	Begin
			Exec [Znode_GetPublishAssociatedProductsJson]

				@PublishCatalogId = 0 ,
				@PimProductId     = @PimProductId,
				@UserId =@UserId,														 
				@VersionIdString = '',
				@Status	 =@Status Out,
				@RevisionType= @RevisionType ,
				@ProductType ='ConfigurableProduct'
			If @Status  = 0 
				Rollback Transaction 
		
			INSERT INTO ZnodePublishSingleProductErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ConfigurableAssociatedProducts', '', Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
			@UserId ,''

			If @Status  = 0 
			Begin
				SELECT 1 AS ID,@Status AS Status;
				Return 0 
			End
	End 
	If @Type = 'ZnodePublishSEOEntity' OR @Type = ''
	Begin
			SELECT TPC.PublishProductId  ,TPC.PublishCatalogId ,VersionId,TPC.LocaleId ,PP.SKU, ZCSD.SEOUrl,ZCSD.PortalId 
			INTO #SEODetails 
			FROM @TBL_PublishCatalogId TPC
			INNER JOIN ZnodePublishProductDetail PP ON (PP.PublishProductId = TPC.PublishProductId AND TPC.LocaleId = PP.LocaleId)
			inner join ZnodePublishCatalog ZPC ON TPC.PublishCatalogId = ZPC.PublishCatalogId
			left join ZnodePortalCatalog ZPCat on ZPC.PublishCatalogId = ZPCat.PublishCatalogId
			left join ZnodeCMSSEODetail ZCSD on PP.SKU = ZCSD.SEOCode and ZPCat.PortalId = ZCSD.PortalId 
				AND ZCSD.CMSSEOTypeId = (select top 1 CMSSEOTypeId from ZnodeCMSSEOType where Name = 'Product')
			--WHERE ZCSD.CMSSEODetailId is not null 
			GROUP BY TPC.PublishProductId  ,TPC.PublishCatalogId ,VersionId,TPC.LocaleId,PP.SKU, ZCSD.SEOUrl,ZCSD.PortalId 
			Declare @Seo_VersionId Varchar(10 )
			,@Seo_LocaleId int 
			,@Seo_SKU Varchar(300)
			,@Seo_PortalId int 

			DECLARE Cr_Attribute CURSOR LOCAL FAST_FORWARD
			FOR SELECT VersionId,LocaleId ,SKU,PortalId from #SEODetails    
			OPEN Cr_Attribute;
			FETCH NEXT FROM Cr_Attribute INTO @Seo_VersionId,@Seo_LocaleId ,@Seo_SKU,@Seo_PortalId ;
			WHILE @@FETCH_STATUS = 0
			BEGIN
				EXEC [Znode_SetPublishSEOEntity]
				  @CMSSEOTypeId = '1' 
				 ,@UserId  = @UserId 
				 ,@Status = @Status  OUTPUT 
				 ,@IsCatalogPublish = 0  
				 ,@IsSingleProductPublish = 1 
				 ,@VersionIdString = @Seo_VersionId  
				 ,@CMSSEOCode = @Seo_SKU
				 ,@PortalId  =@Seo_PortalId 
				 ,@LocaleId = @Seo_LocaleId
				 ,@RevisionState = @RevisionType 
				 
				 If @Status  = 0 
					Rollback Transaction 
		
				INSERT INTO ZnodePublishSingleProductErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
				SELECT 'ZnodePublishSingleProductEntity', '', Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
				@UserId ,''
				If @Status  = 0 
				Begin
					SELECT 1 AS ID,@Status AS Status;
					Return 0 
				End
			FETCH NEXT FROM Cr_Attribute INTO @Seo_VersionId,@Seo_LocaleId ,@Seo_SKU,@Seo_PortalId ;
			END;
			CLOSE Cr_Attribute;
			DEALLOCATE Cr_Attribute;
	End 

	IF Exists (select TOP 1 1  from ZnodePublishSingleProductErrorLogEntity where  ProcessStatus = 'Fail') 
		Begin
			Rollback transaction
			SET @Status  =0 
			SELECT 1 AS ID,@Status AS Status;
			INSERT INTO ZnodePublishSingleProductErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ZnodePublishPortalEntity', '' , 'Fail' , Getdate(), 
			@UserId ,''
			Return 0 
		End
		

	SET @Status = 1
	Commit Transaction 
	Insert into ZnodePublishPreviewLogEntity
			(VersionId,PublishStartTime,IsDisposed,SourcePublishState,EntityId,EntityType,LogMessage,LogCreatedDate,PreviousVersionId,LocaleId,LocaleDisplayValue)
			Select A.VersionId,NULL,NULL,A.RevisionType,0,'product','product has been published successfully' , Getdate(),  
			0,
			A.LocaleId,B.Name
			from ZnodePublishVersionEntity A  Inner join ZnodeLocale B on A.LocaleId = B.LocaleId 
			where A.ZnodeCatalogId in (Select distinct PublishCatalogId from @TBL_PublishCatalogId)

	If @RevisionType = 'Preview'
		UPDATE ZnodePimProduct 
			SET PublishStateId =  DBO.Fn_GetPublishStateIdForPreview() 
			WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_PublishCatalogId ZPP WHERE ZPP.PimProductId = ZnodePimProduct.PimProductId)
	else 	
		UPDATE ZnodePimProduct 
			SET PublishStateId =  DBO.Fn_GetPublishStateIdForPublish() 
			WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_PublishCatalogId ZPP WHERE ZPP.PimProductId = ZnodePimProduct.PimProductId)
	
	If  @IsAutoPublish = 1 
	Begin
		Delete from ZnodePublishProductRecordset where ImportGUID =@ImportGUID  
		Insert into ZnodePublishProductRecordset	
		(PublishCatalogId,PublishProductId,PimProductId,VersionId,LocaleId,RevisionType,ImportGUID)		
		Select  PublishCatalogId,PublishProductId,PimProductId,VersionId,LocaleId,RevisionType,@ImportGUID FROM @TBL_PublishCatalogId  
	End
	Else
	If  @IsAutoPublish = 0 
	Begin
		Select B.* from @TBL_PublishCatalogId  A Inner join ZnodePublishProductEntity B on 
		A.PublishProductId = B.ZnodeProductId 
		and a.VersionId = b.VersionId
		and a.PublishCatalogId = b.ZnodeCatalogId 
		Select * from #SEODetails     		
	end 
	SELECT 0 AS id,@Status AS Status;   

END TRY 
BEGIN CATCH 
	SET @Status =0  
	 SELECT 1 AS ID,@Status AS Status;   
	 Rollback transaction
	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishSingleProductEntity
		@PimProductIds = '',@UserId='+CAST(@UserId AS VARCHAR(50))+',@RevisionType='+CAST(@RevisionType AS VARCHAR(10))
			
	INSERT INTO ZnodePublishSingleProductErrorLogEntity
	(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
	SELECT 'PublishSingleProductEntity', '' + isnull(@ErrorMessage,'') , 'Fail' , Getdate(), 
	@UserId ,''


	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_PublishSingleProductEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH
END

GO

INSERT INTO ZnodeMenu(ParentMenuId,MenuName,MenuSequence,AreaName,ControllerName,ActionName,CSSClassName,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (SELECT TOP 1 MenuId FROM ZnodeMenu WHERE MenuName = 'Diagnostics & Maintenance' AND ParentMenuId = ( SELECT TOP 1 MenuId FROM ZnodeMenu WHERE MenuName = 'Diagnostics & Maintenance')),
'Diagnostics & Maintenance',null,null,'Hangfire','Dashboard','z-Diagnostics-Maintenance',1,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeMenu WHERE MenuName = 'Diagnostics & Maintenance'
AND ParentMenuId = ( SELECT TOP 1 MenuId FROM ZnodeMenu WHERE MenuName = 'Diagnostics & Maintenance'
AND ParentMenuId = ( SELECT TOP 1 MenuId FROM ZnodeMenu WHERE MenuName = 'Diagnostics & Maintenance')))

insert INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'Hangfire','Dashboard',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'Hangfire' and ActionName = 'Dashboard')

INSERT INTO ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
SELECT
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Diagnostics & Maintenance' AND ControllerName = 'Hangfire')
  ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Hangfire' and ActionName = 'Dashboard') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId =
   (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Diagnostics & Maintenance' AND ControllerName = 'Hangfire') and ActionId =
   (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Hangfire' and ActionName = 'Dashboard'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
SELECT
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Diagnostics & Maintenance' AND ControllerName = 'Hangfire'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Hangfire' and ActionName = 'Dashboard')
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId =
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Diagnostics & Maintenance' AND ControllerName = 'Hangfire') and ActionId =
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Hangfire' and ActionName = 'Dashboard'))

GO

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'Hangfire','Dashboard',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'Hangfire' and ActionName = 'Dashboard')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Diagnostics & Maintenance')
,(select top 1 ActionId from ZnodeActions where ControllerName = 'Hangfire' and ActionName = 'Dashboard') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Diagnostics & Maintenance')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'Hangfire' and ActionName = 'Dashboard'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Diagnostics & Maintenance') ,
(select top 1 ActionId from ZnodeActions where ControllerName = 'Hangfire' and ActionName = 'Dashboard')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Diagnostics & Maintenance')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'Hangfire' and ActionName = 'Dashboard'))


Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'Hangfire','Dashboard',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'Hangfire' and ActionName = 'Dashboard')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Diagnostics & Maintenance')
,(select top 1 ActionId from ZnodeActions where ControllerName = 'Hangfire' and ActionName = 'Dashboard') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Diagnostics & Maintenance')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'Hangfire' and ActionName = 'Dashboard'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Diagnostics & Maintenance') ,
(select top 1 ActionId from ZnodeActions where ControllerName = 'Hangfire' and ActionName = 'Dashboard')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Diagnostics & Maintenance')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'Hangfire' and ActionName = 'Dashboard'))

GO

UPDATE ZnodeState
SET StateName = REPLACE( LEFT(StateName, CHARINDEX('kraj', StateName) - 1),'','')
WHERE countrycode='SK' AND StateName like '%%'

--ZPD-14699
UPDATE ZnodeState SET StateName = dbo.Fn_CamelCase(ltrim(rtrim(replace(StateName,'','')))) 
WHERE StateName like '%' and  countrycode ='mx'

UPDATE ZnodeState SET StateName = dbo.Fn_CamelCase(ltrim(rtrim(StateName))) 

UPDATE ZnodeState SET StateName = replace(dbo.Fn_CamelCase(ltrim(rtrim(replace(StateName,'-',' - ')))),' - ','-') 
where StateName like '%-%'

UPDATE ZnodeState SET StateName = replace(dbo.Fn_CamelCase(ltrim(rtrim(replace(StateName,'(',' ( ')))),' ( ','(') 
where StateName like '%(%'

UPDATE ZnodeState SET StateName = replace(dbo.Fn_CamelCase(ltrim(rtrim(replace(StateName,'[',' [ ')))),' [ ','[') 
where StateName like '%[%'


UPDATE ZnodeState SET StateName = dbo.Fn_CamelCase(ltrim(rtrim(replace(StateName,substring(StateName,1,1),''))))
WHERE CountryCode = 'MX' and substring(StateName,1,1) not like '%[a-Z]%'


UPDATE ZnodeState SET StateName = replace(dbo.Fn_CamelCase(ltrim(rtrim(replace(StateName,'(','( ')))),'( ','(')
where StateName like '%(%'

GO

If Not Exists (Select 1 from ZnodeState Where [StateName]='Andaman and Nicobar Island' )
Begin
INSERT INTO ZnodeState (CountryCode, StateCode, StateName, IsActive, IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
VALUES ('IN','AN','Andaman and Nicobar Island',1,0,2,GETDATE(),2,GETDATE());
End

If Not Exists (Select 1 from ZnodeState Where [StateName]='Chandigarh' )
Begin
INSERT INTO ZnodeState (CountryCode, StateCode, StateName, IsActive, IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
VALUES ('IN','CH','Chandigarh',1,0,2,GETDATE(),2,GETDATE());
End

If Not Exists (Select 1 from ZnodeState Where [StateName]='Dadra and Nagar Haveli and Daman and Diu' )
Begin
INSERT INTO ZnodeState (CountryCode, StateCode, StateName, IsActive, IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
VALUES ('IN','DH','Dadra and Nagar Haveli and Daman and Diu',1,0,2,GETDATE(),2,GETDATE());
End

If Not Exists (Select 1 from ZnodeState Where [StateName]='Ladakh' )
Begin
INSERT INTO ZnodeState (CountryCode, StateCode, StateName, IsActive, IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
VALUES ('IN','LA','Ladakh',1,0,2,GETDATE(),2,GETDATE());
End

If Not Exists (Select 1 from ZnodeState Where [StateName]='Lakshadweep' )
Begin
INSERT INTO ZnodeState (CountryCode, StateCode, StateName, IsActive, IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
VALUES ('IN','LD','Lakshadweep',1,0,2,GETDATE(),2,GETDATE());
End

If Not Exists (Select 1 from ZnodeState Where [StateName]='Puducherry' )
Begin
INSERT INTO ZnodeState (CountryCode, StateCode, StateName, IsActive, IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
VALUES ('IN','PY','Puducherry',1,0,2,GETDATE(),2,GETDATE());
End

If Not Exists (Select 1 from ZnodeState Where [StateName]='Delhi' )
Begin
INSERT INTO ZnodeState (CountryCode, StateCode, StateName, IsActive, IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
VALUES ('IN','DL','Delhi',1,0,2,GETDATE(),2,GETDATE());
End

GO

INSERT INTO ZnodeMenu(ParentMenuId,MenuName,MenuSequence,AreaName,ControllerName,ActionName,CSSClassName,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (SELECT TOP 1 MenuId FROM ZnodeMenu WHERE MenuName = 'Diagnostics & Maintenance' AND ParentMenuId = ( SELECT TOP 1 MenuId FROM ZnodeMenu WHERE MenuName = 'Diagnostics & Maintenance')),
'Diagnostics & Maintenance',null,null,'Hangfire','Dashboard','z-Diagnostics-Maintenance',1,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeMenu WHERE MenuName = 'Diagnostics & Maintenance')

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetOmsOrderDetail')
	DROP PROC Znode_GetOmsOrderDetail

GO

CREATE PROCEDURE [dbo].[Znode_GetOmsOrderDetail]
( 
	@WhereClause NVARCHAR(MAX),
	@Rows        INT            = 100,
	@PageNo      INT            = 1,
	@Order_BY    VARCHAR(1000)  = '',
	@RowsCount   INT OUT			,
	@UserId	   INT = 0 ,
	@IsFromAdmin int=0,
	@SalesRepUserId int = 0 
 )
AS
    /*
     Summary : This procedure is used to get the oms order detils
			   Records are fetched for those users who placed the order i.e UserId is Present in ZnodeUser and  ZnodeOmsOrderDetails tables
	 Unit Testing:

    EXEC [Znode_GetOmsOrderDetail_SCT] 'PortalId =1',@Order_BY = '',@RowsCount= 0, @UserId = 0 ,@Rows = 50, @PageNo = 1

	declare @p7 int
	set @p7=4
	exec sp_executesql N'Znode_GetOmsOrderDetail_SCT @WhereClause, @Rows,@PageNo,@Order_By,@RowCount OUT,@UserId,@IsFromAdmin',N'@WhereClause nvarchar(30),@Rows int,@PageNo int,@Order_By nvarchar(14),@RowCount int output,@UserId int,@IsFromAdmin int',@WhereClause=N'(PortalId in(''1'',''4'',''5'',''6''))',@Rows=50,@PageNo=1,@Order_By=N'orderdate desc',@RowCount=@p7 output,@UserId=0,@IsFromAdmin=1
	select @p7



   */
BEGIN
    BEGIN TRY
	SET NOCOUNT ON;
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
		DECLARE @SQL NVARCHAR(MAX), @ProcessType  varchar(50)='Order'
		DECLARE @OrderLineItemRelationshipTypeId INT
		SET @OrderLineItemRelationshipTypeId = ( SELECT top 1 OrderLineItemRelationshipTypeId  FROM ZnodeOmsOrderLineItemRelationshipType where Name = 'AddOns' )

		----Verifying that the @SalesRepUserId is having 'Sales Rep' role
		IF NOT EXISTS
		(
			SELECT * FROM ZnodeUser ZU
			INNER JOIN AspNetZnodeUser ANZU ON ZU.UserName = ANZU.UserName
			INNER JOIN AspNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName
			INNER JOIN AspNetUserRoles ANUR ON ANU.Id = ANUR.UserId
			Where Exists(select * from AspNetRoles ANR Where Name = 'Sales Rep' AND ANUR.RoleId = ANR.Id) 
			AND ZU.UserId = @SalesRepUserId
		)   
		Begin
			SET @SalesRepUserId = 0
		End

		DECLARE @Fn_GetPaginationWhereClause VARCHAR(500) = dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows),
		@Fn_GetFilterWhereClause NVARCHAR(MAX) = ''
		set @Fn_GetFilterWhereClause=dbo.Fn_GetFilterWhereClause(@WhereClause)
			
		IF @Order_BY = ''
			set @Order_BY = 'OrderDate desc'

			set @Order_BY = replace(@Order_BY,'PortalId','ZODD.PortalId')
			set @Order_BY = replace(@Order_BY,'UserName','ISNULL(RTRIM(LTRIM(ZODD.FirstName)),'''')+'' ''+ISNULL(RTRIM(LTRIM(ZODD.LastName)),'''')')
			set @Order_BY = replace(@Order_BY,'email','ZODD.Email')
			set @Order_BY = replace(@Order_BY,'OrderState','case when ZOS.IsShowToCustomer=0 and '+cast( @IsFromAdmin as varchar(50))+' = 0 then ZOSC.Description else  ZOS.Description end')
			set @Order_BY = replace(@Order_BY,'PaymentStatus','ZOPS.Name')
			set @Order_BY = replace(@Order_BY,'PublishState','ZODPS.DisplayName')
			set @Order_BY = replace(@Order_BY,'StoreName','ZP.StoreName')

			Declare @Fn_GetPagingRowId NVARCHAR(MAX) = ' DENSE_RANK()Over('+ ' Order By '+CASE WHEN Isnull(@Order_BY,'') = '' THEN 'OmsOrderId DESC' ELSE @Order_BY + ',OmsOrderId DESC' END  + ') RowId '
						
			IF OBJECT_ID('tempdb..#TBL_RowCount') is not null
				DROP TABLE #TBL_RowCount

			IF OBJECT_ID('tempdb..#Portal') is not null
				DROP TABLE #Portal
			
			Create table #TBL_RowCount(RowsCount int )
			CREATE TABLE #tbl_GetRecurciveUserId  (ID INT IDENTITY(1,1) Primary key,UserId INT,ParentUserId INT)
			INSERT INTO #tbl_GetRecurciveUserId
			SELECT UserId,ParentUserId FROM dbo.Fn_GetRecurciveUserId (CAST(@UserId AS VARCHAR(50)),@ProcessType ) FNRU
			 
			set @Fn_GetFilterWhereClause = replace(@Fn_GetFilterWhereClause,'PortalId','ZODD.PortalId')
			set @Fn_GetFilterWhereClause = replace(@Fn_GetFilterWhereClause,'UserName','ISNULL(RTRIM(LTRIM(ZODD.FirstName)),'''')+'' ''+ISNULL(RTRIM(LTRIM(ZODD.LastName)),'''')')
			set @Fn_GetFilterWhereClause = replace(@Fn_GetFilterWhereClause,'email','ZODD.Email')
			set @Fn_GetFilterWhereClause = replace(@Fn_GetFilterWhereClause,'OrderState','case when ZOS.IsShowToCustomer=0 and '+cast( @IsFromAdmin as varchar(50))+' = 0 then ZOSC.Description else  ZOS.Description end')
			set @Fn_GetFilterWhereClause = replace(@Fn_GetFilterWhereClause,'PaymentStatus','ZOPS.Name')
			set @Fn_GetFilterWhereClause = replace(@Fn_GetFilterWhereClause,'PublishState','ZODPS.DisplayName')
			set @Fn_GetFilterWhereClause = replace(@Fn_GetFilterWhereClause,'StoreName','ZP.StoreName')

			
		
	
		set @Fn_GetPagingRowId = replace(@Fn_GetPagingRowId,'OmsOrderId','Zoo.OmsOrderId')
		
		
		set @Rows = @PageNo * @Rows

		CREATE TABLE #Portal (PortalId int,StoreName varchar(200))
		insert into #Portal
		select PortalId,StoreName
		from ZnodePortal

		SET @SQL = '
		SELECT Distinct top '+cast(@Rows as varchar(10))+' Zoo.OmsOrderId,Zoo.OrderNumber, ZODD.PortalId,ZP.StoreName ,ZODD.CurrencyCode,
		case when ZOS.IsShowToCustomer=0 and '+cast( @IsFromAdmin as varchar(50))+' = 0 then ZOSC.Description else  ZOS.Description end  OrderState,ZODD.ShippingId,ZODD.PaymentTypeId,ZODD.PaymentSettingId
		,ZOPS.Name PaymentStatus,ZPS.Name PaymentType,CAST(1 AS BIT) ShippingStatus ,ZODD.OrderDate,ZODD.UserId,ISNULL(RTRIM(LTRIM(ZODD.FirstName)),'''')
		+'' ''+ISNULL(RTRIM(LTRIM(ZODD.LastName)),'''') UserName ,ZODD.PaymentTransactionToken ,ZODD.OrderTotalWithoutVoucher as Total,ZODD.OmsOrderDetailsId,ZODD.PoDocument,
		ZODD.Email ,ZODD.PhoneNumber ,ZODD.SubTotal ,ZODD.TaxCost ,ZODD.ShippingCost,ZODD.BillingPostalCode,
		ZODD.ModifiedDate AS OrderModifiedDate,  ZODD.PaymentDisplayName  ,isnull(Zoo.ExternalId,0) ExternalId,ZODD.CreditCardExpMonth,ZODD.CultureCode--,ZODD.TotalAdditionalCost
		,ZODD.CreditCardExpYear,ZODD.CardType,ZODD.CreditCardNumber,ZODD.PaymentExternalId,ZODPS.DisplayName as PublishState,
		'''' ProductName, 0 CountId, CAST (0 as bit) IsInRMA, '+@Fn_GetPagingRowId+'
		INTO #Cte_OrderLineDescribe
		FROM ZnodeOmsOrder (nolock) ZOO 
		INNER JOIN ZnodeOmsOrderDetails (nolock) ZODD ON (ZODD.OmsOrderId = ZOO.OmsOrderId AND  ZODD.IsActive = 1)
		INNER JOIN ZnodePublishState ZODPS ON (ZODPS.PublishStateId = ZOO.PublishStateId)
		INNER JOIN #Portal ZP (nolock) ON ZODD.PortalId = ZP.PortalId
		LEFT JOIN ZnodePaymentType (nolock) ZPS ON (ZPS.PaymentTypeId = ZODD.PaymentTypeId )
		LEFT JOIN ZnodeOmsOrderStateShowToCustomer (nolock) ZOSC ON (ZOSC.OmsOrderStateId = ZODD.OmsOrderStateId)
		LEFT JOIN ZnodeOmsOrderState (nolock) ZOS ON (ZOS.OmsOrderStateId = ZODD.OmsOrderStateId)
		LEFT JOIN ZnodeOmsPaymentState (nolock) ZOPS ON (ZOPS.OmsPaymentStateId = ZODD.OmsPaymentStateId)
		WHERE (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and ZODD.UserId = SalRep.CustomerUserid) or '+cast(@SalesRepUserId as varchar(10))+' = 0 )  
		AND (EXISTS (SELECT TOP 1 1 FROM #tbl_GetRecurciveUserId FNRU WHERE FNRU.UserId = ZODD.UserId ) OR '+cast(@UserId as varchar(10))+'  =0 )'
		+ @Fn_GetFilterWhereClause+' 
		ORDER BY '+CASE WHEN Isnull(@Order_BY,'') = '' THEN 'OmsOrderId DESC' ELSE @Order_BY + ',OmsOrderId DESC' END +' 

		INSERT INTO #TBL_RowCount 
		SELECT count(*)
		FROM ZnodeOmsOrder (nolock) ZOO 
		INNER JOIN ZnodeOmsOrderDetails (nolock) ZODD ON (ZODD.OmsOrderId = ZOO.OmsOrderId AND  ZODD.IsActive = 1)
		INNER JOIN ZnodePublishState ZODPS ON (ZODPS.PublishStateId = ZOO.PublishStateId)
		INNER JOIN #Portal ZP (nolock) ON ZODD.PortalId = ZP.PortalId
		LEFT JOIN ZnodePaymentType (nolock) ZPS ON (ZPS.PaymentTypeId = ZODD.PaymentTypeId )
		LEFT JOIN ZnodeOmsOrderStateShowToCustomer (nolock) ZOSC ON (ZOSC.OmsOrderStateId = ZODD.OmsOrderStateId)
		LEFT JOIN ZnodeOmsOrderState (nolock) ZOS ON (ZOS.OmsOrderStateId = ZODD.OmsOrderStateId)
		LEFT JOIN ZnodeOmsPaymentState (nolock) ZOPS ON (ZOPS.OmsPaymentStateId = ZODD.OmsPaymentStateId)
		WHERE (EXISTS(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and ZODD.UserId = SalRep.CustomerUserid) or '+cast(@SalesRepUserId as varchar(10))+' = 0 )  
		AND (EXISTS (SELECT TOP 1 1 FROM #tbl_GetRecurciveUserId FNRU WHERE FNRU.UserId = ZODD.UserId ) OR '+cast(@UserId as varchar(10))+'  =0 )'
		+ @Fn_GetFilterWhereClause+' 
			
		Create index Ind_OrderLineDescribe_RowId on #Cte_OrderLineDescribe(RowId )

		SELECT OmsOrderId,OrderNumber,PortalId,StoreName,CurrencyCode,OrderState,ShippingId,
		PaymentTypeId,PaymentSettingId,PaymentStatus,PaymentType,ShippingStatus,OrderDate,UserId,UserName,PaymentTransactionToken,Total,
		PN OrderItem,a.OmsOrderDetailsId,CountId ItemCount, PoDocument AS PODocumentPath,IsInRMA ,
		Email,PhoneNumber,SubTotal,TaxCost,ShippingCost,BillingPostalCode,null ShippingPostalCode
		,OrderModifiedDate,PaymentDisplayName, 
		ExternalId,CreditCardExpMonth,CreditCardExpYear,CardType,CreditCardNumber,PaymentExternalId,CultureCode,PublishState --TotalAdditionalCost
		FROM #Cte_OrderLineDescribe a inner join (select OmsOrderDetailsId, min(ProductName) PN, sum(case when OmsOrderLineItemsId is null then 0 else 1 end ) CNT from ZnodeOmsOrderLineItems
		where ParentOmsOrderLineItemsId is not null group by OmsOrderDetailsId ) b on a.OmsOrderDetailsId = b.OmsOrderDetailsId
		' + @Fn_GetPaginationWhereClause +' order by RowId '

		--print @SQL
		EXEC(@SQL)
		Select @RowsCount= isnull(RowsCount  ,0) from #TBL_RowCount
		
		IF OBJECT_ID('tempdb..#TBL_RowCount') is not null
				DROP TABLE #TBL_RowCount

		IF OBJECT_ID('tempdb..#Portal') is not null
			DROP TABLE #Portal
		
    END TRY
    BEGIN CATCH
        DECLARE @Status BIT ;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetOmsOrderDetail @WhereClause = '''+ISNULL(CAST(@WhereClause AS VARCHAR(max)),'''''')+''',@Rows='''+ISNULL(CAST(@Rows AS VARCHAR(50)),'''''')+''',@PageNo='+ISNULL(CAST(@PageNo AS VARCHAR(50)),'''')+',
		@Order_BY='+ISNULL(@Order_BY,'''''')+',@UserId = '+ISNULL(CAST(@UserId AS VARCHAR(50)),'''')+',@RowsCount='+ISNULL(CAST(@RowsCount AS VARCHAR(50)),'''')+',@IsFromAdmin='+ISNULL(CAST(@IsFromAdmin AS VARCHAR(10)),'''');
              			 
        SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    

        EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_GetOmsOrderDetail',
		@ErrorInProcedure = 'Znode_GetOmsOrderDetail',
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
    END CATCH;
END;

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'IsPricesInclusiveOfTaxes'
AND Object_ID = Object_ID(N'dbo.ZnodeOmsOrderDetails'))
BEGIN
	ALTER TABLE ZnodeOmsOrderDetails ADD IsPricesInclusiveOfTaxes BIT NULL;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCustomer')
	DROP PROC Znode_ImportCustomer

GO

CREATE PROCEDURE [dbo].[Znode_ImportCustomer]
(
	  @TableName NVARCHAR(100), 
	  @Status BIT OUT, 
	  @UserId INT, 
	  @ImportProcessLogId INT, 
	  @NewGUId NVARCHAR(200), 
	  @LocaleId INT= 0,
	  @PortalId INT ,
	  @CsvColumnString NVARCHAR(max)
)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import SEO Details
	
	-- Unit Testing : 
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(max),@AspNetZnodeUserId NVARCHAR(256),@ASPNetUsersId NVARCHAR(256),
		@PasswordHash NVARCHAR(max),@SecurityStamp NVARCHAR(max),@RoleId NVARCHAR(256),@IsAllowGlobalLevelUserCreation NVARCHAR(10)
		Declare @ProfileId  INT
		DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		 
		SET @SecurityStamp = '0wVYOZNK4g4kKz9wNs-UHw2'
		SET @PasswordHash = 'APy4Tm1KbRG6oy7h3r85UDh/lCW4JeOi2O2Mfsb3OjkpWTp1YfucMAvvcmUqNaSOlA==';
		SELECT  @RoleId  = Id FROM AspNetRoles WHERE   NAME = 'Customer'  

		SELECT @IsAllowGlobalLevelUserCreation = FeatureValues FROM ZnodeGlobalsetting WHERE FeatureName = 'AllowGlobalLevelUserCreation'

		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
		-- Retrive RoundOff Value FROM global setting 

		-- Three type of import required three table varible for product , category and brand
		CREATE TABLE #InsertCustomer 
		( 
			RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, UserName NVARCHAR(512) ,FirstName	NVARCHAR(200),
			LastName NVARCHAR(200), BudgetAmount	NUMERIC,Email	NVARCHAR(100),PhoneNumber	NVARCHAR(100),
		    EmailOptIn	BIT	,ReferralStatus	NVARCHAR(40),IsActive	BIT	,ExternalId	NVARCHAR(max),CreatedDate DATETIME,
			ProfileName varchar(200),AccountCode NVARCHAR(100),DepartmentName varchar(300),RoleName NVARCHAR(256), GUID NVARCHAR(400)
			,PerOrderLimit INT,	PerOrderAnnualLimit NVARCHAR(100),BillingAccountNumber NVARCHAR(100),EnableUserShippingAddressSuggestion  NVARCHAR(100),
			EnablePowerBIReportOnWebStore BIT,Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),
			Custom4 NVARCHAR(max),Custom5 NVARCHAR(max)
		);

		SET @SSQL = 'INSERT INTO #InsertCustomer( RowNumber,' + @CsvColumnString + ',GUID)
		             SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+ @TableName;
		
		EXEC sys.sp_sqlexec @SSQL;
				
		SELECT TOP 1 @ProfileId   =  ProfileId FROM ZnodePortalprofile WHERE Portalid = @Portalid and IsDefaultRegistedProfile=1
		IF( Isnull(@ProfileId ,0) = 0 ) 
		Begin
		
		
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '62', 'Default Portal Profile', '', @NewGUId, 1 , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
							
				UPDATE ZnodeImportProcessLog
				SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
				WHERE ImportProcessLogId = @ImportProcessLogId;
			

				SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog 
				WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
				SELECT @SuccessRecordCount = 0

				UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
				TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
				WHERE ImportProcessLogId = @ImportProcessLogId;

				DELETE FROM #InsertCustomer 
				SET @Status = 0;

				COMMIT TRAN A;
				Return 0 
		End

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '35', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName not like '%_@_%_.__%' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '35', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName like '%;%'
				
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '30', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ltrim(rtrim(ii.UserName)) IN 
		(SELECT ltrim(rtrim(UserName))  FROM #InsertCustomer GROUP BY ltrim(rtrim(UserName))  having count(*) > 1 )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '77', 'AccountCode', ii.AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer ii 
		WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !='' 
		AND NOT EXISTS(SELECT * FROM ZnodeAccount za INNER JOIN ZnodePortalAccount zpa on za.AccountId = zpa.AccountId
			WHERE  ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za.AccountCode and zpa.PortalId = @PortalId )
		AND EXISTS(SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount za1 WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za1.AccountCode );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '73', 'AccountCode', AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !=''   and ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') not IN 
		(
			SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount   
		);

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '88', 'AccountCode', AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !='' and  exists
		(
			SELECT top 1 1 FROM  AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	 
		INNER JOIN ZnodeAccount ZA on  ZU.AccountId = ZA.AccountId
		WHERE ANZU.UserName = ii.UserName and  ZA.AccountCode != ii.AccountCode
		);

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '92', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ISNULL(LTRIM(RTRIM(ii.RoleName)),'') <> '' and  ISNULL(LTRIM(RTRIM(ii.RoleName)),'') IN ('User','Manager','Administrator')
		AND EXISTS(SELECT * FROM ZnodeUser a INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				--INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)						
				INNER JOIN AspNetUserRoles u on u.UserId = b.Id
				INNER JOIN AspNetRoles ZD on u.RoleId = zd.Id
				WHERE (ii.UserName = c.UserName) and ISNULL(LTRIM(RTRIM(ii.RoleName)),'') <> ZD.Name )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '75', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') ='' and ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '74', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE --ltrim(rtrim(ii.RoleName)) not IN ('User','Manager','Administrator') and ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and
			ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and not exists (SELECT top 1 1 FROM  AspNetRoles ANR WHERE name IN ('User','Manager','Administrator') and  ANR.name =ii.RoleName)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '76', 'DepartmentName', DepartmentName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') <> ''
		AND NOT EXISTS(SELECT * FROM  ZnodeAccount ZA INNER JOIN ZnodeDepartment ZD on ZA.AccountId = ZD.AccountId
			WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = ltrim(rtrim(za.AccountCode))
			and ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') = ltrim(rtrim(ZD.DepartmentName)))
				

		UPDATE ZIL
		SET ZIL.ColumnName =   ZIL.ColumnName + ' [ UserName - ' + ISNULL(UserName,'') + ' ] '
		FROM ZnodeImportLog ZIL 
		INNER JOIN #InsertCustomer IPA ON (ZIL.RowNumber = IPA.RowNumber)
		WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		--Note : Content page import is not required 
		
		-- END Function Validation 	
		-----------------------------------------------
		--- Delete Invalid Data after functional validatin  

		DELETE FROM #InsertCustomer
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
			--AND GUID = @NewGUID
		);


		-- Update Record count IN log 
        
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		SELECT @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertCustomer
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- END

		-- Insert Product Data 
				
				
				DECLARE @InsertedAspNetZnodeUser TABLE (AspNetZnodeUserId NVARCHAR(256) ,UserName NVARCHAR(512),PortalId INT )
				DECLARE @InsertedASPNetUsers TABLE (Id NVARCHAR(256) ,UserName NVARCHAR(512))
				DECLARE @InsertZnodeUser TABLE (UserId INT,AspNetUserId NVARCHAR(256),CreatedDate DATETIME )

				UPDATE ANU SET 
				ANU.PhoneNumber	= IC.PhoneNumber, ANU.LockoutEndDateUtc = case when IC.IsActive = 0 then @GetDate when IC.IsActive = 1 then null else ANU.LockoutEndDateUtc END
				FROM AspNetZnodeUser ANZU 
				INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
				WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
				----Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

				UPDATE ZU SET 
				ZU.FirstName	= IC.FirstName,
				ZU.LastName		= IC.LastName,
				--ZU.MiddleName	= IC.MiddleName,
				ZU.BudgetAmount = IC.BudgetAmount,
				ZU.Email		= IC.Email,
				ZU.PhoneNumber	= IC.PhoneNumber,
				ZU.EmailOptIn	= Isnull(IC.EmailOptIn,0),
				ZU.IsActive		= IC.IsActive,
				ZU.Custom1 = IC.Custom1,
				ZU.Custom2 = IC.Custom2,
				ZU.Custom3 = IC.Custom3,
				ZU.Custom4 = IC.Custom4,
				ZU.Custom5 = IC.Custom5
				--ZU.ExternalId = ExternalId
				FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
				WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
				--WHERE Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

				INSERT INTO AspNetZnodeUser (AspNetZnodeUserId, UserName, PortalId)		
				OUTPUT INSERTED.AspNetZnodeUserId, INSERTED.UserName, INSERTED.PortalId	INTO  @InsertedAspNetZnodeUser 			 
				SELECT NEWID(),IC.UserName, @PortalId FROM #InsertCustomer IC 
				WHERE NOT EXISTS (SELECT TOP 1 1  FROM AspNetZnodeUser ANZ 
					WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZ.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END 
					AND ANZ.UserName = IC.UserName)

				INSERT INTO ASPNetUsers (Id,Email,EmailConfirmed,PasswordHash,SecurityStamp,PhoneNumber,PhoneNumberConfirmed,TwoFactorEnabled,
				LockoutEndDateUtc,LockOutEnabled,AccessFailedCount,PasswordChangedDate,UserName)
				OUTPUT inserted.Id, inserted.UserName INTO @InsertedASPNetUsers
				SELECT NewId(), Email,0 ,@PasswordHash,@SecurityStamp,PhoneNumber,0,0,case when A.IsActive = 0 then @GetDate else null END LockoutEndDateUtc,1 LockoutEnabled,
				0,@GetDate,AspNetZnodeUserId FROM #InsertCustomer A INNER JOIN @InsertedAspNetZnodeUser  B 
				ON A.UserName = B.UserName
				
				INSERT INTO  ZnodeUser(AspNetUserId,FirstName,LastName,CustomerPaymentGUID,Email,PhoneNumber,EmailOptIn,
				IsActive,ExternalId, CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,UserName,Custom1,Custom2,Custom3,Custom4,Custom5)
				OUTPUT Inserted.UserId, Inserted.AspNetUserId,Inserted.CreatedDate INTO @InsertZnodeUser
				SELECT IANU.Id AspNetUserId ,IC.FirstName,IC.LastName,null CustomerPaymentGUID,IC.Email
				,IC.PhoneNumber,Isnull(IC.EmailOptIn,0),IC.IsActive,IC.ExternalId, @UserId,
				CASE WHEN IC.CreatedDate IS NULL OR IC.CreatedDate = '' THEN  @Getdate ELSE IC.CreatedDate END,
				@UserId,@Getdate,IC.UserName,IC.Custom1,IC.Custom2,IC.Custom3,IC.Custom4,IC.Custom5
				FROM #InsertCustomer IC INNER JOIN 
				@InsertedAspNetZnodeUser IANZU ON IC.UserName = IANZU.UserName  INNER JOIN 
				@InsertedASPNetUsers IANU ON IANZU.AspNetZnodeUserId = IANU.UserName 
				  	     
				INSERT INTO AspNetUserRoles (UserId,RoleId)  SELECT AspNetUserId, @RoleID FROM @InsertZnodeUser 
				INSERT INTO ZnodeUserPortal (UserId,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
				SELECT UserId, @PortalId , @UserId, IZU.CreatedDate,@UserId,@Getdate 
				FROM @InsertZnodeUser IZU

				INSERT INTO ZnodeAccountUserPermission(UserId,AccountPermissionAccessId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT UserId, 4 , @UserId, @Getdate,@UserId,@Getdate 
				FROM @InsertZnodeUser IZU
		
				------------INSERT INTO ZnodeUserGlobalAttributeValue
	
				IF OBJECT_ID('tempdb..#globaldata') IS NOT NULL 
					DROP TABLE #globaldata
				
				SELECT ZU.userid,PerOrderLimit,
					PerOrderAnnualLimit,
					BillingAccountNumber,
					EnableUserShippingAddressSuggestion,
					EnablePowerBIReportOnWebStore 
				INTO #globaldata
				FROM znodeuser ZU INNER JOIN  #InsertCustomer IC on IC.Email =ZU.EMAIL
				WHERE ZU.userid IN (SELECT userid FROM @InsertZnodeUser)
				GROUP BY ZU.userid,PerOrderLimit,
									PerOrderAnnualLimit,
									BillingAccountNumber,
									EnableUserShippingAddressSuggestion,
									EnablePowerBIReportOnWebStore 

				IF OBJECT_ID('tempdb..#globaldata1') IS NOT NULL DROP TABLE #globaldata1
				SELECT * INTO #globaldata1 FROM (SELECT userid, Cast(PerOrderLimit as varchar(100)) PerOrderLimit,
				 Cast(PerOrderAnnualLimit as varchar(100)) PerOrderAnnualLimit,
				 Cast(BillingAccountNumber as varchar(100)) BillingAccountNumber,
				 Cast(case when cast(EnableUserShippingAddressSuggestion as varchar(10))= '1' or cast(EnableUserShippingAddressSuggestion as varchar(10)) ='YES' or  cast(EnableUserShippingAddressSuggestion as varchar(10)) ='True' then 'True' else 'False'  END  as varchar(100)) EnableUserShippingAddressSuggestion,
				 Cast(case when cast(EnablePowerBIReportOnWebStore as varchar(10))= '1'  or cast(EnablePowerBIReportOnWebStore as varchar(10)) ='YES' or  cast(EnablePowerBIReportOnWebStore as varchar(10)) ='True' then 'True' else 'False' END  as varchar(100)) EnablePowerBIReportOnWebStore FROM #globaldata) ab
				UNPIVOT  
				   (avalue FOR acode IN   
					  (PerOrderLimit,
				PerOrderAnnualLimit,
				BillingAccountNumber,
				EnableUserShippingAddressSuggestion,
				EnablePowerBIReportOnWebStore)  
				)AS unpvt;  

				INSERT INTO ZnodeUserGlobalAttributeValue (UserId,	GlobalAttributeId,	GlobalAttributeDefaultValueId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
				SELECT g.Userid,ZGA.GlobalAttributeId,null,null,@UserId,@Getdate,@UserId,@Getdate
					FROM #globaldata1 g INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.acode
					WHERE NOT EXISTS (SELECT top 1 1 FROM ZnodeUserGlobalAttributeValue ZGAV WHERE ZGAV.Userid =g.Userid and ZGA.GlobalAttributeId=ZGAV.GlobalAttributeId)

				INSERT INTO ZnodeUserGlobalAttributeValuelocale(UserGlobalAttributeValueId,	LocaleId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate,	GlobalAttributeDefaultValueId,	MediaId,	MediaPath)
				SELECT UserGlobalAttributeValueId, @LocaleId,avalue ,@UserId,@Getdate,@UserId,@Getdate,null,null,null
					FROM ZnodeUserGlobalAttributeValue ZUGAV INNER JOIN #globaldata1 g on ZUGAV.userid =g.userid
						INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.acode and ZGA.GlobalAttributeId = ZUGAV.GlobalAttributeId
						WHERE NOT EXISTS (SELECT Top 1 1 FROM ZnodeUserGlobalAttributeValuelocale z WHERE z.UserGlobalAttributeValueId = ZUGAV.UserGlobalAttributeValueId)

				---------------------------------------------------------------------------------

				declare @Profile table (ProfileId INT)

				INSERT INTO ZnodeProfile (ProfileName,ShowOnPartnerSignup,Weighting,TaxExempt,DefaultExternalAccountNo,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ParentProfileId)
				OUTPUT inserted.ProfileId INTO @Profile(ProfileId)
				SELECT Distinct ProfileName, 0, null,0, replace(ltrim(rtrim(ProfileName)),' ','') as DefaultExternalAccountNo, @UserId,@Getdate, @UserId,@Getdate, null as ParentProfileId				
				FROM #InsertCustomer IC
				WHERE NOT EXISTS(SELECT * FROM ZnodeProfile ZP WHERE IC.ProfileName = ZP.ProfileName )
				AND ISNULL(ic.ProfileName,'') <> ''

				INSERT INTO ZnodePortalProfile (PortalId,	ProfileId,	IsDefaultAnonymousProfile,	IsDefaultRegistedProfile,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
				SELECT @PortalId, ProfileId, 0 AS IsDefaultAnonymousProfile, 0 AS IsDefaultRegistedProfile, @UserId,@Getdate, @UserId,@Getdate
				FROM @Profile

				UPDATE ZnodeUserProfile 
				SET ProfileId = COALESCE(ZP.ProfileId,@ProfileId)
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeUserProfile u ON u.UserId = a.UserId
				LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
				--WHERE IC.ProfileName <> ''
				
				INSERT INTO ZnodeUserProfile (ProfileId,UserId,IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT COALESCE(ZP.ProfileId,@ProfileId)  , a.UserId, 1 , @UserId,a.CreatedDate,@UserId,@Getdate 
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeUserProfile u WHERE u.UserId = a.UserId )
				AND EXISTS(SELECT * FROM @InsertZnodeUser IZU WHERE A.UserId = IZU.UserId)

				---to update accountid agaist user
				UPDATE ZU SET ZU.AccountId = ZA.AccountId 
				FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	 
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName
				INNER JOIN ZnodeAccount ZA ON ZA.AccountCode = IC.AccountCode 
				--INNER JOIN @InsertZnodeUser IZU on IZU.UserId =ZU.UserId
				WHERE Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0) and isnull(IC.AccountCode,'') <> ''
				
				update ZDU set ZDU.DepartmentId = ZD.DepartmentId, ModifiedBy = @UserId, ModifiedDate = @Getdate
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
				INNER JOIN ZnodeDepartmentUser ZDU on ZDU.UserId = a.UserId
				WHERE isnull(IC.DepartmentName,'') <> ''

				INSERT INTO ZnodeDepartmentUser(UserId,DepartmentId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT a.UserId, ZD.DepartmentId, @UserId,a.CreatedDate,@UserId,@Getdate 
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeDepartmentUser u WHERE u.UserId = a.UserId)
				AND isnull(IC.DepartmentName,'') <> ''
		
				update u set u.RoleId = ZD.Id
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
				INNER JOIN AspNetUserRoles u on u.UserId = b.Id
				WHERE isnull(IC.RoleName,'') <> ''
				
				INSERT INTO AspNetUserRoles(UserId,RoleId)
				SELECT b.Id as ASPNetUserId, ZD.Id as RoleId
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM AspNetUserRoles u WHERE u.UserId = b.Id)
				AND EXISTS(SELECT * FROM @InsertZnodeUser IZU WHERE A.UserId = IZU.UserId)
				AND isnull(IC.RoleName,'') <> ''


		UPDATE ZnodeImportProcessLog
		  SET Status = dbo.Fn_GetImportStatus( 2 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
		 DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCustomer @TableName = '+CAST(@TableName AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@PortalId='+CAST(@PortalId AS VARCHAR(10))+',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max));
              	
		 ---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

        EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportCustomer',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCustomerAddress')
	DROP PROC Znode_ImportCustomerAddress

GO

CREATE PROCEDURE [dbo].[Znode_ImportCustomerAddress](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @LocaleId int= 0,@PortalId int ,@CsvColumnString nvarchar(max), @IsAccountAddress bit = 0 )
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import SEO Details
	
	-- Unit Testing : 
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(max),@IsAllowGlobalLevelUserCreation NVARCHAR(10)

		DECLARE @GETDATE DATETIME= dbo.Fn_GETDATE();
		-- Retrive Value FROM global setting 
		SELECT @IsAllowGlobalLevelUserCreation = FeatureValues FROM ZnodeGlobalsetting WHERE FeatureName = 'AllowGlobalLevelUserCreation'
		-- Three type of import required three table varible for product , category AND brand

		CREATE TABLE #InsertCustomerAddress 
		( 
			RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT,UserName NVARCHAR(512),FirstName VARCHAR(300),
			LastName VARCHAR(300),DisplayName NVARCHAR(1200),Address1 VARCHAR(300),Address2 VARCHAR(300),
			CountryName VARCHAR(3000),StateName VARCHAR(3000),CityName VARCHAR(3000),PostalCode VARCHAR(50),
			PhoneNumber VARCHAR(50),IsDefaultBilling BIT,IsDefaultShipping BIT	,IsActive BIT,ExternalId NVARCHAR(2000),
			CompanyName NVARCHAR(2000), GUID NVARCHAR(400)
		);
	
		SET @SSQL = ' INSERT INTO #InsertCustomerAddress ( RowNumber, ' + @CsvColumnString + ' ,GUID )
		SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+ @TableName;
		EXEC sys.sp_sqlexec @SSQL;

		-- start Functional Validation 
		----------------------------------------------
		IF (@IsAccountAddress = 0)
		BEGIN
			IF @IsAllowGlobalLevelUserCreation = 'true'
					INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
						   SELECT '19', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
						   FROM #InsertCustomerAddress AS ii
						   WHERE ii.UserName NOT IN 
						   (
							   SELECT UserName FROM AspNetZnodeUser   WHERE PortalId = @PortalId
						   );
			ELSE 
					INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
						   SELECT '19', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
						   FROM #InsertCustomerAddress AS ii
						   WHERE ii.UserName NOT IN 
						   (
							   SELECT UserName FROM AspNetZnodeUser   
						   );

					INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
							SELECT '8', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
							FROM #InsertCustomerAddress AS ii
							WHERE ISNULL(ltrim(rtrim(ii.UserName)), '') = ''

		 END

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '8', 'StateName', StateName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
		FROM #InsertCustomerAddress AS ii
		WHERE NOT EXISTS(SELECT * FROM ZnodeState ZS INNER JOIN ZnodeCountry ZC ON ZS.CountryCode = ZC.CountryCode
			where ii.CountryName = ZC.CountryName AND ZS.StateName = ISNULL(ltrim(rtrim(ii.StateName)), ''))

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '8', 'CountryName', CountryName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
		FROM #InsertCustomerAddress AS ii
		WHERE NOT EXISTS(SELECT * FROM ZnodeCountry ZC WHERE ZC.CountryName = ISNULL(ltrim(rtrim(ii.CountryName)), '') )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '90', 'CountryName', CountryName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
		FROM #InsertCustomerAddress AS ii
		WHERE ISNULL(ltrim(rtrim(ii.CountryName)), '') <> ''
		AND NOT EXISTS(SELECT * FROM ZnodePortalCountry ZPC INNER JOIN ZnodeCountry ZC ON ZPC.CountryCode = ZC.CountryCode
		    WHERE PortalId = @PortalId AND ltrim(rtrim(ii.CountryName)) = ltrim(rtrim(ZC.CountryName)))

		 -- error log when atleast db have 
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '63', 'IsDefaultBilling/IsDefaultShipping', IsDefaultBilling, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
		FROM #InsertCustomerAddress IC WHERE  exists (
		SELECT TOP 1 1  FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
		INNER JOIN ZnodeUserAddress ZUA ON ZUA.UserId = ZU.UserId
		INNER JOIN ZnodeAddress ZA ON ZUA.AddressId = ZA.AddressId
		where ANZU.UserName = IC.UserName AND ZA.IsDefaultBilling =IC.IsDefaultBilling 
		AND ZA.IsDefaultShipping =IC.IsDefaultShipping )

		--Note : Content page import is not required 
		
		-- End Function Validation 	
		-----------------------------------------------
		UPDATE ZIL
		SET ZIL.ColumnName =   ZIL.ColumnName + ' [ UserName - ' + ISNULL(UserName,'') + ' ] '
		FROM ZnodeImportLog ZIL 
		INNER JOIN #InsertCustomerAddress IPA ON (ZIL.RowNumber = IPA.RowNumber)
		WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL


		DELETE FROM #InsertCustomerAddress
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber IS NOT NULL 
			--AND GUID = @NewGUID
		);

		UPDATE ZA SET ZA.IsDefaultBilling = 0
		FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
		INNER JOIN ZnodeUserAddress ZUA ON ZUA.UserId = ZU.UserId
		INNER JOIN ZnodeAddress ZA ON ZUA.AddressId = ZA.AddressId
		INNER JOIN #InsertCustomerAddress IC ON ANZU.UserName = IC.UserName --and IC.IsDefaultBilling <> ZA.IsDefaultBilling 
		where IC.IsDefaultBilling = 1 

		UPDATE ZA SET ZA.IsDefaultShipping = 0
		FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
		INNER JOIN ZnodeUserAddress ZUA ON ZUA.UserId = ZU.UserId
		INNER JOIN ZnodeAddress ZA ON ZUA.AddressId = ZA.AddressId
		INNER JOIN #InsertCustomerAddress IC ON ANZU.UserName = IC.UserName
		where IC.IsDefaultShipping = 1 

		DELETE FROM ZnodeImportLog  WHERE ImportProcessLogId = @ImportProcessLogId AND  ErrorDescription = '63'
		-- UPDATE Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		SELECT @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertCustomerAddress
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- End
		
		DELETE FROM #InsertCustomerAddress 
		WHERE NOT EXISTS
			(SELECT TOP 1 1 FROM 
				(
					SELECT ROW_NUMBER() OVER(PARTITION BY UserName	
					,FirstName	,LastName	,DisplayName	,Address1	,Address2	
					,CountryName	,StateName	,CityName	,PostalCode	
					,PhoneNumber	,IsDefaultBilling,IsDefaultShipping,ExternalId	,CompanyName ORDER BY RowId desc) 
					AS rw_nmbr,RowId  FROM #InsertCustomerAddress 
				) abc WHERE rw_nmbr =1 AND abc.RowId = #InsertCustomerAddress.RowId
			)

		----------UPDATE ZnodeAddress
		DECLARE @AddressColumnString VARCHAR(1000), @WhereConditionString VARCHAR(1000), @UpdateColumnString VARCHAR(1000)

		SELECT @AddressColumnString = COALESCE(@AddressColumnString + ',', '')+a.ColumnName --COALESCE(@CsvColumnString + ' AND ', '') +'ZA.'+ColumnName+' =  IC.'+ColumnName
		FROM ZnodeImportUpdatableColumns a
		INNER JOIN INFORMATION_SCHEMA.COLUMNS b ON a.ColumnName = b.COLUMN_NAME  
		INNER JOIN dbo.Split(@CsvColumnString,',')C ON b.COLUMN_NAME = c.Item
		WHERE b.TABLE_NAME = 'ZnodeAddress' 
		AND EXISTS(SELECT * FROM ZnodeImportHead IH WHERE a.ImportHeadId = IH.ImportHeadId AND IH.Name in ('CustomerAddress','ShippingAddress'))

		SELECT @UpdateColumnString = COALESCE(@UpdateColumnString + ' , ', '') +'ZA.'+a.COLUMN_NAME+' =  IC.'+a.COLUMN_NAME  
		FROM INFORMATION_SCHEMA.COLUMNS a
		INNER JOIN dbo.Split(@CsvColumnString,',')b ON a.COLUMN_NAME = b.Item
		WHERE NOT EXISTS (SELECT * FROM dbo.Split(@AddressColumnString,',') c WHERE a.COLUMN_NAME = c.Item )
		AND a.TABLE_NAME = 'ZnodeAddress'

		SELECT @WhereConditionString = COALESCE(@WhereConditionString + ' AND ', '') +'ZA.'+item+' =  IC.'+item FROM dbo.split(@AddressColumnString,',')
		SET @WhereConditionString = Replace(@WhereConditionString , 'ZA.Address2 =  IC.Address2', 'ISNULL(ZA.Address2 ,'''')=  ISNULL(IC.Address2 ,'''')') 
		
		UPDATE a SET a.StateName =c.StateCode  
		FROM #InsertCustomerAddress a 
		INNER JOIN ZnodeCountry b ON a.CountryName = b.CountryName 
		INNER JOIN ZnodeState c ON b.CountryCode = c.CountryCode AND C.StateName = a.StateName
		
		UPDATE a SET a.CountryName= b.CountryCode FROM  #InsertCustomerAddress a INNER JOIN ZnodeCountry b ON a.CountryName = b.CountryName 
		
		CREATE TABLE #InsertedUserAddress (AddressId  NVARCHAR(256), UserId NVARCHAR(max)) 

		IF ( @IsAccountAddress = 1 )
		BEGIN
			UPDATE ZnodeAddress SET IsDefaultBilling = 0,  IsDefaultShipping = 0
			FROM AspNetZnodeUser ANZU 
			INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
			INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
			INNER JOIN ZnodeUserAddress ZUA ON ZUA.UserId = ZU.UserId
			INNER JOIN ZnodeAddress ZA ON ZUA.AddressId = ZA.AddressId
			INNER JOIN #InsertCustomerAddress IC ON ANZU.UserName = IC.UserName AND ZA.IsDefaultBilling =IC.IsDefaultBilling 
													AND ZA.IsDefaultShipping =IC.IsDefaultShipping

					SET @SSQL = '
						UPDATE ZA set ModifiedBy = '+CONVERT(VARCHAR(10), @UserId)+', ModifiedDate = getdate() '+CASE WHEN ISNULL(@UpdateColumnString,'') = '' THEN '' ELSE ','+@UpdateColumnString END+' 
						FROM ZnodeAddress ZA
						INNER JOIN #InsertCustomerAddress IC ON '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END

			EXEC (@SSQL)

					SET @SSQL = '
					Insert into ZnodeAddress (FirstName,LastName,DisplayName,Address1,Address2,Address3,CountryName,
											StateName,CityName,PostalCode,PhoneNumber,
											IsDefaultBilling,IsDefaultShipping,IsActive,ExternalId,CompanyName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsShipping,IsBilling)		
					OUTPUT INSERTED.AddressId INTO  #InsertedUserAddress (AddressId) 			 
					SELECT IC.FirstName,IC.LastName,IC.DisplayName,IC.Address1,IC.Address2,null,IC.CountryName ,
					IC.StateName,
					,IC.CityName,IC.PostalCode,IC.PhoneNumber,
					isnull(IC.IsDefaultBilling,0),isnull(IC.IsDefaultShipping,0),isnull(IC.IsActive,0),IC.ExternalId,IC.CompanyName, '+CONVERT(VARCHAR(10), @UserId)+' , getdate() , '+CONVERT(VARCHAR(10), @UserId)+' ,getdate(), 1, 1
					FROM  #InsertCustomerAddress IC
					WHERE NOT EXISTS(SELECT * FROM ZnodeAddress ZA WHERE '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END +')'

			EXEC (@SSQL)

			DECLARE @AccountId INT
			SELECT @AccountId = AccountId FROM ZnodeUser WHERE UserId = @UserId
			INSERT INTO ZnodeAccountAddress ( AccountId, AddressId, CreatedBy, CreatedDate,	ModifiedBy,	ModifiedDate )
			SELECT @AccountId, Addressid ,  @UserId , @GETDATE, @UserId , @GETDATE FROM #InsertedUserAddress UA
			WHERE NOT EXISTS ( SELECT * FROM ZnodeAccountAddress AA WHERE AccountId = @AccountId AND AA.Addressid = UA.Addressid )
		END
		ELSE
		BEGIN
		
			UPDATE ZnodeAddress SET IsDefaultBilling = 0,  IsDefaultShipping = 0
			FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
			INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
			INNER JOIN ZnodeUserAddress ZUA ON ZUA.UserId = ZU.UserId
			INNER JOIN ZnodeAddress ZA ON ZUA.AddressId = ZA.AddressId
			INNER JOIN #InsertCustomerAddress IC ON ANZU.UserName = IC.UserName AND ZA.IsDefaultBilling =IC.IsDefaultBilling 
			AND ZA.IsDefaultShipping =IC.IsDefaultShipping
					
					SET @SSQL = '
						UPDATE ZA set ModifiedBy = '+CONVERT(VARCHAR(10), @UserId)+', ModifiedDate = getdate() '+CASE WHEN ISNULL(@UpdateColumnString,'') = '' THEN '' ELSE ','+@UpdateColumnString END+' 
						FROM ZnodeAddress ZA 
						INNER JOIN #InsertCustomerAddress IC ON '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END
						+' ) '
					Print @SSQL
					EXEC (@SSQL)
									
					SET @SSQL = '
					Insert into ZnodeAddress (FirstName,LastName,DisplayName,Address1,Address2,Address3,CountryName,
												StateName,CityName,PostalCode,PhoneNumber,
												IsDefaultBilling,IsDefaultShipping,IsActive,ExternalId,CompanyName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsShipping,IsBilling)		
					OUTPUT INSERTED.AddressId, INSERTED.Address3 INTO  #InsertedUserAddress (AddressId, UserId ) 			 
					SELECT IC.FirstName,IC.LastName,IC.DisplayName,IC.Address1,IC.Address2,convert(nvarchar(100),ZU.UserId),IC.CountryName ,
					IC.StateName 
					,IC.CityName,IC.PostalCode,IC.PhoneNumber,
					isnull(IC.IsDefaultBilling,0),isnull(IC.IsDefaultShipping,0),isnull(IC.IsActive,0),IC.ExternalId,IC.CompanyName, '+CONVERT(VARCHAR(10), @UserId)+' , getdate() , '+CONVERT(VARCHAR(10), @UserId)+' ,getdate(),1,1
					FROM AspNetZnodeUser ANZU 
					INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
					INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
					INNER JOIN #InsertCustomerAddress IC ON ANZU.UserName = IC.UserName 
					WHERE NOT EXISTS(SELECT * FROM ZnodeAddress ZA WHERE '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END +')'
					print @SSQL
					EXEC (@SSQL)

			INSERT INTO ZnodeUserAddress(UserId,AddressId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT CAST( UserId AS INT ) , Addressid , @UserId , @GETDATE, @UserId , @GETDATE FROM  #InsertedUserAddress
		END
				
		UPDATE ZA SET ZA.CountryName = ZC.CountryCode
		FROM ZnodeAddress ZA
		INNER JOIN ZnodeCountry ZC ON ltrim(rtrim(ZA.CountryName)) = ltrim(rtrim(ZC.CountryName))

		UPDATE ZA SET ZA.Address3 = null 
		FROM ZnodeAddress ZA INNER JOIN #InsertedUserAddress IUA ON ZA.AddressId = IUA.AddressId 

		
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 2 ), ProcessCompletedDate = @GETDATE
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCustomerAddress @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@LocaleId='+CAST(@LocaleId AS VARCHAR(max)) +',@PortalId='+CAST(@PortalId AS VARCHAR(max)) +',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max)) +',@IsAccountAddress='+CAST(@IsAccountAddress AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GETDATE
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId

		--Updating total AND fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportCustomerAddress',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishAssociatedAddonsJson')
	DROP PROC Znode_GetPublishAssociatedAddonsJson

GO

CREATE PROCEDURE [dbo].[Znode_GetPublishAssociatedAddonsJson]
(
	@PublishCatalogId NVARCHAR(MAX) = 0,
	@PimProductId    TransferId Readonly,
	@VersionId        INT           = 0,
	@UserId           INT,														 
	@PimCategoryHierarchyId int = 0, 
	@LocaleId       TransferId READONLY,
	@PublishStateId INT = 0, 
	@VersionIdString  VARCHAR(100)= '',
	@Status		   Bit  OutPut,
	@RevisionType Varchar(50)
)
AS 
   
/*
    Summary : If PimcatalogId is provided get all products with Addons and provide above mentioned data
       If PimProductId is provided get all Addons if associated with given product id and provide above mentioned data
    			Input: @PublishCatalogId or @PimProductId
    		    output should be in XML format
       sample xml5
    Begin transaction  
	 declare  @PimProductId TransferId 
	 Declare @Status bit 
	 INSERT INTO @PimProductId  values (768)

			Exec [_Znode_GetPublishAssociatedAddonsJson]
				@PublishCatalogId = 0 ,
				@PimProductId   = @PimProductId,
				@UserId =2,														 
				@VersionIdString = '',--'1662,1664,1663,1665',
				@Status	 =@Status Out,
				@RevisionType= 'Production'
				rollback transaction
				--SELECT * from ZnodePublishVersionEntity 
   
	*/

BEGIN
    BEGIN TRY
    SET NOCOUNT ON 
		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
        DECLARE @LocaleIdIn INT, @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId()
		, @Counter INT= 1
		, @MaxRowId INT= 0;

    -- DECLARE @PimAddOnGroupId VARCHAR(MAX);

		CREATE TABLE #TBL_PublisshIds  (PublishProductId INT , PimProductId INT , PublishCatalogId INT)
		DECLARE @TBL_LocaleId TABLE (RowId    INT IDENTITY(1, 1),LocaleId INT);
		IF OBJECT_ID('tempdb..#VesionIds') is not null
		DROP TABLE #VesionIds
		Create Table #VesionIds(ZnodeCatalogId int , VersionId int , LocaleId int , RevisionType varchar(50) )

  		If @VersionIdString <> ''
		BEGIN
			Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)	
			SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType
			FROM ZnodePublishVersionEntity PV Inner join Split(@VersionIdString,',') S ON PV.VersionId = S.Item
		END
		Else 
		Begin
			If  (@RevisionType like '%Preview%'  OR @RevisionType like '%Production%')
			BEGIN
				Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)	
				SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV  where PV.IsPublishSuccess =1 
				AND PV.RevisionType ='Preview'
			END
			If  (@RevisionType like '%Production%' OR @RevisionType = 'None')
			BEGIN
				Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)	
				SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV  where PV.IsPublishSuccess =1 
				AND PV.RevisionType ='Production'
			END					
		End 

		IF (@PublishCatalogId IS NULL OR @PublishCatalogId = 0)
		BEGIN 
			INSERT INTO #TBL_PublisshIds 
			EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId,@userid,@PimProductId,1
		END 
		IF ISnull(@PimCategoryHierarchyId,0) <> 0 
		BEGIN 
			INSERT INTO #TBL_PublisshIds 
			EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId,@userid,@PimProductId,1,@PimCategoryHierarchyId 
		END 

		CREATE TABLE #TBL_PublishCatalogId (PublishCatalogId INT,PublishProductId INT,PimProductId  INT , VersionId INT ,LocaleId INT  );

		IF  ISnull(@PimCategoryHierarchyId,0) <> 0 
		BEGIN 
			INSERT INTO #TBL_PublishCatalogId 
			SELECT ZPP.PublishCatalogId , ZPP.PublishProductId,PimProductId, MAX(ZPCP.PublishCatalogLogId)  ,LocaleId 
			FROM ZnodePublishProduct ZPP 
			INNER JOIN ZnodePublishCatalogLog ZPCP ON (ZPCP.PublishCatalogId  = ZPP.PublishCatalogId)
			WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId   ) 
			AND ZPCP.Publishstateid = @PublishStateId
			GROUP BY ZPP.PublishCatalogId,ZPP.PublishProductId,PimProductId,LocaleId 
		END 
		ELSE 
		Begin
			INSERT INTO #TBL_PublishCatalogId  
			SELECT ZPP.PublishCatalogId , ZPP.PublishProductId,PimProductId,0  VersionId  ,0 LocaleId 
			FROM ZnodePublishProduct ZPP  
			WHERE EXISTS  (SELECT TOP 1 1 FROM #VesionIds ZPCP WHERE (ZPCP.ZnodeCatalogId  = ZPP.PublishCatalogId)) AND
			(EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId  
			AND  @PublishCatalogId = '0' )  OR (ZPP.PublishCatalogId =  @PublishCatalogId ))
		END
        DECLARE @TBL_AddonGroupLocale TABLE( PimAddonGroupId INT, DisplayType NVARCHAR(400),AddonGroupName NVARCHAR(MAX),LocaleId INT );
        INSERT INTO @TBL_LocaleId(LocaleId)
        SELECT LocaleId FROM ZnodeLocale MT  WHERE IsActive = 1 AND (EXISTS (SELECT TOP 1 1  FROM @LocaleId RT WHERE RT.Id = MT.LocaleId )
			OR NOT EXISTS (SELECT TOP 1 1 FROM @LocaleId ));
        SET @MaxRowId = ISNULL(( SELECT MAX(RowId) FROM @TBL_LocaleId ), 0);
    
        WHILE (@Counter <= @MaxRowId)
        BEGIN
            SET @LocaleIdIn =( SELECT LocaleId FROM @TBL_LocaleId WHERE RowId = @Counter );
            INSERT INTO @TBL_AddonGroupLocale (PimAddonGroupId, DisplayType, AddonGroupName)
            EXEC Znode_GetAddOnGroupLocale '', @LocaleIdIn;
	   		UPDATE @TBL_AddonGroupLocale SET LocaleId = @LocaleIdIn WHERE LocaleId IS NULL 
            SET @Counter = @Counter + 1;
        END;
		
		IF OBJECT_ID('tempdb..#AddonProductPublishedXML') is not null
		drop table #AddonProductPublishedXML
						
		SELECT  ZPPP.PublishProductId,ZPPP.PublishCatalogId,V.LocaleId,v.VersionId,
		ZPPP.[PublishProductId]  ZnodeProductId,
		ZPPP.[PublishCatalogId] ZnodeCatalogId,
		ZPP.PublishProductId  AssociatedZnodeProductId,
		ZPAOP.DisplayOrder DisplayOrder,
		ZPOPD.DisplayOrder AssociatedProductDisplayOrder,
		RequiredType ,
		DisplayType, 
		ISNULL((select ''+AddonGroupName for xml path('')),'') GroupName,
		ISnull(IsDefault,0) IsDefault
		INTO #AddonProductPublishedXML
		FROM [ZnodePimAddOnProductDetail] AS ZPOPD
		INNER JOIN [ZnodePimAddOnProduct] AS ZPAOP ON ZPOPD.[PimAddOnProductId] = ZPAOP.[PimAddOnProductId]
		INNER JOIN #TBL_PublishCatalogId ZPPP ON (ZPPP.PimProductId = ZPAOP.PimProductId )
		INNER JOIN #TBL_PublishCatalogId ZPP ON(ZPP.PimProductId = ZPOPD.[PimChildProductId] AND ZPP.PublishCatalogId = ZPPP.PublishCatalogId  )
		INNER JOIN #VesionIds V ON ZPPP.PublishCatalogId  = V.ZnodeCataLogId
		INNER JOIN @TBL_AddonGroupLocale TBAG ON (TBAG.PimAddonGroupId   = ZPAOP.PimAddonGroupId AND TBAG.LocaleId = V.LocaleId )
					
		If (isnull(@PublishCatalogId ,'') = '' and @VersionIdString = '') OR 
			(isnull(@PublishCatalogId ,'') = 0 and @VersionIdString = '')
		Begin 
			DELETE
			FROM ZnodePublishAddonEntity
			WHERE PublishAddonEntityId  IN (
											SELECT PublishAddonEntityId
											FROM ZnodePublishAddonEntity BP
											INNER JOIN #AddonProductPublishedXML A ON BP.ZnodeProductId =A.PublishProductId
												AND BP.ZnodeCatalogId = A.PublishCatalogId AND BP.VersionId = A.VersionId
											) 

			----Delete addon entries having parent data present but all addon removed
			DELETE ZPAE
			FROM ZnodePublishAddonEntity ZPAE
			WHERE EXISTS (SELECT * from [ZnodePimAddOnProduct] ZPAOP 
					INNER JOIN ZnodePublishProduct ZPPP ON (ZPPP.PimProductId = ZPAOP.PimProductId )
					WHERE ZPAE.ZnodeProductId = ZPPP.PublishProductId AND ZPAE.ZnodeCatalogId = ZPPP.PublishCatalogId)
			AND NOT EXISTS (SELECT * from [ZnodePimAddOnProductDetail] AS ZPOPD
					INNER JOIN [ZnodePimAddOnProduct] AS ZPAOP ON ZPOPD.[PimAddOnProductId] = ZPAOP.[PimAddOnProductId]
					INNER JOIN ZnodePublishProduct ZPPP ON (ZPPP.PimProductId = ZPOPD.PimChildProductId )
					WHERE ZPAE.ZnodeProductId = ZPPP.PublishProductId AND ZPAE.ZnodeCatalogId = ZPPP.PublishCatalogId)
		End 
					
		Insert into  ZnodePublishAddonEntity
		(VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,
			LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault)
		Select 
			VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,Isnull(AssociatedProductDisplayOrder,0),
			LocaleId,GroupName,DisplayType,DisplayOrder,1 IsRequired,RequiredType,IsDefault
		from #AddonProductPublishedXML
		
		SET @Status = 1;
            
    END TRY
    BEGIN CATCH
		SELECT ERROR_MESSAGE(),ERROR_PROCEDURE()
            
        SET @Status = 0;
        DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishAssociatedAddonsJson @PublishCatalogId = '+@PublishCatalogId+',@VersionId='+CAST(@VersionId AS VARCHAR(50))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
        SELECT 0 AS ID,
            CAST(0 AS BIT) AS Status;
        EXEC Znode_InsertProcedureErrorLog
            @ProcedureName = 'Znode_GetPublishAssociatedAddonsJson',
            @ErrorInProcedure = @Error_procedure,
            @ErrorMessage = @ErrorMessage,
            @ErrorLine = @ErrorLine,
            @ErrorCall = @ErrorCall;
    END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPimPersonalisedAttributeValues')
	DROP PROC Znode_GetPimPersonalisedAttributeValues

GO

   
CREATE PROCEDURE [dbo].[Znode_GetPimPersonalisedAttributeValues]    
(  @PimProductId INT,    
   @LocaleId     INT = NULL)    
AS    
/*    
Summary: This Procedure is used to get Personalised attribute of product from all locale    
Unit Testing:    
begin tran      
 EXEC Znode_GetPimPersonalisedAttributeValues 15,1    
rollback tran    
    
*/    
     BEGIN     
  BEGIN TRY    
      
  SET NOCOUNT ON;    
         DECLARE @DefaultLocaleId INT;    
         SET @DefaultLocaleId = dbo.Fn_GetDefaultValue('Locale');    
         DECLARE @TBL_PimPersonalAttribute TABLE    
         (PimProductId               INT,    
          [PimAttributeFamilyId]     INT,    
          PimAttributeId             INT,    
          [PimAttributeGroupId]      INT,    
          AttributeTypeId            INT,    
          AttributeTypeName          VARCHAR(300),    
          IsRequired                 BIT,    
          IsLocalizable              BIT,    
          IsFilterable               BIT,    
          AttributeName              NVARCHAR(MAX),    
          AttributeValue             NVARCHAR(MAX),    
          PimAttributeValueId        INT,    
          PimAttributeDefaultValueId INT,    
          AttributeDefaultValueCode  NVARCHAR(600),    
          AttributeDefaultValue      NVARCHAR(MAX),    
          IsEditable                 BIT,    
          ControlName                VARCHAR(300),    
          ValidationName             VARCHAR(100),    
          SubValidationName          VARCHAR(300),    
          RegExp                     VARCHAR(300),    
          ValidationValue            VARCHAR(300),    
          IsRegExp                   BIT,    
          HelpDescription            NVARCHAR(MAX),    
          AttributeCode              VARCHAR(600),  
		  DisplayOrder    INT   
         );    
         WITH Cte_AttributeIds    
         AS (SELECT PimProductId,PimAttributeId,ZAV.PimAttributeValueId FROM ZnodePimAttributeValue ZAV WHERE EXISTS    
            (SELECT TOP 1 1 FROM ZnodePimAttribute ZPA WHERE ZPA.PimAttributeId = ZAV.PimAttributeId AND ZPA.IsPersonalizable = 1 AND ZPA.IsCategory = 0)    
            AND ZAV.PimAttributeFamilyId IS NULL AND ZAV.PimProductId = @PimProductId)    
       
   ,Cte_AttributeLocale    
          AS (SELECT @PimProductId PimProductId,PimAttributeValueId,ZPA.PimAttributeId,ZPA.AttributeTypeId, ZAT.AttributeTypeName,ZPA.IsRequired,    
              ZPA.IsLocalizable,ZPA.IsFilterable,ZPAL.AttributeName,ZPA.AttributeCode,ZPAL.LocaleId,ZPA.DisplayOrder FROM ZnodePimAttribute ZPA    
              INNER JOIN ZnodePimAttributeLocale ZPAL ON(ZPAL.PimAttributeId = ZPA.PimAttributeId)    
              INNER JOIN ZnodeAttributeType ZAT ON(ZAT.AttributeTypeId = ZPA.AttributeTypeId)    
              INNER JOIN Cte_AttributeIds ZPAV ON(ZPAV.PimAttributeId = ZPA.PimAttributeId) WHERE ZPAL.LocaleId IN(@LocaleId, @DefaultLocaleId)),    
                  
    Cte_AttributeFirstLocale    
          AS (SELECT PimProductId,PimAttributeValueId,PimAttributeId,AttributeTypeId,AttributeTypeName,IsRequired,IsLocalizable,IsFilterable,    
              AttributeName,AttributeCode,DisplayOrder  FROM Cte_AttributeLocale WHERE LocaleId = @LocaleId),    
    
          Cte_AttributeSecondLocale    
          AS (SELECT PimProductId,PimAttributeValueId,PimAttributeId,AttributeTypeId,AttributeTypeName,IsRequired,IsLocalizable,IsFilterable,    
              AttributeName,AttributeCode,DisplayOrder FROM Cte_AttributeFirstLocale    
              UNION ALL    
              SELECT PimProductId,PimAttributeValueId,PimAttributeId,AttributeTypeId,AttributeTypeName,IsRequired,IsLocalizable,IsFilterable,    
              AttributeName,AttributeCode,CTAL.DisplayOrder FROM Cte_AttributeLocale CTAL WHERE LocaleId = @DefaultLocaleId     
     AND NOT EXISTS ( SELECT TOP 1 1 FROM Cte_AttributeFirstLocale CTAFL WHERE CTAFL.PimAttributeId = CTAL.PimAttributeId )),    
                 
    Cte_AttributeValidation    
          AS (SELECT CTASL.PimProductId,CTASL.PimAttributeValueId,CTASL.PimAttributeId,CTASL.AttributeTypeId,CTASL.AttributeTypeName,CTASL.IsRequired,    
              CTASL.IsLocalizable,CTASL.IsFilterable,CTASL.AttributeName,CTASL.AttributeCode,i.[ControlName],i.[Name] AS [ValidationName],j.[ValidationName] AS [SubValidationName],    
              j.[RegExp],k.[Name] AS [ValidationValue],CAST(CASE WHEN j.[RegExp] IS NULL THEN 0 ELSE 1 END AS BIT) AS [IsRegExp],CTASL.DisplayOrder FROM Cte_AttributeSecondLocale CTASL    
              LEFT JOIN [dbo].[ZnodePimAttributeValidation] AS k ON(CTASL.PimAttributeId = K.PimAttributeId)    
              LEFT JOIN [dbo].[ZnodeAttributeInputValidation] AS i ON(k.[InputValidationId] = i.[InputValidationId] AND CTASL.AttributeTypeId = I.AttributeTypeId)    
              LEFT JOIN [dbo].[ZnodeAttributeInputValidationRule] AS j ON(k.[InputValidationRuleId] = j.[InputValidationRuleId])),    
                  
    Cte_DefaultValuesLocale    
          AS (SELECT PimProductId,PimAttributeValueId,CTASL.PimAttributeId,AttributeTypeId,AttributeTypeName, IsRequired,IsLocalizable,IsFilterable,    
              AttributeName,AttributeCode,PimAttributeDefaultValueId,AttributeDefaultValue,AttributeDefaultValueCode,IsEditable,[ControlName],    
              [ValidationName],[SubValidationName],[RegExp],[ValidationValue],[IsRegExp],LocaleId,CTASL.DisplayOrder FROM Cte_AttributeValidation CTASL    
              LEFT JOIN View_PimDefaultValue VIPDV ON(CTASL.PimAttributeId = VIPDV.PimAttributeId AND LocaleId IN(@LocaleId, @DefaultLocaleId))),    
                  
       Cte_DefaultValuesFirstLocale    
          AS (SELECT PimProductId,PimAttributeValueId,PimAttributeId,AttributeTypeId,AttributeTypeName,IsRequired,IsLocalizable,IsFilterable,AttributeName,    
              AttributeCode,PimAttributeDefaultValueId,AttributeDefaultValue,AttributeDefaultValueCode,IsEditable,[ControlName],[ValidationName],[SubValidationName],    
              [RegExp],[ValidationValue],[IsRegExp],CTDVL.DisplayOrder FROM Cte_DefaultValuesLocale CTDVL WHERE(CTDVL.LocaleId = @LocaleId  OR CTDVL.LocaleId IS NULL)),    
                  
    Cte_DefaultValueSecondLocale    
          AS (SELECT PimProductId,PimAttributeValueId,PimAttributeId,AttributeTypeId,AttributeTypeName,IsRequired,IsLocalizable,IsFilterable,AttributeName,    
              AttributeCode,PimAttributeDefaultValueId,AttributeDefaultValue,AttributeDefaultValueCode,IsEditable,[ControlName],[ValidationName],[SubValidationName],    
              [RegExp],[ValidationValue],[IsRegExp],DisplayOrder FROM Cte_DefaultValuesFirstLocale    
     UNION ALL    
              SELECT PimProductId,PimAttributeValueId,PimAttributeId,AttributeTypeId,AttributeTypeName,IsRequired, IsLocalizable,IsFilterable,AttributeName,AttributeCode,    
              PimAttributeDefaultValueId, AttributeDefaultValue,AttributeDefaultValueCode,IsEditable,[ControlName],[ValidationName],[SubValidationName],    
              [RegExp],[ValidationValue],[IsRegExp],CTDVL.DisplayOrder FROM Cte_DefaultValuesLocale CTDVL WHERE CTDVL.LocaleId = @DefaultLocaleId AND NOT EXISTS    
              (SELECT TOP 1 1 FROM Cte_DefaultValuesFirstLocale CTDVF WHERE CTDVF.PimAttributeDefaultValueId = CTDVL.PimAttributeDefaultValueId))    
                  
     INSERT INTO @TBL_PimPersonalAttribute(PimProductId,PimAttributeValueId,PimAttributeId,AttributeTypeId,AttributeTypeName,IsRequired,IsLocalizable,    
     IsFilterable,AttributeName,AttributeCode,PimAttributeDefaultValueId,AttributeDefaultValue,AttributeDefaultValueCode,IsEditable,[ControlName],    
     [ValidationName],[SubValidationName],[RegExp],[ValidationValue],[IsRegExp],DisplayOrder)    
              SELECT PimProductId,PimAttributeValueId,PimAttributeId,AttributeTypeId,AttributeTypeName,IsRequired,IsLocalizable,IsFilterable,AttributeName,AttributeCode,    
     PimAttributeDefaultValueId,AttributeDefaultValue,AttributeDefaultValueCode,IsEditable,[ControlName],[ValidationName],[SubValidationName],[RegExp],    
              [ValidationValue],[IsRegExp],DisplayOrder FROM Cte_DefaultValueSecondLocale;    
    
          WITH Cte_PersonalAttributeValue    
          AS (SELECT TBPPA.PimProductId,TBPPA.PimAttributeId,ZAVL.AttributeValue,ZAVL.LocaleId FROM @TBL_PimPersonalAttribute TBPPA    
              LEFT JOIN ZnodePimAttributeValueLocale ZAVL ON(ZAVL.PimAttributeValueId = TBPPA.PimAttributeValueId) WHERE ZAVL.LocaleId IN(@LocaleId, @DefaultLocaleId)),    
                  
    Cte_AttributeValueFirst    
          AS (SELECT PimProductId,PimAttributeId, AttributeValue FROM Cte_PersonalAttributeValue CTAV WHERE CTAV.LocaleId = @LocaleId OR CTAV.LocaleId IS NULL),    
                  
    Cte_AttributeValueSecond    
          AS (SELECT PimProductId,PimAttributeId, AttributeValue FROM Cte_AttributeValueFirst CTAVF    
              UNION ALL    
              SELECT PimProductId,PimAttributeId,AttributeValue FROM Cte_PersonalAttributeValue CTAV WHERE CTAV.LocaleId = @DefaultLocaleId    
              AND NOT EXISTS(SELECT TOP 1 1 FROM Cte_AttributeValueFirst CTAVF WHERE CTAVF.PimAttributeId = CTAV.PimAttributeId))    
                  
    UPDATE TBPA SET AttributeValue = CTAM.AttributeValue FROM @TBL_PimPersonalAttribute TBPA    
          INNER JOIN Cte_AttributeValueSecond CTAM ON(CTAM.PimAttributeId = TBPA.PimAttributeId);    
             
    WITH Cte_MediaDetails    
          AS (SELECT TBPA.PimAttributeId,[Path],MEdiaId, AttributeValue FROM ZnodeMedia ZM INNER JOIN @TBL_PimPersonalAttribute TBPA     
    ON(EXISTS(SELECT TOP 1 1  FROM dbo.Split(AttributeValue, ',') SP WHERE SP.Item = ZM.MediaId ))    
          WHERE EXISTS(SELECT TOP 1 1 FROM [dbo].[Fn_GetProcedureAttributeDefault]('MediaAttributeType') FNGP WHERE FNGP.[Value] = TBPA.AttributeTypeName)),    
                  
    Cte_Attributemedia    
          AS (SELECT PimAttributeId,SUBSTRING((SELECT DISTINCT ','+[Path] FROM Cte_MediaDetails CTMD WHERE CTMD.PimAttributeId = TBPA.PimAttributeId FOR XML PATH('')), 2, 4000) MediaPath    
              FROM @TBL_PimPersonalAttribute TBPA WHERE EXISTS(SELECT TOP 1 1 FROM [dbo].[Fn_GetProcedureAttributeDefault]('MediaAttributeType') FNGP    
              WHERE FNGP.[Value] = TBPA.AttributeTypeName) GROUP BY TBPA.PimAttributeId)    
                  
    UPDATE TBPA SET AttributeValue = [dbo].[Fn_GetMediaThumbnailMediaPath](MediaPath)+'~'+AttributeValue FROM @TBL_PimPersonalAttribute TBPA    
    INNER JOIN Cte_Attributemedia CTAM ON(CTAM.PimAttributeId = TBPA.PimAttributeId)     
    WHERE EXISTS(SELECT TOP 1 1 FROM [dbo].[Fn_GetProcedureAttributeDefault]('MediaAttributeType') FNGP WHERE FNGP.[Value] = TBPA.AttributeTypeName);    
             
    SELECT [PimProductId],[PimAttributeFamilyId],[PimAttributeId],[PimAttributeGroupId],[AttributeTypeId],[AttributeTypeName],[AttributeCode],[IsRequired],    
    [IsLocalizable],[IsFilterable],[AttributeName],[AttributeValue],[PimAttributeValueId],[PimAttributeDefaultValueId],AttributeDefaultValueCode,[AttributeDefaultValue],    
    ISNULL(NULL, 0) AS [ROWID],ISNULL([IsEditable], 1) AS [IsEditable],[ControlName],[ValidationName],[SubValidationName],[RegExp],[ValidationValue],[IsRegExp],    
    [HelpDescription],DisplayOrder FROM @TBL_PimPersonalAttribute  
	ORDER BY DisplayOrder;    
        
   END TRY    
   BEGIN CATCH    
    DECLARE @Status BIT ;    
    SET @Status = 0;    
    DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPimPersonalisedAttributeValues @PimProductId = '+cast (@PimProductId AS VARCHAR(50))+',@LocaleId='+CAST(@LocaleId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));    
                      
          SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                        
      
          EXEC Znode_InsertProcedureErrorLog    
            @ProcedureName = 'Znode_GetPimPersonalisedAttributeValues',    
            @ErrorInProcedure = @Error_procedure,    
            @ErrorMessage = @ErrorMessage,    
            @ErrorLine = @ErrorLine,    
            @ErrorCall = @ErrorCall;    
   END CATCH    
  END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishAttributeDetail')
	DROP PROC Znode_GetPublishAttributeDetail

GO


CREATE PROCEDURE [dbo].[Znode_GetPublishAttributeDetail]  
(  
	@AttributeCode VARCHAR(MAX),  
	@LocaleId      INT          = 0
)  
AS   
   /*  Summary :- This procedure is used in publish to get the personalies attribute validation while data insert by Uers  
     Unit Testing   
     EXEC [dbo].[Znode_GetPublishAttributeDetail] 'DisplayText,Personalizable',1  
 */  
BEGIN  
BEGIN TRY  
SET NOCOUNT ON;  
	DECLARE @TBL_AttributIds TABLE  
	(
		PimAttributeId INT,  
		AttributeCode  VARCHAR(600)  
	); 
	
	DECLARE @TBL_AttributeDetail TABLE  
	(
		PimAttributeId       INT,  
		ParentPimAttributeId INT,  
		AttributeTypeId      INT,  
		AttributeCode        VARCHAR(600),  
		IsRequired           BIT,  
		IsLocalizable        BIT,  
		IsFilterable         BIT,  
		IsSystemDefined      BIT,  
		IsConfigurable       BIT,  
		IsPersonalizable     BIT,  
		DisplayOrder         INT,  
		HelpDescription      VARCHAR(MAX),  
		IsCategory           BIT,  
		IsHidden             BIT,  
		CreatedDate          DATETIME,  
		ModifiedDate         DATETIME,  
		AttributeName        NVARCHAR(MAX),  
		AttributeTypeName    VARCHAR(MAX)  
	);  
	DECLARE @PimAttributeIds VARCHAR(MAX);  
  
	INSERT INTO @TBL_AttributIds(PimAttributeId,AttributeCode)  
	SELECT PimAttributeId,AttributeCode FROM ZnodePimAttribute ZPA WHERE EXISTS(SELECT TOP 1 1 FROM dbo.split(@AttributeCode, ',') SP WHERE Sp.Item = ZPA.AttributeCode);  
	SET @PimAttributeIds = SUBSTRING((SELECT ','+CAST(PimAttributeId AS VARCHAR(50)) FROM @TBL_AttributIds FOR XML PATH('')), 2, 4000);  
  
	INSERT INTO @TBL_AttributeDetail(PimAttributeId,ParentPimAttributeId,AttributeTypeId,AttributeCode,IsRequired,IsLocalizable,IsFilterable,IsSystemDefined,  
	IsConfigurable,IsPersonalizable,DisplayOrder,HelpDescription,IsCategory,IsHidden,CreatedDate,ModifiedDate,AttributeName,AttributeTypeName)  
	EXEC [dbo].[Znode_GetPimAttributesDetails]@PimAttributeIds,@LocaleId;  
  
	SELECT TBAD.PimAttributeId,ParentPimAttributeId,TBAD.AttributeTypeId,AttributeCode,IsRequired,IsLocalizable,IsFilterable,IsSystemDefined,IsConfigurable,  
	IsPersonalizable,TBAD.DisplayOrder,HelpDescription,IsCategory,IsHidden,TBAD.CreatedDate,TBAD.ModifiedDate,AttributeName,AttributeTypeName,ZAIV.ControlName,  
	ZAIV.Name AS ValidationName,ZAIVR.ValidationName AS SubValidationName,ZAIVR.RegExp,ZPAV.Name AS ValidationValue,  
	CAST(CASE WHEN ZAIVR.RegExp IS NULL THEN 0 ELSE 1 END AS BIT) AS IsRegExp FROM @TBL_AttributeDetail TBAD  
	LEFT OUTER JOIN [dbo].ZnodePimAttributeValidation AS ZPAV ON(ZPAV.PimAttributeId = TBAD.PimAttributeId)  
	LEFT OUTER JOIN [dbo].ZnodeAttributeInputValidation AS ZAIV ON(ZPAV.InputValidationId = ZAIV.InputValidationId)  
	LEFT OUTER JOIN [dbo].ZnodeAttributeInputValidationRule AS ZAIVR ON(ZPAV.InputValidationRuleId = ZAIVR.InputValidationRuleId) WHERE IsCategory = 0 
	ORDER BY TBAD.DisplayOrder
          
END TRY  
BEGIN CATCH  
DECLARE @Status BIT ;  
	SET @Status = 0;  
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishAttributeDetail @AttributeCode = '+@AttributeCode+',@LocaleId='+CAST(@LocaleId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));  
                    
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
      
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_GetPublishAttributeDetail',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH;  
END;  

GO

INSERT INTO ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
SELECT
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Diagnostics & Maintenance' AND ControllerName = 'Diagnostics')
  ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Hangfire' and ActionName = 'Dashboard') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId =
   (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Diagnostics & Maintenance' AND ControllerName = 'Diagnostics') and ActionId =
   (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Hangfire' and ActionName = 'Dashboard'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
SELECT
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Diagnostics & Maintenance' AND ControllerName = 'Diagnostics'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Hangfire' and ActionName = 'Dashboard')
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId =
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Diagnostics & Maintenance' AND ControllerName = 'Diagnostics') and ActionId =
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Hangfire' and ActionName = 'Dashboard'))

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportValidatePimProductData')
	DROP PROC Znode_ImportValidatePimProductData

GO


CREATE PROCEDURE [dbo].[Znode_ImportValidatePimProductData]
(   @ImportHeadName     VARCHAR(200),
    @TableName          VARCHAR(200),
    @NewGUID            NVARCHAR(200),
    @TemplateId         INT,
    @UserId             INT,
    @LocaleId           INT           = 1,
    @IsCategory         INT           = 0,
    @DefaultFamilyId    INT           = 0,
    @ImportProcessLogId INT,
    @PriceListId        INT,
	@CountryCode VARCHAR(100) = '',
	@PimCatalogId         INT    = 0 ,
	@PortalId int = 0,
	@IsAccountAddress bit = 0 )
AS
     SET NOCOUNT ON;

/*
    Summary :   Import PimProduct / Price / Inventory / Category / Category Associated Data 
    Process :   Admin site will upload excel / csv file in database and create global temporary table
				Procedure Znode_ImportValidatePimProductData will validate data with attribute validation rule
				If datatype validation issue found in input daata will logged into table "ZnodeImportLog"
				If Data is correct and record count in table ZnodeImportLog will be 0 then process for import data into Base tables
				To import data call procedure "Znode_ImportPimProductData"
    		  
				SourceColumnName: CSV file column headers
				TargetColumnName: Attributecode from ZnodePimAttribute Table (Consider those Attributecodes configured with default family only)
*/

     BEGIN
         BEGIN TRY
             SET NOCOUNT ON;
             --BEGIN TRAN TRN_ImportValidProductData;
             DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
             DECLARE @SQLQuery NVARCHAR(MAX), @AttributeTypeName NVARCHAR(100), @AttributeCode NVARCHAR(300), @AttributeId INT, @IsRequired BIT, @SourceColumnName NVARCHAR(600), @ControlName VARCHAR(300), @ValidationName VARCHAR(100), @SubValidationName VARCHAR(300), @ValidationValue VARCHAR(300), @RegExp VARCHAR(300), @CreateDateString NVARCHAR(300), @DefaultLocaleId INT, @ImportHeadId INT, @CheckedSourceColumn NVARCHAR(600)= '', @Status BIT= 0,
			    @CsvColumnString nvarchar(max),
				@FailedRecordCount BIGINT,
				@SuccessRecordCount BIGINT
            --To get the total record count for update purpose in catch block
            SET @SQLQuery = 'SELECT '+CAST(@ImportProcessLogId AS VARCHAR(10))+',COUNT(*) FROM '+@TableName
			INSERT INTO Znode_ImportCsvRowCount
			EXEC (@SQLQuery) 

             DECLARE @FamilyAttributeDetail TABLE
             (PimAttributeId       INT,
              AttributeTypeName    VARCHAR(300),
              AttributeCode        VARCHAR(300),
              SourceColumnName     NVARCHAR(600),
              IsRequired           BIT,
              PimAttributeFamilyId INT
             );
             DECLARE @AttributeDetail TABLE
             (PimAttributeId    INT,
              AttributeTypeName VARCHAR(300),
              AttributeCode     VARCHAR(300),
              SourceColumnName  NVARCHAR(600),
              IsRequired        BIT,
              ControlName       VARCHAR(300),
              ValidationName    VARCHAR(100),
              SubValidationName VARCHAR(300),
              ValidationValue   VARCHAR(300),
              RegExp            VARCHAR(300)
             );

			CREATE TABLE #DefaultAttributeCode
			(AttributeTypeName          VARCHAR(300),
			PimAttributeDefaultValueId INT,
			PimAttributeId             INT,
			AttributeDefaultValueCode  VARCHAR(100)
			);

			IF( @ImportHeadName = 'B2BCustomer' )
			BEGIN
				EXEC ZnodeB2BCustomerMapping @ImportHeadName = @ImportHeadName, @TableName = @TableName
			END
		
             DECLARE @GlobalTempTableColumns TABLE(ColumnName NVARCHAR);
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM INFORMATION_SCHEMA.TABLES
                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#InvalidDefaultData'
             )
                 CREATE TABLE #InvalidDefaultData
                 (RowNumber  INT,
                  Value      NVARCHAR(MAX),
                  ColumnName NVARCHAR(600)
                 );
             ELSE
             DROP TABLE #InvalidDefaultData;
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM INFORMATION_SCHEMA.TABLES
                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#GlobalTempTableColumns'
             )
                 BEGIN

                     SET @SQLQuery = 'SELECT Column_Name, '''+@ImportHeadName+''' AS ImportHeadName  from tempdb.INFORMATION_SCHEMA.COLUMNS	where table_name = object_name(object_id('''+@TableName+'''),
					(select database_id from sys.databases where name = ''tempdb''))';
                     CREATE TABLE #GlobalTempTableColumns
                     (ColumnName   NVARCHAR(MAX),
                      TypeOfImport NVARCHAR(100)
                     );
                     INSERT INTO #GlobalTempTableColumns
                     (ColumnName,
                      TypeOfImport
                     )
                     EXEC sys.sp_sqlexec
                          @SQLQuery;
                 END;

             IF EXISTS
             (
                 SELECT TOP 1 1
                 FROM #GlobalTempTableColumns
                 WHERE ColumnName IN('PimCategoryId', 'PimProductId', 'RowNumber')
             )
                 BEGIN
                     INSERT INTO ZnodeImportLog
                     (ErrorDescription,
                      ColumnName,
                      Data,
                      GUID,
                      CreatedBy,
                      CreatedDate,
                      ModifiedBy,
                      ModifiedDate,
                      ImportProcessLogId
                     )
                     VALUES
                     (43,
                      '',
                      '',
                      @newGUID,
                      @UserId,
                      @GetDate,
                      @UserId,
                      @GetDate,
                      @ImportProcessLogId
                     );
                 END;
             SET @DefaultLocaleId = dbo.Fn_GetDefaultLocaleId();

             IF NOT EXISTS
             (
                 SELECT TOP 1 1  FROM ZnodeImportLog
                 WHERE Guid = @NewGUID
                       AND ErrorDescription IN(43, 42)
                 AND ImportProcessLogId = @ImportProcessLogId
             )
                 BEGIN
                     IF @ImportHeadName = 'Product'
                      BEGIN
						  IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
							  SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimProductId int null ';
						  ELSE 
							 SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimProductId int null Primary KEY CLUSTERED(RowNumber)';
						 
						  EXEC sys.sp_sqlexec @SQLQuery;
			         END;
                     ELSE
                     IF @ImportHeadName = 'Category'
                         BEGIN
							  IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimCategoryId int null ';
							  ElSE
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimCategoryId int null Primary KEY CLUSTERED(RowNumber) ';
						  
							  EXEC sys.sp_sqlexec @SQLQuery;
                         END;
                     ELSE
                         BEGIN
							IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1) ';
							Else 
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1) Primary KEY CLUSTERED(RowNumber)';
							
							EXEC sys.sp_sqlexec @SQLQuery;
                         END;;
                 END;

             SET @CreateDateString = CONVERT(VARCHAR(100), @UserId)+','''+CONVERT(VARCHAR(100), @GetDate)+''','+CONVERT(VARCHAR(100), @UserId)+','''+CONVERT(VARCHAR(100), @GetDate)+''', '+CONVERT(VARCHAR(100), @ImportProcessLogId);

             SELECT TOP 1 @ImportHeadId = ImportHeadId FROM ZnodeImportTemplate WHERE ImportTemplateId = @TemplateId;
             IF @DefaultFamilyId = 0
                AND @ImportHeadName IN('Product', 'Category')
                 BEGIN 
                     --Get all default attribute values in attribute 
                     INSERT INTO @FamilyAttributeDetail
                     (PimAttributeId,
                      AttributeTypeName,
                      AttributeCode,
                      SourceColumnName,
                      IsRequired,
                      PimAttributeFamilyId
                     )
                     --Call Process to insert data of defeult family with source column name and target column name 
                     EXEC Znode_ImportGetTemplateDetails
                          @TemplateId = @TemplateId,
                          @IsValidationRules = 0,
                          @IsIncludeRespectiveFamily = 1,
                          @IsCategory = @IsCategory,
                          @DefaultFamilyId = @DefaultFamilyId;

					---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;
             ELSE
             IF @ImportHeadName IN('Product', 'Category')
                 BEGIN
				 
                     --Get all default attribute values in attribute 
                     INSERT INTO @FamilyAttributeDetail
                     (PimAttributeId,
                      AttributeTypeName,
                      AttributeCode,
                      SourceColumnName,
                      IsRequired,
                      PimAttributeFamilyId
                     )
                     --Call Process to insert data of defeult family with source column name and target column name 
                     EXEC Znode_ImportGetTemplateDetails
                          @TemplateId = @TemplateId,
                          @IsValidationRules = 0,
                          @IsIncludeRespectiveFamily = 1,
                          @IsCategory = @IsCategory,
                          @DefaultFamilyId = @DefaultFamilyId;

					---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;      
             -- Check attributes are manditory and not provided with source table
		   	 
			if @TABLENAME	like '%tempdb..%'
				SET @SQLQuery = 'SELECT 42 AS ErrorDescription , SourceColumnName , '''' , '''+@NewGUID+''','+@CreateDateString+' from ZnodeImportTemplateMapping where ImportTemplateId = '+CONVERT(VARCHAR(100), @TemplateId)+' and ltrim(rtrim(SourceColumnName)) <> '''' AND ltrim(rtrim(SourceColumnName)) not in ( select isnull(Name ,'''') from tempdb.sys.columns where object_id = object_id('''+@TABLENAME+'''));';
			else 
				SET @SQLQuery = 'SELECT 42 AS ErrorDescription , SourceColumnName , '''' , '''+@NewGUID+''','+@CreateDateString+' from ZnodeImportTemplateMapping where ImportTemplateId = '+CONVERT(VARCHAR(100), @TemplateId)+' and ltrim(rtrim(SourceColumnName)) <> '''' AND ltrim(rtrim(SourceColumnName)) not in ( select isnull(Name ,'''') from sys.columns where object_id = object_id('''+@TABLENAME+'''));';
		 
			Declare @Tbl_CsvDynamicColulmns TABLE (ColumnName nvarchar(300), SequenceNumber int, DataType nvarchar(50),IsRequired bit )

			INSERT INTO @Tbl_CsvDynamicColulmns(ColumnName , SequenceNumber , DataType ,IsRequired)
			SELECT DISTINCT ZITM.SourceColumnName ,ZIAV.SequenceNumber, ZIAV.AttributeTypeName, ZIAV.IsRequired
			FROM ZnodeImportAttributeValidation ZIAV LEFT OUTER JOIN 
			ZnodeImportTemplate  ZIT ON ZIT.ImportHeadId =  ZIAV.ImportHeadId AND ZIT.ImportTemplateId  = @TemplateId
			LEFT OUTER JOIN ZnodeImportTemplateMapping  ZITM ON ZITM.ImportTemplateId = ZIT.ImportTemplateId  
			and ZIAV.AttributeCode = ZITM.TargetColumnName
			AND ZITM.ImportTemplateId  = @TemplateId
			WHERE ZIAV.ImportHeadId = @ImportHeadId --ORDER BY ZIAV.SequenceNumber


		    SELECT @CsvColumnString = SUBSTRING ((Select ',' +  ISNULL(ColumnName ,'NULL') from @Tbl_CsvDynamicColulmns ORDER BY SequenceNumber FOR XML PATH ('')),2,4000) 


     		INSERT INTO ZnodeImportLog(ErrorDescription, ColumnName, Data, GUID,CreatedBy, CreatedDate,  ModifiedBy,ModifiedDate,ImportProcessLogId
             )
             EXEC sys.sp_sqlexec  @SQLQuery;
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM ZnodeImportLog
                 WHERE Guid = @NewGUID
                       AND ErrorDescription IN(43, 42)
                 AND ImportProcessLogId = @ImportProcessLogId
             )
                 BEGIN
                     --Get all default attribute values in attribute 
                     IF @ImportHeadName IN('Product', 'Category')
                         BEGIN
                             -- Check attributes are manditory and not provided with source table
                             INSERT INTO ZnodeImportLog
                             (ErrorDescription,
                              ColumnName,
                              Data,
                              GUID,
                              CreatedBy,
                              CreatedDate,
                              ModifiedBy,
                              ModifiedDate,
                              ImportProcessLogId
                             )
                                    SELECT '14' AS ErrorDescription,
                                           AttributeCode,
                                           '',
                                           @NewGUID,
                                           @UserId,
                                           @GetDate,
                                           @UserId,
                                           @GetDate,
                                           @ImportProcessLogId
                                    FROM @FamilyAttributeDetail
                                    WHERE ISNULL(SourceColumnName, '') = ''
                                          AND IsRequired = 1;  

                             -- Read all attribute details with their datatype
                             INSERT INTO @AttributeDetail
                             (PimAttributeId,
                              AttributeTypeName,
                              AttributeCode,
                              SourceColumnName,
                              IsRequired,
                              ControlName,
                              ValidationName,
                              SubValidationName,
                              ValidationValue,
                              RegExp
                             )
                             EXEC Znode_ImportGetTemplateDetails
                                  @TemplateId=@TemplateId,
								  @DefaultFamilyId=@DefaultFamilyId;

							---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
							Delete FAD from @AttributeDetail FAD
							where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
							and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
										   inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode) 

                             DELETE FROM @AttributeDetail
                             WHERE AttributeTypeName = 'Image'
                                   AND ValidationName <> 'IsAllowMultiUpload';
							DELETE FROM @AttributeDetail
                             WHERE AttributeTypeName = 'File'
                                   AND ValidationName <> 'IsAllowMultiUpload';

                                     INSERT INTO #DefaultAttributeCode
                                     (AttributeTypeName,
                                      PimAttributeDefaultValueId,
                                      PimAttributeId,
                                      AttributeDefaultValueCode
                                     )
                                     --Call Process to insert default data value 
                                     EXEC Znode_ImportGetPimAttributeDefaultValue;

                                     DELETE FROM #DefaultAttributeCode
                                     WHERE AttributeTypeName = 'Yes/No';

                         END;
                     ELSE
                         BEGIN
					
					
                             --Read all attribute details with their datatype
                             INSERT INTO @AttributeDetail
                             (AttributeTypeName,
                              AttributeCode,
                              SourceColumnName,
                              IsRequired,
                              ControlName,
                              ValidationName,
                              SubValidationName,
                              ValidationValue,
                              RegExp
                             )
                             EXEC [Znode_ImportGetOtherTemplateDetails]
                                  @TemplateId = @TemplateId,
                                  @ImportHeadId = @ImportHeadId;

							IF @ImportHeadName IN('B2BCustomer')
							BEGIN

								INSERT INTO @AttributeDetail
								 (PimAttributeId,
								 AttributeTypeName,
								  AttributeCode,
								  SourceColumnName,
								  IsRequired,
								  ControlName,
								  ValidationName,
								  SubValidationName,
								  ValidationValue,
								  RegExp
								 )
								 EXEC [Znode_ImportGetGlobalTemplateDetails]
									  @TemplateId = @TemplateId,
									  @ImportHeadId = @ImportHeadId;

								
								INSERT INTO #DefaultAttributeCode
								(AttributeTypeName,
								PimAttributeDefaultValueId,
								PimAttributeId,
								AttributeDefaultValueCode
								)
								--Call Process to insert default data value 
								EXEC Znode_ImportGetGlobalAttributeDefaultValue;

								DELETE FROM #DefaultAttributeCode
								WHERE AttributeTypeName = 'Yes/No';

							END
						
                             --Check attributes are not mapped with any family of Pim Product
                             INSERT INTO ZnodeImportLog
                             (ErrorDescription,
                              ColumnName,
                              Data,
                              GUID,
                              CreatedBy,
                              CreatedDate,
                              ModifiedBy,
                              ModifiedDate,
                              ImportProcessLogId
                             )
                                    SELECT DISTINCT
                                           '14' AS ErrorDescription,
                                           AttributeCode,
                                           '',
                                           @NewGUID,
                                           @UserId,
                                           @GetDate,
                                           @UserId,
                                           @GetDate,
                                           @ImportProcessLogId
                                    FROM @AttributeDetail
                                    WHERE ISNULL(SourceColumnName, '') = ''   AND IsRequired = 1;  ;

                         END;
						
                     --	Check attributes are not mapped with (Default / Other) family of Pim Product
                     --	INSERT INTO ZnodeImportLog ( ErrorDescription , ColumnName , Data , GUID , CreatedBy , CreatedDate , ModifiedBy , ModifiedDate , ImportProcessLogId)
                     --	SELECT '1' AS ErrorDescription , SourceColumnName , '' , @NewGUID , @UserId , @GetDate , @UserId , @GetDate , @ImportProcessLogId
                     --	FROM @AttributeDetail WHERE PimAttributeId NOT IN ( SELECT zpfgm.PimAttributeId FROM dbo.ZnodePimFamilyGroupMapper AS zpfgm);
                     --	Verify data in global temporary table (column wise)
					
                     DECLARE Cr_Attribute CURSOR LOCAL FAST_FORWARD
                     FOR SELECT PimAttributeId,
                                AttributeTypeName,
                                AttributeCode,
                                IsRequired,
                                SourceColumnName,
                                ControlName,
                                ValidationName,
                                SubValidationName,
                                ValidationValue,
                                RegExp
                         FROM @AttributeDetail
                         WHERE ISNULL(SourceColumnName, '') <> '';
                     OPEN Cr_Attribute;
                     FETCH NEXT FROM Cr_Attribute INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @ControlName, @ValidationName, @SubValidationName, @ValidationValue, @RegExp;
                     WHILE @@FETCH_STATUS = 0
                         BEGIN
				             IF @AttributeTypeName = 'Number'
                                 BEGIN
							      EXEC Znode_ImportValidateNumber
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @ImportHeadId = @ImportHeadId,
                                          @ImportProcessLogId = @ImportProcessLogId;
                                 END;
							 -- Check invalid date
							
                             IF @AttributeTypeName = 'Date'
                                 BEGIN
                                     EXEC Znode_ImportValidateDate
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @ImportHeadId = @ImportHeadId,
                                          @ImportProcessLogId = @ImportProcessLogId;
                                 END;
							 -- Check Manditory Data
		 					 IF @IsRequired = 1 AND @CheckedSourceColumn <> @SourceColumnName
								BEGIN
									SET @CheckedSourceColumn = @SourceColumnName;
									EXEC Znode_ImportValidateManditoryData
									@TableName = @TableName,
									@SourceColumnName = @SourceColumnName,
									@CreateDateString = @CreateDateString,
									@ValidationName = @ValidationName,
									@ControlName = @ControlName,
									@ValidationValue = @ValidationValue,
									@NewGUID = @NewGUID,
									@ImportHeadId = @ImportHeadId;
								END;
							 --END 
							
                             IF @AttributeTypeName = 'Text'
                                 BEGIN
								 
						              EXEC Znode_ImportValidateManditoryText
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @LocaleId = @LocaleId,
                                          @DefaultLocaleId = @DefaultLocaleId,
                                          @AttributeId = @AttributeId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @ImportHeadId = @ImportHeadId;
                                 END;
                             IF @AttributeTypeName in ( 'Image','File')
                                 BEGIN
                                     EXEC Znode_ImportValidateImageData
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @LocaleId = @LocaleId,
                                          @DefaultLocaleId = @DefaultLocaleId,
                                          @AttributeId = @AttributeId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @ImportHeadId = @ImportHeadId;
                                 END;

					

                             --Check Default data value is valid 
                             IF @ImportHeadName IN('Product', 'Category','B2BCustomer')
                                 BEGIN
                                     IF @AttributeId IN
                                     (
                                         SELECT PimAttributeId
                                         FROM #DefaultAttributeCode
                                     )
                                         BEGIN
							
                                            IF  @AttributeTypeName = 'Multi Select'
											 BEGIN
										 		 ---Verify Image file is exists in media table or not 
												 SET @SQLQuery = ' INSERT INTO #InvalidDefaultData (RowNumber, Value, ColumnName) 
												 SELECT ROWNUMBER , (Select TOP 1 Item from dbo.split(' + @SourceColumnName + ','','')  SP WHERE NOT EXISTS 
												 (Select ToP 1 1 FROM #DefaultAttributeCode DAC WHERE 
												  DAC.AttributeTypeName <> ''Yes/No'' AND DAC.AttributeDefaultValueCode IS NOT NULL AND DAC.PimAttributeId = 
												 ' + CONVERT(VARCHAR(100), @AttributeId) + ' AND ltrim(rtrim(SP.Item) ) = DAC.AttributeDefaultValueCode
												 )), ''' + @SourceColumnName + ''' as [ColumnName]  FROM ' + @TableName
												 + ' Where ISnull(' + @SourceColumnName +  ','''') <> '''''
												EXEC sys.sp_sqlexec @SQLQuery;
											  END
											  ELSE IF @AttributeTypeName = 'Simple Select'
											  BEGIN
						
												---Verify Image file is exists in media table or not 
												 SET @SQLQuery = ' INSERT INTO #InvalidDefaultData (RowNumber, Value, ColumnName) 
												 SELECT ROWNUMBER , ' + @SourceColumnName + ' , ''' + @SourceColumnName + ''' as [ColumnName]  FROM ' + @TableName
												 + ' SP Where ISnull(' + @SourceColumnName +  ','''') <> '''' AND 
												  NOT EXISTS 
												 (Select TOP 1 1 FROM #DefaultAttributeCode DAC WHERE 
												  DAC.AttributeTypeName <> ''Yes/No'' AND DAC.AttributeDefaultValueCode IS NOT NULL AND DAC.PimAttributeId = 
												 ' + CONVERT(VARCHAR(100), @AttributeId) + ' AND ltrim(rtrim(SP.' + @SourceColumnName + ') ) = DAC.AttributeDefaultValueCode ) '
							
												EXEC sys.sp_sqlexec @SQLQuery;
											  END   
												-- Check Invalid Image 
												 SET @SQLQuery = 'SELECT ''9 '' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], 
												 Value AS  AttributeValue,RowNumber ,'''+@NewGUID+''',  '+@CreateDateString+' FROM #InvalidDefaultData Where Value IS NOT NULL'
												 INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, RowNumber, GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
												 EXEC sys.sp_sqlexec @SQLQuery;
												 Delete from #InvalidDefaultData

       
                                         END;
                                 END;
							
                             FETCH NEXT FROM Cr_Attribute INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @ControlName, @ValidationName, @SubValidationName, @ValidationValue, @RegExp;
                         END;
                     CLOSE Cr_Attribute;
                     DEALLOCATE Cr_Attribute;
                     --SELECT top 1 1 FROM @FamilyAttributeDetail where  iSNULL(SourceColumnName,'') = ''  and IsRequired = 1
                 END;
             
			 
			  
------------------------------------------------------------------------------------------
		 Declare @SQLQueryNew NVARCHAR(4000)
		 Declare @SourceColumnNameProduct nvarchar(4000) 
         IF @ImportHeadName IN('Product','Pricing','ProductAssociation','Inventory')
		 BEGIN
		 	 
		 SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'SKU'
		 AND ImportTemplateId = @TemplateId


			SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  SKU - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;			
		END
		ELSE IF @ImportHeadName IN('ProductAttribute')
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'AttributeCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  Attribute - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'ZipCode'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'ZIP'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  ZIPCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'Category'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'CategoryCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  CategoryCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'CategoryAssociation'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'CategoryName'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  CategoryName - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;

		END
		ELSE IF @ImportHeadName IN ('Customer','CustomerAddress')
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'UserName'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  UserName - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'SEODetails'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'Code'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  Code - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'Highlight'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'HighlightCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  HighlightCode - '' + ' + ' cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'AddonAssociation'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'SKU'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  SKU - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'AttributeDefaultValue'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'AttributeDefaultValueCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  AttributeDefaultValueCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
	-------------------------------------------------------------------------------------------------------------
	
	--------------------------------------------------------------------------------------------------------------------
			 
  		SET @SQLQuery = 'Delete FROM  '+@TableName+' Where Rownumber IN (Select Rownumber FROM ZnodeImportLog  WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND Rownumber IS NOT NULL)';
        EXEC sys.sp_sqlexec  @SQLQuery;
			 			
   
             IF @ImportHeadName IN('Product', 'Category')
                 BEGIN
                     IF NOT EXISTS
                     (
                         SELECT TOP 1 1
                         FROM @FamilyAttributeDetail
                         WHERE ISNULL(SourceColumnName, '') = ''
                               AND IsRequired = 1
                     ) AND NOT EXISTS
					 (
						 SELECT TOP 1 1
						 FROM ZnodeImportLog
						 WHERE Guid = @NewGUID
							   AND ErrorDescription IN(43, 42)
						 AND ImportProcessLogId = @ImportProcessLogId
					 )
                         BEGIN
                             IF @IsCategory = 0
                                 BEGIN

                                     EXEC Znode_ImportPimProductData
                                          @TableName = @TableName,
                                          @NewGUID = @NewGUID,
                                          @TemplateId = @TemplateId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @UserId = @UserId,
                                          @LocaleId = @LocaleId,
                                          @DefaultFamilyId = @DefaultFamilyId;

                                 END;
                             ELSE
                                 BEGIN
                                     EXEC Znode_ImportPimCategoryData
                                          @TableName = @TableName,
                                          @NewGUID = @NewGUID,
                                          @TemplateId = @TemplateId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @UserId = @UserId,
                                          @LocaleId = @LocaleId,
                                          @DefaultFamilyId = @DefaultFamilyId;
                                 END;
                         END
						 ELSE
							BEGIN
								-- Update Record count in log 
								
							
								--SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
								--EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount out
								--UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
								--WHERE ImportProcessLogId = @ImportProcessLogId;

								SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
								SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
								EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount out
								UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
								WHERE ImportProcessLogId = @ImportProcessLogId;
							END

                 END;
				IF NOT EXISTS
					 (
						 SELECT TOP 1 1
						 FROM ZnodeImportLog
						 WHERE Guid = @NewGUID
							   AND ErrorDescription IN(43, 42)
						 AND ImportProcessLogId = @ImportProcessLogId
					 )
             BEGIN
                 IF @ImportHeadName = 'Pricing'
                     BEGIN
                         EXEC [Znode_ImportPriceList]
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
                              @PriceListId = @PriceListId;
                     END;

                 IF @ImportHeadName = 'Inventory'
                     BEGIN
				
                         EXEC Znode_ImportInventory_Ver1
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID;
                     END;
                 IF @ImportHeadName = 'ZipCode'
                     BEGIN
						 EXEC Znode_ImportZipCode
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
							  @CountryCode = @CountryCode;
                     END;
					 IF @ImportHeadName = 'CategoryAssociation'
                     BEGIN
						 EXEC Znode_ImportCatalogCategory
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
							  @PimCatalogId = @PimCatalogId;
                     END;
					 IF @ImportHeadName = 'ProductAssociation'
                     BEGIN
						 EXEC Znode_ImportAssociateProducts
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID
                     END;
			
					 IF @ImportHeadName = 'SEODetails' AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportSEODetails
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
							  @LocaleId = @LocaleId,
							  @PortalId =@PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
							  @CsvColumnString = @CsvColumnString 

				
                     END;
				
					 IF @ImportHeadName = 'ProductAttribute' 
                     BEGIN
						 EXEC Znode_ImportAttributes
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
							  @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID
				
                     END;

					 IF @ImportHeadName = 'Customer' AND @PortalId > 0 
                     BEGIN
					
					
						 EXEC Znode_ImportCustomer
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = @PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
				
                     END;
					 
					 IF @ImportHeadName = 'UserApprovers' AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportUserApproval
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = @PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
				
                     END;

					 IF @ImportHeadName = 'B2BCustomer' AND @PortalId > 0 
                     BEGIN

							 EXEC Znode_ImportB2BCustomer
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = @PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
				
                     END;

					 IF @ImportHeadName = 'CustomerAddress' --AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportCustomerAddress
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = 1, -- not implemented from forntend 
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString,
							  @IsAccountAddress = @IsAccountAddress
				
                     END;
					 IF @ImportHeadName = 'ShippingAddress' --AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportCustomerAddress
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = 1, -- not implemented from forntend 
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString,
							  @IsAccountAddress = @IsAccountAddress
				
                     END;
					 IF @ImportHeadName = 'StoreLocator' --AND @PortalId > 0 
                     BEGIN
					 	 EXEC Znode_ImportStoreLocatorAddress
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
                     END;

					IF @ImportHeadName = 'Highlight'
					BEGIN
					EXEC Znode_ImportHighlight 
					@TableName = @TableName, 
					@Status = @Status, 
					@UserId = @UserId, 
					@ImportProcessLogId = @ImportProcessLogId, 
					@NewGUID = @NewGUID 
					END;

					IF @ImportHeadName = 'AddonAssociation'
					BEGIN
					EXEC Znode_ImportAddonAssociation 
					@TableName = @TableName, 
					@Status = @Status, 
					@UserId = @UserId, 
					@ImportProcessLogId = @ImportProcessLogId, 
					@NewGUID = @NewGUID,
					@PimCatalogId = @PimCatalogId
					END;

					IF @ImportHeadName = 'AttributeDefaultValue'
					BEGIN
					EXEC Znode_ImportAttributeDefaultValue 
					@TableName = @TableName, 
					@Status = @Status, 
					@UserId = @UserId, 
					@ImportProcessLogId = @ImportProcessLogId, 
					@NewGUID = @NewGUID
					
					END;

					IF @ImportHeadName = 'Voucher'
					BEGIN
						EXEC Znode_ImportVoucher 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID
					
					END;

					IF @ImportHeadName = 'Account'
					BEGIN
						
						EXEC Znode_ImportAccount 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID,
						@CsvColumnString = @CsvColumnString,
						@PortalId = @PortalId
					
					END;
				 
             END
			 ELSE 
				 BEGIN
					-- Update Record count in log 	
					SET @SQLQuery = ' Select @FailedRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
					EXEC	sp_executesql @SQLQuery , N'@FailedRecordCount BIGINT out' , @FailedRecordCount =@FailedRecordCount out
					SELECT @SuccessRecordCount = 0
									
					UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
					WHERE ImportProcessLogId = @ImportProcessLogId;

				 END

             EXEC Znode_ImportReadErrorLog
                  @ImportProcessLogId = @ImportProcessLogId,
                  @NewGUID = @NewGUID;
             DROP TABLE #GlobalTempTableColumns;

             -- Finally call product insert process if error not found in error log table 
             IF EXISTS
             (
                 SELECT TOP 1 1
                 FROM ZnodeImportLog
                 WHERE ImportProcessLogId = @ImportProcessLogId
                       AND Guid = @NewGUID
             )
                 BEGIN
                     --Update process with completed status for current import 
                     UPDATE ZnodeImportProcessLog
                       SET
                           Status = dbo.Fn_GetImportStatus(3),
                           ProcessCompletedDate = GETDATE()
                       WHERE ImportProcessLogId = @ImportProcessLogId;
                 END;
				 SET @SQLQuery = 'IF Object_id(''+@TableName+'') IS NOT NULL  DROP TABLE ' + @TableName
                 EXEC sys.sp_sqlexec @SQLQuery;

				 print 'end';
         END TRY
         BEGIN CATCH
			DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE()
			DECLARE @TempCount TABLE (Id INT)

			Declare @SQL Varchar(max) = 'Select Count(*) As Id From '+@TableName
			INSERT INTO @TempCount
			EXEC (@SQL)

             SELECT ERROR_MESSAGE(),
                    ERROR_LINE(),
                    ERROR_PROCEDURE();
             EXEC Znode_ImportReadErrorLog
                  @ImportProcessLogId = @ImportProcessLogId,
                  @NewGUID = @NewGUID; 
             
			 ---Import process updating fail due to database error
			UPDATE ZnodeImportProcessLog
			SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
			WHERE ImportProcessLogId = @ImportProcessLogId;

			---Loging error for Import process due to database error
		    INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		    SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

			--Updating total and fail record count
		    UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		    TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		    WHERE ImportProcessLogId = @ImportProcessLogId;

			SET @SQLQuery = 'Drop Table ' + @TableName
            EXEC sys.sp_sqlexec @SQLQuery;
             --ROLLBACK TRAN TRN_ImportValidProductData;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_RevertOrderInventory')
	DROP PROC Znode_RevertOrderInventory

GO

CREATE PROCEDURE [dbo].[Znode_RevertOrderInventory]
(   
	@OmsOrderDetailsId INT,
    @OmsOrderLineItemIds VARCHAR(2000) = '',
    @Status BIT OUT,
    @UserId INT,
	@IsRevertAll BIT = 0
)
AS 
   /* Summary: this proceedure is used to revert the order  inventory in case of order revert
      Unit Testing:
	  begin tran
	  EXEC  Znode_RevertOrderInventory 
      rollback tran
    */
BEGIN
BEGIN TRAN ZROI;
BEGIN TRY
		SET NOCOUNT ON;
		DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
		DECLARE @Revert NVARCHAR(MAX), @SQL NVARCHAR(MAX)
		CREATE TABLE  #OmsOrderLineItemsId (OmsOrderLineItemsId INT);
		--Getting line item ids
		INSERT INTO #OmsOrderLineItemsId
		SELECT item
		FROM dbo.split(@OmsOrderLineItemIds, ',');

		--Getting parent line item ids for downloadable product
		INSERT INTO #OmsOrderLineItemsId
		SELECT ZOOLI.ParentOmsOrderLineItemsId 
		FROM ZnodeOmsOrderLineItems ZOOLI WITH (NOLOCK)
		INNER JOIN #OmsOrderLineItemsId OLI on ZOOLI.OmsOrderLineItemsId=OLI.OmsOrderLineItemsId
		WHERE EXISTS (SELECT * FROM ZnodeOmsDownloadableProductKey Z where Z.OmsOrderLineItemsId=ZOOLI.ParentOmsOrderLineItemsId)
		AND NOT EXISTS (SELECT * FROM #OmsOrderLineItemsId O where O.OmsOrderLineItemsId=ZOOLI.ParentOmsOrderLineItemsId)

		--Getting parent line item ids for downloadable product on basis of OmsOrderDetailsId
		INSERT INTO #OmsOrderLineItemsId
		SELECT ZOOLI.OmsOrderLineItemsId 
		FROM ZnodeOmsOrderLineItems ZOOLI WITH (NOLOCK)
		WHERE ZOOLI.OmsOrderDetailsId = @OmsOrderDetailsId and ZOOLI.OrderLineItemStateId=40
		AND EXISTS (SELECT * FROM ZnodeOmsDownloadableProductKey Z WHERE Z.OmsOrderLineItemsId=ZOOLI.OmsOrderLineItemsId)
		AND NOT EXISTS (SELECT * FROM #OmsOrderLineItemsId O WHERE O.OmsOrderLineItemsId=ZOOLI.OmsOrderLineItemsId)

		--Updating the used key for revert order of downloadable product
		IF EXISTS(SELECT * FROM #OmsOrderLineItemsId)
		BEGIN
			UPDATE ZnodePimDownloadableProductKey
			SET IsUsed = 0,	
				ModifiedDate= GETDATE()
			WHERE EXISTS (SELECT TOP 1 1 FROM ZnodeOmsDownloadableProductKey ZODPK 
				INNER JOIN #OmsOrderLineItemsId OOLI ON OOLI.OmsOrderLineItemsId= ZODPK.OmsOrderLineItemsId
				WHERE ZnodePimDownloadableProductKey.PimDownloadableProductKeyId = ZODPK.PimDownloadableProductKeyId)
		END
		
		--Reverting the quantity of produucts after return
		SET @SQL = '
			
		UPDATE ZI
		SET
			ZI.Quantity = ZI.Quantity + ZOOW.Quantity,
			ZI.MOdifiedBy = '''+CAST(@UserId AS VARCHAR(1000))+''',
			ZI.ModifiedDate = '''+CAST(@GetDate AS VARCHAR(1000))+'''
		FROM ZnodeOmsOrderWarehouse ZOOW
			INNER JOIN ZnodeOmsOrderLineItems ZOOLI ON(ZOOLI.OmsOrderLineItemsId = ZOOW.OmsOrderLineItemsId)
			INNER JOIN ZnodeInventory ZI ON(ZI.WarehouseId = ZOOW.WarehouseId
											AND ZI.SKU = ZOOLI.SKU)
		WHERE 
		ZOOLI.OmsOrderDetailsId = '+CAST(@OmsOrderDetailsId AS VARCHAR(1000))+'
			AND EXISTS
		(
			SELECT TOP 1 1     FROM #OmsOrderLineItemsId SP WHERE Sp.OmsOrderLineItemsId = ZOOLI.OmsOrderLineItemsId OR Sp.OmsOrderLineItemsId = ZOOLI.ParentOmsOrderLineItemsId OR '''+@OmsOrderLineItemIds+''' = ''''
		)  
		' +CASE WHEN @IsRevertAll = 0 THEN 'AND NOT EXISTS   (SELECT TOP  1 1 FROM ZnodeOmsOrderState OOS WHERE OOS.OrderStateName = ''RETURNED'' AND OOS.OmsOrderStateId = ZOOLI.OrderLineItemStateId) ' ELSE '' END

		EXEC(@SQL)

		SET @Status = 1;
		SELECT 1 ID, CAST(1 AS BIT) Status;

COMMIT TRAN ZROI;
END TRY
BEGIN CATCH
    DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_RevertOrderInventory @OmsOrderDetailsId = '+CAST(@OmsOrderDetailsId AS VARCHAR(200))+',@OmsOrderLineItemIds='+@OmsOrderLineItemIds+',@UserId='+CAST(@UserId AS VARCHAR(200))+',@Status='+CAST(@Status AS VARCHAR(200));
    SET @Status = 0;
    SELECT 0 AS ID,
        CAST(0 AS BIT) AS Status;
	ROLLBACK TRAN ZROI;
    EXEC Znode_InsertProcedureErrorLog
        @ProcedureName = 'Znode_RevertOrderInventory',
        @ErrorInProcedure = @Error_procedure,
        @ErrorMessage = @ErrorMessage,
        @ErrorLine = @ErrorLine,
        @ErrorCall = @ErrorCall;
END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_UpdatePimDownloadableProductKey')
	DROP PROC Znode_UpdatePimDownloadableProductKey

GO

CREATE PROCEDURE [dbo].[Znode_UpdatePimDownloadableProductKey]
(   
	@OrderLineItemDataModel XML,
	@Status INT = 0 OUT
)
AS
  /* 
	Summary :- This Procedure is used to update the Znode_UpdatePimDownloadableProductKey 
				
	
   */
BEGIN 
BEGIN TRY
BEGIN TRAN UpdatePimDownloadableProductKey;
SET NOCOUNT ON;
	CREATE TABLE #SKU (Sku INT);
			 
	IF OBJECT_ID('tempdb..#SkuQuantityUpdate') IS NOT NULL 
		DROP TABLE #SkuQuantityUpdate
    --Getting xml data into table
	SELECT  Tbl.Col.value ( 'OmsOrderLineItemsId[1]' , 'INT') AS OmsOrderLineItemsId
		,Tbl.Col.value ( 'ParentOmsOrderLineItemsId[1]' , 'INT') AS ParentOmsOrderLineItemsId,
		Tbl.Col.value ( 'Sku[1]' , 'NVARCHAR(max)') AS Sku
		,Tbl.Col.value ( 'Quantity[1]' , 'Numeric(28,6)') AS Quantity
	INTO #SkuQuantityUpdate
	FROM @OrderLineItemDataModel.nodes ( '//ArrayOfOrderLineItemDataModel/OrderLineItemDataModel'  ) AS Tbl(Col)

	ALTER TABLE #SkuQuantityUpdate ADD OmsLineItemId INT,PimDownloadableProductKeyId INT;

	UPDATE #SkuQuantityUpdate
	SET OmsLineItemId = OmsOrderLineItemsId;

	--Updating the ParentOmsOrderLineItemsId
	UPDATE OLI
	SET OmsLineItemId =  ZOOLI.ParentOmsOrderLineItemsId,PimDownloadableProductKeyId=Z.PimDownloadableProductKeyId
	FROM ZnodeOmsOrderLineItems ZOOLI WITH (NOLOCK)
	INNER JOIN #SkuQuantityUpdate OLI ON ZOOLI.OmsOrderLineItemsId=OLI.OmsOrderLineItemsId
	INNER JOIN ZnodeOmsDownloadableProductKey Z WITH (NOLOCK) ON Z.OmsOrderLineItemsId=ZOOLI.ParentOmsOrderLineItemsId
	WHERE NOT EXISTS (SELECT * FROM #SkuQuantityUpdate O WHERE O.OmsOrderLineItemsId=ZOOLI.ParentOmsOrderLineItemsId)

    IF OBJECT_ID('tempdb..#FinalProductKey') IS NOT NULL 
		DROP TABLE #FinalProductKey
		
	--Getting the product key of downloadable products
	SELECT ZPDPK.PimDownloadableProductKeyId,S.Quantity, RANK() OVER(PARTITION BY ZPDPK.PimDownloadableProductKeyId ORDER BY ZPDPK.PimDownloadableProductKeyId DESC) RNK  
	INTO #FinalProductKey 
	FROM ZnodePimDownloadableProductKey ZPDPK WITH (NOLOCK)
	INNER JOIN ZnodePimDownloadableProduct ZPDP WITH (NOLOCK) ON ZPDP.PimDownloadableProductId = ZPDPK.PimDownloadableProductId
	INNER JOIN #SkuQuantityUpdate S ON  ZPDP.SKU=S.Sku AND S.PimDownloadableProductKeyId = ZPDPK.PimDownloadableProductKeyId

	--Update IsUsed for downloadable products for return 
	UPDATE ZnodePimDownloadableProductKey
	SET IsUsed = 0		
	WHERE PimDownloadableProductKeyId IN (SELECT ISNULL(PimDownloadableProductKeyId,0) FROM #FinalProductKey WHERE RNK <= Quantity )

	SET @Status = 1
	SELECT 1 AS ID,CAST(@Status AS BIT) AS Status; 

COMMIT TRAN UpdatePimDownloadableProductKey;
END TRY
BEGIN CATCH
           	     
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_UpdatePimDownloadableProductKey @OrderLineItemDataModel = '+ cast(@OrderLineItemDataModel as varchar(2000));
    SET @Status = 0          			 
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
	ROLLBACK TRAN UpdatePimDownloadableProductKey;	  
	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_UpdatePimDownloadableProductKey',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishProductPricingBySku')
	DROP PROC Znode_GetPublishProductPricingBySku

GO

CREATE PROCEDURE [dbo].[Znode_GetPublishProductPricingBySku]
(   
    @SKU              VARCHAR(MAX),
    @PortalId         INT,
    @currentUtcDate   VARCHAR(100), -- this date is required for the user date r
    @UserId           INT          = 0, -- userid is optional
	@ProfileId        INT          = 0, 
	@OmsOrderId		  INT        = 0,
	@IsFetchPriceFromOrder  BIT          = 0,
    @PublishProductId TransferId READONLY,
	@IsDebug          BIT          = 0
)
AS 
/* 
--Summary: Retrive Price of product FROM pricelist
--Input Parameters:
--UserId, SKU(Comma separated multiple), PortalId
--Conditions :
--1. If userId is null then check for PriceList having sku associated to profile which is associated to Portal having  PortalId and  having higher Precedence and valid ActivationDate and ExpirationDate for PriceList  and SKU also.
--Unit Testing : 
--EXEC Znode_GetPublishProductPricingBySku_2 @SKU = 'apple,apr234' , @PortalId = 34 , @currentUtcDate = '2016-09-17 00:00:00.000';
--2. If There is no any PriceList having given sku associated to profile  then check for  
--PriceList associated portal having PortalId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
--Unit Testing : 
--EXEC Znode_GetPublishProductPricingBySku_2 @SKU = 'apple,apr234' , @PortalId = 34 , @currentUtcDate = '2016-09-17 00:00:00.000';
--3. If userId is not null then check for PriceList having sku associated to User having UserId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
--4. If There is no any PriceList having given sku associated to user  then check for  
--PriceList associated Account having UserId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
--5. If There is no any PriceList having given sku associated to account  then check for  
--PriceList associated Profile having PortalId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
--6. If There is no any PriceList having given sku associated to Profile  then check for  
--PriceList associated Portal having PortalId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
--7. If in each case Precedence is same then get PriceList according to higher PriceListId ActivationDate and ExpirationDate for PriceList and SKU also.
--8. Also get the Tier Price, Tier Quantity of given sku.
--Unit Testing   
--Exec Znode_GetPublishProductPricingBySku  @SKU = 'Levi''s T-Shirt & Jeans - Bundle Product',@PortalId = 1, @currentUtcDate = '2016-07-31 00:00:00.000'
*/
    
     BEGIN
         BEGIN TRY
             SET NOCOUNT ON;
			 DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
             CREATE TABLE #Tlb_SKU 
             (
				SKU        VARCHAR(100),
				SequenceNo INT IDENTITY
             );

			 CREATE INDEX Idx_#Tlb_SKU ON #Tlb_SKU(SKU)
			  
			 DECLARE @DefaultLocaleId INT = dbo.FN_GETDEFAULTLocaleId()

			 IF @SKU = '' 
			 BEGIN 
				INSERT INTO #Tlb_SKU(SKU)
				SELECT SKU
				FROM ZnodePublishProductDetail a
				INNER JOIN @PublishProductId b ON (b.Id = a.PublishProductId )
				WHERE LocaleId = @DefaultLocaleId

			 END 
			 ELSE 
			 BEGIN
				INSERT INTO #Tlb_SKU(SKU)
				SELECT Item FROM Dbo.split(@SKU, ',');
			 END 

		-- DECLARE #TLB_SKUPRICELIST TABLE
		CREATE TABLE #TLB_SKUPRICELIST
		(
			SKU VARCHAR(100),
			RetailPrice NUMERIC(28, 6),
			SalesPrice NUMERIC(28, 6),
			PriceListId INT,
			TierPrice NUMERIC(28, 6),
			TierQuantity NUMERIC(28, 6),
			ExternalId NVARCHAR(2000),
			Custom1 NVARCHAR(MAX),
			Custom2 NVARCHAR(MAX),
			Custom3 NVARCHAR(MAX)
        );
        DECLARE @PriceListId INT, @PriceRoundOff INT;
        SELECT @PriceRoundOff = CONVERT( INT, FeatureValues)
        FROM ZnodeGlobalSetting
        WHERE FeatureName = 'PriceRoundOff';
		
        --Retrive portal wise pricelist  
		CREATE TABLE #Tbl_PortalWisePriceList  
		(
			PriceListId    INT,
			ActivationDate DATETIME,
			ExpirationDate DATETIME NULL,
			Precedence     INT,
			SKU NVARCHAR(300)
        );
        --Retrive price for respective pricelist   
        CREATE TABLE #Tbl_PriceListWisePriceData 
        (
			PriceListId INT,
			SKU VARCHAR(300),
			SalesPrice NUMERIC(28, 6),
			RetailPrice NUMERIC(28, 6),
			UomId INT,
			UnitSize NUMERIC(28, 6),
			ActivationDate DATETIME,
			ExpirationDate DATETIME NULL,
			TierPrice NUMERIC(28, 6),
			TierQuantity NUMERIC(28, 6),
			TierUomId INT,
			TierUnitSize NUMERIC(28, 6), 
			ExternalId NVARCHAR(2000),
			Custom1 NVARCHAR(MAX),
			Custom2 NVARCHAR(MAX),
			Custom3 NVARCHAR(MAX)
        );
			
	CREATE TABLE #Tbl_SKUWisePriceList(PriceListId INT, SKU NVARCHAR(300))

			INSERT INTO #Tbl_SKUWisePriceList(PriceListId,SKU) 
			SELECT  PriceListId,SKU from ZnodePrice ZP where exists(Select SKU from #Tlb_SKU SKU where SKU.SKU = ZP.SKU )
			Union
			SELECT PriceListId,SKU  from ZnodePriceTier ZPT where exists(Select SKU from #Tlb_SKU SKU where SKU.SKU = ZPT.SKU )
			 
	--1. If userId is null then check for PriceList having sku associated to profile which is associated to Portal having  PortalId and  having higher Precedence and valid ActivationDate and ExpirationDate for PriceList  and SKU also.
    IF @UserId = 0
    BEGIN
		INSERT INTO #Tbl_PortalWisePriceList( PriceListId, ActivationDate, ExpirationDate, Precedence,SKU )
		SELECT a.PriceListId, ActivationDate, ISNULL(ExpirationDate, @GetDate), b.Precedence,tsw.SKU
		FROM ZnodePriceList AS a 
		INNER JOIN ZnodePriceListProfile AS b ON a.PriceListId = b.PriceListId 
		INNER JOIN ZnodePortalProfile AS c ON b.PortalProfileId = c.PortalProfileID AND  c.IsDefaultAnonymousProfile = 1 INNER JOIN ZnodePortalunit AS zupu ON a.CultureId = zupu.CultureId 
		INNER JOIN #Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
		WHERE @CurrentUtcDate BETWEEN a.ActivationDate AND ISNULL(a.ExpirationDate, @GetDate) AND c.PortalId = @PortalId
		ORDER BY b.Precedence;
		
			 
		--2. If There is no any PriceList having given sku associated to profile  then check for PriceList associated portal having PortalId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
		IF EXISTS (SELECT top 1 1  FROM #Tbl_SKUWisePriceList tspl WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Tbl_PortalWisePriceList tpwl
					WHERE tspl.SKU = tpwl.SKU))
		BEGIN
			INSERT INTO #Tbl_PortalWisePriceList( PriceListId, ActivationDate, ExpirationDate, Precedence,SKU )
			SELECT a.PriceListId, ActivationDate, ISNULL(ExpirationDate, @GetDate), b.Precedence,tsw.SKU
			FROM ZnodePriceList AS a INNER JOIN ZnodePriceListPortal AS b ON a.PriceListId = b.PriceListId
			INNER JOIN ZnodePortalunit AS zupu ON a.CultureId = zupu.CultureId   
			INNER JOIN #Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
			AND NOT EXISTS (SELECT TOP 1 1 FROM  #Tbl_PortalWisePriceList tpwl WHERE tpwl.SKU = tsw.SKU )
			WHERE @CurrentUtcDate BETWEEN a.ActivationDate 
			AND ISNULL(a.ExpirationDate, @GetDate) AND b.PortalId = @PortalId
			ORDER BY b.Precedence
			;				
		END;
    END;
    --3. If userId is not null then check for PriceList having sku associated to User having UserId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
    ELSE
    BEGIN
				 
		INSERT INTO #Tbl_PortalWisePriceList (PriceListId, ActivationDate, ExpirationDate, Precedence,SKU )
		SELECT a.PriceListId, ActivationDate,ISNULL(ExpirationDate, @GetDate), b.Precedence,tsw.SKU
		FROM ZnodePriceList AS a 
		INNER JOIN ZnodePriceListUser AS b ON a.PriceListId = b.PriceListId
		INNER JOIN ZnodePortalunit zupu ON a.CultureId = zupu.CultureId AND zupu.PortalId = @PortalId  
		INNER JOIN #Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
				AND NOT EXISTS (SELECT TOP 1 1 FROM  #Tbl_PortalWisePriceList tpwl WHERE tpwl.SKU = tsw.SKU )
		WHERE @CurrentUtcDate BETWEEN a.ActivationDate AND ISNULL(a.ExpirationDate, @GetDate) AND b.UserID = @UserId
		ORDER BY b.Precedence ;

		--4. If There is no any PriceList having given sku associated to user  then check for PriceList associated Account having UserId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
		IF EXISTS (SELECT top 1 1  FROM #Tbl_SKUWisePriceList tspl WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Tbl_PortalWisePriceList tpwl
				WHERE tspl.SKU = tpwl.SKU))
						BEGIN
							INSERT INTO #Tbl_PortalWisePriceList( PriceListId, ActivationDate, ExpirationDate, Precedence,SKU )
								   SELECT a.PriceListId, ActivationDate, ISNULL(ExpirationDate, @GetDate), c.Precedence,tsw.SKU
								   FROM ZnodePriceList AS a INNER JOIN ZnodePriceListAccount AS c ON a.PriceListId = c.PriceListId
										INNER JOIN ZnodeUser AS d ON c.Accountid = d.Accountid INNER JOIN ZnodePortalunit AS zupu ON a.CultureId = zupu.CultureId   
										AND zupu.PortalId = @PortalId
										inner join #Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
										AND NOT EXISTS (Select TOP 1 1 FROM  #Tbl_PortalWisePriceList tpwl WHERE tpwl.SKU = tsw.SKU )
								   WHERE @CurrentUtcDate BETWEEN a.ActivationDate AND ISNULL(a.ExpirationDate, @GetDate) AND d.UserID = @UserId
									ORDER BY c.Precedence
							--Delete from #Tbl_SKUWisePriceList where PriceListId in (Select PriceListId from  #Tbl_PortalWisePriceList )
						 END;
                     -- 5. If There is no any PriceList having given sku associated to account  then check for PriceList associated Profile having PortalId and having higher   Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
				IF Exists (Select top 1 1  FROM #Tbl_SKUWisePriceList tspl 
				where NOT Exists (SELECT TOP 1 1 FROM #Tbl_PortalWisePriceList tpwl
				WHERE tspl.SKU = tpwl.SKU))

                         BEGIN
                             INSERT INTO #Tbl_PortalWisePriceList(PriceListId,ActivationDate,ExpirationDate,Precedence,SKU)
                                    SELECT a.PriceListId, ActivationDate, ISNULL(ExpirationDate, @GetDate), b.Precedence,tsw.SKU
                                    FROM ZnodePriceList AS a
                                         INNER JOIN ZnodePriceListProfile AS b ON a.PriceListId = b.PriceListId 
										 INNER JOIN ZnodePortalProfile AS c ON b.PortalProfileId = c.PortalProfileId  AND c.PortalId = @PortalId                                          
                                         INNER JOIN ZnodePortalunit zupu ON a.CultureId = zupu.CultureId AND zupu.PortalId = @PortalId 
										 inner join #Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
										 AND NOT EXISTS (Select TOP 1 1 FROM  #Tbl_PortalWisePriceList tpwl WHERE tpwl.SKU = tsw.SKU )
                                    WHERE @CurrentUtcDate BETWEEN a.ActivationDate AND ISNULL(a.ExpirationDate, @GetDate) 
									AND EXISTS (SELECT TOP 1 1 FROM dbo.ZnodeUserProfile zup WHERE c.ProfileId = zup.ProfileId AND (IsDefault = 1 OR   @ProfileId <> 0)
									AND (( zup.UserId = @UserId OR  @ProfileId <> 0) AND (ZUP.ProfileId = @ProfileId OR @ProfileId = 0 )));  
					     END;
                   ---6. If There is no any PriceList having given sku associated to Profile  then check for priceList associated Portal having PortalId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
						IF Exists (Select top 1 1 FROM #Tbl_SKUWisePriceList tspl 
						WHERE NOT Exists (SELECT TOP 1 1 FROM #Tbl_PortalWisePriceList tpwl WHERE tspl.SKU = tpwl.SKU))

                         BEGIN
							INSERT INTO #Tbl_PortalWisePriceList( PriceListId, ActivationDate, ExpirationDate, Precedence,SKU )
							SELECT a.PriceListId, ActivationDate, ISNULL(ExpirationDate, @GetDate), b.Precedence,tsw.SKU
							FROM ZnodePriceList AS a INNER JOIN ZnodePriceListPortal AS b ON a.PriceListId = b.PriceListId
								INNER JOIN ZnodePortalunit AS zupu ON a.CultureId = zupu.CultureId AND  zupu.PortalId = b.PortalId    
								inner join #Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
								AND NOT EXISTS (Select TOP 1 1 FROM  #Tbl_PortalWisePriceList tpwl WHERE tpwl.SKU = tsw.SKU )
								WHERE @CurrentUtcDate BETWEEN a.ActivationDate AND ISNULL(a.ExpirationDate, @GetDate) AND b.PortalId = @PortalId
							    ORDER BY b.Precedence;
						 END;
						 
				--IF Exists (Select top 1 1  FROM #Tbl_SKUWisePriceList tspl where NOT Exists (SELECT TOP 1 1 FROM #Tbl_PortalWisePriceList tpwl
				--WHERE tspl.SKU = tpwl.SKU))
				--BEGIN
				
				--	INSERT INTO #Tbl_PortalWisePriceList( PriceListId, ActivationDate, ExpirationDate, Precedence,SKU )
				--	SELECT a.PriceListId, ActivationDate, ISNULL(ExpirationDate, @GetDate), b.Precedence,tsw.SKU
				--	FROM ZnodePriceList AS a INNER JOIN ZnodePriceListProfile AS b ON a.PriceListId = b.PriceListId INNER JOIN ZnodePortalProfile AS c
				--	ON b.ProfileId = c.ProfileId AND  c.IsDefaultAnonymousProfile = 1 INNER JOIN ZnodePortalunit AS zupu ON a.CurrencyId = zupu.CurrencyId
				--	inner join #Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
				--	AND NOT EXISTS (Select TOP 1 1 FROM  #Tbl_PortalWisePriceList tpwl WHERE tpwl.SKU = tsw.SKU )
				--	WHERE @CurrentUtcDate BETWEEN a.ActivationDate AND ISNULL(a.ExpirationDate, @GetDate) AND c.PortalId = @PortalId;
				--END

                 END;
			
             SET @PriceListId = 0;
             -- Check Activation date and expiry date 
			
			 If (@OmsOrderId>0  and  @IsFetchPriceFromOrder=1)
			   begin 
			      EXEC Znode_GetOrderPricList @OmsOrderId=@OmsOrderId,@SKU=@SKU,@PublishProductId=@PublishProductId;
		       end


             else 
			 begin
				 IF EXISTS( SELECT TOP 1 1 FROM #Tbl_PortalWisePriceList)
					 begin
						 -- Declare  @d datetime
						 -- SET @d = @GetDate
						 -- Select ISNULL(ActivationDate,@d)  , ISNULL( ExpirationDate,@GetDate ),b.Precedence,* from ZnodePriceList  a inner join ZnodePriceListPortal b on a.PriceListId = b.PriceListId where @d between ISNULL(ActivationDate,@d) 
						 -- and ISNULL(ExpirationDate,@GetDate ) --and a.PriceListId <>  80
						 -- Order by ISNULL(ActivationDate,@d)  , ISNULL( ExpirationDate,@GetDate ) ,  b.Precedence DESC 
						 --	Retrive pricelist wise price
					   
					   SET @PriceListId =( SELECT TOP 1 PriceListId FROM #Tbl_PortalWisePriceList ORDER BY Precedence  );

					   INSERT INTO #Tbl_PriceListWisePriceData( PriceListId, SKU, SalesPrice, RetailPrice, UomId, UnitSize, ActivationDate, ExpirationDate, TierPrice, TierQuantity, TierUomId, TierUnitSize , ExternalId ,Custom1,Custom2,Custom3)
					   SELECT ZP.PriceListId, ZP.SKU, ZP.SalesPrice, ZP.RetailPrice, ZP.UomId, ZP.UnitSize, ISNULL(ZP.ActivationDate, @CurrentUtcDate), ISNULL(ZP.ExpirationDate, @GetDate), ZPT.Price, ZPT.Quantity, ZPT.UomId, ZPT.UnitSize, ZP.ExternalId,
					   ZPT.Custom1,ZPT.Custom2,ZPT.Custom3
					   FROM [ZnodePrice] AS ZP 
					   INNER JOIN #Tlb_SKU AS TSKU ON (ZP.SKU = TSKU.SKU )
					   LEFT OUTER JOIN ZnodePriceTier AS ZPT ON ZP.SKU = ZPT.SKU AND ZP.PriceListId = ZPT.PriceListId
					   WHERE ZP.PriceListId = @PriceListId

					   -- Check Activation date and expiry date 
						INSERT INTO #TLB_SKUPRICELIST( PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId,Custom1,Custom2,Custom3 )
						   SELECT DISTINCT  PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId,Custom1,Custom2,Custom3
						   FROM #Tbl_PriceListWisePriceData
						   WHERE @currentUtcDate BETWEEN ActivationDate AND ISNULL(ExpirationDate, @GetDate);
					   
			INSERT INTO #TLB_SKUPRICELIST( PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId ,Custom1,Custom2,Custom3)
			SELECT PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId,Custom1,Custom2,Custom3
			FROM #Tbl_PriceListWisePriceData
			WHERE SKU NOT IN(SELECT SKU FROM #TLB_SKUPRICELIST) and ActivationDate is null 
				
        END;
        -- Retrive data as per precedance FROM ZnodePriceListPortal table  
					
        ELSE
        BEGIN
			SET @PriceListId =( SELECT TOP 1 PriceListId FROM #Tbl_PortalWisePriceList ORDER BY Precedence  );

			--Retrive pricelist wise price  
			INSERT INTO #Tbl_PriceListWisePriceData( PriceListId, SKU, SalesPrice, RetailPrice, UomId, UnitSize, ActivationDate, ExpirationDate, TierPrice, TierQuantity, TierUomId, TierUnitSize, ExternalId ,Custom1,Custom2,Custom3)
			SELECT ZP.PriceListId, ZP.SKU, ZP.SalesPrice, ZP.RetailPrice, ZP.UomId, ZP.UnitSize, ISNULL(ZP.ActivationDate, @CurrentUtcDate), 
				ISNULL(ZP.ExpirationDate, @GetDate), ZPT.Price, ZPT.Quantity, ZPT.UomId, ZPT.UnitSize, zp.ExternalId,Custom1,Custom2,Custom3
			FROM [ZnodePrice] AS ZP INNER JOIN #Tlb_SKU AS TSKU ON ZP.SKU = TSKU.SKU LEFT OUTER JOIN ZnodePriceTier AS ZPT ON ZP.SKU = ZPT.SKU AND 
					ZP.PriceListId = ZPT.PriceListId WHERE ZP.PriceListId = @PriceListId; 

				-- Check Activation date and expiry date 
			INSERT INTO #TLB_SKUPRICELIST( PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId ,Custom1,Custom2,Custom3)
			SELECT PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId,Custom1,Custom2,Custom3
			FROM #Tbl_PriceListWisePriceData WHERE @currentUtcDate BETWEEN ActivationDate AND ISNULL(ExpirationDate, @GetDate);
					
			INSERT INTO #TLB_SKUPRICELIST( PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId ,Custom1,Custom2,Custom3)
			SELECT PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId,Custom1,Custom2,Custom3
			FROM #Tbl_PriceListWisePriceData
			WHERE SKU NOT IN ( SELECT SKU FROM #TLB_SKUPRICELIST) and ActivationDate is null;

        END;
        SELECT SKU,
            ROUND(RetailPrice, @PriceRoundOff) AS RetailPrice,
            ROUND(SalesPrice, @PriceRoundOff) AS SalesPrice,
            ROUND(TierPrice, @PriceRoundOff) AS TierPrice,
            ROUND(TierQuantity, @PriceRoundOff) AS TierQuantity,
			ZCC.CurrencyCode  AS CurrencyCode,    
            ZC.Symbol AS CurrencySuffix,  ZC.CultureCode,
			TSPL.ExternalId,
			Custom1,Custom2,Custom3
        FROM #TLB_SKUPRICELIST AS TSPL
        INNER JOIN ZnodePriceList AS ZPL ON TSPL.PriceListId = ZPL.PriceListId
        INNER JOIN ZnodeCulture AS ZC ON ZPL.CultureId = ZC.CultureId    
		LEFT JOIN ZnodeCurrency AS ZCC ON ZC.CurrencyId = ZCC.CurrencyId   
		ORDER BY TierQuantity ASC;
END
END TRY
BEGIN CATCH
    DECLARE @Status BIT ;
	SET @Status = 0;
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishProductPricingBySku @SKU = '+@SKU+',@PortalId = '+CAST(@PortalId AS VARCHAR(10))+',@currentUtcDate = '+@currentUtcDate+',@UserId='+CAST(@UserId AS VARCHAR(100))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_GetPublishProductPricingBySku',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_AdminUsersEditProfile')
	DROP PROC Znode_AdminUsersEditProfile

GO

CREATE PROCEDURE [dbo].[Znode_AdminUsersEditProfile]  
(  
	@LoggedInUserId int  
)  
AS  
/*  
Summary: This SP is used to get User Details  
EXEC Znode_AdminUsersEditProfile @LoggedInUserId = 1006  
*/  
BEGIN  
BEGIN TRY  
SET NOCOUNT ON;  
 
	SELECT UserId, AspNetUserId, FirstName, LastName, MiddleName, CustomerPaymentGUID,BudgetAmount,Email, PhoneNumber,EmailOptIn,  
		ReferralStatus, ReferralCommission, ReferralCommissionTypeId, IsActive, ExternalId, IsShowMessage, CreatedBy,  
		CreatedDate, ModifiedBy, ModifiedDate, Custom1, Custom2, Custom3, Custom4, Custom5, IsVerified,  
		MediaId, UserVerificationType, UserName,AccountId
	FROM ZnodeUser a  
	WHERE a.UserId = @LoggedInUserId  
   
END TRY  
BEGIN CATCH  
	DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_AdminUsersEditProfile @LoggedInUserId='+cast(@LoggedInUserId as varchar(10));  
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName    = 'Znode_AdminUsersEditProfile',  
	@ErrorInProcedure = @ERROR_PROCEDURE,  
	@ErrorMessage     = @ErrorMessage,  
	@ErrorLine        = @ErrorLine,  
	@ErrorCall        = @ErrorCall;  
END CATCH;  
END;

GO

insert into ZnodeApplicationSetting(GroupName,ItemName,Setting,ViewOptions,FrontPageName,FrontObjectName,IsCompressed,OrderByFields,ItemNameWithoutCurrency,CreatedByName,ModifiedByName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 'Table', 'WebStoreCustomerQuoteApprovalHistory','<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>OrderType</name>      <headertext>Order Type</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>OmsQuoteId</name>      <headertext>Order Number</headertext>      <width>0</width>      <datatype>Int32</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>y</isallowlink>      <islinkactionurl>/User/QuoteApprovalView</islinkactionurl>      <islinkparamfield>omsQuoteId,orderStatus</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>linkQuoteId</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>UserName</name>      <headertext>Customer Name</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>AccountName</name>      <headertext>Account Name</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>OrderStatus</name>      <headertext>Order Status</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>QuoteOrderTotal</name>      <headertext>Order Amount</headertext>      <width>0</width>      <datatype>Decimal</datatype>      <columntype>Decimal</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>CreatedDate</name>      <headertext>Created Date</headertext>      <width>0</width>      <datatype>Date</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>View</format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>View</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/User/QuoteApprovalView</manageactionurl>      <manageparamfield>omsQuoteId,orderStatus</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>9</id>      <name>AccountId</name>      <headertext>Account Id</headertext>      <width>0</width>      <datatype>Int32</datatype>      <columntype>Int32</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>',
'WebStoreCustomerQuoteApprovalHistory','WebStoreCustomerQuoteApprovalHistory','WebStoreCustomerQuoteApprovalHistory',0,null,null,null,null,2,getdate(),2,getdate()
where not exists(select * from ZnodeApplicationSetting where ItemName = 'WebStoreCustomerQuoteApprovalHistory')

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemBundle')
	DROP PROC Znode_InsertUpdateSaveCartLineItemBundle

GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemBundle]
 (
	 @SaveCartLineItemType TT_SavecartLineitems READONLY  
	,@Userid  INT = 0
	,@OrderLineItemRelationshipTypeIdBundle INT
	,@OrderLineItemRelationshipTypeIdAddon INT
 )
AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 
    --Declared the variables
    DECLARE @GetDate datetime= dbo.Fn_GetDate(); 
   
	DECLARE @OmsInsertedData TABLE (OmsSavedCartLineItemId INT ) 	
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId INT,BundleProductIds VARCHAR(600) ,PersonalizeCode NVARCHAR(MAX),PersonalizeValue NVARCHAR(MAX),DesignId NVARCHAR(MAX), ThumbnailURL NVARCHAR(MAX))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.BundleProductIds
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(MAX)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(MAX)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(MAX)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(MAX)' ) AS ThumbnailURL
	FROM @SaveCartLineItemType a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col) 

	CREATE TABLE #NewBundleSavecartLineitemDetails 
	(
		GenId INT IDENTITY(1,1),RowId	INT	,OmsSavedCartLineItemId	INT	 ,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	INT
		,SKU	NVARCHAR(MAX) ,Quantity	NUMERIC(28,6)	,OrderLineItemRelationshipTypeID	INT	,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	INT	,AutoAddon	VARCHAR(MAX)	,OmsOrderId	INT	,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX)
	)
	
	--Getting new save cart data(bundle product)
	INSERT INTO #NewBundleSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU 
	FROM @SaveCartLineItemType a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
	 
	--Getting new bundle product save cart data
	INSERT INTO #NewBundleSavecartLineitemDetails 
	SELECT   Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, BundleProductIds
				,Quantity, @OrderLineItemRelationshipTypeIdBundle, CustomText, CartAddOnDetails, Sequence
				,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU  
	FROM @SaveCartLineItemType  a 
	WHERE BundleProductIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, BundleProductIds
	,Quantity,  CustomText, CartAddOnDetails, Sequence ,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
		
	--Getting new Bundle products save cart data if addon is present for any line item
	INSERT INTO #NewBundleSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
	,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
			WHEN  GroupProductIds <> '' THEN GroupProductIds 
			WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU 
	FROM @SaveCartLineItemType  a 
	WHERE AddOnValueIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU

    CREATE TABLE #OldBundleSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old bundle save cart data if present for same SKU in the new save cart data for bundle product		 
	INSERT INTO #OldBundleSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM ZnodeOmsSavedCartLineItem a   
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.BundleProductIds,'')   )   
    AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle   

	--Getting the old save cart Parent data
	INSERT INTO #OldBundleSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b 
	INNER JOIN #OldBundleSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
	AND  b.OrderLineItemRelationshipTypeID IS NULL 

	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldBundleSavecartLineitemDetails

	DELETE a FROM #OldBundleSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldBundleSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 

	--Getting the old bundle product save cart addon data for old line items if present
	INSERT INTO #OldBundleSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b 
	INNER JOIN #OldBundleSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
	AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon	

		------Merge Addon for same product
		IF EXISTS(SELECT * FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
		BEGIN

			INSERT INTO #OldValueForAddon 
			SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
			FROM ZnodeOmsSavedCartLineItem b 
			INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
			WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
			AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
									( SELECT  ', ' + SKU FROM    
										( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
											WHERE a.ParentOmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
											FOR XML PATH('')
									), 1, 2, ''
									) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a WHERE a.ParentOmsSavedCartLineItemId is not null and OrderLineItemRelationshipTypeID<>1

		SELECT distinct a.BundleProductIds SKU, STUFF(
										( SELECT  ', ' + x.AddOnValueIds FROM    
										( SELECT DISTINCT b.AddOnValueIds FROM @SaveCartLineItemType b
											WHERE a.SKU=b.SKU ) x
											FOR XML PATH('')
										), 1, 2, ''
									) AddOns
		INTO #AddOnAdded
		FROM @SaveCartLineItemType a

		if NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
		begin
			DELETE FROM #OldBundleSavecartLineitemDetails
		end

		END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @SaveCartLineItemType ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldBundleSavecartLineitemDetails a WHERE	
	ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
	AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN 
		
		DELETE FROM #OldBundleSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
		BEGIN 

			 DECLARE @parenTofAddon INT  = 0 
			 SET @parenTofAddon = (SELECT TOP 1 ParentOmsSavedCartLineItemId 
			 FROM #OldBundleSavecartLineitemDetails a
			 WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
			 AND (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem  t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId AND   t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			  )

			 DELETE FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId <> @parenTofAddon  AND ParentOmsSavedCartLineItemId IS NOT NULL  

			 DELETE FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldBundleSavecartLineitemDetails m)
			 AND ParentOmsSavedCartLineItemId IS  NULL  
		 
			 IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			  BEGIN 
				DELETE FROM #OldBundleSavecartLineitemDetails
			  END 
			IF (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem   WHERE ParentOmsSavedCartLineItemId =@parenTofAddon AND   OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			BEGIN 
				DELETE FROM #OldBundleSavecartLineitemDetails
			END 

		 END 
		 ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) >= 1 
		 BEGIN 
		    DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM ZnodeOmsSavedCartLineItem a 
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
			OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		 END 
		 ELSE IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  BEGIN 
		    DELETE FROM #OldBundleSavecartLineitemDetails
		  END 
		   ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		      AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  = '' )
		 BEGIN 
		   DELETE FROM #OldBundleSavecartLineitemDetails
		 END 

	END 
	
	--Getting the personalise data for old save cart if present
	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		DELETE FROM #OldBundleSavecartLineitemDetails
	END 
	ELSE 
	BEGIN 
		 IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) <>
		     (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM ZnodeOmsSavedCartLineItem WHERE ParentOmsSavedCartLineItemId IS nULL and OmsSavedCartLineItemId in (select OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails)  )
		 BEGIN 
		   
			   DELETE FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
			   SELECT OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			   AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
			   OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			   AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		 
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) <>
		     (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM ZnodeOmsSavedCartLineItem WHERE ParentOmsSavedCartLineItemId IS nULL and OmsSavedCartLineItemId in (select OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails)  )
		 BEGIN 
		   
			   DELETE n FROM #OldBundleSavecartLineitemDetails n WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
			   OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
		
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		        AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldBundleSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
		       AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		 BEGIN 
		     DELETE FROM #OldBundleSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		 END 
		END 

	IF EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails )
	BEGIN 
		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU not having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*
			FROM @SaveCartLineItemType a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on ( a.BundleProductIds = b.SKU or a.SKU = b.sku)
			WHERE isnull(cast(a.PersonalisedAttribute AS varchar(max)),'') = ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId
			FROM #OldBundleSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
		)
		DELETE a FROM #OldBundleSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*, 
				a.PersonalizeCode
				,a.PersonalizeValue
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on ( a.BundleProductIds = b.SKU )
			WHERE isnull(a.PersonalizeValue,'') <> ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId, b.PersonalizeCode, b.PersonalizeValue
			FROM #OldBundleSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
			WHERE NOT EXISTS(SELECT * FROM cte c WHERE b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and b.PersonalizeCode = c.PersonalizeCode 
								and b.PersonalizeValue = c.PersonalizeValue )
		)
		DELETE a FROM #OldBundleSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)


		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,b.ParentOmsSavedCartLineItemId , a.BundleProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on a.BundleProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM #OldBundleSavecartLineitemDetails b1 
		WHERE NOT EXISTS(SELECT * FROM cte c WHERE (b1.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or b1.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId))
		AND EXISTS(SELECT * FROM cte)
		-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b ON a.BundleProductIds = b.SKU
			LEFT JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
			--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewBundleSavecartLineitemDetails b ON a.BundleProductIds = b.SKU
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		from CTE_OldPersonalizeCodeCount a
		inner join CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		inner join #OldBundleSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
	
		--Delete parent entry if child not present
		DELETE a FROM #OldBundleSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldBundleSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.BundleProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on a.BundleProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE c1
		FROM cte a1		  
		INNER JOIN #OldBundleSavecartLineitemDetails b1 on a1.SKU = b1.SKU
		INNER JOIN #OldBundleSavecartLineitemDetails c1 on (b1.ParentOmsSavedCartLineItemId = c1.OmsSavedCartLineItemId OR b1.OmsSavedCartLineItemId = c1.OmsSavedCartLineItemId)
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c WHERE a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and a1.PersonalizeValue = c.PersonalizeValue)

		--Updating the cart if old and new cart data matches	
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5,
		a.ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldBundleSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewBundleSavecartLineitemDetails ty ON (ty.SKU = b.SKU)
		WHERE a.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon

		 UPDATE a
		 SET a.Quantity = a.Quantity+s.AddOnQuantity,
		 a.ModifiedDate = @GetDate
		 FROM ZnodeOmsSavedCartLineItem a
		 INNER JOIN #OldBundleSavecartLineitemDetails b ON (a.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		 INNER JOIN @SaveCartLineItemType S on a.OmsSavedCartId = s.OmsSavedCartId and a.SKU = s.AddOnValueIds
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon

		 --UPDATE Ab SET ab.Quantity = a.Quantity   
   --      FROM ZnodeOmsSavedCartLineItem a  
   --      INNER JOIN ZnodeOmsSavedCartLineItem ab ON (ab.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)  
   --      INNER JOIN @SaveCartLineItemType b ON (a.OmsSavedCartId = b.OmsSavedCartId  )   
		 --WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle  

		 UPDATE Ab 
		 SET Ab.Quantity = Ab.Quantity+ty.Quantity,
		 Ab.Custom1 = ty.Custom1,
		 Ab.Custom2 = ty.Custom2,
		 Ab.Custom3 = ty.Custom3,
		 Ab.Custom4 = ty.Custom4,
		 Ab.Custom5 = ty.Custom5,
		 ab.ModifiedDate = @GetDate  
         FROM ZnodeOmsSavedCartLineItem a  
         INNER JOIN ZnodeOmsSavedCartLineItem ab ON (ab.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)  
         INNER JOIN @SaveCartLineItemType b ON (a.OmsSavedCartId = b.OmsSavedCartId  ) 
		 INNER JOIN #NewBundleSavecartLineitemDetails ty ON (ty.SKU = b.SKU)  
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle  
		 AND EXISTS(SELECT * FROM #OldBundleSavecartLineitemDetails ov WHERE a.OmsSavedCartLineItemId = ov.OmsSavedCartLineItemId)  

	END 
	--Inserting the new save cart data if old and new cart data not match
	ELSE 
	BEGIN 
			
		UPDATE #NewBundleSavecartLineitemDetails
		SET ParentSKU = (SELECT TOP 1 SKU FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID IS NULL )
		WHERE OrderLineItemRelationshipTypeID  = @OrderLineItemRelationshipTypeIdAddon 
		AND EXISTS (SELECT TOP 1 1 FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle) 
		
		--Getting the new save cart data and generating row no. for new save cart insert
		SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU  
		 INTO #InsertNewBundleSavecartLineitem   
		 FROM  #NewBundleSavecartLineitemDetails  
		 GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU   
		 ORDER BY RowId, Id   
   
		--Removing the line item having Quantity <=0 
		DELETE FROM #InsertNewBundleSavecartLineitem WHERE Quantity <=0  

		;WITH Add_Dup AS
		(
			SELECT  Min(NewRowId)NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID 
			FROM  #InsertNewBundleSavecartLineitem
			GROUP BY SKU ,ParentSKU  ,OrderLineItemRelationshipTypeID
			HAVING OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon	
		)
		DELETE FROM #InsertNewBundleSavecartLineitem
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM Add_Dup WHERE Add_Dup.NewRowId = #InsertNewBundleSavecartLineitem.NewRowId)
		AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		--Updating the rowid INTo new save cart line item AS new line item is merged INTo existing save cart item
		 ;WITH VTTY AS   
		(  
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
			   FROM #InsertNewBundleSavecartLineitem m  
			INNER JOIN  #InsertNewBundleSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU   
			WHERE m.OrderLineItemRelationshipTypeID IN ( @OrderLineItemRelationshipTypeIdAddon , @OrderLineItemRelationshipTypeIdBundle)   
		)   
		UPDATE m1   
		SET m1.RowId = TYU.RowId  
		FROM #InsertNewBundleSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  
      
		--Deleting the new save cart line item if cart line item is merged
		;WITH VTRET AS   
		(  
			SELECT RowId,id,Min(NewRowId)NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID   
			FROM #InsertNewBundleSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU  ,OrderLineItemRelationshipTypeID  
			Having  SKU = ParentSKU  AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		)   
		DELETE FROM #InsertNewBundleSavecartLineitem WHERE NewRowId  IN (SELECT NewRowId FROM VTRET)   
     
	   --Inserting the new cart line item if not merged in existing save cart line item
       INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description)  
       OUTPUT INSERTED.OmsSavedCartLineItemId  INTO @OmsInsertedData 
	   SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description   
       FROM  #InsertNewBundleSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU 
		INTO #Cte_newData 
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
		AND a.ParentOmsSavedCartLineItemId IS nULL  
		AND  EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) 
  
		--------------------------------------------------------------------------------------------------------

		SELECT  MIN(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU  
		INTO #ParentOmsSavedCartId
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #ParentOmsSavedCartId  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon   
		AND  EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) 
		AND  a.sequence in (SELECT  MIN(ab.sequence) FROM ZnodeOmsSavedCartLineItem ab WHERE a.OmsSavedCartId = ab.OmsSavedCartId and 
		 a.SKU = ab.sku and ab.OrderLineItemRelationshipTypeId is not null  ) 

		-----------------------------------------------------------------------------------------------------

		SELECT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(Order BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #NewBuldleProduct
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( CASE WHEN EXISTS (SELECT TOP 1 1 FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle) THEN 0 ELSE 1 END = b.id OR b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c on b.sku = c.sku and b.OmsSavedCartId=c.OmsSavedCartId and b.Id = 1
		WHERE ( CASE WHEN EXISTS (SELECT TOP 1 1 FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle) THEN 0 ELSE 1 END = ISNULL(a.ParentOmsSavedCartLineItemId,0) OR ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  AND c.ParentOmsSavedCartLineItemId IS NULL

	   ;WITH table_update AS 
	   (
		 SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId  ) RowIdNo
		 FROM ZnodeOmsSavedCartLineItem a
		 WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		 AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
		 AND a.ParentOmsSavedCartLineItemId IS NULL  
		 AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewBundleSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
		 AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
	   )
		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewBuldleProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId) 
			FROM #NewBuldleProduct  r  
			WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )    IS NOT NULL 
	 
  
		;WITH Cte_Th AS   
		(             
			  SELECT RowId    
			 FROM #InsertNewBundleSavecartLineitem a   
			 GROUP BY RowId   
			 HAVING COUNT(NewRowId) <= 1   
		)   
		UPDATE a SET a.Quantity =  NULL,
			a.ModifiedDate = @GetDate   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		 AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE Ab SET ab.Quantity = a.Quantity,
			ab.ModifiedDate = @GetDate   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN ZnodeOmsSavedCartLineItem ab ON (ab.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)  
		INNER JOIN @SaveCartLineItemType b ON (a.OmsSavedCartId = b.OmsSavedCartId  )   
		WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle  

		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewBundleSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		AND OrderLineItemRelationshipTypeId IS NOT NULL     
       
	   ;WITH Cte_UpdateSequence AS   
		 (  
		   SELECT OmsSavedCartLineItemId ,Row_Number()Over(Order By OmsSavedCartLineItemId) RowId , Sequence   
		   FROM ZnodeOmsSavedCartLineItem   
		   WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewBundleSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		 )   
		UPDATE Cte_UpdateSequence  
		SET  Sequence = RowId  
			
		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN ZnodeOmsSavedCartLineItem b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS not nULL
		and b.OmsSavedCartLineItemId = (select min(OmsSavedCartLineItemId) FROM @OmsInsertedData d WHERE b.OmsSavedCartLineItemId = d.OmsSavedCartLineItemId)
	 
		DELETE FROM ZnodeOmsPersonalizeCartItem	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
			
		----Inserting saved cart item personalise value FROM given line item
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
			   ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			   WHEN NOT MATCHED THEN 
				INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
				VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
  
		
		END 
END TRY
BEGIN CATCH 
  SELECT ERROR_MESSAGE()
END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemConfigurable')
	DROP PROC Znode_InsertUpdateSaveCartLineItemConfigurable

GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemConfigurable]
 (
	 @SaveCartLineItemType TT_SavecartLineitems READONLY  
	,@Userid  INT = 0 
	,@OrderLineItemRelationshipTypeIdConfigurable INT
	,@OrderLineItemRelationshipTypeIdAddon INT	
)
AS 
BEGIN 
BEGIN TRY 
 SET NOCOUNT ON 
	--Declared the variables
    DECLARE @GetDate datetime= dbo.Fn_GetDate(); 
   
	DECLARE @OmsInsertedData TABLE (OmsSavedCartLineItemId INT, OmsSavedCartId INT,SKU NVARCHAr(max),GroupId  NVARCHAr(max),ParentOmsSavedCartLineItemId INT,OrderLineItemRelationshipTypeId INT  ) 
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId INT,ConfigurableProductIds VARCHAR(600) ,PersonalizeCode NVARCHAR(MAX),PersonalizeValue NVARCHAR(MAX),DesignId NVARCHAR(MAX), ThumbnailURL NVARCHAR(MAX))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.ConfigurableProductIds
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(MAX)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(MAX)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(MAX)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(MAX)' ) AS ThumbnailURL
	FROM @SaveCartLineItemType a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  

	 CREATE TABLE #NewConfigSavecartLineitemDetails 
	 (
		 GenId INT IDENTITY(1,1),RowId	INT	,OmsSavedCartLineItemId	INT	 ,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	INT
		,SKU	NVARCHAR(MAX) ,Quantity	NUMERIC(28,6)	,OrderLineItemRelationshipTypeID	INT	,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	INT	,AutoAddon	VARCHAR(MAX)	,OmsOrderId	INT	,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX)
	)
	 
	--Getting new save cart data(configurable product)
	INSERT INTO #NewConfigSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU 
	FROM @SaveCartLineItemType a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
	 
	--Getting new configurable product save cart data
	INSERT INTO #NewConfigSavecartLineitemDetails 
	SELECT   Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, ConfigurableProductIds
				,Quantity, @OrderLineItemRelationshipTypeIdConfigurable, CustomText, CartAddOnDetails, Sequence
				,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU  
	FROM @SaveCartLineItemType  a 
	WHERE ConfigurableProductIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, ConfigurableProductIds
	,Quantity,  CustomText, CartAddOnDetails, Sequence ,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
	
	--Getting new configurable products save cart data if addon is present for any line item
	INSERT INTO #NewConfigSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
	,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
			WHEN  GroupProductIds <> '' THEN GroupProductIds 
			WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU 
	FROM @SaveCartLineItemType  a 
	WHERE AddOnValueIds <> ''
		GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
		 
		 SELECT * 
		INTO #ZnodeOmsSavedCartLineItem_NT
		FROM ZnodeOmsSavedCartLineItem a 
		WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId)

    CREATE TABLE #OldConfigSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old configurable save cart data if present for same SKU in the new save cart data for configurable product	 
	INSERT INTO #OldConfigSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM #ZnodeOmsSavedCartLineItem_NT a   
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.ConfigurableProductIds,'')   )   
    AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable   

	--Getting the old save cart Parent data
	INSERT INTO #OldConfigSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM #ZnodeOmsSavedCartLineItem_NT b 
	INNER JOIN #OldConfigSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
	AND  b.OrderLineItemRelationshipTypeID IS NULL 
		
	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldConfigSavecartLineitemDetails
		  
	DELETE a FROM #OldConfigSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldConfigSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 

	INSERT INTO #OldConfigSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM #ZnodeOmsSavedCartLineItem_NT b 
	INNER JOIN #OldConfigSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
	AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon
		
		------Merge Addon for same product
		IF EXISTS(SELECT * FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
		BEGIN
		
		
			INSERT INTO #OldValueForAddon 
			SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
			FROM #ZnodeOmsSavedCartLineItem_NT b 
			INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
			WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
			AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
									( SELECT  ', ' + SKU FROM    
										( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
											where a.OmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId AND OrderLineItemRelationshipTypeID = 1 ) x 
											FOR XML PATH('')
									), 1, 2, ''
									) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a where a.ParentOmsSavedCartLineItemId is not null AND OrderLineItemRelationshipTypeID<>1

		SELECT distinct a.ConfigurableProductIds SKU, STUFF(
										( SELECT  ', ' + x.AddOnValueIds FROM    
										( SELECT DISTINCT b.AddOnValueIds FROM @SaveCartLineItemType b
											where a.SKU=b.SKU ) x
											FOR XML PATH('')
										), 1, 2, ''
									) AddOns
		INTO #AddOnAdded
		FROM @SaveCartLineItemType a

			

		IF NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b ON a.SKU = b.SKU AND a.AddOns = b.AddOns )
		BEGIN
			   
			DELETE FROM #OldConfigSavecartLineitemDetails 
	
		END

	END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @SaveCartLineItemType ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldConfigSavecartLineitemDetails a WHERE	
	ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
	AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN 
		
		DELETE FROM #OldConfigSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		
		 IF EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
		 BEGIN 
		 
			 DECLARE @parenTofAddon  TABLE( ParentOmsSavedCartLineItemId INT  )  
			 INSERT INTO  @parenTofAddon 
			 SELECT  ParentOmsSavedCartLineItemId FROM #OldConfigSavecartLineitemDetails a  WHERE a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
			 AND (SELECT COUNT (DISTINCT SKU ) FROM  #ZnodeOmsSavedCartLineItem_NT  t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId AND   t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM  #NewConfigSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  

			 DELETE FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ParentOmsSavedCartLineItemId FROM  @parenTofAddon)   
					AND ParentOmsSavedCartLineItemId IS NOT NULL  
					AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

			 DELETE FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldConfigSavecartLineitemDetails m)
			 AND ParentOmsSavedCartLineItemId IS  NULL  
		 
			 IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldConfigSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewConfigSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			 BEGIN 
				DELETE FROM #OldConfigSavecartLineitemDetails 
			 END 
			 IF (SELECT COUNT (DISTINCT SKU ) FROM  #ZnodeOmsSavedCartLineItem_NT   WHERE ParentOmsSavedCartLineItemId IN (SELECT ParentOmsSavedCartLineItemId FROM @parenTofAddon)AND   OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewConfigSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			 BEGIN 
				DELETE FROM #OldConfigSavecartLineitemDetails 
			 END 

		 END 
		 ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		 BEGIN 
		 -- SELECT 3
		    DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM #ZnodeOmsSavedCartLineItem_NT a 
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable  )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
			OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		    
			 DELETE FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldConfigSavecartLineitemDetails m)
		    AND ParentOmsSavedCartLineItemId IS  NULL  

		 END
		 ELSE IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldConfigSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewConfigSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  BEGIN 
		    DELETE FROM #OldConfigSavecartLineitemDetails 
		  END  
		 ELSE IF  EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsSavedCartLineItem_NT Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		      AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  = '' )
		 BEGIN 
		   DELETE FROM #OldConfigSavecartLineitemDetails 
		 END 

		END 

	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	--Getting the personalise data for old save cart if present		
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		 DELETE FROM #OldConfigSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		 IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 BEGIN 
		    DELETE FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
		    SELECT OmsSavedCartLineItemId FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
		    AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
		    OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
		    AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 BEGIN 
		 
		   DELETE n FROM #OldConfigSavecartLineitemDetails n WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
		   OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
	
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		        AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldConfigSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
		       AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		 BEGIN 
		     DELETE FROM #OldConfigSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		 END 
		END 

	IF EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails )
	BEGIN
		--------If lineitem present in ZnodeOmsPersonalizeCartItem AND personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem AND personalize value is same for same line item then Quantity will added
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.ConfigurableProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldConfigSavecartLineitemDetails b ON a.ConfigurableProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE c1
		FROM cte a1		  
		INNER JOIN #OldConfigSavecartLineitemDetails b1 ON a1.SKU = b1.SKU
		INNER JOIN #OldConfigSavecartLineitemDetails c1 ON (b1.ParentOmsSavedCartLineItemId = c1.OmsSavedCartLineItemId OR b1.OmsSavedCartLineItemId = c1.OmsSavedCartLineItemId)
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c where a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId AND a1.PersonalizeValue = c.PersonalizeValue)
		-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldConfigSavecartLineitemDetails b ON a.ConfigurableProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
			--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewConfigSavecartLineitemDetails b ON a.ConfigurableProductIds = b.SKU
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		from CTE_OldPersonalizeCodeCount a
		inner join CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		inner join #OldConfigSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		
		--Delete parent entry if child not present
		DELETE a FROM #OldConfigSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldConfigSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

	 

		--Updating the cart if old and new cart data matches
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5,
		a.ModifiedDate = @GetDate  
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldConfigSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewConfigSavecartLineitemDetails ty ON (ty.SKU = b.SKU)
		WHERE a.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon
		 
		 UPDATE a
		 SET a.Quantity = a.Quantity+s.AddOnQuantity,
		 a.ModifiedDate = @GetDate
		 FROM ZnodeOmsSavedCartLineItem a
		 INNER JOIN #OldConfigSavecartLineitemDetails b ON (a.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		 INNER JOIN @SaveCartLineItemType S ON a.OmsSavedCartId = s.OmsSavedCartId AND a.SKU = s.AddOnValueIds
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
	END 
	--Inserting the new save cart data if old and new cart data not match
	ELSE 
	BEGIN 
		--Getting the new save cart data and generating row no. for new save cart insert
		SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU  
		 INTO #InsertNewConfigSavecartLineitem   
		 FROM  #NewConfigSavecartLineitemDetails  
		 GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU   
		 ORDER BY RowId, Id   
       	    
		--Removing the line item having Quantity <=0 
		DELETE FROM #InsertNewConfigSavecartLineitem WHERE Quantity <=0  
  
		--Updating the rowid INTo new save cart line item as new line item is merged INTo existing save cart item
		 ;WITH VTTY AS   
		(  
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
			   FROM #InsertNewConfigSavecartLineitem m  
			INNER JOIN  #InsertNewConfigSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU   
			WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon   
		)   
		UPDATE m1   
		SET m1.RowId = TYU.RowId  
		FROM #InsertNewConfigSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  
           
		;WITH VTRET AS   
		(  
			SELECT RowId,id,Min(NewRowId)NewRowId ,SKU ,ParentSKU  ,OrderLineItemRelationshipTypeID  
			FROM #InsertNewConfigSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU  ,OrderLineItemRelationshipTypeID  
			Having  SKU = ParentSKU  AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		)   
		DELETE FROM #InsertNewConfigSavecartLineitem WHERE NewRowId  IN (SELECT NewRowId FROM VTRET)   
     
	   --Inserting the new cart line item if not merged in existing save cart line item
       INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,Sequence,	CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description)  
        OUTPUT INSERTED.OmsSavedCartLineItemId,INSERTED.OmsSavedCartId,inserted.SKU,inserted.GroupId,INSERTED.ParentOmsSavedCartLineItemId,INSERTED.OrderLineItemRelationshipTypeId  INTO @OmsInsertedData 
	   SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description   
       FROM  #InsertNewConfigSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU
		INTO   #Cte_newData
		FROM @OmsInsertedData a  
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			  
	
		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
		AND a.ParentOmsSavedCartLineItemId IS nULL   
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )

	---------------------------------------------------------------------------------------------------------------------

		SELECT  MIN(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU 
		INTO #Cte_newData1 
		FROM @OmsInsertedData a  
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData1  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon     
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
		AND  a.sequence in (SELECT  MIN(ab.sequence) FROM ZnodeOmsSavedCartLineItem ab where a.OmsSavedCartId = ab.OmsSavedCartId AND 
		 a.SKU = ab.sku AND ab.OrderLineItemRelationshipTypeId is not null  ) 
 
	---------------------------------------------------------------------------------------------------------------------------

		SELECT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(Order BY c.OmsSavedCartLineItemId  )RowIdNo
		INTO #NewConfigProduct
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c with (nolock) ON b.sku = c.sku AND b.OmsSavedCartId=c.OmsSavedCartId AND b.Id = 1 
		WHERE ( ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) AND c.ParentOmsSavedCartLineItemId is null
  
	   ;WITH table_update AS 
	   (
		 SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId  ) RowIdNo
		 FROM ZnodeOmsSavedCartLineItem a with (nolock)
		 WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		 AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
		 AND a.ParentOmsSavedCartLineItemId IS NULL  
		 AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewConfigSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
		 AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
	   )
		UPDATE a SET  
		a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 max(OmsSavedCartLineItemId) 
			FROM #NewConfigProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId) 
			FROM #NewConfigProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )    IS nOT NULL 

		;WITH Cte_Th AS   
		(             
			  SELECT RowId    
			 FROM #InsertNewConfigSavecartLineitem a   
			 GROUP BY RowId   
			 HAVING COUNT(NewRowId) <= 1   
		)   
		UPDATE a SET a.Quantity =  NULL,
			a.ModifiedDate = @GetDate   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		 AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewConfigSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		AND OrderLineItemRelationshipTypeId IS NOT NULL     
       
	   ;WITH Cte_UpdateSequence AS   
		(  
		   SELECT OmsSavedCartLineItemId ,Row_Number()Over(Order By OmsSavedCartLineItemId) RowId , Sequence   
		   FROM ZnodeOmsSavedCartLineItem   
		   WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewConfigSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		)   
		UPDATE Cte_UpdateSequence  
		SET  Sequence = RowId  

		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN ZnodeOmsSavedCartLineItem b with (nolock) ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId  AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS not nULL 
	
		DELETE FROM ZnodeOmsPersonalizeCartItem WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
		
		----Inserting saved cart item personalise value FROM given line item
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
			   ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			   WHEN NOT MATCHED THEN 
				INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
				VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
  
		
		END 




END TRY
BEGIN CATCH 
  SELECT ERROR_MESSAGE()
END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemGroup')
	DROP PROC Znode_InsertUpdateSaveCartLineItemGroup

GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemGroup]
 (
	 @SaveCartLineItemType TT_SavecartLineitems READONLY  
	,@Userid  INT = 0 
	,@OrderLineItemRelationshipTypeIdGroup INT
	,@OrderLineItemRelationshipTypeIdAddon INT
 )
AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 
	--Declared the variables
	DECLARE @GetDate datetime= dbo.Fn_GetDate(); 
	
	DECLARE @OmsInsertedData TABLE (SKU varchar(600),OmsSavedCartLineItemId INT ) 	
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId INT,GroupProductIds VARCHAR(600) ,PersonalizeCode NVARCHAR(MAX),PersonalizeValue NVARCHAR(MAX),DesignId NVARCHAR(MAX), ThumbnailURL NVARCHAR(MAX))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.GroupProductIds
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(MAX)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(MAX)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(MAX)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(MAX)' ) AS ThumbnailURL
	FROM @SaveCartLineItemType a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  

	CREATE TABLE #NewGroupSavecartLineitemDetails 
	(
		GenId INT IDENTITY(1,1),RowId	INT ,OmsSavedCartLineItemId	INT,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	int
		,SKU	NVARCHAR(MAX) ,Quantity	numeric(28,6)	,OrderLineItemRelationshipTypeID	INT ,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	INT ,AutoAddon	VARCHAR(MAX)	,OmsOrderId	INT ,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX)
	)
	 
	--Getting new save cart data(group product)
	INSERT INTO #NewGroupSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU 
	FROM @SaveCartLineItemType a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
	 
	--Getting new group product save cart data
	INSERT INTO #NewGroupSavecartLineitemDetails 
	SELECT   Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, GroupProductIds
				,Quantity, @OrderLineItemRelationshipTypeIdGroup, CustomText, CartAddOnDetails, Sequence
				,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU  
	FROM @SaveCartLineItemType  a 
	WHERE GroupProductIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, GroupProductIds
	,Quantity,  CustomText, CartAddOnDetails, Sequence ,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
		
	--Getting new group products save cart data if addon is present for any line item
	INSERT INTO #NewGroupSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
	,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
			WHEN  GroupProductIds <> '' THEN GroupProductIds 
			WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU 
	FROM @SaveCartLineItemType  a 
	WHERE AddOnValueIds <> ''
		GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
		 

	CREATE TABLE #OldGroupSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old group save cart data if present for same SKU in the new save cart data for group product	 	 
	INSERT INTO #OldGroupSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM ZnodeOmsSavedCartLineItem a with (nolock)  
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.GroupProductIds,'')   )   
	AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup   

	--Getting the old save cart Parent data
	INSERT INTO #OldGroupSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldGroupSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
	AND  b.OrderLineItemRelationshipTypeID IS NULL 

	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldGroupSavecartLineitemDetails

	DELETE a FROM #OldGroupSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldGroupSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 

	--Getting the old config product save cart addon data for old line items if present
	INSERT INTO #OldGroupSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldGroupSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
	AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		------Merge Addon for same product
		IF EXISTS(SELECT * FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
		BEGIN

			INSERT INTO #OldValueForAddon 
			SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
			FROM ZnodeOmsSavedCartLineItem b 
			INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
			WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
			AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
									( SELECT  ', ' + SKU FROM    
										( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
											where a.OmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
											FOR XML PATH('')
									), 1, 2, ''
									) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a where a.ParentOmsSavedCartLineItemId is not null and OrderLineItemRelationshipTypeID<>1

		SELECT distinct a.GroupProductIds SKU, STUFF(
										( SELECT  ', ' + x.AddOnValueIds FROM    
										( SELECT DISTINCT b.AddOnValueIds FROM @SaveCartLineItemType b
											where a.SKU=b.SKU ) x
											FOR XML PATH('')
										), 1, 2, ''
									) AddOns
		INTO #AddOnAdded
		FROM @SaveCartLineItemType a

		if not exists(select * FROM #AddOnsExists a INNER JOIN #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
		begin
			DELETE FROM #OldGroupSavecartLineitemDetails
		end

		END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @SaveCartLineItemType ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldGroupSavecartLineitemDetails a WHERE	
	ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
	AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN 
		
		DELETE FROM #OldGroupSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		
		 IF EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
		 BEGIN 
		 
			 DECLARE @parenTofAddon  TABLE( ParentOmsSavedCartLineItemId INT  )  
			 INSERT INTO  @parenTofAddon 
			 SELECT  ParentOmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails a
			 WHERE a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
			 AND (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem  t with (nolock) WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId AND   t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  
			 DELETE FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ParentOmsSavedCartLineItemId FROM  @parenTofAddon)   
						AND ParentOmsSavedCartLineItemId IS NOT NULL  
						AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

			 DELETE FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldGroupSavecartLineitemDetails m)
			 AND ParentOmsSavedCartLineItemId IS  NULL  
		 

		  IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  BEGIN 
		    DELETE FROM #OldGroupSavecartLineitemDetails
		  END 
		 IF (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem with (nolock)  WHERE ParentOmsSavedCartLineItemId IN (SELECT ParentOmsSavedCartLineItemId FROM @parenTofAddon)AND   OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  BEGIN 
		    DELETE FROM #OldGroupSavecartLineitemDetails
		  END 

		 END 
		 ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		 BEGIN 
		 -- SELECT 3
		    DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup  )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
			OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		    
			 DELETE FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldGroupSavecartLineitemDetails m)
		     AND ParentOmsSavedCartLineItemId IS  NULL  

		 END
		 ELSE IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  BEGIN 
		    DELETE FROM #OldGroupSavecartLineitemDetails
		  END 
		   ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		   AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  = '' )
			BEGIN 
			   DELETE FROM #OldGroupSavecartLineitemDetails
			END  
	END 

	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	--Getting the personalise data for old save cart if present	
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		DELETE FROM #OldGroupSavecartLineitemDetails
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 
		   
		DELETE FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
		SELECT OmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
		AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
		OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
		AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) <>
			(SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM ZnodeOmsSavedCartLineItem WHERE ParentOmsSavedCartLineItemId IS nULL and OmsSavedCartLineItemId in (select OmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails)  )
		BEGIN 
		 
		DELETE n FROM #OldGroupSavecartLineitemDetails n WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
		OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
		
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
			AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldGroupSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
			AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		BEGIN 
			DELETE FROM #OldGroupSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		END 
	END 
	
	IF EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails )
	BEGIN
		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU not having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*
			FROM @SaveCartLineItemType a 
					INNER JOIN #OldGroupSavecartLineitemDetails b on ( a.GroupProductIds = b.SKU or a.SKU = b.sku)
					where isnull(cast(a.PersonalisedAttribute AS varchar(max)),'') = ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId
			FROM #OldGroupSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
		)
		DELETE a FROM #OldGroupSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*, 
			a.PersonalizeCode
			,a.PersonalizeValue
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b on ( a.GroupProductIds = b.SKU or a.SKU = b.sku)
			where isnull(a.PersonalizeValue,'') <> ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId, b.PersonalizeCode, b.PersonalizeValue
			FROM #OldGroupSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
			WHERE NOT EXISTS(SELECT * FROM cte c where b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and b.PersonalizeCode = c.PersonalizeCode 
								and b.PersonalizeValue = c.PersonalizeValue )
		)
		DELETE a FROM #OldGroupSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,b.ParentOmsSavedCartLineItemId , a.SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b on a.SKU = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM #OldGroupSavecartLineitemDetails b1 
		WHERE NOT EXISTS(SELECT * FROM cte c where (b1.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or b1.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId))
		AND EXISTS(SELECT * FROM cte)

		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.SKU AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b on a.SKU = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE c1
		FROM cte a1		  
		INNER JOIN #OldGroupSavecartLineitemDetails b1 on a1.SKU = b1.SKU
		INNER JOIN #OldGroupSavecartLineitemDetails c1 on (b1.ParentOmsSavedCartLineItemId = c1.OmsSavedCartLineItemId OR b1.OmsSavedCartLineItemId = c1.OmsSavedCartLineItemId)
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c where a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and a1.PersonalizeValue = c.PersonalizeValue)
	-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b ON a.GroupProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
			--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewGroupSavecartLineitemDetails b ON a.GroupProductIds = b.SKU
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		from CTE_OldPersonalizeCodeCount a
		inner join CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		inner join #OldGroupSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		
		--Delete parent entry if child not present
		DELETE a FROM #OldGroupSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldGroupSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

	

		--Updating the cart if old and new cart data matches
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5,
		a.ModifiedDate = @GetDate  
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldGroupSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewGroupSavecartLineitemDetails ty ON (ty.SKU = b.SKU)
		WHERE a.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon

		 UPDATE a
		 SET a.Quantity = a.Quantity+s.AddOnQuantity,
		 a.ModifiedDate = @GetDate
		 FROM ZnodeOmsSavedCartLineItem a
		 INNER JOIN #OldGroupSavecartLineitemDetails b ON (a.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		 INNER JOIN @SaveCartLineItemType S on a.OmsSavedCartId = s.OmsSavedCartId and a.SKU = s.AddOnValueIds
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon


	END 
	--Inserting the new save cart data if old and new cart data not match
	ELSE 
	BEGIN 
	   
		SELECT RowId, Id ,Row_number()Over(ORDER BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(ORDER BY NewId() ) Sequence ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU  
		 INTO #InsertNewGroupSavecartLineitem   
		 FROM  #NewGroupSavecartLineitemDetails  
		 GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU   
		 ORDER BY RowId, Id   
 
		--Removing the line item having Quantity <=0 
		DELETE FROM #InsertNewGroupSavecartLineitem WHERE Quantity <=0  
  
		--Updating the rowid into new save cart line item as new line item is merged into existing save cart item
		 ;WITH VTTY AS   
		(  
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
			   FROM #InsertNewGroupSavecartLineitem m  
			INNER JOIN  #InsertNewGroupSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU   
			WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon   
		)   
		UPDATE m1   
		SET m1.RowId = TYU.RowId  
		FROM #InsertNewGroupSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  

		;WITH VTRET AS   
		(  
			SELECT RowId,id,Min(NewRowId)NewRowId ,SKU ,ParentSKU, OrderLineItemRelationshipTypeId 
			FROM #InsertNewGroupSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU  ,OrderLineItemRelationshipTypeId
			HAVING SKU = ParentSKU AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		)   
		DELETE FROM #InsertNewGroupSavecartLineitem WHERE NewRowId  IN (SELECT NewRowId FROM VTRET)   
     
	   --Inserting the new cart line item if not merged in existing save cart line item
       INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description)  
       OUTPUT INSERTED.SKU,INSERTED.OmsSavedCartLineItemId  INTO @OmsInsertedData 
	   SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(ORDER BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description   
       FROM  #InsertNewGroupSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU 
		INTO  #Cte_newData
		FROM ZnodeOmsSavedCartLineItem a  with (nolock)
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID	  

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  ORDER BY b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
		AND a.ParentOmsSavedCartLineItemId IS nULL   
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
  
  -----------------------------------------------------------------------------------------------------------------------------------

		SELECT  MIN(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU  
		INTO #Cte_newData1
		FROM ZnodeOmsSavedCartLineItem a with (nolock)
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID	  

		 UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData1  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  ORDER BY b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon   
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
		AND  a.sequence in (SELECT  MIN(ab.sequence) FROM ZnodeOmsSavedCartLineItem ab where a.OmsSavedCartId = ab.OmsSavedCartId and 
		 a.SKU = ab.sku and ab.OrderLineItemRelationshipTypeId is not null  ) 


----------------------------------------------------------------------------------------------------------------------------

		SELECT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(ORDER BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #Cte_newAddon
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c with (nolock) on b.sku = c.sku and b.OmsSavedCartId=c.OmsSavedCartId and b.Id = 1
		WHERE ( ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) and c.ParentOmsSavedCartLineItemId is null

	   ;WITH table_update AS 
	   (
			 SELECT * , ROW_NUMBER()Over(ORDER BY OmsSavedCartLineItemId  ) RowIdNo
			 FROM ZnodeOmsSavedCartLineItem a with (nolock)
			 WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
			 AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
			 AND a.ParentOmsSavedCartLineItemId IS NULL  
			 AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewGroupSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
			 AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
	   )
		UPDATE a SET  
			a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #Cte_newAddon  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId)  FROM #Cte_newAddon  r  
			WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )    IS nOT NULL 

		;WITH Cte_Th AS   
		(             
			  SELECT RowId    
			 FROM #InsertNewGroupSavecartLineitem a   
			 GROUP BY RowId   
			 HAVING COUNT(NewRowId) <= 1   
		  )   
		UPDATE a SET a.Quantity =  NULL,
			a.ModifiedDate = @GetDate   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		 AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewGroupSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		AND OrderLineItemRelationshipTypeId IS NOT NULL     
       
	   ;WITH Cte_UpdateSequence AS   
		 (  
		   SELECT OmsSavedCartLineItemId ,Row_Number()Over(ORDER BY OmsSavedCartLineItemId) RowId , Sequence   
		   FROM ZnodeOmsSavedCartLineItem with (nolock)  
		   WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewGroupSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		 )   
		UPDATE Cte_UpdateSequence  
		SET  Sequence = RowId  
			
		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN @TBL_Personalise c ON a.SKU = c.GroupProductIds
		INNER JOIN ZnodeOmsSavedCartLineItem b WITH (NOLOCK) ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS NOT NULL  
	
		DELETE FROM ZnodeOmsPersonalizeCartItem	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
			
		----Inserting saved cart item personalise value FROM given line item
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
			   ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			   WHEN NOT MATCHED THEN 
				INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
				VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
  
		
		END 




END TRY
BEGIN CATCH 
  SELECT ERROR_MESSAGE()
END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemQuantityWrapper')
	DROP PROC Znode_InsertUpdateSaveCartLineItemQuantityWrapper

GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemQuantityWrapper]
(
	@CartLineItemXML xml, 
	@UserId int,
	@PortalId Int,
	@OmsCookieMappingId INT = 0 
)
AS 
   /* 
    Summary: THis Procedure is USed to save and edit the saved cart line item      
    Unit Testing 
	begin tran  
    Exec Znode_InsertUpdateSaveCartLineItem @CartLineItemXML= '<ArrayOfSavedCartLineItemModel>
  <SavedCartLineItemModel>
    <OmsSavedCartLineItemId>0</OmsSavedCartLineItemId>
    <ParentOmsSavedCartLineItemId>0</ParentOmsSavedCartLineItemId>
    <OmsSavedCartId>1259</OmsSavedCartId>
    <SKU>BlueGreenYellow</SKU>
    <Quantity>1.000000</Quantity>
    <OrderLineItemRelationshipTypeId>0</OrderLineItemRelationshipTypeId>
    <Sequence>1</Sequence>
    <AddonProducts>YELLOW</AddonProducts>
    <BundleProducts />
    <ConfigurableProducts>GREEN</ConfigurableProducts>
  </SavedCartLineItemModel>
  <SavedCartLineItemModel>
    <OmsSavedCartLineItemId>0</OmsSavedCartLineItemId>
    <ParentOmsSavedCartLineItemId>0</ParentOmsSavedCartLineItemId>
    <OmsSavedCartId>1259</OmsSavedCartId>
    <SKU>ap1534</SKU>
    <Quantity>1.0</Quantity>
    <OrderLineItemRelationshipTypeId>0</OrderLineItemRelationshipTypeId>
    <Sequence>2</Sequence>
    <AddonProducts >PINK</AddonProducts>
    <BundleProducts />
    <ConfigurableProducts />
    <PersonaliseValuesList>Address~Hello</PersonaliseValuesList>
  </SavedCartLineItemModel>
</ArrayOfSavedCartLineItemModel>' , @UserId=1 ,@Status=0
	rollback tran
*/
BEGIN
BEGIN TRAN InsertUpdateSaveCartLineItem;
BEGIN TRY
SET NOCOUNT ON;
	--Declared the variables
	DECLARE @GetDate datetime= dbo.Fn_GetDate();
	DECLARE @AddOnQuantity numeric(28, 6)= 0;
	DECLARE @IsAddProduct   BIT = 0 
	DECLARE @OmsSavedCartLineItemId INT = 0
	
	DECLARE @TBL_SavecartLineitems TABLE
	( 
		RowId int , OmsSavedCartLineItemId int, ParentOmsSavedCartLineItemId int, OmsSavedCartId int, SKU nvarchar(600), Quantity numeric(28, 6), OrderLineItemRelationshipTypeID int, CustomText nvarchar(max), 
		CartAddOnDetails nvarchar(max), Sequence int, AddOnValueIds varchar(max), BundleProductIds varchar(max), ConfigurableProductIds varchar(max), GroupProductIds varchar(max), PersonalisedAttribute XML, 
		AutoAddon varchar(max), OmsOrderId int, ItemDetails nvarchar(max),
		Custom1	nvarchar(max),Custom2 nvarchar(max),Custom3 nvarchar(max),Custom4
		nvarchar(max),Custom5 nvarchar(max),GroupId NVARCHAR(max) ,ProductName Nvarchar(1000) , Description NVARCHAR(max),AddOnQuantity NVARCHAR(max)
	);

	--Set the OrderLineItemRelationshipTypeId for Addons product
	DECLARE @OrderLineItemRelationshipTypeIdAddon int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'AddOns'
	);
	--Set the OrderLineItemRelationshipTypeId for simple product
	DECLARE @OrderLineItemRelationshipTypeIdSimple int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Simple'
	);
	--Set the OrderLineItemRelationshipTypeId for group product
	DECLARE @OrderLineItemRelationshipTypeIdGroup int=
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Group'
	);
	--Set the OrderLineItemRelationshipTypeId for Configurable product
	DECLARE @OrderLineItemRelationshipTypeIdConfigurable int=
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Configurable'
	);
	--Set the OrderLineItemRelationshipTypeId for Bundles product	
	DECLARE @OrderLineItemRelationshipTypeIdBundle int=
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Bundles'
	);

	-----Getting OmsSaveCartId FROM @OmsCookieMappingId
	DECLARE @OmsSavedCartId int
	--Getting OmsCookieMappingId on basis of @UserId and portalid if @UserId > 0 (Not a guest User)
	IF isnull(@OmsCookieMappingId,0)=0 and isnull(@UserId,0) <> 0  
	Begin
		SET @OmsCookieMappingId = (SELECT top 1 OmsCookieMappingId FROM ZnodeOmsCookieMapping with (nolock) where isnull(UserId,0) = @UserID AND isnull(PortalId,0) = @PortalId)
	END

	IF Not Exists(SELECT top 1 OmsCookieMappingId FROM ZnodeOmsCookieMapping with (nolock) Where OmsCookieMappingId = @OmsCookieMappingId)
	Begin
		INSERT INTO ZnodeOmsCookieMapping (UserId,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT case when @UserId = 0 then null else @UserId end ,@PortalId,@UserId,@GetDate,@UserId,@GetDate

		SET @OmsCookieMappingId = @@IDENTITY
	End
	----To get the oms savecartid on basis of @OmsCookieMappingId 
	SET @OmsSavedCartId = (SELECT top 1 OmsSavedCartId FROM ZnodeOmsSavedCart with (nolock) where OmsCookieMappingId = @OmsCookieMappingId)
	
	----If omssavecartid not present in ZnodeOmsSavedCart table then inserting new record to generated omssavecartid 
	IF isnull(@OmsSavedCartId,0) = 0
	BEGIN
		INSERT INTO ZnodeOmsSavedCart(OmsCookieMappingId,SalesTax,RecurringSalesTax,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT @OmsCookieMappingId,Null,Null,@UserId,@GetDate,@UserId,@GetDate

		SET @OmsSavedCartId = @@IDENTITY
	END

	--Fetching data FROM xml to table format and inserted into table @TBL_SavecartLineitems
	INSERT INTO @TBL_SavecartLineitems( RowId,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU, Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence, AddOnValueIds, BundleProductIds, ConfigurableProductIds, GroupProductIds, PersonalisedAttribute, AutoAddon, OmsOrderId, ItemDetails,
	Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,Description,AddOnQuantity )
	SELECT DENSE_RANK()Over(Order BY Tbl.Col.value( 'SKU[1]', 'NVARCHAR(2000)' )) RowId ,Tbl.Col.value( 'OmsSavedCartLineItemId[1]', 'NVARCHAR(2000)' ) AS OmsSavedCartLineItemId, Tbl.Col.value( 'ParentOmsSavedCartLineItemId[1]', 'NVARCHAR(2000)' ) AS ParentOmsSavedCartLineItemId, @OmsSavedCartId AS OmsSavedCartId, Tbl.Col.value( 'SKU[1]', 'NVARCHAR(2000)' ) AS SKU, Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(2000)' ) AS Quantity
	, Tbl.Col.value( 'OrderLineItemRelationshipTypeID[1]', 'NVARCHAR(2000)' ) AS OrderLineItemRelationshipTypeID, Tbl.Col.value( 'CustomText[1]', 'NVARCHAR(2000)' ) AS CustomText, Tbl.Col.value( 'CartAddOnDetails[1]', 'NVARCHAR(2000)' ) AS CartAddOnDetails, Tbl.Col.value( 'Sequence[1]', 'NVARCHAR(2000)' ) AS Sequence, Tbl.Col.value( 'AddonProducts[1]', 'NVARCHAR(2000)' ) AS AddOnValueIds, ISNULL(Tbl.Col.value( 'BundleProducts[1]', 'NVARCHAR(2000)' ),'') AS BundleProductIds, ISNULL(Tbl.Col.value( 'ConfigurableProducts[1]', 'NVARCHAR(2000)' ),'') AS ConfigurableProductIds, ISNULL(Tbl.Col.value( 'GroupProducts[1]', 'NVARCHAR(Max)' ),'') AS GroupProductIds, 
			Tbl.Col.query('(PersonaliseValuesDetail/node())') AS PersonaliseValuesDetail, Tbl.Col.value( 'AutoAddon[1]', 'NVARCHAR(Max)' ) AS AutoAddon, Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(Max)' ) AS OmsOrderId,
			Tbl.Col.value( 'ItemDetails[1]', 'NVARCHAR(Max)' ) AS ItemDetails,
			Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
			Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
			Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
			Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
			Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
			Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
			Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(Max)' ) AS ProductName,
			Tbl.Col.value( 'Description[1]', 'NVARCHAR(Max)' ) AS Description, 
			Tbl.Col.value( 'AddOnQuantity[1]', 'NVARCHAR(2000)' ) AS AddOnQuantity
	FROM @CartLineItemXML.nodes( '//ArrayOfSavedCartLineItemModel/SavedCartLineItemModel' ) AS Tbl(Col);
			  
	IF OBJECT_ID('tempdb..#TBL_SavecartLineitems') is not null
		DROP TABLE #TBL_SavecartLineitems

	IF OBJECT_ID('tempdb..#OldValueForAddon') is not null
		DROP TABLE #OldValueForAddon

	SELECT * INTO #TBL_SavecartLineitems FROM @TBL_SavecartLineitems
			
	UPDATE ZnodeOmsSavedCart
	SET ModifiedDate = GETDATE()
	WHERE OmsSavedCartId = (SELECT TOP 1  OmsSavedCartId FROM @TBL_SavecartLineitems)

	UPDATE  @TBL_SavecartLineitems
	SET 	Description = ISNUll(Description,'') 

	--Save cart execution code for bundle product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' )
	BEGIN 				
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
		BEGIN 
			SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0 )

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0)
			, ModifiedDate = @GetDate
			WHERE ( OmsSavedCartLineItemId = @OmsSavedCartLineItemId  
			OR ParentOmsSavedCartLineItemId =  @OmsSavedCartLineItemId   ) 

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
			FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
			INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
			WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
			AND SCLI.BundleProductIds <> ''

			--After update the existing cart with new save cart then deleting those records which are updated
			DELETE	FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0
		END 

		--Getting bundle save cart line item entries into table to pass for bundle prodcut sp
		DECLARE @TBL_bundleProduct TT_SavecartLineitems 
		INSERT INTO @TBL_bundleProduct 
		SELECT *  
		FROM @TBL_SavecartLineitems 
		WHERE ISNULL(BundleProductIds,'') <> '' 
				
		EXEC Znode_InsertUpdateSaveCartLineItemBundle @TBL_bundleProduct,@userId,@OrderLineItemRelationshipTypeIdBundle,@OrderLineItemRelationshipTypeIdAddon
				 
		DELETE FROM  @TBL_SavecartLineitems WHERE ISNULL(BundleProductIds,'') <> '' 
		SET @OmsSavedCartLineItemId = 0 
	END 
	--Save cart execution code for configurable product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' )
	BEGIN 				
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
		BEGIN 

			SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0 )
				 
			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
			, ModifiedDate = @GetDate
			WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
			FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
			INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
			WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
			AND SCLI.ConfigurableProductIds <> ''

			--After update the existing cart with new save cart then deleting those records which are updated
			DELETE	FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0
		END 
		--Getting bundle save cart line item entries into table to pass for configurable prodcut sp
		DECLARE @TBL_Configurable TT_SavecartLineitems 
		INSERT INTO @TBL_Configurable 
		SELECT *  
		FROM @TBL_SavecartLineitems 
		WHERE ISNULL(ConfigurableProductIds,'') <> '' 
		  
		EXEC Znode_InsertUpdateSaveCartLineItemConfigurable @TBL_Configurable,@userId,@OrderLineItemRelationshipTypeIdConfigurable,@OrderLineItemRelationshipTypeIdAddon
				  
		DELETE FROM @TBL_SavecartLineitems 
		WHERE ISNULL(ConfigurableProductIds,'') <> ''
		SET @OmsSavedCartLineItemId = 0  
	END 
	--Save cart execution code for group product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' )
	BEGIN 				
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
		BEGIN 
			--Updating the existing save cart for group product
			SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0 )
			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
			WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
			FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
			INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
			WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
			AND SCLI.GroupProductIds <> ''

			--After update the existing cart with new save cart then deleting those records which are updated
			DELETE	FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0
		END 
		--Getting bundle save cart line item entries into table to pass for group prodcut sp
		DECLARE @TBL_Group TT_SavecartLineitems 
		INSERT INTO @TBL_Group 
		SELECT *  
		FROM @TBL_SavecartLineitems 
		WHERE ISNULL(GroupProductIds,'') <> '' 
		
		EXEC Znode_InsertUpdateSaveCartLineItemGroup @TBL_Group,@userId,@OrderLineItemRelationshipTypeIdGroup,@OrderLineItemRelationshipTypeIdAddon
		
		--After update the existing cart with new save cart then deleting those records which are updated
		DELETE FROM @TBL_SavecartLineitems WHERE ISNULL(GroupProductIds,'') <> ''
		SET @OmsSavedCartLineItemId = 0  
	END 
	
	--This part is for updating the cart for existing line items for simple product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId <> 0  ) 
	BEGIN 
				 
		SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId <> 0 )
		UPDATE ZnodeOmsSavedCartLineItem 
		SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
		, ModifiedDate = @GetDate
		WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId

		UPDATE ZnodeOmsSavedCartLineItem 
		SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
		INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = @OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
		WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					
		DELETE	FROM @TBL_SavecartLineitems WHERE OmsSavedCartLineItemId <> 0
	END 
	--Save cart execution code for Simple product
	DECLARE @OmsInsertedData TABLE (OmsSavedCartLineItemId INT )
	--Inserting the personalise data into variable table @TBL_Personalise for inserting the personalise data for new products
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId int,SKU Varchar(600) ,PersonalizeCode NVARCHAr(max),PersonalizeValue NVARCHAr(max),DesignId NVARCHAr(max), ThumbnailURL NVARCHAr(max))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.SKU
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(Max)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(Max)' ) AS ThumbnailURL
	FROM @TBL_SavecartLineitems a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col) 
			  
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise1 TABLE (OmsSavedCartLineItemId INT ,PersonalizeCode NVARCHAr(max),PersonalizeValue NVARCHAr(max),DesignId NVARCHAr(max), ThumbnailURL NVARCHAr(max))
	INSERT INTO @TBL_Personalise1
	SELECT DISTINCT a.OmsSavedCartLineItemId 
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(Max)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(Max)' ) AS ThumbnailURL
	FROM (SELECT TOP 1 OmsSavedCartLineItemId,PersonalisedAttribute Valuex FROM  #TBL_SavecartLineitems TRTR ) a 
	CROSS APPLY	a.Valuex.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  
		    
			
	CREATE TABLE #NewSavecartLineitemDetails 
	(
		GenId INT IDENTITY(1,1),RowId	INT	,OmsSavedCartLineItemId	INT	 ,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	INT
		,SKU	NVARCHAR(MAX) ,Quantity	NUMERIC(28,6)	,OrderLineItemRelationshipTypeID	INT	,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	int	,AutoAddon	varchar(MAX)	,OmsOrderId	INT	,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX)
	)
	
	--Getting new save cart data
	INSERT INTO #NewSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU 
	FROM @TBL_SavecartLineitems a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
	
	--Getting new simple product save cart data
	INSERT INTO #NewSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, @OrderLineItemRelationshipTypeIdSimple, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU 
	FROM @TBL_SavecartLineitems  a 
	WHERE ISNULL(BundleProductIds,'') =  '' 
	AND  ISNULL(GroupProductIds,'') = ''	AND ISNULL(	ConfigurableProductIds,'') = ''
		GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity,  CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
			
	--Getting new Group,Bundle and Configurable products save cart data if addon is present for any line item
	INSERT INTO #NewSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
		,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
		WHEN  GroupProductIds <> '' THEN GroupProductIds 
		WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU 
	FROM @TBL_SavecartLineitems  a 
	WHERE AddOnValueIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
	
	CREATE TABLE #OldSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old save cart data if present for same SKU in the new save cart data for simple product	 
	INSERT INTO #OldSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM ZnodeOmsSavedCartLineItem a with (nolock)  
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.SKU,'')   )   
	AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple   

	--Getting the old save cart Parent data 
	INSERT INTO #OldSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
	AND  b.OrderLineItemRelationshipTypeID IS NULL 
		 
	DELETE a FROM #OldSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 
		
	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldSavecartLineitemDetails
		
	--Getting the old save cart addon data for old line items if present
	INSERT INTO #OldSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
	AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

	------Merge Addon for same product
	IF EXISTS(SELECT * FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'') <> '' )
	BEGIN

		INSERT INTO #OldValueForAddon 
		SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
		FROM ZnodeOmsSavedCartLineItem b with (nolock)
		INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
								( SELECT  ', ' + SKU FROM    
									( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
										where a.OmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
										FOR XML PATH('')
								), 1, 2, ''
								) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a where a.ParentOmsSavedCartLineItemId is not null and OrderLineItemRelationshipTypeID<>1

		SELECT distinct a.SKU, STUFF(
									( SELECT  ', ' + x.AddOnValueIds FROM    
									( SELECT DISTINCT b.AddOnValueIds FROM @TBL_SavecartLineitems b
										where a.SKU=b.SKU ) x
										FOR XML PATH('')
									), 1, 2, ''
								) AddOns
		INTO #AddOnAdded
		FROM @TBL_SavecartLineitems a

		IF NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
		BEGIN
			DELETE FROM #OldSavecartLineitemDetails
		END

	END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_SavecartLineitems ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldSavecartLineitemDetails a WHERE	
	ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN 
		
		DELETE FROM #OldSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
	    
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  <> '' )
		BEGIN 
		 
			DECLARE @parenTofAddon  TABLE( ParentOmsSavedCartLineItemId INT  )  
			INSERT INTO  @parenTofAddon 
			SELECT  ParentOmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  

			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ParentOmsSavedCartLineItemId FROM  @parenTofAddon)   
				AND ParentOmsSavedCartLineItemId IS NOT NULL  
				AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldSavecartLineitemDetails m)
			AND ParentOmsSavedCartLineItemId IS  NULL  
		 
		END 
		ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		BEGIN 

			DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple  )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
			OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		    
			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldSavecartLineitemDetails m)
			AND ParentOmsSavedCartLineItemId IS  NULL  

		END
		ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  = '' )
		BEGIN 

			DELETE FROM #OldSavecartLineitemDetails
		END 
	END 

	--Getting the personalise data for old save cart if present
	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)

	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		DELETE FROM #OldSavecartLineitemDetails
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 
		   
			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
			SELECT OmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
			OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		      
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 

			DELETE n FROM #OldSavecartLineitemDetails n WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
			OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
	   
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		BEGIN 
			DELETE FROM #OldSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		END 
	  
	END 

	--If already exists cart 
	IF EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails )
	BEGIN
		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU not having personalise value for new cart item
		;WITH cte AS
		(
			SELECT distinct b.*
			FROM @TBL_SavecartLineitems a 
			INNER JOIN #OldSavecartLineitemDetails b on ( a.SKU = b.sku)
			where isnull(cast(a.PersonalisedAttribute AS varchar(max)),'') = ''
		)
		,cte2 AS
		(
			SELECT c.ParentOmsSavedCartLineItemId
			FROM #OldSavecartLineitemDetails a
			INNER JOIN ZnodeOmsSavedCartLineItem c on a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		)
		DELETE a FROM #OldSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU having personalise value for new cart item
		;WITH cte AS
		(
			SELECT distinct b.*, 
				a.PersonalizeCode
				,a.PersonalizeValue
			FROM @TBL_Personalise a 
			INNER JOIN #OldSavecartLineitemDetails b on ( a.SKU = b.sku)
			where a.PersonalizeValue <> ''
		)
		,cte2 AS
		(
			SELECT a.ParentOmsSavedCartLineItemId, b.PersonalizeCode, b.PersonalizeValue
			FROM #OldSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
			WHERE NOT EXISTS(SELECT * FROM cte c where b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and b.PersonalizeCode = c.PersonalizeCode 
						and b.PersonalizeValue = c.PersonalizeValue )
		)
		DELETE a FROM #OldSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,b.ParentOmsSavedCartLineItemId , a.SKU AS SKU
				,a.PersonalizeCode
				,a.PersonalizeValue
				,a.DesignId
				,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldSavecartLineitemDetails b on a.SKU = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM #OldSavecartLineitemDetails b1 
		WHERE NOT EXISTS(SELECT * FROM cte c where (b1.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or b1.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId))
		AND EXISTS(SELECT * FROM cte)

		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
	-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldSavecartLineitemDetails b ON a.SKU = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
			--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewSavecartLineitemDetails  b ON a.SKU = b.SKU
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		from CTE_OldPersonalizeCodeCount a
		inner join CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		inner join #OldSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		
		--Delete parent entry if child not present
		DELETE a FROM #OldSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

	--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
	--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
	
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.SKU
						,d.PersonalizeCode
				,d.PersonalizeValue
				,d.DesignId
				,d.ThumbnailURL
				FROM @TBL_SavecartLineitems a 
				INNER JOIN #OldSavecartLineitemDetails b on a.SKU = b.SKU
				INNER JOIN @TBL_Personalise d on d.SKU = a.SKU
				INNER JOIN ZnodeOmsPersonalizeCartItem  c  with (nolock)  on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
				WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM cte a1		  
		INNER JOIN #OldSavecartLineitemDetails b1 on a1.sku = b1.SKU
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c where a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and a1.PersonalizeValue = c.PersonalizeValue)

		--Updating the cart if old and new cart data matches 
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5, 
		a.ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewSavecartLineitemDetails ty ON (ty.SKU = b.SKU)

	END 
	--Inserting the new save cart data if old and new cart data not match
	ELSE 
	BEGIN 
	    --Getting the new save cart data and generating row no. for new save cart insert
		SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU  
		INTO #InsertNewSavecartLineitem   
		FROM  #NewSavecartLineitemDetails  
		GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails ,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU   
		ORDER BY RowId, Id   
       	
		--Removing the line item having Quantity <=0	     
		DELETE FROM #InsertNewSavecartLineitem WHERE Quantity <=0  
  
		--Updating the rowid into new save cart line item as new line item is merged into existing save cart item
		;WITH VTTY AS   
		(  
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
			FROM #InsertNewSavecartLineitem m  
			INNER JOIN  #InsertNewSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU   
			WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon   
		)   
		UPDATE m1   
		SET m1.RowId = TYU.RowId  
		FROM #InsertNewSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  
        
		--Deleting the new save cart line item if cart line item is merged
		;WITH VTRET AS   
		(  
			SELECT RowId,id,Min(NewRowId) NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID  
			FROM #InsertNewSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID
			Having  SKU = ParentSKU  AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdSimple
		)   
		DELETE FROM #InsertNewSavecartLineitem WHERE NewRowId IN (SELECT NewRowId FROM VTRET)  

		--Inserting the new cart line item if not merged in existing save cart line item
		INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description)  
		OUTPUT INSERTED.OmsSavedCartLineItemId  INTO @OmsInsertedData 
		SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description   
		FROM  #InsertNewSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU  
		INTO #ParentOmsSavedCartId
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		AND CASE WHEN EXISTS (SELECT TOP 1 1 FROM #InsertNewSavecartLineitem TU WHERE TU.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple)  THEN ISNULL(a.OrderLineItemRelationshipTypeID,0) ELSE 0 END = 0 
		GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #ParentOmsSavedCartId  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
		AND a.ParentOmsSavedCartLineItemId IS nULL   

		SELECT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(Order BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #NewSimpleProduct
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c on b.sku = c.sku and b.OmsSavedCartId=c.OmsSavedCartId and b.Id = 1 
		WHERE ( ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  and c.ParentOmsSavedCartLineItemId is null

		--Updating ParentOmsSavedCartLineItemId for newly added save cart line item
		;WITH table_update AS 
		(
			SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId  ) RowIdNo
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
			AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
			AND a.ParentOmsSavedCartLineItemId IS NULL  
			AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
			AND EXISTS (SELECT TOP 1 1 FROM #NewSimpleProduct TI WHERE TI.SKU = a.SKU)
		)
		UPDATE a SET  
		a.ParentOmsSavedCartLineItemId =(SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewSimpleProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewSimpleProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU   GROUP BY r.ParentSKU, r.SKU  )    IS NOT NULL 
	 
		;WITH Cte_Th AS   
		(             
			SELECT RowId    
			FROM #InsertNewSavecartLineitem a   
			GROUP BY RowId   
			HAVING COUNT(NewRowId) <= 1   
		)   
		UPDATE a SET a.Quantity =  NULL , a.ModifiedDate = @GetDate  
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		AND OrderLineItemRelationshipTypeId IS NOT NULL     

		;WITH Cte_UpdateSequence AS   
		(  
			SELECT OmsSavedCartLineItemId ,Row_Number()Over(Order By OmsSavedCartLineItemId) RowId , Sequence   
			FROM ZnodeOmsSavedCartLineItem with (nolock)  
			WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		)   
		UPDATE Cte_UpdateSequence  
		SET  Sequence = RowId  
	
		----To update saved cart item personalise value FROM given line item	
		IF EXISTS(SELECT * FROM @TBL_Personalise1 where isnull(PersonalizeValue,'') <> '' and isnull(OmsSavedCartLineItemId,0) <> 0)
		BEGIN
			DELETE FROM ZnodeOmsPersonalizeCartItem 
			WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise1 yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )

			MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
			USING @TBL_Personalise1 SOURCE
			ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			WHEN NOT MATCHED THEN 
			INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
							,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
			VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
							,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
		END		
	
		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN ZnodeOmsSavedCartLineItem b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS NOT NULL 
	
		DELETE FROM ZnodeOmsPersonalizeCartItem 
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
						
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
		ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
		WHEN NOT MATCHED THEN 
		INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
					,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
		VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
					,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
  
		
		 
	END 

	Declare @OutputTable Table (CartCount numeric(28,6))

	INSERT INTO @OutputTable
	EXEC [Znode_GetOmsSavedCartLineItemCount] @OmsCookieMappingId = @OmsCookieMappingId,@UserId=@UserId,@PortalId=@UserId
	

	SELECT CAST(1 AS bit) AS Status,@OmsSavedCartId AS SavedCartId,@OmsCookieMappingId AS CookieMappingId,CartCount
	FROM @OutputTable

COMMIT TRAN InsertUpdateSaveCartLineItem;
END TRY
BEGIN CATCH
	SELECT ERROR_MESSAGE()	
	DECLARE @Error_procedure varchar(1000)= ERROR_PROCEDURE(), @ErrorMessage nvarchar(max)= ERROR_MESSAGE(), @ErrorLine varchar(100)= ERROR_LINE(), @ErrorCall nvarchar(max)= 'EXEC Znode_InsertUpdateSaveCartLineItem @CartLineItemXML = '+CAST(@CartLineItemXML
	AS varchar(max))+',@UserId = '+CAST(@UserId AS varchar(50))+',@PortalId='+CAST(@PortalId AS varchar(10))+',@OmsCookieMappingId='+CAST(@OmsCookieMappingId AS varchar(10));

	SELECT 0 AS ID, CAST(0 AS bit) AS Status,ERROR_MESSAGE();
	ROLLBACK TRAN InsertUpdateSaveCartLineItem;
	EXEC Znode_InsertProcedureErrorLog @ProcedureName = 'Znode_InsertUpdateSaveCartLineItem', @ErrorInProcedure = @Error_procedure, @ErrorMessage = @ErrorMessage, @ErrorLine = @ErrorLine, @ErrorCall = @ErrorCall;
END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetOrderDetailsByOrderId')
	DROP PROC Znode_GetOrderDetailsByOrderId

GO

CREATE PROCEDURE [dbo].[Znode_GetOrderDetailsByOrderId]
(
	@OmsOrderId	INT
)
AS
/* 
	Summary: This SP is used to get Order Details using OrderId
	EXEC Znode_GetOrderDetailsByOrderId @OmsOrderId = 105557
*/
BEGIN
BEGIN TRY
    SET NOCOUNT ON;

	SELECT OmsOrderId,OrderNumber,IsQuoteOrder,OmsQuoteId
	FROM ZnodeOmsOrder WHERE OmsOrderId = @OmsOrderId

	SELECT OrderDetail.OmsOrderDetailsId, OrderDetail.OmsOrderId, OrderDetail.PortalId AS PortalId, 
		OrderDetail.UserId, OrderDetail.OrderDate, OrderDetail.OmsOrderStateId, OrderDetail.ShippingId, 
		OrderDetail.PaymentTypeId, OrderDetail.BillingFirstName, OrderDetail.BillingLastName, OrderDetail.BillingCompanyName, 
		OrderDetail.BillingStreet1, OrderDetail.BillingStreet2, OrderDetail.BillingCity, OrderDetail.BillingStateCode, 
		OrderDetail.BillingPostalCode, OrderDetail.BillingCountry, OrderDetail.BillingPhoneNumber, OrderDetail.BillingEmailId, 
		OrderDetail.TaxCost, OrderDetail.ShippingCost, OrderDetail.SubTotal, OrderDetail.DiscountAmount, OrderDetail.CurrencyCode, 
		OrderDetail.OverDueAmount, OrderDetail.Total, OrderDetail.ShippingNumber, OrderDetail.TrackingNumber, OrderDetail.CouponCode, 
		OrderDetail.PromoDescription, OrderDetail.ReferralUserId, OrderDetail.PurchaseOrderNumber, OrderDetail.OmsPaymentStateId, 
		OrderDetail.WebServiceDownloadDate, OrderDetail.PaymentSettingId, OrderDetail.PaymentTransactionToken, OrderDetail.ShipDate, 
		OrderDetail.ReturnDate, OrderDetail.AddressId, OrderDetail.PoDocument, OrderDetail.IsActive, OrderDetail.ExternalId, 
		OrderDetail.CreatedBy, OrderDetail.CreatedDate, OrderDetail.ModifiedBy, OrderDetail.ModifiedDate, OrderDetail.CreditCardNumber, 
		OrderDetail.IsShippingCostEdited, OrderDetail.IsTaxCostEdited, OrderDetail.ShippingDifference, OrderDetail.EstimateShippingCost, 
		OrderDetail.TransactionId, OrderDetail.Custom1, OrderDetail.Custom2, OrderDetail.Custom3, OrderDetail.Custom4, OrderDetail.Custom5, 
		OrderDetail.FirstName, OrderDetail.LastName, OrderDetail.CardType,  OrderDetail.CreditCardExpMonth, OrderDetail.CreditCardExpYear, 
		OrderDetail.TotalAdditionalCost, OrderDetail.PaymentDisplayName, OrderDetail.PaymentExternalId, OrderDetail.CultureCode, 
		OrderDetail.DisplayName, OrderDetail.Email, OrderDetail.PhoneNumber, OrderDetail.ShippingHandlingCharges, 
		OrderDetail.OrderTotalWithoutVoucher, OrderDetail.InHandDate, OrderDetail.ShippingConstraintCode, OrderDetail.JobName, OrderDetail.ShippingDiscount
	FROM  dbo.ZnodeOmsOrderDetails AS OrderDetail
	WHERE OrderDetail.OmsOrderId = @OmsOrderId

	SELECT Ship.ShippingId, Ship.ShippingTypeId, Ship.CurrencyId, 
		Ship.ShippingCode, Ship.ShippingName, Ship.HandlingCharge, Ship.HandlingChargeBasedOn, Ship.DestinationCountryCode, Ship.StateCode, 
		Ship.CountyFIPS, Ship.TrackingUrl, Ship.Description, Ship.IsActive, Ship.DisplayOrder, Ship.ZipCode, Ship.CreatedBy, Ship.CreatedDate, 
		Ship.ModifiedBy, Ship.ModifiedDate, Ship.DeliveryTimeframe, Ship.CultureId
	FROM ZnodeShipping Ship 
	WHERE EXISTS(SELECT * FROM ZnodeOmsOrderDetails OrderDetail WHERE OrderDetail.ShippingId = Ship.ShippingId AND OrderDetail.OmsOrderId = @OmsOrderId)


	SELECT OrderLine.OmsOrderLineItemsId, OrderLine.ParentOmsOrderLineItemsId, OrderLine.OrderLineItemRelationshipTypeId, 
		OrderLine.OmsOrderDetailsId, OrderLine.OmsOrderShipmentId, OrderLine.RmaReasonForReturnId, OrderLine.Sku, OrderLine.ProductName, 
		OrderLine.Description, OrderLine.Quantity, OrderLine.Price, OrderLine.Weight, OrderLine.DownloadLink, OrderLine.DiscountAmount, 
		OrderLine.ShipSeparately, OrderLine.ShipDate, OrderLine.ReturnDate, OrderLine.ShippingCost, OrderLine.PromoDescription, 
		OrderLine.TransactionNumber, OrderLine.PaymentStatusId, OrderLine.TrackingNumber, OrderLine.IsAutoGeneratedTracking, 
		OrderLine.OrderLineItemStateId, OrderLine.IsRecurringBilling, OrderLine.RecurringBillingPeriod, OrderLine.RecurringBillingCycles, 
		OrderLine.RecurringBillingFrequency, OrderLine.RecurringBillingAmount, OrderLine.AppliedPromo, OrderLine.CouponsApplied, 
		OrderLine.ExternalId, OrderLine.IsActive, OrderLine.CreatedBy, OrderLine.CreatedDate, OrderLine.ModifiedBy, OrderLine.ModifiedDate, 
		OrderLine.AutoAddonSKU, OrderLine.IsShippingReturn, OrderLine.PartialRefundAmount, OrderLine.Custom1, OrderLine.Custom2, OrderLine.Custom3, 
		OrderLine.Custom4, OrderLine.Custom5, OrderLine.GroupId
    FROM  dbo.ZnodeOmsOrderLineItems AS OrderLine
    WHERE Exists(select * from ZnodeOmsOrderDetails OrderDetail Where OrderLine.OmsOrderDetailsId = OrderDetail.OmsOrderDetailsId 
	     AND OrderDetail.IsActive = 1 AND OrderDetail.OmsOrderId = @OmsOrderId) 
	AND OrderLine.IsActive = 1
    ORDER BY OrderLine.OmsOrderLineItemsId ASC

	SELECT OrderState.OmsOrderStateId, OrderState.OrderStateName, OrderState.IsShowToCustomer, 
		OrderState.IsAccountStatus, OrderState.DisplayOrder, OrderState.Description, OrderState.IsEdit, OrderState.IsSendEmail, OrderState.IsOrderState, 
		OrderState.IsOrderLineItemState, OrderState.CreatedBy, OrderState.CreatedDate, OrderState.ModifiedBy, OrderState.ModifiedDate
	FROM dbo.ZnodeOmsOrderState AS OrderState
	WHERE EXISTS(SELECT * FROM dbo.ZnodeOmsOrderLineItems AS OrderLine WHERE OrderLine.IsActive = 1 AND 
				 Exists(select * from ZnodeOmsOrderDetails OrderDetail Where OrderLine.OmsOrderDetailsId = OrderDetail.OmsOrderDetailsId 
				 AND OrderDetail.IsActive = 1 AND OrderDetail.OmsOrderId = @OmsOrderId) 
				 AND OrderLine.OrderLineItemStateId = OrderState.OmsOrderStateId)
END TRY
BEGIN CATCH
	DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetOrderDetailsByOrderId @OmsOrderId='+cast(@OmsOrderId as varchar(10));
	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName    = 'Znode_GetOrderDetailsByOrderId',
	@ErrorInProcedure = @ERROR_PROCEDURE,
	@ErrorMessage     = @ErrorMessage,
	@ErrorLine        = @ErrorLine,
	@ErrorCall        = @ErrorCall;
END CATCH;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemQuantityWrapper')
	DROP PROC Znode_InsertUpdateSaveCartLineItemQuantityWrapper

GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemQuantityWrapper]
(
	@CartLineItemXML xml, 
	@UserId int,
	@PortalId Int,
	@OmsCookieMappingId INT = 0 
)
AS 
   /* 
    Summary: THis Procedure is USed to save and edit the saved cart line item      
    Unit Testing 
	begin tran  
    Exec Znode_InsertUpdateSaveCartLineItem @CartLineItemXML= '<ArrayOfSavedCartLineItemModel>
  <SavedCartLineItemModel>
    <OmsSavedCartLineItemId>0</OmsSavedCartLineItemId>
    <ParentOmsSavedCartLineItemId>0</ParentOmsSavedCartLineItemId>
    <OmsSavedCartId>1259</OmsSavedCartId>
    <SKU>BlueGreenYellow</SKU>
    <Quantity>1.000000</Quantity>
    <OrderLineItemRelationshipTypeId>0</OrderLineItemRelationshipTypeId>
    <Sequence>1</Sequence>
    <AddonProducts>YELLOW</AddonProducts>
    <BundleProducts />
    <ConfigurableProducts>GREEN</ConfigurableProducts>
  </SavedCartLineItemModel>
  <SavedCartLineItemModel>
    <OmsSavedCartLineItemId>0</OmsSavedCartLineItemId>
    <ParentOmsSavedCartLineItemId>0</ParentOmsSavedCartLineItemId>
    <OmsSavedCartId>1259</OmsSavedCartId>
    <SKU>ap1534</SKU>
    <Quantity>1.0</Quantity>
    <OrderLineItemRelationshipTypeId>0</OrderLineItemRelationshipTypeId>
    <Sequence>2</Sequence>
    <AddonProducts >PINK</AddonProducts>
    <BundleProducts />
    <ConfigurableProducts />
    <PersonaliseValuesList>Address~Hello</PersonaliseValuesList>
  </SavedCartLineItemModel>
</ArrayOfSavedCartLineItemModel>' , @UserId=1 ,@Status=0
	rollback tran
*/
BEGIN
BEGIN TRAN InsertUpdateSaveCartLineItem;
BEGIN TRY
SET NOCOUNT ON;
	--Declared the variables
	DECLARE @GetDate datetime= dbo.Fn_GetDate();
	DECLARE @AddOnQuantity numeric(28, 6)= 0;
	DECLARE @IsAddProduct   BIT = 0 
	DECLARE @OmsSavedCartLineItemId INT = 0
	
	DECLARE @TBL_SavecartLineitems TABLE
	( 
		RowId int IDENTITY(1,1), OmsSavedCartLineItemId int, ParentOmsSavedCartLineItemId int, OmsSavedCartId int, SKU nvarchar(600), Quantity numeric(28, 6), OrderLineItemRelationshipTypeID int, CustomText nvarchar(max), 
		CartAddOnDetails nvarchar(max), Sequence int, AddOnValueIds varchar(max), BundleProductIds varchar(max), ConfigurableProductIds varchar(max), GroupProductIds varchar(max), PersonalisedAttribute XML, 
		AutoAddon varchar(max), OmsOrderId int, ItemDetails nvarchar(max),
		Custom1	nvarchar(max),Custom2 nvarchar(max),Custom3 nvarchar(max),Custom4
		nvarchar(max),Custom5 nvarchar(max),GroupId NVARCHAR(max) ,ProductName Nvarchar(1000) , Description NVARCHAR(max),AddOnQuantity NVARCHAR(max)
	);

	--Set the OrderLineItemRelationshipTypeId for Addons product
	DECLARE @OrderLineItemRelationshipTypeIdAddon int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'AddOns'
	);
	--Set the OrderLineItemRelationshipTypeId for simple product
	DECLARE @OrderLineItemRelationshipTypeIdSimple int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Simple'
	);
	--Set the OrderLineItemRelationshipTypeId for group product
	DECLARE @OrderLineItemRelationshipTypeIdGroup int=
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Group'
	);
	--Set the OrderLineItemRelationshipTypeId for Configurable product
	DECLARE @OrderLineItemRelationshipTypeIdConfigurable int=
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Configurable'
	);
	--Set the OrderLineItemRelationshipTypeId for Bundles product	
	DECLARE @OrderLineItemRelationshipTypeIdBundle int=
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Bundles'
	);

	-----Getting OmsSaveCartId FROM @OmsCookieMappingId
	DECLARE @OmsSavedCartId int
	--Getting OmsCookieMappingId on basis of @UserId and portalid if @UserId > 0 (Not a guest User)
	IF isnull(@OmsCookieMappingId,0)=0 and isnull(@UserId,0) <> 0  
	Begin
		SET @OmsCookieMappingId = (SELECT top 1 OmsCookieMappingId FROM ZnodeOmsCookieMapping with (nolock) where isnull(UserId,0) = @UserID AND isnull(PortalId,0) = @PortalId)
	END

	IF Not Exists(SELECT top 1 OmsCookieMappingId FROM ZnodeOmsCookieMapping with (nolock) Where OmsCookieMappingId = @OmsCookieMappingId)
	Begin
		INSERT INTO ZnodeOmsCookieMapping (UserId,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT case when @UserId = 0 then null else @UserId end ,@PortalId,@UserId,@GetDate,@UserId,@GetDate

		SET @OmsCookieMappingId = @@IDENTITY
	End
	----To get the oms savecartid on basis of @OmsCookieMappingId 
	SET @OmsSavedCartId = (SELECT top 1 OmsSavedCartId FROM ZnodeOmsSavedCart with (nolock) where OmsCookieMappingId = @OmsCookieMappingId)
	
	----If omssavecartid not present in ZnodeOmsSavedCart table then inserting new record to generated omssavecartid 
	IF isnull(@OmsSavedCartId,0) = 0
	BEGIN
		INSERT INTO ZnodeOmsSavedCart(OmsCookieMappingId,SalesTax,RecurringSalesTax,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT @OmsCookieMappingId,Null,Null,@UserId,@GetDate,@UserId,@GetDate

		SET @OmsSavedCartId = @@IDENTITY
	END

	--Fetching data FROM xml to table format and inserted into table @TBL_SavecartLineitems
	INSERT INTO @TBL_SavecartLineitems( OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU, Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence, AddOnValueIds, BundleProductIds, ConfigurableProductIds, GroupProductIds, PersonalisedAttribute, AutoAddon, OmsOrderId, ItemDetails,
	Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,Description,AddOnQuantity )
	SELECT Tbl.Col.value( 'OmsSavedCartLineItemId[1]', 'NVARCHAR(2000)' ) AS OmsSavedCartLineItemId, Tbl.Col.value( 'ParentOmsSavedCartLineItemId[1]', 'NVARCHAR(2000)' ) AS ParentOmsSavedCartLineItemId, @OmsSavedCartId AS OmsSavedCartId, Tbl.Col.value( 'SKU[1]', 'NVARCHAR(2000)' ) AS SKU, Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(2000)' ) AS Quantity
	, Tbl.Col.value( 'OrderLineItemRelationshipTypeID[1]', 'NVARCHAR(2000)' ) AS OrderLineItemRelationshipTypeID, Tbl.Col.value( 'CustomText[1]', 'NVARCHAR(2000)' ) AS CustomText, Tbl.Col.value( 'CartAddOnDetails[1]', 'NVARCHAR(2000)' ) AS CartAddOnDetails, Tbl.Col.value( 'Sequence[1]', 'NVARCHAR(2000)' ) AS Sequence, Tbl.Col.value( 'AddonProducts[1]', 'NVARCHAR(2000)' ) AS AddOnValueIds, ISNULL(Tbl.Col.value( 'BundleProducts[1]', 'NVARCHAR(2000)' ),'') AS BundleProductIds, ISNULL(Tbl.Col.value( 'ConfigurableProducts[1]', 'NVARCHAR(2000)' ),'') AS ConfigurableProductIds, ISNULL(Tbl.Col.value( 'GroupProducts[1]', 'NVARCHAR(Max)' ),'') AS GroupProductIds, 
			Tbl.Col.query('(PersonaliseValuesDetail/node())') AS PersonaliseValuesDetail, Tbl.Col.value( 'AutoAddon[1]', 'NVARCHAR(Max)' ) AS AutoAddon, Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(Max)' ) AS OmsOrderId,
			Tbl.Col.value( 'ItemDetails[1]', 'NVARCHAR(Max)' ) AS ItemDetails,
			Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
			Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
			Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
			Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
			Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
			Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
			Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(Max)' ) AS ProductName,
			Tbl.Col.value( 'Description[1]', 'NVARCHAR(Max)' ) AS Description, 
			Tbl.Col.value( 'AddOnQuantity[1]', 'NVARCHAR(2000)' ) AS AddOnQuantity
	FROM @CartLineItemXML.nodes( '//ArrayOfSavedCartLineItemModel/SavedCartLineItemModel' ) AS Tbl(Col);
			  
	IF OBJECT_ID('tempdb..#TBL_SavecartLineitems') is not null
		DROP TABLE #TBL_SavecartLineitems

	IF OBJECT_ID('tempdb..#OldValueForAddon') is not null
		DROP TABLE #OldValueForAddon

	SELECT * INTO #TBL_SavecartLineitems FROM @TBL_SavecartLineitems
			
	UPDATE ZnodeOmsSavedCart
	SET ModifiedDate = GETDATE()
	WHERE OmsSavedCartId = (SELECT TOP 1  OmsSavedCartId FROM @TBL_SavecartLineitems)

	UPDATE  @TBL_SavecartLineitems
	SET 	Description = ISNUll(Description,'') 

	--Save cart execution code for bundle product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' )
	BEGIN 				
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
		BEGIN 
			SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0 )

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0)
			, ModifiedDate = @GetDate
			WHERE ( OmsSavedCartLineItemId = @OmsSavedCartLineItemId  
			OR ParentOmsSavedCartLineItemId =  @OmsSavedCartLineItemId   ) 

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
			FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
			INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
			WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
			AND SCLI.BundleProductIds <> ''

			--After update the existing cart with new save cart then deleting those records which are updated
			DELETE	FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0
		END 

		--Getting bundle save cart line item entries into table to pass for bundle prodcut sp
		DECLARE @TBL_bundleProduct TT_SavecartLineitems 
		INSERT INTO @TBL_bundleProduct 
		SELECT *  
		FROM @TBL_SavecartLineitems 
		WHERE ISNULL(BundleProductIds,'') <> '' 
				
		EXEC Znode_InsertUpdateSaveCartLineItemBundle @TBL_bundleProduct,@userId,@OrderLineItemRelationshipTypeIdBundle,@OrderLineItemRelationshipTypeIdAddon
				 
		DELETE FROM  @TBL_SavecartLineitems WHERE ISNULL(BundleProductIds,'') <> '' 
		SET @OmsSavedCartLineItemId = 0 
	END 
	--Save cart execution code for configurable product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' )
	BEGIN 				
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
		BEGIN 

			SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0 )
				 
			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
			, ModifiedDate = @GetDate
			WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
			FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
			INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
			WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
			AND SCLI.ConfigurableProductIds <> ''

			--After update the existing cart with new save cart then deleting those records which are updated
			DELETE	FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0
		END 
		--Getting bundle save cart line item entries into table to pass for configurable prodcut sp
		DECLARE @TBL_Configurable TT_SavecartLineitems 
		INSERT INTO @TBL_Configurable 
		SELECT *  
		FROM @TBL_SavecartLineitems 
		WHERE ISNULL(ConfigurableProductIds,'') <> '' 
		  
		EXEC Znode_InsertUpdateSaveCartLineItemConfigurable @TBL_Configurable,@userId,@OrderLineItemRelationshipTypeIdConfigurable,@OrderLineItemRelationshipTypeIdAddon
				  
		DELETE FROM @TBL_SavecartLineitems 
		WHERE ISNULL(ConfigurableProductIds,'') <> ''
		SET @OmsSavedCartLineItemId = 0  
	END 
	--Save cart execution code for group product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' )
	BEGIN 				
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
		BEGIN 
			--Updating the existing save cart for group product
			SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0 )
			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
			WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
			FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
			INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
			WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
			AND SCLI.GroupProductIds <> ''

			--After update the existing cart with new save cart then deleting those records which are updated
			DELETE	FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0
		END 
		--Getting bundle save cart line item entries into table to pass for group prodcut sp
		DECLARE @TBL_Group TT_SavecartLineitems 
		INSERT INTO @TBL_Group 
		SELECT *  
		FROM @TBL_SavecartLineitems 
		WHERE ISNULL(GroupProductIds,'') <> '' 
		
		EXEC Znode_InsertUpdateSaveCartLineItemGroup @TBL_Group,@userId,@OrderLineItemRelationshipTypeIdGroup,@OrderLineItemRelationshipTypeIdAddon
		
		--After update the existing cart with new save cart then deleting those records which are updated
		DELETE FROM @TBL_SavecartLineitems WHERE ISNULL(GroupProductIds,'') <> ''
		SET @OmsSavedCartLineItemId = 0  
	END 
	
	--This part is for updating the cart for existing line items for simple product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId <> 0  ) 
	BEGIN 
				 
		SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId <> 0 )
		UPDATE ZnodeOmsSavedCartLineItem 
		SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
		, ModifiedDate = @GetDate
		WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId

		UPDATE ZnodeOmsSavedCartLineItem 
		SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
		INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = @OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
		WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					
		DELETE	FROM @TBL_SavecartLineitems WHERE OmsSavedCartLineItemId <> 0
	END 
	--Save cart execution code for Simple product
	DECLARE @OmsInsertedData TABLE (OmsSavedCartLineItemId INT )
	--Inserting the personalise data into variable table @TBL_Personalise for inserting the personalise data for new products
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId int,SKU Varchar(600) ,PersonalizeCode NVARCHAr(max),PersonalizeValue NVARCHAr(max),DesignId NVARCHAr(max), ThumbnailURL NVARCHAr(max))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.SKU
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(Max)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(Max)' ) AS ThumbnailURL
	FROM @TBL_SavecartLineitems a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col) 
			  
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise1 TABLE (OmsSavedCartLineItemId INT ,PersonalizeCode NVARCHAr(max),PersonalizeValue NVARCHAr(max),DesignId NVARCHAr(max), ThumbnailURL NVARCHAr(max))
	INSERT INTO @TBL_Personalise1
	SELECT DISTINCT a.OmsSavedCartLineItemId 
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(Max)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(Max)' ) AS ThumbnailURL
	FROM (SELECT TOP 1 OmsSavedCartLineItemId,PersonalisedAttribute Valuex FROM  #TBL_SavecartLineitems TRTR ) a 
	CROSS APPLY	a.Valuex.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  
		    
			
	CREATE TABLE #NewSavecartLineitemDetails 
	(
		GenId INT IDENTITY(1,1),RowId	INT	,OmsSavedCartLineItemId	INT	 ,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	INT
		,SKU	NVARCHAR(MAX) ,Quantity	NUMERIC(28,6)	,OrderLineItemRelationshipTypeID	INT	,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	int	,AutoAddon	varchar(MAX)	,OmsOrderId	INT	,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX)
	)
	
	--Getting new save cart data
	INSERT INTO #NewSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU 
	FROM @TBL_SavecartLineitems a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
	
	--Getting new simple product save cart data
	INSERT INTO #NewSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, @OrderLineItemRelationshipTypeIdSimple, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU 
	FROM @TBL_SavecartLineitems  a 
	WHERE ISNULL(BundleProductIds,'') =  '' 
	AND  ISNULL(GroupProductIds,'') = ''	AND ISNULL(	ConfigurableProductIds,'') = ''
		GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity,  CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
			
	--Getting new Group,Bundle and Configurable products save cart data if addon is present for any line item
	INSERT INTO #NewSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
		,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
		WHEN  GroupProductIds <> '' THEN GroupProductIds 
		WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU 
	FROM @TBL_SavecartLineitems  a 
	WHERE AddOnValueIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
	
	CREATE TABLE #OldSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old save cart data if present for same SKU in the new save cart data for simple product	 
	INSERT INTO #OldSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM ZnodeOmsSavedCartLineItem a with (nolock)  
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.SKU,'')   )   
	AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple   

	--Getting the old save cart Parent data 
	INSERT INTO #OldSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
	AND  b.OrderLineItemRelationshipTypeID IS NULL 
		 
	DELETE a FROM #OldSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 
		
	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldSavecartLineitemDetails
		
	--Getting the old save cart addon data for old line items if present
	INSERT INTO #OldSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
	AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

	------Merge Addon for same product
	IF EXISTS(SELECT * FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'') <> '' )
	BEGIN

		INSERT INTO #OldValueForAddon 
		SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
		FROM ZnodeOmsSavedCartLineItem b with (nolock)
		INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
								( SELECT  ', ' + SKU FROM    
									( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
										where a.OmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
										FOR XML PATH('')
								), 1, 2, ''
								) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a where a.ParentOmsSavedCartLineItemId is not null and OrderLineItemRelationshipTypeID<>1

		SELECT distinct a.SKU, STUFF(
									( SELECT  ', ' + x.AddOnValueIds FROM    
									( SELECT DISTINCT b.AddOnValueIds FROM @TBL_SavecartLineitems b
										where a.SKU=b.SKU ) x
										FOR XML PATH('')
									), 1, 2, ''
								) AddOns
		INTO #AddOnAdded
		FROM @TBL_SavecartLineitems a

		IF NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
		BEGIN
			DELETE FROM #OldSavecartLineitemDetails
		END

	END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_SavecartLineitems ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldSavecartLineitemDetails a WHERE	
	ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN 
		
		DELETE FROM #OldSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
	    
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  <> '' )
		BEGIN 
		 
			DECLARE @parenTofAddon  TABLE( ParentOmsSavedCartLineItemId INT  )  
			INSERT INTO  @parenTofAddon 
			SELECT  ParentOmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  

			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ParentOmsSavedCartLineItemId FROM  @parenTofAddon)   
				AND ParentOmsSavedCartLineItemId IS NOT NULL  
				AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldSavecartLineitemDetails m)
			AND ParentOmsSavedCartLineItemId IS  NULL  
		 
		END 
		ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		BEGIN 

			DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple  )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
			OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		    
			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldSavecartLineitemDetails m)
			AND ParentOmsSavedCartLineItemId IS  NULL  

		END
		ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  = '' )
		BEGIN 

			DELETE FROM #OldSavecartLineitemDetails
		END 
	END 

	--Getting the personalise data for old save cart if present
	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)

	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		DELETE FROM #OldSavecartLineitemDetails
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 
		   
			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
			SELECT OmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
			OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		      
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 

			DELETE n FROM #OldSavecartLineitemDetails n WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
			OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
	   
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		BEGIN 
			DELETE FROM #OldSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		END 
	  
	END 

	--If already exists cart 
	IF EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails )
	BEGIN
		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU not having personalise value for new cart item
		;WITH cte AS
		(
			SELECT distinct b.*
			FROM @TBL_SavecartLineitems a 
			INNER JOIN #OldSavecartLineitemDetails b on ( a.SKU = b.sku)
			where isnull(cast(a.PersonalisedAttribute AS varchar(max)),'') = ''
		)
		,cte2 AS
		(
			SELECT c.ParentOmsSavedCartLineItemId
			FROM #OldSavecartLineitemDetails a
			INNER JOIN ZnodeOmsSavedCartLineItem c on a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		)
		DELETE a FROM #OldSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU having personalise value for new cart item
		;WITH cte AS
		(
			SELECT distinct b.*, 
				a.PersonalizeCode
				,a.PersonalizeValue
			FROM @TBL_Personalise a 
			INNER JOIN #OldSavecartLineitemDetails b on ( a.SKU = b.sku)
			where a.PersonalizeValue <> ''
		)
		,cte2 AS
		(
			SELECT a.ParentOmsSavedCartLineItemId, b.PersonalizeCode, b.PersonalizeValue
			FROM #OldSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
			WHERE NOT EXISTS(SELECT * FROM cte c where b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and b.PersonalizeCode = c.PersonalizeCode 
						and b.PersonalizeValue = c.PersonalizeValue )
		)
		DELETE a FROM #OldSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,b.ParentOmsSavedCartLineItemId , a.SKU AS SKU
				,a.PersonalizeCode
				,a.PersonalizeValue
				,a.DesignId
				,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldSavecartLineitemDetails b on a.SKU = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM #OldSavecartLineitemDetails b1 
		WHERE NOT EXISTS(SELECT * FROM cte c where (b1.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or b1.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId))
		AND EXISTS(SELECT * FROM cte)

		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
	-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldSavecartLineitemDetails b ON a.SKU = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
			--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewSavecartLineitemDetails  b ON a.SKU = b.SKU
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		from CTE_OldPersonalizeCodeCount a
		inner join CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		inner join #OldSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		
		--Delete parent entry if child not present
		DELETE a FROM #OldSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

	--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
	--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
	
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.SKU
						,d.PersonalizeCode
				,d.PersonalizeValue
				,d.DesignId
				,d.ThumbnailURL
				FROM @TBL_SavecartLineitems a 
				INNER JOIN #OldSavecartLineitemDetails b on a.SKU = b.SKU
				INNER JOIN @TBL_Personalise d on d.SKU = a.SKU
				INNER JOIN ZnodeOmsPersonalizeCartItem  c  with (nolock)  on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
				WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM cte a1		  
		INNER JOIN #OldSavecartLineitemDetails b1 on a1.sku = b1.SKU
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c where a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and a1.PersonalizeValue = c.PersonalizeValue)

		--Updating the cart if old and new cart data matches 
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5, 
		a.ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewSavecartLineitemDetails ty ON (ty.SKU = b.SKU)

	END 
	--Inserting the new save cart data if old and new cart data not match
	ELSE 
	BEGIN 
	    --Getting the new save cart data and generating row no. for new save cart insert
		SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU  
		INTO #InsertNewSavecartLineitem   
		FROM  #NewSavecartLineitemDetails  
		GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails ,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU   
		ORDER BY RowId, Id   
       	
		--Removing the line item having Quantity <=0	     
		DELETE FROM #InsertNewSavecartLineitem WHERE Quantity <=0  
  
		--Updating the rowid into new save cart line item as new line item is merged into existing save cart item
		;WITH VTTY AS   
		(  
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
			FROM #InsertNewSavecartLineitem m  
			INNER JOIN  #InsertNewSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU   
			WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon   
		)   
		UPDATE m1   
		SET m1.RowId = TYU.RowId  
		FROM #InsertNewSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  
        
		--Deleting the new save cart line item if cart line item is merged
		;WITH VTRET AS   
		(  
			SELECT RowId,id,Min(NewRowId) NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID  
			FROM #InsertNewSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID
			Having  SKU = ParentSKU  AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdSimple
		)   
		DELETE FROM #InsertNewSavecartLineitem WHERE NewRowId IN (SELECT NewRowId FROM VTRET)  

		--Inserting the new cart line item if not merged in existing save cart line item
		INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description)  
		OUTPUT INSERTED.OmsSavedCartLineItemId  INTO @OmsInsertedData 
		SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description   
		FROM  #InsertNewSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU  
		INTO #ParentOmsSavedCartId
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		AND CASE WHEN EXISTS (SELECT TOP 1 1 FROM #InsertNewSavecartLineitem TU WHERE TU.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple)  THEN ISNULL(a.OrderLineItemRelationshipTypeID,0) ELSE 0 END = 0 
		GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #ParentOmsSavedCartId  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
		AND a.ParentOmsSavedCartLineItemId IS nULL   

		SELECT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(Order BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #NewSimpleProduct
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c on b.sku = c.sku and b.OmsSavedCartId=c.OmsSavedCartId and b.Id = 1 
		WHERE ( ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  and c.ParentOmsSavedCartLineItemId is null

		--Updating ParentOmsSavedCartLineItemId for newly added save cart line item
		;WITH table_update AS 
		(
			SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId  ) RowIdNo
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
			AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
			AND a.ParentOmsSavedCartLineItemId IS NULL  
			AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
			AND EXISTS (SELECT TOP 1 1 FROM #NewSimpleProduct TI WHERE TI.SKU = a.SKU)
		)
		UPDATE a SET  
		a.ParentOmsSavedCartLineItemId =(SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewSimpleProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewSimpleProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU   GROUP BY r.ParentSKU, r.SKU  )    IS NOT NULL 
	 
		;WITH Cte_Th AS   
		(             
			SELECT RowId    
			FROM #InsertNewSavecartLineitem a   
			GROUP BY RowId   
			HAVING COUNT(NewRowId) <= 1   
		)   
		UPDATE a SET a.Quantity =  NULL , a.ModifiedDate = @GetDate  
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		AND OrderLineItemRelationshipTypeId IS NOT NULL     

		;WITH Cte_UpdateSequence AS   
		(  
			SELECT OmsSavedCartLineItemId ,Row_Number()Over(Order By OmsSavedCartLineItemId) RowId , Sequence   
			FROM ZnodeOmsSavedCartLineItem with (nolock)  
			WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		)   
		UPDATE Cte_UpdateSequence  
		SET  Sequence = RowId  
	
		----To update saved cart item personalise value FROM given line item	
		IF EXISTS(SELECT * FROM @TBL_Personalise1 where isnull(PersonalizeValue,'') <> '' and isnull(OmsSavedCartLineItemId,0) <> 0)
		BEGIN
			DELETE FROM ZnodeOmsPersonalizeCartItem 
			WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise1 yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )

			MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
			USING @TBL_Personalise1 SOURCE
			ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			WHEN NOT MATCHED THEN 
			INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
							,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
			VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
							,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
		END		
	
		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN ZnodeOmsSavedCartLineItem b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS NOT NULL 
	
		DELETE FROM ZnodeOmsPersonalizeCartItem 
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
						
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
		ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
		WHEN NOT MATCHED THEN 
		INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
					,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
		VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
					,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
  
		
		 
	END 

	Declare @OutputTable Table (CartCount numeric(28,6))

	INSERT INTO @OutputTable
	EXEC [Znode_GetOmsSavedCartLineItemCount] @OmsCookieMappingId = @OmsCookieMappingId,@UserId=@UserId,@PortalId=@UserId
	

	SELECT CAST(1 AS bit) AS Status,@OmsSavedCartId AS SavedCartId,@OmsCookieMappingId AS CookieMappingId,CartCount
	FROM @OutputTable

COMMIT TRAN InsertUpdateSaveCartLineItem;
END TRY
BEGIN CATCH
	SELECT ERROR_MESSAGE()	
	DECLARE @Error_procedure varchar(1000)= ERROR_PROCEDURE(), @ErrorMessage nvarchar(max)= ERROR_MESSAGE(), @ErrorLine varchar(100)= ERROR_LINE(), @ErrorCall nvarchar(max)= 'EXEC Znode_InsertUpdateSaveCartLineItem @CartLineItemXML = '+CAST(@CartLineItemXML
	AS varchar(max))+',@UserId = '+CAST(@UserId AS varchar(50))+',@PortalId='+CAST(@PortalId AS varchar(10))+',@OmsCookieMappingId='+CAST(@OmsCookieMappingId AS varchar(10));

	SELECT 0 AS ID, CAST(0 AS bit) AS Status,ERROR_MESSAGE();
	ROLLBACK TRAN InsertUpdateSaveCartLineItem;
	EXEC Znode_InsertProcedureErrorLog @ProcedureName = 'Znode_InsertUpdateSaveCartLineItem', @ErrorInProcedure = @Error_procedure, @ErrorMessage = @ErrorMessage, @ErrorLine = @ErrorLine, @ErrorCall = @ErrorCall;
END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdatePimProduct')
	DROP PROC Znode_InsertUpdatePimProduct

GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdatePimProduct]
(   @ProductXml NVARCHAR(max),
    @UserId     INT,
    @status     BIT OUT,
	@CopyPimProductId INT =0 )
AS
/*
     Summary : To Insert / Update single Product with multiple attribute values 
     Update Logic: 
*/
     BEGIN

         BEGIN TRY

		     DECLARE @ConvertedXML XML = REPLACE(REPLACE(REPLACE(@ProductXml,' & ', '&amp;'),'"', '&quot;'),'''', '&apos;')
             DECLARE @PimProductId INT= 0;
             DECLARE @PimProductDetail_xml PIMPRODUCTDETAIL;
             INSERT INTO @pimProductDetail_xml
                    SELECT Tbl.Col.value('ProductAttributeId[1]', 'int') AS ProductAttributeId,
                           Tbl.Col.value('ProductAttributeFamilyId[1]', 'int') AS ProductAttributeFamilyId,
                           Tbl.Col.value('ProductAttributeCode[1]', 'NVARCHAR(300)') AS ProductAttributeCode,
                           Tbl.Col.value('ProductAttributeDefaultValueId[1]', 'int') AS ProductAttributeDefaultValueId,
                           Tbl.Col.value('ProductAttributeValueId[1]', 'int') AS ProductAttributeValueId,
                           Tbl.Col.value('LocaleId[1]', 'INT') AS LocaleId,
                           Tbl.Col.value('ProductId[1]', 'INT') AS ProductId,
                           Tbl.Col.value('ProductAttributeValue[1]', 'NVARCHAR(Max)') AS ProductAttributeValue,
                           Tbl.Col.value('AssociatedProducts[1]', 'NVARCHAR(2000)') AS AssociatedProducts,
                           Tbl.Col.value('ConfigureAttributeIds[1]', 'NVARCHAR(2000)') AS ConfigureAttributeIds,
                           Tbl.Col.value('ConfigureFamilyIds[1]', 'NVARCHAR(2000)') AS ConfigureFamilyIds
                    FROM @ConvertedXML.nodes('//ArrayOfProductAttributeModel/ProductAttributeModel') AS Tbl(Col);
					--Validating SKU is present or not  
					 SET @PimProductId=(SELECT top 1 ZPAV.PimProductId FROM ZnodePimAttributeValue ZPAV     
										INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId    
										WHERE EXISTS(SELECT * FROM ZnodePimAttribute ZPA WHERE ZPA.PimAttributeId = ZPAV.PimAttributeId AND ZPA.AttributeCode = 'SKU')    
										AND EXISTS(SELECT * FROM @pimProductDetail_xml Z WHERE ProductAttributeCode = 'SKU' AND ZPAVL.AttributeValue = Z.AttributeValue AND ISNULL(Z.PimProductId,0) = 0)    )
     
					IF (@PimProductId  <> 0) 
					BEGIN  
						SET @status = 0  
						SELECT @PimProductId AS ID,CAST(0 AS BIT) AS Status;     
						RETURN;  
					END  
             -- Retrieve input productId from @PimProductDetail table ( having multiple attribute values with common productId) 
         BEGIN TRAN A;
             SET @PimProductId =
             (
                 SELECT TOP 1 PimProductId
                 FROM @PimProductDetail_xml
             );
             EXEC [dbo].[Znode_ImportInsertUpdatePimProduct]
                  @PimProductDetail_xml,
                  @UserId,
                  @status OUT,0
				  ,@CopyPimProductId ; 
			
             SET @status = 1;
             COMMIT TRAN A;
         END TRY
         BEGIN CATCH
             SELECT ERROR_MESSAGE()
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertUpdatePimProduct @ProductXml = '+CAST(@ProductXml AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@CopyPimProductId='+CAST(@CopyPimProductId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
			 ROLLBACK TRAN A;
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_InsertUpdatePimProduct',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateGlobalEntityMapper')
	DROP PROC Znode_InsertUpdateGlobalEntityMapper

GO

CREATE PROCEDURE Znode_InsertUpdateGlobalEntityMapper  
(  
	@EntiryMapper XML,  
	@UserId INT,  
	@Action nvarchar(50),  
	@Status INT = 0 OUT    
)  
AS  
BEGIN  
 BEGIN TRY    
 BEGIN TRAN SaveOrUpdateEntityMapper;   
	DECLARE @GetDate DATETIME = dbo.Fn_GetDate()

	IF OBJECT_ID('tempdb..#EntityMapper') IS NOT NULL     
	DROP TABLE #EntityMapper  
    
	--Getting xml data into table    
	SELECT     
	Tbl.Col.value ('GlobalAttributeId[1]' , 'INT') AS AttributeFamilyId,   
	Tbl.Col.value ('GlobalAttributeGroupId[1]' , 'INT') AS AttributeGroupId,    
	Tbl.Col.value ('AttributeDisplayOrder[1]' , 'INT') AS GroupDisplayOrder  
	INTO #EntityMapper    
	FROM @EntiryMapper.nodes ( '//ArrayOfGlobalAttributeGroupMapperModel/GlobalAttributeGroupMapperModel'  ) AS Tbl(Col)   
  
	IF @action='Insert'  
	BEGIN  
		INSERT INTO ZnodeGlobalFamilyGroupMapper(GlobalAttributeFamilyId,GlobalAttributeGroupId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)  
		SELECT AttributeFamilyId,AttributeGroupId,GroupDisplayOrder,@UserId,@GetDate,@UserId,@GetDate 
		FROM #EntityMapper hmapper
		LEFT JOIN ZnodeGlobalFamilyGroupMapper tmapper ON hmapper.AttributeFamilyId=tmapper.GlobalAttributeFamilyId AND hmapper.AttributeGroupId=tmapper.GlobalAttributeGroupId
		WHERE tmapper.GlobalAttributeFamilyId is null and tmapper.GlobalAttributeGroupId is null;
  
		INSERT INTO ZnodeGlobalGroupEntityMapper(GlobalEntityId,GlobalAttributeGroupId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)  
		SELECT AttributeFamilyId,AttributeGroupId,GroupDisplayOrder,@UserId,@GetDate,@UserId,@GetDate  
		FROM #EntityMapper;
		SET @Status = 1  
		SELECT 1 AS ID,CAST(@Status AS BIT) AS Status;     
	END  
	IF @action='Update'  
	BEGIN   
		UPDATE ZnodeGlobalFamilyGroupMapper SET AttributeGroupDisplayOrder=hmapper.GroupDisplayOrder,ModifiedBy=@UserId,ModifiedDate=GETDATE()  
		FROM ZnodeGlobalFamilyGroupMapper tmapper  
		INNER JOIN #EntityMapper hmapper on tmapper.GlobalAttributeFamilyId=hmapper.AttributeFamilyId AND tmapper.GlobalAttributeGroupId=hmapper.AttributeGroupId  
		--WHERE tmapper.GlobalAttributeFamilyId=hmapper.AttributeFamilyId AND tmapper.GlobalAttributeGroupId=hmapper.AttributeGroupId  
  
		UPDATE ZnodeGlobalGroupEntityMapper SET AttributeGroupDisplayOrder=hmapper.GroupDisplayOrder,ModifiedBy=@UserId,ModifiedDate=GETDATE()  FROM ZnodeGlobalGroupEntityMapper tmapper  
		INNER JOIN #EntityMapper hmapper on tmapper.GlobalEntityId=hmapper.AttributeFamilyId AND tmapper.GlobalAttributeGroupId=hmapper.AttributeGroupId  
		--WHERE tmapper.GlobalEntityId=hmapper.AttributeFamilyId AND tmapper.GlobalAttributeGroupId=hmapper.AttributeGroupId  
		SET @Status = 1  
		SELECT 1 AS ID,CAST(@Status AS BIT) AS Status;     
	END  
COMMIT TRAN SaveOrUpdateEntityMapper;  
END TRY    
BEGIN CATCH                      
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),    
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_SaveOrUpdateEntityMapper @@entiryMapper = '+ cast(@entiryMapper as varchar(2000));    
	SET @Status = 0                  
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                        
	ROLLBACK TRAN SaveOrUpdateEntityMapper;       
	EXEC Znode_InsertProcedureErrorLog    
	@ProcedureName = 'Znode_SaveOrUpdateEntityMapper',    
	@ErrorInProcedure = @Error_procedure,    
	@ErrorMessage = @ErrorMessage,    
	@ErrorLine = @ErrorLine,    
	@ErrorCall = @ErrorCall;    
END CATCH;    
  
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_UnassociateGroupFromFamily')
	DROP PROC Znode_UnassociateGroupFromFamily

GO

CREATE PROCEDURE [dbo].[Znode_UnassociateGroupFromFamily](
       @GlobalAttributeGroupId  VARCHAR(2000) ,
       @GlobalAttributeFamilyId INT  )
AS 
    /*
    Summary:  Check and unassociate the group from family if attribute of group is present in pim values then dont
    		  unassociate the group from family
 
   */
     BEGIN
         BEGIN TRAN B;
         BEGIN TRY
             SET NOCOUNT ON; 
			 DECLARE @GlobalEntityId as int
			 SET  @GlobalEntityId = (select GlobalEntityId from ZnodeGlobalAttributeFamily where GlobalAttributeFamilyId = @GlobalAttributeFamilyId)
			 Declare @TableName nvarchar(200) ,@SQL nvarchar(max) 
             ---- Declare the table to store the comma seperated data into record format ------------
             DECLARE @TBL_Group TABLE (
                                      ID                  INT ,
                                      GlobalAttributeGroupId INT
									  );
			DECLARE @TBL_NotToDeleteGroup TABLE (GlobalAttributeGroupId INT
									  );

			Select @TableName=TableName
			from ZnodeGlobalEntity
			Where GlobalEntityId =@GlobalEntityId

			if @TableName is not null
			Begin
		    	Set @SQL =' Select GlobalAttributeGroupId 
						from [dbo].['+@TableName+'] a
						inner join ZnodeGlobalAttributeGroupMapper b on a.GlobalAttributeId=b.GlobalAttributeId
						inner join dbo.Split('''+@GlobalAttributeGroupId+''','','') c on c.item =b.GlobalAttributeGroupId
						group by GlobalAttributeGroupId '
				   Begin Try
					  insert into @TBL_NotToDeleteGroup
					   EXEC SP_EXECUTESQl  @SQL
				   End Try
					Begin Catch
					End  Catch;
			end 


             INSERT INTO @TBL_Group
                    SELECT ID , item 
                    FROM ZnodeGlobalAttributeGroup  ZGAG 
					INNER JOIN dbo.split ( @GlobalAttributeGroupId , ',' ) SP ON (SP.Item = ZGAG.GlobalAttributeGroupId) --- store the comma separeted category id into variable table 
					Where not exists (Select 1 
					from @TBL_NotToDeleteGroup d
					Where d.GlobalAttributeGroupId=sp.Item )
					
					 

                BEGIN
                     DELETE FROM ZnodeGlobalFamilyGroupMapper
                     WHERE EXISTS ( SELECT TOP 1 1
                                    FROM @TBL_Group AS gwa
                                    WHERE gwa.GlobalAttributeGroupId = ZnodeGlobalFamilyGroupMapper.GlobalAttributeGroupId									
                                  )
					 AND ZnodeGlobalFamilyGroupMapper.GlobalAttributeFamilyId =@GlobalAttributeFamilyId;
                    
					 DELETE FROM ZnodeGlobalGroupEntityMapper   
                     WHERE EXISTS ( SELECT TOP 1 1  
                                    FROM @TBL_Group AS gwa  
                                    WHERE gwa.GlobalAttributeGroupId = ZnodeGlobalGroupEntityMapper.GlobalAttributeGroupId           
                                  )  
					AND ZnodeGlobalGroupEntityMapper.GlobalEntityId =@GlobalAttributeFamilyId;

					  IF( SELECT COUNT(1) FROM @TBL_Group ) =
					 ( SELECT COUNT(1) FROM Split(@GlobalAttributeGroupId, ',') )   
						 BEGIN
								SELECT 1 AS ID,CAST(1 AS BIT) AS [Status];
						 END;
					 ELSE
						 BEGIN
							  SELECT 1 AS ID,CAST(0 AS BIT) AS [Status];
						 END;

                 END;
             COMMIT TRAN B;
         END TRY
         BEGIN CATCH
               DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
			   @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_UnassociateGroupEntity @GlobalAttributeGroupId = '+@GlobalAttributeGroupId+',@GlobalEntityId='+CAST(@GlobalEntityId AS VARCHAR(200));
             SELECT 0 AS ID,
                    CAST(0 AS BIT) AS Status;
			 ROLLBACK TRAN B;
             EXEC Znode_InsertProcedureErrorLog
                  @ProcedureName = 'Znode_UnassociateGroupEntity',
                  @ErrorInProcedure = @Error_procedure,
                  @ErrorMessage = @ErrorMessage,
                  @ErrorLine = @ErrorLine,
                  @ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'TouchPointConfiguration','Recurring',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'TouchPointConfiguration' and ActionName = 'Recurring')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Site Search')
,(select top 1 ActionId from ZnodeActions where ControllerName = 'TouchPointConfiguration' and ActionName = 'Recurring') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Site Search')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'TouchPointConfiguration' and ActionName = 'Recurring'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Site Search') ,
(select top 1 ActionId from ZnodeActions where ControllerName = 'TouchPointConfiguration' and ActionName = 'Recurring')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Site Search')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'TouchPointConfiguration' and ActionName = 'Recurring'))

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'Hangfire','Dashboard',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'Hangfire' and ActionName = 'Dashboard')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Diagnostics & Maintenance')
,(select top 1 ActionId from ZnodeActions where ControllerName = 'Hangfire' and ActionName = 'Dashboard') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Diagnostics & Maintenance')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'Hangfire' and ActionName = 'Dashboard'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Diagnostics & Maintenance') ,
(select top 1 ActionId from ZnodeActions where ControllerName = 'Hangfire' and ActionName = 'Dashboard')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Diagnostics & Maintenance')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'Hangfire' and ActionName = 'Dashboard'))

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'NC_Idx_ZnodeAccount_ParentAccountId' AND object_id = OBJECT_ID('ZnodeAccount'))
BEGIN
    CREATE NONCLUSTERED INDEX NC_Idx_ZnodeAccount_ParentAccountId ON ZnodeAccount (ParentAccountId);		
END

GO

IF EXISTS (SELECT * FROM sysobjects WHERE xtype IN (N'FN', N'IF', N'TF') AND id = object_id(N'Fn_GetRecurciveAccounts'))
    DROP FUNCTION Fn_GetRecurciveAccounts
GO


CREATE FUNCTION [dbo].[Fn_GetRecurciveAccounts]
(
       @AccountId      INT 
)
RETURNS  @ConvertTableData TABLE (AccountId INT ,ParentAccountId INT  )
AS
     BEGIN
     
	   With Cte_RecursiveAccountId AS (
	       
		   SELECT AccountId ,ParentAccountId 
		   FROM ZnodeAccount WITH (NOLOCK)
		   WHERE AccountId = @AccountId OR @AccountId = 0 

		   UNION ALL 

		   SELECT ZA.AccountId ,ZA.ParentAccountId 
		   FROM ZnodeAccount ZA WITH (NOLOCK) 
		   INNER JOIN Cte_RecursiveAccountId CTRA ON (ZA.ParentAccountId = CTRA.AccountId)
	    
	   )

	   INSERT INTO @ConvertTableData
	   SELECT * 
	   FROM Cte_RecursiveAccountId
	 
	     
     
		 RETURN 
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeleteAccount')
	DROP PROC Znode_DeleteAccount

GO

CREATE PROCEDURE [dbo].[Znode_DeleteAccount]
( 
	@AccountId VARCHAR(2000)='',
	@Status    BIT OUT,
	@AccountIds TransferId READONLY ,
	@IsForceFullyDelete BIT =0 ,  
	@IsDebug bit = 0 
)
AS
  /* 
     Summary : Remove account details with child table date through accountid
     Sequence For Delete Data   
     1. ZnodeDepartment          
     2. ZnodeAccountAddress		 
     3. ZnodeAccountRoles		 
     4. ZnodeUser				 
     5. ZnodeAccountPermission 
     6. ZnodeAccount	
     7. ZnodePriceListAccount
     8. ZnodePortalAccount
     9. ZnodeNote
     10.ZnodeAccountPromotion
     here check if all account ids which is comma separeted in @AccountId  parameter if deleted all then output dataset status is true other wise its false
     Also check account id not have any chaild account or any user 
     Unit Testing	
	 begin tran
     EXEC Znode_DeleteAccount '5',0
     rollback tran
*/
BEGIN
BEGIN TRAN DeleteAccount;
BEGIN TRY
    SET NOCOUNT ON; 
	DECLARE @StatusOut Table (Id INT ,Message NVARCHAR(max), Status BIT )
    
	--Table varible to store string formated accountids into record format
	IF OBJECT_ID('tempdb..#TBL_AccountId') IS NOT NULL
		DROP TABLE #TBL_AccountId;

	CREATE TABLE #TBL_AccountId (AccountId INT);

    INSERT INTO #TBL_AccountId
    SELECT item
    FROM dbo.Split(@AccountId, ',')
	where @AccountId <> '';
			
	INSERT INTO #TBL_AccountId
	SELECT id FROM @AccountIds 

	--Getting accounts recursive data(child parent data)
	;With Cte_RecursiveAccountId AS 
	(
	       
		SELECT AccountId ,ParentAccountId 
		FROM ZnodeAccount a WITH (NOLOCK)
		WHERE exists(select * from #TBL_AccountId b where a.AccountId = b.AccountId)
		UNION ALL 
		SELECT ZA.AccountId ,ZA.ParentAccountId 
		FROM ZnodeAccount ZA WITH (NOLOCK) 
		INNER JOIN Cte_RecursiveAccountId CTRA ON (ZA.ParentAccountId = CTRA.AccountId)	    
	) 
	SELECT * 
	INTO #ConvertTableData
	FROM Cte_RecursiveAccountId

	CREATE NONCLUSTERED INDEX NC_INdx_AccountId ON #TBL_AccountId(AccountId);

    DECLARE @DeletedCount INT= 0; -- Carry the how much records are need to delete 
    -- Table variable to store deleted accountid will be used to delete records from child tables
    -- to avoid multiple calling of ZnodeAccount tables
	IF OBJECT_ID('tempdb..#TLB_DeleteAccountId') IS NOT NULL
	DROP TABLE #TLB_DeleteAccountId;
    CREATE TABLE #TLB_DeleteAccountId (AccountId INT);
    DECLARE @TBL_AddressDetail TABLE(AddressId INT); 
	DECLARE @TBL_UserS TABLE(UserId INT);
		
	-- this table is used to hold the address id related to the account ids 
    -- Retrive validate data from account table 
    -- Any kind of validation / restriction can apply on following query for deletion
	IF OBJECT_ID('tempdb..#AccountUserWith') IS NOT NULL
		DROP TABLE #AccountUserWith;
		
	CREATE TABLE #AccountUserWith (AccountId INT , ParentAccountId INT );
	
	INSERT INTO #AccountUserWith
	SELECT ZA.AccountId,ZA.ParentAccountId
    FROM [dbo].ZnodeAccount AS ZA WITH (NOLOCK)
    INNER JOIN #ConvertTableData AS TBA ON  ZA.AccountId = TBA.AccountId
    WHERE  EXISTS
    (
        SELECT TOP 1 1
        FROM ZnodeUser AS ZU WITH (NOLOCK)
		INNER JOIN ZnodeOmsOrderDetails ZOOSD WITH (NOLOCK) ON (ZOOSD.UserId = ZU.UserId)
        WHERE ZU.AccountId = ZA.AccountId
										
    )
		
	CREATE NONCLUSTERED INDEX NC_Idx_AccountId_PAccountId ON #AccountUserWith (AccountId,ParentAccountId);	
				
	DECLARE @TBL_GetUserDeleted TABLE (ID INT , [Status] BIT )

	  		
	INSERT INTO #TLB_DeleteAccountId
	SELECT ZA.AccountId
	FROM [dbo].ZnodeAccount AS ZA WITH (NOLOCK)
	WHERE 
	EXISTS( SELECT TOP 1 1 FROM #ConvertTableData SP WHERE   ZA.AccountId = SP.AccountId)
	AND (NOT EXISTS
	(
		SELECT TOP 1 1
		FROM #AccountUserWith AS ZU
		WHERE ZU.AccountId = ZA.AccountId
		OR ZU.ParentAccountId= ZA.AccountId
										
	)  OR 	 @IsForceFullyDelete =1 )
				   
	CREATE NONCLUSTERED INDEX NC_Idx_AccountId ON #TLB_DeleteAccountId (AccountId);		

	INSERT INTO @TBL_UserS 
	SELECT UserId 
	FROM ZnodeUser WITH (NOLOCK)
	WHERE EXISTS
	(
		SELECT TOP 1 1
		FROM #TLB_DeleteAccountId AS TBDA
		WHERE TBDA.AccountId = ZnodeUSer.AccountId
	);


	SET @DeletedCount =
	(
		SELECT COUNT(1)
		FROM #TLB_DeleteAccountId
	);
		
	DELETE FROM ZnodeDepartmentUser 
	WHERE DepartmentId IN (SELECT DepartmentId FROM ZnodeDepartment
    WHERE EXISTS
    (
        SELECT TOP 1 1
        FROM #TLB_DeleteAccountId AS TBDA
        WHERE TBDA.AccountId = ZnodeDepartment.AccountId
    ))
    DELETE FROM ZnodeDepartment
    WHERE EXISTS
    (
        SELECT TOP 1 1
        FROM #TLB_DeleteAccountId AS TBDA
        WHERE TBDA.AccountId = ZnodeDepartment.AccountId
    ); -- check for delete 

			

    DELETE FROM ZnodeAccountAddress
    OUTPUT Deleted.AddressId
        INTO @TBL_AddressDetail -- Insert the deleted AddressedId 
    WHERE EXISTS
    (
        SELECT TOP 1 1
        FROM #TLB_DeleteAccountId AS TBDA
        WHERE TBDA.AccountId = ZnodeAccountAddress.AccountId
    );

	DELETE FROM ZnodeAccountRoles
    WHERE EXISTS
    (
        SELECT TOP 1 1
        FROM #TLB_DeleteAccountId AS TBDA
        WHERE TBDA.AccountId = ZnodeAccountRoles.AccountId
    );
          
    DELETE FROM ZnodePriceListAccount
    WHERE EXISTS
    (
        SELECT TOP 1 1
        FROM #TLB_DeleteAccountId AS TBDA
        WHERE TBDA.AccountId = ZnodePriceListAccount.AccountId
    );
    DELETE FROM ZnodePortalAccount
    WHERE EXISTS
    (
        SELECT TOP 1 1
        FROM #TLB_DeleteAccountId AS TBDA
        WHERE TBDA.AccountId = ZnodePortalAccount.AccountId
    );
    DELETE FROM ZnodeNote
    WHERE EXISTS
    (
        SELECT TOP 1 1
        FROM #TLB_DeleteAccountId AS TBDA
        WHERE TBDA.AccountId = ZnodeNote.AccountId
    );
    DELETE FROM ZnodeAccountPromotion
    WHERE EXISTS
    (
        SELECT TOP 1 1
        FROM #TLB_DeleteAccountId AS TBDA
        WHERE TBDA.AccountId = ZnodeAccountPromotion.AccountId
    );

			 
	DELETE FROM ZnodeAccountProfile 
	WHERE EXISTS
	(
	SELECT TOP 1 1
	FROM #TLB_DeleteAccountId AS TBDA
	WHERE TBDA.AccountId = ZnodeAccountProfile.AccountId
	)

	DELETE FROM ZnodeUserProfile 
	WHERE EXISTS
    (
        SELECT TOP 1 1
        FROM @TBL_UserS AS TBDA
        WHERE TBDA.Userid = ZnodeUserProfile.UserId
    ) 
	DELETE FROM ZnodeUserPortal 
	WHERE EXISTS
    (
        SELECT TOP 1 1
        FROM @TBL_UserS AS TBDA
        WHERE TBDA.Userid = ZnodeUserPortal.UserId
    ) 
		
	DECLARE @UserId transferId 
	INSERT INTO @UserId 
	SELECT userId 
	FROM @TBL_UserS 

	DELETE FROM ZnodeAccountUserPermission 
	WHERE EXISTS (
            SELECT TOP 1 1
            FROM @TBL_UserS AS TBDA
            WHERE TBDA.UserId = ZnodeAccountUserPermission.UserId
        )
		
		DELETE FROM ZnodeAccountPermissionaccess
        WHERE EXISTS
        (
            SELECT TOP 1 1
            FROM ZnodeAccountPermission
            WHERE ZnodeAccountPermission.AccountPermissionId = ZnodeAccountPermissionaccess.AccountPermissionId
                AND EXISTS
            (
                SELECT TOP 1 1
                FROM #TLB_DeleteAccountId AS TBDA
                WHERE TBDA.AccountId = ZnodeAccountPermission.AccountId
            )
        );
        DELETE FROM ZnodeAccountPermission
        WHERE EXISTS
        (
            SELECT TOP 1 1
            FROM #TLB_DeleteAccountId AS TBDA
            WHERE TBDA.AccountId = ZnodeAccountPermission.AccountId
        );
	--	INSERT INTO @StatusOut(id ,Status)
	EXEC Znode_DeleteUserDetails @UserIds= @UserId,@Status=0,@IsForceFullyDelete = @IsForceFullyDelete,@IsCallInternal =1 
           
		DELETE FROM ZnodeAddress
        WHERE EXISTS
        (
            SELECT TOP 1 1
            FROM @TBL_AddressDetail AS TBD
            WHERE TBD.AddressId = ZnodeAddress.AddressId
        );

		DELETE FROM ZnodeAccount
        WHERE EXISTS
        (
            SELECT TOP 1 1
            FROM #TLB_DeleteAccountId AS TBDA
            WHERE TBDA.AccountId = ZnodeAccount.AccountId
        );

			
        SET @Status = 1;
        IF
        (
            SELECT COUNT(1)
            FROM #ConvertTableData
        ) = @DeletedCount    -- check for passed @AccountId ids is equal to the deleted ids with child accounts
            BEGIN
                SELECT 1 AS ID,
                    CAST(1 AS BIT) AS [Status]; 
            END;
        ELSE
            BEGIN
                SELECT 0 AS ID,
                    CAST(0 AS BIT) AS [Status];
            END;
		    
COMMIT TRAN DeleteAccount;
END TRY
	BEGIN CATCH
	SELECT 0 AS ID,
	CAST(0 AS BIT) AS Status;
	SELECT ERROR_MESSAGE()
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeleteAccount @AccountId = '+@AccountId+',@Status='+CAST(@Status AS VARCHAR(200));
             			 
	SET @Status = 0;
            
	ROLLBACK TRAN DeleteAccount;
	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_DeleteAccount',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
            
END CATCH;
END;


GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'IDX_ZnodePimAddOnProductDetail_PimAddOnProductId_PimChildProductId' AND object_id = OBJECT_ID('ZnodePimAddOnProductDetail'))
BEGIN
    CREATE NONCLUSTERED INDEX IDX_ZnodePimAddOnProductDetail_PimAddOnProductId_PimChildProductId
	ON [dbo].[ZnodePimAddOnProductDetail] ([PimAddOnProductId],[PimChildProductId])
	INCLUDE ([IsDefault],[DisplayOrder]);
END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'IDX_ZnodePimAddOnProductDetailPim_ChildProductId' AND object_id = OBJECT_ID('ZnodePimAddOnProductDetail'))
BEGIN
    CREATE NONCLUSTERED INDEX IDX_ZnodePimAddOnProductDetailPim_ChildProductId
	ON [dbo].[ZnodePimAddOnProductDetail] ([PimChildProductId])
	INCLUDE ([PimAddOnProductId],[IsDefault],[DisplayOrder]);
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeletePublishCatalogEntity')
	DROP PROC Znode_DeletePublishCatalogEntity

GO

CREATE PROCEDURE [dbo].[Znode_DeletePublishCatalogEntity]
(
    @PublishCatalogId  INT = 0 
   ,@UserId int = 0
   ,@IsRevertPublish bit = 0 
   ,@NewGUID nvarchar(500) 

)
AS
/*
	To Remove all publish catalog details from related entities
	Unit Testing : 
	Declare @Status bit 
	Exec [dbo].[ZnodePublishPortalEntity]
     @PortalId  = 1 
	,@LocaleId  = 0 
	,@RevisionState = 'PRODUCTION' 
	,@UserId = 2
	,@Status = @Status 
	--Select @Status 
*/
BEGIN
SET NOCOUNT ON
BEGIN TRY 
Begin Transaction 
--SET NOCOUNT ON
		Declare @Status Bit =0, @IsPreviewEnable  int,  @Batch INT;
		IF object_id('tempdb..[#Tbl_VersionEntity]') IS NOT NULL
			drop table tempdb..#Tbl_VersionEntity
		
		Create Table #Tbl_VersionEntity(PublishCatalogId int , VersionId int , LocaleId int , PublishType varchar(50))
		Insert into #Tbl_VersionEntity (PublishCatalogId , VersionId , LocaleId , PublishType )
			select ZnodeCatalogId , VersionId , LocaleId , RevisionType  from ZnodePublishVersionEntity   where ZnodeCatalogId = @PublishCatalogId 
			and  IsPublishSuccess =0  

		IF object_id('tempdb..[#Tbl_VersionEntityforCatalog]') IS NOT NULL
			drop table tempdb..#Tbl_VersionEntityforCatalog
		
		Create Table #Tbl_VersionEntityforCatalog(PublishCatalogId int , VersionId int , LocaleId int , PublishType varchar(50))
		Insert into #Tbl_VersionEntityforCatalog(PublishCatalogId , VersionId , LocaleId , PublishType )
		select ZnodeCatalogId , VersionId , LocaleId , RevisionType  from ZnodePublishVersionEntity   where ZnodeCatalogId = @PublishCatalogId 
		and  IsPublishSuccess = 0  

		IF object_id('tempdb..[#Tbl_OldVersionEntityforCatalog]') IS NOT NULL
			drop table tempdb..#Tbl_OldVersionEntityforCatalog
		
		Create Table #Tbl_OldVersionEntityforCatalog(PublishCatalogId int , VersionId int , LocaleId int , PublishType varchar(50),IsPublishSuccess bit )
		Insert into #Tbl_OldVersionEntityforCatalog(PublishCatalogId , VersionId , LocaleId , PublishType ,IsPublishSuccess)
		select ZnodeCatalogId , VersionId , LocaleId, RevisionType  ,IsPublishSuccess from ZnodePublishVersionEntity   where ZnodeCatalogId = @PublishCatalogId 
		and  IsPublishSuccess = 1  

		IF object_id('tempdb..[#Tbl_OldVersionEntityforDeletion]') IS NOT NULL
		drop table tempdb..#Tbl_OldVersionEntityforDeletion

		Create Table #Tbl_OldVersionEntityforDeletion(PublishCatalogId int , VersionId int , LocaleId int , PublishType varchar(50),IsPublishSuccess bit )
		Insert into #Tbl_OldVersionEntityforDeletion(PublishCatalogId , VersionId , LocaleId , PublishType ,IsPublishSuccess)
		select ZnodeCatalogId , VersionId , LocaleId, RevisionType  ,IsPublishSuccess from ZnodePublishVersionEntity   where ZnodeCatalogId = @PublishCatalogId 
		and  IsPublishSuccess = 1  and RevisionType  in 
		(Select distinct PublishType from #Tbl_VersionEntity where ZnodeCatalogId = #Tbl_VersionEntity.PublishCatalogId  )

		If @IsRevertPublish = 0 AND @PublishCatalogId > 0 AND Exists (Select Top 1 1 from #Tbl_VersionEntity ) 
		Begin 
			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =90, 
			IsCompleted  = 1,
			IsFailed =0
			where  JobId = @NewGUID

			Delete  From ZnodePublishCatalogEntity Where  VersionId NOT IN  (Select VersionId from #Tbl_VersionEntity) AND ZnodeCatalogId = @PublishCatalogId  
				AND VersionId IN  (SELECT VersionId from #Tbl_OldVersionEntityforDeletion) 
			SET @Batch= 1;
			WHILE @Batch > 0
			BEGIN 
				Delete  TOP (10000) From ZnodePublishProductEntity Where  VersionId NOT IN (Select VersionId from #Tbl_VersionEntity)  AND ZnodeCatalogId = @PublishCatalogId 
				AND VersionId IN  (SELECT VersionId from #Tbl_OldVersionEntityforDeletion) 
				SET @Batch= @@ROWCOUNT;
				-- CHECKPOINT;    -- if simple
				-- BACKUP LOG ... -- if full
			END

			Delete  From ZnodePublishAddOnEntity Where  VersionId NOT IN (Select VersionId from #Tbl_VersionEntity)  AND ZnodeCatalogId = @PublishCatalogId 
			AND VersionId IN  (SELECT VersionId from #Tbl_OldVersionEntityforDeletion) 

			
			Delete  From ZnodePublishCategoryEntity Where  VersionId NOT IN  (Select VersionId from #Tbl_VersionEntity) AND ZnodeCatalogId = @PublishCatalogId 
			AND VersionId IN  (SELECT VersionId from #Tbl_OldVersionEntityforDeletion) 

			Delete  From ZnodePublishBundleProductEntity Where  VersionId NOT IN (Select VersionId from #Tbl_VersionEntity) AND ZnodeCatalogId = @PublishCatalogId 
			AND VersionId IN  (SELECT VersionId from #Tbl_OldVersionEntityforDeletion) 

			Delete  From ZnodePublishGroupProductEntity Where  VersionId NOT IN (Select VersionId from #Tbl_VersionEntity) AND ZnodeCatalogId = @PublishCatalogId 
			AND VersionId IN  (SELECT VersionId from #Tbl_OldVersionEntityforDeletion) 

			Delete  From ZnodePublishConfigurableProductEntity Where  VersionId NOT IN (Select VersionId from #Tbl_VersionEntity) AND ZnodeCatalogId = @PublishCatalogId 
			AND VersionId IN  (SELECT VersionId from #Tbl_OldVersionEntityforDeletion) 

			Delete  From ZnodePublishSEOEntity Where CMSSEOTypeId in (1,2,4) and 
			VersionId NOT IN  (Select VersionId from #Tbl_VersionEntity) 
			AND VersionId IN  (SELECT VersionId from #Tbl_OldVersionEntityforDeletion) 

			Delete  From ZnodePublishVersionEntity Where  VersionId NOT IN (Select VersionId from #Tbl_VersionEntity) AND ZnodeCatalogId = @PublishCatalogId 
			AND VersionId IN  (SELECT VersionId from #Tbl_OldVersionEntityforDeletion) 

			Update ZnodePublishVersionEntity  SET IsPublishSuccess= 1 where IsPublishSuccess = 0
			and ZnodeCatalogId  = @PublishCatalogId   

			
			Update ZnodePublishCatalogLog SET IsCatalogPublished =1,  PublishStateId = DBO.Fn_GetPublishStateIdForPreview(), ModifiedDate = Getdate()  where  PublishCatalogLogId in 
			(Select VersionId from #Tbl_VersionEntity Where PublishType = 'PREVIEW' )
			Update ZnodePublishCatalogLog SET IsCatalogPublished =1,  PublishStateId = DBO.Fn_GetPublishStateIdForPublish()  , ModifiedDate = Getdate() where  PublishCatalogLogId in
			(Select VersionId from #Tbl_VersionEntity Where PublishType = 'PRODUCTION' )

			Insert into ZnodePublishPreviewLogEntity
			(VersionId,PublishStartTime,IsDisposed,SourcePublishState,EntityId,EntityType,LogMessage,LogCreatedDate,PreviousVersionId,LocaleId,LocaleDisplayValue)
				Select A.VersionId,NULL,NULL,A.PublishType,@PublishCatalogId,'catalog','catalog has been published successfully' , Getdate(),  
				(select TOP 1 VersionId   from #Tbl_OldVersionEntityforCatalog where LocaleId = A.LocaleId AND PublishType = A.PublishType
				AND  PublishCatalogId = A.PublishCatalogId and  IsPublishSuccess =1 ),
				A.LocaleId,B.Name
				from #Tbl_VersionEntity  A  Inner join ZnodeLocale B on A.LocaleId = B.LocaleId 

			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =100, 
			IsCompleted  = 1,
			IsFailed =0
			where  JobId = @NewGUID

			--UPDATE ZnodePimProduct SET IsProductPublish = 1,PublishStateId =  DBO.Fn_GetPublishStateIdForPublish()  
			--WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishProduct ZPP WHERE ZPP.PimProductId = ZnodePimProduct.PimProductId AND ZPP.PublishCatalogId = @PublishCatalogId)

			--UPDATE ZnodePublishCatalogLog 
			--SET IsProductPublished = 1 
			--,PublishProductId = (SELECT  COUNT(DISTINCT PublishProductId) FROM ZnodePublishCategoryProduct ZPP WHERE ZPP.PublishCatalogId = ZnodePublishCatalogLog.PublishCatalogId AND ZPP.PublishCategoryId IS NOT NULL) 
			--WHERE EXISTS (SELECT TOP 1 1 FROM #Tbl_VersionEntity TY  WHERE  TY.VersionId =ZnodePublishCatalogLog.PublishCatalogLogId )  

		End
		Else If @IsRevertPublish = 1 AND @PublishCatalogId > 0 
		Begin 
			
			Delete  From ZnodePublishCatalogEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
			SET @Batch= 1;
			WHILE @Batch > 0
			BEGIN 
				Delete  TOP (10000) From ZnodePublishProductEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
				SET @Batch= @@ROWCOUNT;
				-- CHECKPOINT;    -- if simple
				-- BACKUP LOG ... -- if full
			END
			Delete  From ZnodePublishAddOnEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
			Delete  From ZnodePublishCategoryEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
			Delete  From ZnodePublishBundleProductEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
			Delete  From ZnodePublishGroupProductEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
			Delete  From ZnodePublishConfigurableProductEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
			Delete  From ZnodePublishSEOEntity Where CMSSEOTypeId in (1,2,4) and  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) 
			--AND PortalId in 
			--	(Select ZPC.PortalId  from ZnodePublishVersionEntity  ZPVE inner join ZnodePortalCatalog  
			--		ZPC ON ZPVE.ZnodeCatalogId = ZPC.PublishCatalogId where  (ZPC.PublishCatalogId = @PublishCatalogId ))

			Delete  From ZnodePublishVersionEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 

			INSERT INTO ZnodePublishCatalogErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'Elastic-index genration get failed : ', '' , 'Fail' , Getdate(), 
			@UserId , '' 
			
			Update ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed() ,
			IsCatalogPublished = 0  , ModifiedDate = Getdate()
			where PublishCatalogLogId in  (Select VersionId from #Tbl_VersionEntityforCatalog)
			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =100, 
			IsCompleted  = 1,
			IsFailed =1
			where  JobId = @NewGUID

		END 
		Else If @IsRevertPublish = 1 AND Isnull(@PublishCatalogId,0) = 0 
		Begin 
			INSERT INTO ZnodePublishCatalogErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'Publish failed, Check connection failure ', '' , 'Fail' , Getdate(), @UserId , '' 
			
			Update ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed() ,
			IsCatalogPublished =0, IsCategoryPublished = 0 ,IsProductPublished = 0 , ModifiedDate = Getdate()
			 where 
			PublishStateId  = 6 
						
			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =80, 
			IsCompleted  = 0,
			IsFailed =1
			where  JobId = @NewGUID

		end

		SET @Status = 1
		Commit Transaction 
		SELECT @PublishCatalogId AS id,@Status AS Status;   
END TRY 
BEGIN CATCH 
	SET @Status =0  
	 SELECT 1 AS ID,@Status AS Status;   
	 Rollback transaction
	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity 
		@PublishCatalogId = '+CAST(@PublishCatalogId  AS VARCHAR	(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@IsRevertPublish='+CAST(@IsRevertPublish AS VARCHAR(10))
		+',@UserId = ' + CAST(@UserId AS varchar(20));	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
	
	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_PublishCatalogEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ManageProductList_XML')
	DROP PROC Znode_ManageProductList_XML

GO

CREATE PROCEDURE [dbo].[Znode_ManageProductList_XML]
(   @WhereClause						 XML,
    @Rows								 INT           = 100,
    @PageNo								 INT           = 1,
    @Order_BY			 VARCHAR(1000) = '',
    @LocaleId			 INT           = 1,
    @PimProductId		 VARCHAR(2000) = 0,
    @IsProductNotIn	 BIT           = 0,
	@IsCallForAttribute BIT		   = 0,
	@AttributeCode      VARCHAR(max ) = '' ,
	@PimCatalogId   INT = 0,
	@IsCatalogFilter   BIT            = 0,
	@IsDebug            Bit		   = 0,
	@publishstatus   NVARCHAR(200) = '' 
	)
AS
    
/*
		  Summary:-   This Procedure is used for get product List  
				    Procedure will pivot verticle table(ZnodePimattributeValues) into horizontal table with columns 
				    ProductId,ProductName,ProductType,AttributeFamily,SKU,Price,Quantity,IsActive,ImagePath,Assortment,LocaleId,DisplayOrder
        
		  Unit Testing
		  
exec Znode_ManageProductList_XML @WhereClause=N'',@Rows=50,@PageNo=1,@Order_By=N'',@LocaleId=1,@PimProductId=N'',@IsProductNotIn=1,@IsCallForAttribute=0,@AttributeCode=''
          select * from ZnodeAttributeType  WHERE AttributeValue LIKE '%&%'
		  UPDATE VieW_lOADMANAGEpRODUCT SET  AttributeValue = 'A & B'  WHERE AttributeValue LIKE '% and %' AND PimProductId = 158
    */

     BEGIN
         SET NOCOUNT ON;
         BEGIN TRY
		 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
             DECLARE @PimProductIds TransferId, --VARCHAR(MAX), 
					 @FirstWhereClause NVARCHAR(MAX)= '', 
					 @SQL NVARCHAR(MAX)= '' ,
					 @OutPimProductIds VARCHAR(max),
					 @ProductXML NVARCHAR(max) ;
			Declare @publishstatusid table (id int);

			if isnull(@publishstatus,'') <>''
				begin
				declare @sql1 nvarchar(2000)='';
				DECLARE @ParmDefinition NVARCHAR(500); 
				set @sql1 = N'select  PublishStateId from ZnodePublishState where DisplayName ' +  @publishstatus +'';
				
				 ----EXEC (@sql1);
				 insert into @publishstatusid
				 EXEC (@sql1)
				  
				 --set @publishstatusid = @p

				 ----set @sql1 = N' SET @publishstatusid1 =( select top 1  PublishStateId from ZnodePublishState where DisplayName like ''%' + @publishstatus +'%'')';
				
				 --------EXEC (@sql1);
				 ----set @ParmDefinition ='@publishstatusid1 int output';
				 ---- EXECUTE sp_executesql @sql1, @ParmDefinition, @publishstatusid1 = @publishstatusid output

				End

             DECLARE @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId()
					 ,@RowsCount INT =0 ;
             DECLARE @TransferPimProductId TransferId 
			 DECLARE @TBL_AttributeDefaultValue TABLE
             (PimAttributeId            INT,
              AttributeDefaultValueCode VARCHAR(100),
              IsEditable                BIT,
              AttributeDefaultValue     NVARCHAR(MAX)
			  ,DisplayOrder INT 
			  ,PimAttributedefaultValueId INT 
             );
             DECLARE @TBL_AttributeDetails AS TABLE
             (PimProductId   INT,
              AttributeValue NVARCHAR(MAX),
              AttributeCode  VARCHAR(600),
              PimAttributeId INT,
			  AttributeDefaultValue NVARCHAR(MAX)
             );
			 Create table #TBL_AttributeDetailsLocale
             (PimProductId   INT,
              AttributeValue NVARCHAR(MAX),
              AttributeCode  VARCHAR(600),
              PimAttributeId INT
             );
			 DECLARE @TBL_MultiSelectAttribute TABLE (PimAttributeId INT , AttributeCode VARCHAR(600))
			
			 DECLARE @TBL_MediaAttribute TABLE (Id INT ,PimAttributeId INT ,AttributeCode VARCHAR(600) )
			 
			 DECLARE @TBL_ProductIds TABLE 
			 (
			  PimProductId INT,
			  ModifiedDate DATETIME  
			 )

			 DECLARE @FamilyDetails TABLE
             (
			  PimProductId         INT,
              PimAttributeFamilyId INT,
              FamilyName           NVARCHAR(Max)
             );
             DECLARE @DefaultAttributeFamily INT= dbo.Fn_GetDefaultPimProductFamilyId();
             DECLARE @ProductIdTable TABLE
             (PimProductId INT,
              CountId      INT,
              RowId        INT IDENTITY(1,1)
             );
          		
             IF EXISTS ( SELECT TOP 1 1 FROM @WhereClause.nodes ( '//ArrayOfWhereClauseModel/WhereClauseModel'  ) AS Tbl(Col)
			 WHERE LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''',''))))  =  'Brand'
                OR LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''','')))) = 'Vendor'
                OR LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''',''))))  =  'ShippingCostRules'
                OR LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''','')))) =  'Highlights') and @IsCallForAttribute=1
                 BEGIN
                DECLARE @AttributeCodeValue TABLE (AttributeValue NVARCHAr(max),AttributeCode NVARCHAR(max))

				INSERT INTO @AttributeCodeValue(AttributeValue,AttributeCode)
				SELECT  Tbl.Col.value ( 'attributevalue[1]' , 'NVARCHAR(max)') AS AttributeValue
						 ,Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)') AS AttributeCode
				FROM @WhereClause.nodes ( '//ArrayOfWhereClauseModel/WhereClauseModel'  ) AS Tbl(Col)
				WHERE LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''',''))))  =  'Brand'
                OR LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''',''))))  = 'Vendor'
                OR LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''',''))))  =  'ShippingCostRules'
                OR LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''',''))))  =  'Highlights'
		
				SET @SQL =   
				           ';WIth Cte_DefaultValue AS (
										  SELECT AttributeDefaultValueCode , ZPDF.PimAttributeId ,FNPA.AttributeCode
										  FROM ZnodePImAttributeDefaultValue ZPDF
										  INNER JOIN [dbo].[Fn_GetProductDefaultFilterAttributes] () FNPA ON ( FNPA.PimAttributeId = ZPDF.PimAttributeId) 
										)
										, Cte_productIds AS 
										(
										  SELECT a.PimProductId, c.AttributeCode , CTDV.AttributeDefaultValueCode AttributeValue,b.ModifiedDate 
										  FROM  ZnodePimAttributeValue a
										  LEFT JOIN ZnodePimAttribute c ON(c.PimAttributeId = a.PimAttributeId)
										  LEFT JOIN ZnodePimAttributeValueLocale b ON(b.PimAttributeValueId = a.PimAttributeValueId)  
										  INNER JOIN Cte_DefaultValue CTDV ON (CTDV.AttributeCode = c.AttributeCode 
										  AND EXISTS (SELECT TOP 1 1 FROM dbo.split(b.AttributeValue,'','') SP WHERE SP.Item = CTDV.AttributeDefaultValueCode) )
										  Union all 
										  
											SELECT a.PimProductId,c.AttributeCode,ZPADV.AttributeDefaultValueCode AttributeValue ,a.ModifiedDate 
											FROM ZnodePimProductAttributeDefaultValue ZPPADV
											INNER JOIN ZnodePimAttributeDefaultValue ZPADV ON (ZPPADV.PimAttributeDefaultValueId = ZPADV.PimAttributeDefaultValueId)
											LEFT JOIN ZnodePimAttributeValue a ON (a.PimAttributeValueId = ZPPADV.PimAttributeValueId )
											LEFT JOIN ZnodePimAttribute c ON ( c.PimAttributeId=a.PimAttributeId )
											INNER JOIN Cte_DefaultValue CTDV ON (CTDV.AttributeCode = c.AttributeCode )
										)										
										SELECT PimProductId ,ModifiedDate
										FROM Cte_productIds WHERE  AttributeCode '+(SELECT TOP 1 AttributeCode  FROM @AttributeCodeValue )+' AND 
										AttributeValue '+(SELECT TOP 1 AttributeValue  FROM @AttributeCodeValue )+' 
										GROUP BY PimProductId,ModifiedDate Order By ModifiedDate DESC ';


					 SET @Order_BY = CASE WHEN @Order_BY = '' THEN 'ModifiedDate DESC' ELSE @Order_BY END 
					 	
					 SET @WhereClause = CAST(REPLACE(CAST(@WhereClause AS NVARCHAR(max)),'<WhereClauseModel><attributecode>'+(SELECT TOP 1 AttributeCode  FROM @AttributeCodeValue )+'</attributecode><attributevalue>'+(SELECT TOP 1 AttributeValue   FROM @AttributeCodeValue )+'</attributevalue></WhereClauseModel>','') AS XML )
					
				     INSERT INTO @TBL_ProductIds ( PimProductId, ModifiedDate )
					 EXEC (@SQL);
			  					 
					
						 INSERT INTO @ProductIdTable( PimProductId )
						 SELECT PimProductId 
						 FROM @TBL_ProductIds
					

                     INSERT INTO @TransferPimProductId
					 SELECT PimProductId
                     FROM @ProductIdTable
                   
				   			  
     DELETE FROM @ProductIdTable;
   --  SET @WhereClause = CAST(REPLACE(CAST(@WhereClause AS NVARCHAR(MAX)), @FirstWhereClause, ' 1 = 1') AS XML);
                 END
	            ELSE IF @PimProductId <> ''
			    BEGIN 
		
				 INSERT INTO @TransferPimProductId(id)
				 SELECT Item 
				 FROM dbo.split(@PimProductId,',')
			    END 
		
			
	 DECLARE  @ProductListIdRTR TransferId
	 DECLARE @TAb Transferid 
	 --DECLARE @tBL_mainList TABLE (Id INT,RowId INT)
	 Create table #TBL_ProductMainList (Id INT,RowId INT)

	 	IF @PimProductId <> ''  OR   @IsCallForAttribute=1 --OR (CAST(@WhereClause AS NVARCHAR(max))= N'' AND @Order_by <> N'' AND @AttributeCode = N'')
		BEGIN 
	 SET @IsProductNotIn = CASE WHEN @IsProductNotIn = 0 THEN 1  
					 WHEN @IsProductNotIn = 1 THEN 0 END 
		END 
	
	 INSERT INTO @ProductListIdRTR
	 EXEC Znode_GetProductList  @IsProductNotIn,@TransferPimProductId, @PimCatalogId,@IsCatalogFilter
 
	 IF CAST(@WhereClause AS NVARCHAR(max))<> N''
	 BEGIN 
	 
	  SET @SQL = 'SELECT Distinct PimProductId FROM ##Temp_PimProductId'+CAST(@@SPID AS VARCHAR(500))

	  EXEC Znode_GetFilterPimProductId @WhereClause,@ProductListIdRTR,@localeId,@IsProductNotIn
	  
      INSERT INTO @TAB 
	  EXEC (@SQL)
	 
	 END 
	 
	

	 IF EXISTS (SELECT Top 1 1 FROM @TAb ) OR CAST(@WhereClause AS NVARCHAR(max)) <> N''
	 BEGIN 
	 
	 SET @AttributeCode = REPLACE(dbo.FN_TRIM(REPLACE(REPLACE(@order_by,' DESC',''),' ASC','')),'DisplayOrder','ProductName')
	 SET @order_by = REPLACE(@order_by,'DisplayOrder','ProductName')
	 INSERT INTO #TBL_ProductMainList(id,RowId)
	 EXEC Znode_GetOrderByPagingProduct @order_by,@rows,@PageNo, @TAb ,@AttributeCode,@localeId
	 
	 END 
	 ELSE 
	 BEGIN
	      
	 SET @AttributeCode = REPLACE(dbo.FN_TRIM(REPLACE(REPLACE(@order_by,' DESC',''),' ASC','')),'DisplayOrder','ProductName')
	 SET @order_by = REPLACE(@order_by,'DisplayOrder','ProductName')
	 INSERT INTO #TBL_ProductMainList(id,RowId)
	 EXEC Znode_GetOrderByPagingProduct @order_by,@rows,@PageNo, @ProductListIdRTR ,@AttributeCode,@localeId 
	 END 
          

  			 INSERT INTO @PimProductIds ( Id  )
			 SELECT DISTINCT id FROM #TBL_ProductMainList

			 DECLARE @TBL_PimProductIds transferId 
			 INSERT INTO @TBL_PimProductIds
			 SELECT id 
             FROM @PimProductIds
			 			 	
			 DECLARE @PimAttributeIds TransferId  
			 INSERT INTO @PimAttributeIds
			 SELECT PimAttributeId  
			 FROM [dbo].[Fn_GetProductGridAttributes]()
			 
			

			 INSERT INTO @TBL_AttributeDetails
             (PimProductId,
              AttributeValue,
              AttributeCode,
              PimAttributeId,
			  AttributeDefaultValue
             )
             EXEC Znode_GetProductsAttributeValue_newTesting
                  @TBL_PimProductIds,
                  @PimAttributeIds,
                  @localeId;
			
			
			UPDATE @TBL_AttributeDetails
			SET AttributeValue = ISNULL(AttributeValue,'')
			WHERE AttributeValue IS NULL 

----------------------------------------------------------------------------------------------------

			

		    declare @SKU SelectColumnList
			declare @TBL_Inventorydetails table (Quantity NVARCHAR(MAx),PimProductId INT)

			INSERT INTO @SKU
			SELECT AttributeValue 
			FROM @TBL_AttributeDetails
			WHERE AttributeCode = 'SKU'
 
 			INSERT INTO @TBL_Inventorydetails(Quantity,PimProductId)
			EXEC Znode_GetPimProductAttributeInventory @SKU--vishal

			 INSERT INTO @FamilyDetails
             (PimAttributeFamilyId,
              PimProductId
             )
             EXEC [dbo].[Znode_GetPimProductAttributeFamilyId]
                  @PimProductIds,
                  1;
             
		 UPDATE a
               SET
                   FamilyName = b.AttributeFamilyName
             FROM @FamilyDetails a
                  INNER JOIN ZnodePimFamilyLocale b ON(a.PimAttributeFamilyId = b.PimAttributeFamilyId
                                                       AND LocaleId = @LocaleId);
             UPDATE a
               SET
                   FamilyName = b.AttributeFamilyName
             FROM @FamilyDetails a
                  INNER JOIN ZnodePimFamilyLocale b ON(a.PimAttributeFamilyId = b.PimAttributeFamilyId
                                                       AND LocaleId = @DefaultLocaleId)
             WHERE a.FamilyName IS NULL
                   OR a.FamilyName = '';
           	
			INSERT INTO @TBL_AttributeDetails             (PimProductId,              AttributeValue,              AttributeCode,              PimAttributeId             )
			SELECT PimProductId ,FamilyName, 'AttributeFamily',NULL
			FROM @FamilyDetails 
			

			  
					INSERT INTO @TBL_AttributeDetails             (PimProductId,              AttributeValue,              AttributeCode,              PimAttributeId             )
					SELECT a.ID PimProductId ,th.DisplayName, 'PublishStatus',NULL
					FROM @PimProductIds a 
					INNER JOIN ZnodePimProduct b ON (b.PimProductId = a.ID)
					LEFT JOIN ZnodePublishState th ON (th.PublishStateId = b.PublishStateId)
				 
			
		 IF isnull(@publishstatus,'') = ''

                 BEGIN
					INSERT INTO #TBL_AttributeDetailsLocale (PimProductId ,PimAttributeId,AttributeCode )
						SELECT  TBLAD.PimProductId ,TBLAD.PimAttributeId,TBLAD.AttributeCode 
						FROM @TBL_AttributeDetails TBLAD 
						GROUP BY  TBLAD.PimProductId ,TBLAD.PimAttributeId,TBLAD.AttributeCode 
				 end 
				 else
				 begin
						INSERT INTO #TBL_AttributeDetailsLocale (PimProductId ,PimAttributeId,AttributeCode )
							SELECT  TBLAD.PimProductId ,TBLAD.PimAttributeId,TBLAD.AttributeCode 
							FROM @TBL_AttributeDetails TBLAD where TBLAD.PimProductId  
									in (select PimProductId from @TBL_AttributeDetails  t where t.AttributeCode = 'PublishStatus'
										and AttributeValue in (select DisplayName from ZnodePublishState where PublishStateId in (select id from @publishstatusid)))
								
							GROUP BY  TBLAD.PimProductId ,TBLAD.PimAttributeId,TBLAD.AttributeCode 
				 End
		
	    UPDATE TBLPP 
		SET AttributeValue = CTDD.AttributeValue 
		FROM  @TBL_AttributeDetails CTDD 
		INNER JOIN #TBL_AttributeDetailsLocale TBLPP ON (TBLPP.PimProductId = CTDD.PimProductId AND TBLPP.AttributeCode  = CTDD.AttributeCode)
		WHERE TBLPP.AttributeValue IS NULL 

    	SET @ProductXML =  '<MainProduct>'+ STUFF( (  SELECT '<Product>'+'<PimProductId>'+CAST(TBAD.PimProductId AS VARCHAR(50))+'</PimProductId>'
																		+'<AvailableInventory>'+CAST(ISNULL(IDD.[Quantity],'') AS VARCHAR(50))+'</AvailableInventory>'
		+ STUFF(    (  SELECT '<'+TBADI.AttributeCode+'>'+CAST( (SELECT  ''+TBADI.AttributeValue FOR XML PATH('')) AS NVARCHAR(max))+'</'+TBADI.AttributeCode+'>'   
															FROM #TBL_AttributeDetailsLocale TBADI      
															 WHERE TBADI.PimProductId = TBAD.PimProductId 
															 ORDER BY TBADI.PimProductId DESC
															 FOR XML PATH (''), TYPE
																).value('.', ' Nvarchar(max)'), 1, 0, '')+'</Product>'	   

		FROM #TBL_AttributeDetailsLocale TBAD
		INNER JOIN #TBL_ProductMainList TBPI ON (TBAD.PimProductid = TBPI.id )
		LEFT JOIN @TBL_ProductIds TPT ON TBAD.PimProductId = TPT.PimProductId
		LEFT JOIN @TBL_InventoryDetails IDD ON (TBPI.id = IDD.PimProductId)
		GROUP BY TBAD.pimProductid, TPT.ModifiedDate,TBPI.RowId,IDD.Quantity
		ORDER BY TBPI.RowId 
		FOR XML PATH (''),TYPE).value('.', ' Nvarchar(max)'), 1, 0, '')+'</MainProduct>'
			--FOR XML PATH ('MainProduct'))
 

			SELECT  CAST(@ProductXML AS XML ) ProductXMl
		   
		     SELECT AttributeCode ,  ZPAL.AttributeName
			 FROM ZnodePimAttribute ZPA 
			 LEFT JOIN ZnodePiMAttributeLOcale ZPAL ON (ZPAL.PimAttributeId = ZPA.PimAttributeId )
             WHERE LocaleId = 1  
			 AND  IsCategory = 0 
			 AND ZPA.IsShowOnGrid = 1  
			 UNION ALL 
			 SELECT 'PublishStatus','Publish Status'

     IF EXISTS (SELECT Top 1 1 FROM @TAb )
	 BEGIN 

		  SELECT (SELECT COUNT(1) FROM @TAb) AS RowsCount   
	 END 
	 ELSE 
	 BEGIN
	 		  SELECT (SELECT COUNT(1) FROM @ProductListIdRTR) AS RowsCount   
	 END 
		;

             -- find the all locale values 
         END TRY
         BEGIN CATCH
		    SELECT ERROR_MESSAGE()
                DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ManageProductList_XML @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@LocaleId = '+CAST(@LocaleId AS VARCHAR(50))+',@PimProductId='+@PimProductId+',@IsProductNotIn='+CAST(@IsProductNotIn AS VARCHAR(50))+',@IsCallForAttribute='+CAST(@IsCallForAttribute AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_ManageProductList_XML',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;

         END CATCH;

     END;

GO

update ZnodeApplicationSetting
set Setting ='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>PimProductId</name><headertext>Checkbox</headertext><width>20</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield>PimProductId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>Image</name><headertext>Image</headertext><width>20</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield>ProductImage,ProductName</imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class>imageicon</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>SKU</name><headertext>SKU</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>ProductName</name><headertext>Product Name</headertext><width>60</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl>/PIM/Products/Edit</islinkactionurl><islinkparamfield>PimProductId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>ProductType</name><headertext>Product Type</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>AttributeFamily</name><headertext>Attribute Family</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>PublishStatus</name><headertext>Publish Status</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>IsActive</name><headertext>Status</headertext><width>0</width><datatype>Boolean</datatype><columntype>Boolean</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>9</id><name>Manage</name><headertext>Action</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>Edit|Copy|Delete|Publish</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Copy|Delete|Publish</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/PIM/Products/Edit|/PIM/Products/Copy|/PIM/Products/Delete|/PIM/Products/PublishProduct</manageactionurl><manageparamfield>PimProductId|PimProductId|PimProductId|PimProductId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName= 'View_ManageProductList'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_UpdateUserProfileBasedOnAccountProfile')
	DROP PROC Znode_UpdateUserProfileBasedOnAccountProfile

GO

CREATE PROCEDURE [dbo].[Znode_UpdateUserProfileBasedOnAccountProfile]
(
	@AccountId Int,
	@UserIds Varchar(2000),
	@Status bit = 0 out 
)
as
BEGIN
	SET NOCOUNT ON
	DECLARE @UserIds_Tbl TABLE(UserId int)
	DECLARE @GetDate DATETIME =dbo.Fn_GetDate()
	DECLARE @ProfileIdByAccountId INT;

	BEGIN TRY
	BEGIN TRAN
		INSERT INTO @UserIds_Tbl(UserId)
		SELECT Item FROM dbo.Split(@UserIds,',')

		--Getting Default Profile Id Based on Account Id
		SELECT @ProfileIdByAccountId = ProfileId FROM ZnodeAccountProfile WHERE AccountId = @AccountId and IsDefault = 1;

		 IF isnull(@UserIds,'0') <> '0' or  ISNULL(@UserIds,'') <> ''
		BEGIN
			
			DELETE FROM ZnodeUserProfile  WHERE EXISTS (SELECT TOP 1 1 FROM @UserIds_Tbl UIT
			WHERE UIT.UserId = ZnodeUserProfile.UserId);

			INSERT INTO ZnodeUserProfile(ProfileId,UserId,IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT @ProfileIdByAccountId,UserId,1,@AccountId,@GetDate,@AccountId,@GetDate
			FROM @UserIds_Tbl;
		
		END

		SET @Status = 1;
		SELECT 1 AS ID,@Status AS STATUS;    
	COMMIT TRAN
	END TRY
	BEGIN CATCH
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_UpdateUserProfileBasedOnAccountProfile @AccountId='+CAST(@AccountId AS VARCHAR(50))+',@UserIds='+CAST(@UserIds AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,@Status AS STATUS;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName    = 'Znode_UpdateUserProfileBasedOnAccountProfile',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage     = @ErrorMessage,
				@ErrorLine        = @ErrorLine,
				@ErrorCall        = @ErrorCall;
			ROLLBACK TRAN
	END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdatePimCatalogProductDetailJson')
	DROP PROC Znode_InsertUpdatePimCatalogProductDetailJson

GO


CREATE PROCEDURE [dbo].[Znode_InsertUpdatePimCatalogProductDetailJson] 
(
	@PublishCatalogId INT = 0, 
	@LocaleId TransferId READONLY, 
	@UserId INT = 0   
)
AS 

--declare @LocaleId TransferId
--INSERT INTO @LocaleId
--SELECT 1
--exec [Znode_InsertUpdatePimCatalogProductDetailJson] @PublishCatalogId=3,@LocaleId=@LocaleId,@UserId=2

--declare @LocaleId TransferId
--INSERT INTO @LocaleId
--SELECT 1
----union 
----SELECT 4
----union 
----SELECT 2
--exec [Znode_POC_InsertUpdatePimCatalogProductDetail] @PublishCatalogId=3,@LocaleId=@LocaleId,@UserId=2
BEGIN 
BEGIN TRY 

  SET NOCOUNT ON 
       DECLARE @LocaleId_In INT = 0 , @DefaultLocaleId INT = dbo.FN_GETDefaultLocaleId()
			   ,@Date DATETIME = dbo.fn_GetDate()
	   DECLARE @PimMediaAttributeId INT = dbo.Fn_GetProductImageAttributeId()		   

	   CREATE TABLE #PimDefaultValueLocale  (PimAttributeDefaultJsonId INT  PRIMARY KEY ,PimAttributeDefaultValueId INT ,LocaleId INT, DefaultValueJson	nvarchar(max) )

	   CREATE TABLE #AttributeValueLocale  (Id int Identity,  PimProductId INT, AttributeCode Varchar(300), AttributeValue varchar(max), AttributeEntity varchar(max), LocaleId int )

	    ----To get the localwise product data
		SELECT DISTINCT ZPAV.PimProductId, ZPP.PublishProductId, ZPAVL.LocaleId
		INTO #ProductLocaleWise
		FROM ZnodePimAttributeValue ZPAV
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		INNER JOIN ZnodePublishProduct ZPP ON ZPAV.PimProductId = ZPP.PimProductId
		WHERE ZPAV.PimAttributeId = (SELECT PimAttributeId FROM ZnodePimAttribute WHERE AttributeCode = 'SKU')
			
		INSERT INTO #ProductLocaleWise
		SELECT DISTINCT ZPAV.PimProductId, ZPP.PublishProductId, ZPAVL.LocaleId
		FROM ZnodePimAttributeValue ZPAV
		INNER JOIN ZnodePimProductAttributeDefaultValue ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		INNER JOIN ZnodePublishProduct ZPP ON ZPAV.PimProductId = ZPP.PimProductId
		WHERE NOT EXISTS(SELECT * FROM #ProductLocaleWise X WHERE ZPAV.PimProductId = X.PimProductId AND ZPAVL.LocaleId = X.LocaleId)
		
		INSERT INTO #ProductLocaleWise
		SELECT DISTINCT ZPAV.PimProductId, ZPP.PublishProductId, ZPAVL.LocaleId
		FROM ZnodePimAttributeValue ZPAV
		INNER JOIN ZnodePimProductAttributeTextAreaValue ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		INNER JOIN ZnodePublishProduct ZPP ON ZPAV.PimProductId = ZPP.PimProductId
		WHERE NOT EXISTS(SELECT * FROM #ProductLocaleWise X WHERE ZPAV.PimProductId = X.PimProductId AND ZPAVL.LocaleId = X.LocaleId)
		
		INSERT INTO #ProductLocaleWise
		SELECT DISTINCT ZPAV.PimProductId, ZPP.PublishProductId, ZPAVL.LocaleId
		FROM ZnodePimAttributeValue ZPAV
		INNER JOIN ZnodePimProductAttributeMedia ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		INNER JOIN ZnodePublishProduct ZPP ON ZPAV.PimProductId = ZPP.PimProductId
		WHERE NOT EXISTS(SELECT * FROM #ProductLocaleWise X WHERE ZPAV.PimProductId = X.PimProductId AND ZPAVL.LocaleId = X.LocaleId)
		------------

		SELECT BTM.PimProductId , ZPCPD.PublishProductId, ZPCPD.PublishCatalogId,BTM.ModifiedDate
		INTO #ProductAttributeXML
		FROM ZnodePublishProductAttributeJson BTM 
		INNER JOIN ZnodePublishProduct ZPP1 ON BTM.PimProductId = ZPP1.PimProductId
		INNER JOIN ZnodePublishCatalogProductDetail ZPCPD ON ZPP1.PublishProductId = ZPCPD.PublishProductId AND ZPCPD.PublishCatalogId = ZPP1.PublishCatalogId 
		WHERE ZPCPD.PublishCatalogId =  @PublishCatalogId 

	    -------- Products Attribute modified 
		SELECT DISTINCT ZPP.PublishProductId,  ZPCC.PimCategoryHierarchyId 
		INTO #ModifiedProducts
		FROM ZnodePublishProduct  ZPP
		INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
		INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimProductId = ZPP.PimProductId )
		INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = ZPAV.PimAttributeId)
		INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategoryProduct ZPCC  ON (ZPP.PublishProductId = ZPCC.PublishProductId AND ZPCC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategory ZPPC ON (ISNULL(ZPPC.PimCategoryHierarchyId,0) = ISNULL(ZPCC.PimCategoryHierarchyId,0) AND ZPPC.PublishCategoryId = ZPCC.PublishCategoryId)
		WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
		AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId AND ZPFGM.PimAttributeId = ZPAV.PimAttributeId))
		AND EXISTS (SELECT TOP 1 1 FROM #ProductAttributeXML BTM WHERE BTM.PimProductId = ZPP.PimProductId AND BTM.PublishCatalogId = ZPP.PublishCatalogId
						AND (BTM.ModifiedDate < ZPAV.ModifiedDate OR BTM.ModifiedDate < ZPA.ModifiedDate)   ) 
		
		-------- Products not published  
		INSERT INTO #ModifiedProducts
		SELECT ZPP.PublishProductId,  ZPCC.PimCategoryHierarchyId 
		FROM ZnodePublishProduct  ZPP
		INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
		INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategoryProduct ZPCC  ON (ZPP.PublishProductId = ZPCC.PublishProductId AND ZPCC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategory ZPPC ON (ISNULL(ZPPC.PimCategoryHierarchyId,0) = ISNULL(ZPCC.PimCategoryHierarchyId,0) AND ZPPC.PublishCategoryId = ZPCC.PublishCategoryId)
		WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
		AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId ))--AND ZPFGM.PimAttributeId = ZPAV.PimAttributeId))
		AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 INNER JOIN ZnodePublishState ZPS ON ZPP1.PublishStateId = ZPS.PublishStateId
					WHERE StateName <> 'Publish' AND ZPP.PimProductId = ZPP1.PimProductId )	
			
		-------- Products associated to catalog or category or modified catalog category products
		INSERT INTO #ModifiedProducts		
		SELECT ZPP.PublishProductId,  ZPCC.PimCategoryHierarchyId 
		FROM ZnodePublishProduct  ZPP
		INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
		INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZPP.PublishCatalogId)
		INNER JOIN ZnodePimCategoryProduct ZPCC1 ON  ZPP.PimProductId = ZPCC1.PimProductId 
		INNER JOIN ZnodePimCategoryHierarchy ZPCH ON ZPCC1.PimCategoryId = ZPCH.PimCategoryId AND ZPC.PimCatalogId = ZPCH.PimCatalogId 
		LEFT JOIN ZnodePublishCategoryProduct ZPCC  ON (ZPP.PublishProductId = ZPCC.PublishProductId AND ZPCC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategory ZPPC ON (ISNULL(ZPPC.PimCategoryHierarchyId,0) = ISNULL(ZPCC.PimCategoryHierarchyId,0) AND ZPPC.PublishCategoryId = ZPCC.PublishCategoryId)
		WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
		AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId ))--AND ZPFGM.PimAttributeId = ZPAV.PimAttributeId))
		AND EXISTS (SELECT TOP 1 1 FROM #ProductAttributeXML BTM WHERE BTM.PimProductId = ZPCC1.PimProductId AND BTM.PublishCatalogId = ZPP.PublishCatalogId
						AND (BTM.ModifiedDate < ZPCC1.ModifiedDate )   ) 

		-------- Link Product modified 
		INSERT INTO #ModifiedProducts	
		SELECT ZPP.PublishProductId,  ZPCC.PimCategoryHierarchyId 
		FROM ZnodePublishProduct  ZPP
		INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
		INNER JOIN ZnodePimLinkProductDetail ZPAV ON (ZPAV.PimParentProductId = ZPP.PimProductId )
		INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategoryProduct ZPCC  ON (ZPP.PublishProductId = ZPCC.PublishProductId AND ZPCC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategory ZPPC ON (ISNULL(ZPPC.PimCategoryHierarchyId,0) = ISNULL(ZPCC.PimCategoryHierarchyId,0) AND ZPPC.PublishCategoryId = ZPCC.PublishCategoryId)
		WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
		--AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId AND ZPFGM.PimAttributeId = ZPAV.PimAttributeId))
		AND EXISTS (SELECT TOP 1 1 FROM #ProductAttributeXML BTM WHERE BTM.PimProductId = ZPP.PimProductId AND BTM.PublishCatalogId = ZPP.PublishCatalogId
						AND (BTM.ModifiedDate < ZPAV.ModifiedDate)   ) 

		--------Associated child Products (varients, Group) not published	
		INSERT INTO #ModifiedProducts	
		SELECT ZPP.PublishProductId,  ZPCC.PimCategoryHierarchyId 
		FROM ZnodePublishProduct  ZPP
		INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
		INNER JOIN ZnodePimProductTypeAssociation ZPAV ON (ZPAV.PimProductId = ZPP.PimProductId )
		INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategoryProduct ZPCC  ON (ZPP.PublishProductId = ZPCC.PublishProductId AND ZPCC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategory ZPPC ON (ISNULL(ZPPC.PimCategoryHierarchyId,0) = ISNULL(ZPCC.PimCategoryHierarchyId,0) AND ZPPC.PublishCategoryId = ZPCC.PublishCategoryId)
		WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
		AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 INNER JOIN ZnodePublishState ZPS ON ZPP1.PublishStateId = ZPS.PublishStateId
					WHERE StateName <> 'Publish' AND ZPAV.PimProductId = ZPP1.PimProductId )


		--------Link child Products (Bundle) not published 	
		INSERT INTO #ModifiedProducts
		SELECT ZPP.PublishProductId,  ZPCC.PimCategoryHierarchyId 
		FROM ZnodePublishProduct  ZPP
		INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
		INNER JOIN ZnodePimLinkProductDetail ZPAV ON (ZPAV.PimProductId = ZPP.PimProductId )
		INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategoryProduct ZPCC  ON (ZPP.PublishProductId = ZPCC.PublishProductId AND ZPCC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategory ZPPC ON (ISNULL(ZPPC.PimCategoryHierarchyId,0) = ISNULL(ZPCC.PimCategoryHierarchyId,0) AND ZPPC.PublishCategoryId = ZPCC.PublishCategoryId)
		WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
		AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 INNER JOIN ZnodePublishState ZPS ON ZPP1.PublishStateId = ZPS.PublishStateId
					WHERE StateName <> 'Publish' AND ZPAV.PimProductId = ZPP1.PimProductId )

		----Getting products of newly added category hierarchy 
		INSERT INTO #ModifiedProducts		
		SELECT ZPP.PublishProductId,  ZPCC.PimCategoryHierarchyId
		FROM ZnodePublishProduct  ZPP
		INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
		INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZPP.PublishCatalogId)
		INNER JOIN ZnodePimCategoryProduct ZPCC1 ON  ZPP.PimProductId = ZPCC1.PimProductId 
		INNER JOIN ZnodePimCategoryHierarchy ZPCH ON ZPCC1.PimCategoryId = ZPCH.PimCategoryId AND ZPC.PimCatalogId = ZPCH.PimCatalogId 
		LEFT JOIN ZnodePublishCategoryProduct ZPCC  ON (ZPP.PublishProductId = ZPCC.PublishProductId AND ZPCC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategory ZPPC ON (ISNULL(ZPPC.PimCategoryHierarchyId,0) = ISNULL(ZPCC.PimCategoryHierarchyId,0) AND ZPPC.PublishCategoryId = ZPCC.PublishCategoryId)
		WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
		AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId ))--AND ZPFGM.PimAttributeId = ZPAV.PimAttributeId))
		AND NOT EXISTS(SELECT * FROM ZnodePublishCatalogProductDetail ZPCPPD WHERE ZPCPPD.PimCategoryHierarchyId =  ZPCH.PimCategoryHierarchyId AND ZPCPPD.PublishCatalogId = ZPP.PublishCatalogId ) 

		---------------------Category associated to catalog or category or modified catalog
		SELECT ZPCH.PimCategoryId, ZPC1.PublishCategoryId, ZPCH.PimCategoryHierarchyId
		INTO #ModifiedCategory
		FROM ZnodePimCategoryHierarchy ZPCH 
		INNER JOIN ZnodePublishCategory ZPC1 ON ZPCH.PimCategoryId = ZPC1.PimCategoryId 
        WHERE ZPC1.PublishCatalogId =  @PublishCatalogId 
		AND EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogProductDetail BTM  
		WHERE BTM.PublishCatalogId = ZPC1.PublishCatalogId AND (BTM.ModifiedDate < ZPCH.ModifiedDate )   )
		AND NOT EXISTS(SELECT * FROM #ModifiedProducts MP WHERE  ISNULL(ZPCH.PimCategoryHierarchyId,0) = ISNULL(MP.PimCategoryHierarchyId,0))

		-------- Category associated to catalog or category or modified catalog
		INSERT INTO #ModifiedProducts		
		SELECT ZPP.PublishProductId,  ZPCC.PimCategoryHierarchyId 
		FROM ZnodePublishProduct  ZPP
		INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
		INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZPP.PublishCatalogId)
		INNER JOIN ZnodePimCategoryProduct ZPCC1 ON  ZPP.PimProductId = ZPCC1.PimProductId 
		INNER JOIN ZnodePimCategoryHierarchy ZPCH ON ZPCC1.PimCategoryId = ZPCH.PimCategoryId AND ZPC.PimCatalogId = ZPCH.PimCatalogId 
		LEFT JOIN ZnodePublishCategoryProduct ZPCC  ON (ZPP.PublishProductId = ZPCC.PublishProductId AND ZPCC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategory ZPPC ON (ISNULL(ZPPC.PimCategoryHierarchyId,0) = ISNULL(ZPCC.PimCategoryHierarchyId,0) AND ZPPC.PublishCategoryId = ZPCC.PublishCategoryId)
		WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
		AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId ))
		AND EXISTS (SELECT TOP 1 1 FROM #ModifiedCategory BTM WHERE BTM.PimCategoryHierarchyId = ZPCH.PimCategoryHierarchyId  ) 
		------------------

		--Getting all products of catalog for publish first time 
		SELECT ZPP.PublishProductId,  ZPAV.PimAttributeId, ZPP.PublishCatalogId , ZPCC.PimCategoryHierarchyId , ZPCC.PublishCategoryId,
		       ZPAV.PimAttributeValueId, ZPC.CatalogName ,ZPP.PimProductId ,ZPA.AttributeCode				
		INTO #ZnodePublishCategoryProduct
		FROM ZnodePublishProduct  ZPP
		INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
		INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimProductId = ZPP.PimProductId )
		INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = ZPAV.PimAttributeId)
		INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategoryProduct ZPCC  ON (ZPP.PublishProductId = ZPCC.PublishProductId AND ZPCC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategory ZPPC ON (ISNULL(ZPPC.PimCategoryHierarchyId,0) = ISNULL(ZPCC.PimCategoryHierarchyId,0) AND ZPPC.PublishCategoryId = ZPCC.PublishCategoryId)
		WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
		AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId AND ZPFGM.PimAttributeId = ZPAV.PimAttributeId))
		AND NOT EXISTS (SELECT TOP 1 1 FROM #ProductAttributeXML BTM WHERE BTM.PimProductId = ZPP.PimProductId AND BTM.PublishCatalogId = ZPP.PublishCatalogId)
		
		--Getting all products of catalog for publish which are modified after last publish
		INSERT INTO #ZnodePublishCategoryProduct 
		SELECT ZPP.PublishProductId,  ZPAV.PimAttributeId, ZPP.PublishCatalogId , ZPCC.PimCategoryHierarchyId , ZPCC.PublishCategoryId
			   ,ZPAV.PimAttributeValueId, ZPC.CatalogName--,CASE WHEN ZPCC.PublishProductId IS NULL THEN 1 ELSE  dense_rank()Over(ORDER BY ZPCC.PimCategoryHierarchyId,ZPCC.PublishProductId) END  ProductIndex 	
			   ,ZPP.PimProductId ,ZPA.AttributeCode				
		FROM ZnodePublishProduct  ZPP
		INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
		INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimProductId = ZPP.PimProductId )
		INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = ZPAV.PimAttributeId)
		INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategoryProduct ZPCC  ON (ZPP.PublishProductId = ZPCC.PublishProductId AND ZPCC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategory ZPPC ON (ZPPC.PimCategoryHierarchyId = ZPCC.PimCategoryHierarchyId AND ZPPC.PublishCategoryId = ZPCC.PublishCategoryId)
		WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
		AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId AND ZPFGM.PimAttributeId = ZPAV.PimAttributeId))
		AND EXISTS (SELECT * FROM #ModifiedProducts MP WHERE ZPP.PublishProductId = MP.PublishProductId 
			AND ISNULL(ZPCC.PimCategoryHierarchyId,0) = ISNULL(MP.PimCategoryHierarchyId,0) ) 
		AND NOT EXISTS(SELECT * FROM #ZnodePublishCategoryProduct ZPCP WHERE ZPP.PublishProductId = ZPCP.PublishProductId AND
			ZPAV.PimAttributeId=ZPCP.PimAttributeId AND ZPP.PublishCatalogId=ZPCP.PublishCatalogId 
			AND ISNULL(ZPCC.PimCategoryHierarchyId,0)= ISNULL(ZPCP.PimCategoryHierarchyId,0))

		CREATE INDEX IDX_#ZnodePublishCategoryProduct_PimProductId ON #ZnodePublishCategoryProduct(PimProductId)
		CREATE INDEX IDX_#ZnodePublishCategoryProduct_PublishCategoryId ON #ZnodePublishCategoryProduct(PublishCategoryId)

		CREATE INDEX IDX_#ZnodePublishCategoryProduct_PimAttributeValueId ON #ZnodePublishCategoryProduct(PimAttributeValueId)
		CREATE INDEX IDX_#ZnodePublishCategoryProduct_PimAttributeId ON #ZnodePublishCategoryProduct(PimAttributeId)
		 
		------Getting All Link Product Details
		SELECT ZPLPD.PimParentProductId, ZPLPD.PimProductId, ZPLPD.PimAttributeId, ZPAVL.AttributeValue as SKU
		INTO #LinkProduct
		FROM ZnodePimLinkProductDetail ZPLPD 
		INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimProductId = ZPLPD.PimProductId)
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		WHERE EXISTS(SELECT * FROM ZnodePimAttribute ZPA WHERE ZPA.PimAttributeId = ZPAV.PimAttributeId AND ZPA.AttributeCode = 'SKU')
		
		 ----Getting products link product value entity
	     INSERT INTO #AttributeValueLocale ( PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId )
	     SELECT ZPLP.PimParentProductId ,ZPAX.AttributeCode, '' AttributeValue , 
		 JSON_MODIFY( JSON_Modify(ZPAX.AttributeJson , '$.AttributeValues' , 
		 ISNULL(SUBSTRING ( (SELECT ','+cast( LP.SKU as varchar(600))
							FROM #LinkProduct LP
							WHERE LP.PimParentProductId = ZPLP.PimParentProductId 
							AND LP.PimAttributeId = ZPLP.PimAttributeId FOR XML PATH('')),2,8000),'') ),'$.SelectValues',Json_Query('[]'))   

							, ZPAX.LocaleId
		 FROM ZnodePimLinkProductDetail ZPLP
		 INNER JOIN ZnodePimAttributeJSON ZPAX ON (ZPAX.PimAttributeId = ZPLP.PimAttributeId )
		 WHERE EXISTS(SELECT * FROM #ZnodePublishCategoryProduct PPCP  WHERE (ZPLP.PimParentProductId = PPCP.PimProductId ))
		 GROUP BY ZPLP.PimParentProductId ,ZPAX.AttributeCode , ZPAX.AttributeJSON,ZPAX.LocaleId,ZPAX.AttributeCode,ZPLP.PimAttributeId


		  ----Getting product attribute value entity
	      INSERT INTO #AttributeValueLocale ( PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId )
		  SELECT PPCP.PimProductId , ZPA.AttributeCode,ZPAVL.AttributeValue ,
					JSON_MODIFY(
					JSON_MODIFY (Json_Query( ZPAX.AttributeJSON  ) , '$.AttributeValues' ,  ISNULL(ZPAVL.AttributeValue,'') )    
					,'$.SelectValues',Json_Query('[]'))   
					AS 'AttributeEntity', 
				 ZPAVL.LocaleId
		  FROM ZnodePimAttributeValue PPCP
		  INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = PPCP.PimAttributeId)
		  INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON (PPCP.PimAttributeValueId =ZPAVL.PimAttributeValueId)
		  INNER JOIN ZnodePimAttributeJSON ZPAX ON (ZPAX.PimAttributeId = ZPA.PimAttributeId AND ZPAX.LocaleId = ZPAVL.LocaleId)
		  WHERE EXISTS(SELECT * FROM #ZnodePublishCategoryProduct PPCP1  WHERE PPCP1.PimProductId = PPCP.PimProductId)--(PPCP1.PimAttributeValueId =PPCP.PimAttributeValueId) AND (ZPA.PimAttributeId = PPCP1.PimAttributeId))
		  AND NOT EXISTS(SELECT * FROM #AttributeValueLocale AVL WHERE PPCP.PimProductId = AVL.PimProductId AND ZPA.AttributeCode = AVL.AttributeCode AND ZPAVL.LocaleId = AVL.LocaleId )
		  AND NOT EXISTS(SELECT * FROM ZnodePimConfigureProductAttribute UOP WHERE ZPAX.PimAttributeId = UOP.PimAttributeId AND PPCP.PimProductId = UOP.PimProductId )

		  ----Getting product attribute value entity getting for other locale with default attribute json
		  INSERT INTO #AttributeValueLocale ( PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId )
		  SELECT PPCP.PimProductId , ZPA.AttributeCode,ZPAVL.AttributeValue ,
					JSON_MODIFY(
					JSON_MODIFY (Json_Query( ZPAX.AttributeJSON  ) , '$.AttributeValues' ,  ISNULL(ZPAVL.AttributeValue,'') )    
					,'$.SelectValues',Json_Query('[]'))   
					AS 'AttributeEntity', 
				 ZPAVL.LocaleId
		  FROM ZnodePimAttributeValue PPCP
		  INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = PPCP.PimAttributeId)
		  INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON (PPCP.PimAttributeValueId =ZPAVL.PimAttributeValueId)
		  INNER JOIN ZnodePimAttributeJSON ZPAX ON (ZPAX.PimAttributeId = ZPA.PimAttributeId)
		  WHERE ZPAX.LocaleId = @DefaultLocaleId AND ZPAVL.LocaleId <> @DefaultLocaleId AND
		  EXISTS(SELECT * FROM #ZnodePublishCategoryProduct PPCP1  WHERE PPCP1.PimProductId = PPCP.PimProductId)--(PPCP1.PimAttributeValueId =PPCP.PimAttributeValueId) AND (ZPA.PimAttributeId = PPCP1.PimAttributeId))
		  AND NOT EXISTS(SELECT * FROM #AttributeValueLocale AVL WHERE PPCP.PimProductId = AVL.PimProductId AND ZPA.AttributeCode = AVL.AttributeCode AND ZPAVL.LocaleId = AVL.LocaleId )
		  AND NOT EXISTS(SELECT * FROM ZnodePimConfigureProductAttribute UOP WHERE ZPAX.PimAttributeId = UOP.PimAttributeId AND PPCP.PimProductId = UOP.PimProductId )


		  IF OBJECT_ID('TEMPDB..#ZnodePublishCatalogProductDetail') IS NOT NULL
			DROP TABLE #ZnodePublishCatalogProductDetail

		  IF OBJECT_ID('TEMPDB..#ZnodePublishCatalogProductDetail1') IS NOT NULL
			DROP TABLE #ZnodePublishCatalogProductDetail1

		  IF OBJECT_ID('TEMPDB..#TBL_ProductRequiredAttribute') IS NOT NULL
			DROP TABLE #TBL_ProductRequiredAttribute

		  
		CREATE TABLE #TBL_ProductRequiredAttribute (PimProductId INT,SKU VARCHAR(600),ProductName VARCHAR(600), IsActive VARCHAR(10), LocaleId INT)

		INSERT INTO #TBL_ProductRequiredAttribute(PimProductId, LocaleId)
		SELECT DISTINCT PimProductId, LocaleId FROM #AttributeValueLocale

		UPDATE #TBL_ProductRequiredAttribute 
		SET SKU = b.AttributeValue
		FROM #TBL_ProductRequiredAttribute a
		INNER JOIN #AttributeValueLocale b ON a.PimproductId = b.PimProductId AND a.LocaleId = b.LocaleId
		WHERE b.AttributeCode = 'SKU'

		UPDATE #TBL_ProductRequiredAttribute 
		SET ProductName = b.AttributeValue
		FROM #TBL_ProductRequiredAttribute a
		INNER JOIN #AttributeValueLocale b ON a.PimproductId = b.PimProductId AND a.LocaleId = b.LocaleId
		WHERE b.AttributeCode = 'ProductName'

		UPDATE #TBL_ProductRequiredAttribute 
		SET IsActive = b.AttributeValue
		FROM #TBL_ProductRequiredAttribute a
		INNER JOIN #AttributeValueLocale b ON a.PimproductId = b.PimProductId AND a.LocaleId = b.LocaleId
		WHERE b.AttributeCode = 'IsActive'

		  CREATE INDEX IDX_#TBL_ProductRequiredAttribute_PimProductId ON #TBL_ProductRequiredAttribute(PimProductId)

		  SELECT ZPI.PublishProductId, ZPI.PublishCatalogId ,TYU.PublishCategoryId,ZPI.CatalogName,ISNULL(ZPI.PimCategoryHierarchyId,0) PimCategoryHierarchyId
					,TPAR.SKU,TPAR.ProductName,TPAR.IsActive,TYU.PublishCategoryName CategoryName,ISNULL(TYU.LocaleId,TPAR.LocaleId) as LocaleId
		   INTO #ZnodePublishCatalogProductDetail
		   FROM #ZnodePublishCategoryProduct ZPI
		   INNER JOIN #TBL_ProductRequiredAttribute TPAR ON (TPAR.PimProductId = ZPI.PimProductId )
		   LEFT JOIN ZnodePublishCategoryDetail TYU ON (TYU.PublishCategoryId = ZPI.PublishCategoryId AND TPAR.LocaleId = TYU.LocaleId )
		   GROUP BY PublishProductId, PublishCatalogId ,TYU.PublishCategoryId,CatalogName,PimCategoryHierarchyId
					,SKU,ProductName,TPAR.IsActive,PublishCategoryName, TYU.LocaleId, TPAR.LocaleId

			
			CREATE INDEX IDX_#ZnodePublishCatalogProductDetail ON #ZnodePublishCatalogProductDetail(PublishProductId,PublishCatalogId,PimCategoryHierarchyId,LocaleId)

			SELECT PublishProductId,PublishCatalogId,PimCategoryHierarchyId,SKU,ProductName,CategoryName, CatalogName, LocaleId ,IsActive
			      ,CASE WHEN PublishProductId IS NULL THEN 1 ELSE Row_Number()Over(Partition by PublishProductId ORDER BY PublishProductId,PimCategoryHierarchyId) END  ProductIndex
			INTO #ZnodePublishCatalogProductDetail1
			FROM #ZnodePublishCatalogProductDetail


			INSERT INTO #ZnodePublishCatalogProductDetail1 (PublishProductId,PublishCatalogId,PimCategoryHierarchyId,SKU,ProductName,CategoryName, CatalogName, LocaleId ,IsActive,ProductIndex)
			SELECT PublishProductId,PublishCatalogId,PimCategoryHierarchyId,SKU,ProductName,CategoryName, CatalogName, b.Id ,IsActive,ProductIndex
			FROM #ZnodePublishCatalogProductDetail1 a
			CROSS APPLY @LocaleId b 
			WHERE NOT EXISTS(SELECT * FROM #ZnodePublishCatalogProductDetail1 c WHERE a.PublishProductId = c.PublishProductId AND b.Id = c.LocaleId  )
			AND a.LocaleId = @DefaultLocaleId 
			AND a.PublishCatalogId = @PublishCatalogId

			DELETE ZPCPD 
			FROM ZnodePublishCatalogProductDetail ZPCPD
			WHERE NOT EXISTS(SELECT * FROM #ProductLocaleWise ZPCPD1 WHERE ZPCPD.PublishProductId = ZPCPD1.PublishProductId 
			                 AND ZPCPD.LocaleId = ZPCPD1.LocaleId )  
			AND ZPCPD.PublishCatalogId = @PublishCatalogId

			DELETE ZPCPD 
			FROM ZnodePublishCatalogProductDetail ZPCPD
			WHERE EXISTS(SELECT * FROM #ZnodePublishCatalogProductDetail ZPCPD1 WHERE 
						ZPCPD.PublishProductId = ZPCPD1.PublishProductId 
			            AND ZPCPD.LocaleId = ZPCPD1.LocaleId 
						AND ISNULL(ZPCPD1.PimCategoryHierarchyId,0)  <> 0 ) AND ZPCPD.PimCategoryHierarchyId =0
			AND ZPCPD.PublishCatalogId = @PublishCatalogId
			
			----Update data ZnodePublishCatalogProductDetail 
			UPDATE TARGET
			SET  TARGET.ProductIndex	=SOURCE.ProductIndex
				,TARGET.ModifiedBy		= @UserId	
				,TARGET.ModifiedDate	= @Date
			FROM ZnodePublishCatalogProductDetail TARGET
			INNER JOIN #ZnodePublishCatalogProductDetail1 SOURCE
			ON (
		        SOURCE.PublishProductId = TARGET.PublishProductId
				AND SOURCE.PublishCatalogId = TARGET.PublishCatalogId 
				AND ISNULL(SOURCE.PimCategoryHierarchyId,0) = ISNULL(TARGET.PimCategoryHierarchyId,0)
				AND SOURCE.LocaleId = TARGET.LocaleId --@LocaleId_In
				)
			WHERE TARGET.PublishCatalogId = @PublishCatalogId

			----Update data ZnodePublishCatalogProductDetail 
			UPDATE TARGET
			SET  
				TARGET.ProductName		=SOURCE.ProductName
				,TARGET.CatalogName		=SOURCE.CatalogName
				,TARGET.IsActive		=case when SOURCE.IsActive in ('0','false') then 0 else 1 end 
				,TARGET.ModifiedBy		= @UserId	
				,TARGET.ModifiedDate	= @Date
			FROM ZnodePublishCatalogProductDetail TARGET
			INNER JOIN #ZnodePublishCatalogProductDetail1 SOURCE
			ON (
		        TARGET.SKU = SOURCE.SKU
				AND SOURCE.LocaleId = TARGET.LocaleId --@LocaleId_In
				)
			WHERE TARGET.PublishCatalogId = @PublishCatalogId

			
		----Update data ZnodePublishCatalogProductDetail 
		UPDATE TARGET
		SET  
			TARGET.CategoryName	=SOURCE.CategoryName
			,TARGET.ModifiedBy		= @UserId	
			,TARGET.ModifiedDate	= @Date
		FROM ZnodePublishCatalogProductDetail TARGET
		INNER JOIN #ZnodePublishCatalogProductDetail1 SOURCE
		ON (
		    TARGET.SKU = SOURCE.SKU
			AND SOURCE.LocaleId = TARGET.LocaleId 
			AND ISNULL(SOURCE.PimCategoryHierarchyId,0) = ISNULL(TARGET.PimCategoryHierarchyId,0)
			)
		WHERE ISNULL(TARGET.PimCategoryHierarchyId,0) <> 0
		AND TARGET.PublishCatalogId = @PublishCatalogId

		----Insert data ZnodePublishCatalogProductDetail 
		INSERT INTO ZnodePublishCatalogProductDetail
			( PublishProductId,PublishCatalogId,PimCategoryHierarchyId,SKU,ProductName,CategoryName, CatalogName,
				LocaleId ,IsActive,ProductIndex,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
		SELECT SOURCE.PublishProductId ,SOURCE.PublishCatalogId ,SOURCE.PimCategoryHierarchyId ,SOURCE.SKU ,SOURCE.ProductName
		,SOURCE.CategoryName ,SOURCE.CatalogName ,SOURCE.LocaleId ,SOURCE.IsActive ,SOURCE.ProductIndex ,@UserId ,@Date ,@UserId ,@Date
		FROM #ZnodePublishCatalogProductDetail1 SOURCE
		WHERE NOT EXISTS(SELECT * FROM ZnodePublishCatalogProductDetail TARGET WHERE SOURCE.PublishProductId = TARGET.PublishProductId
						AND SOURCE.PublishCatalogId = TARGET.PublishCatalogId 
						AND SOURCE.PimCategoryHierarchyId = TARGET.PimCategoryHierarchyId 
						AND TARGET.LocaleId = SOURCE.LocaleId )
		AND SOURCE.PublishCatalogId = @PublishCatalogId
					
		----		  
		INSERT INTO ZnodePublishCatalogProductDetail (PublishProductId,PublishCatalogId,PimCategoryHierarchyId,SKU,ProductName,CategoryName, CatalogName,
				LocaleId ,IsActive,ProductIndex,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT PublishProductId,PublishCatalogId,PimCategoryHierarchyId,SKU,ProductName,CategoryName, CatalogName,
				b.Id ,IsActive,ProductIndex,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		FROM ZnodePublishCatalogProductDetail a
		CROSS APPLY @LocaleId b 
		WHERE NOT EXISTS(SELECT * FROM ZnodePublishCatalogProductDetail c WHERE a.PublishProductId = c.PublishProductId AND b.Id = c.LocaleId  )
		AND a.LocaleId = @DefaultLocaleId
		AND a.PublishCatalogId = @PublishCatalogId

		DELETE ZPCPD FROM ZnodePublishCatalogProductDetail ZPCPD
		INNER JOIN ZnodePublishProduct ZPD ON ZPCPD.PublishProductId = ZPD.PublishProductId AND ZPCPD.PublishCatalogId = ZPD.PublishCatalogId
		INNER JOIN ZnodePublishCatalog ZPC ON ZPCPD.PublishCatalogId = ZPC.PublishCatalogId
		WHERE NOT EXISTS(SELECT * FROM ZnodePimCategoryProduct ZPCC 
			    INNER JOIN ZnodePimCategoryHierarchy ZPCH ON ZPCC.PimCategoryId = ZPCH.PimCategoryId WHERE ZPD.PimProductId = ZPCC.PimProductId AND ZPC.PimCatalogId = ZPCH.PimCatalogId AND ZPCPD.PimCategoryHierarchyId = ZPCH.PimCategoryHierarchyId)
		AND ZPCPD.PimCategoryHierarchyId <> 0
		AND ZPCPD.PublishCatalogId = @PublishCatalogId

		----Updating the SKU into table ZnodePublishCatalogProductDetail
		UPDATE ZnodePublishCatalogProductDetail 
		SET SKU = b.AttributeValue
		FROM ZnodePublishCatalogProductDetail a
		INNER JOIN ZnodePublishProduct ZPP ON a.PublishProductId = ZPP.PublishProductId
		INNER JOIN #AttributeValueLocale b ON ZPP.PimproductId = b.PimProductId AND a.LocaleId = b.LocaleId
		WHERE b.AttributeCode = 'SKU'
		AND a.PublishCatalogId = @PublishCatalogId

		----Updating the ProductName into table ZnodePublishCatalogProductDetail
		UPDATE ZnodePublishCatalogProductDetail 
		SET ProductName = b.AttributeValue
		FROM ZnodePublishCatalogProductDetail a
		INNER JOIN ZnodePublishProduct ZPP ON a.PublishProductId = ZPP.PublishProductId
		INNER JOIN #AttributeValueLocale b ON ZPP.PimproductId = b.PimProductId AND a.LocaleId = b.LocaleId
		WHERE b.AttributeCode = 'ProductName'
		AND a.PublishCatalogId = @PublishCatalogId

		----Updating the IsActive into table ZnodePublishCatalogProductDetail
		UPDATE ZnodePublishCatalogProductDetail 
		SET IsActive = b.AttributeValue
		FROM ZnodePublishCatalogProductDetail a
		INNER JOIN ZnodePublishProduct ZPP ON a.PublishProductId = ZPP.PublishProductId
		INNER JOIN #AttributeValueLocale b ON ZPP.PimproductId = b.PimProductId AND a.LocaleId = b.LocaleId
		WHERE b.AttributeCode = 'IsActive'
		AND a.PublishCatalogId = @PublishCatalogId

		---- To clean Older Hierarchies associations.
		DELETE ZPCPD
		FROM ZnodePublishCatalogProductDetail ZPCPD
		WHERE NOT EXISTS (select top 1 1 from ZnodePimCategoryHierarchy ZPCH where (ZPCPD.PimCategoryHierarchyId = ZPCH.PimCategoryHierarchyId))
		AND ISNULL(ZPCPD.PimCategoryHierarchyId,0) <>0

		SELECT a.PimProductId,  a.PimAttributeId
		INTO #PimProductAttributeDefaultValue
		FROM ZnodePimAttributeValue a 
		INNER JOIN ZnodePimProductAttributeDefaultValue b ON a.PimAttributeValueId = b.PimAttributeValueId 

		CREATE INDEX Idx_#PimProductAttributeDefaultValue ON #PimProductAttributeDefaultValue (PimProductId,PimAttributeId)

		INSERT INTO #PimDefaultValueLocale
		SELECT PimAttributeDefaultJsonId,PimAttributeDefaultValueId,LocaleId ,DefaultValueJson
		FROM ZnodePimAttributeDefaultJSON

		SELECT  AA.DefaultValueJson , ZPADV.PimAttributeValueId, AA.LocaleId 
		INTO #PimAttributeDefaultXML
		FROM ZnodePimAttributeDefaultJSON AA 
		INNER JOIN #PimDefaultValueLocale GH ON (GH.PimAttributeDefaultJsonId = AA.PimAttributeDefaultJsonId AND AA.LocaleId = GH.LocaleId)
		INNER JOIN ZnodePimProductAttributeDefaultValue ZPADV ON ( ZPADV.PimAttributeDefaultValueId = AA.PimAttributeDefaultValueId AND AA.LocaleId = ZPADV.LocaleId)

		--To get the data localwise
		INSERT INTO #PimAttributeDefaultXML (DefaultValueJson, PimAttributeValueId, LocaleId)
		SELECT A.DefaultValueJson , A.PimAttributeValueId,b.id FROM #PimAttributeDefaultXML A CROSS APPLY  @LocaleId b  
		WHERE NOT EXISTS ( SELECT * FROM #PimAttributeDefaultXML c WHERE a.PimAttributeValueId  = c.PimAttributeValueId AND c.LocaleId = b.Id )
		AND b.Id <> @DefaultLocaleId

		----Getting child facets for merging		  
		SELECT DISTINCT ZPPADV.PimAttributeDefaultValueId, ZPAV_Parent.PimAttributeValueId, ZPPADV.LocaleId
		INTO #PimChildProductFacets
		FROM ZnodePimAttributeValue ZPAV_Parent
		INNER JOIN ZnodePimProductTypeAssociation ZPPTA ON ZPAV_Parent.PimProductId = ZPPTA.PimParentProductId
		INNER JOIN ZnodePimAttributeValue ZPAV_Child ON ZPPTA.PimProductId = ZPAV_Child.PimProductId AND ZPAV_Parent.PimAttributeId = ZPAV_Child.PimAttributeId
		INNER JOIN ZnodePimProductAttributeDefaultValue ZPPADV ON ZPAV_Child.PimAttributeValueId = ZPPADV.PimAttributeValueId 
		WHERE EXISTS(SELECT * FROM ZnodePimFrontendProperties ZPFP WHERE ZPAV_Parent.PimAttributeId = ZPFP.PimAttributeId AND ZPFP.IsFacets = 1)
		AND EXISTS(SELECT * FROM #ZnodePublishCategoryProduct ZPPC WHERE ZPAV_Parent.PimProductId = ZPPC.PimProductId )
		AND NOT EXISTS(SELECT * FROM ZnodePimProductAttributeDefaultValue ZPPADV1 WHERE ZPAV_Parent.PimAttributeValueId = ZPPADV1.PimAttributeValueId 
		                AND ZPPADV1.PimAttributeDefaultValueId = ZPPADV.PimAttributeDefaultValueId )

		----Merging childs facet attribute Default value XML for parent
		INSERT INTO #PimAttributeDefaultXML (DefaultValueJson, PimAttributeValueId, LocaleId)
		SELECT ZPADX.DefaultValueJson, ZPPADV.PimAttributeValueId, ZPPADV.LocaleId
		FROM #PimChildProductFacets ZPPADV		  
		INNER JOIN ZnodePimAttributeDefaultJSON ZPADX ON ( ZPPADV.PimAttributeDefaultValueId = ZPADX.PimAttributeDefaultValueId AND ZPPADV.LocaleId = ZPADX.LocaleId)

		CREATE INDEX Idx_#PimDefaultValueLocale ON #PimDefaultValueLocale(PimAttributeDefaultJsonId,LocaleId)

		CREATE INDEX Idx_#PimAttributeDefaultXML ON #PimAttributeDefaultXML(PimAttributeValueId,LocaleId)
		INCLUDE (DefaultValueJson)

		----Getting default attribute value entity
		INSERT INTO #AttributeValueLocale
		
		SELECT PPCP.PimProductId, PPCP.AttributeCode,'' AttributeValue,
		JSON_MODIFY (JSON_MODIFY (ZPAX.AttributeJson,'$.AttributeValues',''), '$.SelectValues',
			
				ISNULL((SELECT 
							ISNULL(JSON_VALUE(DefaultValueJson, '$.Code'),'') Code 
							,ISNULL(JSON_VALUE(DefaultValueJson, '$.LocaleId'),0) LocaleId
							,ISNULL(JSON_VALUE(DefaultValueJson, '$.Value'),'') Value
							,ISNULL(JSON_VALUE(DefaultValueJson, '$.AttributeDefaultValue'),'') AttributeDefaultValue
							,ISNULL(JSON_VALUE(DefaultValueJson, '$.DisplayOrder'),0) DisplayOrder
							,ISNULL(JSON_VALUE(DefaultValueJson, '$.IsEditable'),'false') IsEditable
							,ISNULL(JSON_VALUE(DefaultValueJson, '$.SwatchText'),'') SwatchText
							,ISNULL(JSON_VALUE(DefaultValueJson, '$.Path'),'') Path
					FROM #PimAttributeDefaultXML aa
					WHERE (aa.PimAttributeValueId = PPCP.PimAttributeValueId AND AA.LocaleId = ZPAX.LocaleId ) For JSON Auto 
				),'[]') 
				) 
			 AttributeEntity 
		 , ZPAX.LocaleId
		 FROM #ZnodePublishCategoryProduct PPCP 
		 INNER JOIN ZnodePimAttributeJSON ZPAX ON (ZPAX.PimAttributeId = PPCP.PimAttributeId)
		 WHERE 
		 NOT EXISTS(SELECT * FROM #AttributeValueLocale AVL WHERE PPCP.PimProductId = AVL.PimProductId AND PPCP.AttributeCode = AVL.AttributeCode AND ZPAX.LocaleId = AVL.LocaleId )
		 AND EXISTS(SELECT * FROM #PimProductAttributeDefaultValue a  WHERE PPCP.PimProductId = a.PimProductId AND ZPAX.PimAttributeId = a.PimAttributeId )
		 AND EXISTS(SELECT * FROM ZnodePimAttributeValue a INNER JOIN ZnodePimProductAttributeDefaultValue b ON a.PimAttributeValueId = b.PimAttributeValueId 
		            AND PPCP.PimProductId = a.PimProductId AND ZPAX.PimAttributeId = a.PimAttributeId )
		 AND NOT EXISTS(SELECT * FROM ZnodePimConfigureProductAttribute UOP WHERE ZPAX.PimAttributeId = UOP.PimAttributeId AND PPCP.PimProductId = UOP.PimProductId )

		 
		 ----Getting text attribute value entity
		 INSERT INTO #AttributeValueLocale ( PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId )
		 SELECT PPCP.PimProductId , ZPA.AttributeCode,'' AttributeValue ,
		 JSON_MODIFY (JSON_MODIFY (Json_Query( ZPAX.AttributeJSON  ) , '$.AttributeValues' ,  ISNULL(ZPAVL.AttributeValue,'') ) ,'$.SelectValues',Json_Query('[]'))
		    AS 'AttributeEntity', 
		 ZPAVL.LocaleId
		 FROM ZnodePimAttributeValue PPCP
		 INNER JOIN ZnodePimProductAttributeTextAreaValue ZPAVL ON (PPCP.PimAttributeValueId =ZPAVL.PimAttributeValueId)
		 INNER JOIN ZnodePimAttributeJSON ZPAX ON (ZPAX.PimAttributeId = PPCP.PimAttributeId AND ZPAX.LocaleId = ZPAVL.LocaleId)
		 INNER JOIN ZnodePimAttribute ZPA ON PPCP.PimAttributeId = ZPA.PimAttributeId
	     WHERE EXISTS(SELECT * FROM #ZnodePublishCategoryProduct PPCP1 WHERE PPCP1.PimProductId = PPCP.PimProductId) --(PPCP1.PimAttributeValueId =ZPAVL.PimAttributeValueId) AND (ZPAX.PimAttributeId = PPCP1.PimAttributeId))
		 AND NOT EXISTS(SELECT * FROM #AttributeValueLocale AVL WHERE PPCP.PimProductId = AVL.PimProductId AND ZPA.AttributeCode = AVL.AttributeCode AND ZPAVL.LocaleId = AVL.LocaleId )
		group by PPCP.PimProductId , ZPA.AttributeCode,ZPAX.AttributeJson,ZPAVL.LocaleId,ZPAVL.AttributeValue

		 ----Getting custome field value entity
		 INSERT INTO #AttributeValueLocale ( PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId )
 		 SELECT ZPCFX.PimProductId , ZPCFX.CustomCode, '' AttributeValue ,
		 JSON_MODIFY (Json_Query( ZPCFX.CustomeFiledJson) ,'$.SelectValues',Json_Query('[]')) 
		 AttributeEntity, 
		 ZPCFX.LocaleId
		 FROM ZnodePimCustomeFieldJSON ZPCFX 
		 WHERE EXISTS(SELECT * FROM #ZnodePublishCategoryProduct PPCP WHERE (PPCP.PimProductId = ZPCFX.PimProductId ))
		 AND NOT EXISTS(SELECT * FROM #AttributeValueLocale AVL WHERE ZPCFX.PimProductId = AVL.PimProductId AND ZPCFX.CustomCode = AVL.AttributeCode AND ZPCFX.LocaleId = AVL.LocaleId )
		 group by ZPCFX.PimProductId , ZPCFX.CustomCode, ZPCFX.CustomeFiledJson , ZPCFX.LocaleId

		  ----Getting image attribute value entity
		 INSERT INTO #AttributeValueLocale ( PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId )
		 SELECT PPCP.PimProductId, ZPA.AttributeCode,'' AttributeValue,
		 JSON_MODIFY (JSON_MODIFY (Json_Query( ZPAX.AttributeJSON  ) , '$.AttributeValues',  
		 ISNULL((SELECT stuff( (SELECT ','+ZPPAM.MediaPath FROM ZnodePimProductAttributeMedia ZPPAM WHERE (ZPPAM.PimAttributeValueId = PPCP.PimAttributeValueId)
				 FOR XML PATH(''),Type).value('.', 'varchar(max)'), 1, 1, '')
				 
				 ),'') ) ,'$.SelectValues',Json_Query('[]'))   
				 AS 'AttributeEntity', 
				 ZPAX.LocaleId
		 FROM ZnodePimAttributeValue PPCP 
		 INNER JOIN ZnodePimAttributeJSON ZPAX ON (ZPAX.PimAttributeId = PPCP.PimAttributeId)
		 INNER JOIN ZnodePimAttribute ZPA ON ZPA.PimAttributeId = PPCP.PimAttributeId
		 WHERE NOT EXISTS(SELECT * FROM #AttributeValueLocale AVL WHERE PPCP.PimProductId = AVL.PimProductId AND ZPA.AttributeCode = AVL.AttributeCode AND ZPAX.LocaleId = AVL.LocaleId )
		 AND EXISTS(SELECT * FROM ZnodePimProductAttributeMedia b WHERE PPCP.PimAttributeValueId = b.PimAttributeValueId )
		 AND EXISTS(SELECT * FROM #ZnodePublishCategoryProduct PPCP1 WHERE PPCP.PimProductId = PPCP1.PimProductId )
		 AND NOT EXISTS(SELECT * FROM ZnodePimConfigureProductAttribute UOP WHERE ZPAX.PimAttributeId = UOP.PimAttributeId AND PPCP.PimProductId = UOP.PimProductId )

		 -------------configurable attribute 		 
		
		INSERT INTO #AttributeValueLocale ( PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId )
		SELECT DISTINCT UOP.PimProductId,c.AttributeCode,'' AttributeValue ,--'<Attributes><AttributeEntity>'+
		JSON_MODIFY (ISNULL(JSON_MODIFY (c.AttributeJson,'$.AttributeValues',''),'')  ,'$.SelectValues',
			ISNULL((SELECT DISTINCT 
							ISNULL(JSON_VALUE(AA.DefaultValueJson, '$.Code'),'') Code 
							,ISNULL(JSON_VALUE(AA.DefaultValueJson, '$.LocaleId'),0) LocaleId
							,ISNULL(JSON_VALUE(AA.DefaultValueJson, '$.Value'),'') Value
							,ISNULL(JSON_VALUE(AA.DefaultValueJson, '$.AttributeDefaultValue'),'') AttributeDefaultValue
							,ISNULL(JSON_VALUE(AA.DefaultValueJson, '$.DisplayOrder'),0) DisplayOrder
							,ISNULL(JSON_VALUE(AA.DefaultValueJson, '$.IsEditable'),'false') IsEditable
							,ISNULL(JSON_VALUE(AA.DefaultValueJson, '$.SwatchText'),'') SwatchText
							,ISNULL(JSON_VALUE(AA.DefaultValueJson, '$.Path'),'') Path 
							,ISNULL(ZPA.DisplayOrder,0)  AS VariantDisplayOrder 
							,ISNULL(ZPAVL_SKU.AttributeValue,'')   AS VariantSKU 
							,ISNULL(ZM.Path,'') AS VariantImagePath 
						 FROM ZnodePimAttributeDefaultJSON AA 
						 INNER JOIN ZnodePimProductAttributeDefaultValue ZPADV ON ( ZPADV.PimAttributeDefaultValueId = AA.PimAttributeDefaultValueId )
						 INNER JOIN ZnodePimAttributeValue ZPAV1 ON (ZPAV1.PimAttributeValueId= ZPADV.PimAttributeValueId )
						 -- check/join for active variants 
						 INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimProductId =ZPAV1.PimProductId)
						 INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON (ZPAV.PimAttributevalueid = ZPAVL.PimAttributeValueId AND ZPAVL.AttributeValue = 'True')
						 INNER JOIN ZnodePimProductTypeAssociation YUP ON (YUP.PimProductId = ZPAV1.PimProductId)
						 -- SKU
						 INNER JOIN ZnodePimAttributeValue ZPAV_SKU ON(YUP.PimProductId = ZPAV_SKU.PimProductId)
						 INNER JOIN ZnodePimAttributeValueLocale ZPAVL_SKU ON (ZPAVL_SKU.PimAttributeValueId = ZPAV_SKU.PimAttributeValueId)
						 LEFT JOIN ZnodePimAttributeValue ZPAV12 ON (ZPAV12.PimProductId= YUP.PimProductId  AND ZPAV12.PimAttributeId = @PimMediaAttributeId ) 
						 LEFT JOIN ZnodePimProductAttributeMedia ZPAVM ON (ZPAVM.PimAttributeValueId= ZPAV12.PimAttributeValueId ) 
						 LEFT JOIN ZnodeMedia ZM ON (ZM.MediaId = ZPAVM.MediaId)
						 LEFT JOIN ZnodePimAttribute ZPA ON (ZPA.PimattributeId = ZPAV1.PimAttributeId)
						 WHERE (YUP.PimParentProductId  = UOP.PimProductId AND ZPAV1.pimAttributeId = UOP.PimAttributeId )
						 -- Active Variants
						 AND ZPAV.PimAttributeId = (SELECT TOP 1 PimAttributeId FROM ZnodePimAttribute WHERE AttributeCode = 'IsActive')
						 -- VariantSKU
						 AND ZPAV_SKU.PimAttributeId = (SELECT PimAttributeId FROM ZnodePimAttribute WHERE AttributeCode = 'SKU')
		FOR JSON auto),'[]')) SelectValuesEntity ,
		c.LocaleId
		FROM ZnodePimConfigureProductAttribute UOP 
		INNER JOIN ZnodePimAttributeJSON c   ON (c.PimAttributeId = UOP.PimAttributeId )
		WHERE  EXISTS(SELECT * FROM #ZnodePublishCategoryProduct PPCP1 WHERE UOP.PimProductId = PPCP1.PimProductId )

		-------------configurable attribute 

		CREATE INDEX IDX_#AttributeValueLocale ON #AttributeValueLocale(PimProductId,AttributeCode,LocaleId)
		CREATE INDEX IDX_#AttributeValueLocale_Id ON #AttributeValueLocale(ID)
		 	
		DELETE ZPPAX FROM ZnodePublishProductAttributeJson ZPPAX
		WHERE exists (SELECT * FROM #AttributeValueLocale AVL WHERE ZPPAX.PimProductId = AVL.PimProductId AND AVL.LocaleId = ZPPAX.LocaleId )
		AND NOT EXISTS(SELECT * FROM #AttributeValueLocale AVL WHERE ZPPAX.PimProductId = AVL.PimProductId AND AVL.LocaleId = ZPPAX.LocaleId AND ZPPAX.AttributeCode = AVL.AttributeCode )

		DECLARE @MaxCount INT, @MinRow INT, @MaxRow INT, @Rows numeric(10,2);
		SELECT @MaxCount = COUNT(*) FROM #AttributeValueLocale;

		SELECT @Rows = 200000
        
		SELECT @MaxCount = CEILING(@MaxCount / @Rows);

		IF OBJECT_ID('tempdb..#Temp_ImportLoop') IS NOT NULL
            DROP TABLE #Temp_ImportLoop;
        
		---- To get the min AND max rows for import in loop
		;WITH cte AS 
		(
			SELECT RowId = 1, 
				   MinRow = 1, 
                   MaxRow = cast(@Rows as int)
            UNION ALL
            SELECT RowId + 1, 
                   MinRow + cast(@Rows as int), 
                   MaxRow + cast(@Rows as int)
            FROM cte
            WHERE RowId + 1 <= @MaxCount
		)
        SELECT RowId, MinRow, MaxRow
        INTO #Temp_ImportLoop
        FROM cte
		OPTION (maxrecursion 0);

		--Cursor for rows wise execution in bulk
		DECLARE cur_BulkData CURSOR LOCAL FAST_FORWARD
        FOR SELECT MinRow, MaxRow FROM #Temp_ImportLoop
		WHERE EXISTS(SELECT * FROM #AttributeValueLocale);

        OPEN cur_BulkData;
        FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow;

        WHILE @@FETCH_STATUS = 0
        BEGIN
	         UPDATE ZnodePublishProductAttributeJson SET IsUpdateLocaleWise = 0 WHERE ISNULL(IsUpdateLocaleWise,0) = 1
			  ----Update Product Attribute XML
			 UPDATE ZPPAX SET ZPPAX.Attributes = AVL.AttributeEntity, ZPPAX.ModifiedBy = @UserId, ZPPAX.ModifiedDate = GETDATE() 
			        , ZPPAX.IsUpdateLocaleWise = 0
			 FROM ZnodePublishProductAttributeJson ZPPAX 
			 INNER JOIN #AttributeValueLocale AVL ON ZPPAX.PimProductId = AVL.PimProductId AND AVL.LocaleId = ZPPAX.LocaleId AND ZPPAX.AttributeCode = AVL.AttributeCode 
			 WHERE  AVL.Id BETWEEN @MinRow AND @MaxRow AND AVL.AttributeEntity is not null
		 
			 ----Insert Product Attribute XML
			 INSERT INTO ZnodePublishProductAttributeJson(PimProductId,LocaleId,AttributeCode,Attributes,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			 SELECT AVL.PimProductId, AVL.LocaleId, AVL.AttributeCode, cast(AVL.AttributeEntity as varchar(max)), @UserId CreatedBy, GETDATE() CreatedDate, @UserId ModifiedBy, GETDATE() ModifiedDate
			 FROM #AttributeValueLocale AVL
			 WHERE NOT EXISTS(SELECT * FROM ZnodePublishProductAttributeJson ZPPAX WHERE AVL.PimProductId = ZPPAX.PimProductId AND  AVL.LocaleId = ZPPAX.LocaleId AND AVL.AttributeCode = ZPPAX.AttributeCode )
			 AND  AVL.Id BETWEEN @MinRow AND @MaxRow AND AVL.AttributeEntity is not null
			 GROUP BY AVL.PimProductId, AVL.AttributeEntity, AVL.LocaleId, AVL.AttributeCode

			 FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow;
        END;
		CLOSE cur_BulkData;
		DEALLOCATE cur_BulkData;

		DELETE ZPPAX
		FROM ZnodePublishProductAttributeJson ZPPAX
		WHERE LocaleId <> @DefaultLocaleId
		AND exists( SELECT * FROM ZnodePublishProductAttributeJson ZPPAX1 WHERE ZPPAX.AttributeCode = ZPPAX1.AttributeCode AND ZPPAX.PimProductId = ZPPAX1.PimProductId )
		AND NOT EXISTS(SELECT * FROM #ProductLocaleWise AVL WHERE AVL.PimProductId = ZPPAX.PimProductId AND  AVL.LocaleId = ZPPAX.LocaleId )
		
		
		DELETE  ZPPAX
		FROM ZnodePublishProductAttributeJson ZPPAX
		WHERE NOT EXISTS(SELECT * FROM #ProductLocaleWise ZLW WHERE ZPPAX.PimProductId = ZLW.PimProductId 
			                AND ZPPAX.LocaleId = ZLW.LocaleId )

		SELECT PimProductId,Attributes Attributes,AttributeCode
		INTO #ZnodePublishProductAttributeJson
		FROM ZnodePublishProductAttributeJson 
		WHERE LocaleId = @DefaultLocaleId

		INSERT INTO ZnodePublishProductAttributeJson (PimProductId,Attributes,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AttributeCode)
		SELECT PimProductId,Attributes,b.id,@UserId,GETDATE(),@UserId,GETDATE(),AttributeCode
		FROM #ZnodePublishProductAttributeJson a
		CROSS APPLY @LocaleId b 
		WHERE NOT EXISTS(SELECT * FROM ZnodePublishProductAttributeJson c WHERE a.PimProductId = c.PimProductId AND b.Id = c.LocaleId AND a.AttributeCode = c.AttributeCode )
		AND b.Id <> @DefaultLocaleId
					  
END TRY
BEGIN CATCH
    DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertUpdatePimCatalogProductDetailJson @PublishCatalogId = '+CAST(@PublishCatalogId AS VARCHAR(200))+',@UserId='+CAST(@UserId AS VARCHAR(200));


    EXEC Znode_InsertProcedureErrorLog
        @ProcedureName = 'Znode_InsertUpdatePimCatalogProductDetailJson',
        @ErrorInProcedure = @Error_procedure,
        @ErrorMessage = @ErrorMessage,
        @ErrorLine = @ErrorLine,
        @ErrorCall = @ErrorCall;
            
            
END CATCH;
END

GO

DECLARE @SequenceNumber1 INT=(SELECT MAX(SequenceNumber) FROM ZnodeImportAttributeValidation 
Where  ImportHeadId = (select top 1 ImportHeadId from ZnodeImportHead WHERE Name = 'Customer'))
Update ZnodeImportAttributeValidation SET SequenceNumber = @SequenceNumber1+1   
Where  AttributeCode ='PerOrderAnnualLimit' and ImportHeadId = (select top 1 ImportHeadId from ZnodeImportHead WHERE Name = 'Customer')
and SequenceNumber is null

set @SequenceNumber1 =(SELECT MAX(SequenceNumber) FROM ZnodeImportAttributeValidation 
Where  ImportHeadId = (select top 1 ImportHeadId from ZnodeImportHead WHERE Name = 'Customer'))
Update ZnodeImportAttributeValidation SET SequenceNumber =@SequenceNumber1+1  
Where  AttributeCode ='BillingAccountNumber' and ImportHeadId = (select top 1 ImportHeadId from ZnodeImportHead WHERE Name = 'Customer')
and SequenceNumber is null

set @SequenceNumber1 =(SELECT MAX(SequenceNumber) FROM ZnodeImportAttributeValidation 
Where  ImportHeadId = (select top 1 ImportHeadId from ZnodeImportHead WHERE Name = 'Customer'))
Update ZnodeImportAttributeValidation SET SequenceNumber = @SequenceNumber1+1
Where  AttributeCode ='EnableUserShippingAddressSuggestion' and ImportHeadId = (select top 1 ImportHeadId from ZnodeImportHead WHERE Name = 'Customer')
and SequenceNumber is null 

Update ZnodeImportAttributeValidation SET SequenceNumber = @SequenceNumber1+1 
Where  AttributeCode ='EnablePowerBIReportOnWebStore' and ImportHeadId = (select top 1 ImportHeadId from ZnodeImportHead WHERE Name = 'Customer')
and SequenceNumber is null and ControlName = 'Yes/No'  and ValidationName = 'AllowNegative'

Update ZnodeImportAttributeValidation SET SequenceNumber = @SequenceNumber1+1 
Where  AttributeCode ='EnablePowerBIReportOnWebStore' and ImportHeadId = (select top 1 ImportHeadId from ZnodeImportHead WHERE Name = 'Customer')
and SequenceNumber is null and ControlName = 'Yes/No'  and ValidationName = 'AllowDecimals'

Update ZnodeImportAttributeValidation SET SequenceNumber = @SequenceNumber1+1 
Where  AttributeCode ='EnablePowerBIReportOnWebStore' and ImportHeadId = (select top 1 ImportHeadId from ZnodeImportHead WHERE Name = 'Customer')
and SequenceNumber is null and ControlName = 'Number'  and ValidationName = 'MinNumber'

Update ZnodeImportAttributeValidation SET SequenceNumber = @SequenceNumber1+1 
Where  AttributeCode ='EnablePowerBIReportOnWebStore' and ImportHeadId = (select top 1 ImportHeadId from ZnodeImportHead WHERE Name = 'Customer')
and SequenceNumber is null and ControlName = 'Number'  and ValidationName = 'MaxNumber'

set @SequenceNumber1 =(SELECT MAX(SequenceNumber) FROM ZnodeImportAttributeValidation 
Where  ImportHeadId = (select top 1 ImportHeadId from ZnodeImportHead WHERE Name = 'Customer'))
Update ZnodeImportAttributeValidation SET SequenceNumber = @SequenceNumber1+1 
Where  AttributeCode ='PerOrderLimit' and ImportHeadId = (select top 1 ImportHeadId from ZnodeImportHead WHERE Name = 'Customer')
and SequenceNumber is null

GO

update ZnodeEmailTemplateAreas
set name ='PendingOrderApproval'
where name ='PendingApproval'

update ZnodeEmailTemplateAreas
set name ='PendingOrderStatusNotification'
where name ='QuoteStatusNotification'

update ZnodeEmailTemplateAreas
set name ='PendingOrderRejected'
where name ='QuoteRejected'

update ZnodeEmailTemplateAreas
set name ='PendingOrderApproved'
where name ='QuoteApproved'

update ZnodeEmailTemplateAreas
set name ='PendingOrderApproval'
where  name ='QuoteApproval'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity

GO

CREATE PROCEDURE [dbo].[Znode_PublishCatalogEntity]
(
   @PimCatalogId  INT = 0 
  ,@RevisionState varchar(50) = '' 
  ,@UserId int = 0
  ,@NewGUID nvarchar(500) 
)
AS
/*
	To publish all catalog product and their details
	Unit Testing : 
	Exec [dbo].[Znode_PublishCatalogEntity]
     @PimCatalogId  = 3
	,@RevisionState = 'PRODUCTION' 
	,@UserId = 2
	,@NewGUID = '123'
	
	EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,
	@NewGUID ='123' 

*/
BEGIN
BEGIN TRY 
SET NOCOUNT ON
	Declare @Status Bit =0 , @PublishCatalogId INT=0
	IF (@PimCatalogId=0)
	BEGIN
		--SET @Status =0
		SELECT 0 AS ID,@Status AS Status;
		SET @PublishCatalogId=0
		SELECT @PublishCatalogId;
	END
	ELSE
	BEGIN
	
	--Declare @NewGUID nvarchar(500) =  newid()
	Declare @Type varchar(50) = '',	@CMSSEOCode varchar(300);
	SET @Status = 1 
	Declare @IsPreviewEnable int
	,@PreviewVersionId INT = 0  
	,@ProductionVersionId INT = 0
	--,@PublishCatalogId    INT = 0 
	,@CatalogProfileId varchar(1000)
	
	 IF OBJECT_ID('tempdb..#CatalogAttributeDetails') IS NOT NULL
		DROP TABLE #CatalogAttributeDetails
	 CREATE TABLE [dbo].[#CatalogAttributeDetails]
	 (
		[ZnodeCatalogId] [int] NULL,
		[AttributeCode] [nvarchar](300) NULL,
		[AttributeTypeName] [varchar](300) NULL,
		[IsComparable] [bit] NOT NULL,
		[IsHtmlTags] [bit] NOT NULL,
		[IsFacets] [bit] NOT NULL,
		[IsUseInSearch] [bit] NOT NULL,
		[IsPersonalizable] [bit] NOT NULL,
		[IsConfigurable] [bit] NOT NULL,
		[AttributeName] [nvarchar](300) NULL,
		[LocaleId] [int] NULL,
		[DisplayOrder] [int] NULL,
		[DefaultValueDisplayOrder] [int] NULL,
		[AttributeDefaultValue] [nvarchar](max) NULL
	 ) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
	 Declare @CatalogName varchar(100),@UserName Varchar(50)
	 SET @PublishCatalogId = ISNULL((SELECT TOP 1 PublishCatalogId FROM ZnodePublishCatalog ZPC WHERE ZPC.PimCatalogId = @PimCatalogId), 0)
	 
	 Select TOP 1  @UserName = aspNetZnodeUser.UserName from ZnodeUser Inner Join aspNetUsers ON ZnodeUser.aspNetUserId = aspNetUsers.Id 
	 Inner Join aspNetZnodeUser on aspNetUsers.UserName = aspNetZnodeUser.AspNetZnodeUserId
	 where ZnodeUser.UserId = @userId

	 Select @CatalogName = CatalogName from ZnodePimCatalog where PimCatalogId = @PimCatalogId 
	 Delete from ZnodePublishProgressNotifierEntity where JOBName =@CatalogName 
	 INSERT INTO ZnodePublishProgressNotifierEntity
	 (VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriendlyName)
	 Values(0,@NewGUID , Isnull(@CatalogName,'') + ' Catalog ', 0 , 0 , 0 , '' , @UserId, @UserName )

   	 If Exists (SELECT  * from ZnodePublishStateApplicationTypeMapping PSA where PSA.IsEnabled =1 and  
		Exists (select TOP 1 1  from ZnodePublishState PS where PS.PublishStateId = PSA.PublishStateId ) and ApplicationType =  'WebstorePreview')
			SET @IsPreviewEnable = 1 
		else 
			SET @IsPreviewEnable = 0 

		--Genrate preview entry 
		DECLARE @SetLocaleId INT , @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleId(), @MaxCount INT =0 , @IncrementalId INT = 1  
		DECLARE @TBL_Locale TABLE (LocaleId INT , RowId INT IDENTITY(1,1))
		
		IF object_id('tempdb..[#Tbl_NewVersionEntity]') IS NOT NULL
			drop table tempdb..#Tbl_NewVersionEntity
		Create Table #Tbl_NewVersionEntity(PublishCatalogId int , VersionId int , LocaleId int , PublishType varchar(50) )

		IF object_id('tempdb..[#Tbl_OldVersionEntity]') IS NOT NULL
			drop table tempdb..#Tbl_OldVersionEntity
		Create Table #Tbl_OldVersionEntity(PublishCatalogId int , NewVersionId int ,OldVersionId int , LocaleId int , PublishType varchar(50) )
		
		
		if @PublishCatalogId > 0 
		  
		  UPDATE ZPC SET CatalogName = ZC.CatalogName,ExternalId = ZC.ExternalId,PimCatalogId= @PimCatalogId,CreatedBy = @UserId,
					  CreatedDate = Getdate(),ModifiedBy = @UserId,ModifiedDate = Getdate()
					  FROM ZnodePublishCatalog ZPC 
					  INNER JOIN ZnodePimCatalog ZC ON(ZC.PimCatalogId = ZPC.PimCatalogId)
					  WHERE ZPC.PimCatalogId = @PimCatalogId;
		Else
		Begin
			INSERT INTO ZnodePublishCatalog (PimCatalogId,CatalogName,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT PimCatalogId,CatalogName,ExternalId,@UserId,Getdate(),@UserId,Getdate() FROM ZnodePimCatalog AS ZPC 
			WHERE ZPC.PimCatalogId = @PimCatalogId;
                      
			SET @PublishCatalogId = SCOPE_IDENTITY();
        End

		INSERT INTO @TBL_Locale (LocaleId) SELECT LocaleId FROM ZnodeLocale WHERE IsActive =1 --AND (LocaleId  = @LocaleId OR @LocaleId = 0 )
		SET @MaxCount = ISNULL((SELECT MAx(RowId) FROM @TBL_Locale),0)
		WHILE @IncrementalId <= @MaxCount
		BEGIN 
			SET @SetLocaleId = (SELECT Top 1 LocaleId FROM @TBL_locale WHERE RowId = @IncrementalId)
			If @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  )  
			Begin
				Insert into ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,
				IsCategoryPublished,PublishProductId,
				IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId)
				Select @PublishCatalogId,  @PimCatalogId,NULL,0,
				NULL,0,
				NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(), null ,@SetLocaleId ,DBO.Fn_GetPublishStateIdForProcessing() 

				insert into #Tbl_NewVersionEntity (PublishCatalogId,VersionId,LocaleId,PublishType)
				select @PublishCatalogId, @@Identity , @SetLocaleId ,'PREVIEW'
				
			End
			If (@RevisionState like '%Production%' OR @RevisionState = 'None')
			Begin
				--Genrate production entry 
				Insert into ZnodePublishCatalogLog
				(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,
					IsCategoryPublished,PublishProductId,
					IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId)
				Select @PublishCatalogId,  @PimCatalogId,NULL,0,
					NULL,0,
					NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(), null ,@SetLocaleId ,DBO.Fn_GetPublishStateIdForProcessing() 
			
				insert into #Tbl_NewVersionEntity (PublishCatalogId,VersionId,LocaleId,PublishType)
				select @PublishCatalogId, @@Identity , @SetLocaleId ,'PRODUCTION'
			End 
	   	SET @IncrementalId = @IncrementalId +1 
		END 
		Declare  @VersionIdString varchar(100)= ''  
		SELECT   @VersionIdString = STUFF((SELECT ',' + cast (VersionId as varchar(50))  FROM #Tbl_NewVersionEntity FOR XML PATH ('')), 1, 1, '') 
	
		Truncate table ZnodePublishCatalogErrorLogEntity
		

		Insert into #Tbl_OldVersionEntity (PublishCatalogId,NewVersionId,OldVersionId, LocaleId, PublishType)
		Select A.PublishCatalogId , A.VersionId, B.VersionId, a.LocaleId,a.PublishType 
		from #Tbl_NewVersionEntity A Inner join ZnodePublishVersionEntity B on 
		A.PublishCatalogId = B.ZnodeCatalogId and A.LocaleId = B.LocaleId AND A.PublishType= B.RevisionType  
	
		Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =5, 
			IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
			IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
			where  JobId = @NewGUID
	
	EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = @PublishCatalogId,@UserId = @UserId , @IsRevertPublish = 0 ,
	@NewGUID =@NewGUID 

	if @Type = 'ZnodePublishCatalogEntity' OR @Type = ''
	Begin
	
		Insert INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing)
		SELECT Distinct VE.VersionId, ZPC.PublishCatalogId, PC.CatalogName,VE.PublishType, VE.LocaleId, isnull(PC.IsAllowIndexing,0)
		FROM ZnodePublishCatalog ZPC
		INNER JOIN  #Tbl_NewVersionEntity VE ON (VE.PublishCatalogId = ZPC.PublishCatalogId)
		Inner join ZnodePimCatalog PC on ZPC.PimCatalogId = PC.PimCatalogId
		-- Data inserted into flat table ZnodeWebStoreEntity (Replica of MongoDB Collection )  
		
		If @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  ) 
		Begin
			Insert Into ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)
			SELECT VersionId,PublishCatalogId,PublishType,LocaleId,0 from  #Tbl_NewVersionEntity where PublishType = 'PREVIEW'
		End
		If (@RevisionState like '%Production%' OR @RevisionState = 'None')
		Begin
			Insert Into ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)
			SELECT VersionId,PublishCatalogId,PublishType,LocaleId,0 from  #Tbl_NewVersionEntity where PublishType = 'PRODUCTION'
		End

		INSERT INTO ZnodePublishCatalogErrorLogEntity
		(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
		SELECT 'ZnodePublishCatalogEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
		@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

	End

	If @Type = 'ZnodePublishCategoryEntity' OR @Type = ''
	Begin
		Exec [Znode_GetPublishCategoryJson]
				@PublishCatalogId = @PublishCatalogId ,
				@UserId =@UserId,														 
				@VersionIdString = @VersionIdString,
				@Status	 =@Status Out,
				@RevisionState = @RevisionState 
	
			INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ZnodePublishCategoryEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
			
			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =30, 
			IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
			IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
			where  JobId = @NewGUID

			If @Status  = 0 
			Begin
				SELECT 1 AS ID,@Status AS Status;
				Return 0 
			End
	End 
	
	If @Type = 'ZnodePublishProductEntity' OR @Type = ''
	Begin
		-- Process call catalog publish (include category, products with multiple types)
		Declare @PimProductId TransferId 
		EXEC [Znode_PublishLatestAssociatedProduct] @PublishCatalogId = @PublishCatalogId, @PimProductId = @PimProductId  , @UserId = @UserId , @PublishStateId =0 
		EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId= @PublishCatalogId ,@userid =@userid ,@PimProductId = @PimProductId 
		EXEC Znode_GetPublishProductJson 
			 @PublishCatalogId =@PublishCatalogId 
			,@PimProductId = @PimProductId 
			,@UserId = @userid
			,@PimCatalogId = @PimCatalogId 
			,@VersionIdString = @VersionIdString
			,@Status  =@Status  Out
			,@RevisionState = @RevisionState 
	
		
			INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ZnodePublishProductEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =50, 
			IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
			IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
			where  JobId = @NewGUID
			If @Status  = 1
			Begin
				update ZPCE SET ZPCE.ProductIds = 
				'[' +SUBSTRING((SELECT ','+CAST(PublishProductId AS VARCHAR(50))
				FROM ZnodePublishCategoryProduct ZPCP 
				WHERE ZPCP.PublishCategoryId = ZPCE.ZnodeCategoryId
				AND ZPCP.PublishCatalogId = ZPCE.ZnodeCatalogId  FOR XML PATH('')), 2, 8000) + ']' 
				FROM ZnodePublishCategoryEntity  ZPCE where ZPCE.ProductIds is null 
			End


		If @Status  = 0 
		Begin
			SELECT 1 AS ID,@Status AS Status;
			Return 0 
		End
	End
	If @Type = 'ZnodePublishAddOnEntity' OR @Type = ''
	Begin
		Exec [Znode_GetPublishAssociatedAddonsJson]
				@PublishCatalogId = @PublishCatalogId ,
				@PimProductId   = @PimProductId ,
				@UserId =@UserId,														 
				@VersionIdString = @VersionIdString,
				@RevisionType='',
				@Status	 =@Status Out

		
			INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ZnodePublishAddOnEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =52, 
			IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
			IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
			where  JobId = @NewGUID
			
			If @Status  = 0 
			Begin
				SELECT 1 AS ID,@Status AS Status;
				Return 0 
			End
	End 
	
	If @Type = 'BundleAssociatedProducts' OR @Type = ''
	Begin
			Exec [Znode_GetPublishAssociatedProductsJson]
				@PublishCatalogId = @PublishCatalogId ,
				@UserId =@UserId,														 
				@VersionIdString = @VersionIdString,
				@RevisionType = '',
				@Status	 =@Status Out,
				@ProductType    = 'BundleProduct'
		
			INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'BundleAssociatedProducts', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =54, 
			IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
			IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
			where  JobId = @NewGUID
			
			If @Status  = 0 
			Begin
				SELECT 1 AS ID,@Status AS Status;
				Return 0 
			End
	End 
	If @Type = 'GroupedAssociatedProducts' OR @Type = ''
	Begin
			Exec [Znode_GetPublishAssociatedProductsJson]
				@PublishCatalogId = @PublishCatalogId ,
				@UserId =@UserId,														 
				@VersionIdString = @VersionIdString,
				@RevisionType = '',
				@Status	 =@Status Out,
				@ProductType    = 'GroupedProduct'


		
			INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'GroupedAssociatedProducts', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
			
			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =56, 
			IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
			IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
			where  JobId = @NewGUID
			

			If @Status  = 0 
			Begin
				SELECT 1 AS ID,@Status AS Status;
				Return 0 
			End
	End 
	If @Type = 'ConfigurableAssociatedProducts' OR @Type = ''
	Begin
			Exec [Znode_GetPublishAssociatedProductsJson]
				@PublishCatalogId = @PublishCatalogId ,
				@UserId =@UserId,														 
				@VersionIdString = @VersionIdString,
				@RevisionType = '',
				@Status	 =@Status Out,
				@ProductType= 'ConfigurableProduct'

				
			INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ConfigurableAssociatedProducts', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =58, 
			IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
			IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
			where  JobId = @NewGUID
			

			If @Status  = 0 
			Begin
				SELECT 1 AS ID,@Status AS Status;
				Return 0 
			End
	End 
	If @Type = 'CatalogAttributeaDetail' OR @Type = ''
	Begin
		Begin Try
			Insert into [dbo].[#CatalogAttributeDetails]([ZnodeCatalogId],[AttributeCode],[AttributeTypeName],[IsComparable],
			[IsHtmlTags],[IsFacets],[IsUseInSearch],[IsPersonalizable],[IsConfigurable],[AttributeName],
			[LocaleId],[DisplayOrder],[DefaultValueDisplayOrder],[AttributeDefaultValue] )
			EXEC Znode_GetPublishProductAttribute @PublishCatalogId 
			
			insert into ZnodePublishCatalogAttributeEntity
			(VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition,IsComparable,
			IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,
			AttributeName,LocaleId,DisplayOrder,SelectValues)
			Select Distinct 
			B.VersionId, A.[ZnodeCatalogId],A.[AttributeCode],A.[AttributeTypeName],0 IsPromoRuleCondition,[IsComparable],
			[IsHtmlTags],[IsFacets],[IsUseInSearch],[IsPersonalizable],[IsConfigurable],
			[AttributeName],A.[LocaleId],[DisplayOrder] ,
			(Select Isnull(IA.AttributeDefaultValue,'') Value , Isnull(IA.[DefaultValueDisplayOrder],'') DisplayOrder  
			from [dbo].[#CatalogAttributeDetails] IA  where IA.AttributeCode = A.AttributeCode AND IA.LocaleId = A.LocaleId 
			For JSON PATH)
			FROM [dbo].[#CatalogAttributeDetails] A Inner join #Tbl_NewVersionEntity B on A.LocaleId = B.LocaleId
	
			SET @Status =1 
		
			INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'CatalogAttributeaDetail', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =60, 
			IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
			IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
			where  JobId = @NewGUID
			

		END TRY 
		BEGIN CATCH 
			SET @Status   = 0 
			
			INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'CatalogAttributeaDetail', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

			If @Status  = 0 
			Begin
				SELECT 1 AS ID,@Status AS Status;
				Return 0 
			End
		End CATCH  
	End 

	If @Type = 'ZnodePublishSEOEntity' OR @Type = ''
	Begin
		   EXEC [Znode_SetPublishSEOEntity]
			 @RevisionState = @RevisionState 
			,@CMSSEOTypeId  = '1,2' 
			,@UserId  = @UserId 
			,@Status  = @Status  OUTPUT 
			,@IsCatalogPublish = 1  
			,@VersionIdString  = @VersionIdString 
			,@IsPreviewEnable  = @IsPreviewEnable 
			
	
			INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ZnodePublishSEOEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =70, 
			IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
			IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
			where  JobId = @NewGUID

			If @Status  = 0 
			Begin
				SELECT 1 AS ID,@Status AS Status;
				Return 0 
			End

	End 

	IF Exists (select TOP 1 1  from ZnodePublishCatalogErrorLogEntity where  ProcessStatus = 'Fail') 
		Begin
		
			SET @Status  =0 
			SELECT 1 AS ID,@Status AS Status;
			INSERT INTO ZnodePublishCatalogErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ZnodePublishPortalEntity', @RevisionState , 'Fail' , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
			
			EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = @PublishCatalogId,@UserId = @UserId , @IsRevertPublish = 0 ,
			@NewGUID =@NewGUID 

			Update ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed(),
			IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0, ModifiedDate = Getdate()
			  where PublishCatalogLogId in  (Select VersionId from #Tbl_NewVersionEntity Where PublishType = 'PREVIEW' )
			Update ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed(),
			IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0
			, ModifiedDate = Getdate()  where PublishCatalogLogId in (Select VersionId from #Tbl_NewVersionEntity Where PublishType = 'PRODUCTION' )
			
			Return 0 
		End

	SET @Status = 1

		
	SELECT @PublishCatalogId AS id,@Status AS Status;   
	END
END TRY 
BEGIN CATCH 
	SET @Status =0  
	 SELECT 1 AS ID,@Status AS Status;   
	
	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity 
		@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR	(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))
		+',@PreviewVersionId = ' + CAST(@PreviewVersionId  AS varchar(20))
		+',@ProductionVersionId = ' + CAST(@ProductionVersionId  AS varchar(20))
		+',@RevisionState = ''' + CAST(@RevisionState  AS varchar(50))
		+',@UserId = ' + CAST(@UserId AS varchar(20));	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
	
			
	INSERT INTO ZnodePublishCatalogErrorLogEntity
	(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
	SELECT 'Znode_PublishCatalogEntity', @RevisionState + isnull(@ErrorMessage,'') , 'Fail' , Getdate(), 
	@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
	
	EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = @PublishCatalogId,@UserId = @UserId , @IsRevertPublish = 0 ,
	@NewGUID =@NewGUID 

	Update ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed(),
	IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0 , ModifiedDate = Getdate()   where  PublishCatalogLogId in 
	(Select VersionId from #Tbl_NewVersionEntity Where PublishType = 'PREVIEW' )
	Update ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed() ,
	IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0 , ModifiedDate = Getdate() where  PublishCatalogLogId in
	(Select VersionId from #Tbl_NewVersionEntity Where PublishType = 'PRODUCTION' )
		                			 
	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_PublishCatalogEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeleteGlobalAttribute')
	DROP PROC Znode_DeleteGlobalAttribute

GO

CREATE PROCEDURE [dbo].[Znode_DeleteGlobalAttribute](
       @GlobalAttributeId VARCHAR(300) = NULL ,
       @Status         INT OUT,
	   @GlobalAttributeIds TransferId READONLY, 
	   @IsForceFullyDelete BIT =0   )
AS 
    -----------------------------------------------------------------------------
    --Summary:  Remove GlobalAttribute still in used 
    --		   	
    --          
    --Unit Testing   
	--Begin Transaction 
		--DECLARE @Status INT  EXEC Znode_DeleteGlobalAttribute @GlobalAttributeId = '59,60,61,62' ,@Status=@Status OUT  SELECT @Status
		--select * from ZnodeGlobalAttributeValue where GlobalAttributeId in (59,60,61,62)
		--select * from ZnodeGlobalAttribute where AttributeCode in ( 'SpecValue','TempSettings','UPCcode', 'ratest') 	
	--Rollback Transaction 
    ----------------------------------------------------------------------------- 


     BEGIN
         BEGIN TRY
             SET NOCOUNT ON;
             BEGIN TRAN A;
			 DECLARE @FinalCount INT =0 
             DECLARE @DeletdAttributeId TABLE (
                                              GlobalAttributeId INT
                                              );
            INSERT INTO @DeletdAttributeId
                    SELECT Item
                    FROM dbo.split ( @GlobalAttributeId , ','
                                   ) AS a 
					INNER JOIN ZnodeGlobalAttribute AS B ON ( CAST(a.item AS INT )  = b.GlobalAttributeId )
					Where 
					not exists(  Select 1 
					from ZnodeGlobalAttributeGroupMapper dd
					where dd.GlobalAttributeId =b.GlobalAttributeId)
					and ISNULL(b.IsSystemDefined,0) <> 1
             		AND @GlobalAttributeId <> ''
			 INSERT INTO  @DeletdAttributeId 
				 SELECT id 
                    FROM @GlobalAttributeIds AS a 
					INNER JOIN ZnodeGlobalAttribute AS B ON ( a.Id = b.GlobalAttributeId )
					AND ISNULL(b.IsSystemDefined,0) <> 1
			       
             DELETE FROM ZnodeGlobalAttributeLocale
             WHERE EXISTS ( SELECT 1
                            FROM @DeletdAttributeId AS sd
                            WHERE sd.GlobalAttributeId = ZnodeGlobalAttributeLocale.GlobalAttributeId
                          );
             DELETE FROM ZnodeGlobalAttributeValidation
             WHERE EXISTS ( SELECT 1
                            FROM @DeletdAttributeId AS sd
                            WHERE sd.GlobalAttributeId = ZnodeGlobalAttributeValidation.GlobalAttributeId
                          );

			 DELETE FROM ZnodeGlobalAttributeValueLocale 
             WHERE EXISTS ( SELECT 1
                            FROM @DeletdAttributeId AS sd Inner join ZnodeGlobalAttributeValue AS zpav ON sd.GlobalAttributeId=zpav.GlobalAttributeId
                            WHERE zpav.GlobalAttributeValueId = ZnodeGlobalAttributeValueLocale.GlobalAttributeValueId);

             DELETE FROM ZnodeGlobalAttributeValue
             WHERE EXISTS ( SELECT 1
                            FROM @DeletdAttributeId AS sd
                            WHERE sd.GlobalAttributeId = ZnodeGlobalAttributeValue.GlobalAttributeId
                          );
			 DELETE FROM ZnodeGlobalAttributeDefaultValueLocale
             WHERE EXISTS ( SELECT 1
                            FROM ZnodeGlobalAttributeDefaultValue
                            WHERE EXISTS ( SELECT 1
                                           FROM @DeletdAttributeId AS sd
                                           WHERE sd.GlobalAttributeId = ZnodeGlobalAttributeDefaultValue.GlobalAttributeId
                                         )
                                  AND
                                  ZnodeGlobalAttributeDefaultValueLocale.GlobalAttributeDefaultValueId = ZnodeGlobalAttributeDefaultValue.GlobalAttributeDefaultValueId
                          );
           
		    DELETE ZA FROM ZnodePortalGlobalAttributeValueLocale ZA  INNER JOIN ZnodePortalGlobalAttributeValue dg ON (dg.PortalGlobalAttributeValueId = ZA.PortalGlobalAttributeValueId) 
			 WHERE EXISTS ( SELECT 1
                                           FROM @DeletdAttributeId AS sd
                                           WHERE sd.GlobalAttributeId = dg.GlobalAttributeId
                                         )
			 DELETE FROM ZnodePortalGlobalAttributeValue 
			 WHERE EXISTS ( SELECT 1
                                           FROM @DeletdAttributeId AS sd
                                           WHERE sd.GlobalAttributeId = ZnodePortalGlobalAttributeValue.GlobalAttributeId
                                         )
           	 DELETE ZA FROM  ZnodeFormBuilderGlobalAttributeValueLocale	ZA INNER JOIN ZnodeFormBuilderGlobalAttributeValue dg ON (dg.FormBuilderGlobalAttributeValueId = ZA.FormBuilderGlobalAttributeValueId) 
			  WHERE EXISTS ( SELECT 1
                                           FROM @DeletdAttributeId AS sd
                                           WHERE sd.GlobalAttributeId = dg.GlobalAttributeId
                                         )
			 DELETE FROM ZnodeFormBuilderGlobalAttributeValue
			  WHERE EXISTS ( SELECT 1
                                           FROM @DeletdAttributeId AS sd
                                           WHERE sd.GlobalAttributeId = ZnodeFormBuilderGlobalAttributeValue.GlobalAttributeId
                                         )
			 DELETE FROM ZnodeFormBuilderAttributeMapper
			   WHERE EXISTS ( SELECT 1
                                           FROM @DeletdAttributeId AS sd
                                           WHERE sd.GlobalAttributeId = ZnodeFormBuilderAttributeMapper.GlobalAttributeId
                                         )


			 DELETE FROM ZnodeGlobalAttributeDefaultValue
             WHERE EXISTS ( SELECT 1
                            FROM @DeletdAttributeId AS sd
                            WHERE sd.GlobalAttributeId = ZnodeGlobalAttributeDefaultValue.GlobalAttributeId
                          );
			 DELETE ZA FROM ZnodeUserGlobalAttributeValueLocale ZA INNER JOIN ZnodeUserGlobalAttributeValue dg ON (dg.UserGlobalAttributeValueId = ZA.UserGlobalAttributeValueId) 
			    WHERE EXISTS ( SELECT 1
                            FROM @DeletdAttributeId AS sd
                            WHERE sd.GlobalAttributeId = dg.GlobalAttributeId
                          );
			 DELETE FROM ZnodeUserGlobalAttributeValue 
			  WHERE EXISTS ( SELECT 1
                            FROM @DeletdAttributeId AS sd
                            WHERE sd.GlobalAttributeId = ZnodeUserGlobalAttributeValue.GlobalAttributeId
                          );	
						  
		     DELETE FROM ZnodeAccountGlobalAttributeValueLocale WHERE AccountGlobalAttributeValueId IN (SELECT AccountGlobalAttributeValueId FROM ZnodeAccountGlobalAttributeValue WHERE EXISTS ( SELECT 1
                            FROM @DeletdAttributeId AS sd
                            WHERE sd.GlobalAttributeId = ZnodeAccountGlobalAttributeValue.GlobalAttributeId
                          ) )		  


			 DELETE FROM ZnodeAccountGlobalAttributeValue  WHERE EXISTS ( SELECT TOP 1 1
                            FROM @DeletdAttributeId AS sd
                            WHERE sd.GlobalAttributeId = ZnodeAccountGlobalAttributeValue.GlobalAttributeId
                          ) 		  	
						  						  						  
									  		  
			DELETE FROM ZnodeGlobalAttributeGroupMapper  
				 WHERE EXISTS ( SELECT 1
                            FROM @DeletdAttributeId AS sd
                            WHERE sd.GlobalAttributeId = ZnodeGlobalAttributeGroupMapper.GlobalAttributeId
                          );	
						  
			DELETE FROM ZnodeWidgetGlobalAttributeValueLocale
			WHERE EXISTS(SELECT * FROM ZnodeWidgetGlobalAttributeValue
						 WHERE EXISTS ( SELECT 1FROM @DeletdAttributeId AS sd
                            WHERE sd.GlobalAttributeId = ZnodeWidgetGlobalAttributeValue.GlobalAttributeId
                          ) AND ZnodeWidgetGlobalAttributeValueLocale.WidgetGlobalAttributeValueId = ZnodeWidgetGlobalAttributeValue.WidgetGlobalAttributeValueId);
			
			DELETE FROM ZnodeWidgetGlobalAttributeValue
			WHERE EXISTS ( SELECT 1
                            FROM @DeletdAttributeId AS sd
                            WHERE sd.GlobalAttributeId = ZnodeWidgetGlobalAttributeValue.GlobalAttributeId
                          );

             DELETE FROM ZnodeGlobalAttribute
             WHERE EXISTS ( SELECT 1
                            FROM @DeletdAttributeId AS sd
                            WHERE sd.GlobalAttributeId = ZnodeGlobalAttribute.GlobalAttributeId
                          );
              SET @FinalCount = 	( SELECT COUNT(1) FROM dbo.split ( @GlobalAttributeId , ',')   AS a WHERE @GlobalAttributeId <> '')
			 SET @FinalCount = 	CASE WHEN @FinalCount = 0 OR @FinalCount IS nULL  THEN  ( SELECT COUNT(1) FROM @GlobalAttributeIds AS a ) ELSE   @FinalCount END 
			
			

			 IF ( SELECT COUNT(1)
                  FROM @DeletdAttributeId
                ) = @FinalCount
                 BEGIN
                     SELECT 1 AS ID , CAST(1 AS BIT) AS Status;
                 END;
             ELSE
                 BEGIN
                     SELECT 0 AS ID , CAST(0 AS BIT) AS Status;
                 END;
             SET @Status = 1;
             COMMIT TRAN A;
         END TRY
         BEGIN CATCH
             SELECT 0 AS ID , CAST(0 AS BIT) AS Status;
             SELECT ERROR_MESSAGE() , ERROR_LINE() , ERROR_PROCEDURE();
             SET @Status = 0;
             ROLLBACK TRAN A;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeleteMedia')
	DROP PROC Znode_DeleteMedia

GO

CREATE PROCEDURE [dbo].[Znode_DeleteMedia]
( @MediaId VARCHAR(2000)= '',
  @Status  BIT           = 1 OUT,
  @MediaIds TransferId READONLY ,
  @IsCallInternal BIT = 0 )
AS
/*
   
     Summary : Remove media with their reference data 
			   This Procedure is used to check the media is associated to the product or not 
			   If passed @MediaIds are matched with deleted count then data set return true other wise false 
			   dbo.Split function use to make comma separeted data in table rows 
			   1 ZnodeMediaAttributeValue
			   2 ZnodeMediaCategory
			   3 ZnodeMedia
     Unit Testing 
	 begin tran
     Declare @Status bit 
     EXEC Znode_DeleteMedia 32,@Status= @Status
	 rollback tran
  
*/
     BEGIN
         BEGIN TRAN DeleteMedia;
         BEGIN TRY 

             ----- Declare the variable table for store the comma separeted value in row
          
             --- this is for media path with server 
             DECLARE @TBL_MediaIds TABLE(MediaId INT);
             DECLARE @TBL_DeletedMediaId TABLE
             (
			  MediaId   INT,
              MediaPath VARCHAR(3000),
			  MediaConfigurationId INT
             );
             DECLARE @TBL_DeletedMediaId_forOther TABLE
             (MediaId   INT,
              MediaPath VARCHAR(3000),
			   MediaConfigurationId INT
             );
			 -- dbo.Split function use to make comma separeted data in table rows
             INSERT INTO @TBL_MediaIds(MediaId)
                    SELECT Item
                    FROM dbo.Split(@MediaId, ','  
                    ) AS a
					WHERE @MediaId <> '';
			 
			 INSERT INTO @TBL_MediaIds
			 SELECT	id 
			 FROM @MediaIds 

             INSERT INTO @TBL_DeletedMediaId_forOther
                    SELECT zm.MediaId,
                           zm.[Path],
						   zm.MediaConfigurationId
                    FROM ZnodeMedia AS zm
                         INNER JOIN @TBL_MediaIds AS tm ON(tm.MediaId = zm.MediaId);

             /*------------------------------------------------------This code comment after requirment change ---------------------------------------------------------*/

             /*		   WHERE NOT EXISTS (SELECT TOP 1 1  																											   */

             /*         FROM  ZnodePimAttribute a 																													   */

             /*         INNEr JOIN ZnodeAttributeType b ON (a.AttributeTypeId   = b.AttributeTypeId )																   */

             /*         INNER JOIN ZnodePimAttributeValue c ON (c.PimAttributeId = a.PimAttributeId) 																   */

             /*         INNER JOIN ZnodePimAttributeValueLocale d on( d.PimAttributeValueId= c.PimAttributeValueId )												   */

             /*         WHERE EXISTS (SELECT TOP 1 1 FROM dbo.split(d.AttributeValue , ',')  qw WHERE qw.Item = CAST(zm.MediaId AS VARCHAr(1000))	)				   */

             /*         AND b.AttributeTypeName IN ('Image','File','Audio','Video'))	 																			   */

             /*         AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimProductImage zpi  WHERE zpi.MediaId = zm.MediaId)												   */

             /*         AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSPortalTheme zct WHERE zct.MediaId = zm.MediaId)												   */

             /*         -- when its complicated to handle all where conditions within single query 																	   */

             -------------------------------------------------------------------------------------------------------------------------------------------------------------
             INSERT INTO @TBL_DeletedMediaId
                    SELECT MediaId,
                           MediaPath,
						    MediaConfigurationId 
                    FROM @TBL_DeletedMediaId_forOther AS zm;

             /*------------------------------------------------------This code commented after requirment change ---------------------------------------------------------*/

             /*        WHERE NOT EXISTS (SELECT TOP 1 1																												*/

             /*        FROM  ZnodePimAttribute a 																														*/

             /*        INNEr JOIN ZnodeAttributeType b ON (a.AttributeTypeId   = b.AttributeTypeId )																	*/

             /*        INNER JOIN ZnodePimCategoryAttributeValue c ON (c.PimAttributeId = a.PimAttributeId) 															*/

             /*        INNER JOIN ZnodePimCategoryAttributeValueLocale d on( d.PimCategoryAttributeValueId= c.PimCategoryAttributeValueId )							*/

             /*        WHERE EXISTS (SELECT TOP 1 1 FROM dbo.split(d.CategoryValue , ',')  qw WHERE qw.Item = CAST(zm.MediaId AS VARCHAr(1000))	)					*/

             /*        AND b.AttributeTypeName IN ('Image','File','Audio','Video'))																					*/

             /*        AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimGlobalDisplaySetting zpg WHERE zpg.MediaId = zm.MediaId)											*/

             /*        AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSWidgetTitleConfiguration zcwtc WHERE zcwtc.mediaId = zm.MediaId)									*/

             /*        AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSliderBanner zcb WHERE zcb.MediaId = zm.MediaId)													*/

             /*        --- Above conditions check the media are associated with product or portal or theme if associated the n not deleted other wise deleted			*/

             ------------------------------------------------------------------------------------------------------------------------------------------------------------

             DELETE FROM ZnodeMediaAttributeValue
             WHERE EXISTS
             (
                 SELECT TOP 1 1
                 FROM ZnodeMediaCategory AS zmc
                 WHERE EXISTS
                 (
                     SELECT TOP 1 1
                     FROM @TBL_DeletedMediaId AS td
                     WHERE td.mediaId = zmc.MediaId
                 )
                       AND zmc.MediaCategoryId = ZnodeMediaAttributeValue.MediaCategoryId
             );
             DELETE FROM ZnodeMediaCategory
             WHERE EXISTS
             (
                 SELECT TOP 1 1
                 FROM @TBL_DeletedMediaId AS td
                 WHERE td.mediaId = ZnodeMediaCategory.MediaId
             );
			 DELETE FROM ZnodeBlogNewsContent WHERE BlogNewsId IN (SELECT BlogNewsId FROM ZnodeBlogNews
             WHERE EXISTS
             (
                 SELECT TOP 1 1
                 FROM @TBL_DeletedMediaId AS td
                 WHERE td.mediaId = ZnodeBlogNews.MediaId
             ))
			 DELETE FROM ZnodeBlogNewsCommentLocale WHERE BlogNewsCommentId IN (SELECT BlogNewsCommentId 
			 FROM ZnodeBlogNewsComment WHERE BlogNewsId IN (SELECT BlogNewsId FROM ZnodeBlogNews
             WHERE EXISTS
             (
                 SELECT TOP 1 1
                 FROM @TBL_DeletedMediaId AS td
                 WHERE td.mediaId = ZnodeBlogNews.MediaId
             )))
			 DELETE FROM ZnodeBlogNewsComment WHERE BlogNewsId IN (SELECT BlogNewsId FROM ZnodeBlogNews
             WHERE EXISTS
             (
                 SELECT TOP 1 1
                 FROM @TBL_DeletedMediaId AS td
                 WHERE td.mediaId = ZnodeBlogNews.MediaId
             ))
			 DELETE FROM ZnodeBlogNewsLocale WHERE BlogNewsId IN (SELECT BlogNewsId FROM ZnodeBlogNews
             WHERE EXISTS
             (
                 SELECT TOP 1 1
                 FROM @TBL_DeletedMediaId AS td
                 WHERE td.mediaId = ZnodeBlogNews.MediaId
             ))
			  
			 DELETE FROM ZnodeBlogNews
             WHERE EXISTS
             (
                 SELECT TOP 1 1
                 FROM @TBL_DeletedMediaId AS td
                 WHERE td.mediaId = ZnodeBlogNews.MediaId
             );

			 DELETE FROM ZnodeCMSMediaConfiguration
			  WHERE EXISTS
             (
                 SELECT TOP 1 1
                 FROM @TBL_DeletedMediaId AS td
                 WHERE td.mediaId = ZnodeCMSMediaConfiguration.MediaId
             );

			 DELETE FROM ZnodeWidgetGlobalAttributeValueLocale
			 WHERE EXISTS
             (
                 SELECT TOP 1 1
                 FROM @TBL_DeletedMediaId AS td
                 WHERE td.mediaId = ZnodeWidgetGlobalAttributeValueLocale.MediaId
             );

             DELETE FROM ZnodeMedia
             WHERE EXISTS
             (
                 SELECT TOP 1 1
                 FROM @TBL_DeletedMediaId AS td
                 WHERE td.mediaId = ZnodeMedia.MediaId
             );

             IF
             (
                 SELECT COUNT(1)
                 FROM @TBL_MediaIds
             ) =
             (
                 SELECT COUNT(1)
                 FROM @TBL_DeletedMediaId -- here check if count of both table are same then its return true other wise false 
             )
                 BEGIN
				     IF @IsCallInternal =1 
					 BEGIN 
					  SELECT 0 id  , '' MessageDetail, 1 Status 
					 END 
                     SELECT MediaId Id ,
                            MediaPath MessageDetails  ,
						   CAST(1 AS BIT) AS [Status]
                     FROM @TBL_DeletedMediaId TBLD
				    SET @Status = 1;
                 END
             ELSE  
                 BEGIN
				     IF @IsCallInternal =1 
					 BEGIN 
					  SELECT 0 id  , '' MessageDetail, 0 Status 
					 END
                     SELECT MediaId Id ,
                            MediaPath MessageDetails,
                            CAST(0 AS BIT) AS [Status]
                     FROM @TBL_DeletedMediaId;
                     SET @Status = 0;
                 END;
             COMMIT TRAN DeleteMedia;
         END TRY
         BEGIN CATCH
		     SELECT ERROR_MESSAGE()
             DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
		    @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeleteMedia @MediaId = '+@MediaId+',
		    @Status='+CAST(@Status AS VARCHAR(50));
             SELECT 1 AS ID,
                    '' AS [MessageDetails],
                    CAST(0 AS BIT) AS [Status];
             SET @Status = 0;
             ROLLBACK TRAN DeleteMedia;
             EXEC Znode_InsertProcedureErrorLog
                  @ProcedureName = 'Znode_DeleteMedia',
                  @ErrorInProcedure = @Error_procedure,
                  @ErrorMessage = @ErrorMessage,
                  @ErrorLine = @ErrorLine,
                  @ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeleteOrderById')
	DROP PROC Znode_DeleteOrderById

GO

CREATE PROCEDURE [dbo].[Znode_DeleteOrderById]
(@OrderDetailId INT = 0 ,
 @Status   BIT OUT,
 @OmsOrderIds TransferId READONLY 

)
AS

/*
begin tran
exec Znode_DeleteOrderById 6
rollback tran
*/
BEGIN
  SET NOCOUNT ON
   BEGIN  TRAN DeleteOrderById
  BEGIN TRY 
		   	DECLARE @OmsOrderId TABLE (OmsOrderId INT ) 
			DECLARE @OmsOrderDetailsId TABLE (OmsOrderDetailsId  INT ) 
			
			INSERT INTO  @OmsOrderId 
			SELECT Id 
			FROM  @OmsOrderIds


			Insert into @OmsOrderId
				Select OmsOrderId from ZnodeOmsOrderDetails a
				Where OmsOrderDetailsId = @OrderDetailId and not exists 
				(select * from @OmsOrderId b where b.OmsOrderId = a.OmsOrderId)


			INSERT INTO @OmsOrderDetailsId 
			SELECT OmsOrderDetailsId 
			FROM ZnodeOmsOrderDetails  ZP 
			WHERE (OmsOrderDetailsId = @OrderDetailId OR 
			EXISTS (SELECT TOP 1 1  FROM @OmsOrderId WHERE OmsOrderId = ZP.OmsOrderId)  ) 

			
			DECLARE @TBL_OmsOrderLineItems TABLE (OmsOrderLineItemsId INT,OmsOrderShipmentId INT, OmsOrderDetailsId INT)
			INSERT INTO @TBL_OmsOrderLineItems
			SELECT OmsOrderLineItemsId,OmsOrderShipmentId, OmsOrderDetailsId 
			FROM ZnodeOmsOrderLineItems S 
			WHERE EXISTS (SELECT TOP 1 1 FROM @OmsOrderDetailsId TR WHERE TR.OmsOrderDetailsId = S.OmsOrderDetailsId )
			DELETE FROM ZnodeOmsOrderAttribute WHERE EXISTS (SELECT OmsOrderLineItemsId FROM @TBL_OmsOrderLineItems )
			DELETE FROM ZnodeOmsOrderDiscount WHERE EXISTS (SELECT OmsOrderLineItemsId FROM @TBL_OmsOrderLineItems TY WHERE TY.OmsOrderDetailsId = ZnodeOmsOrderDiscount.OmsOrderDetailsId   or TY.OmsOrderLineItemsId = ZnodeOmsOrderDiscount.OmsOrderLineItemId  )
			DELETE FROM ZnodeOmsOrderWarehouse WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_OmsOrderLineItems TBLOLI WHERE TBLOLI.OmsOrderLineItemsId = ZnodeOmsOrderWarehouse.OmsOrderLineItemsId  )
			DELETE FROM ZnodeRmaRequestItem WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_OmsOrderLineItems TBLOLI WHERE TBLOLI.OmsOrderLineItemsId = ZnodeRmaRequestItem.OmsOrderLineItemsId  )
			DELETE FROM ZnodeOmsOrderLineItemsAdditionalCost WHERE EXISTS ( SELECT TOP 1 1 FROM 
			ZnodeOmsOrderLineItems WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_OmsOrderLineItems TBLOLI WHERE TBLOLI.OmsOrderDetailsId = ZnodeOmsOrderLineItems.OmsOrderDetailsId)
			AND ZnodeOmsOrderLineItems.OmsOrderLineItemsId = ZnodeOmsOrderLineItemsAdditionalCost.OmsOrderLineItemsId)

			DELETE FROM ZnodeOmsDownloadableProductKey
			WHERE EXISTS(SELECT * FROM ZnodeOmsOrderLineItems WHERE EXISTS (SELECT TOP 1 1 FROM @OmsOrderDetailsId rt WHERE rt.OmsOrderDetailsId =ZnodeOmsOrderLineItems.OmsOrderDetailsId)
						AND ZnodeOmsDownloadableProductKey.OmsOrderLineItemsId = ZnodeOmsOrderLineItems.OmsOrderLineItemsId)

			DELETE FROM ZnodeOmsPersonalizeItem WHERE EXISTS (SELECT TOP 1 1  FROM @TBL_OmsOrderLineItems TBLOLI WHERE TBLOLI.OmsOrderLineItemsId = ZnodeOmsPersonalizeItem.OmsOrderLineItemsId)
		   	DELETE FROM ZnodeOmsTaxOrderLineDetails WHERE EXISTS (SELECT TOP 1 1  FROM @TBL_OmsOrderLineItems TBLOLI WHERE TBLOLI.OmsOrderLineItemsId = ZnodeOmsTaxOrderLineDetails.OmsOrderLineItemsId)
		   	DELETE FROM znodeGiftCardHistory WHERE EXISTS (SELECT TOP 1 1 FROM @OmsOrderDetailsId rt WHERE rt.OmsOrderDetailsId =znodeGiftCardHistory.OmsOrderDetailsId)
		   	DELETE FROM znodeOmsEmailHistory WHERE EXISTS (SELECT TOP 1 1 FROM @OmsOrderDetailsId rt WHERE rt.OmsOrderDetailsId =znodeOmsEmailHistory.OmsOrderDetailsId)
		   	DELETE FROM ZnodeOmsReferralCommission WHERE EXISTS (SELECT TOP 1 1 FROM @OmsOrderDetailsId rt WHERE rt.OmsOrderDetailsId =ZnodeOmsReferralCommission.OmsOrderDetailsId)
		   	DELETE FROM ZnodeOmsTaxOrderDetails WHERE EXISTS (SELECT TOP 1 1 FROM @OmsOrderDetailsId rt WHERE rt.OmsOrderDetailsId =ZnodeOmsTaxOrderDetails.OmsOrderDetailsId)
			DELETE FROM ZnodeOmsHistory   WHERE EXISTS (SELECT TOP 1 1 FROM @OmsOrderDetailsId rt WHERE rt.OmsOrderDetailsId =ZnodeOmsHistory.OmsOrderDetailsId)
			DELETE FROM znodeOmsNotes WHERE EXISTS (SELECT TOP 1 1 FROM @OmsOrderDetailsId rt WHERE rt.OmsOrderDetailsId =znodeOmsNotes.OmsOrderDetailsId)
			DELETE FROM ZnodeOmsOrderLineItems WHERE EXISTS (SELECT TOP 1 1 FROM @OmsOrderDetailsId TBLOLI WHERE TBLOLI.OmsOrderDetailsId = ZnodeOmsOrderLineItems.OmsOrderDetailsId)
			DELETE FROM ZnodeOmsOrderShipment WHERE EXISTS (SELECT TOP 1 1  FROM @TBL_OmsOrderLineItems TBLOLI WHERE TBLOLI.OmsOrderShipmentId = ZnodeOmsOrderShipment.OmsOrderShipmentId )
		   	DELETE FROM ZnodeOmsCustomerShipping WHERE EXISTS(SELECT TOP 1 1  FROM @TBL_OmsOrderLineItems TBLOLI WHERE TBLOLI.OmsOrderDetailsId =ZnodeOmsCustomerShipping.OmsOrderDetailsId)
			DELETE FROM ZnodeOmsOrderDetails  WHERE EXISTS (SELECT TOP 1 1 FROM @OmsOrderDetailsId rt WHERE rt.OmsOrderDetailsId =ZnodeOmsOrderDetails.OmsOrderDetailsId)
		   	DELETE FROM ZnodeOmsOrder WHERE EXISTS (SELECT TOP 1 1  FROM @OmsOrderId T WHERE T.OmsOrderId = ZnodeOmsOrder.OmsOrderId)
        

		SELECT 1 AS ID , CAST(1 AS BIT) AS Status;

        SET @Status = 1;    
		 COMMIT  TRAN DeleteOrderById
	END TRY
	BEGIN CATCH
	   SELECT ERROR_MESSAGE	()
	   SELECT 0 AS ID , CAST(0 AS BIT) AS Status;
	SET @Status = 0;
		ROLLBACK TRAN DeleteOrderById
	SELECT ERROR_MESSAGE()
	END CATCH

END

GO

IF NOT EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME = 'CreatedBy' AND TABLE_NAME = 'ZnodeCMSWidgetProfileVariant')
BEGIN
	ALTER TABLE ZnodeCMSWidgetProfileVariant ADD [CreatedBy] INT    NULL
END
GO
IF NOT EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME = 'CreatedDate' AND TABLE_NAME = 'ZnodeCMSWidgetProfileVariant')
BEGIN
	ALTER TABLE ZnodeCMSWidgetProfileVariant ADD [CreatedDate] DATETIME    NULL
END
GO
IF NOT EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME = 'ModifiedBy' AND TABLE_NAME = 'ZnodeCMSWidgetProfileVariant')
BEGIN
	ALTER TABLE ZnodeCMSWidgetProfileVariant ADD ModifiedBy INT    NULL
END
GO
IF NOT EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME = 'ModifiedDate' AND TABLE_NAME = 'ZnodeCMSWidgetProfileVariant')
BEGIN
	ALTER TABLE ZnodeCMSWidgetProfileVariant ADD ModifiedDate DATETIME    NULL
END

GO


IF EXISTS (SELECT * 
  FROM sys.foreign_keys 
   WHERE object_id = OBJECT_ID(N'FK_ZnodeCMSWidgetProfileLocale_ZnodeLocale')
   AND parent_object_id = OBJECT_ID(N'dbo.ZnodeCMSWidgetProfileVariant')
)
BEGIN
	ALTER TABLE [dbo].[ZnodeCMSWidgetProfileVariant] DROP CONSTRAINT [FK_ZnodeCMSWidgetProfileLocale_ZnodeLocale]
END

GO

IF EXISTS (SELECT * 
  FROM sys.foreign_keys 
   WHERE object_id = OBJECT_ID(N'FK_ZnodeCMSWidgetProfileLocale_ZnodeCMSWidgetTemplate')
   AND parent_object_id = OBJECT_ID(N'dbo.ZnodeCMSWidgetProfileVariant')
)
BEGIN
	ALTER TABLE [dbo].[ZnodeCMSWidgetProfileVariant] DROP CONSTRAINT [FK_ZnodeCMSWidgetProfileLocale_ZnodeCMSWidgetTemplate]
END

GO

IF EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'LocaleId'
AND Object_ID = Object_ID(N'dbo.ZnodeCMSWidgetProfileVariant'))
BEGIN
	ALTER TABLE ZnodeCMSWidgetProfileVariant DROP COLUMN LocaleId
END

GO

IF EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'CMSWidgetTemplateId'
AND Object_ID = Object_ID(N'dbo.ZnodeCMSWidgetProfileVariant'))
BEGIN
	ALTER TABLE ZnodeCMSWidgetProfileVariant DROP COLUMN CMSWidgetTemplateId
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'PortalId'
AND Object_ID = Object_ID(N'dbo.ZnodeCMSWidgetProfileVariant'))
BEGIN
	ALTER TABLE ZnodeCMSWidgetProfileVariant ADD PortalId INT;
END

GO

IF EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'CreatedBy'
AND Object_ID = Object_ID(N'dbo.ZnodeCMSWidgetProfileVariant'))
BEGIN
	ALTER TABLE ZnodeCMSWidgetProfileVariant ALTER COLUMN [CreatedBy] INT NULL
END

GO

IF EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'CreatedDate'
AND Object_ID = Object_ID(N'dbo.ZnodeCMSWidgetProfileVariant'))
BEGIN
	ALTER TABLE ZnodeCMSWidgetProfileVariant ALTER COLUMN [CreatedDate] DATETIME       NULL
END

IF EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'ModifiedBy'
AND Object_ID = Object_ID(N'dbo.ZnodeCMSWidgetProfileVariant'))
BEGIN
	ALTER TABLE ZnodeCMSWidgetProfileVariant ALTER COLUMN [ModifiedBy] INT       NULL
END

GO

IF EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'ModifiedDate'
AND Object_ID = Object_ID(N'dbo.ZnodeCMSWidgetProfileVariant'))
BEGIN
	ALTER TABLE ZnodeCMSWidgetProfileVariant ALTER COLUMN [ModifiedDate] DATETIME       NULL
END

GO


IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeleteProfile')
	DROP PROC Znode_DeleteProfile

GO

CREATE PROCEDURE [dbo].[Znode_DeleteProfile]
( @ProfileId VARCHAR(2000),
  @Status    INT OUT
 , @IsForceFullyDelete BIT = 0 )
AS 
   /*
     Summary : Remove profile only when this is not mapped with other entity 
     Check existence of profileid in other tables 
    1. ZnodeShipping
    2. ZnodeUserProfile
    3. ZnodePriceListProfile
    4. ZnodeProfilePromotion  ( Remove table ) 
    5. ZnodePortalProfile
    Unit Testing : 
	BEGIN TRAN
    Declare @Status  int 
    Exec [Znode_DeleteProfile]  @ProfileId =  ,@Status = @Status  oUt
    ROLLBACK TRAN
   */
     BEGIN
         BEGIN TRY
             SET NOCOUNT ON;
             BEGIN TRAN A;
             DECLARE @DeleteProfileId TABLE(ProfileId INT);
             INSERT INTO @DeleteProfileId
                    SELECT Item
                    FROM dbo.split(@ProfileId, ',') AS a
					WHERE @ProfileId <> '' 
					;
             DECLARE @V_tabledeleted TABLE(ProfileId INT);
             INSERT INTO @V_tabledeleted
                    SELECT a.ProfileId
                    FROM @DeleteProfileId AS a
                    WHERE (( NOT EXISTS
                           
                    (
                        SELECT TOP 1 1
                        FROM ZnodeUserProfile AS d
                        WHERE d.ProfileId = a.ProfileId
                    )
                         
                          AND NOT EXISTS
                    (
                        SELECT TOP 1 1
                        FROM ZnodePortalProfile AS f
                        WHERE f.ProfileId = a.ProfileId
                    )) OR @IsForceFullyDelete =1 ) ;
           
			DELETE FROM ZnodeProfileShipping
			WHERE EXISTS (SELECT TOP 1 1 FROM @V_tabledeleted DAI
			WHERE DAI.ProfileId = ZnodeProfileShipping.ProfileId)

			DELETE FROM ZnodeProfilePaymentSetting
			WHERE EXISTS (SELECT TOP 1 1 FROM @V_tabledeleted DAI
			WHERE DAI.ProfileId = ZnodeProfilePaymentSetting.ProfileId )
						
			 DELETE FROM ZnodeUserProfile  WHERE EXISTS (SELECT TOP 1 1 FROM @V_tabledeleted DAI
			WHERE DAI.ProfileId = ZnodeUserProfile.ProfileId)

			DELETE FROM ZnodePriceListProfile WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePortalProfile 	WHERE EXISTS (SELECT TOP 1 1 FROM @V_tabledeleted DAI
			WHERE DAI.ProfileId = ZnodePortalProfile.ProfileId) AND ZnodePortalProfile.PortalProfileId = ZnodePriceListProfile.PortalProfileId)

			DELETE FROM ZnodePortalProfile 	WHERE EXISTS (SELECT TOP 1 1 FROM @V_tabledeleted DAI
			WHERE DAI.ProfileId = ZnodePortalProfile.ProfileId)

			DELETE FROM ZnodeAccountProfile WHERE EXISTS (SELECT TOP 1 1 FROM @V_tabledeleted DAI
			WHERE DAI.ProfileId = ZnodeAccountProfile.ProfileId) 
			 
			  DELETE FROM znodecmscontentpagesprofile   WHERE EXISTS
             (
                 SELECT TOP 1 1
                 FROM @V_tabledeleted AS DAI
                 WHERE DAI.ProfileId = znodecmscontentpagesprofile.ProfileId
             );

			 DELETE FROM ZnodeSearchProfileTrigger   WHERE EXISTS
             (
                 SELECT TOP 1 1
                 FROM @V_tabledeleted AS DAI
                 WHERE DAI.ProfileId = ZnodeSearchProfileTrigger.ProfileId
             );

			 DELETE FROM ZnodeCMSWidgetProfileVariant
			 WHERE EXISTS
             (
                 SELECT TOP 1 1
                 FROM @V_tabledeleted AS DAI
                 WHERE DAI.ProfileId = ZnodeCMSWidgetProfileVariant.ProfileId
             );

			   DELETE FROM ZnodeProfile
             WHERE EXISTS
             (
                 SELECT TOP 1 1
                 FROM @V_tabledeleted AS DAI
                 WHERE DAI.ProfileId = ZnodeProfile.ProfileId
             );


             IF
             (
                 SELECT COUNT(1)
                 FROM @V_tabledeleted
             ) =
             (
                 SELECT COUNT(1)
                 FROM @DeleteProfileId
             )
                 BEGIN
                     SELECT 1 AS ID,
                            CAST(1 AS BIT) AS Status;
                 END;
             ELSE
                 BEGIN
                     SELECT 0 AS ID,
                            CAST(0 AS BIT) AS Status;
                 END;
             SET @Status = 1;
             COMMIT TRAN A;
         END TRY
         BEGIN CATCH
		   SELECT ERROR_MESSAGE()
          DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeleteProfile @ProfileId = '+@ProfileId+',@Status='+CAST(@Status AS VARCHAR(200));
             SET @Status = 0;
             SELECT 0 AS ID,
                    CAST(0 AS BIT) AS Status;
			 ROLLBACK TRAN A;
             EXEC Znode_InsertProcedureErrorLog
                  @ProcedureName = 'Znode_DeleteProfile',
                  @ErrorInProcedure = @Error_procedure,
                  @ErrorMessage = @ErrorMessage,
                  @ErrorLine = @ErrorLine,
                  @ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeleteUserDetails')
	DROP PROC Znode_DeleteUserDetails

GO


CREATE PROCEDURE [dbo].[Znode_DeleteUserDetails]
(
       @UserId VARCHAR(2000) = NULL ,
       @Status INT OUT	  , 
	   @UserIds Transferid READONLY , 
	   @IsForceFullyDelete BIT =0  ,@IsCallInternal   BIT = 0 
)
AS
/*
Summary: This Procedure Is used to delete user details
Unit Testing:
EXEC Znode_DeleteUserDetails 

*/
     BEGIN
         BEGIN TRY
             SET NOCOUNT ON;
             BEGIN TRAN A;
			 DECLARE @StatusOut Table (Id INT ,Message NVARCHAR(max), Status BIT )
             DECLARE @V_table TABLE (
                                    USERID1 NVARCHAR(200)
                                    );
             DECLARE @V_tabledeleted TABLE (
                                           UserId1      INT ,
                                           AspnetUserid NVARCHAR(1000)
                                           );
             DECLARE @TBL_DeleteduserName TABLE (
                                                id NVARCHAR(MAX)
                                                );
             INSERT INTO @V_tabledeleted
                    SELECT ITEM , b.AspNetUserId
                    FROM dbo.split ( @UserId , ','
                                   ) AS a INNER JOIN ZnodeUser AS b ON ( a.Item = b.UserId )
								   WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeOmsOrderDetails zood WHERE zood.UserId= b.UserId)
					 AND UserId <> 2 
		     INSERT INTO @V_tabledeleted 						   
			  	 SELECT a.Id , b.AspNetUserId
                    FROM @UserIds AS a 
					INNER JOIN ZnodeUser AS b ON ( a.Id = b.UserId )
								   WHERE (NOT EXISTS (SELECT TOP 1 1 FROM ZnodeOmsOrderDetails zood WHERE zood.UserId= b.UserId) OR @IsForceFullyDelete =1 )	
								   AND UserId <> 2 			  
             DELETE FROM ZnodeUserProfile
             WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS a
                            WHERE a.UserId1 = ZnodeUserProfile.UserId
                          );
             DELETE FROM ZnodeUserAddress
             WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS a
                            WHERE a.UserId1 = ZnodeUserAddress.UserId
                          ); 

			--------
			delete from ZnodeOmsPersonalizeCartItem 
			where OmsSavedCartLineItemId in (
				select OmsSavedCartLineItemId  from ZnodeOmsSavedCartLineItem where OmsSavedCartId in (
				select OmsSavedCartId FROM ZnodeOmsSavedCart
				where OmsCookieMappingId in (select OmsCookieMappingId from ZnodeOmsCookieMapping
										 WHERE EXISTS ( SELECT TOP 1 1
														FROM @V_tabledeleted AS a
														WHERE a.UserId1 = ZnodeOmsCookieMapping.UserId
													  ))));

			delete from ZnodeOmsSavedCartLineItem where OmsSavedCartId in (
			select OmsSavedCartId FROM ZnodeOmsSavedCart
			where OmsCookieMappingId in (select OmsCookieMappingId from ZnodeOmsCookieMapping
										 WHERE EXISTS ( SELECT TOP 1 1
														FROM @V_tabledeleted AS a
														WHERE a.UserId1 = ZnodeOmsCookieMapping.UserId
													  )));

			DELETE FROM ZnodeOmsSavedCart
			where OmsCookieMappingId in (select OmsCookieMappingId from ZnodeOmsCookieMapping
										 WHERE EXISTS ( SELECT TOP 1 1
														FROM @V_tabledeleted AS a
														WHERE a.UserId1 = ZnodeOmsCookieMapping.UserId
													  ));

			DELETE FROM ZnodeOmsCookieMapping
             WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS a
                            WHERE a.UserId1 = ZnodeOmsCookieMapping.UserId
                          );

			DELETE ZGCH
			FROM ZnodeGiftCardHistory ZGCH
			INNER JOIN ZnodeGiftCard ZGC ON (ZGCH.GiftCardId = ZGC.GiftCardId)
			WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS a
                            WHERE a.UserId1 = ZGC.UserId)

			DELETE FROM ZnodeGiftCard            
             WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS a
                            WHERE a.UserId1 = ZnodeGiftCard.UserId
                          );
		   ---------

             DELETE FROM ZnodeAccountUserOrderApproval
             WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS a
                            WHERE a.UserId1 = ZnodeAccountUserOrderApproval.UserId
                          );
             DELETE FROM AspNetUserRoles
             WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS a
                            WHERE a.aspNetUserId = AspNetUserRoles.UserId
                          );
         
             DELETE FROM dbo.ZnodeAccountUserPermission
             WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS a
                            WHERE a.UserId1 = ZnodeAccountUserPermission.UserId
                          );
			 
			 DELETE FROM ZnodeSalesRepCustomerUserPortal
             WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS a
                            WHERE a.UserId1 = ZnodeSalesRepCustomerUserPortal.CustomerUserid
                          );

		     delete from ZnodeSalesRepCustomerUserPortal 
			 WHERE exists(select TOP 1 1  FROM ZnodeUserPortal ZUP where EXISTS ( SELECT TOP 1 1 FROM @V_tabledeleted AS a WHERE a.UserId1 = ZUP.UserId )
			              and ZnodeSalesRepCustomerUserPortal.UserPortalId = ZUP.UserPortalId );
			 
			 DELETE FROM ZnodeUserPortal
             WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS a
                            WHERE a.UserId1 = ZnodeUserPortal.UserId
                          );
             DELETE FROM ZnodeAccountUserOrderApproval
             WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS TBDL
                            WHERE TBDL.UserId1 = ZnodeAccountUserOrderApproval.UserId
                                  OR
                                  TBDL.UserId1 = ZnodeAccountUserOrderApproval.ApprovalUserId
                          );
			 DELETE FROM ZnodeOmsUsersReferralUrl 
			  WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS TBDL
                            WHERE TBDL.UserId1 = ZnodeOmsUsersReferralUrl.UserId
                           );
			 DELETE FROM ZnodeOmsReferralCommission 
			 WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS TBDL
                            WHERE TBDL.UserId1 = ZnodeOmsReferralCommission.UserId      
                          );
			DELETE FROM ZnodeUserWishList 
			WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS TBDL
                            WHERE TBDL.UserId1 = ZnodeUserWishList.UserId      
                          );
			 DELETE FROM ZnodeDepartmentUser 
			 WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS TBDL
                            WHERE TBDL.UserId1 = ZnodeDepartmentUser.UserId      
                          );
			 DELETE FROM ZnodeUserPromotion 
			 WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS TBDL
                            WHERE TBDL.UserId1 = ZnodeUserPromotion.UserId      
                          );

			 DELETE FROM AspNetUserClaims 
			 WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS TBDL
                            WHERE TBDL.UserId1 = AspNetUserClaims.UserId      
                          ); 
			 DELETE FROM ZnodeNote 
			 WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS TBDL
                            WHERE TBDL.UserId1 = ZnodeNote.UserId      
                          ); 

			 DELETE FROM ZnodeOmsQuotePersonalizeItem WHERE OmsQuoteLineItemId IN (SELECT OmsQuoteLineItemId FROM ZnodeOmsQuoteLineItem  WHERE OmsQuoteId IN (SELECT OmsQuoteId FROM ZnodeOmsQuote 
			  WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS TBDL
                            WHERE TBDL.UserId1 = ZnodeOmsQuote.UserId      
                          ) )) 
			 DELETE FROM ZnodeOmsQuoteLineItem  WHERE OmsQuoteId IN (SELECT OmsQuoteId FROM ZnodeOmsQuote 
			  WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS TBDL
                            WHERE TBDL.UserId1 = ZnodeOmsQuote.UserId      
                          ) )

			DELETE FROM ZnodeUserApprovers
			WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS TBDL
                            WHERE TBDL.UserId1 = ZnodeUserApprovers.ApproverUserId      
                          ) 


			DELETE FROM ZnodeOMSQuoteApproval 
			  WHERE exists(select *  FROM ZnodeOmsQuote 
			  WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS TBDL
                            WHERE TBDL.UserId1 = ZnodeOmsQuote.UserId      
                          ) AND ZnodeOMSQuoteApproval.OMSQuoteId = ZnodeOmsQuote.OmsQuoteId) ;

			DELETE FROM ZnodeOmsQuoteComment 
			  WHERE exists(select *  FROM ZnodeOmsQuote 
			  WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS TBDL
                            WHERE TBDL.UserId1 = ZnodeOmsQuote.UserId      
                          ) AND ZnodeOmsQuoteComment.OMSQuoteId = ZnodeOmsQuote.OmsQuoteId) ;


			DELETE FROM ZnodeOmsNotes 
			  WHERE exists(select *  FROM ZnodeOmsQuote 
			  WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS TBDL
                            WHERE TBDL.UserId1 = ZnodeOmsQuote.UserId      
                          ) AND ZnodeOmsNotes.OMSQuoteId = ZnodeOmsQuote.OmsQuoteId) ;

			DELETE FROM ZnodeOmsQuoteHistory 
			  WHERE exists(select *  FROM ZnodeOmsQuote 
			  WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS TBDL
                            WHERE TBDL.UserId1 = ZnodeOmsQuote.UserId      
                          ) AND ZnodeOmsQuoteHistory.OMSQuoteId = ZnodeOmsQuote.OmsQuoteId) ; 

			 DELETE FROM ZnodeOmsQuote 
			  WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS TBDL
                            WHERE TBDL.UserId1 = ZnodeOmsQuote.UserId      
                          ); 
			 DELETE FROM ZnodeAccountUserPermission 
			  WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS TBDL
                            WHERE TBDL.UserId1 = ZnodeAccountUserPermission.UserId      
                          ); 
			  DELETE FROM ZnodePriceListUser 
			  WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS TBDL
                            WHERE TBDL.UserId1 = ZnodePriceListUser.UserId      
                          ); 
			  DELETE FROM ZnodeMediaFolderUser 
			  WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS TBDL
                            WHERE TBDL.UserId1 = ZnodeMediaFolderUser.UserId      
                          ); 
			  DELETE FROM ZnodeAccountUserOrderApproval 
			  WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS TBDL
                            WHERE TBDL.UserId1 = ZnodeAccountUserOrderApproval.UserId      
                          ); 
			 DELETE FROM ZnodeOmsTemplateLineItem WHERE OmsTemplateId IN (SELECT OmsTemplateId 
			 FROM ZnodeOmsTemplate WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS TBDL
                            WHERE TBDL.UserId1 = ZnodeOmsTemplate.UserId      
                          ) )

			 DELETE FROM dbo.ZnodeFormBuilderGlobalAttributeValueLocale   WHERE FormBuilderGlobalAttributeValueId IN 
			 (SELECT FormBuilderGlobalAttributeValueId  FROM dbo.ZnodeFormBuilderGlobalAttributeValue  WHERE FormBuilderSubmitId IN (SELECT FormBuilderSubmitId FROM dbo.ZnodeFormBuilderSubmit WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS TBDL
                            WHERE TBDL.UserId1 = ZnodeFormBuilderSubmit.UserId      
                          ) ))

			  DELETE FROM dbo.ZnodeFormBuilderGlobalAttributeValue  WHERE FormBuilderSubmitId IN (SELECT FormBuilderSubmitId FROM dbo.ZnodeFormBuilderSubmit WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS TBDL
                            WHERE TBDL.UserId1 = ZnodeFormBuilderSubmit.UserId      
                          ) )
			  DELETE FROM dbo.ZnodeFormBuilderSubmit WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS TBDL
                            WHERE TBDL.UserId1 = ZnodeFormBuilderSubmit.UserId      
                          )  
			 
			 DELETE FROM ZnodeOmsTemplate  WHERE  EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS TBDL
                            WHERE TBDL.UserId1 = ZnodeOmsTemplate.UserId      
                          ) 
			 
			 
			DELETE FROM ZnodeCaseRequestHistory WHERE CaseRequestId IN (SELECT CaseRequestId  FROM ZnodeCaseRequest  WHERE EXISTS (SELECT TOP  1 1 FROM @V_tabledeleted AS TBDL WHERE TBDL.UserId1 = ZnodeCaseRequest.UserId))
			  DELETE FROM ZnodeCaseRequest  WHERE EXISTS (SELECT TOP  1 1 FROM @V_tabledeleted AS TBDL WHERE TBDL.UserId1 = ZnodeCaseRequest.UserId)
			  DECLARE @OrderId Transferid 
			 INSERT INTO @OrderId 
			 SELECT DISTINCT  a.OmsOrderId 
			 FROM ZnodeOMsOrder A 
			 INNER JOIN ZnodeOmsOrderDetails b ON(b.OmsOrderId = a.OmsOrderId)
			 WHERE EXISTS (SELECT TOP 1  1 FROM @V_tabledeleted t WHERE b.UserId = t.UserId1 )
			 INSERT INTO @StatusOut (Id ,Status) 
			EXEC  Znode_DeleteOrderById   @OmsOrderIds =@OrderId ,@Status = 0 
			UPDATE ZnodePublishCatalogLog	 SET Userid =2 
			WHERE UserId IN (SELECT UserId1 FROM @V_tabledeleted t)

			
			 DELETE FROM ZnodeCMSCustomerReview WHERE UserId IN (SELECT UserId1 FROM @V_tabledeleted t)
             DELETE FROM ZnodeBlogNewsCommentLocale where BlogNewsCommentId in (select BlogNewsCommentId from  ZnodeBlogNewsComment WHERE UserId IN
			  (SELECT UserId1 FROM @V_tabledeleted t))
			 DELETE FROM ZnodeBlogNewsComment WHERE UserId IN (SELECT UserId1 FROM @V_tabledeleted t)

			-----------
			DELETE FROM ZnodePublishedPortalXml
			WHERE EXISTS(SELECT *  FROM ZnodePublishPortalLog
						WHERE EXISTS ( SELECT TOP 1 1
									FROM @V_tabledeleted AS TBDL
									WHERE TBDL.UserId1 = ZnodePublishPortalLog.UserId
						AND ZnodePublishedPortalXml.PublishPortalLogId = ZnodePublishPortalLog.PublishPortalLogId));

			DELETE FROM ZnodePublishPortalLog
			WHERE EXISTS ( SELECT TOP 1 1
										FROM @V_tabledeleted AS TBDL
										WHERE TBDL.UserId1 = ZnodePublishPortalLog.UserId      
									  ); 

			DELETE FROM ZnodeUserGlobalAttributeValueLocale
			WHERE EXISTS(SELECT *  FROM ZnodeUserGlobalAttributeValue
						WHERE EXISTS ( SELECT TOP 1 1
									FROM @V_tabledeleted AS TBDL
									WHERE TBDL.UserId1 = ZnodeUserGlobalAttributeValue.UserId
						AND ZnodeUserGlobalAttributeValueLocale.UserGlobalAttributeValueId = ZnodeUserGlobalAttributeValue.UserGlobalAttributeValueId)); 
			DELETE FROM ZnodeUserGlobalAttributeValue
			WHERE EXISTS ( SELECT TOP 1 1
										FROM @V_tabledeleted AS TBDL
										WHERE TBDL.UserId1 = ZnodeUserGlobalAttributeValue.UserId      
									  ); 

			DELETE FROM ZnodeOMSQuoteApproval
			WHERE EXISTS ( SELECT TOP 1 1
										FROM @V_tabledeleted AS TBDL
										WHERE TBDL.UserId1 = ZnodeOMSQuoteApproval.UserId      
									  ); 

			DELETE FROM AspNetUserLogins
			WHERE EXISTS ( SELECT TOP 1 1
										FROM @V_tabledeleted AS TBDL
										WHERE TBDL.UserId1 = AspNetUserLogins.UserId      
									  ); 

			DELETE FROM ZnodePasswordLog
			WHERE EXISTS ( SELECT TOP 1 1
										FROM @V_tabledeleted AS TBDL
										WHERE TBDL.UserId1 = ZnodePasswordLog.UserId      
									  ); 

			DELETE FROM ZnodeSavedReportViews
			WHERE EXISTS ( SELECT TOP 1 1
										FROM @V_tabledeleted AS TBDL
										WHERE TBDL.UserId1 = ZnodeSavedReportViews.UserId      
									  ); 

			DELETE FROM ZnodeSearchActivity
			WHERE EXISTS ( SELECT TOP 1 1
										FROM @V_tabledeleted AS TBDL
										WHERE TBDL.UserId1 = ZnodeSearchActivity.UserId      
									  ); 

			DELETE FROM ZnodeOmsCustomerShipping
			WHERE EXISTS ( SELECT TOP 1 1
										FROM @V_tabledeleted AS TBDL
										WHERE TBDL.UserId1 = ZnodeOmsCustomerShipping.UserId      
									  ); 

			DELETE FROM ZnodeOMSQuoteApproval
			WHERE EXISTS ( SELECT TOP 1 1
										FROM @V_tabledeleted AS TBDL
										WHERE TBDL.UserId1 = ZnodeOMSQuoteApproval.ApproverUserId      
									  ); 
			
			------------
			
			
			DELETE FROM ZnodeUser
             OUTPUT deleted.UserId
                    INTO @V_table
             WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS a
                            WHERE a.UserId1 = ZnodeUser.UserId
                          );

             DELETE FROM AspNetUsers
             OUTPUT deleted.UserName
                    INTO @TBL_DeleteduserName
             WHERE EXISTS ( SELECT TOP 1 1
                            FROM @V_tabledeleted AS a
                            WHERE a.AspnetUserid = AspNetUsers.Id
                          );

             DELETE FROM AspNetZnodeUser
             WHERE EXISTS ( SELECT TOP 1 1
                            FROM @TBL_DeleteduserName AS TBUN
                            WHERE TBUN.id = AspNetZnodeUser.AspNetZnodeUserId
                          );
			 
			 
			  IF  @IsCallInternal = 0  
			  BEGIN 
             IF ( SELECT COUNT(1)
                  FROM @V_tabledeleted
                ) = ( SELECT COUNT(1)
                      FROM dbo.split ( @UserId , ','
                                     )
                    ) OR @UserId IS NULL 
                 BEGIN
                     SELECT 0 AS ID , CAST(1 AS BIT) AS Status;
                 END;
             ELSE
                 BEGIN
                     SELECT 0 AS ID , CAST(0 AS BIT) AS Status;
                 END;
		       END 
             SET @Status = 1;
             COMMIT TRAN A;
         END TRY
         BEGIN CATCH
		 SELECT ERROR_MESSAGE()
              DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeleteUserDetails @UserId = '+@UserId+',@Status='+CAST(@Status AS VARCHAR(200));
             SET @Status = 0;
             SELECT 0 AS ID,
                    CAST(0 AS BIT) AS Status;
			 ROLLBACK TRAN A;
             EXEC Znode_InsertProcedureErrorLog
                  @ProcedureName = 'Znode_DeleteUserDetails',
                  @ErrorInProcedure = @Error_procedure,
                  @ErrorMessage = @ErrorMessage,
                  @ErrorLine = @ErrorLine,
                  @ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PurgeCatalogData')
	DROP PROC Znode_PurgeCatalogData

GO

CREATE PROCEDURE [dbo].[Znode_PurgeCatalogData]
(
	@DeleteAllCatalog BIT = 0,
	@ExceptCatalogId TransferId Readonly
)
AS
BEGIN 
BEGIN TRY
	SET NOCOUNT ON;
	--Delete catalogs
	EXECUTE [Znode_PurgeData] @DeleteAllCatalog = @DeleteAllCatalog,@ExceptCatalogId=@ExceptCatalogId

	--Delete publish references of deleted catalog
	DECLARE @DeletedIds TransferId 
	INSERT INTO @DeletedIds
	SELECT ZPP.PublishCatalogId
	FROM ZnodePublishCatalog ZPP
	WHERE NOT EXISTS(SELECT * FROM ZnodePimCatalog ZPP1 WHERE ZPP1.PimCatalogId = ZPP.PimCatalogId)

	DELETE FROM ZnodePublishCategoryDetail 
	WHERE EXISTS(SELECT * FROM ZnodePublishCategory WHERE ZnodePublishCategoryDetail.PublishCategoryId = ZnodePublishCategory.PublishCategoryId
		AND EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodePublishCategory.PublishCatalogId = D.Id))
	
	DELETE FROM ZnodePublishCategoryProduct 
	WHERE  EXISTS(SELECT * FROM ZnodePublishCategory WHERE ZnodePublishCategory.PublishCategoryId = ZnodePublishCategoryProduct.PublishCategoryId
		AND EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodePublishCategory.PublishCatalogId = D.Id))
	
	DELETE FROM ZnodePromotionCategory 
	WHERE  EXISTS(SELECT * FROM ZnodePublishCategory WHERE ZnodePublishCategory.PublishCategoryId = ZnodePromotionCategory.PublishCategoryId
		AND EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodePublishCategory.PublishCatalogId = D.Id))
	
	DELETE FROM ZnodeSearchSynonyms
	WHERE EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodeSearchSynonyms.PublishCatalogId = D.Id)

	DELETE FROM ZnodeSearchKeywordsRedirect
	WHERE EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodeSearchKeywordsRedirect.PublishCatalogId = D.Id)
	
	DELETE FROM ZnodePublishCategory 
	WHERE EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodePublishCategory.PublishCatalogId = D.Id)

	DELETE FROM ZnodePublishCatalogLog 
	WHERE EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodePublishCatalogLog .PublishCatalogId = D.Id)

	DELETE FROM ZnodeSearchIndexServerStatus 
	WHERE EXISTS(SELECT * FROM ZnodeSearchIndexMonitor 
			WHERE ZnodeSearchIndexServerStatus.SearchIndexMonitorId = ZnodeSearchIndexMonitor.SearchIndexMonitorId 
			AND CatalogIndexId in (SELECT CatalogIndexId FROM ZnodeCatalogIndex WHERE EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodeCatalogIndex .PublishCatalogId = D.Id)))
	
	
	DELETE FROM ZnodeSearchIndexMonitor 
	WHERE EXISTS(SELECT * FROM ZnodeCatalogIndex WHERE ZnodeSearchIndexMonitor.CatalogIndexId = ZnodeCatalogIndex.CatalogIndexId
			AND EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodeCatalogIndex .PublishCatalogId = D.Id))
	
	DELETE FROM ZnodeCatalogIndex 
	WHERE EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodeCatalogIndex .PublishCatalogId = D.Id)

	DELETE FROM ZnodePublishProductDetail
	WHERE EXISTS(SELECT * FROM ZnodePublishProduct WHERE ZnodePublishProductDetail.PublishProductId = ZnodePublishProduct.PublishProductId 
			AND EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodePublishProduct .PublishCatalogId = D.Id))
	
	DELETE FROM ZnodePromotionProduct 
	WHERE EXISTS(SELECT * FROM ZnodePublishProduct WHERE ZnodePromotionProduct.PublishProductId = ZnodePublishProduct.PublishProductId 
			AND EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodePublishProduct .PublishCatalogId = D.Id))
	
	DELETE FROM ZnodeSearchGlobalProductBoost 
	WHERE EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodeSearchGlobalProductBoost .PublishCatalogId = D.Id)

	DELETE FROM ZnodeSearchGlobalProductCategoryBoost  
	WHERE EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodeSearchGlobalProductCategoryBoost .PublishCatalogId = D.Id)

	DELETE FROM ZnodePublishProduct 
	WHERE EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodePublishProduct .PublishCatalogId = D.Id)

	DELETE FROM ZnodePublishCatalogSearchProfile
	WHERE EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodePublishCatalogSearchProfile .PublishCatalogId = D.Id)
	
	DELETE FROM ZnodeportalCatalog 
	WHERE EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodeportalCatalog .PublishCatalogId = D.Id)

	DELETE FROM ZnodePortalSearchProfile
	WHERE EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodePortalSearchProfile .PublishCatalogId = D.Id)

	DELETE FROM ZnodePublishCatalog 
	WHERE EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodePublishCatalog .PublishCatalogId = D.Id)

END TRY
	BEGIN CATCH
		SELECT ERROR_MESSAGE()	
		DECLARE @Error_procedure varchar(1000)= ERROR_PROCEDURE(), @ErrorMessage nvarchar(max)= ERROR_MESSAGE(), @ErrorLine varchar(100)= ERROR_LINE(), @ErrorCall nvarchar(max) = 'EXEC Znode_PurgeCatalogData'
		SELECT 0 AS ID, CAST(0 AS bit) AS Status,ERROR_MESSAGE();
		EXEC Znode_InsertProcedureErrorLog @ProcedureName = 'Znode_PurgeCatalogData', @ErrorInProcedure = @Error_procedure, @ErrorMessage = @ErrorMessage, @ErrorLine = @ErrorLine, @ErrorCall = @ErrorCall;
	END CATCH;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PurgeCategoryData')
	DROP PROC Znode_PurgeCategoryData

GO

CREATE PROCEDURE [dbo].[Znode_PurgeCategoryData]
(
	@DeleteAllCategory BIT = 0,
	@ExceptCategoryId TransferId Readonly
)
AS
BEGIN 
BEGIN TRY
	SET NOCOUNT ON;
	--Delete categories
	EXECUTE [Znode_PurgeData] @DeleteAllCategory = @DeleteAllCategory,@ExceptCategoryId=@ExceptCategoryId

	--Delete publish references of deleted categories
	DECLARE @DeletedIds TransferId 
	INSERT INTO @DeletedIds
	SELECT ZPP.PublishCategoryId
	FROM ZnodePublishCategory ZPP
	WHERE NOT EXISTS(SELECT * FROM ZnodePimCategory ZPP1 WHERE ZPP1.PimCategoryId = ZPP.PimCategoryId)

	
	DELETE FROM ZnodePromotionCategory
	WHERE EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodePromotionCategory.PublishCategoryId = D.Id)

	DELETE FROM ZnodePublishCategoryDetail
	WHERE EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodePublishCategoryDetail.PublishCategoryId = D.Id)

	DELETE FROM ZnodePublishCategoryProduct
	WHERE EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodePublishCategoryProduct.PublishCategoryId = D.Id)

	DELETE FROM ZnodePublishedPortalXml
	WHERE EXISTS(SELECT * FROM ZnodePublishPortalLog
		WHERE ZnodePublishedPortalXml.PublishPortalLogId = ZnodePublishPortalLog.PublishPortalLogId AND
		EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodePublishPortalLog.PublishCategoryId = D.Id))

	DELETE FROM ZnodePublishPortalLog
	WHERE EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodePublishPortalLog.PublishCategoryId = D.Id)

	DELETE FROM ZnodeCMSWidgetCategory
	WHERE EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodeCMSWidgetCategory.PublishCategoryId = D.Id)

	DELETE FROM ZnodeSearchGlobalProductCategoryBoost
	WHERE EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodeSearchGlobalProductCategoryBoost.PublishCategoryId = D.Id)

	DELETE FROM ZnodePublishCategory
	WHERE EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodePublishCategory.PublishCategoryId = D.Id)

END TRY
	BEGIN CATCH
		SELECT ERROR_MESSAGE()	
		DECLARE @Error_procedure varchar(1000)= ERROR_PROCEDURE(), @ErrorMessage nvarchar(max)= ERROR_MESSAGE(), @ErrorLine varchar(100)= ERROR_LINE(), @ErrorCall nvarchar(max) = 'EXEC Znode_PurgeCategoryData'
		SELECT 0 AS ID, CAST(0 AS bit) AS Status,ERROR_MESSAGE();
		EXEC Znode_InsertProcedureErrorLog @ProcedureName = 'Znode_PurgeCategoryData', @ErrorInProcedure = @Error_procedure, @ErrorMessage = @ErrorMessage, @ErrorLine = @ErrorLine, @ErrorCall = @ErrorCall;
	END CATCH;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PurgeCMSData')
	DROP PROC Znode_PurgeCMSData

GO

CREATE PROCEDURE [Znode_PurgeCMSData]
(
	@DeleteAllCMSData BIT = 0
)
AS
BEGIN 
BEGIN TRY
	SET NOCOUNT ON;

	--Delete CMS Data
	EXEC [Znode_PurgeData] @DeleteAllCMSData=@DeleteAllCMSData

END TRY
BEGIN CATCH
	SELECT ERROR_MESSAGE()	
	DECLARE @Error_procedure varchar(1000)= ERROR_PROCEDURE(), @ErrorMessage nvarchar(max)= ERROR_MESSAGE(), @ErrorLine varchar(100)= ERROR_LINE(), @ErrorCall nvarchar(max) = 'EXEC Znode_PurgeCMSData'
	SELECT 0 AS ID, CAST(0 AS bit) AS Status,ERROR_MESSAGE();
	EXEC Znode_InsertProcedureErrorLog @ProcedureName = 'Znode_PurgeCMSData', @ErrorInProcedure = @Error_procedure, @ErrorMessage = @ErrorMessage, @ErrorLine = @ErrorLine, @ErrorCall = @ErrorCall;
END CATCH;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PurgeData')
	DROP PROC Znode_PurgeData

GO



CREATE PROCEDURE [dbo].[Znode_PurgeData] 
(
 
  @DeleteAllProduct    							BIT = 0 -- This flag 1 will delete all product except ids in @ExceptProductId  table 
 ,@DeleteAllCategory							BIT = 0 -- This flag 1 will delete all category except ids in @ExceptCategoryId  table 
 ,@DeleteAllCatalog								BIT = 0 -- This flag 1 will delete all catalog except ids in @ExceptCatalogId  table 
 ,@DeleteAllSaveCart							Bit = 0	-- This flag 1 will delete all save carts of users.  
 ,@DeleteAllOrder								BIT = 0	-- This flag 1 will delete all orders. 
 ,@DeleteAllAccount								BIT = 0 -- This flag 1 will delete all Account. 
 ,@DeleteAllUser								BIT = 0 -- This flag 1 will delete all user. 
 ,@DeleteAllStore 								BIT = 0 -- This flag 1 will delete all store. 
 ,@DeleteAllGlobalAttribute  					BIT = 0 -- This flag 1 will delete all Global Attribute. 
 ,@DeleteAllProductCategoryAttribute			BIT = 0 -- This flag 1 will delete all Pim Attribute. 
 ,@DeleteAllMedia								BIT = 0 -- This flag 1 will delete all media. 
 ,@DeleteAllWarehouse							BIT = 0 -- This flag 1 will delete all warhouse. 
 ,@DeleteAllPricelist							BIT = 0 -- This flag 1 will delete all price list. 
 ,@DeleteAllProfile								BIT = 0 -- This flag 1 will delete all Profiles. 
 ,@DeleteAllSiteSearchData						BIT = 0	-- This flag 1 will delete all data related to search. 
 ,@DeleteAllCMSData								BIT = 0 -- This flag 1 will delete all CMS data. 
 ,@DeleteAllBrand								BIT = 0 -- This flag 1 will delete all brand. 
 ,@DeleteAllVendor								BIT = 0 -- This flag 1 will delete all vendor. 
 ,@DeleteAllCmsSeoDetails						BIT = 0 -- This flag 1 will delete all Seo details .   
 ,@ResetDomainData								BIT = 0 -- This flag 1 will delete and rest all domain. 
 ,@ExceptProductId								TransferId Readonly
 ,@ExceptCategoryId								TransferId Readonly
 ,@ExceptCatalogId								TransferId Readonly
 ,@ExceptAccountId								TransferId Readonly
 ,@ExceptUserId 								TransferId Readonly
 ,@ExceptStoreId 								TransferId Readonly 
 ,@ExceptGlobalAttributeId 						TransferId Readonly
 ,@ExceptProductCategoryAttributeId 		    TransferId Readonly
 ,@ExceptMediaId								TransferId Readonly
 ,@ExceptWarehouseId							TransferId ReadOnly 
 ,@ExceptPricelistId							TransferId ReadOnly 
 ,@ExceptProfileId								TransferId ReadOnly
 ,@ExceptSeoType								VARCHAR(2000) = ''
 ,@ResetIdentity								BIT = 0    -- Reset identity 
 ,@DeleteAllData								BIT = 0 	
 ,@DeleteAllShippingMethods						BIT = 0 
 ,@DeleteAllPaymentMethods						BIT = 0 
 ,@DeleteAllTaxes								BIT = 0 
 ,@DeleteAllPublishedData BIT = 0
)
AS 
BEGIN 
SET NOCOUNT ON 
 	 BEGIN TRY
	    DECLARE @StatusOut Table (Id INT ,Message NVARCHAR(max), Status BIT )
		DECLARE @DeletedIds TransferId 
		DECLARE @PortalId INT , @CMSThemeId INT , @CMSThemeCSSId INT,@PublishCatalogId INT
		,@PimCatalogId INT  

		----Delete all published data
		IF @DeleteAllPublishedData = 1 OR @DeleteAllData =1 
		BEGIN	

			EXECUTE [Znode_DeleteAllPublishedData] @UserId = 2

		END

		DELETE FROM @DeletedIds DELETE FROM @StatusOut 
		IF  Object_Id('elmah_error')	 <> 0 
		BEGIN 
			 TRUNCATE TABLE elmah_error
			 DELETE FROM ZnodeImportLog
			 DELETE FROM ZnodeImportProcesslog
			 DELETE FROM ZnodeActivityLog	
             DELETE FROM ZnodePasswordLog	
             DELETE FROM ZnodeProceduresErrorLog
		END 
	
		DECLARE @DeleteId  NVARCHAR(max)= '', @StoreData NVARCHAR(max),@RunTime INT =1 
		DELETE FROM @DeletedIds DELETE FROM @StatusOut 
		IF  @DeleteAllVendor = 1   OR @DeleteAllData =1 
			BEGIN 
			 	INSERT INTO @DeletedIds 
				SELECT PimVendorId 
				FROM ZnodePimVendor ZP 
							
				INSERT INTO @StatusOut(id ,Status) 
				EXEC [dbo].[Znode_DeleteVendor] @PimVendorIds = @DeletedIds ,@Status = 0  
			    
				DELETE FROM ZnodePimProductAttributeDefaultValue WHERE PimAttributeValueId IN (
				SELECT PimAttributeValueId  
				FROM ZnodePimAttributeValue WHERE PimAttributeId = (SELECT PimAttributeId FROM ZnodePimAttribute WHERE AttributeCode= 'Vendor') )
				
				DELETE FROM ZnodePimAttributeValue WHERE PimAttributeId = (SELECT PimAttributeId FROM ZnodePimAttribute WHERE AttributeCode= 'Vendor') 

				DELETE FROM ZnodePimAttributeDefaultValueLocale  WHERE PimAttributeDefaultValueId IN (
				SELECT PimAttributeDefaultValueId FROM ZnodePimAttributeDefaultValue WHERE AttributeDefaultValueCode IN (SELECT VendorCode FROM ZnodePimVendor ))
				
				DELETE FROM  ZnodePimAttributeDefaultValue WHERE AttributeDefaultValueCode IN (SELECT VendorCode FROM ZnodePimVendor )

			    PRINT '<-- Vendor Data Deleted Sucessfully-->'
				
			END
			DELETE FROM @DeletedIds DELETE FROM @StatusOut 
			IF  @DeleteAllBrand = 1  OR @DeleteAllData =1 
			BEGIN 
			   INSERT INTO @DeletedIds 
			   SELECT BrandId
			   FROM ZnodeBrandDetails a
			   INSERT INTO @StatusOut (Id ,Status) 
			   EXEC [dbo].[Znode_DeleteBrand] @BrandIds = @DeletedIds, @Status = 0   
			 IF  EXISTS (SELECT TOP 1 1  FROM @StatusOut WHERE Status = 1 )
				BEGIN 
		     	PRINT '<-- Brand Data Deleted Sucessfully-->'
			   END
			   ELSE 
				BEGIN 
				PRINT '<-- Brand Data Not Deleted Properly -->' 
				END  
		    END 
				
		DELETE FROM @DeletedIds DELETE FROM @StatusOut 
		IF  @DeleteAllProduct = 1  OR @DeleteAllData =1 
		BEGIN 
		   	 INSERT INTO @DeletedIds 
		     SELECT PimProductId 
			 FROM ZnodePimProduct ZPP 
			 WHERE NOT EXISTS (SELECT TOP 1 1 FROM @ExceptProductId WHERE id = ZPP.PimProductId) 
			  INSERT INTO @StatusOut (Id ,Status) 
			  EXEC [dbo].[Znode_DeletePimProducts] @PimProductIds=@DeletedIds , @Status = 0   
			
			SELECT PimAddonGroupId,PimProductId,PimAddOnProductId  
			INTO #Temp_Addon 
			FROM ZnodePimAddOnProduct ZPP
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM @ExceptProductId WHERE id = ZPP.PimProductId)

			DELETE FROM ZnodePimAddOnProductDetail WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Addon t 
							 WHERE t.PimAddOnProductId  = ZnodePimAddOnProductDetail.PimAddOnProductId )
			
			DELETE FROM  ZnodePimAddOnProduct  WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Addon t 
							 WHERE t.PimAddOnProductId  = ZnodePimAddOnProduct.PimAddOnProductId )
			
			DELETE FROM ZnodePimAddonGroupLocale WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Addon t 
							 WHERE t.PimAddonGroupId  = ZnodePimAddonGroupLocale.PimAddonGroupId )
			DELETE FROM ZnodePimAddonGroupProduct 	WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Addon t 
							 WHERE t.PimAddonGroupId  = ZnodePimAddonGroupProduct.PimAddonGroupId )
			DELETE FROM ZnodePimAddonGroup 	WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Addon t 
							 WHERE t.PimAddonGroupId  = ZnodePimAddonGroup.PimAddonGroupId )
			IF  EXISTS (SELECT TOP 1 1  FROM @StatusOut WHERE Status = 1 )
				BEGIN 
		     	PRINT '<-- Product Data Deleted Sucessfully-->'
			    END
			    ELSE 
				BEGIN 
				PRINT '<-- Product Data Not Deleted Properly -->' 
				END  
			  
	    END 
		DELETE FROM @DeletedIds DELETE FROM @StatusOut 
		IF  @DeleteAllCategory = 1 	  OR @DeleteAllData =1 
		BEGIN   
		   		INSERT INTO @DeletedIds 
				SELECT  PimCategoryId 
				FROM ZnodePimCategory ZPC
				WHERE NOT EXISTS  (SELECT TOP 1 1 FROM @ExceptCategoryId WHERE id =ZPC.PimCategoryId )
				--Remove extra products from catalog
				--INSERT INTO @StatusOut (Id ,Status) 

				EXEC Znode_DeletePimCategory @PimCategoryId = @DeletedIds, @Status = 1;
			
				IF  EXISTS (SELECT TOP 1 1  FROM @StatusOut WHERE Status = 1 )
				BEGIN 
		     	PRINT '<-- Category Data Deleted Sucessfully-->'
			    END
			    ELSE 
				BEGIN 
				PRINT '<-- Category Data Not Deleted Properly -->' 
				END     
		  END
		  DELETE FROM @DeletedIds DELETE FROM @StatusOut 
		  IF  @DeleteAllCatalog = 1 	OR @DeleteAllData =1 
		   BEGIN
		   	 INSERT INTO @DeletedIds 
		   	 SELECT PimCatalogId 
			 FROM ZnodePimCatalog ZP 
			 WHERE NOT EXISTS (SELECT TOP 1 1  FROM @ExceptCatalogId WHERE id = ZP.PimCatalogId)
		   	 INSERT INTO @StatusOut (Id ,Message,Status) 
			 EXEC [dbo].[Znode_DeletePimCatalog] @PimCatalogId = @DeletedIds ,@IsForceFullyDelete = 1  
		      

			 IF  EXISTS (SELECT TOP 1 1  FROM @StatusOut WHERE Status = 1 )
				BEGIN 
		     	PRINT '<-- Catalog Data Deleted Sucessfully-->'
			    END
			    ELSE 
				BEGIN 
				PRINT '<-- Catalog Data Not Deleted Properly -->' 
				END  
           END
		   DELETE FROM @DeletedIds DELETE FROM @StatusOut 
		   IF  @DeleteAllOrder = 1 	OR @DeleteAllData =1 
		   BEGIN

				--Delete return data against order
				DELETE FROM ZnodeRmaRequestItem
				DELETE FROM ZnodeRmaRequest
				DELETE FROM ZnodeRmaReturnNotes
				DELETE FROM ZnodeRmaReturnEmailHistory
				DELETE FROM ZnodeRmaReturnHistory
				DELETE FROM ZnodeRmaReturnPaymentRefund
				DELETE FROM ZnodeRmaReturnPaymentDetails
				DELETE FROM ZnodeRmaReturnLineItems
				DELETE FROM ZnodeRmaReturnDetails

				 INSERT INTO @DeletedIds 
		   		 SELECT OmsOrderID 
				 FROM ZnodeOmsOrder  ZP 
				 INSERT INTO @StatusOut (Id ,Status) 
			     EXEC [dbo].[Znode_DeleteOrderById] @OmsOrderIds = @DeletedIds , @status = 0  
		    
		        IF  EXISTS (SELECT TOP 1 1  FROM @StatusOut WHERE Status = 1 )
				BEGIN 
		     	PRINT '<-- Order Data Deleted Sucessfully-->'
			    END
			    ELSE 
				BEGIN 
				PRINT '<-- Order Data Not Deleted Properly -->' 
				END  
		  END
		
		   DELETE FROM @DeletedIds DELETE FROM @StatusOut
		   IF  @DeleteAllSaveCart = 1  OR @DeleteAllData =1 
		   BEGIN
		      DELETE FROM ZnodeOmsPersonalizeCartItem
			  DELETE FROM ZnodeOmsSavedCartLineItem 
			  DELETE FROM ZnodeOmsSavedCart
			  DELETE FROM ZnodeOmsCookieMapping
			  DELETE FROM ZnodeOmsQuotePersonalizeItem 
			  DELETE FROM ZnodeOmsQuoteLineItem
			  DELETE FROM ZnodeOmsQuote
			  DELETE FROM ZnodeOmsTemplateLineItem 
			  DELETE FROM ZnodeOmsTemplate
			 
		      PRINT '<-- Save Cart & Quote Data Deleted Sucessfully -->'
			  
		   END
		   DELETE FROM @DeletedIds DELETE FROM @StatusOut 
		   IF  @DeleteAllUser = 1 OR @DeleteAllData =1 
		   BEGIN  
		  
			   INSERT INTO @DeletedIds 
			   SELECT UserId
			   FROM ZnodeUser ZU 
			   WHERE NOT EXISTS (SELECT TOP 1  1 FROM @ExceptUserId RT WHERE RT.Id = ZU.UserId) 
			 --  INSERT INTO @StatusOut (Id ,Status) 
			   EXEC Znode_DeleteUserDetails @UserIds =@DeletedIds ,@Status = 0 , @IsForceFullyDelete =1 

			DELETE FROM AspNetUsers  WHERE NOT EXISTS (SELECT TOP 1 1 FROM AspNetZnodeUser rt WHERE rt.AspNetZnodeUserId = AspNetUsers.UserName )

		     	PRINT '<-- User Data Deleted Sucessfully-->'
			  
		   END
	    DELETE FROM @DeletedIds DELETE FROM @StatusOut 
		IF  @DeleteAllAccount = 1 	OR @DeleteAllData =1 
		  BEGIN    
				 INSERT INTO @DeletedIds 
				  SELECT AccountId
			      FROM ZnodeAccount ZU 
			      WHERE NOT EXISTS (SELECT TOP 1  1 FROM @ExceptAccountId RT WHERE RT.Id = ZU.AccountiD) 
			    -- INSERT INTO @StatusOut (Id ,Status) 
				  EXEC Znode_DeleteAccount @AccountIds =  @DeletedIds,@Status= 0,@IsForceFullyDelete =1  
				 
		     	PRINT '<-- Accouts Data Deleted Sucessfully-->'
			    
		  END
		 DELETE FROM @DeletedIds DELETE FROM @StatusOut 
		 IF  @DeleteAllGlobalAttribute = 1 	 OR @DeleteAllData =1 
		   BEGIN 
		   	INSERT INTO @DeletedIds 
			SELECT GlobalAttributeId 
			FROM ZnodeGlobalAttribute ZP 
			WHERE NOT EXISTS (SELECT TOP 1 1  FROM @ExceptGlobalAttributeId a WHERE a.Id = ZP.GlobalAttributeId)
			AND ISNULL(ZP.IsSystemDefined,0) <> 1
			--INSERT INTO @StatusOut (Id ,Status) 	   
			EXEC [dbo].[Znode_DeleteGlobalAttribute] @GlobalAttributeIds= @DeletedIds,@Status =0 , 	@IsForceFullyDelete= 1    
			
			DELETE FROM ZnodeGlobalFamilyGroupMapper WHERE GlobalAttributeGroupId IN  (SELECT GlobalAttributeGroupId  FROM ZnodeGlobalAttributeGroup WHERE IsSystemDefined <> 1 )
			DELETE FROM ZnodeGlobalAttributeGroupLocale	WHERE GlobalAttributeGroupId IN  (SELECT GlobalAttributeGroupId  FROM ZnodeGlobalAttributeGroup WHERE IsSystemDefined <> 1 )
			DELETE FROM ZnodeGlobalAttributeGroupMapper WHERE GlobalAttributeGroupId IN  (SELECT GlobalAttributeGroupId  FROM ZnodeGlobalAttributeGroup WHERE IsSystemDefined <> 1)
			DELETE FROM ZnodeGlobalGroupEntityMapper WHERE GlobalAttributeGroupId IN  (SELECT GlobalAttributeGroupId  FROM ZnodeGlobalAttributeGroup WHERE IsSystemDefined <> 1)
			DELETE FROM ZnodeFormBuilderAttributeMapper	WHERE GlobalAttributeGroupId IN  (SELECT GlobalAttributeGroupId  FROM ZnodeGlobalAttributeGroup WHERE IsSystemDefined <> 1)
			DELETE FROM ZnodeGlobalAttributeGroup	WHERE GlobalAttributeGroupId IN  (SELECT GlobalAttributeGroupId  FROM ZnodeGlobalAttributeGroup WHERE IsSystemDefined <> 1)   
			 
			   IF  EXISTS (SELECT TOP 1 1  FROM @StatusOut WHERE Status = 1 )
				BEGIN 
		     	PRINT '<-- Global Attribute Data Deleted Sucessfully-->'
			    END
			    ELSE 
				BEGIN 
				PRINT '<-- Global Attribute Not Deleted Properly -->' 
				END 	   
		   END  
		   DELETE FROM @DeletedIds DELETE FROM @StatusOut 
		   IF  @DeleteAllProductCategoryAttribute = 1  OR @DeleteAllData =1 
		   BEGIN 
			   	INSERT INTO @DeletedIds 
				SELECT PimAttributeId
				FROM ZnodePimAttribute ZP 
				WHERE NOT EXISTS (SELECT TOP 1 1  FROM @ExceptProductCategoryAttributeId WHERE id = ZP.PimAttributeId )
				AND ZP.IsSystemDefined <> 1 
				INSERT INTO @StatusOut (Id ,Status) 			
				EXEC Znode_DeletePimAttributeWithReference @PimAttributeIds = @DeletedIds  , @Status = 1  
			  
			    DELETE FROM ZnodePimAttributeGroupLocale 
					WHERE PimAttributeGroupId IN (SELECT PimAttributeGroupId FROM ZnodePimAttributeGroup WHERE IsSystemDefined <> 1  )
				DELETE FROM ZnodePimAttributeGroupMapper wHERE PimAttributeGroupId IN (SELECT PimAttributeGroupId FROM ZnodePimAttributeGroup WHERE IsSystemDefined <> 1  )
				DELETE FROM ZnodePimFamilyGroupMapper 
					WHERE PimAttributeGroupId IN (SELECT PimAttributeGroupId FROM ZnodePimAttributeGroup WHERE IsSystemDefined <> 1  )
				DELETE FROM ZnodePimAttributeGroup WHERE IsSystemDefined <> 1  
			
				DELETE FROM ZnodePimFamilyLocale WHERE  PimAttributeFamilyId IN (SELECT PimAttributeFamilyId FROM ZnodePimAttributeFamily WHERE IsSystemDefined <> 1  )
				UPDATE ZP SET PimAttributeFamilyId = dbo.Fn_GetDefaultPimProductFamilyId() FROM ZnodePimProduct  ZP  WHERE  PimAttributeFamilyId IN (SELECT PimAttributeFamilyId FROM ZnodePimAttributeFamily WHERE IsSystemDefined <> 1  )
				UPDATE ZP SET PimAttributeFamilyId = dbo.Fn_GetDefaultPimProductFamilyId() FROM ZnodePimCategory  ZP  WHERE  PimAttributeFamilyId IN (SELECT PimAttributeFamilyId FROM ZnodePimAttributeFamily WHERE IsSystemDefined <> 1  )
				UPDATE ZP SET PimAttributeFamilyId = dbo.Fn_GetDefaultPimProductFamilyId() FROM ZnodePimCategoryAttributeValue  ZP  WHERE  PimAttributeFamilyId IN (SELECT PimAttributeFamilyId FROM ZnodePimAttributeFamily WHERE IsSystemDefined <> 1  )
				UPDATE ZP SET PimAttributeFamilyId = dbo.Fn_GetDefaultPimProductFamilyId() FROM ZnodePimAttributeValue  ZP  WHERE  PimAttributeFamilyId IN (SELECT PimAttributeFamilyId FROM ZnodePimAttributeFamily WHERE IsSystemDefined <> 1  )

				DELETE FROM ZnodeImportTemplateMapping WHERE ImportTemplateId IN (SELECT ImportTemplateId FROM ZnodeImportTemplate WHERE PimAttributeFamilyId IN (SELECT PimAttributeFamilyId FROM ZnodePimAttributeFamily WHERE IsSystemDefined <> 1  ))
				DELETE FROM ZnodeImportTemplate WHERE PimAttributeFamilyId IN (SELECT PimAttributeFamilyId FROM ZnodePimAttributeFamily WHERE IsSystemDefined <> 1  )
				DELETE FROM ZnodePimFamilyGroupMapper 
					WHERE PimAttributeFamilyId IN (SELECT PimAttributeFamilyId FROM ZnodePimAttributeFamily WHERE IsSystemDefined <> 1  )

				DELETE  FROM ZnodePimAttributeFamily WHERE IsSystemDefined <> 1 
				UPDATE ZP SET PimAttributeFamilyId = dbo.Fn_GetDefaultPimProductFamilyId() FROM ZnodePimAttributeValue  ZP  WHERE  PimAttributeFamilyId IN (SELECT PimAttributeFamilyId FROM ZnodePimAttributeFamily WHERE IsSystemDefined <> 1  ) 
			   	IF  EXISTS (SELECT TOP 1 1  FROM @StatusOut WHERE Status = 1 )
				BEGIN 
		     	PRINT '<-- PIM Attribute Data Deleted Sucessfully-->'
			    END
			    ELSE 
				BEGIN 
				PRINT '<-- PIM Attribute Not Deleted Properly -->' 
				END 
		   END
		   DELETE FROM @DeletedIds 
		   DELETE FROM @StatusOut 
		   IF  @DeleteAllMedia = 1  OR @DeleteAllData =1 
		   BEGIN 
		  		INSERT INTO @DeletedIds 
		   		SELECT  MediaId   
				FROM ZnodeMedia ZP 
				WHERE NOT EXISTS (SELECT TOP 1 1  FROM @ExceptMediaId WHERE id = ZP.Mediaid )
				--INSERT INTO @StatusOut (Id ,Message,Status)
				EXEC Znode_DeleteMedia @MediaIds = @DeletedIds  , @Status = 1  ,@IsCallInternal =1 
				DELETE FROM ZnodeMediaCategory WHERE MediaPathId IN (SELECT MediaPathId FROM ZnodeMediaPath WHERE PathCode<>'Root')
				DELETE FROM ZnodeMediaPathLocale WHERE MediaPathId IN (SELECT MediaPathId FROM ZnodeMediaPath WHERE PathCode<>'Root')
				DELETE FROM ZnodeMediaPath WHERE PathCode<>'Root'
				IF  EXISTS (SELECT TOP 1 1  FROM @StatusOut WHERE Status = 1 )
				BEGIN 
		     	PRINT '<-- Media Data Deleted Sucessfully-->'
			    END
			    ELSE 
				BEGIN 
				PRINT '<-- Media Not Deleted Properly -->' 
				END
				
		   END 
		   DELETE FROM @DeletedIds DELETE FROM @StatusOut 
		
		   IF  @DeleteAllWarehouse = 1 OR @DeleteAllData =1 
		   BEGIN 
		   	
		   		SET @DeleteId =  SUBSTRING((
				SELECT  ',' + CONVERT(NVARCHAR(500), WarehouseId)  
				FROM ZnodeWarehouse ZP 
				WHERE NOT EXISTS (SELECT TOP 1 1  FROM @ExceptWarehouseId WHERE id = ZP.WarehouseId )
				FOR XML PATH ('')
				),2,4000) 
				INSERT INTO @StatusOut (Id ,Status)
			    EXEC Znode_DeleteWarehouse @WarehouseId = @DeleteId  , @Status = 1 
		
				IF  EXISTS (SELECT TOP 1 1  FROM @StatusOut WHERE Status = 1 )
				BEGIN 
		     	PRINT '<-- Warehouse Data Deleted Sucessfully-->'
			    END
			    ELSE 
				BEGIN 
				PRINT '<-- Warehouse Not Deleted Properly -->' 
				END
		    END 
			DELETE FROM @DeletedIds DELETE FROM @StatusOut 
		
			IF  @DeleteAllPricelist = 1   OR @DeleteAllData =1 
		    BEGIN 
				SET @DeleteId =  SUBSTRING((
				SELECT ',' + CONVERT(NVARCHAR(500), PriceListId)  
				FROM ZnodePriceList ZP 
				WHERE NOT EXISTS (SELECT TOP 1 1  FROM @ExceptPricelistId WHERE id = ZP.PriceListId )
				FOR XML PATH ('')
				),2,4000) 
			  
				INSERT INTO @StatusOut (Id ,Status)  
				EXEC Znode_DeletePriceList @PriceListId = @DeleteId  , @Status = 1 
		      
			   IF  EXISTS (SELECT TOP 1 1  FROM @StatusOut WHERE Status = 1 )
				BEGIN 
		     	PRINT '<-- Price List Data Deleted Sucessfully-->'
			    END
			    ELSE 
				BEGIN 
				PRINT '<-- Price List Not Deleted Properly -->' 
				END
		    END
		
			DELETE FROM @DeletedIds DELETE FROM @StatusOut 
			IF  @DeleteAllProfile = 1  OR @DeleteAllData =1 
			 BEGIN 
				SET @DeleteId =  SUBSTRING((
				SELECT ',' + CONVERT(NVARCHAR(500), ProfileId)  
				FROM ZnodeProfile ZP 
				WHERE NOT EXISTS (SELECT TOP 1 1  FROM @ExceptProfileId WHERE id = ZP.ProfileId )
				FOR XML PATH ('')
				),2,4000) 
		   	 	--INSERT INTO @StatusOut (Id ,Status)
				EXEC  Znode_DeleteProfile  @ProfileId=@DeleteId, @Status = 0 ,	@IsForceFullyDelete =1 
				
				IF  EXISTS (SELECT TOP 1 1  FROM @StatusOut WHERE Status = 1 )
				BEGIN 
		     	PRINT '<-- Profile Data Deleted Sucessfully-->'
			    END
			    ELSE 
				BEGIN 
				PRINT '<-- Profile Not Deleted Properly -->' 
				END
		    END
			DELETE FROM @DeletedIds DELETE FROM @StatusOut 
			IF  @DeleteAllSiteSearchData  = 1  OR @DeleteAllData =1 
			BEGIN 
			
					DELETE FROM ZnodeSearchIndexServerStatus
					DELETE FROM ZnodeSearchIndexMonitor
					DELETE FROM ZnodeCatalogIndex
					DELETE FROM ZnodePublishCatalogSearchProfile
					DELETE FROM ZnodeCatalogIndex
					DELETE FROM ZnodeCMSCustomerReview 
					DELETE FROM ZnodePublishPortalLog
					DELETE FROM ZnodeListViewFilter
					DELETE FROM ZnodeListView
			
					PRINT '<-- Site Search Data Deleted Sucessfully-->'
			 END
			 DELETE FROM @DeletedIds DELETE FROM @StatusOut 
			 IF  @DeleteAllCMSData = 1 	OR @DeleteAllData =1 
			 BEGIN 
				IF EXISTS (SELECT TOP 1 1  FROM SYS.Tables WHERE name = '_ZnodeCMSPortalTheme' )
				BEGIN
				 DROP TABLE _ZnodeCMSPortalTheme 
				END 
				SELECT * 
				INTO _ZnodeCMSPortalTheme
				FROM ZnodeCMSPortalTheme
				DELETE FROM ZnodeCMSContentPagesProfile 
				DELETE FROM ZnodeFormWidgetEmailConfiguration
				DELETE FROM ZnodeCMSWidgetTitleConfigurationLocale
				DELETE FROM ZnodeCMSWidgetTitleConfiguration
				DELETE FROM ZnodeCMSTextWidgetConfiguration
				DELETE FROM ZnodeCMSFormWidgetConfiguration
				DELETE FROM ZnodeCMSPortalProductPage
				DELETE FROM ZnodeCMSContentPageGroupMapping
				DELETE FROM ZnodeCMSContentPageGroupLocale
				DELETE FROM ZnodeCMSContentPageGroup
				DELETE FROM ZnodeCMSContentPagesLocale
				DELETE FROM ZnodeCMSContentPages
				DELETE FROM ZnodeCMSContentPagesProfile
				DELETE FROM ZnodeCMSPortalTheme  
			    DELETE FROM ZnodeCMSThemeCSS 
				DELETE FROM ZnodeCMSTheme  
				DELETE FROM ZnodeEmailTemplateMapper
				DELETE FROM ZnodeEmailTemplateLocale
				DELETE FROM ZnodeEmailTemplateAreas
				DELETE FROM ZnodeEmailTemplate
			    DELETE FROM ZnodeCMSWidgetSliderBanner
				DELETE FROM ZnodeCMSSliderBannerLocale
				DELETE FROM ZnodeCMSSliderBanner
				DELETE FROM ZnodeCMSSlider
				DELETE FROM ZnodeCmsPortalMessage
				DELETE FROM ZnodeCMSPortalMessageKeyTag
				DELETE FROM ZnodeCMSMessage 
				DELETE FROM ZnodeCMSMessageKey 
				DELETE FROM ZnodeCMSTemplate
				DELETE FROM ZnodeFormBuilderGlobalAttributeValueLocale 
				DELETE FROM ZnodeFormBuilderGlobalAttributeValue
				DELETE FROM ZnodeFormBuilderAttributeMapper 
				DELETE FROM ZnodeFormBuilderSubmit 
				DELETE FROM ZnodeFormBuilder

				IF NOT EXISTS (SELECT TOP 1 1  FROM ZnodeCMSTheme)
				BEGIN 
			   INSERT INTO ZnodeCMSTheme(Name
			,CreatedBy
			,CreatedDate
			,ModIFiedBy
			,ModIFiedDate
			,IsParentTheme
			,ParentThemeId)
			SELECT 'Default',2,GETDATE(),2,GETDATE(),1,NULL
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSTheme WHERE Name = 'Default')

			SET @CMSThemeId = CASE WHEN @CMSThemeId	 IS NULL THEN (SELECT TOP 1 CMSThemeId FROM ZnodeCMSTheme WHERE Name = 'Default'   )  ELSE  @CMSThemeId END 
			INSERT INTO ZnodeCMSThemeCSS  (CMSThemeId
			,CSSName
			,CreatedBy
			,CreatedDate
			,ModIFiedBy
			,ModIFiedDate)
			SELECT @CMSThemeId,'DefaultCSS',2,GETDATE(),2,GETDATE()
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSThemeCSS WHERE CSSName = 'DefaultCSS')
	  	
			SET @CMSThemeCSSId = CASE WHEN @CMSThemeCSSId IS NULL THEN (SELECT TOP 1 CMSThemeCSSId FROM ZnodeCMSThemeCSS 
			WHERE CSSName = 'DefaultCSS'
			) ELSE 	@CMSThemeCSSId END 

			 INSERT INTO ZnodeCMSPortalTheme (PortalId
					,CMSThemeId
					,CMSThemeCSSId
					,MediaId
					,FavIconId
					,WebsiteTitle
					,CreatedBy
					,CreatedDate
					,ModifiedBy
					,ModifiedDate)
			 SELECT DISTINCT PortalId
					,@CMSThemeId
					,@CMSThemeCSSId
					,MediaId
					,FavIconId
					,WebsiteTitle
					,2
					,GETDATE()
					,2
					,GETDATE() 
			 FROM _ZnodeCMSPortalTheme	TYU 
			 WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodeCMSPortalTheme TY  WHERE TY.PortalId = TYU.PortalId AND TY.CMSThemeId = @CMSThemeId AND TY.CMSThemeCSSId = @CMSThemeCSSId)
			 
			 END 

			 PRINT '<-- CMS Data Deleted Sucessfully-->'	  			   
			 IF  NOT EXISTS (SELECT TOP 1 1  FROM ZnodeCMSContentPageGroup )
			 BEGIN 
			    DECLARE @GroupId INT =0 
				INSERT INTO ZnodeCMSContentPageGroup (ParentCMSContentPageGroupId ,Code,CreatedBy,CreatedDate,ModIFiedBy,ModIFiedDate)
				SELECT NULL,'Root',2,GETDATE(),2,GETDATE()
			    SET @GroupId = SCOPE_IDENTITY()
				INSERT INTO ZnodeCMSContentPageGroupLocale(CMSContentPageGroupId,Name,LocaleId,CreatedBy,CreatedDate,ModIFiedBy,ModIFiedDate)
			    SELECT @GroupId,'Root',1,2,GETDATE(),2,GETDATE()
			 END
			 END 
	 		 DELETE FROM @DeletedIds DELETE FROM @StatusOut 
			 IF  @DeleteAllCmsSeoDetails =1 OR @DeleteAllData =1 
			 BEGIN 
			 
			   DELETE FROM ZnodeCMSSEODetailLocale 
			   WHERE CMSSEODetailId IN (SELECT CMSSEODetailId FROM ZnodeCMSSEODetail a 
			   INNER JOIN ZnodeCMSSEOType b ON (b.CMSSEOTypeId = a.CMSSEOTypeId)
			   WHERE NOT EXISTS (SELECT TOP 1 1 FROM dbo.split(@ExceptSeoType,',') t WHERE t.Item = b.Name))
			  
			   DELETE FROM ZnodeCMSSEODetail 
			   WHERE CMSSEODetailId IN (SELECT CMSSEODetailId FROM ZnodeCMSSEODetail a 
			   INNER JOIN ZnodeCMSSEOType b ON (b.CMSSEOTypeId = a.CMSSEOTypeId)
			   WHERE NOT EXISTS (SELECT TOP 1 1 FROM dbo.split(@ExceptSeoType,',') t WHERE t.Item = b.Name))
			   PRINT '<-- SEO Data Deleted Sucessfully-->'
			END 
			
		DELETE FROM @DeletedIds DELETE FROM @StatusOut 
		IF  @DeleteAllStore = 1   OR @DeleteAllData =1 
		   BEGIN 
		   DECLARE @TBL_PortalIds TABLE	 ( PortalId int	);
		   DECLARE @TBL_Promotion TABLE ( PromotionId int	);
		  	IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = '_ZnodeDomain')
			BEGIN
				   CREATE TABLE  _ZnodeDomain (PortalId INT  ,DomainName NVARCHAR(max),IsActive BIT ,ApplicationType NVARCHAR(max),CreatedBy INT
		   ,CreatedDate DATETIME ,ModifiedBy INT ,ModIFiedDate DATETIME )
			END 


		   INSERT INTO _ZnodeDomain ( PortalId,DomainName ,IsActive  ,ApplicationType ,CreatedBy,CreatedDate ,ModIFiedBy ,ModIFiedDate) 
		   SELECT PortalId,DomainName ,IsActive  ,ApplicationType ,CreatedBy,CreatedDate ,ModIFiedBy ,ModIFiedDate
		   FROM ZnodeDomain 
		   DECLARE @TBL_DeletedUsers TABLE (AspNetUserId NVARCHAR(1000))

		       SET @DeleteId = Substring((select  ',' + convert(nvarchar(500), PromotionId)  
					FROM ZnodePromotion  SP
					WHERE NOT EXISTS (SELECT TOP 1 1  FROM @ExceptStoreId WHERE id = SP.PortalId )
					for XML Path ('')),2,4000) 
			   
			   

		-- inserting PortalIds which are not present in Order and Quote
		   INSERT INTO @TBL_PortalIds 
		   SELECT PortalId FROM ZnodePortal AS SP
		   WHERE NOT EXISTS (SELECT TOP 1 1  FROM @ExceptStoreId WHERE id = SP.PortalId );

		  	INSERT INTO @StatusOut (Id ,Status)
				EXEC Znode_DeletePromotion  @PromotionId = @DeleteId ,@Status = 1;

		
				IF  EXISTS (SELECT TOP 1 1  FROM @StatusOut WHERE Status = 1 )
				BEGIN 
		     	PRINT '<-- Store Promotion Data Deleted Sucessfully-->'
			    END
			    ELSE 
				BEGIN 
				PRINT '<-- Store Promotion Data Not Deleted Properly -->' 
				END	

-------------------------------------------------

			   DELETE FROM ZnodeGiftCardHistory	
                 WHERE EXISTS( SELECT *  FROM ZnodeGiftCard B	
                               WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS a	
                                                              WHERE a.PortalId = B.PortalId	) AND ZnodeGiftCardHistory.GiftCardId = B.GiftCardId );
	
	
                    DELETE FROM ZnodeRmaRequestItem	
                    WHERE EXISTS( SELECT *  FROM ZnodeGiftCard B WHERE EXISTS ( SELECT TOP 1 1	FROM @TBL_PortalIds AS a  WHERE a.PortalId = B.PortalId	
                              ) AND ZnodeRmaRequestItem.GiftCardId = B.GiftCardId );
	
	
                DELETE FROM ZnodeGiftCardLocale
                    WHERE EXISTS( SELECT *  FROM ZnodeGiftCard B	
                                            WHERE EXISTS ( SELECT TOP 1 1	FROM @TBL_PortalIds AS a	
                                             WHERE a.PortalId = B.PortalId	  ) AND ZnodeGiftCardLocale.GiftCardId = B.GiftCardId );
	
                    	
                    DELETE FROM ZnodeGiftCard	
                    WHERE EXISTS ( SELECT TOP 1 1	
                        FROM @TBL_PortalIds AS a	
                        WHERE a.PortalId = ZnodeGiftCard.PortalId	 );
		
                    DELETE FROM ZnodePortalLoginProvider	
                    WHERE EXISTS ( SELECT TOP 1 1	  FROM @TBL_PortalIds AS a	 WHERE a.PortalId = ZnodePortalLoginProvider.PortalId  );

--------------------------------------------------------------------------------------------------------

		 DELETE FROM  ZnodeBrandPortal  WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeBrandPortal.PortalId);
	    DELETE FROM  ZnodeCustomPortalDetail  WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCustomPortalDetail.PortalId);
		
		 DELETE FROM  ZnodeSupplier WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeSupplier.PortalId)

	     DELETE FROM  ZnodeOmsTemplateLineItem  WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP INNER JOIN ZnodeOmsTemplate ZOT ON 
	     TBP.PortalId = ZOT.PortalId AND ZOT.OmsTemplateId = ZnodeOmsTemplateLineItem.OmsTemplateId);

	     DELETE FROM ZnodeOmsTemplate WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeOmsTemplate.PortalId);
	     DELETE FROM  ZnodeOmsUsersReferralUrl WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeOmsUsersReferralUrl.PortalId)

		DELETE FROM ZnodePortalShipping WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalShipping.PortalId);
		DELETE FROM ZnodePortalTaxClass WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalTaxClass.PortalId);
		DELETE FROM ZnodePortalPaymentSetting WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalPaymentSetting.PortalId);
		DELETE FROM ZnodeCMSPortalMessageKeyTag WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSPortalMessageKeyTag.PortalId);
		DELETE FROM ZnodePriceListProfile WHERE PortalProfileID IN (SELECT PortalProfileID FROM ZnodePortalProfile WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalProfile.PortalId))
		DELETE FROM ZnodePortalProfile WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalProfile.PortalId);
		DELETE FROM ZnodePortalFeatureMapper WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalFeatureMapper.PortalId);
		DELETE FROM ZnodePortalShippingDetails WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalShippingDetails.PortalId);
		DELETE FROM ZnodePortalUnit WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalUnit.PortalId);
		DELETE FROM ZnodeDomain WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeDomain.PortalId);
		
		DELETE FROM ZnodePortalSearchProfile   WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalSearchProfile.PortalId);
		DELETE FROM dbo.ZnodePortalPixelTracking WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalPixelTracking.PortalId); 
		DELETE FROM ZnodeRobotsTxt WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeRobotsTxt.PortalId);
		DELETE FROM ZnodePortalSmtpSetting WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalSmtpSetting.PortalId);
		DELETE FROM ZnodeActivityLog WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeActivityLog.PortalId);
		DELETE FROM ZnodePortalCatalog WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalCatalog.PortalId );
		DELETE FROM ZnodeCMSPortalMessage  WHERE EXISTS  ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSPortalMessage.PortalId );
		DELETE FROM ZnodeGoogleTagManager WHERE  EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeGoogleTagManager.PortalId);
		DELETE FROM ZnodeTaxRuleTypes WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeTaxRuleTypes.PortalId);
		DELETE FROM ZnodeCMSContentPagesProfile WHERE EXISTS (SELECT TOP 1 1 FROM  ZnodeCMSContentPages ZCCP  
											WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZCCP.PortalId) AND ZCCP.CMSContentPagesId = ZnodeCMSContentPagesProfile.CMSContentPagesId )
		DELETE FROM ZnodeCMSContentPageGroupMapping WHERE EXISTS (SELECT TOP 1 1 FROM  ZnodeCMSContentPages ZCCP  
																	WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZCCP.PortalId) AND ZCCP.CMSContentPagesId = ZnodeCMSContentPageGroupMapping.CMSContentPagesId )
	     DELETE FROM ZnodeCMSContentPagesLocale WHERE EXISTS (SELECT TOP 1 1 FROM  ZnodeCMSContentPages ZCCP  
																	WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZCCP.PortalId) AND ZCCP.CMSContentPagesId = ZnodeCMSContentPagesLocale.CMSContentPagesId )
		
		DELETE FROM ZnodeBlogNewsCommentLocale WHERE EXISTS (SELECT TOP 1 1 FROM ZnodeBlogNewsComment ZBC
													WHERE EXISTS (SELECT TOP 1 1 FROM ZnodeBlogNews ZBN
														WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZBN.PortalId) AND ZBN.BlogNewsId = ZBC.BlogNewsId ) and ZBC.BlogNewsCommentId = ZnodeBlogNewsCommentLocale.BlogNewsCommentId)
		DELETE FROM ZnodeBlogNewsComment WHERE EXISTS (SELECT TOP 1 1 FROM ZnodeBlogNews ZBN
													WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZBN.PortalId) AND ZBN.BlogNewsId = ZnodeBlogNewsComment.BlogNewsId )
		 
		DELETE FROM ZnodeBlogNewsContent WHERE EXISTS (SELECT TOP 1 1 FROM ZnodeBlogNews ZBN
													WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZBN.PortalId) AND ZBN.BlogNewsId = ZnodeBlogNewsContent.BlogNewsId )
		DELETE FROM ZnodeBlogNewsLocale WHERE EXISTS (SELECT TOP 1 1 FROM ZnodeBlogNews ZBN
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZBN.PortalId) AND ZBN.BlogNewsId = ZnodeBlogNewsLocale.BlogNewsId )
													
		DELETE FROM ZnodeBlogNews WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeBlogNews.PortalId)
		DELETE FROM  ZnodeFormWidgetEmailConfiguration 	WHERE CMSContentPagesId IN (SELECT CMSContentPagesId FROM ZnodeCMSContentPages WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSContentPages.PortalId))
		DELETE FROM ZnodeCMSContentPages WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSContentPages.PortalId);
		DELETE FROM ZnodeCaseRequestHistory WHERE CaseRequestId IN (SELECT CaseRequestId   FROM ZnodeCaseRequest WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCaseRequest.PortalId))
		DELETE FROM ZnodeCaseRequest WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCaseRequest.PortalId);
		DELETE FROM ZnodePortalLocale WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalLocale.PortalId);
		DELETE FROM ZnodeShippingPortal WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeShippingPortal.PortalId);
		
		--Delete return data against order
		DELETE FROM ZnodeRmaRequestItem
		DELETE FROM ZnodeRmaRequest
		DELETE FROM ZnodeRmaReturnNotes
		DELETE FROM ZnodeRmaReturnEmailHistory
		DELETE FROM ZnodeRmaReturnHistory
		DELETE FROM ZnodeRmaReturnPaymentRefund
		DELETE FROM ZnodeRmaReturnPaymentDetails
		DELETE FROM ZnodeRmaReturnLineItems
		DELETE FROM ZnodeRmaReturnDetails
		--Delete orders against store
		DELETE FROM   @DeletedIds
		INSERT INTO @DeletedIds 
		SELECT distinct OmsOrderID 
		FROM ZnodeOmsOrderDetails  ZP 
		WHERE NOT EXISTS(SELECT * FROM @ExceptStoreId A WHERE ZP.PortalId = A.Id)
		--INSERT INTO @StatusOut (Id ,Status) 
		EXEC [dbo].[Znode_DeleteOrderById] @OmsOrderIds = @DeletedIds , @status = 0  

		DELETE FROM   @DeletedIds
		INSERT INTO @DeletedIds 
		SELECT DISTINCT UserId 
		FROM ZnodeUserPortal 
		WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeUserPortal.PortalId);

		--INSERT INTO @StatusOut (Id ,Status) 
		EXEC [dbo].Znode_DeleteUserDetails @UserIds = @DeletedIds , @status = 0,@IsForceFullyDelete =1 ,@IsCallInternal=1 
		
		DELETE FROM AspNetZnodeUser OUTPUT DELETED.AspNetZnodeUserId   INTO @TBL_DeletedUsers WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = AspNetZnodeUser.PortalId )
		
		DELETE FROM ZnodePortalAlternateWarehouse WHERE EXISTS ( SELECT TOP 1 1 FROM ZnodePortalWareHouse AS ZPWH WHERE EXISTS (
				SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZPWH.PortalId ) AND  ZPWH.PortalWarehouseId = ZnodePortalAlternateWarehouse.PortalWarehouseId);
		DELETE FROM ZnodePortalWareHouse WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalWareHouse.PortalId);
		DELETE ZnodePriceListPortal WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePriceListPortal.PortalId );
		
		DELETE FROM ZnodeEmailTemplateMapper WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeEmailTemplateMapper.PortalId);
		DELETE FROM ZnodeGIFtCard WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeGIFtCard.PortalId );
		DELETE FROM ZnodeCMSPortalProductPage WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSPortalProductPage.PortalId);

		DELETE FROM ZnodeCMSPortalSEOSetting WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSPortalSEOSetting.PortalId);

		DELETE FROM ZnodeCMSPortalTheme WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSPortalTheme.PortalId);

		DELETE FROM ZnodeCMSSEODetailLocale WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP INNER JOIN ZnodeCMSSEODetail AS zcsd ON TBP.PortalId = zcsd.PortalId WHERE zcsd.CMSSEODetailId = ZnodeCMSSEODetailLocale.CMSSEODetailId);
		 
		DELETE FROM ZnodeCMSSEODetail WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSSEODetail.PortalId);
		DELETE FROM ZnodePortalAccount WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalAccount.PortalId);
		DELETE FROM ZnodePortalAddress WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalAddress.PortalId);
		DELETE FROM ZnodePortalCountry WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalCountry.PortalId);
		DELETE FROM ZnodeCMSUrlRedirect WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSUrlRedirect.PortalId);
		DELETE FROM ZnodeTaxPortaL  WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeTaxPortaL.PortalId);
	   	INSERT INTO @TBL_Promotion( PromotionId ) SELECT PromotionId FROM ZnodePromotion WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePromotion.PortalId);
		DELETE FROM ZnodePromotionProduct WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_Promotion AS TBP WHERE TBP.PromotionId = ZnodePromotionProduct.PromotionId);
		DELETE FROM dbo.ZnodePromotionCoupon  WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_Promotion AS TBP WHERE TBP.PromotionId = ZnodePromotionCoupon.PromotionId);
		DELETE FROM ZnodePromotionCategory WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_Promotion AS TBP WHERE TBP.PromotionId = ZnodePromotionCategory.PromotionId);
		DELETE FROM ZnodePromotionCatalogs WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_Promotion AS TBP WHERE TBP.PromotionId = ZnodePromotionCatalogs.PromotionId);
		DELETE FROM ZnodePromotion WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_Promotion AS TBP WHERE TBP.PromotionId = ZnodePromotion.PromotionId);
		DELETE FROM ZnodeBlogNewsLocale WHERE exists (select top 1 1 from ZnodeBlogNews ZBN
													WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZBN.PortalId) AND ZBN.BlogNewsId = ZnodeBlogNewsLocale.BlogNewsId )
		
        DELETE a FROM ZnodeFormBuilderGlobalAttributeValueLocale	a 
			INNER JOIN ZnodeFormBuilderGlobalAttributeValue aa ON (a.FormBuilderGlobalAttributeValueId = aa.FormBuilderGlobalAttributeValueId)INNER JOIN ZnodeFormBuilderSubmit b ON (b.FormBuilderSubmitId =aa.FormBuilderSubmitId)
			 WHERE EXISTS ( SELECT TOP 1 1
									   FROM @TBL_PortalIds AS TBDL
									   WHERE TBDL.PortalId = b.PortalId      
									 ); 
		DELETE a FROM ZnodeFormBuilderGlobalAttributeValue a INNER JOIN ZnodeFormBuilderSubmit b ON (b.FormBuilderSubmitId =a.FormBuilderSubmitId)
		 WHERE EXISTS ( SELECT TOP 1 1
								   FROM @TBL_PortalIds AS TBDL
								   WHERE TBDL.PortalId = b.PortalId      
								 ); 
		DELETE FROM ZnodeFormBuilderSubmit 
		WHERE EXISTS ( SELECT TOP 1 1
								   FROM @TBL_PortalIds AS TBDL
								   WHERE TBDL.PortalId = ZnodeFormBuilderSubmit.PortalId      
								 );   
		DELETE FROM   @DeletedIds
		INSERT INTO @DeletedIds 
		SELECT DISTINCT a.OmsOrderId 
		FROM ZnodeOmsOrder A 
		INNER JOIN ZnodeOMsOrderDetails b  ON (b.OmsOrderId = a.OmsOrderId )
		WHERE   EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = b.PortalId)

		INSERT INTO @StatusOut (Id ,Status) 
		EXEC [dbo].[Znode_DeleteOrderById] @OmsOrderIds = @DeletedIds , @status = 0 

		DELETE FROM @DeletedIds DELETE FROM @StatusOut 									  
		
		DELETE FROM dbo.ZnodeSearchSynonyms	 WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalCatalog Tt WHERE Tt.PublishCatalogId = ZnodeSearchSynonyms.PublishCatalogId )
		DELETE FROM ZnodePublishedXml 
		DELETE FROM ZnodePublishCatalogLog	 WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalCatalog Tt WHERE Tt.PublishCatalogId = ZnodePublishCatalogLog.PublishCatalogId )
		DELETE FROM ZnodePublishCatalogSearchProfile WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalCatalog Tt WHERE Tt.PublishCatalogId = ZnodePublishCatalogSearchProfile.PublishCatalogId )
		DELETE FROM ZnodePublishCategoryProduct   WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalCatalog Tt WHERE Tt.PublishCatalogId = ZnodePublishCategoryProduct.PublishCatalogId )
		DELETE FROM ZnodePublishCategoryDetail 	WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePublishCategoryProduct Tt WHERE Tt.PublishCategoryId = ZnodePublishCategoryDetail.PublishCategoryId )
		DELETE FROM ZnodePublishProductDetail WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePublishCategoryProduct Tt WHERE Tt.PublishCategoryId = ZnodePublishProductDetail.PublishProductId )
		
		DELETE FROM ZnodeCMSWidgetCategory WHERE PublishCategoryId IN (SELECT PublishCategoryId FROM ZnodePublishCategory   WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalCatalog Tt WHERE Tt.PublishCatalogId = ZnodePublishCategory.PublishCatalogId ))

		DELETE FROM ZnodePublishCategory   WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalCatalog Tt WHERE Tt.PublishCatalogId = ZnodePublishCategory.PublishCatalogId )
		DELETE FROM dbo.ZnodeCMSWidgetProduct	WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePublishCategoryProduct Tt WHERE Tt.PublishProductId = ZnodeCMSWidgetProduct.PublishProductId )
		DELETE FROM dbo.ZnodeSearchGlobalProductBoost	WHERE PublishProductId IN (SELECT PublishProductId FROM ZnodePublishProduct	 WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalCatalog Tt WHERE Tt.PublishCatalogId = ZnodePublishProduct.PublishCatalogId ))
		DELETE FROM ZnodeCMSCustomerReview 
			WHERE PublishProductId IN (SELECT PublishProductId FROM ZnodePublishProduct	 WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalCatalog Tt WHERE Tt.PublishCatalogId = ZnodePublishProduct.PublishCatalogId ))
		DELETE FROM ZnodePublishProduct	 WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalCatalog Tt WHERE Tt.PublishCatalogId = ZnodePublishProduct.PublishCatalogId )
		DELETE FROM dbo.ZnodeSearchIndexServerStatus WHERE SearchIndexMonitorId IN (SELECT SearchIndexMonitorId FROM dbo.ZnodeSearchIndexMonitor WHERE CatalogIndexId IN (SELECT CatalogIndexId FROM ZnodeCatalogIndex	 WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalCatalog Tt WHERE Tt.PublishCatalogId = ZnodeCatalogIndex.PublishCatalogId )))
		DELETE FROM dbo.ZnodeSearchIndexMonitor WHERE CatalogIndexId IN (SELECT CatalogIndexId FROM ZnodeCatalogIndex	 WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalCatalog Tt WHERE Tt.PublishCatalogId = ZnodeCatalogIndex.PublishCatalogId ))
		DELETE FROM  ZnodeCatalogIndex   WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalCatalog Tt WHERE Tt.PublishCatalogId = ZnodeCatalogIndex.PublishCatalogId )
		DELETE FROM ZnodeSearchDocumentMapping WHERE PublishCatalogId IN (SELECT PublishCatalogId FROM ZnodePublishCatalog	  WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalCatalog Tt WHERE Tt.PublishCatalogId = ZnodePublishCatalog.PublishCatalogId ))
		
		DELETE FROM ZnodeSearchKeywordsRedirect 
		WHERE EXISTS(SELECT * FROM ZnodePublishCatalog	WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalCatalog Tt WHERE Tt.PublishCatalogId = ZnodePublishCatalog.PublishCatalogId ) AND ZnodeSearchKeywordsRedirect.PublishCatalogId = ZnodePublishCatalog.PublishCatalogId)

		DELETE FROM ZnodePublishCatalog	  WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalCatalog Tt WHERE Tt.PublishCatalogId = ZnodePublishCatalog.PublishCatalogId )
		DELETE FROM ZnodeOmsPersonalizeCartItem WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsSavedCartLineItem WHERE OmsSavedCartId IN (SELECT OmsSavedCartId FROM ZnodeOmsSavedCart WHERE OmsCookieMappingId IN (SELECT OmsCookieMappingId FROM ZnodeOmsCookieMapping WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeOmsCookieMapping.PortalId) ) 	 )) 
		DELETE FROM ZnodeOmsSavedCartLineItem WHERE OmsSavedCartId IN (SELECT OmsSavedCartId FROM ZnodeOmsSavedCart WHERE OmsCookieMappingId IN (SELECT OmsCookieMappingId FROM ZnodeOmsCookieMapping WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeOmsCookieMapping.PortalId) ) 	 )
		DELETE FROM ZnodeOmsSavedCart WHERE OmsCookieMappingId IN (SELECT OmsCookieMappingId FROM ZnodeOmsCookieMapping WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeOmsCookieMapping.PortalId) ) 
		DELETE FROM ZnodeOmsCookieMapping WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeOmsCookieMapping.PortalId); 
		DELETE FROM ZnodeDomain WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeDomain.PortalId);
		
		DELETE FROM ZnodeSalesRepCustomerUserPortal WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeSalesRepCustomerUserPortal.CustomerPortalId);

		delete from ZnodeSalesRepCustomerUserPortal 
		where exists(select * FROM ZnodeUserPortal WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeUserPortal.PortalId) and ZnodeSalesRepCustomerUserPortal.UserPortalId = ZnodeUserPortal.UserPortalId);
		

		DELETE FROM ZnodePortalRecommendationSetting  
		WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalRecommendationSetting.PortalId);
		
		DELETE FROM ZnodePortalPageSetting  
		WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalPageSetting.PortalId);

		DELETE FROM ZnodePortalBrand
		WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalBrand.PortalId);
	
		DELETE FROM ZnodePortalSortSetting
		WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalSortSetting.PortalId);

		DELETE FROM ZnodeImpersonificationLog
		WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeImpersonificationLog.PortalId);

		DELETE FROM ZnodePortalCustomCss
		WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalCustomCss.PortalId);

		DELETE FROM ZnodeSearchActivity
		WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeSearchActivity.PortalId);
		
		DELETE FROM ZnodePortal WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortal.PortalId);
		
		PRINT '<-- Store Data Deleted Sucessfully-->'
	   
	   IF  NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortal) 
	   BEGIN 
	        SET @CMSThemeId = NULL 
			SET @CMSThemeCSSId = NULL  
			
	        SET IDENTITY_INSERT [dbo].[ZnodePortal] ON 
			INSERT [dbo].[ZnodePortal] ([PortalId], [CompanyName], [StoreName], [LogoPath], [UseSSL], [AdminEmail], [SalesEmail], [CustomerServiceEmail], [SalesPhoneNumber], [CustomerServicePhoneNumber], [ImageNotAvailablePath], [ShowSwatchInCategory], [ShowAlternateImageInCategory], [ExternalID], [MobileLogoPath], [DefaultOrderStateID], [DefaultReviewStatus], [SplashCategoryID], [SplashImageFile], [MobileTheme], [CopyContentBasedOnPortalId], [CreatedBy], [CreatedDate], [ModIFiedBy], [ModIFiedDate], [InStockMsg], [OutOfStockMsg], [BackOrderMsg], [OrderAmount], [Email], [StoreCode]) 
			VALUES (1, N'DemoStore', N'DemoStore', NULL, 0, N'test@znode.com', N'test@znode.com', N'test@znode.com', N'123456789', N'123456789', N'', 0, 0, NULL, NULL, 50, N'N', NULL, NULL, NULL, NULL, 2, CAST(N'2018-04-23T01:05:48.620' AS DateTime), 2, CAST(N'2018-04-23T01:05:48.620' AS DateTime), N'Demo', N'Demo', N'Demo', NULL, NULL, 'DemoStore')
			SET IDENTITY_INSERT [dbo].[ZnodePortal] OFF
			SET @PortalId  = 1
			INSERT INTO ZnodePimCatalog (CatalogName,IsActive,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT 'DefaultCatalog' , 1 ,NULL,2 ,GETDATE(),2,GETDATE() 
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimCatalog r WHERE r.CatalogName = 'DefaultCatalog' )
			SET @PimCatalogId = CASE WHEN @PimCatalogId IS nULL THEN (SELECT TOP 1 PimCatalogId FROM ZnodePimCatalog WHERE	CatalogName = 'DefaultCatalog'  ) ELSE  @PimCatalogId END 	
			INSERT INTO ZnodePublishCatalog (PimCatalogId
			,CatalogName
			,ExternalId
			,CreatedBy
			,CreatedDate
			,ModIFiedBy
			,ModIFiedDate
			,Token)
			SELECT @PimCatalogId,'DefaultCatalog' , '',2,GETDATE(),2,GETDAte(),''
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalog WHERE CatalogName = 'DefaultCatalog')
			SET  @PublishCatalogId = CASE WHEN  @PublishCatalogId IS nULL THEN (SELECT TOP 1 PublishCatalogId  FROM ZnodePublishCatalog WHERE CatalogName = 'DefaultCatalog'   )  ELSE @PublishCatalogId END 
			INSERT INTO ZnodeCMSTheme(Name
			,CreatedBy
			,CreatedDate
			,ModIFiedBy
			,ModIFiedDate
			,IsParentTheme
			,ParentThemeId)
			SELECT 'Default',2,GETDATE(),2,GETDATE(),1,NULL
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSTheme WHERE Name = 'Default')
			SET  @CMSThemeId = CASE WHEN @CMSThemeId IS nULL THEN (SELECT TOP 1 CMSThemeId FROM ZnodeCMSTheme WHERE Name = 'Default'   )  ELSE @CMSThemeId END  
		
			INSERT INTO ZnodeCMSThemeCSS  (CMSThemeId
			,CSSName
			,CreatedBy
			,CreatedDate
			,ModIFiedBy
			,ModIFiedDate)
			SELECT @CMSThemeId,'DefaultCSS',2,GETDATE(),2,GETDATE()
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSThemeCSS WHERE CSSName = 'DefaultCSS')
			SET  @CMSThemeCSSId = CASE WHEN @CMSThemeCSSId IS nULL THEN (SELECT TOP 1 CMSThemeCSSId FROM ZnodeCMSThemeCSS WHERE CSSName = 'DefaultCSS'  )  ELSE @CMSThemeCSSId END  
		
			INSERT INTO ZnodeCMSPortalTheme (PortalId
			,CMSThemeId
			,CMSThemeCSSId
			,MediaId
			,FavIconId
			,WebsiteTitle
			,CreatedBy
			,CreatedDate
			,ModIFiedBy
			,ModIFiedDate	)    
			SELECT  @PortalId,@CMSThemeId,@CMSThemeCSSId,NULL,NULL,NULL,2,GETDATE(),2,GETDATE()
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSPortalTheme WHERE PortalId  = @PortalId  )
			INSERT INTO ZnodePortalCatalog (PortalId
			,PublishCatalogId
			,CreatedBy
			,CreatedDate
			,ModIFiedBy
			,ModIFiedDate)
			SELECT @PortalId,@PublishCatalogId,2,GETDATE(),2,GETDATE()
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalCatalog WHERE PortalId  = @PortalId )
			
			INSERT INTO ZnodeDomain (PortalId,DomainName ,IsActive,ApplicationType,CreatedBy ,CreatedDate ,ModIFiedBy ,ModIFiedDate)
			SELECT DISTINCT 1,DomainName ,IsActive,ApplicationType,CreatedBy ,GETDATE()CreatedDate ,ModIFiedBy ,GETDATE()ModIFiedDate 
			FROM _ZnodeDomain  TR
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeDomain TY WHERE TR.PortalId = TY.PortalId AND TR.DomainName = TY.DomainName) 
			GROUP BY DomainName ,IsActive,ApplicationType,CreatedBy,ModifiedBy

			INSERT INTO ZnodePortalUnit (PortalId,CurrencyId,WeightUnit,DimensionUnit,CurrencySuffix,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT @PortalId,(SELECT TOP 1 CurrencyId FROM ZnodeCulture WHERE CultureCode = 'en-US' ) 
			,'Lbs','IN','USD',2,GETDATE(),2,GETDATE()
			WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalUnit  WHERE PortalId = @PortalId AND CurrencyId = (SELECT TOP 1 CurrencyId FROM ZnodeCulture WHERE CultureCode = 'en-US')  )

	   END 
	   
		
		   END  
			 DELETE FROM @DeletedIds DELETE FROM @StatusOut 
			 IF  @ResetDomainData = 1  OR @DeleteAllData =1     
			 BEGIN 
			  DECLARE @OneportalId INT = (SELECT TOP 1 PortalId  FROM ZnodePortal)
			  DELETE FROM ZnodeDomain 
			  INSERT INTO znodedomain(PortalId,DomainName,	IsActive,	ApiKey,	ApplicationType,	CreatedBy,	CreatedDate	,ModIFiedBy	,ModIFiedDate)
			  SELECT @OneportalId, 'localhost:6766',1, '115915F1-7E6B-4386-A623-9779F27D9A5E','Admin',2,GETDATE(),2,GETDATE()
			  WHERE NOT EXISTS(SELECT * FROM znodedomain WHERE DomainName = 'localhost:6766'  and PortalId = (SELECT TOP 1 PortalId FROM ZnodePortal ))
			  
			  INSERT INTO znodedomain(PortalId,DomainName,	IsActive,	ApiKey,	ApplicationType,	CreatedBy,	CreatedDate	,ModIFiedBy	,ModIFiedDate)
			  SELECT @OneportalId, 'localhost:3288',1, 'c58cc0c0-1349-4001-8416-cf1cea7960e8','WebStore',2,GETDATE(),2,GETDATE()
			  WHERE NOT EXISTS(SELECT * FROM znodedomain WHERE DomainName = 'localhost:3288'  and PortalId = (SELECT TOP 1 PortalId FROM ZnodePortal ))
			  
			  INSERT INTO znodedomain(PortalId,DomainName,	IsActive,	ApiKey,	ApplicationType,	CreatedBy,	CreatedDate	,ModIFiedBy	,ModIFiedDate)
			  SELECT @OneportalId, 'localhost:44762',1, '8a8b4931-7d57-42e8-a005-b1c0cce49f1d','Api',2,GETDATE(),2,GETDATE()
			  WHERE NOT EXISTS(SELECT * FROM znodedomain WHERE DomainName = 'localhost:44762' and PortalId = (SELECT TOP 1 PortalId FROM ZnodePortal ) )
			  
			  INSERT INTO znodedomain(PortalId,DomainName,	IsActive,	ApiKey,	ApplicationType,	CreatedBy,	CreatedDate	,ModIFiedBy	,ModIFiedDate)
			  SELECT  @OneportalId  , 'localhost',1, '115915F1-7E6B-4386-A623-9779F27D9A5E','Admin',2,GETDATE(),2,GETDATE()
			  WHERE NOT EXISTS(SELECT * FROM znodedomain WHERE DomainName = 'localhost'  and PortalId = (SELECT TOP 1 PortalId FROM ZnodePortal ))
			 PRINT '<-- Domain reset Sucessfully-->'
			 END 
		DELETE FROM @DeletedIds DELETE FROM @StatusOut 
		IF @DeleteAllShippingMethods = 1 OR @DeleteAllData =1 
		BEGIN 
		
		   	SET @DeleteId = Substring((select  ',' + convert(nvarchar(500), ShippingId)  
					FROM ZnodeShipping for XML Path ('')),2,4000) 
		  -- INSERT INTO @StatusOut (Id ,Status)

		   EXEC Znode_DeleteShipping  @ShippingId = @DeleteId , @Status =0 ,@IsForceFullyDelete =1 
		   
		 PRINT '<-- Shipping Methods are Deleted Sucessfully-->'
			   
		END
		DELETE FROM @DeletedIds DELETE FROM @StatusOut  
		IF @DeleteAllPaymentMethods	 = 1  OR @DeleteAllData =1 
		BEGIN 
			 	 
		INSERT INTO @DeletedIds 
		SELECT DISTINCT a.OmsOrderId 
		FROM ZnodeOmsOrder A 
		INNER JOIN ZnodeOMsOrderDetails b  ON (b.OmsOrderId = a.OmsOrderId )
		WHERE   EXISTS ( SELECT TOP 1 1 FROM ZnodePaymentSetting AS TBP WHERE TBP.PaymentSettingId = b.PaymentSettingId)

		INSERT INTO @StatusOut (Id ,Status) 
		EXEC [dbo].[Znode_DeleteOrderById] @OmsOrderIds = @DeletedIds , @status = 0 
		 
		 DELETE FROM ZnodePortalPaymentSetting 
		 DELETE FROM ZnodeProfilePaymentSetting
		 DELETE FROM ZnodePaymentSetting
		
			  
		 PRINT '<-- Payment Methods are Deleted Sucessfully-->'
			   
		END 
		DELETE FROM @DeletedIds DELETE FROM @StatusOut 
		IF @DeleteAllTaxes	= 1 OR @DeleteAllData =1 		
		BEGIN 
		 
		  	SET @DeleteId = Substring((select  ',' + convert(nvarchar(500), TaxClassId)  
					FROM ZnodeTaxClass for XML Path ('')),2,4000) 
		-- INSERT INTO @StatusOut (Id ,Status) 
		 EXEC [dbo].[Znode_DeleteTaxClass] @TaxClassId =  @DeleteId, @status = 0 , @IsForceFullyDelete =1 
		 DELETE FROM ZnodeTaxRuleTypes   
     	 PRINT '<-- Taxes Data Deleted Sucessfully-->'
		 		 
		END 
		IF  @ResetIdentity =1  OR @DeleteAllData =1 
		 BEGIN
		 DECLARE @table_name varchar(100)= NULL, @showReport bit= 0, @debug bit= 0
	
		IF  OBJECT_ID('tempdb..#reseed_temp1') < 0 
			Drop TABLE #reseed_temp1 
		CREATE TABLE   #reseed_temp1 
		( 
					 tbame varchar(100), mvalue varchar(20) DEFAULT 0
		)

			DECLARE @Tablename varchar(256), @columnname varchar(256), @IndentValue numeric, @query varchar(4000), @query1 nvarchar(4000), @id int;

			DECLARE Cur_Reseed CURSOR LOCAL FAST_FORWARD
			FOR SELECT b.name, c.name
				FROM sys.objects AS a, sys.objects AS b, sys.columns AS c
				WHERE a.type = 'PK' AND 
					  a.parent_object_id = b.object_id AND 
					  b.object_id = c.object_id AND 
					  c.column_id = 1 AND 
					  is_identity <> 0 AND 
					  b.name NOT LIKE '%-%' AND 
					  b.name NOT LIKE '%(%' AND 
					  RTRIM(LTRIM(b.name)) = RTRIM(LTRIM(COALESCE(@table_name, b.name)));

			OPEN Cur_Reseed;

			FETCH NEXT FROM Cur_Reseed INTO @Tablename, @columnname;

			WHILE(@@FETCH_STATUS = 0)

			BEGIN

				 IF  @columnname <> ''

				BEGIN

					SET @query = 'insert into #reseed_temp1  (tbame, mvalue) ( select  '''+@Tablename+''', max( '+@columnname+') from '+@Tablename+')';

					EXECUTE (@query);

					SELECT @Tablename = tbame, @IndentValue = isnull(mvalue,1)
					FROM #reseed_temp1 ;



					DBCC CHECKIDENT(@Tablename, RESEED, @IndentValue);



				END;

				FETCH NEXT FROM Cur_Reseed INTO @Tablename, @columnname;

			END;
			CLOSE Cur_Reseed;
			DEALLOCATE Cur_Reseed;
			DROP TABLE #reseed_temp1
		PRINT '<---Reset Identity Sucessfully-->'
		END   
		--COMMIT TRAN  CleanUpProcess
	 END TRY 
	 BEGIN CATCH 
	 SELECT ERROR_MESSAGE()
	--ROLLBACK TRAN CleanUpProcess
	 END CATCH  
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PurgeGlobalAttributeData')
	DROP PROC Znode_PurgeGlobalAttributeData

GO

CREATE PROCEDURE [Znode_PurgeGlobalAttributeData]
(
	@DeleteAllGlobalAttribute BIT = 0,
	@ExceptGlobalAttributeId TransferId Readonly
)
AS
BEGIN 
BEGIN TRY
	SET NOCOUNT ON;

	--Delete Global Attribute Data
	EXEC [Znode_PurgeData] @DeleteAllGlobalAttribute=@DeleteAllGlobalAttribute,@ExceptGlobalAttributeId=@ExceptGlobalAttributeId

END TRY
BEGIN CATCH
	SELECT ERROR_MESSAGE()	
	DECLARE @Error_procedure varchar(1000)= ERROR_PROCEDURE(), @ErrorMessage nvarchar(max)= ERROR_MESSAGE(), @ErrorLine varchar(100)= ERROR_LINE(), @ErrorCall nvarchar(max) = 'EXEC Znode_PurgeGlobalAttributeData'
	SELECT 0 AS ID, CAST(0 AS bit) AS Status,ERROR_MESSAGE();
	EXEC Znode_InsertProcedureErrorLog @ProcedureName = 'Znode_PurgeGlobalAttributeData', @ErrorInProcedure = @Error_procedure, @ErrorMessage = @ErrorMessage, @ErrorLine = @ErrorLine, @ErrorCall = @ErrorCall;
END CATCH;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PurgeOrderData')
	DROP PROC Znode_PurgeOrderData

GO

CREATE PROCEDURE [dbo].[Znode_PurgeOrderData]
(
	@DeleteAllOrder BIT = 0
)
AS
BEGIN 
BEGIN TRY
	SET NOCOUNT ON;

	--Delete return data against order
	DELETE FROM ZnodeRmaRequestItem
	DELETE FROM ZnodeRmaRequest
	DELETE FROM ZnodeRmaReturnNotes
	DELETE FROM ZnodeRmaReturnEmailHistory
	DELETE FROM ZnodeRmaReturnHistory
	DELETE FROM ZnodeRmaReturnPaymentRefund
	DELETE FROM ZnodeRmaReturnPaymentDetails
	DELETE FROM ZnodeRmaReturnLineItems
	DELETE FROM ZnodeRmaReturnDetails

	--Delete order data
	DECLARE @Loop int
	SET @Loop = 1

	WHILE @Loop = 1
	BEGIN
		
		DECLARE @DeletedIds TransferId 
		delete from @DeletedIds
		INSERT INTO @DeletedIds 
		SELECT top 4000 OmsOrderID 
		FROM ZnodeOmsOrder  ZP 

		EXEC [dbo].[Znode_DeleteOrderById] @OmsOrderIds = @DeletedIds , @status = 0  

		IF EXISTS(SELECT * FROM @DeletedIds)
			SET @Loop = 1
		ELSE 
			SET @Loop = 0

	END
END TRY
BEGIN CATCH
	SELECT ERROR_MESSAGE()	
	DECLARE @Error_procedure varchar(1000)= ERROR_PROCEDURE(), @ErrorMessage nvarchar(max)= ERROR_MESSAGE(), @ErrorLine varchar(100)= ERROR_LINE(), @ErrorCall nvarchar(max) = 'EXEC Znode_PurgeOrderData'
	SELECT 0 AS ID, CAST(0 AS bit) AS Status,ERROR_MESSAGE();
	EXEC Znode_InsertProcedureErrorLog @ProcedureName = 'Znode_PurgeOrderData', @ErrorInProcedure = @Error_procedure, @ErrorMessage = @ErrorMessage, @ErrorLine = @ErrorLine, @ErrorCall = @ErrorCall;
END CATCH;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PurgeProductCategoryAttributeData')
	DROP PROC Znode_PurgeProductCategoryAttributeData

GO

CREATE PROCEDURE [Znode_PurgeProductCategoryAttributeData]
(
	@DeleteAllProductCategoryAttribute BIT = 0,
	@ExceptProductCategoryAttributeId TransferId Readonly
)
AS
BEGIN 
BEGIN TRY
	SET NOCOUNT ON;

	--Delete Product AND Category Attribute Data
	EXEC [Znode_PurgeData] @DeleteAllProductCategoryAttribute=@DeleteAllProductCategoryAttribute,@ExceptProductCategoryAttributeId=@ExceptProductCategoryAttributeId

END TRY
BEGIN CATCH
	SELECT ERROR_MESSAGE()	
	DECLARE @Error_procedure varchar(1000)= ERROR_PROCEDURE(), @ErrorMessage nvarchar(max)= ERROR_MESSAGE(), @ErrorLine varchar(100)= ERROR_LINE(), @ErrorCall nvarchar(max) = 'EXEC Znode_PurgeProductCategoryAttributeData'
	SELECT 0 AS ID, CAST(0 AS bit) AS Status,ERROR_MESSAGE();
	EXEC Znode_InsertProcedureErrorLog @ProcedureName = 'Znode_PurgeProductCategoryAttributeData', @ErrorInProcedure = @Error_procedure, @ErrorMessage = @ErrorMessage, @ErrorLine = @ErrorLine, @ErrorCall = @ErrorCall;
END CATCH;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PurgeProductData')
	DROP PROC Znode_PurgeProductData

GO

CREATE PROCEDURE [Znode_PurgeProductData]
(
	@DeleteAllProduct BIT = 0,
	@ExceptProductId TransferId Readonly
)
AS
BEGIN 
BEGIN TRY
	SET NOCOUNT ON;		
	--Delete products
	EXECUTE [Znode_PurgeData] @DeleteAllProduct = @DeleteAllProduct,@ExceptProductId=@ExceptProductId

	--Delete publish references of deleted products
	DECLARE @DeletedIds TransferId 
	INSERT INTO @DeletedIds
	SELECT ZPP.PublishProductId
	FROM ZnodePublishProduct ZPP
	WHERE NOT EXISTS(SELECT * FROM ZnodePimProduct ZPP1 WHERE ZPP1.PimProductId = ZPP.PimProductId)

	DELETE FROM ZnodePublishProductRecordset
	WHERE EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodePublishProductRecordset.PublishProductId = D.Id)
	DELETE FROM ZnodeSearchGlobalProductBoost
	WHERE EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodeSearchGlobalProductBoost.PublishProductId = D.Id)
	DELETE FROM ZnodeSearchGlobalProductBoost
	WHERE EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodeSearchGlobalProductBoost.PublishProductId = D.Id)
	DELETE FROM ZnodeCMSCustomerReview
	WHERE EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodeCMSCustomerReview.PublishProductId = D.Id)
	DELETE FROM ZnodePromotionProduct
	WHERE EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodePromotionProduct.PublishProductId = D.Id)
	DELETE FROM ZnodePublishCategoryProduct
	WHERE EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodePublishCategoryProduct.PublishProductId = D.Id)

	DELETE FROM ZnodePublishCatalogProductDetail
	WHERE EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodePublishCatalogProductDetail.PublishProductId = D.Id)
	DELETE FROM ZnodePublishProductDetail
	WHERE EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodePublishProductDetail.PublishProductId = D.Id)
	DELETE FROM ZnodeCMSWidgetProduct
	WHERE EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodeCMSWidgetProduct.PublishProductId = D.Id)
	DELETE FROM ZnodePublishProduct
	WHERE EXISTS(SELECT * FROM @DeletedIds D WHERE ZnodePublishProduct.PublishProductId = D.Id)

END TRY
	BEGIN CATCH
		SELECT ERROR_MESSAGE()	
		DECLARE @Error_procedure varchar(1000)= ERROR_PROCEDURE(), @ErrorMessage nvarchar(max)= ERROR_MESSAGE(), @ErrorLine varchar(100)= ERROR_LINE(), @ErrorCall nvarchar(max) = 'EXEC Znode_PurgeProductData'
		SELECT 0 AS ID, CAST(0 AS bit) AS Status,ERROR_MESSAGE();
		EXEC Znode_InsertProcedureErrorLog @ProcedureName = 'Znode_PurgeProductData', @ErrorInProcedure = @Error_procedure, @ErrorMessage = @ErrorMessage, @ErrorLine = @ErrorLine, @ErrorCall = @ErrorCall;
	END CATCH;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PurgePublishedData')
	DROP PROC Znode_PurgePublishedData

GO

CREATE PROCEDURE [Znode_PurgePublishedData]
(
	@DeleteAllPublishedData BIT = 0
)
AS
BEGIN 
BEGIN TRY
	SET NOCOUNT ON;

	--Delete store data
	EXEC [Znode_PurgeData] @DeleteAllPublishedData = @DeleteAllPublishedData
	
END TRY
BEGIN CATCH
	SELECT ERROR_MESSAGE()	
	DECLARE @Error_procedure varchar(1000)= ERROR_PROCEDURE(), @ErrorMessage nvarchar(max)= ERROR_MESSAGE(), @ErrorLine varchar(100)= ERROR_LINE(), @ErrorCall nvarchar(max) = 'EXEC Znode_PurgePublishedData'
	SELECT 0 AS ID, CAST(0 AS bit) AS Status,ERROR_MESSAGE();
	EXEC Znode_InsertProcedureErrorLog @ProcedureName = 'Znode_PurgePublishedData', @ErrorInProcedure = @Error_procedure, @ErrorMessage = @ErrorMessage, @ErrorLine = @ErrorLine, @ErrorCall = @ErrorCall;
END CATCH;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PurgeStoreData')
	DROP PROC Znode_PurgeStoreData

GO

CREATE PROCEDURE [Znode_PurgeStoreData]
(
	@DeleteAllStore BIT = 0,
	@ExceptStoreId TransferId Readonly 
)
AS
BEGIN 
BEGIN TRY
	SET NOCOUNT ON;

	--Delete store data
	EXEC [Znode_PurgeData] @DeleteAllStore = @DeleteAllStore,@ExceptStoreId=@ExceptStoreId
	
END TRY
BEGIN CATCH
	SELECT ERROR_MESSAGE()	
	DECLARE @Error_procedure varchar(1000)= ERROR_PROCEDURE(), @ErrorMessage nvarchar(max)= ERROR_MESSAGE(), @ErrorLine varchar(100)= ERROR_LINE(), @ErrorCall nvarchar(max) = 'EXEC Znode_PurgeStoreData'
	SELECT 0 AS ID, CAST(0 AS bit) AS Status,ERROR_MESSAGE();
	EXEC Znode_InsertProcedureErrorLog @ProcedureName = 'Znode_PurgeStoreData', @ErrorInProcedure = @Error_procedure, @ErrorMessage = @ErrorMessage, @ErrorLine = @ErrorLine, @ErrorCall = @ErrorCall;
END CATCH;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PurgeUserData')
	DROP PROC Znode_PurgeUserData

GO

CREATE PROCEDURE [Znode_PurgeUserData]
(
	@DeleteAllUser BIT = 0,
	@ExceptUserId TransferId Readonly
)
AS
BEGIN 
BEGIN TRY
	SET NOCOUNT ON;
	--Delete users
	EXECUTE [Znode_PurgeData] @DeleteAllUser = @DeleteAllUser,@ExceptUserId=@ExceptUserId

END TRY
	BEGIN CATCH
		SELECT ERROR_MESSAGE()	
		DECLARE @Error_procedure varchar(1000)= ERROR_PROCEDURE(), @ErrorMessage nvarchar(max)= ERROR_MESSAGE(), @ErrorLine varchar(100)= ERROR_LINE(), @ErrorCall nvarchar(max) = 'EXEC Znode_PurgeUserData'
		SELECT 0 AS ID, CAST(0 AS bit) AS Status,ERROR_MESSAGE();
		EXEC Znode_InsertProcedureErrorLog @ProcedureName = 'Znode_PurgeUserData', @ErrorInProcedure = @Error_procedure, @ErrorMessage = @ErrorMessage, @ErrorLine = @ErrorLine, @ErrorCall = @ErrorCall;
	END CATCH;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportSEODetails')
	DROP PROC Znode_ImportSEODetails

GO


CREATE PROCEDURE [dbo].[Znode_ImportSEODetails]
(  
   @TableName NVARCHAR(100), 
   @Status BIT OUT, 
   @UserId INT, 
   @ImportProcessLogId INT, 
   @NewGUId NVARCHAR(200), 
   @LocaleId INT= 1,
   @PortalId INT ,
   @CsvColumnString NVARCHAR(max)
)  
AS  
 --------------------------------------------------------------------------------------  
 -- Summary :  Import SEO Details  
   
 -- Unit Testing :   
 --------------------------------------------------------------------------------------  
  
BEGIN  
BEGIN TRAN A;  
BEGIN TRY  
   
	DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(max);  
	DECLARE @GetDate DATETIME= dbo.Fn_GetDate();  
    
    
	DECLARE @CMSSEOTypeProduct INT ,@CMSSEOTypeCategory INT  
  
	SELECT @CMSSEOTypeProduct = CMSSEOTypeId FROM ZnodeCMSSEOType WHERE Name = 'Product'  
	SELECT @CMSSEOTypeCategory = CMSSEOTypeId FROM ZnodeCMSSEOType WHERE Name = 'Category'  
  
  
	-- Three type of import required three table varible for product , category AND brAND  
	DECLARE @InsertSEODetails TABLE  
	(   
		RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, ImportType varchar(20), Code NVARCHAR(300),   
		IsRedirect BIT ,MetaInformation NVARCHAR(max),PortalId INT ,SEOUrl NVARCHAR(max),IsActive varchar(10),  
		SEOTitle NVARCHAR(max),SEODescription NVARCHAR(max),SEOKeywords NVARCHAR(max),   
		RedirectFROM NVARCHAR(max),RedirectTo NVARCHAR(max), EnableRedirection BIT, CanonicalURL VARCHAR(200),   
		RobotTag VARCHAR(50), GUID NVARCHAR(400)  
	);  
  
	DECLARE @InsertSEODetailsOFProducts TABLE  
	(   
		RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, ImportType varchar(20), Code NVARCHAR(300),   
		IsRedirect BIT ,MetaInformation NVARCHAR(max),PortalId INT ,SEOUrl NVARCHAR(max),IsActive varchar(10),  
		SEOTitle NVARCHAR(max),SEODescription NVARCHAR(max),SEOKeywords NVARCHAR(max),  
		RedirectFROM NVARCHAR(max),RedirectTo NVARCHAR(max), EnableRedirection BIT, CanonicalURL VARCHAR(200),  
		RobotTag VARCHAR(50),GUID NVARCHAR(400) 
	);  
  
	DECLARE @InsertSEODetailsOFCategory TABLE  
	(   
		RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, ImportType varchar(20), Code NVARCHAR(300),   
		IsRedirect BIT ,MetaInformation NVARCHAR(max),PortalId INT ,SEOUrl NVARCHAR(max),IsActive varchar(10),  
		SEOTitle NVARCHAR(max),SEODescription NVARCHAR(max),SEOKeywords NVARCHAR(max),  
		RedirectFROM NVARCHAR(max),RedirectTo NVARCHAR(max), EnableRedirection BIT, CanonicalURL VARCHAR(200), 
		RobotTag VARCHAR(50),GUID NVARCHAR(400)
	);  
  
	DECLARE @InsertSEODetailsOFBrAND TABLE  
	(   
		RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, ImportType varchar(20), Code NVARCHAR(300),   
		IsRedirect BIT ,MetaInformation NVARCHAR(max),PortalId INT ,SEOUrl NVARCHAR(max),IsActive varchar(10),  
		SEOTitle NVARCHAR(max),SEODescription NVARCHAR(max),SEOKeywords NVARCHAR(max),   
		RedirectFROM NVARCHAR(max),RedirectTo NVARCHAR(max), EnableRedirection BIT, CanonicalURL VARCHAR(200),  
		RobotTag VARCHAR(50),GUID NVARCHAR(400) 
	);  
  
    
	DECLARE @InsertedZnodeCMSSEODetail TABLE  
	(   
		CMSSEODetailId INT , SEOCode Varchar(4000), CMSSEOTypeId INT  
	);  
    
	--SET @SSQL = 'SELECT RowNumber,ImportType,Code,IsRedirect,MetaInformation,SEOUrl,IsActive,SEOTitle,SEODescription,SEOKeywords,GUID  FROM '+@TableName;  
	SET @SSQL = 'SELECT RowNumber,'+@CsvColumnString+',GUID  FROM '+@TableName;  
  
	INSERT INTO @InsertSEODetails(RowNumber,ImportType,Code,IsRedirect,MetaInformation,SEOUrl,IsActive,SEOTitle,SEODescription,SEOKeywords,RedirectFrom,RedirectTo,EnableRedirection,CanonicalURL,RobotTag,GUID )  
	EXEC sys.sp_sqlexec @SSQL;  
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '30', 'SEOUrl', SEOUrl, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii   
	WHERE ii.SEOURL IN (SELECT ISD.SEOURL FROM @InsertSEODetails ISD Group by ISD.SEOUrl having count(*) > 1 ) 
	    
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '10', 'SEOUrl', SEOUrl, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii   
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEODetail ZCSD WHERE ZCSD.SEOUrl = ii.SEOUrl AND ZCSD.PortalId = @PortalId
	AND ZCSD.SEOCode <> ii.Code  AND EXISTS  
	(SELECT TOP 1 1 FROM ZnodeCMSSEODetailLocale dl WHERE dl.CMSSEODetailId = ZCSD.CMSSEODetailId AND dl.LocaleId = @LocaleId  
	AND dl.SEODescription = ii.SEODescription AND dl.SEOTitle = ii.SEOTitle AND dl.SEOKeywords = ii.SEOKeywords))   
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '53', 'RedirectFrom', RedirectFrom, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii   
	WHERE ii.RedirectFROM IN (SELECT ISD.RedirectFROM FROM @InsertSEODetails ISD Group by ISD.RedirectFROM having count(*) > 1 )   
	AND (ii.RedirectFROM <> '' )

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '35', 'RedirectFrom\RedirectTo', RedirectFROM + '  ' + RedirectTo  , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii   
	WHERE ii.RedirectFROM = ii.RedirectTo  
	AND (ii.RedirectFROM <> '' AND ii.RedirectTo <> '' )
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '35', 'SEOUrl', SEOUrl, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii  
	WHERE LTRIM(RTRIM(ISNULL(ii.SEOUrl,''))) like '% %' -----space not allowed  
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '19', 'ImportType', ImportType, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii  
	WHERE ii.ImportType NOT IN   
	(  
		SELECT NAME FROM ZnodeCMSSEOType WHERE NAME NOT IN ('Content Page','BlogNews','Brand')  
	);  

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '35', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii  
	WHERE ii.IsActive not IN ('True','1','Yes','FALSE','0','No')
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '9', 'RobotTag', RobotTag, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii  
	WHERE ii.RobotTag not IN ( 'INDEX_FOLLOW','NOINDEX_NOFOLLOW','NOINDEX_FOLLOW','INDEX_NOFOLLOW','1','2','3','4') 
	AND ISNULL(ii.RobotTag,'')<>''

	UPDATE ZIL
	SET ZIL.ColumnName =   ZIL.ColumnName + ' [ SEOCode - ' + ISNULL(Code,'') + ' ] '
	FROM ZnodeImportLog ZIL 
	INNER JOIN @InsertSEODetails IPA ON (ZIL.RowNumber = IPA.RowNumber)
	WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

	DELETE FROM @InsertSEODetails  
	WHERE RowNumber IN  
	(  
		SELECT DISTINCT   
		RowNumber  
		FROM ZnodeImportLog  
		WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber is not null   
	);  

	-------------------------------------------------------------------------------------------------------------------------------  
  
	INSERT INTO @InsertSEODetailsOFProducts(  RowNumber , ImportType , Code ,   
	IsRedirect ,MetaInformation ,SEOUrl ,IsActive ,  
	SEOTitle ,SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag, GUID )  
	SELECT RowNumber , ImportType , Code , IsRedirect ,MetaInformation ,SEOUrl , 
	CASE WHEN IsActive IN ('True','1','Yes') 
	Then 1 
	ELSE 0
	END as IsActive, SEOTitle ,SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag, GUID  
	FROM @InsertSEODetails WHERE ImportType = 'Product'  
  
  
	INSERT INTO @InsertSEODetailsOFCategory( RowNumber , ImportType , Code ,   
	IsRedirect ,MetaInformation,SEOUrl ,IsActive ,  
	SEOTitle ,SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag , GUID )  
	SELECT RowNumber , ImportType , Code , IsRedirect ,MetaInformation ,SEOUrl , 
		CASE WHEN IsActive IN ('True','1','Yes') Then 1 ELSE 0 END as IsActive, SEOTitle ,
		SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag, GUID  
	FROM @InsertSEODetails WHERE ImportType = 'Category'  
  
	INSERT INTO @InsertSEODetailsOFBrand( RowNumber , ImportType , Code ,   
	IsRedirect ,MetaInformation ,SEOUrl ,IsActive ,  
	SEOTitle ,SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag , GUID )  
	SELECT RowNumber , ImportType , Code , IsRedirect ,MetaInformation ,SEOUrl ,
		CASE WHEN IsActive IN ('True','1','Yes') Then 1 ELSE 0 END as IsActive, SEOTitle ,
		SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag, GUID  
	FROM @InsertSEODetails WHERE ImportType = 'Brand'  
  
  
	-- start Functional Validation   
	--1. Product  
	--2. Category  
	--3. Content Page  
	--4. BrAND  
	-----------------------------------------------  
  
    
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '19', 'SKU', CODE, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetailsOFProducts AS ii  
	WHERE ii.CODE NOT IN   
	(  
		SELECT ZPAVL.AttributeValue  
		FROM ZnodePimAttributeValue ZPAV   
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId  
		INNER JOIN ZnodePimAttribute ZPA on ZPAV.PimAttributeId = ZPA.PimAttributeId  
		WHERE ZPA.AttributeCode = 'SKU' AND ZPAVL.AttributeValue IS NOT NULL   
	)  AND ImportType = 'Product';  
  

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '19', 'Category', CODE, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetailsOFCategory AS ii  
	WHERE ii.CODE NOT IN   
	(  
		SELECT ZPCAVL.CategoryValue  
		FROM ZnodePimCategoryAttributeValue ZPCAV   
		INNER JOIN ZnodePimCategoryAttributeValueLocale ZPCAVL on ZPCAV.PimCategoryAttributeValueId = ZPCAVL.PimCategoryAttributeValueId  
		INNER JOIN ZnodePimAttribute ZPA on ZPCAV.PimAttributeId = ZPA.PimAttributeId  
		WHERE ZPA.AttributeCode = 'CategoryCode' AND ZPCAVL.CategoryValue IS NOT NULL  
	)  AND ImportType = 'Category';  
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '19', 'Brand', CODE, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetailsOFBrAND AS ii  
	WHERE ii.CODE NOT IN   
	(  
		SELECT BrandCode FROM ZnodeBrandDetails WHERE BrandCode IS NOT NULL  
	)  AND ImportType = 'Brand';  
    
	-- UPDATE Record count IN log 
	DECLARE @FailedRecordCount BIGINT
	DECLARE @SuccessRecordCount BIGINT
	SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
	SELECT @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertSEODetails
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
	WHERE ImportProcessLogId = @ImportProcessLogId;
	

	--Note : Content page import is not required   
    
	-- End Function Validation    
	-----------------------------------------------  
	--- Delete Invalid Data after functional validatin    
 
	DELETE FROM @InsertSEODetailsOFProducts  
	WHERE RowNumber IN  
	(  
		SELECT DISTINCT   
		RowNumber  
		FROM ZnodeImportLog  
		WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber is not null   
	);  
  
	DELETE FROM @InsertSEODetailsOFCategory  
	WHERE RowNumber IN  
	(  
		SELECT DISTINCT   
		RowNumber  
		FROM ZnodeImportLog  
		WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber is not null   
	);  
  
	DELETE FROM @InsertSEODetailsOFBrAND  
	WHERE RowNumber IN  
	(  
		SELECT DISTINCT   
		RowNumber  
		FROM ZnodeImportLog  
		WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber is not null   
	);  
  
 
	-- Insert Product Data   
	IF EXISTS (SELECT TOP 1 1 FROM @InsertSEODetailsOFProducts)  
	BEGIN  
		UPDATE ZCSD SET ZCSD.IsRedirect = ISD.IsRedirect ,  
			ZCSD.MetaInformation =  ISD.MetaInformation,  
			ZCSD.SEOUrl=  ISD.SEOUrl,  
			ZCSD.IsPublish = 0  
		FROM @InsertSEODetailsOFProducts ISD    
		INNER JOIN ZnodeCMSSEODetail ZCSD ON  ZCSD.CMSSEOTypeId = @CMSSEOTypeProduct AND ZCSD.SEOCode = ISD.Code  
		INNER JOIN ZnodeCMSSEODetailLocale ZCSDL ON ZCSD.CMSSEODetailId = ZCSDL.CMSSEODetailId  
		WHERE  ZCSD.PortalId  =@PortalId;  
     
		UPDATE ZCSDL SET ZCSDL.SEOTitle = ISD.SEOTitle  
			,ZCSDL.SEODescription = ISD.SEODescription  
			,ZCSDL.SEOKeywords= ISD.SEOKeywords
			,ZCSDL.CanonicalURL = ISD.CanonicalURL
			,ZCSDL.RobotTag = ISD.RobotTag  
		FROM @InsertSEODetailsOFProducts ISD    
		INNER JOIN ZnodeCMSSEODetail ZCSD ON  ZCSD.CMSSEOTypeId = @CMSSEOTypeProduct AND ZCSD.SEOCode = ISD.Code  
		INNER JOIN ZnodeCMSSEODetailLocale ZCSDL ON ZCSD.CMSSEODetailId = ZCSDL.CMSSEODetailId  
		WHERE  ZCSD.PortalId = @PortalId AND ZCSDL.LocaleId = @LocaleId;   
  
		----Making product as draft if SEOUrl is changed for part of partial publish
		UPDATE ZPP SET ZPP.PublishStateId = (SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE StateName = 'Draft')
		FROM ZnodePimProduct ZPP
		INNER JOIN ZnodePimAttributeValue ZPAV ON ZPP.PimProductId = ZPAV.PimProductId
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		WHERE EXISTS (SELECT * FROM ZnodePimAttribute zpa WHERE zpa.AttributeCode = 'SKU' AND ZPAV.PimAttributeId = zpa.PimAttributeId)
		AND EXISTS(SELECT * FROM @InsertSEODetailsOFProducts ISD    
			INNER JOIN ZnodeCMSSEODetail ZCSD ON  ZCSD.CMSSEOTypeId = @CMSSEOTypeProduct AND ZCSD.SEOCode = ISD.Code
			WHERE ZPAVL.AttributeValue = ZCSD.SEOCode)
     
		INSERT INTO ZnodeCMSSEODetailLocale (CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CanonicalURL,RobotTag)  
		SELECT DISTINCT CSD.CMSSEODetailId,@LocaleId,ISD.SEOTitle,ISD.SEODescription,ISD.SEOKeywords,@USerId, @GetDate,@USerId, @GetDate, CanonicalURL,RobotTag  
		FROM ZnodeCMSSEODetail CSD  
		INNER JOIN @InsertSEODetailsOFProducts ISD ON CSD.SEOCode = ISD.Code AND CSD.CMSSEOTypeId = @CMSSEOTypeProduct   
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEODetailLocale CSDL WHERE CSDL.LocaleId = @LocaleId AND CSD.CMSSEODetailId = CSDL.CMSSEODetailId )  
		AND CSD.portalId = @PortalId  
  
     
		DELETE FROM @InsertedZnodeCMSSEODetail  

		INSERT INTO ZnodeCMSSEODetail(CMSSEOTypeId,SEOCode,IsRedirect,MetaInformation,PortalId,SEOUrl,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)    
		OUTPUT Inserted.CMSSEODetailId,Inserted.SEOCode,Inserted.CMSSEOTypeId INTO @InsertedZnodeCMSSEODetail    
		SELECT DISTINCT @CMSSEOTypeProduct,ISD.Code , ISD.IsRedirect,ISD.MetaInformation,@PortalId,ISD.SEOUrl,@USerId, @GetDate,@USerId, @GetDate FROM   
		@InsertSEODetailsOFProducts ISD    
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEODetail ZCSD WHERE ZCSD.CMSSEOTypeId = @CMSSEOTypeProduct AND ZCSD.SEOCode = ISD.Code AND  ZCSD.PortalId =@PortalId   );  
    
		INSERT INTO ZnodeCMSSEODetailLocale(CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CanonicalURL,RobotTag)  
		SELECT DISTINCT IZCSD.CMSSEODetailId,@LocaleId,ISD.SEOTitle,ISD.SEODescription,ISD.SEOKeywords,@USerId, @GetDate,@USerId, @GetDate,CanonicalURL,RobotTag   
		FROM @InsertedZnodeCMSSEODetail IZCSD   
		INNER JOIN @InsertSEODetailsOFProducts ISD ON IZCSD.SEOCode = ISD.Code   

		----Making product as draft if SEOUrl is inserted for part of partial publish
		UPDATE ZPP SET ZPP.PublishStateId = (SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE StateName = 'Draft')
		FROM ZnodePimProduct ZPP
		INNER JOIN ZnodePimAttributeValue ZPAV ON ZPP.PimProductId = ZPAV.PimProductId
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		WHERE EXISTS (SELECT * FROM ZnodePimAttribute zpa WHERE zpa.AttributeCode = 'SKU' AND ZPAV.PimAttributeId = zpa.PimAttributeId)
		AND EXISTS(SELECT * FROM @InsertedZnodeCMSSEODetail IZCSD WHERE ZPAVL.AttributeValue = IZCSD.SEOCode)
  
		-----RedirectUrlInsert  
		INSERT INTO ZnodeCMSUrlRedirect ( RedirectFrom,RedirectTo,IsActive,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)  
		SELECT RedirectFrom,RedirectTo,
		EnableRedirection,@PortalId as PortalId ,2 as CreatedBy,@GetDate as CreatedDate,2 as ModifiedBy,@GetDate as ModifiedDate  
		FROM @InsertSEODetailsOFProducts SDP  
		WHERE IsRedirect = 1
		AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSUrlRedirect ZCR 
			WHERE ZCR.RedirectFROM = SDP.RedirectFROM AND ZCR.RedirectTo = SDP.RedirectTo)
			AND (SDP.RedirectFROM <> '' AND SDP.RedirectTo <> '' )
  
	END  
  
	-- Insert Category Data   
	IF EXISTS (SELECT TOP 1 1 FROM @InsertSEODetailsOFCategory)  
	BEGIN  
  
		UPDATE ZCSD SET ZCSD.IsRedirect = ISD.IsRedirect ,  
			ZCSD.MetaInformation =  ISD.MetaInformation,  
			ZCSD.SEOUrl=  ISD.SEOUrl,  
			ZCSD.IsPublish = 0  
		FROM @InsertSEODetailsOFCategory ISD    
		INNER JOIN ZnodeCMSSEODetail ZCSD ON  ZCSD.CMSSEOTypeId = @CMSSEOTypeCategory AND ZCSD.SEOCode = ISD.Code  
		INNER JOIN ZnodeCMSSEODetailLocale ZCSDL ON ZCSD.CMSSEODetailId = ZCSDL.CMSSEODetailId  
		WHERE  ZCSD.PortalId  =@PortalId;  
     
     
		UPDATE ZCSDL SET ZCSDL.SEOTitle = ISD.SEOTitle  
			,ZCSDL.SEODescription = ISD.SEODescription  
			,ZCSDL.SEOKeywords= ISD.SEOKeywords 
			,CanonicalURL = ISD.CanonicalURL
			,RobotTag = ISD.RobotTag
		FROM @InsertSEODetailsOFCategory ISD    
		INNER JOIN ZnodeCMSSEODetail ZCSD ON  ZCSD.CMSSEOTypeId = @CMSSEOTypeCategory AND ZCSD.SEOCode = ISD.Code  
		INNER JOIN ZnodeCMSSEODetailLocale ZCSDL ON ZCSD.CMSSEODetailId = ZCSDL.CMSSEODetailId  
		WHERE  ZCSD.PortalId  =@PortalId AND ZCSDL.LocaleId = @LocaleId;   
  
		INSERT INTO ZnodeCMSSEODetailLocale (CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CanonicalURL,RobotTag)  
		SELECT DISTINCT CSD.CMSSEODetailId,@LocaleId,ISD.SEOTitle,ISD.SEODescription,ISD.SEOKeywords,@USerId, @GetDate,@USerId, @GetDate,CanonicalURL,RobotTag  
		FROM ZnodeCMSSEODetail CSD  
		INNER JOIN @InsertSEODetailsOFProducts ISD ON CSD.SEOCode = ISD.Code AND CSD.CMSSEOTypeId = @CMSSEOTypeCategory   
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEODetailLocale CSDL WHERE CSDL.LocaleId = @LocaleId AND CSD.CMSSEODetailId = CSDL.CMSSEODetailId )  
		AND CSD.portalId = @PortalId  
  
  
		DELETE FROM @InsertedZnodeCMSSEODetail  

		INSERT INTO ZnodeCMSSEODetail(CMSSEOTypeId,SEOCode,IsRedirect,MetaInformation,PortalId,SEOUrl,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)    
		OUTPUT Inserted.CMSSEODetailId,Inserted.SEOCode,Inserted.CMSSEOTypeId INTO @InsertedZnodeCMSSEODetail    
		SELECT DISTINCT @CMSSEOTypeCategory,ISD.Code , ISD.IsRedirect,ISD.MetaInformation,@PortalId,ISD.SEOUrl,@USerId, @GetDate,@USerId, @GetDate   
		FROM @InsertSEODetailsOFCategory ISD    
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEODetail ZCSD WHERE ZCSD.CMSSEOTypeId = @CMSSEOTypeCategory AND ZCSD.SEOCode  = ISD.Code AND ZCSD.PortalId = @PortalId );  
  
		INSERT INTO ZnodeCMSSEODetailLocale(CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CanonicalURL,RobotTag)  
		SELECT DISTINCT IZCSD.CMSSEODetailId,@LocaleId,ISD.SEOTitle,ISD.SEODescription,ISD.SEOKeywords,@USerId, @GetDate,@USerId, @GetDate,CanonicalURL,RobotTag   
		FROM @InsertedZnodeCMSSEODetail IZCSD   
		INNER JOIN @InsertSEODetailsOFCategory ISD ON IZCSD.SEOCode = ISD.Code   
		WHERE IZCSD.CMSSEOTypeId =@CMSSEOTypeCategory    

		-----RedirectUrlInsert  
		INSERT INTO ZnodeCMSUrlRedirect ( RedirectFrom,RedirectTo,IsActive,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)  
		SELECT RedirectFrom,RedirectTo,
		EnableRedirection,@PortalId as PortalId ,2 as CreatedBy,@GetDate as CreatedDate,2 as ModifiedBy,@GetDate as ModifiedDate  
		FROM @InsertSEODetailsOFCategory SDP  
		WHERE IsRedirect = 1 
		AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSUrlRedirect ZCR 
			WHERE ZCR.RedirectFROM = SDP.RedirectFROM AND ZCR.RedirectTo = SDP.RedirectTo)
			AND (SDP.RedirectFROM <> '' AND SDP.RedirectTo <> '' )
	END  

	UPDATE ZnodeImportProcessLog  
	SET Status = dbo.Fn_GetImportStatus( 2 ), ProcessCompletedDate = @GetDate  
	WHERE ImportProcessLogId = @ImportProcessLogId;  
  
COMMIT TRAN A;  
END TRY  
BEGIN CATCH  
ROLLBACK TRAN A;

	SET @Status = 0;  
	SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE(); 

	DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportSEODetails @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@LocaleId='+CAST(@LocaleId AS VARCHAR(max)) +',@PortalId='+CAST(@PortalId AS VARCHAR(max)) +',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max)) ;

	---Import process updating fail due to database error
	UPDATE ZnodeImportProcessLog
	SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
	WHERE ImportProcessLogId = @ImportProcessLogId;

	---Loging error for Import process due to database error
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

	--Updating total AND fail record count
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
	TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
	WHERE ImportProcessLogId = @ImportProcessLogId;

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_ImportSEODetails',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
    
END CATCH;  
END;

GO

UPDATE ZnodeEmailTemplateLocale
SET Content = '<!DOCTYPE html><html><body><p><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;"></span><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">Dear&nbsp;</span><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">#CustomerName#,</span></p>  <p>&nbsp;</p>  <p><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">You have received a Voucher for&nbsp;</span><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">#StoreName# store</span><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">. Here are the voucher details.</span></p>  <p><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">Voucher Name :&nbsp;&nbsp;</span><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">#VoucherName#.</span></p>  <p><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">Voucher Number :&nbsp;#CardNumber#</span></p>  <p><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">Voucher Start Date :&nbsp;</span><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">#StartDate#.</span></p>  <p><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">Voucher Expiration Date&nbsp; &nbsp;:&nbsp;</span><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">#ExpirationDate#.</span></p>  <p><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">Voucher Amount :&nbsp;</span><span style="color: #2a2c2e; font-family: Roboto-Regular, segoeui, ''HelveticaNeueLTStd Lt'', Arial, sans-serif; font-size: 12px;">#Amount#</span></p>  <p>&nbsp;</p>  <p><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">Please login to our Store to use the remaining balance before it&nbsp; expires.</span></p>  <p><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">Please contact our customer service for any help required!</span></p>  <p><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">Thanks and Regards,</span></p>  <p><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">#StoreName# Support</span></p>  <p>&nbsp;</p>  <p>&nbsp;</p></body></html>'
WHERE EmailTemplateId = (SELECT TOP 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName = 'New Voucher Issued For Customer')
	AND LocaleId =1

UPDATE ZnodeEmailTemplateLocale
SET Content = '<!DOCTYPE html><html><body><p><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;"></span><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">Dear&nbsp;</span><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">#CustomerName#,</span></p>  <p>&nbsp;</p>  <p><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">Your voucher is used to place an order&nbsp;</span><span style="color: #2a2c2e; font-family: Roboto-Regular, segoeui, ''HelveticaNeueLTStd Lt'', Arial, sans-serif; font-size: 12px;">#OrderNumber# on the&nbsp;</span><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">#StoreName# store. here are the details:</span><span style="color: #2a2c2e; font-family: Roboto-Regular, segoeui, ''HelveticaNeueLTStd Lt'', Arial, sans-serif; font-size: 12px;">&nbsp;</span></p>  <p><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">Voucher Name :&nbsp;&nbsp;</span><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">#VoucherName#.</span></p>  <p><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">Voucher Number :&nbsp;#CardNumber#</span></p>  <p>&nbsp;</p>  <p><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">Amount Used :&nbsp;</span><span style="color: #2a2c2e; font-family: Roboto-Regular, segoeui, ''HelveticaNeueLTStd Lt'', Arial, sans-serif; font-size: 12px;">#VoucherAmountUsed#</span></p>  <p><span style="color: #2a2c2e; font-family: Roboto-Regular, segoeui, ''HelveticaNeueLTStd Lt'', Arial, sans-serif; font-size: 12px;">Remaining Amount : #RemainingAmount#</span></p>  <p>&nbsp;</p>  <p><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">Please login to our Store to see the voucher usages details.</span></p>  <p><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">Please contact our customer service for any help required!</span></p>  <p>&nbsp;</p>  <p><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">Thanks and Regards,</span></p>  <p><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">#StoreName# Support</span></p></body></html>'
WHERE EmailTemplateId = (SELECT TOP 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName = 'Remaining Voucher Balance')
	AND LocaleId =1

UPDATE ZnodeEmailTemplateLocale
SET Content = '<!DOCTYPE html><html><body><p><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;"></span><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">Dear&nbsp;</span><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">#CustomerName#,</span></p>  <p>&nbsp;</p>  <p><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">Your voucher&nbsp;</span><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">#VoucherName#.</span><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">&nbsp;with Voucher Number :&nbsp;</span><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">#VoucherName#. <br />will expire on&nbsp;</span><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">&nbsp;#ExpirationDate# .</span></p>  <p>&nbsp;</p>  <p><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">Please login to our Store to use the remaining balance before it expires.</span></p>  <p><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">Please contact our customer service for any help required!</span></p>  <p>&nbsp;</p>  <p><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">Thanks and Regards,</span></p>  <p><span style="color: #263238; font-family: Roboto, Arial, sans-serif; font-size: 13px;">#StoreName# Support</span></p></body></html>'
WHERE EmailTemplateId = (SELECT TOP 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName = 'Reminder To Use The Voucher Balance Before It Expires')
	AND LocaleId =1

GO

insert into ZnodeGlobalAttributeGroup(GroupCode,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsSystemDefined)
select 'Captcha',null,2,getdate(),2,getdate(),0
where not exists(select * from ZnodeGlobalAttributeGroup where GroupCode = 'Captcha')

insert into ZnodeGlobalAttributeGroupLocale(LocaleId,GlobalAttributeGroupId,AttributeGroupName,Description,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 1,GlobalAttributeGroupId,'Captcha',null,2,getdate(),2,getdate()
from ZnodeGlobalAttributeGroup a
where GroupCode = 'Captcha'
and not exists(select * from ZnodeGlobalAttributeGroupLocale b where b.GlobalAttributeGroupId= a.GlobalAttributeGroupId and b.LocaleId = 1)

insert into ZnodeGlobalAttribute(AttributeTypeId,AttributeCode,IsRequired,IsLocalizable,IsActive,DisplayOrder,HelpDescription,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsSystemDefined,GlobalEntityId)
select (select top 1 AttributeTypeId from ZnodeAttributeType where AttributeTypeName = 'Yes/No'),'IsCaptchaRequired',0,1,0,2,
'When enabled, the Captcha will be visible on the Contact Us, Feedback Form pages.',2,getdate(),2,getdate(),0,1
where not exists(select * from ZnodeGlobalAttribute where  AttributeCode = 'IsCaptchaRequired')

insert into ZnodeGlobalAttribute(AttributeTypeId,AttributeCode,IsRequired,IsLocalizable,IsActive,DisplayOrder,HelpDescription,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsSystemDefined,GlobalEntityId)
select (select top 1 AttributeTypeId from ZnodeAttributeType where AttributeTypeName = 'Yes/No'),'IsCaptchaRequiredForLogin',0,1,0,2,
'IsCaptchaRequiredForLogin',2,getdate(),2,getdate(),0,1
where not exists(select * from ZnodeGlobalAttribute where  AttributeCode = 'IsCaptchaRequiredForLogin')

insert into ZnodeGlobalAttributeLocale(LocaleId,GlobalAttributeId,AttributeName,Description,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 1,GlobalAttributeId,'Is Captcha Required For Forms',null,2,getdate(),2,getdate()
from ZnodeGlobalAttribute a
where AttributeCode = 'IsCaptchaRequired' and 
not exists(select * from ZnodeGlobalAttributeLocale b where a.GlobalAttributeId = b.GlobalAttributeId and b.LocaleId = 1)

insert into ZnodeGlobalAttributeLocale(LocaleId,GlobalAttributeId,AttributeName,Description,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 1,GlobalAttributeId,'Is Captcha Required For Login',null,2,getdate(),2,getdate()
from ZnodeGlobalAttribute a
where AttributeCode = 'IsCaptchaRequiredForLogin' and 
not exists(select * from ZnodeGlobalAttributeLocale b where a.GlobalAttributeId = b.GlobalAttributeId and b.LocaleId = 1)


insert into ZnodeGlobalAttributeGroupMapper (GlobalAttributeGroupId,GlobalAttributeId,AttributeDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select (select top 1 GlobalAttributeGroupId from ZnodeGlobalAttributeGroup where GroupCode = 'Captcha'),
(select top 1 GlobalAttributeId from ZnodeGlobalAttribute where AttributeCode = 'IsCaptchaRequired'),null,2,getdate(),2,getdate()
where not exists(select * from ZnodeGlobalAttributeGroupMapper 
     where GlobalAttributeGroupId = (select top 1 GlobalAttributeGroupId from ZnodeGlobalAttributeGroup where GroupCode = 'Captcha')
	 and GlobalAttributeId = (select top 1 GlobalAttributeId from ZnodeGlobalAttribute where AttributeCode = 'IsCaptchaRequired'))

insert into ZnodeGlobalAttributeGroupMapper (GlobalAttributeGroupId,GlobalAttributeId,AttributeDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select (select top 1 GlobalAttributeGroupId from ZnodeGlobalAttributeGroup where GroupCode = 'Captcha'),
(select top 1 GlobalAttributeId from ZnodeGlobalAttribute where AttributeCode = 'IsCaptchaRequiredForLogin'),null,2,getdate(),2,getdate()
where not exists(select * from ZnodeGlobalAttributeGroupMapper 
     where GlobalAttributeGroupId = (select top 1 GlobalAttributeGroupId from ZnodeGlobalAttributeGroup where GroupCode = 'Captcha')
	 and GlobalAttributeId = (select top 1 GlobalAttributeId from ZnodeGlobalAttribute where AttributeCode = 'IsCaptchaRequiredForLogin'))

insert into ZnodePortalGlobalAttributeValue(PortalId,GlobalAttributeId,GlobalAttributeDefaultValueId,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select PortalId,(select top 1 GlobalAttributeId from ZnodeGlobalAttribute where  AttributeCode = 'IsCaptchaRequired'),null,null,2,getdate(),2,getdate()
from ZnodePortal ZP
where not exists(select * from ZnodePortalGlobalAttributeValue ZPGA where ZP.PortalId = ZPGA.PortalId
      and ZPGA.GlobalAttributeId = (select top 1 GlobalAttributeId from ZnodeGlobalAttribute where  AttributeCode = 'IsCaptchaRequired'))

insert into ZnodePortalGlobalAttributeValueLocale(PortalGlobalAttributeValueId,	LocaleId,	AttributeValue	,CreatedBy,	CreatedDate,	ModifiedBy	,ModifiedDate)
select PortalGlobalAttributeValueId,1,'true',2,getdate(),2,getdate()
from ZnodePortalGlobalAttributeValue ZPGA
where ZPGA.GlobalAttributeId = (select top 1 GlobalAttributeId from ZnodeGlobalAttribute where  AttributeCode = 'IsCaptchaRequired')
and not exists(select * from ZnodePortalGlobalAttributeValueLocale ZPGAVL where ZPGAVL.PortalGlobalAttributeValueId = ZPGA.PortalGlobalAttributeValueId)

insert into ZnodePortalGlobalAttributeValue(PortalId,GlobalAttributeId,GlobalAttributeDefaultValueId,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select PortalId,(select top 1 GlobalAttributeId from ZnodeGlobalAttribute where  AttributeCode = 'IsCaptchaRequiredForLogin'),null,null,2,getdate(),2,getdate()
from ZnodePortal ZP
where not exists(select * from ZnodePortalGlobalAttributeValue ZPGA where ZP.PortalId = ZPGA.PortalId
      and ZPGA.GlobalAttributeId = (select top 1 GlobalAttributeId from ZnodeGlobalAttribute where  AttributeCode = 'IsCaptchaRequiredForLogin'))

insert into ZnodePortalGlobalAttributeValueLocale(PortalGlobalAttributeValueId,	LocaleId,	AttributeValue	,CreatedBy,	CreatedDate,	ModifiedBy	,ModifiedDate)
select PortalGlobalAttributeValueId,1,'false',2,getdate(),2,getdate()
from ZnodePortalGlobalAttributeValue ZPGA
where ZPGA.GlobalAttributeId = (select top 1 GlobalAttributeId from ZnodeGlobalAttribute where  AttributeCode = 'IsCaptchaRequiredForLogin')
and not exists(select * from ZnodePortalGlobalAttributeValueLocale ZPGAVL where ZPGAVL.PortalGlobalAttributeValueId = ZPGA.PortalGlobalAttributeValueId)

GO

update ZnodeGlobalAttribute set HelpDescription = 'When enabled, the Captcha will be visible on the Contact Us, Feedback Form pages.'
where AttributeCode = 'IsCaptchaRequired'
update ZnodeGlobalAttribute set HelpDescription = 'When enabled, the Captcha will be visible on the Login page'
where AttributeCode = 'IsCaptchaRequiredForLogin'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPimAttributes')
	DROP PROC Znode_GetPimAttributes

GO

CREATE  PROCEDURE [dbo].[Znode_GetPimAttributes]
(   @WhereClause         VARCHAR(MAX)  = '',
    @Rows                INT           = 100,
    @PageNo              INT           = 1,
    @Order_BY            VARCHAR(1000) = '',
    @RowsCount           INT OUT,
    @LocaleId            INT           = 0,
    @PimAttributeId      VARCHAR(MAX)  = '',
    @IsReturnAllCoulumns BIT           = 0)
AS
/*
     Summary :- This Procedure is used to get the attribute details with the attribute name locale wise 
				Result is fetched order by PimAttributeId in descending order
     Unit Testing 
	 
     EXEC [Znode_GetPimAttributes] '',10,1,'',0,1,'54,53,56',1

	
*/
     BEGIN
         SET NOCOUNT ON;
		 
         BEGIN TRY
             DECLARE @SQL NVARCHAR(MAX);
             DECLARE @DefaultLocaleId INT= dbo.Fn_GetdefaultLocaleId();
            
             DECLARE @TBL_AttributeDefault TABLE
             (PimAttributeId       INT,
              ParentPimAttributeId INT,
              AttributeTypeId      INT,
              AttributeCode        VARCHAR(600),
              IsRequired           BIT,
              IsLocalizable        BIT,
              IsFilterable         BIT,
              IsSystemDefined      BIT,
              IsConfigurable       BIT,
              IsPersonalizable     BIT,
              DisplayOrder         INT,
              HelpDescription      VARCHAR(MAX),
              IsCategory           BIT,
              IsHidden             BIT,
              CreatedDate          DATETIME,
              ModifiedDate         DATETIME,
              AttributeName        NVARCHAR(MAX),
              AttributeTypeName    VARCHAR(300),
			  IsComparable BIT,
			  IsUseInSearch BIT,
			  IsFacets BIT,
			  UsedInProductsCount int,
              RowId                INT,
              CountId              INT
             );
             IF @PimAttributeId <> ''
                 BEGIN
                     SET @WhereClause = CASE  WHEN @WhereClause = '' THEN '' ELSE ' AND ' END+' EXISTS (SELECT TOP 1  1  FROM dbo.Split('''+@PimAttributeId+''','','') SP WHERE SP.Item = CTPADV.PimAttributeId )';                                            
                 END;

			--collect count of used attribute in product.
            IF OBJECT_ID('tempdb..#AttributeCount', 'U') IS NOT NULL
			Begin
				DROP TABLE tempdb..#AttributeCount 
			End
			
			CREATE TABLE tempdb..#AttributeCount ( PimAttributeId int ,UsedInProductsCount  int  )

			INSERT INTO tempdb..#AttributeCount ( PimAttributeId,UsedInProductsCount)
				SELECT AD.PimAttributeId,COUNT(PAV.PimProductId) 
				FROM ZnodePimAttribute AD Inner JOIN ZnodePimAttributeValue PAV ON AD.PimAttributeId = PAV.PimAttributeId
				WHERE AD.IsCategory =0 
				GROUP BY AD.PimAttributeId
						

             SET @SQL = '
		     ;With Cte_PimAttribute AS 
			 (
				 SELECT ZPA.PimAttributeId,ZPA.ParentPimAttributeId,ZPA.AttributeTypeId,ZPA.AttributeCode,ZPA.IsRequired,ZPA.IsLocalizable,ZPA.IsFilterable
				 ,ZPA.IsSystemDefined,ZPA.IsConfigurable,ZPA.IsPersonalizable,ZPA.DisplayOrder,ZPA.HelpDescription,ZPA.IsCategory,ZPA.IsHidden
				 ,ZPA.CreatedBy,ZPA.CreatedDate,ZPA.ModifiedBy,ZPA.ModifiedDate,ZPAL.AttributeName,ZAT.AttributeTypeName , ZPAL.LocaleId ,
				  ZPFP.IsComparable,ZPFP.IsUseInSearch,ZPFP.IsFacets,AC.UsedInProductsCount
				 FROM ZnodePimAttribute ZPA 
				 INNER JOIN ZnodePimAttributeLocale ZPAL ON (ZPAL.PimAttributeId = ZPA.PimAttributeId)
				 INNER JOIN ZnodeAttributeType ZAT ON (ZAT.AttributeTypeId = ZPA.AttributeTypeId)
				 Left Outer JOIN ZnodePimFrontendProperties ZPFP ON ZPA.PimAttributeId = ZPFP.PimAttributeId 
				 Left Outer Join tempdb..#AttributeCount AC on ZPA.PimAttributeId = AC.PimAttributeId
				 WHERE IsHidden = 0
			 )
			 , Cte_PimAttributeFirstLocale AS 
			 (
				 SELECT PimAttributeId,ParentPimAttributeId,AttributeTypeId,AttributeCode,IsRequired,IsLocalizable,IsFilterable
				 ,IsSystemDefined,IsConfigurable,IsPersonalizable,DisplayOrder,HelpDescription,IsCategory,IsHidden
				 ,AttributeName ,AttributeTypeName,CreatedDate,ModifiedDate,LocaleId
				 ,IsComparable,IsUseInSearch,IsFacets,UsedInProductsCount
				 FROM Cte_PimAttribute CTA 
				 WHERE LocaleId = '+CAST(@localeId AS VARCHAR(20))+'
			 )
			 , Cte_PimAttributeDefaultLocale AS 
			 (
			     SELECT PimAttributeId,ParentPimAttributeId,AttributeTypeId,AttributeCode,IsRequired,IsLocalizable,IsFilterable
			     ,IsSystemDefined,IsConfigurable,IsPersonalizable,DisplayOrder,HelpDescription,IsCategory,IsHidden
			     ,AttributeName ,AttributeTypeName,CreatedDate,ModifiedDate,LocaleId,IsComparable,IsUseInSearch,IsFacets,UsedInProductsCount
			     FROM Cte_PimAttributeFirstLocale 
			     UNION ALL 
			     SELECT PimAttributeId,ParentPimAttributeId,AttributeTypeId,AttributeCode,IsRequired,IsLocalizable,IsFilterable
				 ,IsSystemDefined,IsConfigurable,IsPersonalizable,DisplayOrder,HelpDescription,IsCategory,IsHidden
				 ,AttributeName ,AttributeTypeName,CreatedDate,ModifiedDate,LocaleId,IsComparable,IsUseInSearch,IsFacets,UsedInProductsCount
			     FROM Cte_PimAttribute CTA
			     WHERE LocaleId = '+CAST(@DefaultLocaleId AS VARCHAR(20))+'
			     AND NOT EXISTS (SELECT TOP 1 1 FROM Cte_PimAttributeFirstLocale CTAFL WHERE CTAFL.PimAttributeId = CTA.PimAttributeId)		 
			  )
			  ,Cte_PimAttributeFilter AS 
			  (
			     SELECT PimAttributeId,ParentPimAttributeId,AttributeTypeId,AttributeCode,IsRequired,IsLocalizable,IsFilterable
				 ,IsSystemDefined,IsConfigurable,IsPersonalizable,DisplayOrder,HelpDescription,IsCategory,IsHidden,CreatedDate,ModifiedDate
				 ,AttributeName ,AttributeTypeName,LocaleId,IsComparable,IsUseInSearch,IsFacets ,UsedInProductsCount, '+[dbo].[Fn_GetPagingRowId](@Order_BY, ' PimAttributeId DESC')+' , Count(*)Over() CountId
			     FROM Cte_PimAttributeDefaultLocale 	CTPADV 
			     WHERE 1=1 
			     '+[dbo].[Fn_GetFilterWhereClause](@WhereClause)+'
			  )
			 
			     SELECT PimAttributeId,ParentPimAttributeId,AttributeTypeId,AttributeCode,IsRequired,IsLocalizable,IsFilterable
				 ,IsSystemDefined,IsConfigurable,IsPersonalizable,DisplayOrder,HelpDescription,IsCategory,IsHidden,CreatedDate,ModifiedDate
				 ,AttributeName ,AttributeTypeName ,ISNULL(IsComparable,0)IsComparable ,ISNULL(IsUseInSearch,0)IsUseInSearch,ISNULL(IsFacets,0) IsFacets,UsedInProductsCount,RowId ,CountId 
			     FROM Cte_PimAttributeFilter CTAF 
			     '+[dbo].[Fn_GetPaginationWhereClause](@PageNo, @Rows)+'
			     '+[dbo].[Fn_GetOrderByClause](@Order_BY, 'PimAttributeId DESC')+'
			     ';
           
				 INSERT INTO @TBL_AttributeDefault
				 (PimAttributeId,ParentPimAttributeId,AttributeTypeId,AttributeCode,IsRequired,IsLocalizable,IsFilterable,IsSystemDefined,IsConfigurable
				 ,IsPersonalizable,DisplayOrder,HelpDescription,IsCategory,IsHidden,CreatedDate,ModifiedDate,AttributeName,AttributeTypeName,IsComparable,IsUseInSearch,IsFacets,UsedInProductsCount,RowId,CountId)
				 EXEC (@SQL);


				 IF @IsReturnAllCoulumns = 0
                 BEGIN
                     SELECT AD.PimAttributeId,AD.AttributeCode,AD.AttributeName,AD.AttributeTypeName,AD.IsRequired,AD.IsLocalizable,AD.IsSystemDefined,AD.CreatedDate,AD.IsPersonalizable,AD.IsComparable,AD.IsUseInSearch,AD.IsFacets,
					         Isnull(AD.UsedInProductsCount,0) UsedInProductsCount, ZPAGM.PimAttributeGroupId AS AttributeGroupId
                     FROM @TBL_AttributeDefault AD
					 Left Join ZnodePimAttributeGroupMapper ZPAGM ON AD.PimAttributeId = ZPAGM.PimAttributeId
		         END;
                 ELSE
                 BEGIN
                     SELECT AD.PimAttributeId,ParentPimAttributeId,AttributeTypeId,AD.AttributeCode,AD.IsRequired,AD.IsLocalizable,AD.IsFilterable,AD.IsSystemDefined
					 ,AD.IsConfigurable,AD.IsPersonalizable,AD.DisplayOrder,AD.HelpDescription,AD.IsCategory,AD.IsHidden,AD.CreatedDate,AD.ModifiedDate,AD.AttributeName,AD.AttributeTypeName,
					  AD.IsComparable,AD.IsUseInSearch,AD.IsFacets
					  , Isnull(AD.UsedInProductsCount,0) UsedInProductsCount, ZPAGM.PimAttributeGroupId AS AttributeGroupId
                     FROM @TBL_AttributeDefault AD
					 Left Join ZnodePimAttributeGroupMapper ZPAGM ON AD.PimAttributeId = ZPAGM.PimAttributeId
				 END;
				 SET @RowsCount = ISNULL((SELECT TOP 1 CountId FROM @TBL_AttributeDefault), 0);
		
         END TRY
         BEGIN CATCH
		
		DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPimAttributes @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@LocaleId = '+CAST(@LocaleId AS VARCHAR(50))+',@PimAttributeId='+@PimAttributeId+',@IsReturnAllCoulumns='+CAST(@IsReturnAllCoulumns AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetPimAttributes',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
            
         END CATCH;
     END;

GO

Update ZnodeSearchFeature 
set HelpDescription = 'Edit the characters in a word to make it same as another word. Number of edits is calculated basis the character count. Auto Correct will not function when Multi Match-> Cross option is selected.' 
where FeatureCode='AutoCorrect'

GO

IF NOT EXISTS(SELECT 1 FROM sys.types WHERE is_table_type = 1 AND name = 'ProductQuantityValidation')
BEGIN
	CREATE TYPE [dbo].[ProductQuantityValidation] AS TABLE(
	[SKU] [varchar](600) NULL,
	[MinimumQuantity] [numeric](28, 6) NULL,
	[MaximumQuantity] [numeric](28, 6) NULL,
	[Quantity] [numeric](28, 6) NULL,
	[IsEditCart] BIT NULL
	)
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ValidateProductSaveCartQuantityMinMaxValue')
	DROP PROC Znode_ValidateProductSaveCartQuantityMinMaxValue

GO

CREATE PROCEDURE [dbo].[Znode_ValidateProductSaveCartQuantityMinMaxValue]
(
	@ProductQuantityValidate DBO.ProductQuantityValidation READONLY,
	@OmsCookieMappingId INT,
	@Status BIT = 0 OUT
)
--EXECUTE Znode_ValidateProductSaveCartQuantityMinMaxValue @SKU = 'ap1234',@Quantity=1,@OmsCookieMappingId=1
AS
BEGIN
BEGIN TRY 
SET NOCOUNT ON;

		IF OBJECT_ID('tempdb..#GroupProductQuantity') IS NOT NULL
			DROP TABLE #ProductQuantity

		CREATE TABLE #ProductQuantity(SKU VARCHAR(600),Quantity NUMERIC(28,6),Status BIT)

		--To get the quantity for save car for group poducts
		INSERT INTO #ProductQuantity(SKU ,Quantity ,Status)
		SELECT S.SKU,ISNULL(S.Quantity,0)+CASE WHEN ISNULL(S.IsEditCart,0) = 1  THEN 0 ELSE ISNULL(SUM(ISNULL(SCLI.Quantity,0)),0) END AS Quantity, 0 AS Status
		FROM @ProductQuantityValidate S
		LEFT JOIN ZnodeOmsSavedCartLineItem SCLI WITH (NOLOCK) ON SCLI.SKU = S.SKU
		AND EXISTS(SELECT * FROM ZnodeOmsSavedCart SC WITH (NOLOCK) WHERE SC.OmsCookieMappingId = @OmsCookieMappingId AND SCLI.OmsSavedCartId = SC.OmsSavedCartId)
		GROUP BY S.SKU,S.Quantity,S.IsEditCart

		--Validating Quantity for group poducts
		UPDATE P set Status = 1 
		FROM #ProductQuantity P
		INNER JOIN @ProductQuantityValidate S on S.sku = P.SKU 
		WHERE P.Quantity BETWEEN S.MinimumQuantity AND S.MaximumQuantity

		IF EXISTS(SELECT * FROM #ProductQuantity WHERE Status = 0)
			SET @Status = 0
		ELSE
			SET @Status = 1

	SELECT 1 AS ID,CAST(@Status AS BIT) AS Status;  

END TRY    
BEGIN CATCH      
	SET @Status = 0;    
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= 
	ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 
	'EXEC Znode_ValidateProductSaveCartQuantityMinMaxValue @OmsCookieMappingId ='+CAST(@OmsCookieMappingId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));    
                      
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                       
        
	EXEC Znode_InsertProcedureErrorLog    
	@ProcedureName = 'Znode_ValidateProductSaveCartQuantityMinMaxValue',    
	@ErrorInProcedure = @Error_procedure,    
	@ErrorMessage = @ErrorMessage,    
	@ErrorLine = @ErrorLine,    
	@ErrorCall = @ErrorCall;                                
END CATCH; 
END

GO

update ZnodeApplicationSetting
set Setting='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>UserAddressId</name><headertext>Checkbox</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>UserAddressId</name><headertext>User Address Id</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>AddressId</name><headertext>Checkbox</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>IsDefaultBilling</name><headertext>Is Default Billing</headertext><width>0</width><datatype>Boolean</datatype><columntype>Boolean</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>IsDefaultShipping</name><headertext>Is Default Shipping</headertext><width>0</width><datatype>Boolean</datatype><columntype>Boolean</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>DisplayAddress</name><headertext>Address</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>AccountId</name><headertext>AccountId</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName='ZnodeGuestUserAddress'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetConfigureAttributeDetail')
	DROP PROC Znode_GetConfigureAttributeDetail

GO


CREATE PROCEDURE [dbo].[Znode_GetConfigureAttributeDetail]
( @PimFamilyId  INT = 0,
  @PimProductId INT = 0,
  @LocaleId     INT = 1)
AS
 /*
   Summary: sp Get configuration of attribute of Product
 begin tran  
 EXEC Znode_GetConfigureAttributeDetail 0,0,1
 rollback tran
*/

     BEGIN
         BEGIN TRY
             SET NOCOUNT ON;
             IF @LocaleId IS NULL
                 BEGIN
                     SET @LocaleId = dbo.Fn_GetDefaultLocaleId();
                 END;
             IF @PimFamilyId = 0
                 BEGIN
                     SET @PimFamilyId = [dbo].[Fn_GetDefaultPimProductFamilyId]();
                 END;
             SELECT ZPFGM.PimAttributeFamilyId,ZPFGM.PimAttributeGroupId,ZPAGL.AttributeGroupName,VPAL.PimAttributeId,VPAL.AttributeName,VPAL.AttributeCode,ZAT.AttributeTypeId,VPAL.IsFilterable,VPAL.IsRequired,VPAL.IsLocalizable,g.IsEditable,ZAT.AttributeTypeName,ZAIV.Name,ZAIV.ControlName,ZAIVR.ValidationName,ZPAV.Name AS SubValidationName,ZAIVR.RegExp,g.AttributeDefaultValue,
                    CASE
                        WHEN ZPCPA.PimAttributeId IS NULL
                        THEN 0
                        ELSE 1
                    END AS IsConfigurableAttribute
             FROM ZnodePimFamilyGroupMapper AS ZPFGM
                  INNER JOIN ZnodePimAttributeGroupLocale AS ZPAGL ON(ZPAGL.PimAttributeGroupId = ZPFGM.PimAttributeGroupId
                                                                   AND ZPAGL.LocaleId = @LocaleId)
                  INNER JOIN View_PimAttributeLocale AS VPAL ON(VPAL.PimAttributeId = ZPFGM.PimAttributeId
                                                             AND VPAL.IsConfigurable = 1
                                                             AND VPAL.LocaleId = ZPAGL.LocaleId)
                  INNER JOIN ZnodeAttributeType AS ZAT ON(ZAT.AttributeTypeId = VPAL.AttributeTypeId
                                                       AND ZAT.IsPimAttributeType = 1)
                  LEFT JOIN ZnodePimAttributeValidation AS ZPAV ON(ZPAV.PimAttributeId = VPAL.PimAttributeId)
                  LEFT JOIN ZnodeAttributeInputValidation AS ZAIV ON(ZAIV.InputValidationId = ZPAV.InputValidationId)
                  LEFT JOIN ZnodeAttributeInputValidationRule AS ZAIVR ON(ZAIVR.InputValidationRuleId = ZPAV.InputValidationRuleId)
                  LEFT JOIN View_PimDefaultValue AS g ON(VPAL.PimAttributeId = g.PimAttributeId
                                                      AND g.LocaleId = VPAL.LocaleId)
                  LEFT JOIN ZnodePimConfigureProductAttribute AS ZPCPA ON(ZPCPA.PimFamilyId = @PimFamilyId
                                                                       AND ZPCPA.PimAttributeId = VPAL.PimAttributeId
                                                                       AND ZPCPA.PimProductId = @PimProductId)
             WHERE ZPFGM.PimAttributeFamilyId = @PimFamilyId
                   AND EXISTS
             (
                 SELECT TOP 1 1
                 FROM
                 (
                     SELECT 1 AS idm
                 ) AS ZPFGM
                 LEFT JOIN ZnodePimConfigureProductAttribute AS ZPCPA ON(ZPFGM.Idm = 1)
                 WHERE(ZPCPA.PimAttributeId = VPAL.PimAttributeId
                       AND ZPCPA.PimProductId = @PimProductId)
                       OR @PimProductId = 0
             ); 
            
         END TRY
         BEGIN CATCH
               DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetConfigureAttributeDetail @PimFamilyId = '+CAST(@PimFamilyId AS VARCHAR(50))+',@PimProductId='+CAST(@PimProductId AS VARCHAR(50))+',@LocaleId='+CAST(@LocaleId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		 
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetConfigureAttributeDetail',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCustomerAddress')
	DROP PROC Znode_ImportCustomerAddress

GO

CREATE PROCEDURE [dbo].[Znode_ImportCustomerAddress](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @LocaleId int= 0,@PortalId int ,@CsvColumnString nvarchar(max), @IsAccountAddress bit = 0 )
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import SEO Details
	
	-- Unit Testing : 
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(max),@IsAllowGlobalLevelUserCreation NVARCHAR(10)

		DECLARE @GETDATE DATETIME= dbo.Fn_GETDATE();
		-- Retrive Value FROM global setting 
		SELECT @IsAllowGlobalLevelUserCreation = FeatureValues FROM ZnodeGlobalsetting WHERE FeatureName = 'AllowGlobalLevelUserCreation'
		-- Three type of import required three table varible for product , category AND brand

		CREATE TABLE #InsertCustomerAddress 
		( 
			RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT,UserName NVARCHAR(512),FirstName VARCHAR(300),
			LastName VARCHAR(300),DisplayName NVARCHAR(1200),Address1 VARCHAR(300),Address2 VARCHAR(300),
			CountryName VARCHAR(3000),StateName VARCHAR(3000),CityName VARCHAR(3000),PostalCode VARCHAR(50),
			PhoneNumber VARCHAR(50),IsDefaultBilling BIT,IsDefaultShipping BIT	,IsActive BIT,ExternalId NVARCHAR(2000),
			CompanyName NVARCHAR(2000), GUID NVARCHAR(400)
		);
	
		SET @SSQL = ' INSERT INTO #InsertCustomerAddress ( RowNumber, ' + @CsvColumnString + ' ,GUID )
		SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+ @TableName;
		EXEC sys.sp_sqlexec @SSQL;

		-- start Functional Validation 
		----------------------------------------------
		IF (@IsAccountAddress = 0)
		BEGIN
			IF @IsAllowGlobalLevelUserCreation = 'true'
					INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
						   SELECT '19', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
						   FROM #InsertCustomerAddress AS ii
						   WHERE ii.UserName NOT IN 
						   (
							   SELECT UserName FROM AspNetZnodeUser   WHERE PortalId = @PortalId
						   );
			ELSE 
					INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
						   SELECT '19', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
						   FROM #InsertCustomerAddress AS ii
						   WHERE ii.UserName NOT IN 
						   (
							   SELECT UserName FROM AspNetZnodeUser   
						   );

					INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
							SELECT '8', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
							FROM #InsertCustomerAddress AS ii
							WHERE ISNULL(ltrim(rtrim(ii.UserName)), '') = ''

		 END

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '8', 'StateName', StateName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
		FROM #InsertCustomerAddress AS ii
		WHERE NOT EXISTS(SELECT * FROM ZnodeState ZS INNER JOIN ZnodeCountry ZC ON ZS.CountryCode = ZC.CountryCode
			where ii.CountryName = ZC.CountryName AND ZS.StateName = ISNULL(ltrim(rtrim(ii.StateName)), ''))

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '8', 'CountryName', CountryName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
		FROM #InsertCustomerAddress AS ii
		WHERE NOT EXISTS(SELECT * FROM ZnodeCountry ZC WHERE ZC.CountryName = ISNULL(ltrim(rtrim(ii.CountryName)), '') )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '90', 'CountryName', CountryName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
		FROM #InsertCustomerAddress AS ii
		WHERE ISNULL(ltrim(rtrim(ii.CountryName)), '') <> ''
		AND NOT EXISTS(SELECT * FROM ZnodePortalCountry ZPC INNER JOIN ZnodeCountry ZC ON ZPC.CountryCode = ZC.CountryCode
		    WHERE PortalId = @PortalId AND ltrim(rtrim(ii.CountryName)) = ltrim(rtrim(ZC.CountryName)))

		 -- error log when atleast db have 
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '63', 'IsDefaultBilling/IsDefaultShipping', IsDefaultBilling, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
		FROM #InsertCustomerAddress IC WHERE  exists (
		SELECT TOP 1 1  FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
		INNER JOIN ZnodeUserAddress ZUA ON ZUA.UserId = ZU.UserId
		INNER JOIN ZnodeAddress ZA ON ZUA.AddressId = ZA.AddressId
		where ANZU.UserName = IC.UserName AND ZA.IsDefaultBilling =IC.IsDefaultBilling 
		AND ZA.IsDefaultShipping =IC.IsDefaultShipping )

		--Note : Content page import is not required 
		
		-- End Function Validation 	
		-----------------------------------------------
		UPDATE ZIL
		SET ZIL.ColumnName =   ZIL.ColumnName + ' [ UserName - ' + ISNULL(UserName,'') + ' ] '
		FROM ZnodeImportLog ZIL 
		INNER JOIN #InsertCustomerAddress IPA ON (ZIL.RowNumber = IPA.RowNumber)
		WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL


		DELETE FROM #InsertCustomerAddress
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber IS NOT NULL 
			--AND GUID = @NewGUID
		);

		UPDATE ZA SET ZA.IsDefaultBilling = 0
		FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
		INNER JOIN ZnodeUserAddress ZUA ON ZUA.UserId = ZU.UserId
		INNER JOIN ZnodeAddress ZA ON ZUA.AddressId = ZA.AddressId
		INNER JOIN #InsertCustomerAddress IC ON ANZU.UserName = IC.UserName --and IC.IsDefaultBilling <> ZA.IsDefaultBilling 
		where IC.IsDefaultBilling = 1 

		UPDATE ZA SET ZA.IsDefaultShipping = 0
		FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
		INNER JOIN ZnodeUserAddress ZUA ON ZUA.UserId = ZU.UserId
		INNER JOIN ZnodeAddress ZA ON ZUA.AddressId = ZA.AddressId
		INNER JOIN #InsertCustomerAddress IC ON ANZU.UserName = IC.UserName
		where IC.IsDefaultShipping = 1 

		DELETE FROM ZnodeImportLog  WHERE ImportProcessLogId = @ImportProcessLogId AND  ErrorDescription = '63'
		-- UPDATE Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		SELECT @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertCustomerAddress
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- End
		
		DELETE FROM #InsertCustomerAddress 
		WHERE NOT EXISTS
			(SELECT TOP 1 1 FROM 
				(
					SELECT ROW_NUMBER() OVER(PARTITION BY UserName	
					,FirstName	,LastName	,DisplayName	,Address1	,Address2	
					,CountryName	,StateName	,CityName	,PostalCode	
					,PhoneNumber	,IsDefaultBilling,IsDefaultShipping,ExternalId	,CompanyName ORDER BY RowId desc) 
					AS rw_nmbr,RowId  FROM #InsertCustomerAddress 
				) abc WHERE rw_nmbr =1 AND abc.RowId = #InsertCustomerAddress.RowId
			)

		----------UPDATE ZnodeAddress
		DECLARE @AddressColumnString VARCHAR(1000), @WhereConditionString VARCHAR(1000), @UpdateColumnString VARCHAR(1000)

		SELECT @AddressColumnString = COALESCE(@AddressColumnString + ',', '')+a.ColumnName --COALESCE(@CsvColumnString + ' AND ', '') +'ZA.'+ColumnName+' =  IC.'+ColumnName
		FROM ZnodeImportUpdatableColumns a
		INNER JOIN INFORMATION_SCHEMA.COLUMNS b ON a.ColumnName = b.COLUMN_NAME  
		INNER JOIN dbo.Split(@CsvColumnString,',')C ON b.COLUMN_NAME = c.Item
		WHERE b.TABLE_NAME = 'ZnodeAddress' 
		AND EXISTS(SELECT * FROM ZnodeImportHead IH WHERE a.ImportHeadId = IH.ImportHeadId AND IH.Name in ('CustomerAddress','ShippingAddress'))

		SELECT @UpdateColumnString = COALESCE(@UpdateColumnString + ' , ', '') +'ZA.'+a.COLUMN_NAME+' =  IC.'+a.COLUMN_NAME  
		FROM INFORMATION_SCHEMA.COLUMNS a
		INNER JOIN dbo.Split(@CsvColumnString,',')b ON a.COLUMN_NAME = b.Item
		WHERE NOT EXISTS (SELECT * FROM dbo.Split(@AddressColumnString,',') c WHERE a.COLUMN_NAME = c.Item )
		AND a.TABLE_NAME = 'ZnodeAddress'

		SELECT @WhereConditionString = COALESCE(@WhereConditionString + ' AND ', '') +'ZA.'+item+' =  IC.'+item FROM dbo.split(@AddressColumnString,',')
		SET @WhereConditionString = Replace(@WhereConditionString , 'ZA.Address2 =  IC.Address2', 'ISNULL(ZA.Address2 ,'''')=  ISNULL(IC.Address2 ,'''')') 
		
		UPDATE a SET a.StateName =c.StateCode  
		FROM #InsertCustomerAddress a 
		INNER JOIN ZnodeCountry b ON a.CountryName = b.CountryName 
		INNER JOIN ZnodeState c ON b.CountryCode = c.CountryCode AND C.StateName = a.StateName
		
		UPDATE a SET a.CountryName= b.CountryCode FROM  #InsertCustomerAddress a INNER JOIN ZnodeCountry b ON a.CountryName = b.CountryName 
		
		CREATE TABLE #InsertedUserAddress (AddressId  NVARCHAR(256), UserId NVARCHAR(max)) 

		IF ( @IsAccountAddress = 1 )
		BEGIN
			UPDATE ZnodeAddress SET IsDefaultBilling = 0,  IsDefaultShipping = 0
			FROM AspNetZnodeUser ANZU 
			INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
			INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
			INNER JOIN ZnodeUserAddress ZUA ON ZUA.UserId = ZU.UserId
			INNER JOIN ZnodeAddress ZA ON ZUA.AddressId = ZA.AddressId
			INNER JOIN #InsertCustomerAddress IC ON ANZU.UserName = IC.UserName AND ZA.IsDefaultBilling =IC.IsDefaultBilling 
													AND ZA.IsDefaultShipping =IC.IsDefaultShipping

					SET @SSQL = '
						UPDATE ZA set ModifiedBy = '+CONVERT(VARCHAR(10), @UserId)+', ModifiedDate = getdate() '+CASE WHEN ISNULL(@UpdateColumnString,'') = '' THEN '' ELSE ','+@UpdateColumnString END+' 
						FROM ZnodeAddress ZA
						INNER JOIN #InsertCustomerAddress IC ON '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END

			EXEC (@SSQL)

					SET @SSQL = '
					Insert into ZnodeAddress (FirstName,LastName,DisplayName,Address1,Address2,Address3,CountryName,
											StateName,CityName,PostalCode,PhoneNumber,
											IsDefaultBilling,IsDefaultShipping,IsActive,ExternalId,CompanyName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsShipping,IsBilling)		
					OUTPUT INSERTED.AddressId INTO  #InsertedUserAddress (AddressId) 			 
					SELECT IC.FirstName,IC.LastName,IC.DisplayName,IC.Address1,IC.Address2,null,IC.CountryName ,
					IC.StateName,
					,IC.CityName,IC.PostalCode,IC.PhoneNumber,
					isnull(IC.IsDefaultBilling,0),isnull(IC.IsDefaultShipping,0),isnull(IC.IsActive,0),IC.ExternalId,IC.CompanyName, '+CONVERT(VARCHAR(10), @UserId)+' , getdate() , '+CONVERT(VARCHAR(10), @UserId)+' ,getdate(), 1, 1
					FROM  #InsertCustomerAddress IC
					WHERE NOT EXISTS(SELECT * FROM ZnodeAddress ZA WHERE '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END +')'

			EXEC (@SSQL)

			DECLARE @AccountId INT
			SELECT @AccountId = AccountId FROM ZnodeUser WHERE UserId = @UserId
			INSERT INTO ZnodeAccountAddress ( AccountId, AddressId, CreatedBy, CreatedDate,	ModifiedBy,	ModifiedDate )
			SELECT @AccountId, Addressid ,  @UserId , @GETDATE, @UserId , @GETDATE FROM #InsertedUserAddress UA
			WHERE NOT EXISTS ( SELECT * FROM ZnodeAccountAddress AA WHERE AccountId = @AccountId AND AA.Addressid = UA.Addressid )
		END
		ELSE
		BEGIN
		
			UPDATE ZnodeAddress SET IsDefaultBilling = 0,  IsDefaultShipping = 0
			FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
			INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
			INNER JOIN ZnodeUserAddress ZUA ON ZUA.UserId = ZU.UserId
			INNER JOIN ZnodeAddress ZA ON ZUA.AddressId = ZA.AddressId
			INNER JOIN #InsertCustomerAddress IC ON ANZU.UserName = IC.UserName AND ZA.IsDefaultBilling =IC.IsDefaultBilling 
			AND ZA.IsDefaultShipping =IC.IsDefaultShipping
					
					SET @SSQL = '
						UPDATE ZA set ModifiedBy = '+CONVERT(VARCHAR(10), @UserId)+', ModifiedDate = getdate() '+CASE WHEN ISNULL(@UpdateColumnString,'') = '' THEN '' ELSE ','+@UpdateColumnString END+' 
						FROM ZnodeAddress ZA 
						INNER JOIN #InsertCustomerAddress IC ON '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END
						
					Print @SSQL
					EXEC (@SSQL)
									
					SET @SSQL = '
					Insert into ZnodeAddress (FirstName,LastName,DisplayName,Address1,Address2,Address3,CountryName,
												StateName,CityName,PostalCode,PhoneNumber,
												IsDefaultBilling,IsDefaultShipping,IsActive,ExternalId,CompanyName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsShipping,IsBilling)		
					OUTPUT INSERTED.AddressId, INSERTED.Address3 INTO  #InsertedUserAddress (AddressId, UserId ) 			 
					SELECT IC.FirstName,IC.LastName,IC.DisplayName,IC.Address1,IC.Address2,convert(nvarchar(100),ZU.UserId),IC.CountryName ,
					IC.StateName 
					,IC.CityName,IC.PostalCode,IC.PhoneNumber,
					isnull(IC.IsDefaultBilling,0),isnull(IC.IsDefaultShipping,0),isnull(IC.IsActive,0),IC.ExternalId,IC.CompanyName, '+CONVERT(VARCHAR(10), @UserId)+' , getdate() , '+CONVERT(VARCHAR(10), @UserId)+' ,getdate(),1,1
					FROM AspNetZnodeUser ANZU 
					INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
					INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
					INNER JOIN #InsertCustomerAddress IC ON ANZU.UserName = IC.UserName 
					WHERE NOT EXISTS(SELECT * FROM ZnodeAddress ZA WHERE '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END +')'
					print @SSQL
					EXEC (@SSQL)

			INSERT INTO ZnodeUserAddress(UserId,AddressId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT CAST( UserId AS INT ) , Addressid , @UserId , @GETDATE, @UserId , @GETDATE FROM  #InsertedUserAddress
		END
				
		UPDATE ZA SET ZA.CountryName = ZC.CountryCode
		FROM ZnodeAddress ZA
		INNER JOIN ZnodeCountry ZC ON ltrim(rtrim(ZA.CountryName)) = ltrim(rtrim(ZC.CountryName))

		UPDATE ZA SET ZA.Address3 = null 
		FROM ZnodeAddress ZA INNER JOIN #InsertedUserAddress IUA ON ZA.AddressId = IUA.AddressId 

		
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 2 ), ProcessCompletedDate = @GETDATE
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCustomerAddress @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@LocaleId='+CAST(@LocaleId AS VARCHAR(max)) +',@PortalId='+CAST(@PortalId AS VARCHAR(max)) +',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max)) +',@IsAccountAddress='+CAST(@IsAccountAddress AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GETDATE
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId

		--Updating total AND fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportCustomerAddress',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		
	END CATCH;
END;

GO

update ZnodeApplicationSetting
set Setting='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>OrderId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>OrderNumber</name><headertext>Order Number</headertext><width>15</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl>/Order/Manage</islinkactionurl><islinkparamfield>OmsOrderId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield>OmsOrderId</controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>CustomerName</name><headertext>Customer Name</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>UserName</name><headertext>User Name</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>TransactionDate</name><headertext>Created Date</headertext><width>30</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>Notes</name><headertext>Notes</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>TransactionAmount</name><headertext>Amount Used</headertext><width>30</width><datatype>Decimal</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>View</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>View</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/Order/Manage</manageactionurl><manageparamfield>OmsOrderId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'where ItemName='ZnodeVoucherHistory'

GO

Update ZnodeSearchQueryType set HelpDescription = 'When Multi-Match query type is configured, the application searches keywords in more than one searchable field to display results on the Web Store. Best: Should be used when the searched term must appear in any one searchable field. Cross: Should be used when the searched term can be spread across multiple searchable fields. Auto Correct is not applicable for Multi match -> Cross combination.' 
where QueryTypeName = 'Multi Match'

GO


INSERT INTO ZnodePortalFeature (PortalFeatureName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 'Enable_Barcode_Scanner',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT TOP 1 1 FROM ZnodePortalFeature WHERE PortalFeatureName='Enable_Barcode_Scanner')

GO

Declare @PimCategoryHierarchyId int, @PimCatalogId int

		  Declare Cur_Category_Hierarchy_Delete Cursor For 
		  select PimCategoryHierarchyId , PimCatalogId
			from ZnodePimCategoryHierarchy a where ParentPimCategoryHierarchyId is not null
			and not exists (
			select * from ZnodePimCategoryHierarchy b where b.PimCategoryHierarchyId = a.ParentPimCategoryHierarchyId
			)
		  OPEN Cur_Category_Hierarchy_Delete  
		  FETCH NEXT FROM Cur_Category_Hierarchy_Delete INTO @PimCategoryHierarchyId, @PimCatalogId 

		  WHILE (@@FETCH_STATUS = 0)
		  BEGIN

				EXEC [dbo].[Znode_DeletePimCategoryHierarchy] @PimCategoryHierarchyId = @PimCategoryHierarchyId, @PimCatalogId = @PimCatalogId

				FETCH NEXT FROM Cur_Category_Hierarchy_Delete INTO @PimCategoryHierarchyId, @PimCatalogId 

		  END
		  CLOSE Cur_Category_Hierarchy_Delete
		  DEALLOCATE Cur_Category_Hierarchy_Delete
go

IF NOT EXISTS (SELECT * FROM sys.objects o 
WHERE o.object_id = object_id(N'[dbo].[FK_ZnodePimCategoryHierarchy_ParentPimCategoryHierarchyId]') 
AND OBJECTPROPERTY(o.object_id, N'IsForeignKey') = 1)
BEGIN
ALTER TABLE ZnodePimCategoryHierarchy WITH CHECK ADD CONSTRAINT FK_ZnodePimCategoryHierarchy_ParentPimCategoryHierarchyId
FOREIGN KEY (ParentPimCategoryHierarchyId) REFERENCES ZnodePimCategoryHierarchy (PimCategoryHierarchyId)
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetFilterPimProductId')
	DROP PROC Znode_GetFilterPimProductId

GO


Create PROCEDURE [dbo].[Znode_GetFilterPimProductId]
(
  @WhereClause XML 
 ,@PimProductId TransferId READONLY 
 ,@LocaleId   INT,
 @IsProductNotIn BIT = 1
)
AS 
BEGIN 
SET NOCOUNT ON 

		DECLARE  @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleID()
		DECLARE @SQL NVARCHAR(MAX)
		DECLARE @InternalProductWhereClause NVARCHAR(MAX)

		DECLARE @WorkingProcess INT = 0 

		DECLARE @TBL_FilterClause TABLE (ID INT IDENTITY(1,1),AttributeValue NVARCHAR(MAX),AttributeCode NVARCHAr(MAX),PimAttributeId INT ,AttributeTypeName VARCHAR(300),AttributeCodeOrg VARCHAR(600))

		DECLARE @WhereClauseXML XML = @WhereClause 

		SET @SQL  = ''

		IF EXISTS (SELECT TOP 1 1 FROM @WhereClauseXml.nodes ( '//ArrayOfWhereClauseModel/WhereClauseModel'  ) AS Tbl(Col) 
		WHERE Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(MAX)')  LIKE  '% in (%')
		BEGIN 
			SET @WorkingProcess = 1

				INSERT INTO @TBL_FilterClause (AttributeValue,AttributeCode,AttributeTypeName,PimAttributeId,AttributeCodeOrg)
			SELECT  Tbl.Col.value ( 'attributevalue[1]' , 'NVARCHAR(MAX)') AS AttributeValue
			,Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(MAX)') AS AttributeValue,ZTY.AttributeTypeName,ZPA.PimAttributeId,AttributeCode AttributeCodeOrg
			FROM @WhereClauseXml.nodes ( '//ArrayOfWhereClauseModel/WhereClauseModel'  ) AS Tbl(Col)
			LEFT JOIN  ZnodePimAttribute ZPA  ON ((Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(MAX)')  LIKE '%in (%' OR dbo.Fn_Trim(REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(MAX)'),' = ',''),'''','')) 
												= ZPA.AttributeCode ) AND IsCategory = 0 
			AND ( ZPA.IsShowOnGrid = 1 OR ZPA.IsConfigurable =1  )  )
			LEFT JOIN ZnodeAttributeType ZTY ON (ZTY.AttributeTypeId = ZPA.AttributeTypeId)

		END 
		ELSE 
		BEGIN 

			INSERT INTO @TBL_FilterClause (AttributeValue,AttributeCode,AttributeTypeName,PimAttributeId,AttributeCodeOrg)
			SELECT  Tbl.Col.value ( 'attributevalue[1]' , 'NVARCHAR(MAX)') AS AttributeValue
			,Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(MAX)') AS AttributeValue,ZTY.AttributeTypeName,ZPA.PimAttributeId,AttributeCode AttributeCodeOrg
			FROM @WhereClauseXml.nodes ( '//ArrayOfWhereClauseModel/WhereClauseModel'  ) AS Tbl(Col)
			LEFT JOIN ZnodePimAttribute ZPA  ON (dbo.Fn_Trim(REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(MAX)'),' = ',''),'''','')) 
												= ZPA.AttributeCode AND ZPA.IsCategory = 0 
			AND ( ZPA.IsShowOnGrid = 1 OR ZPA.IsConfigurable =1  )  )
			LEFT JOIN ZnodeAttributeType ZTY ON (ZTY.AttributeTypeId = ZPA.AttributeTypeId)

		END 

		CREATE TABLE #TBL_PimProductId (PimProductId INT)

		CREATE TABLE #TBL_PimProductIdDelete (PimProductId INT )

		INSERT INTO #TBL_PimProductId (PimProductId )
		SELECT Id 
		FROM @PimProductId

		SELECT ZPAV.PimProductId ,PimAttributeValueId ,ZPAV.CreatedDate,ZPAV.ModifiedDate,TBLA.AttributeCodeOrg AttributeCode
		INTO #TBL_AttributeValueId 
		FROM  ZnodePimAttributeValue ZPAV 
		INNER JOIN @TBL_FilterClause TBLA ON (TBLA.PimAttributeId = ZPAV.PimAttributeId)
		INNER JOIN #TBL_PimProductId YT ON (YT.PimProductId = ZPAV.PimProductId OR NOT EXISTS (SELECT TOP 1 1 #TBL_PimProductId))

		DELETE FROM #TBL_PimProductId

		INSERT INTO #TBL_PimProductId (PimProductId )
		SELECT DISTINCT PimProductId 
		FROM #TBL_AttributeValueId

		IF @WorkingProcess =1 
		BEGIN 
				DECLARE @PimAttributeId_in TransferId 

				INSERT INTO @PimAttributeId_in 
				SELECT PimAttributeId
				FROM  @TBL_FilterClause 
				WHERE AttributeTypeName IN ('Simple Select','Multi Select') 
				AND AttributeCode LIKE '%in (%'

				CREATE TABLE #TBL_AttributeDefaultValue_in ( PimAttributeId INT ,
							AttributeDefaultValueCode VARCHAR(MAX),IsEditable INT,AttributeDefaultValue NVARCHAR(MAX),DisplayOrder INT,PimAttributeDefaultValueId INT,IsDefault Bit  )    
				INSERT INTO #TBL_AttributeDefaultValue_in(PimAttributeId,AttributeDefaultValueCode,IsEditable,AttributeDefaultValue,DisplayOrder,PimAttributeDefaultValueId,IsDefault)
				EXEC Znode_GetAttributeDefaultValueLocaleNew_TansferId @PimAttributeId_in, @LocaleId;
 
				DECLARE @WhereClauseInCom NVARCHAR(MAX) = (SELECT TOP 1 AttributeValue FROM @TBL_FilterClause WHERE AttributeCode LIKE '%in (%') 


			SET @SQL = '
			;With Cte_AttributeValue AS 
			(
			SELECT PimAttributeValueId 
			FROM ZnodePimAttributeValueLocale 
			WHERE AttributeValue '+@WhereClauseInCom+'
			UNION ALL 
			SELECT ZPADV.PimAttributeValueID 
			FROM ZnodePimProductAttributeDefaultValue ZPADV 
			INNER JOIN #TBL_AttributeDefaultValue_in TBL ON (TBL.PimAttributeDefaultValueId = ZPADV.PimAttributeDefaultValueId)
			WHERE TBL.AttributeDefaultValue '+@WhereClauseInCom+'
			)
   
			SELECT PimProductId 
			FROM #TBL_AttributeValueId ZPAV 
			INNER JOIN  Cte_AttributeValue CTAC ON (CTAC.PimAttributeValueId = ZPAV.PimAttributeVaLueId )
			GROUP BY PimProductId
			UNION ALL  
			SELECT PimProductId 
			FROM ZnodePimProduct a
			INNER JOIN ZnodePimFamilyLocale b ON (b.PimAttributeFamilyId = a.PimAttributeFamilyId) 
			WHERE b.AttributeFamilyName '+@WhereClauseInCom+'
			GROUP BY PimProductId
			UNION ALL 
			SELECT  TBLAV.PimProductId 
			FROM ZnodePimProduct TBLAV
			WHERE CASE WHEN TBLAV.IsProductPublish  IS NULL THEN ''Not Published'' 
					WHEN TBLAV.IsProductPublish = 0 THEN ''Draft''
					ELSE  ''Published'' END '+@WhereClauseInCom+'
			GROUP BY TBLAV.PimProductId 
			'
   
			DELETE FROM #TBL_PimProductIdDelete 
			INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
			EXEC (@SQL)
			DELETE FROM #TBL_PimProductId
			INSERT INTO #TBL_PimProductId
			SELECT PimProductId FROM #TBL_PimProductIdDelete
			INSERT INTO #TBL_PimProductId
			SELECT -1 
			WHERE NOT EXISTS (SELECT TOP 1 1  FROM #TBL_PimProductId)

			DELETE  FROM @TBL_FilterClause WHERE AttributeCode LIKE '% in (%'

			DROP TABLE #TBL_AttributeDefaultValue_in
			SET @WorkingProcess  = 0 
   
		END 

		IF EXISTS (SELECT TOP 1 1 FROM @TBL_FilterClause WHERE AttributeCode <> '' AND ISNULL(AttributeValue,'') = '')
		BEGIN 
  
				SET  @InternalProductWhereClause = STUFF( (  SELECT ' INNER JOIN #TBL_AttributeValueId AS ZPAVL'+CAST(ID AS VARCHAR(200))+
												' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
												' )'				
										FROM @TBL_FilterClause
										WHERE ISNULL(AttributeValue,'') = ''
										FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				----Change for configurable product varient page seach
				SET @SQL = ' 
							SELECT  TBLAV.PimProductId 
							FROM #TBL_AttributeValueId TBLAV '+@InternalProductWhereClause+' 
							WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId )
							GROUP BY TBLAV.PimProductId 
						'
  

				DELETE FROM #TBL_PimProductIdDelete 
				INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
				EXEC (@SQL)
				DELETE FROM #TBL_PimProductId
				INSERT INTO #TBL_PimProductId
				SELECT PimProductId FROM #TBL_PimProductIdDelete
				INSERT INTO #TBL_PimProductId
				SELECT -1 
				WHERE NOT EXISTS (SELECT TOP 1 1  FROM #TBL_PimProductId)
				DELETE FROM @TBL_FilterClause WHERE ISNULL(AttributeValue,'') = ''
				IF NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) AND EXISTS (SELECT TOP 1 1  FROM @PimProductId Having Max (ID) = 0 )
				BEGIN
				INSERT INTO  #TBL_PimProductId (PimProductId)
				SELECT 0 
			END
  
		END 

		IF EXISTS (SELECT TOP 1 1 FROM @TBL_FilterClause WHERE AttributeTypeName IN ('Simple Select','Multi Select') )
		BEGIN
			DECLARE @PimAttributeId TransferId 

			INSERT INTO @PimAttributeId 
			SELECT DISTINCT PimAttributeId
			FROM  @TBL_FilterClause WHERE AttributeTypeName IN ('Simple Select','Multi Select') 

			CREATE TABLE #TBL_AttributeDefaultValue ( PimAttributeId INT ,
						AttributeDefaultValueCode VARCHAR(MAX),IsEditable INT,AttributeDefaultValue NVARCHAR(MAX),DisplayOrder INT,PimAttributeDefaultValueId INT,IsDefault BIT  )    
			INSERT INTO #TBL_AttributeDefaultValue(PimAttributeId,AttributeDefaultValueCode,IsEditable,AttributeDefaultValue,DisplayOrder,PimAttributeDefaultValueId,IsDefault)
			EXEC Znode_GetAttributeDefaultValueLocaleNew_TansferId @PimAttributeId, @LocaleId;
 
			IF @DefaultLocaleId = @LocaleID AND  @WorkingProcess = 0 
			BEGIN 

				IF @IsProductNotIn = 1 AND EXISTS(SELECT * FROM @TBL_FilterClause WHERE AttributeCodeOrg = 'Brand')
				BEGIN
					SET  @InternalProductWhereClause = STUFF( (  SELECT ' INNER JOIN Cte_AttributeValue AS ZPAVL'+CAST(ID AS VARCHAR(200))+
													' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
													+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+
													'.LocaleId='+CAST(@LocaleID AS VARCHAR(200))+' )'				
											FROM @TBL_FilterClause
											WHERE AttributeTypeName IN ('Simple Select','Multi Select')
											AND AttributeValue <> ''
											AND AttributeValue IS NOT NULL
											FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				END
				ELSE IF @IsProductNotIn = 0  AND EXISTS(SELECT * FROM @TBL_FilterClause WHERE AttributeCodeOrg <> 'Brand')
				BEGIN
					SET  @InternalProductWhereClause = STUFF( (  SELECT ' INNER JOIN Cte_AttributeValue AS ZPAVL'+CAST(ID AS VARCHAR(200))+
													' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
													+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+
													'.LocaleId='+CAST(@LocaleID AS VARCHAR(200))+' )'				
											FROM @TBL_FilterClause
											WHERE AttributeTypeName IN ('Simple Select','Multi Select')
											AND AttributeValue <> ''
											AND AttributeValue IS NOT NULL
											FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				END
				ELSE
				BEGIN
					SET @InternalProductWhereClause = ''
				END
				
				SET @SQL = ' ;With Cte_AttributeValue AS 
							(
							SELECT TBLAV.PimAttributeValueId ,SUBSTRING((SELECT '',''+AttributeDefaultValue FROM #TBL_AttributeDefaultValue TTR 
							INNER JOIN ZnodePimProductAttributeDefaultValue ZPAVL ON (TTR.PimAttributeDefaultValueId = ZPAVL.PimAttributeDefaultValueId )
							WHERE ZPAVL.PimAttributeValueId = TBLAV.PimAttributeValueId  
							AND ZPAVL.LocaleId = '+Cast(@localeId AS VARCHAR(200))+'
							FOR XML PATH('''') ),2,4000) AttributeValue
								,  '+Cast(@localeId AS VARCHAR(200))+' LocaleId,TBLAV.AttributeCode,TBLAV.PimProductId
							FROM #TBL_AttributeValueId TBLAV
							'+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END+'
							GROUP BY TBLAV.PimAttributeValueId,TBLAV.AttributeCode,TBLAV.PimProductId
							)
  
						SELECT  TBLAV.PimProductId
						FROM #TBL_AttributeValueId TBLAV
						'+@InternalProductWhereClause+'	GROUP BY TBLAV.PimProductId '
			
				
			END 
			ELSE IF  @WorkingProcess = 0 
			BEGIN 

				SET  @InternalProductWhereClause = 
										STUFF( (  SELECT ' INNER JOIN Cte_AttributeValue AS ZPAVL'+CAST(ID AS VARCHAR(200))+
												' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
												' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+'  )'				
										FROM @TBL_FilterClause
										WHERE AttributeTypeName IN ('Simple Select','Multi Select')
										AND AttributeValue <> ''
										AND AttributeValue IS NOT NULL
										FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				SET @SQL = '  			 
							SELECT TBLAV.PimAttributeValueId,ZPAVL.PimAttributeDefaultValueId , ZPAVL.LocaleId ,COUNT(*)Over(Partition By TBLAV.PimAttributeValueId ,TBLAV.PimProductId ORDER BY TBLAV.PimAttributeValueId ,TBLAV.PimProductId  ) RowId
							INTO #temp_Table 
							FROM #TBL_AttributeValueId TBLAV 
							INNER JOIN ZnodePimProductAttributeDefaultValue ZPAVL ON (ZPAVL.PimAttributeValueId = TBLAV.PimAttributeValueId)
							WHERE (ZPAVL.LocaleId = '+Cast(@localeId AS VARCHAR(200))+' OR ZPAVL.LocaleId = '+Cast(@DefaultlocaleId AS VARCHAR(200))+')
				
							;with Cte_AttributeValue AS 
							(
							SELECT TBLAV.PimAttributeValueId ,SUBSTRING((SELECT '',''+AttributeDefaultValue FROM #TBL_AttributeDefaultValue TTR 
							INNER JOIN #temp_Table  ZPAVL ON (TTR.PimAttributeDefaultValueId = ZPAVL.PimAttributeDefaultValueId )
							WHERE ZPAVL.PimAttributeValueId = TBLAV.PimAttributeValueId  
							AND ZPAVL.LocaleId = CASE WHEN ZPAVL.RowId = 2 THEN '+CAST(@LocaleId AS Varchar(300))+' ELSE '+Cast(@DefaultLocaleId AS Varchar(300))+' END  
							FOR XML PATH('''') ),2,4000) AttributeValue,TBLAV.AttributeCode ,TBLAV.PimProductId 
							FROM #TBL_AttributeValueId TBLAV
							'+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END+'
							GROUP BY TBLAV.PimAttributeValueId,TBLAV.AttributeCode ,TBLAV.PimProductId 
							)
  
							SELECT   TBLAV.PimProductId
							FROM  #TBL_AttributeValueId TBLAV
							'+@InternalProductWhereClause+'	GROUP BY TBLAV.PimProductId '

			END 

			DELETE FROM #TBL_PimProductIdDelete 
			INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
			EXEC (@SQL)
			DELETE FROM #TBL_PimProductId
			INSERT INTO #TBL_PimProductId
			SELECT PimProductId FROM #TBL_PimProductIdDelete
 
			DROP TABLE #TBL_AttributeDefaultValue

		END 

		IF EXISTS (SELECT TOP 1 1 FROM @TBL_FilterClause WHERE AttributeTypeName IN ('Text','Number','Datetime','Yes/No','Date') )
		BEGIN  
   
				IF @DefaultLocaleId = @LocaleID AND @WorkingProcess = 0 
				BEGIN 
					SET  @InternalProductWhereClause = 
											STUFF( (  SELECT ' INNER JOIN View_PimProducttextValue AS ZPAVL'+CAST(ID AS VARCHAR(200))+
													' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
													' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+
													'.LocaleId='+CAST(@LocaleID AS VARCHAR(200))+' )'				
											FROM @TBL_FilterClause
											WHERE AttributeTypeName IN ('Text','Number','Datetime','Yes/No','Date')
											FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
 
					SET @SQL = '	SELECT  TBLAV.PimProductId 
								FROM #TBL_AttributeValueId TBLAV
								'+@InternalProductWhereClause+'
								'+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
											ELSE ' WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId   ) ' END 
								+' GROUP BY TBLAV.PimProductId '

			END 
			ELSE IF @WorkingProcess = 0 
			BEGIN 
				SET  @InternalProductWhereClause = 
										STUFF( (  SELECT ' INNER JOIN Cte_AttributeDetails AS ZPAVL'+CAST(ID AS VARCHAR(200))+
												' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
												' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+
												'.LocaleId = CASE WHEN ZPAVL'+CAST(ID AS VARCHAR(200))+'.RowId = 2 THEN  '+CAST(@LocaleId AS Varchar(300))+' ELSE '+Cast(@DefaultLocaleId AS Varchar(300))+' END  )'				
										FROM @TBL_FilterClause
										WHERE AttributeTypeName IN ('Text','Number','Datetime','Yes/No','Date')
										FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				SET @SQL = ' 
					;With Cte_AttributeDetails AS 
					(
					SELECT TBLAV.PimProductId,ZPAVL.AttributeValue,TBLAV.AttributeCode,ZPAVL.LocaleId ,COUNT(*)Over(Partition By TBLAV.PimProductId,TBLAV.AttributeCode ORDER BY TBLAV.PimProductId,TBLAV.AttributeCode  ) RowId
					FROM #TBL_AttributeValueId TBLAV 
					INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON (ZPAVL.PimAttributeValueId = TBLAV.PimAttributeValueId )
					WHERE (LocaleId = '+Cast(@DefaultLocaleId AS Varchar(300))+' OR LocaleId = '+CAST(@LocaleId AS Varchar(300))+' )'+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' AND EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END +'
					) 
					SELECT  TBLAV.PimProductId 
  					FROM #TBL_AttributeValueId TBLAV
					'+@InternalProductWhereClause+'
					GROUP BY TBLAV.PimProductId 
					'
			END 
			DELETE FROM #TBL_PimProductIdDelete 
			INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
			EXEC (@SQL)
			DELETE FROM #TBL_PimProductId
			INSERT INTO #TBL_PimProductId
			SELECT PimProductId FROM #TBL_PimProductIdDelete

		END 

		IF EXISTS (SELECT TOP 1 1 FROM @TBL_FilterClause WHERE AttributeTypeName IN ('Text Area') )
		BEGIN    
			IF @DefaultLocaleId = @LocaleID AND @WorkingProcess = 0 
			BEGIN 
				SET  @InternalProductWhereClause = 
											STUFF( (  SELECT ' INNER JOIN View_PimProductTextAreaValue AS ZPAVL'+CAST(ID AS VARCHAR(200))+
												' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
												' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+
												'.LocaleId='+CAST(@LocaleID AS VARCHAR(200))+' )'				
										FROM @TBL_FilterClause
										WHERE AttributeTypeName IN ('Text Area')
										FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
 
				SET @SQL = '
							SELECT  TBLAV.PimProductId 
							FROM #TBL_AttributeValueId TBLAV
							'+@InternalProductWhereClause+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END 
										+' GROUP BY TBLAV.PimProductId '
			END 
			ELSE IF @WorkingProcess = 0 
			BEGIN 
				SET  @InternalProductWhereClause = 
										STUFF( (  SELECT ' INNER JOIN Cte_AttributeDetails AS ZPAVL'+CAST(ID AS VARCHAR(200))+
												' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
												' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+
												'.LocaleId = CASE WHEN ZPAVL'+CAST(ID AS VARCHAR(200))+'.RowId = 2 THEN  '+CAST(@LocaleId AS Varchar(300))+' ELSE '+Cast(@DefaultLocaleId AS Varchar(300))+' END  )'				
										FROM @TBL_FilterClause
										WHERE AttributeTypeName IN ('Text Area')
										FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				SET @SQL = ' 
					;With Cte_AttributeDetails AS 
					(
					SELECT TBLAV.PimProductId,TBLAV.AttributeCode,ZPAVL.AttributeValue,ZPAVL.LocaleId ,COUNT(*)Over(Partition By TBLAV.PimProductId,TBLAV.AttributeCode ORDER BY TBLAV.PimProductId,TBLAV.AttributeCode  ) RowId
					FROM #TBL_AttributeValueId TBLAV 
					INNER JOIN ZnodePimProductAttributeTextAreaValue ZPAVL ON (ZPAVL.PimAttributeValueId = TBLAV.PimAttributeValueId )
					WHERE (LocaleId = '+Cast(@DefaultLocaleId AS Varchar(300))+' OR LocaleId = '+CAST(@LocaleId AS Varchar(300))+' )
	 
					) 
					SELECT  TBLAV.PimProductId 
  					FROM #TBL_AttributeValueId TBLAV
					'+@InternalProductWhereClause+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END 
										+' 
										GROUP BY TBLAV.PimProductId 	
										'
				END 
			DELETE FROM #TBL_PimProductIdDelete 
			INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
			EXEC (@SQL)
			DELETE FROM #TBL_PimProductId
			INSERT INTO #TBL_PimProductId
			SELECT PimProductId FROM #TBL_PimProductIdDelete

		END 
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_FilterClause WHERE AttributeCode  LIKE '%PublishStatus%' )
		BEGIN    
 
				SET @SQL = '
							SELECT  TBLAV.PimProductId 
							FROM ZnodePimProduct TBLAV
							WHERE CASE WHEN TBLAV.IsProductPublish  IS NULL THEN ''Not Published'' 
							WHEN TBLAV.IsProductPublish = 0 THEN ''Draft''
							ELSE  ''Published'' END '+(SELECT TOP 1 AttributeValue FROM @TBL_FilterClause WHERE AttributeCode LIKE '%PublishStatus%')+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' AND EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END 
										+' GROUP BY TBLAV.PimProductId '
  
				DELETE FROM #TBL_PimProductIdDelete 
				INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
				EXEC (@SQL)
				DELETE FROM #TBL_PimProductId
				INSERT INTO #TBL_PimProductId
				SELECT PimProductId FROM #TBL_PimProductIdDelete

		END 
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_FilterClause WHERE AttributeCode  LIKE '%AttributeFamily%' )
		BEGIN 

				;With Cte_attributeValue AS 
				(
					SELECT ZPAF.PimAttributeFamilyId,FamilyCode,AttributeFamilyName ,ZPFL.LocaleId
					FROM ZnodePimAttributeFamily ZPAF
					INNER JOIN ZnodePimFamilyLocale ZPFL ON (ZPFL.PimAttributeFamilyId = ZPAF.PimAttributeFamilyId) 
					WHERE ZPFL.LocaleId IN (@DefaultLocaleId,@LocaleId)
				) 
				, Cte_AttributeValueAttribute AS 
				(
					SELECT PimAttributeFamilyId,FamilyCode,AttributeFamilyName
					FROM Cte_attributeValue RTY 
					WHERE LocaleId = @LocaleId
				)
				, Cte_AttributeValueTht AS 
				(
					SELECT PimAttributeFamilyId,FamilyCode,AttributeFamilyName
					FROM Cte_AttributeValueAttribute
					UNION ALL 
					SELECT PimAttributeFamilyId,FamilyCode,AttributeFamilyName
					FROM Cte_attributeValue TYY  
					WHERE NOT EXISTS (SELECT TOP 1 1 FROM Cte_AttributeValueAttribute THE WHERE THE.PimAttributeFamilyId = TYY.PimAttributeFamilyId )
					AND TYY.LocaleId = @DefaultLocaleId
				)
				SELECT PimAttributeFamilyId,FamilyCode,AttributeFamilyName
				INTO #TBL_FamilyLocale
				FROM Cte_AttributeValueTht 


				SET @SQL = '
							SELECT  TBLAV.PimProductId 
							FROM ZnodePimProduct TBLAV 
							INNER JOIN #TBL_FamilyLocale THY ON (THY.PimAttributeFamilyId = TBLAV.PimAttributeFamilyId )
							WHERE AttributeFamilyName '+(SELECT TOP 1 AttributeValue FROM @TBL_FilterClause WHERE AttributeCode LIKE '%AttributeFamily%')+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' AND EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END 
										+' GROUP BY TBLAV.PimProductId '
  

			DELETE FROM #TBL_PimProductIdDelete 
			INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
			EXEC (@SQL)
			DELETE FROM #TBL_PimProductId
			INSERT INTO #TBL_PimProductId
			SELECT PimProductId FROM #TBL_PimProductIdDelete

		END 
	
		SET @SQL = '
		IF EXISTS ( SELECT TOP 1 1 FROM tempdb..sysobjects WHERE name = ''##Temp_PimProductId'+CAST(@@SPID AS VARCHAR(500))+''' )
		BEGIN 
			DROP TABLE ##Temp_PimProductId'+CAST(@@SPID AS VARCHAR(500))+'
		END 
		CREATE TABLE ##Temp_PimProductId'+CAST(@@SPID AS VARCHAR(500))+' (PimProductId INT )
		INSERT INTO  ##Temp_PimProductId'+CAST(@@SPID AS VARCHAR(500))+'
		SELECT PimProductId 
		FROM #TBL_PimProductId
		'
		EXEC (@SQL)
		DROP TABLE #TBL_PimProductId
		DROP TABLE #TBL_AttributeValueId
		DROP TABLE #TBL_PimProductIdDelete
 END
 
GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ManageProductList_XML')
	DROP PROC Znode_ManageProductList_XML

GO

CREATE PROCEDURE [dbo].[Znode_ManageProductList_XML]
(   @WhereClause						 XML,
    @Rows								 INT           = 100,
    @PageNo								 INT           = 1,
    @Order_BY			 VARCHAR(1000) = '',
    @LocaleId			 INT           = 1,
    @PimProductId		 VARCHAR(2000) = 0,
    @IsProductNotIn	 BIT           = 0,
	@IsCallForAttribute BIT		   = 0,
	@AttributeCode      VARCHAR(max ) = '' ,
	@PimCatalogId   INT = 0,
	@IsCatalogFilter   BIT            = 0,
	@IsDebug            Bit		   = 0,
	@publishstatus   NVARCHAR(200) = '' 
	)
AS
    
/*
		  Summary:-   This Procedure is used for get product List  
				    Procedure will pivot verticle table(ZnodePimattributeValues) into horizontal table with columns 
				    ProductId,ProductName,ProductType,AttributeFamily,SKU,Price,Quantity,IsActive,ImagePath,Assortment,LocaleId,DisplayOrder
        
		  Unit Testing
		  
exec Znode_ManageProductList_XML @WhereClause=N'',@Rows=50,@PageNo=1,@Order_By=N'',@LocaleId=1,@PimProductId=N'',@IsProductNotIn=1,@IsCallForAttribute=0,@AttributeCode=''
          select * from ZnodeAttributeType  WHERE AttributeValue LIKE '%&%'
		  UPDATE VieW_lOADMANAGEpRODUCT SET  AttributeValue = 'A & B'  WHERE AttributeValue LIKE '% and %' AND PimProductId = 158
    */

     BEGIN
         SET NOCOUNT ON;
         BEGIN TRY
		 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
             DECLARE @PimProductIds TransferId, --VARCHAR(MAX), 
					 @FirstWhereClause NVARCHAR(MAX)= '', 
					 @SQL NVARCHAR(MAX)= '' ,
					 @OutPimProductIds VARCHAR(max),
					 @ProductXML NVARCHAR(max) ;
			Declare @publishstatusid table (id int);

			if isnull(@publishstatus,'') <>''
				begin
				declare @sql1 nvarchar(2000)='';
				DECLARE @ParmDefinition NVARCHAR(500); 
				set @sql1 = N'select  PublishStateId from ZnodePublishState where DisplayName ' +  @publishstatus +'';
				
				 ----EXEC (@sql1);
				 insert into @publishstatusid
				 EXEC (@sql1)
				  
				 --set @publishstatusid = @p

				 ----set @sql1 = N' SET @publishstatusid1 =( select top 1  PublishStateId from ZnodePublishState where DisplayName like ''%' + @publishstatus +'%'')';
				
				 --------EXEC (@sql1);
				 ----set @ParmDefinition ='@publishstatusid1 int output';
				 ---- EXECUTE sp_executesql @sql1, @ParmDefinition, @publishstatusid1 = @publishstatusid output

				End

             DECLARE @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId()
					 ,@RowsCount INT =0 ;
             DECLARE @TransferPimProductId TransferId 
			 DECLARE @TBL_AttributeDefaultValue TABLE
             (PimAttributeId            INT,
              AttributeDefaultValueCode VARCHAR(100),
              IsEditable                BIT,
              AttributeDefaultValue     NVARCHAR(MAX)
			  ,DisplayOrder INT 
			  ,PimAttributedefaultValueId INT 
             );
             DECLARE @TBL_AttributeDetails AS TABLE
             (PimProductId   INT,
              AttributeValue NVARCHAR(MAX),
              AttributeCode  VARCHAR(600),
              PimAttributeId INT,
			  AttributeDefaultValue NVARCHAR(MAX)
             );
			 Create table #TBL_AttributeDetailsLocale
             (PimProductId   INT,
              AttributeValue NVARCHAR(MAX),
              AttributeCode  VARCHAR(600),
              PimAttributeId INT
             );
			 DECLARE @TBL_MultiSelectAttribute TABLE (PimAttributeId INT , AttributeCode VARCHAR(600))
			
			 DECLARE @TBL_MediaAttribute TABLE (Id INT ,PimAttributeId INT ,AttributeCode VARCHAR(600) )
			 
			 DECLARE @TBL_ProductIds TABLE 
			 (
			  PimProductId INT,
			  ModifiedDate DATETIME  
			 )

			 DECLARE @FamilyDetails TABLE
             (
			  PimProductId         INT,
              PimAttributeFamilyId INT,
              FamilyName           NVARCHAR(Max)
             );
             DECLARE @DefaultAttributeFamily INT= dbo.Fn_GetDefaultPimProductFamilyId();
             DECLARE @ProductIdTable TABLE
             (PimProductId INT,
              CountId      INT,
              RowId        INT IDENTITY(1,1)
             );
          		
             IF EXISTS ( SELECT TOP 1 1 FROM @WhereClause.nodes ( '//ArrayOfWhereClauseModel/WhereClauseModel'  ) AS Tbl(Col)
			 WHERE LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''',''))))  =  'Brand'
                OR LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''','')))) = 'Vendor'
                OR LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''',''))))  =  'ShippingCostRules'
                OR LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''','')))) =  'Highlights') and @IsCallForAttribute=1
                 BEGIN
                DECLARE @AttributeCodeValue TABLE (AttributeValue NVARCHAr(max),AttributeCode NVARCHAR(max))

				INSERT INTO @AttributeCodeValue(AttributeValue,AttributeCode)
				SELECT  Tbl.Col.value ( 'attributevalue[1]' , 'NVARCHAR(max)') AS AttributeValue
						 ,Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)') AS AttributeCode
				FROM @WhereClause.nodes ( '//ArrayOfWhereClauseModel/WhereClauseModel'  ) AS Tbl(Col)
				WHERE LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''',''))))  =  'Brand'
                OR LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''',''))))  = 'Vendor'
                OR LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''',''))))  =  'ShippingCostRules'
                OR LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''',''))))  =  'Highlights'
		
				SET @SQL =   
				           ';WIth Cte_DefaultValue AS (
										  SELECT AttributeDefaultValueCode , ZPDF.PimAttributeId ,FNPA.AttributeCode
										  FROM ZnodePImAttributeDefaultValue ZPDF
										  INNER JOIN [dbo].[Fn_GetProductDefaultFilterAttributes] () FNPA ON ( FNPA.PimAttributeId = ZPDF.PimAttributeId) 
										)
										, Cte_productIds AS 
										(
										  SELECT a.PimProductId, c.AttributeCode , CTDV.AttributeDefaultValueCode AttributeValue,b.ModifiedDate 
										  FROM  ZnodePimAttributeValue a
										  LEFT JOIN ZnodePimAttribute c ON(c.PimAttributeId = a.PimAttributeId)
										  LEFT JOIN ZnodePimAttributeValueLocale b ON(b.PimAttributeValueId = a.PimAttributeValueId)  
										  INNER JOIN Cte_DefaultValue CTDV ON (CTDV.AttributeCode = c.AttributeCode 
										  AND EXISTS (SELECT TOP 1 1 FROM dbo.split(b.AttributeValue,'','') SP WHERE SP.Item = CTDV.AttributeDefaultValueCode) )
										  Union all 
										  
											SELECT a.PimProductId,c.AttributeCode,ZPADV.AttributeDefaultValueCode AttributeValue ,a.ModifiedDate 
											FROM ZnodePimProductAttributeDefaultValue ZPPADV
											INNER JOIN ZnodePimAttributeDefaultValue ZPADV ON (ZPPADV.PimAttributeDefaultValueId = ZPADV.PimAttributeDefaultValueId)
											LEFT JOIN ZnodePimAttributeValue a ON (a.PimAttributeValueId = ZPPADV.PimAttributeValueId )
											LEFT JOIN ZnodePimAttribute c ON ( c.PimAttributeId=a.PimAttributeId )
											INNER JOIN Cte_DefaultValue CTDV ON (CTDV.AttributeCode = c.AttributeCode )
										)										
										SELECT PimProductId ,ModifiedDate
										FROM Cte_productIds WHERE  AttributeCode '+(SELECT TOP 1 AttributeCode  FROM @AttributeCodeValue )+' AND 
										AttributeValue '+(SELECT TOP 1 AttributeValue  FROM @AttributeCodeValue )+' 
										GROUP BY PimProductId,ModifiedDate Order By ModifiedDate DESC ';


					 SET @Order_BY = CASE WHEN @Order_BY = '' THEN 'ModifiedDate DESC' ELSE @Order_BY END 
					 	
					 SET @WhereClause = CAST(REPLACE(CAST(@WhereClause AS NVARCHAR(max)),'<WhereClauseModel><attributecode>'''+(SELECT TOP 1 AttributeCode  FROM @AttributeCodeValue )+'''</attributecode><attributevalue>'''+(SELECT TOP 1 AttributeValue   FROM @AttributeCodeValue )+'''</attributevalue></WhereClauseModel>','') AS XML )
					
				     INSERT INTO @TBL_ProductIds ( PimProductId, ModifiedDate )
					 EXEC (@SQL);
			  					 
					
						 INSERT INTO @ProductIdTable( PimProductId )
						 SELECT PimProductId 
						 FROM @TBL_ProductIds
					

                     INSERT INTO @TransferPimProductId
					 SELECT PimProductId
                     FROM @ProductIdTable
                   
				   			  
     DELETE FROM @ProductIdTable;
   --  SET @WhereClause = CAST(REPLACE(CAST(@WhereClause AS NVARCHAR(MAX)), @FirstWhereClause, ' 1 = 1') AS XML);
                 END
	            ELSE IF @PimProductId <> ''
			    BEGIN 
		
				 INSERT INTO @TransferPimProductId(id)
				 SELECT Item 
				 FROM dbo.split(@PimProductId,',')
			    END 
		
			
	 DECLARE  @ProductListIdRTR TransferId
	 DECLARE @TAb Transferid 
	 --DECLARE @tBL_mainList TABLE (Id INT,RowId INT)
	 Create table #TBL_ProductMainList (Id INT,RowId INT)

	 	IF @PimProductId <> ''  OR   @IsCallForAttribute=1 --OR (CAST(@WhereClause AS NVARCHAR(max))= N'' AND @Order_by <> N'' AND @AttributeCode = N'')
		BEGIN 
	 SET @IsProductNotIn = CASE WHEN @IsProductNotIn = 0 THEN 1  
					 WHEN @IsProductNotIn = 1 THEN 0 END 
		END 
	
	 INSERT INTO @ProductListIdRTR
	 EXEC Znode_GetProductList  @IsProductNotIn,@TransferPimProductId, @PimCatalogId,@IsCatalogFilter
 
	 IF CAST(@WhereClause AS NVARCHAR(max))<> N''
	 BEGIN 
	 
	  SET @SQL = 'SELECT Distinct PimProductId FROM ##Temp_PimProductId'+CAST(@@SPID AS VARCHAR(500))

	  EXEC Znode_GetFilterPimProductId @WhereClause,@ProductListIdRTR,@localeId,@IsProductNotIn
	  
      INSERT INTO @TAB 
	  EXEC (@SQL)
	 
	 END 
	 
	

	 IF EXISTS (SELECT Top 1 1 FROM @TAb ) OR CAST(@WhereClause AS NVARCHAR(max)) <> N''
	 BEGIN 
	 
	 SET @AttributeCode = REPLACE(dbo.FN_TRIM(REPLACE(REPLACE(@order_by,' DESC',''),' ASC','')),'DisplayOrder','ProductName')
	 SET @order_by = REPLACE(@order_by,'DisplayOrder','ProductName')
	 INSERT INTO #TBL_ProductMainList(id,RowId)
	 EXEC Znode_GetOrderByPagingProduct @order_by,@rows,@PageNo, @TAb ,@AttributeCode,@localeId
	 
	 END 
	 ELSE 
	 BEGIN
	      
	 SET @AttributeCode = REPLACE(dbo.FN_TRIM(REPLACE(REPLACE(@order_by,' DESC',''),' ASC','')),'DisplayOrder','ProductName')
	 SET @order_by = REPLACE(@order_by,'DisplayOrder','ProductName')
	 INSERT INTO #TBL_ProductMainList(id,RowId)
	 EXEC Znode_GetOrderByPagingProduct @order_by,@rows,@PageNo, @ProductListIdRTR ,@AttributeCode,@localeId 
	 END 
          

  			 INSERT INTO @PimProductIds ( Id  )
			 SELECT DISTINCT id FROM #TBL_ProductMainList

			 DECLARE @TBL_PimProductIds transferId 
			 INSERT INTO @TBL_PimProductIds
			 SELECT id 
             FROM @PimProductIds
			 			 	
			 DECLARE @PimAttributeIds TransferId  
			 INSERT INTO @PimAttributeIds
			 SELECT PimAttributeId  
			 FROM [dbo].[Fn_GetProductGridAttributes]()
			 
			

			 INSERT INTO @TBL_AttributeDetails
             (PimProductId,
              AttributeValue,
              AttributeCode,
              PimAttributeId,
			  AttributeDefaultValue
             )
             EXEC Znode_GetProductsAttributeValue_newTesting
                  @TBL_PimProductIds,
                  @PimAttributeIds,
                  @localeId;
			
			
			UPDATE @TBL_AttributeDetails
			SET AttributeValue = ISNULL(AttributeValue,'')
			WHERE AttributeValue IS NULL 

----------------------------------------------------------------------------------------------------

			

		    declare @SKU SelectColumnList
			declare @TBL_Inventorydetails table (Quantity NVARCHAR(MAx),PimProductId INT)

			INSERT INTO @SKU
			SELECT AttributeValue 
			FROM @TBL_AttributeDetails
			WHERE AttributeCode = 'SKU'
 
 			INSERT INTO @TBL_Inventorydetails(Quantity,PimProductId)
			EXEC Znode_GetPimProductAttributeInventory @SKU--vishal

			 INSERT INTO @FamilyDetails
             (PimAttributeFamilyId,
              PimProductId
             )
             EXEC [dbo].[Znode_GetPimProductAttributeFamilyId]
                  @PimProductIds,
                  1;
             
		 UPDATE a
               SET
                   FamilyName = b.AttributeFamilyName
             FROM @FamilyDetails a
                  INNER JOIN ZnodePimFamilyLocale b ON(a.PimAttributeFamilyId = b.PimAttributeFamilyId
                                                       AND LocaleId = @LocaleId);
             UPDATE a
               SET
                   FamilyName = b.AttributeFamilyName
             FROM @FamilyDetails a
                  INNER JOIN ZnodePimFamilyLocale b ON(a.PimAttributeFamilyId = b.PimAttributeFamilyId
                                                       AND LocaleId = @DefaultLocaleId)
             WHERE a.FamilyName IS NULL
                   OR a.FamilyName = '';
           	
			INSERT INTO @TBL_AttributeDetails             (PimProductId,              AttributeValue,              AttributeCode,              PimAttributeId             )
			SELECT PimProductId ,FamilyName, 'AttributeFamily',NULL
			FROM @FamilyDetails 
			

			  
					INSERT INTO @TBL_AttributeDetails             (PimProductId,              AttributeValue,              AttributeCode,              PimAttributeId             )
					SELECT a.ID PimProductId ,th.DisplayName, 'PublishStatus',NULL
					FROM @PimProductIds a 
					INNER JOIN ZnodePimProduct b ON (b.PimProductId = a.ID)
					LEFT JOIN ZnodePublishState th ON (th.PublishStateId = b.PublishStateId)
				 
			
		 IF isnull(@publishstatus,'') = ''

                 BEGIN
					INSERT INTO #TBL_AttributeDetailsLocale (PimProductId ,PimAttributeId,AttributeCode )
						SELECT  TBLAD.PimProductId ,TBLAD.PimAttributeId,TBLAD.AttributeCode 
						FROM @TBL_AttributeDetails TBLAD 
						GROUP BY  TBLAD.PimProductId ,TBLAD.PimAttributeId,TBLAD.AttributeCode 
				 end 
				 else
				 begin
						INSERT INTO #TBL_AttributeDetailsLocale (PimProductId ,PimAttributeId,AttributeCode )
							SELECT  TBLAD.PimProductId ,TBLAD.PimAttributeId,TBLAD.AttributeCode 
							FROM @TBL_AttributeDetails TBLAD where TBLAD.PimProductId  
									in (select PimProductId from @TBL_AttributeDetails  t where t.AttributeCode = 'PublishStatus'
										and AttributeValue in (select DisplayName from ZnodePublishState where PublishStateId in (select id from @publishstatusid)))
								
							GROUP BY  TBLAD.PimProductId ,TBLAD.PimAttributeId,TBLAD.AttributeCode 
				 End
		
	    UPDATE TBLPP 
		SET AttributeValue = CTDD.AttributeValue 
		FROM  @TBL_AttributeDetails CTDD 
		INNER JOIN #TBL_AttributeDetailsLocale TBLPP ON (TBLPP.PimProductId = CTDD.PimProductId AND TBLPP.AttributeCode  = CTDD.AttributeCode)
		WHERE TBLPP.AttributeValue IS NULL 

    	SET @ProductXML =  '<MainProduct>'+ STUFF( (  SELECT '<Product>'+'<PimProductId>'+CAST(TBAD.PimProductId AS VARCHAR(50))+'</PimProductId>'
																		+'<AvailableInventory>'+CAST(ISNULL(IDD.[Quantity],'') AS VARCHAR(50))+'</AvailableInventory>'
		+ STUFF(    (  SELECT '<'+TBADI.AttributeCode+'>'+CAST( (SELECT  ''+TBADI.AttributeValue FOR XML PATH('')) AS NVARCHAR(max))+'</'+TBADI.AttributeCode+'>'   
															FROM #TBL_AttributeDetailsLocale TBADI      
															 WHERE TBADI.PimProductId = TBAD.PimProductId 
															 ORDER BY TBADI.PimProductId DESC
															 FOR XML PATH (''), TYPE
																).value('.', ' Nvarchar(max)'), 1, 0, '')+'</Product>'	   

		FROM #TBL_AttributeDetailsLocale TBAD
		INNER JOIN #TBL_ProductMainList TBPI ON (TBAD.PimProductid = TBPI.id )
		LEFT JOIN @TBL_ProductIds TPT ON TBAD.PimProductId = TPT.PimProductId
		LEFT JOIN @TBL_InventoryDetails IDD ON (TBPI.id = IDD.PimProductId)
		GROUP BY TBAD.pimProductid, TPT.ModifiedDate,TBPI.RowId,IDD.Quantity
		ORDER BY TBPI.RowId 
		FOR XML PATH (''),TYPE).value('.', ' Nvarchar(max)'), 1, 0, '')+'</MainProduct>'
			--FOR XML PATH ('MainProduct'))
 

			SELECT  CAST(@ProductXML AS XML ) ProductXMl
		   
		     SELECT AttributeCode ,  ZPAL.AttributeName
			 FROM ZnodePimAttribute ZPA 
			 LEFT JOIN ZnodePiMAttributeLOcale ZPAL ON (ZPAL.PimAttributeId = ZPA.PimAttributeId )
             WHERE LocaleId = 1  
			 AND  IsCategory = 0 
			 AND ZPA.IsShowOnGrid = 1  
			 UNION ALL 
			 SELECT 'PublishStatus','Publish Status'

     IF EXISTS (SELECT Top 1 1 FROM @TAb )
	 BEGIN 

		  SELECT (SELECT COUNT(1) FROM @TAb) AS RowsCount   
	 END 
	 ELSE 
	 BEGIN
	 		  SELECT (SELECT COUNT(1) FROM @ProductListIdRTR) AS RowsCount   
	 END 
		;

             -- find the all locale values 
         END TRY
         BEGIN CATCH
		    SELECT ERROR_MESSAGE()
                DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ManageProductList_XML @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@LocaleId = '+CAST(@LocaleId AS VARCHAR(50))+',@PimProductId='+@PimProductId+',@IsProductNotIn='+CAST(@IsProductNotIn AS VARCHAR(50))+',@IsCallForAttribute='+CAST(@IsCallForAttribute AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_ManageProductList_XML',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;

         END CATCH;

     END;

GO

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'Attributes','ValidationRuleRegularExpression',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'Attributes' and ActionName = 'ValidationRuleRegularExpression')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Attributes')
,(select top 1 ActionId from ZnodeActions where ControllerName = 'Attributes' and ActionName = 'ValidationRuleRegularExpression') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Attributes')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'Attributes' and ActionName = 'ValidationRuleRegularExpression'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Attributes') ,
(select top 1 ActionId from ZnodeActions where ControllerName = 'Attributes' and ActionName = 'ValidationRuleRegularExpression')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Attributes')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'Attributes' and ActionName = 'ValidationRuleRegularExpression'))

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_AdminUsersByUserId')
	DROP PROC Znode_AdminUsersByUserId

GO

CREATE PROCEDURE [dbo].[Znode_AdminUsersByUserId]
(	@RoleName		VARCHAR(200),
    @UserName		VARCHAR(200),
    @WhereClause	XML,
    @Rows			INT           = 100,
    @PageNo			INT           = 1,
    @Order_By		VARCHAR(1000) = '',
    @RowCount		INT        = 0 OUT,
	@IsCallOnSite   BIT = 0 ,
	@PortalId		VARCHAR(1000) = 0,
	@IsGuestUser    BIT = 0,
	@ColumnName     dbo.SelectColumnList ReadOnly,
	@SalesRepUserId int = 0
)
AS
   /* 
      Summary: List of users with details and shows link with ASPNet tables 
      This procedure is used for finding both users and admin users 
      here use three view "View_RoleUsers" for check  @UserName is present or not 
      "View_AdminUserDetail"  this view use for admin users 
      "View_CustomerUserDetail" Use for customer users 
      Unit Testing   
	  SELECT * FROM ZnodeUser 
      DECLARE @EDE INT=0  EXEC Znode_AdminUsersByUserId '','admin@znode.com',@WhereClause='',@Order_By='',@PageNo= 1 ,@Rows= 214,@IsCallOnSite='false',@PortalId=0,@RowCount=@EDE OUT  SELECT @EDE
   */
     BEGIN
         BEGIN TRY
            SET NOCOUNT ON;
			
            DECLARE @SQL NVARCHAR(MAX)= '', @PaginationWhereClause VARCHAR(300)= dbo.Fn_GetRowsForPagination(@PageNo, @Rows, ' WHERE RowId');
             
			----Verifying that the @SalesRepUserId is having 'Sales Rep' role
			IF NOT EXISTS
			(
				SELECT * FROM ZnodeUser ZU
				INNER JOIN AspNetZnodeUser ANZU ON ZU.UserName = ANZU.UserName
				INNER JOIN AspNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName
				INNER JOIN AspNetUserRoles ANUR ON ANU.Id = ANUR.UserId
				Where Exists(select * from AspNetRoles ANR Where Name = 'Sales Rep' AND ANUR.RoleId = ANR.Id) 
				AND ZU.UserId = @SalesRepUserId
			)   
			Begin
				SET @SalesRepUserId = 0
			End

			IF OBJECT_ID('tempdb..#TBL_RowCount') is not null
				DROP TABLE #TBL_RowCount
			Create table #TBL_RowCount(RowsCount int )
			-----Split where clause XMl 
			CREATE TABLE #WhereColumnList(RowId Int identity, filterName varchar(max), WhereCondition varchar(max))
			insert into #WhereColumnList(filterName,WhereCondition)
			SELECT 
					Tbl.Col.value('key[1]', 'varchar(max)') as filterName,
					Tbl.Col.value('condition[1]', 'varchar(max)') WhereCondition
			FROM   @WhereClause.nodes('//filter') Tbl(Col) 
			----Address column in global search
			declare @AddressGlobalSearch varchar(1000)
			declare @GlobalSearch varchar(100)
			select @GlobalSearch = substring(WhereCondition,charindex(' like ',WhereCondition), charindex(' OR ',WhereCondition)-charindex(' like ',WhereCondition)) 
			from #WhereColumnList
			where filtername like '%|%'
			and filtername <> ''
			and filterName in ('CityName','CountryName','PostalCode','StateName','CompanyName') 

			if isnull(@GlobalSearch,'') <> ''
			begin
				select @AddressGlobalSearch = '('+'CityName '+ @GlobalSearch+' OR '+'CountryName '+ @GlobalSearch+' OR '+'PostalCode '+ @GlobalSearch+' OR '+'StateName '+ @GlobalSearch+' OR '+'CompanyName '+ @GlobalSearch+')'
			end
			else
			begin
				SET @AddressGlobalSearch = ''
			end
			----Global search where clause
			declare @WhereClauseGlobal varchar(1000)=''
			select @WhereClauseGlobal = ISNULL(WhereCondition,'')
			from #WhereColumnList
			where filtername like '%|%'
			and filtername <> ''
			
			----Where clause columns except Address columns
			declare @WhereClause1 varchar(max) 
			select @WhereClause1 = COALESCE(@WhereClause1 + '', '') + WhereCondition+' And '
			--case when @WhereClause1 <> ''  then ' And ' else '' end
			from #WhereColumnList a
			where filterName not like '%|%' and
			filterName not in ('CountryName','CityName','StateName','PostalCode','CompanyName')
			and filtername <> ''

			if @WhereClause1 <> ''
			begin
				set @WhereClause1=isnull(substring(@WhereClause1,1,len(@WhereClause1)-3),'')
			end
			else
			begin
				set @WhereClause1 = ''
			end

			----Where clause columns
			declare @AddressColumnWhereClause varchar(max) 
			select @AddressColumnWhereClause = COALESCE(@AddressColumnWhereClause + '', '') + WhereCondition+' And '
			from #WhereColumnList a
			where filterName not like '%|%' and
			filterName in ('CountryName','CityName','StateName','PostalCode','CompanyName')
			and filtername <> ''
			
			if isnull(@AddressColumnWhereClause,'') <> ''
			begin
				set @AddressColumnWhereClause=isnull(substring(@AddressColumnWhereClause,1,len(@AddressColumnWhereClause)-3),'')
            end
			else
			begin
				set @AddressColumnWhereClause = ''
			end

			declare @WhereClauseAll varchar(max)
			select @WhereClauseAll = COALESCE(@WhereClauseAll + '', '') + WhereCondition+' And '
			from #WhereColumnList a

			set @WhereClauseAll=isnull(substring(@WhereClauseAll,1,len(@WhereClauseAll)-3),'')
			-------------- 

			IF @PortalId  <> '0' 
			BEGIN 
				SELECT @PortalId = STUFF((SELECT CONCAT(', ', ISNULL(ZUP2.PortalId,@PortalId))
					FROM dbo.ZnodeUserPortal ZUP2 WITH (NOLOCK)
					WHERE ZUP1.UserId = ZUP2.UserId
					FOR XML PATH ('')), 1, 2, '')
				FROM dbo.ZnodeUserPortal ZUP1 WITH (NOLOCK)
				WHERE ZUP1.UserId=(SELECT TOP 1 UserId FROM ZnodeUser WITH (NOLOCK) WHERE UserName=@UserName)
				GROUP BY ZUP1.UserId;

			    SET @WhereClauseAll = CASE WHEN  @WhereClauseAll = '' THEN ' (PortalId IN ('+@PortalId+') OR PortalId IS NULL) ' ELSE @WhereClauseAll+' AND (PortalId IN ('+@PortalId+') OR PortalId IS NULL) ' END 

				SET @WhereClause1 = CASE WHEN  @WhereClause1 = '' THEN ' (isnull(PortalId,0) IN ('+@PortalId+') OR PortalId IS NULL) ' ELSE @WhereClause1+' AND (isnull(PortalId,0) IN ('+@PortalId+') OR PortalId IS NULL) ' END 
			
			END 
			IF EXISTS ( SELECT TOP 1 1 FROM View_RoleUsers  WHERE Username = @UserName   )  AND @RoleName <> ''  
			-- this check for admin user
       		BEGIN
				SET @SQL = ' SELECT  A.UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,A.CreatedBy,A.CreatedDate,A.ModifiedBy,A.ModifiedDate
				,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
				,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId ,CustomerPaymentGUID
				INTO #Cte_AdminUserDetail
				FROM View_AdminUserDetail A
				'+CASE WHEN @PortalId  <> '0' THEN ' INNER JOIN ZnodeUserPortal ZUP ON (ZUP.UserId = A.UserId) 'ELSE '' END  +'	 
				'+dbo.Fn_GetWhereClause(@WhereClauseAll, ' WHERE ')+'
				
				;with Cte_AdminUserDetailRowId AS 
				(
				SELECT UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
				,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
				,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId,CustomerPaymentGUID ,RANK()Over('+dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC')+',UserId DESC) RowId
				FROM  #Cte_AdminUserDetail a
				where (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
				)
					 
				SELECT UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
				,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
				,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId,CustomerPaymentGUID ,RowId 
				INTO #AccountDetails
				FROM Cte_AdminUserDetailRowId 
					 
				SET @Count= ISNULL((SELECT  Count(1) FROM #AccountDetails ),0)
					 
				SELECT DISTINCT UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
				,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
				,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId ,CustomerPaymentGUID
				FROM #AccountDetails '+@PaginationWhereClause+' '+dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC' );
				EXEC SP_executesql
				@SQL,
				N'@Count INT OUT',
				@Count = @RowCount OUT;
			END;
			-- For Customer user
            ELSE   
			BEGIN
				IF @roleName = ''
				BEGIN
					if OBJECT_ID('tempdb..##CustomerUserAddDetail') is not null
					drop table ##CustomerUserAddDetail

					if OBJECT_ID('tempdb..##View_CustomerUserAddDetail') is not null
					drop table ##View_CustomerUserAddDetail
				
					if OBJECT_ID('tempdb..##UserList') is not null
					drop table ##UserList

					CREATE TABLE ##UserList(UserId int,AddressID int)

					declare @UserList varchar(1000)=''

					------To get the list of user having adress column in global search
					if (@AddressGlobalSearch <> '')
					begin
				
					set @UserList = 'select a.UserId, b.AddressID	from ZnodeUserAddress a	inner join ZnodeAddress b on a.AddressId = b.AddressId	where '+@AddressGlobalSearch
					--print @UserList
					insert into ##UserList(UserId, b.AddressID)
					exec (@UserList)
			
					end
					----To get the list of user having adress column in where clause 
					if (@AddressColumnWhereClause <> '')
					begin
					
					set @UserList = 'select a.UserId, b.AddressID	from ZnodeUserAddress a	inner join ZnodeAddress b on a.AddressId = b.AddressId	where '+@AddressColumnWhereClause
					--print @UserList
					insert into ##UserList(UserId,AddressID)
					exec (@UserList)
					
					end

					If @IsGuestUser= 0 
					AND
					NOT Exists (Select filterName from #WhereColumnList where filterName in ('accountid','isaccountcustomer','UserId') and filtername <> '')
					-- Customer List with GuestUsers
					Begin
						SET @SQL = 
							'SELECT a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
							 a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATE, a.CreatedDate) CreatedDate,A.ModifiedBy,
							 CONVERT( DATE, a.ModifiedDate) ModifiedDate, 0 RoleId,''''  RoleName,
							 CASE	WHEN B.LockoutEndDateUtc IS NULL
							 THEN CAST(1 AS    BIT)	ELSE CAST(0 AS BIT)
							 END IsActive,	CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
				
							 (ISNULL(RTRIM(LTRIM(a.FirstName)), '''')+'' ''+ISNULL(RTRIM(LTRIM(a.MiddleName)), '''')+CASE
							 WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '''') = ''''	THEN ''''
							 ELSE '' ''	END+ISNULL(RTRIM(LTRIM(a.LastName)), '''')) 
				
							 FullName,
							 e.Name AccountName
							 ,a.AccountId,a.ExternalId,	CASE	WHEN a.AccountId IS NULL THEN 0	ELSE 1	END IsAccountCustomer,
							 a.BudgetAmount,
							 '''' TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser,a.CustomerPaymentGUID
							 --,CASE WHEN zp.StoreName IS NULL THEN ''ALL'' ELSE zp.StoreName END StoreName,
							 ,ISnull(zp.StoreName , ''ALL'')StoreName,
							 up.PortalId as PortalId, e.AccountCode
							 into ##View_CustomerUserAddDetail
							 FROM ZnodeUser a
							 INNER JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
							 INNER JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
							 LEFT JOIN ZnodeUserPortal up ON(up.UserId = a.UserId)  
							 LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
							 LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
							 WHERE (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid ) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
							' 
						EXEC (@SQL)
					End	
					Else If @IsGuestUser= 1 
					Begin
							SET @SQL='SELECT a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
							a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATE, a.CreatedDate) CreatedDate,A.ModifiedBy,
							CONVERT( DATE, a.ModifiedDate) ModifiedDate,ur.RoleId,r.Name RoleName,
							CASE WHEN B.LockoutEndDateUtc IS NULL THEN CAST(1 AS    BIT) ELSE CAST(0 AS BIT) END IsActive,
							CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
							(ISNULL(RTRIM(LTRIM(a.FirstName)), '''')+'' ''+ISNULL(RTRIM(LTRIM(a.MiddleName)), '''')+CASE
							WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '''') = '''' THEN '''' ELSE '' '' END+ISNULL(RTRIM(LTRIM(a.LastName)), '''')) FullName,
							e.Name AccountName,a.AccountId,a.ExternalId,
							CASE WHEN a.AccountId IS NULL THEN 0 ELSE 1	END IsAccountCustomer,
							a.BudgetAmount,r.TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser,a.CustomerPaymentGUID
							,CASE WHEN zp.StoreName IS NULL THEN ''ALL'' ELSE zp.StoreName END StoreName,
							CASE WHEN a.AccountId IS NULL THEN up.PortalId ELSE ZPA.PortalId END as PortalId,e.AccountCode
							into ##View_CustomerUserAddDetail
							FROM ZnodeUser a
							LEFT JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
							LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
							LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
							LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)                       
							LEFT JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
							LEFT JOIN ZnodeUserPortal up ON(up.UserId = a.UserId)  
							LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
							LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = a.AccountId) 
							WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUSer ZUQ WHERE ZUQ.UserId = a.UserId AND ZUQ.EmailOptIn = 1 AND ZUQ.AspNetUserId IS NULL )
							AND a.AspNetuserId is null
							AND (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid ) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
							'
						EXEC (@SQL)
					End
					Else IF Exists (Select filterName from #WhereColumnList where filterName in ('UserId') and filtername <> '')
					and  @IsGuestUser= 0   
					-- Customer List for user edit single user 
					Begin
					SET @SQL='SELECT a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
							a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATE, a.CreatedDate) CreatedDate,A.ModifiedBy,
							CONVERT( DATE, a.ModifiedDate) ModifiedDate,ur.RoleId,r.Name RoleName,
							CASE WHEN B.LockoutEndDateUtc IS NULL THEN CAST(1 AS    BIT) ELSE CAST(0 AS BIT) END IsActive,
							CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
							(ISNULL(RTRIM(LTRIM(a.FirstName)), '''')+'' ''+ISNULL(RTRIM(LTRIM(a.MiddleName)), '''')+CASE
							WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '''') = '''' THEN '''' ELSE '' '' END+ISNULL(RTRIM(LTRIM(a.LastName)), '''')) FullName,
							e.Name AccountName,a.AccountId,a.ExternalId,
							CASE WHEN a.AccountId IS NULL THEN 0 ELSE 1	END IsAccountCustomer,
							a.BudgetAmount,r.TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser,a.CustomerPaymentGUID
							,CASE WHEN zp.StoreName IS NULL THEN ''ALL'' ELSE zp.StoreName END StoreName,
							CASE WHEN a.AccountId IS NULL THEN up.PortalId ELSE ZPA.PortalId END as PortalId,e.AccountCode
							into ##View_CustomerUserAddDetail
							FROM ZnodeUser a
							LEFT JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
							LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
							LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
							LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)                       
							LEFT JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
							LEFT JOIN ZnodeUserPortal up ON(up.UserId = a.UserId)  
							LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
							LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = a.AccountId) 
							WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUSer ZUQ WHERE ZUQ.UserId = a.UserId AND ZUQ.EmailOptIn = 1 AND ZUQ.AspNetUserId IS NULL )
							AND (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid ) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
							'
						EXEC (@SQL)
					End	
					Else -- Account user List 
					Begin
							SELECT a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
							a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATE, a.CreatedDate) CreatedDate,A.ModifiedBy,
							CONVERT( DATE, a.ModifiedDate) ModifiedDate,ur.RoleId,r.Name RoleName,
							CASE WHEN B.LockoutEndDateUtc IS NULL THEN CAST(1 AS    BIT) ELSE CAST(0 AS BIT) END IsActive,
							CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
							(ISNULL(RTRIM(LTRIM(a.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(a.MiddleName)), '')+CASE
							WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '') = '' THEN '' ELSE ' ' END+ISNULL(RTRIM(LTRIM(a.LastName)), '')) FullName,
							e.Name AccountName,a.AccountId,a.ExternalId,
							CASE WHEN a.AccountId IS NULL THEN 0 ELSE 1	END IsAccountCustomer,
							a.BudgetAmount,r.TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser,a.CustomerPaymentGUID
							,CASE WHEN zp.StoreName IS NULL THEN 'ALL' ELSE zp.StoreName END StoreName,
							CASE WHEN a.AccountId IS NULL THEN up.PortalId ELSE ZPA.PortalId END as PortalId, e.AccountCode
							into ##View_CustomerUserAddDetail
							FROM ZnodeUser a
							LEFT JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
							LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
							LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
							LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)                       
							LEFT JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
							LEFT JOIN ZnodeUserPortal up ON(up.UserId = a.UserId)  
							LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
							LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = a.AccountId) 
							WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUSer ZUQ WHERE ZUQ.UserId = a.UserId AND ZUQ.EmailOptIn = 1 AND ZUQ.AspNetUserId IS NULL )
							AND (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = @SalesRepUserId and a.UserId = SalRep.CustomerUserid ) or @SalesRepUserId = 0)
					End


					alter table ##View_CustomerUserAddDetail 
					add DepartmentId int, PermissionsName varchar(200), PermissionCode varchar(200), DepartmentName varchar(300), AccountPermissionAccessId int,
					AccountUserOrderApprovalId int, ApprovalName varchar(1000) , ApprovalUserId int
					--, PortalId int , StoreName varchar(1000)
					,CountryName varchar(1000),CityName varchar(1000),StateName varchar(1000),PostalCode varchar(1000), CompanyName varchar(1000),
					SalesRepUserName varchar(600),SalesRepFullName varchar(1000)

	
					IF ((@AddressGlobalSearch like '%CountryName%' OR @AddressGlobalSearch like '%CityName%' OR @AddressGlobalSearch like '%StateName%' OR @AddressGlobalSearch like '%PostalCode%' OR @AddressGlobalSearch like '%CompanyName%')
					and exists(select * from ##UserList))
					BEGIN
						update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
						PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName
						from ##View_CustomerUserAddDetail a
						inner join ZnodeUserAddress ZUA on a.UserId = ZUA.UserId
						inner  JOIN ZnodeAddress ZA on ZA.AddressId = zua.AddressId
						where exists(select * from ##UserList UL where a.UserId = UL.UserId and UL.AddressId = ZA.AddressId )

						update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
						PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName
						from ##View_CustomerUserAddDetail a
						inner join ZnodeAccountAddress ZAA on a.AccountId = ZAA.AccountId
						inner  JOIN ZnodeAddress ZA on ZA.AddressId = ZAA.AddressId
						where isnull(a.AccountId,0)<> 0-- is not null
						and exists(select * from ##UserList UL where a.UserId = UL.UserId and UL.AddressID = ZA.AddressId)
						and (a.CountryName is null OR a.CityName is null OR a.StateName is null or a.PostalCode is null or a.CompanyName is null)
		
					END

					--CREATE NONCLUSTERED INDEX IND_101
					--ON [dbo].[##View_CustomerUserAddDetail] ([userId],[AspNetuserId])

					SET @SQL = '			
						
						create table #AccountDetail
						(
							UserId int,AspNetuserId nvarchar(200),UserName nvarchar(200),FirstName nvarchar(200),MiddleName nvarchar(200),LastName nvarchar(200),
							PhoneNumber nvarchar(100),Email nvarchar(100),EmailOptIn bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,
							RoleId varchar(200),RoleName varchar(200),IsActive bit,IsLock bit,FullName  varchar(1000),AccountName  varchar(200),PermissionsName  varchar(200),
							DepartmentName  varchar(200),DepartmentId int,AccountId int,AccountPermissionAccessId int, ExternalId  varchar(200),BudgetAmount numeric(10,6),
							AccountUserOrderApprovalId int,ApprovalName varchar(200),ApprovalUserId int,PermissionCode varchar(500),CustomerPaymentGUID varchar(500),
							StoreName varchar(200),PortalId int,CountryName varchar(200), CityName varchar(200), StateName varchar(200), PostalCode varchar(200), CompanyName varchar(200)
							,SalesRepUserName varchar(200),SalesRepFullName varchar(200) ,RowId int identity , AccountCode nvarchar(100)
						) 
						'+
						+' insert into #AccountDetail(UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
						EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,FullName,
						AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
						BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode,CustomerPaymentGUID
						,StoreName,PortalId, CountryName, CityName, StateName, PostalCode, CompanyName, AccountCode)
						SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
						EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,FullName,
						AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
						BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode,CustomerPaymentGUID 
						,StoreName,PortalId, CountryName, CityName, StateName, PostalCode, CompanyName, AccountCode
						FROM ##View_CustomerUserAddDetail where 1=1'+
						dbo.Fn_GetWhereClause(@WhereClauseGlobal+case when @WhereClauseGlobal<>'' and @WhereClause1 <> '' then ' And '+@WhereClause1 else @WhereClause1 end, ' AND ')+
						dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC') + '
			
						Insert Into #TBL_RowCount Values(@@RowCount)
							
						SELECT  UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
						EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,FullName,
						AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
						BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode ,CustomerPaymentGUID,StoreName,PortalId,
						CountryName, CityName, StateName, PostalCode, CompanyName, SalesRepUserName, SalesRepFullName, AccountCode
						,Row_Number()Over('+dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC')+')  RowNumber
						into ##CustomerUserAddDetail
						FROM #AccountDetail '+@PaginationWhereClause  +' '+ dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC');

					EXEC (@SQL)
				
					Select @RowCount= isnull(RowsCount  ,0) from #TBL_RowCount

					ALTER TABLE ##CustomerUserAddDetail ADD AddressId Int
					--To get data for DepartmentId
					update CUD SET DepartmentId = i.DepartmentId
					from ##CustomerUserAddDetail cud
					INNER JOIN ZnodeDepartmentUser i ON(i.UserId = cud.UserId)

					--To get data for PermissionsName
					update CUD SET PermissionsName = h.PermissionsName, PermissionCode = h.PermissionCode
					from ##CustomerUserAddDetail cud
					INNER JOIN ZnodeAccountUserPermission f ON(f.UserId = cud.UserId)
					INNER JOIN ZnodeAccountPermissionAccess g ON(g.AccountPermissionAccessId = f.AccountPermissionAccessId)
					INNER JOIN ZnodeAccessPermission h ON(h.AccessPermissionId = g.AccessPermissionId)

					------To get data for DepartmentName
					update CUD SET DepartmentName = j.DepartmentName
					from ##CustomerUserAddDetail cud
					INNER JOIN ZnodeDepartmentUser i ON(i.UserId = cud.UserId)
					INNER JOIN ZnodeDepartment j ON(j.DepartmentId = i.DepartmentId)

					--To get data for AccountPermissionAccessId
					update CUD SET AccountPermissionAccessId = f.AccountPermissionAccessId
					from ##CustomerUserAddDetail cud
					INNER JOIN ZnodeAccountUserPermission f ON(f.UserId = cud.UserId)

					--To get data for AccountPermissionAccessId
					update CUD SET AccountPermissionAccessId = f.AccountPermissionAccessId
					from ##CustomerUserAddDetail cud
					INNER JOIN ZnodeAccountUserPermission f ON(f.UserId = cud.UserId)
	
					--To get data for AccountUserOrderApprovalId
					update CUD SET AccountUserOrderApprovalId = ZAUOA.AccountUserOrderApprovalId
					from ##CustomerUserAddDetail cud
					INNER JOIN ZnodeAccountUserOrderApproval ZAUOA ON cud.UserId = ZAUOA.UserID
	
					--To get data for ApprovalName,ApprovalUserId
					update CUD SET ApprovalName = ISNULL(RTRIM(LTRIM(ZU.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '')
					+CASE
					WHEN ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '') = ''
					THEN ''
					ELSE ' '
					END,
					ApprovalUserId = ZAUOA.ApprovalUserId
					from ##CustomerUserAddDetail cud
					INNER JOIN ZnodeAccountUserOrderApproval ZAUOA ON cud.UserId = ZAUOA.UserID
					INNER JOIN ZnodeUser ZU ON(ZU.UserId = ZAUOA.ApprovalUserId)
	
					----To get data for PortalId
					--update CUD SET PortalId = CASE
					--								WHEN cud.AccountId IS NULL
					--								THEN up.PortalId
					--								ELSE ZPA.PortalId
					--							END 
					--from ##CustomerUserAddDetail cud
					--   LEFT JOIN ZnodeUserPortal up ON(up.UserId = cud.UserId) 
					--LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = cud.AccountId) 
	
					----To get data for CountryName, CityName, StateName, PostalCode, CompanyName
					IF (EXISTS(SELECT * FROM @ColumnName where ([StringColumn] LIKE '%CountryName%' OR [StringColumn] LIKE '%CityName%' OR [StringColumn] LIKE '%StateName%' OR [StringColumn] LIKE '%PostalCode%' OR [StringColumn] LIKE '%CompanyName%'))
					OR (@WhereClauseAll like '%CountryName%' OR @WhereClauseAll like '%CityName%' OR @WhereClauseAll like '%StateName%' OR @WhereClauseAll like '%PostalCode%' OR @WhereClauseAll like '%CompanyName%'))
					BEGIN
			 
						update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
						PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName, a.AddressId = ZA.AddressId
						from ##CustomerUserAddDetail a
						inner join ZnodeAccountAddress ZAA on a.AccountId = ZAA.AccountId
						inner  JOIN ZnodeAddress ZA on ZA.AddressId = ZAA.AddressId
						where isnull(a.AccountId,0)<> 0-- is not null
	 
						update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
						PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName, a.AddressId = ZA.AddressId
						from ##CustomerUserAddDetail a
						inner join ZnodeUserAddress ZUA on a.UserId = ZUA.UserId
						inner  JOIN ZnodeAddress ZA on ZA.AddressId = zua.AddressId
					END

					----Updating SalesRep for user if any 
					update CUAD
					set CUAD.SalesRepUserName = azu.UserName, 
					CUAD.SalesRepFullName = (ISNULL(RTRIM(LTRIM(ZU.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '')
					+CASE
					WHEN ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '') = ''
					THEN ''
					ELSE ' '
					END+ISNULL(RTRIM(LTRIM(ZU.LastName)), '')) 
					from ##CustomerUserAddDetail CUAD
					inner join ZnodeSalesRepCustomerUserPortal SRCUP ON CUAD.UserId = SRCUP.CustomerUserid 
					inner join ZnodeUser ZU ON SRCUP.SalesRepUserId = ZU.UserId
					inner join ASPNetUsers ANU ON(ZU.AspNetuserId = ANU.Id)
					inner join AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = ANU.UserName)

					if ( exists(select * from ##UserList) OR @AddressColumnWhereClause <> '')
					begin
						SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
						EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,
						Isnull(FirstName,'') +  ' ' + ISnull(LastName,'')  FullName,
						AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
						BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode ,CustomerPaymentGUID,StoreName,PortalId,
						CountryName, CityName, StateName, PostalCode, CompanyName, SalesRepUserName, SalesRepFullName, AccountCode
						from ##CustomerUserAddDetail CUAD
						where exists(select * from ##UserList UL where CUAD.UserId = UL.UserId and CUAD.AddressId = UL.AddressID )
						Order by RowNumber
					end
					else
					begin
						SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
						EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,
						Isnull(FirstName,'') +  ' ' + ISnull(LastName,'')  FullName,
						AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
						BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode ,CustomerPaymentGUID,StoreName,PortalId,
						CountryName, CityName, StateName, PostalCode, CompanyName, SalesRepUserName, SalesRepFullName, AccountCode
						from ##CustomerUserAddDetail
						Order by RowNumber
					end
	
					if OBJECT_ID('tempdb..##CustomerUserAddDetail') is not null
					drop table ##CustomerUserAddDetail

					if OBJECT_ID('tempdb..##View_CustomerUserAddDetail') is not null
					drop table ##View_CustomerUserAddDetail
				
				END;
            ELSE
				BEGIN
					SELECT * FROM View_CustomerUserDetail AS VICUD WHERE 1 = 0;
					SET @RowCount = 0;
				END;
            END;			
         END TRY
         BEGIN CATCH
            DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_AdminUsersByUserId @RoleName = '+@RoleName+' ,@UserName='+@UserName+',@WhereClause='+cast(@WhereClause as varchar(max))+' ,@Rows= '+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_By='+@Order_By+',@RowCount='+CAST(@RowCount AS VARCHAR(50));
            EXEC Znode_InsertProcedureErrorLog
            @ProcedureName    = 'Znode_AdminUsersByUserId',
            @ErrorInProcedure = @ERROR_PROCEDURE,
            @ErrorMessage     = @ErrorMessage,
            @ErrorLine        = @ErrorLine,
            @ErrorCall        = @ErrorCall;
         END CATCH;


     END;

GO

update ZnodeApplicationSetting
set Setting='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>PublishProductId</name><headertext>PublishProductId</headertext><width>5</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield>PublishProductId,Quantity,SKU</checkboxparamfield><iscontrol>n</iscontrol><controltype>HiddenField</controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>Image</name><headertext>Image</headertext><width>40</width><datatype>String</datatype><columntype>Single</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield>ImageSmallThumbnailPath,ProductName</imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class>imageicon</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>SKU</name><headertext>SKU</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl>JavaScript:void(0);</islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>sku</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>Name</name><headertext>Product Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>productname</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>SalesPriceWithCurrency</name><headertext>Sales Price</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>RetailPriceWithCurrency</name><headertext>Retail Price</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>Edit</format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/SEO/SEODetails</manageactionurl><manageparamfield>ItemName,ItemId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName='ZnodeOrderProductList'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateQuoteLineItem')
	DROP PROC Znode_InsertUpdateQuoteLineItem

GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateQuoteLineItem]
(   
	@OmsQuoteId      INT ,
    @UserId          INT = 0,
	@OmsSavedCartId  INT = 0,
    @Status          BIT OUT ,
	@SKUPriceForQuote [dbo].[SKUPriceForQuote] ReadOnly
)
AS 
   /* 
    Summary: This Procedure is used to save and edit the quote line item      
    Unit Testing   
    Exec Znode_InsertUpdateQuoteLineItem 1071,1527,0
   
	*/
     BEGIN
         BEGIN TRAN A;
         BEGIN TRY
             SET NOCOUNT ON;
			 DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
			 DECLARE  @OmsQuoteLineItemId INT;
			 DECLARE @TempOmsQuoteLineItem TABLE (OmsQuoteLineItemId INT , OmsSavedCartLineItemId INT , ParentOmsSavedCartLineItemId INT  )
			 DECLARE @OrderLineItemRelationshipTypeIdBundle INT = (SELECT TOP 1 OrderLineItemRelationshipTypeId FROM ZnodeOmsOrderLineItemRelationshipType WHERE Name = 'Bundles')

			CREATE TABLE #ZnodeOmsSavedCartLineItem
			(OmsSavedCartLineItemId	int,
			ParentOmsSavedCartLineItemId	int,
			OmsSavedCartId	int,
			SKU	nvarchar(200),
			Quantity	numeric(28,	13) ,
			OrderLineItemRelationshipTypeId	int,
			CustomText	nvarchar(MAX),
			CartAddOnDetails	nvarchar(MAX),
			Sequence	int,
			CreatedBy	int,
			CreatedDate	datetime,
			ModifiedBy	int,
			ModifiedDate	datetime,
			AutoAddon	nvarchar(MAX),
			OmsOrderId	int,
			Custom1	nvarchar(MAX),
			Custom2	nvarchar(MAX),
			Custom3	nvarchar(MAX),
			Custom4	nvarchar(MAX),
			Custom5	nvarchar(MAX),
			GroupId	nvarchar(MAX),
			ProductName	nvarchar(2000),
			Description	nvarchar(MAX),
			Price numeric(28,6),
			ShippingCost numeric(28,6),
			InitialPrice numeric(28,6),
			InitialShippingCost numeric(28,6),
			IsPriceEdit bit)
			 
			IF (isnull(@OmsSavedCartId,0) <> 0)
			BEGIN
				INSERT INTO #ZnodeOmsSavedCartLineItem(OmsSavedCartLineItemId,ParentOmsSavedCartLineItemId,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId,CustomText,CartAddOnDetails,
				                                       Sequence,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AutoAddon,OmsOrderId,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,Description)
				SELECT a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId,a.OmsSavedCartId,a.SKU,a.Quantity,a.OrderLineItemRelationshipTypeId,a.CustomText,a.CartAddOnDetails,
				       a.Sequence,a.CreatedBy,a.CreatedDate,a.ModifiedBy,a.ModifiedDate,a.AutoAddon,a.OmsOrderId,a.Custom1,a.Custom2,a.Custom3,a.Custom4,a.Custom5,a.GroupId,a.ProductName,a.Description 				
				FROM ZnodeOmsSavedCartLineItem  a 
				WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeOmsQuoteLineItem ty WHERE ty.OmsQuoteId = @OmsQuoteId) and a.OmsSavedCartId=@OmsSavedCartId
				
			END
			ELSE
			BEGIN
				INSERT INTO #ZnodeOmsSavedCartLineItem(OmsSavedCartLineItemId,ParentOmsSavedCartLineItemId,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId,CustomText,CartAddOnDetails,
				                                       Sequence,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AutoAddon,OmsOrderId,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,Description)
				SELECT a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId,a.OmsSavedCartId,a.SKU,a.Quantity,a.OrderLineItemRelationshipTypeId,a.CustomText,a.CartAddOnDetails,
				       a.Sequence,a.CreatedBy,a.CreatedDate,a.ModifiedBy,a.ModifiedDate,a.AutoAddon,a.OmsOrderId,a.Custom1,a.Custom2,a.Custom3,a.Custom4,a.Custom5,a.GroupId,a.ProductName,a.Description 
				FROM ZnodeOmsSavedCartLineItem  a 
				INNER JOIN ZnodeOmsSavedCart b ON (b.OmsSavedCartId = a.OmsSavedCartId)
				INNER JOIN ZnodeOmsCookieMapping c ON (c.OmsCookieMappingId = b.OmsCookieMappingId)
				WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeOmsQuoteLineItem ty WHERE ty.OmsQuoteId = @OmsQuoteId) 
				AND c.UserId = @UserId
			END

			UPDATE ZOSLI set ZOSLI.Price = SPQ.Price, ZOSLI.ShippingCost = SPQ.ShippingCost, ZOSLI.InitialPrice = SPQ.InitialPrice,
			ZOSLI.InitialShippingCost = SPQ.InitialShippingCost, ZOSLI.IsPriceEdit = SPQ.IsPriceEdit
			FROM #ZnodeOmsSavedCartLineItem ZOSLI
			INNER JOIN @SKUPriceForQuote SPQ ON ZOSLI.OmsSavedCartLineItemId = SPQ.OmsSavedCartLineItemId

			--To update price and ShippingCost for child entries of bundle product
			UPDATE ZOSLI set ZOSLI.Price = SPQ.Price, ZOSLI.ShippingCost = SPQ.ShippingCost, ZOSLI.InitialPrice = SPQ.InitialPrice,
			ZOSLI.InitialShippingCost = SPQ.InitialShippingCost, ZOSLI.IsPriceEdit= SPQ.IsPriceEdit
			FROM #ZnodeOmsSavedCartLineItem ZOSLI
			INNER JOIN @SKUPriceForQuote SPQ ON ZOSLI.ParentOmsSavedCartLineItemId = SPQ.OmsSavedCartLineItemId
			WHERE ZOSLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle


			IF OBJECT_ID('Tempdb..#desupdate1') IS NOT NULL  
			DROP TABLE Tempdb..#desupdate1 
			select ZnodeProductId,des into #desupdate1 from (
									   SELECT  ZnodeProductId, CONCAT('Qty: ',cast(cast(AssociatedProductBundleQuantity as int) as varchar(5)),'| ',sku,' - ', productname, char(10) ) des  FROM ZnodePublishBundleProductEntity  ZPBPE1
											inner join ZnodePublishProductDetail ZPP  on  ZPBPE1.AssociatedZnodeProductId = ZPP.PublishProductId
											)asd group by ZnodeProductId, des


			IF OBJECT_ID('Tempdb..#desupdate') IS NOT NULL  
			DROP TABLE Tempdb..#desupdate 

			select ZPBPE.des, asd.* into #desupdate from (
				select VLMP.PimProductId PPI , ZOSCL.* from #ZnodeOmsSavedCartLineItem ZOSCL 
							inner join [dbo].[View_LoadManageProduct] VLMP on VLMP.AttributeCode ='SKU' and VLMP.AttributeValue= ZOSCL.sku
							inner join (select * from ZnodepimAttributevalue where PimAttributeId = 10 and  PimAttributeValueId in (
											select PimAttributeValueId from ZnodePimProductAttributeDefaultValue where PimAttributeDefaultValueId in (
											select PimAttributeDefaultValueId from ZnodePimAttributeDefaultValue where AttributeDefaultValueCode = 'BundleProduct' ))) BP
												on BP.PimProductId =  VLMP.PimProductId ) asd
						cross apply
						 (
						SELECT   *
						FROM    (SELECT ZnodeProductId, '<p><span style="font-family: Arial, Helvetica, sans-serif; font-size: 10px;">' +
							(SELECT  des +' </br> '  
											FROM #desupdate1 AS p 
											WHERE p.ZnodeProductId = a.ZnodeProductId
											FOR XML PATH(''))
							
						+ '</span></p>' AS des
									FROM #desupdate1 a
									GROUP BY ZnodeProductId)  ZPBPE1
						inner join ZnodePublishProduct ZPP on  ZPBPE1.ZnodeProductId = ZPP.PublishProductId

						WHERE   Zpp.PimProductId = asd.PPI
      
						) 
				   ZPBPE

			UPDATE ZOSLI set ZOSLI.Description = SPQ.des
			FROM #ZnodeOmsSavedCartLineItem ZOSLI
			INNER JOIN #desupdate SPQ ON ZOSLI.OmsSavedCartLineItemId = SPQ.OmsSavedCartLineItemId or ZOSLI.ParentOmsSavedCartLineItemId = SPQ.OmsSavedCartLineItemId


			
			MERGE INTO ZnodeOmsQuoteLineItem TARGET 
			USING #ZnodeOmsSavedCartLineItem  SOURCE 
			ON (1=0 )
			WHEN NOT MATCHED THEN 
			INSERT   (ParentOmsQuoteLineItemId,OmsQuoteId,SKU,Quantity,OrderLineItemRelationshipTypeId
						,CustomText,CartAddOnDetails,Sequence,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,GroupId,ProductName,Description, Price, ShippingCost,
						InitialPrice, InitialShippingCost, IsPriceEdit)
			 
			VALUES ( NULL,@OmsQuoteId,SOURCE.SKU,SOURCE.Quantity,SOURCE.OrderLineItemRelationshipTypeId
						,SOURCE.CustomText,SOURCE.CartAddOnDetails,SOURCE.Sequence,SOURCE.CreatedBy,SOURCE.CreatedDate,SOURCE.ModifiedBy,SOURCE.ModifiedDate,SOURCE.GroupId,SOURCE.ProductName,SOURCE.Description, SOURCE.Price, SOURCE.ShippingCost,
						SOURCE.InitialPrice, SOURCE.InitialShippingCost, SOURCE.IsPriceEdit ) 
			
			OUTPUT Inserted.OmsQuoteLineItemId , SOURCE.OmsSavedCartLineItemId,Source.ParentOmsSavedCartLineItemId  INTO @TempOmsQuoteLineItem ;


			UPDATE a
			SET a.ParentOmsQuoteLineItemId =( SELECT TOP 1 b1.OmsQuoteLineItemId FROM  @TempOmsQuoteLineItem b1 WHERE b.ParentOmsSavedCartLineItemId  = b1.OmsSavedCartLineItemId)  
			FROM ZnodeOmsQuoteLineItem  a 
			INNER JOIN @TempOmsQuoteLineItem b ON (b.OmsQuoteLineItemId = a.OmsQuoteLineItemId)
			WHERE b.ParentOmsSavedCartLineItemId IS NOT NULL 



			INSERT INTO ZnodeOmsQuotePersonalizeItem (OmsQuoteLineItemId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
														,DesignId,ThumbnailURL)
			SELECT b.OmsQuoteLineItemId,PersonalizeCode,PersonalizeValue,a.CreatedBy,a.CreatedDate,a.ModifiedBy,a.ModifiedDate
														,DesignId,ThumbnailURL
			FROM ZnodeOmsPersonalizeCartItem a  
			INNER JOIN @TempOmsQuoteLineItem b ON (b.OmsSavedCartLineItemId =  a.OmsSavedCartLineItemId )         


             SET @Status = 1;
             COMMIT TRAN A;
         END TRY
         BEGIN CATCH
        
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertUpdateQuoteLineItem @CartLineItemXML = '+CAST('' AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
			 ROLLBACK TRAN A;
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_InsertUpdateQuoteLineItem',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodeOmsFailedOrderPayments')
BEGIN
	CREATE TABLE [dbo].[ZnodeOmsFailedOrderPayments](
		[OmsFailedOrderPaymentId] [int] IDENTITY(1,1) NOT NULL,
		[PaymentCode] [nvarchar](200) NOT NULL,
		[PaymentDisplayName] [nvarchar](1200) NULL,
		[TransactionToken] [nvarchar](300) NOT NULL,
		[TotalAmount] [decimal](28, 6) NOT NULL,
		[UserName] [nvarchar](256) NULL,
		[UserId] [int] NOT NULL,
		[Email] [nvarchar](100) NULL,
		[PaymentSettingId] [int] NOT NULL,
		[OrderNumber] [nvarchar](200) NOT NULL,
		[OrderDate] [datetime] NOT NULL,
		[PaymentStatusId] [int] NOT NULL,
		[CreatedBy] [int] NOT NULL,
		[CreatedDate] [datetime] NOT NULL,
		[ModifiedBy] [int] NOT NULL,
		[ModifiedDate] [datetime] NOT NULL,
	 CONSTRAINT [PK_ZnodeOmsFailedOrderPayments] PRIMARY KEY CLUSTERED 
	(
		[OmsFailedOrderPaymentId] ASC
	)
	)
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_OmsFailedOrderPaymentsList')
	DROP PROC Znode_OmsFailedOrderPaymentsList

GO

CREATE PROCEDURE [dbo].[Znode_OmsFailedOrderPaymentsList]
( 
	@WhereClause NVARCHAR(MAX),
	@Rows        INT            = 100,
	@PageNo      INT            = 1,
	@Order_BY    VARCHAR(1000)  = '',
	@RowsCount   INT OUT			
 )
AS
/*
	Summary : This procedure is used to get the oms failed order payment details

	Unit Testing:

	EXEC [Znode_OmsFailedOrderPaymentsList] 'PortalId =1',@Order_BY = '',@RowsCount= 0, @UserId = 0 ,@Rows = 50, @PageNo = 1

	declare @p7 int
	set @p7=4
	exec sp_executesql N'Znode_OmsFailedOrderPaymentsList @WhereClause, @Rows,@PageNo,@Order_By,@RowCount OUT',N'@WhereClause nvarchar(30),
		@Rows int,@PageNo int,@Order_By nvarchar(14),@RowCount int output',@WhereClause=N'',@Rows=50,@PageNo=1,@Order_By=N'orderdate desc',
		@RowCount=@p7 output
	select @p7
*/
BEGIN
    BEGIN TRY
	SET NOCOUNT ON;
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
		DECLARE @SQL NVARCHAR(MAX)

		DECLARE @Fn_GetPaginationWhereClause VARCHAR(500) = dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows),
			@Fn_GetFilterWhereClause NVARCHAR(MAX) = ''
		SET @Fn_GetFilterWhereClause=dbo.Fn_GetFilterWhereClause(@WhereClause)
			
		IF @Order_BY = ''
			SET @Order_BY = 'OrderDate desc'

			SET @Order_BY = REPLACE(@Order_BY,'PaymentName','ZOFOP.PaymentDisplayName')
			SET @Order_BY = REPLACE(@Order_BY,'CustomerName','ZOFOP.UserName')
			SET @Order_BY = REPLACE(@Order_BY,'EmailAddress','ZOFOP.Email')
			SET @Order_BY = REPLACE(@Order_BY,'PaymentStatus','ZOPS.Name')

			DECLARE @Fn_GetPagingRowId NVARCHAR(MAX) = ' DENSE_RANK()Over('+ ' Order By '+CASE WHEN ISNULL(@Order_BY,'') = '' THEN 'OmsFailedOrderPaymentId DESC' ELSE @Order_BY + ',OmsFailedOrderPaymentId DESC' END  + ') RowId '
						
			IF OBJECT_ID('tempdb..#TBL_RowCount') IS NOT NULL
				DROP TABLE #TBL_RowCount
			
			CREATE TABLE #TBL_RowCount(RowsCount INT)
			 
			SET @Fn_GetFilterWhereClause = REPLACE(@Fn_GetFilterWhereClause,'PaymentName','ZOFOP.PaymentDisplayName')
			SET @Fn_GetFilterWhereClause = REPLACE(@Fn_GetFilterWhereClause,'CustomerName','ZOFOP.UserName')
			SET @Fn_GetFilterWhereClause = REPLACE(@Fn_GetFilterWhereClause,'EmailAddress','ZOFOP.Email')
			SET @Fn_GetFilterWhereClause = REPLACE(@Fn_GetFilterWhereClause,'PaymentStatus','ZOPS.Name')

			SET @Fn_GetPagingRowId = REPLACE(@Fn_GetPagingRowId,'OmsFailedOrderPaymentId','OmsFailedOrderPaymentId')

			SET @Rows = @PageNo * @Rows

		SET @SQL = '
		SELECT DISTINCT TOP '+CAST(@Rows as VARCHAR(10))+' ZOFOP.OrderNumber,ZOFOP.TotalAmount,ZOFOP.OrderDate,
			ZOFOP.PaymentDisplayName As PaymentName,ZOFOP.PaymentStatusId,ZOPS.Name PaymentStatus,
			ZOFOP.TransactionToken,ZOFOP.UserName As CustomerName,ZOFOP.Email As EmailAddress, '+@Fn_GetPagingRowId+' ,
			ZOFOP.OmsFailedOrderPaymentId
		INTO #Cte_OrderLineDescribe
		FROM ZnodeOmsFailedOrderPayments ZOFOP WITH (NOLOCK)
		LEFT JOIN ZnodeOmsPaymentState ZOPS WITH (NOLOCK) ON (ZOPS.OmsPaymentStateId = ZOFOP.PaymentStatusId)
		WHERE 1=1 '+ @Fn_GetFilterWhereClause+' 
		ORDER BY '+CASE WHEN ISNULL(@Order_BY,'') = '' THEN 'ZOFOP.OmsFailedOrderPaymentId DESC' ELSE @Order_BY + ',ZOFOP.OmsFailedOrderPaymentId DESC' END +' 

		INSERT INTO #TBL_RowCount
		SELECT COUNT(*)
		FROM ZnodeOmsFailedOrderPayments ZOFOP WITH (NOLOCK)
		LEFT JOIN ZnodeOmsPaymentState ZOPS WITH (NOLOCK) ON (ZOPS.OmsPaymentStateId = ZOFOP.PaymentStatusId)
		WHERE 1=1 '+ @Fn_GetFilterWhereClause+' 
			
		Create index Ind_OrderLineDescribe_RowId on #Cte_OrderLineDescribe(RowId )

		SELECT OrderNumber,TotalAmount,OrderDate,PaymentName AS PaymentDisplayName,PaymentStatusId,PaymentStatus,TransactionToken
			,CustomerName AS UserName,EmailAddress AS Email
		FROM #Cte_OrderLineDescribe
		' + @Fn_GetPaginationWhereClause +' order by RowId '

		PRINT @SQL
		EXEC(@SQL)
		Select @RowsCount= isnull(RowsCount  ,0) from #TBL_RowCount
		
		IF OBJECT_ID('tempdb..#TBL_RowCount') is not null
				DROP TABLE #TBL_RowCount
		
    END TRY
    BEGIN CATCH
DECLARE @Status BIT ;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_OmsFailedOrderPaymentsList @WhereClause = '''+ISNULL(CAST(@WhereClause AS VARCHAR(max)),'''''')+''',@Rows='''+ISNULL(CAST(@Rows AS VARCHAR(50)),'''''')+''',@PageNo='+ISNULL(CAST(@PageNo AS VARCHAR(50)),'''')+',
		@Order_BY='+ISNULL(@Order_BY,'''''')+',@RowsCount='+ISNULL(CAST(@RowsCount AS VARCHAR(50)),'''')+',''';
              			 
        SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
        EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_OmsFailedOrderPaymentsList',
		@ErrorInProcedure = 'Znode_OmsFailedOrderPaymentsList',
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
    END CATCH;
END;

GO

INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'Customer','FailedOrderTransactionList',1,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'Customer' and ActionName = 'FailedOrderTransactionList')

INSERT INTO ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
SELECT
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Users' AND ControllerName = 'Customer')
,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Customer' and ActionName = 'FailedOrderTransactionList') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId =
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Users' AND ControllerName = 'Customer') and ActionId =
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Customer' and ActionName = 'FailedOrderTransactionList'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
SELECT
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Users' AND ControllerName = 'Customer'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Customer' and ActionName = 'FailedOrderTransactionList')
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId =
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Users' AND ControllerName = 'Customer') and ActionId =
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Customer' and ActionName = 'FailedOrderTransactionList'))

GO

Update ZnodeApplicationSetting set Setting='<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>MediaId</name>      <headertext>Checkbox</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>MediaId</islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>MediaId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>Image</name>      <headertext>Media</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>Edit</format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>MediaId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Edit</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>Path,FileName</imageparamfield>      <manageactionurl>/MediaManager/MediaManager/GetMediaAttributeValues</manageactionurl>      <manageparamfield>MediaId</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>imageicon</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>FileName</name>      <headertext>File Name</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>100</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>y</isallowlink>      <islinkactionurl>/MediaManager/MediaManager/GetMediaAttributeValues</islinkactionurl>      <islinkparamfield>MediaId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>MediaId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>filename</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>y</allowdetailview>    </column>    <column>      <id>4</id>      <name>MediaType</name>      <headertext>File Type</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>MediaId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>MediaId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>Size</name>      <headertext>Size</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>MediaId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>MediaId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>Height</name>      <headertext>Height</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>MediaId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>MediaId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>Width</name>      <headertext>Width</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>MediaId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>MediaId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>MediaType</name>      <headertext>Type</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>MediaId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>MediaId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>9</id>      <name>Folder</name>      <headertext>Folder</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>MediaId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>MediaId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>10</id>      <name>Path</name>      <headertext>Path</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>Path</imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>imageicon</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>11</id>      <name>DisplayName</name>      <headertext>Display Name</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>Path</imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>12</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>Edit|Delete</format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>MediaId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Edit|Delete</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/MediaManager/MediaManager/GetMediaAttributeValues|/MediaManager/MediaManager/DeleteMedia</manageactionurl>      <manageparamfield>MediaId|MediaId</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>inline</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>' 
where ItemName = 'View_GetMediaPathDetail'

insert into ZnodeApplicationSetting (GroupName,	ItemName,	Setting,	ViewOptions,	FrontPageName,	FrontObjectName,	IsCompressed,	OrderByFields,	ItemNameWithoutCurrency,	CreatedByName,	ModifiedByName,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
select 'Table','ZnodeOmsFailedOrderPayments','<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>OrderNumber</name>      <headertext>Order/Invoice Number</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>y</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>TotalAmount</name>      <headertext>Order Total</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>Decimal</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>OrderDate</name>      <headertext>Order/Transaction Date</headertext>      <width>0</width>      <datatype>DateTime</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>PaymentDisplayName</name>      <headertext>Payment Name</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>PaymentStatus</name>      <headertext>Payment Status</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>TransactionToken</name>      <headertext>Transaction ID</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>UserName</name>      <headertext>Customer Name</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>Email</name>      <headertext>Email Address</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>','ZnodeOmsFailedOrderPayments','ZnodeOmsFailedOrderPayments','ZnodeOmsFailedOrderPayments',0,'OrderDateWithTime|DESC',null,null,null,2,GETDATE(),2,getdate()
where not exists(select * from ZnodeApplicationSetting where GroupName = 'Table' and ItemName = 'ZnodeOmsFailedOrderPayments')

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'ZnodeReport_DashboardOrders')
	DROP PROC ZnodeReport_DashboardOrders

GO

CREATE PROCEDURE [dbo].[ZnodeReport_DashboardOrders]              
(            
	@PortalId  bigint  = null,        
	@AccountId bigint  = null  ,    
	@SalesRepUserId int = 0              
)              
AS              
/*              
Summary:- This procedure is used to get the order details              
Unit Testing:              
EXEC [ZnodeReport_DashboardOrders]              
*/              
BEGIN              
BEGIN TRY              
SET NOCOUNT ON;              
	DECLARE @TopItem TABLE (ItemName nvarchar(100),CustomerName nvarchar(100),ItemId nvarchar(10), Total numeric(28,6) , Date datetime,Symbol NVARCHAR(10))              
           
                 
	DECLARE @RoundOffValue INT= dbo.Fn_GetDefaultValue('PriceRoundOff')          
   
	----Verifying that the @SalesRepUserId is having 'Sales Rep' role
	IF NOT EXISTS
	(
		SELECT * FROM ZnodeUser ZU
		INNER JOIN AspNetZnodeUser ANZU ON ZU.UserName = ANZU.UserName
		INNER JOIN AspNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName
		INNER JOIN AspNetUserRoles ANUR ON ANU.Id = ANUR.UserId
		Where Exists(select * from AspNetRoles ANR Where Name = 'Sales Rep' AND ANUR.RoleId = ANR.Id)
		AND ZU.UserId = @SalesRepUserId
	)  
	Begin
		SET @SalesRepUserId = 0
	End    
             
	DECLARE @TBL_CultureCurrency TaBLE (Symbol Varchar(100),CurrencyCode varchar(100))              
	INSERT INTO @TBL_CultureCurrency (Symbol,CurrencyCode)              
	SELECT Symbol,CultureCode FROM  ZnodeCulture ZC              
	DECLARE @PortalCurrencySymbol nvarchar(20)          
	DECLARE @DefaultCurrencySymbol nvarchar(20)            
           
	SET @PortalCurrencySymbol = [dbo].[Fn_GetPortalCurrencySymbol](CAST(@PortalID AS INTEGER) )          
	SET @DefaultCurrencySymbol = [dbo].[Fn_GetDefaultCurrencySymbol]()          
         
	IF @PortalCurrencySymbol IS NULL          
	UPDATE @TBL_CultureCurrency SET Symbol  =@DefaultCurrencySymbol WHERE  Symbol IS NULL          
	ELSE          
	UPDATE @TBL_CultureCurrency SET Symbol  =@PortalCurrencySymbol WHERE  Symbol IS NULL          
   
	IF @AccountId = -1
	Begin
		INSERT INTO @TopItem(ItemId, ItemName,CustomerName,Date,Total,Symbol)          
		SELECT Zoo.OmsOrderId,Zoo.OrderNumber,ISNULL(RTRIM(LTRIM(ZODD.FirstName)),'')          
		+' '+ISNULL(RTRIM(LTRIM(ZODD.LastName)),'') UserName ,ZODD.OrderDate,round(ZODD.Total,@RoundOffValue),        
		COALESCE (ZC.Symbol,[dbo].[Fn_GetPortalCurrencySymbol](CAST(@PortalId AS INTEGER)),[dbo].[Fn_GetDefaultCurrencySymbol]())          
		FROM ZnodeOmsOrder (nolock) ZOO          
		INNER JOIN ZnodeOmsOrderDetails (nolock) ZODD ON (ZODD.OmsOrderId = ZOO.OmsOrderId AND  ZODD.IsActive = 1)          
		INNER JOIN ZnodePortal (nolock) ZP ON (ZP.PortalId = ZODD.portalId )          
		INNER JOIN ZnodePublishState ZODPS ON (ZODPS.PublishStateId = ZOO.PublishStateId)          
		LEFT JOIN ZnodePaymentType (nolock) ZPS ON (ZPS.PaymentTypeId = ZODD.PaymentTypeId )          
		LEFT JOIN  ZnodeOmsOrderStateShowToCustomer (nolock) ZOSC ON (ZOSC.OmsOrderStateId = ZODD.OmsOrderStateId)          
		LEFT JOIN ZnodeOmsOrderState (nolock) ZOS ON (ZOS.OmsOrderStateId = ZODD.OmsOrderStateId)          
		LEFT JOIN ZnodeOmsPaymentState (nolock) ZOPS ON (ZOPS.OmsPaymentStateId = ZODD.OmsPaymentStateId)          
		LEft JOIN ZnodeUser ZU ON (ZU.UserId = ZODD.UserId)          
		LEFT JOIN [dbo].[View_GetUserDetails]  (nolock) ZVGD ON (ZVGD.UserId = ZODD.CreatedBy )          
		LEFT JOIN [dbo].[View_GetUserDetails]  (nolock) ZVGDI ON (ZVGDI.UserId = ZODD.ModifiedBy)          
		LEFT JOIN ZnodeShipping ZS ON (ZS.ShippingId = ZODD.ShippingId)          
		LEFT OUTER JOIN ZnodePaymentSetting (nolock) ZPSS ON (ZPSS.PaymentSettingId = ZODD.PaymentSettingId)          
		LEFT JOIN ZnodePortalPaymentSetting (nolock) ZPPS ON (ZPPS.PaymentSettingId = ZPSS.PaymentSettingId  AND ZPPS.PortalId = ZODD.PortalId   )          
		LEFT JOIN @TBL_CultureCurrency ZC ON (ZC.CurrencyCode = ZODD.CultureCode )        
		WHERE (ZP.PortalId = @PortalId OR  ISNULL(@PortalId,0) = 0)        
		and (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = @SalesRepUserId and ZU.UserId = SalRep.CustomerUserid) or @SalesRepUserId = 0)      
		and not Exists(Select * from ZnodeAccount ZA Where isnull(ZU.AccountId,0) = ZA.AccountId)
	End
	Else
	Begin
		INSERT INTO @TopItem(ItemId, ItemName,CustomerName,Date,Total,Symbol)          
		SELECT Zoo.OmsOrderId,Zoo.OrderNumber,ISNULL(RTRIM(LTRIM(ZODD.FirstName)),'')          
		+' '+ISNULL(RTRIM(LTRIM(ZODD.LastName)),'') UserName ,ZODD.OrderDate,round(ZODD.Total,@RoundOffValue),        
		COALESCE (ZC.Symbol,[dbo].[Fn_GetPortalCurrencySymbol](CAST(@PortalId AS INTEGER)),[dbo].[Fn_GetDefaultCurrencySymbol]())          
		FROM ZnodeOmsOrder (nolock) ZOO          
		INNER JOIN ZnodeOmsOrderDetails (nolock) ZODD ON (ZODD.OmsOrderId = ZOO.OmsOrderId AND  ZODD.IsActive = 1)          
		INNER JOIN ZnodePortal (nolock) ZP ON (ZP.PortalId = ZODD.portalId )          
		INNER JOIN ZnodePublishState ZODPS ON (ZODPS.PublishStateId = ZOO.PublishStateId)          
		LEFT JOIN ZnodePaymentType (nolock) ZPS ON (ZPS.PaymentTypeId = ZODD.PaymentTypeId )          
		LEFT JOIN  ZnodeOmsOrderStateShowToCustomer (nolock) ZOSC ON (ZOSC.OmsOrderStateId = ZODD.OmsOrderStateId)          
		LEFT JOIN ZnodeOmsOrderState (nolock) ZOS ON (ZOS.OmsOrderStateId = ZODD.OmsOrderStateId)          
		LEFT JOIN ZnodeOmsPaymentState (nolock) ZOPS ON (ZOPS.OmsPaymentStateId = ZODD.OmsPaymentStateId)          
		LEFT JOIN ZnodeUser ZU ON (ZU.UserId = ZODD.UserId)          
		LEFT JOIN [dbo].[View_GetUserDetails]  (nolock) ZVGD ON (ZVGD.UserId = ZODD.CreatedBy )          
		LEFT JOIN [dbo].[View_GetUserDetails]  (nolock) ZVGDI ON (ZVGDI.UserId = ZODD.ModifiedBy)          
		LEFT JOIN ZnodeShipping ZS ON (ZS.ShippingId = ZODD.ShippingId)          
		LEFT OUTER JOIN ZnodePaymentSetting (nolock) ZPSS ON (ZPSS.PaymentSettingId = ZODD.PaymentSettingId)          
		LEFT JOIN ZnodePortalPaymentSetting (nolock) ZPPS ON (ZPPS.PaymentSettingId = ZPSS.PaymentSettingId  AND ZPPS.PortalId = ZODD.PortalId   )          
		LEFT JOIN @TBL_CultureCurrency ZC ON (ZC.CurrencyCode = ZODD.CultureCode )        
		WHERE (ZP.PortalId = @PortalId OR  ISNULL(@PortalId,0) = 0) AND (ZU.AccountId = @AccountId OR  ISNULL(@AccountId,0) = 0)        
		and (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = @SalesRepUserId and ZU.UserId = SalRep.CustomerUserid) or @SalesRepUserId = 0)      
	End

	SELECT TOP 5 ItemId, ItemName,CustomerName,Date,Total,Symbol FROM @TopItem Order by  Convert(datetime,Date )  desc                
   
END TRY              
             
BEGIN CATCH              
	DECLARE @Status BIT ;        
	SET @Status = 0;              
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),              
	@ErrorCall NVARCHAR(MAX)= 'EXEC ZnodeReport_DashboardOrders @PortalId = '+@PortalId;            
                               
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                                  
                 
	EXEC Znode_InsertProcedureErrorLog              
	@ProcedureName = 'ZnodeReport_DashboardOrders',              
	@ErrorInProcedure = @Error_procedure,              
	@ErrorMessage = @ErrorMessage,              
	@ErrorLine = @ErrorLine,              
	@ErrorCall = @ErrorCall;              
END CATCH              
             
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'ZnodeReport_DashboardQuotes')
	DROP PROC ZnodeReport_DashboardQuotes

GO

CREATE PROCEDURE [dbo].[ZnodeReport_DashboardQuotes]              
(             
	@PortalId  bigint  = null,        
	@AccountId bigint  = null,    
	@SalesRepUserId int = 0                
)              
AS               
/*              
     Summary:- This procedure is used to get the order details               
    Unit Testing:              
     EXEC [ZnodeReport_DashboardTopCategory]              
*/              
BEGIN              
BEGIN TRY              
SET NOCOUNT ON;              
	
	DECLARE @TopItem TABLE (ItemName nvarchar(100),CustomerName nvarchar(100),ItemId nvarchar(10), Total numeric(28,6) , Date datetime,Symbol NVARCHAR(10))               
     
	DECLARE @RoundOffValue INT= dbo.Fn_GetDefaultValue('PriceRoundOff')      
        
	----Verifying that the @SalesRepUserId is having 'Sales Rep' role
	IF NOT EXISTS
	(
		SELECT * FROM ZnodeUser ZU
		INNER JOIN AspNetZnodeUser ANZU ON ZU.UserName = ANZU.UserName
		INNER JOIN AspNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName
		INNER JOIN AspNetUserRoles ANUR ON ANU.Id = ANUR.UserId
		Where Exists(select * from AspNetRoles ANR Where Name = 'Sales Rep' AND ANUR.RoleId = ANR.Id) 
		AND ZU.UserId = @SalesRepUserId
	)   
	Begin
		SET @SalesRepUserId = 0
	End              
  
	DECLARE @TBL_CultureCurrency TaBLE (Symbol Varchar(100),CurrencyCode varchar(100))              
	INSERT INTO @TBL_CultureCurrency (Symbol,CurrencyCode)              
	SELECT Symbol,CultureCode FROM  ZnodeCulture ZC               
	DECLARE @PortalCurrencySymbol nvarchar(20)          
	DECLARE @DefaultCurrencySymbol nvarchar(20)            
            
	SET @PortalCurrencySymbol = [dbo].[Fn_GetPortalCurrencySymbol](CAST(@PortalID AS INTEGER) )          
	SET @DefaultCurrencySymbol = [dbo].[Fn_GetDefaultCurrencySymbol]()           
          
	IF @PortalCurrencySymbol IS NULL           
	UPDATE @TBL_CultureCurrency SET Symbol  =@DefaultCurrencySymbol WHERE  Symbol IS NULL          
	ELSE           
	UPDATE @TBL_CultureCurrency SET Symbol  =@PortalCurrencySymbol WHERE  Symbol IS NULL          
     
	CREATE TABLE #User(UserId INT, FirstName varchar(100), MiddleName varchar(100), LastName varchar(100), Email varchar(50), PhoneNumber varchar(50))

	IF @AccountId = -1
		INSERT INTO #User(UserId, FirstName, MiddleName, LastName, Email , PhoneNumber )
		SELECT ZU.UserId, ZU.FirstName, ZU.MiddleName, ZU.LastName, ZU.Email , ZU.PhoneNumber                    
		FROM ZnodeUser ZU           
		WHERE EXISTS(SELECT * FROM ZnodeOmsQuote ZOQ where ZU.UserId = ZOQ.UserID )        
		and ISNULL(ZU.AccountId,0) = 0      
	Else
		INSERT INTO #User(UserId, FirstName, MiddleName, LastName, Email , PhoneNumber )
		SELECT ZU.UserId, ZU.FirstName, ZU.MiddleName, ZU.LastName, ZU.Email , ZU.PhoneNumber          
		FROM ZnodeUser ZU           
		WHERE EXISTS(SELECT * FROM ZnodeOmsQuote ZOQ where ZU.UserId = ZOQ.UserID )        
		and (ZU.AccountId = @AccountId or isnull(@AccountId,0) = 0 ) 
          
	Update ZOQ set OmsOrderStateId = (select top 1 OmsOrderStateId from ZnodeOMSOrderState where OrderStateName = 'EXPIRED')          
	from ZnodeOmsQuote ZOQ          
	Inner Join ZnodeOmsQuoteType ZOQT ON ZOQ.OmsQuoteTypeId = ZOQT.OmsQuoteTypeId          
	INNER JOIN #User U ON ZOQ.UserId = U.UserId           
	INNER JOIN ZnodePortal ZP ON ZOQ.PortalID = ZP.PortalID          
	INNER JOIN ZnodeOMSOrderState ZOOS ON ZOOS.OmsOrderStateId = ZOQ.OmsOrderStateId          
	where  (ZOQ.PortalID = @PortalId OR @PortalId = 0 OR @PortalId is null)          
	and cast(ZOQ.QuoteExpirationDate as date) < cast(GETDATE() as date)          
	and ZOQ.OmsOrderStateId <> (select top 1 OmsOrderStateId from ZnodeOMSOrderState where OrderStateName = 'EXPIRED')          
          
	insert into @TopItem(ItemId, ItemName,CustomerName,Date,Total,Symbol)          
	Select ZOQ.OmsQuoteId,ZOQ.QuoteNumber as QuoteNumber,isnull(U.FirstName,'')+case when U.MiddleName is not null then ' ' else '' end+ isnull(U.MiddleName,'')+' '+isnull(U.LastName,'') as CustomerName,          
	ZOQ.CreatedDate as QuoteDate,round(ZOQ.QuoteOrderTotal,@RoundOffValue) as TotalAmount        
	,COALESCE (ZC.Symbol,[dbo].[Fn_GetPortalCurrencySymbol](CAST(@PortalId AS INTEGER)),[dbo].[Fn_GetDefaultCurrencySymbol]()) Symbol              
	from ZnodeOmsQuote ZOQ          
	Inner Join ZnodeOmsQuoteType ZOQT ON ZOQ.OmsQuoteTypeId = ZOQT.OmsQuoteTypeId          
	INNER JOIN #User U ON ZOQ.UserId = U.UserId           
	INNER JOIN ZnodePortal ZP ON ZOQ.PortalID = ZP.PortalID          
	INNER JOIN ZnodeOMSOrderState ZOOS ON ZOOS.OmsOrderStateId = ZOQ.OmsOrderStateId          
	LEFT JOIN @TBL_CultureCurrency ZC ON (ZC.CurrencyCode = ZOQ.CultureCode )           
	where  (ZOQ.PortalID = @PortalId OR @PortalId = 0 OR @PortalId is null)          
	and (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = @SalesRepUserId and U.UserId = SalRep.CustomerUserid) or @SalesRepUserId = 0)              
	and ZOQT.QuoteTypeCode = 'QUOTE'
	
	SELECT TOP 5 ItemId, ItemName,CustomerName,Date,Total,Symbol FROM @TopItem Order by  Convert(datetime,Date )  desc                
   
END TRY              
              
BEGIN CATCH              
	DECLARE @Status BIT ;              
		SET @Status = 0;              
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),              
	@ErrorCall NVARCHAR(MAX)= 'EXEC ZnodeReport_DashboardQuotes @PortalId = '+@PortalId;             
                                
				SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                                  
                  
				EXEC Znode_InsertProcedureErrorLog              
	@ProcedureName = 'ZnodeReport_DashboardQuotes',              
	@ErrorInProcedure = @Error_procedure,              
	@ErrorMessage = @ErrorMessage,              
	@ErrorLine = @ErrorLine,              
	@ErrorCall = @ErrorCall;              
END CATCH              
              
END;

GO

Update ZnodeApplicationSetting
Set Setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>ShippingId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>ShippingTypeName</name><headertext>Shipping Type</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>ShippingCode</name><headertext>Shipping Code</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>ShippingName</name><headertext>Shipping Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>Description</name><headertext>Display Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>DisplayOrder</name><headertext>Display Order</headertext><width>30</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>3</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>y</iscontrol><controltype>Text</controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>DestinationCountryCode</name><headertext>Country Code</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>HandlingCharge</name><headertext>Handling Charge</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>IsActive</name><headertext>Enable</headertext><width>40</width><datatype>Boolean</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>9</id><name>ZipCode</name><headertext>Zip Code</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>10</id><name>PublishState</name><headertext>Application Type</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>y</iscontrol><controltype>DropDown</controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>11</id><name>Manage</name><headertext>Action</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>Edit|Delete</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>PortalId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/Profiles/UpdateProfileShipping|/Profiles/UnAssociateAssociatedShipping</manageactionurl><manageparamfield>shippingId,profileId|shippingId,profileId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>12</id><name>ProfileName</name><headertext>Profile Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>13</id><name>ShippingId</name><headertext>ShippingId</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName = 'ZnodeAssociatedShippingListToProfile'

GO

Update ZnodeApplicationSetting
Set Setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>ShippingId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>ShippingTypeName</name><headertext>Shipping Type</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>ShippingCode</name><headertext>Shipping Code</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>ShippingName</name><headertext>Shipping Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>Description</name><headertext>Display Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>DisplayOrder</name><headertext>Display Order</headertext><width>30</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>3</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>y</iscontrol><controltype>Text</controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>DestinationCountryCode</name><headertext>Country Code</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>HandlingCharge</name><headertext>Handling Charge</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>IsActive</name><headertext>Enable</headertext><width>40</width><datatype>Boolean</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>9</id><name>ZipCode</name><headertext>Zip Code</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>10</id><name>PublishState</name><headertext>Application Type</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>y</iscontrol><controltype>DropDown</controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>11</id><name>Manage</name><headertext>Action</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>Edit|Delete</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>PortalId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/Profiles/UpdateProfileShipping|/Profiles/UnAssociateAssociatedShipping</manageactionurl><manageparamfield>shippingId,profileId|shippingId,profileId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>12</id><name>ProfileName</name><headertext>Profile Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>13</id><name>ShippingId</name><headertext>ShippingId</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName = 'ZnodeAssociatedShippingListToProfile'

GO

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'Account','GetParentAccountsList',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'Account' and ActionName = 'GetParentAccountsList')

GO

update ZnodeActions set IsGlobalAccess=1  where ControllerName = 'Account' and ActionName = 'GetParentAccountsList'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetDefaultSimpleProductFilter')
	DROP PROC Znode_GetDefaultSimpleProductFilter

GO

CREATE PROCEDURE [dbo].[Znode_GetDefaultSimpleProductFilter]
( @LocaleId INT )

AS
/*
     Summary :- This function is used to find the default value filter 
     Unit Testing 
	 begin tran
     EXEC Znode_GetDefaultSimpleProductFilter 1
	 rollback tran
*/
     BEGIN
	   SET NOCOUNT ON;
	     BEGIN TRY
         -- Declare the return variable here
         DECLARE @DefaultValue NVARCHAR(MAX)= '';
         DECLARE @DefaultLocaleId INT= Dbo.Fn_GetDefaultValue('Locale');

         WITH Cte_DefaultProductType
              AS (SELECT ZPA.PimAttributeId,ZPADV.AttributeDefaultValueCode AttributeValue,ZPADVL.LocaleId
                  FROM ZnodePImAttributeDefaultValueLocale ZPADVL
                  INNER JOIN ZnodePimAttributeDefaultvalue ZPADV ON(ZPADV.PimAttributeDefaultvalueId = ZPADVL.PimAttributeDefaultvalueId)
                  INNER JOIN ZnodePimAttribute ZPA ON(ZPADV.PimAttributeId = ZPA.PimAttributeId)
                  WHERE ZPA.AttributeCode = 'ProductType'
                        AND AttributeDefaultValueCode = 'SimpleProduct'
                        AND LocaleId IN(@DefaultLocaleId, @LocaleId)),

              Cte_GetAttributeValue
              AS (SELECT PimAttributeId,AttributeValue                      
                  FROM Cte_DefaultProductType CTDPT
                  WHERE CTDPT.LocaleId = @LocaleId),

              Cte_AttributeIds
              AS (
              SELECT *
              FROM Cte_GetAttributeValue
              UNION ALL
              SELECT PimAttributeId, AttributeValue                   
              FROM Cte_DefaultProductType CTDPT
              WHERE CTDPT.LocaleId = @DefaultLocaleId
                    AND NOT EXISTS
              (
                  SELECT TOP 1 1
                  FROM Cte_GetAttributeValue CTGAV
                  WHERE CTGAV.PimAttributeId = CTDPT.PimAttributeId
              ))
              SELECT  TOP 1 AttributeValue
              FROM Cte_AttributeIds;
		END TRY
		BEGIN CATCH
			  DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetDefaultSimpleProductFilter @LocaleId = '+CAST(@LocaleId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		     
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetDefaultSimpleProductFilter',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
		END CATCH
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetFilterPimProductId')
	DROP PROC Znode_GetFilterPimProductId

GO


Create PROCEDURE [dbo].[Znode_GetFilterPimProductId]
(
  @WhereClause XML 
 ,@PimProductId TransferId READONLY 
 ,@LocaleId   INT,
 @IsProductNotIn BIT = 1
)
AS 
BEGIN 
SET NOCOUNT ON 

		DECLARE  @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleID()
		DECLARE @SQL NVARCHAR(MAX)
		DECLARE @InternalProductWhereClause NVARCHAR(MAX)

		DECLARE @WorkingProcess INT = 0 

		DECLARE @TBL_FilterClause TABLE (ID INT IDENTITY(1,1),AttributeValue NVARCHAR(MAX),AttributeCode NVARCHAr(MAX),PimAttributeId INT ,AttributeTypeName VARCHAR(300),AttributeCodeOrg VARCHAR(600))

		DECLARE @WhereClauseXML XML = @WhereClause 

		SET @SQL  = ''

		IF EXISTS (SELECT TOP 1 1 FROM @WhereClauseXml.nodes ( '//ArrayOfWhereClauseModel/WhereClauseModel'  ) AS Tbl(Col) 
		WHERE Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(MAX)')  LIKE  '% in (%')
		BEGIN 
			SET @WorkingProcess = 1

				INSERT INTO @TBL_FilterClause (AttributeValue,AttributeCode,AttributeTypeName,PimAttributeId,AttributeCodeOrg)
			SELECT  Tbl.Col.value ( 'attributevalue[1]' , 'NVARCHAR(MAX)') AS AttributeValue
			,Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(MAX)') AS AttributeValue,ZTY.AttributeTypeName,ZPA.PimAttributeId,AttributeCode AttributeCodeOrg
			FROM @WhereClauseXml.nodes ( '//ArrayOfWhereClauseModel/WhereClauseModel'  ) AS Tbl(Col)
			LEFT JOIN  ZnodePimAttribute ZPA  ON ((Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(MAX)')  LIKE '%in (%' OR dbo.Fn_Trim(REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(MAX)'),' = ',''),'''','')) 
												= ZPA.AttributeCode ) AND IsCategory = 0 
			AND ( ZPA.IsShowOnGrid = 1 OR ZPA.IsConfigurable =1  )  )
			LEFT JOIN ZnodeAttributeType ZTY ON (ZTY.AttributeTypeId = ZPA.AttributeTypeId)

		END 
		ELSE 
		BEGIN 

			INSERT INTO @TBL_FilterClause (AttributeValue,AttributeCode,AttributeTypeName,PimAttributeId,AttributeCodeOrg)
			SELECT  Tbl.Col.value ( 'attributevalue[1]' , 'NVARCHAR(MAX)') AS AttributeValue
			,Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(MAX)') AS AttributeValue,ZTY.AttributeTypeName,ZPA.PimAttributeId,AttributeCode AttributeCodeOrg
			FROM @WhereClauseXml.nodes ( '//ArrayOfWhereClauseModel/WhereClauseModel'  ) AS Tbl(Col)
			LEFT JOIN ZnodePimAttribute ZPA  ON (dbo.Fn_Trim(REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(MAX)'),' = ',''),'''','')) 
												= ZPA.AttributeCode AND ZPA.IsCategory = 0 
			AND ( ZPA.IsShowOnGrid = 1 OR ZPA.IsConfigurable =1  )  )
			LEFT JOIN ZnodeAttributeType ZTY ON (ZTY.AttributeTypeId = ZPA.AttributeTypeId)

		END 

		CREATE TABLE #TBL_PimProductId (PimProductId INT)

		CREATE TABLE #TBL_PimProductIdDelete (PimProductId INT )

		INSERT INTO #TBL_PimProductId (PimProductId )
		SELECT Id 
		FROM @PimProductId

		SELECT ZPAV.PimProductId ,PimAttributeValueId ,ZPAV.CreatedDate,ZPAV.ModifiedDate,TBLA.AttributeCodeOrg AttributeCode
		INTO #TBL_AttributeValueId 
		FROM  ZnodePimAttributeValue ZPAV 
		INNER JOIN @TBL_FilterClause TBLA ON (TBLA.PimAttributeId = ZPAV.PimAttributeId)
		INNER JOIN #TBL_PimProductId YT ON (YT.PimProductId = ZPAV.PimProductId OR NOT EXISTS (SELECT TOP 1 1 #TBL_PimProductId))

		DELETE FROM #TBL_PimProductId

		INSERT INTO #TBL_PimProductId (PimProductId )
		SELECT DISTINCT PimProductId 
		FROM #TBL_AttributeValueId

		IF @WorkingProcess =1 
		BEGIN 
				DECLARE @PimAttributeId_in TransferId 

				INSERT INTO @PimAttributeId_in 
				SELECT PimAttributeId
				FROM  @TBL_FilterClause 
				WHERE AttributeTypeName IN ('Simple Select','Multi Select') 
				AND AttributeCode LIKE '%in (%'

				CREATE TABLE #TBL_AttributeDefaultValue_in ( PimAttributeId INT ,
							AttributeDefaultValueCode VARCHAR(MAX),IsEditable INT,AttributeDefaultValue NVARCHAR(MAX),DisplayOrder INT,PimAttributeDefaultValueId INT,IsDefault Bit  )    
				INSERT INTO #TBL_AttributeDefaultValue_in(PimAttributeId,AttributeDefaultValueCode,IsEditable,AttributeDefaultValue,DisplayOrder,PimAttributeDefaultValueId,IsDefault)
				EXEC Znode_GetAttributeDefaultValueLocaleNew_TansferId @PimAttributeId_in, @LocaleId;
 
				DECLARE @WhereClauseInCom NVARCHAR(MAX) = (SELECT TOP 1 AttributeValue FROM @TBL_FilterClause WHERE AttributeCode LIKE '%in (%') 


			SET @SQL = '
			;With Cte_AttributeValue AS 
			(
			SELECT PimAttributeValueId 
			FROM ZnodePimAttributeValueLocale 
			WHERE AttributeValue '+@WhereClauseInCom+'
			UNION ALL 
			SELECT ZPADV.PimAttributeValueID 
			FROM ZnodePimProductAttributeDefaultValue ZPADV 
			INNER JOIN #TBL_AttributeDefaultValue_in TBL ON (TBL.PimAttributeDefaultValueId = ZPADV.PimAttributeDefaultValueId)
			WHERE TBL.AttributeDefaultValue '+@WhereClauseInCom+'
			)
   
			SELECT PimProductId 
			FROM #TBL_AttributeValueId ZPAV 
			INNER JOIN  Cte_AttributeValue CTAC ON (CTAC.PimAttributeValueId = ZPAV.PimAttributeVaLueId )
			GROUP BY PimProductId
			UNION ALL  
			SELECT PimProductId 
			FROM ZnodePimProduct a
			INNER JOIN ZnodePimFamilyLocale b ON (b.PimAttributeFamilyId = a.PimAttributeFamilyId) 
			WHERE b.AttributeFamilyName '+@WhereClauseInCom+'
			GROUP BY PimProductId
			UNION ALL 
			SELECT  TBLAV.PimProductId 
			FROM ZnodePimProduct TBLAV
			WHERE CASE WHEN TBLAV.IsProductPublish  IS NULL THEN ''Not Published'' 
					WHEN TBLAV.IsProductPublish = 0 THEN ''Draft''
					ELSE  ''Published'' END '+@WhereClauseInCom+'
			GROUP BY TBLAV.PimProductId 
			'
   
			DELETE FROM #TBL_PimProductIdDelete 
			INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
			EXEC (@SQL)
			DELETE FROM #TBL_PimProductId
			INSERT INTO #TBL_PimProductId
			SELECT PimProductId FROM #TBL_PimProductIdDelete
			INSERT INTO #TBL_PimProductId
			SELECT -1 
			WHERE NOT EXISTS (SELECT TOP 1 1  FROM #TBL_PimProductId)

			DELETE  FROM @TBL_FilterClause WHERE AttributeCode LIKE '% in (%'

			DROP TABLE #TBL_AttributeDefaultValue_in
			SET @WorkingProcess  = 0 
   
		END 

		IF EXISTS (SELECT TOP 1 1 FROM @TBL_FilterClause WHERE AttributeCode <> '' AND ISNULL(AttributeValue,'') = '')
		BEGIN 
  
				SET  @InternalProductWhereClause = STUFF( (  SELECT ' INNER JOIN #TBL_AttributeValueId AS ZPAVL'+CAST(ID AS VARCHAR(200))+
												' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
												' )'				
										FROM @TBL_FilterClause
										WHERE ISNULL(AttributeValue,'') = ''
										FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				----Change for configurable product varient page seach
				SET @SQL = ' 
							SELECT  TBLAV.PimProductId 
							FROM #TBL_AttributeValueId TBLAV '+@InternalProductWhereClause+' 
							WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId )
							GROUP BY TBLAV.PimProductId 
						'
  

				DELETE FROM #TBL_PimProductIdDelete 
				INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
				EXEC (@SQL)
				DELETE FROM #TBL_PimProductId
				INSERT INTO #TBL_PimProductId
				SELECT PimProductId FROM #TBL_PimProductIdDelete
				INSERT INTO #TBL_PimProductId
				SELECT -1 
				WHERE NOT EXISTS (SELECT TOP 1 1  FROM #TBL_PimProductId)
				DELETE FROM @TBL_FilterClause WHERE ISNULL(AttributeValue,'') = ''
				IF NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) AND EXISTS (SELECT TOP 1 1  FROM @PimProductId Having Max (ID) = 0 )
				BEGIN
				INSERT INTO  #TBL_PimProductId (PimProductId)
				SELECT 0 
			END
  
		END 

		IF EXISTS (SELECT TOP 1 1 FROM @TBL_FilterClause WHERE AttributeTypeName IN ('Simple Select','Multi Select') )
		BEGIN
			DECLARE @PimAttributeId TransferId 

			INSERT INTO @PimAttributeId 
			SELECT DISTINCT PimAttributeId
			FROM  @TBL_FilterClause WHERE AttributeTypeName IN ('Simple Select','Multi Select') 

			CREATE TABLE #TBL_AttributeDefaultValue ( PimAttributeId INT ,
						AttributeDefaultValueCode VARCHAR(MAX),IsEditable INT,AttributeDefaultValue NVARCHAR(MAX),DisplayOrder INT,PimAttributeDefaultValueId INT,IsDefault BIT  )    
			INSERT INTO #TBL_AttributeDefaultValue(PimAttributeId,AttributeDefaultValueCode,IsEditable,AttributeDefaultValue,DisplayOrder,PimAttributeDefaultValueId,IsDefault)
			EXEC Znode_GetAttributeDefaultValueLocaleNew_TansferId @PimAttributeId, @LocaleId;
 
			IF @DefaultLocaleId = @LocaleID AND  @WorkingProcess = 0 
			BEGIN 

				IF @IsProductNotIn = 1 AND EXISTS(SELECT * FROM @TBL_FilterClause WHERE AttributeCodeOrg = 'Brand')
				BEGIN
					SET  @InternalProductWhereClause = STUFF( (  SELECT ' INNER JOIN Cte_AttributeValue AS ZPAVL'+CAST(ID AS VARCHAR(200))+
													' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
													+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+
													'.LocaleId='+CAST(@LocaleID AS VARCHAR(200))+' )'				
											FROM @TBL_FilterClause
											WHERE AttributeTypeName IN ('Simple Select','Multi Select')
											AND AttributeValue <> ''
											AND AttributeValue IS NOT NULL
											FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				END
				ELSE IF @IsProductNotIn = 0  AND EXISTS(SELECT * FROM @TBL_FilterClause WHERE AttributeCodeOrg <> 'Brand')
				BEGIN
					SET  @InternalProductWhereClause = STUFF( (  SELECT ' INNER JOIN Cte_AttributeValue AS ZPAVL'+CAST(ID AS VARCHAR(200))+
													' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
													+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+
													'.LocaleId='+CAST(@LocaleID AS VARCHAR(200))+' )'				
											FROM @TBL_FilterClause
											WHERE AttributeTypeName IN ('Simple Select','Multi Select')
											AND AttributeValue <> ''
											AND AttributeValue IS NOT NULL
											FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				END
				ELSE
				BEGIN
					SET  @InternalProductWhereClause = STUFF( (  SELECT ' INNER JOIN Cte_AttributeValue AS ZPAVL'+CAST(ID AS VARCHAR(200))+
													' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+
													'.LocaleId='+CAST(@LocaleID AS VARCHAR(200))+' )'				
											FROM @TBL_FilterClause
											WHERE AttributeTypeName IN ('Simple Select','Multi Select')
											AND AttributeValue <> ''
											AND AttributeValue IS NOT NULL
											FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				END
				
				SET @SQL = ' ;With Cte_AttributeValue AS 
							(
							SELECT TBLAV.PimAttributeValueId ,SUBSTRING((SELECT '',''+AttributeDefaultValue FROM #TBL_AttributeDefaultValue TTR 
							INNER JOIN ZnodePimProductAttributeDefaultValue ZPAVL ON (TTR.PimAttributeDefaultValueId = ZPAVL.PimAttributeDefaultValueId )
							WHERE ZPAVL.PimAttributeValueId = TBLAV.PimAttributeValueId  
							AND ZPAVL.LocaleId = '+Cast(@localeId AS VARCHAR(200))+'
							FOR XML PATH('''') ),2,4000) AttributeValue
								,  '+Cast(@localeId AS VARCHAR(200))+' LocaleId,TBLAV.AttributeCode,TBLAV.PimProductId
							FROM #TBL_AttributeValueId TBLAV
							'+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END+'
							GROUP BY TBLAV.PimAttributeValueId,TBLAV.AttributeCode,TBLAV.PimProductId
							)
  
						SELECT  TBLAV.PimProductId
						FROM #TBL_AttributeValueId TBLAV
						'+@InternalProductWhereClause+'	GROUP BY TBLAV.PimProductId '
			
				
			END 
			ELSE IF  @WorkingProcess = 0 
			BEGIN 

				SET  @InternalProductWhereClause = 
										STUFF( (  SELECT ' INNER JOIN Cte_AttributeValue AS ZPAVL'+CAST(ID AS VARCHAR(200))+
												' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
												' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+'  )'				
										FROM @TBL_FilterClause
										WHERE AttributeTypeName IN ('Simple Select','Multi Select')
										AND AttributeValue <> ''
										AND AttributeValue IS NOT NULL
										FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				SET @SQL = '  			 
							SELECT TBLAV.PimAttributeValueId,ZPAVL.PimAttributeDefaultValueId , ZPAVL.LocaleId ,COUNT(*)Over(Partition By TBLAV.PimAttributeValueId ,TBLAV.PimProductId ORDER BY TBLAV.PimAttributeValueId ,TBLAV.PimProductId  ) RowId
							INTO #temp_Table 
							FROM #TBL_AttributeValueId TBLAV 
							INNER JOIN ZnodePimProductAttributeDefaultValue ZPAVL ON (ZPAVL.PimAttributeValueId = TBLAV.PimAttributeValueId)
							WHERE (ZPAVL.LocaleId = '+Cast(@localeId AS VARCHAR(200))+' OR ZPAVL.LocaleId = '+Cast(@DefaultlocaleId AS VARCHAR(200))+')
				
							;with Cte_AttributeValue AS 
							(
							SELECT TBLAV.PimAttributeValueId ,SUBSTRING((SELECT '',''+AttributeDefaultValue FROM #TBL_AttributeDefaultValue TTR 
							INNER JOIN #temp_Table  ZPAVL ON (TTR.PimAttributeDefaultValueId = ZPAVL.PimAttributeDefaultValueId )
							WHERE ZPAVL.PimAttributeValueId = TBLAV.PimAttributeValueId  
							AND ZPAVL.LocaleId = CASE WHEN ZPAVL.RowId = 2 THEN '+CAST(@LocaleId AS Varchar(300))+' ELSE '+Cast(@DefaultLocaleId AS Varchar(300))+' END  
							FOR XML PATH('''') ),2,4000) AttributeValue,TBLAV.AttributeCode ,TBLAV.PimProductId 
							FROM #TBL_AttributeValueId TBLAV
							'+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END+'
							GROUP BY TBLAV.PimAttributeValueId,TBLAV.AttributeCode ,TBLAV.PimProductId 
							)
  
							SELECT   TBLAV.PimProductId
							FROM  #TBL_AttributeValueId TBLAV
							'+@InternalProductWhereClause+'	GROUP BY TBLAV.PimProductId '

			END 

			DELETE FROM #TBL_PimProductIdDelete 
			INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
			EXEC (@SQL)
			DELETE FROM #TBL_PimProductId
			INSERT INTO #TBL_PimProductId
			SELECT PimProductId FROM #TBL_PimProductIdDelete
 
			DROP TABLE #TBL_AttributeDefaultValue

		END 

		IF EXISTS (SELECT TOP 1 1 FROM @TBL_FilterClause WHERE AttributeTypeName IN ('Text','Number','Datetime','Yes/No','Date') )
		BEGIN  
   
				IF @DefaultLocaleId = @LocaleID AND @WorkingProcess = 0 
				BEGIN 
					SET  @InternalProductWhereClause = 
											STUFF( (  SELECT ' INNER JOIN View_PimProducttextValue AS ZPAVL'+CAST(ID AS VARCHAR(200))+
													' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
													' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+
													'.LocaleId='+CAST(@LocaleID AS VARCHAR(200))+' )'				
											FROM @TBL_FilterClause
											WHERE AttributeTypeName IN ('Text','Number','Datetime','Yes/No','Date')
											FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
 
					SET @SQL = '	SELECT  TBLAV.PimProductId 
								FROM #TBL_AttributeValueId TBLAV
								'+@InternalProductWhereClause+'
								'+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
											ELSE ' WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId   ) ' END 
								+' GROUP BY TBLAV.PimProductId '

			END 
			ELSE IF @WorkingProcess = 0 
			BEGIN 
				SET  @InternalProductWhereClause = 
										STUFF( (  SELECT ' INNER JOIN Cte_AttributeDetails AS ZPAVL'+CAST(ID AS VARCHAR(200))+
												' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
												' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+
												'.LocaleId = CASE WHEN ZPAVL'+CAST(ID AS VARCHAR(200))+'.RowId = 2 THEN  '+CAST(@LocaleId AS Varchar(300))+' ELSE '+Cast(@DefaultLocaleId AS Varchar(300))+' END  )'				
										FROM @TBL_FilterClause
										WHERE AttributeTypeName IN ('Text','Number','Datetime','Yes/No','Date')
										FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				SET @SQL = ' 
					;With Cte_AttributeDetails AS 
					(
					SELECT TBLAV.PimProductId,ZPAVL.AttributeValue,TBLAV.AttributeCode,ZPAVL.LocaleId ,COUNT(*)Over(Partition By TBLAV.PimProductId,TBLAV.AttributeCode ORDER BY TBLAV.PimProductId,TBLAV.AttributeCode  ) RowId
					FROM #TBL_AttributeValueId TBLAV 
					INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON (ZPAVL.PimAttributeValueId = TBLAV.PimAttributeValueId )
					WHERE (LocaleId = '+Cast(@DefaultLocaleId AS Varchar(300))+' OR LocaleId = '+CAST(@LocaleId AS Varchar(300))+' )'+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' AND EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END +'
					) 
					SELECT  TBLAV.PimProductId 
  					FROM #TBL_AttributeValueId TBLAV
					'+@InternalProductWhereClause+'
					GROUP BY TBLAV.PimProductId 
					'
			END 
			DELETE FROM #TBL_PimProductIdDelete 
			INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
			EXEC (@SQL)
			DELETE FROM #TBL_PimProductId
			INSERT INTO #TBL_PimProductId
			SELECT PimProductId FROM #TBL_PimProductIdDelete

		END 

		IF EXISTS (SELECT TOP 1 1 FROM @TBL_FilterClause WHERE AttributeTypeName IN ('Text Area') )
		BEGIN    
			IF @DefaultLocaleId = @LocaleID AND @WorkingProcess = 0 
			BEGIN 
				SET  @InternalProductWhereClause = 
											STUFF( (  SELECT ' INNER JOIN View_PimProductTextAreaValue AS ZPAVL'+CAST(ID AS VARCHAR(200))+
												' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
												' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+
												'.LocaleId='+CAST(@LocaleID AS VARCHAR(200))+' )'				
										FROM @TBL_FilterClause
										WHERE AttributeTypeName IN ('Text Area')
										FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
 
				SET @SQL = '
							SELECT  TBLAV.PimProductId 
							FROM #TBL_AttributeValueId TBLAV
							'+@InternalProductWhereClause+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END 
										+' GROUP BY TBLAV.PimProductId '
			END 
			ELSE IF @WorkingProcess = 0 
			BEGIN 
				SET  @InternalProductWhereClause = 
										STUFF( (  SELECT ' INNER JOIN Cte_AttributeDetails AS ZPAVL'+CAST(ID AS VARCHAR(200))+
												' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
												' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+
												'.LocaleId = CASE WHEN ZPAVL'+CAST(ID AS VARCHAR(200))+'.RowId = 2 THEN  '+CAST(@LocaleId AS Varchar(300))+' ELSE '+Cast(@DefaultLocaleId AS Varchar(300))+' END  )'				
										FROM @TBL_FilterClause
										WHERE AttributeTypeName IN ('Text Area')
										FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				SET @SQL = ' 
					;With Cte_AttributeDetails AS 
					(
					SELECT TBLAV.PimProductId,TBLAV.AttributeCode,ZPAVL.AttributeValue,ZPAVL.LocaleId ,COUNT(*)Over(Partition By TBLAV.PimProductId,TBLAV.AttributeCode ORDER BY TBLAV.PimProductId,TBLAV.AttributeCode  ) RowId
					FROM #TBL_AttributeValueId TBLAV 
					INNER JOIN ZnodePimProductAttributeTextAreaValue ZPAVL ON (ZPAVL.PimAttributeValueId = TBLAV.PimAttributeValueId )
					WHERE (LocaleId = '+Cast(@DefaultLocaleId AS Varchar(300))+' OR LocaleId = '+CAST(@LocaleId AS Varchar(300))+' )
	 
					) 
					SELECT  TBLAV.PimProductId 
  					FROM #TBL_AttributeValueId TBLAV
					'+@InternalProductWhereClause+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END 
										+' 
										GROUP BY TBLAV.PimProductId 	
										'
				END 
			DELETE FROM #TBL_PimProductIdDelete 
			INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
			EXEC (@SQL)
			DELETE FROM #TBL_PimProductId
			INSERT INTO #TBL_PimProductId
			SELECT PimProductId FROM #TBL_PimProductIdDelete

		END 
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_FilterClause WHERE AttributeCode  LIKE '%PublishStatus%' )
		BEGIN    
 
				SET @SQL = '
							SELECT  TBLAV.PimProductId 
							FROM ZnodePimProduct TBLAV
							WHERE CASE WHEN TBLAV.IsProductPublish  IS NULL THEN ''Not Published'' 
							WHEN TBLAV.IsProductPublish = 0 THEN ''Draft''
							ELSE  ''Published'' END '+(SELECT TOP 1 AttributeValue FROM @TBL_FilterClause WHERE AttributeCode LIKE '%PublishStatus%')+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' AND EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END 
										+' GROUP BY TBLAV.PimProductId '
  
				DELETE FROM #TBL_PimProductIdDelete 
				INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
				EXEC (@SQL)
				DELETE FROM #TBL_PimProductId
				INSERT INTO #TBL_PimProductId
				SELECT PimProductId FROM #TBL_PimProductIdDelete

		END 
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_FilterClause WHERE AttributeCode  LIKE '%AttributeFamily%' )
		BEGIN 

				;With Cte_attributeValue AS 
				(
					SELECT ZPAF.PimAttributeFamilyId,FamilyCode,AttributeFamilyName ,ZPFL.LocaleId
					FROM ZnodePimAttributeFamily ZPAF
					INNER JOIN ZnodePimFamilyLocale ZPFL ON (ZPFL.PimAttributeFamilyId = ZPAF.PimAttributeFamilyId) 
					WHERE ZPFL.LocaleId IN (@DefaultLocaleId,@LocaleId)
				) 
				, Cte_AttributeValueAttribute AS 
				(
					SELECT PimAttributeFamilyId,FamilyCode,AttributeFamilyName
					FROM Cte_attributeValue RTY 
					WHERE LocaleId = @LocaleId
				)
				, Cte_AttributeValueTht AS 
				(
					SELECT PimAttributeFamilyId,FamilyCode,AttributeFamilyName
					FROM Cte_AttributeValueAttribute
					UNION ALL 
					SELECT PimAttributeFamilyId,FamilyCode,AttributeFamilyName
					FROM Cte_attributeValue TYY  
					WHERE NOT EXISTS (SELECT TOP 1 1 FROM Cte_AttributeValueAttribute THE WHERE THE.PimAttributeFamilyId = TYY.PimAttributeFamilyId )
					AND TYY.LocaleId = @DefaultLocaleId
				)
				SELECT PimAttributeFamilyId,FamilyCode,AttributeFamilyName
				INTO #TBL_FamilyLocale
				FROM Cte_AttributeValueTht 


				SET @SQL = '
							SELECT  TBLAV.PimProductId 
							FROM ZnodePimProduct TBLAV 
							INNER JOIN #TBL_FamilyLocale THY ON (THY.PimAttributeFamilyId = TBLAV.PimAttributeFamilyId )
							WHERE AttributeFamilyName '+(SELECT TOP 1 AttributeValue FROM @TBL_FilterClause WHERE AttributeCode LIKE '%AttributeFamily%')+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' AND EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END 
										+' GROUP BY TBLAV.PimProductId '
  

			DELETE FROM #TBL_PimProductIdDelete 
			INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
			EXEC (@SQL)
			DELETE FROM #TBL_PimProductId
			INSERT INTO #TBL_PimProductId
			SELECT PimProductId FROM #TBL_PimProductIdDelete

		END 
	
		SET @SQL = '
		IF EXISTS ( SELECT TOP 1 1 FROM tempdb..sysobjects WHERE name = ''##Temp_PimProductId'+CAST(@@SPID AS VARCHAR(500))+''' )
		BEGIN 
			DROP TABLE ##Temp_PimProductId'+CAST(@@SPID AS VARCHAR(500))+'
		END 
		CREATE TABLE ##Temp_PimProductId'+CAST(@@SPID AS VARCHAR(500))+' (PimProductId INT )
		INSERT INTO  ##Temp_PimProductId'+CAST(@@SPID AS VARCHAR(500))+'
		SELECT PimProductId 
		FROM #TBL_PimProductId
		'
		EXEC (@SQL)
		DROP TABLE #TBL_PimProductId
		DROP TABLE #TBL_AttributeValueId
		DROP TABLE #TBL_PimProductIdDelete
 END
 
GO

IF NOT EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'Custom1'
AND Object_ID = Object_ID(N'dbo.ZnodeBrandDetailLocale'))
BEGIN
	ALTER TABLE ZnodeBrandDetailLocale ADD Custom1 NVARCHAR(MAX);
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'Custom2'
AND Object_ID = Object_ID(N'dbo.ZnodeBrandDetailLocale'))
BEGIN
	ALTER TABLE ZnodeBrandDetailLocale ADD Custom2 NVARCHAR(MAX);
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'Custom3'
AND Object_ID = Object_ID(N'dbo.ZnodeBrandDetailLocale'))
BEGIN
	ALTER TABLE ZnodeBrandDetailLocale ADD Custom3 NVARCHAR(MAX);
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'Custom4'
AND Object_ID = Object_ID(N'dbo.ZnodeBrandDetailLocale'))
BEGIN
	ALTER TABLE ZnodeBrandDetailLocale ADD Custom4 NVARCHAR(MAX);
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'Custom5'
AND Object_ID = Object_ID(N'dbo.ZnodeBrandDetailLocale'))
BEGIN
	ALTER TABLE ZnodeBrandDetailLocale ADD Custom5 NVARCHAR(MAX);
END

GO

Update ZnodeApplicationSetting
Set Setting = '<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>AccountId</name>      <headertext>Checkbox</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>AccountId</name>      <headertext>Account ID</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>AccountCode</name>      <headertext>Account Code</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>accountcodecolumn</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>Name</name>      <headertext>Account Name</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>y</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>accountnamecolumn</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>ParentAccountName</name>      <headertext>Parent Account Name</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>PortalId</name>      <headertext>Portal ID</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>portalId</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
where ItemName='ZnodeUserAccountList'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishBrandForSiteMap')
	DROP PROC Znode_GetPublishBrandForSiteMap

GO

CREATE PROCEDURE [dbo].[Znode_GetPublishBrandForSiteMap]
(
	@Rows INT,
	@PageNo INT,
	@PortalId INT,
	@VersionId INT,
	@LocaleId INT = 1,
	@RowsCount INT = 0 OUT
)
AS
---- Execute [Znode_GetPublishBrandForSiteMap] @Rows = 20,@PageNo=1,@PortalId=1,@VersionId=39,@LocaleId=1
BEGIN
BEGIN TRY 
SET NOCOUNT ON;
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
	DECLARE @SQL NVARCHAR(MAX),@Rows1 BIGINT

	IF Object_id('tempdb..#PublishBrandEntity') <>0
		DROP TABLE #PublishBrandEntity

	SET @Rows1 = @Rows * @PageNo

	CREATE TABLE #PublishBrandEntity
	(
		RowId BIGINT PRIMARY KEY IDENTITY(1,1), 
		PortalId INT,
		LocaleId INT,
		BrandId INT,
		BrandCode VARCHAR(50),
		BrandName VARCHAR(500),
		SEOFriendlyPageName NVARCHAR(MAX)
	)

	INSERT INTO #PublishBrandEntity(PortalId ,LocaleId ,BrandId ,BrandCode,BrandName,SEOFriendlyPageName )
	SELECT
		ZPPBE.PortalId AS PortalId,
		ZPPBE.LocaleId AS LocaleId,
		ZPPBE.BrandId AS BrandId,
		ZPPBE.BrandCode AS BrandCode,
		ZPPBE.BrandName AS BrandName,
		ZPPBE.SEOFriendlyPageName AS SEOFriendlyPageName
	FROM dbo.ZnodePublishPortalBrandEntity AS ZPPBE
	--LEFT JOIN ZnodePublishSeoEntity ZPSE ON ZPPBE.BrandCode = ZPSE.SEOCode AND ItemName = 'Brand'
	--	AND ZPPBE.VersionId = ZPSE.VersionId
	WHERE ZPPBE.LocaleId = @LocaleId AND ZPPBE.PortalId = @PortalId AND ZPPBE.VersionId = @VersionId 
	AND (1 = ZPPBE.IsActive)
	ORDER BY ZPPBE.DisplayOrder ASC

	--Applying pagination
	SET @SQL = 'SELECT TOP '+CAST(@Rows1 AS VARCHAR(10))+' PortalId ,LocaleId ,BrandId ,BrandCode,BrandName,SEOFriendlyPageName 
	FROM #PublishBrandEntity
	'+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows)
	
	EXEC sp_executesql @SQL
	SET @RowsCount = (SELECT COUNT(*) FROM #PublishBrandEntity)

END TRY
BEGIN CATCH
    DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishBrandForSiteMap @Rows = '+CAST(@Rows AS VARCHAR(200))+',@PageNo='+CAST(@PageNo AS VARCHAR(200))
	+',@PortalId ='+CAST(@PortalId AS VARCHAR(200))+',@VersionId='+CAST(@VersionId AS VARCHAR(200))+',@LocaleId='+CAST(@LocaleId AS VARCHAR(200))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(200));

    EXEC Znode_InsertProcedureErrorLog
        @ProcedureName = 'Znode_GetPublishBrandForSiteMap',
        @ErrorInProcedure = @Error_procedure,
        @ErrorMessage = @ErrorMessage,
        @ErrorLine = @ErrorLine,
        @ErrorCall = @ErrorCall;

END CATCH;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishCategoryForSiteMap')
	DROP PROC Znode_GetPublishCategoryForSiteMap

GO

CREATE PROCEDURE [dbo].[Znode_GetPublishCategoryForSiteMap]
(
	@Rows INT,
	@PageNo INT,
	@CatalogId INT,
	@VersionId INT,
	@LocaleId INT = 1,
	@IncludeAssociatedCategories BIT =1,
	@RowsCount INT = 0 OUT
)
AS
---- Execute [Znode_GetPublishCategoryForSiteMap] @Rows = 20,@PageNo=1,@CatalogId=3,@VersionId=53,@LocaleId=1,@IncludeAssociatedCategories=1
BEGIN
BEGIN TRY 
SET NOCOUNT ON;
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
	DECLARE @SQL NVARCHAR(MAX),@Rows1 BIGINT

	SET @Rows1 = @Rows * @PageNo 

	IF Object_id('tempdb..#PublishCategoryEntity') <>0
		DROP TABLE #PublishCategoryEntity

	IF Object_id('tempdb..#PublishCategoryEntityPagination') <>0
		DROP TABLE #PublishCategoryEntityPagination

	CREATE TABLE #PublishCategoryEntity
	(
		RowId INT IDENTITY(1,1),
		ZnodeCategoryId INT, 
		CategoryName VARCHAR(300),
		CategoryCode VARCHAR(100),
		ZnodeCatalogId INT,
		CatalogName VARCHAR(300),
		ZnodeParentCategoryIds VARCHAR(200),
		SEOUrl NVARCHAR(MAX)
	)

	CREATE TABLE #PublishCategoryEntityPagination
	(
		Id INT IDENTITY(1,1),
		ZnodeCategoryId INT, 
		CategoryName VARCHAR(300),
		CategoryCode VARCHAR(100),
		ZnodeCatalogId INT,
		CatalogName VARCHAR(300),
		ZnodeParentCategoryIds VARCHAR(200),
		SEOUrl NVARCHAR(MAX),
		DisplayOrder INT
	)

	
	SELECT @RowsCount = COUNT(*)
	FROM dbo.ZnodePublishCategoryEntity AS ZPCE
	WHERE ZPCE.ZnodeCatalogId = @CatalogId AND ZPCE.LocaleId = @LocaleId  
	AND ZPCE.IsActive = 1 AND ZPCE.VersionId = @VersionId 
	AND ZPCE.ZnodeParentCategoryIds IS NULL

	--Getting category entity data for site map
	SET @SQL = '	
	INSERT INTO #PublishCategoryEntity(ZnodeCategoryId ,CategoryName,CategoryCode,ZnodeCatalogId,CatalogName, ZnodeParentCategoryIds, SEOUrl)
	SELECT TOP '+CAST(@Rows1 AS VARCHAR(10))+' ZPCE.ZnodeCategoryId , ZPCE.Name as CategoryName,ZPCE.CategoryCode,ZPCE.ZnodeCatalogId,ZPCE.CatalogName, ZPCE.ZnodeParentCategoryIds, ZPSE.SEOUrl
	FROM dbo.ZnodePublishCategoryEntity AS ZPCE
	LEFT JOIN ZnodePublishSeoEntity ZPSE ON ZPCE.CategoryCode = ZPSE.SEOCode AND ItemName = ''Category''
		AND ZPCE.VersionId = ZPSE.VersionId 
	WHERE ZPCE.ZnodeCatalogId = '+CAST(@CatalogId AS VARCHAR(10))+' AND ZPCE.LocaleId = '+CAST(@LocaleId AS VARCHAR(10))+' 
	AND ZPCE.IsActive = 1 AND ZPCE.VersionId = '+CAST(@VersionId AS VARCHAR(10))+' 
	AND ZPCE.ZnodeParentCategoryIds IS NULL 
	ORDER BY ZPCE.DisplayOrder ASC'

	EXEC sp_executesql @SQL


	--Applying pagination
	SET @SQL = 'SELECT ZnodeCategoryId ,CategoryName,CategoryCode,ZnodeCatalogId,CatalogName, ZnodeParentCategoryIds, SEOUrl 
	FROM #PublishCategoryEntity '+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows)+' ORDER BY RowId'
	--PRINT @SQL
	INSERT INTO #PublishCategoryEntityPagination(ZnodeCategoryId ,CategoryName,CategoryCode,ZnodeCatalogId,CatalogName, ZnodeParentCategoryIds, SEOUrl)
	EXEC sp_executesql @SQL

	IF @IncludeAssociatedCategories = 1
	BEGIN
		----Getting child publish category data
		;WITH CategoryDetails AS 
		(
			SELECT  ZPCE.ZnodeCategoryId , ZPCE.Name as CategoryName,ZPCE.CategoryCode,ZPCE.ZnodeCatalogId,ZPCE.CatalogName, 
					ZPCE.ZnodeParentCategoryIds, ZPCE.VersionId, ZPCE.DisplayOrder
			FROM dbo.ZnodePublishCategoryEntity AS ZPCE
			WHERE ZPCE.ZnodeCatalogId = @CatalogId  AND ZPCE.LocaleId = @LocaleId
			AND ZPCE.IsActive = 1 AND ZPCE.VersionId = @VersionId 
			AND ZPCE.ZnodeParentCategoryIds IS NOT NULL
			AND EXISTS(SELECT * FROM #PublishCategoryEntityPagination P 
			WHERE '['+CAST(P.ZnodeCategoryId AS VARCHAR(10))+']' = ZPCE.ZnodeParentCategoryIds )
			UNION ALL
			SELECT  ZPCE1.ZnodeCategoryId , ZPCE1.Name as CategoryName,ZPCE1.CategoryCode,ZPCE1.ZnodeCatalogId,ZPCE1.CatalogName, 
					ZPCE1.ZnodeParentCategoryIds, ZPCE1.VersionId, ZPCE1.DisplayOrder
			FROM dbo.ZnodePublishCategoryEntity AS ZPCE1
			INNER JOIN CategoryDetails CD ON '['+CAST(CD.ZnodeCategoryId AS VARCHAR(10))+']' = ZPCE1.ZnodeParentCategoryIds
			WHERE ZPCE1.ZnodeCatalogId = @CatalogId  AND ZPCE1.LocaleId = @LocaleId
			AND ZPCE1.IsActive = 1 AND ZPCE1.VersionId = @VersionId 
			AND ZPCE1.ZnodeParentCategoryIds IS NOT NULL
		)
		INSERT INTO #PublishCategoryEntityPagination(ZnodeCategoryId ,CategoryName,CategoryCode,ZnodeCatalogId,CatalogName, ZnodeParentCategoryIds, SEOUrl, DisplayOrder)
		SELECT DISTINCT CD.ZnodeCategoryId,	CD.CategoryName, CD.CategoryCode, CD.ZnodeCatalogId, CD.CatalogName, CD.ZnodeParentCategoryIds, ZPSE.SEOUrl, CD.DisplayOrder
		FROM CategoryDetails CD
		LEFT JOIN ZnodePublishSeoEntity ZPSE ON CD.CategoryCode = ZPSE.SEOCode AND ZPSE.ItemName = 'Category' AND CD.VersionId = ZPSE.VersionId 
		WHERE NOT EXISTS(SELECT * FROM #PublishCategoryEntityPagination PCEP WHERE CD.ZnodeCategoryId = PCEP.ZnodeCategoryId AND ISNULL(CD.ZnodeParentCategoryIds,'') = ISNULL(PCEP.ZnodeParentCategoryIds,''))
		ORDER BY CD.DisplayOrder ASC
	END

	SELECT DISTINCT Id, ZnodeCategoryId,	CategoryName,	CategoryCode,	ZnodeCatalogId,	CatalogName,	ZnodeParentCategoryIds,	SEOUrl
	FROM #PublishCategoryEntityPagination ORDER BY Id 
	
END TRY
BEGIN CATCH
    DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishCategoryForSiteMap @Rows = '+CAST(@Rows AS VARCHAR(200))+',@PageNo='+CAST(@PageNo AS VARCHAR(200))
	+',@CatalogId='+CAST(@CatalogId AS VARCHAR(200))+',@VersionId='+CAST(@VersionId AS VARCHAR(200))+',@LocaleId='+CAST(@LocaleId AS VARCHAR(200));

    EXEC Znode_InsertProcedureErrorLog
        @ProcedureName = 'Znode_GetPublishCategoryForSiteMap',
        @ErrorInProcedure = @Error_procedure,
        @ErrorMessage = @ErrorMessage,
        @ErrorLine = @ErrorLine,
        @ErrorCall = @ErrorCall;

END CATCH;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishProductForSiteMap')
	DROP PROC Znode_GetPublishProductForSiteMap

GO

CREATE PROCEDURE [dbo].[Znode_GetPublishProductForSiteMap]
(
	@Rows INT,
	@PageNo INT,
	@CatalogId INT,
	@VersionId INT,
	@LocaleId INT = 1,
	@RowsCount INT = 0 OUT
)
AS
---- Execute [Znode_GetPublishProductForSiteMap] @Rows = 5,@PageNo=1,@CatalogId=3,@VersionId=38,@LocaleId=1,@RowsCount=0
BEGIN
BEGIN TRY 
SET NOCOUNT ON;
	DECLARE @SQL NVARCHAR(MAX),@Rows1 BIGINT

	IF Object_id('tempdb..#PublishProductEntity') <>0
	DROP TABLE #PublishProductEntity

	CREATE TABLE #PublishProductEntity(RowId BIGINT PRIMARY KEY IDENTITY(1,1), ZnodeProductId INT,SKU NVARCHAR(500),Name NVARCHAR(500),CategoryName NVARCHAR(500),SeoUrl NVARCHAR(500))

	SET @Rows1 = @Rows * @PageNo

	INSERT INTO #PublishProductEntity(ZnodeProductId,SKU,Name,CategoryName,SeoUrl)
	SELECT
		ZPPE.[ZnodeProductId] AS [ZnodeProductId],
		ZPPE.[SKU] AS [SKU],
		ZPPE.[Name] AS [Name],
		ZPPE.[CategoryName] AS [CategoryName],
		ZPPE.[SeoUrl] AS [SeoUrl] 
	FROM [dbo].[ZnodePublishProductEntity] AS ZPPE
	LEFT JOIN ZnodePublishSeoEntity ZPSE ON ZPPE.SKU = ZPSE.SEOCode AND ZPSE.ItemName = 'Product'
		AND ZPPE.VersionId = ZPSE.VersionId 
	WHERE (ZPPE.[ZnodeCatalogId] = @CatalogId ) AND (ZPPE.[LocaleId] = @LocaleId ) AND (ZPPE.[VersionId] = @VersionId )
	and isnull([CategoryName],'') != ''
	ORDER BY ZPPE.[ZnodeCategoryIds] ASC
	print @SQL
	--Applying pagination
	SET @SQL = 'SELECT TOP '+CAST(@Rows1 AS VARCHAR(10))+' * FROM #PublishProductEntity
	'+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows)
	
	EXEC sp_executesql @SQL
	SET @RowsCount = (SELECT COUNT(*) FROM #PublishProductEntity)

END TRY
BEGIN CATCH
    DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishProductForSiteMap @Rows = '+CAST(@Rows AS VARCHAR(200))+',@PageNo='+CAST(@PageNo AS VARCHAR(200))
	+',@CatalogId='+CAST(@CatalogId AS VARCHAR(200))+',@VersionId='+CAST(@VersionId AS VARCHAR(200))+',@LocaleId='+CAST(@LocaleId AS VARCHAR(200));

    EXEC Znode_InsertProcedureErrorLog
        @ProcedureName = 'Znode_GetPublishProductForSiteMap',
        @ErrorInProcedure = @Error_procedure,
        @ErrorMessage = @ErrorMessage,
        @ErrorLine = @ErrorLine,
        @ErrorCall = @ErrorCall;

END CATCH;
END

GO

Update ZnodeApplicationSetting set Setting='<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>MediaId</name>      <headertext>Checkbox</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>MediaId</islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>MediaId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>Image</name>      <headertext>Media</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>Edit</format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>MediaId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Edit</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>Path,FileName</imageparamfield>      <manageactionurl>/MediaManager/MediaManager/GetMediaAttributeValues</manageactionurl>      <manageparamfield>MediaId</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>imageicon</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>FileName</name>      <headertext>File Name</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>100</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>y</isallowlink>      <islinkactionurl>/MediaManager/MediaManager/GetMediaAttributeValues</islinkactionurl>      <islinkparamfield>MediaId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>MediaId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>filename</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>y</allowdetailview>    </column>    <column>      <id>4</id>      <name>MediaType</name>      <headertext>File Type</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>MediaId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>MediaId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>Size</name>      <headertext>Size</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>MediaId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>MediaId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>Height</name>      <headertext>Height</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>MediaId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>MediaId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>Width</name>      <headertext>Width</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>MediaId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>MediaId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>MediaType</name>      <headertext>Type</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>MediaId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>MediaId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>9</id>      <name>Folder</name>      <headertext>Folder</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>MediaId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>MediaId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>10</id>      <name>Path</name>      <headertext>Path</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>Path</imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>imageicon</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>11</id>      <name>DisplayName</name>      <headertext>Display Name</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>Path</imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>12</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>Edit|Delete</format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>MediaId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Edit|Delete</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/MediaManager/MediaManager/GetMediaAttributeValues|/MediaManager/MediaManager/DeleteMedia</manageactionurl>      <manageparamfield>MediaId|MediaId</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>inline</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>' where ItemName = 'View_GetMediaPathDetail'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishSingleProductJson')
	DROP PROC Znode_GetPublishSingleProductJson

GO

CREATE PROCEDURE [dbo].[Znode_GetPublishSingleProductJson]
(
	 @PublishCatalogId INT = 0 
	,@VersionId       VARCHAR(50) = 0 
	,@PimProductId    TransferId Readonly 
	,@UserId		  INT = 0 
	,@TokenId nvarchar(max)= ''	
	,@LocaleIds TransferId READONLY
	,@PublishStateId INT = 0  
	,@RevisionType varchar(50)
	,@Status bit = 0 OutPut
	
)
AS


--Declare @PimProductId TransferId 
--insert into @PimProductId  select 230147
-- EXEC Znode_GetPublishSingleProductJson  @PublishCatalogId = 0 ,@VersionId= 0 ,@PimProductId =@PimProductId, @UserId=2 ,@RevisionType ='Production'


BEGIN 
BEGIN TRY 
 SET NOCOUNT ON 

EXEC Znode_InsertUpdatePimAttributeJson 1 
EXEC Znode_InsertUpdateCustomeFieldJson 1
EXEC Znode_InsertUpdateAttributeDefaultValueJson 1 

DECLARE @PimMediaAttributeId INT = dbo.Fn_GetProductImageAttributeId()
				
Select ZPLPD.PimParentProductId, ZPLPD.PimProductId, ZPLPD.PimAttributeId, ZPAVL.AttributeValue as SKU
into #LinkProduct
FROM ZnodePimLinkProductDetail ZPLPD 
INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimProductId = ZPLPD.PimProductId)
INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
WHERE exists(select * from ZnodePimAttribute ZPA where ZPA.PimAttributeId = ZPAV.PimAttributeId and ZPA.AttributeCode = 'SKU')
and exists(select * from @PimProductId pp where ZPLPD.PimParentProductId = pp.Id)

select * into #PimProductId from @PimProductId

create index Idx_#PimProductId_Id on #PimProductId(Id)
 IF OBJECT_ID('tempdb..#Cte_BrandData') is not null
 BEGIN 
	DROP TABLE #Cte_BrandData
 END 
 

 IF OBJECT_ID('tempdb..#ProductIds') is not null
 BEGIN 
	DROP TABLE #ProductIds
 END 

			Create Table #ProductIds (PimProductId int, PublishProductId  int )
			
			--DECLARE @PimProductAttributeJson TABLE(PimAttributeJsonId INT  PRIMARY KEY ,PimAttributeId INT,LocaleId INT  )
			CREATE TABLE #PimProductAttributeJson (PimAttributeJsonId INT  PRIMARY KEY ,PimAttributeId INT,LocaleId INT  )
			DECLARE @PimDefaultValueLocale  TABLE (PimAttributeDefaultJsonId INT  PRIMARY KEY ,PimAttributeDefaultValueId INT ,LocaleId INT ) 
			DECLARE @ProductNamePimAttributeId INT = dbo.Fn_GetProductNameAttributeId(),@DefaultLocaleId INT= Dbo.Fn_GetDefaultLocaleId(),@LocaleId INT = 0 
			,@SkuPimAttributeId  INT =  dbo.Fn_GetProductSKUAttributeId() , @IsActivePimAttributeId INT =  dbo.Fn_GetProductIsActiveAttributeId()
			DECLARE @GetDate DATETIME =dbo.Fn_GetDate()
			DECLARE @TBL_LocaleId  TABLE (RowId INT IDENTITY(1,1) PRIMARY KEY  , LocaleId INT )

			DECLARE @DomainUrl varchar(max) = (select TOp 1 URL FROM ZnodeMediaConfiguration WHERE IsActive =1)

			INSERT INTO @TBL_LocaleId (LocaleId)
			SELECT  LocaleId
			FROM ZnodeLocale MT
			WHERE IsActive = 1
			AND (EXISTS (SELECT TOP 1 1  FROM @LocaleIds RT WHERE RT.Id = MT.LocaleId )
			OR NOT EXISTS (SELECT TOP 1 1 FROM @LocaleIds )) 
	
			-----to update link products newly addded and deleted from PIM
			delete ZPAP
			from ZnodePublishAssociatedProduct ZPAP
			where ZPAP.IsLink = 1
			AND not exists(select * from ZnodePimLinkProductDetail ZPPD where ZPAP.ParentPimProductId = ZPPD.PimParentProductId AND ZPAP.PimProductId = ZPPD.PimProductId)
			and exists(select * from #PimProductId PP where PP.Id = ZPAP.ParentPimProductId )

			UPDATE ZPACP SET ZPACP.DisplayOrder = ZPLPD.DisplayOrder
			from ZnodePimLinkProductDetail ZPLPD
			INNER JOIN ZnodePimCategoryProduct ZPCP ON ZPLPD.PimParentProductId = ZPCP.PimProductId
			INNER JOIN ZnodePimCategoryHierarchy ZPCH ON ZPCP.PimCategoryId = ZPCH.PimCategoryId
			INNER JOIN ZnodePublishAssociatedProduct ZPACP ON ZPCH.PimCatalogId = ZPACP.PimCatalogId and ZPLPD.PimParentProductId = ZPACP.ParentPimProductId AND ZPLPD.PimProductId = ZPACP.PimProductId 
			where exists(select * from #PimProductId PP where PP.Id = ZPLPD.PimParentProductId )
			AND ZPACP.IsLink = 1

			insert into ZnodePublishAssociatedProduct(PimCatalogId,ParentPimProductId,PimProductId,PublishStateId,IsConfigurable,IsBundle,IsGroup,IsAddOn,IsLink,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			select distinct ZPCH.PimCatalogId, ZPLPD.PimParentProductId, ZPLPD.PimProductId, @PublishStateId, 0, 0, 0, 0, 1, ZPLPD.DisplayOrder, @UserId,@GetDate ,@UserId , @GetDate
			from ZnodePimLinkProductDetail ZPLPD
			INNER JOIN ZnodePimCategoryProduct ZPCP ON ZPLPD.PimParentProductId = ZPCP.PimProductId
			INNER JOIN ZnodePimCategoryHierarchy ZPCH ON ZPCP.PimCategoryId = ZPCH.PimCategoryId
			where exists(select * from #PimProductId PP where PP.Id = ZPLPD.PimParentProductId )
			and not exists(select * from ZnodePublishAssociatedProduct ZPACP where ZPCH.PimCatalogId = ZPACP.PimCatalogId and ZPLPD.PimParentProductId = ZPACP.ParentPimProductId AND ZPLPD.PimProductId = ZPACP.PimProductId  )
		
			-----to update config products newly addded and deleted from PIM
			delete ZPAP
			from ZnodePublishAssociatedProduct ZPAP
			where ZPAP.IsConfigurable = 1
			AND exists(select * from ZnodePimProductTypeAssociation ZPPD where ZPAP.ParentPimProductId = ZPPD.PimParentProductId )
			and exists(select * from #PimProductId PP where PP.Id = ZPAP.ParentPimProductId )

			Update ZPACP SET ZPACP.DisplayOrder = ZPLPD.DisplayOrder
			from ZnodePimProductTypeAssociation ZPLPD
			INNER JOIN ZnodePimCategoryProduct ZPCP ON ZPLPD.PimParentProductId = ZPCP.PimProductId
			INNER JOIN ZnodePimCategoryHierarchy ZPCH ON ZPCP.PimCategoryId = ZPCH.PimCategoryId
			INNER JOIN ZnodePublishAssociatedProduct ZPACP ON ZPCH.PimCatalogId = ZPACP.PimCatalogId and ZPLPD.PimParentProductId = ZPACP.ParentPimProductId AND ZPLPD.PimProductId = ZPACP.PimProductId
			where exists(select * from #PimProductId PP where PP.Id = ZPLPD.PimParentProductId )
			AND ZPACP.IsConfigurable = 1

			insert into ZnodePublishAssociatedProduct(PimCatalogId,ParentPimProductId,PimProductId,PublishStateId,IsConfigurable,IsBundle,IsGroup,IsAddOn,IsLink,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate, IsDefault)
			select distinct ZPCH.PimCatalogId, ZPLPD.PimParentProductId, ZPLPD.PimProductId, @PublishStateId, 1, 0, 0, 0, 0, ZPLPD.DisplayOrder, @UserId,@GetDate ,@UserId , @GetDate, ZPLPD.IsDefault
			from ZnodePimProductTypeAssociation ZPLPD
			INNER JOIN ZnodePimCategoryProduct ZPCP ON ZPLPD.PimParentProductId = ZPCP.PimProductId
			INNER JOIN ZnodePimCategoryHierarchy ZPCH ON ZPCP.PimCategoryId = ZPCH.PimCategoryId
			where exists(select * from #PimProductId PP where PP.Id = ZPLPD.PimParentProductId )
			and not exists(select * from ZnodePublishAssociatedProduct ZPACP where ZPCH.PimCatalogId = ZPACP.PimCatalogId and ZPLPD.PimParentProductId = ZPACP.ParentPimProductId AND ZPLPD.PimProductId = ZPACP.PimProductId  )
			--group by ZPCH.PimCatalogId, ZPLPD.PimParentProductId, ZPLPD.PimProductId, ZPLPD.DisplayOrder, ZPLPD.IsDefault
			-------

			DECLARE @Counter INT =1 ,@maxCountId INT = (SELECT max(RowId) FROM @TBL_LocaleId ) 

			CREATE TABLE #TBL_PublishCatalogId (PublishCatalogId INT,PublishProductId INT,PimProductId  INT   , VersionId INT ,LocaleId INT, PriceListId INT , PortalId INT ,MaxSmallWidth NVARCHAr(max)  )
			CREATE INDEX idx_#TBL_PublishCatalogIdPimProductId on #TBL_PublishCatalogId(PimProductId)
			CREATE INDEX idx_#TBL_PublishCatalogIdPimPublishCatalogId on #TBL_PublishCatalogId(PublishCatalogId)

			INSERT INTO #TBL_PublishCatalogId 
			SELECT Distinct ZPP.PublishCatalogId , ZPP.PublishProductId,PimProductId, 0,0 ,
			(SELECT TOP 1 PriceListId FROM ZnodePriceListPortal NT 
			INNER JOIN ZnodePimCatalog ZPC on ZPC.PortalId=NT.PortalId  
			ORDER BY NT.Precedence ASC ) ,TY.PortalId,
			(SELECT TOP 1  MAX(MaxSmallWidth) FROM ZnodeGlobalMediaDisplaySetting)
			FROM ZnodePublishProduct ZPP 
			LEFT JOIN ZnodePortalCatalog TY ON (TY.PublishCatalogId = ZPP.PublishCatalogId)
			WHERE (EXISTS (SELECT TOP 1 1 FROM #PimProductId SP WHERE SP.Id = ZPP.PimProductId  
			AND  (@PublishCatalogId IS NULL OR @PublishCatalogId = 0 ))
			OR  (ZPP.PublishCatalogId = @PublishCatalogId ))
			And Exists 
			(Select TOP 1 1 from ZnodePublishVersionEntity ZPCP  where ZPCP.ZnodeCatalogId  = ZPP.PublishCatalogId AND ZPCP.IsPublishSuccess =1 )

			Insert into #ProductIds (PimProductId,PublishProductId) Select distinct PimProductId,PublishProductId from #TBL_PublishCatalogId  

             Create TABLE #TBL_ZnodeTempPublish (PimProductId INT , AttributeCode VARCHAR(300) ,AttributeValue NVARCHAR(max) ) 			
			 DECLARE @TBL_AttributeVAlueLocale TABLE(PimProductId INT,PimAttributeId INT,ZnodePimAttributeValueLocaleId INT,LocaleId INT ,AttributeValue Nvarchar(1000) )


			 INSERT INTO @TBL_AttributeValueLocale (PimProductId ,PimAttributeId ,ZnodePimAttributeValueLocaleId ,LocaleId ,AttributeValue )
			 SELECT VIR.PimProductId,PimAttributeId,ZnodePimAttributeValueLocaleId,VIR.LocaleId, ''
			 FROM View_LoadManageProductInternal VIR
			 INNER JOIN #ProductIds ZPP ON (ZPP.PimProductId = VIR.PimProductId)
			 UNION ALL 
			 SELECT VIR.PimProductId,PimAttributeId,PimProductAttributeMediaId,ZPDE.LocaleId , ''
			 FROM ZnodePimAttributeValue  VIR
			 INNER JOIN ZnodePimProductAttributeMedia ZPDE ON (ZPDE.PimAttributeValueId = VIR.PimAttributeValueId )
			 WHERE EXISTS (SELECT TOP 1 1 FROM #ProductIds ZPP WHERE (ZPP.PimProductId = VIR.PimProductId) )
			 Union All 
			 SELECT VIR.PimProductId,VIR.PimAttributeId,ZPDVL.PimAttributeDefaultValueLocaleId,ZPDVL.LocaleId ,ZPDVL.AttributeDefaultValue
			   FROM ZnodePimAttributeValue  VIR
			 INNER JOIN ZnodePimAttribute D ON ( D.PimAttributeId=VIR.PimAttributeId AND D.IsPersonalizable =1 )
			 INNER JOIN ZnodePimAttributeDefaultValue ZPADV ON ZPADV.PimAttributeId = D.PimAttributeId
			 INNER JOIN ZnodePimAttributeDefaultValueLocale ZPDVL   on (ZPADV.PimAttributeDefaultValueId = ZPDVL.PimAttributeDefaultValueId)
			 WHERE ( ZPDVL.LocaleId = @DefaultLocaleId OR ZPDVL.LocaleId = @LocaleId )
			 AND EXISTS(SELECT TOP 1 1 FROM #ProductIds ZPP WHERE (ZPP.PimProductId = VIR.PimProductId) )
			 Union All 
			 SELECT VIR.PimProductId,VIR.PimAttributeId,'','' ,''
			 FROM ZnodePimAttributeValue  VIR
			 INNER JOIN ZnodePimAttribute D ON ( D.PimAttributeId=VIR.PimAttributeId AND D.IsPersonalizable =1 )
			 WHERE  EXISTS(SELECT TOP 1 1 FROM #ProductIds ZPP WHERE (ZPP.PimProductId = VIR.PimProductId) )
		
				--insert INTO #ZnodePrice
				SELECT RetailPrice,SalesPrice,ZC.CurrencyCode,ZCC.CultureCode ,ZCC.Symbol CurrencySuffix,TYU.PublishProductId ,isnull(ZPC1.IsAllowIndexing,0) as IsAllowIndexing
				into #ZnodePrice
				FROM ZnodePrice ZP 
				INNER JOIN ZnodePriceList ZPL ON (ZPL.PriceListId = ZP.PriceListId)
				INNER JOIN ZnodeCurrency ZC oN (ZC.CurrencyId = ZPL.CurrencyId )
				INNER JOIN ZnodeCulture ZCC ON (ZCC.CultureId = ZPL.CultureId)
				INNER JOIN ZnodePublishProductDetail TY ON (TY.SKU = ZP.SKU ) 
				INNER JOIN ZnodePublishProduct TYU ON (TYU.PublishProductId = TY.PublishProductId)
				INNER JOIN ZnodePublishCatalog ZPC ON (TYU.PublishCatalogId = ZPC.PublishCatalogId)
				INNER JOIN ZnodePimCatalog ZPC1 ON (ZPC.PimCatalogId = ZPC1.PimCatalogId)
				WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PublishCatalogId TYUR WHERE TYUR.PriceListId = ZPL.PriceListId AND TYUR.PublishCatalogId = TYU.PublishCatalogId
				AND TYU.PublishProductId = TYUR.PublishProductId)
				AND TY.LocaleId = dbo.Fn_GetDefaultLocaleId()
				AND EXISTS (SELECT TOP 1 1 FROM ZnodePriceListPortal ZPLP 
				INNER JOIN ZnodePimCatalog ZPC on ZPC.PortalId=ZPLP.PortalId WHERE ZPLP.PriceListId=ZP.PriceListId )
				
				--insert INTO #ProductSKU
				SELECT ZCSD.SEOUrl , ZCDL.SEODescription,ZCDL.SEOKeywords ,ZCDL.SEOTitle, TYU.PublishProductId ,isnull(ZPC1.IsAllowIndexing,0) as IsAllowIndexing
				INTO #ProductSKU
				FROM ZnodeCMSSEODetail ZCSD 
				INNER JOIN ZnodeCMSSEODetailLocale ZCDL ON (ZCDL.CMSSEODetailId = ZCSD.CMSSEODetailId)
				INNER JOIN ZnodePublishProductDetail TY ON (TY.SKU = ZCSD.SEOCode AND ZCDL.LocaleId = TY.LocaleId) 
				INNER JOIN ZnodePublishProduct TYU ON (TYU.PublishProductId = TY.PublishProductId)
				INNER JOIN ZnodePublishCatalog ZPC ON (TYU.PublishCatalogId = ZPC.PublishCatalogId)
				INNER JOIN ZnodePimCatalog ZPC1 ON (ZPC.PimCatalogId = ZPC1.PimCatalogId)
				WHERE CMSSEOTypeId = (SELECT TOP 1 CMSSEOTypeId FROM ZnodeCMSSEOType WHERE Name = 'Product') 
				AND EXISTS (SELECT TOP 1 1  FROM #TBL_PublishCatalogId TYUR WHERE  TYUR.PublishCatalogId = TYU.PublishCatalogId
				AND TYU.PublishProductId = TYUR.PublishProductId)
				AND ZCDL.LocaleId = dbo.Fn_GetDefaultLocaleId()
				and ZCSD.PortalId = isnull(ZPC1.PortalId,0)

			
				--insert INTO #ProductImages
				SELECT  TUI.PublishCatalogId, TYU.PublishProductId , @DomainUrl +'Catalog/'  + CAST(Max(ZPC1.PortalId) AS VARCHAr(100)) + '/'+ CAST(Isnull(Max(TUI.MaxSmallWidth),'') AS VARCHAR(100)) + '/' + Isnull(RT.MediaPath,'') AS ImageSmallPath    
				,isnull(ZPC1.IsAllowIndexing,0) as IsAllowIndexing
				INTO #ProductImages
				FROM ZnodePimAttributeValue ZPAV 
				INNER JOIN ZnodePublishProduct TYU ON (TYU.PimProductId  = ZPAV.PimProductId)
				INNER JOIN ZnodePimProductAttributeMedia  RT ON ( RT.PimAttributeValueId = ZPAV.PimAttributeValueId )
				INNER JOIN #TBL_PublishCatalogId TUI ON (TUI.PublishProductId = TYU.PublishProductId AND TUI.PublishCatalogId = TYU.PublishCatalogId
						 )--AND  TUI.LocaleId = dbo.Fn_GetDefaultLocaleId()
				INNER JOIN ZnodePublishCatalog ZPC ON (TYU.PublishCatalogId = ZPC.PublishCatalogId)
				INNER JOIN ZnodePimCatalog ZPC1 ON (ZPC.PimCatalogId = ZPC1.PimCatalogId)
				WHERE  RT.LocaleId = dbo.Fn_GetDefaultLocaleId()
				AND ZPAV.PimAttributeId = (SELECT TOp 1 PimAttributeId FROM ZnodePimAttribute WHERE AttributeCode = 'ProductImage')
				group by TUI.PublishCatalogId, TYU.PublishProductId ,isnull(RT.MediaPath,''),isnull(ZPC1.IsAllowIndexing,0) 
		  -- end
	  
WHILE @Counter <= @maxCountId
BEGIN
 SET @LocaleId = (SELECT TOP 1 LocaleId FROM @TBL_LocaleId WHERE RowId = @Counter)

  INSERT INTO #PimProductAttributeJson 
  SELECT PimAttributeJsonId ,PimAttributeId,LocaleId
  FROM ZnodePimAttributeJSON
  WHERE LocaleId = @LocaleId
  
  INSERT INTO #PimProductAttributeJson 
  SELECT PimAttributeJsonId ,PimAttributeId,LocaleId
  FROM ZnodePimAttributeJSON ZPAX
  WHERE ZPAX.LocaleId = @DefaultLocaleId  
  AND NOT EXISTS (SELECT TOP 1 1 FROM #PimProductAttributeJson ZPAXI WHERE ZPAXI.PimAttributeId = ZPAX.PimAttributeId )

  INSERT INTO @PimDefaultValueLocale
  SELECT PimAttributeDefaultJsonId,PimAttributeDefaultValueId,LocaleId 
  FROM ZnodePimAttributeDefaultJson
  WHERE localeId = @LocaleId

  INSERT INTO @PimDefaultValueLocale 
   SELECT PimAttributeDefaultJsonId,PimAttributeDefaultValueId,LocaleId 
  FROM ZnodePimAttributeDefaultJson ZX
  WHERE localeId = @DefaultLocaleId
  AND NOT EXISTS (SELECT TOP 1 1 FROM @PimDefaultValueLocale TRTR WHERE TRTR.PimAttributeDefaultValueId = ZX.PimAttributeDefaultValueId)
  
 
  --DECLARE @TBL_AttributeVAlue TABLE(PimProductId INT,PimAttributeId INT,ZnodePimAttributeValueLocaleId INT  )
  --DECLARE @TBL_CustomeFiled TABLE (PimCustomeFieldJsonId INT ,CustomCode VARCHAR(300),PimProductId INT ,LocaleId INT )
  CREATE TABLE #TBL_CustomeFiled  (PimCustomeFieldJsonId INT ,CustomCode VARCHAR(300),PimProductId INT ,LocaleId INT )
  CREATE TABLE #TBL_AttributeVAlue (PimProductId INT,PimAttributeId INT,ZnodePimAttributeValueLocaleId INT  )



  INSERT INTO #TBL_CustomeFiled (PimCustomeFieldJsonId,PimProductId ,LocaleId,CustomCode)
  SELECT  PimCustomeFieldJsonId,RTR.PimProductId ,RTR.LocaleId,CustomCode
  FROM ZnodePimCustomeFieldJson RTR 
  INNER JOIN #ProductIds ZPP ON (ZPP.PimProductId = RTR.PimProductId)
  WHERE RTR.LocaleId = @LocaleId
 

  INSERT INTO #TBL_CustomeFiled (PimCustomeFieldJsonId,PimProductId ,LocaleId,CustomCode)
  SELECT  Distinct  PimCustomeFieldJsonId,ITR.PimProductId ,ITR.LocaleId,CustomCode
  FROM ZnodePimCustomeFieldJson ITR
  INNER JOIN #ProductIds ZPP ON (ZPP.PimProductId = ITR.PimProductId)
  WHERE ITR.LocaleId = @DefaultLocaleId
  AND NOT EXISTS (SELECT TOP 1 1 FROM #TBL_CustomeFiled TBL  WHERE ITR.CustomCode = TBL.CustomCode AND ITR.PimProductId = TBL.PimProductId)
  

    INSERT INTO #TBL_AttributeVAlue (PimProductId ,PimAttributeId ,ZnodePimAttributeValueLocaleId )
    SELECT Distinct  PimProductId,PimAttributeId,ZnodePimAttributeValueLocaleId
	FROM @TBL_AttributeVAlueLocale
    WHERE LocaleId = @LocaleId

    
	INSERT INTO #TBL_AttributeVAlue(PimProductId ,PimAttributeId ,ZnodePimAttributeValueLocaleId )
	SELECT VI.PimProductId,PimAttributeId,ZnodePimAttributeValueLocaleId
	FROM @TBL_AttributeVAlueLocale VI 
    WHERE VI.LocaleId = @DefaultLocaleId 
	AND NOT EXISTS (SELECT TOP 1 1 FROM #TBL_AttributeVAlue  CTE WHERE CTE.PimProductId = VI.PimProductId AND CTE.PimAttributeId = VI.PimAttributeId )
 
	------------Facet Merging Patch --------------
	IF OBJECT_ID('tempdb..#PimChildProductFacets') is not null
	BEGIN 
		DROP TABLE #PimChildProductFacets
	END 

	IF OBJECT_ID('tempdb..#PimAttributeDefaultXML') is not null
	BEGIN 
		DROP TABLE #PimAttributeDefaultXML
	END
	----Getting parent facets data
	Select  ZPPADV.PimAttributeDefaultValueId, ZPAV_Parent.PimAttributeValueId, ZPPADV.LocaleId
	Into #PimChildProductFacets
	from ZnodePimAttributeValue ZPAV_Parent
	inner join ZnodePimProductAttributeDefaultValue ZPPADV ON ZPAV_Parent.PimAttributeValueId = ZPPADV.PimAttributeValueId 
	where exists(select * from #ProductIds ZPPC where ZPAV_Parent.PimProductId = ZPPC.PimProductId )

	----Getting child facets for merging	
	insert into #PimChildProductFacets	  
	Select distinct ZPPADV.PimAttributeDefaultValueId, ZPAV_Parent.PimAttributeValueId, ZPPADV.LocaleId
	from ZnodePimAttributeValue ZPAV_Parent
	inner join ZnodePimProductTypeAssociation ZPPTA ON ZPAV_Parent.PimProductId = ZPPTA.PimParentProductId
	inner join ZnodePimAttributeValue ZPAV_Child ON ZPPTA.PimProductId = ZPAV_Child.PimProductId AND ZPAV_Parent.PimAttributeId = ZPAV_Child.PimAttributeId
	inner join ZnodePimProductAttributeDefaultValue ZPPADV ON ZPAV_Child.PimAttributeValueId = ZPPADV.PimAttributeValueId 
	where exists(select * from ZnodePimFrontendProperties ZPFP where ZPAV_Parent.PimAttributeId = ZPFP.PimAttributeId and ZPFP.IsFacets = 1)
	and exists(select * from #ProductIds ZPPC where ZPAV_Parent.PimProductId = ZPPC.PimProductId )
	and not exists(select * from ZnodePimProductAttributeDefaultValue ZPPADV1 where ZPAV_Parent.PimAttributeValueId = ZPPADV1.PimAttributeValueId 
		            and ZPPADV1.PimAttributeDefaultValueId = ZPPADV.PimAttributeDefaultValueId )

	----Merging childs facet attribute Default value XML for parent
	Create table #PimAttributeDefaultXML (DefaultValueJson nvarchar(max), PimAttributeValueId int, LocaleId int )

    Insert into #PimAttributeDefaultXML (DefaultValueJson , PimAttributeValueId , LocaleId )
	select  ZPADX.DefaultValueJson, ZPPADV.PimAttributeValueId, ZPPADV.LocaleId
	from #PimChildProductFacets ZPPADV		  
	inner join ZnodePimAttributeDefaultJson ZPADX ON ( ZPPADV.PimAttributeDefaultValueId = ZPADX.PimAttributeDefaultValueId )--AND ZPPADV.LocaleId = ZPADX.LocaleId)
	INNER JOIN @PimDefaultValueLocale GH ON (GH.PimAttributeDefaultJsonId = ZPADX.PimAttributeDefaultJsonId)
	
	IF ( @LocaleId <> @DefaultLocaleId )
	BEGIN
		Insert into #PimAttributeDefaultXML (DefaultValueJson , PimAttributeValueId , LocaleId )
		Select  ZPADX.DefaultValueJson, ZPPADV.PimAttributeValueId, @LocaleId
		from #PimChildProductFacets ZPPADV		  
		inner join ZnodePimAttributeDefaultJson ZPADX ON ( ZPPADV.PimAttributeDefaultValueId = ZPADX.PimAttributeDefaultValueId )--AND ZPPADV.LocaleId = ZPADX.LocaleId)
		INNER JOIN @PimDefaultValueLocale GH ON (GH.PimAttributeDefaultJsonId = ZPADX.PimAttributeDefaultJsonId)
		Where Not exists (select TOP 1 1 From #PimAttributeDefaultXML X Where X.LocaleId = @LocaleId and 
		 ZPPADV.PimAttributeValueId = X.PimAttributeValueId) and GH.LocaleId = @DefaultLocaleId
	END
	------------Facet Merging Patch --------------   

	 IF OBJECT_ID('tempdb..#View_LoadManageProductInternal') is not null
	 BEGIN 
		DROP TABLE #View_LoadManageProductInternal
	 END 

	SELECT a.PimProductId ,b.AttributeValue as AttributeValue , b.LocaleId  ,a.PimAttributeId,c.AttributeCode ,b.ZnodePimAttributeValueLocaleId
	into #View_LoadManageProductInternal
	FROM ZnodePimAttributeValue a 
	INNER JOIN  ZnodePimAttributeValueLocale b ON ( b.PimAttributeValueId = a.PimAttributeValueId )
	INNER JOIN ZnodePimAttribute c ON ( c.PimAttributeId=a.PimAttributeId )
	INNER JOIN ZnodePimAttributeJSON c1   ON (c1.PimAttributeId = a.PimAttributeId )
	INNER JOIN #PimProductAttributeJson b1 ON (b1.PimAttributeJsonId = c1.PimAttributeJsonId )
	INNER JOIN #TBL_AttributeVAlue CTE ON (Cte.PimAttributeId = a.PimAttributeId AND Cte.ZnodePimAttributeValueLocaleId = b.ZnodePimAttributeValueLocaleId)
	UNION ALL
	SELECT a.PimProductId,ZPPATAV.AttributeValue AS AttributeValue  
	,ZPPATAV.LocaleId,a.PimAttributeId,c.AttributeCode  ,ZPPATAV.PimProductAttributeTextAreaValueId
	FROM ZnodePimAttributeValue a 
	INNER JOIN ZnodePimProductAttributeTextAreaValue ZPPATAV ON (ZPPATAV.PimAttributeValueId = a.PimAttributeValueId )
	INNER JOIN ZnodePimAttribute c ON ( c.PimAttributeId=a.PimAttributeId )
	INNER JOIN ZnodePimAttributeJSON c1   ON (c1.PimAttributeId = a.PimAttributeId )
	INNER JOIN #PimProductAttributeJson b1 ON (b1.PimAttributeJsonId = c1.PimAttributeJsonId )
	INNER JOIN #TBL_AttributeVAlue CTE ON (Cte.PimAttributeId = a.PimAttributeId AND Cte.ZnodePimAttributeValueLocaleId = ZPPATAV.PimProductAttributeTextAreaValueId)
	
	INSERT INTO #TBL_ZnodeTempPublish  
		SELECT  a.PimProductId,a.AttributeCode , 
			JSON_MODIFY (JSON_MODIFY (Json_Query( c.AttributeJSON  ) , '$.AttributeValues' ,  
			ISNULL(a.AttributeValue,'') ) ,'$.SelectValues',Json_Query('[]'))
			AS 'AttributeValue'
		FROM #View_LoadManageProductInternal a 
		INNER JOIN ZnodePimAttributeJSON c   ON (c.PimAttributeId = a.PimAttributeId )
		INNER JOIN #PimProductAttributeJson b ON (b.PimAttributeJsonId = c.PimAttributeJsonId )
		INNER JOIN #TBL_AttributeVAlue CTE ON (Cte.PimAttributeId = a.PimAttributeId AND Cte.ZnodePimAttributeValueLocaleId = a.ZnodePimAttributeValueLocaleId)
	UNION ALL 
			SELECT  a.PimProductId,c.AttributeCode , 
			JSON_MODIFY (JSON_MODIFY (Json_Query( c.AttributeJSON  ) , '$.AttributeValues' ,  
			ISNULL(TAVL.AttributeValue,'') ) ,'$.SelectValues',Json_Query('[]'))
			AS 'AttributeValue'
		FROM ZnodePimAttributeValue  a 
		INNER JOIN ZnodePimAttributeJSON c   ON (c.PimAttributeId = a.PimAttributeId )
		INNER JOIN #PimProductAttributeJson b ON (b.PimAttributeJsonId = c.PimAttributeJsonId )
		INNER JOIN ZnodePImAttribute ZPA  ON (ZPA.PimAttributeId = a.PimAttributeId)
		INNER JOIN #ProductIds ZPP ON (ZPP.PimProductId = a.PimProductId)
		Inner JOIN @TBL_AttributeVAlueLocale TAVL ON  (c.PimAttributeId = TAVL.PimAttributeId  and ZPP.PimProductId = TAVL.PimProductId )
		WHERE ZPA.IsPersonalizable = 1 
		AND NOT EXISTS ( SELECT TOP 1 1 FROM ZnodePimAttributeValueLocale q WHERE q.PimAttributeValueId = a.PimAttributeValueId) 
	UNION ALL 
		SELECT THB.PimProductId,THB.CustomCode,
		--'<Attributes><AttributeEntity>'+CustomeFiledJson +'</AttributeEntity></Attributes>' 
		JSON_MODIFY (Json_Query( CustomeFiledJson ) ,'$.SelectValues',Json_Query('[]')) 
		FROM ZnodePimCustomeFieldJson THB 
		INNER JOIN #TBL_CustomeFiled TRTE ON (TRTE.PimCustomeFieldJsonId = THB.PimCustomeFieldJsonId)
		UNION ALL 
		SELECT ZPAV.PimProductId,c.AttributeCode,
			JSON_MODIFY (JSON_MODIFY (c.AttributeJson,'$.AttributeValues',''), '$.SelectValues',
			Isnull((SELECT 
			Isnull(JSON_VALUE(DefaultValueJson, '$.Code'),'') Code 
			,Isnull(JSON_VALUE(DefaultValueJson, '$.LocaleId'),0) LocaleId
			,IsNull(JSON_VALUE(DefaultValueJson, '$.Value'),'') Value
			,IsNull(JSON_VALUE(DefaultValueJson, '$.AttributeDefaultValue'),'') AttributeDefaultValue
			,Isnull(JSON_VALUE(DefaultValueJson, '$.DisplayOrder'),0) DisplayOrder
			,Isnull(JSON_VALUE(DefaultValueJson, '$.IsEditable'),'false') IsEditable
			,Isnull(JSON_VALUE(DefaultValueJson, '$.SwatchText'),'') SwatchText
			,Isnull(JSON_VALUE(DefaultValueJson, '$.Path'),'') Path
			FROM #PimAttributeDefaultXML ZPADV
			WHERE (ZPADV.PimAttributeValueId = ZPAV.PimAttributeValueId) For JSON Auto 
			),'[]') 
		)  AttributeValue
		FROM ZnodePimAttributeValue ZPAV  With (NoLock)
		INNER JOIN ZnodePimAttributeJSON c   ON (c.PimAttributeId = ZPAV.PimAttributeId )
		INNER JOIN #PimProductAttributeJson b ON (b.PimAttributeJsonId = c.PimAttributeJsonId )
		INNER JOIN #ProductIds ZPP ON (ZPP.PimProductId = ZPAV.PimProductId)
		WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePimProductAttributeDefaultValue ZPADVL 
		WHERE ZPADVL.PimAttributeValueId = ZPAV.PimAttributeValueId)
	UNION ALL 
		SELECT DISTINCT  ZPAV.PimProductId,c.AttributeCode,
			JSON_MODIFY (JSON_MODIFY (Json_Query( c.AttributeJson  ) , '$.AttributeValues',  
			ISNULL((Select stuff( 
			(SELECT ','+ZPPG.MediaPath 
			FROM ZnodePimProductAttributeMedia ZPPG INNER JOIN  #TBL_AttributeVAlue TBLV ON 
			(	TBLV.PimProductId=  ZPAV.PimProductId AND TBLV.PimAttributeId = ZPAV.PimAttributeId )
			WHERE ZPPG.PimProductAttributeMediaId = TBLV.ZnodePimAttributeValueLocaleId
			FOR XML PATH(''),Type).value('.', 'varchar(max)'), 1, 1, '')),'') ) ,'$.SelectValues',Json_Query('[]'))   
			AS 'AttributeEntity'
		FROM ZnodePimAttributeValue ZPAV 
		INNER JOIN ZnodePimAttributeJSON c   ON (c.PimAttributeId = ZPAV.PimAttributeId )
		INNER JOIN #PimProductAttributeJson b ON (b.PimAttributeJsonId = c.PimAttributeJsonId )
		INNER JOIN #ProductIds ZPP ON (ZPP.PimProductId = ZPAV.PimProductId)
		WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePimProductAttributeMedia ZPADVL WHERE ZPADVL.PimAttributeValueId = ZPAV.PimAttributeValueId)
	UNION ALL 
		SELECT ZPLP.PimParentProductId ,c.AttributeCode, 
			JSON_MODIFY( JSON_Modify(c.AttributeJson , '$.AttributeValues' , 
			ISNULL(SUBSTRING((SELECT ','+cast( LP.SKU as varchar(600)) 
							 FROM #LinkProduct LP
							 WHERE LP.PimParentProductId = ZPLP.PimParentProductId 
							 AND LP.PimAttributeId = ZPLP.PimAttributeId
		FOR XML PATH ('') ),2,4000),'')),'$.SelectValues',Json_Query('[]'))   
	
		FROM ZnodePimLinkProductDetail ZPLP 
		INNER JOIN #TBL_PublishCatalogId ZPP ON (ZPP.PimProductId = ZPLP.PimParentProductId)
		INNER JOIN ZnodePimAttributeJSON c   ON (c.PimAttributeId = ZPLP.PimAttributeId )
		INNER JOIN #PimProductAttributeJson b ON (b.PimAttributeJsonId = c.PimAttributeJsonId )
		GROUP BY ZPLP.PimParentProductId , ZPP.PublishProductId  ,ZPLP.PimAttributeId,c.AttributeCode,c.AttributeJson,ZPP.PublishCatalogId
	UNION ALL 
		SELECT ZPAV.PimProductId,'DefaultSkuForConfigurable' ,
			JSON_MODIFY( JSON_Modify(
			REPLACE(REPLACE (c.AttributeJson,'ProductType','DefaultSkuForConfigurable'),'Product Type','Default Sku For Configurable'),
			'$.AttributeValues' , 
			ISNULL(SUBSTRING((SELECT ','+CAST(adl.AttributeValue AS VARCHAR(50)) 
		FROM ZnodePimAttributeValue ad 
		inner join ZnodePimAttributeValueLocale adl on ad.PimattributeValueId = adl.PimAttributeValueId
		INNER JOIN ZnodePimProductTypeAssociation yt ON (yt.PimProductId = ad.PimProductId)
		WHERE EXISTS (select * from #ProductIds p where yt.PimParentProductId = p.PimProductId)
		AND Ad.PimAttributeId =(select top 1 PimAttributeId from ZnodePimAttribute zpa where zpa.AttributeCode = 'SKU')
		AND yt.PimParentProductId = ZPAV.PimProductId 
		ORDER BY yt.DisplayOrder , yt.PimProductTypeAssociationId ASC FOR XML PATH ('') ),2,4000),'')),'$.SelectValues',Json_Query('[]'))   
		FROM ZnodePimAttributeValue ZPAV  
		INNER JOIN ZnodePimAttributeJSON c   ON (c.PimAttributeId = ZPAV.PimAttributeId )
		INNER JOIN #ProductIds ZPP ON (ZPP.PimProductId = ZPAV.PimProductId)
		WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePimProductAttributeDefaultValue ZPADVL 
		INNER JOIN ZnodePimAttributeDefaultValue dr ON (dr.PimAttributeDefaultValueId = ZPADVL.PimAttributeDefaultValueId)
		WHERE ZPADVL.PimAttributeValueId = ZPAV.PimAttributeValueId
		AND dr.AttributeDefaultValueCode= 'ConfigurableProduct' 
		)
		AND EXISTS (select * from #PimProductAttributeJson b where b.PimAttributeJsonId = c.PimAttributeJsonId)
		AND c.AttributeCode = 'ProductType' 
	UNION ALL
		SELECT DISTINCT  UOP.PimProductId,c.AttributeCode,
			JSON_MODIFY (JSON_MODIFY (c.AttributeJson,'$.AttributeValues',''), '$.SelectValues',
			Isnull((SELECT  DISTINCT 
			Isnull(JSON_VALUE(AA.DefaultValueJson, '$.Code'),'') Code 
			,Isnull(JSON_VALUE(AA.DefaultValueJson, '$.LocaleId'),0) LocaleId
			,Isnull(JSON_VALUE(AA.DefaultValueJson, '$.Value'),'') Value
			,Isnull(JSON_VALUE(AA.DefaultValueJson, '$.AttributeDefaultValue'),'') AttributeDefaultValue
			,Isnull(JSON_VALUE(AA.DefaultValueJson, '$.DisplayOrder'),0) DisplayOrder
			,Isnull(JSON_VALUE(AA.DefaultValueJson, '$.IsEditable'),'false') IsEditable
			,Isnull(JSON_VALUE(AA.DefaultValueJson, '$.SwatchText'),'') SwatchText
			,Isnull(JSON_VALUE(AA.DefaultValueJson, '$.Path'),'') Path 
			,ISNULL(ZPA.DisplayOrder,0)  AS VariantDisplayOrder 
			,ISNULL(ZPAVL_SKU.AttributeValue,'')   AS VariantSKU 
			--,Isnull(ZM.Path,'') 
		,ZM.Path AS VariantImagePath 
		FROM ZnodePimAttributeDefaultJson AA 
		INNER JOIN ZnodePimProductAttributeDefaultValue ZPADV ON ( ZPADV.PimAttributeDefaultValueId = AA.PimAttributeDefaultValueId )
		INNER JOIN ZnodePimAttributeValue ZPAV1 ON (ZPAV1.PimAttributeValueId= ZPADV.PimAttributeValueId )
		-- check/join for active variants 
		INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimProductId =ZPAV1.PimProductId)
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON (ZPAV.PimAttributevalueid = ZPAVL.PimAttributeValueId AND ZPAVL.AttributeValue = 'True')
		INNER JOIN ZnodePimProductTypeAssociation YUP ON (YUP.PimProductId = ZPAV1.PimProductId)
		-- SKU
		INNER JOIN ZnodePimAttributeValue ZPAV_SKU ON(YUP.PimProductId = ZPAV_SKU.PimProductId)
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL_SKU ON (ZPAVL_SKU.PimAttributeValueId = ZPAV_SKU.PimAttributeValueId)
		LEFT JOIN ZnodePimAttribute ZPA ON (ZPA.PimattributeId = ZPAV1.PimAttributeId)
		--VariantImagePath
		LEFT  JOIN ZnodePimAttributeValue ZPAV12 ON (ZPAV12.PimProductId= YUP.PimProductId  AND ZPAV12.PimAttributeId = @PimMediaAttributeId ) 
		LEFT JOIN ZnodePimProductAttributeMedia ZPAVM ON (ZPAVM.PimAttributeValueId= ZPAV12.PimAttributeValueId ) 
		LEFT JOIN ZnodeMedia ZM ON (ZM.MediaId = ZPAVM.MediaId)
		WHERE (YUP.PimParentProductId  = UOP.PimProductId AND ZPAV1.pimAttributeId = UOP.PimAttributeId )
		-- Active Variants
		AND ZPAV.PimAttributeId = (SELECT TOP 1 PimAttributeId FROM ZnodePimAttribute WHERE AttributeCode = 'IsActive')
		-- VariantSKU
		AND ZPAV_SKU.PimAttributeId = (SELECT PimAttributeId FROM ZnodePimAttribute WHERE AttributeCode = 'SKU')
		For JSON Auto 
		),'[]')) 
				
		--</AttributeEntity></Attributes>' 
		FROM ZnodePimConfigureProductAttribute UOP 
		INNER JOIN ZnodePimAttributeJSON c   ON (c.PimAttributeId = UOP.PimAttributeId )
		WHERE  exists(select * from #TBL_PublishCatalogId PPCP1 where UOP.PimProductId = PPCP1.PimProductId )
		AND EXISTS (select * from #PimProductAttributeJson b where b.PimAttributeJsonId = c.PimAttributeJsonId)

			-------------configurable attribute 
			---------------------------------------------------------------------
			
			If (@RevisionType like '%Preview%'  OR @RevisionType like '%Production%'  ) 
				Delete from ZnodePublishProductEntity where SKU  in (select SKU from #TBL_PublishCatalogId
				A inner join ZnodePublishProductDetail B on A.PublishProductId   =B.PublishProductId   )
				AND LocaleId = @LocaleId
				AND VersionId in (SELECT VersionId FROM ZnodePublishVersionEntity where RevisionType = 'PREVIEW')
			If (@RevisionType like '%Production%' OR @RevisionType = 'None')
				Delete from ZnodePublishProductEntity where SKU  in (select SKU from #TBL_PublishCatalogId
				A inner join ZnodePublishProductDetail B on A.PublishProductId   =B.PublishProductId   )
				AND LocaleId = @LocaleId
				AND VersionId in (SELECT VersionId FROM ZnodePublishVersionEntity where RevisionType = 'PRODUCTION')

			Insert into ZnodePublishProductEntity (
					VersionId, --1
					IndexId, --2 
					ZnodeProductId,ZnodeCatalogId, --3
					SKU,LocaleId, --4 
					Name,ZnodeCategoryIds, --5
					IsActive, -- 6 
					Attributes, -- 7 
					Brands, -- 9
					CategoryName, --9
					CatalogName,DisplayOrder, --10 
					RevisionType,AssociatedProductDisplayOrder, --11
					ProductIndex,--12
					SalesPrice,RetailPrice,CultureCode,CurrencySuffix,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower --13 
					)
 			SELECT distinct ZPVE.VersionId, --1 
			CAST(ISNULL(ZPCP.ProductIndex,1) AS VARCHAr(100)) + CAST(ISNULL(ZPC.PublishCategoryId,'')  AS VARCHAR(50))  + 
			CAST(Isnull(ZPP.PublishCatalogId ,'')  AS VARCHAR(50)) + CAST( @LocaleId AS VARCHAR(50)) IndexId, --2 
			CAST(ZPP.PublishProductId AS VARCHAR(50)) PublishProductId,CAST(ZPP.PublishCatalogId  AS VARCHAR(50)) PublishCatalogId,  --3 
			CAST(ISNULL(ZPPDFG.SKU ,'') AS NVARCHAR(2000)) SKU,CAST( Isnull(@LocaleId ,'') AS VARCHAR(50)) LocaleId, -- 4 
			CAST(isnull(ZPPDFG.ProductName,'') AS NVARCHAR(2000) )  ProductName ,CAST(ISNULL(ZPCD.PublishCategoryId,'')  AS VARCHAR(50)) PublishCategoryId  -- 5 
			,CAST(ISNULL(ZPPDFG.IsActive ,'0') AS VARCHAR(50)) IsActive , --6 
			'[' +
				(Select STUFF((SELECT distinct ','+ AttributeValue from #TBL_ZnodeTempPublish TY WHERE TY.PimProductId = ZPP.PimProductId   
				FOR XML Path ('')) ,1,1,'')  ) 
			+ ']' xmlvalue,  -- 7 
			'[]' Brands  --8 
			,CAST(isnull(PublishCategoryName,'') AS NVARCHAR(2000)) CategoryName  --9
			,CAST(Isnull(CatalogName,'')  AS NVARCHAR(2000)) CatalogName,CAST(ISNULL(ZPCCF.DisplayOrder,'') AS VARCHAR(50)) DisplayOrder  -- 10  
			,ZPVE.RevisionType RevisionType , 0 AssociatedProductDisplayOrder,-- pending  -- 11 
			Isnull(ZPCP.ProductIndex,1),  -- 12 

			Case When TBZP.IsAllowIndexing = 1 then  ISNULL(CAST(SalesPrice  AS varchar(500)),'') else '' end SalesPrice , 
			Case When TBZP.IsAllowIndexing = 1 then  ISNULL(CAST(RetailPrice  AS varchar(500)),'') else '' end RetailPrice , 
			Case When TBZP.IsAllowIndexing = 1 then  ISNULL(CultureCode ,'') else '' end CultureCode , 
			Case When TBZP.IsAllowIndexing = 1 then  ISNULL(CurrencySuffix ,'') else '' end CurrencySuffix , 
			Case When TBZP.IsAllowIndexing = 1 then  ISNULL(CurrencyCode ,'') else '' end CurrencyCode , 
			Case When TBZP.IsAllowIndexing = 1 then  ISNULL(SEODescription,'') else '' end SEODescriptionForIndex,
			Case When TBZP.IsAllowIndexing = 1 then  ISNULL(SEOKeywords,'') else '' end SEOKeywords,
			Case When TBZP.IsAllowIndexing = 1 then  ISNULL(SEOTitle,'') else '' end SEOTitle,
			Case When TBZP.IsAllowIndexing = 1 then  ISNULL(SEOUrl ,'') else '' end SEOUrl,
			Case When TBZP.IsAllowIndexing = 1 then  ISNULL(ImageSmallPath,'') else '' end ImageSmallPath,
			CAST(ISNULL(LOWER(ZPPDFG.SKU) ,'') AS NVARCHAR(100)) Lower_SKU -- 13
	FROM  #TBL_PublishCatalogId zpp
	INNER JOIN ZnodePublishCatalog ZPCV ON (ZPCV.PublishCatalogId = ZPP.PublishCatalogId)
	INNER JOIN ZnodePublishProductDetail ZPPDFG ON (ZPPDFG.PublishProductId =  ZPP.PublishProductId)
	INNER JOIN ZnodePublishVersionEntity ZPVE ON (ZPVE.ZnodeCatalogId  = ZPP.PublishCatalogId AND ZPVE.IsPublishSuccess =1 AND ZPVE.LocaleId = @LocaleId )
	LEFT JOIN #ZnodePrice TBZP ON (TBZP.PublishProductId = ZPP.PublishProductId)
	LEFT JOIN #ProductSKU TBPS ON (TBPS.PublishProductId = ZPP.PublishProductId)
	LEFT JOIN #ProductImages TBPI ON (TBPI.PublishProductId = ZPP.PublishProductId  )
	LEFT JOIN ZnodePublishCategoryProduct ZPCP ON (ZPCP.PublishProductId = ZPP.PublishProductId AND ZPCP.PublishCatalogId = ZPP.PublishCatalogId)
	LEFT JOIN ZnodePublishCategory ZPC ON (ZPC.PublishCatalogId = ZPCP.PublishCatalogId AND   ZPC.PublishCategoryId = ZPCP.PublishCategoryId)
	LEFT JOIN ZnodePimCategoryProduct ZPCCF ON (ZPCCF.PimCategoryId = ZPC.PimCategoryId  AND ZPCCF.PimProductId = ZPP.PimProductId )
	LEFT JOIN ZnodePimCategoryHierarchy ZPCH ON (ZPCH.PimCatalogId = ZPCV.PimCatalogId AND  ZPCH.PimCategoryHierarchyId =  ZPC.PimCategoryHierarchyId) 
	LEFT JOIN ZnodePublishCategoryDetail ZPCD ON (ZPCD.PublishCategoryId = ZPCP.PublishCategoryId AND ZPCD.LocaleId = @LocaleId )
	WHERE ZPPDFG.LocaleId = @LocaleId
		--AND zpp.LocaleId = @LocaleId
	AND 
		(
			(ZPVE.RevisionType =  Case when  (@RevisionType like '%Preview%'  OR @RevisionType like '%Production%' ) then 'Preview' End ) 
			OR 
			(ZPVE.RevisionType =  Case when (@RevisionType like '%Production%' OR @RevisionType = 'None') then  'Production'  end )
		)


	DELETE FROM #TBL_ZnodeTempPublish
	IF OBJECT_ID('tempdb..#PimProductAttributeJson') is not null
	 BEGIN 
		DELETE FROM #PimProductAttributeJson
	 END
	 IF OBJECT_ID('tempdb..#TBL_CustomeFiled') is not null
	 BEGIN 
	 DROP TABLE #TBL_CustomeFiled
	 END
	 IF OBJECT_ID('tempdb..#TBL_AttributeVAlue') is not null
	 BEGIN 
	 DROP TABLE #TBL_AttributeVAlue
	 END
 
	DELETE FROM @PimDefaultValueLocale
SET @Counter = @counter + 1 
END

SET @Status =1 

END TRY 
BEGIN CATCH 
	SET @Status =0  
	 SELECT 1 AS ID,@Status AS Status;   
	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC [Znode_GetPublishSingleProductJson] 
		@PublishCatalogId = '+CAST(@PublishCatalogId  AS VARCHAR	(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))
				
	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_GetPublishSingleProductJson',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetImportLogs')
	DROP PROC Znode_GetImportLogs

GO

CREATE PROCEDURE dbo.Znode_GetImportLogs
(
	@ImportProcessLogId INT
)
AS
/*
	Summary : Get import log details.
	Unit Testing  
	BEGIN TRAN
		EXEC Znode_GetImportLogs @ImportProcessLogId=1;
	ROLLBACK TRAN
*/
BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
		SELECT DISTINCT ImportProcessLogId,ImportTemplateId,Status,ProcessStartedDate,ProcessCompletedDate,CreatedDate,
			CreatedBy,ModifiedBy,ModifiedDate,ERPTaskSchedulerId,SuccessRecordCount,FailedRecordcount,
			TotalProcessedRecords,'' AS TemplateName,ImportName
		FROM
		(
			SELECT ZIP.ImportProcessLogId AS ImportProcessLogId,ZIP.ImportTemplateId AS ImportTemplateId,
				ZIP.[Status] AS [Status],ZIP.ProcessStartedDate AS ProcessStartedDate,
				ZIP.ProcessCompletedDate AS ProcessCompletedDate,ZIP.CreatedBy AS CreatedBy,
				ZIP.CreatedDate AS CreatedDate, ZIP.ModifiedBy AS ModifiedBy,ZIP.ModifiedDate AS ModifiedDate,
				ZIP.ERPTaskSchedulerId AS ERPTaskSchedulerId,ZIP.SuccessRecordCount AS SuccessRecordCount,
				ZIP.FailedRecordcount AS FailedRecordcount,ZIP.TotalProcessedRecords AS	TotalProcessedRecords,
				'' AS TemplateName,'' AS 'ImportName'
			FROM dbo.ZnodeImportProcessLog AS ZIP WITH(NOLOCK)
			--INNER JOIN ZnodeImportTemplate AS ZIT ON ZIP.ImportTemplateId = ZIT.ImportTemplateId
			--INNER JOIN ZnodeImportLog AS ZIL ON ZIP.ImportProcessLogId = ZIL.ImportProcessLogId
			WHERE ZIP.ImportProcessLogId=@ImportProcessLogId
		) logs
	END TRY
	BEGIN CATCH
		DECLARE @Status BIT;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(),
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetImportLogs @ImportProcessLogId = '+CAST(@ImportProcessLogId AS VARCHAR(50));
             
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_GetImportLogs',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;                              
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetImportProcessLog')
	DROP PROC Znode_GetImportProcessLog

GO

CREATE PROCEDURE [dbo].[Znode_GetImportProcessLog]
( @WhereClause VARCHAR(max),
  @Rows        INT           = 100,
  @PageNo      INT           = 1,
  @Order_BY    VARCHAR(1000)  = '',
  @RowsCount   INT OUT)
AS
  /*
    Summary : Get import process log details include rowwise errors in details.    	
	Unit Testing   
	begin tran 
	DECLARE @RowsCount INT;
    EXEC Znode_GetImportProcessLog @WhereClause = 'ImportProcessLogId = 1151',@Rows = 1000,@PageNo = 0,@Order_BY = '',@RowsCount = @RowsCount OUT;
	rollback tran
    SELECT @RowsCount;
    
  */
     BEGIN
         SET NOCOUNT ON;
         BEGIN TRY
             DECLARE @SQL NVARCHAR(MAX);
             DECLARE @TBL_ImportLog TABLE(ImportLogId INT,ImportProcessLogId INT,RowNumber BIgInt,ColumnName NVARCHAR(1000),ColumnValue NVARCHAR(max),ErrorDescription NVARCHAR(max)
										,RowId INt , CountNo Int )  ;
             SET @SQL = ' 
							;with Cte_ErrorLog AS 
							(
								SELECT zil.ImportLogId, zil.ImportProcessLogId, ISNULL(zil.RowNumber, 0) [RowNumber], ISNULL(zil.ColumnName, '''') [ColumnName],
								ISNULL(zil.Data, '''') [ColumnValue], zm.MessageName + 
								CASE 
								WHEN zm.MessageCode IN (17,4)	AND Name in (''Pricing'') AND ISNULL(zil.ColumnName, '''') NOT like ''%Quantity%'' THEN +''  ''+ dbo.Fn_GetDefaultPriceRoundOff(isnull(DefaultErrorValue,''0000000.00'') - 1)
								WHEN zm.MessageCode IN (17,4)	AND Name in (''Pricing'') AND ISNULL(zil.ColumnName, '''') like ''%Quantity%''  THEN +''  ''+ dbo.Fn_GetDefaultInventoryRoundOff(isnull(DefaultErrorValue,''0000000.00'') - 1) 
								WHEN zm.MessageCode IN (17,4)	AND Name in (''Inventory'')  THEN +''  ''+ dbo.Fn_GetDefaultInventoryRoundOff(isnull(DefaultErrorValue,''0000000.00'') - 1) 
								WHEN zm.MessageCode IN (16,41,4) AND Name in (''Pricing'') AND ISNULL(zil.ColumnName, '''') NOT like ''%Quantity%'' THEN +''  ''+ dbo.Fn_GetDefaultPriceRoundOff(isnull(DefaultErrorValue,''0000000.00'' ))
								WHEN zm.MessageCode IN (16,41,4) AND Name in (''Pricing'') AND ISNULL(zil.ColumnName, '''')  like ''%Quantity%'' THEN +''  ''+ dbo.Fn_GetDefaultInventoryRoundOff(isnull(DefaultErrorValue,''0000000.00'' ))
								WHEN zm.MessageCode IN (16,41,4) AND Name in (''Inventory'') THEN +''  ''+ dbo.Fn_GetDefaultInventoryRoundOff(isnull(DefaultErrorValue,''0000000.00'' ))
								WHEN zm.MessageCode IN (44) AND Name in (''Pricing'') THEN +''  ''+ isnull(DefaultErrorValue,''0000000.00'' )
								ELSE ''''END ''ErrorDescription'' ,zil.ModifiedDate,zil.GUID
								FROM ZnodeImportLog AS zil WITH (NOLOCK) INNER JOIN ZnodeMessage AS zm WITH (NOLOCK) ON zil.ErrorDescription = CONVERT(VARCHAR(50) , zm.MessageCode)
								INNER JOIN ZnodeImportProcessLog zipl WITH (NOLOCK) ON zil.ImportProcessLogId = zipl.ImportProcessLogId
								LEFT Outer JOIN ZnodeImportTemplate zit WITH (NOLOCK) ON zipl.ImportTemplateId = zit.ImportTemplateId
								LEFT Outer JOIN ZnodeImportHead zih WITH (NOLOCK) ON zit.ImportHeadId =zih.ImportHeadId 
								)
								,Cte_ErrorLogFilter As ( SELECT ImportLogId,ImportProcessLogId,[RowNumber],[ColumnName],[ColumnValue],[ErrorDescription],[ModifiedDate],GUID
												,'+dbo.Fn_GetPagingRowId(@Order_BY , 'RowNumber,ImportLogId')+',Count(*)Over() CountNo 
								 FROM Cte_ErrorLog
								 WHERE 1 = 1 '+dbo.Fn_GetFilterWhereClause(@WhereClause)+' 
							 )

							SELECT ImportLogId,ImportProcessLogId,RowNumber,ColumnName,ColumnValue,ErrorDescription,RowId, CountNo 
							FROM Cte_ErrorLogFilter '+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows)

			 INSERT INTO @TBL_ImportLog (ImportLogId,ImportProcessLogId,RowNumber,ColumnName,ColumnValue,ErrorDescription,RowId, CountNo)
			 EXEC (@SQL)
				 SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM @TBL_ImportLog), 0);
             SELECT ImportLogId,ImportProcessLogId,RowNumber,ColumnName,ColumnValue,ErrorDescription
			 FROM @TBL_ImportLog
			

		 END TRY
         BEGIN CATCH
             DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetImportProcessLog @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetImportProcessLog',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;                                    
         END CATCH;
     END;

GO

update ZnodeApplicationSetting
set setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>ShippingId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>ShippingTypeName</name><headertext>Shipping Type</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>ShippingCode</name><headertext>Shipping Code</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>ShippingName</name><headertext>Shipping Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>Description</name><headertext>Display Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>DisplayOrder</name><headertext>Display Order</headertext><width>30</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>3</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>y</iscontrol><controltype>Text</controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>DestinationCountryCode</name><headertext>Country Code</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>HandlingCharge</name><headertext>Handling Charge</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>9</id><name>IsActive</name><headertext>Enable</headertext><width>40</width><datatype>Boolean</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>10</id><name>ZipCode</name><headertext>Zip Code</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>11</id><name>PublishState</name><headertext>Application Type</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>y</iscontrol><controltype>DropDown</controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>12</id><name>Manage</name><headertext>Action</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>Edit|Delete</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>PortalId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/Profiles/UpdateProfileShipping|/Profiles/UnAssociateAssociatedShipping</manageactionurl><manageparamfield>shippingId,profileId|shippingId,profileId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>13</id><name>ProfileName</name><headertext>Profile Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>14</id><name>ShippingId</name><headertext>ShippingId</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName = 'ZnodeAssociatedShippingListToProfile'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetFilterPimProductId')
	DROP PROC Znode_GetFilterPimProductId

GO


Create PROCEDURE [dbo].[Znode_GetFilterPimProductId]
(
  @WhereClause XML 
 ,@PimProductId TransferId READONLY 
 ,@LocaleId   INT,
 @IsProductNotIn BIT = 1
)
AS 
BEGIN 
SET NOCOUNT ON 

		DECLARE  @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleID()
		DECLARE @SQL NVARCHAR(MAX)
		DECLARE @InternalProductWhereClause NVARCHAR(MAX)

		DECLARE @WorkingProcess INT = 0 

		DECLARE @TBL_FilterClause TABLE (ID INT IDENTITY(1,1),AttributeValue NVARCHAR(MAX),AttributeCode NVARCHAr(MAX),PimAttributeId INT ,AttributeTypeName VARCHAR(300),AttributeCodeOrg VARCHAR(600))

		DECLARE @WhereClauseXML XML = @WhereClause 

		SET @SQL  = ''

		IF EXISTS (SELECT TOP 1 1 FROM @WhereClauseXml.nodes ( '//ArrayOfWhereClauseModel/WhereClauseModel'  ) AS Tbl(Col) 
		WHERE Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(MAX)')  LIKE  '% in (%')
		BEGIN 
			SET @WorkingProcess = 1

				INSERT INTO @TBL_FilterClause (AttributeValue,AttributeCode,AttributeTypeName,PimAttributeId,AttributeCodeOrg)
			SELECT  Tbl.Col.value ( 'attributevalue[1]' , 'NVARCHAR(MAX)') AS AttributeValue
			,Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(MAX)') AS AttributeValue,ZTY.AttributeTypeName,ZPA.PimAttributeId,AttributeCode AttributeCodeOrg
			FROM @WhereClauseXml.nodes ( '//ArrayOfWhereClauseModel/WhereClauseModel'  ) AS Tbl(Col)
			LEFT JOIN  ZnodePimAttribute ZPA  ON ((Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(MAX)')  LIKE '%in (%' OR dbo.Fn_Trim(REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(MAX)'),' = ',''),'''','')) 
												= ZPA.AttributeCode ) AND IsCategory = 0 
			AND ( ZPA.IsShowOnGrid = 1 OR ZPA.IsConfigurable =1  )  )
			LEFT JOIN ZnodeAttributeType ZTY ON (ZTY.AttributeTypeId = ZPA.AttributeTypeId)

		END 
		ELSE 
		BEGIN 

			INSERT INTO @TBL_FilterClause (AttributeValue,AttributeCode,AttributeTypeName,PimAttributeId,AttributeCodeOrg)
			SELECT  Tbl.Col.value ( 'attributevalue[1]' , 'NVARCHAR(MAX)') AS AttributeValue
			,Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(MAX)') AS AttributeValue,ZTY.AttributeTypeName,ZPA.PimAttributeId,AttributeCode AttributeCodeOrg
			FROM @WhereClauseXml.nodes ( '//ArrayOfWhereClauseModel/WhereClauseModel'  ) AS Tbl(Col)
			LEFT JOIN ZnodePimAttribute ZPA  ON (dbo.Fn_Trim(REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(MAX)'),' = ',''),'''','')) 
												= ZPA.AttributeCode AND ZPA.IsCategory = 0 
			AND ( ZPA.IsShowOnGrid = 1 OR ZPA.IsConfigurable =1  )  )
			LEFT JOIN ZnodeAttributeType ZTY ON (ZTY.AttributeTypeId = ZPA.AttributeTypeId)

		END 

		CREATE TABLE #TBL_PimProductId (PimProductId INT)

		CREATE TABLE #TBL_PimProductIdDelete (PimProductId INT )

		INSERT INTO #TBL_PimProductId (PimProductId )
		SELECT Id 
		FROM @PimProductId

		SELECT ZPAV.PimProductId ,PimAttributeValueId ,ZPAV.CreatedDate,ZPAV.ModifiedDate,TBLA.AttributeCodeOrg AttributeCode
		INTO #TBL_AttributeValueId 
		FROM  ZnodePimAttributeValue ZPAV 
		INNER JOIN @TBL_FilterClause TBLA ON (TBLA.PimAttributeId = ZPAV.PimAttributeId)
		INNER JOIN #TBL_PimProductId YT ON (YT.PimProductId = ZPAV.PimProductId OR NOT EXISTS (SELECT TOP 1 1 #TBL_PimProductId))

		DELETE FROM #TBL_PimProductId

		INSERT INTO #TBL_PimProductId (PimProductId )
		SELECT DISTINCT PimProductId 
		FROM #TBL_AttributeValueId

		IF @WorkingProcess =1 
		BEGIN 
				DECLARE @PimAttributeId_in TransferId 

				INSERT INTO @PimAttributeId_in 
				SELECT PimAttributeId
				FROM  @TBL_FilterClause 
				WHERE AttributeTypeName IN ('Simple Select','Multi Select') 
				AND AttributeCode LIKE '%in (%'

				CREATE TABLE #TBL_AttributeDefaultValue_in ( PimAttributeId INT ,
							AttributeDefaultValueCode VARCHAR(MAX),IsEditable INT,AttributeDefaultValue NVARCHAR(MAX),DisplayOrder INT,PimAttributeDefaultValueId INT,IsDefault Bit  )    
				INSERT INTO #TBL_AttributeDefaultValue_in(PimAttributeId,AttributeDefaultValueCode,IsEditable,AttributeDefaultValue,DisplayOrder,PimAttributeDefaultValueId,IsDefault)
				EXEC Znode_GetAttributeDefaultValueLocaleNew_TansferId @PimAttributeId_in, @LocaleId;
 
				DECLARE @WhereClauseInCom NVARCHAR(MAX) = (SELECT TOP 1 AttributeValue FROM @TBL_FilterClause WHERE AttributeCode LIKE '%in (%') 


			SET @SQL = '
			;With Cte_AttributeValue AS 
			(
			SELECT PimAttributeValueId 
			FROM ZnodePimAttributeValueLocale 
			WHERE AttributeValue '+@WhereClauseInCom+'
			UNION ALL 
			SELECT ZPADV.PimAttributeValueID 
			FROM ZnodePimProductAttributeDefaultValue ZPADV 
			INNER JOIN #TBL_AttributeDefaultValue_in TBL ON (TBL.PimAttributeDefaultValueId = ZPADV.PimAttributeDefaultValueId)
			WHERE TBL.AttributeDefaultValue '+@WhereClauseInCom+'
			)
   
			SELECT PimProductId 
			FROM #TBL_AttributeValueId ZPAV 
			INNER JOIN  Cte_AttributeValue CTAC ON (CTAC.PimAttributeValueId = ZPAV.PimAttributeVaLueId )
			GROUP BY PimProductId
			UNION ALL  
			SELECT PimProductId 
			FROM ZnodePimProduct a
			INNER JOIN ZnodePimFamilyLocale b ON (b.PimAttributeFamilyId = a.PimAttributeFamilyId) 
			WHERE b.AttributeFamilyName '+@WhereClauseInCom+'
			GROUP BY PimProductId
			UNION ALL 
			SELECT  TBLAV.PimProductId 
			FROM ZnodePimProduct TBLAV
			WHERE CASE WHEN TBLAV.IsProductPublish  IS NULL THEN ''Not Published'' 
					WHEN TBLAV.IsProductPublish = 0 THEN ''Draft''
					ELSE  ''Published'' END '+@WhereClauseInCom+'
			GROUP BY TBLAV.PimProductId 
			'
   
			DELETE FROM #TBL_PimProductIdDelete 
			INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
			EXEC (@SQL)
			DELETE FROM #TBL_PimProductId
			INSERT INTO #TBL_PimProductId
			SELECT PimProductId FROM #TBL_PimProductIdDelete
			INSERT INTO #TBL_PimProductId
			SELECT -1 
			WHERE NOT EXISTS (SELECT TOP 1 1  FROM #TBL_PimProductId)

			DELETE  FROM @TBL_FilterClause WHERE AttributeCode LIKE '% in (%'

			DROP TABLE #TBL_AttributeDefaultValue_in
			SET @WorkingProcess  = 0 
   
		END 

		IF EXISTS (SELECT TOP 1 1 FROM @TBL_FilterClause WHERE AttributeCode <> '' AND ISNULL(AttributeValue,'') = '')
		BEGIN 
  
				SET  @InternalProductWhereClause = STUFF( (  SELECT ' INNER JOIN #TBL_AttributeValueId AS ZPAVL'+CAST(ID AS VARCHAR(200))+
												' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
												' )'				
										FROM @TBL_FilterClause
										WHERE ISNULL(AttributeValue,'') = ''
										FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				----Change for configurable product varient page seach
				SET @SQL = ' 
							SELECT  TBLAV.PimProductId 
							FROM #TBL_AttributeValueId TBLAV '+@InternalProductWhereClause+' 
							WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId )
							GROUP BY TBLAV.PimProductId 
						'
  

				DELETE FROM #TBL_PimProductIdDelete 
				INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
				EXEC (@SQL)
				DELETE FROM #TBL_PimProductId
				INSERT INTO #TBL_PimProductId
				SELECT PimProductId FROM #TBL_PimProductIdDelete
				INSERT INTO #TBL_PimProductId
				SELECT -1 
				WHERE NOT EXISTS (SELECT TOP 1 1  FROM #TBL_PimProductId)
				DELETE FROM @TBL_FilterClause WHERE ISNULL(AttributeValue,'') = ''
				IF NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) AND EXISTS (SELECT TOP 1 1  FROM @PimProductId Having Max (ID) = 0 )
				BEGIN
				INSERT INTO  #TBL_PimProductId (PimProductId)
				SELECT 0 
			END
  
		END 

		IF EXISTS (SELECT TOP 1 1 FROM @TBL_FilterClause WHERE AttributeTypeName IN ('Simple Select','Multi Select') )
		BEGIN
			DECLARE @PimAttributeId TransferId 

			INSERT INTO @PimAttributeId 
			SELECT DISTINCT PimAttributeId
			FROM  @TBL_FilterClause WHERE AttributeTypeName IN ('Simple Select','Multi Select') 

			CREATE TABLE #TBL_AttributeDefaultValue ( PimAttributeId INT ,
						AttributeDefaultValueCode VARCHAR(MAX),IsEditable INT,AttributeDefaultValue NVARCHAR(MAX),DisplayOrder INT,PimAttributeDefaultValueId INT,IsDefault BIT  )    
			INSERT INTO #TBL_AttributeDefaultValue(PimAttributeId,AttributeDefaultValueCode,IsEditable,AttributeDefaultValue,DisplayOrder,PimAttributeDefaultValueId,IsDefault)
			EXEC Znode_GetAttributeDefaultValueLocaleNew_TansferId @PimAttributeId, @LocaleId;
 
			IF @DefaultLocaleId = @LocaleID AND  @WorkingProcess = 0 
			BEGIN 

				IF @IsProductNotIn = 1 AND EXISTS(SELECT * FROM @TBL_FilterClause WHERE AttributeCodeOrg = 'Brand')
				BEGIN
					SET  @InternalProductWhereClause = STUFF( (  SELECT ' INNER JOIN Cte_AttributeValue AS ZPAVL'+CAST(ID AS VARCHAR(200))+
													' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
													+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+
													'.LocaleId='+CAST(@LocaleID AS VARCHAR(200))+' )'				
											FROM @TBL_FilterClause
											WHERE AttributeTypeName IN ('Simple Select','Multi Select')
											AND AttributeValue <> ''
											AND AttributeValue IS NOT NULL
											FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				END
				ELSE IF @IsProductNotIn = 0  AND EXISTS(SELECT * FROM @TBL_FilterClause WHERE AttributeCodeOrg <> 'Brand')
				BEGIN
					SET  @InternalProductWhereClause = STUFF( (  SELECT ' INNER JOIN Cte_AttributeValue AS ZPAVL'+CAST(ID AS VARCHAR(200))+
													' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
													+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+
													'.LocaleId='+CAST(@LocaleID AS VARCHAR(200))+' )'				
											FROM @TBL_FilterClause
											WHERE AttributeTypeName IN ('Simple Select','Multi Select')
											AND AttributeValue <> ''
											AND AttributeValue IS NOT NULL
											FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				END
				ELSE
				BEGIN
					SET  @InternalProductWhereClause = STUFF( (  SELECT ' INNER JOIN Cte_AttributeValue AS ZPAVL'+CAST(ID AS VARCHAR(200))+
													' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+
													'.LocaleId='+CAST(@LocaleID AS VARCHAR(200))+' )'				
											FROM @TBL_FilterClause
											WHERE AttributeTypeName IN ('Simple Select','Multi Select')
											AND AttributeValue <> ''
											AND AttributeValue IS NOT NULL
											FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				END
				
				SET @SQL = ' ;With Cte_AttributeValue AS 
							(
							SELECT TBLAV.PimAttributeValueId ,SUBSTRING((SELECT '',''+AttributeDefaultValueCode FROM #TBL_AttributeDefaultValue TTR 
							INNER JOIN ZnodePimProductAttributeDefaultValue ZPAVL ON (TTR.PimAttributeDefaultValueId = ZPAVL.PimAttributeDefaultValueId )
							WHERE ZPAVL.PimAttributeValueId = TBLAV.PimAttributeValueId  
							AND ZPAVL.LocaleId = '+Cast(@localeId AS VARCHAR(200))+'
							FOR XML PATH('''') ),2,4000) AttributeValue
								,  '+Cast(@localeId AS VARCHAR(200))+' LocaleId,TBLAV.AttributeCode,TBLAV.PimProductId
							FROM #TBL_AttributeValueId TBLAV
							'+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END+'
							GROUP BY TBLAV.PimAttributeValueId,TBLAV.AttributeCode,TBLAV.PimProductId
							)
  
						SELECT  TBLAV.PimProductId
						FROM #TBL_AttributeValueId TBLAV
						'+@InternalProductWhereClause+'	GROUP BY TBLAV.PimProductId '
			
				
			END 
			ELSE IF  @WorkingProcess = 0 
			BEGIN 

				SET  @InternalProductWhereClause = 
										STUFF( (  SELECT ' INNER JOIN Cte_AttributeValue AS ZPAVL'+CAST(ID AS VARCHAR(200))+
												' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
												' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+'  )'				
										FROM @TBL_FilterClause
										WHERE AttributeTypeName IN ('Simple Select','Multi Select')
										AND AttributeValue <> ''
										AND AttributeValue IS NOT NULL
										FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				SET @SQL = '  			 
							SELECT TBLAV.PimAttributeValueId,ZPAVL.PimAttributeDefaultValueId , ZPAVL.LocaleId ,COUNT(*)Over(Partition By TBLAV.PimAttributeValueId ,TBLAV.PimProductId ORDER BY TBLAV.PimAttributeValueId ,TBLAV.PimProductId  ) RowId
							INTO #temp_Table 
							FROM #TBL_AttributeValueId TBLAV 
							INNER JOIN ZnodePimProductAttributeDefaultValue ZPAVL ON (ZPAVL.PimAttributeValueId = TBLAV.PimAttributeValueId)
							WHERE (ZPAVL.LocaleId = '+Cast(@localeId AS VARCHAR(200))+' OR ZPAVL.LocaleId = '+Cast(@DefaultlocaleId AS VARCHAR(200))+')
				
							;with Cte_AttributeValue AS 
							(
							SELECT TBLAV.PimAttributeValueId ,SUBSTRING((SELECT '',''+AttributeDefaultValueCode FROM #TBL_AttributeDefaultValue TTR 
							INNER JOIN #temp_Table  ZPAVL ON (TTR.PimAttributeDefaultValueId = ZPAVL.PimAttributeDefaultValueId )
							WHERE ZPAVL.PimAttributeValueId = TBLAV.PimAttributeValueId  
							AND ZPAVL.LocaleId = CASE WHEN ZPAVL.RowId = 2 THEN '+CAST(@LocaleId AS Varchar(300))+' ELSE '+Cast(@DefaultLocaleId AS Varchar(300))+' END  
							FOR XML PATH('''') ),2,4000) AttributeValue,TBLAV.AttributeCode ,TBLAV.PimProductId 
							FROM #TBL_AttributeValueId TBLAV
							'+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END+'
							GROUP BY TBLAV.PimAttributeValueId,TBLAV.AttributeCode ,TBLAV.PimProductId 
							)
  
							SELECT   TBLAV.PimProductId
							FROM  #TBL_AttributeValueId TBLAV
							'+@InternalProductWhereClause+'	GROUP BY TBLAV.PimProductId '

			END 

			DELETE FROM #TBL_PimProductIdDelete 
			INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
			EXEC (@SQL)
			DELETE FROM #TBL_PimProductId
			INSERT INTO #TBL_PimProductId
			SELECT PimProductId FROM #TBL_PimProductIdDelete
 
			DROP TABLE #TBL_AttributeDefaultValue

		END 

		IF EXISTS (SELECT TOP 1 1 FROM @TBL_FilterClause WHERE AttributeTypeName IN ('Text','Number','Datetime','Yes/No','Date') )
		BEGIN  
   
				IF @DefaultLocaleId = @LocaleID AND @WorkingProcess = 0 
				BEGIN 
					SET  @InternalProductWhereClause = 
											STUFF( (  SELECT ' INNER JOIN View_PimProducttextValue AS ZPAVL'+CAST(ID AS VARCHAR(200))+
													' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
													' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+
													'.LocaleId='+CAST(@LocaleID AS VARCHAR(200))+' )'				
											FROM @TBL_FilterClause
											WHERE AttributeTypeName IN ('Text','Number','Datetime','Yes/No','Date')
											FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
 
					SET @SQL = '	SELECT  TBLAV.PimProductId 
								FROM #TBL_AttributeValueId TBLAV
								'+@InternalProductWhereClause+'
								'+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
											ELSE ' WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId   ) ' END 
								+' GROUP BY TBLAV.PimProductId '

			END 
			ELSE IF @WorkingProcess = 0 
			BEGIN 
				SET  @InternalProductWhereClause = 
										STUFF( (  SELECT ' INNER JOIN Cte_AttributeDetails AS ZPAVL'+CAST(ID AS VARCHAR(200))+
												' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
												' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+
												'.LocaleId = CASE WHEN ZPAVL'+CAST(ID AS VARCHAR(200))+'.RowId = 2 THEN  '+CAST(@LocaleId AS Varchar(300))+' ELSE '+Cast(@DefaultLocaleId AS Varchar(300))+' END  )'				
										FROM @TBL_FilterClause
										WHERE AttributeTypeName IN ('Text','Number','Datetime','Yes/No','Date')
										FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				SET @SQL = ' 
					;With Cte_AttributeDetails AS 
					(
					SELECT TBLAV.PimProductId,ZPAVL.AttributeValue,TBLAV.AttributeCode,ZPAVL.LocaleId ,COUNT(*)Over(Partition By TBLAV.PimProductId,TBLAV.AttributeCode ORDER BY TBLAV.PimProductId,TBLAV.AttributeCode  ) RowId
					FROM #TBL_AttributeValueId TBLAV 
					INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON (ZPAVL.PimAttributeValueId = TBLAV.PimAttributeValueId )
					WHERE (LocaleId = '+Cast(@DefaultLocaleId AS Varchar(300))+' OR LocaleId = '+CAST(@LocaleId AS Varchar(300))+' )'+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' AND EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END +'
					) 
					SELECT  TBLAV.PimProductId 
  					FROM #TBL_AttributeValueId TBLAV
					'+@InternalProductWhereClause+'
					GROUP BY TBLAV.PimProductId 
					'
			END 
			DELETE FROM #TBL_PimProductIdDelete 
			INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
			EXEC (@SQL)
			DELETE FROM #TBL_PimProductId
			INSERT INTO #TBL_PimProductId
			SELECT PimProductId FROM #TBL_PimProductIdDelete

		END 

		IF EXISTS (SELECT TOP 1 1 FROM @TBL_FilterClause WHERE AttributeTypeName IN ('Text Area') )
		BEGIN    
			IF @DefaultLocaleId = @LocaleID AND @WorkingProcess = 0 
			BEGIN 
				SET  @InternalProductWhereClause = 
											STUFF( (  SELECT ' INNER JOIN View_PimProductTextAreaValue AS ZPAVL'+CAST(ID AS VARCHAR(200))+
												' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
												' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+
												'.LocaleId='+CAST(@LocaleID AS VARCHAR(200))+' )'				
										FROM @TBL_FilterClause
										WHERE AttributeTypeName IN ('Text Area')
										FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
 
				SET @SQL = '
							SELECT  TBLAV.PimProductId 
							FROM #TBL_AttributeValueId TBLAV
							'+@InternalProductWhereClause+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END 
										+' GROUP BY TBLAV.PimProductId '
			END 
			ELSE IF @WorkingProcess = 0 
			BEGIN 
				SET  @InternalProductWhereClause = 
										STUFF( (  SELECT ' INNER JOIN Cte_AttributeDetails AS ZPAVL'+CAST(ID AS VARCHAR(200))+
												' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
												' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+
												'.LocaleId = CASE WHEN ZPAVL'+CAST(ID AS VARCHAR(200))+'.RowId = 2 THEN  '+CAST(@LocaleId AS Varchar(300))+' ELSE '+Cast(@DefaultLocaleId AS Varchar(300))+' END  )'				
										FROM @TBL_FilterClause
										WHERE AttributeTypeName IN ('Text Area')
										FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				SET @SQL = ' 
					;With Cte_AttributeDetails AS 
					(
					SELECT TBLAV.PimProductId,TBLAV.AttributeCode,ZPAVL.AttributeValue,ZPAVL.LocaleId ,COUNT(*)Over(Partition By TBLAV.PimProductId,TBLAV.AttributeCode ORDER BY TBLAV.PimProductId,TBLAV.AttributeCode  ) RowId
					FROM #TBL_AttributeValueId TBLAV 
					INNER JOIN ZnodePimProductAttributeTextAreaValue ZPAVL ON (ZPAVL.PimAttributeValueId = TBLAV.PimAttributeValueId )
					WHERE (LocaleId = '+Cast(@DefaultLocaleId AS Varchar(300))+' OR LocaleId = '+CAST(@LocaleId AS Varchar(300))+' )
	 
					) 
					SELECT  TBLAV.PimProductId 
  					FROM #TBL_AttributeValueId TBLAV
					'+@InternalProductWhereClause+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END 
										+' 
										GROUP BY TBLAV.PimProductId 	
										'
				END 
			DELETE FROM #TBL_PimProductIdDelete 
			INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
			EXEC (@SQL)
			DELETE FROM #TBL_PimProductId
			INSERT INTO #TBL_PimProductId
			SELECT PimProductId FROM #TBL_PimProductIdDelete

		END 
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_FilterClause WHERE AttributeCode  LIKE '%PublishStatus%' )
		BEGIN    
 
				SET @SQL = '
							SELECT  TBLAV.PimProductId 
							FROM ZnodePimProduct TBLAV
							WHERE CASE WHEN TBLAV.IsProductPublish  IS NULL THEN ''Not Published'' 
							WHEN TBLAV.IsProductPublish = 0 THEN ''Draft''
							ELSE  ''Published'' END '+(SELECT TOP 1 AttributeValue FROM @TBL_FilterClause WHERE AttributeCode LIKE '%PublishStatus%')+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' AND EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END 
										+' GROUP BY TBLAV.PimProductId '
  
				DELETE FROM #TBL_PimProductIdDelete 
				INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
				EXEC (@SQL)
				DELETE FROM #TBL_PimProductId
				INSERT INTO #TBL_PimProductId
				SELECT PimProductId FROM #TBL_PimProductIdDelete

		END 
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_FilterClause WHERE AttributeCode  LIKE '%AttributeFamily%' )
		BEGIN 

				;With Cte_attributeValue AS 
				(
					SELECT ZPAF.PimAttributeFamilyId,FamilyCode,AttributeFamilyName ,ZPFL.LocaleId
					FROM ZnodePimAttributeFamily ZPAF
					INNER JOIN ZnodePimFamilyLocale ZPFL ON (ZPFL.PimAttributeFamilyId = ZPAF.PimAttributeFamilyId) 
					WHERE ZPFL.LocaleId IN (@DefaultLocaleId,@LocaleId)
				) 
				, Cte_AttributeValueAttribute AS 
				(
					SELECT PimAttributeFamilyId,FamilyCode,AttributeFamilyName
					FROM Cte_attributeValue RTY 
					WHERE LocaleId = @LocaleId
				)
				, Cte_AttributeValueTht AS 
				(
					SELECT PimAttributeFamilyId,FamilyCode,AttributeFamilyName
					FROM Cte_AttributeValueAttribute
					UNION ALL 
					SELECT PimAttributeFamilyId,FamilyCode,AttributeFamilyName
					FROM Cte_attributeValue TYY  
					WHERE NOT EXISTS (SELECT TOP 1 1 FROM Cte_AttributeValueAttribute THE WHERE THE.PimAttributeFamilyId = TYY.PimAttributeFamilyId )
					AND TYY.LocaleId = @DefaultLocaleId
				)
				SELECT PimAttributeFamilyId,FamilyCode,AttributeFamilyName
				INTO #TBL_FamilyLocale
				FROM Cte_AttributeValueTht 


				SET @SQL = '
							SELECT  TBLAV.PimProductId 
							FROM ZnodePimProduct TBLAV 
							INNER JOIN #TBL_FamilyLocale THY ON (THY.PimAttributeFamilyId = TBLAV.PimAttributeFamilyId )
							WHERE AttributeFamilyName '+(SELECT TOP 1 AttributeValue FROM @TBL_FilterClause WHERE AttributeCode LIKE '%AttributeFamily%')+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' AND EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END 
										+' GROUP BY TBLAV.PimProductId '
  

			DELETE FROM #TBL_PimProductIdDelete 
			INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
			EXEC (@SQL)
			DELETE FROM #TBL_PimProductId
			INSERT INTO #TBL_PimProductId
			SELECT PimProductId FROM #TBL_PimProductIdDelete

		END 
	
		SET @SQL = '
		IF EXISTS ( SELECT TOP 1 1 FROM tempdb..sysobjects WHERE name = ''##Temp_PimProductId'+CAST(@@SPID AS VARCHAR(500))+''' )
		BEGIN 
			DROP TABLE ##Temp_PimProductId'+CAST(@@SPID AS VARCHAR(500))+'
		END 
		CREATE TABLE ##Temp_PimProductId'+CAST(@@SPID AS VARCHAR(500))+' (PimProductId INT )
		INSERT INTO  ##Temp_PimProductId'+CAST(@@SPID AS VARCHAR(500))+'
		SELECT PimProductId 
		FROM #TBL_PimProductId
		'
		EXEC (@SQL)
		DROP TABLE #TBL_PimProductId
		DROP TABLE #TBL_AttributeValueId
		DROP TABLE #TBL_PimProductIdDelete
 END
 
GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ManageProductList_XML')
	DROP PROC Znode_ManageProductList_XML

GO

CREATE PROCEDURE [dbo].[Znode_ManageProductList_XML]
(   @WhereClause						 XML,
    @Rows								 INT           = 100,
    @PageNo								 INT           = 1,
    @Order_BY			 VARCHAR(1000) = '',
    @LocaleId			 INT           = 1,
    @PimProductId		 VARCHAR(2000) = 0,
    @IsProductNotIn	 BIT           = 0,
	@IsCallForAttribute BIT		   = 0,
	@AttributeCode      VARCHAR(max ) = '' ,
	@PimCatalogId   INT = 0,
	@IsCatalogFilter   BIT            = 0,
	@IsDebug            Bit		   = 0,
	@publishstatus   NVARCHAR(200) = '' 
	)
AS
    
/*
		  Summary:-   This Procedure is used for get product List  
				    Procedure will pivot verticle table(ZnodePimattributeValues) into horizontal table with columns 
				    ProductId,ProductName,ProductType,AttributeFamily,SKU,Price,Quantity,IsActive,ImagePath,Assortment,LocaleId,DisplayOrder
        
		  Unit Testing
		  
exec Znode_ManageProductList_XML @WhereClause=N'',@Rows=50,@PageNo=1,@Order_By=N'',@LocaleId=1,@PimProductId=N'',@IsProductNotIn=1,@IsCallForAttribute=0,@AttributeCode=''
          select * from ZnodeAttributeType  WHERE AttributeValue LIKE '%&%'
		  UPDATE VieW_lOADMANAGEpRODUCT SET  AttributeValue = 'A & B'  WHERE AttributeValue LIKE '% and %' AND PimProductId = 158
    */

     BEGIN
         SET NOCOUNT ON;
         BEGIN TRY
		 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
             DECLARE @PimProductIds TransferId, --VARCHAR(MAX), 
					 @FirstWhereClause NVARCHAR(MAX)= '', 
					 @SQL NVARCHAR(MAX)= '' ,
					 @OutPimProductIds VARCHAR(max),
					 @ProductXML NVARCHAR(max) ;
			Declare @publishstatusid table (id int);

			if isnull(@publishstatus,'') <>''
				begin
				declare @sql1 nvarchar(2000)='';
				DECLARE @ParmDefinition NVARCHAR(500); 
				set @sql1 = N'select  PublishStateId from ZnodePublishState where DisplayName ' +  @publishstatus +'';
				
				 ----EXEC (@sql1);
				 insert into @publishstatusid
				 EXEC (@sql1)
				  
				 --set @publishstatusid = @p

				 ----set @sql1 = N' SET @publishstatusid1 =( select top 1  PublishStateId from ZnodePublishState where DisplayName like ''%' + @publishstatus +'%'')';
				
				 --------EXEC (@sql1);
				 ----set @ParmDefinition ='@publishstatusid1 int output';
				 ---- EXECUTE sp_executesql @sql1, @ParmDefinition, @publishstatusid1 = @publishstatusid output

				End

             DECLARE @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId()
					 ,@RowsCount INT =0 ;
             DECLARE @TransferPimProductId TransferId 
			 DECLARE @TBL_AttributeDefaultValue TABLE
             (PimAttributeId            INT,
              AttributeDefaultValueCode VARCHAR(100),
              IsEditable                BIT,
              AttributeDefaultValue     NVARCHAR(MAX)
			  ,DisplayOrder INT 
			  ,PimAttributedefaultValueId INT 
             );
             DECLARE @TBL_AttributeDetails AS TABLE
             (PimProductId   INT,
              AttributeValue NVARCHAR(MAX),
              AttributeCode  VARCHAR(600),
              PimAttributeId INT,
			  AttributeDefaultValue NVARCHAR(MAX)
             );
			 Create table #TBL_AttributeDetailsLocale
             (PimProductId   INT,
              AttributeValue NVARCHAR(MAX),
              AttributeCode  VARCHAR(600),
              PimAttributeId INT
             );
			 DECLARE @TBL_MultiSelectAttribute TABLE (PimAttributeId INT , AttributeCode VARCHAR(600))
			
			 DECLARE @TBL_MediaAttribute TABLE (Id INT ,PimAttributeId INT ,AttributeCode VARCHAR(600) )
			 
			 DECLARE @TBL_ProductIds TABLE 
			 (
			  PimProductId INT,
			  ModifiedDate DATETIME  
			 )

			 DECLARE @FamilyDetails TABLE
             (
			  PimProductId         INT,
              PimAttributeFamilyId INT,
              FamilyName           NVARCHAR(Max)
             );
             DECLARE @DefaultAttributeFamily INT= dbo.Fn_GetDefaultPimProductFamilyId();
             DECLARE @ProductIdTable TABLE
             (PimProductId INT,
              CountId      INT,
              RowId        INT IDENTITY(1,1)
             );
          		
             IF EXISTS ( SELECT TOP 1 1 FROM @WhereClause.nodes ( '//ArrayOfWhereClauseModel/WhereClauseModel'  ) AS Tbl(Col)
			 WHERE LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''',''))))  =  'Brand'
                OR LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''','')))) = 'Vendor'
                OR LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''',''))))  =  'ShippingCostRules'
                OR LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''','')))) =  'Highlights') and @IsCallForAttribute=1
                 BEGIN
                DECLARE @AttributeCodeValue TABLE (AttributeValue NVARCHAr(max),AttributeCode NVARCHAR(max))

				INSERT INTO @AttributeCodeValue(AttributeValue,AttributeCode)
				SELECT  Tbl.Col.value ( 'attributevalue[1]' , 'NVARCHAR(max)') AS AttributeValue
						 ,Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)') AS AttributeCode
				FROM @WhereClause.nodes ( '//ArrayOfWhereClauseModel/WhereClauseModel'  ) AS Tbl(Col)
				WHERE LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''',''))))  =  'Brand'
                OR LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''',''))))  = 'Vendor'
                OR LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''',''))))  =  'ShippingCostRules'
                OR LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''',''))))  =  'Highlights'
		
				SET @SQL =   
				           ';WIth Cte_DefaultValue AS (
										  SELECT AttributeDefaultValueCode , ZPDF.PimAttributeId ,FNPA.AttributeCode
										  FROM ZnodePImAttributeDefaultValue ZPDF
										  INNER JOIN [dbo].[Fn_GetProductDefaultFilterAttributes] () FNPA ON ( FNPA.PimAttributeId = ZPDF.PimAttributeId) 
										)
										, Cte_productIds AS 
										(
										  SELECT a.PimProductId, c.AttributeCode , CTDV.AttributeDefaultValueCode AttributeValue,b.ModifiedDate 
										  FROM  ZnodePimAttributeValue a
										  LEFT JOIN ZnodePimAttribute c ON(c.PimAttributeId = a.PimAttributeId)
										  LEFT JOIN ZnodePimAttributeValueLocale b ON(b.PimAttributeValueId = a.PimAttributeValueId)  
										  INNER JOIN Cte_DefaultValue CTDV ON (CTDV.AttributeCode = c.AttributeCode 
										  AND EXISTS (SELECT TOP 1 1 FROM dbo.split(b.AttributeValue,'','') SP WHERE SP.Item = CTDV.AttributeDefaultValueCode) )
										  Union all 
										  
											SELECT a.PimProductId,c.AttributeCode,ZPADV.AttributeDefaultValueCode AttributeValue ,a.ModifiedDate 
											FROM ZnodePimProductAttributeDefaultValue ZPPADV
											INNER JOIN ZnodePimAttributeDefaultValue ZPADV ON (ZPPADV.PimAttributeDefaultValueId = ZPADV.PimAttributeDefaultValueId)
											LEFT JOIN ZnodePimAttributeValue a ON (a.PimAttributeValueId = ZPPADV.PimAttributeValueId )
											LEFT JOIN ZnodePimAttribute c ON ( c.PimAttributeId=a.PimAttributeId )
											INNER JOIN Cte_DefaultValue CTDV ON (CTDV.AttributeCode = c.AttributeCode )
										)										
										SELECT PimProductId ,ModifiedDate
										FROM Cte_productIds WHERE  AttributeCode '+(SELECT TOP 1 AttributeCode  FROM @AttributeCodeValue )+' AND 
										AttributeValue '+(SELECT TOP 1 AttributeValue  FROM @AttributeCodeValue )+' 
										GROUP BY PimProductId,ModifiedDate Order By ModifiedDate DESC ';


					 SET @Order_BY = CASE WHEN @Order_BY = '' THEN 'ModifiedDate DESC' ELSE @Order_BY END 
					 	
					 SET @WhereClause = CAST(REPLACE(CAST(@WhereClause AS NVARCHAR(max)),'<WhereClauseModel><attributecode>'''+(SELECT TOP 1 AttributeCode  FROM @AttributeCodeValue )+'''</attributecode><attributevalue>'''+(SELECT TOP 1 AttributeValue   FROM @AttributeCodeValue )+'''</attributevalue></WhereClauseModel>','') AS XML )
					
				     INSERT INTO @TBL_ProductIds ( PimProductId, ModifiedDate )
					 EXEC (@SQL);
			  					 
					
						 INSERT INTO @ProductIdTable( PimProductId )
						 SELECT PimProductId 
						 FROM @TBL_ProductIds
					

                     INSERT INTO @TransferPimProductId
					 SELECT PimProductId
                     FROM @ProductIdTable
                   
				   			  
     DELETE FROM @ProductIdTable;
   --  SET @WhereClause = CAST(REPLACE(CAST(@WhereClause AS NVARCHAR(MAX)), @FirstWhereClause, ' 1 = 1') AS XML);
                 END
	            ELSE IF @PimProductId <> ''
			    BEGIN 
		
				 INSERT INTO @TransferPimProductId(id)
				 SELECT Item 
				 FROM dbo.split(@PimProductId,',')
			    END 
		
			
	 DECLARE  @ProductListIdRTR TransferId
	 DECLARE @TAb Transferid 
	 --DECLARE @tBL_mainList TABLE (Id INT,RowId INT)
	 Create table #TBL_ProductMainList (Id INT,RowId INT)

	 	IF @PimProductId <> ''  OR   @IsCallForAttribute=1 --OR (CAST(@WhereClause AS NVARCHAR(max))= N'' AND @Order_by <> N'' AND @AttributeCode = N'')
		BEGIN 
	 SET @IsProductNotIn = CASE WHEN @IsProductNotIn = 0 THEN 1  
					 WHEN @IsProductNotIn = 1 THEN 0 END 
		END 
	
	 INSERT INTO @ProductListIdRTR
	 EXEC Znode_GetProductList  @IsProductNotIn,@TransferPimProductId, @PimCatalogId,@IsCatalogFilter
 
	 IF CAST(@WhereClause AS NVARCHAR(max))<> N''
	 BEGIN 
	 
	  SET @SQL = 'SELECT Distinct PimProductId FROM ##Temp_PimProductId'+CAST(@@SPID AS VARCHAR(500))

	  EXEC Znode_GetFilterPimProductId @WhereClause,@ProductListIdRTR,@localeId,@IsProductNotIn
	  
      INSERT INTO @TAB 
	  EXEC (@SQL)
	 
	 END 
	 
	

	 IF EXISTS (SELECT Top 1 1 FROM @TAb ) OR CAST(@WhereClause AS NVARCHAR(max)) <> N''
	 BEGIN 
	 
	 SET @AttributeCode = REPLACE(dbo.FN_TRIM(REPLACE(REPLACE(@order_by,' DESC',''),' ASC','')),'DisplayOrder','ProductName')
	 SET @order_by = REPLACE(@order_by,'DisplayOrder','ProductName')
	 INSERT INTO #TBL_ProductMainList(id,RowId)
	 EXEC Znode_GetOrderByPagingProduct @order_by,@rows,@PageNo, @TAb ,@AttributeCode,@localeId
	 
	 END 
	 ELSE 
	 BEGIN
	      
	 SET @AttributeCode = REPLACE(dbo.FN_TRIM(REPLACE(REPLACE(@order_by,' DESC',''),' ASC','')),'DisplayOrder','ProductName')
	 SET @order_by = REPLACE(@order_by,'DisplayOrder','ProductName')
	 INSERT INTO #TBL_ProductMainList(id,RowId)
	 EXEC Znode_GetOrderByPagingProduct @order_by,@rows,@PageNo, @ProductListIdRTR ,@AttributeCode,@localeId 
	 END 
          

  			 INSERT INTO @PimProductIds ( Id  )
			 SELECT DISTINCT id FROM #TBL_ProductMainList

			 DECLARE @TBL_PimProductIds transferId 
			 INSERT INTO @TBL_PimProductIds
			 SELECT id 
             FROM @PimProductIds
			 			 	
			 DECLARE @PimAttributeIds TransferId  
			 INSERT INTO @PimAttributeIds
			 SELECT PimAttributeId  
			 FROM [dbo].[Fn_GetProductGridAttributes]()
			 
			

			 INSERT INTO @TBL_AttributeDetails
             (PimProductId,
              AttributeValue,
              AttributeCode,
              PimAttributeId,
			  AttributeDefaultValue
             )
             EXEC Znode_GetProductsAttributeValue_newTesting
                  @TBL_PimProductIds,
                  @PimAttributeIds,
                  @localeId;
			
			
			UPDATE @TBL_AttributeDetails
			SET AttributeValue = ISNULL(AttributeValue,'')
			WHERE AttributeValue IS NULL 

----------------------------------------------------------------------------------------------------

			

		    declare @SKU SelectColumnList
			declare @TBL_Inventorydetails table (Quantity NVARCHAR(MAx),PimProductId INT)

			INSERT INTO @SKU
			SELECT AttributeValue 
			FROM @TBL_AttributeDetails
			WHERE AttributeCode = 'SKU'
 
 			INSERT INTO @TBL_Inventorydetails(Quantity,PimProductId)
			EXEC Znode_GetPimProductAttributeInventory @SKU--vishal

			 INSERT INTO @FamilyDetails
             (PimAttributeFamilyId,
              PimProductId
             )
             EXEC [dbo].[Znode_GetPimProductAttributeFamilyId]
                  @PimProductIds,
                  1;
             
		 UPDATE a
               SET
                   FamilyName = b.AttributeFamilyName
             FROM @FamilyDetails a
                  INNER JOIN ZnodePimFamilyLocale b ON(a.PimAttributeFamilyId = b.PimAttributeFamilyId
                                                       AND LocaleId = @LocaleId);
             UPDATE a
               SET
                   FamilyName = b.AttributeFamilyName
             FROM @FamilyDetails a
                  INNER JOIN ZnodePimFamilyLocale b ON(a.PimAttributeFamilyId = b.PimAttributeFamilyId
                                                       AND LocaleId = @DefaultLocaleId)
             WHERE a.FamilyName IS NULL
                   OR a.FamilyName = '';
           	
			INSERT INTO @TBL_AttributeDetails             (PimProductId,              AttributeValue,              AttributeCode,              PimAttributeId             )
			SELECT PimProductId ,FamilyName, 'AttributeFamily',NULL
			FROM @FamilyDetails 
			

			  
					INSERT INTO @TBL_AttributeDetails             (PimProductId,              AttributeValue,              AttributeCode,              PimAttributeId             )
					SELECT a.ID PimProductId ,th.DisplayName, 'PublishStatus',NULL
					FROM @PimProductIds a 
					INNER JOIN ZnodePimProduct b ON (b.PimProductId = a.ID)
					LEFT JOIN ZnodePublishState th ON (th.PublishStateId = b.PublishStateId)
				 
			
		 IF isnull(@publishstatus,'') = ''

                 BEGIN
					INSERT INTO #TBL_AttributeDetailsLocale (PimProductId ,PimAttributeId,AttributeCode )
						SELECT  TBLAD.PimProductId ,TBLAD.PimAttributeId,TBLAD.AttributeCode 
						FROM @TBL_AttributeDetails TBLAD 
						GROUP BY  TBLAD.PimProductId ,TBLAD.PimAttributeId,TBLAD.AttributeCode 
				 end 
				 else
				 begin
						INSERT INTO #TBL_AttributeDetailsLocale (PimProductId ,PimAttributeId,AttributeCode )
							SELECT  TBLAD.PimProductId ,TBLAD.PimAttributeId,TBLAD.AttributeCode 
							FROM @TBL_AttributeDetails TBLAD where TBLAD.PimProductId  
									in (select PimProductId from @TBL_AttributeDetails  t where t.AttributeCode = 'PublishStatus'
										and AttributeValue in (select DisplayName from ZnodePublishState where PublishStateId in (select id from @publishstatusid)))
								
							GROUP BY  TBLAD.PimProductId ,TBLAD.PimAttributeId,TBLAD.AttributeCode 
				 End
		
	    UPDATE TBLPP 
		SET AttributeValue = CTDD.AttributeValue 
		FROM  @TBL_AttributeDetails CTDD 
		INNER JOIN #TBL_AttributeDetailsLocale TBLPP ON (TBLPP.PimProductId = CTDD.PimProductId AND TBLPP.AttributeCode  = CTDD.AttributeCode)
		WHERE TBLPP.AttributeValue IS NULL 

    	SET @ProductXML =  '<MainProduct>'+ STUFF( (  SELECT '<Product>'+'<PimProductId>'+CAST(TBAD.PimProductId AS VARCHAR(50))+'</PimProductId>'
																		+'<AvailableInventory>'+CAST(ISNULL(IDD.[Quantity],'') AS VARCHAR(50))+'</AvailableInventory>'
		+ STUFF(    (  SELECT '<'+TBADI.AttributeCode+'>'+CAST( (SELECT  ''+TBADI.AttributeValue FOR XML PATH('')) AS NVARCHAR(max))+'</'+TBADI.AttributeCode+'>'   
															FROM #TBL_AttributeDetailsLocale TBADI      
															 WHERE TBADI.PimProductId = TBAD.PimProductId 
															 ORDER BY TBADI.PimProductId DESC
															 FOR XML PATH (''), TYPE
																).value('.', ' Nvarchar(max)'), 1, 0, '')+'</Product>'	   

		FROM #TBL_AttributeDetailsLocale TBAD
		INNER JOIN #TBL_ProductMainList TBPI ON (TBAD.PimProductid = TBPI.id )
		LEFT JOIN @TBL_ProductIds TPT ON TBAD.PimProductId = TPT.PimProductId
		LEFT JOIN @TBL_InventoryDetails IDD ON (TBPI.id = IDD.PimProductId)
		GROUP BY TBAD.pimProductid, TPT.ModifiedDate,TBPI.RowId,IDD.Quantity
		ORDER BY TBPI.RowId 
		FOR XML PATH (''),TYPE).value('.', ' Nvarchar(max)'), 1, 0, '')+'</MainProduct>'
			--FOR XML PATH ('MainProduct'))
 

			SELECT  CAST(@ProductXML AS XML ) ProductXMl
		   
		     SELECT AttributeCode ,  ZPAL.AttributeName
			 FROM ZnodePimAttribute ZPA 
			 LEFT JOIN ZnodePiMAttributeLOcale ZPAL ON (ZPAL.PimAttributeId = ZPA.PimAttributeId )
             WHERE LocaleId = 1  
			 AND  IsCategory = 0 
			 AND ZPA.IsShowOnGrid = 1  
			 UNION ALL 
			 SELECT 'PublishStatus','Publish Status'

     IF EXISTS (SELECT Top 1 1 FROM @TAb )
	 BEGIN 

		  SELECT (SELECT COUNT(1) FROM @TAb) AS RowsCount   
	 END 
	 ELSE 
	 BEGIN
	 		  SELECT (SELECT COUNT(1) FROM @ProductListIdRTR) AS RowsCount   
	 END 
		;

             -- find the all locale values 
         END TRY
         BEGIN CATCH
		    SELECT ERROR_MESSAGE()
                DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ManageProductList_XML @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@LocaleId = '+CAST(@LocaleId AS VARCHAR(50))+',@PimProductId='+@PimProductId+',@IsProductNotIn='+CAST(@IsProductNotIn AS VARCHAR(50))+',@IsCallForAttribute='+CAST(@IsCallForAttribute AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_ManageProductList_XML',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;

         END CATCH;

     END;

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'SubTotal'
AND Object_ID = Object_ID(N'dbo.ZnodeOmsQuote'))
BEGIN
ALTER TABLE ZnodeOmsQuote ADD SubTotal NUMERIC(28,6) NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'DiscountAmount'
AND Object_ID = Object_ID(N'dbo.ZnodeOmsQuote'))
BEGIN
ALTER TABLE ZnodeOmsQuote ADD DiscountAmount NUMERIC(28,6) NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'ShippingDiscount'
AND Object_ID = Object_ID(N'dbo.ZnodeOmsQuote'))
BEGIN
ALTER TABLE ZnodeOmsQuote ADD ShippingDiscount NUMERIC(28,6) NULL;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_UpdateInventory')
	DROP PROC Znode_UpdateInventory

GO

CREATE PROCEDURE [dbo].[Znode_UpdateInventory]
(
	@SkuXml xml,
	@PortalId int, 
	@UserId int, 
	@Status bit OUT, 
	@IsDebug bit= 0
)
AS 
	/*
	Summary: (13671)   Inventory will be updated on the basis of "InventoryTracking" (Attribute Code) value in locale table 
				    If value id "DisablePurchasing" then subtracts currently selected quantity only when it will greater than zero.
				    If "AllowBackordering" then inventory will become negative
				    If "DontTrackInventory" then don't update inventory.
				    inventory will be get deducted from associated warehouse where quantity is available as per warehouse precedence. 
				    Validate total quantity 
	Input Parameters:
	SKU(Comma separated multiple), PortalId
	Unit Testing   
		Declare @Status bit 
		Exec Znode_UpdateInventory  @SkuXml = '<ArrayOfOrderWarehouseLineItemsModel>
		<OrderWarehouseLineItemsModel>
		<OrderLineItemId>418</OrderLineItemId>
		<SKU>ap1534</SKU>
		<InventoryTracking>DisablePurchasing</InventoryTracking>
		<Quantity>1.000000</Quantity>
		</OrderWarehouseLineItemsModel>
		<OrderWarehouseLineItemsModel>
		<OrderLineItemId>419</OrderLineItemId>
		<SKU>al8907</SKU>
		<InventoryTracking>DisablePurchasing</InventoryTracking>
		<Quantity>1.000000</Quantity>
		</OrderWarehouseLineItemsModel>
		</ArrayOfOrderWarehouseLineItemsModel>',@PortalId = 1,@UserId = 2,@Status = @Status

	*/
BEGIN
	BEGIN TRAN UpdateInventory;
	BEGIN TRY
		SET NOCOUNT ON;
		DECLARE @RoundOffValue INT= dbo.Fn_GetDefaultValue('InventoryRoundOff');
		DECLARE @TBL_XmlReturnToTable TABLE
		( 
			OrderLineItemId int, SKU nvarchar(max), InventoryTracking nvarchar(1000), Quantity numeric(28, 6),
			AllowBackOrder VARCHAR(100), SequenceNo int IDENTITY, OrderLineItemRelationshipTypeId int 
		);
		DECLARE @TBL_ErrorInventoryTracking TABLE
		( 
			SKU nvarchar(max), Quantity numeric(28, 6), InventoryTracking nvarchar(2000), AllowBackOrder varchar(100)
		);
		INSERT INTO @TBL_XmlReturnToTable( OrderLineItemId, SKU, InventoryTracking, Quantity,AllowBackOrder )
			   SELECT Tbl.Col.value( 'OrderLineItemId[1]', 'INT' ) AS OrderLineItemId, Tbl.Col.value( 'SKU[1]', 'NVARCHAR(2000)' ) AS SKU, Tbl.Col.value( 'InventoryTracking[1]', 'NVARCHAR(2000)' ) AS InventoryTracking, Tbl.Col.value( 'Quantity[1]', 'Numeric(28,6)' ) AS Quantity
			   , Tbl.Col.value( 'AllowBackOrder[1]', 'VARCHAR(100)' ) AS AllowBackOrder
			   FROM @SkuXml.nodes( '//ArrayOfOrderWarehouseLineItemsModel/OrderWarehouseLineItemsModel' ) AS Tbl(Col)
			   WHERE Tbl.Col.value( 'InventoryTracking[1]', 'NVARCHAR(2000)' ) <> 'DontTrackInventory' 
			   AND Tbl.Col.value( 'Quantity[1]', 'Numeric(28,6)' ) > 0
			   ;
		DECLARE @Cur_WarehouseId int, @Cur_PortalId int, @Cur_PortalWarehouseId int, @Cur_WarehouseSequence int, @Cur_SKU varchar(200), @Cur_Quantity numeric(28, 6), @Cur_ReOrderLevel numeric(28, 6), @Cur_InventoryId int;

		DECLARE @RecurringQuantity numeric(28, 6), @BalanceQuantity numeric(28, 6)
		SET @Status = 0; 
   
		Update X SET x.OrderLineItemRelationshipTypeId = b.OrderLineItemRelationshipTypeId 
		FROM ZnodeOmsOrderLineItems a
		inner join ZnodeOmsOrderLineItems b on a.OmsOrderLineItemsId = b.ParentOmsOrderLineItemsId 
		inner join @TBL_XmlReturnToTable X on x.OrderLineItemId = a.OmsOrderLineItemsId
		where a.ParentOmsOrderLineItemsId is null
		and b.ParentOmsOrderLineItemsId is not null


		DECLARE @TBL_CalculateQuntity TABLE
		( 
			WarehouseId int, SKU varchar(200), MainQuantity numeric(28, 6), InventoryId int, OrderQuantity numeric(28, 6), UpdatedQuantity numeric(28, 6), WarehouseSequenceId int, InventoryTracking nvarchar(2000)
			, AllowBackOrder varchar(100)
		);
		
		DECLARE @TBL_AllwareHouseToportal TABLE
		( 
			WarehouseId int, PortalId int, PortalWarehouseId int, WarehouseSequenceFirst int, WarehouseSequence int, SKU varchar(200), Quantity numeric(28, 6), ReOrderLevel numeric(28, 6), InventoryId int
		);
		
	
		INSERT INTO @TBL_AllwareHouseToportal( WarehouseId, PortalId, PortalWarehouseId, SKU, Quantity, ReOrderLevel, InventoryId, WarehouseSequence, WarehouseSequenceFirst )
			SELECT ZPW.WarehouseId, ZPW.PortalId, zpw.PortalWarehouseId, zi.SKU, zi.Quantity, zi.ReOrderLevel, zi.InventoryId, DENSE_RANK() OVER(ORDER BY ZPW.WarehouseId), 1
			FROM dbo.ZnodeInventory AS zi
			LEFT JOIN [ZnodePortalWarehouse] AS ZPW ON ZPW.WarehouseId = ZI.WareHouseId AND  ZPW.PortalId = @PortalId
			WHERE EXISTS ( SELECT TOP 1 1  FROM @TBL_XmlReturnToTable AS TBXRT WHERE RTRIM(LTRIM(TBXRT.SKU)) = RTRIM(LTRIM(zi.SKU))) 
			AND ZPW.WarehouseId IS NOT NULL
			ORDER BY ZPW.Precedence DESC
			
			INSERT INTO @TBL_AllwareHouseToportal( WarehouseId, PortalId, PortalWarehouseId, SKU, Quantity, ReOrderLevel, InventoryId, WarehouseSequence, WarehouseSequenceFirst )
			SELECT zpaw.WarehouseId, @PortalId, zpaw.PortalWarehouseId, zi.SKU, zi.Quantity, zi.ReOrderLevel, zi.InventoryId, DENSE_RANK() OVER (ORDER BY zpaw.WarehouseId),
			CASE WHEN EXISTS ( SELECT TOP 1 1 FROM @TBL_AllwareHouseToportal WE WHERE WE.SKU = ZI.SKU  ) THEN 2 ELSE 1 END
			FROM dbo.ZnodeInventory AS zi 
			INNER JOIN [dbo].[ZnodePortalAlternateWarehouse] AS zpaw ON zpaw.WarehouseId = ZI.WareHouseId
			WHERE EXISTS ( SELECT TOP 1 1 FROM [ZnodePortalWarehouse] AS a WHERE zpaw.PortalWarehouseId = a.PortalWarehouseId AND  a.PortalId = @PortalId) AND 
			EXISTS ( SELECT TOP 1 1 FROM @TBL_XmlReturnToTable AS TBXRT WHERE RTRIM(LTRIM(TBXRT.SKU)) = RTRIM(LTRIM(zi.SKU))) ORDER BY ZPAW.Precedence DESC;

		--Total Avaialble qunatity in all warehouse 
		IF EXISTS ( SELECT TOP 1 1 FROM @TBL_XmlReturnToTable WHERE InventoryTracking = 'DisablePurchasing')
		BEGIN
			INSERT INTO @TBL_ErrorInventoryTracking 
			SELECT TBAHL.SKU, SUM(TBAHL.Quantity), InventoryTracking,TBXML.AllowBackOrder 
			FROM @TBL_XmlReturnToTable AS TBXML
			LEFT JOIN @TBL_AllwareHouseToportal AS TBAHL ON(TBAHL.SKU = TBXML.SKU) 
			INNER JOIN ZnodeOmsOrderLineItems b on (TBXML.orderlineitemid = b.OmsOrderLineItemsId)
			WHERE InventoryTracking = 'DisablePurchasing'
			AND b.OrderLineItemRelationshipTypeId IS NOT NULL
			GROUP BY TBXML.AllowBackOrder ,TBAHL.SKU, InventoryTracking HAVING SUM(TBAHL.Quantity) < 1 ORDER BY TBAHL.SKU;
			IF EXISTS ( SELECT TOP 1 1 FROM @TBL_ErrorInventoryTracking )
			BEGIN
				SET @Status = 0;
				RAISERROR(15600, -1, -1, 'DisablePurchasing');
			END;
		END;

		---Getting data for simple , configurable and group
		INSERT INTO @TBL_CalculateQuntity
		SELECT WarehouseId, TBXML.SKU, TBAHL.Quantity, TBAHL.InventoryId, TBXML.Quantity, NULL AS UpdatedQuantity, DENSE_RANK() 
		OVER(ORDER BY WarehouseSequenceFirst,WarehouseSequence), InventoryTracking, TBXML.AllowBackOrder
		FROM @TBL_XmlReturnToTable AS TBXML	
		INNER  JOIN @TBL_AllwareHouseToportal AS TBAHL ON(TBAHL.SKU = TBXML.SKU)
		where exists(select * from ZnodeOmsOrderLineItems ZOOLI where TBXML.OrderLineItemId = ZOOLI.OmsOrderLineItemsId
			and ZOOLI.ParentOmsOrderLineItemsId is not null) 
		AND isnull(TBXML.OrderLineItemRelationshipTypeId,0) <> (Select top 1 OrderLineItemRelationshipTypeId From ZnodeOmsOrderLineItemRelationshipType Where Name IN ('Bundles','Configurable','Group'))
		ORDER BY  WarehouseSequenceFirst,WarehouseSequence;

		---Getting data for bundle products
		INSERT INTO @TBL_CalculateQuntity
		SELECT WarehouseId, TBXML.SKU, TBAHL.Quantity, TBAHL.InventoryId, TBXML.Quantity, NULL AS UpdatedQuantity, DENSE_RANK() 
		OVER(ORDER BY WarehouseSequenceFirst,WarehouseSequence), InventoryTracking, TBXML.AllowBackOrder
		FROM @TBL_XmlReturnToTable AS TBXML	
		INNER  JOIN @TBL_AllwareHouseToportal AS TBAHL ON(TBAHL.SKU = TBXML.SKU)
		where exists(select * from ZnodeOmsOrderLineItems ZOOLI where TBXML.OrderLineItemId = ZOOLI.OmsOrderLineItemsId and ZOOLI.ParentOmsOrderLineItemsId is null)
		AND TBXML.OrderLineItemRelationshipTypeId = (Select top 1 OrderLineItemRelationshipTypeId From ZnodeOmsOrderLineItemRelationshipType Where Name IN ('Bundles','Configurable','Group'))
		ORDER BY  WarehouseSequenceFirst,WarehouseSequence;

		;with cte as
		(
			select WarehouseId,	a.SKU,	MainQuantity,	InventoryId,	WarehouseSequenceId,	a.InventoryTracking,	AllowBackOrder,sum(OrderQuantity) as OrderQuantity
			from @TBL_CalculateQuntity A
			group by WarehouseId,	a.SKU,	MainQuantity,	InventoryId,	WarehouseSequenceId,	InventoryTracking,	AllowBackOrder
		)
		update b set  b.OrderQuantity = a.OrderQuantity
		from cte a
		inner join @TBL_CalculateQuntity b on a.SKU = b.SKU and a.InventoryId = b.InventoryId and a.WarehouseId = b.WarehouseId

		
		UPDATE @TBL_CalculateQuntity 
		SET UpdatedQuantity = MainQuantity - OrderQuantity  
		WHERE WarehouseSequenceId = 1;
		 		
		DECLARE @CountToRepeate int= ( SELECT count( distinct WarehouseId) FROM @TBL_CalculateQuntity),@Initializationofloop int= 2;
       
		WHILE @Initializationofloop <= @CountToRepeate 
				AND EXISTS (SELECT TOP 1 1 FROM @TBL_CalculateQuntity AS a 
					WHERE UpdatedQuantity < 0  )
		BEGIN
		 
			UPDATE a  
			SET a.UpdatedQuantity = a.MainQuantity + b.UpdatedQuantity 
			FROM @TBL_CalculateQuntity a 
			INNER JOIN @TBL_CalculateQuntity b ON (a.Sku = b.Sku AND b.WarehouseSequenceId = (@Initializationofloop - 1)) 
			WHERE a.WarehouseSequenceId = @Initializationofloop 
			AND b.UpdatedQuantity < 0
			AND b.UpdatedQuantity IS NOT NULL 
			--AND a.WarehouseSequenceId = @Initializationofloop - 1

			UPDATE @TBL_CalculateQuntity 
			SET UpdatedQuantity  = 0 
			WHERE WarehouseSequenceId = @Initializationofloop -1 
			--AND  InventoryTracking <> 'AllowBackordering'
			AND UpdatedQuantity < 0
			AND UpdatedQuantity IS NOT NULL 
			--AND WarehouseSequenceId = @Initializationofloop - 1


			SET @Initializationofloop = @Initializationofloop + 1;
		END; 
		
		
		   IF EXISTS (SELECT TOP 1 1 FROM @TBL_CalculateQuntity WHERE ISNULL(UpdatedQuantity,0) < 0 AND @CountToRepeate >1)
		   BEGIN 
		    UPDATE a  
			SET a.UpdatedQuantity = b.UpdatedQuantity 
			FROM @TBL_CalculateQuntity a 
			INNER JOIN @TBL_CalculateQuntity b ON (a.Sku = b.Sku AND b.WarehouseSequenceId = @Initializationofloop -1 ) 
			WHERE a.WarehouseSequenceId = 1 
			AND ISNULL(b.UpdatedQuantity,0) < 0

			UPDATE @TBL_CalculateQuntity 
			SET UpdatedQuantity  = 0 
			WHERE WarehouseSequenceId = @Initializationofloop -1 
			--AND  InventoryTracking <> 'AllowBackordering'
		    AND ISNULL(UpdatedQuantity,0) < 0
		   END 
			
			
		--If "AllowBackordering" then inventory will go to be negative conside only single warehouse
		IF EXISTS(SELECT TOP 1 1 FROM @TBL_XmlReturnToTable WHERE InventoryTracking = 'AllowBackordering')
		BEGIN
			UPDATE ZI SET Quantity = Isnull(TBCQ.UpdatedQuantity,0) 
			FROM dbo.ZnodeInventory ZI 
			INNER JOIN @TBL_CalculateQuntity TBCQ ON(Zi.InventoryId = TBCQ.InventoryId)
			WHERE InventoryTracking = 'AllowBackordering' AND  UpdatedQuantity IS NOT NULL  ;
			SET @Status = 1;
		END;
		
		-- If @InventoryTracking is "DisablePurchasing" then subtracts currently selected quantity only when it will greater than zero.
		IF EXISTS ( SELECT TOP 1 1 FROM @TBL_XmlReturnToTable WHERE InventoryTracking = 'DisablePurchasing')
		BEGIN
			SET @BalanceQuantity = 1;
			UPDATE ZI 
			SET Quantity = CASE WHEN TBCQ.UpdatedQuantity < 0 THEN 0 ELSE TBCQ.UpdatedQuantity END 
			FROM dbo.ZnodeInventory ZI 
			INNER JOIN  @TBL_CalculateQuntity TBCQ ON(Zi.InventoryId = TBCQ.InventoryId) WHERE InventoryTracking = 'DisablePurchasing'
			AND TBCQ.UpdatedQuantity IS NOT NULL 
			;
		END;
		
		INSERT INTO ZnodeOmsOrderWarehouse( OmsOrderLineItemsId, WarehouseId,Quantity, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate )
		SELECT OrderLineItemId, WarehouseId,CASE WHEN UpdatedQuantity = 0 THEN MainQuantity ELSE MainQuantity - UpdatedQuantity END , @UserId, dbo.Fn_GetDate(), @UserId, dbo.Fn_GetDate() 
		FROM @TBL_CalculateQuntity AS TBCQ 
		INNER JOIN @TBL_XmlReturnToTable AS TBXR
			   ON(TBXR.SKU = TBCQ.SKU) WHERE UpdatedQuantity IS NOT NULL;
  
		SELECT DISTINCT SKU,
		 [dbo].[Fn_GetDefaultPriceRoundOffReturnNumeric](UpdatedQuantity) AS Quantity,
		  InventoryTracking,CAST(AllowBackOrder AS BIT) AllowBackOrder
		FROM @TBL_CalculateQuntity
		WHERE UpdatedQuantity IS NOT NULL;

		SET @Status = 1;
		COMMIT TRAN UpdateInventory;
	END TRY
	BEGIN CATCH
	
		SET @Status = 0;
		SELECT SKU, Quantity, InventoryTracking,AllowBackOrder
		FROM @TBL_ErrorInventoryTracking;
		
		ROLLBACK TRAN UpdateInventory;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertQuoteTaxDetails')
	DROP PROC Znode_InsertQuoteTaxDetails

GO

CREATE PROCEDURE [dbo].[Znode_InsertQuoteTaxDetails]
(
	@OmsQuoteId INT,
	@TaxRuleId INT,
	@TaxRate NUMERIC(28,6),
	@status BIT OUT
)
AS
/* Summary :- This Procedure is used to insert the  TaxRule Data
Unit Testing
EXEC [Znode_InsertQuoteTaxDetails] @OmsQuoteId = 1467, @TaxRuleId = 10
*/
BEGIN
SET NOCOUNT ON;

BEGIN TRY
BEGIN TRAN
DECLARE @GetDate DATETIME = dbo.Fn_GetDate();

	--------Insert TaxRule Data
	IF(NOT EXISTS(SELECT 1 from ZnodeOmsQuoteTaxRule where OmsQuoteId= @OmsQuoteId))
	BEGIN
		INSERT INTO ZnodeOmsQuoteTaxRule
		(
			OmsQuoteId,TaxRuleId,TaxRuleTypeId,TaxClassId,DestinationCountryCode,DestinationStateCode,CountyFIPS,Precedence, SalesTax,
			VAT,GST,PST,HST,TaxShipping,Custom1,Custom2,Custom3,ExternalID,ZipCode,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		)
		--OUTPUT INSERTED.OmsOrderId INTO @ZnodeOmsQuoteTaxRule
		SELECT @OmsQuoteId,TaxRuleId,TaxRuleTypeId,TaxClassId,DestinationCountryCode,DestinationStateCode,CountyFIPS,Precedence,
			(CASE When @TaxRate > 0 then @TaxRate ELSE SalesTax END) AS SalesTax,VAT,GST,PST,HST,TaxShipping,Custom1,Custom2,Custom3,
			ExternalID,ZipCode,CreatedBy,@GetDate ,ModifiedBy,@GetDate
		FROM ZnodeTaxRule
		WHERE TaxRuleId = @TaxRuleId
	END

SET @status = 1;
COMMIT TRAN
END TRY
BEGIN CATCH
	SET @Status = 0;
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertQuoteTaxDetails @OmsQuoteId = '+CAST(@OmsQuoteId AS VARCHAR(10))+',@TaxRuleId='+CAST(@TaxRuleId AS VARCHAR(50))
             
	ROLLBACK TRAN
	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_InsertQuoteTaxDetails',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
END CATCH;
END

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodeOmsQuoteOrderDiscount')
BEGIN
	CREATE TABLE [dbo].[ZnodeOmsQuoteOrderDiscount] (
    [OmsQuoteOrderDiscountId]        INT             IDENTITY (1, 1) NOT NULL,
    [OmsQuoteId]         INT             NULL,
    [OmsQuoteLineItemId]        INT             NULL,
    [OmsDiscountTypeId]         INT             NULL,
    [DiscountCode]              VARCHAR (300)   NULL,
    [DiscountAmount]            NUMERIC (28, 6) NULL,
    [Description]               NVARCHAR (MAX)  NULL,
    [CreatedBy]                 INT             NOT NULL,
    [CreatedDate]               DATETIME        NOT NULL,
    [ModifiedBy]                INT             NOT NULL,
    [ModifiedDate]              DATETIME        NOT NULL,
    [PerQuantityDiscount]       NUMERIC (28, 6) NULL,
    [DiscountMultiplier]        NUMERIC (28, 6) NULL,
    [ParentOmsQuoteLineItemId] INT             NULL,
    [DiscountLevelTypeId]       INT             NULL,
    [PromotionName]             NVARCHAR (600)  NULL,
	[PromotionTypeId]           INT             NULL,
	[DiscountAppliedSequence]   INT             NULL,
	[PromotionMessage]          NVARCHAR (MAX)  NULL,
    CONSTRAINT [PK_ZnodeOmsQuoteOrderDiscount] PRIMARY KEY CLUSTERED ([OmsQuoteOrderDiscountId] ASC) WITH (FILLFACTOR = 90),
    CONSTRAINT [FK_ZnodeOmsQuoteOrderDiscount_ZnodeOmsDiscountType] FOREIGN KEY ([OmsDiscountTypeId]) REFERENCES [dbo].[ZnodeOmsDiscountType] ([OmsDiscountTypeId]),
    CONSTRAINT [FK_ZnodeOmsQuoteOrderDiscount_ZnodeOmsQuoteId] FOREIGN KEY ([OmsQuoteId]) REFERENCES [dbo].[ZnodeOmsQuote] ([OmsQuoteId]),
    CONSTRAINT [FK_ZnodeOmsQuoteOrderDiscount_ZnodeOmsQuoteLineItem] FOREIGN KEY ([OmsQuoteLineItemId]) REFERENCES [dbo].[ZnodeOmsQuoteLineItem] ([OmsQuoteLineItemId]),
    CONSTRAINT [FK_ZnodeOmsQuoteOrderDiscount_ZnodePromotionType] FOREIGN KEY ([PromotionTypeId]) REFERENCES [dbo].[ZnodePromotionType] ([PromotionTypeId])
	);
END 

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodeOmsQuoteTaxOrderDetails')
BEGIN
	CREATE TABLE [dbo].[ZnodeOmsQuoteTaxOrderDetails] (
    [OmsQuoteTaxOrderDetailsId] INT             IDENTITY (1, 1) NOT NULL,
    [OmsQuoteId]    INT             NOT NULL,
    [SalesTax]             NUMERIC (28, 6) NULL,
    [VAT]                  NUMERIC (28, 6) NULL,
    [GST]                  NUMERIC (28, 6) NULL,
    [PST]                  NUMERIC (28, 6) NULL,
    [HST]                  NUMERIC (28, 6) NULL,
    [CreatedBy]            INT             NOT NULL,
    [CreatedDate]          DATETIME        NOT NULL,
    [ModifiedBy]           INT             NOT NULL,
    [ModifiedDate]         DATETIME        NOT NULL,
    [ImportDuty] NUMERIC(28,6) NULL,
    CONSTRAINT [PK_ZnodeOmsQuoteTaxOrderDetails] PRIMARY KEY CLUSTERED ([OmsQuoteTaxOrderDetailsId] ASC) WITH (FILLFACTOR = 90),
    CONSTRAINT [FK_ZnodeOmsQuoteTaxOrderDetails_ZnodeOmsQuote] 
	FOREIGN KEY ([OmsQuoteId]) REFERENCES [dbo].[ZnodeOmsQuote] ([OmsQuoteId])
	);
END 

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodeOmsQuoteTaxRule')
BEGIN
	CREATE TABLE [dbo].[ZnodeOmsQuoteTaxRule](
	[OmsTaxRuleId] [int] IDENTITY(1,1) NOT NULL,
	[OmsQuoteId] [int] NOT NULL,
	[TaxRuleId] [int] NOT NULL,
	[TaxRuleTypeId] [int] NULL,
	[TaxClassId] [int] NULL,
	[DestinationCountryCode] [nvarchar](10) NULL,
	[DestinationStateCode] [nvarchar](255) NULL,
	[CountyFIPS] [nvarchar](50) NULL,
	[Precedence] [int] NOT NULL,
	[SalesTax] [decimal](18, 5) NULL,
	[VAT] [decimal](18, 2) NULL,
	[GST] [decimal](18, 2) NULL,
	[PST] [decimal](18, 2) NULL,
	[HST] [decimal](18, 2) NULL,
	[TaxShipping] [bit] NOT NULL,
	[Custom1] [nvarchar](max) NULL,
	[Custom2] [nvarchar](max) NULL,
	[Custom3] [nvarchar](max) NULL,
	[ExternalID] [varchar](50) NULL,
	[ZipCode] [nvarchar](max) NULL,
	[CreatedBy] [int] NOT NULL,
	[CreatedDate] [datetime] NOT NULL,
	[ModifiedBy] [int] NOT NULL,
	[ModifiedDate] [datetime] NOT NULL,
	 CONSTRAINT [PK_ZnodeOmsQuoteTaxRule] PRIMARY KEY CLUSTERED ([OmsTaxRuleId] ASC), 
	 CONSTRAINT [FK_ZnodeOmsQuoteTaxRule_ZnodeOmsQuote] FOREIGN KEY([OmsQuoteId]) REFERENCES [dbo].[ZnodeOmsQuote] ([OmsQuoteId])
	 )
END

GO

Update ZnodeApplicationSetting Set setting='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>MediaAttributeGroupId</name><headertext>Checkbox</headertext><width>10</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>y</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>Id</islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>GroupCode</name><headertext>Group Code</headertext><width>50</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>y</isconditional><isallowlink>n</isallowlink><islinkactionurl>/MediaManager/AttributeGroup/Edit</islinkactionurl><islinkparamfield>MediaAttributeGroupId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>Id</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>y</allowdetailview></column><column><id>3</id><name>AttributeGroupName</name><headertext>Group Label</headertext><width>50</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>y</isconditional><isallowlink>y</isallowlink><islinkactionurl>/MediaManager/AttributeGroup/Edit</islinkactionurl><islinkparamfield>MediaAttributeGroupId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>Id</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>y</allowdetailview></column><column><id>4</id><name>IsSystemDefined</name><headertext>Is System Defined</headertext><width>0</width><datatype>Boolean</datatype><columntype>Boolean</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>ModifiedDate</name><headertext>Modified</headertext><width>30</width><datatype>String</datatype><columntype>DateTime</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>CreatedDate</name><headertext>Created</headertext><width>30</width><datatype>String</datatype><columntype>DateTime</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>Manage</name><headertext>Action</headertext><width>50</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>Edit|Delete</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>y</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>MediaAttributeGroupId|MediaAttributeGroupId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>Id</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/MediaManager/AttributeGroup/Edit|/MediaManager/AttributeGroup/Delete</manageactionurl><manageparamfield>MediaAttributeGroupId|MediaAttributeGroupId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName= 'ZnodeMediaAttributeGroup'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_CatalogProductDraftForPublish')
	DROP PROC Znode_CatalogProductDraftForPublish

GO

CREATE PROCEDURE Znode_CatalogProductDraftForPublish
(
	@PublishCatalogId INT
)
AS
BEGIN
BEGIN TRY 
SET NOCOUNT ON 
	SELECT ZPCP.PimProductId
	INTO #DraftProduct
	FROM ZnodePimCategoryProduct ZPCP WITH(NOLOCK)
	INNER JOIN ZnodePimCategoryHierarchy ZPCH WITH(NOLOCK) ON ZPCP.PimCategoryId = ZPCH.PimCatalogId 
	WHERE EXISTS(SELECT * FROM ZnodePublishCatalog ZPC WITH(NOLOCK) WHERE ZPC.PublishCatalogId = @PublishCatalogId AND ZPCH.PimCatalogId = ZPC.PimCatalogId )

	Update ZPP SET PublishStateId = 2, IsProductPublish = 0 , ModifiedDate = GETDATE() 
	FROM ZnodePimProduct ZPP 
	WHERE EXISTS(SELECT * FROM #DraftProduct DP WHERE ZPP.PimProductId = DP.PimProductId)

	Update ZPP SET PublishStateId = 2, IsProductPublish = 0 , ModifiedDate = GETDATE() 
	FROM ZnodePimProduct ZPP WITH(NOLOCK)
	where EXISTS(SELECT * FROM ZnodePimProductTypeAssociation PTA WITH(NOLOCK) WHERE ZPP.PimProductId = PTA.PimProductId 
			AND EXISTS(SELECT * FROM #DraftProduct DP WHERE PTA.PimParentProductId = DP.PimProductId))

	Update ZPP SET PublishStateId = 2, IsProductPublish = 0 , ModifiedDate = GETDATE() 
	FROM ZnodePimProduct ZPP WITH(NOLOCK)
	where EXISTS(SELECT * FROM ZnodePimLinkProductDetail PTA WITH(NOLOCK) WHERE ZPP.PimProductId = PTA.PimProductId 
			AND EXISTS(SELECT * FROM #DraftProduct DP WHERE PTA.PimParentProductId = DP.PimProductId))

	Update ZPP SET PublishStateId = 2, IsProductPublish = 0 , ModifiedDate = GETDATE() 
	FROM ZnodePimProduct ZPP WITH(NOLOCK)
	where EXISTS(SELECT * FROM ZnodePimLinkProductDetail PTA WITH(NOLOCK) WHERE ZPP.PimProductId = PTA.PimProductId 
			AND EXISTS(SELECT * FROM #DraftProduct DP WHERE PTA.PimParentProductId = DP.PimProductId))

	Update ZPP SET PublishStateId = 2, IsProductPublish = 0 , ModifiedDate = GETDATE() 
	FROM ZnodePimProduct ZPP
	where EXISTS(SELECT * FROM ZnodePimAddOnProduct PTA WITH(NOLOCK)
			INNER JOIN ZnodePimAddOnProductDetail ZPA1 WITH(NOLOCK) ON PTA.PimAddOnProductId = ZPA1.PimAddOnProductId
			WHERE ZPP.PimProductId = PTA.PimProductId 
			AND EXISTS(SELECT * FROM #DraftProduct DP WHERE ZPA1.PimChildProductId = DP.PimProductId))
END TRY
BEGIN CATCH
    DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_CatalogProductDraftForPublish @PublishCatalogId = '+CAST(@PublishCatalogId AS VARCHAR(200));

    EXEC Znode_InsertProcedureErrorLog
        @ProcedureName = 'Znode_CatalogProductDraftForPublish',
        @ErrorInProcedure = @Error_procedure,
        @ErrorMessage = @ErrorMessage,
        @ErrorLine = @ErrorLine,
        @ErrorCall = @ErrorCall;
           
END CATCH;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishProductJson')
	DROP PROC Znode_GetPublishProductJson

GO

CREATE PROCEDURE [dbo].[Znode_GetPublishProductJson]  
(  
  @PublishCatalogId INT = 0   
 ,@PimProductId     TransferId Readonly  
 ,@UserId     INT = 0   
 ,@PimCatalogId     INT = 0   
 ,@VersionIdString  VARCHAR(100)= ''  
 ,@Status     Bit  OutPut  
 ,@RevisionState   Varchar(50) = ''  
 ,@IsDraftProductsOnly BIT = 1  
)  
With RECOMPILE  
AS  
/*  
DECLARE @rrte transferId   
INSERT INTO @rrte  
select 1  
  
EXEC [_POC_Znode_GetPublishProductbulk] @PublishCatalogId=9,@UserId= 2 ,@localeIDs = @rrte,@PublishStateId = 3   
  
*/  
BEGIN  
Begin Try   
 SET NOCOUNT ON;  
 Set @Status = 0    
 Declare  @RevisionType VARCHAR(50) = ''   
 Declare @VersionId int = 0   
 DECLARE @PortalId INT = (SELECT TOP 1 POrtalId FROM ZnodePortalCatalog WHERE PublishCatalogId = @PublishCatalogId)  
 DECLARE @PriceListId INT = (SELECT TOP 1 PriceListId FROM ZnodePriceListPortal WHERE PortalId = @PortalId )  
 DECLARE @DomainUrl varchar(max) = (select TOp 1 URL FROM ZnodeMediaConfiguration WHERE IsActive =1)  
 DECLARE @MaxSmallWidth INT  = (SELECT TOP 1  MAX(MaxSmallWidth) FROM ZnodeGlobalMediaDisplaySetting)  
 DECLARE @PimMediaAttributeId INT = dbo.Fn_GetProductImageAttributeId()  
  
 DECLARE @TBL_LocaleId  TABLE (RowId INT IDENTITY(1,1) PRIMARY KEY  , LocaleId INT , VersionId int,RevisionType varchar(50)  )  
 DECLARE @LocaleIds transferId   
  
    INSERT INTO @TBL_LocaleId (LocaleId,VersionId,RevisionType)  
 SELECT PV.LocaleId , PV.VersionId , PV.RevisionType  FROM ZnodePublishVersionEntity PV Inner join Split(@VersionIdString,',') S ON PV.VersionId = S.Item  
   
    
  
  
 Insert into @LocaleIds    
 SELECT  LocaleId  
 FROM ZnodeLocale MT   
 WHERE IsActive = 1  
   
 DECLARE --@ProductNamePimAttributeId INT = dbo.Fn_GetProductNameAttributeId(),  
 @DefaultLocaleId INT= Dbo.Fn_GetDefaultLocaleId(),@LocaleId INT = 0   
  --,@SkuPimAttributeId  INT =  dbo.Fn_GetProductSKUAttributeId() , @IsActivePimAttributeId INT =  dbo.Fn_GetProductIsActiveAttributeId()  
    DECLARE @GetDate DATETIME =dbo.Fn_GetDate()  
  
    DECLARE @DefaultPortal int, @IsAllowIndexing int  
    select @DefaultPortal = ZPC.PortalId, @IsAllowIndexing = 1 from ZnodePimCatalog ZPC Inner Join ZnodePublishCatalog ZPC1 ON ZPC.PimCatalogId = ZPC1.PimCatalogId where ZPC1.PublishCatalogId =  @PublishCatalogId and isnull(ZPC.IsAllowIndexing,0) = 1   
     
   -----delete unwanted publish data  
 delete ZPC from ZnodePublishCategoryProduct ZPC  
 where not exists(select * from ZnodePublishCategory ZC where ZPC.PublishCategoryId = ZC.PublishCategoryId )  
  
 delete ZPP from ZnodePublishCategoryProduct ZPP  
 where not exists(select * from ZnodePublishProduct ZP where ZPP.PublishProductId = ZP.PublishProductId )  
  
 delete ZPP from ZnodePublishCatalogProductDetail ZPP  
 where not exists(select * from ZnodePublishProduct ZP where ZPP.PublishProductId = ZP.PublishProductId )  
  
 delete ZPCP from ZnodePublishCatalogProductDetail ZPCP  
 inner join ZnodePublishProduct b on ZPCP.PublishProductId = b.PublishProductId   
 where not exists(select * from ZnodePimCategoryProduct a  
 inner join ZnodePimCategoryHierarchy ZPCH on ZPCH.PimCategoryID = a.PimCategoryId   
 where b.PimProductId = A.PimProductId and ZPCP.PimCategoryHierarchyId = ZPCH.PimCategoryHierarchyId)  
 and isnull(ZPCP.PimCategoryHierarchyId,0) <> 0 and b.PublishCatalogId = @PublishCatalogId  
 ---------  
  
  
   DECLARE @Counter INT =1 ,@maxCountId INT = (SELECT max(RowId) FROM @TBL_LocaleId )   
  
   CREATE TABLE #ZnodePrice (RetailPrice numeric(28,13),SalesPrice numeric(28,13),CurrencyCode varchar(100), CultureCode varchar(100), CurrencySuffix varchar(100), PublishProductId int)  
   
   CREATE TABLE #ProductSKU (SEOUrl nvarchar(max), SEODescription  nvarchar(max),SEOKeywords  nvarchar(max),SEOTitle  nvarchar(max), PublishProductId int)  
  
 CREATE TABLE #ProductImages (PublishProductId int, ImageSmallPath  varchar(max))  
  
 EXEC Znode_InsertUpdateAttributeDefaultValueJson 1   
 EXEC Znode_InsertUpdateCustomeFieldJson 1   
 EXEC Znode_InsertUpdatePimAttributeJson 1   
  
 ---To draft all catalog products and associated products for full catalog publish  
 IF @IsDraftProductsOnly = 0  
 BEGIN  
  EXEC Znode_CatalogProductDraftForPublish @PublishCatalogId=@PublishCatalogId   
 END  
  
 EXEC [Znode_InsertUpdatePimCatalogProductDetailJson] @PublishCatalogId=@PublishCatalogId,@LocaleId=@LocaleIds ,@UserId=@UserId  
   
  
 if (@IsAllowIndexing=1)  
 begin   
  insert into #ZnodePrice  
  SELECT RetailPrice,SalesPrice,ZC.CurrencyCode,ZCC.CultureCode ,ZCC.Symbol CurrencySuffix,TYU.PublishProductId  
  FROM ZnodePrice ZP   
  INNER JOIN ZnodePriceList ZPL ON (ZPL.PriceListId = ZP.PriceListId)  
  INNER JOIN ZnodeCurrency ZC oN (ZC.CurrencyId = ZPL.CurrencyId )  
  INNER JOIN ZnodeCulture ZCC ON (ZCC.CultureId = ZPL.CultureId)  
  INNER JOIN ZnodePublishProductDetail TY ON (TY.SKU = ZP.SKU )   
  INNER JOIN ZnodePublishProduct TYU ON (TYU.PublishProductId = TY.PublishProductId)   
  WHERE ZP.PriceListId = @PriceListId   
  AND TY.LocaleId = @DefaultLocaleId  
  AND TYU.PublishCatalogId = @PublishCatalogId  
  AND EXISTS (SELECT TOP 1 1 FROM ZnodePriceListPortal ZPLP   
  INNER JOIN ZnodePimCatalog ZPC on ZPC.PortalId=ZPLP.PortalId WHERE ZPLP.PriceListId=ZP.PriceListId )  
  AND EXISTS(select * from ZnodePimProduct ZPP1 where TYU.PimProductId = ZPP1.PimProductId )  
   --+ CAST(@DefaultPortal AS VARCHAr(100)) + '/'  
  insert INTO #ProductImages  
  SELECT  TYU.PublishProductId , @DomainUrl +'Catalog/'  + CAST(@MaxSmallWidth AS VARCHAR(100)) + '/' + RT.MediaPath AS ImageSmallPath     
  FROM ZnodePimAttributeValue ZPAV   
  INNER JOIN ZnodePublishProduct TYU ON (TYU.PimProductId  = ZPAV.PimProductId)  
  INNER JOIN ZnodePimProductAttributeMedia  RT ON ( RT.PimAttributeValueId = ZPAV.PimAttributeValueId )  
  WHERE  TYU.PublishCatalogId = @PublishCatalogId  
  AND RT.LocaleId = @DefaultLocaleId  
  AND ZPAV.PimAttributeId = (SELECT TOp 1 PimAttributeId FROM ZnodePimAttribute WHERE AttributeCode = 'ProductImage')  
  AND EXISTS(select * from ZnodePimProduct ZPP1 where TYU.PimProductId = ZPP1.PimProductId )  
   
  insert INTO #ProductSKU   
  SELECT ZCSD.SEOUrl , ZCDL.SEODescription,ZCDL.SEOKeywords ,ZCDL.SEOTitle, TYU.PublishProductId  
  FROM ZnodeCMSSEODetail ZCSD   
  INNER JOIN ZnodeCMSSEODetailLocale ZCDL ON (ZCDL.CMSSEODetailId = ZCSD.CMSSEODetailId)  
  INNER JOIN ZnodePublishProductDetail TY ON (TY.SKU = ZCSD.SEOCode AND ZCDL.LocaleId = TY.LocaleId)   
  INNER JOIN ZnodePublishProduct TYU ON (TYU.PublishProductId = TY.PublishProductId)  
  WHERE CMSSEOTypeId = (SELECT TOP 1 CMSSEOTypeId FROM ZnodeCMSSEOType WHERE Name = 'Product')   
  AND ZCDL.LocaleId = @DefaultLocaleId  
  AND TYU.PublishCatalogId = @PublishCatalogId  
  --AND ZCSD.PublishStateId = @PublishStateId  
  AND ZCSD.PortalId = @DefaultPortal  
  AND EXISTS(select * from ZnodePimProduct ZPP1 where TYU.PimProductId = ZPP1.PimProductId )  
  
 end  
   
 CREATE NONCLUSTERED INDEX Idx_#ProductSKU_PublishProductId  
 ON [dbo].[#ProductSKU] ([PublishProductId])  
 CREATE NONCLUSTERED INDEX Idx_#ProductImages_PublishProductId  
 ON [dbo].#ProductImages ([PublishProductId])  
 CREATE NONCLUSTERED INDEX Idx_#ZnodePrice_PublishProductId  
 ON [dbo].#ZnodePrice ([PublishProductId])  
  
 SELECT ZPP.Pimproductid,ZPCPD.LocaleId,  
 --'{"Attributes":[' +  
   '[' +  
   (Select STUFF((SELECT ','+ Attributes from ZnodePublishProductAttributeJson a   
   where a.pimproductid = ZPP.pimproductid and a.LocaleId = ZPCPD.LocaleId   
   FOR XML Path (''),Type).value('.', 'varchar(max)') ,1,1,'')  )   
 + ']'  
 --']}'   
 ProductXML  
 into #ProductAttributeXML  
 FROM [ZnodePublishCatalogProductDetail] ZPCPD   
 INNER JOIN ZnodePublishProduct ZPP ON ZPCPD.PublishProductId = ZPP.PublishProductId and ZPCPD.PublishCatalogId = ZPP.PublishCatalogId --where TY.PimProductId = ZPP.PimProductId  AND TY.LocaleId = ZPCPD.LocaleId   
 WHERE ZPCPD.PublishCatalogId = @PublishCatalogId  
 group by pimproductid,ZPCPD.LocaleId  
  
  
 CREATE NONCLUSTERED INDEX Idx_#ProductAttributeXML_PimProductId_LocaleId  
 ON [dbo].#ProductAttributeXML (PimProductId,LocaleId)  
  
 DECLARE @MaxCount INT, @MinRow INT, @MaxRow INT, @Rows numeric(10,2);  
   SELECT @MaxCount = COUNT(*) FROM [ZnodePublishCatalogProductDetail] WHERE PublishCatalogId = @PublishCatalogId;  
  
   SELECT @Rows = 5000  
          
   SELECT @MaxCount = CEILING(@MaxCount / @Rows);  
  
   select PimCatalogProductDetailId, PublishProductId,Row_Number() over(Order by PublishProductId) ID into #ZnodePublishCatalogProductDetail from [ZnodePublishCatalogProductDetail] WHERE PublishCatalogId = @PublishCatalogId  
  
  
  --CREATE NONCLUSTERED INDEX #ZnodePublishCatalogProductDetail  
  
   IF OBJECT_ID('tempdb..#Temp_ImportLoop') IS NOT NULL  
             DROP TABLE #Temp_ImportLoop;  
          
   ---- To get the min and max rows for import in loop  
   ;WITH cte AS   
   (  
   SELECT RowId = 1,   
       MinRow = 1,   
                   MaxRow = cast(@Rows as int)  
            UNION ALL  
            SELECT RowId + 1,   
                   MinRow + cast(@Rows as int),   
                   MaxRow + cast(@Rows as int)  
            FROM cte  
            WHERE RowId + 1 <= @MaxCount  
  )  
        SELECT RowId, MinRow, MaxRow  
        INTO #Temp_ImportLoop  
        FROM cte  
  option (maxrecursion 0);  
    
  
  
  
  DECLARE cur_BulkData CURSOR LOCAL FAST_FORWARD  
        FOR SELECT MinRow, MaxRow, B.LocaleId ,B.VersionId, B.RevisionType  
  FROM #Temp_ImportLoop L  
  CROSS APPLY @TBL_LocaleId B;  
  
        OPEN cur_BulkData;  
        FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow,@LocaleId,@VersionId, @RevisionType  
  WHILE @@FETCH_STATUS = 0  
        BEGIN  
    INSERT INTO ZnodePublishProductEntity (  
     VersionId, --1  
     IndexId, --2   
     ZnodeProductId,ZnodeCatalogId, --3  
     SKU,LocaleId, --4   
     Name,ZnodeCategoryIds, --5  
     IsActive,Attributes,Brands,CategoryName, --6   
     CatalogName,DisplayOrder, --7   
     RevisionType,AssociatedProductDisplayOrder, --8  
     ProductIndex,--9  
     SalesPrice,RetailPrice,CultureCode,CurrencySuffix,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower)  
    
    Select   
     CAST(@VersionId AS VARCHAR(50)) VersionId --1   
     ,CAST(ZPCPD.ProductIndex AS VARCHAr(100)) + CAST(ISNULL(ZPCP.PublishCategoryId,'')  AS VARCHAR(50))  + CAST(Isnull(ZPCPD.PublishCatalogId ,'')  AS VARCHAR(50)) + CAST( Isnull(ZPCPD.LocaleId,'') AS VARCHAR(50)) IndexId  --2  
     ,CAST(ZPCPD.PublishProductId AS VARCHAR(50)) PublishProductId,CAST(ZPCPD.PublishCatalogId  AS VARCHAR(50)) PublishCatalogId  --3   
     ,CAST(ISNULL(ZPCPD.SKU ,'') AS NVARCHAR(2000)) SKU,CAST( Isnull(ZPCPD.LocaleId,'') AS VARCHAR(50)) LocaleId -- 4   
     ,CAST(isnull(ZPCPD.ProductName,'') AS NVARCHAR(2000) )  ProductName ,CAST(ISNULL(ZPCP.PublishCategoryId,'')  AS VARCHAR(50)) PublishCategoryId  -- 5   
     --'{"Attributes":[' + PAX.ProductXML + ']'  
     ,CAST(ISNULL(ZPCPD.IsActive ,'0') AS VARCHAR(50)) IsActive ,PAX.ProductXML,'[]' Brands,CAST(isnull(ZPCPD.CategoryName,'') AS NVARCHAR(2000)) CategoryName  --6  
     ,CAST(Isnull(ZPCPD.CatalogName,'')  AS NVARCHAR(2000)) CatalogName,CAST(ISNULL(ZPCCF.DisplayOrder,'') AS VARCHAR(50)) DisplayOrder  -- 7   
     ,@RevisionType , 0 AssociatedProductDisplayOrder,-- pending  -- 8   
     ZPCPD.ProductIndex,  -- 9  
     Case When @IsAllowIndexing = 1 then  ISNULL(CAST(TBZP.SalesPrice  AS VARCHAr(500)),'') else '' end SalesPrice ,   
     Case When @IsAllowIndexing = 1 then  ISNULL(CAST(TBZP.RetailPrice  AS VARCHAr(500)),'') else '' end RetailPrice ,   
     Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CultureCode ,'') else '' end CultureCode ,   
     Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CurrencySuffix ,'') else '' end CurrencySuffix ,   
     Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CurrencyCode ,'') else '' end CurrencyCode ,   
     Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEODescription,'') else '' end SEODescriptionForIndex,  
     Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEOKeywords,'') else '' end SEOKeywords,  
     Case When @IsAllowIndexing = 1 then  ISNULL(SEOTitle,'') else '' end SEOTitle,  
     Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEOUrl ,'') else '' end SEOUrl,  
     Case When @IsAllowIndexing = 1 then  ISNULL(TBPI.ImageSmallPath,'') else '' end ImageSmallPath,  
     CAST(ISNULL(LOWER(ZPCPD.SKU) ,'') AS NVARCHAR(2000)) Lower_SKU  
     
     FROM [ZnodePublishCatalogProductDetail] ZPCPD  
     INNER JOIN ZnodePublishCatalog ZPCV ON (ZPCV.PublishCatalogId = ZPCPD.PublishCatalogId)  
     INNER JOIN ZnodePublishProduct ZPP ON ZPCPD.PublishProductId = ZPP.PublishProductId and ZPCPD.PublishCatalogId = ZPP.PublishCatalogId  
     INNER JOIN #ProductAttributeXML PAX ON PAX.PimProductId = ZPP.PimProductId  AND PAX.LocaleId = ZPCPD.LocaleId   
     INNER JOIN #ZnodePublishCatalogProductDetail z on ZPCPD.PimCatalogProductDetailId = z.PimCatalogProductDetailId  
     LEFT JOIN  #ZnodePrice TBZP ON (TBZP.PublishProductId = ZPCPD.PublishProductId)  
     LEFT JOIN  #ProductSKU TBPS ON (TBPS.PublishProductId = ZPCPD.PublishProductId)  
     LEFT JOIN  #ProductImages TBPI ON (TBPI.PublishProductId = ZPCPD.PublishProductId)  
     LEFT JOIN  ZnodePublishCategoryProduct ZPCP ON (ZPCP.PublishProductId = ZPCPD.PublishProductId AND ZPCP.PublishCatalogId = ZPCPD.PublishCatalogId AND ZPCP.PimCategoryHierarchyId = ZPCPD.PimCategoryHierarchyId)  
     LEFT JOIN  ZnodePublishCategory ZPC ON (ZPCP.PublishCatalogId = ZPC.PublishCatalogId AND   ZPC.PublishCategoryId = ZPCP.PublishCategoryId AND ZPCP.PimCategoryHierarchyId = ZPC.PimCategoryHierarchyId)  
     LEFT JOIN  ZnodePimCategoryProduct ZPCCF ON (ZPCCF.PimCategoryId = ZPC.PimCategoryId  AND ZPCCF.PimProductId = ZPP.PimProductId )  
     LEFT JOIN  ZnodePimCategoryHierarchy ZPCH ON (ZPCH.PimCatalogId = ZPCV.PimCatalogId AND  ZPCH.PimCategoryHierarchyId =  ZPC.PimCategoryHierarchyId)  
     WHERE      ZPCPD.LocaleId = @LocaleId and z.Id BETWEEN @MinRow AND @MaxRow  
     AND ZPCPD.PublishCatalogId = @PublishCatalogId  
     SET @VersionId = 0  
   FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow,@LocaleId,@VersionId, @RevisionType  
        END;  
  CLOSE cur_BulkData;  
  DEALLOCATE cur_BulkData;  
  
  
  If @RevisionState = 'PREVIEW'   
   UPDATE ZnodePimProduct SET IsProductPublish = 1,PublishStateId =  DBO.Fn_GetPublishStateIdForPreview()    
   WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishProduct ZPP WHERE ZPP.PimProductId = ZnodePimProduct.PimProductId   
   AND ZPP.PublishCatalogId = @PublishCatalogId)  
  Else  
   UPDATE ZnodePimProduct SET IsProductPublish = 1,PublishStateId =  DBO.Fn_GetPublishStateIdForPublish()    
   WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishProduct ZPP WHERE ZPP.PimProductId = ZnodePimProduct.PimProductId   
   AND ZPP.PublishCatalogId = @PublishCatalogId)  
  UPDATE ZnodePublishCatalogLog   
  SET IsProductPublished = 1   
  ,PublishProductId = (SELECT  COUNT(DISTINCT PublishProductId) FROM ZnodePublishCategoryProduct ZPP   
  WHERE ZPP.PublishCatalogId = ZnodePublishCatalogLog.PublishCatalogId AND ZPP.PublishCategoryId IS NOT NULL)   
  WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_LocaleId TY  WHERE  TY.VersionId =ZnodePublishCatalogLog.PublishCatalogLogId )    
  
  
  SET @Status = 1   
END TRY   
BEGIN CATCH   
 SET @Status =0    
 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
  @ErrorLine VARCHAR(100)= ERROR_LINE(),  
  @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishProductJson   
     @PublishCatalogId = '+CAST(@PublishCatalogId AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))  
  +',@PimCatalogId = ' + CAST(@PimCatalogId AS varchar(20))  
  +',@VersionIdString= ' + CAST(@VersionIdString AS varchar(20))  
       
 EXEC Znode_InsertProcedureErrorLog  
  @ProcedureName = 'Znode_GetPublishProductJson',  
  @ErrorInProcedure = @Error_procedure,  
  @ErrorMessage = @ErrorMessage,  
  @ErrorLine = @ErrorLine,  
  @ErrorCall = @ErrorCall;  
END CATCH  
  
END  

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity

GO

CREATE PROCEDURE [dbo].[Znode_PublishCatalogEntity]  
(  
   @PimCatalogId  INT = 0   
  ,@RevisionState varchar(50) = ''   
  ,@UserId int = 0  
  ,@NewGUID nvarchar(500)   
 , @IsDraftProductsOnly BIT = 1  
)  
AS  
/*  
 To publish all catalog product and their details  
 Unit Testing :   
 Exec [dbo].[Znode_PublishCatalogEntity]  
     @PimCatalogId  = 3  
 ,@RevisionState = 'PRODUCTION'   
 ,@UserId = 2  
 ,@NewGUID = '123'  
   
 EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,  
 @NewGUID ='123'   
  
*/  
BEGIN  
BEGIN TRY   
SET NOCOUNT ON  
 Declare @Status Bit =0 , @PublishCatalogId INT=0  
 IF (@PimCatalogId=0)  
 BEGIN  
  --SET @Status =0  
  SELECT 0 AS ID,@Status AS Status;  
  SET @PublishCatalogId=0  
  SELECT @PublishCatalogId;  
 END  
 ELSE  
 BEGIN  
   
 --Declare @NewGUID nvarchar(500) =  newid()  
 Declare @Type varchar(50) = '', @CMSSEOCode varchar(300);  
 SET @Status = 1   
 Declare @IsPreviewEnable int  
 ,@PreviewVersionId INT = 0    
 ,@ProductionVersionId INT = 0  
 --,@PublishCatalogId    INT = 0   
 ,@CatalogProfileId varchar(1000)  
   
  IF OBJECT_ID('tempdb..#CatalogAttributeDetails') IS NOT NULL  
  DROP TABLE #CatalogAttributeDetails  
  CREATE TABLE [dbo].[#CatalogAttributeDetails]  
  (  
  [ZnodeCatalogId] [int] NULL,  
  [AttributeCode] [nvarchar](300) NULL,  
  [AttributeTypeName] [varchar](300) NULL,  
  [IsComparable] [bit] NOT NULL,  
  [IsHtmlTags] [bit] NOT NULL,  
  [IsFacets] [bit] NOT NULL,  
  [IsUseInSearch] [bit] NOT NULL,  
  [IsPersonalizable] [bit] NOT NULL,  
  [IsConfigurable] [bit] NOT NULL,  
  [AttributeName] [nvarchar](300) NULL,  
  [LocaleId] [int] NULL,  
  [DisplayOrder] [int] NULL,  
  [DefaultValueDisplayOrder] [int] NULL,  
  [AttributeDefaultValue] [nvarchar](max) NULL  
  ) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]  
  Declare @CatalogName varchar(100),@UserName Varchar(50)  
  SET @PublishCatalogId = ISNULL((SELECT TOP 1 PublishCatalogId FROM ZnodePublishCatalog ZPC WHERE ZPC.PimCatalogId = @PimCatalogId), 0)  
    
  Select TOP 1  @UserName = aspNetZnodeUser.UserName from ZnodeUser Inner Join aspNetUsers ON ZnodeUser.aspNetUserId = aspNetUsers.Id   
  Inner Join aspNetZnodeUser on aspNetUsers.UserName = aspNetZnodeUser.AspNetZnodeUserId  
  where ZnodeUser.UserId = @userId  
  
  Select @CatalogName = CatalogName from ZnodePimCatalog where PimCatalogId = @PimCatalogId   
  Delete from ZnodePublishProgressNotifierEntity where JOBName =@CatalogName   
  INSERT INTO ZnodePublishProgressNotifierEntity  
  (VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriendlyName)  
  Values(0,@NewGUID , Isnull(@CatalogName,'') + ' Catalog ', 0 , 0 , 0 , '' , @UserId, @UserName )  
  
     If Exists (SELECT  * from ZnodePublishStateApplicationTypeMapping PSA where PSA.IsEnabled =1 and    
  Exists (select TOP 1 1  from ZnodePublishState PS where PS.PublishStateId = PSA.PublishStateId ) and ApplicationType =  'WebstorePreview')  
   SET @IsPreviewEnable = 1   
  else   
   SET @IsPreviewEnable = 0   
  
  --Genrate preview entry   
  DECLARE @SetLocaleId INT , @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleId(), @MaxCount INT =0 , @IncrementalId INT = 1    
  DECLARE @TBL_Locale TABLE (LocaleId INT , RowId INT IDENTITY(1,1))  
    
  IF object_id('tempdb..[#Tbl_NewVersionEntity]') IS NOT NULL  
   drop table tempdb..#Tbl_NewVersionEntity  
  Create Table #Tbl_NewVersionEntity(PublishCatalogId int , VersionId int , LocaleId int , PublishType varchar(50) )  
  
  IF object_id('tempdb..[#Tbl_OldVersionEntity]') IS NOT NULL  
   drop table tempdb..#Tbl_OldVersionEntity  
  Create Table #Tbl_OldVersionEntity(PublishCatalogId int , NewVersionId int ,OldVersionId int , LocaleId int , PublishType varchar(50) )  
    
    
  if @PublishCatalogId > 0   
      
    UPDATE ZPC SET CatalogName = ZC.CatalogName,ExternalId = ZC.ExternalId,PimCatalogId= @PimCatalogId,CreatedBy = @UserId,  
       CreatedDate = Getdate(),ModifiedBy = @UserId,ModifiedDate = Getdate()  
       FROM ZnodePublishCatalog ZPC   
       INNER JOIN ZnodePimCatalog ZC ON(ZC.PimCatalogId = ZPC.PimCatalogId)  
       WHERE ZPC.PimCatalogId = @PimCatalogId;  
  Else  
  Begin  
   INSERT INTO ZnodePublishCatalog (PimCatalogId,CatalogName,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)  
   SELECT PimCatalogId,CatalogName,ExternalId,@UserId,Getdate(),@UserId,Getdate() FROM ZnodePimCatalog AS ZPC   
   WHERE ZPC.PimCatalogId = @PimCatalogId;  
                        
   SET @PublishCatalogId = SCOPE_IDENTITY();  
        End  
  
  INSERT INTO @TBL_Locale (LocaleId) SELECT LocaleId FROM ZnodeLocale WHERE IsActive =1 --AND (LocaleId  = @LocaleId OR @LocaleId = 0 )  
  SET @MaxCount = ISNULL((SELECT MAx(RowId) FROM @TBL_Locale),0)  
  WHILE @IncrementalId <= @MaxCount  
  BEGIN   
   SET @SetLocaleId = (SELECT Top 1 LocaleId FROM @TBL_locale WHERE RowId = @IncrementalId)  
   If @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  )    
   Begin  
    Insert into ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
    IsCategoryPublished,PublishProductId,  
    IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId)  
    Select @PublishCatalogId,  @PimCatalogId,NULL,0,  
    NULL,0,  
    NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(), null ,@SetLocaleId ,DBO.Fn_GetPublishStateIdForProcessing()   
  
    insert into #Tbl_NewVersionEntity (PublishCatalogId,VersionId,LocaleId,PublishType)  
    select @PublishCatalogId, @@Identity , @SetLocaleId ,'PREVIEW'  
      
   End  
   If (@RevisionState like '%Production%' OR @RevisionState = 'None')  
   Begin  
    --Genrate production entry   
    Insert into ZnodePublishCatalogLog  
    (PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
     IsCategoryPublished,PublishProductId,  
     IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId)  
    Select @PublishCatalogId,  @PimCatalogId,NULL,0,  
     NULL,0,  
     NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(), null ,@SetLocaleId ,DBO.Fn_GetPublishStateIdForProcessing()   
     
    insert into #Tbl_NewVersionEntity (PublishCatalogId,VersionId,LocaleId,PublishType)  
    select @PublishCatalogId, @@Identity , @SetLocaleId ,'PRODUCTION'  
   End   
     SET @IncrementalId = @IncrementalId +1   
  END   
  Declare  @VersionIdString varchar(100)= ''    
  SELECT   @VersionIdString = STUFF((SELECT ',' + cast (VersionId as varchar(50))  FROM #Tbl_NewVersionEntity FOR XML PATH ('')), 1, 1, '')   
   
  Truncate table ZnodePublishCatalogErrorLogEntity  
    
  
  Insert into #Tbl_OldVersionEntity (PublishCatalogId,NewVersionId,OldVersionId, LocaleId, PublishType)  
  Select A.PublishCatalogId , A.VersionId, B.VersionId, a.LocaleId,a.PublishType   
  from #Tbl_NewVersionEntity A Inner join ZnodePublishVersionEntity B on   
  A.PublishCatalogId = B.ZnodeCatalogId and A.LocaleId = B.LocaleId AND A.PublishType= B.RevisionType    
   
  Update ZnodePublishProgressNotifierEntity SET   
   ProgressMark =5,   
   IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,  
   IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end    
   where  JobId = @NewGUID  
   
 EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = @PublishCatalogId,@UserId = @UserId , @IsRevertPublish = 0 ,  
 @NewGUID =@NewGUID   
  
 if @Type = 'ZnodePublishCatalogEntity' OR @Type = ''  
 Begin  
   
  Insert INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing)  
  SELECT Distinct VE.VersionId, ZPC.PublishCatalogId, PC.CatalogName,VE.PublishType, VE.LocaleId, isnull(PC.IsAllowIndexing,0)  
  FROM ZnodePublishCatalog ZPC  
  INNER JOIN  #Tbl_NewVersionEntity VE ON (VE.PublishCatalogId = ZPC.PublishCatalogId)  
  Inner join ZnodePimCatalog PC on ZPC.PimCatalogId = PC.PimCatalogId  
  -- Data inserted into flat table ZnodeWebStoreEntity (Replica of MongoDB Collection )    
    
  If @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  )   
  Begin  
   Insert Into ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
   SELECT VersionId,PublishCatalogId,PublishType,LocaleId,0 from  #Tbl_NewVersionEntity where PublishType = 'PREVIEW'  
  End  
  If (@RevisionState like '%Production%' OR @RevisionState = 'None')  
  Begin  
   Insert Into ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
   SELECT VersionId,PublishCatalogId,PublishType,LocaleId,0 from  #Tbl_NewVersionEntity where PublishType = 'PRODUCTION'  
  End  
  
  INSERT INTO ZnodePublishCatalogErrorLogEntity  
  (EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
  SELECT 'ZnodePublishCatalogEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(),   
  @UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId)   
  
 End  
  
 If @Type = 'ZnodePublishCategoryEntity' OR @Type = ''  
 Begin  
  Exec [Znode_GetPublishCategoryJson]  
    @PublishCatalogId = @PublishCatalogId ,  
    @UserId =@UserId,                 
    @VersionIdString = @VersionIdString,  
    @Status  =@Status Out,  
    @RevisionState = @RevisionState   
   
   INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
   SELECT 'ZnodePublishCategoryEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(),   
   @UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId)   
     
   Update ZnodePublishProgressNotifierEntity SET   
   ProgressMark =30,   
   IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,  
   IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end    
   where  JobId = @NewGUID  
  
   If @Status  = 0   
   Begin  
    SELECT 1 AS ID,@Status AS Status;  
    Return 0   
   End  
 End   
   
 If @Type = 'ZnodePublishProductEntity' OR @Type = ''  
 Begin  
  -- Process call catalog publish (include category, products with multiple types)  
  Declare @PimProductId TransferId   
  EXEC [Znode_PublishLatestAssociatedProduct] @PublishCatalogId = @PublishCatalogId, @PimProductId = @PimProductId  , @UserId = @UserId , @PublishStateId =0   
  EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId= @PublishCatalogId ,@userid =@userid ,@PimProductId = @PimProductId   
  EXEC Znode_GetPublishProductJson   
    @PublishCatalogId =@PublishCatalogId   
   ,@PimProductId = @PimProductId   
   ,@UserId = @userid  
   ,@PimCatalogId = @PimCatalogId   
   ,@VersionIdString = @VersionIdString  
   ,@Status  =@Status  Out  
   ,@RevisionState = @RevisionState   
   ,@IsDraftProductsOnly = @IsDraftProductsOnly  
   
    
   INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
   SELECT 'ZnodePublishProductEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(),   
   @UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId)   
  
   Update ZnodePublishProgressNotifierEntity SET   
   ProgressMark =50,   
   IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,  
   IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end    
   where  JobId = @NewGUID  
   If @Status  = 1  
   Begin  
    update ZPCE SET ZPCE.ProductIds =   
    '[' +SUBSTRING((SELECT ','+CAST(PublishProductId AS VARCHAR(50))  
    FROM ZnodePublishCategoryProduct ZPCP   
    WHERE ZPCP.PublishCategoryId = ZPCE.ZnodeCategoryId  
    AND ZPCP.PublishCatalogId = ZPCE.ZnodeCatalogId  FOR XML PATH('')), 2, 8000) + ']'   
    FROM ZnodePublishCategoryEntity  ZPCE where ZPCE.ProductIds is null   
   End  
  
  
  If @Status  = 0   
  Begin  
   SELECT 1 AS ID,@Status AS Status;  
   Return 0   
  End  
 End  
 If @Type = 'ZnodePublishAddOnEntity' OR @Type = ''  
 Begin  
  Exec [Znode_GetPublishAssociatedAddonsJson]  
    @PublishCatalogId = @PublishCatalogId ,  
    @PimProductId   = @PimProductId ,  
    @UserId =@UserId,                 
    @VersionIdString = @VersionIdString,  
    @RevisionType='',  
    @Status  =@Status Out  
  
    
   INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
   SELECT 'ZnodePublishAddOnEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(),   
   @UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId)   
  
   Update ZnodePublishProgressNotifierEntity SET   
   ProgressMark =52,   
   IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,  
   IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end    
   where  JobId = @NewGUID  
     
   If @Status  = 0   
   Begin  
    SELECT 1 AS ID,@Status AS Status;  
    Return 0   
   End  
 End   
   
 If @Type = 'BundleAssociatedProducts' OR @Type = ''  
 Begin  
   Exec [Znode_GetPublishAssociatedProductsJson]  
    @PublishCatalogId = @PublishCatalogId ,  
    @UserId =@UserId,                 
    @VersionIdString = @VersionIdString,  
    @RevisionType = '',  
    @Status  =@Status Out,  
    @ProductType    = 'BundleProduct'  
    
   INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
   SELECT 'BundleAssociatedProducts', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(),   
   @UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId)   
  
   Update ZnodePublishProgressNotifierEntity SET   
   ProgressMark =54,   
   IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,  
   IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end    
   where  JobId = @NewGUID  
     
   If @Status  = 0   
   Begin  
    SELECT 1 AS ID,@Status AS Status;  
    Return 0   
   End  
 End   
 If @Type = 'GroupedAssociatedProducts' OR @Type = ''  
 Begin  
   Exec [Znode_GetPublishAssociatedProductsJson]  
    @PublishCatalogId = @PublishCatalogId ,  
    @UserId =@UserId,                 
    @VersionIdString = @VersionIdString,  
    @RevisionType = '',  
    @Status  =@Status Out,  
    @ProductType    = 'GroupedProduct'  
  
  
    
   INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
   SELECT 'GroupedAssociatedProducts', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(),   
   @UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId)   
     
   Update ZnodePublishProgressNotifierEntity SET   
   ProgressMark =56,   
   IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,  
   IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end    
   where  JobId = @NewGUID  
     
  
   If @Status  = 0   
   Begin  
    SELECT 1 AS ID,@Status AS Status;  
    Return 0   
   End  
 End   
 If @Type = 'ConfigurableAssociatedProducts' OR @Type = ''  
 Begin  
   Exec [Znode_GetPublishAssociatedProductsJson]  
    @PublishCatalogId = @PublishCatalogId ,  
    @UserId =@UserId,                 
    @VersionIdString = @VersionIdString,  
    @RevisionType = '',  
    @Status  =@Status Out,  
    @ProductType= 'ConfigurableProduct'  
  
      
   INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
   SELECT 'ConfigurableAssociatedProducts', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(),   
   @UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId)   
  
   Update ZnodePublishProgressNotifierEntity SET   
   ProgressMark =58,   
   IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,  
   IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end    
   where  JobId = @NewGUID  
     
  
   If @Status  = 0   
   Begin  
    SELECT 1 AS ID,@Status AS Status;  
    Return 0   
   End  
 End   
 If @Type = 'CatalogAttributeaDetail' OR @Type = ''  
 Begin  
  Begin Try  
   Insert into [dbo].[#CatalogAttributeDetails]([ZnodeCatalogId],[AttributeCode],[AttributeTypeName],[IsComparable],  
   [IsHtmlTags],[IsFacets],[IsUseInSearch],[IsPersonalizable],[IsConfigurable],[AttributeName],  
   [LocaleId],[DisplayOrder],[DefaultValueDisplayOrder],[AttributeDefaultValue] )  
   EXEC Znode_GetPublishProductAttribute @PublishCatalogId   
     
   insert into ZnodePublishCatalogAttributeEntity  
   (VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition,IsComparable,  
   IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,  
   AttributeName,LocaleId,DisplayOrder,SelectValues)  
   Select Distinct   
   B.VersionId, A.[ZnodeCatalogId],A.[AttributeCode],A.[AttributeTypeName],0 IsPromoRuleCondition,[IsComparable],  
   [IsHtmlTags],[IsFacets],[IsUseInSearch],[IsPersonalizable],[IsConfigurable],  
   [AttributeName],A.[LocaleId],[DisplayOrder] ,  
   (Select Isnull(IA.AttributeDefaultValue,'') Value , Isnull(IA.[DefaultValueDisplayOrder],'') DisplayOrder    
   from [dbo].[#CatalogAttributeDetails] IA  where IA.AttributeCode = A.AttributeCode AND IA.LocaleId = A.LocaleId   
   For JSON PATH)  
   FROM [dbo].[#CatalogAttributeDetails] A Inner join #Tbl_NewVersionEntity B on A.LocaleId = B.LocaleId  
   
   SET @Status =1   
    
   INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
   SELECT 'CatalogAttributeaDetail', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(),   
   @UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId)   
  
   Update ZnodePublishProgressNotifierEntity SET   
   ProgressMark =60,   
   IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,  
   IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end    
   where  JobId = @NewGUID  
     
  
  END TRY   
  BEGIN CATCH   
   SET @Status   = 0   
     
   INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
   SELECT 'CatalogAttributeaDetail', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(),   
   @UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId)   
  
   If @Status  = 0   
   Begin  
    SELECT 1 AS ID,@Status AS Status;  
    Return 0   
   End  
  End CATCH    
 End   
  
 If @Type = 'ZnodePublishSEOEntity' OR @Type = ''  
 Begin  
     EXEC [Znode_SetPublishSEOEntity]  
    @RevisionState = @RevisionState   
   ,@CMSSEOTypeId  = '1,2'   
   ,@UserId  = @UserId   
   ,@Status  = @Status  OUTPUT   
   ,@IsCatalogPublish = 1    
   ,@VersionIdString  = @VersionIdString   
   ,@IsPreviewEnable  = @IsPreviewEnable   
     
   
   INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
   SELECT 'ZnodePublishSEOEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(),   
   @UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId)   
  
   Update ZnodePublishProgressNotifierEntity SET   
   ProgressMark =70,   
   IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,  
   IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end    
   where  JobId = @NewGUID  
  
   If @Status  = 0   
   Begin  
    SELECT 1 AS ID,@Status AS Status;  
    Return 0   
   End  
  
 End   
  
 IF Exists (select TOP 1 1  from ZnodePublishCatalogErrorLogEntity where  ProcessStatus = 'Fail')   
  Begin  
    
   SET @Status  =0   
   SELECT 1 AS ID,@Status AS Status;  
   INSERT INTO ZnodePublishCatalogErrorLogEntity  
   (EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
   SELECT 'ZnodePublishPortalEntity', @RevisionState , 'Fail' , Getdate(),   
   @UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId)   
     
   EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = @PublishCatalogId,@UserId = @UserId , @IsRevertPublish = 0 ,  
   @NewGUID =@NewGUID   
  
   Update ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed(),  
   IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0, ModifiedDate = Getdate()  
     where PublishCatalogLogId in  (Select VersionId from #Tbl_NewVersionEntity Where PublishType = 'PREVIEW' )  
   Update ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed(),  
   IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0  
   , ModifiedDate = Getdate()  where PublishCatalogLogId in (Select VersionId from #Tbl_NewVersionEntity Where PublishType = 'PRODUCTION' )  
     
   Return 0   
  End  
  
 SET @Status = 1  
  
    
 SELECT @PublishCatalogId AS id,@Status AS Status;     
 END  
END TRY   
BEGIN CATCH   
 SET @Status =0    
  SELECT 1 AS ID,@Status AS Status;     
   
  DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
  @ErrorLine VARCHAR(100)= ERROR_LINE(),  
  @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity   
  @PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))  
  +',@PreviewVersionId = ' + CAST(@PreviewVersionId  AS varchar(20))  
  +',@ProductionVersionId = ' + CAST(@ProductionVersionId  AS varchar(20))  
  +',@RevisionState = ''' + CAST(@RevisionState  AS varchar(50))  
  +',@UserId = ' + CAST(@UserId AS varchar(20)); SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
   
     
 INSERT INTO ZnodePublishCatalogErrorLogEntity  
 (EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
 SELECT 'Znode_PublishCatalogEntity', @RevisionState + isnull(@ErrorMessage,'') , 'Fail' , Getdate(),   
 @UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId)   
   
 EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = @PublishCatalogId,@UserId = @UserId , @IsRevertPublish = 0 ,  
 @NewGUID =@NewGUID   
  
 Update ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed(),  
 IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0 , ModifiedDate = Getdate()   where  PublishCatalogLogId in   
 (Select VersionId from #Tbl_NewVersionEntity Where PublishType = 'PREVIEW' )  
 Update ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed() ,  
 IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0 , ModifiedDate = Getdate() where  PublishCatalogLogId in  
 (Select VersionId from #Tbl_NewVersionEntity Where PublishType = 'PRODUCTION' )  
                        
 EXEC Znode_InsertProcedureErrorLog  
  @ProcedureName = 'Znode_PublishCatalogEntity',  
  @ErrorInProcedure = @Error_procedure,  
  @ErrorMessage = @ErrorMessage,  
  @ErrorLine = @ErrorLine,  
  @ErrorCall = @ErrorCall;  
END CATCH  
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'ParentSku'
AND Object_ID = Object_ID(N'dbo.ZnodeOmsOrderLineItems'))
BEGIN
	ALTER TABLE ZnodeOmsOrderLineItems ADD ParentSku NVARCHAR (600)  NULL;
END

GO

update ZnodeSearchProfile set SearchSubQueryTypeId=(select SearchQueryTypeId from ZnodeSearchQueryType where QueryTypeName='Cross'), Operator='AND'
where IsDefault=1 and ProfileName='ZnodeSearchProfile'
and not exists (select * from ZnodeSearchProfile where ProfileName='ZnodeSearchProfile' and SearchSubQueryTypeId = 7)

GO

update ZnodeSearchProfileAttributeMapping 
set IsUseInSearch=0 
where SearchProfileId=1 and IsFacets = 0 and AttributeCode not in ('ProductName','SKU')
and not exists(select * from ZnodeSearchProfileAttributeMapping where SearchProfileId=1 and IsFacets = 0 and AttributeCode not in ('ProductName','SKU') and IsUseInSearch <> 1)

GO


IF (EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodeCMSWidgetProfileVariant' AND COLUMN_NAME = 'CMSWidgetTemplateId')
 AND EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodeCMSWidgetProfileVariant' AND COLUMN_NAME = 'LocaleId'))
 BEGIN

 IF EXISTS(SELECT * FROM SYS.TABLES WHERE NAME = 'ZnodeCMSWidgetProfileVariant_Temp')
 BEGIN
	DROP TABLE ZnodeCMSWidgetProfileVariant_Temp
 END
CREATE TABLE ZnodeCMSWidgetProfileVariant_Temp (
    CMSWidgetProfileVariantId int NULL,
    CMSContentWidgetId int  NULL,
	ProfileId int,
	LocaleId int  NULL,
	CMSWidgetTemplateId int,
	CreatedBy int,
	CreatedDate datetime,
	ModifiedBy int,
	ModifiedDate datetime
);

declare @sql varchar(max)
set @sql = '
INSERT INTO ZnodeCMSWidgetProfileVariant_Temp(CMSWidgetProfileVariantId,CMSContentWidgetId,ProfileId,LocaleId,CMSWidgetTemplateId)
SELECT CMSWidgetProfileVariantId,CMSContentWidgetId,ProfileId,LocaleId,CMSWidgetTemplateId
FROM ZnodeCMSWidgetProfileVariant'
exec (@sql)
END

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodeCMSContainerTemplate')
BEGIN
	CREATE TABLE [dbo].[ZnodeCMSContainerTemplate](
	[CMSContainerTemplateId] [int] IDENTITY(1,1) NOT NULL,
	[Code] [varchar](200) NOT NULL,
	[Name] [nvarchar](100) NOT NULL,
	[FileName] [nvarchar](2000) NOT NULL,
	[MediaId] [int] NULL,
	[CreatedBy] [int] NOT NULL,
	[CreatedDate] [datetime] NOT NULL,
	[ModifiedBy] [int] NOT NULL,
	[ModifiedDate] [datetime] NOT NULL,
	 CONSTRAINT [PK_ZnodeCMSContainerTemplate] PRIMARY KEY CLUSTERED 
	(
		[CMSContainerTemplateId] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 90) ON [PRIMARY]
	) ON [PRIMARY]

END

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodeCMSContainerProfileVariant')
BEGIN
	CREATE TABLE [dbo].[ZnodeCMSContainerProfileVariant](
		[CMSContainerProfileVariantId] [int] IDENTITY(1,1) NOT NULL,
		[CMSContentContainerId] [int] NOT NULL,
		[ProfileId] [int] NULL,
		[PortalId] [int] NULL,
		[CreatedBy] [int] NOT NULL,
		[CreatedDate] [datetime] NOT NULL,
		[ModifiedBy] [int] NOT NULL,
		[ModifiedDate] [datetime] NOT NULL,
		[PublishStateId] [tinyint] NULL,
	 CONSTRAINT [PK_ZnodeCMSContainerProfileVariant] PRIMARY KEY CLUSTERED 
	(
		[CMSContainerProfileVariantId] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 90) ON [PRIMARY]
	) ON [PRIMARY]

	ALTER TABLE [dbo].[ZnodeCMSContainerProfileVariant]  WITH CHECK ADD  CONSTRAINT [FK_ZnodeCMSContainerProfileVariant_ZnodeProfile] FOREIGN KEY([ProfileId])
	REFERENCES [dbo].[ZnodeProfile] ([ProfileId])

	ALTER TABLE [dbo].[ZnodeCMSContainerProfileVariant] CHECK CONSTRAINT [FK_ZnodeCMSContainerProfileVariant_ZnodeProfile]

	ALTER TABLE [dbo].[ZnodeCMSContainerProfileVariant]  WITH CHECK ADD  CONSTRAINT [FK_ZnodeCMSContainerProfileVariant_ZnodePublishState] FOREIGN KEY([PublishStateId])
	REFERENCES [dbo].[ZnodePublishState] ([PublishStateId])

	ALTER TABLE [dbo].[ZnodeCMSContainerProfileVariant] CHECK CONSTRAINT [FK_ZnodeCMSContainerProfileVariant_ZnodePublishState]
END 

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodeCMSContainerProfileVariantLocale')
BEGIN
	CREATE TABLE [dbo].[ZnodeCMSContainerProfileVariantLocale](
	[CMSContainerProfileVariantLocaleId] [int] IDENTITY(1,1) NOT NULL,
	[CMSContainerProfileVariantId] [int] NOT NULL,
	[CMSContainerTemplateId] [int] NULL,
	[LocaleId] [int] NOT NULL,
	[CreatedBy] [int] NOT NULL,
	[CreatedDate] [datetime] NOT NULL,
	[ModifiedBy] [int] NOT NULL,
	[ModifiedDate] [datetime] NOT NULL,
	[IsActive] [bit] NOT NULL,	
	 CONSTRAINT [PK_ZnodeCMSContainerProfileVariantLocale] PRIMARY KEY CLUSTERED 
	(
		[CMSContainerProfileVariantLocaleId] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
	) ON [PRIMARY]

	ALTER TABLE [dbo].[ZnodeCMSContainerProfileVariantLocale] ADD  DEFAULT ((1)) FOR [IsActive]


	ALTER TABLE [dbo].[ZnodeCMSContainerProfileVariantLocale]  WITH CHECK ADD  CONSTRAINT [FK_ZnodeCMSContainerProfileVariantLocale_ZnodeCMSContainerProfileVariant] FOREIGN KEY([CMSContainerProfileVariantId])
	REFERENCES [dbo].[ZnodeCMSContainerProfileVariant] ([CMSContainerProfileVariantId])


	ALTER TABLE [dbo].[ZnodeCMSContainerProfileVariantLocale] CHECK CONSTRAINT [FK_ZnodeCMSContainerProfileVariantLocale_ZnodeCMSContainerProfileVariant]

	ALTER TABLE [dbo].[ZnodeCMSContainerProfileVariantLocale]  WITH CHECK ADD  CONSTRAINT [FK_ZnodeCMSContainerProfileVariantLocale_ZnodeLocale] FOREIGN KEY([LocaleId])
	REFERENCES [dbo].[ZnodeLocale] ([LocaleId])

	ALTER TABLE [dbo].[ZnodeCMSContainerProfileVariantLocale] CHECK CONSTRAINT [FK_ZnodeCMSContainerProfileVariantLocale_ZnodeLocale]

	ALTER TABLE [dbo].[ZnodeCMSContainerProfileVariantLocale]  WITH CHECK ADD  CONSTRAINT [FK_ZnodeCMSWidgetProfileVariantLocale_ZnodeCMSContainerTemplate] FOREIGN KEY([CMSContainerTemplateId])
	REFERENCES [dbo].[ZnodeCMSContainerTemplate] ([CMSContainerTemplateId])

	ALTER TABLE [dbo].[ZnodeCMSContainerProfileVariantLocale] CHECK CONSTRAINT [FK_ZnodeCMSWidgetProfileVariantLocale_ZnodeCMSContainerTemplate]

END

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodeCMSContentContainer')
BEGIN
	CREATE TABLE [dbo].[ZnodeCMSContentContainer](
	[CMSContentContainerId] [int] IDENTITY(1,1) NOT NULL,
	[Name] [nvarchar](100) NOT NULL,
	[ContainerKey] [nvarchar](50) NOT NULL,
	[FamilyId] [int] NOT NULL,
	[Tags] [nvarchar](1000) NULL,
	[CreatedBy] [int] NOT NULL,
	[CreatedDate] [datetime] NOT NULL,
	[ModifiedBy] [int] NOT NULL,
	[ModifiedDate] [datetime] NOT NULL,
	[PublishStateId] [tinyint] NULL,
	 CONSTRAINT [PK_ZnodeCMSContentContainer] PRIMARY KEY CLUSTERED 
	(
		[CMSContentContainerId] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 90) ON [PRIMARY]
	) ON [PRIMARY]

	ALTER TABLE [dbo].[ZnodeCMSContentContainer] ADD  DEFAULT ((2)) FOR [PublishStateId]

	ALTER TABLE [dbo].[ZnodeCMSContentContainer]  WITH CHECK ADD  CONSTRAINT [FK_ZnodeCMSContentContainer_PublishStateId] FOREIGN KEY([PublishStateId])
	REFERENCES [dbo].[ZnodePublishState] ([PublishStateId])

	ALTER TABLE [dbo].[ZnodeCMSContentContainer] CHECK CONSTRAINT [FK_ZnodeCMSContentContainer_PublishStateId]
END

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodeCMSContentWidget')
BEGIN
	CREATE TABLE ZnodeCMSContentWidget (
    CMSContentWidgetId int NOT NULL  IDENTITY(1,1),
	Name nvarchar(100) NOT NULL,
	WidgetKey nvarchar(50) NOT NULL ,
	PortalId int ,
	FamilyId int NOT NULL,
    Tags nvarchar(1000),
    CreatedBy int NOT NULL,
    CreatedDate datetime NOT NULL, 
    ModifiedBy int NOT NULL,
	ModifiedDate datetime  NOT NULL ,
	CONSTRAINT [PK_ZnodeCMSContentWidget] PRIMARY KEY CLUSTERED ([CMSContentWidgetId] ASC) WITH (FILLFACTOR = 90),

	);
END

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodeCMSContentWidget')
BEGIN
	CREATE TABLE ZnodeCMSContentWidget (
    CMSContentWidgetId int NOT NULL  IDENTITY(1,1),
	Name nvarchar(100) NOT NULL,
	WidgetKey nvarchar(50) NOT NULL ,
	PortalId int ,
	FamilyId int NOT NULL,
    Tags nvarchar(1000),
    CreatedBy int NOT NULL,
    CreatedDate datetime NOT NULL, 
    ModifiedBy int NOT NULL,
	ModifiedDate datetime  NOT NULL ,
	CONSTRAINT [PK_ZnodeCMSContentWidget] PRIMARY KEY CLUSTERED ([CMSContentWidgetId] ASC) WITH (FILLFACTOR = 90),

	);
END

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodeCMSWidgetProfileVariantLocale')
BEGIN
	CREATE TABLE [dbo].[ZnodeCMSWidgetProfileVariantLocale](
		[CMSWidgetProfileVariantLocaleId] [int] IDENTITY(1,1) NOT NULL,
		[CMSWidgetProfileVariantId] [int] NOT NULL,
		[CMSWidgetTemplateId] [int] NULL,
		[LocaleId] [int] NOT NULL,
		[CreatedBy] [int] NOT NULL,
		[CreatedDate] [datetime] NOT NULL,
		[ModifiedBy] [int] NOT NULL,
		[ModifiedDate] [datetime] NOT NULL,
	 CONSTRAINT [PK_ZnodeCMSWidgetProfileVariantLocale] PRIMARY KEY CLUSTERED 
	(
		[CMSWidgetProfileVariantLocaleId] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
	) ON [PRIMARY]

	ALTER TABLE [dbo].[ZnodeCMSWidgetProfileVariantLocale]  WITH CHECK ADD  CONSTRAINT [FK_ZnodeCMSWidgetProfileVariantLocale_ZnodeCMSWidgetProfileVariant] FOREIGN KEY([CMSWidgetProfileVariantId])
	REFERENCES [dbo].[ZnodeCMSWidgetProfileVariant] ([CMSWidgetProfileVariantId])

	ALTER TABLE [dbo].[ZnodeCMSWidgetProfileVariantLocale] CHECK CONSTRAINT [FK_ZnodeCMSWidgetProfileVariantLocale_ZnodeCMSWidgetProfileVariant]

	ALTER TABLE [dbo].[ZnodeCMSWidgetProfileVariantLocale]  WITH CHECK ADD  CONSTRAINT [FK_ZnodeCMSWidgetProfileVariantLocale_ZnodeCMSWidgetTemplate] FOREIGN KEY([CMSWidgetTemplateId])
	REFERENCES [dbo].[ZnodeCMSWidgetTemplate] ([CMSWidgetTemplateId])

	ALTER TABLE [dbo].[ZnodeCMSWidgetProfileVariantLocale] CHECK CONSTRAINT [FK_ZnodeCMSWidgetProfileVariantLocale_ZnodeCMSWidgetTemplate]

	ALTER TABLE [dbo].[ZnodeCMSWidgetProfileVariantLocale]  WITH CHECK ADD  CONSTRAINT [FK_ZnodeCMSWidgetProfileVariantLocale_ZnodeLocale] FOREIGN KEY([LocaleId])
	REFERENCES [dbo].[ZnodeLocale] ([LocaleId])

	ALTER TABLE [dbo].[ZnodeCMSWidgetProfileVariantLocale] CHECK CONSTRAINT [FK_ZnodeCMSWidgetProfileVariantLocale_ZnodeLocale]
END

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodeCMSWidgetTemplate')
BEGIN
	CREATE TABLE ZnodeCMSWidgetTemplate (
    CMSWidgetTemplateId int NOT NULL  IDENTITY(1,1),
	Code varchar(200) not null,
    Name nvarchar(100) NOT NULL,
	FileName nvarchar(2000) NOT NULL,
	MediaId int,
    CreatedBy int NOT NULL,
    CreatedDate datetime NOT NULL, 
    ModifiedBy int NOT NULL,
	ModifiedDate datetime  NOT NULL ,
	CONSTRAINT [PK_ZnodeCMSWidgetTemplate] PRIMARY KEY CLUSTERED ([CMSWidgetTemplateId] ASC) WITH (FILLFACTOR = 90)
	);
END

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodePublishContentContainerEntity')
BEGIN
	CREATE TABLE [dbo].[ZnodePublishContentContainerEntity](
	[PublishContentContainerEntityId] [int] IDENTITY(1,1) NOT NULL,
	[VersionId] [int] NOT NULL,
	[Name] [nvarchar](100) NOT NULL,
	[ContainerKey] [nvarchar](50) NOT NULL,
	[FamilyId] [int] NOT NULL,
	[Tags] [nvarchar](1000) NULL,
	[CreatedBy] [int] NOT NULL,
	[CreatedDate] [datetime] NOT NULL,
	[ModifiedBy] [int] NOT NULL,
	[ModifiedDate] [datetime] NOT NULL,
	 CONSTRAINT [PK_ZnodePublishContentContainerEntity] PRIMARY KEY CLUSTERED 
	(
		[PublishContentContainerEntityId] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 90) ON [PRIMARY]
	) ON [PRIMARY]
END

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodePublishContentContainerVariantEntity')
BEGIN
	CREATE TABLE [dbo].[ZnodePublishContentContainerVariantEntity](
		[PublishContentContainerVariantEntityId] [int] IDENTITY(1,1) NOT NULL,
		[VersionId] [int] NOT NULL,
		[PortalId] [int],
		[LocaleId] [int] NOT NULL,
		[Name] [nvarchar](100) NOT NULL,
		[ContainerKey] [nvarchar](50) NOT NULL,
		[CMSContentContainerId] [int] NOT NULL,
		[ProfileId] [int],
		[CMSContainerTemplateId] [int],
		[CreatedBy] [int] NOT NULL,
		[CreatedDate] [datetime] NOT NULL,
		[ModifiedBy] [int] NOT NULL,
		[ModifiedDate] [datetime] NOT NULL,
		CMSContainerProfileVariantId INT,
	 CONSTRAINT [PK_ZnodePublishContentContainerVariantEntity] PRIMARY KEY CLUSTERED 
	(
		[PublishContentContainerVariantEntityId] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
	) ON [PRIMARY]

	ALTER TABLE [dbo].[ZnodePublishContentContainerVariantEntity]  WITH CHECK ADD  CONSTRAINT [FK_ZnodePublishContentContainerVariantEntity_LocaleId] FOREIGN KEY([LocaleId])
	REFERENCES [dbo].[ZnodeLocale] ([LocaleId])

	ALTER TABLE [dbo].[ZnodePublishContentContainerVariantEntity] CHECK CONSTRAINT [FK_ZnodePublishContentContainerVariantEntity_LocaleId]

	ALTER TABLE [dbo].[ZnodePublishContentContainerVariantEntity]  WITH CHECK ADD  CONSTRAINT [FK_ZnodePublishContentContainerVariantEntity_PortalId] FOREIGN KEY([PortalId])
	REFERENCES [dbo].[ZnodePortal] ([PortalId])

	ALTER TABLE [dbo].[ZnodePublishContentContainerVariantEntity] CHECK CONSTRAINT [FK_ZnodePublishContentContainerVariantEntity_PortalId]

	ALTER TABLE [dbo].[ZnodePublishContentContainerVariantEntity]  WITH CHECK ADD  CONSTRAINT [FK_ZnodePublishContentContainerVariantEntity_ProfileId] FOREIGN KEY([ProfileId])
	REFERENCES [dbo].[ZnodeProfile] ([ProfileId])

	ALTER TABLE [dbo].[ZnodePublishContentContainerVariantEntity] CHECK CONSTRAINT [FK_ZnodePublishContentContainerVariantEntity_ProfileId]
END

GO

IF EXISTS(SELECT 1 FROM sys.columns WHERE [name] = N'CMSContentWidgetId'
           AND [object_id] = OBJECT_ID(N'ZnodeWidgetGlobalAttributeValue'))
BEGIN
    EXEC sp_RENAME 'ZnodeWidgetGlobalAttributeValue.CMSContentWidgetId', 'CMSContentContainerId' , 'COLUMN'
END;

GO

IF EXISTS(SELECT 1 FROM sys.columns WHERE [name] = N'CMSWidgetProfileVariantId'
           AND [object_id] = OBJECT_ID(N'ZnodeWidgetGlobalAttributeValue'))
BEGIN
    EXEC sp_RENAME 'ZnodeWidgetGlobalAttributeValue.CMSWidgetProfileVariantId', 'CMSContainerProfileVariantId' , 'COLUMN'
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ActivateDeactivateAssociatedVariants')
	DROP PROC Znode_ActivateDeactivateAssociatedVariants

GO

CREATE PROCEDURE [dbo].[Znode_ActivateDeactivateAssociatedVariants]
(
	@ContainerProfileVariantIds VARCHAR(2000),
	@IsActivate BIT,
	@status BIT OUT
)
AS
--EXEC Znode_ActivateDeactivateAssociatedVariants '1019,1021,1027',0,0
BEGIN
	BEGIN TRY
	BEGIN TRAN ActDeactivateAssociatedVariant
		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();

		DECLARE @TBL_CMSContainerProfileVariant TABLE(CMSContainerProfileVariantId INT);

		DECLARE @VariantIdsCnt INT;

		INSERT INTO @TBL_CMSContainerProfileVariant (CMSContainerProfileVariantId)
		SELECT item FROM dbo.Split(@ContainerProfileVariantIds,',')

		SELECT @VariantIdsCnt=COUNT(1)
		FROM @TBL_CMSContainerProfileVariant;

		IF EXISTS (	SELECT TOP 1 1 FROM ZnodeCMSContainerProfileVariant CPV
					INNER JOIN @TBL_CMSContainerProfileVariant TCPV ON TCPV.CMSContainerProfileVariantId=CPV.CMSContainerProfileVariantId
					WHERE (CPV.ProfileId IS NULL AND CPV.PortalId IS NULL)
					) AND (@VariantIdsCnt=1)
		BEGIN
			SET @Status = 0;
			SELECT 1 AS ID, @Status AS [Status];
		END

		ELSE
		BEGIN
			UPDATE CPVL
			SET CPVL.IsActive=@IsActivate, CPVL.ModifiedDate=@GetDate
			FROM ZnodeCMSContainerProfileVariant CPV
			INNER JOIN @TBL_CMSContainerProfileVariant TCPV ON TCPV.CMSContainerProfileVariantId=CPV.CMSContainerProfileVariantId
			INNER JOIN ZnodeCMSContainerProfileVariantLocale CPVL ON CPV.CMSContainerProfileVariantId=CPVL.CMSContainerProfileVariantId
			WHERE (CPV.ProfileId IS NOT NULL AND CPV.PortalId IS NOT NULL);

			SET @Status = 1;
			SELECT 1 AS ID, CAST(1 AS BIT) AS [Status];
		END
	COMMIT TRAN ActDeactivateAssociatedVariant;
	END TRY

	BEGIN CATCH
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
			@ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ActivateDeactivateAssociatedVariants 
			@ContainerProfileVariantIds = '+@ContainerProfileVariantIds+',@IsActivate='+CAST(@IsActivate AS VARCHAR(50))+',
			@Status='+CAST(@Status AS VARCHAR(50));

		SET @Status =0
		SELECT 1 AS ID,@Status AS Status;
		ROLLBACK TRAN ActDeactivateAssociatedVariant;
		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ActivateDeactivateAssociatedVariants',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;

	END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeleteAssociatedVariants')
	DROP PROC Znode_DeleteAssociatedVariants

GO

CREATE PROCEDURE [dbo].[Znode_DeleteAssociatedVariants]
(
	@ContainerProfileVariantId  VARCHAR(2000),
	@Status  BIT = 0 OUT
)
AS
BEGIN
BEGIN TRY


	DECLARE @TBL_ContainerProfileVariantId TABLE(CMSContainerProfileVariantId INT); 
             
	INSERT INTO @TBL_ContainerProfileVariantId(CMSContainerProfileVariantId)
	SELECT Item FROM  dbo.Split(@ContainerProfileVariantId, ',')
		
	IF ((SELECT COUNT(1) FROM @TBL_ContainerProfileVariantId) = 1
	AND EXISTS(SELECT * FROM ZnodeCMSContainerProfileVariant 
			WHERE EXISTS(SELECT * FROM @TBL_ContainerProfileVariantId WP WHERE ZnodeCMSContainerProfileVariant.CMSContainerProfileVariantId = WP.CMSContainerProfileVariantId)
			AND ZnodeCMSContainerProfileVariant.ProfileId IS NULL AND ZnodeCMSContainerProfileVariant.PortalId IS NULL))
	BEGIN
		SET @Status = 0;
		SELECT 1 AS ID,
		CAST(0 AS BIT) AS [Status] ,'The default variant cannot be deleted.' AS Message;	
		RETURN
	END
	ELSE 
	BEGIN
		BEGIN TRAN DeleteAssociatedVariants
			DELETE WP
			FROM @TBL_ContainerProfileVariantId WP
			WHERE EXISTS(SELECT * FROM ZnodeCMSContainerProfileVariant WHERE ZnodeCMSContainerProfileVariant.CMSContainerProfileVariantId = WP.CMSContainerProfileVariantId AND ProfileId IS NULL AND PortalId IS NULL)
		
			DELETE  L FROM ZnodeWidgetGlobalAttributeValueLocale L	
			INNER JOIN ZnodeWidgetGlobalAttributeValue V ON L.WidgetGlobalAttributeValueId = V.WidgetGlobalAttributeValueId
			WHERE EXISTS(SELECT * FROM @TBL_ContainerProfileVariantId WP WHERE V.CMSContainerProfileVariantId = WP.CMSContainerProfileVariantId)

			DELETE ZnodeWidgetGlobalAttributeValue 
			WHERE EXISTS(SELECT * FROM @TBL_ContainerProfileVariantId WP WHERE ZnodeWidgetGlobalAttributeValue.CMSContainerProfileVariantId = WP.CMSContainerProfileVariantId)

			DELETE WPVL
			FROM ZnodeCMSContainerProfileVariantLocale WPVL
			WHERE EXISTS(SELECT * FROM ZnodeCMSContainerProfileVariant WPV
				WHERE EXISTS(SELECT * FROM @TBL_ContainerProfileVariantId WP WHERE WPV.CMSContainerProfileVariantId = WP.CMSContainerProfileVariantId)
				AND WPV.CMSContainerProfileVariantId = WPVL.CMSContainerProfileVariantId)

			DELETE ZnodeCMSContainerProfileVariant 
			WHERE EXISTS(SELECT * FROM @TBL_ContainerProfileVariantId WP WHERE ZnodeCMSContainerProfileVariant.CMSContainerProfileVariantId = WP.CMSContainerProfileVariantId)

			SET @Status = 1;
			SELECT 1 AS ID,
			CAST(1 AS BIT) AS [Status],'' as Message;	
		COMMIT TRAN DeleteAssociatedVariants;
	END
		

END TRY

BEGIN CATCH
	ROLLBACK TRAN DeleteAttributeFamily;
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
	@ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeleteAssociatedVariants 
	@WidgetProfileVariantId = '+@ContainerProfileVariantId+',@Status='+CAST(@Status AS VARCHAR(50));

	SET @Status =0  
	SELECT 1 AS ID,@Status AS Status,'' Message;  
	
	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_DeleteAssociatedVariants',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	       
END CATCH

END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeleteCMSContainerTemplates')
	DROP PROC Znode_DeleteCMSContainerTemplates

GO

CREATE PROCEDURE [dbo].[Znode_DeleteCMSContainerTemplates]
(
	@WidgetTemplateIds  VARCHAR(2000),
	@status  BIT OUT
)
AS
BEGIN
BEGIN TRY
BEGIN TRAN DeleteWidgetTemplates

		DECLARE @TBL_WidgetTemplate TABLE(WidgetTemplateId int)

		INSERT INTO @TBL_WidgetTemplate (WidgetTemplateId)
		SELECT item FROM dbo.Split(@WidgetTemplateIds,',')

		DECLARE @TBL_DeleteIds TABLE(WidgetTemplateId int)
			 
		INSERT INTO @TBL_DeleteIds(WidgetTemplateId)
		SELECT WT.WidgetTemplateId FROM @TBL_WidgetTemplate WT inner join
		ZnodeCMSContainerTemplate CWT on WT.WidgetTemplateId = CWT.CMSContainerTemplateId 
		WHERE not exists
		(
		SELECT top 1 1 FROM ZnodeCMSContainerProfileVariant CW 
		INNER JOIN ZnodeCMSContainerProfileVariantLocale CWL ON CW.CMSContainerProfileVariantId = CWL.CMSContainerProfileVariantId
		WHERE CWL.CMSContainerTemplateId = WT.WidgetTemplateId

		)
		
		DELETE FROM ZnodeCMSContainerTemplate
		WHERE exists
		(
		SELECT top 1 1 FROM @TBL_DeleteIds DI
		WHERE DI.WidgetTemplateId = ZnodeCMSContainerTemplate.CMSContainerTemplateId

		);
			 
		IF(SELECT COUNT(1) FROM @TBL_DeleteIds) = (SELECT COUNT(1) FROM @TBL_WidgetTemplate )  
		BEGIN
            SET @Status = 1;
            SELECT 1 AS ID,
                CAST(1 AS BIT) AS [Status];
        END;
        ELSE
        BEGIN
            SET @Status = 0;
            SELECT 1 AS ID,
                CAST(0 AS BIT) AS [Status];
        END;

COMMIT TRAN DeleteWidgetTemplates;
END TRY

BEGIN CATCH
	ROLLBACK TRAN DeleteWidgetTemplates;

	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
	@ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeleteCMSWidgetTemplates 
	@WidgetTemplateIds = '+@WidgetTemplateIds+',@Status='+CAST(@Status AS VARCHAR(50));

		SET @Status =0  
		SELECT 1 AS ID,@Status AS Status;  
		
		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_DeleteCMSWidgetTemplates',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
       
END CATCH

END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeleteCMSWidgetTemplates')
	DROP PROC Znode_DeleteCMSWidgetTemplates

GO

CREATE PROCEDURE [dbo].[Znode_DeleteCMSWidgetTemplates]
(
	@WidgetTemplateIds  VARCHAR(2000),
	@status  BIT OUT
)
AS
BEGIN
BEGIN TRY
BEGIN TRAN DeleteWidgetTemplates

		DECLARE @TBL_WidgetTemplate TABLE(WidgetTemplateId int)

		INSERT INTO @TBL_WidgetTemplate (WidgetTemplateId)
		SELECT item FROM dbo.Split(@WidgetTemplateIds,',')

		DECLARE @TBL_DeleteIds TABLE(WidgetTemplateId int)
			 
		INSERT INTO @TBL_DeleteIds(WidgetTemplateId)
		SELECT WT.WidgetTemplateId FROM @TBL_WidgetTemplate WT inner join
		ZnodeCMSWidgetTemplate CWT on WT.WidgetTemplateId = CWT.CMSWidgetTemplateId 
		WHERE not exists
		(
		SELECT top 1 1 FROM ZnodeCMSWidgetProfileVariant CW 
		INNER JOIN ZnodeCMSWidgetProfileVariantLocale CWL ON CW.CMSWidgetProfileVariantId = CWL.CMSWidgetProfileVariantId
		WHERE CWL.CMSWidgetTemplateId = WT.WidgetTemplateId

		)

		DELETE FROM ZnodeCMSWidgetTemplate
		WHERE exists
		(
		SELECT top 1 1 FROM @TBL_DeleteIds DI
		WHERE DI.WidgetTemplateId = ZnodeCMSWidgetTemplate.CMSWidgetTemplateId

		);
			 
		IF(SELECT COUNT(1) FROM @TBL_DeleteIds) = (SELECT COUNT(1) FROM @TBL_WidgetTemplate )  
		BEGIN
            SET @Status = 1;
            SELECT 1 AS ID,
                CAST(1 AS BIT) AS [Status];
        END;
        ELSE
        BEGIN
            SET @Status = 0;
            SELECT 1 AS ID,
                CAST(0 AS BIT) AS [Status];
        END;

COMMIT TRAN DeleteWidgetTemplates;
END TRY

BEGIN CATCH
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
	@ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeleteCMSWidgetTemplates 
	@WidgetTemplateIds = '+@WidgetTemplateIds+',@Status='+CAST(@Status AS VARCHAR(50));

		SET @Status =0  
		SELECT 1 AS ID,@Status AS Status;  
		ROLLBACK TRAN DeleteWidgetTemplates;
		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_DeleteCMSWidgetTemplates',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
       
END CATCH

END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeleteContentContainer')
	DROP PROC Znode_DeleteContentContainer

GO

CREATE PROCEDURE [dbo].[Znode_DeleteContentContainer]
(
	@ContentContainerIds  VARCHAR(2000),
	@status  BIT OUT
)
AS
BEGIN
		BEGIN TRY

			 BEGIN TRAN DeleteContentContainer
			
				 DECLARE @TBL_DeleteContainerId TABLE(ContainerId INT); 
             
					INSERT INTO @TBL_DeleteContainerId(ContainerId)
					SELECT Item FROM  dbo.Split(@ContentContainerIds, ',')	
				 
					DELETE GWL  from ZnodeWidgetGlobalAttributeValueLocale GWL
					INNER JOIN ZnodeWidgetGlobalAttributeValue WGA ON 
					GWL.WidgetGlobalAttributeValueId = WGA.WidgetGlobalAttributeValueId
					INNER JOIN @TBL_DeleteContainerId DC ON WGA.CMSContentContainerId = DC.ContainerId
					
					
					DELETE GAV  FROM ZnodeWidgetGlobalAttributeValue GAV
					INNER JOIN @TBL_DeleteContainerId DC ON  GAV.CMSContentContainerId = DC.ContainerId	
					
					DELETE GEFM FROM ZnodeGlobalEntityFamilyMapper GEFM			
					INNER JOIN @TBL_DeleteContainerId DC ON  GEFM.GlobalEntityValueId = DC.ContainerId	
         
					DELETE CWL
					FROM ZnodeCMSContainerProfileVariantLocale CWL
					WHERE EXISTS(SELECT * FROM ZnodeCMSContainerProfileVariant CW
						INNER JOIN @TBL_DeleteContainerId DC ON  CW.CMSContentContainerId = DC.ContainerId
						WHERE CW.CMSContainerProfileVariantId = CWL.CMSContainerProfileVariantId)

					DELETE WPV FROM ZnodeCMSContainerProfileVariant WPV
					INNER JOIN @TBL_DeleteContainerId DC ON  WPV.CMSContentContainerId = DC.ContainerId

					DELETE CW FROM ZnodeCMSContentContainer CW
					INNER JOIN @TBL_DeleteContainerId DC ON  CW.CMSContentContainerId = DC.ContainerId

				  SET @Status = 1;
                     SELECT 1 AS ID,
                            CAST(1 AS BIT) AS [Status];

             COMMIT TRAN DeleteContentContainer;
		END TRY

		BEGIN CATCH
		ROLLBACK TRAN DeleteContentContainer;
             DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
			 @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeleteContentContainer 
			 @ContentContainerIds = '+@ContentContainerIds+',@Status='+CAST(@Status AS VARCHAR(50));


			  	 SET @Status =0  
				 SELECT 1 AS ID,@Status AS Status;  
				 
				 EXEC Znode_InsertProcedureErrorLog
                  @ProcedureName = 'Znode_DeleteContentContainer',
                  @ErrorInProcedure = @Error_procedure,
                  @ErrorMessage = @ErrorMessage,
                  @ErrorLine = @ErrorLine,
                  @ErrorCall = @ErrorCall;
       
		END CATCH

END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeleteContentWidget')
	DROP PROC Znode_DeleteContentWidget

GO

CREATE PROCEDURE [dbo].[Znode_DeleteContentWidget]
(
	@ContentWidgetIds  VARCHAR(2000),
	@status  BIT OUT
)
AS
BEGIN
		BEGIN TRY

			 BEGIN TRAN DeleteContentWidget
			
				 DECLARE @TBL_DeleteWidgetId TABLE(widgetId INT); 
             
					INSERT INTO @TBL_DeleteWidgetId(widgetId)
					SELECT Item FROM  dbo.Split(@ContentWidgetIds, ',')	
				 
					DELETE GWL  from ZnodeWidgetGlobalAttributeValueLocale GWL
					INNER JOIN ZnodeWidgetGlobalAttributeValue WGA ON 
					GWL.WidgetGlobalAttributeValueId = WGA.WidgetGlobalAttributeValueId
					INNER JOIN @TBL_DeleteWidgetId DC ON WGA.CMSContentContainerId = DC.widgetId
					
					
					DELETE GAV  FROM ZnodeWidgetGlobalAttributeValue GAV
					INNER JOIN @TBL_DeleteWidgetId DC ON  GAV.CMSContentContainerId = DC.widgetId	
					
					DELETE GEFM FROM ZnodeGlobalEntityFamilyMapper GEFM			
					INNER JOIN @TBL_DeleteWidgetId DC ON  GEFM.GlobalEntityValueId = DC.widgetId	
         
					DELETE CWL
					FROM ZnodeCMSContainerProfileVariantLocale CWL
					WHERE EXISTS(SELECT * FROM ZnodeCMSContainerProfileVariant CW
						INNER JOIN @TBL_DeleteWidgetId DC ON  CW.CMSContentContainerId = DC.widgetId
						WHERE CW.CMSContainerProfileVariantId = CWL.CMSContainerProfileVariantId)

					DELETE WPV FROM ZnodeCMSWidgetProfileVariant WPV
					INNER JOIN @TBL_DeleteWidgetId DC ON  WPV.CMSContentWidgetId = DC.widgetId

					DELETE CW FROM ZnodeCMSContentWidget CW
					INNER JOIN @TBL_DeleteWidgetId DC ON  CW.CMSContentWidgetId = DC.widgetId

				  SET @Status = 1;
                     SELECT 1 AS ID,
                            CAST(1 AS BIT) AS [Status];

             COMMIT TRAN DeleteContentWidget;
		END TRY

		BEGIN CATCH

             DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
			 @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeleteContentWidget 
			 @ContentWidgetIds = '+@ContentWidgetIds+',@Status='+CAST(@Status AS VARCHAR(50));


			  	 SET @Status =0  
				 SELECT 1 AS ID,@Status AS Status;  
				 ROLLBACK TRAN DeleteContentWidget;
				 EXEC Znode_InsertProcedureErrorLog
                  @ProcedureName = 'Znode_DeleteContentWidget',
                  @ErrorInProcedure = @Error_procedure,
                  @ErrorMessage = @ErrorMessage,
                  @ErrorLine = @ErrorLine,
                  @ErrorCall = @ErrorCall;
       
		END CATCH

END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetCMSContainerlist')
	DROP PROC Znode_GetCMSContainerlist

GO

CREATE PROCEDURE [dbo].[Znode_GetCMSContainerlist]  
(    
  @WhereClause NVARCHAR(Max)       
 ,@Rows INT = 100       
 ,@PageNo INT = 1       
 ,@Order_BY VARCHAR(1000) = ''    
 ,@RowsCount INT OUT    
)    
AS    
--EXEC Znode_GetCMSContainerlist @WhereClause = '',@RowsCount=0
BEGIN      
BEGIN TRY     
SET NOCOUNT ON        
	DECLARE @SQL NVARCHAR(MAX)    
	DECLARE @TBL_ContentContainer TABLE (ContentContainerId INT,ContainerKey NVARCHAR(max),Tags NVARCHAR(max),PublishStatus VARCHAR(32),CreatedByName NVARCHAR(600),CreatedDate DATETIME,ModifiedByName NVARCHAR(600),ModifiedDate DATETIME,RowId INT,CountNo INT)  
	
	IF OBJECT_ID('TEMPDB..#User') IS NOT NULL
		DROP TABLE #User

	SELECT ZU.UserId, ZU.UserName
	INTO #User
	FROM ZnodeUser ZU
	WHERE EXISTS(SELECT * FROM ZnodeCMSContentContainer ZCW WHERE ZU.UserId = ZCW.CreatedBy OR ZU.UserId = ZCW.ModifiedBy)

	
	SET @SQL = '   
	;With Cte_ContentContainer AS   
	(  
		SELECT DISTINCT ZCW.CMSContentContainerId, ZCW.ContainerKey as ContainerKey, ZCW.Tags, ZPS.StateName As PublishStatus ,U.UserName AS CreatedByName,ZCW.CreatedDate,U1.UserName AS ModifiedByName,ZCW.ModifiedDate
		FROM ZnodeCMSContentContainer ZCW
		LEFT JOIN ZnodePublishState ZPS ON ZCW.PublishStateId=ZPS.PublishStateId
		INNER JOIN #User U ON U.UserId = ZCW.CreatedBy
		INNER JOIN #User U1 ON U1.UserId = ZCW.ModifiedBy
	)  
	,Cte_ContentContainerList AS
	(
		SELECT CMSContentContainerId, ContainerKey, Tags,PublishStatus,CreatedByName,CreatedDate,ModifiedByName,ModifiedDate,
		'+dbo.Fn_GetPagingRowId(@Order_BY,'ContainerKey ASC')+',Count(*)Over() CountNo 
		FROM Cte_ContentContainer    
		WHERE 1=1 '+dbo.Fn_GetFilterWhereClause(@WhereClause)+'    
	)
	SELECT CMSContentContainerId,ContainerKey,Tags,PublishStatus,CreatedByName,CreatedDate,ModifiedByName,ModifiedDate,RowId,CountNo    
	FROM Cte_ContentContainerList   
	'+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows)  

	INSERT INTO @TBL_ContentContainer (ContentContainerId,ContainerKey,Tags,PublishStatus,CreatedByName,CreatedDate,ModifiedByName,ModifiedDate,RowId,CountNo)  
	EXEC (@SQL)  
	SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM @TBL_ContentContainer ),0)  

	SELECT ContentContainerId,ContainerKey,Tags,PublishStatus,CreatedByName,CreatedDate,ModifiedByName,ModifiedDate
	FROM @TBL_ContentContainer  
	ORDER BY RowId

END TRY    
BEGIN CATCH    
	DECLARE @Status BIT ;    
	SET @Status = 0;    
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= 
	ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 
	'EXEC Znode_GetCMSContainerlist @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',
	@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',
	@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));    
                      
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                       
        
	EXEC Znode_InsertProcedureErrorLog    
	@ProcedureName = 'Znode_GetCMSContainerlist',    
	@ErrorInProcedure = @Error_procedure,    
	@ErrorMessage = @ErrorMessage,    
	@ErrorLine = @ErrorLine,    
	@ErrorCall = @ErrorCall;                                
END CATCH; 
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetCMSContainerProfileVariantlist')
	DROP PROC Znode_GetCMSContainerProfileVariantlist

GO

CREATE PROCEDURE [dbo].[Znode_GetCMSContainerProfileVariantlist]
(
	@WhereClause NVARCHAR(MAX)
	,@ContainerKey NVARCHAR(MAX)
	,@Rows INT = 100   
	,@PageNo INT = 1   
	,@Order_BY VARCHAR(1000) = ''
	,@RowsCount INT OUT
)
AS
-- EXEC Znode_GetCMSContainerProfileVariantlist '','',0,0,'',0
BEGIN  
BEGIN TRY 
SET NOCOUNT ON
	DECLARE @SQL NVARCHAR(MAX)
	CREATE TABLE #TBL_ContentContainer (CMSContainerProfileVariantId INT, ContainerKey NVARCHAR(MAX), PortalId INT, StoreName NVARCHAR(MAX), ProfileName NVARCHAR(200),CreatedByName VARCHAR(500), CreatedDate DATETIME, ModifiedByName VARCHAR(500),
		ModifiedDate DATETIME, IsDefaultVarient BIT,StoreCode VARCHAR(200),ProfileCode Varchar(200),RowId INT,CountNo INT,IsActive BIT,PublishStatus VARCHAR(32))  
	
	SELECT CAST(UserName AS NVARCHAR(500)) AS UserName , ZU.UserId
	INTO #Users
	FROM ZnodeUser ZU WITH (NOLOCK)
	WHERE EXISTS( SELECT * FROM ZnodeCMSContainerProfileVariant CWPV WHERE ZU.UserId = CWPV.CreatedBy )
	UNION
	SELECT UserName, ZU.UserId
	FROM ZnodeUser ZU
	WHERE EXISTS( SELECT * FROM ZnodeCMSContainerProfileVariant CWPV WHERE ZU.UserId = CWPV.ModifiedBy )

	SELECT DISTINCT WPV.CMSContainerProfileVariantId, ZCW.ContainerKey, WPV.PortalId, --ZCW.Tags,
		CASE WHEN WPV.PortalId IS NULL THEN  'Any Store' ELSE ZP.StoreName END StoreName  ,
		CASE WHEN WPV.ProfileId IS NULL THEN  'Any User Profile' ELSE ZPr.ProfileName END ProfileName, 
		U.UserName AS CreatedByName, WPV.CreatedDate, U1.UserName AS ModifiedByName, WPV.ModifiedDate,
		CAST(CASE WHEN WPV.ProfileId IS NULL AND WPV.PortalId IS NULL THEN 1 ELSE 0 END AS BIT) AS IsDefaultVarient,
		CASE WHEN WPV.PortalId IS NULL THEN  'AnyStore' ELSE ZP.StoreCode END StoreCode ,
		CASE WHEN WPV.ProfileId IS NULL THEN  'AnyUserProfile' ELSE ZPr.DefaultExternalAccountNo END ProfileCode,
		CPVL.IsActive,ZPS.StateName As PublishStatus
	INTO #Cte_ContentContainerVarient
	FROM ZnodeCMSContentContainer ZCW 
	INNER JOIN ZnodeCMSContainerProfileVariant WPV ON WPV.CMSContentContainerId = ZCW.CMSContentContainerId
	LEFT JOIN ZnodeCMSContainerProfileVariantLocale CPVL ON WPV.CMSContainerProfileVariantId=CPVL.CMSContainerProfileVariantId
	LEFT JOIN ZnodePublishState ZPS ON WPV.PublishStateId=ZPS.PublishStateId
	LEFT JOIN ZnodePortal ZP ON (WPV.PortalId = ZP.PortalId ) 
	LEFT JOIN ZnodeProfile ZPr ON WPV.ProfileId = ZPr.ProfileId
	INNER JOIN #Users U ON WPV.CreatedBy = U.UserId
	INNER JOIN #Users U1 ON WPV.ModifiedBy = U1.UserId
	WHERE ZCW.ContainerKey = @ContainerKey 

	SET @SQL = '   
	;With Cte_ContentContainerVarientList AS
	(
		SELECT CMSContainerProfileVariantId, ContainerKey, PortalId, StoreName, ProfileName,CreatedByName, CreatedDate, ModifiedByName, ModifiedDate, IsDefaultVarient,StoreCode,ProfileCode,
		'+dbo.Fn_GetPagingRowId(@Order_BY,'IsDefaultVarient ASC,CMSContainerProfileVariantId DESC')+',Count(*)Over() CountNo,IsActive,PublishStatus
		FROM #Cte_ContentContainerVarient
		WHERE 1=1 '+dbo.Fn_GetFilterWhereClause(@WhereClause)+'
	)
	INSERT INTO #TBL_ContentContainer 
	SELECT * 
	FROM Cte_ContentContainerVarientList

	SELECT CMSContainerProfileVariantId as ContainerProfileVariantId, ContainerKey, PortalId, StoreName, ProfileName,CreatedByName, CreatedDate, ModifiedByName, ModifiedDate, IsDefaultVarient ,StoreCode,ProfileCode,IsActive,PublishStatus
	FROM #TBL_ContentContainer   
	'+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows) +'
	 ORDER BY RowId'

	EXEC (@SQL)
	SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM #TBL_ContentContainer ),0)  

END TRY
BEGIN CATCH
	DECLARE @Status BIT ;
	SET @Status = 0;
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= 
	ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 
	'EXEC Znode_GetCMSContainerProfileVariantlist @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',
	@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',
	@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));

	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;   

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_GetCMSContainerProfileVariantlist',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
END CATCH; 
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetCMSContainerTemplatelist')
	DROP PROC Znode_GetCMSContainerTemplatelist

GO

CREATE PROCEDURE [dbo].[Znode_GetCMSContainerTemplatelist]  
(    
	@WhereClause NVARCHAR(Max)       
	,@Rows INT = 100       
	,@PageNo INT = 1       
	,@Order_BY VARCHAR(1000) = ''    
	,@RowsCount INT OUT    
)    
AS    
--EXEC [Znode_GetCMSContainerTemplatelist] @WhereClause = '',@RowsCount=0
BEGIN      
BEGIN TRY     
SET NOCOUNT ON  
	DECLARE @SQL NVARCHAR(MAX)  

	DECLARE @TBL_CMSContainerTemplateList TABLE ([ContainerTemplateId] INT, [Code] VARCHAR(200), [Name] VARCHAR(200),[FileName] NVARCHAR(2000),[MediaId] INT,[CreatedByName] NVARCHAR(600),[CreatedDate] DATETIME,[ModifiedByName] NVARCHAR(600),[ModifiedDate] DATETIME,[MediaPath] VARCHAR(300),RowId INT,CountNo INT) 

	IF OBJECT_ID('TEMPDB..#User') IS NOT NULL
		DROP TABLE #User

	IF OBJECT_ID('TEMPDB..#Media') IS NOT NULL
		DROP TABLE #Media

	SELECT ZU.UserId, ZU.[UserName]
	INTO #User
	FROM ZnodeUser ZU
	WHERE EXISTS(SELECT * FROM ZnodeCMSContainerTemplate ZCW WHERE ZU.UserId = ZCW.CreatedBy OR ZU.UserId = ZCW.ModifiedBy)

	SELECT ZM.MediaId, ZM.Path as [MediaPath]
	INTO #Media
	FROM [ZnodeMedia] ZM
	WHERE EXISTS(SELECT * FROM [ZnodeCMSContainerTemplate] CWT WHERE CWT.MediaId = ZM.MediaId) 

	SELECT 
		CWT.[CMSContainerTemplateId] AS [ContainerTemplateId], 
		CWT.[Code] AS [Code], 
		CWT.[Name] AS [Name], 
		CWT.[FileName] AS [FileName], 
		CWT.[MediaId] AS [MediaId], 
		U.[UserName] AS [CreatedByName], 
		CWT.[CreatedDate] AS [CreatedDate], 
		U1.[UserName] AS [ModifiedByName],  
		CWT.[ModifiedDate] AS [ModifiedDate],
		M.[MediaPath]
	INTO #CMSContainerTemplate
	FROM [dbo].[ZnodeCMSContainerTemplate] AS CWT
	INNER JOIN #User U ON U.UserId = CWT.CreatedBy
	INNER JOIN #User U1 ON U1.UserId = CWT.ModifiedBy
	LEFT JOIN #Media as M on CWT.MediaId = M.MediaId

	SET @SQL = '   
	;With Cte_CMSContainerTemplate AS   
	(  
		SELECT DISTINCT [ContainerTemplateId], [Code], [Name],[FileName],[MediaId],[CreatedByName],[CreatedDate],[ModifiedByName],[ModifiedDate],[MediaPath],
		'+dbo.Fn_GetPagingRowId(@Order_BY,' ContainerTemplateId DESC')+',Count(*)Over() CountNo 
		FROM #CMSContainerTemplate ZCW  
		WHERE 1=1 '+dbo.Fn_GetFilterWhereClause(@WhereClause)+'
	)  
	SELECT [ContainerTemplateId], [Code], [Name],[FileName],[MediaId],[CreatedByName],[CreatedDate],[ModifiedByName],[ModifiedDate],[MediaPath],RowId,CountNo    
	FROM Cte_CMSContainerTemplate   
	'+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows)  

	INSERT INTO @TBL_CMSContainerTemplateList ([ContainerTemplateId], [Code], [Name],[FileName],[MediaId],[CreatedByName],[CreatedDate],[ModifiedByName],[ModifiedDate],[MediaPath],RowId,CountNo)  
	EXEC (@SQL)  
	SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM @TBL_CMSContainerTemplateList ),0)  

	SELECT [ContainerTemplateId], [Code], [Name],[FileName],[MediaId],[CreatedByName],[CreatedDate],[ModifiedByName],[ModifiedDate],[MediaPath]
	FROM @TBL_CMSContainerTemplateList
	ORDER BY RowId

END TRY    
BEGIN CATCH    
	DECLARE @Status BIT ;    
	SET @Status = 0;    
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= 
	ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 
	'EXEC Znode_GetCMSContainerTemplatelist @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',
	@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',
	@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));    
                      
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                       
        
	EXEC Znode_InsertProcedureErrorLog    
	@ProcedureName = 'Znode_GetCMSContainerTemplatelist',    
	@ErrorInProcedure = @Error_procedure,    
	@ErrorMessage = @ErrorMessage,    
	@ErrorLine = @ErrorLine,    
	@ErrorCall = @ErrorCall;                                
END CATCH; 
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetCMSWidgetlist')
	DROP PROC Znode_GetCMSWidgetlist

GO

CREATE PROCEDURE [dbo].[Znode_GetCMSWidgetlist]  
(    
  @WhereClause NVARCHAR(Max)       
 ,@Rows INT = 100       
 ,@PageNo INT = 1       
 ,@Order_BY VARCHAR(1000) = ''    
 ,@RowsCount INT OUT    
)    
AS    
--EXEC Znode_GetCMSWidgetlist @WhereClause = '',@RowsCount=0
BEGIN      
BEGIN TRY     
SET NOCOUNT ON        
	DECLARE @SQL NVARCHAR(MAX)    
	DECLARE @TBL_ContentWidget TABLE (ContentWidgetId INT,ContainerKey NVARCHAR(max),Tags NVARCHAR(max),CreatedByName NVARCHAR(600),CreatedDate DATETIME,ModifiedByName NVARCHAR(600),ModifiedDate DATETIME,RowId INT,CountNo INT)  
	
	IF OBJECT_ID('TEMPDB..#User') IS NOT NULL
		DROP TABLE #User

	SELECT ZU.UserId, ZU.UserName
	INTO #User
	FROM ZnodeUser ZU
	WHERE EXISTS(SELECT * FROM ZnodeCMSContentWidget ZCW WHERE ZU.UserId = ZCW.CreatedBy OR ZU.UserId = ZCW.ModifiedBy)

	
	SET @SQL = '   
	;With Cte_ContentWidget AS   
	(  
		SELECT DISTINCT ZCW.CMSContentWidgetId, ZCW.WidgetKey as ContainerKey, ZCW.Tags ,U.UserName AS CreatedByName,ZCW.CreatedDate,U1.UserName AS ModifiedByName,ZCW.ModifiedDate
		FROM ZnodeCMSContentWidget ZCW  
		INNER JOIN #User U ON U.UserId = ZCW.CreatedBy
		INNER JOIN #User U1 ON U1.UserId = ZCW.ModifiedBy
	)  
	,Cte_ContentWidgetList AS
	(
		SELECT CMSContentWidgetId, ContainerKey, Tags,CreatedByName,CreatedDate,ModifiedByName,ModifiedDate,
		'+dbo.Fn_GetPagingRowId(@Order_BY,'ContainerKey ASC')+',Count(*)Over() CountNo 
		FROM Cte_ContentWidget    
		WHERE 1=1 '+dbo.Fn_GetFilterWhereClause(@WhereClause)+'    
	)
	SELECT CMSContentWidgetId,ContainerKey,Tags,CreatedByName,CreatedDate,ModifiedByName,ModifiedDate,RowId,CountNo    
	FROM Cte_ContentWidgetList   
	'+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows)  

	INSERT INTO @TBL_ContentWidget (ContentWidgetId,ContainerKey,Tags,CreatedByName,CreatedDate,ModifiedByName,ModifiedDate,RowId,CountNo)  
	EXEC (@SQL)  
	SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM @TBL_ContentWidget ),0)  

	SELECT ContentWidgetId,ContainerKey,Tags,CreatedByName,CreatedDate,ModifiedByName,ModifiedDate
	FROM @TBL_ContentWidget  
	ORDER BY RowId

END TRY    
BEGIN CATCH    
	DECLARE @Status BIT ;    
	SET @Status = 0;    
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= 
	ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 
	'EXEC Znode_GetCMSWidgetlist @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',
	@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',
	@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));    
                      
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                       
        
	EXEC Znode_InsertProcedureErrorLog    
	@ProcedureName = 'Znode_GetCMSWidgetlist',    
	@ErrorInProcedure = @Error_procedure,    
	@ErrorMessage = @ErrorMessage,    
	@ErrorLine = @ErrorLine,    
	@ErrorCall = @ErrorCall;                                
END CATCH; 
END;    

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetCMSWidgetProfileVariantlist')
	DROP PROC Znode_GetCMSWidgetProfileVariantlist

GO

CREATE PROCEDURE [dbo].[Znode_GetCMSWidgetProfileVariantlist]  
(    
	@WhereClause NVARCHAR(MAX)
	,@WidgetKey NVARCHAR(MAX)
	,@Rows INT = 100       
	,@PageNo INT = 1       
	,@Order_BY VARCHAR(1000) = ''    
	,@RowsCount INT OUT    
)    
AS    
BEGIN      
BEGIN TRY     
SET NOCOUNT ON        
	DECLARE @SQL NVARCHAR(MAX)    
	CREATE TABLE #TBL_ContentWidget (CMSWidgetProfileVariantId INT, WidgetKey NVARCHAR(MAX), PortalId INT, StoreName NVARCHAR(MAX), ProfileName NVARCHAR(200),CreatedByName VARCHAR(500), CreatedDate DATETIME, ModifiedByName VARCHAR(500), ModifiedDate DATETIME, IsDefaultVarient BIT,RowId INT,CountNo INT)  
	
	SELECT CAST(UserName AS NVARCHAR(500)) AS UserName , ZU.UserId
	INTO #Users
	FROM ZnodeUser ZU WITH (NOLOCK)
	WHERE EXISTS( SELECT * FROM ZnodeCMSWidgetProfileVariant CWPV WHERE ZU.UserId = CWPV.CreatedBy )
	UNION
	SELECT UserName, ZU.UserId
	FROM ZnodeUser ZU
	WHERE EXISTS( SELECT * FROM ZnodeCMSWidgetProfileVariant CWPV WHERE ZU.UserId = CWPV.ModifiedBy )

	SELECT WPV.CMSWidgetProfileVariantId, ZCW.WidgetKey, WPV.PortalId, --ZCW.Tags,
		CASE WHEN WPV.PortalId IS NULL THEN  'Any Store' ELSE ZP.StoreName END StoreName  ,
		CASE WHEN WPV.ProfileId IS NULL THEN  'Any User Profile' ELSE ZPr.ProfileName END ProfileName, 
		U.UserName AS CreatedByName, WPV.CreatedDate, U1.UserName AS ModifiedByName, WPV.ModifiedDate,
		CAST(CASE WHEN WPV.ProfileId IS NULL AND WPV.PortalId IS NULL THEN 1 ELSE 0 END AS BIT) AS IsDefaultVarient
	INTO #Cte_ContentWidgetVarient
	FROM ZnodeCMSContentWidget ZCW  
	INNER JOIN ZnodeCMSWidgetProfileVariant WPV ON WPV.CMSContentWidgetId = ZCW.CMSContentWidgetId
	LEFT JOIN ZnodePortal ZP ON (WPV.PortalId = ZP.PortalId ) 
	LEFT JOIN ZnodeProfile ZPr ON WPV.ProfileId = ZPr.ProfileId
	INNER JOIN #Users U ON WPV.CreatedBy = U.UserId
	INNER JOIN #Users U1 ON WPV.ModifiedBy = U1.UserId
	WHERE ZCW.WidgetKey = @WidgetKey 

	SET @SQL = '   
	;With Cte_ContentWidgetVarientList AS
	(
		SELECT CMSWidgetProfileVariantId, WidgetKey, PortalId, StoreName, ProfileName,CreatedByName, CreatedDate, ModifiedByName, ModifiedDate, IsDefaultVarient,
		'+dbo.Fn_GetPagingRowId(@Order_BY,'IsDefaultVarient ASC,CMSWidgetProfileVariantId DESC')+',Count(*)Over() CountNo 
		FROM #Cte_ContentWidgetVarient    
		WHERE 1=1 '+dbo.Fn_GetFilterWhereClause(@WhereClause)+'    
	)
	INSERT INTO #TBL_ContentWidget 
	SELECT * 
	FROM Cte_ContentWidgetVarientList

	SELECT CMSWidgetProfileVariantId as WidgetProfileVariantId, WidgetKey, PortalId, StoreName, ProfileName,CreatedByName, CreatedDate, ModifiedByName, ModifiedDate, IsDefaultVarient  
	FROM #TBL_ContentWidget   
	'+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows) +'
	 ORDER BY RowId'

	EXEC (@SQL)
	SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM #TBL_ContentWidget ),0)  

END TRY    
BEGIN CATCH    
	DECLARE @Status BIT ;    
	SET @Status = 0;    
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= 
	ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 
	'EXEC Znode_GetCMSWidgetProfileVariantlist @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',
	@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',
	@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));    
                      
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                       
        
	EXEC Znode_InsertProcedureErrorLog    
	@ProcedureName = 'Znode_GetCMSWidgetProfileVariantlist',    
	@ErrorInProcedure = @Error_procedure,    
	@ErrorMessage = @ErrorMessage,    
	@ErrorLine = @ErrorLine,    
	@ErrorCall = @ErrorCall;                                
END CATCH; 
END;    
    
GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetCMSWidgetTemplatelist')
	DROP PROC Znode_GetCMSWidgetTemplatelist

GO

CREATE PROCEDURE [dbo].[Znode_GetCMSWidgetTemplatelist]  
(    
	@WhereClause NVARCHAR(Max)       
	,@Rows INT = 100       
	,@PageNo INT = 1       
	,@Order_BY VARCHAR(1000) = ''    
	,@RowsCount INT OUT    
)    
AS    
--EXEC [Znode_GetCMSWidgetTemplatelist] @WhereClause = '',@RowsCount=0
BEGIN      
BEGIN TRY     
SET NOCOUNT ON  
	DECLARE @SQL NVARCHAR(MAX)  

	DECLARE @TBL_CMSWidgetTemplateList TABLE ([CMSWidgetTemplateId] INT, [Code] VARCHAR(200), [Name] VARCHAR(200),[FileName] NVARCHAR(2000),[MediaId] INT,[CreatedByName] NVARCHAR(600),[CreatedDate] DATETIME,[ModifiedByName] NVARCHAR(600),[ModifiedDate] DATETIME,[MediaPath] VARCHAR(300),RowId INT,CountNo INT) 

	IF OBJECT_ID('TEMPDB..#User') IS NOT NULL
		DROP TABLE #User

	IF OBJECT_ID('TEMPDB..#Media') IS NOT NULL
		DROP TABLE #Media

	SELECT ZU.UserId, ZU.[UserName]
	INTO #User
	FROM ZnodeUser ZU
	WHERE EXISTS(SELECT * FROM ZnodeCMSWidgetTemplate ZCW WHERE ZU.UserId = ZCW.CreatedBy OR ZU.UserId = ZCW.ModifiedBy)

	SELECT ZM.MediaId, ZM.Path as [MediaPath]
	INTO #Media
	FROM [ZnodeMedia] ZM
	WHERE EXISTS(SELECT * FROM [ZnodeCMSWidgetTemplate] CWT WHERE CWT.MediaId = ZM.MediaId) 

	SELECT 
		CWT.[CMSWidgetTemplateId] AS [CMSWidgetTemplateId], 
		CWT.[Code] AS [Code], 
		CWT.[Name] AS [Name], 
		CWT.[FileName] AS [FileName], 
		CWT.[MediaId] AS [MediaId], 
		U.[UserName] AS [CreatedByName], 
		CWT.[CreatedDate] AS [CreatedDate], 
		U1.[UserName] AS [ModifiedByName],  
		CWT.[ModifiedDate] AS [ModifiedDate],
		M.[MediaPath]
	INTO #CMSWidgetTemplate
	FROM [dbo].[ZnodeCMSWidgetTemplate] AS CWT
	INNER JOIN #User U ON U.UserId = CWT.CreatedBy
	INNER JOIN #User U1 ON U1.UserId = CWT.ModifiedBy
	LEFT JOIN #Media as M on CWT.MediaId = M.MediaId

	SET @SQL = '   
	;With Cte_CMSWidgetTemplate AS   
	(  
		SELECT DISTINCT [CMSWidgetTemplateId], [Code], [Name],[FileName],[MediaId],[CreatedByName],[CreatedDate],[ModifiedByName],[ModifiedDate],[MediaPath],
		'+dbo.Fn_GetPagingRowId(@Order_BY,' CMSWidgetTemplateId DESC')+',Count(*)Over() CountNo 
		FROM #CMSWidgetTemplate ZCW  
		WHERE 1=1 '+dbo.Fn_GetFilterWhereClause(@WhereClause)+'
	)  
	SELECT [CMSWidgetTemplateId], [Code], [Name],[FileName],[MediaId],[CreatedByName],[CreatedDate],[ModifiedByName],[ModifiedDate],[MediaPath],RowId,CountNo    
	FROM Cte_CMSWidgetTemplate   
	'+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows)  

	INSERT INTO @TBL_CMSWidgetTemplateList ([CMSWidgetTemplateId], [Code], [Name],[FileName],[MediaId],[CreatedByName],[CreatedDate],[ModifiedByName],[ModifiedDate],[MediaPath],RowId,CountNo)  
	EXEC (@SQL)  
	SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM @TBL_CMSWidgetTemplateList ),0)  

	SELECT [CMSWidgetTemplateId], [Code], [Name],[FileName],[MediaId],[CreatedByName],[CreatedDate],[ModifiedByName],[ModifiedDate],[MediaPath]
	FROM @TBL_CMSWidgetTemplateList
	ORDER BY RowId

END TRY    
BEGIN CATCH    
	DECLARE @Status BIT ;    
	SET @Status = 0;    
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= 
	ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 
	'EXEC Znode_GetCMSWidgetTemplatelist @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',
	@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',
	@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));    
                      
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                       
        
	EXEC Znode_InsertProcedureErrorLog    
	@ProcedureName = 'Znode_GetCMSWidgetTemplatelist',    
	@ErrorInProcedure = @Error_procedure,    
	@ErrorMessage = @ErrorMessage,    
	@ErrorLine = @ErrorLine,    
	@ErrorCall = @ErrorCall;                                
END CATCH; 
END;    

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetContentContainerAttributeValue')
	DROP PROC Znode_GetContentContainerAttributeValue

GO

CREATE PROCEDURE [dbo].[Znode_GetContentContainerAttributeValue]
(
	@EntityName	NVARCHAR(200) = 0,
	@ContainerKey	NVARCHAR(200),
	@LocalId	INT = 0,
	@PortalId	INT = 0,
	@ProfileId	INT = 0
)
AS
/*
	 Summary :- This procedure is used to get the Content and Container attribute value as per filter pass
	 Unit Testing 
	 BEGIN TRAN
	 EXEC [Znode_GetContentContainerAttributeValue] @EntityName='Content Containers',@ContainerKey='',@LocalId=0,@PortalId=0,@ProfileId=0
	 ROLLBACK TRAN
*/
BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
		-- Variable Declaration as per the code requirement
		DECLARE @LocaleCode NVARCHAR(50),
				@LocalIdInput INT,
				@LocaleCodeInput NVARCHAR(50),
				@GlobalEntityValueId INT,
				@GroupCode NVARCHAR(200) = NULL,
				@SelectedValue BIT = 0,
				@FamilyCode VARCHAR(200);

		SET @LocalIdInput = @LocalId

		SELECT @LocaleCode=Code FROM ZnodeLocale WITH (NOLOCK) WHERE LocaleId=@LocalId;
		SET @LocaleCodeInput = @LocaleCode

		--1. Specific Store, Specific User Profile, Selected Locale
		-- Based on input if count will 1 then this will take CMSContainerProfileVariantId from 1st loop else this will go for next loop.
		IF (SELECT COUNT(1) FROM ZnodeCMSContainerProfileVariant WPV WITH (NOLOCK) WHERE ISNULL(WPV.ProfileId,0)=@ProfileId 
			AND EXISTS(SELECT * FROM ZnodeCMSContainerProfileVariantLocale WPVL WHERE WPV.CMSContainerProfileVariantId = WPVL.CMSContainerProfileVariantId AND WPVL.LocaleId=@LocalId ))=1
		BEGIN
			SELECT @GlobalEntityValueId=CMSContainerProfileVariantId 
			FROM ZnodeCMSContainerProfileVariant WPV WITH (NOLOCK)
			WHERE ISNULL(WPV.ProfileId,0)=@ProfileId 
			AND EXISTS(SELECT * FROM ZnodeCMSContentContainer CW WITH (NOLOCK) WHERE CW.ContainerKey=@ContainerKey AND WPV.CMSContentContainerId = CW.CMSContentContainerId)
			AND EXISTS(SELECT * FROM ZnodeCMSContainerProfileVariantLocale WPVL WHERE WPV.CMSContainerProfileVariantId = WPVL.CMSContainerProfileVariantId AND WPVL.LocaleId=@LocalId );
		END
		ELSE
		BEGIN
			SELECT @GlobalEntityValueId=CMSContainerProfileVariantId 
			FROM ZnodeCMSContainerProfileVariant WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = @ProfileId ) AND (ISNULL(WPV.PortalId,0) = @PortalId )
			AND EXISTS(SELECT * FROM ZnodeCMSContentContainer CW WITH (NOLOCK) WHERE CW.ContainerKey=@ContainerKey AND WPV.CMSContentContainerId = CW.CMSContentContainerId)
			AND EXISTS(SELECT * FROM ZnodeCMSContainerProfileVariantLocale WPVL WHERE WPV.CMSContainerProfileVariantId = WPVL.CMSContainerProfileVariantId AND WPVL.LocaleId=@LocalId );
		
		END

		--2. Specific Store, Specific User Profile, Default Locale
		IF ISNULL(@GlobalEntityValueId,0) = 0
		BEGIN
			SELECT @LocalId = LocaleId FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;
			SELECT @LocaleCode = Code FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;

			SELECT @GlobalEntityValueId=CMSContainerProfileVariantId 
			FROM ZnodeCMSContainerProfileVariant WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = @ProfileId ) AND (ISNULL(WPV.PortalId,0) = @PortalId )
			AND EXISTS(SELECT * FROM ZnodeCMSContentContainer CW WITH (NOLOCK) WHERE CW.ContainerKey=@ContainerKey AND WPV.CMSContentContainerId = CW.CMSContentContainerId)
			AND EXISTS(SELECT * FROM ZnodeCMSContainerProfileVariantLocale WPVL WHERE WPV.CMSContainerProfileVariantId = WPVL.CMSContainerProfileVariantId AND WPVL.LocaleId=@LocalId );
			
			IF ISNULL(@GlobalEntityValueId,0) = 0
			BEGIN
				SET @LocalId = @LocalIdInput
				SET @LocaleCode = @LocaleCodeInput
			END
		
		END

		--3. Specific Store, Any User Profile, Selected Locale
		IF ISNULL(@GlobalEntityValueId,0) = 0
		BEGIN
			SELECT @GlobalEntityValueId=CMSContainerProfileVariantId 
			FROM ZnodeCMSContainerProfileVariant WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = 0 ) AND (ISNULL(WPV.PortalId,0) = @PortalId )
			AND EXISTS(SELECT * FROM ZnodeCMSContentContainer CW WITH (NOLOCK) WHERE CW.ContainerKey=@ContainerKey AND WPV.CMSContentContainerId = CW.CMSContentContainerId)
			AND EXISTS(SELECT * FROM ZnodeCMSContainerProfileVariantLocale WPVL WHERE WPV.CMSContainerProfileVariantId = WPVL.CMSContainerProfileVariantId AND WPVL.LocaleId=@LocalId );			
		END

		--4. Specific Store, Any User Profile, Default Locale
		IF ISNULL(@GlobalEntityValueId,0) = 0
		BEGIN
			SELECT @LocalId = LocaleId FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;
			SELECT @LocaleCode = Code FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;

			SELECT @GlobalEntityValueId=CMSContainerProfileVariantId 
			FROM ZnodeCMSContainerProfileVariant WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = 0 ) AND (ISNULL(WPV.PortalId,0) = @PortalId )
			AND EXISTS(SELECT * FROM ZnodeCMSContentContainer CW WITH (NOLOCK) WHERE CW.ContainerKey=@ContainerKey AND WPV.CMSContentContainerId = CW.CMSContentContainerId)
			AND EXISTS(SELECT * FROM ZnodeCMSContainerProfileVariantLocale WPVL WHERE WPV.CMSContainerProfileVariantId = WPVL.CMSContainerProfileVariantId AND WPVL.LocaleId=@LocalId );			
		
			IF ISNULL(@GlobalEntityValueId,0) = 0
			BEGIN
				SET @LocalId = @LocalIdInput
				SET @LocaleCode = @LocaleCodeInput
			END
		END
		
		--5. Any Store, Any User Profile, Selected Locale
		IF ISNULL(@GlobalEntityValueId,0) = 0
		BEGIN
			SELECT @GlobalEntityValueId=CMSContainerProfileVariantId 
			FROM ZnodeCMSContainerProfileVariant WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = 0 ) AND (ISNULL(WPV.PortalId,0) = 0 )
			AND EXISTS(SELECT * FROM ZnodeCMSContentContainer CW WITH (NOLOCK) WHERE CW.ContainerKey=@ContainerKey AND WPV.CMSContentContainerId = CW.CMSContentContainerId)
			AND EXISTS(SELECT * FROM ZnodeCMSContainerProfileVariantLocale WPVL WHERE WPV.CMSContainerProfileVariantId = WPVL.CMSContainerProfileVariantId AND WPVL.LocaleId=@LocalId );			
		END

		--6. Any Store, Any User Profile, Default Locale
		IF ISNULL(@GlobalEntityValueId,0) = 0
		BEGIN
			SELECT @LocalId = LocaleId FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;
			SELECT @LocaleCode = Code FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;

			SELECT @GlobalEntityValueId=CMSContainerProfileVariantId 
			FROM ZnodeCMSContainerProfileVariant WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = 0 ) AND (ISNULL(WPV.PortalId,0) = 0 )
			AND EXISTS(SELECT * FROM ZnodeCMSContentContainer CW WITH (NOLOCK) WHERE CW.ContainerKey=@ContainerKey AND WPV.CMSContentContainerId = CW.CMSContentContainerId)
			AND EXISTS(SELECT * FROM ZnodeCMSContainerProfileVariantLocale WPVL WHERE WPV.CMSContainerProfileVariantId = WPVL.CMSContainerProfileVariantId AND WPVL.LocaleId=@LocalId );			
		
			IF ISNULL(@GlobalEntityValueId,0) = 0
			BEGIN
				SET @LocalId = @LocalIdInput
				SET @LocaleCode = @LocaleCodeInput
			END
		END
		
		-- This will take FamilyCode based on the inputs.
		SELECT @FamilyCode=GAF.FamilyCode
		FROM ZnodeCMSContentContainer CCW WITH (NOLOCK)
		INNER JOIN ZnodeGlobalAttributeFamily GAF WITH (NOLOCK) ON CCW.FamilyId=GAF.GlobalAttributeFamilyId
		WHERE CCW.ContainerKey=@ContainerKey 
		AND EXISTS(SELECT * FROM ZnodeCMSContainerProfileVariant CWPV WHERE CCW.CMSContentContainerId = CWPV.CMSContentContainerId AND (ISNULL(CWPV.PortalId,0)=@PortalId));

		-- Based on input @EntityName='Content Containers' as fixed value this will execute nested SP.
		-- Nested SP will give 2 Output (1 Result set & 1 Msg.
		IF @EntityName='Content Containers'
		begin
			 EXEC [dbo].[Znode_GetWidgetGlobalAttributeValue]
			 @EntityName=@EntityName,
			 @GlobalEntityValueId=@GlobalEntityValueId,
			 @LocaleCode=@LocaleCode,
			 @GroupCode =@GroupCode,
			 @SelectedValue = @SelectedValue;

		end
		
		-- This will take FamilyCode based on the inputs.
		SELECT @FamilyCode=GAF.FamilyCode
		FROM ZnodeCMSContentContainer CCW WITH (NOLOCK)
		INNER JOIN ZnodeGlobalAttributeFamily GAF WITH (NOLOCK) ON CCW.FamilyId=GAF.GlobalAttributeFamilyId
		WHERE CCW.ContainerKey=@ContainerKey 
		AND EXISTS(SELECT * FROM ZnodeCMSContainerProfileVariant CWPV WHERE CCW.CMSContentContainerId = CWPV.CMSContentContainerId AND (ISNULL(CWPV.PortalId,0)=@PortalId));

		IF ISNULL(@FamilyCode,'') = ''
		BEGIN
			-- This will take FamilyCode based on the inputs.
			SELECT @FamilyCode=GAF.FamilyCode
			FROM ZnodeCMSContentContainer CCW WITH (NOLOCK)
			INNER JOIN ZnodeGlobalAttributeFamily GAF WITH (NOLOCK) ON CCW.FamilyId=GAF.GlobalAttributeFamilyId
			WHERE CCW.ContainerKey=@ContainerKey 
			AND EXISTS(SELECT * FROM ZnodeCMSContainerProfileVariant CWPV WHERE CCW.CMSContentContainerId = CWPV.CMSContentContainerId AND (ISNULL(CWPV.PortalId,0)=0));
		END

		-- This will give 3rd result set of Attribute Groups Data.
		SELECT GE.GlobalEntityId, GE.EntityName, GE.IsActive, GE.TableName, GE.IsFamilyUnique
			, GAF.GlobalAttributeFamilyId, GAF.FamilyCode, GAF.IsSystemDefined, GAF.GlobalEntityId
			, GFGM.GlobalFamilyGroupMapperId, GFGM.GlobalAttributeFamilyId, GFGM.GlobalAttributeGroupId
			, GFGM.AttributeGroupDisplayOrder
			, GAG.GlobalAttributeGroupId, GAG.GroupCode, GAG.DisplayOrder, GAG.IsSystemDefined, GAG.GlobalEntityId
			, GAGL.GlobalAttributeGroupLocaleId, GAGL.LocaleId, GAGL.GlobalAttributeGroupId, GAGL.AttributeGroupName
			, GAGL.[Description]
		FROM ZnodeGlobalEntity GE WITH (NOLOCK)
		INNER JOIN ZnodeGlobalAttributeFamily GAF WITH (NOLOCK) ON GE.GlobalEntityId=GAF.GlobalEntityId
		INNER JOIN ZnodeGlobalFamilyGroupMapper GFGM WITH (NOLOCK) ON GAF.GlobalAttributeFamilyId=GFGM.GlobalAttributeFamilyId
		INNER JOIN ZnodeGlobalAttributeGroup GAG WITH (NOLOCK) ON GFGM.GlobalAttributeGroupId=GAG.GlobalAttributeGroupId
		INNER JOIN ZnodeGlobalAttributeGroupLocale GAGL WITH (NOLOCK) ON GAG.GlobalAttributeGroupId=GAGL.GlobalAttributeGroupId
		WHERE GE.EntityName=@EntityName AND GAGL.LocaleId=@LocalId AND GAF.FamilyCode=@FamilyCode
		ORDER BY GFGM.AttributeGroupDisplayOrder;

		-- This will give 4th result set of ContainerProfile & ContentContainer Data.
		SELECT CWPV.CMSContainerProfileVariantId, CWPV.CMSContentContainerId, CWPV.ProfileId, CWPVL.LocaleId, CWPVL.CMSContainerTemplateId
			,CCW.CMSContentContainerId, CCW.[Name], CCW.ContainerKey, CWPV.PortalId, CCW.FamilyId, CCW.Tags
		FROM ZnodeCMSContainerProfileVariant CWPV WITH (NOLOCK)
		INNER JOIN ZnodeCMSContainerProfileVariantLocale CWPVL WITH (NOLOCK) ON CWPV.CMSContainerProfileVariantId = CWPVL.CMSContainerProfileVariantId
		INNER JOIN ZnodeCMSContentContainer CCW WITH (NOLOCK) ON CWPV.CMSContentContainerId=CCW.CMSContentContainerId
		WHERE (ISNULL(CWPV.ProfileId,0) = @ProfileId OR ISNULL(CWPV.ProfileId,0) = 0) AND CWPVL.LocaleId=@LocalId AND CCW.ContainerKey=@ContainerKey AND ((ISNULL(CWPV.PortalId,0)=@PortalId OR ISNULL(CWPV.PortalId,0) = 0));

		-- This will give 5th result set of ContainerTemplate & ContentContainer Data.
		SELECT CWT.CMSContainerTemplateId, CWT.[FileName], CWT.MediaId, CCW.[Name], CCW.FamilyId, CCW.Tags
		FROM ZnodeCMSContentContainer CCW WITH (NOLOCK) 
		INNER JOIN ZnodeCMSContainerProfileVariant CWPV ON CCW.CMSContentContainerId = CWPV.CMSContentContainerId AND (ISNULL(CWPV.PortalId,0)=@PortalId OR ISNULL(CWPV.PortalId,0) = 0)
		INNER JOIN ZnodeCMSContainerProfileVariantLocale CWPVL ON CWPV.CMSContainerProfileVariantId = CWPVL.CMSContainerProfileVariantId
		INNER JOIN  ZnodeCMSContainerTemplate CWT WITH (NOLOCK) ON (CWPVL.CMSContainerTemplateId = CWT.CMSContainerTemplateId OR ISNULL(CWPVL.CMSContainerTemplateId,0) = 0)
		WHERE CCW.ContainerKey=@ContainerKey
	END TRY
	BEGIN CATCH
		SELECT ERROR_MESSAGE()
		DECLARE @Status BIT;
		SET @Status = 0;

		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(),
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetContentContainerAttributeValue
					@EntityName = '''+ISNULL(@EntityName,'''''')+
					''',@ContainerKey='+ISNULL(@ContainerKey,'''')+
					''',@LocalId='+ISNULL(CAST(@LocalId AS VARCHAR(20)),'''')+
					''',@PortalId='+ISNULL(CAST(@PortalId AS VARCHAR(20)),'''')+
					''',@ProfileId='+ISNULL(CAST(@ProfileId AS VARCHAR(20)),'''')
					
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_GetContentContainerAttributeValue',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetContentWidgetAttributeValue')
	DROP PROC Znode_GetContentWidgetAttributeValue

GO

CREATE PROCEDURE [dbo].[Znode_GetContentWidgetAttributeValue]
(
	@EntityName	NVARCHAR(200) = 0,
	@WidgetKey	NVARCHAR(200),
	@LocalId	INT = 0,
	@PortalId	INT = 0,
	@ProfileId	INT = 0
)
AS
/*
	 Summary :- This procedure is used to get the Content and Widget attribute value as per filter pass
	 Unit Testing 
	 BEGIN TRAN
	 EXEC [Znode_GetContentWidgetAttributeValue] @EntityName='Content Widgets',@WidgetKey='',@LocalId=0,@PortalId=0,@ProfileId=0
	 ROLLBACK TRAN
*/
BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
		-- Variable Declaration as per the code requirement
		DECLARE @LocaleCode NVARCHAR(50),
				@LocalIdInput INT,
				@LocaleCodeInput NVARCHAR(50),
				@GlobalEntityValueId INT,
				@GroupCode NVARCHAR(200) = NULL,
				@SelectedValue BIT = 0,
				@FamilyCode VARCHAR(200);

		SET @LocalIdInput = @LocalId

		SELECT @LocaleCode=Code FROM ZnodeLocale WITH (NOLOCK) WHERE LocaleId=@LocalId;
		SET @LocaleCodeInput = @LocaleCode

		--1. Specific Store, Specific User Profile, Selected Locale
		-- Based on input if count will 1 then this will take CMSWidgetProfileVariantId from 1st loop else this will go for next loop.
		IF (SELECT COUNT(1) FROM ZnodeCMSWidgetProfileVariant WPV WITH (NOLOCK) WHERE ISNULL(WPV.ProfileId,0)=@ProfileId 
			AND EXISTS(SELECT * FROM ZnodeCMSWidgetProfileVariantLocale WPVL WHERE WPV.CMSWidgetProfileVariantId = WPVL.CMSWidgetProfileVariantId AND WPVL.LocaleId=@LocalId ))=1
		BEGIN
			SELECT @GlobalEntityValueId=CMSWidgetProfileVariantId 
			FROM ZnodeCMSWidgetProfileVariant WPV WITH (NOLOCK)
			WHERE ISNULL(WPV.ProfileId,0)=@ProfileId 
			AND EXISTS(SELECT * FROM ZnodeCMSContentWidget CW WITH (NOLOCK) WHERE CW.WidgetKey=@WidgetKey AND WPV.CMSContentWidgetId = CW.CMSContentWidgetId)
			AND EXISTS(SELECT * FROM ZnodeCMSWidgetProfileVariantLocale WPVL WHERE WPV.CMSWidgetProfileVariantId = WPVL.CMSWidgetProfileVariantId AND WPVL.LocaleId=@LocalId );
		END
		ELSE
		BEGIN
			SELECT @GlobalEntityValueId=CMSWidgetProfileVariantId 
			FROM ZnodeCMSWidgetProfileVariant WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = @ProfileId ) AND (ISNULL(WPV.PortalId,0) = @PortalId )
			AND EXISTS(SELECT * FROM ZnodeCMSContentWidget CW WITH (NOLOCK) WHERE CW.WidgetKey=@WidgetKey AND WPV.CMSContentWidgetId = CW.CMSContentWidgetId)
			AND EXISTS(SELECT * FROM ZnodeCMSWidgetProfileVariantLocale WPVL WHERE WPV.CMSWidgetProfileVariantId = WPVL.CMSWidgetProfileVariantId AND WPVL.LocaleId=@LocalId );
		
		END

		--2. Specific Store, Specific User Profile, Default Locale
		IF ISNULL(@GlobalEntityValueId,0) = 0
		BEGIN
			SELECT @LocalId = LocaleId FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;
			SELECT @LocaleCode = Code FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;

			SELECT @GlobalEntityValueId=CMSWidgetProfileVariantId 
			FROM ZnodeCMSWidgetProfileVariant WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = @ProfileId ) AND (ISNULL(WPV.PortalId,0) = @PortalId )
			AND EXISTS(SELECT * FROM ZnodeCMSContentWidget CW WITH (NOLOCK) WHERE CW.WidgetKey=@WidgetKey AND WPV.CMSContentWidgetId = CW.CMSContentWidgetId)
			AND EXISTS(SELECT * FROM ZnodeCMSWidgetProfileVariantLocale WPVL WHERE WPV.CMSWidgetProfileVariantId = WPVL.CMSWidgetProfileVariantId AND WPVL.LocaleId=@LocalId );
			
			IF ISNULL(@GlobalEntityValueId,0) = 0
			BEGIN
				SET @LocalId = @LocalIdInput
				SET @LocaleCode = @LocaleCodeInput
			END
		
		END

		--3. Specific Store, Any User Profile, Selected Locale
		IF ISNULL(@GlobalEntityValueId,0) = 0
		BEGIN
			SELECT @GlobalEntityValueId=CMSWidgetProfileVariantId 
			FROM ZnodeCMSWidgetProfileVariant WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = 0 ) AND (ISNULL(WPV.PortalId,0) = @PortalId )
			AND EXISTS(SELECT * FROM ZnodeCMSContentWidget CW WITH (NOLOCK) WHERE CW.WidgetKey=@WidgetKey AND WPV.CMSContentWidgetId = CW.CMSContentWidgetId)
			AND EXISTS(SELECT * FROM ZnodeCMSWidgetProfileVariantLocale WPVL WHERE WPV.CMSWidgetProfileVariantId = WPVL.CMSWidgetProfileVariantId AND WPVL.LocaleId=@LocalId );			
		END

		--4. Specific Store, Any User Profile, Default Locale
		IF ISNULL(@GlobalEntityValueId,0) = 0
		BEGIN
			SELECT @LocalId = LocaleId FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;
			SELECT @LocaleCode = Code FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;

			SELECT @GlobalEntityValueId=CMSWidgetProfileVariantId 
			FROM ZnodeCMSWidgetProfileVariant WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = 0 ) AND (ISNULL(WPV.PortalId,0) = @PortalId )
			AND EXISTS(SELECT * FROM ZnodeCMSContentWidget CW WITH (NOLOCK) WHERE CW.WidgetKey=@WidgetKey AND WPV.CMSContentWidgetId = CW.CMSContentWidgetId)
			AND EXISTS(SELECT * FROM ZnodeCMSWidgetProfileVariantLocale WPVL WHERE WPV.CMSWidgetProfileVariantId = WPVL.CMSWidgetProfileVariantId AND WPVL.LocaleId=@LocalId );			
		
			IF ISNULL(@GlobalEntityValueId,0) = 0
			BEGIN
				SET @LocalId = @LocalIdInput
				SET @LocaleCode = @LocaleCodeInput
			END
		END
		
		--5. Any Store, Any User Profile, Selected Locale
		IF ISNULL(@GlobalEntityValueId,0) = 0
		BEGIN
			SELECT @GlobalEntityValueId=CMSWidgetProfileVariantId 
			FROM ZnodeCMSWidgetProfileVariant WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = 0 ) AND (ISNULL(WPV.PortalId,0) = 0 )
			AND EXISTS(SELECT * FROM ZnodeCMSContentWidget CW WITH (NOLOCK) WHERE CW.WidgetKey=@WidgetKey AND WPV.CMSContentWidgetId = CW.CMSContentWidgetId)
			AND EXISTS(SELECT * FROM ZnodeCMSWidgetProfileVariantLocale WPVL WHERE WPV.CMSWidgetProfileVariantId = WPVL.CMSWidgetProfileVariantId AND WPVL.LocaleId=@LocalId );			
		END

		--6. Any Store, Any User Profile, Default Locale
		IF ISNULL(@GlobalEntityValueId,0) = 0
		BEGIN
			SELECT @LocalId = LocaleId FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;
			SELECT @LocaleCode = Code FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;

			SELECT @GlobalEntityValueId=CMSWidgetProfileVariantId 
			FROM ZnodeCMSWidgetProfileVariant WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = 0 ) AND (ISNULL(WPV.PortalId,0) = 0 )
			AND EXISTS(SELECT * FROM ZnodeCMSContentWidget CW WITH (NOLOCK) WHERE CW.WidgetKey=@WidgetKey AND WPV.CMSContentWidgetId = CW.CMSContentWidgetId)
			AND EXISTS(SELECT * FROM ZnodeCMSWidgetProfileVariantLocale WPVL WHERE WPV.CMSWidgetProfileVariantId = WPVL.CMSWidgetProfileVariantId AND WPVL.LocaleId=@LocalId );			
		
			IF ISNULL(@GlobalEntityValueId,0) = 0
			BEGIN
				SET @LocalId = @LocalIdInput
				SET @LocaleCode = @LocaleCodeInput
			END
		END
		
		-- This will take FamilyCode based on the inputs.
		SELECT @FamilyCode=GAF.FamilyCode
		FROM ZnodeCMSContentWidget CCW WITH (NOLOCK)
		INNER JOIN ZnodeGlobalAttributeFamily GAF WITH (NOLOCK) ON CCW.FamilyId=GAF.GlobalAttributeFamilyId
		WHERE CCW.WidgetKey=@WidgetKey 
		AND EXISTS(SELECT * FROM ZnodeCMSWidgetProfileVariant CWPV WHERE CCW.CMSContentWidgetId = CWPV.CMSContentWidgetId AND (ISNULL(CWPV.PortalId,0)=@PortalId));

		-- Based on input @EntityName='Content Widgets' as fixed value this will execute nested SP.
		-- Nested SP will give 2 Output (1 Result set & 1 Msg.
		IF @EntityName='Content Containers'
		begin
			 EXEC [dbo].[Znode_GetWidgetGlobalAttributeValue]
			 @EntityName=@EntityName,
			 @GlobalEntityValueId=@GlobalEntityValueId,
			 @LocaleCode=@LocaleCode,
			 @GroupCode =@GroupCode,
			 @SelectedValue = @SelectedValue;

		end
		
		-- This will take FamilyCode based on the inputs.
		SELECT @FamilyCode=GAF.FamilyCode
		FROM ZnodeCMSContentWidget CCW WITH (NOLOCK)
		INNER JOIN ZnodeGlobalAttributeFamily GAF WITH (NOLOCK) ON CCW.FamilyId=GAF.GlobalAttributeFamilyId
		WHERE CCW.WidgetKey=@WidgetKey 
		AND EXISTS(SELECT * FROM ZnodeCMSWidgetProfileVariant CWPV WHERE CCW.CMSContentWidgetId = CWPV.CMSContentWidgetId AND (ISNULL(CWPV.PortalId,0)=@PortalId));

		IF ISNULL(@FamilyCode,'') = ''
		BEGIN
			-- This will take FamilyCode based on the inputs.
			SELECT @FamilyCode=GAF.FamilyCode
			FROM ZnodeCMSContentWidget CCW WITH (NOLOCK)
			INNER JOIN ZnodeGlobalAttributeFamily GAF WITH (NOLOCK) ON CCW.FamilyId=GAF.GlobalAttributeFamilyId
			WHERE CCW.WidgetKey=@WidgetKey 
			AND EXISTS(SELECT * FROM ZnodeCMSWidgetProfileVariant CWPV WHERE CCW.CMSContentWidgetId = CWPV.CMSContentWidgetId AND (ISNULL(CWPV.PortalId,0)=0));
		END

		-- This will give 3rd result set of Attribute Groups Data.
		SELECT GE.GlobalEntityId, GE.EntityName, GE.IsActive, GE.TableName, GE.IsFamilyUnique
			, GAF.GlobalAttributeFamilyId, GAF.FamilyCode, GAF.IsSystemDefined, GAF.GlobalEntityId
			, GFGM.GlobalFamilyGroupMapperId, GFGM.GlobalAttributeFamilyId, GFGM.GlobalAttributeGroupId
			, GFGM.AttributeGroupDisplayOrder
			, GAG.GlobalAttributeGroupId, GAG.GroupCode, GAG.DisplayOrder, GAG.IsSystemDefined, GAG.GlobalEntityId
			, GAGL.GlobalAttributeGroupLocaleId, GAGL.LocaleId, GAGL.GlobalAttributeGroupId, GAGL.AttributeGroupName
			, GAGL.[Description]
		FROM ZnodeGlobalEntity GE WITH (NOLOCK)
		INNER JOIN ZnodeGlobalAttributeFamily GAF WITH (NOLOCK) ON GE.GlobalEntityId=GAF.GlobalEntityId
		INNER JOIN ZnodeGlobalFamilyGroupMapper GFGM WITH (NOLOCK) ON GAF.GlobalAttributeFamilyId=GFGM.GlobalAttributeFamilyId
		INNER JOIN ZnodeGlobalAttributeGroup GAG WITH (NOLOCK) ON GFGM.GlobalAttributeGroupId=GAG.GlobalAttributeGroupId
		INNER JOIN ZnodeGlobalAttributeGroupLocale GAGL WITH (NOLOCK) ON GAG.GlobalAttributeGroupId=GAGL.GlobalAttributeGroupId
		WHERE GE.EntityName=@EntityName AND GAGL.LocaleId=@LocalId AND GAF.FamilyCode=@FamilyCode
		ORDER BY GFGM.AttributeGroupDisplayOrder;

		-- This will give 4th result set of WidgetProfile & ContentWidget Data.
		SELECT CWPV.CMSWidgetProfileVariantId, CWPV.CMSContentWidgetId, CWPV.ProfileId, CWPVL.LocaleId, CWPVL.CMSWidgetTemplateId
			,CCW.CMSContentWidgetId, CCW.[Name], CCW.WidgetKey, CWPV.PortalId, CCW.FamilyId, CCW.Tags
		FROM ZnodeCMSWidgetProfileVariant CWPV WITH (NOLOCK)
		INNER JOIN ZnodeCMSWidgetProfileVariantLocale CWPVL WITH (NOLOCK) ON CWPV.CMSWidgetProfileVariantId = CWPVL.CMSWidgetProfileVariantId
		INNER JOIN ZnodeCMSContentWidget CCW WITH (NOLOCK) ON CWPV.CMSContentWidgetId=CCW.CMSContentWidgetId
		WHERE (ISNULL(CWPV.ProfileId,0) = @ProfileId OR ISNULL(CWPV.ProfileId,0) = 0) AND CWPVL.LocaleId=@LocalId AND CCW.WidgetKey=@WidgetKey AND ((ISNULL(CWPV.PortalId,0)=@PortalId OR ISNULL(CWPV.PortalId,0) = 0));

		-- This will give 5th result set of WidgetTemplate & ContentWidget Data.
		SELECT CWT.CMSWidgetTemplateId, CWT.[FileName], CWT.MediaId, CCW.[Name], CCW.FamilyId, CCW.Tags
		FROM ZnodeCMSContentWidget CCW WITH (NOLOCK) 
		INNER JOIN ZnodeCMSWidgetProfileVariant CWPV ON CCW.CMSContentWidgetId = CWPV.CMSContentWidgetId AND (ISNULL(CWPV.PortalId,0)=@PortalId OR ISNULL(CWPV.PortalId,0) = 0)
		INNER JOIN ZnodeCMSWidgetProfileVariantLocale CWPVL ON CWPV.CMSWidgetProfileVariantId = CWPVL.CMSWidgetProfileVariantId
		INNER JOIN  ZnodeCMSWidgetTemplate CWT WITH (NOLOCK) ON (CWPVL.CMSWidgetTemplateId = CWT.CMSWidgetTemplateId OR ISNULL(CWPVL.CMSWidgetTemplateId,0) = 0)
		WHERE CCW.WidgetKey=@WidgetKey
	END TRY
	BEGIN CATCH
		SELECT ERROR_MESSAGE()
		DECLARE @Status BIT;
		SET @Status = 0;

		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(),
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetContentWidgetAttributeValue
					@EntityName = '''+ISNULL(@EntityName,'''''')+
					''',@WidgetKey='+ISNULL(@WidgetKey,'''')+
					''',@LocalId='+ISNULL(CAST(@LocalId AS VARCHAR(20)),'''')+
					''',@PortalId='+ISNULL(CAST(@PortalId AS VARCHAR(20)),'''')+
					''',@ProfileId='+ISNULL(CAST(@ProfileId AS VARCHAR(20)),'''')
					
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_GetContentWidgetAttributeValue',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetContentWidgetGlobalAttributeValue')
	DROP PROC Znode_GetContentWidgetGlobalAttributeValue

GO

CREATE PROCEDURE [dbo].[Znode_GetContentWidgetGlobalAttributeValue]
(
    @EntityName       NVARCHAR(500) = 0,
	@FamilyCode   VARCHAR(200),
	@LocaleCode       VARCHAR(100) = '',
    @GroupCode  NVARCHAR(200) = null,
    @SelectedValue BIT = 0
)
AS
 BEGIN
 BEGIN TRY
	DECLARE @LocaleId INT
	DECLARE @GlobalFamilyId   INT =(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode = @FamilyCode)
	DECLARE @V_MediaServerThumbnailPath VARCHAR(4000);
          SET @V_MediaServerThumbnailPath =
         (
             SELECT ISNULL(CASE WHEN CDNURL = '' THEN NULL ELSE CDNURL END,URL)+ZMSM.ThumbnailFolderName+'/'  
             FROM ZnodeMediaConfiguration ZMC 
			 INNER JOIN ZnodeMediaServerMaster ZMSM ON (ZMSM.MediaServerMasterId = ZMC.MediaServerMasterId)
		     WHERE IsActive = 1 
         );

        Declare	@EntityAttributeList AS TABLE  (GlobalEntityId INT,EntityName NVARCHAR(300),
		GlobalAttributeGroupId INT,GlobalAttributeId INT,AttributeTypeId INT,AttributeTypeName NVARCHAR(300),
			AttributeCode NVARCHAR(300) ,IsRequired bit,IsLocalizable bit,AttributeName  NVARCHAR(300) , HelpDescription NVARCHAR(max),DisplayOrder INT
		) 
			 
		Declare @EntityAttributeValidationList  AS TABLE  
		( GlobalAttributeId INT, ControlName NVARCHAR(300), ValidationName NVARCHAR(300),SubValidationName NVARCHAR(300),
			RegExp NVARCHAR(300), ValidationValue NVARCHAR(300),IsRegExp Bit)

		Declare	@EntityAttributeDefaultValueList AS TABLE  (GlobalAttributeDefaultValueId INT,GlobalAttributeId INT,
		AttributeDefaultValueCode NVARCHAR(300),AttributeDefaultValue NVARCHAR(300),RowId INT,IsEditable bit,DisplayOrder INT )

		set @LocaleId = (select top 1 LocaleId FROM ZnodeLocale WHERE Code = @LocaleCode)

        IF ISnull(@GroupCode, '') = ''
        BEGIN
			INSERT INTO @EntityAttributeList
				(	GlobalEntityId ,EntityName  ,
				GlobalAttributeGroupId ,GlobalAttributeId ,AttributeTypeId ,AttributeTypeName ,
				AttributeCode  ,IsRequired ,IsLocalizable ,AttributeName,HelpDescription,DisplayOrder  ) 
			SELECT qq.GlobalEntityId,qq.EntityName,ww.GlobalAttributeGroupId,
				c.GlobalAttributeId,c.AttributeTypeId,q.AttributeTypeName,c.AttributeCode,c.IsRequired,
				c.IsLocalizable,f.AttributeName,c.HelpDescription,c.DisplayOrder
			FROM dbo.ZnodeGlobalEntity AS qq
				INNER JOIN dbo.ZnodeGlobalAttributeFamily AS w ON qq.GlobalEntityId = w.GlobalEntityId
				INNER JOIN dbo.ZnodeGlobalFamilyGroupMapper AS FGM ON FGM.GlobalAttributeFamilyId = w.GlobalAttributeFamilyId
				INNER JOIN dbo.ZnodeGlobalAttributeGroupMapper AS ww ON ww.GlobalAttributeGroupId = FGM.GlobalAttributeGroupId
				INNER JOIN dbo.ZnodeGlobalAttribute AS c ON ww.GlobalAttributeId = c.GlobalAttributeId
				INNER JOIN dbo.ZnodeAttributeType AS q ON c.AttributeTypeId = q.AttributeTypeId
				INNER JOIN dbo.ZnodeGlobalAttributeLocale AS f ON c.GlobalAttributeId = f.GlobalAttributeId
				WHERE qq.EntityName=@EntityName --AND ( f.LocaleId = isnull(@LocaleId, 0 ) or isnull(@LocaleId,0) = 0 )
				and w.GlobalAttributeFamilyId = @GlobalFamilyId

		END
		Else

            BEGIN
                    INSERT INTO @EntityAttributeList
                            ( GlobalEntityId ,EntityName  ,
                            GlobalAttributeGroupId ,GlobalAttributeId ,AttributeTypeId ,AttributeTypeName ,
                            AttributeCode  ,IsRequired ,IsLocalizable ,AttributeName,HelpDescription,DisplayOrder  )
                            SELECT qq.GlobalEntityId,qq.EntityName,ww.GlobalAttributeGroupId,
                            c.GlobalAttributeId,c.AttributeTypeId,q.AttributeTypeName,c.AttributeCode,c.IsRequired,
                            c.IsLocalizable,f.AttributeName,c.HelpDescription,c.DisplayOrder
                    FROM dbo.ZnodeGlobalEntity AS qq
					INNER JOIN dbo.ZnodeGlobalAttributeFamily AS w ON qq.GlobalEntityId = w.GlobalEntityId
					INNER JOIN dbo.ZnodeGlobalFamilyGroupMapper AS FGM ON FGM.GlobalAttributeFamilyId = w.GlobalAttributeFamilyId
					INNER JOIN dbo.ZnodeGlobalAttributeGroupMapper AS ww ON ww.GlobalAttributeGroupId = FGM.GlobalAttributeGroupId
					INNER JOIN dbo.ZnodeGlobalAttribute AS c ON ww.GlobalAttributeId = c.GlobalAttributeId
					INNER JOIN dbo.ZnodeAttributeType AS q ON c.AttributeTypeId = q.AttributeTypeId
					INNER JOIN dbo.ZnodeGlobalAttributeLocale AS f ON c.GlobalAttributeId = f.GlobalAttributeId
					WHERE qq.EntityName=@EntityName AND ( f.LocaleId = isnull(@LocaleId, 0 ) or isnull(@LocaleId,0) = 0 )
					and w.GlobalAttributeFamilyId = @GlobalFamilyId	
                                AND exists( select 1 FROM ZnodeGlobalAttributeGroup g WHERE ww.GlobalAttributeGroupId = g.GlobalAttributeGroupId and g.GroupCode = @GroupCode )	
        
			END

			INSERT INTO @EntityAttributeValidationList
			(GlobalAttributeId,ControlName , ValidationName ,SubValidationName , RegExp, ValidationValue,IsRegExp)
			Select aa.GlobalAttributeId,i.ControlName,i.Name AS ValidationName,j.ValidationName AS SubValidationName,
			j.RegExp,k.Name AS ValidationValue,CAST(CASE WHEN j.RegExp IS NULL THEN 0 ELSE 1 END AS BIT) AS IsRegExp		
			FROM @EntityAttributeList aa
			INNER JOIN dbo.ZnodeGlobalAttributeValidation AS k ON k.GlobalAttributeId = aa.GlobalAttributeId
			INNER JOIN dbo.ZnodeAttributeInputValidation AS i ON k.InputValidationId = i.InputValidationId
			LEFT JOIN dbo.ZnodeAttributeInputValidationRule AS j ON k.InputValidationRuleId = j.InputValidationRuleId

			INSERT INTO @EntityAttributeDefaultValueList
			(GlobalAttributeDefaultValueId,GlobalAttributeId,AttributeDefaultValueCode,
			AttributeDefaultValue ,RowId ,IsEditable ,DisplayOrder )
			Select  h.GlobalAttributeDefaultValueId, aa.GlobalAttributeId,h.AttributeDefaultValueCode,g.AttributeDefaultValue,0,ISNULL(h.IsEditable, 1),
			h.DisplayOrder
			FROM  @EntityAttributeList aa
			INNER JOIN dbo.ZnodeGlobalAttributeDefaultValue h ON h.GlobalAttributeId = aa.GlobalAttributeId
			INNER JOIN dbo.ZnodeGlobalAttributeDefaultValueLocale g ON h.GlobalAttributeDefaultValueId = g.GlobalAttributeDefaultValueId
		  
		 
			IF NOT EXISTS (SELECT 1 FROM @EntityAttributeList )
			BEGIN
				INSERT INTO @EntityAttributeList
				(	GlobalEntityId ,EntityName  ,GlobalAttributeGroupId ,GlobalAttributeId ,AttributeTypeId ,AttributeTypeName ,
				AttributeCode  ,IsRequired ,IsLocalizable ,AttributeName,HelpDescription  ) 
				SELECT qq.GlobalEntityId,qq.EntityName,0 GlobalAttributeGroupId,
				0 GlobalAttributeId,0 AttributeTypeId,''AttributeTypeName,''AttributeCode,0 IsRequired,
				0 IsLocalizable,'' AttributeName,'' HelpDescription
				FROM dbo.ZnodeGlobalEntity AS qq
				WHERE qq.EntityName=@EntityName 
			End
				

			SELECT GlobalEntityId,EntityName,GlobalAttributeGroupId,
			AA.GlobalAttributeId,AttributeTypeId,AttributeTypeName,AttributeCode,IsRequired,
			IsLocalizable,AttributeName,ControlName,ValidationName,SubValidationName,RegExp,
			ValidationValue,cast(isnull(IsRegExp,0) as bit)  IsRegExp,
			HelpDescription,NULL AS AttributeValue,NULL AS GlobalAttributeValueId,NULL AS GlobalAttributeDefaultValueId,
			aab.AttributeDefaultValueCode,
			aab.AttributeDefaultValue,isnull(aab.RowId,0)   RowId,cast(isnull(aab.IsEditable,0) as bit)   IsEditable
			,NULL AS MediaId,AA.DisplayOrder
			FROM @EntityAttributeList AA				
			LEFT JOIN @EntityAttributeDefaultValueList aab on aab.GlobalAttributeId=AA.GlobalAttributeId	
			LEFT JOIN @EntityAttributeValidationList vl on vl.GlobalAttributeId=aa.GlobalAttributeId			
			ORDER BY AA.DisplayOrder, aab.DisplayOrder

			SELECT 1 AS ID,CAST(1 AS BIT) AS Status;       
END TRY
BEGIN CATCH
	SELECT ERROR_MESSAGE()
		DECLARE @Status BIT ;
	SET @Status = 0;

	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
	@ErrorLine VARCHAR(100)= ERROR_LINE(),
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetContentWidgetGlobalAttributeValue 
	@EntityName = '+@EntityName+',@LocaleCode='+@LocaleCode+',
	@GroupCode = '+@GroupCode+',@SelectedValue = '+CAST(@SelectedValue AS VARCHAR(10))+',@GlobalFamilyId = '+CAST(@GlobalFamilyId AS VARCHAR(10));   
		 
	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_GetContentWidgetGlobalAttributeValue',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetGlobalEntityAttributeValue')
	DROP PROC Znode_GetGlobalEntityAttributeValue

GO



CREATE   PROCEDURE [dbo].[Znode_GetGlobalEntityAttributeValue]
(
    @EntityName       nvarchar(200) = 0,
    @GlobalEntityValueId   INT = 0,
	@LocaleCode       nvarchar(200) = '',
	@GroupCode nvarchar(200)  = null,
	@SelectedValue bit = 0
)
AS
/*
	 Summary :- This procedure is used to get the Attribute and EntityValue attribute value as per filter pass 
	 Unit Testing 
	 BEGIN TRAN
	 EXEC [Znode_GetGlobalEntityAttributeValue] 'Store',1
	 ROLLBACK TRAN

*/	 
     BEGIN
         BEGIN TRY
 


		 IF @EntityName='Store'
			 Exec [dbo].[Znode_GetPortalGlobalAttributeValue] 
			 @EntityName=@EntityName,
			 @GlobalEntityValueId=@GlobalEntityValueId,@LocaleCode=@LocaleCode,
			 @GroupCode =@GroupCode,
			 @SelectedValue = @SelectedValue

		 Else IF @EntityName='User'
			 Exec [dbo].[Znode_GetUserGlobalAttributeValue] 
			 @EntityName=@EntityName,
			 @GlobalEntityValueId=@GlobalEntityValueId,
			 @LocaleCode=@LocaleCode,
			 @GroupCode =@GroupCode,
			 @SelectedValue = @SelectedValue

		Else IF @EntityName='Account'
			 Exec [dbo].[Znode_GetAccountGlobalAttributeValue] 
			 @EntityName=@EntityName,
			 @GlobalEntityValueId=@GlobalEntityValueId,
			 @LocaleCode=@LocaleCode,
			 @GroupCode =@GroupCode,
			 @SelectedValue = @SelectedValue
		--Else IF @EntityName='FormBuilder'
		--	 Exec [dbo].[Znode_GetFormBuilderGlobalAttributeValue] 
		--	 @EntityName=@EntityName,
		--	 @GlobalEntityValueId=@GlobalEntityValueId

		
			 Else IF @EntityName='Content Containers'
			 Exec [dbo].[Znode_GetWidgetGlobalAttributeValue] 
			 @EntityName=@EntityName,
			 @GlobalEntityValueId=@GlobalEntityValueId,
			 @LocaleCode=@LocaleCode,
			 @GroupCode =@GroupCode,
			 @SelectedValue = @SelectedValue
   
		  END TRY
         BEGIN CATCH
		 SELECT ERROR_MESSAGE()
             DECLARE @Status BIT ;
		  SET @Status = 0;
		  DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
		   @ErrorLine VARCHAR(100)= ERROR_LINE(),
		    @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetGlobalEntityAttributeValue @EntityName = '''+ISNULL(@EntityName,'''''')+''',@GlobalEntityValueId='+ISNULL(CAST(@GlobalEntityValueId AS VARCHAR(50)),'''')+
			''',@LocaleCode='+ISNULL(CAST(@LocaleCode AS VARCHAR(100)),'''')+''',@GroupCode='+ISNULL(CAST(@GroupCode AS VARCHAR(100)),'''')+''',@SelectedValue='+ISNULL(CAST(@SelectedValue AS VARCHAR(50)),'''')      			 
          SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                     
		 
          EXEC Znode_InsertProcedureErrorLog
            @ProcedureName = 'Znode_GetGlobalEntityAttributeValue',
            @ErrorInProcedure = @Error_procedure,
            @ErrorMessage = @ErrorMessage,
            @ErrorLine = @ErrorLine,
            @ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetWidgetGlobalAttributeValue')
	DROP PROC Znode_GetWidgetGlobalAttributeValue

GO

CREATE PROCEDURE [dbo].[Znode_GetWidgetGlobalAttributeValue]
(
    @EntityName       nvarchar(200) = 0,
    @GlobalEntityValueId   INT = 0,
	@LocaleCode       VARCHAR(100) = '',
    @GroupCode  nvarchar(200) = null,
    @SelectedValue bit = 0
)
AS
 BEGIN
 BEGIN TRY
 declare @EntityValue nvarchar(200), @LocaleId int, @WidgetId int, @DefaultLocaleId INT

 

  DECLARE @V_MediaServerThumbnailPath VARCHAR(4000);
          SET @V_MediaServerThumbnailPath =
         (
             SELECT ISNULL(CASE WHEN CDNURL = '' THEN NULL ELSE CDNURL END,URL) 
             FROM ZnodeMediaConfiguration ZMC 
			 --INNER JOIN ZnodeMediaServerMaster ZMSM ON (ZMSM.MediaServerMasterId = ZMC.MediaServerMasterId)
		     WHERE IsActive = 1 
         );

 Select @EntityValue= Name,@WidgetId = CCW.CMSContentContainerId from ZnodeCMSContentContainer CCW
 inner join ZnodeCMSContainerProfileVariant CWPV  on CCW.CMSContentContainerId = CWPV.CMSContentContainerId
 Where CWPV.CMSContainerProfileVariantId = @GlobalEntityValueId

 	DECLARE @GlobalFamilyId int
	SET  @GlobalFamilyId = (select top 1 FM.GlobalAttributeFamilyId from ZnodeGlobalEntity GE inner join  ZnodeGlobalEntityFamilyMapper FM
	on GE.GlobalEntityId = FM.GlobalEntityId
	where GE.EntityName =  @EntityName and  (FM.GlobalEntityValueId = @GlobalEntityValueId ))
  

            Declare	@EntityAttributeList as	table  (GlobalEntityId int,EntityName nvarchar(300),EntityValue nvarchar(max),
			GlobalAttributeGroupId int,GlobalAttributeId int,AttributeTypeId int,AttributeTypeName nvarchar(300),
			 AttributeCode nvarchar(300) ,IsRequired bit,IsLocalizable bit,AttributeName  nvarchar(300) , HelpDescription nvarchar(max),DisplayOrder int
			) 
			 
			Declare @EntityAttributeValidationList  as	table  
			( GlobalAttributeId int, ControlName nvarchar(300), ValidationName nvarchar(300),SubValidationName nvarchar(300),
			 RegExp nvarchar(300), ValidationValue nvarchar(300),IsRegExp Bit)

			Declare	@EntityAttributeValueList as	table  (GlobalAttributeId int,AttributeValue nvarchar(max),
			GlobalAttributeValueId int,GlobalAttributeDefaultValueId int,AttributeDefaultValueCode nvarchar(300),
			AttributeDefaultValue nvarchar(300),
			MediaId int,MediaPath nvarchar(300),IsEditable bit,DisplayOrder int )



			Declare	@EntityAttributeDefaultValueList as	table  (GlobalAttributeDefaultValueId int,GlobalAttributeId int,
			AttributeDefaultValueCode nvarchar(300),AttributeDefaultValue nvarchar(300),RowId int,IsEditable bit,DisplayOrder int )

			set @LocaleId = (select top 1 LocaleId from ZnodeLocale where Code = @LocaleCode)
			set @DefaultLocaleId = (select top 1 LocaleId from ZnodeLocale WHERE IsDefault = 1)

			if isnull(@LocaleId,0)=0
				set @LocaleId = (select top 1 LocaleId from ZnodeLocale WHERE IsDefault = 1)

            IF ISnull(@GroupCode, '') = ''
            Begin
			
				insert into @EntityAttributeList
					(	GlobalEntityId ,EntityName ,EntityValue ,
					GlobalAttributeGroupId ,GlobalAttributeId ,AttributeTypeId ,AttributeTypeName ,
					AttributeCode  ,IsRequired ,IsLocalizable ,AttributeName,HelpDescription,DisplayOrder  ) 
				SELECT qq.GlobalEntityId,qq.EntityName,@EntityValue EntityValue,ww.GlobalAttributeGroupId,
					c.GlobalAttributeId,c.AttributeTypeId,q.AttributeTypeName,c.AttributeCode,c.IsRequired,
					c.IsLocalizable,f.AttributeName,c.HelpDescription,c.DisplayOrder
				 FROM dbo.ZnodeGlobalEntity AS qq
					  INNER JOIN dbo.ZnodeGlobalAttributeFamily AS w ON qq.GlobalEntityId = w.GlobalEntityId
					  INNER JOIN dbo.ZnodeGlobalFamilyGroupMapper AS FGM ON FGM.GlobalAttributeFamilyId = w.GlobalAttributeFamilyId
					  INNER JOIN dbo.ZnodeGlobalAttributeGroupMapper AS ww ON ww.GlobalAttributeGroupId = FGM.GlobalAttributeGroupId
					  INNER JOIN dbo.ZnodeGlobalAttribute AS c ON ww.GlobalAttributeId = c.GlobalAttributeId
					  INNER JOIN dbo.ZnodeAttributeType AS q ON c.AttributeTypeId = q.AttributeTypeId
					  INNER JOIN dbo.ZnodeGlobalAttributeLocale AS f ON c.GlobalAttributeId = f.GlobalAttributeId
					  Where qq.EntityName=@EntityName AND ( f.LocaleId = isnull(@LocaleId, 0 ) or isnull(@LocaleId,0) = 0 )
					  and w.GlobalAttributeFamilyId = @GlobalFamilyId

				insert into @EntityAttributeList
				SELECT qq.GlobalEntityId,qq.EntityName,@EntityValue EntityValue,ww.GlobalAttributeGroupId,
					c.GlobalAttributeId,c.AttributeTypeId,q.AttributeTypeName,c.AttributeCode,c.IsRequired,
					c.IsLocalizable,f.AttributeName,c.HelpDescription,c.DisplayOrder
				 FROM dbo.ZnodeGlobalEntity AS qq
					  INNER JOIN dbo.ZnodeGlobalAttributeFamily AS w ON qq.GlobalEntityId = w.GlobalEntityId
					  INNER JOIN dbo.ZnodeGlobalFamilyGroupMapper AS FGM ON FGM.GlobalAttributeFamilyId = w.GlobalAttributeFamilyId
					  INNER JOIN dbo.ZnodeGlobalAttributeGroupMapper AS ww ON ww.GlobalAttributeGroupId = FGM.GlobalAttributeGroupId
					  INNER JOIN dbo.ZnodeGlobalAttribute AS c ON ww.GlobalAttributeId = c.GlobalAttributeId
					  INNER JOIN dbo.ZnodeAttributeType AS q ON c.AttributeTypeId = q.AttributeTypeId
					  INNER JOIN dbo.ZnodeGlobalAttributeLocale AS f ON c.GlobalAttributeId = f.GlobalAttributeId
					  Where qq.EntityName=@EntityName AND ( f.LocaleId = isnull(@DefaultLocaleId, 0 ) or isnull(@DefaultLocaleId,0) = 0 )
					  and w.GlobalAttributeFamilyId = @GlobalFamilyId
					AND NOT EXISTS(SELECT * FROM @EntityAttributeList Z
						WHERE qq.GlobalEntityId = Z.GlobalEntityId AND qq.EntityName = Z.EntityName AND c.GlobalAttributeId = Z.GlobalAttributeId)

				IF NOT EXISTS(SELECT * FROM @EntityAttributeList)
				BEGIN
					insert into @EntityAttributeList
					(	GlobalEntityId ,EntityName ,EntityValue ,
					GlobalAttributeGroupId ,GlobalAttributeId ,AttributeTypeId ,AttributeTypeName ,
					AttributeCode  ,IsRequired ,IsLocalizable ,AttributeName,HelpDescription,DisplayOrder  ) 
					SELECT qq.GlobalEntityId,qq.EntityName,@EntityValue EntityValue,ww.GlobalAttributeGroupId,
						c.GlobalAttributeId,c.AttributeTypeId,q.AttributeTypeName,c.AttributeCode,c.IsRequired,
						c.IsLocalizable,f.AttributeName,c.HelpDescription,c.DisplayOrder
					 FROM dbo.ZnodeGlobalEntity AS qq
					  INNER JOIN dbo.ZnodeGlobalAttributeFamily AS w ON qq.GlobalEntityId = w.GlobalEntityId
					  INNER JOIN dbo.ZnodeGlobalFamilyGroupMapper AS FGM ON FGM.GlobalAttributeFamilyId = w.GlobalAttributeFamilyId
					  INNER JOIN dbo.ZnodeGlobalAttributeGroupMapper AS ww ON ww.GlobalAttributeGroupId = FGM.GlobalAttributeGroupId
					  INNER JOIN dbo.ZnodeGlobalAttribute AS c ON ww.GlobalAttributeId = c.GlobalAttributeId
					  INNER JOIN dbo.ZnodeAttributeType AS q ON c.AttributeTypeId = q.AttributeTypeId
					  INNER JOIN dbo.ZnodeGlobalAttributeLocale AS f ON c.GlobalAttributeId = f.GlobalAttributeId
					  Where qq.EntityName=@EntityName ---AND ( f.LocaleId = isnull(@DefaultLocaleId, 0 ) or isnull(@DefaultLocaleId,0) = 0 )
					  --and w.GlobalAttributeFamilyId = @GlobalFamilyId
				END
			
			
			END
			Else

               Begin
                       insert into @EntityAttributeList
                               ( GlobalEntityId ,EntityName ,EntityValue ,
                               GlobalAttributeGroupId ,GlobalAttributeId ,AttributeTypeId ,AttributeTypeName ,
                               AttributeCode  ,IsRequired ,IsLocalizable ,AttributeName,HelpDescription,DisplayOrder  )
                               SELECT qq.GlobalEntityId,qq.EntityName,@EntityValue EntityValue,ww.GlobalAttributeGroupId,
                               c.GlobalAttributeId,c.AttributeTypeId,q.AttributeTypeName,c.AttributeCode,c.IsRequired,
                               c.IsLocalizable,f.AttributeName,c.HelpDescription,c.DisplayOrder
                        FROM dbo.ZnodeGlobalEntity AS qq
						INNER JOIN dbo.ZnodeGlobalAttributeFamily AS w ON qq.GlobalEntityId = w.GlobalEntityId
					  INNER JOIN dbo.ZnodeGlobalFamilyGroupMapper AS FGM ON FGM.GlobalAttributeFamilyId = w.GlobalAttributeFamilyId
					  INNER JOIN dbo.ZnodeGlobalAttributeGroupMapper AS ww ON ww.GlobalAttributeGroupId = FGM.GlobalAttributeGroupId
					  INNER JOIN dbo.ZnodeGlobalAttribute AS c ON ww.GlobalAttributeId = c.GlobalAttributeId
					  INNER JOIN dbo.ZnodeAttributeType AS q ON c.AttributeTypeId = q.AttributeTypeId
					  INNER JOIN dbo.ZnodeGlobalAttributeLocale AS f ON c.GlobalAttributeId = f.GlobalAttributeId
					  Where qq.EntityName=@EntityName AND ( f.LocaleId = isnull(@LocaleId, 0 ) or isnull(@LocaleId,0) = 0 )
					  and w.GlobalAttributeFamilyId = @GlobalFamilyId	
                                 AND exists( select 1 from ZnodeGlobalAttributeGroup g where ww.GlobalAttributeGroupId = g.GlobalAttributeGroupId and g.GroupCode = @GroupCode )	
        
					IF NOT EXISTS(SELECT * FROM @EntityAttributeList)
					BEGIN
						insert into @EntityAttributeList
                               ( GlobalEntityId ,EntityName ,EntityValue ,
                               GlobalAttributeGroupId ,GlobalAttributeId ,AttributeTypeId ,AttributeTypeName ,
                               AttributeCode  ,IsRequired ,IsLocalizable ,AttributeName,HelpDescription,DisplayOrder  )
                               SELECT qq.GlobalEntityId,qq.EntityName,@EntityValue EntityValue,ww.GlobalAttributeGroupId,
                               c.GlobalAttributeId,c.AttributeTypeId,q.AttributeTypeName,c.AttributeCode,c.IsRequired,
                               c.IsLocalizable,f.AttributeName,c.HelpDescription,c.DisplayOrder
						FROM dbo.ZnodeGlobalEntity AS qq
						INNER JOIN dbo.ZnodeGlobalAttributeFamily AS w ON qq.GlobalEntityId = w.GlobalEntityId
						  INNER JOIN dbo.ZnodeGlobalFamilyGroupMapper AS FGM ON FGM.GlobalAttributeFamilyId = w.GlobalAttributeFamilyId
						  INNER JOIN dbo.ZnodeGlobalAttributeGroupMapper AS ww ON ww.GlobalAttributeGroupId = FGM.GlobalAttributeGroupId
						  INNER JOIN dbo.ZnodeGlobalAttribute AS c ON ww.GlobalAttributeId = c.GlobalAttributeId
						  INNER JOIN dbo.ZnodeAttributeType AS q ON c.AttributeTypeId = q.AttributeTypeId
						  INNER JOIN dbo.ZnodeGlobalAttributeLocale AS f ON c.GlobalAttributeId = f.GlobalAttributeId
						  Where qq.EntityName=@EntityName --AND ( f.LocaleId = isnull(@DefaultLocaleId, 0 ) or isnull(@DefaultLocaleId,0) = 0 )
						  --and w.GlobalAttributeFamilyId = @GlobalFamilyId	
                          AND exists( select 1 from ZnodeGlobalAttributeGroup g where ww.GlobalAttributeGroupId = g.GlobalAttributeGroupId and g.GroupCode = @GroupCode )	
        
					END
			   
			   
			   END


		  INSERT INTO @EntityAttributeValidationList
		  (GlobalAttributeId,ControlName , ValidationName ,SubValidationName ,
		RegExp, ValidationValue,IsRegExp)

		

		 Select aa.GlobalAttributeId,i.ControlName,i.Name AS ValidationName,j.ValidationName AS SubValidationName,
		j.RegExp,k.Name AS ValidationValue,CAST(CASE WHEN j.RegExp IS NULL THEN 0 ELSE 1 END AS BIT) AS IsRegExp
		
		fROM @EntityAttributeList aa
		  inner  JOIN dbo.ZnodeGlobalAttributeValidation AS k ON k.GlobalAttributeId = aa.GlobalAttributeId
          inner  JOIN dbo.ZnodeAttributeInputValidation AS i ON k.InputValidationId = i.InputValidationId
          LEFT  JOIN dbo.ZnodeAttributeInputValidationRule AS j ON k.InputValidationRuleId = j.InputValidationRuleId

		  insert into @EntityAttributeValueList
		  (GlobalAttributeId,GlobalAttributeValueId,GlobalAttributeDefaultValueId,AttributeValue ,MediaId,MediaPath)
		  Select DISTINCT GlobalAttributeId,aa.WidgetGlobalAttributeValueId,bb.GlobalAttributeDefaultValueId,
		  case when bb.MediaPath is not null then  @V_MediaServerThumbnailPath+bb.MediaPath--+'~'+convert(nvarchar(10),bb.MediaId) 
		  else bb.AttributeValue end,		  
		  bb.MediaId,bb.MediaPath
		  from  dbo.ZnodeWidgetGlobalAttributeValue aa
		   inner join ZnodeWidgetGlobalAttributeValueLocale bb ON bb.WidgetGlobalAttributeValueId = aa.WidgetGlobalAttributeValueId 
		  Where  aa.CMSContainerProfileVariantId=@GlobalEntityValueId and aa.CMSContentContainerId = @WidgetId		
		  AND ( bb.LocaleId = isnull(@LocaleId, 0 ) or isnull(@LocaleId,0) = 0 )
	

		  update aa
		  Set AttributeDefaultValueCode= h.AttributeDefaultValueCode,
              AttributeDefaultValue=g.AttributeDefaultValue,
			  GlobalAttributeDefaultValueId=g.GlobalAttributeDefaultValueId,
			  AttributeValue=case when aa.AttributeValue is  null then h.AttributeDefaultValueCode else aa.AttributeValue end,
			  IsEditable = ISNULL(h.IsEditable, 1),DisplayOrder = h.DisplayOrder
		  from  @EntityAttributeValueList aa
		  inner JOIN dbo.ZnodeGlobalAttributeDefaultValue h ON h.GlobalAttributeDefaultValueId = aa.GlobalAttributeDefaultValueId                                       
          inner JOIN dbo.ZnodeGlobalAttributeDefaultValueLocale g ON h.GlobalAttributeDefaultValueId = g.GlobalAttributeDefaultValueId
		  WHERE ( G.LocaleId = isnull(@LocaleId, 0 ) or isnull(@LocaleId,0) = 0 )
          
		  insert into @EntityAttributeDefaultValueList
		  (GlobalAttributeDefaultValueId,GlobalAttributeId,AttributeDefaultValueCode,
			AttributeDefaultValue ,RowId ,IsEditable ,DisplayOrder )
		  Select  h.GlobalAttributeDefaultValueId, aa.GlobalAttributeId,h.AttributeDefaultValueCode,g.AttributeDefaultValue,0,ISNULL(h.IsEditable, 1),
		  h.DisplayOrder
		  from  @EntityAttributeList aa
		  inner JOIN dbo.ZnodeGlobalAttributeDefaultValue h ON h.GlobalAttributeId = aa.GlobalAttributeId
          inner JOIN dbo.ZnodeGlobalAttributeDefaultValueLocale g ON h.GlobalAttributeDefaultValueId = g.GlobalAttributeDefaultValueId
		  WHERE ( G.LocaleId = isnull(@LocaleId, 0 ) or isnull(@LocaleId,0) = 0 )
		 
			if not exists (Select 1 from @EntityAttributeList )
			Begin
			insert into @EntityAttributeList
			(	GlobalEntityId ,EntityName ,EntityValue ,
			GlobalAttributeGroupId ,GlobalAttributeId ,AttributeTypeId ,AttributeTypeName ,
			AttributeCode  ,IsRequired ,IsLocalizable ,AttributeName,HelpDescription  ) 
			SELECT qq.GlobalEntityId,qq.EntityName,@EntityValue EntityValue,0 GlobalAttributeGroupId,
			0 GlobalAttributeId,0 AttributeTypeId,''AttributeTypeName,''AttributeCode,0 IsRequired,
			0 IsLocalizable,'' AttributeName,'' HelpDescription
			FROM dbo.ZnodeGlobalEntity AS qq
			 Where qq.EntityName=@EntityName 
			End
				

			SELECT GlobalEntityId,EntityName,EntityValue,GlobalAttributeGroupId,
			AA.GlobalAttributeId,AttributeTypeId,AttributeTypeName,AttributeCode,IsRequired,
			IsLocalizable,AttributeName,ControlName,ValidationName,SubValidationName,RegExp,
			ValidationValue,cast(isnull(IsRegExp,0) as bit)  IsRegExp,
			HelpDescription,AttributeValue,GlobalAttributeValueId,bb.GlobalAttributeDefaultValueId,
			aab.AttributeDefaultValueCode,
			aab.AttributeDefaultValue,isnull(aab.RowId,0)   RowId,cast(isnull(aab.IsEditable,0) as bit)   IsEditable
			,bb.MediaId,AA.DisplayOrder
			fROM @EntityAttributeList AA				
			left join @EntityAttributeDefaultValueList aab on aab.GlobalAttributeId=AA.GlobalAttributeId	
			left join @EntityAttributeValidationList vl on vl.GlobalAttributeId=aa.GlobalAttributeId			
			LEFT JOIN @EntityAttributeValueList BB ON BB.GlobalAttributeId=AA.GlobalAttributeId		 
		    and ( (aab.GlobalAttributeDefaultValueId=bb.GlobalAttributeDefaultValueId	)
			or  ( bb.MediaId is not null and isnull(vl.ValidationName,'')='IsAllowMultiUpload'  and bb.GlobalAttributeDefaultValueId is null )
			or  ( bb.MediaId is  null and  bb.GlobalAttributeDefaultValueId is null ))
			order by AA.DisplayOrder, aab.DisplayOrder

			SELECT 1 AS ID,CAST(1 AS BIT) AS Status;       
		  END TRY
         BEGIN CATCH
		 SELECT ERROR_MESSAGE()
             DECLARE @Status BIT ;
		  SET @Status = 0;

		  DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
		   @ErrorLine VARCHAR(100)= ERROR_LINE(),
		   @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetWidgetGlobalAttributeValue 
		   @EntityName = '+@EntityName+',@GlobalEntityValueId='+CAST(@GlobalEntityValueId AS VARCHAR(10))+',@LocaleCode='+@LocaleCode+',
		   @GroupCode = '+@GroupCode+',@SelectedValue = '+CAST(@SelectedValue AS VARCHAR(10));   
		 
          EXEC Znode_InsertProcedureErrorLog
            @ProcedureName = 'Znode_GetWidgetGlobalAttributeValue',
            @ErrorInProcedure = @Error_procedure,
            @ErrorMessage = @ErrorMessage,
            @ErrorLine = @ErrorLine,
            @ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportInsertUpdateWidgetGlobalAttributeValue')
	DROP PROC Znode_ImportInsertUpdateWidgetGlobalAttributeValue

GO

CREATE PROCEDURE [dbo].[Znode_ImportInsertUpdateWidgetGlobalAttributeValue]
(
    @GlobalEntityValueDetail  [GlobalEntityValueDetail] READONLY,
    @UserId            INT       ,
    @status            BIT    OUT,
    @IsNotReturnOutput BIT    = 0 
)
AS
     BEGIN
         BEGIN TRAN A;
         BEGIN TRY
			 DECLARE @GlobalEntityId INT,
			  @MultiSelectGroupAttributeTypeName nvarchar(200)='Select'
			 ,@MediaGroupAttributeTypeName nvarchar(200)='Media'
             DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
			 declare  @CMSContentWidgetId int
			 declare  @CMSWidgetProfileVariantId int
			 DECLARE @TBL_Widget TABLE (CMSWidgetProfileVariantId [int] NULL)
			 DECLARE @TBL_DeleteUser TABLE (CMSWidgetProfileVariantId [int] NULL,WidgetGlobalAttributeValueId int, LocaleId int)
			 DECLARE @TBL_AttributeDefaultValueList TABLE 
			   (NewWidgetGlobalAttributeValueId int,WidgetGlobalAttributeValueId int,[AttributeValue] [varchar](300),[GlobalAttributeDefaultValueId] int,
			   [GlobalAttributeId] int,MediaId int,WidgetGlobalAttributeValueLocaleId int,LocaleId int)


			 DECLARE @TBL_MediaValueList TABLE 
			   (NewWidgetGlobalAttributeValueId int,WidgetGlobalAttributeValueId int,GlobalAttributeId int,
			   MediaId int,MediaPath nvarchar(300),WidgetGlobalAttributeValueLocaleId int,LocaleId int)


		 	 DECLARE @TBL_GlobalEntityValueDetail TABLE ([GlobalAttributeId] [int] NULL,
				[AttributeCode] [varchar](300),[GlobalAttributeDefaultValueId] [int],[GlobalAttributeValueId] [int],
				[LocaleId] [int],CMSWidgetProfileVariantId [int], [AttributeValue] [nvarchar](max),WidgetGlobalAttributeValueId int,
				NewWidgetGlobalAttributeValueId int,GroupAttributeTypeName [varchar](300))
				
				SELECT TOP 1 @CMSWidgetProfileVariantId = GlobalEntityValueId FROM @GlobalEntityValueDetail;

				 Select @CMSContentWidgetId = CCW.CMSContentContainerId from ZnodeCMSContentContainer CCW
				 inner join ZnodeCMSContainerProfileVariant CWPV  on CCW.CMSContentContainerId = CWPV.CMSContentContainerId
				 Where CWPV.CMSContainerProfileVariantId = @CMSWidgetProfileVariantId

				Insert into @TBL_GlobalEntityValueDetail
				([GlobalAttributeId],[AttributeCode],[GlobalAttributeDefaultValueId],
				[GlobalAttributeValueId],[LocaleId],CMSWidgetProfileVariantId,[AttributeValue],GroupAttributeTypeName)
				Select dd.[GlobalAttributeId],dd.[AttributeCode],case when [GlobalAttributeDefaultValueId]=0 then null else 
				[GlobalAttributeDefaultValueId] end [GlobalAttributeDefaultValueId],
				case when [GlobalAttributeValueId]=0 then null else 
				[GlobalAttributeValueId] end [GlobalAttributeValueId],[LocaleId],[GlobalEntityValueId],[AttributeValue],ss.GroupAttributeType
				From @GlobalEntityValueDetail dd
				inner join [View_ZnodeGlobalAttribute] ss on ss.GlobalAttributeId=dd.GlobalAttributeId

				Update ss
				Set ss.WidgetGlobalAttributeValueId=dd.WidgetGlobalAttributeValueId
				From @TBL_GlobalEntityValueDetail ss
				inner join ZnodeWidgetGlobalAttributeValue dd on dd.CMSContainerProfileVariantId=ss.CMSWidgetProfileVariantId
				and dd.GlobalAttributeId=ss.GlobalAttributeId
				
				insert into @TBL_Widget(CMSWidgetProfileVariantId)
				Select distinct  CMSWidgetProfileVariantId from @TBL_GlobalEntityValueDetail;

                insert into @TBL_DeleteUser(CMSWidgetProfileVariantId ,WidgetGlobalAttributeValueId , LocaleId)
				Select p.CMSWidgetProfileVariantId,a.WidgetGlobalAttributeValueId, b.LocaleId
				from ZnodeWidgetGlobalAttributeValue a
				INNER JOIN ZnodeWidgetGlobalAttributeValueLocale B ON A.WidgetGlobalAttributeValueId = B.WidgetGlobalAttributeValueId
				inner join @TBL_Widget p on p.CMSWidgetProfileVariantId=a.CMSContainerProfileVariantId
				Where not exists(select 1 from @TBL_GlobalEntityValueDetail dd 
				where dd.CMSWidgetProfileVariantId=a.CMSContainerProfileVariantId and dd.GlobalAttributeId=a.GlobalAttributeId
				)
				             
				Delete From ZnodeWidgetGlobalAttributeValueLocale
				WHere exists (select 1 from @TBL_DeleteUser dd 
					Where dd.WidgetGlobalAttributeValueId=ZnodeWidgetGlobalAttributeValueLocale.WidgetGlobalAttributeValueId
					and ZnodeWidgetGlobalAttributeValueLocale.LocaleId = dd.LocaleId)
				and exists (select 1 from @TBL_GlobalEntityValueDetail dd 
					Where ZnodeWidgetGlobalAttributeValueLocale.LocaleId = dd.LocaleId)

				Delete From ZnodeWidgetGlobalAttributeValue
				WHere exists (select 1 from @TBL_DeleteUser dd 
				Where dd.WidgetGlobalAttributeValueId=ZnodeWidgetGlobalAttributeValue.WidgetGlobalAttributeValueId)
				and not exists(select * from ZnodeWidgetGlobalAttributeValueLocale where ZnodeWidgetGlobalAttributeValue.WidgetGlobalAttributeValueId = ZnodeWidgetGlobalAttributeValueLocale.WidgetGlobalAttributeValueId)
							

				INSERT INTO [dbo].[ZnodeWidgetGlobalAttributeValue]
				([CMSContentContainerId],[CMSContainerProfileVariantId],[GlobalAttributeId],[GlobalAttributeDefaultValueId],[CreatedBy],[CreatedDate],
				[ModifiedBy],[ModifiedDate])
				Select @CMSContentWidgetId,[CMSWidgetProfileVariantId],[GlobalAttributeId],[GlobalAttributeDefaultValueId]
				,@UserId [CreatedBy],@GetDate [CreatedDate],@UserId [ModifiedBy],@GetDate [ModifiedDate]
				From @TBL_GlobalEntityValueDetail dd
				WHERE WidgetGlobalAttributeValueId IS NULL		
				AND NOT EXISTS(SELECT * FROM ZnodeWidgetGlobalAttributeValue WGAV WHERE WGAV.CMSContentContainerId = @CMSContentWidgetId 
					AND WGAV.CMSContainerProfileVariantId = dd.CMSWidgetProfileVariantId AND WGAV.GlobalAttributeId = dd.GlobalAttributeId )

				Update dd
				Set dd.NewWidgetGlobalAttributeValueId=WGAV.WidgetGlobalAttributeValueId
				From @TBL_GlobalEntityValueDetail dd
				inner join [ZnodeWidgetGlobalAttributeValue] WGAV on WGAV.CMSContentContainerId = @CMSContentWidgetId 
					AND WGAV.CMSContainerProfileVariantId = dd.CMSWidgetProfileVariantId AND WGAV.GlobalAttributeId = dd.GlobalAttributeId

				INSERT INTO [dbo].[ZnodeWidgetGlobalAttributeValueLocale]
			   ([WidgetGlobalAttributeValueId],[LocaleId],[AttributeValue],[CreatedBy],[CreatedDate],[ModifiedBy]
			   ,[ModifiedDate])
				Select NewWidgetGlobalAttributeValueId,[LocaleId],[AttributeValue],@UserId [CreatedBy],@GetDate [CreatedDate],
				@UserId [ModifiedBy],@GetDate [ModifiedDate]
				From @TBL_GlobalEntityValueDetail dd
				WHERE NewWidgetGlobalAttributeValueId IS not NULL
				and isnull([AttributeValue],'') <>''    
				and isnull(GroupAttributeTypeName,'') != @MultiSelectGroupAttributeTypeName
				and isnull(GroupAttributeTypeName,'') != @MediaGroupAttributeTypeName	
				AND NOT EXISTS(SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WGAV WHERE WGAV.[WidgetGlobalAttributeValueId] = DD.NewWidgetGlobalAttributeValueId
					AND WGAV.[LocaleId] = DD.[LocaleId])
				
				Update ss
				Set ss.AttributeValue=dd.AttributeValue,ss.ModifiedDate=@GetDate,ss.ModifiedBy=@UserId
				From @TBL_GlobalEntityValueDetail dd
				inner join [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ss on ss.WidgetGlobalAttributeValueId =dd.WidgetGlobalAttributeValueId AND SS.[LocaleId] = DD.[LocaleId]
				Where isnull(GroupAttributeTypeName,'') != @MultiSelectGroupAttributeTypeName
				and isnull(GroupAttributeTypeName,'') != @MediaGroupAttributeTypeName	

				insert into @TBL_AttributeDefaultValueList
				(NewWidgetGlobalAttributeValueId,WidgetGlobalAttributeValueId,dd.AttributeValue,GlobalAttributeId,LocaleId)
				Select dd.NewWidgetGlobalAttributeValueId, dd.WidgetGlobalAttributeValueId,ss.Item,dd.GlobalAttributeId,dd.LocaleId
				From @TBL_GlobalEntityValueDetail dd
				cross apply dbo.Split(dd.AttributeValue,',') ss
				Where isnull(GroupAttributeTypeName,'') = @MultiSelectGroupAttributeTypeName

				Update dd
				Set dd.GlobalAttributeDefaultValueId=ss.GlobalAttributeDefaultValueId
				from  @TBL_AttributeDefaultValueList DD
				inner join [ZnodeGlobalAttributeDefaultValue] ss on dd.GlobalAttributeId=ss.GlobalAttributeId
				and dd.AttributeValue=ss.AttributeDefaultValueCode

				Update dd
				Set dd.WidgetGlobalAttributeValueLocaleId=ss.WidgetGlobalAttributeValueLocaleId
				from  @TBL_AttributeDefaultValueList DD
				inner join [ZnodeWidgetGlobalAttributeValueLocale] ss on dd.WidgetGlobalAttributeValueId=ss.WidgetGlobalAttributeValueId
				and ss.GlobalAttributeDefaultValueId=dd.GlobalAttributeDefaultValueId and dd.LocaleId = ss.LocaleId

				delete ss
				From @TBL_GlobalEntityValueDetail dd
				inner join [ZnodeWidgetGlobalAttributeValueLocale] ss on dd.WidgetGlobalAttributeValueId=ss.WidgetGlobalAttributeValueId
				Where isnull(GroupAttributeTypeName,'') = @MultiSelectGroupAttributeTypeName and dd.LocaleId = ss.LocaleId
				and not exists (Select 1 from @TBL_AttributeDefaultValueList cc 
				where cc.WidgetGlobalAttributeValueLocaleId=ss.WidgetGlobalAttributeValueLocaleId )
				and exists(select * from @TBL_GlobalEntityValueDetail dd1 where dd1.LocaleId = ss.LocaleId)

				INSERT INTO [dbo].[ZnodeWidgetGlobalAttributeValueLocale]
			   ([WidgetGlobalAttributeValueId],[LocaleId],GlobalAttributeDefaultValueId,[CreatedBy],[CreatedDate],[ModifiedBy]
			   ,[ModifiedDate])
				Select ss.NewWidgetGlobalAttributeValueId,dd.[LocaleId],ss.GlobalAttributeDefaultValueId,@UserId [CreatedBy],@GetDate [CreatedDate],
				@UserId [ModifiedBy],@GetDate [ModifiedDate]
				From @TBL_GlobalEntityValueDetail dd
				inner join @TBL_AttributeDefaultValueList ss on dd.GlobalAttributeId=ss.GlobalAttributeId
				and ss.NewWidgetGlobalAttributeValueId=dd.NewWidgetGlobalAttributeValueId
				WHERE isnull(dd.GroupAttributeTypeName,'') = @MultiSelectGroupAttributeTypeName
				AND NOT EXISTS(SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WGAV WHERE WGAV.[WidgetGlobalAttributeValueId] = ss.NewWidgetGlobalAttributeValueId
					AND WGAV.[LocaleId] = DD.[LocaleId])

				INSERT INTO [dbo].[ZnodeWidgetGlobalAttributeValueLocale]
			   ([WidgetGlobalAttributeValueId],[LocaleId],GlobalAttributeDefaultValueId,[CreatedBy],[CreatedDate],[ModifiedBy]
			   ,[ModifiedDate])
				Select ss.WidgetGlobalAttributeValueId,dd.[LocaleId],ss.GlobalAttributeDefaultValueId,@UserId [CreatedBy],@GetDate [CreatedDate],
				@UserId [ModifiedBy],@GetDate [ModifiedDate]
				From @TBL_GlobalEntityValueDetail dd
				inner join @TBL_AttributeDefaultValueList ss on dd.GlobalAttributeId=ss.GlobalAttributeId
				and ss.WidgetGlobalAttributeValueId=dd.WidgetGlobalAttributeValueId				
				WHERE isnull(dd.GroupAttributeTypeName,'') = @MultiSelectGroupAttributeTypeName
				and ss.WidgetGlobalAttributeValueLocaleId is null 
				AND NOT EXISTS(SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WGAV WHERE WGAV.[WidgetGlobalAttributeValueId] = ss.WidgetGlobalAttributeValueId
					AND WGAV.[LocaleId] = DD.[LocaleId])


				insert into @TBL_MediaValueList
				(NewWidgetGlobalAttributeValueId,WidgetGlobalAttributeValueId,GlobalAttributeId,MediaId,LocaleId)
				Select dd.NewWidgetGlobalAttributeValueId, dd.WidgetGlobalAttributeValueId,GlobalAttributeId,Case when ss.Item = 0 then null else ss.Item end,dd.LocaleId
				From @TBL_GlobalEntityValueDetail dd
				cross apply dbo.Split(dd.AttributeValue,',') ss
				Where isnull(GroupAttributeTypeName,'') = @MediaGroupAttributeTypeName

				Update dd
				Set dd.MediaPath=ss.Path
				from  @TBL_MediaValueList DD
				inner join ZnodeMedia ss on dd.MediaId=ss.MediaId

				Update dd
				Set dd.WidgetGlobalAttributeValueLocaleId=ss.WidgetGlobalAttributeValueLocaleId
				from  @TBL_MediaValueList DD
				inner join [ZnodeWidgetGlobalAttributeValueLocale] ss on dd.WidgetGlobalAttributeValueId=ss.WidgetGlobalAttributeValueId
				and ss.MediaId=dd.MediaId and dd.LocaleId = ss.LocaleId

				delete ss
				From @TBL_GlobalEntityValueDetail dd
				inner join [ZnodeWidgetGlobalAttributeValueLocale] ss on dd.WidgetGlobalAttributeValueId=ss.WidgetGlobalAttributeValueId and ss.GlobalAttributeDefaultValueId = dd.GlobalAttributeDefaultValueId
				Where isnull(GroupAttributeTypeName,'') = @MediaGroupAttributeTypeName
				and not exists (Select 1 from @TBL_MediaValueList cc 
					where cc.MediaId=ss.MediaId and dd.LocaleId = cc.LocaleId
					and cc.WidgetGlobalAttributeValueId=dd.WidgetGlobalAttributeValueId )
				and exists(select * from @TBL_GlobalEntityValueDetail dd1 where dd1.LocaleId = ss.LocaleId)

				INSERT INTO [dbo].[ZnodeWidgetGlobalAttributeValueLocale]
			   ([WidgetGlobalAttributeValueId],[LocaleId],MediaId,MediaPath,[CreatedBy],[CreatedDate],[ModifiedBy]
			   ,[ModifiedDate])
				Select ss.NewWidgetGlobalAttributeValueId,dd.[LocaleId],ss.MediaId,ss.MediaPath,@UserId [CreatedBy],@GetDate [CreatedDate],
				@UserId [ModifiedBy],@GetDate [ModifiedDate]
				From @TBL_GlobalEntityValueDetail dd
				inner join @TBL_MediaValueList ss on dd.GlobalAttributeId=ss.GlobalAttributeId
				and ss.NewWidgetGlobalAttributeValueId=dd.NewWidgetGlobalAttributeValueId
				WHERE isnull(dd.GroupAttributeTypeName,'') = @MediaGroupAttributeTypeName
				AND NOT EXISTS(SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WGAV WHERE WGAV.[WidgetGlobalAttributeValueId] = ss.NewWidgetGlobalAttributeValueId
					AND WGAV.[LocaleId] = DD.[LocaleId])

				INSERT INTO [dbo].[ZnodeWidgetGlobalAttributeValueLocale]
			   ([WidgetGlobalAttributeValueId],[LocaleId],MediaId,MediaPath,[CreatedBy],[CreatedDate],[ModifiedBy]
			   ,[ModifiedDate])
				Select ss.WidgetGlobalAttributeValueId,dd.[LocaleId],ss.MediaId,ss.MediaPath,@UserId [CreatedBy],@GetDate [CreatedDate],
				@UserId [ModifiedBy],@GetDate [ModifiedDate]
				From @TBL_GlobalEntityValueDetail dd
				inner join @TBL_MediaValueList ss on dd.GlobalAttributeId=ss.GlobalAttributeId
				and ss.WidgetGlobalAttributeValueId=dd.WidgetGlobalAttributeValueId				
				WHERE isnull(dd.GroupAttributeTypeName,'') = @MediaGroupAttributeTypeName
				and ss.WidgetGlobalAttributeValueLocaleId is null 
				AND NOT EXISTS(SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WGAV WHERE WGAV.[WidgetGlobalAttributeValueId] = ss.WidgetGlobalAttributeValueId
					AND WGAV.[LocaleId] = DD.[LocaleId])

				--Update dd 
				--Set dd.MediaPath=ss.MediaPath
				--from [ZnodeWidgetGlobalAttributeValueLocale] dd
    --            inner join @TBL_MediaValueList ss on 
				--ss.WidgetGlobalAttributeValueLocaleId =dd.WidgetGlobalAttributeValueLocaleId
				
				Update wgavl 
				Set wgavl.MediaPath=ss.MediaPath
				from [ZnodeWidgetGlobalAttributeValueLocale] wgavl
				inner join @TBL_GlobalEntityValueDetail dd on wgavl.WidgetGlobalAttributeValueId =dd.WidgetGlobalAttributeValueId AND wgavl.[LocaleId] = DD.[LocaleId]	 	 
                inner join @TBL_MediaValueList ss on dd.GlobalAttributeId=ss.GlobalAttributeId and ss.WidgetGlobalAttributeValueId=dd.WidgetGlobalAttributeValueId AND ss.[LocaleId] = DD.[LocaleId]						 
				WHERE isnull(dd.GroupAttributeTypeName,'') = @MediaGroupAttributeTypeName
		
		     SELECT 1 AS ID,CAST(1 AS BIT) AS Status;    
			   
             COMMIT TRAN A;
         END TRY
         BEGIN CATCH
             SELECT ERROR_MESSAGE()
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
			 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportInsertUpdateGlobalEntity @UserId = '+CAST(@UserId AS VARCHAR(50))+',@IsNotReturnOutput='+CAST(@IsNotReturnOutput AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
			ROLLBACK TRAN A;
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_ImportInsertUpdateWidgetGlobalAttributeValue',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateGlobalEntityAttributeValue')
	DROP PROC Znode_InsertUpdateGlobalEntityAttributeValue

GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateGlobalEntityAttributeValue]
(   
	@GlobalEntityValueXml NVARCHAR(max),
    @GlobalEntityValueId int,
	@EntityName varchar(200),
	@FamilyId  INT,
    @UserId     INT,
    @status     BIT OUT 
)
AS
/*
     Summary : To Insert / Update single Global Entity Value with multiple attribute values 
     Update Logic: 
*/
     BEGIN
         BEGIN TRAN A;
         BEGIN TRY

		     DECLARE @ConvertedXML XML = REPLACE(REPLACE(REPLACE(@GlobalEntityValueXml,' & ', '&amp;'),'"', '&quot;'),'''', '&apos;')
              DECLARE @GlobalEntityValueDetail_xml GlobalEntityValueDetail;

             INSERT INTO @GlobalEntityValueDetail_xml
			 (GlobalAttributeId,GlobalAttributeValueId,GlobalAttributeDefaultValueId,AttributeCode,AttributeValue
			 ,LocaleId,GlobalEntityValueId)
			SELECT Tbl.Col.value('GlobalAttributeId[1]', 'int') AS GlobalAttributeId,
			Tbl.Col.value('GlobalAttributeValueId[1]', 'int') AS GlobalAttributeValueId,
			Tbl.Col.value('GlobalAttributeDefaultValueId[1]', 'int') AS GlobalAttributeDefaultValueId,
			Tbl.Col.value('AttributeCode[1]', 'NVARCHAR(300)') AS AttributeCode,
			Tbl.Col.value('AttributeValue[1]', 'NVARCHAR(MAX)') AS AttributeValue,
			Tbl.Col.value('LocaleId[1]', 'INT') AS LocaleId,
			@GlobalEntityValueId AS GlobalEntityValueId
			FROM @ConvertedXML.nodes('//ArrayOfEntityAttributeDetailsModel/EntityAttributeDetailsModel') AS Tbl(Col);

			Declare @IsFamilyUnique BIT
			set @IsFamilyUnique = (select IsFamilyUnique from ZnodeGlobalEntity where EntityName = @EntityName)
			if(@IsFamilyUnique = 0)
			BEGIN
			   IF EXISTS(select top 1 1 from ZnodeGlobalEntityFamilyMapper where GlobalEntityId = (select GlobalEntityId from ZnodeGlobalEntity where EntityName = @EntityName)  and GlobalEntityValueId = @GlobalEntityValueId )
					update ZnodeGlobalEntityFamilyMapper set GlobalAttributeFamilyId= @FamilyId 
					where GlobalEntityValueId = @GlobalEntityValueId	and GlobalEntityId = (select GlobalEntityId from ZnodeGlobalEntity where EntityName = @EntityName)
			   ELSE
					insert into ZnodeGlobalEntityFamilyMapper values (@FamilyId,(select GlobalEntityId from ZnodeGlobalEntity where  EntityName = @EntityName),@GlobalEntityValueId)
			END

			If @EntityName='Store'
             EXEC [dbo].[Znode_ImportInsertUpdatePortalGlobalAttributeValue]
                  @GlobalEntityValueDetail_xml,
                  @UserId,
                  @status OUT,0 ; 
			else If @EntityName='User'
			EXEC [dbo].[Znode_ImportInsertUpdateUserGlobalAttributeValue]
                  @GlobalEntityValueDetail_xml,
                  @UserId,
                  @status OUT,0 ; 
			else If @EntityName='Account'
			EXEC [dbo].Znode_ImportInsertUpdateAccountGlobalAttributeValue
                  @GlobalEntityValueDetail_xml,
                  @UserId,
                  @status OUT,0 ; 
		    else if @EntityName = 'Content Containers'
			EXEC [dbo].Znode_ImportInsertUpdateWidgetGlobalAttributeValue
                  @GlobalEntityValueDetail_xml,
                  @UserId,
                  @status OUT,0 ; 
			else If @EntityName='FormBuilder'
			EXEC [dbo].Znode_ImportInsertUpdateFormBuilderGlobalAttributeValue
                  @GlobalEntityValueDetail_xml,
                  @UserId,
                  @status OUT,0 ; 
			
             SET @status = 1;
             COMMIT TRAN A;
         END TRY
         BEGIN CATCH
             SELECT ERROR_MESSAGE()
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			 @ErrorCall NVARCHAR(MAX)= 'EXEC [Znode_InsertUpdateGlobalEntityAttributeValue] @GlobalEntityValueXml= '+CAST(@GlobalEntityValueXml AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
			 ROLLBACK TRAN A;
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_InsertUpdateGlobalEntityAttributeValue',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateGlobalEntityMapper')
	DROP PROC Znode_InsertUpdateGlobalEntityMapper

GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateGlobalEntityMapper]  
(  
	@EntiryMapper XML,  
	@UserId INT,  
	@Action nvarchar(50),  
	@Status INT = 0 OUT    
)  
AS  
BEGIN  
 BEGIN TRY    
 BEGIN TRAN SaveOrUpdateEntityMapper;   
	DECLARE @GetDate DATETIME = dbo.Fn_GetDate()
	DECLARE @GlobalEntityId INT;

	IF OBJECT_ID('tempdb..#EntityMapper') IS NOT NULL     
	DROP TABLE #EntityMapper  
    
	--Getting xml data into table    
	SELECT     
	Tbl.Col.value ('GlobalAttributeId[1]' , 'INT') AS AttributeFamilyId,   
	Tbl.Col.value ('GlobalAttributeGroupId[1]' , 'INT') AS AttributeGroupId,    
	Tbl.Col.value ('AttributeDisplayOrder[1]' , 'INT') AS GroupDisplayOrder  
	INTO #EntityMapper    
	FROM @EntiryMapper.nodes ( '//ArrayOfGlobalAttributeGroupMapperModel/GlobalAttributeGroupMapperModel'  ) AS Tbl(Col)   

	SELECT @GlobalEntityId=GlobalEntityId
	FROM ZnodeGlobalAttributeFamily
	WHERE GlobalAttributeFamilyId=(SELECT DISTINCT AttributeFamilyId FROM #EntityMapper);
  
	IF @action='Insert'  
	BEGIN  
		INSERT INTO ZnodeGlobalFamilyGroupMapper(GlobalAttributeFamilyId,GlobalAttributeGroupId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)  
		SELECT AttributeFamilyId,AttributeGroupId,GroupDisplayOrder,@UserId,@GetDate,@UserId,@GetDate 
		FROM #EntityMapper hmapper
		LEFT JOIN ZnodeGlobalFamilyGroupMapper tmapper ON hmapper.AttributeFamilyId=tmapper.GlobalAttributeFamilyId AND hmapper.AttributeGroupId=tmapper.GlobalAttributeGroupId
		WHERE tmapper.GlobalAttributeFamilyId is null and tmapper.GlobalAttributeGroupId is null;
  
		INSERT INTO ZnodeGlobalGroupEntityMapper(GlobalEntityId,GlobalAttributeGroupId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)  
		SELECT @GlobalEntityId,AttributeGroupId,GroupDisplayOrder,@UserId,@GetDate,@UserId,@GetDate  
		FROM #EntityMapper;
		SET @Status = 1  
		SELECT 1 AS ID,CAST(@Status AS BIT) AS Status;     
	END  
	IF @action='Update'  
	BEGIN   
		UPDATE ZnodeGlobalFamilyGroupMapper SET AttributeGroupDisplayOrder=hmapper.GroupDisplayOrder,ModifiedBy=@UserId,ModifiedDate=GETDATE()  
		FROM ZnodeGlobalFamilyGroupMapper tmapper  
		INNER JOIN #EntityMapper hmapper on tmapper.GlobalAttributeFamilyId=hmapper.AttributeFamilyId AND tmapper.GlobalAttributeGroupId=hmapper.AttributeGroupId  
		--WHERE tmapper.GlobalAttributeFamilyId=hmapper.AttributeFamilyId AND tmapper.GlobalAttributeGroupId=hmapper.AttributeGroupId  
  
		UPDATE ZnodeGlobalGroupEntityMapper SET AttributeGroupDisplayOrder=hmapper.GroupDisplayOrder,ModifiedBy=@UserId,ModifiedDate=GETDATE()  FROM ZnodeGlobalGroupEntityMapper tmapper  
		INNER JOIN #EntityMapper hmapper on tmapper.GlobalEntityId=hmapper.AttributeFamilyId AND tmapper.GlobalAttributeGroupId=hmapper.AttributeGroupId  
		--WHERE tmapper.GlobalEntityId=hmapper.AttributeFamilyId AND tmapper.GlobalAttributeGroupId=hmapper.AttributeGroupId  
		SET @Status = 1  
		SELECT 1 AS ID,CAST(@Status AS BIT) AS Status;     
	END  
COMMIT TRAN SaveOrUpdateEntityMapper;  
END TRY    
BEGIN CATCH                      
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),    
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_SaveOrUpdateEntityMapper @entiryMapper = '+ cast(@entiryMapper as varchar(2000));    
	SET @Status = 0                  
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                        
	ROLLBACK TRAN SaveOrUpdateEntityMapper;       
	EXEC Znode_InsertProcedureErrorLog    
	@ProcedureName = 'Znode_SaveOrUpdateEntityMapper',    
	@ErrorInProcedure = @Error_procedure,    
	@ErrorMessage = @ErrorMessage,    
	@ErrorLine = @ErrorLine,    
	@ErrorCall = @ErrorCall;    
END CATCH;    
  
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_SaveVariantsData')
	DROP PROC Znode_SaveVariantsData

GO

CREATE PROCEDURE [dbo].[Znode_SaveVariantsData]
(
	@LocaleId INT,
	@CMSContainerTemplateId INT,
	@CMSContainerProfileVariantId INT,
	@UserId INT=0,
	@IsActive BIT,
	@status BIT OUT
)
AS
--EXEC Znode_SaveVariantsData 0,0,0,0,0,0
BEGIN
	BEGIN TRY
	BEGIN TRAN SaveVariantsData
		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
		DECLARE @PublishStateId INT =(SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE StateName='Draft');

		IF EXISTS (SELECT TOP 1 1 FROM ZnodeCMSContainerProfileVariantLocale WHERE CMSContainerProfileVariantId=@CMSContainerProfileVariantId)
		BEGIN
			IF EXISTS (SELECT TOP 1 1 FROM ZnodeCMSContainerProfileVariantLocale
						WHERE CMSContainerProfileVariantId=@CMSContainerProfileVariantId AND LocaleId=@LocaleId)
			BEGIN
				UPDATE ZnodeCMSContainerProfileVariantLocale
				SET CMSContainerTemplateId=@CMSContainerTemplateId, IsActive=@IsActive
				WHERE CMSContainerProfileVariantId=@CMSContainerProfileVariantId AND LocaleId=@LocaleId
					AND CMSContainerTemplateId<>@CMSContainerTemplateId;

				UPDATE ZnodeCMSContainerProfileVariant
				SET PublishStateId = @PublishStateId,ModifiedBy=@UserId, ModifiedDate=@GetDate
				WHERE CMSContainerProfileVariantId=@CMSContainerProfileVariantId;

				UPDATE ZnodeCMSContentContainer
				SET PublishStateId=@PublishStateId,ModifiedBy=@UserId, ModifiedDate=@GetDate
				WHERE CMSContentContainerId=(SELECT CMSContentContainerId FROM ZnodeCMSContainerProfileVariant
											WHERE CMSContainerProfileVariantId=@CMSContainerProfileVariantId);
			END
			ELSE
			BEGIN
			select 1
				INSERT INTO ZnodeCMSContainerProfileVariantLocale
					(CMSContainerProfileVariantId,CMSContainerTemplateId,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsActive)
				SELECT @CMSContainerProfileVariantId,@CMSContainerTemplateId,@LocaleId,@UserId,@GetDate,@UserId,@GetDate,@IsActive;

				UPDATE ZnodeCMSContainerProfileVariant
				SET PublishStateId = @PublishStateId,ModifiedBy=@UserId, ModifiedDate=@GetDate
				WHERE CMSContainerProfileVariantId=@CMSContainerProfileVariantId;

				UPDATE ZnodeCMSContentContainer
				SET PublishStateId=@PublishStateId,ModifiedBy=@UserId, ModifiedDate=@GetDate
				WHERE CMSContentContainerId=(SELECT CMSContentContainerId FROM ZnodeCMSContainerProfileVariant
											WHERE CMSContainerProfileVariantId=@CMSContainerProfileVariantId);
			END
		END
		ELSE
		BEGIN
			INSERT INTO ZnodeCMSContainerProfileVariantLocale
					(CMSContainerProfileVariantId,CMSContainerTemplateId,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsActive)
			SELECT @CMSContainerProfileVariantId,@CMSContainerTemplateId,@LocaleId,@UserId,@GetDate,@UserId,@GetDate,@IsActive;

			UPDATE ZnodeCMSContainerProfileVariant
				SET PublishStateId = @PublishStateId,ModifiedBy=@UserId, ModifiedDate=@GetDate
				WHERE CMSContainerProfileVariantId=@CMSContainerProfileVariantId;

			UPDATE ZnodeCMSContentContainer
			SET PublishStateId=@PublishStateId,ModifiedBy=@UserId, ModifiedDate=@GetDate
			WHERE CMSContentContainerId=(SELECT CMSContentContainerId FROM ZnodeCMSContainerProfileVariant
										WHERE CMSContainerProfileVariantId=@CMSContainerProfileVariantId);
		END

		SET @Status = 1;
		SELECT 1 AS ID, CAST(1 AS BIT) AS [Status];

	COMMIT TRAN SaveVariantsData;
	END TRY

	BEGIN CATCH
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
			@ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_SaveVariantsData 
			@LocaleId = '+CAST(@LocaleId AS VARCHAR(50))+',
			@CMSContainerTemplateId='+CAST(@CMSContainerTemplateId AS VARCHAR(50))+',
			@CMSContainerProfileVariantId='+CAST(@CMSContainerProfileVariantId AS VARCHAR(50))+',
			@UserId='+CAST(@UserId AS VARCHAR(50))+',
			@Status='+CAST(@Status AS VARCHAR(50));

		SET @Status =0
		SELECT 1 AS ID,@Status AS Status;
		ROLLBACK TRAN SaveVariantsData;
		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_SaveVariantsData',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;

	END CATCH
END

GO

Update ZnodeApplicationSetting
SET Setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>RmaReturnDetailsId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>Boolean</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>OrderNumber</name><headertext>Order No.</headertext><width>15</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>OrderNumber</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield>OmsOrderId</controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>ReturnNumber</name><headertext>Return No.</headertext><width>15</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl>/RMAReturn/ManageReturn</islinkactionurl><islinkparamfield>ReturnNumber</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield>OmsOrderId</controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>UserName</name><headertext>Customer Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>UserId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>EmailId</name><headertext>Email ID</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>UserId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Email Id</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>StoreName</name><headertext>Store Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>UserId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>ReturnStatus</name><headertext>Return Status</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>ReturnDateWithTime</name><headertext>Return Date</headertext><width>0</width><datatype>DateTime</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>9</id><name>TotalExpectedReturnQuantity</name><headertext>Total Expected Qty</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>10</id><name>ReturnTotalWithCurrency</name><headertext>Return Total</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>11</id><name>TotalReturnAmount</name><headertext>Return Total</headertext><width>30</width><datatype>Decimal</datatype><columntype>Decimal</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>12</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>View</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>View</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/RMAReturn/ManageReturn</manageactionurl><manageparamfield>ReturnNumber</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName='ZnodeReturn'

update ZnodeApplicationSetting set Setting ='<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>ContentWidgetId</name>      <headertext>Checkbox</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>WidgetKey</name>      <headertext>Widget Key</headertext>      <width>60</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>Tags</name>      <headertext>Widget Tag</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>Edit|Delete</format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Edit|Delete</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/ContentWidget/Edit|/ContentWidget/Delete</manageactionurl>      <manageparamfield>widgetKey|ContentWidgetId</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
 where ItemName = 'ZnodeCMSContentWidget'

 insert into ZnodeApplicationSetting (GroupName,	ItemName,	Setting,	ViewOptions,	FrontPageName,	FrontObjectName,	IsCompressed,	OrderByFields,	ItemNameWithoutCurrency,	CreatedByName,	ModifiedByName,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
select 'Table','ZnodeCMSAssociatedVariant',
'<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>WidgetProfileVariantId</name>      <headertext>Checkbox</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>WidgetProfileVariantId</name>      <headertext>Widget Profile Variant Id</headertext>      <width>0</width>      <datatype>Int32</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>y</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>StoreName</name>      <headertext>Store Name</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>ProfileName</name>      <headertext>Profile Name</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>CreatedByName</name>      <headertext>Created By</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>CreatedDate</name>      <headertext>Created Date</headertext>      <width>0</width>      <datatype>DateTime</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>ModifiedByName</name>      <headertext>Modified By</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>ModifiedDate</name>      <headertext>Modified Date</headertext>      <width>0</width>      <datatype>DateTime</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>9</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>Edit|Delete</format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>Id</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Edit|Delete</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/ContentWidget/EditVarinat|/ContentWidget/DeleteAssociatedVariant</manageactionurl>      <manageparamfield>WidgetProfileVariantId|WidgetProfileVariantId,WidgetKey</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>10</id>      <name>IsDefaultVarient</name>      <headertext>      </headertext>      <width>0</width>      <datatype>Boolean</datatype>      <columntype>Boolean</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>IsDefaultVarient</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>IsDefaultVarinat</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>',
'ZnodeCMSAssociatedVariant','ZnodeCMSAssociatedVariant','ZnodeCMSAssociatedVariant',0,null,null,null,null,2,getdate(),2,getdate()
where not exists(select * from ZnodeApplicationSetting where GroupName = 'Table' and ItemName = 'ZnodeCMSAssociatedVariant')

update ZnodeApplicationSetting set Setting ='<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>ContentWidgetId</name>      <headertext>Checkbox</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>ContainerKey</name>      <headertext>Container Key</headertext>      <width>60</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>Tags</name>      <headertext>Tags</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>Edit|Delete</format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Edit|Delete</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/ContentWidget/Edit|/ContentWidget/Delete</manageactionurl>      <manageparamfield>containerKey|ContentWidgetId</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
where ItemName = 'ZnodeCMSContentWidget'

update ZnodeApplicationSetting set Setting = '<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>WidgetTemplateId</name>      <headertext>Checkbox</headertext>      <width>30</width>      <datatype>Int32</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>Image</name>      <headertext>Image</headertext>      <width>20</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>MediaPath,Name</imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>imageicon</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>Code</name>      <headertext>Template Code</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>Name</name>      <headertext>Template Name</headertext>      <width>60</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>y</isallowlink>      <islinkactionurl>/WidgetTemplate/Edit</islinkactionurl>      <islinkparamfield>Code</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>FileName</name>      <headertext>File Name</headertext>      <width>60</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>CreatedByName</name>      <headertext>Created By</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>CreatedDate</name>      <headertext>Created Date</headertext>      <width>0</width>      <datatype>DateTime</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>yyyy-MM-dd HH:mm:ss</format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>ModifiedByName</name>      <headertext>Modified By</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>9</id>      <name>ModifiedDate</name>      <headertext>Modified Date</headertext>      <width>0</width>      <datatype>DateTime</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>yyyy-MM-dd HH:mm:ss</format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>10</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>Edit|Download|Copy|Delete</format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Edit|Download|Copy|Delete</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/WidgetTemplate/Edit|/WidgetTemplate/DownloadWidgetTemplate|/WidgetTemplate/Copy|/WidgetTemplate/Delete</manageactionurl>      <manageparamfield>Code|widgetTemplateId,FileName|Code|widgetTemplateId,FileName</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
where ItemName = 'ZnodeCMSWidgetTemplate'

update ZnodeApplicationSetting set Setting = '<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>ContentWidgetId</name>      <headertext>Checkbox</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>ContainerKey</name>      <headertext>Container Key</headertext>      <width>60</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>Tags</name>      <headertext>Tags</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>CreatedByName</name>      <headertext>Created By</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>CreatedDate</name>      <headertext>Created Date</headertext>      <width>0</width>      <datatype>DateTime</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>yyyy-MM-dd HH:mm:ss</format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>ModifiedByName</name>      <headertext>Modified By</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>ModifiedDate</name>      <headertext>Modified Date</headertext>      <width>0</width>      <datatype>DateTime</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>yyyy-MM-dd HH:mm:ss</format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>Edit|Delete</format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Edit|Delete</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/ContentWidget/Edit|/ContentWidget/Delete</manageactionurl>      <manageparamfield>containerKey|ContentWidgetId</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
where ItemName = 'ZnodeCMSContentWidget'

update ZnodeApplicationSetting set Setting = '<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>WidgetProfileVariantId</name>      <headertext>Checkbox</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>WidgetProfileVariantId</name>      <headertext>Widget Profile Variant Id</headertext>      <width>0</width>      <datatype>Int32</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>y</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>StoreName</name>      <headertext>Store Name</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>ProfileName</name>      <headertext>Profile Name</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>CreatedByName</name>      <headertext>Created By</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>CreatedDate</name>      <headertext>Created Date</headertext>      <width>0</width>      <datatype>DateTime</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>ModifiedByName</name>      <headertext>Modified By</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>ModifiedDate</name>      <headertext>Modified Date</headertext>      <width>0</width>      <datatype>DateTime</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>9</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>Edit|Delete</format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>Id</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Edit|Delete</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/ContentWidget/EditAssociatedVariant|/ContentWidget/DeleteAssociatedVariant</manageactionurl>      <manageparamfield>WidgetProfileVariantId|WidgetProfileVariantId,ContainerKey</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>10</id>      <name>IsDefaultVarient</name>      <headertext>      </headertext>      <width>0</width>      <datatype>Boolean</datatype>      <columntype>Boolean</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>IsDefaultVarient</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>IsDefaultVarinat</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
where ItemName = 'ZnodeCMSAssociatedVariant'

Update ZnodeApplicationSetting
Set Setting ='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>WidgetProfileVariantId</name><headertext>Widget Profile Variant Id</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>WidgetProfileVariantId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>StoreName</name><headertext>Store Name</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>ProfileName</name><headertext>User Profile</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>CreatedByName</name><headertext>Created By</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>CreatedDate</name><headertext>Created Date</headertext><width>0</width><datatype>DateTime</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>ModifiedByName</name><headertext>Modified By</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>ModifiedDate</name><headertext>Modified Date</headertext><width>0</width><datatype>DateTime</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>9</id><name>Manage</name><headertext>Action</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>Edit|Delete</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>Id</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/ContentContainer/EditAssociatedVariant|/ContentContainer/DeleteAssociatedVariant</manageactionurl><manageparamfield>ContainerProfileVariantId|ContainerProfileVariantId,ContainerKey</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName ='ZnodeCMSAssociatedVariant'

Update ZnodeApplicationSetting
Set Setting = '<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>ContainerProfileVariantId</name>      <headertext>Checkbox</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>ContainerProfileVariantId</name>      <headertext>Container Profile Variant Id</headertext>      <width>0</width>      <datatype>Int32</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>y</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>StoreName</name>      <headertext>Store Name</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>StoreCode</name>      <headertext>Store Code</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>ProfileName</name>      <headertext>Profile Name</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>ProfileCode</name>      <headertext>Profile Code</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>CreatedByName</name>      <headertext>Created By</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>CreatedDate</name>      <headertext>Created Date</headertext>      <width>0</width>      <datatype>DateTime</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>9</id>      <name>ModifiedByName</name>      <headertext>Modified By</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>10</id>      <name>ModifiedDate</name>      <headertext>Modified Date</headertext>      <width>0</width>      <datatype>DateTime</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>11</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>Edit|Delete</format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>Id</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Edit|Delete</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/ContentContainer/EditAssociatedVariant|/ContentContainer/DeleteAssociatedVariant</manageactionurl>      <manageparamfield>ContainerProfileVariantId|ContainerProfileVariantId,ContainerKey</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
where ItemName = 'ZnodeCMSAssociatedVariant'

Update ZnodeApplicationSetting
set Setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>ContentWidgetId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>ContainerKey</name><headertext>Container Key</headertext><width>60</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>Tags</name><headertext>Tags</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>CreatedByName</name><headertext>Created By</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>CreatedDate</name><headertext>Created Date</headertext><width>0</width><datatype>DateTime</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format>yyyy-MM-dd HH:mm:ss</format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>ModifiedByName</name><headertext>Modified By</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>ModifiedDate</name><headertext>Modified Date</headertext><width>0</width><datatype>DateTime</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format>yyyy-MM-dd HH:mm:ss</format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>PublishStatus</name><headertext>Publish Status</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>9</id><name>Manage</name><headertext>Action</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>Edit|Delete</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/ContentContainer/Edit|/ContentContainer/Delete</manageactionurl><manageparamfield>containerKey|contentContainerId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>    '
where ItemName = 'ZnodeCMSContentContainer'

update ZnodeApplicationSetting
set Setting = '<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>ContainerProfileVariantId</name>      <headertext>Checkbox</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>ContainerProfileVariantId</name>      <headertext>Container Profile Variant Id</headertext>      <width>0</width>      <datatype>Int32</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>y</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>StoreName</name>      <headertext>Store Name</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>StoreCode</name>      <headertext>Store Code</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>ProfileName</name>      <headertext>User Profile</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>ProfileCode</name>      <headertext>User Profile Code</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>IsActive</name>      <headertext>Is Active</headertext>      <width>0</width>      <datatype>Boolean</datatype>      <columntype>Boolean</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>PublishStatus</name>      <headertext>Publish Status</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>9</id>      <name>CreatedByName</name>      <headertext>Created By</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>10</id>      <name>CreatedDate</name>      <headertext>Created Date</headertext>      <width>0</width>      <datatype>DateTime</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>11</id>      <name>ModifiedByName</name>      <headertext>Modified By</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>12</id>      <name>ModifiedDate</name>      <headertext>Modified Date</headertext>      <width>0</width>      <datatype>DateTime</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>13</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>Edit|Delete|Disable|Publish</format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>Id</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Edit|Delete|Deactivate|Publish</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/ContentContainer/EditAssociatedVariant|/ContentContainer/DeleteAssociatedVariant|/ContentContainer/ActivateDeactivateVariant|/ContentContainer/PublishContainerVariant</manageactionurl>      <manageparamfield>ContainerProfileVariantId|ContainerProfileVariantId,ContainerKey|ContainerProfileVariantId,IsActive|ContainerKey,ContainerProfileVariantId</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
where ItemName = 'ZnodeCMSAssociatedVariant'

insert into ZnodeApplicationSetting (GroupName,	ItemName,	Setting,	ViewOptions,	FrontPageName,	FrontObjectName,	IsCompressed,	OrderByFields,	ItemNameWithoutCurrency,	CreatedByName,	ModifiedByName,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
select 'Table','ZnodeCMSContentContainer','<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>ContentContainerId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>ContainerKey</name><headertext>Container Key</headertext><width>60</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>Tags</name><headertext>Tags</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>CreatedByName</name><headertext>Created By</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>CreatedDate</name><headertext>Created Date</headertext><width>0</width><datatype>DateTime</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format>yyyy-MM-dd HH:mm:ss</format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>ModifiedByName</name><headertext>Modified By</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>ModifiedDate</name><headertext>Modified Date</headertext><width>0</width><datatype>DateTime</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format>yyyy-MM-dd HH:mm:ss</format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>PublishStatus</name><headertext>Publish Status</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>9</id><name>Manage</name><headertext>Action</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>Edit|Delete|Publish</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Delete|Publish</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/ContentContainer/Edit|/ContentContainer/Delete|/ContentContainer/PublishContentContainer</manageactionurl><manageparamfield>containerKey|contentContainerId|ContainerKey,TargetPublishState</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>',
'ZnodeCMSContentWidget','ZnodeCMSContentWidget','ZnodeCMSContentWidget',0,null,null,null,null,2,GETDATE(),2,getdate()
where not exists(select * from ZnodeApplicationSetting where GroupName = 'Table' and ItemName = 'ZnodeCMSContentContainer')

update ZnodeApplicationSetting
set Setting = '<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>ContentWidgetId</name>      <headertext>Checkbox</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>ContainerKey</name>      <headertext>Container Key</headertext>      <width>60</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>Tags</name>      <headertext>Tags</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>CreatedByName</name>      <headertext>Created By</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>CreatedDate</name>      <headertext>Created Date</headertext>      <width>0</width>      <datatype>DateTime</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>yyyy-MM-dd HH:mm:ss</format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>ModifiedByName</name>      <headertext>Modified By</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>ModifiedDate</name>      <headertext>Modified Date</headertext>      <width>0</width>      <datatype>DateTime</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>yyyy-MM-dd HH:mm:ss</format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>PublishStatus</name>      <headertext>Publish Status</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>9</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>Edit|Delete|Publish</format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Edit|Delete|Publish</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/ContentContainer/Edit|/ContentContainer/Delete|/ContentContainer/PublishContentContainer</manageactionurl>      <manageparamfield>containerKey|contentContainerId|ContainerKey,TargetPublishState</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
where ItemName = 'ZnodeCMSContentContainer'

update ZnodeApplicationSetting
set Setting = '<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>ContainerTemplateId</name>      <headertext>Checkbox</headertext>      <width>30</width>      <datatype>Int32</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>Image</name>      <headertext>Image</headertext>      <width>20</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>MediaPath,Name</imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>imageicon</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>Code</name>      <headertext>Template Code</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>Name</name>      <headertext>Template Name</headertext>      <width>60</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>y</isallowlink>      <islinkactionurl>/ContainerTemplate/Edit</islinkactionurl>      <islinkparamfield>Code</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>FileName</name>      <headertext>File Name</headertext>      <width>60</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>CreatedByName</name>      <headertext>Created By</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>CreatedDate</name>      <headertext>Created Date</headertext>      <width>0</width>      <datatype>DateTime</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>yyyy-MM-dd HH:mm:ss</format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>ModifiedByName</name>      <headertext>Modified By</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>9</id>      <name>ModifiedDate</name>      <headertext>Modified Date</headertext>      <width>0</width>      <datatype>DateTime</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>yyyy-MM-dd HH:mm:ss</format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>10</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>Edit|Download|Copy|Delete</format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Edit|Download|Copy|Delete</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/ContainerTemplate/Edit|/ContainerTemplate/DownloadWidgetTemplate|/ContainerTemplate/Copy|/ContainerTemplate/Delete</manageactionurl>      <manageparamfield>Code|ContainerTemplateId,FileName|Code|ContainerTemplateId,FileName</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
where ItemName = 'ZnodeCMSWidgetTemplate'

Update ZnodeApplicationSetting
set Setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>ContainerProfileVariantId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>ContainerProfileVariantId</name><headertext>Container Profile Variant Id</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>StoreName</name><headertext>Store Name</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>StoreCode</name><headertext>Store Code</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>ProfileName</name><headertext>User Profile</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>ProfileCode</name><headertext>User Profile Code</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>Status</name><headertext>Is Active</headertext><width>0</width><datatype>Boolean</datatype><columntype>Boolean</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>PublishStatus</name><headertext>Publish Status</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>9</id><name>CreatedByName</name><headertext>Created By</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>10</id><name>CreatedDate</name><headertext>Created Date</headertext><width>0</width><datatype>DateTime</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>11</id><name>ModifiedByName</name><headertext>Modified By</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>12</id><name>ModifiedDate</name><headertext>Modified Date</headertext><width>0</width><datatype>DateTime</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>13</id><name>Manage</name><headertext>Action</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>Edit|Delete|Disable|Publish</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>Id</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Delete|Deactivate|Publish</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/ContentContainer/EditAssociatedVariant|/ContentContainer/DeleteAssociatedVariant|/ContentContainer/ActivateDeactivateVariant|/ContentContainer/PublishContainerVariant</manageactionurl><manageparamfield>ContainerProfileVariantId|ContainerProfileVariantId,ContainerKey|ContainerProfileVariantId,IsActive|ContainerKey,ContainerProfileVariantId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName = 'ZnodeCMSAssociatedVariant'


insert into ZnodeApplicationSetting(GroupName,ItemName,Setting,ViewOptions,FrontPageName,FrontObjectName,IsCompressed,OrderByFields,ItemNameWithoutCurrency,CreatedByName,ModifiedByName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 'Table', 'WebStoreCustomerQuoteApprovalHistory','<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>OrderType</name>      <headertext>Order Type</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>OmsQuoteId</name>      <headertext>Order Number</headertext>      <width>0</width>      <datatype>Int32</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>y</isallowlink>      <islinkactionurl>/User/QuoteApprovalView</islinkactionurl>      <islinkparamfield>omsQuoteId,orderStatus</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>linkQuoteId</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>UserName</name>      <headertext>Customer Name</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>AccountName</name>      <headertext>Account Name</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>OrderStatus</name>      <headertext>Order Status</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>QuoteOrderTotal</name>      <headertext>Order Amount</headertext>      <width>0</width>      <datatype>Decimal</datatype>      <columntype>Decimal</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>CreatedDate</name>      <headertext>Created Date</headertext>      <width>0</width>      <datatype>Date</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>View</format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>View</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/User/QuoteApprovalView</manageactionurl>      <manageparamfield>omsQuoteId,orderStatus</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>9</id>      <name>AccountId</name>      <headertext>Account Id</headertext>      <width>0</width>      <datatype>Int32</datatype>      <columntype>Int32</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>',
'WebStoreCustomerQuoteApprovalHistory','WebStoreCustomerQuoteApprovalHistory','WebStoreCustomerQuoteApprovalHistory',0,null,null,null,null,2,getdate(),2,getdate()
where not exists(select * from ZnodeApplicationSetting where ItemName = 'WebStoreCustomerQuoteApprovalHistory')

update ZnodeApplicationSetting
set Setting='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>UserAddressId</name><headertext>Checkbox</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>UserAddressId</name><headertext>User Address Id</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>AddressId</name><headertext>Checkbox</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>IsDefaultBilling</name><headertext>Is Default Billing</headertext><width>0</width><datatype>Boolean</datatype><columntype>Boolean</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>IsDefaultShipping</name><headertext>Is Default Shipping</headertext><width>0</width><datatype>Boolean</datatype><columntype>Boolean</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>DisplayAddress</name><headertext>Address</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>AccountId</name><headertext>AccountId</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>
'where ItemName='ZnodeGuestUserAddress'


update ZnodeApplicationSetting
set Setting='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>OrderId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>OrderNumber</name><headertext>Order Number</headertext><width>15</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl>/Order/Manage</islinkactionurl><islinkparamfield>OmsOrderId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield>OmsOrderId</controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>CustomerName</name><headertext>Customer Name</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>UserName</name><headertext>User Name</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>TransactionDate</name><headertext>Created Date</headertext><width>30</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>Notes</name><headertext>Notes</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>TransactionAmount</name><headertext>Amount Used</headertext><width>30</width><datatype>Decimal</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>View</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>View</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/Order/Manage</manageactionurl><manageparamfield>OmsOrderId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'where ItemName='ZnodeVoucherHistory'

update ZnodeApplicationSetting
set Setting='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>PublishProductId</name><headertext>PublishProductId</headertext><width>5</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield>PublishProductId,Quantity,SKU</checkboxparamfield><iscontrol>n</iscontrol><controltype>HiddenField</controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>Image</name><headertext>Image</headertext><width>40</width><datatype>String</datatype><columntype>Single</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield>ImageSmallThumbnailPath,ProductName</imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class>imageicon</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>SKU</name><headertext>SKU</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl>JavaScript:void(0);</islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>sku</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>Name</name><headertext>Product Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>productname</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>SalesPriceWithCurrency</name><headertext>Sales Price</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>RetailPriceWithCurrency</name><headertext>Retail Price</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>Edit</format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/SEO/SEODetails</manageactionurl><manageparamfield>ItemName,ItemId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName='ZnodeOrderProductList'

Update ZnodeApplicationSetting
Set Setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>ShippingId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>ShippingTypeName</name><headertext>Shipping Type</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>ShippingCode</name><headertext>Shipping Code</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>ShippingName</name><headertext>Shipping Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>Description</name><headertext>Display Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>DisplayOrder</name><headertext>Display Order</headertext><width>30</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>3</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>y</iscontrol><controltype>Text</controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>DestinationCountryCode</name><headertext>Country Code</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>HandlingCharge</name><headertext>Handling Charge</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>IsActive</name><headertext>Enable</headertext><width>40</width><datatype>Boolean</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>9</id><name>ZipCode</name><headertext>Zip Code</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>10</id><name>PublishState</name><headertext>Application Type</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>y</iscontrol><controltype>DropDown</controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>11</id><name>Manage</name><headertext>Action</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>Edit|Delete</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>PortalId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/Profiles/UpdateProfileShipping|/Profiles/UnAssociateAssociatedShipping</manageactionurl><manageparamfield>shippingId,profileId|shippingId,profileId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>12</id><name>ProfileName</name><headertext>Profile Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>13</id><name>ShippingId</name><headertext>ShippingId</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName = 'ZnodeAssociatedShippingListToProfile'


Update ZnodeApplicationSetting
Set Setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>ShippingId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>ShippingTypeName</name><headertext>Shipping Type</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>ShippingCode</name><headertext>Shipping Code</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>ShippingName</name><headertext>Shipping Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>Description</name><headertext>Display Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>DisplayOrder</name><headertext>Display Order</headertext><width>30</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>3</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>y</iscontrol><controltype>Text</controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>DestinationCountryCode</name><headertext>Country Code</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>HandlingCharge</name><headertext>Handling Charge</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>IsActive</name><headertext>Enable</headertext><width>40</width><datatype>Boolean</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>9</id><name>ZipCode</name><headertext>Zip Code</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>10</id><name>PublishState</name><headertext>Application Type</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>y</iscontrol><controltype>DropDown</controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>11</id><name>Manage</name><headertext>Action</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>Edit|Delete</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>PortalId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/Profiles/UpdateProfileShipping|/Profiles/UnAssociateAssociatedShipping</manageactionurl><manageparamfield>shippingId,profileId|shippingId,profileId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>12</id><name>ProfileName</name><headertext>Profile Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>13</id><name>ShippingId</name><headertext>ShippingId</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName = 'ZnodeAssociatedShippingListToProfile'



Update ZnodeApplicationSetting
Set Setting = '<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>AccountId</name>      <headertext>Checkbox</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>AccountId</name>      <headertext>Account ID</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>AccountCode</name>      <headertext>Account Code</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>accountcodecolumn</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>Name</name>      <headertext>Account Name</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>y</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>accountnamecolumn</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>ParentAccountName</name>      <headertext>Parent Account Name</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>PortalId</name>      <headertext>Portal ID</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>portalId</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
where ItemName='ZnodeUserAccountList'


Update ZnodeApplicationSetting set Setting='<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>MediaId</name>      <headertext>Checkbox</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>MediaId</islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>MediaId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>Image</name>      <headertext>Media</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>Edit</format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>MediaId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Edit</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>Path,FileName</imageparamfield>      <manageactionurl>/MediaManager/MediaManager/GetMediaAttributeValues</manageactionurl>      <manageparamfield>MediaId</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>imageicon</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>FileName</name>      <headertext>File Name</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>100</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>y</isallowlink>      <islinkactionurl>/MediaManager/MediaManager/GetMediaAttributeValues</islinkactionurl>      <islinkparamfield>MediaId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>MediaId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>filename</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>y</allowdetailview>    </column>    <column>      <id>4</id>      <name>MediaType</name>      <headertext>File Type</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>MediaId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>MediaId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>Size</name>      <headertext>Size</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>MediaId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>MediaId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>Height</name>      <headertext>Height</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>MediaId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>MediaId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>Width</name>      <headertext>Width</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>MediaId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>MediaId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>MediaType</name>      <headertext>Type</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>MediaId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>MediaId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>9</id>      <name>Folder</name>      <headertext>Folder</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>MediaId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>MediaId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>10</id>      <name>Path</name>      <headertext>Path</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>Path</imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>imageicon</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>11</id>      <name>DisplayName</name>      <headertext>Display Name</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>Path</imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>12</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>Edit|Delete</format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>MediaId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Edit|Delete</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/MediaManager/MediaManager/GetMediaAttributeValues|/MediaManager/MediaManager/DeleteMedia</manageactionurl>      <manageparamfield>MediaId|MediaId</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>inline</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>' 
where ItemName = 'View_GetMediaPathDetail'

insert into ZnodeApplicationSetting (GroupName,	ItemName,	Setting,	ViewOptions,	FrontPageName,	FrontObjectName,	IsCompressed,	OrderByFields,	ItemNameWithoutCurrency,	CreatedByName,	ModifiedByName,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
select 'Table','ZnodeOmsFailedOrderPayments','<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>OrderNumber</name>      <headertext>Order/Invoice Number</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>y</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>TotalAmount</name>      <headertext>Order Total</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>Decimal</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>OrderDate</name>      <headertext>Order/Transaction Date</headertext>      <width>0</width>      <datatype>DateTime</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>PaymentDisplayName</name>      <headertext>Payment Name</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>PaymentStatus</name>      <headertext>Payment Status</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>TransactionToken</name>      <headertext>Transaction ID</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>UserName</name>      <headertext>Customer Name</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>Email</name>      <headertext>Email Address</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>','ZnodeOmsFailedOrderPayments','ZnodeOmsFailedOrderPayments','ZnodeOmsFailedOrderPayments',0,'OrderDateWithTime|DESC',null,null,null,2,GETDATE(),2,getdate()
where not exists(select * from ZnodeApplicationSetting where GroupName = 'Table' and ItemName = 'ZnodeOmsFailedOrderPayments')


UPDATE Znodemenu SET MenuName = 'Content Containers',ControllerName = 'ContentContainer' WHERE MenuName = 'Content Widgets' AND CSSClassName = 'z-content-widgets'
UPDATE Znodemenu SET MenuName = 'Containers',ControllerName = 'ContentContainer' WHERE MenuName = 'Containers' AND CSSClassName = 'z-content-widgets'
UPDATE Znodemenu SET MenuName = 'Container Templates',ControllerName = 'ContainerTemplate' WHERE MenuName = 'Widget Templates' AND CSSClassName = 'z-widget-templates'

Update Znodemenu SET MenuName = 'Containers',ControllerName = 'ContentContainer' where MenuName = 'Widgets' AND CSSClassName = 'z-content-widgets'
and MenuId = (select min(MenuId) from Znodemenu where MenuName = 'Widgets' AND CSSClassName = 'z-content-widgets')

Update Znodemenu SET MenuName = 'Content Containers',ControllerName = 'ContentContainer' where MenuName = 'Widgets' AND CSSClassName = 'z-content-widgets'
and MenuId = (select max(MenuId) from Znodemenu where MenuName = 'Widgets' AND CSSClassName = 'z-content-widgets')


insert into ZnodeMenu(ParentMenuId,MenuName,MenuSequence,AreaName,ControllerName,ActionName,CSSClassName,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select (select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS'),'Containers',3,null,'ContentWidget','List','z-content-widgets',1,
2,getdate(),2,getdate()
where not exists(select * from ZnodeMenu where MenuName = 'Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS'))

insert into ZnodeMenu(ParentMenuId,MenuName,MenuSequence,AreaName,ControllerName,ActionName,CSSClassName,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select (select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')),
'Content Containers',3,null,'ContentWidget','List','z-content-widgets',1,
2,getdate(),2,getdate()
where not exists(select * from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))

insert into ZnodeMenu(ParentMenuId,MenuName,MenuSequence,AreaName,ControllerName,ActionName,CSSClassName,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select (select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')),
'Container Templates',2,null,'WidgetTemplate','List','z-widget-templates',1,
2,getdate(),2,getdate()
where not exists(select * from ZnodeMenu where MenuName = 'Container Templates'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))


update ZnodeMenu set MenuSequence = 2 where ParentMenuId = (select Top 1 MenuId from  ZnodeMenu where MenuName = 'CMS') and MenuName = 'Containers'


GO


Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'ContentContainer','List',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'ContentContainer' and ActionName = 'List')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'List') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'List'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS'))) ,
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'List')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId =(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'List'))


Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'ContentContainer','Create',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'ContentContainer' and ActionName = 'Create')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'Create') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId =(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'Create'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS'))) ,
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'Create')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId =(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'Create'))


Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'ContentContainer','Edit',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'ContentContainer' and ActionName = 'Edit')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'Edit') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId =(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'Edit'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS'))) ,
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'Edit')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId =(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'Edit'))



Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'ContentContainer','GetVariants',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'ContentContainer' and ActionName = 'GetVariants')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'GetVariants') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId =(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'GetVariants'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS'))) ,
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'GetVariants')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId =(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'GetVariants'))


Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'ContentContainer','GetUnassociatedProfiles',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'ContentContainer' and ActionName = 'GetUnassociatedProfiles')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'GetUnassociatedProfiles') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'GetUnassociatedProfiles'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS'))) ,
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'GetUnassociatedProfiles')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'GetUnassociatedProfiles'))


Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'ContentContainer','AssociateVariants',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'ContentContainer' and ActionName = 'AssociateVariants')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'AssociateVariants') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'AssociateVariants'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS'))) ,
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'AssociateVariants')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'AssociateVariants'))


Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'ContentContainer','AssociateWidgetTemplate',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'ContentContainer' and ActionName = 'AssociateWidgetTemplate')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'AssociateWidgetTemplate') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'AssociateWidgetTemplate'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS'))) ,
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'AssociateWidgetTemplate')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'AssociateWidgetTemplate'))



Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'ContentContainer','GetEntityAttributeDetails',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'ContentContainer' and ActionName = 'GetEntityAttributeDetails')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'GetEntityAttributeDetails') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'GetEntityAttributeDetails'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS'))) ,
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'GetEntityAttributeDetails')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'GetEntityAttributeDetails'))


Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'ContentContainer','SaveEntityDetails',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'ContentContainer' and ActionName = 'SaveEntityDetails')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'SaveEntityDetails') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'SaveEntityDetails'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS'))) ,
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'SaveEntityDetails')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'SaveEntityDetails'))



Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'ContentContainer','DeleteAssociatedVariant',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'ContentContainer' and ActionName = 'DeleteAssociatedVariant')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'DeleteAssociatedVariant') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'DeleteAssociatedVariant'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS'))) ,
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'DeleteAssociatedVariant')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'DeleteAssociatedVariant'))



Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'ContentContainer','Delete',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'ContentContainer' and ActionName = 'Delete')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'Delete') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'Delete'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS'))) ,
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'Delete')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'Delete'))



Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'ContentContainer','IsWidgetExist',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'ContentContainer' and ActionName = 'IsWidgetExist')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'IsWidgetExist') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'IsWidgetExist'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS'))) ,
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'IsWidgetExist')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Content Containers'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'IsWidgetExist'))



Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'WidgetTemplate','List',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'List')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
,(select top 1 ActionId from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'List') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'List'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS'))) ,
(select top 1 ActionId from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'List')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'List'))



Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'WidgetTemplate','Create',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'Create')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
,(select top 1 ActionId from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'Create') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'Create'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS'))) ,
(select top 1 ActionId from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'Create')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'Create'))



Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'WidgetTemplate','Edit',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'Edit')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
,(select top 1 ActionId from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'Edit') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'Edit'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS'))) ,
(select top 1 ActionId from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'Edit')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'Edit'))



Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'WidgetTemplate','Delete',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'Delete')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
,(select top 1 ActionId from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'Delete') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'Delete'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS'))) ,
(select top 1 ActionId from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'Delete')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'Delete'))



Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'WidgetTemplate','Copy',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'Copy')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
,(select top 1 ActionId from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'Copy') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'Copy'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS'))) ,
(select top 1 ActionId from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'Copy')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'Copy'))



Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'WidgetTemplate','DownloadWidgetTemplate',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'DownloadWidgetTemplate')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
,(select top 1 ActionId from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'DownloadWidgetTemplate') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'DownloadWidgetTemplate'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS'))) ,
(select top 1 ActionId from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'DownloadWidgetTemplate')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'DownloadWidgetTemplate'))



Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'WidgetTemplate','IsWidgetTemplateExist',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'IsWidgetTemplateExist')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
,(select top 1 ActionId from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'IsWidgetTemplateExist') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'IsWidgetTemplateExist'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS'))) ,
(select top 1 ActionId from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'IsWidgetTemplateExist')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates'
and ParentMenuId = ( select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =(select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')))
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'WidgetTemplate' and ActionName = 'IsWidgetTemplateExist'))


--ZPD-12333 --> ZPD-10403
Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 'MediaManager' ,'MediaConfiguration','GenerateImages',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'MediaConfiguration' and ActionName = 'GenerateImages')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Media Settings')
,(select top 1 ActionId from ZnodeActions where ControllerName = 'MediaConfiguration' and ActionName = 'GenerateImages') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Media Settings')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'MediaConfiguration' and ActionName = 'GenerateImages'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Media Settings'),
(select top 1 ActionId from ZnodeActions where ControllerName = 'MediaConfiguration' and ActionName = 'GenerateImages')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Media Settings')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'MediaConfiguration' and ActionName = 'GenerateImages'))

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 'MediaManager' ,'MediaManager','GenerateImageOnEdit',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'MediaManager' and ActionName = 'GenerateImageOnEdit')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'DAM')
,(select top 1 ActionId from ZnodeActions where ControllerName = 'MediaManager' and ActionName = 'GenerateImageOnEdit') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'DAM')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'MediaManager' and ActionName = 'GenerateImageOnEdit'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'DAM'),
(select top 1 ActionId from ZnodeActions where ControllerName = 'MediaManager' and ActionName = 'GenerateImageOnEdit')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'DAM')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'MediaManager' and ActionName = 'GenerateImageOnEdit'))

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 'MediaManager' ,'MediaManager','GenerateImageOnEdit',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'MediaManager' and ActionName = 'GenerateImageOnEdit')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Media Explorer')
,(select top 1 ActionId from ZnodeActions where ControllerName = 'MediaManager' and ActionName = 'GenerateImageOnEdit') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Media Explorer')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'MediaManager' and ActionName = 'GenerateImageOnEdit'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Media Explorer'),
(select top 1 ActionId from ZnodeActions where ControllerName = 'MediaManager' and ActionName = 'GenerateImageOnEdit')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Media Explorer')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'MediaManager' and ActionName = 'GenerateImageOnEdit'))

---------------- ZPD-9657 --> ZPD-13470  dt-12/01/2021

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select '' ,'RMAReturn','CheckOrderEligibileForReturn',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'CheckOrderEligibileForReturn')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Returns')
,(select top 1 ActionId from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'CheckOrderEligibileForReturn') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Returns')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'CheckOrderEligibileForReturn'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Returns'),
(select top 1 ActionId from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'CheckOrderEligibileForReturn')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Returns')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'CheckOrderEligibileForReturn'))
-----------------------------------------------------------

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select '' ,'RMAReturn','GetOrderDetailsForReturn',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'GetOrderDetailsForReturn')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Returns')
,(select top 1 ActionId from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'GetOrderDetailsForReturn') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Returns')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'GetOrderDetailsForReturn'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Returns'),
(select top 1 ActionId from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'GetOrderDetailsForReturn')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Returns')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'GetOrderDetailsForReturn'))
-----------------------------------------------------------
Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select '' ,'RMAReturn','CalculateOrderReturn',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'CalculateOrderReturn')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Returns')
,(select top 1 ActionId from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'CalculateOrderReturn') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Returns')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'CalculateOrderReturn'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Returns'),
(select top 1 ActionId from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'CalculateOrderReturn')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Returns')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'CalculateOrderReturn'))
-----------------------------------------------------------
Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select '' ,'RMAReturn','SubmitCreateReturn',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'SubmitCreateReturn')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Returns')
,(select top 1 ActionId from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'SubmitCreateReturn') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Returns')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'SubmitCreateReturn'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Returns'),
(select top 1 ActionId from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'SubmitCreateReturn')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Returns')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'SubmitCreateReturn'))
-----------------------------------------------------------
Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select '' ,'RMAReturn','GetReturnDetails',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'GetReturnDetails')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Returns')
,(select top 1 ActionId from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'GetReturnDetails') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Returns')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'GetReturnDetails'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Returns'),
(select top 1 ActionId from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'GetReturnDetails')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Returns')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'GetReturnDetails'))

---------------- ZPD-9657 --> ZPD-13470  dt-12/01/2021

Update ZnodeActions SET ActionName='CheckOrderEligibleForReturn' where ControllerName= 'RMAReturn' AND ActionName= 'CheckOrderEligibileForReturn'

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select '' ,'RMAReturn','IsValidReturnItems',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'IsValidReturnItems')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Returns')
,(select top 1 ActionId from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'IsValidReturnItems') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Returns')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'IsValidReturnItems'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Returns'),
(select top 1 ActionId from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'IsValidReturnItems')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Returns')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'IsValidReturnItems'))

---------------- ZPD-9657 --> ZPD-13616  dt-25/01/2021
Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select '' ,'RMAReturn','PrintCreateReturnReceipt',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'PrintCreateReturnReceipt')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Returns')
,(select top 1 ActionId from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'PrintCreateReturnReceipt') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Returns')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'PrintCreateReturnReceipt'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Returns'),
(select top 1 ActionId from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'PrintCreateReturnReceipt')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Returns')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'RMAReturn' and ActionName = 'PrintCreateReturnReceipt'))

---------------ZPD-13095  dt-04/02/2021
Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select '' ,'Recommendation','CreateScheduler',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'Recommendation' and ActionName = 'CreateScheduler')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Store Experience')
,(select top 1 ActionId from ZnodeActions where ControllerName = 'Recommendation' and ActionName = 'CreateScheduler') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Store Experience')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'Recommendation' and ActionName = 'CreateScheduler'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Store Experience'),
(select top 1 ActionId from ZnodeActions where ControllerName = 'Recommendation' and ActionName = 'CreateScheduler')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Store Experience')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'Recommendation' and ActionName = 'CreateScheduler'))
insert into ZnodeActions (Areaname,ControllerName,ActionName,IsGlobalAccess,CreatedBy, CreatedDate,ModifiedBy,ModifiedDate)
select null,'Customer','GetSalesRepListForAccount',0,2,GETUTCDATE(),2,GETUTCDATE()
where not exists(select * from ZnodeActions where ControllerName = 'Customer' and ActionName = 'GetSalesRepListForAccount')

 insert into ZnodeActionMenu (MenuId,ActionId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 
 (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Accounts' AND ControllerName = 'Account')	
    ,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Customer' and ActionName= 'GetSalesRepListForAccount') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId = 
     (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Accounts' AND ControllerName = 'Account') and ActionId = 
     (select TOP 1 ActionId from ZnodeActions where ControllerName = 'Customer' and ActionName= 'GetSalesRepListForAccount'))

insert into ZnodeMenuActionsPermission ( MenuId,	ActionId, AccessPermissionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
select 
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Accounts' AND ControllerName = 'Account')	
    ,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Customer' and ActionName= 'GetSalesRepListForAccount')	
,1,2,Getdate(),2,Getdate() where not exists 
(select * from ZnodeMenuActionsPermission where MenuId = 
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Accounts' AND ControllerName = 'Account') and ActionId = 
(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Customer' and ActionName= 'GetSalesRepListForAccount'))


insert into ZnodeActions (Areaname,ControllerName,ActionName,IsGlobalAccess,CreatedBy, CreatedDate,ModifiedBy,ModifiedDate)
SELECT null,'Dashboard','GetDashboardDetails',0,2,GETUTCDATE(),2,GETUTCDATE()
WHERE not exists(Select * from ZnodeActions where ControllerName='Dashboard' and ActionName='GetDashboardDetails')

 insert into ZnodeActionMenu (MenuId,ActionId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 
 (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Dashboard' AND ControllerName = 'Dashboard')	
    ,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Dashboard' and ActionName= 'GetDashboardDetails') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId = 
     (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Dashboard' AND ControllerName = 'Dashboard') and ActionId = 
     (select TOP 1 ActionId from ZnodeActions where ControllerName = 'Dashboard' and ActionName= 'GetDashboardDetails'))

insert into ZnodeMenuActionsPermission(MenuId,ActionId,AccessPermissionId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Dashboard' AND ControllerName = 'Dashboard')	
    ,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Dashboard' and ActionName= 'GetDashboardDetails')	
,1,2,Getdate(),2,Getdate() where not exists (select * from ZnodeMenuActionsPermission where MenuId = 
     (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Dashboard' AND ControllerName = 'Dashboard') and ActionId = 
     (select TOP 1 ActionId from ZnodeActions where ControllerName = 'Dashboard' and ActionName= 'GetDashboardDetails'))

insert into ZnodeActions (Areaname,ControllerName,ActionName,IsGlobalAccess,CreatedBy, CreatedDate,ModifiedBy,ModifiedDate)
SELECT null,'Dashboard','GetDashboardOrders',0,2,GETUTCDATE(),2,GETUTCDATE()
WHERE not exists(Select * from ZnodeActions where ControllerName='Dashboard' and ActionName='GetDashboardOrders')

 insert into ZnodeActionMenu (MenuId,ActionId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 
 (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Dashboard' AND ControllerName = 'Dashboard')	
    ,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Dashboard' and ActionName= 'GetDashboardOrders') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId = 
     (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Dashboard' AND ControllerName = 'Dashboard') and ActionId = 
     (select TOP 1 ActionId from ZnodeActions where ControllerName = 'Dashboard' and ActionName= 'GetDashboardOrders'))

insert into ZnodeMenuActionsPermission(MenuId,ActionId,AccessPermissionId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Dashboard' AND ControllerName = 'Dashboard')	
    ,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Dashboard' and ActionName= 'GetDashboardOrders')	
,1,2,Getdate(),2,Getdate() where not exists (select * from ZnodeMenuActionsPermission where MenuId = 
     (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Dashboard' AND ControllerName = 'Dashboard') and ActionId = 
     (select TOP 1 ActionId from ZnodeActions where ControllerName = 'Dashboard' and ActionName= 'GetDashboardOrders'))

insert into ZnodeActions (Areaname,ControllerName,ActionName,IsGlobalAccess,CreatedBy, CreatedDate,ModifiedBy,ModifiedDate)
SELECT null,'Dashboard','GetDashboardReturns',0,2,GETUTCDATE(),2,GETUTCDATE()
WHERE not exists(Select * from ZnodeActions where ControllerName='Dashboard' and ActionName='GetDashboardReturns')

 insert into ZnodeActionMenu (MenuId,ActionId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 
 (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Dashboard' AND ControllerName = 'Dashboard')	
    ,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Dashboard' and ActionName= 'GetDashboardReturns') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId = 
     (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Dashboard' AND ControllerName = 'Dashboard') and ActionId = 
     (select TOP 1 ActionId from ZnodeActions where ControllerName = 'Dashboard' and ActionName= 'GetDashboardReturns'))

insert into ZnodeMenuActionsPermission(MenuId,ActionId,AccessPermissionId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Dashboard' AND ControllerName = 'Dashboard')	
    ,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Dashboard' and ActionName= 'GetDashboardReturns')	
,1,2,Getdate(),2,Getdate() where not exists (select * from ZnodeMenuActionsPermission where MenuId = 
     (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Dashboard' AND ControllerName = 'Dashboard') and ActionId = 
     (select TOP 1 ActionId from ZnodeActions where ControllerName = 'Dashboard' and ActionName= 'GetDashboardReturns'))

insert into ZnodeActions (Areaname,ControllerName,ActionName,IsGlobalAccess,CreatedBy, CreatedDate,ModifiedBy,ModifiedDate)
SELECT null,'Dashboard','GetDashboardQuotes',0,2,GETUTCDATE(),2,GETUTCDATE()
WHERE not exists(Select * from ZnodeActions where ControllerName='Dashboard' and ActionName='GetDashboardQuotes')

 insert into ZnodeActionMenu (MenuId,ActionId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 
 (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Dashboard' AND ControllerName = 'Dashboard')	
    ,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Dashboard' and ActionName= 'GetDashboardQuotes') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId = 
     (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Dashboard' AND ControllerName = 'Dashboard') and ActionId = 
     (select TOP 1 ActionId from ZnodeActions where ControllerName = 'Dashboard' and ActionName= 'GetDashboardQuotes'))

insert into ZnodeMenuActionsPermission(MenuId,ActionId,AccessPermissionId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Dashboard' AND ControllerName = 'Dashboard')	
    ,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Dashboard' and ActionName= 'GetDashboardQuotes')	
,1,2,Getdate(),2,Getdate() where not exists (select * from ZnodeMenuActionsPermission where MenuId = 
     (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Dashboard' AND ControllerName = 'Dashboard') and ActionId = 
     (select TOP 1 ActionId from ZnodeActions where ControllerName = 'Dashboard' and ActionName= 'GetDashboardQuotes'))

insert into ZnodeActions (Areaname,ControllerName,ActionName,IsGlobalAccess,CreatedBy, CreatedDate,ModifiedBy,ModifiedDate)
SELECT null,'Dashboard','GetDashboardSaleDetails',0,2,GETUTCDATE(),2,GETUTCDATE()
WHERE not exists(Select * from ZnodeActions where ControllerName='Dashboard' and ActionName='GetDashboardSaleDetails')

 insert into ZnodeActionMenu (MenuId,ActionId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 
 (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Dashboard' AND ControllerName = 'Dashboard')	
    ,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Dashboard' and ActionName= 'GetDashboardSaleDetails') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId = 
     (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Dashboard' AND ControllerName = 'Dashboard') and ActionId = 
     (select TOP 1 ActionId from ZnodeActions where ControllerName = 'Dashboard' and ActionName= 'GetDashboardSaleDetails'))

insert into ZnodeMenuActionsPermission(MenuId,ActionId,AccessPermissionId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Dashboard' AND ControllerName = 'Dashboard')	
    ,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Dashboard' and ActionName= 'GetDashboardSaleDetails')	
,1,2,Getdate(),2,Getdate() where not exists (select * from ZnodeMenuActionsPermission where MenuId = 
     (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Dashboard' AND ControllerName = 'Dashboard') and ActionId = 
     (select TOP 1 ActionId from ZnodeActions where ControllerName = 'Dashboard' and ActionName= 'GetDashboardSaleDetails'))

insert into ZnodeActions (Areaname,ControllerName,ActionName,IsGlobalAccess,CreatedBy, CreatedDate,ModifiedBy,ModifiedDate)
SELECT null,'Dashboard','GetDashboardSaleDetails',0,2,GETUTCDATE(),2,GETUTCDATE()
WHERE not exists(Select * from ZnodeActions where ControllerName='Dashboard' and ActionName='GetDashboardSaleDetails')

 insert into ZnodeActionMenu (MenuId,ActionId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 
 (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Dashboard' AND ControllerName = 'Dashboard')	
    ,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Dashboard' and ActionName= 'GetDashboardSaleDetails') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId = 
     (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Dashboard' AND ControllerName = 'Dashboard') and ActionId = 
     (select TOP 1 ActionId from ZnodeActions where ControllerName = 'Dashboard' and ActionName= 'GetDashboardSaleDetails'))

insert into ZnodeMenuActionsPermission(MenuId,ActionId,AccessPermissionId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Dashboard' AND ControllerName = 'Dashboard')	
    ,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Dashboard' and ActionName= 'GetDashboardSaleDetails')	
,1,2,Getdate(),2,Getdate() where not exists (select * from ZnodeMenuActionsPermission where MenuId = 
     (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Dashboard' AND ControllerName = 'Dashboard') and ActionId = 
     (select TOP 1 ActionId from ZnodeActions where ControllerName = 'Dashboard' and ActionName= 'GetDashboardSaleDetails'))

insert into ZnodeActions (Areaname,ControllerName,ActionName,IsGlobalAccess,CreatedBy, CreatedDate,ModifiedBy,ModifiedDate)
SELECT null,'Dashboard','GetDashboardTopAccounts',0,2,GETUTCDATE(),2,GETUTCDATE()
WHERE not exists(Select * from ZnodeActions where ControllerName='Dashboard' and ActionName='GetDashboardTopAccounts')

 insert into ZnodeActionMenu (MenuId,ActionId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 
 (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Dashboard' AND ControllerName = 'Dashboard')	
    ,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Dashboard' and ActionName= 'GetDashboardTopAccounts') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId = 
     (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Dashboard' AND ControllerName = 'Dashboard') and ActionId = 
     (select TOP 1 ActionId from ZnodeActions where ControllerName = 'Dashboard' and ActionName= 'GetDashboardTopAccounts'))

insert into ZnodeMenuActionsPermission(MenuId,ActionId,AccessPermissionId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Dashboard' AND ControllerName = 'Dashboard')	
    ,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Dashboard' and ActionName= 'GetDashboardTopAccounts')	
,1,2,Getdate(),2,Getdate() where not exists (select * from ZnodeMenuActionsPermission where MenuId = 
     (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Dashboard' AND ControllerName = 'Dashboard') and ActionId = 
     (select TOP 1 ActionId from ZnodeActions where ControllerName = 'Dashboard' and ActionName= 'GetDashboardTopAccounts'))


update ZnodeActions set IsGlobalAccess=0 where ActionName='CreateOrder'

update ZnodeActions set IsGlobalAccess=1 where ActionName = 'GetSuggestions' and ControllerName= 'Typeahead'


INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'SEO','DeleteSeoDetail',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'SEO' and ActionName = 'DeleteSeoDetail')

INSERT INTO ZnodeActionMenu ( MenuId,	ActionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
 (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Products' AND ControllerName = 'SEO')	
    ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'SEO' and ActionName = 'DeleteSeoDetail') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = 
     (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Products' AND ControllerName = 'SEO') and ActionId = 
     (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'SEO' and ActionName = 'DeleteSeoDetail'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId,	ActionId, AccessPermissionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Products' AND ControllerName = 'SEO'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'SEO' and ActionName = 'DeleteSeoDetail')	
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS 
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Products' AND ControllerName = 'SEO') and ActionId = 
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'SEO' and ActionName = 'DeleteSeoDetail'))



--ZPD-15085
INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'GiftCard','ActivateDeactivateVouchers',0,2,Getdate(),2,Getdate() 
WHERE NOT EXISTS(SELECT * FROM ZnodeActions WHERE ControllerName = 'GiftCard' and ActionName = 'ActivateDeactivateVouchers')

INSERT INTO ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
SELECT(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Vouchers' AND ControllerName = 'GiftCard'),
	(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'GiftCard' and ActionName = 'ActivateDeactivateVouchers') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId =(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Vouchers' AND ControllerName = 'GiftCard') 
	AND ActionId =(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'GiftCard' and ActionName = 'ActivateDeactivateVouchers'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
SELECT(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Vouchers' AND ControllerName = 'GiftCard'),
	(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'GiftCard' and ActionName = 'ActivateDeactivateVouchers'),1,2,Getdate(),2,Getdate() 
WHERE NOT EXISTS(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId =(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Vouchers' AND ControllerName = 'GiftCard') 
AND ActionId =(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'GiftCard' and ActionName = 'ActivateDeactivateVouchers'))

--ZPD-15108
INSERT  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'Account','GetParentAccountsList',0,2,Getdate(),2,Getdate() 
WHERE NOT EXISTS(SELECT * FROM ZnodeActions WHERE ControllerName = 'Account' and ActionName = 'GetParentAccountsList')

INSERT INTO ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
SELECT (SELECT TOP 1 MenuId FROM ZnodeMenu WHERE MenuName = 'Accounts' AND ControllerName = 'Account')
  ,(SELECT TOP 1 ActionId FROM ZnodeActions WHERE ControllerName = 'Account' and ActionName= 'GetParentAccountsList') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = (SELECT TOP 1 MenuId FROM ZnodeMenu WHERE MenuName = 'Accounts' AND ControllerName = 'Account') and ActionId =
   (SELECT TOP 1 ActionId FROM ZnodeActions WHERE ControllerName = 'Account' and ActionName= 'GetParentAccountsList'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
SELECT (SELECT TOP 1 MenuId FROM ZnodeMenu WHERE MenuName = 'Accounts' AND ControllerName = 'Account') ,
	(SELECT TOP 1 ActionId FROM ZnodeActions WHERE ControllerName = 'Account' and ActionName= 'GetParentAccountsList')
	,3,2,Getdate(),2,Getdate() 
WHERE NOT EXISTS(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = (SELECT TOP 1 MenuId FROM ZnodeMenu WHERE MenuName = 'Accounts' AND ControllerName = 'Account') and ActionId =
	(SELECT TOP 1 ActionId FROM ZnodeActions WHERE ControllerName = 'Account' and ActionName= 'GetParentAccountsList'))
----------ZPD-14893
Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'Products','GetAssociatedBundleProducts',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'Products' and ActionName = 'GetAssociatedBundleProducts')

 

INSERT INTO ZnodeMenuActionsPermission (MenuId,ActionId,AccessPermissionId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select TOP 1 MenuId from ZnodeMenu where MenuName='PIM'), 
(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Products' and ActionName= 'GetAssociatedBundleProducts'),1,2,getdate(),2,getdate()
where exists(select TOP 1 MenuId from ZnodeMenu where MenuName='PIM') and
exists(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Products' and ActionName= 'GetAssociatedBundleProducts')
and not exists(select * from ZnodeMenuActionsPermission where MenuId = (select TOP 1 MenuId from ZnodeMenu where MenuName='PIM')
and ActionId =(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Products' and ActionName= 'GetAssociatedBundleProducts'))



insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
SELECT (select TOP 1 MenuId from ZnodeMenu where MenuName='Products'), 
(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Products' and ActionName= 'GetAssociatedBundleProducts'),1,2,getdate(),2,getdate()
where exists(select TOP 1 MenuId from ZnodeMenu where MenuName='Products') and
exists(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Products' and ActionName= 'GetAssociatedBundleProducts')
and not exists(select * from ZnodeMenuActionsPermission where MenuId = (select TOP 1 MenuId from ZnodeMenu where MenuName='Products')
and ActionId =(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Products' and ActionName= 'GetAssociatedBundleProducts'))




GO
--ZPD-15085
INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'GiftCard','ActivateDeactivateVouchers',0,2,Getdate(),2,Getdate() 
WHERE NOT EXISTS(SELECT * FROM ZnodeActions WHERE ControllerName = 'GiftCard' and ActionName = 'ActivateDeactivateVouchers')

INSERT INTO ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
SELECT(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Vouchers' AND ControllerName = 'GiftCard'),
	(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'GiftCard' and ActionName = 'ActivateDeactivateVouchers') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId =(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Vouchers' AND ControllerName = 'GiftCard') 
	AND ActionId =(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'GiftCard' and ActionName = 'ActivateDeactivateVouchers'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
SELECT(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Vouchers' AND ControllerName = 'GiftCard'),
	(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'GiftCard' and ActionName = 'ActivateDeactivateVouchers'),1,2,Getdate(),2,Getdate() 
WHERE NOT EXISTS(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId =(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Vouchers' AND ControllerName = 'GiftCard') 
AND ActionId =(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'GiftCard' and ActionName = 'ActivateDeactivateVouchers'))

--ZPD-15108
INSERT  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'Account','GetParentAccountsList',0,2,Getdate(),2,Getdate() 
WHERE NOT EXISTS(SELECT * FROM ZnodeActions WHERE ControllerName = 'Account' and ActionName = 'GetParentAccountsList')

INSERT INTO ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
SELECT (SELECT TOP 1 MenuId FROM ZnodeMenu WHERE MenuName = 'Accounts' AND ControllerName = 'Account')
  ,(SELECT TOP 1 ActionId FROM ZnodeActions WHERE ControllerName = 'Account' and ActionName= 'GetParentAccountsList') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = (SELECT TOP 1 MenuId FROM ZnodeMenu WHERE MenuName = 'Accounts' AND ControllerName = 'Account') and ActionId =
   (SELECT TOP 1 ActionId FROM ZnodeActions WHERE ControllerName = 'Account' and ActionName= 'GetParentAccountsList'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
SELECT (SELECT TOP 1 MenuId FROM ZnodeMenu WHERE MenuName = 'Accounts' AND ControllerName = 'Account') ,
	(SELECT TOP 1 ActionId FROM ZnodeActions WHERE ControllerName = 'Account' and ActionName= 'GetParentAccountsList')
	,3,2,Getdate(),2,Getdate() 
WHERE NOT EXISTS(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = (SELECT TOP 1 MenuId FROM ZnodeMenu WHERE MenuName = 'Accounts' AND ControllerName = 'Account') and ActionId =
	(SELECT TOP 1 ActionId FROM ZnodeActions WHERE ControllerName = 'Account' and ActionName= 'GetParentAccountsList'))


----------------ZPD-15239
INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'Customer','GetCountryBasedOnPortalId',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'Customer' and ActionName = 'GetCountryBasedOnPortalId')

INSERT INTO ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
SELECT
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Users' AND ControllerName = 'Customer')
,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Customer' and ActionName = 'GetCountryBasedOnPortalId') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId =
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Users' AND ControllerName = 'Customer') and ActionId =
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Customer' and ActionName = 'GetCountryBasedOnPortalId'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
SELECT
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Users' AND ControllerName = 'Customer'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Customer' and ActionName = 'GetCountryBasedOnPortalId')
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId =
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Users' AND ControllerName = 'Customer') and ActionId =
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Customer' and ActionName = 'GetCountryBasedOnPortalId'))
----------ZPD-14893
Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'Products','GetAssociatedBundleProducts',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'Products' and ActionName = 'GetAssociatedBundleProducts')

 

INSERT INTO ZnodeMenuActionsPermission (MenuId,ActionId,AccessPermissionId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select TOP 1 MenuId from ZnodeMenu where MenuName='PIM'), 
(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Products' and ActionName= 'GetAssociatedBundleProducts'),1,2,getdate(),2,getdate()
where exists(select TOP 1 MenuId from ZnodeMenu where MenuName='PIM') and
exists(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Products' and ActionName= 'GetAssociatedBundleProducts')
and not exists(select * from ZnodeMenuActionsPermission where MenuId = (select TOP 1 MenuId from ZnodeMenu where MenuName='PIM')
and ActionId =(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Products' and ActionName= 'GetAssociatedBundleProducts'))



insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
SELECT (select TOP 1 MenuId from ZnodeMenu where MenuName='Products'), 
(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Products' and ActionName= 'GetAssociatedBundleProducts'),1,2,getdate(),2,getdate()
where exists(select TOP 1 MenuId from ZnodeMenu where MenuName='Products') and
exists(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Products' and ActionName= 'GetAssociatedBundleProducts')
and not exists(select * from ZnodeMenuActionsPermission where MenuId = (select TOP 1 MenuId from ZnodeMenu where MenuName='Products')
and ActionId =(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Products' and ActionName= 'GetAssociatedBundleProducts'))




GO

--ZPD-16057
Update ZnodeActionMenu set MenuId = (select TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'General' and ControllerName = 'MyReports') 
where ActionId = (select top 1 ActionId from ZnodeActions where ControllerName='MyReports'and ActionName='List')

--ZPD-16284
Update ZnodeActionMenu set MenuId = (select TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'General' and ControllerName = 'MyReports') 
where ActionId = (select top 1 ActionId from ZnodeActions where ControllerName='MyReports'and ActionName='DynamicReport')
GO
INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'ContentContainer','SaveAssociatedVariantData',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'SaveAssociatedVariantData')

INSERT INTO ZnodeActionMenu ( MenuId,	ActionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
 (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Containers' AND ControllerName = 'ContentContainer')	
    ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'SaveAssociatedVariantData') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = 
     (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Containers' AND ControllerName = 'ContentContainer') and ActionId = 
     (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'SaveAssociatedVariantData'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId,	ActionId, AccessPermissionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Containers' AND ControllerName = 'ContentContainer'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'SaveAssociatedVariantData')	
,2,2,Getdate(),2,Getdate() WHERE NOT EXISTS 
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Containers' AND ControllerName = 'ContentContainer') and ActionId = 
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'SaveAssociatedVariantData'))


INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'ContentContainer','EditAssociatedVariant',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'EditAssociatedVariant')

INSERT INTO ZnodeActionMenu ( MenuId,	ActionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
 (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Containers' AND ControllerName = 'ContentContainer')	
    ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'EditAssociatedVariant') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = 
     (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Containers' AND ControllerName = 'ContentContainer') and ActionId = 
     (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'EditAssociatedVariant'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId,	ActionId, AccessPermissionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Containers' AND ControllerName = 'ContentContainer'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'EditAssociatedVariant')	
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS 
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Containers' AND ControllerName = 'ContentContainer') and ActionId = 
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'EditAssociatedVariant'))




INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'ContentContainer','GetGlobalAttributesForDefaultData',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'GetGlobalAttributesForDefaultData')

INSERT INTO ZnodeActionMenu ( MenuId,	ActionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
 (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Containers' AND ControllerName = 'ContentContainer')	
    ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'GetGlobalAttributesForDefaultData') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = 
     (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Containers' AND ControllerName = 'ContentContainer') and ActionId = 
     (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'GetGlobalAttributesForDefaultData'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId,	ActionId, AccessPermissionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Containers' AND ControllerName = 'ContentContainer'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'GetGlobalAttributesForDefaultData')	
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS 
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Containers' AND ControllerName = 'ContentContainer') and ActionId = 
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'GetGlobalAttributesForDefaultData'))



INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'ContentContainer','GetAssociatedVariantList',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'GetAssociatedVariantList')

INSERT INTO ZnodeActionMenu ( MenuId,	ActionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
 (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Containers' AND ControllerName = 'ContentContainer')	
    ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'GetAssociatedVariantList') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = 
     (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Containers' AND ControllerName = 'ContentContainer') and ActionId = 
     (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'GetAssociatedVariantList'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId,	ActionId, AccessPermissionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Containers' AND ControllerName = 'ContentContainer'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'GetAssociatedVariantList')	
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS 
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Containers' AND ControllerName = 'ContentContainer') and ActionId = 
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'GetAssociatedVariantList'))

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'TouchPointConfiguration','Recurring',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'TouchPointConfiguration' and ActionName = 'Recurring')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Site Search')
,(select top 1 ActionId from ZnodeActions where ControllerName = 'TouchPointConfiguration' and ActionName = 'Recurring') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Site Search')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'TouchPointConfiguration' and ActionName = 'Recurring'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Site Search') ,
(select top 1 ActionId from ZnodeActions where ControllerName = 'TouchPointConfiguration' and ActionName = 'Recurring')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Site Search')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'TouchPointConfiguration' and ActionName = 'Recurring'))
GO

--ZPD-16622
Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'Attributes','ValidationRuleRegularExpression',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'Attributes' and ActionName = 'ValidationRuleRegularExpression')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Attributes')
,(select top 1 ActionId from ZnodeActions where ControllerName = 'Attributes' and ActionName = 'ValidationRuleRegularExpression') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Attributes')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'Attributes' and ActionName = 'ValidationRuleRegularExpression'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Attributes') ,
(select top 1 ActionId from ZnodeActions where ControllerName = 'Attributes' and ActionName = 'ValidationRuleRegularExpression')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Attributes')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'Attributes' and ActionName = 'ValidationRuleRegularExpression'))

-- ZPD-15479
INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'Customer','FailedOrderTransactionList',1,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'Customer' and ActionName = 'FailedOrderTransactionList')

INSERT INTO ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
SELECT
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Users' AND ControllerName = 'Customer')
,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Customer' and ActionName = 'FailedOrderTransactionList') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId =
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Users' AND ControllerName = 'Customer') and ActionId =
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Customer' and ActionName = 'FailedOrderTransactionList'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
SELECT
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Users' AND ControllerName = 'Customer'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Customer' and ActionName = 'FailedOrderTransactionList')
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId =
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Users' AND ControllerName = 'Customer') and ActionId =
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Customer' and ActionName = 'FailedOrderTransactionList'))
GO

--dt 19/10/2021 ZPD-16038
Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'Attributes','ValidationRuleRegularExpression',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'Attributes' and ActionName = 'ValidationRuleRegularExpression')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Attributes')
,(select top 1 ActionId from ZnodeActions where ControllerName = 'Attributes' and ActionName = 'ValidationRuleRegularExpression') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Attributes')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'Attributes' and ActionName = 'ValidationRuleRegularExpression'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Attributes') ,
(select top 1 ActionId from ZnodeActions where ControllerName = 'Attributes' and ActionName = 'ValidationRuleRegularExpression')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Attributes')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'Attributes' and ActionName = 'ValidationRuleRegularExpression'))

update ZnodeMenu Set ParentMenuId = (select top 1 MenuId from ZnodeMenu WHERE MenuName = 'CMS' AND ControllerName = 'StoreExperience')
where MenuName = 'Containers' and CSSClassName = 'z-content-widgets' AND ControllerName = 'ContentContainer'

update ZnodeMenu 
Set ParentMenuId = (select top 1 MenuId from ZnodeMenu WHERE MenuName = 'Containers' AND ControllerName = 'ContentContainer'
					and ParentMenuId = (select top 1 MenuId from ZnodeMenu WHERE MenuName = 'CMS' AND ControllerName = 'StoreExperience'))
where MenuName = 'Content Containers' and CSSClassName = 'z-content-widgets' AND ControllerName = 'ContentContainer'

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'ContainerTemplate','Create',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'ContainerTemplate' and ActionName = 'Create')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates')
,(select top 1 ActionId from ZnodeActions where ControllerName = 'ContainerTemplate' and ActionName = 'Create') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'ContainerTemplate' and ActionName = 'Create'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates') ,
(select top 1 ActionId from ZnodeActions where ControllerName = 'ContainerTemplate' and ActionName = 'Create')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'ContainerTemplate' and ActionName = 'Create'))


Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'ContainerTemplate','Edit',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'ContainerTemplate' and ActionName = 'Edit')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates')
,(select top 1 ActionId from ZnodeActions where ControllerName = 'ContainerTemplate' and ActionName = 'Edit') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'ContainerTemplate' and ActionName = 'Edit'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates') ,
(select top 1 ActionId from ZnodeActions where ControllerName = 'ContainerTemplate' and ActionName = 'Edit')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'ContainerTemplate' and ActionName = 'Edit'))

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'ContainerTemplate','Copy',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'ContainerTemplate' and ActionName = 'Copy')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates')
,(select top 1 ActionId from ZnodeActions where ControllerName = 'ContainerTemplate' and ActionName = 'Copy') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'ContainerTemplate' and ActionName = 'Copy'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates') ,
(select top 1 ActionId from ZnodeActions where ControllerName = 'ContainerTemplate' and ActionName = 'Copy')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select top 1 MenuId from ZnodeMenu where MenuName = 'Container Templates')
and ActionId = (select top 1 ActionId from ZnodeActions where ControllerName = 'ContainerTemplate' and ActionName = 'Copy'))

INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'ContentContainer','AssociateContainerTemplate',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'AssociateContainerTemplate')

INSERT INTO ZnodeActionMenu ( MenuId,	ActionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
 (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer')	
    ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'AssociateContainerTemplate') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = 
     (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer') and ActionId = 
     (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'AssociateContainerTemplate'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId,	ActionId, AccessPermissionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'AssociateContainerTemplate')	
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS 
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer') and ActionId = 
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'AssociateContainerTemplate'))

INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'ContentContainer','ActivateDeactivateVariant',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'ActivateDeactivateVariant')

INSERT INTO ZnodeActionMenu ( MenuId,	ActionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
 (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer')	
    ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'ActivateDeactivateVariant') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = 
     (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer') and ActionId = 
     (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'ActivateDeactivateVariant'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId,	ActionId, AccessPermissionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'ActivateDeactivateVariant')	
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS 
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer') and ActionId = 
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'ActivateDeactivateVariant'))

INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'ContentContainer','IsContainerExist',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'IsContainerExist')

INSERT INTO ZnodeActionMenu ( MenuId,	ActionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
 (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer')	
    ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'IsContainerExist') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = 
     (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer') and ActionId = 
     (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'IsContainerExist'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId,	ActionId, AccessPermissionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'IsContainerExist')	
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS 
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer') and ActionId = 
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'IsContainerExist'))

INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'ContentContainer','UpdateAndPublishContentContainer',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'UpdateAndPublishContentContainer')

INSERT INTO ZnodeActionMenu ( MenuId,	ActionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
 (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer')	
    ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'UpdateAndPublishContentContainer') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = 
     (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer') and ActionId = 
     (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'UpdateAndPublishContentContainer'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId,	ActionId, AccessPermissionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'UpdateAndPublishContentContainer')	
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS 
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer') and ActionId = 
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'UpdateAndPublishContentContainer'))

INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'ContentContainer','PublishContentContainer',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'PublishContentContainer')

INSERT INTO ZnodeActionMenu ( MenuId,	ActionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
 (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer')	
    ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'PublishContentContainer') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = 
     (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer') and ActionId = 
     (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'PublishContentContainer'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId,	ActionId, AccessPermissionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'PublishContentContainer')	
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS 
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer') and ActionId = 
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'PublishContentContainer'))

INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'ContentContainer','PublishContainerVariant',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'PublishContainerVariant')

INSERT INTO ZnodeActionMenu ( MenuId,	ActionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
 (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer')	
    ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'PublishContainerVariant') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = 
     (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer') and ActionId = 
     (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'PublishContainerVariant'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId,	ActionId, AccessPermissionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'PublishContainerVariant')	
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS 
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer') and ActionId = 
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'PublishContainerVariant'))

INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'ContentContainer','UpdateAndPublishContainerVariant',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'UpdateAndPublishContainerVariant')

INSERT INTO ZnodeActionMenu ( MenuId,	ActionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
 (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer')	
    ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'UpdateAndPublishContainerVariant') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = 
     (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer') and ActionId = 
     (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'UpdateAndPublishContainerVariant'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId,	ActionId, AccessPermissionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'UpdateAndPublishContainerVariant')	
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS 
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer') and ActionId = 
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'UpdateAndPublishContainerVariant'))

INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'ContentContainer','EditAssociatedVariant',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'EditAssociatedVariant')

INSERT INTO ZnodeActionMenu ( MenuId,	ActionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
 (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer')	
    ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'EditAssociatedVariant') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = 
     (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer') and ActionId = 
     (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'EditAssociatedVariant'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId,	ActionId, AccessPermissionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'EditAssociatedVariant')	
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS 
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer') and ActionId = 
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'EditAssociatedVariant'))

INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'ContainerTemplate','List',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'ContainerTemplate' and ActionName = 'List')

INSERT INTO ZnodeActionMenu ( MenuId,	ActionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
 (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Container Templates' AND ControllerName = 'ContainerTemplate')	
    ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContainerTemplate' and ActionName = 'List') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = 
     (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Container Templates' AND ControllerName = 'ContainerTemplate') and ActionId = 
     (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContainerTemplate' and ActionName = 'List'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId,	ActionId, AccessPermissionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Container Templates' AND ControllerName = 'ContainerTemplate'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContainerTemplate' and ActionName = 'List')	
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS 
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Container Templates' AND ControllerName = 'ContainerTemplate') and ActionId = 
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContainerTemplate' and ActionName = 'List'))


insert INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'Hangfire','Dashboard',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'Hangfire' and ActionName = 'Dashboard')

INSERT INTO ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
SELECT
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Diagnostics & Maintenance' AND ControllerName = 'Diagnostics')
  ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Hangfire' and ActionName = 'Dashboard') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId =
   (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Diagnostics & Maintenance' AND ControllerName = 'Diagnostics') and ActionId =
   (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Hangfire' and ActionName = 'Dashboard'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
SELECT
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Diagnostics & Maintenance' AND ControllerName = 'Diagnostics'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Hangfire' and ActionName = 'Dashboard')
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId =
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Diagnostics & Maintenance' AND ControllerName = 'Diagnostics') and ActionId =
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Hangfire' and ActionName = 'Dashboard'))

GO


Update ZnodeGlobalEntity Set EntityName = 'Content Containers'
WHERE EntityName = 'Content Widgets'
go
IF NOT EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME = 'PortalId' AND TABLE_NAME = 'ZnodeCMSWidgetProfileVariant')
BEGIN
	ALTER TABLE ZnodeCMSWidgetProfileVariant ADD PortalId INT
END
GO
IF EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME = 'PortalId' AND TABLE_NAME = 'ZnodeCMSWidgetProfileVariant')
AND EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME = 'PortalId' AND TABLE_NAME = 'ZnodeCMSContentWidget')
BEGIN
	DECLARE @SQL VARCHAR(MAX) = ''
	SET @SQL = '
	UPDATE A SET a.PortalId = b.PortalId
	FROM ZnodeCMSWidgetProfileVariant A
	INNER JOIN ZnodeCMSContentWidget B ON A.CMSContentWidgetId = B.CMSContentWidgetId
	WHERE a.PortalId IS NULL AND b.PortalId IS NOT NULL'

	EXEC (@SQL)
END
GO
IF EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME = 'PortalId' AND TABLE_NAME = 'ZnodeCMSContentWidget')
BEGIN
	ALTER TABLE ZnodeCMSContentWidget DROP COLUMN PortalId
END

GO

UPDATE A SET a.CreatedBy = b.CreatedBy
FROM ZnodeCMSWidgetProfileVariant A
INNER JOIN ZnodeCMSContentWidget B ON A.CMSContentWidgetId = B.CMSContentWidgetId
WHERE a.CreatedBy IS NULL AND b.CreatedBy IS NOT NULL

UPDATE A SET a.CreatedDate = b.CreatedDate
FROM ZnodeCMSWidgetProfileVariant A
INNER JOIN ZnodeCMSContentWidget B ON A.CMSContentWidgetId = B.CMSContentWidgetId
WHERE a.CreatedDate IS NULL AND b.CreatedDate IS NOT NULL

UPDATE A SET a.ModifiedBy = b.ModifiedBy
FROM ZnodeCMSWidgetProfileVariant A 
INNER JOIN ZnodeCMSContentWidget B ON A.CMSContentWidgetId = B.CMSContentWidgetId
WHERE a.ModifiedBy IS NULL AND b.ModifiedBy IS NOT NULL

UPDATE A SET a.ModifiedDate = b.ModifiedDate
FROM ZnodeCMSWidgetProfileVariant A
INNER JOIN ZnodeCMSContentWidget B ON A.CMSContentWidgetId = B.CMSContentWidgetId
WHERE a.ModifiedDate IS NULL AND b.ModifiedDate IS NOT NULL

GO

UPDATE A SET a.CreatedBy = 2
FROM ZnodeCMSWidgetProfileVariant A
WHERE a.CreatedBy IS NULL

UPDATE A SET a.CreatedDate = getdate()
FROM ZnodeCMSWidgetProfileVariant A
WHERE a.CreatedDate IS NULL

UPDATE A SET a.ModifiedBy = 2
FROM ZnodeCMSWidgetProfileVariant A
WHERE a.ModifiedBy IS NULL

UPDATE A SET a.ModifiedDate = getdate()
FROM ZnodeCMSWidgetProfileVariant A
WHERE a.ModifiedDate IS NULL

GO
if exists(select * from sys.tables where name = 'ZnodeCMSWidgetProfileVariant_Temp')
begin
	Declare @sql2 varchar(max)
	set @sql2 ='
	UPDATE A SET a.CreatedBy = b.CreatedBy, a.CreatedDate = b.CreatedDate,a.ModifiedBy = b.ModifiedBy,a.ModifiedDate = b.ModifiedDate
	from ZnodeCMSWidgetProfileVariant b
	inner join ZnodeCMSWidgetProfileVariant_Temp a on a.CMSWidgetProfileVariantId = b.CMSWidgetProfileVariantId'
	exec (@sql2)
end
go
IF EXISTS(SELECT * FROM SYS.TABLES WHERE NAME = 'ZnodeCMSWidgetProfileVariant_Temp')
AND EXISTS(SELECT * FROM SYS.TABLES WHERE NAME = 'ZnodeCMSWidgetProfileVariantLocale')
BEGIN
	DECLARE @SQL1 VARCHAR(MAX) = ''
	SET @SQL1 = '
	INSERT INTO ZnodeCMSWidgetProfileVariantLocale(CMSWidgetProfileVariantId,CMSWidgetTemplateId,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
	SELECT CMSWidgetProfileVariantId,CMSWidgetTemplateId,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
	FROM ZnodeCMSWidgetProfileVariant_Temp a
	WHERE NOT EXISTS(SELECT * FROM ZnodeCMSWidgetProfileVariantLocale WHERE ZnodeCMSWidgetProfileVariantLocale.CMSWidgetProfileVariantId = a.CMSWidgetProfileVariantId)'

	EXEC (@SQL1)
END
GO
IF (EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodeCMSWidgetProfileVariant' AND COLUMN_NAME='CMSWidgetTemplateId')
AND EXISTS(select * from sys.objects where name =  'FK_ZnodeCMSWidgetProfileLocale_ZnodeLocale'))
BEGIN
	alter table ZnodeCMSWidgetProfileVariant drop constraint FK_ZnodeCMSWidgetProfileLocale_ZnodeCMSWidgetTemplate 
END
GO
IF (EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodeCMSWidgetProfileVariant' AND COLUMN_NAME='LocaleId')
AND EXISTS(select * from sys.objects where name =  'FK_ZnodeCMSWidgetProfileLocale_ZnodeLocale'))
BEGIN
	alter table ZnodeCMSWidgetProfileVariant drop constraint FK_ZnodeCMSWidgetProfileLocale_ZnodeLocale 
END
GO
IF EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME = 'CMSWidgetTemplateId' AND TABLE_NAME = 'ZnodeCMSWidgetProfileVariant')
BEGIN
	ALTER TABLE ZnodeCMSWidgetProfileVariant DROP COLUMN CMSWidgetTemplateId
END
GO
IF EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME = 'LocaleId' AND TABLE_NAME = 'ZnodeCMSWidgetProfileVariant')
BEGIN
	ALTER TABLE ZnodeCMSWidgetProfileVariant DROP COLUMN LocaleId
END

GO
IF EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME = 'CreatedBy' AND TABLE_NAME = 'ZnodeCMSWidgetProfileVariant')
BEGIN
	ALTER TABLE ZnodeCMSWidgetProfileVariant ALTER COLUMN [CreatedBy] INT  NOT  NULL
END
GO
IF EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME = 'CreatedDate' AND TABLE_NAME = 'ZnodeCMSWidgetProfileVariant')
BEGIN
	ALTER TABLE ZnodeCMSWidgetProfileVariant ALTER COLUMN [CreatedDate] DATETIME  NOT  NULL
END
GO
IF EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME = 'ModifiedBy' AND TABLE_NAME = 'ZnodeCMSWidgetProfileVariant')
BEGIN
	ALTER TABLE ZnodeCMSWidgetProfileVariant ALTER COLUMN ModifiedBy INT  NOT  NULL
END
GO
IF EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME = 'ModifiedDate' AND TABLE_NAME = 'ZnodeCMSWidgetProfileVariant')
BEGIN
	ALTER TABLE ZnodeCMSWidgetProfileVariant ALTER COLUMN ModifiedDate DATETIME  NOT  NULL
END
GO
IF EXISTS(SELECT * FROM SYS.TABLES WHERE NAME = 'ZnodeCMSWidgetProfileVariant_Temp')
 BEGIN
	DROP TABLE ZnodeCMSWidgetProfileVariant_Temp
 END

 GO

 SET IDENTITY_INSERT [dbo].[ZnodeCMSContentContainer] ON 
GO
INSERT [dbo].[ZnodeCMSContentContainer] ([CMSContentContainerId], [Name], [ContainerKey], [FamilyId], [Tags], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [PublishStateId]) 
SELECT [CMSContentWidgetId], [Name], [WidgetKey], [FamilyId], [Tags], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], NULL
FROM ZnodeCMSContentWidget
WHERE CMSContentWidgetId NOT IN (SELECT CMSContentContainerId FROM [ZnodeCMSContentContainer])
GO
SET IDENTITY_INSERT [dbo].[ZnodeCMSContentContainer] OFF
GO


SET IDENTITY_INSERT [dbo].[ZnodeCMSContainerTemplate] ON 
GO
INSERT [dbo].[ZnodeCMSContainerTemplate] ([CMSContainerTemplateId], [Code], [Name], [FileName], [MediaId], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT [CMSWidgetTemplateId], [Code], [Name], [FileName], [MediaId], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]
FROM ZnodeCMSWidgetTemplate
WHERE CMSWidgetTemplateId NOT IN (SELECT CMSContainerTemplateId FROM [ZnodeCMSContainerTemplate])
GO
SET IDENTITY_INSERT [dbo].[ZnodeCMSContainerTemplate] OFF
GO


SET IDENTITY_INSERT [dbo].[ZnodeCMSContainerProfileVariant] ON 
GO
INSERT [dbo].[ZnodeCMSContainerProfileVariant] ([CMSContainerProfileVariantId], [CMSContentContainerId], [ProfileId], [PortalId], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT [CMSWidgetProfileVariantId], [CMSContentWidgetId], [ProfileId], [PortalId], isnull([CreatedBy],2), isnull([CreatedDate],getdate()), isnull([ModifiedBy],2), isnull([ModifiedDate],getdate())
FROM ZnodeCMSWidgetProfileVariant
WHERE CMSWidgetProfileVariantId NOT IN (SELECT CMSContainerProfileVariantId FROM [ZnodeCMSContainerProfileVariant])
GO
SET IDENTITY_INSERT [dbo].[ZnodeCMSContainerProfileVariant] OFF


GO
SET IDENTITY_INSERT [dbo].[ZnodeCMSContainerProfileVariantLocale] ON 
GO
INSERT [dbo].[ZnodeCMSContainerProfileVariantLocale] ([CMSContainerProfileVariantLocaleId], [CMSContainerProfileVariantId], [CMSContainerTemplateId], [LocaleId], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsActive]) 
SELECT [CMSWidgetProfileVariantLocaleId], [CMSWidgetProfileVariantId], [CMSWidgetTemplateId], [LocaleId], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], 1
FROM ZnodeCMSWidgetProfileVariantLocale
WHERE CMSWidgetProfileVariantLocaleId NOT IN (SELECT CMSContainerProfileVariantLocaleId FROM [ZnodeCMSContainerProfileVariantLocale])
GO
SET IDENTITY_INSERT [dbo].[ZnodeCMSContainerProfileVariantLocale] OFF

GO

INSERT INTO ZnodeGlobalEntity(EntityName, IsActive, TableName, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, IsFamilyUnique)
SELECT 'Content Containers', 1, 'ZnodeWidgetGlobalAttributeValue', 2, getdate(), 2, getdate(), 0
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers')

Update ZnodeGlobalEntity set IsFamilyUnique = 0 where EntityName = 'Content Containers' 

GO

Update ZnodeApplicationSetting
set Setting = '<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>ContainerTemplateId</name>      <headertext>Checkbox</headertext>      <width>30</width>      <datatype>Int32</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>Image</name>      <headertext>Image</headertext>      <width>20</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>MediaPath,Name</imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>imageicon</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>Code</name>      <headertext>Template Code</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>Name</name>      <headertext>Template Name</headertext>      <width>60</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>y</isallowlink>      <islinkactionurl>/ContainerTemplate/Edit</islinkactionurl>      <islinkparamfield>Code</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>FileName</name>      <headertext>File Name</headertext>      <width>60</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>CreatedByName</name>      <headertext>Created By</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>CreatedDate</name>      <headertext>Created Date</headertext>      <width>0</width>      <datatype>DateTime</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>yyyy-MM-dd HH:mm:ss</format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>ModifiedByName</name>      <headertext>Modified By</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>9</id>      <name>ModifiedDate</name>      <headertext>Modified Date</headertext>      <width>0</width>      <datatype>DateTime</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>yyyy-MM-dd HH:mm:ss</format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>10</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>Edit|Download|Copy|Delete</format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Edit|Download|Copy|Delete</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/ContainerTemplate/Edit|/ContainerTemplate/DownloadWidgetTemplate|/ContainerTemplate/Copy|/ContainerTemplate/Delete</manageactionurl>      <manageparamfield>Code|ContainerTemplateId,FileName|Code|ContainerTemplateId,FileName</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
where ItemName = 'ZnodeCMSWidgetTemplate'

Update ZnodeApplicationSetting
Set Setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>ContentContainerId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>ContainerKey</name><headertext>Container Key</headertext><width>60</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>Tags</name><headertext>Tags</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>CreatedByName</name><headertext>Created By</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>CreatedDate</name><headertext>Created Date</headertext><width>0</width><datatype>DateTime</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format>yyyy-MM-dd HH:mm:ss</format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>ModifiedByName</name><headertext>Modified By</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>ModifiedDate</name><headertext>Modified Date</headertext><width>0</width><datatype>DateTime</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format>yyyy-MM-dd HH:mm:ss</format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>PublishStatus</name><headertext>Publish Status</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>9</id><name>Manage</name><headertext>Action</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>Edit|Delete|Publish</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Delete|Publish</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/ContentContainer/Edit|/ContentContainer/Delete|/ContentContainer/PublishContentContainer</manageactionurl><manageparamfield>containerKey|contentContainerId|ContainerKey,TargetPublishState</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName ='ZnodeCMSContentContainer'

Update ZnodeApplicationSetting
Set Setting = '<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>ContainerTemplateId</name>      <headertext>Checkbox</headertext>      <width>30</width>      <datatype>Int32</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>Image</name>      <headertext>Image</headertext>      <width>20</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>MediaPath,Name</imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>imageicon</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>Code</name>      <headertext>Template Code</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>Name</name>      <headertext>Template Name</headertext>      <width>60</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>y</isallowlink>      <islinkactionurl>/ContainerTemplate/Edit</islinkactionurl>      <islinkparamfield>Code</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>FileName</name>      <headertext>File Name</headertext>      <width>60</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>CreatedByName</name>      <headertext>Created By</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>CreatedDate</name>      <headertext>Created Date</headertext>      <width>0</width>      <datatype>DateTime</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>yyyy-MM-dd HH:mm:ss</format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>ModifiedByName</name>      <headertext>Modified By</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>9</id>      <name>ModifiedDate</name>      <headertext>Modified Date</headertext>      <width>0</width>      <datatype>DateTime</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>yyyy-MM-dd HH:mm:ss</format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>10</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>Edit|Download|Copy|Delete</format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Edit|Download|Copy|Delete</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/ContainerTemplate/Edit|/ContainerTemplate/DownloadWidgetTemplate|/ContainerTemplate/Copy|/ContainerTemplate/Delete</manageactionurl>      <manageparamfield>Code|ContainerTemplateId,FileName|Code|ContainerTemplateId,FileName</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
where ItemName = 'ZnodeCMSWidgetTemplate'

Update ZnodeApplicationSetting
Set Setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>ContentContainerId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>ContainerKey</name><headertext>Container Key</headertext><width>60</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>Tags</name><headertext>Tags</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>CreatedByName</name><headertext>Created By</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>CreatedDate</name><headertext>Created Date</headertext><width>0</width><datatype>DateTime</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format>yyyy-MM-dd HH:mm:ss</format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>ModifiedByName</name><headertext>Modified By</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>ModifiedDate</name><headertext>Modified Date</headertext><width>0</width><datatype>DateTime</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format>yyyy-MM-dd HH:mm:ss</format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>PublishStatus</name><headertext>Publish Status</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>9</id><name>Manage</name><headertext>Action</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>Edit|Delete|Publish</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Delete|Publish</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/ContentContainer/Edit|/ContentContainer/Delete|/ContentContainer/PublishContentContainer</manageactionurl><manageparamfield>containerKey|contentContainerId|ContainerKey,TargetPublishState</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName = 'ZnodeCMSContentContainer'

Update ZnodeApplicationSetting
Set Setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>ContainerProfileVariantId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>ContainerProfileVariantId</name><headertext>Container Profile Variant Id</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>StoreName</name><headertext>Store Name</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>StoreCode</name><headertext>Store Code</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>ProfileName</name><headertext>User Profile</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>ProfileCode</name><headertext>User Profile Code</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>PublishStatus</name><headertext>Publish Status</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>Status</name><headertext>Is Active</headertext><width>0</width><datatype>Boolean</datatype><columntype>Boolean</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>9</id><name>CreatedByName</name><headertext>Created By</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>10</id><name>CreatedDate</name><headertext>Created Date</headertext><width>0</width><datatype>DateTime</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>11</id><name>ModifiedByName</name><headertext>Modified By</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>12</id><name>ModifiedDate</name><headertext>Modified Date</headertext><width>0</width><datatype>DateTime</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>13</id><name>Manage</name><headertext>Action</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>Edit|Delete|Disable|Publish</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>Id</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Delete|Disable|Publish</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/ContentContainer/EditAssociatedVariant|/ContentContainer/DeleteAssociatedVariant|/ContentContainer/ActivateDeactivateVariant|/ContentContainer/PublishContainerVariant</manageactionurl><manageparamfield>ContainerProfileVariantId|ContainerProfileVariantId,ContainerKey|ContainerProfileVariantId,IsActive|ContainerKey,ContainerProfileVariantId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName = 'ZnodeCMSAssociatedVariant'

GO

INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'ContainerTemplate','Delete',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'ContainerTemplate' and ActionName = 'Delete')

INSERT INTO ZnodeActionMenu ( MenuId,	ActionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
 (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Container Templates' AND ControllerName = 'ContainerTemplate')	
    ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContainerTemplate' and ActionName = 'Delete') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = 
     (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Container Templates' AND ControllerName = 'ContainerTemplate') and ActionId = 
     (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContainerTemplate' and ActionName = 'Delete'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId,	ActionId, AccessPermissionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Container Templates' AND ControllerName = 'ContainerTemplate'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContainerTemplate' and ActionName = 'Delete')	
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS 
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Container Templates' AND ControllerName = 'ContainerTemplate') and ActionId = 
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContainerTemplate' and ActionName = 'Delete'))

INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'ContainerTemplate','DownloadWidgetTemplate',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'ContainerTemplate' and ActionName = 'DownloadWidgetTemplate')

INSERT INTO ZnodeActionMenu ( MenuId,	ActionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
 (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Container Templates' AND ControllerName = 'ContainerTemplate')	
    ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContainerTemplate' and ActionName = 'DownloadWidgetTemplate') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = 
     (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Container Templates' AND ControllerName = 'ContainerTemplate') and ActionId = 
     (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContainerTemplate' and ActionName = 'DownloadWidgetTemplate'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId,	ActionId, AccessPermissionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Container Templates' AND ControllerName = 'ContainerTemplate'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContainerTemplate' and ActionName = 'DownloadWidgetTemplate')	
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS 
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Container Templates' AND ControllerName = 'ContainerTemplate') and ActionId = 
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContainerTemplate' and ActionName = 'DownloadWidgetTemplate'))

INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'ContainerTemplate','IsContainerTemplateExist',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'ContainerTemplate' and ActionName = 'IsContainerTemplateExist')

INSERT INTO ZnodeActionMenu ( MenuId,	ActionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
 (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Container Templates' AND ControllerName = 'ContainerTemplate')	
    ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContainerTemplate' and ActionName = 'IsContainerTemplateExist') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = 
     (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Container Templates' AND ControllerName = 'ContainerTemplate') and ActionId = 
     (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContainerTemplate' and ActionName = 'IsContainerTemplateExist'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId,	ActionId, AccessPermissionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Container Templates' AND ControllerName = 'ContainerTemplate'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContainerTemplate' and ActionName = 'IsContainerTemplateExist')	
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS 
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Container Templates' AND ControllerName = 'ContainerTemplate') and ActionId = 
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContainerTemplate' and ActionName = 'IsContainerTemplateExist'))


INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'ContentContainer','GetAttributesDataOnLocaleChange',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'GetAttributesDataOnLocaleChange')

INSERT INTO ZnodeActionMenu ( MenuId,	ActionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
 (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer')	
    ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'GetAttributesDataOnLocaleChange') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = 
     (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer') and ActionId = 
     (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'GetAttributesDataOnLocaleChange'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId,	ActionId, AccessPermissionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'GetAttributesDataOnLocaleChange')	
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS 
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer') and ActionId = 
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'GetAttributesDataOnLocaleChange'))

GO

Update ZnodeApplicationSetting
set Setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>PimDownloadableProductKeyId</name><headertext>Checkbox</headertext><width>40</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>ID</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>SKU</name><headertext>SKU</headertext><width>50</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>ProductId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>ProductId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Code</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>DownloadableProductKey</name><headertext>Product Key</headertext><width>50</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>150</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>ProductId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>ProductId</checkboxparamfield><iscontrol>y</iscontrol><controltype>Text</controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>DownloadableProductURL</name><headertext>Download URL</headertext><width>50</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>150</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>ProductId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>ProductId</checkboxparamfield><iscontrol>y</iscontrol><controltype>Text</controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>IsUsed</name><headertext>Is Used</headertext><width>40</width><datatype>Boolean</datatype><columntype>Boolean</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>LocaleId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class>z-isused</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>Manage</name><headertext>Action</headertext><width>50</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>Edit|Delete</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>productId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>Id</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/Inventory/UpdateDownloadableProductKey|/Inventory/DeleteDownloadableProductKeys</manageactionurl><manageparamfield>PimDownloadableProductKeyId|PimDownloadableProductKeyId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName='ZnodePimDownloadableProductKeyForInventory'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ActivateDeactivateAssociatedVariants')
	DROP PROC Znode_ActivateDeactivateAssociatedVariants

GO

CREATE PROCEDURE [dbo].[Znode_ActivateDeactivateAssociatedVariants]
(
	@ContainerProfileVariantIds VARCHAR(2000),
	@IsActivate BIT,
	@status BIT OUT
)
AS
--EXEC Znode_ActivateDeactivateAssociatedVariants '1019,1021,1027',0,0
BEGIN
	BEGIN TRY
	BEGIN TRAN ActDeactivateAssociatedVariant
		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();

		DECLARE @TBL_CMSContainerProfileVariant TABLE(CMSContainerProfileVariantId INT);

		DECLARE @VariantIdsCnt INT;

		INSERT INTO @TBL_CMSContainerProfileVariant (CMSContainerProfileVariantId)
		SELECT item FROM dbo.Split(@ContainerProfileVariantIds,',')

		SELECT @VariantIdsCnt=COUNT(1)
		FROM @TBL_CMSContainerProfileVariant;

		IF EXISTS (	SELECT TOP 1 1 FROM ZnodeCMSContainerProfileVariant CPV
					INNER JOIN @TBL_CMSContainerProfileVariant TCPV ON TCPV.CMSContainerProfileVariantId=CPV.CMSContainerProfileVariantId
					WHERE (CPV.ProfileId IS NULL AND CPV.PortalId IS NULL)
					) AND (@VariantIdsCnt=1)
		BEGIN
			SET @Status = 0;
			SELECT 1 AS ID, @Status AS [Status];
		END

		ELSE
		BEGIN
			UPDATE CPVL
			SET CPVL.IsActive=@IsActivate, CPVL.ModifiedDate=@GetDate
			FROM ZnodeCMSContainerProfileVariant CPV
			INNER JOIN @TBL_CMSContainerProfileVariant TCPV ON TCPV.CMSContainerProfileVariantId=CPV.CMSContainerProfileVariantId
			INNER JOIN ZnodeCMSContainerProfileVariantLocale CPVL ON CPV.CMSContainerProfileVariantId=CPVL.CMSContainerProfileVariantId
			WHERE (CPV.ProfileId IS NOT NULL OR CPV.PortalId IS NOT NULL);

			SET @Status = 1;
			SELECT 1 AS ID, CAST(1 AS BIT) AS [Status];
		END
	COMMIT TRAN ActDeactivateAssociatedVariant;
	END TRY

	BEGIN CATCH
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
			@ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ActivateDeactivateAssociatedVariants 
			@ContainerProfileVariantIds = '+@ContainerProfileVariantIds+',@IsActivate='+CAST(@IsActivate AS VARCHAR(50))+',
			@Status='+CAST(@Status AS VARCHAR(50));

		SET @Status =0
		SELECT 1 AS ID,@Status AS Status;
		ROLLBACK TRAN ActDeactivateAssociatedVariant;
		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ActivateDeactivateAssociatedVariants',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;

	END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ActivateDeactivateAssociatedVariants')
	DROP PROC Znode_ActivateDeactivateAssociatedVariants

GO

CREATE PROCEDURE [dbo].[Znode_ActivateDeactivateAssociatedVariants]
(
	@ContainerProfileVariantIds VARCHAR(2000),
	@IsActivate BIT,
	@status BIT OUT
)
AS
--EXEC Znode_ActivateDeactivateAssociatedVariants '1019,1021,1027',0,0
BEGIN
	BEGIN TRY
	BEGIN TRAN ActDeactivateAssociatedVariant
		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();

		DECLARE @TBL_CMSContainerProfileVariant TABLE(CMSContainerProfileVariantId INT);

		DECLARE @VariantIdsCnt INT;

		INSERT INTO @TBL_CMSContainerProfileVariant (CMSContainerProfileVariantId)
		SELECT item FROM dbo.Split(@ContainerProfileVariantIds,',')

		SELECT @VariantIdsCnt=COUNT(1)
		FROM @TBL_CMSContainerProfileVariant;

		IF EXISTS (	SELECT TOP 1 1 FROM ZnodeCMSContainerProfileVariant CPV
					INNER JOIN @TBL_CMSContainerProfileVariant TCPV ON TCPV.CMSContainerProfileVariantId=CPV.CMSContainerProfileVariantId
					WHERE (CPV.ProfileId IS NULL AND CPV.PortalId IS NULL)
					) AND (@VariantIdsCnt=1)
		BEGIN
			IF (@IsActivate=1)
			BEGIN
				SET @Status = 1;
				SELECT 1 AS ID, CAST(1 AS BIT) AS [Status];
			END
			ELSE
			BEGIN
				SET @Status = 0;
				SELECT 1 AS ID, @Status AS [Status];
			END
		END

		ELSE
		BEGIN
			UPDATE CPVL
			SET CPVL.IsActive=@IsActivate, CPVL.ModifiedDate=@GetDate
			FROM ZnodeCMSContainerProfileVariant CPV
			INNER JOIN @TBL_CMSContainerProfileVariant TCPV ON TCPV.CMSContainerProfileVariantId=CPV.CMSContainerProfileVariantId
			INNER JOIN ZnodeCMSContainerProfileVariantLocale CPVL ON CPV.CMSContainerProfileVariantId=CPVL.CMSContainerProfileVariantId
			WHERE (CPV.ProfileId IS NOT NULL OR CPV.PortalId IS NOT NULL);

			SET @Status = 1;
			SELECT 1 AS ID, CAST(1 AS BIT) AS [Status];
		END
	COMMIT TRAN ActDeactivateAssociatedVariant;
	END TRY

	BEGIN CATCH
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
			@ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ActivateDeactivateAssociatedVariants 
			@ContainerProfileVariantIds = '+@ContainerProfileVariantIds+',@IsActivate='+CAST(@IsActivate AS VARCHAR(50))+',
			@Status='+CAST(@Status AS VARCHAR(50));

		SET @Status =0
		SELECT 1 AS ID,@Status AS Status;
		ROLLBACK TRAN ActDeactivateAssociatedVariant;
		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ActivateDeactivateAssociatedVariants',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;

	END CATCH
END

GO

Update ZnodeSearchQueryType set QueryTypeName = 'Multi Match - Best' where QueryTypeName = 'Best' 
Update ZnodeSearchQueryType set QueryTypeName = 'Multi Match - Cross' where QueryTypeName = 'Cross'

Update ZnodeSearchQueryType
set HelpDescription = 'When Multi Match query type is configured, the application searches keywords in more than one searchable field to display results on the Web Store. Best: Should be used when the searched term must appear in any one searchable field'
where QueryTypeName = 'Multi Match - Best' and not exists (select * from ZnodeSearchQueryType where QueryTypeName = 'Multi Match - Best' and HelpDescription like 'When Multi Match%')

Update ZnodeSearchQueryType
set HelpDescription = 'When Multi Match query type is configured, the application searches keywords in more than one searchable field to display results on the Web Store. Cross: Should be used when the searched term can be spread across multiple searchable fields'
where QueryTypeName = 'Multi Match - Cross' and not exists (select * from ZnodeSearchQueryType where QueryTypeName = 'Multi Match - Cross' and HelpDescription like 'When Multi Match%')

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetCMSContainerlist')
	DROP PROC Znode_GetCMSContainerlist

GO

CREATE PROCEDURE [dbo].[Znode_GetCMSContainerlist]  
(    
  @WhereClause NVARCHAR(Max)       
 ,@Rows INT = 100       
 ,@PageNo INT = 1       
 ,@Order_BY VARCHAR(1000) = ''    
 ,@RowsCount INT OUT    
)    
AS    
--EXEC Znode_GetCMSContainerlist @WhereClause = '',@RowsCount=0
BEGIN      
BEGIN TRY     
SET NOCOUNT ON        
	DECLARE @SQL NVARCHAR(MAX)    
	DECLARE @TBL_ContentContainer TABLE (ContentContainerId INT,ContainerKey NVARCHAR(max),Tags NVARCHAR(max),PublishStatus VARCHAR(32),CreatedByName NVARCHAR(600),CreatedDate DATETIME,ModifiedByName NVARCHAR(600),ModifiedDate DATETIME,RowId INT,CountNo INT)  
	
	IF OBJECT_ID('TEMPDB..#User') IS NOT NULL
		DROP TABLE #User

	SELECT ZU.UserId, ZU.UserName
	INTO #User
	FROM ZnodeUser ZU
	WHERE EXISTS(SELECT * FROM ZnodeCMSContentContainer ZCW WHERE ZU.UserId = ZCW.CreatedBy OR ZU.UserId = ZCW.ModifiedBy)

	
	SET @SQL = '   
	;With Cte_ContentContainer AS   
	(  
		SELECT DISTINCT ZCW.CMSContentContainerId, ZCW.ContainerKey as ContainerKey, ZCW.Tags, ZPS.DisplayName As PublishStatus ,U.UserName AS CreatedByName,ZCW.CreatedDate,U1.UserName AS ModifiedByName,ZCW.ModifiedDate
		FROM ZnodeCMSContentContainer ZCW
		LEFT JOIN ZnodePublishState ZPS ON ZCW.PublishStateId=ZPS.PublishStateId
		INNER JOIN #User U ON U.UserId = ZCW.CreatedBy
		INNER JOIN #User U1 ON U1.UserId = ZCW.ModifiedBy
	)  
	,Cte_ContentContainerList AS
	(
		SELECT CMSContentContainerId, ContainerKey, Tags,PublishStatus,CreatedByName,CreatedDate,ModifiedByName,ModifiedDate,
		'+dbo.Fn_GetPagingRowId(@Order_BY,'ContainerKey ASC')+',Count(*)Over() CountNo 
		FROM Cte_ContentContainer    
		WHERE 1=1 '+dbo.Fn_GetFilterWhereClause(@WhereClause)+'    
	)
	SELECT CMSContentContainerId,ContainerKey,Tags,PublishStatus,CreatedByName,CreatedDate,ModifiedByName,ModifiedDate,RowId,CountNo    
	FROM Cte_ContentContainerList   
	'+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows)  

	INSERT INTO @TBL_ContentContainer (ContentContainerId,ContainerKey,Tags,PublishStatus,CreatedByName,CreatedDate,ModifiedByName,ModifiedDate,RowId,CountNo)  
	EXEC (@SQL)  
	SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM @TBL_ContentContainer ),0)  

	SELECT ContentContainerId,ContainerKey,Tags,PublishStatus,CreatedByName,CreatedDate,ModifiedByName,ModifiedDate
	FROM @TBL_ContentContainer  
	ORDER BY RowId

END TRY    
BEGIN CATCH    
	DECLARE @Status BIT ;    
	SET @Status = 0;    
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= 
	ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 
	'EXEC Znode_GetCMSContainerlist @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',
	@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',
	@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));    
                      
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                       
        
	EXEC Znode_InsertProcedureErrorLog    
	@ProcedureName = 'Znode_GetCMSContainerlist',    
	@ErrorInProcedure = @Error_procedure,    
	@ErrorMessage = @ErrorMessage,    
	@ErrorLine = @ErrorLine,    
	@ErrorCall = @ErrorCall;                                
END CATCH; 
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetCMSContainerProfileVariantlist')
	DROP PROC Znode_GetCMSContainerProfileVariantlist

GO

CREATE PROCEDURE [dbo].[Znode_GetCMSContainerProfileVariantlist]
(
	@WhereClause NVARCHAR(MAX)
	,@ContainerKey NVARCHAR(MAX)
	,@Rows INT = 100   
	,@PageNo INT = 1   
	,@Order_BY VARCHAR(1000) = ''
	,@RowsCount INT OUT
)
AS
-- EXEC Znode_GetCMSContainerProfileVariantlist '','',0,0,'',0
BEGIN  
BEGIN TRY 
SET NOCOUNT ON
	DECLARE @SQL NVARCHAR(MAX)
	CREATE TABLE #TBL_ContentContainer (CMSContainerProfileVariantId INT, ContainerKey NVARCHAR(MAX), PortalId INT, StoreName NVARCHAR(MAX), ProfileName NVARCHAR(200),CreatedByName VARCHAR(500), CreatedDate DATETIME, ModifiedByName VARCHAR(500),
		ModifiedDate DATETIME, IsDefaultVarient BIT,StoreCode VARCHAR(200),ProfileCode Varchar(200),RowId INT,CountNo INT,IsActive BIT,PublishStatus VARCHAR(32))  
	
	SELECT CAST(UserName AS NVARCHAR(500)) AS UserName , ZU.UserId
	INTO #Users
	FROM ZnodeUser ZU WITH (NOLOCK)
	WHERE EXISTS( SELECT * FROM ZnodeCMSContainerProfileVariant CWPV WHERE ZU.UserId = CWPV.CreatedBy )
	UNION
	SELECT UserName, ZU.UserId
	FROM ZnodeUser ZU
	WHERE EXISTS( SELECT * FROM ZnodeCMSContainerProfileVariant CWPV WHERE ZU.UserId = CWPV.ModifiedBy )

	SELECT DISTINCT WPV.CMSContainerProfileVariantId, ZCW.ContainerKey, WPV.PortalId, --ZCW.Tags,
		CASE WHEN WPV.PortalId IS NULL THEN  'Any Store' ELSE ZP.StoreName END StoreName  ,
		CASE WHEN WPV.ProfileId IS NULL THEN  'Any User Profile' ELSE ZPr.ProfileName END ProfileName, 
		U.UserName AS CreatedByName, WPV.CreatedDate, U1.UserName AS ModifiedByName, WPV.ModifiedDate,
		CAST(CASE WHEN WPV.ProfileId IS NULL AND WPV.PortalId IS NULL THEN 1 ELSE 0 END AS BIT) AS IsDefaultVarient,
		CASE WHEN WPV.PortalId IS NULL THEN  'AnyStore' ELSE ZP.StoreCode END StoreCode ,
		CASE WHEN WPV.ProfileId IS NULL THEN  'AnyUserProfile' ELSE ZPr.DefaultExternalAccountNo END ProfileCode,
		CPVL.IsActive As Status,ZPS.DisplayName As PublishStatus
	INTO #Cte_ContentContainerVarient
	FROM ZnodeCMSContentContainer ZCW 
	INNER JOIN ZnodeCMSContainerProfileVariant WPV ON WPV.CMSContentContainerId = ZCW.CMSContentContainerId
	LEFT JOIN ZnodeCMSContainerProfileVariantLocale CPVL ON WPV.CMSContainerProfileVariantId=CPVL.CMSContainerProfileVariantId
	LEFT JOIN ZnodePublishState ZPS ON WPV.PublishStateId=ZPS.PublishStateId
	LEFT JOIN ZnodePortal ZP ON (WPV.PortalId = ZP.PortalId ) 
	LEFT JOIN ZnodeProfile ZPr ON WPV.ProfileId = ZPr.ProfileId
	INNER JOIN #Users U ON WPV.CreatedBy = U.UserId
	INNER JOIN #Users U1 ON WPV.ModifiedBy = U1.UserId
	WHERE ZCW.ContainerKey = @ContainerKey 

	SET @SQL = '   
	;With Cte_ContentContainerVarientList AS
	(
		SELECT CMSContainerProfileVariantId, ContainerKey, PortalId, StoreName, ProfileName,CreatedByName, CreatedDate, ModifiedByName, ModifiedDate, IsDefaultVarient,StoreCode,ProfileCode,
		'+dbo.Fn_GetPagingRowId(@Order_BY,'IsDefaultVarient ASC,CMSContainerProfileVariantId DESC')+',Count(*)Over() CountNo,Status,PublishStatus
		FROM #Cte_ContentContainerVarient
		WHERE 1=1 '+dbo.Fn_GetFilterWhereClause(@WhereClause)+'
	)
	INSERT INTO #TBL_ContentContainer 
	SELECT * 
	FROM Cte_ContentContainerVarientList

	SELECT CMSContainerProfileVariantId as ContainerProfileVariantId, ContainerKey, PortalId, StoreName, ProfileName,CreatedByName, CreatedDate, ModifiedByName, ModifiedDate, IsDefaultVarient ,StoreCode,ProfileCode,IsActive,PublishStatus
	FROM #TBL_ContentContainer   
	'+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows) +'
	 ORDER BY RowId'

	EXEC (@SQL)
	SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM #TBL_ContentContainer ),0)  

END TRY
BEGIN CATCH
	DECLARE @Status BIT ;
	SET @Status = 0;
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= 
	ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 
	'EXEC Znode_GetCMSContainerProfileVariantlist @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',
	@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',
	@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));

	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;   

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_GetCMSContainerProfileVariantlist',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
END CATCH; 
END;

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodePublishContentContainerVariantEntity')
BEGIN
	CREATE TABLE [dbo].[ZnodePublishContentContainerVariantEntity](
		[PublishContentContainerVariantEntityId] [int] IDENTITY(1,1) NOT NULL,
		[VersionId] [int] NOT NULL,
		[PortalId] [int] NULL,
		[LocaleId] [int] NOT NULL,
		[Name] [nvarchar](100) NOT NULL,
		[ContainerKey] [nvarchar](50) NOT NULL,
		[CMSContentContainerId] [int] NOT NULL,
		[ProfileId] [int] NULL,
		[CMSContainerTemplateId] [int] NULL,
		[CreatedBy] [int] NOT NULL,
		[CreatedDate] [datetime] NOT NULL,
		[ModifiedBy] [int] NOT NULL,
		[ModifiedDate] [datetime] NOT NULL,
		[CMSContainerProfileVariantId] [int] NULL,
		[GlobalAttributes] [nvarchar](max) NULL,
	 CONSTRAINT [PK_ZnodePublishContentContainerVariantEntity] PRIMARY KEY CLUSTERED 
	(
		[PublishContentContainerVariantEntityId] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
	) ON [PRIMARY]

	ALTER TABLE [dbo].[ZnodePublishContentContainerVariantEntity]  WITH NOCHECK ADD  CONSTRAINT [FK_ZnodePublishContentContainerVariantEntity_CMSContainerTemplateId] FOREIGN KEY([CMSContainerTemplateId])
	REFERENCES [dbo].[ZnodeCMSContainerTemplate] ([CMSContainerTemplateId])

	ALTER TABLE [dbo].[ZnodePublishContentContainerVariantEntity] CHECK CONSTRAINT [FK_ZnodePublishContentContainerVariantEntity_CMSContainerTemplateId]

	ALTER TABLE [dbo].[ZnodePublishContentContainerVariantEntity]  WITH CHECK ADD  CONSTRAINT [FK_ZnodePublishContentContainerVariantEntity_LocaleId] FOREIGN KEY([LocaleId])
	REFERENCES [dbo].[ZnodeLocale] ([LocaleId])

	ALTER TABLE [dbo].[ZnodePublishContentContainerVariantEntity] CHECK CONSTRAINT [FK_ZnodePublishContentContainerVariantEntity_LocaleId]

	ALTER TABLE [dbo].[ZnodePublishContentContainerVariantEntity]  WITH NOCHECK ADD  CONSTRAINT [FK_ZnodePublishContentContainerVariantEntity_PortalId] FOREIGN KEY([PortalId])
	REFERENCES [dbo].[ZnodePortal] ([PortalId])

	ALTER TABLE [dbo].[ZnodePublishContentContainerVariantEntity] CHECK CONSTRAINT [FK_ZnodePublishContentContainerVariantEntity_PortalId]

	ALTER TABLE [dbo].[ZnodePublishContentContainerVariantEntity]  WITH NOCHECK ADD  CONSTRAINT [FK_ZnodePublishContentContainerVariantEntity_ProfileId] FOREIGN KEY([ProfileId])
	REFERENCES [dbo].[ZnodeProfile] ([ProfileId])

	ALTER TABLE [dbo].[ZnodePublishContentContainerVariantEntity] CHECK CONSTRAINT [FK_ZnodePublishContentContainerVariantEntity_ProfileId]

	ALTER TABLE [dbo].[ZnodePublishContentContainerVariantEntity]  WITH CHECK ADD  CONSTRAINT [FK_ZnodePublishContentContainerVariantEntity_ZnodeCMSContainerProfileVariant] FOREIGN KEY([CMSContainerProfileVariantId])
	REFERENCES [dbo].[ZnodeCMSContainerProfileVariant] ([CMSContainerProfileVariantId])

	ALTER TABLE [dbo].[ZnodePublishContentContainerVariantEntity] CHECK CONSTRAINT [FK_ZnodePublishContentContainerVariantEntity_ZnodeCMSContainerProfileVariant]
END 

GO

IF EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'PortalId'
AND Object_ID = Object_ID(N'dbo.ZnodePublishContentContainerVariantEntity'))
BEGIN
	ALTER TABLE ZnodePublishContentContainerVariantEntity ALTER COLUMN PortalId INT NULL
END

GO

IF EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'ProfileId'
AND Object_ID = Object_ID(N'dbo.ZnodePublishContentContainerVariantEntity'))
BEGIN
	ALTER TABLE ZnodePublishContentContainerVariantEntity ALTER COLUMN ProfileId INT NULL
END

GO

IF EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'CMSContainerTemplateId'
AND Object_ID = Object_ID(N'dbo.ZnodePublishContentContainerVariantEntity'))
BEGIN
	ALTER TABLE ZnodePublishContentContainerVariantEntity ALTER COLUMN CMSContainerTemplateId INT NULL
END

GO

IF EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'CMSContainerProfileVariantId'
AND Object_ID = Object_ID(N'dbo.ZnodePublishContentContainerVariantEntity'))
BEGIN
	ALTER TABLE ZnodePublishContentContainerVariantEntity ALTER COLUMN CMSContainerProfileVariantId INT NULL
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns
WHERE Name = N'GlobalAttributes'
AND Object_ID = Object_ID(N'dbo.ZnodePublishContentContainerVariantEntity'))
BEGIN
	ALTER TABLE ZnodePublishContentContainerVariantEntity ADD GlobalAttributes NVARCHAR(MAX) NULL;
END

GO

IF NOT EXISTS (SELECT * 
  FROM sys.foreign_keys 
   WHERE object_id = OBJECT_ID(N'FK_ZnodePublishContentContainerVariantEntity_CMSContainerTemplateId')
   AND parent_object_id = OBJECT_ID(N'dbo.ZnodePublishContentContainerVariantEntity')
)
BEGIN
	ALTER TABLE [dbo].[ZnodePublishContentContainerVariantEntity]  WITH NOCHECK ADD  CONSTRAINT [FK_ZnodePublishContentContainerVariantEntity_CMSContainerTemplateId] FOREIGN KEY([CMSContainerTemplateId])
	REFERENCES [dbo].[ZnodeCMSContainerTemplate] ([CMSContainerTemplateId])

	ALTER TABLE [dbo].[ZnodePublishContentContainerVariantEntity] CHECK CONSTRAINT [FK_ZnodePublishContentContainerVariantEntity_CMSContainerTemplateId]
END


GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodePublishContetContainerVersionEntity')
BEGIN
	CREATE TABLE [dbo].[ZnodePublishContetContainerVersionEntity](
	[VersionId] [int] IDENTITY(1,1) NOT NULL,
	[PublishStartTime] [datetime] NULL,
	[PublishState] [varchar](100) NULL
	) ON [PRIMARY]
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishContainerGlobalAttributeValue')
	DROP PROC Znode_GetPublishContainerGlobalAttributeValue

GO

CREATE PROCEDURE [dbo].[Znode_GetPublishContainerGlobalAttributeValue]
(
    @CMSContainerProfileVariantId   INT = 0,
	@LocaleCode VARCHAR(100) = ''
)
AS
BEGIN
	BEGIN TRY
		DECLARE @LocaleId INT
		SET @LocaleId = ISNULL(( SELECT TOP 1 LocaleId FROM ZnodeLocale WHERE Code = @LocaleCode),0)

		IF OBJECT_ID('tempdb..#ContainerVariantEntity') IS NOT NULL
			DROP TABLE #ContainerVariantEntity;

		SELECT DISTINCT ZPCCVE.Name as ContentContainerName ,ZPCCVE.ContainerKey, 
			REPLACE(REPLACE(ZPCCVE.GlobalAttributes,'[',''),']','') AS GlobalAttributes, ZCCT.Name AS ContainerTemplateName
		INTO #ContainerVariantEntity
		FROM ZnodePublishContentContainerVariantEntity ZPCCVE
		LEFT JOIN ZnodeCMSContainerTemplate ZCCT ON ISNULL(ZPCCVE.CMSContainerTemplateId,0) = ZCCT.CMSContainerTemplateId
		WHERE ZPCCVE.CMSContainerProfileVariantId = @CMSContainerProfileVariantId AND (ISNULL(ZPCCVE.LocaleId,0) = 1 OR ISNULL(1,0) = 0)

		--SELECT t.ContentContainerName,t.ContainerKey,
		--	'['+STRING_AGG( t.GlobalAttributes,',') WITHIN GROUP (ORDER BY ContainerKey)+']'
		--	,t.ContainerTemplateName
		--FROM #ContainerVariantEntity t
		--GROUP BY t.ContentContainerName,t.ContainerKey,t.ContainerTemplateName;

		SELECT DISTINCT t2.ContentContainerName,t2.ContainerKey,
				'['+STUFF((
				SELECT DISTINCT ',' + t1.GlobalAttributes
				FROM #ContainerVariantEntity t1
				WHERE t1.ContentContainerName=t2.ContentContainerName
					AND t1.ContainerKey=t2.ContainerKey
				FOR XML PATH('')
				), 1, 1, '')+']' As GlobalAttributes
				, t2.ContainerTemplateName
		FROM #ContainerVariantEntity t2

		--SELECT ZPCCVE.Name as ContentContainerName ,ZPCCVE.ContainerKey, ZPCCVE.GlobalAttributes, ZCCT.Name AS ContainerTemplateName
		--FROM ZnodePublishContentContainerVariantEntity ZPCCVE
		--LEFT JOIN ZnodeCMSContainerTemplate ZCCT ON ISNULL(ZPCCVE.CMSContainerTemplateId,0) = ZCCT.CMSContainerTemplateId
		--WHERE ZPCCVE.CMSContainerProfileVariantId = @CMSContainerProfileVariantId AND (ISNULL(ZPCCVE.LocaleId,0) = @LocaleId OR ISNULL(@LocaleId,0) = 0)

		--SELECT 1 AS ID,CAST(1 AS BIT) AS Status;       
	END TRY
	BEGIN CATCH
		SELECT ERROR_MESSAGE()
		DECLARE @Status BIT ;
		SET @Status = 0;

		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(),
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishContainerGlobalAttributeValue 					
					@CMSContainerProfileVariantId='+CAST(@CMSContainerProfileVariantId AS VARCHAR(10))
					+''',@LocaleCode='+ISNULL(@LocaleCode,'''')
					
		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_GetPublishContainerGlobalAttributeValue',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishContentContainerAttributeValue')
	DROP PROC Znode_GetPublishContentContainerAttributeValue

GO

CREATE PROCEDURE [dbo].[Znode_GetPublishContentContainerAttributeValue]
(
	@EntityName	NVARCHAR(200) = 0,
	@ContainerKey	NVARCHAR(200),
	@LocalId	INT = 0,
	@PortalId	INT = 0,
	@ProfileId	INT = 0
)
AS
/*
	 Summary :- This procedure is used to get the Content and Container attribute value as per filter pass
	 Unit Testing
	 BEGIN TRAN
	 EXEC [Znode_GetPublishContentContainerAttributeValue] @EntityName='Content Containers',@ContainerKey='',@LocalId=0,@PortalId=0,@ProfileId=0
	 ROLLBACK TRAN
*/
BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
		-- Variable Declaration as per the code requirement
		DECLARE @LocaleCode NVARCHAR(50),
				@LocalIdInput INT,
				@LocaleCodeInput NVARCHAR(50),
				@CMSContainerProfileVariantId INT,
				@GroupCode NVARCHAR(200) = NULL,
				@SelectedValue BIT = 0,
				@FamilyCode VARCHAR(200);

		SET @LocalIdInput = @LocalId

		SELECT @LocaleCode=Code FROM ZnodeLocale WITH (NOLOCK) WHERE LocaleId=@LocalId;
		SET @LocaleCodeInput = @LocaleCode

		--1. Specific Store, Specific User Profile, Selected Locale
		-- Based on input if count will 1 then this will take CMSContainerProfileVariantId from 1st loop else this will go for next loop.
		IF (SELECT COUNT(1) FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK) WHERE ISNULL(WPV.ProfileId,0)=@ProfileId  AND WPV.LocaleId=@LocalId)=1
		BEGIN
			SELECT @CMSContainerProfileVariantId=WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE ISNULL(WPV.ProfileId,0)=@ProfileId AND WPV.ContainerKey=@ContainerKey
			AND WPV.LocaleId=@LocalId
		END
		ELSE
		BEGIN
			SELECT @CMSContainerProfileVariantId=WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = @ProfileId ) AND (ISNULL(WPV.PortalId,0) = @PortalId )
			AND WPV.ContainerKey=@ContainerKey AND WPV.LocaleId=@LocalId
		END

		--2. Specific Store, Specific User Profile, Default Locale
		IF ISNULL(@CMSContainerProfileVariantId,0) = 0
		BEGIN
			SELECT @LocalId = LocaleId FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;
			SELECT @LocaleCode = Code FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;

			SELECT @CMSContainerProfileVariantId= WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = @ProfileId ) AND (ISNULL(WPV.PortalId,0) = @PortalId )
			AND WPV.ContainerKey=@ContainerKey AND WPV.LocaleId=@LocalId 

			IF ISNULL(@CMSContainerProfileVariantId,0) = 0
			BEGIN
				SET @LocalId = @LocalIdInput
				SET @LocaleCode = @LocaleCodeInput
			END
		
		END

		--3. Specific Store, Any User Profile, Selected Locale
		IF ISNULL(@CMSContainerProfileVariantId,0) = 0
		BEGIN
			SELECT @CMSContainerProfileVariantId= WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = 0 ) AND (ISNULL(WPV.PortalId,0) = @PortalId )
			AND WPV.ContainerKey=@ContainerKey AND WPV.LocaleId=@LocalId 
		END

		--4. Specific Store, Any User Profile, Default Locale
		IF ISNULL(@CMSContainerProfileVariantId,0) = 0
		BEGIN
			SELECT @LocalId = LocaleId FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;
			SELECT @LocaleCode = Code FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;

			SELECT @CMSContainerProfileVariantId= WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = 0 ) AND (ISNULL(WPV.PortalId,0) = @PortalId )
			AND WPV.ContainerKey=@ContainerKey AND WPV.LocaleId=@LocalId

			IF ISNULL(@CMSContainerProfileVariantId,0) = 0
			BEGIN
				SET @LocalId = @LocalIdInput
				SET @LocaleCode = @LocaleCodeInput
			END
		END
		
		--5. Any Store, Any User Profile, Selected Locale
		IF ISNULL(@CMSContainerProfileVariantId,0) = 0
		BEGIN
			SELECT @CMSContainerProfileVariantId= WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = 0 ) AND (ISNULL(WPV.PortalId,0) = 0 )
			AND WPV.ContainerKey=@ContainerKey AND WPV.LocaleId=@LocalId
		END

		--6. Any Store, Any User Profile, Default Locale
		IF ISNULL(@CMSContainerProfileVariantId,0) = 0
		BEGIN
			SELECT @LocalId = LocaleId FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;
			SELECT @LocaleCode = Code FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;

			SELECT @CMSContainerProfileVariantId= WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = 0 ) AND (ISNULL(WPV.PortalId,0) = 0 )
			AND WPV.ContainerKey=@ContainerKey AND WPV.LocaleId=@LocalId 

			IF ISNULL(@CMSContainerProfileVariantId,0) = 0
			BEGIN
				SET @LocalId = @LocalIdInput
				SET @LocaleCode = @LocaleCodeInput
			END
		END
		
		-- This will take FamilyCode based on the inputs.
		SELECT @FamilyCode=GAF.FamilyCode
		FROM ZnodeCMSContentContainer CCW WITH (NOLOCK)
		INNER JOIN ZnodeGlobalAttributeFamily GAF WITH (NOLOCK) ON CCW.FamilyId=GAF.GlobalAttributeFamilyId
		WHERE CCW.ContainerKey=@ContainerKey 
		AND EXISTS(SELECT * FROM ZnodePublishContentContainerVariantEntity CWPV WITH (NOLOCK) WHERE CCW.CMSContentContainerId = CWPV.CMSContentContainerId AND (ISNULL(CWPV.PortalId,0)=@PortalId));

		-- Based on input @EntityName='Content Containers' as fixed value this will execute nested SP.
		-- Nested SP will give 2 Output (1 Result set & 1 Msg.

		-- Declared table variable to combined nested sp data with the output of this sp.
		DECLARE	@PublishContainerGlobalAttributeValue As TABLE
		(ContentContainerName NVARCHAR(100), ContainerKey NVARCHAR(50), GlobalAttributes NVARCHAR(MAX), ContainerTemplateName NVARCHAR(100))

		IF @EntityName='Content Containers'
		begin
			INSERT INTO @PublishContainerGlobalAttributeValue
				(ContentContainerName, ContainerKey, GlobalAttributes, ContainerTemplateName)
			EXEC [dbo].[Znode_GetPublishContainerGlobalAttributeValue]
				@CMSContainerProfileVariantId=@CMSContainerProfileVariantId, @LocaleCode= @LocaleCode
		end
		
		-- This will take FamilyCode based on the inputs.
		SELECT @FamilyCode=GAF.FamilyCode
		FROM ZnodeCMSContentContainer CCW WITH (NOLOCK)
		INNER JOIN ZnodeGlobalAttributeFamily GAF WITH (NOLOCK) ON CCW.FamilyId=GAF.GlobalAttributeFamilyId
		WHERE CCW.ContainerKey=@ContainerKey 
		AND EXISTS(SELECT * FROM ZnodeCMSContainerProfileVariant CWPV WHERE CCW.CMSContentContainerId = CWPV.CMSContentContainerId AND (ISNULL(CWPV.PortalId,0)=@PortalId));

		IF ISNULL(@FamilyCode,'') = ''
		BEGIN
			-- This will take FamilyCode based on the inputs.
			SELECT @FamilyCode=GAF.FamilyCode
			FROM ZnodeCMSContentContainer CCW WITH (NOLOCK)
			INNER JOIN ZnodeGlobalAttributeFamily GAF WITH (NOLOCK) ON CCW.FamilyId=GAF.GlobalAttributeFamilyId
			WHERE CCW.ContainerKey=@ContainerKey 
			AND EXISTS(SELECT * FROM ZnodeCMSContainerProfileVariant CWPV WHERE CCW.CMSContentContainerId = CWPV.CMSContentContainerId AND (ISNULL(CWPV.PortalId,0)=0));
		END

		-- This will give 3rd result set of Attribute Groups Data.
		--SELECT GE.GlobalEntityId, GE.EntityName, GE.IsActive, GE.TableName, GE.IsFamilyUnique
		--	, GAF.GlobalAttributeFamilyId, GAF.FamilyCode, GAF.IsSystemDefined, GAF.GlobalEntityId
		--	, GFGM.GlobalFamilyGroupMapperId, GFGM.GlobalAttributeFamilyId, GFGM.GlobalAttributeGroupId
		--	, GFGM.AttributeGroupDisplayOrder
		--	, GAG.GlobalAttributeGroupId, GAG.GroupCode, GAG.DisplayOrder, GAG.IsSystemDefined, GAG.GlobalEntityId
		--	, GAGL.GlobalAttributeGroupLocaleId, GAGL.LocaleId, GAGL.GlobalAttributeGroupId, GAGL.AttributeGroupName
		--	, GAGL.[Description]
		--FROM ZnodeGlobalEntity GE WITH (NOLOCK)
		--INNER JOIN ZnodeGlobalAttributeFamily GAF WITH (NOLOCK) ON GE.GlobalEntityId=GAF.GlobalEntityId
		--INNER JOIN ZnodeGlobalFamilyGroupMapper GFGM WITH (NOLOCK) ON GAF.GlobalAttributeFamilyId=GFGM.GlobalAttributeFamilyId
		--INNER JOIN ZnodeGlobalAttributeGroup GAG WITH (NOLOCK) ON GFGM.GlobalAttributeGroupId=GAG.GlobalAttributeGroupId
		--INNER JOIN ZnodeGlobalAttributeGroupLocale GAGL WITH (NOLOCK) ON GAG.GlobalAttributeGroupId=GAGL.GlobalAttributeGroupId
		--WHERE GE.EntityName=@EntityName AND GAGL.LocaleId=@LocalId AND GAF.FamilyCode=@FamilyCode
		--ORDER BY GFGM.AttributeGroupDisplayOrder;

		-- This will give 4th result set of ContainerProfile & ContentContainer Data.

		SELECT DISTINCT CWPV.CMSContainerProfileVariantId, CWPV.CMSContentContainerId, CGAV.ContentContainerName, CWPV.ProfileId
			, CWPV.LocaleId, CWPV.CMSContainerTemplateId, CGAV.ContainerTemplateName
			, CCW.[Name], CCW.ContainerKey, CWPV.PortalId, CCW.FamilyId, CCW.Tags
			, CGAV.GlobalAttributes
		FROM ZnodePublishContentContainerVariantEntity CWPV WITH (NOLOCK)
		--INNER JOIN ZnodeCMSContainerProfileVariantLocale CWPVL WITH (NOLOCK) ON CWPV.CMSContainerProfileVariantId = CWPVL.CMSContainerProfileVariantId
		INNER JOIN ZnodeCMSContentContainer CCW WITH (NOLOCK) ON CWPV.CMSContentContainerId=CCW.CMSContentContainerId
		INNER JOIN @PublishContainerGlobalAttributeValue CGAV ON CCW.ContainerKey=CGAV.ContainerKey
			AND CWPV.CMSContainerProfileVariantId=@CMSContainerProfileVariantId
		WHERE (ISNULL(CWPV.ProfileId,0) = @ProfileId OR ISNULL(CWPV.ProfileId,0) = 0) AND CWPV.LocaleId=@LocalId AND CCW.ContainerKey=@ContainerKey AND ((ISNULL(CWPV.PortalId,0)=@PortalId OR ISNULL(CWPV.PortalId,0) = 0));

		-- This will give 5th result set of ContainerTemplate & ContentContainer Data.
		--SELECT CWT.CMSContainerTemplateId, CWT.[FileName], CWT.MediaId, CCW.[Name], CCW.FamilyId, CCW.Tags
		--FROM ZnodeCMSContentContainer CCW WITH (NOLOCK) 
		--INNER JOIN ZnodeCMSContainerProfileVariant CWPV ON CCW.CMSContentContainerId = CWPV.CMSContentContainerId AND (ISNULL(CWPV.PortalId,0)=@PortalId OR ISNULL(CWPV.PortalId,0) = 0)
		--INNER JOIN ZnodeCMSContainerProfileVariantLocale CWPVL ON CWPV.CMSContainerProfileVariantId = CWPVL.CMSContainerProfileVariantId
		--INNER JOIN  ZnodeCMSContainerTemplate CWT WITH (NOLOCK) ON (CWPVL.CMSContainerTemplateId = CWT.CMSContainerTemplateId OR ISNULL(CWPVL.CMSContainerTemplateId,0) = 0)
		--WHERE CCW.ContainerKey=@ContainerKey
	END TRY
	BEGIN CATCH
		SELECT ERROR_MESSAGE()
		DECLARE @Status BIT;
		SET @Status = 0;

		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(),
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetContentContainerAttributeValue
					@EntityName = '''+ISNULL(@EntityName,'''''')+
					''',@ContainerKey='+ISNULL(@ContainerKey,'''')+
					''',@LocalId='+ISNULL(CAST(@LocalId AS VARCHAR(20)),'''')+
					''',@PortalId='+ISNULL(CAST(@PortalId AS VARCHAR(20)),'''')+
					''',@ProfileId='+ISNULL(CAST(@ProfileId AS VARCHAR(20)),'''')
					
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_GetContentContainerAttributeValue',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishContentContainerVariantEntity')
	DROP PROC Znode_PublishContentContainerVariantEntity

GO

CREATE PROCEDURE [dbo].[Znode_PublishContentContainerVariantEntity]
(
	 @ContainerKey VARCHAR(50) = ''
	,@RevisionState VARCHAR(50) = 'Production'
	,@UserId INT = 0
	,@OldPreviewId INT = 0
	,@OldProductionId INT = 0
	,@ContainerProfileVariantId INT = 0
	,@Status BIT = 0 OUTPUT
)
AS
/*
	if profileid and portalid will null then it must be publish.
	This Procedure is used to publish the Content Container Variant against the store 

	EXEC [Znode_PublishContentContainerVariantEntity] 1 2,3

	EXEC Znode_PublishContentContainerVariantEntity @@ContainerKey='',@RevisionState='Production',@UserId=2,
	@OldPreviewId=0,@OldProductionId=

	SELECT * FROM ZnodePublishContentContainerVariantEntity

*/
BEGIN 
BEGIN TRY 
SET NOCOUNT ON

	DECLARE @VersionId Int
	SET @VersionId = ( SELECT TOP 1 VersionId FROM ZnodePublishContetContainerVersionEntity WHERE PublishState = @RevisionState )

	IF ISNULL(@VersionId,0) = 0 AND @RevisionState = 'PREVIEW'
	BEGIN
		INSERT INTO ZnodePublishContetContainerVersionEntity(PublishStartTime,PublishState)
		SELECT GETDATE(),'PREVIEW'
		SET @VersionId = @@IDENTITY
	END
	
	IF ISNULL(@VersionId,0) = 0 AND @RevisionState = 'PRODUCTION'
 	BEGIN
		INSERT INTO ZnodePublishContetContainerVersionEntity(PublishStartTime,PublishState)
		SELECT GETDATE(),'PRODUCTION'
		SET @VersionId = @@IDENTITY
	END 


		DECLARE @SetLocaleId INT, @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleId(), @MaxCount INT =0 , @IncrementalId INT = 1;
		DECLARE @TBL_Locale TABLE (LocaleId INT , RowId INT IDENTITY(1,1));
		DECLARE @TBL_ContentContainerVariantEntity TABLE
			(CMSContainerProfileVariantId INT,PortalId INT, LocaleId INT, Name NVARCHAR(100), ContainerKey NVARCHAR(50),	CMSContentContainerId INT, ProfileId INT,
				CMSContainerTemplateId INT, CreatedBy INT, CreatedDate DATETIME, ModifiedBy INT, ModifiedDate DATETIME);

		INSERT INTO @TBL_Locale (LocaleId)
		SELECT LocaleId
		FROM ZnodeLocale
		WHERE IsActive =1 --AND (LocaleId = @LocaleId OR @LocaleId = 0);

		SET @MaxCount = ISNULL((SELECT MAx(RowId) FROM @TBL_Locale),0);

		WHILE @IncrementalId <= @MaxCount
		BEGIN 
			SET @SetLocaleId = (SELECT TOP 1 LocaleId FROM @TBL_locale WHERE  RowId = @IncrementalId);

			;WITH Cte_CMSContainerProfileVariant AS
			(
				SELECT DISTINCT WPV.CMSContainerProfileVariantId, ZCW.ContainerKey, WPV.PortalId, --ZCW.Tags,
					CASE WHEN WPV.PortalId IS NULL THEN  'Any Store' ELSE ZP.StoreName END StoreName  ,
					CASE WHEN WPV.ProfileId IS NULL THEN  'Any User Profile' ELSE ZPR.ProfileName END ProfileName, 
					GETDATE() As CreatedDate, GETDATE() As ModifiedDate,
					CAST(CASE WHEN WPV.ProfileId IS NULL AND WPV.PortalId IS NULL THEN 1 ELSE 0 END AS BIT) AS IsDefaultVarient,
					CASE WHEN WPV.PortalId IS NULL THEN  'AnyStore' ELSE ZP.StoreCode END StoreCode ,
					CASE WHEN WPV.ProfileId IS NULL THEN  'AnyUserProfile' ELSE ZPR.DefaultExternalAccountNo END ProfileCode,
					CPVL.LocaleId,ZCW.Name,ZCW.CMSContentContainerId,WPV.ProfileId,CPVL.CMSContainerTemplateId
				FROM ZnodeCMSContentContainer ZCW
				INNER JOIN ZnodeCMSContainerProfileVariant WPV ON WPV.CMSContentContainerId = ZCW.CMSContentContainerId
				INNER JOIN ZnodeCMSContainerProfileVariantLocale CPVL ON WPV.CMSContainerProfileVariantId=CPVL.CMSContainerProfileVariantId
				LEFT JOIN ZnodePortal ZP ON (WPV.PortalId = ZP.PortalId ) 
				LEFT JOIN ZnodeProfile ZPR ON WPV.ProfileId = ZPR.ProfileId
				WHERE (CPVL.LocaleId = @SetLocaleId) -- OR CPVL.LocaleId = @DefaultLocaleId
				AND CPVL.IsActive = 1 AND (ZCW.ContainerKey = @ContainerKey OR @ContainerKey = '' )
				AND ( WPV.CMSContainerProfileVariantId = @ContainerProfileVariantId OR @ContainerProfileVariantId = 0)
			)
			, Cte_GetFirstFilterData AS
			(
				SELECT CMSContainerProfileVariantId,ContainerKey,PortalId,StoreName,ProfileName,CreatedDate,ModifiedDate,IsDefaultVarient,
					StoreCode,ProfileCode,LocaleId,Name,CMSContentContainerId,ProfileId,CMSContainerTemplateId
				FROM Cte_CMSContainerProfileVariant
				WHERE LocaleId = @SetLocaleId
			)
			, Cte_GetDefaultFilterData AS
			(
				SELECT CMSContainerProfileVariantId,ContainerKey,PortalId,StoreName,ProfileName,CreatedDate,ModifiedDate,IsDefaultVarient,
					StoreCode,ProfileCode,LocaleId,Name,CMSContentContainerId,ProfileId,CMSContainerTemplateId
				FROM Cte_GetFirstFilterData
				UNION ALL
				SELECT CMSContainerProfileVariantId,ContainerKey,PortalId,StoreName,ProfileName,CreatedDate,ModifiedDate,IsDefaultVarient,
					StoreCode,ProfileCode,LocaleId,Name,CMSContentContainerId,ProfileId,CMSContainerTemplateId
				FROM Cte_CMSContainerProfileVariant CTEC
				WHERE  LocaleId = @DefaultLocaleId
					AND NOT EXISTS (SELECT TOP 1 1 FROM Cte_GetFirstFilterData CTEFD WHERE CTEFD.CMSContainerProfileVariantId = CTEC.CMSContainerProfileVariantId)
			)
			INSERT INTO @TBL_ContentContainerVariantEntity
				(CMSContainerProfileVariantId,PortalId, LocaleId, Name, ContainerKey,	CMSContentContainerId, ProfileId, CMSContainerTemplateId,
					CreatedBy, CreatedDate, ModifiedBy,	ModifiedDate)
			SELECT CMSContainerProfileVariantId,PortalId, LocaleId, Name, ContainerKey,	CMSContentContainerId, ProfileId, CMSContainerTemplateId,
					@UserId, CreatedDate, @UserId,	ModifiedDate
			FROM Cte_GetDefaultFilterData

			SET @IncrementalId = @IncrementalId +1;
		END 

		CREATE TABLE #ContentContainerGlobalAttribute(CMSContainerProfileVariantId INT,LocaleId INT, GlobalAttributes NVARCHAR(MAX))

		INSERT INTO #ContentContainerGlobalAttribute (CMSContainerProfileVariantId ,LocaleId , GlobalAttributes )
		EXEC [Znode_SetPublishContentContainerGlobalAttributeEntity] @ContainerKey = @ContainerKey, @ContainerProfileVariantId = @ContainerProfileVariantId
		-- Data inserted INTO flat table ZnodeBlogNewsEntity (Replica of MongoDB Collection )
		IF (@RevisionState like '%Preview%' ) 
		BEGIN
			--Data inserted INTO flat table ZnodePublishContentContainerVariantEntity (Replica of MongoDB Collection )
			DELETE FROM ZnodePublishContentContainerVariantEntity WHERE VersionId = @VersionId
			AND EXISTS(SELECT * FROM @TBL_ContentContainerVariantEntity cc WHERE ZnodePublishContentContainerVariantEntity.ContainerKey = CC.ContainerKey
						AND ZnodePublishContentContainerVariantEntity.CMSContainerProfileVariantId = CC.CMSContainerProfileVariantId)

			INSERT INTO ZnodePublishContentContainerVariantEntity
			(
				VersionId,PortalId,LocaleId,Name,ContainerKey,CMSContentContainerId,ProfileId,CMSContainerTemplateId,
				CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CMSContainerProfileVariantId, GlobalAttributes
			)
			SELECT @VersionId,A.PortalId,A.LocaleId,Name,ContainerKey,CMSContentContainerId,ProfileId,CMSContainerTemplateId,
				CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,A.CMSContainerProfileVariantId, B.GlobalAttributes
			FROM @TBL_ContentContainerVariantEntity A
			LEFT JOIN #ContentContainerGlobalAttribute B ON A.CMSContainerProfileVariantId = B.CMSContainerProfileVariantId AND A.LocaleId = B.LocaleId

			DELETE FROM ZnodePublishContentContainerVariantEntity WHERE VersionId = @OldPreviewId

		END
		---------------------------- END Preview 
		IF (@RevisionState LIKE '%Production%' OR @RevisionState = 'None')
		BEGIN
			-- Only production version id will process 
			DELETE FROM ZnodePublishContentContainerVariantEntity WHERE VersionId = @VersionId
			AND EXISTS(SELECT * FROM @TBL_ContentContainerVariantEntity cc WHERE ZnodePublishContentContainerVariantEntity.ContainerKey = CC.ContainerKey
					AND ZnodePublishContentContainerVariantEntity.CMSContainerProfileVariantId = CC.CMSContainerProfileVariantId)

			INSERT INTO ZnodePublishContentContainerVariantEntity
			(
				VersionId,PortalId,LocaleId,Name,ContainerKey,CMSContentContainerId,ProfileId,CMSContainerTemplateId,
				CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CMSContainerProfileVariantId,GlobalAttributes
			)
			SELECT DISTINCT @VersionId,A.PortalId,A.LocaleId,Name,ContainerKey,CMSContentContainerId,ProfileId,CMSContainerTemplateId,
				CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,A.CMSContainerProfileVariantId,B.GlobalAttributes
			FROM @TBL_ContentContainerVariantEntity A
			LEFT JOIN #ContentContainerGlobalAttribute B ON A.CMSContainerProfileVariantId = B.CMSContainerProfileVariantId AND A.LocaleId = B.LocaleId

			DELETE FROM ZnodePublishContentContainerVariantEntity WHERE VersionId = @OldProductionId
		
		END

		SET @Status =1 ;
		IF (@RevisionState = 'Preview')
			UPDATE B SET PublishStateId = (SELECT dbo.Fn_GetPublishStateIdForPreview()) --, ISPublish = 1 
			FROM @TBL_ContentContainerVariantEntity A
			INNER JOIN ZnodeCMSContainerProfileVariant B ON A.CMSContainerProfileVariantId = B.CMSContainerProfileVariantId
				
		ELSE IF (@RevisionState = 'Production' Or @RevisionState = 'None' )
			UPDATE B SET PublishStateId = (SELECT dbo.Fn_GetPublishStateIdForPublish()) --, ISPublish = 1 
			FROM @TBL_ContentContainerVariantEntity A
			INNER JOIN ZnodeCMSContainerProfileVariant B ON A.CMSContainerProfileVariantId = B.CMSContainerProfileVariantId
				

		SELECT 1 ID, @Status Status;
END TRY 
BEGIN CATCH
	SET @Status =0

	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishContentContainerVariantEntity
		@ContainerKey = '+CAST(@ContainerKey AS VARCHAR	(max))
		+',@ContainerProfileVariantId = ''' + CAST(@ContainerProfileVariantId AS VARCHAR(50))
		+',@RevisionState = ''' + CAST(@RevisionState AS VARCHAR(50))
		+',@UserId = ' + CAST(@UserId AS VARCHAR(20))
		+',@Status='+CAST(@Status AS VARCHAR(10));
		SELECT 0 AS ID,@Status AS Status;
	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_PublishContentContainerVariantEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_SaveVariantsData')
	DROP PROC Znode_SaveVariantsData

GO

CREATE PROCEDURE [dbo].[Znode_SaveVariantsData]
(
	@LocaleId INT,
	@CMSContainerTemplateId INT,
	@CMSContainerProfileVariantId INT,
	@UserId INT=0,
	@IsActive BIT,
	@status BIT OUT
)
AS
--EXEC Znode_SaveVariantsData 0,0,0,0,0,0
BEGIN
	BEGIN TRY
	BEGIN TRAN SaveVariantsData
		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
		DECLARE @PublishStateId INT =(SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE StateName='Draft');

		IF EXISTS (SELECT TOP 1 1 FROM ZnodeCMSContainerProfileVariantLocale WHERE CMSContainerProfileVariantId=@CMSContainerProfileVariantId)
		BEGIN
			IF EXISTS (SELECT TOP 1 1 FROM ZnodeCMSContainerProfileVariantLocale
						WHERE CMSContainerProfileVariantId=@CMSContainerProfileVariantId AND LocaleId=@LocaleId)
			BEGIN
				UPDATE ZnodeCMSContainerProfileVariantLocale
				SET CMSContainerTemplateId=@CMSContainerTemplateId, IsActive=@IsActive
				WHERE CMSContainerProfileVariantId=@CMSContainerProfileVariantId AND LocaleId=@LocaleId
					AND CMSContainerTemplateId<>@CMSContainerTemplateId;

				UPDATE ZnodeCMSContainerProfileVariant
				SET PublishStateId = @PublishStateId,ModifiedBy=@UserId, ModifiedDate=@GetDate
				WHERE CMSContainerProfileVariantId=@CMSContainerProfileVariantId;

				UPDATE ZnodeCMSContentContainer
				SET PublishStateId=@PublishStateId,ModifiedBy=@UserId, ModifiedDate=@GetDate
				WHERE CMSContentContainerId=(SELECT CMSContentContainerId FROM ZnodeCMSContainerProfileVariant
											WHERE CMSContainerProfileVariantId=@CMSContainerProfileVariantId);
			END
			ELSE
			BEGIN
			select 1
				INSERT INTO ZnodeCMSContainerProfileVariantLocale
					(CMSContainerProfileVariantId,CMSContainerTemplateId,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsActive)
				SELECT @CMSContainerProfileVariantId,@CMSContainerTemplateId,@LocaleId,@UserId,@GetDate,@UserId,@GetDate,@IsActive;

				UPDATE ZnodeCMSContainerProfileVariant
				SET PublishStateId = @PublishStateId,ModifiedBy=@UserId, ModifiedDate=@GetDate
				WHERE CMSContainerProfileVariantId=@CMSContainerProfileVariantId;

				UPDATE ZnodeCMSContentContainer
				SET PublishStateId=@PublishStateId,ModifiedBy=@UserId, ModifiedDate=@GetDate
				WHERE CMSContentContainerId=(SELECT CMSContentContainerId FROM ZnodeCMSContainerProfileVariant
											WHERE CMSContainerProfileVariantId=@CMSContainerProfileVariantId);
			END
		END
		ELSE
		BEGIN
			INSERT INTO ZnodeCMSContainerProfileVariantLocale
					(CMSContainerProfileVariantId,CMSContainerTemplateId,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsActive)
			SELECT @CMSContainerProfileVariantId,@CMSContainerTemplateId,@LocaleId,@UserId,@GetDate,@UserId,@GetDate,@IsActive;

			UPDATE ZnodeCMSContainerProfileVariant
				SET PublishStateId = @PublishStateId,ModifiedBy=@UserId, ModifiedDate=@GetDate
				WHERE CMSContainerProfileVariantId=@CMSContainerProfileVariantId;

			UPDATE ZnodeCMSContentContainer
			SET PublishStateId=@PublishStateId,ModifiedBy=@UserId, ModifiedDate=@GetDate
			WHERE CMSContentContainerId=(SELECT CMSContentContainerId FROM ZnodeCMSContainerProfileVariant
										WHERE CMSContainerProfileVariantId=@CMSContainerProfileVariantId);
		END

		SET @Status = 1;
		SELECT 1 AS ID, CAST(1 AS BIT) AS [Status];

	COMMIT TRAN SaveVariantsData;
	END TRY

	BEGIN CATCH
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
			@ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_SaveVariantsData 
			@LocaleId = '+CAST(@LocaleId AS VARCHAR(50))+',
			@CMSContainerTemplateId='+CAST(@CMSContainerTemplateId AS VARCHAR(50))+',
			@CMSContainerProfileVariantId='+CAST(@CMSContainerProfileVariantId AS VARCHAR(50))+',
			@UserId='+CAST(@UserId AS VARCHAR(50))+',
			@Status='+CAST(@Status AS VARCHAR(50));

		SET @Status =0
		SELECT 1 AS ID,@Status AS Status;
		ROLLBACK TRAN SaveVariantsData;
		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_SaveVariantsData',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;

	END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_SetPublishContainerEntity')
	DROP PROC Znode_SetPublishContainerEntity

GO

CREATE PROCEDURE [dbo].[Znode_SetPublishContainerEntity]
(
	 @PreviewVersionId INT = 0
	,@IsPreviewEnable INT = 0
	,@ProductionVersionId INT = 0
	,@RevisionState VARCHAR(50) = 'PRODUCTION'
	,@ContainerKey NVARCHAR(50) = ''
	,@UserId INT = 0
	,@Status INT = 0 OUTPUT
)
AS
/*

	This Procedure is used to publish the Content Container and its varients publish

	EXEC  [Znode_SetPublishContainerEntity] @VersionId = 0,@PreviewVersionId=0,@IsPreviewEnable=1,@ProductionVersionId=0,
		@RevisionState='Preview',@ContainerKey='DiwaliOffer11',@UserId=2,@Status=0

				EXEC  [Znode_SetPublishContainerEntity] @PreviewVersionId=0,@IsPreviewEnable=1,@ProductionVersionId=0,
		@RevisionState='Preview',@ContainerKey='',@UserId=2,@Status=0

		EXEC  [Znode_SetPublishContainerEntity] @VersionId = 0,@PreviewVersionId=0,@IsPreviewEnable=0,@ProductionVersionId=0,
		@RevisionState='Production',@ContainerKey='',@UserId=2,@Status=0

*/
BEGIN 
BEGIN TRY 
SET NOCOUNT ON
BEGIN TRAN ContentContainer

	DECLARE @OldPreviewId INT, @OldProductionId INT
	IF @PreviewVersionId = 0 AND @ContainerKey = '' AND @RevisionState = 'PREVIEW'
	BEGIN
		SET @OldPreviewId = ( SELECT TOP 1 VersionId FROM ZnodePublishContetContainerVersionEntity WHERE PublishState ='PREVIEW')
			
		INSERT INTO ZnodePublishContetContainerVersionEntity(PublishStartTime,PublishState)
		SELECT GETDATE(),'PREVIEW'
		SET @PreviewVersionId = @@IDENTITY

		DELETE FROM ZnodePublishContetContainerVersionEntity WHERE VersionId = @OldPreviewId 
	END
	ELSE IF @RevisionState = 'PREVIEW'
	BEGIN
		INSERT INTO ZnodePublishContetContainerVersionEntity(PublishStartTime,PublishState)
		SELECT GETDATE(),'PREVIEW'
		WHERE NOT EXISTS (SELECT * FROM ZnodePublishContetContainerVersionEntity WHERE PublishState <> 'PREVIEW')
		
		SET @PreviewVersionId = ( SELECT TOP 1 VersionId FROM ZnodePublishContetContainerVersionEntity WHERE PublishState ='PREVIEW')
	END
			
	IF @ProductionVersionId = 0 AND @ContainerKey = '' AND @RevisionState = 'PRODUCTION'
 	BEGIN
		SET @OldProductionId = ( SELECT TOP 1 VersionId FROM ZnodePublishContetContainerVersionEntity WHERE PublishState ='PRODUCTION')
			
		INSERT INTO ZnodePublishContetContainerVersionEntity(PublishStartTime,PublishState)
		SELECT GETDATE(),'PRODUCTION'
		SET @ProductionVersionId = @@IDENTITY

		DELETE FROM ZnodePublishContetContainerVersionEntity WHERE VersionId = @OldProductionId 
	END 
	ELSE IF @RevisionState = 'PRODUCTION'
	BEGIN
		INSERT INTO ZnodePublishContetContainerVersionEntity(PublishStartTime,PublishState)
		SELECT GETDATE(),'PRODUCTION'
		WHERE NOT EXISTS (SELECT * FROM ZnodePublishContetContainerVersionEntity WHERE PublishState <> 'PRODUCTION')

		SET @ProductionVersionId = ( SELECT TOP 1 VersionId FROM ZnodePublishContetContainerVersionEntity WHERE PublishState ='PRODUCTION')
	END

	
	DECLARE @TBL_ContentContainerEntity TABLE
	(
		CMSContentContainerId INT, Name NVARCHAR(100), ContainerKey NVARCHAR(50),	FamilyId INT, Tags NVARCHAR(1000),
		CreatedBy INT, CreatedDate DATETIME, ModifiedBy INT,	ModifiedDate DATETIME
	);

	INSERT INTO @TBL_ContentContainerEntity(CMSContentContainerId, Name, ContainerKey, FamilyId, Tags, CreatedDate, ModifiedDate)
	SELECT DISTINCT ZCW.CMSContentContainerId, ZCW.Name, ZCW.ContainerKey, ZCW.FamilyId, ZCW.Tags,
		GETDATE(), GETDATE()
	FROM ZnodeCMSContentContainer ZCW WITH (NOLOCK)
	WHERE ( ZCW.ContainerKey = @ContainerKey OR ISNULL(@ContainerKey,'') = '' )

	IF @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%' OR @RevisionState like '%Production%') 
	BEGIN
		--Data inserted INTO flat table ZnodePublishContentContainerEntity 
		DELETE FROM ZnodePublishContentContainerEntity WHERE VersionId = @PreviewVersionId
		AND EXISTS(SELECT * FROM @TBL_ContentContainerEntity cc WHERE ZnodePublishContentContainerEntity.ContainerKey = CC.ContainerKey)

		INSERT INTO ZnodePublishContentContainerEntity
		(
			VersionId,Name,ContainerKey,FamilyId,Tags,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		)
		SELECT @PreviewVersionId,Name, ContainerKey, FamilyId, Tags, @UserId, CreatedDate, @UserId, ModifiedDate
		FROM @TBL_ContentContainerEntity A

		DELETE FROM ZnodePublishContentContainerEntity WHERE VersionId = @OldPreviewId

	END
	---------------------------- END Preview 
	IF (@RevisionState LIKE '%Production%' OR @RevisionState = 'None')
	BEGIN

		-- Only production version id will process 
		DELETE FROM ZnodePublishContentContainerEntity WHERE VersionId = @ProductionVersionId
		AND EXISTS(SELECT * FROM @TBL_ContentContainerEntity cc WHERE ZnodePublishContentContainerEntity.ContainerKey = CC.ContainerKey)
		
		INSERT INTO ZnodePublishContentContainerEntity
		(
			VersionId,Name,ContainerKey,FamilyId,Tags,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		)
		SELECT @ProductionVersionId,Name, ContainerKey, FamilyId, Tags, @UserId, CreatedDate, @UserId, ModifiedDate
		FROM @TBL_ContentContainerEntity A
				
		DELETE FROM ZnodePublishContentContainerEntity WHERE VersionId = @OldProductionId
	END

	-- Content container varient publish
	EXEC [Znode_PublishContentContainerVariantEntity] @ContainerKey = @ContainerKey,@RevisionState=@RevisionState, @UserId = @UserId,@OldPreviewId=@OldPreviewId,@OldProductionId=@OldProductionId,@Status = 0
	
	SET @Status =1 ;
	IF (@RevisionState = 'Preview')
		UPDATE B SET PublishStateId = (SELECT dbo.Fn_GetPublishStateIdForPreview()) --, ISPublish = 1 
		FROM @TBL_ContentContainerEntity A
		INNER JOIN ZnodeCMSContentContainer B ON A.CMSContentContainerId = B.CMSContentContainerId
				
	ELSE IF (@RevisionState = 'Production' Or @RevisionState = 'None' )
		UPDATE B SET PublishStateId = (SELECT dbo.Fn_GetPublishStateIdForPublish()) --, ISPublish = 1 
		FROM @TBL_ContentContainerEntity A
		INNER JOIN ZnodeCMSContentContainer B ON A.CMSContentContainerId = B.CMSContentContainerId
	
COMMIT TRAN ContentContainer
SELECT 1 ID, @Status Status;
END TRY 
BEGIN CATCH
	SET @Status =0
	ROLLBACK TRAN ContentContainer
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
	@ErrorLine VARCHAR(100)= ERROR_LINE(),
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_SetPublishContainerEntity
	@PreviewVersionId = ' + CAST(@PreviewVersionId AS VARCHAR(20))
	+',@IsPreviewEnable='+CAST(@IsPreviewEnable AS VARCHAR(10))
	+',@ProductionVersionId = ' + CAST(@ProductionVersionId AS VARCHAR(20))
	+',@RevisionState = ''' + CAST(@RevisionState AS VARCHAR(50))
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20))
	+',@Status='+CAST(@Status AS VARCHAR(10));
	SELECT 0 AS ID,CAST(@Status AS BIT) AS Status;

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_SetPublishContainerEntity',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_SetPublishContentContainerGlobalAttributeEntity')
	DROP PROC Znode_SetPublishContentContainerGlobalAttributeEntity

GO

CREATE PROCEDURE [dbo].[Znode_SetPublishContentContainerGlobalAttributeEntity]
(
	 @ContainerKey VARCHAR(50) = ''
	 ,@ContainerProfileVariantId INT = 0
)
AS
    
/*
exec [Znode_SetPublishContentContainerGlobalAttributeEntity] @ContainerKey = 'HomePagePromo', @ContainerProfileVariantId = 0
    Summary :	Publish Product on the basis of publish catalog
				Retrive all Product details with attributes and INSERT INTO following tables 
				1.	ZnodePublishedXml
				2.	ZnodePublishCategoryProduct
				3.	ZnodePublishProduct
				4.	ZnodePublishProductDetail

                Product details include all the type of products link, grouped, configure and bundel products (include addon) their associated products 
				collect their attributes and values into tables variables to process for publish.  
                
				Finally genrate XML for products with their attributes and inserted into ZnodePublishedXml Znode Admin process xml from sql server to mongodb
				one by one.

 */

BEGIN
	
	BEGIN TRY
		SET NOCOUNT ON;
		DECLARE @VersionId Int, @CMSContentContainerId int
		--SET @VersionId = ( SELECT TOP 1 VersionId FROM ZnodePublishContetContainerVersionEntity WHERE PublishState = @RevisionState )

		DECLARE @SetLocaleId INT, @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleId(), @MaxCount INT =0 , @IncrementalId INT = 1;
		DECLARE @TBL_Locale TABLE (LocaleId INT , RowId INT IDENTITY(1,1));

		--If @PreviewVersionId = 0 
		--	Begin
  -- 				INSERT INTO @Tbl_PreviewVersionId 
		--		SELECT distinct VersionId , PortalId, LocaleId FROM  ZnodePublishWebStoreEntity WHERE (PortalId = @PortalId or @PortalId=0 ) and PublishState ='PREVIEW'
		--	end
		--Else 
		--		INSERT INTO @Tbl_PreviewVersionId SELECT distinct VersionId , PortalId, LocaleId FROM  ZnodePublishWebStoreEntity 
		--		WHERE VersionId = @PreviewVersionId
		--If @ProductionVersionId = 0 
  -- 			Begin
		--		INSERT INTO @Tbl_ProductionVersionId 
		--		SELECT distinct VersionId , PortalId , LocaleId FROM  ZnodePublishWebStoreEntity WHERE (PortalId = @PortalId or @PortalId=0 ) and PublishState ='PRODUCTION'
		--	End 
		--Else 
		
		--	INSERT INTO @Tbl_ProductionVersionId SELECT distinct VersionId , PortalId, LocaleId FROM  ZnodePublishWebStoreEntity 
		--	WHERE VersionId = @ProductionVersionId
		--	DECLARE @SetLocaleId INT , @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleId(), @MaxCount INT =0 , @IncrementalId INT = 1  
		--DECLARE @TBL_Locale TABLE (LocaleId INT , RowId INT IDENTITY(1,1))

		DECLARE @TBL_GlobalAttributeGrouplist TABLE ([GlobalAttributeGroupId] INT , [AttributeGroupDisplayOrder] INT,Groups int )
		DECLARE @TBL_GlobalAttributelist      TABLE ([GlobalAttributeGroupId] INT , [GlobalAttributeId] INT,[AttributeDisplayOrder] int ,Attributes int )
		Declare	@EntityAttributeValueList as	table
		(
			IsInput bit, IsMedia BIT, AttributeValues int,WidgetGlobalAttributeValueId int,GlobalAttributeId int,AttributeValue nvarchar(max),
			GlobalAttributeValueId int,GlobalAttributeDefaultValueId int,AttributeDefaultValueCode nvarchar(300),
			AttributeDefaultValue nvarchar(300),MediaId int,MediaPath nvarchar(300) ,SwatchText nvarchar(300),DisplayOrder int,
			SingleAttributeValue nvarchar(max), CMSContainerProfileVariantId INT,LocaleId INT
		)
		Declare	@EntityAttributeSingleValueList as table(AttributeValues int,PortalGlobalAttributeValueId int,GlobalAttributeId int)

		Declare @LocaleId INT , @GetDate DATETIME =dbo.Fn_GetDate()

		IF @ContainerKey <> ''
		BEGIN
			Select @CMSContentContainerId= CMSContentContainerId 
			from ZnodeCMSContentContainer  
			WHERE ContainerKey = @ContainerKey
		END

		INSERT INTO @EntityAttributeValueList
		(
			IsInput, IsMedia,AttributeValues,WidgetGlobalAttributeValueId,GlobalAttributeId,GlobalAttributeValueId,GlobalAttributeDefaultValueId,
			AttributeValue ,MediaId,MediaPath,SingleAttributeValue,CMSContainerProfileVariantId, LocaleId
		)
		Select case when zga.GroupAttributeType in('Input','TextArea')   then 1  else 0 end ,
				0, 1, aa.WidgetGlobalAttributeValueId,aa.GlobalAttributeId,aa.WidgetGlobalAttributeValueId,bb.GlobalAttributeDefaultValueId,

			case when zga.GroupAttributeType in('Input','TextArea')   then null  else  bb.AttributeValue  end AttributeValue,	  
			bb.MediaId,bb.MediaPath,
			case when zga.GroupAttributeType in('Input','TextArea')   then bb.AttributeValue   else null end  SingleAttributeValue,
			aa.CMSContainerProfileVariantId, bb.LocaleId
		FROM ZnodeWidgetGlobalAttributeValue aa
		INNER JOIN ZnodeWidgetGlobalAttributeValueLocale bb ON bb.WidgetGlobalAttributeValueId = aa.WidgetGlobalAttributeValueId 
		INNER JOIN View_ZnodeGlobalAttribute zga on zga.[GlobalAttributeId]=aa.[GlobalAttributeId]
		WHERE (aa.CMSContainerProfileVariantId = @ContainerProfileVariantId OR @ContainerProfileVariantId = 0)
		AND (AA.CMSContentContainerId = @CMSContentContainerId OR ISNULL(@CMSContentContainerId,0) = 0 )
		AND bb.MediaId IS NULL 
				

		INSERT INTO @EntityAttributeValueList
		(IsInput,IsMedia,AttributeValues,WidgetGlobalAttributeValueId,GlobalAttributeId,GlobalAttributeValueId,GlobalAttributeDefaultValueId,AttributeValue ,MediaId,MediaPath,SingleAttributeValue,CMSContainerProfileVariantId,LocaleId)
		Select 1,1 ,1, aa.WidgetGlobalAttributeValueId,aa.GlobalAttributeId,aa.WidgetGlobalAttributeValueId,null GlobalAttributeDefaultValueId,
			NULL AttributeValue,	  
			NULL MediaId,null MediaPath,
			NULL SingleAttributeValue, aa.CMSContainerProfileVariantId	,bb.LocaleId
		FROM dbo.ZnodeWidgetGlobalAttributeValue aa
		INNER JOIN ZnodeWidgetGlobalAttributeValueLocale bb ON bb.WidgetGlobalAttributeValueId = aa.WidgetGlobalAttributeValueId 
		INNER JOIN View_ZnodeGlobalAttribute zga on zga.[GlobalAttributeId]=aa.[GlobalAttributeId]
		WHERE (AA.CMSContentContainerId = @CMSContentContainerId OR ISNULL(@CMSContentContainerId,0) = 0 )
		AND zga.GroupAttributeType ='Media'


		UPDATE aa
		Set SingleAttributeValue= ( Select bb.MediaPath FROM  ZnodeWidgetGlobalAttributeValueLocale bb 
			WHERE bb.WidgetGlobalAttributeValueId = aa.WidgetGlobalAttributeValueId
			FOR XML PATH ('') )				
		FROM  @EntityAttributeValueList aa
		WHERE aa.IsMedia=1

		UPDATE aa
		Set SingleAttributeValue= replace(replace(SingleAttributeValue,'</MediaPath>',','),'<MediaPath>','')
		FROM  @EntityAttributeValueList aa
		WHERE aa.IsMedia=1

		UPDATE aa
		Set SingleAttributeValue= Substring(SingleAttributeValue,1,len(SingleAttributeValue)-1)
		FROM  @EntityAttributeValueList aa
		WHERE aa.IsMedia=1

		UPDATE aa
		SET AttributeDefaultValueCode= h.AttributeDefaultValueCode,
			SwatchText=h.SwatchText,
			AttributeValue=g.AttributeDefaultValue,
			GlobalAttributeDefaultValueId=g.GlobalAttributeDefaultValueId,
			DisplayOrder=h.DisplayOrder
		FROM  @EntityAttributeValueList aa
		INNER JOIN dbo.ZnodeGlobalAttributeDefaultValue h ON h.GlobalAttributeDefaultValueId = aa.GlobalAttributeDefaultValueId                                       
		INNER JOIN dbo.ZnodeGlobalAttributeDefaultValueLocale g ON h.GlobalAttributeDefaultValueId = g.GlobalAttributeDefaultValueId and aa.LocaleId = g.LocaleId
          
		INSERT INTO @TBL_GlobalAttributeGrouplist
		([GlobalAttributeGroupId] , [AttributeGroupDisplayOrder],Groups )
		SELECT ss.[GlobalAttributeGroupId],ss.[AttributeGroupDisplayOrder],1
		FROM [dbo].[ZnodeGlobalGroupEntityMapper] SS
		INNER JOIN dbo.ZnodeGlobalEntity aa on ss.[GlobalEntityId]=aa.[GlobalEntityId]
		WHERE aa.EntityName='Content Containers'
		--FOR XML PATH('')

		INSERT INTO @TBL_GlobalAttributelist
		([GlobalAttributeGroupId] , [GlobalAttributeId],[AttributeDisplayOrder],Attributes )
		SELECT aa.[GlobalAttributeGroupId],aa.[GlobalAttributeId] ,aa.[AttributeDisplayOrder],1
		FROM [dbo].[ZnodeGlobalAttributeGroupMapper] aa
		INNER JOIN @TBL_GlobalAttributeGrouplist ss on ss.GlobalAttributeGroupId=aa.GlobalAttributeGroupId
			
		IF object_id('tempdb..[#GlobalAttributeGrouplist]') IS NOT NULL
			drop table tempdb..#GlobalAttributeGrouplist

		CREATE TABLE #GlobalAttributeGrouplist 
		( 
			CMSContainerProfileVariantId INT,LocaleId	int,GlobalAttributeGroupId	int	,GroupCode	varchar	(200),AttributeGroupName nvarchar(600),AttributeGroupDisplayOrder int,
			GlobalAttributeId	int	,AttributeDisplayOrder	int	,AttributeCode	nvarchar	(600),AttributeName	nvarchar	(600),IsRequired	bit	,
			AttributeTypeName	varchar	(300),AttributeTypeId	int	,SingleAttributeValue	nvarchar(max),SelectValues	nvarchar(max)
		)

		SET @LocaleId = 0 

		INSERT INTO @TBL_Locale (LocaleId) 
		SELECT LocaleId FROM ZnodeLocale WHERE IsActive =1 AND (LocaleId  = @LocaleId OR @LocaleId = 0 )

		SET @MaxCount = ISNULL((SELECT MAx(RowId) FROM @TBL_Locale),0)
		WHILE @IncrementalId <= @MaxCount
		BEGIN 
			SET @SetLocaleId = (SELECT Top 1 LocaleId FROM @TBL_locale WHERE RowId = @IncrementalId)
			;With Cte_GetCmsContentContainerData AS 
			(
			Select distinct @SetLocaleId AS LocaleId, sv.CMSContainerProfileVariantId,
				aa.[GlobalAttributeGroupId] AS 'GlobalAttributeGroupId' ,
				zgag.GroupCode	AS 'GroupCode'		 ,  
				zgagl.AttributeGroupName  AS 'AttributeGroupName'   ,
				AttributeGroupDisplayOrder 	 , 
				ss.GlobalAttributeId	 AS 'GlobalAttributeId'	 ,
				ss.[AttributeDisplayOrder] AS 'AttributeDisplayOrder'	,
				zga.AttributeCode AS 'AttributeCode'	,			
				zgal.AttributeName AS 'AttributeName'	,
				zga.IsRequired AS 'IsRequired'	,
				zga.AttributeTypeName AS 'AttributeTypeName'      ,
				zga.AttributeTypeId AS 'AttributeTypeId' 		,
				sv.SingleAttributeValue AS 'SingleAttributeValue'	,	
	   
				( Select 
				SelectValuesEntity.DisplayOrder					as DisplayOrder,
				SelectValuesEntity.GlobalAttributeDefaultValueId as GlobalAttributeDefaultValueId,
				SelectValuesEntity.AttributeValue				as [Value]	,
				SelectValuesEntity.AttributeDefaultValueCode		as Code	,
				SelectValuesEntity.SwatchText                    as SwatchText	,
				SelectValuesEntity.MediaPath		         		as [Path]	
				FROM  @EntityAttributeValueList SelectValuesEntity 
				WHERE SelectValuesEntity.WidgetGlobalAttributeValueId = sv.WidgetGlobalAttributeValueId
				and SelectValuesEntity.LocaleId = sv.LocaleId and 
				zga.GroupAttributeType ='Select'
				FOR JSON Auto, INCLUDE_NULL_VALUES    
				)  as 'SelectValues'
			FROM 
				@TBL_GlobalAttributeGrouplist aa				
				INNER JOIN @TBL_GlobalAttributelist ss on  ss.GlobalAttributeGroupId=aa.GlobalAttributeGroupId
				INNER JOIN ZnodeGlobalAttributeGroup zgag on zgag.[GlobalAttributeGroupId]=aa.[GlobalAttributeGroupId]
				INNER JOIN ZnodeGlobalAttributeGroupLocale zgagl on zgagl.GlobalAttributeGroupId=zgag.GlobalAttributeGroupId
				INNER JOIN View_ZnodeGlobalAttribute zga       on zga.[GlobalAttributeId]=ss.[GlobalAttributeId]
				INNER JOIN ZnodeGlobalAttributeLocale zgal on zga.[GlobalAttributeId]=zgal.[GlobalAttributeId]
				INNER JOIN @EntityAttributeValueList sv   on sv.[GlobalAttributeId]=ss.[GlobalAttributeId]
				WHERE zgagl.LocaleId= zgal.LocaleId and 
				(sv.LocaleId = @SetLocaleId)  
			)
	     	, Cte_GetFirstFilterData AS
			(
				SELECT CMSContainerProfileVariantId,LocaleId,GlobalAttributeGroupId,GroupCode,AttributeGroupName,AttributeGroupDisplayOrder,
						GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName,IsRequired,AttributeTypeName,
						AttributeTypeId,SingleAttributeValue,SelectValues
				FROM Cte_GetCmsContentContainerData 
				WHERE LocaleId = @SetLocaleId
			)
			, Cte_GetDefaultFilterData AS
			(
				SELECT CMSContainerProfileVariantId,LocaleId,GlobalAttributeGroupId,GroupCode,AttributeGroupName,AttributeGroupDisplayOrder,
						GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName,IsRequired,AttributeTypeName,
						AttributeTypeId,SingleAttributeValue,SelectValues
				FROM  Cte_GetFirstFilterData 
				UNION ALL 
				SELECT CMSContainerProfileVariantId,LocaleId,GlobalAttributeGroupId,GroupCode,AttributeGroupName,AttributeGroupDisplayOrder,
						GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName,IsRequired,AttributeTypeName,
						AttributeTypeId,SingleAttributeValue,SelectValues
				FROM Cte_GetCmsContentContainerData CTEC 
				WHERE LocaleId = @DefaultLocaleId 
				AND NOT EXISTS (SELECT TOP 1 1 FROM Cte_GetFirstFilterData CTEFD WHERE CTEFD.GlobalAttributeGroupId = CTEC.GlobalAttributeGroupId )
			)
			INSERT INTO #GlobalAttributeGrouplist 
			(
				CMSContainerProfileVariantId,LocaleId,GlobalAttributeGroupId,GroupCode,AttributeGroupName,AttributeGroupDisplayOrder,
				GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName,IsRequired,AttributeTypeName,
				AttributeTypeId,SingleAttributeValue,SelectValues
			)
			SELECT DISTINCT CMSContainerProfileVariantId,@SetLocaleId,GlobalAttributeGroupId,GroupCode,AttributeGroupName,AttributeGroupDisplayOrder,
					GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName,IsRequired,AttributeTypeName,
					AttributeTypeId,SingleAttributeValue,SelectValues
			FROM Cte_GetDefaultFilterData
						
				SET @IncrementalId = @IncrementalId +1 
		End 
		--select * into ##GlobalAttributeGrouplist from #GlobalAttributeGrouplist
	--select distinct CMSContainerProfileVariantId,GlobalAttributeGroupId,GroupCode,AttributeGroupName,AttributeGroupDisplayOrder,LocaleId 
	--into #GroupMaster from #GlobalAttributeGrouplist
	
	--If (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  ) 
	--Begin
	--    --Data inserted into flat table ZnodePublishWidgetSliderBannerEntity (Replica of MongoDB Collection )  

	--	Delete from ZnodePublishContentContainerVariantEntity WHERE  VersionId = @VersionId
	 		 

	--	INSERT INTO ZnodePublishPortalGlobalAttributeEntity
	--	(
	--		VersionId,PublishStartTime,PortalId,PortalName,LocaleId,GlobalAttributeGroups
	--	)
	  	
			--Select Distinct PV.CMSContainerProfileVariantId,PV.LocaleId,  (Select 
			--A.GlobalAttributeGroupId AS 'GlobalAttributeGroupId',
			--A.GroupCode AS 'GroupCode',
			--A.AttributeGroupName AS 'AttributeGroupName',
			--A.AttributeGroupDisplayOrder AS 'AttributeGroupDisplayOrder',
			--A.LocaleId AS 'LocaleId', 
			--(
			--	Select DISTINCT GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName ,IsRequired ,	
			--	AttributeTypeName,AttributeTypeId,SingleAttributeValue,SelectValues 
			--	from #GlobalAttributeGrouplist B WHERE A.GlobalAttributeGroupId = B.GlobalAttributeGroupId 
			--	AND A.LocaleId = B.LocaleId AND A.CMSContainerProfileVariantId = B.CMSContainerProfileVariantId
			--	For JSON Path 
			--) AS 'GlobalAttributes'
			--from #GlobalAttributeGrouplist A WHERE A.CMSContainerProfileVariantId = PV.CMSContainerProfileVariantId AND A.LocaleId = PV.LocaleId For Json Path) GlobalAttributes
			--FROM  #GlobalAttributeGrouplist  PV 

			SELECT DISTINCT A.CMSContainerProfileVariantId,A.LocaleId,  
			(
				SELECT DISTINCT GlobalAttributeGroupId, GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName ,IsRequired ,	
				AttributeTypeName,AttributeTypeId,SingleAttributeValue As AttributeValue,SelectValues 
				FROM #GlobalAttributeGrouplist B
				WHERE A.GlobalAttributeGroupId = B.GlobalAttributeGroupId 
				AND A.LocaleId = B.LocaleId AND A.CMSContainerProfileVariantId = B.CMSContainerProfileVariantId
				--AND GlobalAttributeId=32 and A.GlobalAttributeGroupId=23
				For JSON Path 
			) AS 'GlobalAttributes'
			FROM #GlobalAttributeGrouplist  A
	--End
	---------------------------- End Preview 
	--If (@RevisionState like '%Production%' OR @RevisionState = 'None')
	--Begin
	--	-- Only production version id will process 
	--	Delete from ZnodePublishPortalGlobalAttributeEntity WHERE  VersionId in (Select ProductionVersionId from @Tbl_ProductionVersionId)
	--	AND PortalId = @PortalId
	 		 

	--	INSERT INTO ZnodePublishPortalGlobalAttributeEntity
	--	(
	--		VersionId,PublishStartTime,PortalId,PortalName,LocaleId,GlobalAttributeGroups
	--	)
			  	
	--		Select Distinct PV.ProductionVersionId, Getdate(),  @PortalId,@StoreName, PV.LocaleId, (Select 
	--		A.GlobalAttributeGroupId AS 'GlobalAttributeGroupId',
	--		A.GroupCode AS 'GroupCode',
	--		A.AttributeGroupName AS 'AttributeGroupName',
	--		A.AttributeGroupDisplayOrder AS 'AttributeGroupDisplayOrder',
	--		A.LocaleId AS 'LocaleId', 
	--		(
	--			Select GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName ,IsRequired ,	
	--			AttributeTypeName,AttributeTypeId,SingleAttributeValue,SelectValues 
	--			from #GlobalAttributeGrouplist B WHERE A.GlobalAttributeGroupId = B.GlobalAttributeGroupId 
	--			AND A.LocaleId = B.LocaleId
	--			For JSON Path 
	--		) AS 'GlobalAttributes'
	--		from #GroupMaster A  WHERE A.LocaleId = PV.LocaleId  For Json Path) 
	--		FROM  @Tbl_ProductionVersionId  PV 

	--End

END TRY
BEGIN CATCH
	SELECT ERROR_MESSAGE(), ERROR_PROCEDURE();

END CATCH;
END;

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodeUserRegistrationAttempt')
BEGIN
	CREATE TABLE [dbo].[ZnodeUserRegistrationAttempt](
		[Id] [int] IDENTITY(1,1) NOT NULL,
		[UserName] [nvarchar](256) NOT NULL,
		[PortalId] [int] NULL,
		[CreatedDate] [datetime] NOT NULL,
	 CONSTRAINT [PK_ZnodeUserRegistrationAttempt] PRIMARY KEY CLUSTERED 
	(
		[Id] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
	) ON [PRIMARY]
END 

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_RemoveUserRegistrationAttemptDetails')
	DROP PROC Znode_RemoveUserRegistrationAttemptDetails

GO

CREATE PROCEDURE [dbo].[Znode_RemoveUserRegistrationAttemptDetails]	
(
	@Status BIT = 0 OUT
)
/* SP used to delete auth token*/
AS
BEGIN
BEGIN TRY
SET NOCOUNT ON;
	TRUNCATE Table [dbo].[ZnodeUserRegistrationAttempt]
	SET @Status = 1
	SELECT 1 AS Id, @Status AS Status
END TRY
BEGIN CATCH
	SET @Status = 0
	SELECT ERROR_MESSAGE()
	SELECT 0 AS Id, @Status AS Status
END CATCH
END

GO

INSERT INTO [dbo].[ZnodeEmailTemplate]([TemplateName],[CreatedBy],[CreatedDate],[ModifiedBy],[ModifiedDate])
select 'RegistrationAttemptUsingExistingUsername' ,2 ,Getdate() ,2 ,Getdate()
where not exists(select * from [ZnodeEmailTemplate] where [TemplateName] = 'RegistrationAttemptUsingExistingUsername' )
GO
INSERT INTO [dbo].[ZnodeEmailTemplateAreas] ([Name] ,[Code] ,[CreatedBy] ,[CreatedDate] ,[ModifiedBy] ,[ModifiedDate])
select 'RegistrationAttemptUsingExistingUsername' ,'RegistrationAttemptUsingExistingUsername' ,2  ,Getdate() ,2 ,Getdate()
where not exists(select * from [ZnodeEmailTemplateAreas] where [Name] = 'RegistrationAttemptUsingExistingUsername' )

GO
INSERT INTO [dbo].[ZnodeEmailTemplateMapper]
          ([EmailTemplateId] ,[PortalId] ,[EmailTemplateAreasId] ,[IsActive]  ,[CreatedBy] ,[CreatedDate] ,[ModifiedBy] ,[ModifiedDate] ,[IsEnableBcc])
select (select top 1 [EmailTemplateId]  from [ZnodeEmailTemplate] where [TemplateName] = 'RegistrationAttemptUsingExistingUsername' )
          ,PortalID ,(select top 1 [EmailTemplateAreasId] from [ZnodeEmailTemplateAreas] where [Name] = 'RegistrationAttemptUsingExistingUsername' )
          ,1 ,2 ,Getdate() ,2 ,Getdate() ,0
from ZnodePortal ZP
where not exists(select * from [ZnodeEmailTemplateMapper] ZETM where [EmailTemplateId] = (select top 1 [EmailTemplateId]  from [ZnodeEmailTemplate] where [TemplateName] = 'RegistrationAttemptUsingExistingUsername' )
      and ZP.PortalID = ZETM.PortalID and [EmailTemplateAreasId] = (select top 1 [EmailTemplateAreasId] from [ZnodeEmailTemplateAreas] where [Name] = 'RegistrationAttemptUsingExistingUsername' ))
GO
INSERT INTO [dbo].[ZnodeEmailTemplateLocale]
          ([EmailTemplateId]  ,[Subject] ,[Descriptions] ,[Content] ,[LocaleId] ,[CreatedBy] ,[CreatedDate] ,[ModifiedBy] ,[ModifiedDate])
select (select top 1 [EmailTemplateId]  from [ZnodeEmailTemplate] where [TemplateName] = 'RegistrationAttemptUsingExistingUsername' )
          ,'Registration Attempt','This template is used for notifying customers that an attempt has been made to register using their username.'
		  ,'<div style="font-family: Arial, Helvetica; border: 1px solid black;"><div style="background-color: #6074a6; font-size: 1.5em; font-weight: bold; padding-top: .5em; padding-bottom: .5em; padding-left: 1em; border-bottom: solid 1px #edffff; color: white;"><span style="background-color: #ffffff; color: #000000; font-size: 11px;">#StoreLogo#</span>&nbsp;Registration Attempt</div><div style="padding: 1em;"><div>Dear #Username#,</div><br/><div>An account registration attempt was made with your Username/Email. Forgot your password? Please request a link to reset your password. #Link#</div><br/><div>Please contact customer service for additional help!</div><br/><div>Thank and Regards,<br /> #StoreName# Support</div><br/></div>'
		  ,1 ,2 ,Getdate() ,2  ,Getdate()
Where not exists(select * from [ZnodeEmailTemplateLocale] where [EmailTemplateId] = (select top 1 [EmailTemplateId]  from [ZnodeEmailTemplate] where [TemplateName] = 'RegistrationAttemptUsingExistingUsername' ))

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetERPTaskSchedulerDetail')
	DROP PROC Znode_GetERPTaskSchedulerDetail
GO

CREATE PROCEDURE [dbo].[Znode_GetERPTaskSchedulerDetail]
( @ERPTaskSchedulerId INT)
AS
  /*
    
    Summary:  List of erp task scheduler details by ERPTaskSchedulerId    		              
    Unit Testing         	
       EXEC Znode_GetERPTaskSchedulerDetail 1   
   */ 
	 BEGIN
         BEGIN TRY
             SET NOCOUNT ON;
             SELECT ERPTaskSchedulerId, 
					ISNULL(ERPConfiguratorId, 0) ERPConfiguratorId,
					SchedulerName, 
					SchedulerType,
					TouchPointName,
					SchedulerFrequency,
					CASE WHEN ISNULL(StartDate,'1900-01-01 00:00:00.000')='1900-01-01 00:00:00.000' THEN null ELSE StartDate END AS StartDate,  
					ZETS.CreatedBy,
					ZETS.CreatedDate,
					ZETS.ModifiedBy,
					ZETS.ModifiedDate,
					ZETS.IsEnabled,
					SchedulerCallFor,
					CronExpression,
					HangfireJobId
             FROM ZnodeERPTaskScheduler AS ZETS
             WHERE ZETS.ERPTaskSchedulerId = @ERPTaskSchedulerId;
         END TRY
         BEGIN CATCH
               DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetERPTaskSchedulerDetail @ERPTaskSchedulerId = '+CAST(@ERPTaskSchedulerId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		    
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetERPTaskSchedulerDetail',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_AdminUsersByUserId')
	DROP PROC Znode_AdminUsersByUserId
GO


CREATE PROCEDURE [dbo].[Znode_AdminUsersByUserId]
(	@RoleName		VARCHAR(200),
    @UserName		VARCHAR(200),
    @WhereClause	XML,
    @Rows			INT           = 100,
    @PageNo			INT           = 1,
    @Order_By		VARCHAR(1000) = '',
    @RowCount		INT        = 0 OUT,
	@IsCallOnSite   BIT = 0 ,
	@PortalId		VARCHAR(1000) = 0,
	@IsGuestUser    BIT = 0,
	@ColumnName     dbo.SelectColumnList ReadOnly,
	@SalesRepUserId int = 0
)
AS
   /* 
      Summary: List of users with details and shows link with ASPNet tables 
      This procedure is used for finding both users and admin users 
      here use three view "View_RoleUsers" for check  @UserName is present or not 
      "View_AdminUserDetail"  this view use for admin users 
      "View_CustomerUserDetail" Use for customer users 
      Unit Testing   
	  SELECT * FROM ZnodeUser 
      DECLARE @EDE INT=0  EXEC Znode_AdminUsersByUserId '','admin@znode.com',@WhereClause='',@Order_By='',@PageNo= 1 ,@Rows= 214,@IsCallOnSite='false',@PortalId=0,@RowCount=@EDE OUT  SELECT @EDE
   */
     BEGIN
         BEGIN TRY
            SET NOCOUNT ON;
			
            DECLARE @SQL NVARCHAR(MAX)= '', @PaginationWhereClause VARCHAR(300)= dbo.Fn_GetRowsForPagination(@PageNo, @Rows, ' WHERE RowId');
             
			----Verifying that the @SalesRepUserId is having 'Sales Rep' role
			IF NOT EXISTS
			(
				SELECT * FROM ZnodeUser ZU
				INNER JOIN AspNetZnodeUser ANZU ON ZU.UserName = ANZU.UserName
				INNER JOIN AspNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName
				INNER JOIN AspNetUserRoles ANUR ON ANU.Id = ANUR.UserId
				Where Exists(select * from AspNetRoles ANR Where Name = 'Sales Rep' AND ANUR.RoleId = ANR.Id) 
				AND ZU.UserId = @SalesRepUserId
			)   
			Begin
				SET @SalesRepUserId = 0
			End

			IF OBJECT_ID('tempdb..#TBL_RowCount') is not null
				DROP TABLE #TBL_RowCount
			Create table #TBL_RowCount(RowsCount int )
			-----Split where clause XMl 
			CREATE TABLE #WhereColumnList(RowId Int identity, filterName varchar(max), WhereCondition varchar(max))
			insert into #WhereColumnList(filterName,WhereCondition)
			SELECT 
					Tbl.Col.value('key[1]', 'varchar(max)') as filterName,
					Tbl.Col.value('condition[1]', 'varchar(max)') WhereCondition
			FROM   @WhereClause.nodes('//filter') Tbl(Col) 
			----Address column in global search
			declare @AddressGlobalSearch varchar(1000)
			declare @GlobalSearch varchar(100)
			select @GlobalSearch = substring(WhereCondition,charindex(' like ',WhereCondition), charindex(' OR ',WhereCondition)-charindex(' like ',WhereCondition)) 
			from #WhereColumnList
			where filtername like '%|%'
			and filtername <> ''
			and filterName in ('CityName','CountryName','PostalCode','StateName','CompanyName') 

			if isnull(@GlobalSearch,'') <> ''
			begin
				select @AddressGlobalSearch = '('+'CityName '+ @GlobalSearch+' OR '+'CountryName '+ @GlobalSearch+' OR '+'PostalCode '+ @GlobalSearch+' OR '+'StateName '+ @GlobalSearch+' OR '+'CompanyName '+ @GlobalSearch+')'
			end
			else
			begin
				SET @AddressGlobalSearch = ''
			end
			----Global search where clause
			declare @WhereClauseGlobal varchar(1000)=''
			select @WhereClauseGlobal = ISNULL(WhereCondition,'')
			from #WhereColumnList
			where filtername like '%|%'
			and filtername <> ''
			
			----Where clause columns except Address columns
			declare @WhereClause1 varchar(max) 
			select @WhereClause1 = COALESCE(@WhereClause1 + '', '') + WhereCondition+' And '
			--case when @WhereClause1 <> ''  then ' And ' else '' end
			from #WhereColumnList a
			where filterName not like '%|%' and
			filterName not in ('CountryName','CityName','StateName','PostalCode','CompanyName')
			and filtername <> ''

			if @WhereClause1 <> ''
			begin
				set @WhereClause1=isnull(substring(@WhereClause1,1,len(@WhereClause1)-3),'')
			end
			else
			begin
				set @WhereClause1 = ''
			end

			----Where clause columns
			declare @AddressColumnWhereClause varchar(max) 
			select @AddressColumnWhereClause = COALESCE(@AddressColumnWhereClause + '', '') + WhereCondition+' And '
			from #WhereColumnList a
			where filterName not like '%|%' and
			filterName in ('CountryName','CityName','StateName','PostalCode','CompanyName')
			and filtername <> ''
			
			if isnull(@AddressColumnWhereClause,'') <> ''
			begin
				set @AddressColumnWhereClause=isnull(substring(@AddressColumnWhereClause,1,len(@AddressColumnWhereClause)-3),'')
            end
			else
			begin
				set @AddressColumnWhereClause = ''
			end

			declare @WhereClauseAll varchar(max)
			select @WhereClauseAll = COALESCE(@WhereClauseAll + '', '') + WhereCondition+' And '
			from #WhereColumnList a

			set @WhereClauseAll=isnull(substring(@WhereClauseAll,1,len(@WhereClauseAll)-3),'')
			-------------- 

			IF @PortalId  <> '0' 
			BEGIN 
				SELECT @PortalId = STUFF((SELECT CONCAT(', ', ISNULL(ZUP2.PortalId,@PortalId))
					FROM dbo.ZnodeUserPortal ZUP2 WITH (NOLOCK)
					WHERE ZUP1.UserId = ZUP2.UserId
					FOR XML PATH ('')), 1, 2, '')
				FROM dbo.ZnodeUserPortal ZUP1 WITH (NOLOCK)
				WHERE ZUP1.UserId=(SELECT TOP 1 UserId FROM ZnodeUser WITH (NOLOCK) WHERE UserName=@UserName)
				GROUP BY ZUP1.UserId;

			    SET @WhereClauseAll = CASE WHEN  @WhereClauseAll = '' THEN ' (PortalId IN ('+@PortalId+') OR PortalId IS NULL) ' ELSE @WhereClauseAll+' AND (PortalId IN ('+@PortalId+') OR PortalId IS NULL) ' END 

				SET @WhereClause1 = CASE WHEN  @WhereClause1 = '' THEN ' (isnull(PortalId,0) IN ('+@PortalId+') OR PortalId IS NULL) ' ELSE @WhereClause1+' AND (isnull(PortalId,0) IN ('+@PortalId+') OR PortalId IS NULL) ' END 
			
			END 
			IF EXISTS ( SELECT TOP 1 1 FROM View_RoleUsers  WHERE Username = @UserName   )  AND @RoleName <> ''  
			-- this check for admin user
       		BEGIN
				SET @SQL = ' SELECT  A.UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,A.CreatedBy,A.CreatedDate,A.ModifiedBy,A.ModifiedDate
				,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
				,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId ,CustomerPaymentGUID
				INTO #Cte_AdminUserDetail
				FROM View_AdminUserDetail A
				'+CASE WHEN @PortalId  <> '0' THEN ' INNER JOIN ZnodeUserPortal ZUP ON (ZUP.UserId = A.UserId) 'ELSE '' END  +'	 
				'+dbo.Fn_GetWhereClause(@WhereClauseAll, ' WHERE ')+'
				
				;with Cte_AdminUserDetailRowId AS 
				(
				SELECT UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
				,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
				,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId,CustomerPaymentGUID ,RANK()Over('+dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC')+',UserId DESC) RowId
				FROM  #Cte_AdminUserDetail a
				where (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
				)
					 
				SELECT UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
				,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
				,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId,CustomerPaymentGUID ,RowId 
				INTO #AccountDetails
				FROM Cte_AdminUserDetailRowId 
					 
				SET @Count= ISNULL((SELECT  Count(1) FROM #AccountDetails ),0)
					 
				SELECT DISTINCT UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
				,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
				,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId ,CustomerPaymentGUID
				FROM #AccountDetails '+@PaginationWhereClause+' '+dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC' );
				EXEC SP_executesql
				@SQL,
				N'@Count INT OUT',
				@Count = @RowCount OUT;
			END;
			-- For Customer user
            ELSE   
			BEGIN
				IF @roleName = ''
				BEGIN
					if OBJECT_ID('tempdb..##CustomerUserAddDetail') is not null
					drop table ##CustomerUserAddDetail

					if OBJECT_ID('tempdb..##View_CustomerUserAddDetail') is not null
					drop table ##View_CustomerUserAddDetail
				
					if OBJECT_ID('tempdb..##UserList') is not null
					drop table ##UserList

					CREATE TABLE ##UserList(UserId int,AddressID int)

					declare @UserList varchar(1000)=''

					------To get the list of user having adress column in global search
					if (@AddressGlobalSearch <> '')
					begin
				
					set @UserList = 'select a.UserId, b.AddressID	from ZnodeUserAddress a	inner join ZnodeAddress b on a.AddressId = b.AddressId	where '+@AddressGlobalSearch
					--print @UserList
					insert into ##UserList(UserId, b.AddressID)
					exec (@UserList)
			
					end
					----To get the list of user having adress column in where clause 
					if (@AddressColumnWhereClause <> '')
					begin
					
					set @UserList = 'select a.UserId, b.AddressID	from ZnodeUserAddress a	inner join ZnodeAddress b on a.AddressId = b.AddressId	where '+@AddressColumnWhereClause
					--print @UserList
					insert into ##UserList(UserId,AddressID)
					exec (@UserList)
					
					end

					If @IsGuestUser= 0 
					AND
					NOT Exists (Select filterName from #WhereColumnList where filterName in ('accountid','isaccountcustomer','UserId') and filtername <> '')
					-- Customer List with GuestUsers
					Begin
						SET @SQL = 
							'SELECT a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
							 a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATE, a.CreatedDate) CreatedDate,A.ModifiedBy,
							 CONVERT( DATE, a.ModifiedDate) ModifiedDate, 0 RoleId,
							 CASE WHEN A.AccountId IS NULL THEN '''' ELSE r.name END as RoleName,
							 CASE	WHEN B.LockoutEndDateUtc IS NULL
							 THEN CAST(1 AS    BIT)	ELSE CAST(0 AS BIT)
							 END IsActive,	CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
				
							 (ISNULL(RTRIM(LTRIM(a.FirstName)), '''')+'' ''+ISNULL(RTRIM(LTRIM(a.MiddleName)), '''')+CASE
							 WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '''') = ''''	THEN ''''
							 ELSE '' ''	END+ISNULL(RTRIM(LTRIM(a.LastName)), '''')) 
				
							 FullName,
							 e.Name AccountName
							 ,a.AccountId,a.ExternalId,	CASE	WHEN a.AccountId IS NULL THEN 0	ELSE 1	END IsAccountCustomer,
							 a.BudgetAmount,
							 '''' TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser,a.CustomerPaymentGUID
							 --,CASE WHEN zp.StoreName IS NULL THEN ''ALL'' ELSE zp.StoreName END StoreName,
							 ,ISnull(zp.StoreName , ''ALL'')StoreName,
							 up.PortalId as PortalId, e.AccountCode
							 into ##View_CustomerUserAddDetail
							 FROM ZnodeUser a
							 INNER JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
							 INNER JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
							 LEFT JOIN ZnodeUserPortal up ON(up.UserId = a.UserId)  
							 LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
							 LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
							 LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
							 LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)
							 WHERE (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid ) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
							' 
						EXEC (@SQL)
					End	
					Else If @IsGuestUser= 1 
					Begin
							SET @SQL='SELECT a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
							a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATE, a.CreatedDate) CreatedDate,A.ModifiedBy,
							CONVERT( DATE, a.ModifiedDate) ModifiedDate,ur.RoleId,r.Name RoleName,
							CASE WHEN B.LockoutEndDateUtc IS NULL THEN CAST(1 AS    BIT) ELSE CAST(0 AS BIT) END IsActive,
							CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
							(ISNULL(RTRIM(LTRIM(a.FirstName)), '''')+'' ''+ISNULL(RTRIM(LTRIM(a.MiddleName)), '''')+CASE
							WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '''') = '''' THEN '''' ELSE '' '' END+ISNULL(RTRIM(LTRIM(a.LastName)), '''')) FullName,
							e.Name AccountName,a.AccountId,a.ExternalId,
							CASE WHEN a.AccountId IS NULL THEN 0 ELSE 1	END IsAccountCustomer,
							a.BudgetAmount,r.TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser,a.CustomerPaymentGUID
							,CASE WHEN zp.StoreName IS NULL THEN ''ALL'' ELSE zp.StoreName END StoreName,
							CASE WHEN a.AccountId IS NULL THEN up.PortalId ELSE ZPA.PortalId END as PortalId,e.AccountCode
							into ##View_CustomerUserAddDetail
							FROM ZnodeUser a
							LEFT JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
							LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
							LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
							LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)                       
							LEFT JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
							LEFT JOIN ZnodeUserPortal up ON(up.UserId = a.UserId)  
							LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
							LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = a.AccountId) 
							WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUSer ZUQ WHERE ZUQ.UserId = a.UserId AND ZUQ.EmailOptIn = 1 AND ZUQ.AspNetUserId IS NULL )
							AND a.AspNetuserId is null
							AND (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid ) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
							'
						EXEC (@SQL)
					End
					Else IF Exists (Select filterName from #WhereColumnList where filterName in ('UserId') and filtername <> '')
					and  @IsGuestUser= 0   
					-- Customer List for user edit single user 
					Begin
					SET @SQL='SELECT a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
							a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATE, a.CreatedDate) CreatedDate,A.ModifiedBy,
							CONVERT( DATE, a.ModifiedDate) ModifiedDate,ur.RoleId,r.Name RoleName,
							CASE WHEN B.LockoutEndDateUtc IS NULL THEN CAST(1 AS    BIT) ELSE CAST(0 AS BIT) END IsActive,
							CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
							(ISNULL(RTRIM(LTRIM(a.FirstName)), '''')+'' ''+ISNULL(RTRIM(LTRIM(a.MiddleName)), '''')+CASE
							WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '''') = '''' THEN '''' ELSE '' '' END+ISNULL(RTRIM(LTRIM(a.LastName)), '''')) FullName,
							e.Name AccountName,a.AccountId,a.ExternalId,
							CASE WHEN a.AccountId IS NULL THEN 0 ELSE 1	END IsAccountCustomer,
							a.BudgetAmount,r.TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser,a.CustomerPaymentGUID
							,CASE WHEN zp.StoreName IS NULL THEN ''ALL'' ELSE zp.StoreName END StoreName,
							CASE WHEN a.AccountId IS NULL THEN up.PortalId ELSE ZPA.PortalId END as PortalId,e.AccountCode
							into ##View_CustomerUserAddDetail
							FROM ZnodeUser a
							LEFT JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
							LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
							LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
							LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)                       
							LEFT JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
							LEFT JOIN ZnodeUserPortal up ON(up.UserId = a.UserId)  
							LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
							LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = a.AccountId) 
							WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUSer ZUQ WHERE ZUQ.UserId = a.UserId AND ZUQ.EmailOptIn = 1 AND ZUQ.AspNetUserId IS NULL )
							AND (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid ) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
							'
						EXEC (@SQL)
					End	
					Else -- Account user List 
					Begin
							SELECT a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
							a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATE, a.CreatedDate) CreatedDate,A.ModifiedBy,
							CONVERT( DATE, a.ModifiedDate) ModifiedDate,ur.RoleId,r.Name RoleName,
							CASE WHEN B.LockoutEndDateUtc IS NULL THEN CAST(1 AS    BIT) ELSE CAST(0 AS BIT) END IsActive,
							CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
							(ISNULL(RTRIM(LTRIM(a.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(a.MiddleName)), '')+CASE
							WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '') = '' THEN '' ELSE ' ' END+ISNULL(RTRIM(LTRIM(a.LastName)), '')) FullName,
							e.Name AccountName,a.AccountId,a.ExternalId,
							CASE WHEN a.AccountId IS NULL THEN 0 ELSE 1	END IsAccountCustomer,
							a.BudgetAmount,r.TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser,a.CustomerPaymentGUID
							,CASE WHEN zp.StoreName IS NULL THEN 'ALL' ELSE zp.StoreName END StoreName,
							CASE WHEN a.AccountId IS NULL THEN up.PortalId ELSE ZPA.PortalId END as PortalId, e.AccountCode
							into ##View_CustomerUserAddDetail
							FROM ZnodeUser a
							LEFT JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
							LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
							LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
							LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)                       
							LEFT JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
							LEFT JOIN ZnodeUserPortal up ON(up.UserId = a.UserId)  
							LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
							LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = a.AccountId) 
							WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUSer ZUQ WHERE ZUQ.UserId = a.UserId AND ZUQ.EmailOptIn = 1 AND ZUQ.AspNetUserId IS NULL )
							AND (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = @SalesRepUserId and a.UserId = SalRep.CustomerUserid ) or @SalesRepUserId = 0)
					End


					alter table ##View_CustomerUserAddDetail 
					add DepartmentId int, PermissionsName varchar(200), PermissionCode varchar(200), DepartmentName varchar(300), AccountPermissionAccessId int,
					AccountUserOrderApprovalId int, ApprovalName varchar(1000) , ApprovalUserId int
					--, PortalId int , StoreName varchar(1000)
					,CountryName varchar(1000),CityName varchar(1000),StateName varchar(1000),PostalCode varchar(1000), CompanyName varchar(1000),
					SalesRepUserName varchar(600),SalesRepFullName varchar(1000)

	
					IF ((@AddressGlobalSearch like '%CountryName%' OR @AddressGlobalSearch like '%CityName%' OR @AddressGlobalSearch like '%StateName%' OR @AddressGlobalSearch like '%PostalCode%' OR @AddressGlobalSearch like '%CompanyName%')
					and exists(select * from ##UserList))
					BEGIN
						update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
						PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName
						from ##View_CustomerUserAddDetail a
						inner join ZnodeUserAddress ZUA on a.UserId = ZUA.UserId
						inner  JOIN ZnodeAddress ZA on ZA.AddressId = zua.AddressId
						where exists(select * from ##UserList UL where a.UserId = UL.UserId and UL.AddressId = ZA.AddressId )

						update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
						PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName
						from ##View_CustomerUserAddDetail a
						inner join ZnodeAccountAddress ZAA on a.AccountId = ZAA.AccountId
						inner  JOIN ZnodeAddress ZA on ZA.AddressId = ZAA.AddressId
						where isnull(a.AccountId,0)<> 0-- is not null
						and exists(select * from ##UserList UL where a.UserId = UL.UserId and UL.AddressID = ZA.AddressId)
						and (a.CountryName is null OR a.CityName is null OR a.StateName is null or a.PostalCode is null or a.CompanyName is null)
		
					END

					--CREATE NONCLUSTERED INDEX IND_101
					--ON [dbo].[##View_CustomerUserAddDetail] ([userId],[AspNetuserId])

					SET @SQL = '			
						
						create table #AccountDetail
						(
							UserId int,AspNetuserId nvarchar(200),UserName nvarchar(200),FirstName nvarchar(200),MiddleName nvarchar(200),LastName nvarchar(200),
							PhoneNumber nvarchar(100),Email nvarchar(100),EmailOptIn bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,
							RoleId varchar(200),RoleName varchar(200),IsActive bit,IsLock bit,FullName  varchar(1000),AccountName  varchar(200),PermissionsName  varchar(200),
							DepartmentName  varchar(200),DepartmentId int,AccountId int,AccountPermissionAccessId int, ExternalId  varchar(200),BudgetAmount numeric(10,6),
							AccountUserOrderApprovalId int,ApprovalName varchar(200),ApprovalUserId int,PermissionCode varchar(500),CustomerPaymentGUID varchar(500),
							StoreName varchar(200),PortalId int,CountryName varchar(200), CityName varchar(200), StateName varchar(200), PostalCode varchar(200), CompanyName varchar(200)
							,SalesRepUserName varchar(200),SalesRepFullName varchar(200) ,RowId int identity , AccountCode nvarchar(100)
						) 
						'+
						+' insert into #AccountDetail(UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
						EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,FullName,
						AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
						BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode,CustomerPaymentGUID
						,StoreName,PortalId, CountryName, CityName, StateName, PostalCode, CompanyName, AccountCode)
						SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
						EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,FullName,
						AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
						BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode,CustomerPaymentGUID 
						,StoreName,PortalId, CountryName, CityName, StateName, PostalCode, CompanyName, AccountCode
						FROM ##View_CustomerUserAddDetail where 1=1'+
						dbo.Fn_GetWhereClause(@WhereClauseGlobal+case when @WhereClauseGlobal<>'' and @WhereClause1 <> '' then ' And '+@WhereClause1 else @WhereClause1 end, ' AND ')+
						dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC') + '
			
						Insert Into #TBL_RowCount Values(@@RowCount)
							
						SELECT  UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
						EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,FullName,
						AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
						BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode ,CustomerPaymentGUID,StoreName,PortalId,
						CountryName, CityName, StateName, PostalCode, CompanyName, SalesRepUserName, SalesRepFullName, AccountCode
						,Row_Number()Over('+dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC')+')  RowNumber
						into ##CustomerUserAddDetail
						FROM #AccountDetail '+@PaginationWhereClause  +' '+ dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC');

					EXEC (@SQL)
				
					Select @RowCount= isnull(RowsCount  ,0) from #TBL_RowCount

					ALTER TABLE ##CustomerUserAddDetail ADD AddressId Int
					--To get data for DepartmentId
					update CUD SET DepartmentId = i.DepartmentId
					from ##CustomerUserAddDetail cud
					INNER JOIN ZnodeDepartmentUser i ON(i.UserId = cud.UserId)

					--To get data for PermissionsName
					update CUD SET PermissionsName = h.PermissionsName, PermissionCode = h.PermissionCode
					from ##CustomerUserAddDetail cud
					INNER JOIN ZnodeAccountUserPermission f ON(f.UserId = cud.UserId)
					INNER JOIN ZnodeAccountPermissionAccess g ON(g.AccountPermissionAccessId = f.AccountPermissionAccessId)
					INNER JOIN ZnodeAccessPermission h ON(h.AccessPermissionId = g.AccessPermissionId)

					------To get data for DepartmentName
					update CUD SET DepartmentName = j.DepartmentName
					from ##CustomerUserAddDetail cud
					INNER JOIN ZnodeDepartmentUser i ON(i.UserId = cud.UserId)
					INNER JOIN ZnodeDepartment j ON(j.DepartmentId = i.DepartmentId)

					--To get data for AccountPermissionAccessId
					update CUD SET AccountPermissionAccessId = f.AccountPermissionAccessId
					from ##CustomerUserAddDetail cud
					INNER JOIN ZnodeAccountUserPermission f ON(f.UserId = cud.UserId)

					--To get data for AccountPermissionAccessId
					update CUD SET AccountPermissionAccessId = f.AccountPermissionAccessId
					from ##CustomerUserAddDetail cud
					INNER JOIN ZnodeAccountUserPermission f ON(f.UserId = cud.UserId)
	
					--To get data for AccountUserOrderApprovalId
					update CUD SET AccountUserOrderApprovalId = ZAUOA.AccountUserOrderApprovalId
					from ##CustomerUserAddDetail cud
					INNER JOIN ZnodeAccountUserOrderApproval ZAUOA ON cud.UserId = ZAUOA.UserID
	
					--To get data for ApprovalName,ApprovalUserId
					update CUD SET ApprovalName = ISNULL(RTRIM(LTRIM(ZU.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '')
					+CASE
					WHEN ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '') = ''
					THEN ''
					ELSE ' '
					END,
					ApprovalUserId = ZAUOA.ApprovalUserId
					from ##CustomerUserAddDetail cud
					INNER JOIN ZnodeAccountUserOrderApproval ZAUOA ON cud.UserId = ZAUOA.UserID
					INNER JOIN ZnodeUser ZU ON(ZU.UserId = ZAUOA.ApprovalUserId)
	
					----To get data for PortalId
					--update CUD SET PortalId = CASE
					--								WHEN cud.AccountId IS NULL
					--								THEN up.PortalId
					--								ELSE ZPA.PortalId
					--							END 
					--from ##CustomerUserAddDetail cud
					--   LEFT JOIN ZnodeUserPortal up ON(up.UserId = cud.UserId) 
					--LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = cud.AccountId) 
	
					----To get data for CountryName, CityName, StateName, PostalCode, CompanyName
					IF (EXISTS(SELECT * FROM @ColumnName where ([StringColumn] LIKE '%CountryName%' OR [StringColumn] LIKE '%CityName%' OR [StringColumn] LIKE '%StateName%' OR [StringColumn] LIKE '%PostalCode%' OR [StringColumn] LIKE '%CompanyName%'))
					OR (@WhereClauseAll like '%CountryName%' OR @WhereClauseAll like '%CityName%' OR @WhereClauseAll like '%StateName%' OR @WhereClauseAll like '%PostalCode%' OR @WhereClauseAll like '%CompanyName%'))
					BEGIN
			 
						update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
						PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName, a.AddressId = ZA.AddressId
						from ##CustomerUserAddDetail a
						inner join ZnodeAccountAddress ZAA on a.AccountId = ZAA.AccountId
						inner  JOIN ZnodeAddress ZA on ZA.AddressId = ZAA.AddressId
						where isnull(a.AccountId,0)<> 0-- is not null
	 
						update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
						PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName, a.AddressId = ZA.AddressId
						from ##CustomerUserAddDetail a
						inner join ZnodeUserAddress ZUA on a.UserId = ZUA.UserId
						inner  JOIN ZnodeAddress ZA on ZA.AddressId = zua.AddressId
					END

					----Updating SalesRep for user if any 
					update CUAD
					set CUAD.SalesRepUserName = azu.UserName, 
					CUAD.SalesRepFullName = (ISNULL(RTRIM(LTRIM(ZU.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '')
					+CASE
					WHEN ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '') = ''
					THEN ''
					ELSE ' '
					END+ISNULL(RTRIM(LTRIM(ZU.LastName)), '')) 
					from ##CustomerUserAddDetail CUAD
					inner join ZnodeSalesRepCustomerUserPortal SRCUP ON CUAD.UserId = SRCUP.CustomerUserid 
					inner join ZnodeUser ZU ON SRCUP.SalesRepUserId = ZU.UserId
					inner join ASPNetUsers ANU ON(ZU.AspNetuserId = ANU.Id)
					inner join AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = ANU.UserName)

					if ( exists(select * from ##UserList) OR @AddressColumnWhereClause <> '')
					begin
						SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
						EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,
						Isnull(FirstName,'') +  ' ' + ISnull(LastName,'')  FullName,
						AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
						BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode ,CustomerPaymentGUID,StoreName,PortalId,
						CountryName, CityName, StateName, PostalCode, CompanyName, SalesRepUserName, SalesRepFullName, AccountCode
						from ##CustomerUserAddDetail CUAD
						where exists(select * from ##UserList UL where CUAD.UserId = UL.UserId and CUAD.AddressId = UL.AddressID )
						Order by RowNumber
					end
					else
					begin
						SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
						EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,
						Isnull(FirstName,'') +  ' ' + ISnull(LastName,'')  FullName,
						AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
						BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode ,CustomerPaymentGUID,StoreName,PortalId,
						CountryName, CityName, StateName, PostalCode, CompanyName, SalesRepUserName, SalesRepFullName, AccountCode
						from ##CustomerUserAddDetail
						Order by RowNumber
					end
	
					if OBJECT_ID('tempdb..##CustomerUserAddDetail') is not null
					drop table ##CustomerUserAddDetail

					if OBJECT_ID('tempdb..##View_CustomerUserAddDetail') is not null
					drop table ##View_CustomerUserAddDetail
				
				END;
            ELSE
				BEGIN
					SELECT * FROM View_CustomerUserDetail AS VICUD WHERE 1 = 0;
					SET @RowCount = 0;
				END;
            END;			
         END TRY
         BEGIN CATCH
            DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_AdminUsersByUserId @RoleName = '+@RoleName+' ,@UserName='+@UserName+',@WhereClause='+cast(@WhereClause as varchar(max))+' ,@Rows= '+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_By='+@Order_By+',@RowCount='+CAST(@RowCount AS VARCHAR(50));
            EXEC Znode_InsertProcedureErrorLog
            @ProcedureName    = 'Znode_AdminUsersByUserId',
            @ErrorInProcedure = @ERROR_PROCEDURE,
            @ErrorMessage     = @ErrorMessage,
            @ErrorLine        = @ErrorLine,
            @ErrorCall        = @ErrorCall;
         END CATCH;


     END;

GO

IF EXISTS(SELECT * FROM SYS.sysconstraints WHERE OBJECT_NAME(CONSTID) = 'FK_ZnodePublishContentContainerVariantEntity_PortalId')
	ALTER TABLE ZnodePublishContentContainerVariantEntity DROP CONSTRAINT FK_ZnodePublishContentContainerVariantEntity_PortalId

IF EXISTS(SELECT * FROM SYS.sysconstraints WHERE OBJECT_NAME(CONSTID) = 'FK_ZnodePublishContentContainerVariantEntity_ProfileId')
	ALTER TABLE ZnodePublishContentContainerVariantEntity DROP CONSTRAINT FK_ZnodePublishContentContainerVariantEntity_ProfileId

IF EXISTS(SELECT * FROM SYS.sysconstraints WHERE OBJECT_NAME(CONSTID) = 'FK_ZnodePublishContentContainerVariantEntity_ZnodeCMSContainerProfileVariant')
	ALTER TABLE ZnodePublishContentContainerVariantEntity DROP CONSTRAINT FK_ZnodePublishContentContainerVariantEntity_ZnodeCMSContainerProfileVariant

GO


IF NOT EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_Name = 'ZnodeOmsOrderLineItems' AND COLUMN_NAME = 'ParentSku')
BEGIN
	ALTER TABLE ZnodeOmsOrderLineItems ADD ParentSku VARCHAR(600)
END
GO

IF EXISTS(SELECT * FROM SYS.procedures WHERE NAME = 'Znode_InsertUpdateOmsOrder')
	DROP PROC Znode_PromotionCouponDeduct
GO
IF EXISTS(SELECT * FROM SYS.TYPES WHERE NAME = 'PromotionCoupons')
	DROP TYPE PromotionCoupons
GO


/****** Object:  UserDefinedTableType [dbo].[PromotionCoupons]    Script Date: 12/10/2021 8:21:17 PM ******/
CREATE TYPE [dbo].[PromotionCoupons] AS TABLE(
	[Code] [varchar](50) NULL,
	[IsExistInOrder] [bit] NULL,
	[OmsOrderId] [int] NULL
)

GO
IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PromotionCouponDeduct')
	DROP PROC Znode_PromotionCouponDeduct
GO
CREATE PROCEDURE [dbo].[Znode_PromotionCouponDeduct]
(
	@PromotionCoupons DBO.PromotionCoupons READONLY
)
AS
BEGIN
SET NOCOUNT ON  
BEGIN TRY

		----Quantity decuction for promotion coupons
		UPDATE ZPC SET ZPC.AvailableQuantity = ZPC.AvailableQuantity-1 
		FROM ZnodePromotionCoupon ZPC
		WHERE EXISTS(SELECT * FROM @PromotionCoupons PC WHERE ZPC.Code = PC.Code AND ( PC.IsExistInOrder IN ('0','FALSE') OR ISNULL(PC.OmsOrderId,0) = 0 ))

		IF EXISTS(SELECT * FROM @PromotionCoupons WHERE IsExistInOrder IN ('1','TRUE') AND ISNULL(OmsOrderId,0) > 0)
		BEGIN
			--For existing order if coupon not used
			UPDATE ZPC SET ZPC.AvailableQuantity = ZPC.AvailableQuantity-1 
			FROM ZnodeOmsOrderDetails dtls 
			INNER JOIN ZnodeOmsOrderLineItems item on dtls.OmsOrderDetailsId = item.OmsOrderDetailsId 
			INNER JOIN [ZnodeOmsOrderDiscount] disc on (disc.OmsOrderLineItemId = item.OmsOrderLineItemsId or disc.OmsOrderDetailsId = dtls.OmsOrderDetailsId)
			INNER JOIN ZnodeOmsDiscountType typ on disc.OmsDiscountTypeId = typ.OmsDiscountTypeId
			INNER JOIN @PromotionCoupons PC ON BINARY_CHECKSUM(disc.discountcode) <> BINARY_CHECKSUM(PC.Code) AND ISNULL(PC.OmsOrderId,0) = dtls.OmsOrderId
			INNER JOIN ZnodePromotionCoupon ZPC ON PC.Code = ZPC.Code
			WHERE dtls.IsActive = 1 and typ.Name = 'COUPONCODE'
			AND PC.IsExistInOrder IN ('1','TRUE') 
		END

END TRY
BEGIN CATCH

	DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PromotionCouponDeduct '

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName    = 'Znode_PromotionCouponDeduct',
	@ErrorInProcedure = @ERROR_PROCEDURE,
	@ErrorMessage     = @ErrorMessage,
	@ErrorLine        = @ErrorLine,
	@ErrorCall        = @ErrorCall;
END CATCH

END
go
IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PostSubmitOrderProcess')
	DROP PROC Znode_PostSubmitOrderProcess
GO

CREATE PROCEDURE [dbo].[Znode_PostSubmitOrderProcess]
(
	@PostOrderXml XML,
	@InventoryData XML,
	@UserId INT,
	@PortalId INT = 0,
	@Status BIT OUT
)
AS
BEGIN
BEGIN TRY
--BEGIN TRAN PostOrder
	DECLARE @OmsOrderDetailsId INT
	DECLARE @OmsOrderId INT = (SELECT Tbl.Col.value( 'OrderID[1]', 'NVARCHAR(2000)' ) AS OrderId FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))
	
	DECLARE @IsGuest BIT = (SELECT Tbl.Col.value( 'IsGuest[1]', 'NVARCHAR(2000)' ) AS IsGuest FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))

	DECLARE @OmsCookieMappingId INT = (SELECT Tbl.Col.value( 'CookieMappingId[1]', 'NVARCHAR(2000)' ) AS CookieMappingId FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))
	DECLARE @BillingAddressId INT = (SELECT Tbl.Col.value( 'BillingAddressId[1]', 'NVARCHAR(2000)' ) AS BillingAddressId FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))
	
	DECLARE @IsReferralCommission BIT = (SELECT Tbl.Col.value( 'IsReferralCommission[1]', 'NVARCHAR(2000)' ) AS IsReferralCommission FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))
	DECLARE @CommissionAmount NUMERIC(26,6) = (SELECT Tbl.Col.value( 'CommissionAmount[1]', 'NVARCHAR(2000)' ) AS CommissionAmount FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))
	
	SET @OmsOrderDetailsId = (SELECT OmsOrderDetailsId from ZnodeOmsOrderDetails WHERE OmsOrderId = @OmsOrderId AND IsActive = 1)
	DECLARE @SetBillingShippingFlags BIT = (SELECT Tbl.Col.value( 'SetBillingShippingFlags[1]', 'NVARCHAR(2000)' ) AS SetBillingShippingFlags FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col)) 
	DECLARE @GetDate DATETIME = GETDATE()
	
	--Fetching required user details 
	DECLARE @ReferralCommissionTypeId INT, @ReferralCommission NUMERIC(28,6) , @FirstName VARCHAR(100)
	SELECT @FirstName = FirstName, @ReferralCommission = CASE WHEN ReferralCommission IS NULL THEN 0 ELSE ReferralCommission END, @ReferralCommissionTypeId = ReferralCommissionTypeId
	FROM ZnodeUser WITH (NOLOCK) 
	WHERE UserId = @UserId
	
	---Voucher model fetch
	CREATE TABLE #TempVoucher
	(
		VoucherBalance NUMERIC(28,6),VoucherNumber NVARCHAR(600),VoucherMessage NVARCHAR(MAX),IsVoucherValid BIT,
		IsVoucherApplied BIT,VoucherAmountUsed NUMERIC(28,6),VoucherName NVARCHAR(600),ExpirationDate DATETIME,
		CultureCode NVARCHAR(600),PortalId INT,IsExistInOrder BIT,UserId INT,IsActive BIT,OrderVoucherAmount NUMERIC(28,6)
	)

	INSERT INTO #TempVoucher
	(
		VoucherBalance ,VoucherNumber,VoucherMessage ,IsVoucherValid ,
		IsVoucherApplied ,VoucherAmountUsed ,VoucherName ,ExpirationDate ,
		CultureCode ,PortalId ,IsExistInOrder ,UserId ,IsActive ,OrderVoucherAmount 
	)
	SELECT Tbl.Col.value( 'VoucherBalance[1]', 'NVARCHAR(2000)' ) AS VoucherBalance,
		Tbl.Col.value( 'VoucherNumber[1]', 'NVARCHAR(2000)' ) AS VoucherNumber,
		Tbl.Col.value( 'VoucherMessage[1]', 'NVARCHAR(2000)' ) AS VoucherMessage,
		Tbl.Col.value( 'IsVoucherValid[1]', 'NVARCHAR(2000)' ) AS IsVoucherValid,
		Tbl.Col.value( 'IsVoucherApplied[1]', 'NVARCHAR(2000)' ) AS IsVoucherApplied,
		Tbl.Col.value( 'VoucherAmountUsed[1]', 'NVARCHAR(2000)' ) AS VoucherAmountUsed,
		Tbl.Col.value( 'VoucherName[1]', 'NVARCHAR(2000)' ) AS VoucherName,
		Tbl.Col.value( 'ExpirationDate[1]', 'NVARCHAR(2000)' ) AS ExpirationDate,
		Tbl.Col.value( 'CultureCode[1]', 'NVARCHAR(2000)' ) AS CultureCode,
		Tbl.Col.value( 'PortalId[1]', 'NVARCHAR(2000)' ) AS PortalId,
		Tbl.Col.value( 'IsExistInOrder[1]', 'NVARCHAR(2000)' ) AS IsExistInOrder,
		Tbl.Col.value( 'UserId[1]', 'NVARCHAR(2000)' ) AS UserId,	
		Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(2000)' ) AS IsActive,
		Tbl.Col.value( 'OrderVoucherAmount[1]', 'NVARCHAR(2000)' ) AS OrderVoucherAmount
	FROM @PostOrderXml.nodes('//PostOrderSubmitModel/Vouchers/VoucherModel') AS Tbl(Col)


	----Promotion coupon start
	DECLARE @TempPromotionCoupon DBO.PromotionCoupons

	INSERT INTO @TempPromotionCoupon
	SELECT Tbl.Col.value( 'Code[1]', 'NVARCHAR(2000)' ) AS Code,
		Tbl.Col.value( 'IsExistInOrder[1]', 'NVARCHAR(2000)' ) AS IsExistInOrder,@OmsOrderId AS OmsOrderId
	FROM @PostOrderXml.nodes('//PostOrderSubmitModel/Coupons/CouponModel') AS Tbl(Col)

	--Deduct promotion coupon count
	EXEC [Znode_PromotionCouponDeduct] @PromotionCoupons = @TempPromotionCoupon
	----Promotion coupon END
	
	--Deduct inventory quantity
	EXEC [Znode_UpdateInventoryPostOrder] @SkuXml = @InventoryData,@PortalId = @PortalId, @UserId= @UserId,@OmsOrderId=@OmsOrderId,@Status = 0

	----Voucher start
	IF EXISTS(SELECT * FROM #TempVoucher)
	BEGIN
		INSERT INTO ZnodeGiftCardHistory(GiftCardId,TransactionDate,TransactionAmount,OmsOrderDetailsId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Notes,RemainingAmount)
		SELECT GC.GiftCardId, @GetDate, VoucherAmountUsed,@OmsOrderDetailsId,CASE WHEN ISNULL(@IsGuest,0) IN ('TRUE','1') THEN NULL ELSE @UserId END, @GetDate, @UserId, @GetDate, 'Voucher is used to make payments for the order' as Notes, NULL AS RemainingAmount
		FROM #TempVoucher V
		INNER JOIN ZnodeGiftCard GC WITH (NOLOCK) ON V.VoucherNumber = GC.CardNumber

		IF EXISTS(SELECT * FROM #TempVoucher WHERE IsExistInOrder IN ('TRUE','1'))
		BEGIN
			UPDATE GC SET GC.RemainingAmount = V.VoucherBalance
			FROM #TempVoucher V
			INNER JOIN ZnodeGiftCard GC ON V.VoucherNumber = GC.CardNumber
			WHERE IsExistInOrder IN ('TRUE','1')
		END

		IF EXISTS(SELECT * FROM #TempVoucher WHERE IsExistInOrder IN ('FALSE','0'))
		BEGIN
			UPDATE GC SET GC.RemainingAmount = GC.RemainingAmount - V.VoucherAmountUsed
			FROM #TempVoucher V
			INNER JOIN ZnodeGiftCard GC ON V.VoucherNumber = GC.CardNumber
			WHERE IsExistInOrder IN ('FALSE','0')
		END
	END
	----Voucher end
	
	--Update user details
	IF @FirstName IS NULL
	BEGIN
		DECLARE @FirstName1 VARCHAR(300), @LastName VARCHAR(300), @PhoneNumber VARCHAR(300)
		SELECT @FirstName1=FirstName, @LastName=LastName, @PhoneNumber=PhoneNumber
		FROM ZnodeAddress WITH (NOLOCK)  WHERE AddressId = @BillingAddressId

		UPDATE ZnodeUser 
		SET FirstName = @FirstName, LastName = @LastName, PhoneNumber = @PhoneNumber
		WHERE UserId = @UserId
	END

	--Update address details
	IF @SetBillingShippingFlags IN ('TRUE','1')
	BEGIN
		UPDATE ZnodeAddress
		SET IsBilling = 1, IsShipping = 1
		WHERE AddressId = @BillingAddressId
	END

	--ReferralCommission details
	IF @IsReferralCommission IN ('TRUE','1')
	BEGIN
		INSERT INTO ZnodeOmsReferralCommission
		(
			UserId,OmsOrderDetailsId,OrderCommission,TransactionId,Description,ReferralCommission,ReferralCommissionTypeId
			,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		)
		SELECT @UserId,@OmsOrderDetailsId,CASE WHEN @ReferralCommissionTypeId =1 THEN ((@CommissionAmount * ISNULL(@ReferralCommission,0)) / 100) ELSE @ReferralCommission END AS OrderCommission,'' AS TransactionId,'' AS Description,@ReferralCommission,@ReferralCommissionTypeId
			,@UserId,@GetDate,@UserId,@GetDate
	END
	
	---OmsTaxOrderSummary details
	IF EXISTS(SELECT * FROM ZnodeOmsTaxOrderSummary WITH (NOLOCK)  WHERE OmsOrderDetailsId = @OmsOrderDetailsId)
	BEGIN
		DELETE FROM ZnodeOmsTaxOrderSummary WHERE OmsOrderDetailsId = @OmsOrderDetailsId
	END

	INSERT INTO ZnodeOmsTaxOrderSummary (OmsOrderDetailsId,Tax,Rate,TaxName,TaxTypeName)
	SELECT 	@OmsOrderDetailsId AS OmsOrderDetailsId,
		Tbl.Col.value( 'Tax[1]', 'NVARCHAR(2000)' ) AS Tax,
		Tbl.Col.value( 'Rate[1]', 'NVARCHAR(2000)' ) AS Rate,
		Tbl.Col.value( 'TaxName[1]', 'NVARCHAR(2000)' ) AS TaxName,
		Tbl.Col.value( 'TaxTypeName[1]', 'NVARCHAR(2000)' ) AS TaxTypeName
	FROM @PostOrderXml.nodes('//PostOrderSubmitModel/TaxSummaryList/TaxSummaryModel') AS Tbl(Col)
	WHERE Tbl.Col.value( 'Tax[1]', 'NVARCHAR(2000)' ) IS NOT NULL
	--------

	--Remove 
	EXEC [Znode_DeleteSavedCartItem] @OmsCookieMappingId = @OmsCookieMappingId, @UserId = @UserId,@PortalId = @PortalId,@Status = 0  

	SET @Status = 1
	--COMMIT TRAN PostOrder
END TRY
BEGIN CATCH
--ROLLBACK TRAN PostOrder
	SET @Status = 0
	
	DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PostSubmitOrderProcess @PostOrderXml ='+CAST(@PostOrderXml AS VARCHAR(MAX))+' , @InventoryData = '+CAST(@InventoryData AS VARCHAR(50))+',@UserId ='+CAST(@UserId AS VARCHAR(50))+',@PortalId ='+CAST(@PortalId AS VARCHAR(50))+',@Status ='+CAST(@Status AS VARCHAR(50));
	
	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName    = 'Znode_PostSubmitOrderProcess',
	@ErrorInProcedure = @ERROR_PROCEDURE,
	@ErrorMessage     = @ErrorMessage,
	@ErrorLine        = @ErrorLine,
	@ErrorCall        = @ErrorCall;
END CATCH

END
GO
IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_UpdateInventoryPostOrder')
	DROP PROC Znode_UpdateInventoryPostOrder
GO

CREATE PROCEDURE [dbo].[Znode_UpdateInventoryPostOrder]
(
	@SkuXml xml,
	@PortalId int, 
	@UserId int, 
	@Status bit OUT, 
	@OmsOrderId INT,
	@IsDebug bit= 0
)
AS 
	/*
	Summary: (13671)   Inventory will be updated on the basis of "InventoryTracking" (Attribute Code) value in locale table 
				    If value id "DisablePurchasing" then subtracts currently selected quantity only when it will greater than zero.
				    If "AllowBackordering" then inventory will become negative
				    If "DontTrackInventory" then don't update inventory.
				    inventory will be get deducted from associated warehouse where quantity is available as per warehouse precedence. 
				    Validate total quantity 
	Input Parameters:
	SKU(Comma separated multiple), PortalId
	Unit Testing   
		Declare @Status bit 
		Exec Znode_UpdateInventory  @SkuXml = '<ArrayOfOrderWarehouseLineItemsModel>
		<OrderWarehouseLineItemsModel>
		<OrderLineItemId>418</OrderLineItemId>
		<SKU>ap1534</SKU>
		<InventoryTracking>DisablePurchasing</InventoryTracking>
		<Quantity>1.000000</Quantity>
		</OrderWarehouseLineItemsModel>
		<OrderWarehouseLineItemsModel>
		<OrderLineItemId>419</OrderLineItemId>
		<SKU>al8907</SKU>
		<InventoryTracking>DisablePurchasing</InventoryTracking>
		<Quantity>1.000000</Quantity>
		</OrderWarehouseLineItemsModel>
		</ArrayOfOrderWarehouseLineItemsModel>',@PortalId = 1,@UserId = 2,@Status = @Status

	*/
BEGIN
	BEGIN TRAN UpdateInventory;
	BEGIN TRY
		SET NOCOUNT ON;
		DECLARE @RoundOffValue INT= dbo.Fn_GetDefaultValue('InventoryRoundOff');
		DECLARE @TBL_XmlReturnToTable TABLE
		( 
			OrderLineItemId int, SKU nvarchar(max), InventoryTracking nvarchar(1000), Quantity numeric(28, 6),
			AllowBackOrder VARCHAR(100), SequenceNo int IDENTITY, OrderLineItemRelationshipTypeId int 
		);
		DECLARE @TBL_ErrorInventoryTracking TABLE
		( 
			SKU nvarchar(max), Quantity numeric(28, 6), InventoryTracking nvarchar(2000), AllowBackOrder varchar(100)
		);
		INSERT INTO @TBL_XmlReturnToTable( OrderLineItemId, SKU, InventoryTracking, Quantity,AllowBackOrder )
			   SELECT Tbl.Col.value( 'OrderLineItemId[1]', 'INT' ) AS OrderLineItemId, Tbl.Col.value( 'SKU[1]', 'NVARCHAR(2000)' ) AS SKU, Tbl.Col.value( 'InventoryTracking[1]', 'NVARCHAR(2000)' ) AS InventoryTracking, Tbl.Col.value( 'Quantity[1]', 'Numeric(28,6)' ) AS Quantity
			   , Tbl.Col.value( 'AllowBackOrder[1]', 'VARCHAR(100)' ) AS AllowBackOrder
			   FROM @SkuXml.nodes( '//ArrayOfOrderWarehouseLineItemsModel/OrderWarehouseLineItemsModel' ) AS Tbl(Col)
			   WHERE Tbl.Col.value( 'InventoryTracking[1]', 'NVARCHAR(2000)' ) <> 'DontTrackInventory' 
			   AND Tbl.Col.value( 'Quantity[1]', 'Numeric(28,6)' ) > 0
			   ;
		DECLARE @Cur_WarehouseId int, @Cur_PortalId int, @Cur_PortalWarehouseId int, @Cur_WarehouseSequence int, @Cur_SKU varchar(200), @Cur_Quantity numeric(28, 6), @Cur_ReOrderLevel numeric(28, 6), @Cur_InventoryId int;

		DECLARE @RecurringQuantity numeric(28, 6), @BalanceQuantity numeric(28, 6)
		SET @Status = 0; 
   
		Update X SET x.OrderLineItemRelationshipTypeId = b.OrderLineItemRelationshipTypeId 
		FROM ZnodeOmsOrderLineItems a
		inner join ZnodeOmsOrderLineItems b on a.OmsOrderLineItemsId = b.ParentOmsOrderLineItemsId 
		inner join @TBL_XmlReturnToTable X on x.OrderLineItemId = a.OmsOrderLineItemsId
		where a.ParentOmsOrderLineItemsId is null
		and b.ParentOmsOrderLineItemsId is not null

		---Updating order line item
		UPDATE TBL SET OrderLineItemId = ZOOLI.OmsOrderLineItemsId
		FROM ZnodeOmsOrderLineItems ZOOLI
		INNER JOIN @TBL_XmlReturnToTable TBL ON ZOOLI.Sku = TBL.SKU
		WHERE EXISTS(SELECT * FROM ZnodeOmsOrderDetails ZOOD WHERE ZOOLI.OmsOrderDetailsId = ZOOD.OmsOrderDetailsId AND ZOOD.OmsOrderId = @OmsOrderId)
		AND ZOOLI.ParentOmsOrderLineItemsId IS NOT NULL


		DECLARE @TBL_CalculateQuntity TABLE
		( 
			WarehouseId int, SKU varchar(200), MainQuantity numeric(28, 6), InventoryId int, OrderQuantity numeric(28, 6), UpdatedQuantity numeric(28, 6), WarehouseSequenceId int, InventoryTracking nvarchar(2000)
			, AllowBackOrder varchar(100)
		);
		
		DECLARE @TBL_AllwareHouseToportal TABLE
		( 
			WarehouseId int, PortalId int, PortalWarehouseId int, WarehouseSequenceFirst int, WarehouseSequence int, SKU varchar(200), Quantity numeric(28, 6), ReOrderLevel numeric(28, 6), InventoryId int
		);
		
	
		INSERT INTO @TBL_AllwareHouseToportal( WarehouseId, PortalId, PortalWarehouseId, SKU, Quantity, ReOrderLevel, InventoryId, WarehouseSequence, WarehouseSequenceFirst )
			SELECT ZPW.WarehouseId, ZPW.PortalId, zpw.PortalWarehouseId, zi.SKU, zi.Quantity, zi.ReOrderLevel, zi.InventoryId, DENSE_RANK() OVER(ORDER BY ZPW.WarehouseId), 1
			FROM dbo.ZnodeInventory AS zi
			LEFT JOIN [ZnodePortalWarehouse] AS ZPW ON ZPW.WarehouseId = ZI.WareHouseId AND  ZPW.PortalId = @PortalId
			WHERE EXISTS ( SELECT TOP 1 1  FROM @TBL_XmlReturnToTable AS TBXRT WHERE RTRIM(LTRIM(TBXRT.SKU)) = RTRIM(LTRIM(zi.SKU))) 
			AND ZPW.WarehouseId IS NOT NULL
			ORDER BY ZPW.Precedence DESC
			
			INSERT INTO @TBL_AllwareHouseToportal( WarehouseId, PortalId, PortalWarehouseId, SKU, Quantity, ReOrderLevel, InventoryId, WarehouseSequence, WarehouseSequenceFirst )
			SELECT zpaw.WarehouseId, @PortalId, zpaw.PortalWarehouseId, zi.SKU, zi.Quantity, zi.ReOrderLevel, zi.InventoryId, DENSE_RANK() OVER (ORDER BY zpaw.WarehouseId),
			CASE WHEN EXISTS ( SELECT TOP 1 1 FROM @TBL_AllwareHouseToportal WE WHERE WE.SKU = ZI.SKU  ) THEN 2 ELSE 1 END
			FROM dbo.ZnodeInventory AS zi 
			INNER JOIN [dbo].[ZnodePortalAlternateWarehouse] AS zpaw ON zpaw.WarehouseId = ZI.WareHouseId
			WHERE EXISTS ( SELECT TOP 1 1 FROM [ZnodePortalWarehouse] AS a WHERE zpaw.PortalWarehouseId = a.PortalWarehouseId AND  a.PortalId = @PortalId) AND 
			EXISTS ( SELECT TOP 1 1 FROM @TBL_XmlReturnToTable AS TBXRT WHERE RTRIM(LTRIM(TBXRT.SKU)) = RTRIM(LTRIM(zi.SKU))) ORDER BY ZPAW.Precedence DESC;

		--Total Avaialble qunatity in all warehouse 
		IF EXISTS ( SELECT TOP 1 1 FROM @TBL_XmlReturnToTable WHERE InventoryTracking = 'DisablePurchasing')
		BEGIN
			INSERT INTO @TBL_ErrorInventoryTracking 
			SELECT TBAHL.SKU, SUM(TBAHL.Quantity), InventoryTracking,TBXML.AllowBackOrder 
			FROM @TBL_XmlReturnToTable AS TBXML
			LEFT JOIN @TBL_AllwareHouseToportal AS TBAHL ON(TBAHL.SKU = TBXML.SKU) 
			INNER JOIN ZnodeOmsOrderLineItems b on (TBXML.orderlineitemid = b.OmsOrderLineItemsId)
			WHERE InventoryTracking = 'DisablePurchasing'
			AND b.OrderLineItemRelationshipTypeId IS NOT NULL
			GROUP BY TBXML.AllowBackOrder ,TBAHL.SKU, InventoryTracking HAVING SUM(TBAHL.Quantity) < 1 ORDER BY TBAHL.SKU;
			IF EXISTS ( SELECT TOP 1 1 FROM @TBL_ErrorInventoryTracking )
			BEGIN
				SET @Status = 0;
				RAISERROR(15600, -1, -1, 'DisablePurchasing');
			END;
		END;

		---Getting data for simple , configurable and group
		INSERT INTO @TBL_CalculateQuntity
		SELECT WarehouseId, TBXML.SKU, TBAHL.Quantity, TBAHL.InventoryId, TBXML.Quantity, NULL AS UpdatedQuantity, DENSE_RANK() 
		OVER(ORDER BY WarehouseSequenceFirst,WarehouseSequence), InventoryTracking, TBXML.AllowBackOrder
		FROM @TBL_XmlReturnToTable AS TBXML	
		INNER  JOIN @TBL_AllwareHouseToportal AS TBAHL ON(TBAHL.SKU = TBXML.SKU)
		where exists(select * from ZnodeOmsOrderLineItems ZOOLI where TBXML.OrderLineItemId = ZOOLI.OmsOrderLineItemsId
			and ZOOLI.ParentOmsOrderLineItemsId is not null) 
		AND isnull(TBXML.OrderLineItemRelationshipTypeId,0) <> (Select top 1 OrderLineItemRelationshipTypeId From ZnodeOmsOrderLineItemRelationshipType Where Name IN ('Bundles','Configurable','Group'))
		ORDER BY  WarehouseSequenceFirst,WarehouseSequence;

		---Getting data for bundle products
		INSERT INTO @TBL_CalculateQuntity
		SELECT WarehouseId, TBXML.SKU, TBAHL.Quantity, TBAHL.InventoryId, TBXML.Quantity, NULL AS UpdatedQuantity, DENSE_RANK() 
		OVER(ORDER BY WarehouseSequenceFirst,WarehouseSequence), InventoryTracking, TBXML.AllowBackOrder
		FROM @TBL_XmlReturnToTable AS TBXML	
		INNER  JOIN @TBL_AllwareHouseToportal AS TBAHL ON(TBAHL.SKU = TBXML.SKU)
		where exists(select * from ZnodeOmsOrderLineItems ZOOLI where TBXML.OrderLineItemId = ZOOLI.OmsOrderLineItemsId and ZOOLI.ParentOmsOrderLineItemsId is null)
		AND TBXML.OrderLineItemRelationshipTypeId = (Select top 1 OrderLineItemRelationshipTypeId From ZnodeOmsOrderLineItemRelationshipType Where Name IN ('Bundles','Configurable','Group'))
		ORDER BY  WarehouseSequenceFirst,WarehouseSequence;

		;with cte as
		(
			select WarehouseId,	a.SKU,	MainQuantity,	InventoryId,	WarehouseSequenceId,	a.InventoryTracking,	AllowBackOrder,sum(OrderQuantity) as OrderQuantity
			from @TBL_CalculateQuntity A
			group by WarehouseId,	a.SKU,	MainQuantity,	InventoryId,	WarehouseSequenceId,	InventoryTracking,	AllowBackOrder
		)
		update b set  b.OrderQuantity = a.OrderQuantity
		from cte a
		inner join @TBL_CalculateQuntity b on a.SKU = b.SKU and a.InventoryId = b.InventoryId and a.WarehouseId = b.WarehouseId

		
		UPDATE @TBL_CalculateQuntity 
		SET UpdatedQuantity = MainQuantity - OrderQuantity  
		WHERE WarehouseSequenceId = 1;
		 		
		DECLARE @CountToRepeate int= ( SELECT count( distinct WarehouseId) FROM @TBL_CalculateQuntity),@Initializationofloop int= 2;
       
		WHILE @Initializationofloop <= @CountToRepeate 
				AND EXISTS (SELECT TOP 1 1 FROM @TBL_CalculateQuntity AS a 
					WHERE UpdatedQuantity < 0  )
		BEGIN
		 
			UPDATE a  
			SET a.UpdatedQuantity = a.MainQuantity + b.UpdatedQuantity 
			FROM @TBL_CalculateQuntity a 
			INNER JOIN @TBL_CalculateQuntity b ON (a.Sku = b.Sku AND b.WarehouseSequenceId = (@Initializationofloop - 1)) 
			WHERE a.WarehouseSequenceId = @Initializationofloop 
			AND b.UpdatedQuantity < 0
			AND b.UpdatedQuantity IS NOT NULL 
			--AND a.WarehouseSequenceId = @Initializationofloop - 1

			UPDATE @TBL_CalculateQuntity 
			SET UpdatedQuantity  = 0 
			WHERE WarehouseSequenceId = @Initializationofloop -1 
			--AND  InventoryTracking <> 'AllowBackordering'
			AND UpdatedQuantity < 0
			AND UpdatedQuantity IS NOT NULL 
			--AND WarehouseSequenceId = @Initializationofloop - 1


			SET @Initializationofloop = @Initializationofloop + 1;
		END; 
		
		
		   IF EXISTS (SELECT TOP 1 1 FROM @TBL_CalculateQuntity WHERE ISNULL(UpdatedQuantity,0) < 0 AND @CountToRepeate >1)
		   BEGIN 
		    UPDATE a  
			SET a.UpdatedQuantity = b.UpdatedQuantity 
			FROM @TBL_CalculateQuntity a 
			INNER JOIN @TBL_CalculateQuntity b ON (a.Sku = b.Sku AND b.WarehouseSequenceId = @Initializationofloop -1 ) 
			WHERE a.WarehouseSequenceId = 1 
			AND ISNULL(b.UpdatedQuantity,0) < 0

			UPDATE @TBL_CalculateQuntity 
			SET UpdatedQuantity  = 0 
			WHERE WarehouseSequenceId = @Initializationofloop -1 
			--AND  InventoryTracking <> 'AllowBackordering'
		    AND ISNULL(UpdatedQuantity,0) < 0
		   END 
			
			
		--If "AllowBackordering" then inventory will go to be negative conside only single warehouse
		IF EXISTS(SELECT TOP 1 1 FROM @TBL_XmlReturnToTable WHERE InventoryTracking = 'AllowBackordering')
		BEGIN
			UPDATE ZI SET Quantity = Isnull(TBCQ.UpdatedQuantity,0) 
			FROM dbo.ZnodeInventory ZI 
			INNER JOIN @TBL_CalculateQuntity TBCQ ON(Zi.InventoryId = TBCQ.InventoryId)
			WHERE InventoryTracking = 'AllowBackordering' AND  UpdatedQuantity IS NOT NULL  ;
			SET @Status = 1;
		END;
		
		-- If @InventoryTracking is "DisablePurchasing" then subtracts currently selected quantity only when it will greater than zero.
		IF EXISTS ( SELECT TOP 1 1 FROM @TBL_XmlReturnToTable WHERE InventoryTracking = 'DisablePurchasing')
		BEGIN
			SET @BalanceQuantity = 1;
			UPDATE ZI 
			SET Quantity = CASE WHEN TBCQ.UpdatedQuantity < 0 THEN 0 ELSE TBCQ.UpdatedQuantity END 
			FROM dbo.ZnodeInventory ZI 
			INNER JOIN  @TBL_CalculateQuntity TBCQ ON(Zi.InventoryId = TBCQ.InventoryId) WHERE InventoryTracking = 'DisablePurchasing'
			AND TBCQ.UpdatedQuantity IS NOT NULL 
			;
		END;
		
		INSERT INTO ZnodeOmsOrderWarehouse( OmsOrderLineItemsId, WarehouseId,Quantity, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate )
		SELECT OrderLineItemId, WarehouseId,CASE WHEN UpdatedQuantity = 0 THEN MainQuantity ELSE MainQuantity - UpdatedQuantity END , @UserId, dbo.Fn_GetDate(), @UserId, dbo.Fn_GetDate() 
		FROM @TBL_CalculateQuntity AS TBCQ 
		INNER JOIN @TBL_XmlReturnToTable AS TBXR
			   ON(TBXR.SKU = TBCQ.SKU) WHERE UpdatedQuantity IS NOT NULL;
  
		SELECT DISTINCT SKU,
		 [dbo].[Fn_GetDefaultPriceRoundOffReturnNumeric](UpdatedQuantity) AS Quantity,
		  InventoryTracking,CAST(AllowBackOrder AS BIT) AllowBackOrder
		FROM @TBL_CalculateQuntity
		WHERE UpdatedQuantity IS NOT NULL;

		SET @Status = 1;
		COMMIT TRAN UpdateInventory;
	END TRY
	BEGIN CATCH
	
		SET @Status = 0;
		SELECT SKU, Quantity, InventoryTracking,AllowBackOrder
		FROM @TBL_ErrorInventoryTracking;
		
		ROLLBACK TRAN UpdateInventory;
	END CATCH;
END;
GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateOmsOrder')
	DROP PROC Znode_InsertUpdateOmsOrder
GO


CREATE PROCEDURE [dbo].[Znode_InsertUpdateOmsOrder]
(
	@OrderXML XML,
	@UserId INT
)
AS
BEGIN
SET NOCOUNT ON;
BEGIN TRY
BEGIN TRAN OrderInsert
	DECLARE @GetDate DATETIME = GETDATE()
	DECLARE @OMSOrder TABLE(OmsOrderId INT,OrderNumber VARCHAR(200))
	DECLARE @OMSOrderDetail TABLE(OmsOrderId INT,OmsOrderDetailsId INT)
	DECLARE @OmsOrderLineItems TABLE(RowId INT IDENTITY(1,1),OmsOrderDetailsId INT,OmsOrderLineItemsId INT, Sku VARCHAR(600), ParentOmsOrderLineItemsId INT, GroupId NVARCHAR(MAX),OrderLineItemRelationshipTypeId INT,ParentSku varchar(600))
	DECLARE @OmsParentOrderLineItems TABLE(RowId INT IDENTITY(1,1),OmsOrderDetailsId INT,OmsOrderLineItemsId INT, Sku VARCHAR(600), ParentOmsOrderLineItemsId INT, GroupId NVARCHAR(MAX), OrderLineItemRelationshipTypeId INT)

	DECLARE @OrderLineItemRelationshipTypeIdAddon int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'AddOns'
	);

	DECLARE @OrderLineItemRelationshipTypeIdSimple int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Simple'
	);

	DECLARE @OrderLineItemRelationshipTypeIdBundles int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Bundles'
	);

	DECLARE @OrderLineItemRelationshipTypeIdGroup int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Group'
	);


	CREATE TABLE #TempOrderData
	(
		RowId INT IDENTITY(1,1),OrderNumber VARCHAR(200), PublishStateId INT,OmsOrderId INT,OmsOrderStateId INT,
		DiscountAmount NUMERIC(28,6),SalesTax NUMERIC(28,6),TaxRate NUMERIC(28,6),IsOldOrder BIT,VAT NUMERIC(28,6),GST NUMERIC(28,6),
		PST NUMERIC(28,6),HST NUMERIC(28,6),Total NUMERIC(28,6),BillingAddressId INT,ShippingAddressId INT,ShippingId INT,
		PortalId INT,ShippingNumber nvarchar(max),TrackingNumber nvarchar(1000),CouponCode nvarchar(1000),
		PromoDescription nvarchar(max),ReferralUserId int,PurchaseOrderNumber nvarchar(1000),OmsPaymentStateId int,
		WebServiceDownloadDate datetime,PaymentSettingId int,PaymentTransactionToken nvarchar(600),ShipDate datetime,ReturnDate datetime,
		AddressId int,PoDocument nvarchar(600),IsActive bit,ExternalId nvarchar(1000),PaymentTypeId INT,CreatedBy INT,CreatedDate datetime,ModifiedBy INT,
		ModifiedDate datetime,CreditCardNumber varchar(4),IsShippingCostEdited bit,IsTaxCostEdited bit,ShippingDifference NUMERIC(28,6),
		EstimateShippingCost NUMERIC(28,6),TransactionId nvarchar(800),Custom1 nvarchar(MAX),Custom2 nvarchar(MAX),Custom3 nvarchar(MAX),
		Custom4 nvarchar(MAX),Custom5 nvarchar(MAX),FirstName nvarchar(200),LastName nvarchar(200),CardType varchar(50),CreditCardExpMonth INT,
		CreditCardExpYear INT,TotalAdditionalCost numeric(28,6),PaymentDisplayName nvarchar(2000),PaymentExternalId nvarchar(2000),
		CultureCode varchar(200),DisplayName nvarchar(2000),InHandDate datetime,IpAddress varchar(100),JobName nvarchar(200),
		ShippingConstraintCode nvarchar(100),ShippingDiscount numeric(28,6),ShippingHandlingCharges numeric(28,6),ReturnCharges numeric(28,6),
		IsCalculateTaxAfterDiscount bit,Email varchar(50),PhoneNumber varchar(50),OrderTotalWithoutVoucher numeric(28,6),ImportDuty numeric(28,6),
		TaxCost NUMERIC(28,6),ShippingCost numeric(28,6), SubTotal numeric(28,6),CurrencyCode varchar(100),OverDueAmount numeric(28,6), ShippingTypeId INT,
		AccountNumber NVARCHAR(4000),ShippingMethod NVARCHAR(4000),PaymentCode NVARCHAR(400) ,PaymentStatusId Int
	)

	CREATE TABLE #TempParentLineItemDetails
	(
		RowId INT IDENTITY(1,1),OrderLineItemRelationshipTypeId INT,OmsOrderDetailsId INT,OmsOrderShipmentId INT,RmaReasonForReturnId INT,Sku nvarchar(600),ProductName nvarchar(1000),
		Description nvarchar(max),Quantity numeric(28,6),Price numeric(28,6),Weight numeric(28,6),DownloadLink nvarchar(max),DiscountAmount numeric(28,6),
		ShipSeparately bit,ShipDate datetime,ReturnDate datetime,ShippingCost numeric(28,6),PromoDescription nvarchar(max),TransactionNumber nvarchar(max),
		PaymentStatusId int,TrackingNumber nvarchar(max),IsAutoGeneratedTracking bit,OrderLineItemStateId int,IsRecurringBilling bit,RecurringBillingPeriod nvarchar(100),
		RecurringBillingCycles int,RecurringBillingFrequency nvarchar(100),RecurringBillingAmount numeric(28,6),AppliedPromo nvarchar(max),CouponsApplied nvarchar(100),
		ExternalId nvarchar(1000),IsActive bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,AutoAddonSku nvarchar(max),IsShippingReturn bit,
		PartialRefundAmount numeric(28,6),Custom1 nvarchar(max),Custom2 nvarchar(max),Custom3 nvarchar(max),Custom4 nvarchar(max),Custom5 nvarchar(max),
		GroupId nvarchar(max),BundleQuantity int, TaxRuleId INT,TaxTransactionNumber NVARCHAR(1200),Comments NVARCHAR(MAX),SalesTax NUMERIC(28,6),VAT NUMERIC(28,6),
		GST NUMERIC(28,6),PST NUMERIC(28,6),HST NUMERIC(28,6),ImportDuty NUMERIC(28,6)
	)

	CREATE TABLE #TempChildLineItemDetails
	(
		RowId INT IDENTITY(1,1),OrderLineItemRelationshipTypeId INT,OmsOrderDetailsId INT,OmsOrderShipmentId INT,RmaReasonForReturnId INT,Sku nvarchar(600),ProductName nvarchar(1000),
		Description nvarchar(max),Quantity numeric(28,6),Price numeric(28,6),Weight numeric(28,6),DownloadLink nvarchar(max),DiscountAmount numeric(28,6),
		ShipSeparately bit,ShipDate datetime,ReturnDate datetime,ShippingCost numeric(28,6),PromoDescription nvarchar(max),TransactionNumber nvarchar(max),
		PaymentStatusId int,TrackingNumber nvarchar(max),IsAutoGeneratedTracking bit,OrderLineItemStateId int,IsRecurringBilling bit,RecurringBillingPeriod nvarchar(100),
		RecurringBillingCycles int,RecurringBillingFrequency nvarchar(100),RecurringBillingAmount numeric(28,6),AppliedPromo nvarchar(max),CouponsApplied nvarchar(100),
		ExternalId nvarchar(1000),IsActive bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,AutoAddonSku nvarchar(max),IsShippingReturn bit,
		PartialRefundAmount numeric(28,6),Custom1 nvarchar(max),Custom2 nvarchar(max),Custom3 nvarchar(max),Custom4 nvarchar(max),Custom5 nvarchar(max),
		GroupId nvarchar(max),BundleQuantity int, TaxRuleId INT,TaxTransactionNumber NVARCHAR(1200),Comments NVARCHAR(MAX),SalesTax NUMERIC(28,6),VAT NUMERIC(28,6),
		GST NUMERIC(28,6),PST NUMERIC(28,6),HST NUMERIC(28,6),ImportDuty NUMERIC(28,6), ParentSku nvarchar(600)
	)

	CREATE TABLE #TempOrderAttribute
	(
		AttributeCode NVARCHAR(1000),AttributeValue NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,
		ModifiedBy INT,ModifiedDate DATETIME,AttributeValueCode NVARCHAR(1000), Sku VARCHAR(600), GroupId nvarchar(max)
	)

	CREATE TABLE #OmsPersonalizeItem
	(
		PersonalizeCode NVARCHAR(400),PersonalizeValue NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,
		ModifiedDate DATETIME,DesignId NVARCHAR(4000),ThumbnailURL NVARCHAR(MAX), Sku VARCHAR(600), GroupId nvarchar(max)
	)

	CREATE TABLE #OmsOrderDiscount
	(
		OmsDiscountTypeId INT,DiscountCode VARCHAR(300),DiscountAmount NUMERIC(28,6),Description NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,
		ModifiedBy INT,ModifiedDate DATETIME,PerQuantityDiscount NUMERIC(28,6),DiscountMultiplier NUMERIC(28,6),ParentOmsOrderLineItemsId INT,
		DiscountLevelTypeId INT,PromotionName NVARCHAR(1200),PromotionTypeId INT,DiscountAppliedSequence INT,PromotionMessage NVARCHAR(MAX),Sku VARCHAR(600),
		GroupId nvarchar(max)
	)

	--------Order details insert
	INSERT INTO #TempOrderData
	(
		OrderNumber, PublishStateId ,OmsOrderId ,OmsOrderStateId ,DiscountAmount ,SalesTax ,TaxRate ,IsOldOrder ,
		VAT ,GST ,PST ,HST ,Total ,BillingAddressId ,ShippingAddressId ,ShippingId ,PortalId,
		ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
		,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive
		,ExternalId,PaymentTypeId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
		,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName
		,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
		,DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
		,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty,TaxCost,ShippingCost, SubTotal,
		CurrencyCode,OverDueAmount, ShippingTypeId, AccountNumber, ShippingMethod, PaymentCode, PaymentStatusId
	)
	SELECT
	CASE WHEN Tbl.Col.value( 'OrderNumber[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderNumber[1]', 'NVARCHAR(Max)' ) END  AS OrderNumber,
	CASE WHEN Tbl.Col.value( 'PublishStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PublishStateId[1]', 'NVARCHAR(Max)' ) END AS PublishStateId,
	CASE WHEN Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderId,
	CASE WHEN Tbl.Col.value( 'OmsOrderStateId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderStateId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderStateId,
	CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
	CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE  Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
	CASE WHEN Tbl.Col.value( 'TaxRate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TaxRate[1]', 'NVARCHAR(Max)' ) END AS TaxRate,
	CASE WHEN Tbl.Col.value('IsOldOrder[1]', 'NVARCHAR(2000)') = '' THEN NULL ELSE Tbl.Col.value('IsOldOrder[1]', 'NVARCHAR(2000)') END AS IsOldOrder,
	CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE  Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
	CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
	CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END  AS PST,
	CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END AS HST,
	CASE WHEN Tbl.Col.value( 'Total[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Total[1]', 'NVARCHAR(Max)' ) END AS Total,
	CASE WHEN Tbl.Col.value( 'BillingAddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'BillingAddressId[1]', 'NVARCHAR(Max)' ) END AS BillingAddressId,
	CASE WHEN Tbl.Col.value( 'ShippingAddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingAddressId[1]', 'NVARCHAR(Max)' ) END AS ShippingAddressId,
	CASE WHEN (Tbl.Col.value( 'ShippingId[1]', 'NVARCHAR(Max)' )) = '' THEN NULL ELSE (Tbl.Col.value( 'ShippingId[1]', 'NVARCHAR(Max)' )) END  AS ShippingId,
	CASE WHEN Tbl.Col.value( 'PortalId[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'PortalId[1]', 'NVARCHAR(Max)' ) END AS PortalId,
	Tbl.Col.value( 'ShippingNumber[1]', 'NVARCHAR(Max)' ) AS ShippingNumber,
	Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
	Tbl.Col.value( 'CouponCode[1]', 'NVARCHAR(Max)' ) AS CouponCode,
	Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
	CASE WHEN Tbl.Col.value( 'ReferralUserId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReferralUserId[1]', 'NVARCHAR(Max)' ) END  AS ReferralUserId,
	Tbl.Col.value( 'PurchaseOrderNumber[1]', 'NVARCHAR(Max)' ) AS PurchaseOrderNumber,
	CASE WHEN Tbl.Col.value( 'OmsPaymentStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsPaymentStateId[1]', 'NVARCHAR(Max)' ) END AS OmsPaymentStateId,
	Tbl.Col.value( 'WebServiceDownloadDate[1]', 'NVARCHAR(Max)' ) AS WebServiceDownloadDate,
	CASE WHEN Tbl.Col.value( 'PaymentSettingId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentSettingId[1]', 'NVARCHAR(Max)' ) END AS PaymentSettingId,
	Tbl.Col.value( 'PaymentTransactionToken[1]', 'NVARCHAR(Max)' ) AS PaymentTransactionToken,
	CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE @GetDate END AS ShipDate,
	CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
	CASE WHEN Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) END AS AddressId,
	Tbl.Col.value( 'PoDocument[1]', 'NVARCHAR(Max)' ) AS PoDocument,
	CASE WHEN Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) END  AS IsActive,
	Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
	CASE WHEN Tbl.Col.value( 'PaymentTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentTypeId[1]', 'NVARCHAR(Max)' ) END  AS PaymentTypeId,
	@UserId AS CreatedBy,
	@GetDate AS CreatedDate,
	@UserId AS ModifiedBy,
	@GetDate AS ModifiedDate,
	Tbl.Col.value( 'CreditCardNumber[1]', 'NVARCHAR(Max)' ) AS CreditCardNumber,
	CASE WHEN Tbl.Col.value( 'IsShippingCostEdited[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsShippingCostEdited[1]', 'NVARCHAR(Max)' ) END AS IsShippingCostEdited,
	CASE WHEN Tbl.Col.value( 'IsTaxCostEdited[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsTaxCostEdited[1]', 'NVARCHAR(Max)' ) END AS IsTaxCostEdited,
	Tbl.Col.value( 'ShippingDifference[1]', 'NVARCHAR(Max)' ) AS ShippingDifference,
	CASE WHEN Tbl.Col.value( 'EstimateShippingCost[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'EstimateShippingCost[1]', 'NVARCHAR(Max)' ) END AS EstimateShippingCost,
	Tbl.Col.value( 'TransactionId[1]', 'NVARCHAR(Max)' ) AS TransactionId,
	Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
	Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
	Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
	Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
	Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
	Tbl.Col.value( 'FirstName[1]', 'NVARCHAR(Max)' ) AS FirstName,
	Tbl.Col.value( 'LastName[1]', 'NVARCHAR(Max)' ) AS LastName,
	Tbl.Col.value( 'CardType[1]', 'NVARCHAR(Max)' ) AS CardType,
	Tbl.Col.value( 'CreditCardExpMonth[1]', 'NVARCHAR(Max)' ) AS CreditCardExpMonth,
	Tbl.Col.value( 'CreditCardExpYear[1]', 'NVARCHAR(Max)' ) AS CreditCardExpYear,
	CASE WHEN Tbl.Col.value( 'TotalAdditionalCost[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TotalAdditionalCost[1]', 'NVARCHAR(Max)' ) END AS TotalAdditionalCost,
	Tbl.Col.value( 'PaymentDisplayName[1]', 'NVARCHAR(Max)' ) AS PaymentDisplayName,
	Tbl.Col.value( 'PaymentExternalId[1]', 'NVARCHAR(Max)' ) AS PaymentExternalId,
	Tbl.Col.value( 'CultureCode[1]', 'NVARCHAR(Max)' ) AS CultureCode,
	Tbl.Col.value( 'DisplayName[1]', 'NVARCHAR(Max)' ) AS DisplayName,
	Tbl.Col.value( 'InHandDate[1]', 'NVARCHAR(Max)' ) AS InHandDate,
	Tbl.Col.value( 'IpAddress[1]', 'NVARCHAR(Max)' ) AS IpAddress,
	Tbl.Col.value( 'JobName[1]', 'NVARCHAR(Max)' ) AS JobName,
	Tbl.Col.value( 'ShippingConstraintCode[1]', 'NVARCHAR(Max)' ) AS ShippingConstraintCode,
	Tbl.Col.value( 'ShippingDiscount[1]', 'NVARCHAR(Max)' ) AS ShippingDiscount,
	Tbl.Col.value( 'ShippingHandlingCharges[1]', 'NVARCHAR(Max)' ) AS ShippingHandlingCharges,
	CASE WHEN Tbl.Col.value( 'ReturnCharges[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'ReturnCharges[1]', 'NVARCHAR(Max)' ) END AS ReturnCharges,
	CASE WHEN Tbl.Col.value( 'IsCalculateTaxAfterDiscount[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsCalculateTaxAfterDiscount[1]', 'NVARCHAR(Max)' ) END AS IsCalculateTaxAfterDiscount,
	Tbl.Col.value( 'Email[1]', 'NVARCHAR(Max)' ) AS Email,
	Tbl.Col.value( 'PhoneNumber[1]', 'NVARCHAR(Max)' ) AS PhoneNumber,
	CASE WHEN Tbl.Col.value( 'OrderTotalWithoutVoucher[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OrderTotalWithoutVoucher[1]', 'NVARCHAR(Max)' )  END AS OrderTotalWithoutVoucher,
	CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )='' THEN '' ELSE Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
	CASE WHEN Tbl.Col.value( 'TaxCost[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'TaxCost[1]', 'NVARCHAR(Max)' ) END  AS TaxCost,
	CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
	CASE WHEN Tbl.Col.value( 'SubTotal[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'SubTotal[1]', 'NVARCHAR(Max)' ) END AS SubTotal,
	Tbl.Col.value( 'CurrencyCode[1]', 'NVARCHAR(Max)' ) AS CurrencyCode,
	CASE WHEN Tbl.Col.value( 'OverDueAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OverDueAmount[1]', 'NVARCHAR(Max)' ) END AS OverDueAmount,
	CASE WHEN Tbl.Col.value( 'ShippingTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingTypeId[1]', 'NVARCHAR(Max)' ) END AS ShippingTypeId,
	Tbl.Col.value( 'AccountNumber[1]', 'NVARCHAR(Max)' ) AS AccountNumber,
	Tbl.Col.value( 'ShippingMethod[1]', 'NVARCHAR(Max)' ) AS ShippingMethod,
	Tbl.Col.value( 'PaymentCode[1]', 'NVARCHAR(Max)' ) AS PaymentCode,
	CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId
	FROM @OrderXML.nodes( '//PlaceOrderModel' ) AS Tbl(Col);

	----Parent line item details insert
	INSERT INTO #TempParentLineItemDetails
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description,Quantity,
		Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber,
		PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles,
		RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy,
		ModifiedDate,AutoAddonSku,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity,
		TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty
	)
	SELECT
	CASE WHEN Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemRelationshipTypeId,
	CASE WHEN Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) END  AS OmsOrderDetailsId,
	CASE WHEN Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderShipmentId,
	CASE WHEN Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) END AS RmaReasonForReturnId,
	Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
	Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(2000)' ) AS ProductName,
	Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
	Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(Max)' ) AS Quantity,
	CASE WHEN Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) END AS Price,
	Tbl.Col.value( 'Weight[1]', 'NVARCHAR(Max)' ) AS Weight,
	Tbl.Col.value( 'DownloadLink[1]', 'NVARCHAR(Max)' ) AS DownloadLink,
	CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
	Tbl.Col.value( 'ShipSeparately[1]', 'NVARCHAR(Max)' ) AS ShipSeparately,
	CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE @GetDate END AS ShipDate,
	CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
	CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
	Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
	Tbl.Col.value( 'TransactionNumber[1]', 'NVARCHAR(Max)' ) AS TransactionNumber,
	CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId,
	Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
	CASE WHEN Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) END AS IsAutoGeneratedTracking,
	CASE WHEN Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemStateId,
	CASE WHEN Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) END AS IsRecurringBilling,
	Tbl.Col.value( 'RecurringBillingPeriod[1]', 'NVARCHAR(Max)' ) AS RecurringBillingPeriod,
	Tbl.Col.value( 'RecurringBillingCycles[1]', 'NVARCHAR(Max)' ) AS RecurringBillingCycles,
	Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingFrequency,
	Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingAmount,
	Tbl.Col.value( 'AppliedPromo[1]', 'NVARCHAR(Max)' ) AS AppliedPromo,
	Tbl.Col.value( 'CouponsApplied[1]', 'NVARCHAR(Max)' ) AS CouponsApplied,
	Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
	CASE WHEN Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) END AS IsActive,
	@UserId AS CreatedBy,
	@GetDate AS CreatedDate,
	@UserId AS ModifiedBy,
	@GetDate AS ModifiedDate,
	Tbl.Col.value( 'AutoAddonSKU[1]', 'NVARCHAR(Max)' ) AutoAddonSku,
	CASE WHEN Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) END IsShippingReturn,
	CASE WHEN Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) END PartialRefundAmount,
	Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
	Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
	Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
	Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
	Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
	Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
	CASE WHEN Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) = ''  THEN NULL ELSE Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) END AS BundleQuantity,
	CASE WHEN Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) END AS TaxRuleId,
	Tbl.Col.value( 'TaxTransactionNumber[1]', 'NVARCHAR(Max)' ) AS TaxTransactionNumber,
	Tbl.Col.value( 'Comments[1]', 'NVARCHAR(Max)' ) AS Comments,
	CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
	CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
	CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
	CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END AS PST,
	CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END  AS HST,
	CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel' ) AS Tbl(Col);

	----Child line item details insert
	INSERT INTO #TempChildLineItemDetails
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description,Quantity,
		Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber,
		PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles,
		RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy,
		ModifiedDate,AutoAddonSku,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity,
		TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty, ParentSku
	)
	SELECT
	CASE WHEN Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemRelationshipTypeId,
	CASE WHEN Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderDetailsId,
	CASE WHEN Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderShipmentId,
	CASE WHEN Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) END AS RmaReasonForReturnId,
	Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
	Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(2000)' ) AS ProductName,
	Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
	Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(Max)' ) AS Quantity,
	CASE WHEN Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) END AS Price,
	Tbl.Col.value( 'Weight[1]', 'NVARCHAR(Max)' ) AS Weight,
	Tbl.Col.value( 'DownloadLink[1]', 'NVARCHAR(Max)' ) AS DownloadLink,
	CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
	Tbl.Col.value( 'ShipSeparately[1]', 'NVARCHAR(Max)' ) AS ShipSeparately,
	CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE @GetDate END AS ShipDate,
	CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
	CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
	Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
	Tbl.Col.value( 'TransactionNumber[1]', 'NVARCHAR(Max)' ) AS TransactionNumber,
	CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId,
	Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
	CASE WHEN Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) END AS IsAutoGeneratedTracking,
	CASE WHEN Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemStateId,
	CASE WHEN Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) END AS IsRecurringBilling,
	Tbl.Col.value( 'RecurringBillingPeriod[1]', 'NVARCHAR(Max)' ) AS RecurringBillingPeriod,
	Tbl.Col.value( 'RecurringBillingCycles[1]', 'NVARCHAR(Max)' ) AS RecurringBillingCycles,
	Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingFrequency,
	Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingAmount,
	Tbl.Col.value( 'AppliedPromo[1]', 'NVARCHAR(Max)' ) AS AppliedPromo,
	Tbl.Col.value( 'CouponsApplied[1]', 'NVARCHAR(Max)' ) AS CouponsApplied,
	Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
	Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) AS IsActive,
	@UserId AS CreatedBy,
	@GetDate AS CreatedDate,
	@UserId AS ModifiedBy,
	@GetDate AS ModifiedDate,
	Tbl.Col.value( 'AutoAddonSKU[1]', 'NVARCHAR(Max)' ) AutoAddonSku,
	CASE WHEN Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) END AS IsShippingReturn,
	CASE WHEN Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) END AS  PartialRefundAmount,
	Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
	Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
	Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
	Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
	Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
	Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
	CASE WHEN Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) END AS BundleQuantity,
	CASE WHEN Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) END AS TaxRuleId,
	Tbl.Col.value( 'TaxTransactionNumber[1]', 'NVARCHAR(Max)' ) AS TaxTransactionNumber,
	Tbl.Col.value( 'Comments[1]', 'NVARCHAR(Max)' ) AS Comments,
	CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
	CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
	CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
	CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END AS PST,
	CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END AS HST,
	CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE  Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
	Tbl.Col.value( 'ParentProductSKU[1]', 'NVARCHAR(Max)' ) AS ParentSku
	FROM @OrderXML.nodes('//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/OrderLineItem/PlaceOrderlineItemCollection') AS Tbl(Col);

	UPDATE #TempChildLineItemDetails SET ParentSku = Sku where OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdSimple
	AND OrderLineItemRelationshipTypeId IS NOT NULL

	SELECT ZA.AddressId,ZA.FirstName,ZA.LastName,ZA.CompanyName,
	ZA.Address1,ZA.Address2,ZA.CityName,ZA.StateName,ZA.PostalCode,ZA.CountryName,ZA.PhoneNumber,ZA.EmailAddress
	INTO #BillingAddress
	FROM ZnodeAddress ZA WITH (NOLOCK)
	WHERE EXISTS(SELECT * FROM #TempOrderData OD WHERE ZA.AddressId = OD.BillingAddressId)

	INSERT INTO ZnodeOmsOrder(IsQuoteOrder,OrderNumber,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PublishStateId,IsOldOrder)
	OUTPUT INSERTED.OmsOrderId, INSERTED.OrderNumber INTO @OMSOrder
	SELECT 0 AS IsQuoteOrder, OrderNumber,OrderNumber AS ExternalId,@UserId,@GetDate,@UserId,@GetDate,PublishStateId, IsOldOrder
	FROM #TempOrderData
	WHERE ISNULL(OmsOrderId,0) = 0

	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		INSERT INTO ZnodeOmsOrderDetails
		(
			OmsOrderId,PortalId,UserId,OrderDate,OmsOrderStateId,ShippingId,PaymentTypeId,BillingFirstName,BillingLastName
			,BillingCompanyName,BillingStreet1,BillingStreet2,BillingCity,BillingStateCode,BillingPostalCode,BillingCountry
			,BillingPhoneNumber,BillingEmailId,TaxCost,ShippingCost,SubTotal,DiscountAmount,CurrencyCode,OverDueAmount,Total
			,ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive
			,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
			,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
			,DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
			,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty
		)
		OUTPUT INSERTED.OmsOrderId, INSERTED.OmsOrderDetailsId INTO @OMSOrderDetail
		SELECT OO.OmsOrderId, OD.PortalId,@UserId,@GetDate,OD.OmsOrderStateId,OD.ShippingId,OD.PaymentTypeId,BA.FirstName,BA.LastName,BA.CompanyName,
		BA.Address1,BA.Address2,BA.CityName,BA.StateName,BA.PostalCode,BA.CountryName,BA.PhoneNumber,BA.EmailAddress,OD.TaxCost,
		OD.ShippingCost,OD.SubTotal, OD.DiscountAmount,OD.CurrencyCode,OD.OverDueAmount,OD.Total
		,OD.ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
		,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,OD.BillingAddressId,PoDocument,CAST(1 AS BIT) AS IsActive
		,OD.ExternalId,OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
		,ShippingDifference,EstimateShippingCost,TransactionId,OD.Custom1,OD.Custom2,OD.Custom3,OD.Custom4,OD.Custom5,OD.FirstName,OD.LastName
		,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
		,OD.DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
		,IsCalculateTaxAfterDiscount,Email,OD.PhoneNumber,OrderTotalWithoutVoucher,ImportDuty
		FROM #TempOrderData OD
		INNER JOIN @OMSOrder OO ON OD.OrderNumber = OO.OrderNumber
		INNER JOIN #BillingAddress BA ON OD.BillingAddressId = BA.AddressId

	END
	ELSE
	BEGIN
		Declare @OldOmsOrderDetailsId INT
		SET @OldOmsOrderDetailsId = (SELECT TOP 1 OOD.OmsOrderDetailsId FROM ZnodeOmsOrderDetails OOD  WITH (NOLOCK) 
									 WHERE EXISTS(SELECT * FROM ZnodeOmsOrder OO  WITH (NOLOCK) WHERE OO.OmsOrderId = OOD.OmsOrderId 
											AND EXISTS(SELECT * FROM #TempOrderData OD WHERE OD.OrderNumber = OO.OrderNumber))
									 AND OOD.IsActive = 1)

		INSERT INTO ZnodeOmsOrderDetails
		(
			OmsOrderId,PortalId,UserId,OrderDate,OmsOrderStateId,ShippingId,PaymentTypeId,BillingFirstName,BillingLastName
			,BillingCompanyName,BillingStreet1,BillingStreet2,BillingCity,BillingStateCode,BillingPostalCode,BillingCountry
			,BillingPhoneNumber,BillingEmailId,TaxCost,ShippingCost,SubTotal,DiscountAmount,CurrencyCode,OverDueAmount,Total
			,ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive
			,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
			,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
			,DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
			,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty
		)
		OUTPUT INSERTED.OmsOrderId, INSERTED.OmsOrderDetailsId INTO @OMSOrderDetail
		SELECT OO.OmsOrderId, OD.PortalId,@UserId,@GetDate,OD.OmsOrderStateId,OD.ShippingId,OD.PaymentTypeId,BA.FirstName,BA.LastName,BA.CompanyName,
		BA.Address1,BA.Address2,BA.CityName,BA.StateName,BA.PostalCode,BA.CountryName,BA.PhoneNumber,BA.EmailAddress,OD.TaxCost,
		OD.ShippingCost,OD.SubTotal, OD.DiscountAmount,OD.CurrencyCode,OD.OverDueAmount,OD.Total
		,OD.ShippingNumber,OD.TrackingNumber,OD.CouponCode,OD.PromoDescription,OD.ReferralUserId,OD.PurchaseOrderNumber,OD.OmsPaymentStateId
		,OD.WebServiceDownloadDate,OD.PaymentSettingId,OD.PaymentTransactionToken,OD.ShipDate,OD.ReturnDate,OD.BillingAddressId,OD.PoDocument,CAST(1 AS BIT) AS IsActive
		,OD.ExternalId,OD.CreatedBy,OOD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.CreditCardNumber,OD.IsShippingCostEdited,OD.IsTaxCostEdited
		,OD.ShippingDifference,OD.EstimateShippingCost,OD.TransactionId,OD.Custom1,OD.Custom2,OD.Custom3,OD.Custom4,OD.Custom5,OD.FirstName,OD.LastName
		,OD.CardType,OD.CreditCardExpMonth,OD.CreditCardExpYear,OD.TotalAdditionalCost,CASE WHEN OD.PaymentSettingId = OOD.PaymentSettingId THEN OOD.PaymentDisplayName ELSE OD.PaymentDisplayName END AS PaymentDisplayName,
		CASE WHEN OD.PaymentSettingId = OOD.PaymentSettingId THEN OOD.PaymentExternalId ELSE OD.PaymentExternalId END AS PaymentExternalId,OD.CultureCode
		,OD.DisplayName,OD.InHandDate,OD.IpAddress,OD.JobName,OD.ShippingConstraintCode,OD.ShippingDiscount,OD.ShippingHandlingCharges,OD.ReturnCharges
		,OD.IsCalculateTaxAfterDiscount,OD.Email,OD.PhoneNumber,OD.OrderTotalWithoutVoucher,OD.ImportDuty
		FROM #TempOrderData OD
		INNER JOIN ZnodeOmsOrder OO WITH (NOLOCK) ON OD.OrderNumber = OO.OrderNumber
		INNER JOIN ZnodeOmsOrderDetails OOD  WITH (NOLOCK) ON OO.OmsOrderId = OOD.OmsOrderId AND OOD.IsActive = 1
		INNER JOIN #BillingAddress BA ON OD.BillingAddressId = BA.AddressId

		DECLARE @OmsOrderStateIdCancelled int =  (select top 1 OmsOrderStateId From ZnodeOmsOrderState WHERE OrderStateName = 'CANCELLED')

		UPDATE ZnodeOmsOrderDetails SET IsActive = 0 , OmsOrderStateId = @OmsOrderStateIdCancelled
		WHERE OmsOrderDetailsId = @OldOmsOrderDetailsId

		UPDATE ZnodeOmsOrderLineItems SET IsActive = 0
		WHERE OmsOrderDetailsId = @OldOmsOrderDetailsId
	END

	Declare @OmsOrderDetailsId INT
	SET @OmsOrderDetailsId = ( SELECT TOP 1 OmsOrderDetailsId FROM @OMSOrderDetail )

	--Insert Order Notes
	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		INSERT INTO ZnodeOmsNotes(OmsOrderDetailsId,Notes,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
		SELECT @OmsOrderDetailsId,Tbl.Col.value( 'AdditionalInstructions[1]', 'NVARCHAR(Max)' ) AS Notes,
		@UserId,@GetDate,@UserId,@GetDate
		FROM @OrderXML.nodes( '//PlaceOrderModel' ) AS Tbl(Col)
		WHERE Tbl.Col.value( 'AdditionalInstructions[1]', 'NVARCHAR(Max)' ) <> '';
	END

	----Inserting parent line item data
	INSERT INTO ZnodeOmsOrderLineItems
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy
		,ModifiedDate,AutoAddonSku,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity
	)
	OUTPUT INSERTED.OmsOrderDetailsId, INSERTED.OmsOrderLineItemsId, INSERTED.Sku,INSERTED.ParentOmsOrderLineItemsId, INSERTED.GroupId, INSERTED.OrderLineItemRelationshipTypeId INTO @OmsParentOrderLineItems
	SELECT OrderLineItemRelationshipTypeId,@OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description
	,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber
	,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles
	,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,ISNULL(IsActive,1) AS IsActive,CreatedBy,CreatedDate,ModifiedBy
	,ModifiedDate,AutoAddonSku,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity
	FROM #TempParentLineItemDetails PLID

	----Inserting child line item data
	INSERT INTO ZnodeOmsOrderLineItems
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy
		,ModifiedDate,AutoAddonSku,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, ParentSku
	)
	OUTPUT INSERTED.OmsOrderDetailsId, INSERTED.OmsOrderLineItemsId, INSERTED.Sku,INSERTED.ParentOmsOrderLineItemsId, INSERTED.GroupId, INSERTED.OrderLineItemRelationshipTypeId, INSERTED.ParentSku INTO @OmsOrderLineItems
	SELECT PLID.OrderLineItemRelationshipTypeId,@OmsOrderDetailsId,PLID.OmsOrderShipmentId,PLID.RmaReasonForReturnId,PLID.Sku,
	PLID.ProductName,PLID.Description,PLID.Quantity,PLID.Price,PLID.Weight,PLID.DownloadLink,PLID.DiscountAmount,PLID.ShipSeparately,PLID.ShipDate,
	PLID.ReturnDate,PLID.ShippingCost,PLID.PromoDescription,PLID.TransactionNumber,PLID.PaymentStatusId,PLID.TrackingNumber,PLID.IsAutoGeneratedTracking,
	PLID.OrderLineItemStateId,PLID.IsRecurringBilling,PLID.RecurringBillingPeriod,PLID.RecurringBillingCycles,PLID.RecurringBillingFrequency,PLID.RecurringBillingAmount,
	PLID.AppliedPromo,PLID.CouponsApplied,PLID.ExternalId,isnull(PLID.IsActive,1) AS IsActive,PLID.CreatedBy,PLID.CreatedDate,PLID.ModifiedBy
	,PLID.ModifiedDate,PLID.AutoAddonSku,PLID.IsShippingReturn,PLID.PartialRefundAmount,PLID.Custom1,PLID.Custom2,PLID.Custom3,PLID.Custom4,PLID.Custom5,
	PLID.GroupId,PLID.BundleQuantity, case when PLID.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdSimple then PLID.Sku else PLID.ParentSku end as ParentSku
	FROM #TempChildLineItemDetails PLID

	--Updating ParentOmsOrderLineItemsId for child line items
	UPDATE A SET A.ParentOmsOrderLineItemsId = (SELECT TOP 1 OmsOrderLineItemsId FROM @OmsParentOrderLineItems d WHERE d.Sku = B.ParentSku  and ISNULL(a.GroupId,'-') = ISNULL(d.GroupId,'-'))
	from ZnodeOmsOrderLineItems a
	INNER JOIN #TempChildLineItemDetails b on a.Sku = b.Sku and a.OrderLineItemRelationshipTypeId = b.OrderLineItemRelationshipTypeId
	where a.OrderLineItemRelationshipTypeId NOT IN (@OrderLineItemRelationshipTypeIdAddon ,@OrderLineItemRelationshipTypeIdGroup)
	AND exists(select * from @OmsOrderLineItems c where c.OmsOrderLineItemsId = a.OmsOrderLineItemsId )
	AND A.ParentOmsOrderLineItemsId IS NULL 

	--Updating ParentOmsOrderLineItemsId for child line items for group products
	UPDATE A SET A.ParentOmsOrderLineItemsId = d.OmsOrderLineItemsId
	from ZnodeOmsOrderLineItems a
	INNER JOIN #TempChildLineItemDetails b ON a.Sku = b.Sku and a.OrderLineItemRelationshipTypeId = b.OrderLineItemRelationshipTypeId 
	INNER JOIN @OmsParentOrderLineItems d ON d.Sku = B.ParentSku and d.RowId = b.RowId and ISNULL(a.GroupId,'-') = ISNULL(d.GroupId,'-')
	where a.OrderLineItemRelationshipTypeId<>@OrderLineItemRelationshipTypeIdAddon 
	AND a.OrderLineItemRelationshipTypeId=@OrderLineItemRelationshipTypeIdGroup
	AND exists(select * from @OmsOrderLineItems c where c.OmsOrderLineItemsId = a.OmsOrderLineItemsId )
	AND A.ParentOmsOrderLineItemsId IS NULL 
	
	--Updating ParentOmsOrderLineItemsId for addon
	select c.Sku, b.OmsOrderLineItemsId
	into #AddonParentUpdate
	from @OmsOrderLineItems c
	INNER JOIN @OmsParentOrderLineItems b on c.ParentSku = b.Sku
	where c.OrderLineItemRelationshipTypeId<>1 and c.OrderLineItemRelationshipTypeId is not null
	and b.OrderLineItemRelationshipTypeId=@OrderLineItemRelationshipTypeIdAddon

	update a set ParentOmsOrderLineItemsId = b.OmsOrderLineItemsId
	from ZnodeOmsOrderLineItems a
	INNER JOIN #AddonParentUpdate b on a.ParentSku = b.Sku
	where exists(select * from @OmsOrderLineItems c where c.OmsOrderLineItemsId = a.OmsOrderLineItemsId and c.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
	AND A.ParentOmsOrderLineItemsId IS NULL AND A.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon

	--Updating ParentOmsOrderLineItemsId for addon for bundle
	 SELECT c.parentSku as Sku, b.OmsOrderLineItemsId
	 INTO #AddonBundleParentUpdate
	 FROM @OmsOrderLineItems c
	 INNER JOIN @OmsParentOrderLineItems b on B.Sku = C.parentSku
	 WHERE B.OrderLineItemRelationshipTypeId is null
	 AND C.OrderLineItemRelationshipTypeId=@OrderLineItemRelationshipTypeIdAddon

	 UPDATE a set ParentOmsOrderLineItemsId = b.OmsOrderLineItemsId
	 FROM ZnodeOmsOrderLineItems a
	 INNER JOIN #AddonBundleParentUpdate b on a.ParentSku = b.Sku
	 where exists(select * from @OmsOrderLineItems c where c.OmsOrderLineItemsId = a.OmsOrderLineItemsId and c.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
	 AND A.ParentOmsOrderLineItemsId IS NULL AND A.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon

	----Shipping details Start
	DECLARE @ShippingTypeId INT
	IF EXISTS(SELECT * FROM #TempOrderData WHERE ShippingTypeId IS NULL)
	BEGIN
		SET @ShippingTypeId = (SELECT TOP 1 ShippingTypeId FROM ZnodeShipping WHERE EXISTS(SELECT * FROM #TempOrderData WHERE ZnodeShipping.ShippingId = #TempOrderData.ShippingId))
	END
	ELSE
	BEGIN
		SET @ShippingTypeId = (SELECT TOP 1 ShippingTypeId FROM #TempOrderData)
	END
	IF EXISTS(SELECT * FROM ZnodeShippingTypes WITH (NOLOCK)  WHERE ShippingTypeId = @ShippingTypeId AND ClassName = 'ZnodeCustomerShipping')
	BEGIN
		INSERT INTO ZnodeOmsCustomerShipping(OmsOrderDetailsId,UserId,ShippingTypeId,AccountNumber,ShippingMethod,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT TOP 1 @OmsOrderDetailsId,@UserId,@ShippingTypeId,AccountNumber,ShippingMethod,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		FROM #TempOrderData
	END
	----Shipping details end

	----Order tax details start
	----Inserting order tax data
	INSERT INTO ZnodeOmsTaxOrderDetails(OmsOrderDetailsId,SalesTax,VAT,GST,PST,HST,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportDuty)
	SELECT @OmsOrderDetailsId,OD.SalesTax,OD.VAT,OD.GST,OD.PST,OD.HST,OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.ImportDuty
	FROM #TempOrderData OD

	----Inserting order tax data for parent line item
	INSERT INTO ZnodeOmsTaxOrderLineDetails
	(
		OmsOrderLineItemsId,TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty,
		CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
	)
	SELECT POLI.OmsOrderLineItemsId,CLID.TaxRuleId,CLID.TaxTransactionNumber,CLID.Comments,CLID.SalesTax,CLID.VAT,CLID.GST,CLID.PST,CLID.HST,CLID.ImportDuty,
	CLID.CreatedBy,CLID.CreatedDate,CLID.ModifiedBy,CLID.ModifiedDate
	FROM #TempParentLineItemDetails CLID
	INNER JOIN @OmsOrderLineItems POLI ON CLID.Sku = POLI.Sku AND ISNULL(CLID.GroupId,'') = ISNULL(POLI.GroupId,'')
	WHERE POLI.ParentOmsOrderLineItemsId IS NULL

	----Inserting order tax data for child line item
	INSERT INTO ZnodeOmsTaxOrderLineDetails
	(
		OmsOrderLineItemsId,TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty,
		CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
	)
	SELECT POLI.OmsOrderLineItemsId,CLID.TaxRuleId,CLID.TaxTransactionNumber,CLID.Comments,CLID.SalesTax,CLID.VAT,CLID.GST,CLID.PST,CLID.HST,CLID.ImportDuty,
		CLID.CreatedBy,CLID.CreatedDate,CLID.ModifiedBy,CLID.ModifiedDate
	FROM #TempChildLineItemDetails CLID
	INNER JOIN @OmsOrderLineItems POLI ON CLID.Sku = POLI.Sku AND ISNULL(CLID.GroupId,'') = ISNULL(POLI.GroupId,'')
	WHERE POLI.ParentOmsOrderLineItemsId IS NOT NULL
	----Order tax details end

	----Order attribte details start
	----Fetching order attributes from xml
	INSERT INTO #TempOrderAttribute(AttributeCode ,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AttributeValueCode,Sku,GroupId )
	SELECT
	Tbl.Col.value( 'AttributeCode[1]', 'NVARCHAR(Max)' ) AS AttributeCode,
	Tbl.Col.value( 'AttributeValue[1]', 'NVARCHAR(Max)' ) AS AttributeValue,
	@UserId,@GetDate,@UserId,@GetDate,
	Tbl.Col.value( 'AttributeValueCode[1]', 'NVARCHAR(2000)' ) AS AttributeValueCode,
	Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
	Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/OrderLineItem/PlaceOrderlineItemCollection/orderAttribute/PlaceOrderAttributeModel' ) AS Tbl(Col);

	----Inserting order attributes data
	INSERT INTO ZnodeOmsOrderAttribute(OmsOrderLineItemsId,AttributeCode,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AttributeValueCode)
	SELECT POLI.OmsOrderLineItemsId, OA.AttributeCode,OA.AttributeValue,OA.CreatedBy,OA.CreatedDate,OA.ModifiedBy,OA.CreatedDate,OA.AttributeValueCode
	FROM #TempOrderAttribute OA
	INNER JOIN @OmsOrderLineItems POLI ON OA.Sku = POLI.Sku AND ISNULL(OA.GroupId,'') = ISNULL(POLI.GroupId,'')
	----Order attribte details end

	----Personalise details start
	----Fetching personalize order data
	INSERT INTO #OmsPersonalizeItem(PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL,Sku,GroupId)
	SELECT
	Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode,
	Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue,
	@UserId,@GetDate,@UserId,@GetDate,
	Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(2000)' ) AS DesignId,
	Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(2000)' ) AS ThumbnailURL,
	Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
	Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/PersonaliseDetails/PlaceOrderPersonaliseModel' ) AS Tbl(Col);

	--Inserting personalize order data
	INSERT INTO ZnodeOmsPersonalizeItem(OmsOrderLineItemsId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL)
	SELECT OmsOrderLineItemsId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL
	FROM #OmsPersonalizeItem OPI
	INNER JOIN @OmsOrderLineItems POLI ON OPI.Sku = POLI.Sku AND ISNULL(OPI.GroupId,'') = ISNULL(POLI.GroupId,'')
	WHERE POLI.ParentOmsOrderLineItemsId IS NULL
	----Personalise details end

	----discount details start
	----Fetching order discount data
	INSERT INTO #OmsOrderDiscount
	(
		OmsDiscountTypeId ,DiscountCode,DiscountAmount ,Description ,CreatedBy ,CreatedDate ,
		ModifiedBy ,ModifiedDate ,PerQuantityDiscount,DiscountMultiplier ,DiscountLevelTypeId ,
		PromotionName ,PromotionTypeId ,DiscountAppliedSequence,PromotionMessage ,Sku,GroupId
	)
	SELECT
	CASE WHEN Tbl.Col.value( 'OmsDiscountTypeId[1]', 'NVARCHAR(2000)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OmsDiscountTypeId[1]', 'NVARCHAR(2000)' ) END AS OmsDiscountTypeId,
	Tbl.Col.value( 'DiscountCode[1]', 'NVARCHAR(Max)' ) AS DiscountCode,
	CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
	Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
	@UserId,@GetDate,@UserId,@GetDate,
	CASE WHEN Tbl.Col.value( 'PerQuantityDiscount[1]', 'NVARCHAR(2000)' )='' THEN NULL ELSE Tbl.Col.value( 'PerQuantityDiscount[1]', 'NVARCHAR(2000)' ) END AS PerQuantityDiscount,
	CASE WHEN Tbl.Col.value( 'DiscountMultiplier[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountMultiplier[1]', 'NVARCHAR(2000)' ) END AS DiscountMultiplier,
	CASE WHEN Tbl.Col.value( 'DiscountLevelTypeId[1]', 'NVARCHAR(2000)' )= '' THEN NULL ELSE Tbl.Col.value( 'DiscountLevelTypeId[1]', 'NVARCHAR(2000)' ) END AS DiscountLevelTypeId,
	Tbl.Col.value( 'PromotionName[1]', 'NVARCHAR(2000)' ) AS PromotionName,
	CASE WHEN Tbl.Col.value( 'PromotionTypeId[1]', 'NVARCHAR(2000)' )= '' THEN NULL ELSE Tbl.Col.value( 'PromotionTypeId[1]', 'NVARCHAR(2000)' ) END AS PromotionTypeId,
	Tbl.Col.value( 'DiscountAppliedSequence[1]', 'NVARCHAR(2000)' ) AS DiscountAppliedSequence,
	Tbl.Col.value( 'PromotionMessage[1]', 'NVARCHAR(2000)' ) AS PromotionMessage,
	Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
	Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId
	FROM @OrderXML.nodes('//PlaceOrderModel/OrderDiscounts/PlaceOrderDiscountModel') AS Tbl(Col)

	----Inserting order discount data
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,POLI.OmsOrderLineItemsId,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
	OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,POLI.ParentOmsOrderLineItemsId,
	OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	LEFT JOIN @OmsOrderLineItems POLI ON OD.Sku = POLI.Sku AND ISNULL(OD.GroupId,'') = ISNULL(POLI.GroupId,'')

	----discount details end

	----Additional Cost details start
	IF OBJECT_ID('TEMPDB..#TempAdditionalCost') IS NOT NULL
	DROP TABLE #TempAdditionalCost
	--fetching additional cost details
	SELECT Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
	Tbl1.Col.value( 'KeyName[1]', 'NVARCHAR(2000)' ) AS KeyName,
	CASE WHEN Tbl1.Col.value( 'KeyValue[1]', 'NVARCHAR(2000)' )='' THEN NULL ELSE Tbl1.Col.value( 'KeyValue[1]', 'NVARCHAR(2000)' ) END AS KeyValue,
	Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId
	INTO #TempAdditionalCost
	FROM @OrderXML.nodes('//PlaceOrderModel/LineItems/PlaceOrderLineItemModel') AS Tbl(Col)
	CROSS APPLY Tbl.Col.nodes( '*:AdditionalCostList/AdditionalCost' ) AS Tbl1(Col);

	--Inserting additional cost details
	IF EXISTS(SELECT * FROM #TempAdditionalCost)
	BEGIN
		INSERT INTO ZnodeOmsOrderLineItemsAdditionalCost(OmsOrderLineItemsId,KeyName,KeyValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT OLI.OmsOrderLineItemsId, AC.KeyName, AC.KeyValue, @UserId, @GetDate, @UserId, @GetDate
		FROM #TempAdditionalCost AC
		INNER JOIN @OmsOrderLineItems OLI ON AC.Sku = OLI.Sku AND ISNULL(AC.GroupId,'') = ISNULL(OLI.GroupId,'')
		WHERE OLI.ParentOmsOrderLineItemsId IS NULL
		AND ISNULL(AC.KeyName,'') <> ''
	END
	----Additional Cost details end

	----RMA details start
	IF (SELECT TOP 1 OmsOrderID FROM #TempOrderData) > 0
	BEGIN
		DECLARE @OmsOrderID INT, @OldOmsOrderDetailID INT
		SET @OmsOrderID = (SELECT TOP 1 OmsOrderId FROM #TempOrderData)
		SET @OldOmsOrderDetailID = (SELECT TOP 1 OmsOrderDetailsId FROM ZnodeOmsOrderDetails WHERE OmsOrderId = @OmsOrderID AND OmsOrderDetailsId <> @OmsOrderDetailsId ORDER BY OmsOrderDetailsId DESC)

		UPDATE ZnodeRmaReturnDetails
		SET OmsOrderDetailsId = @OmsOrderDetailsId
		WHERE OmsOrderId = @OmsOrderID

		SELECT OOLI.OmsOrderLineItemsId AS OldOmsOrderLineItemsId, OOLI.OmsOrderDetailsId, OOLI.Sku, LI.OmsOrderLineItemsId as NewOmsOrderLineItemsId
		INTO #OldOrderLineItems
		FROM ZnodeOmsOrderLineItems OOLI WITH (NOLOCK)
		INNER JOIN @OmsOrderLineItems LI ON LI.Sku = OOLI.Sku
		WHERE OOLI.OmsOrderDetailsId = @OldOmsOrderDetailID --AND OOLI.ParentOmsOrderLineItemsId IS NULL
 
		UPDATE RRLI SET RRLI.OmsOrderLineItemsId = OldLI.NewOmsOrderLineItemsId
		FROM ZnodeRmaReturnLineItems RRLI
		INNER JOIN #OldOrderLineItems OldLI ON RRLI.OmsOrderLineItemsId = OldOmsOrderLineItemsId
	END
	----RMA details end

	COMMIT TRAN OrderInsert

	SELECT TOP 1 OmsOrderId,@OmsOrderDetailsId AS OmsOrderDetailsId, cast(1 as bit)  AS Status, '' AS ErrorMessage
	FROM @OMSOrderDetail

END TRY
BEGIN CATCH
	ROLLBACK TRAN OrderInsert
	SELECT TOP 1 0 as OmsOrderId,0 AS OmsOrderDetailsId, cast(0 as bit)  AS Status, ERROR_MESSAGE() AS ErrorMessage

	INSERT INTO ZnodeOmsFailedOrderPayments(PaymentCode,PaymentDisplayName,TransactionToken,TotalAmount,UserName,UserId,Email,PaymentSettingId,OrderNumber,OrderDate,PaymentStatusId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
	SELECT TOP 1 PaymentCode,PaymentDisplayName, PaymentTransactionToken,Total,a.FirstName+' '+a.LastName,@UserId,a.Email,a.PaymentSettingId,a.OrderNumber,@GetDate,PaymentStatusId,@UserId,@GetDate,@UserId,@GetDate
	FROM #TempOrderData A

	DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertUpdateOmsOrder @OrderXML ='+CAST(@OrderXML AS VARCHAR(MAX))+' , @UserId = '+CAST(@UserId AS VARCHAR(50));

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName    = 'Znode_InsertUpdateOmsOrder',
	@ErrorInProcedure = @ERROR_PROCEDURE,
	@ErrorMessage     = @ErrorMessage,
	@ErrorLine        = @ErrorLine,
	@ErrorCall        = @ErrorCall;
	--If error throw in SP the deleting records from order tables if data inserted
	EXEC Znode_DeleteOrderById @OrderDetailId=@OmsOrderDetailsId,@Status=0
END CATCH

END

GO


IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_SetPublishContentContainerGlobalAttributeEntity')
	DROP PROC Znode_SetPublishContentContainerGlobalAttributeEntity
GO

CREATE PROCEDURE [dbo].[Znode_SetPublishContentContainerGlobalAttributeEntity]
(
	 @ContainerKey VARCHAR(50) = ''
	 ,@ContainerProfileVariantId INT = 0
)
AS
    
/*
exec [Znode_SetPublishContentContainerGlobalAttributeEntity] @ContainerKey = 'HomePagePromo', @ContainerProfileVariantId = 0
    Summary :	Publish Product on the basis of publish catalog
				Retrive all Product details with attributes and INSERT INTO following tables 
				1.	ZnodePublishedXml
				2.	ZnodePublishCategoryProduct
				3.	ZnodePublishProduct
				4.	ZnodePublishProductDetail

                Product details include all the type of products link, grouped, configure and bundel products (include addon) their associated products 
				collect their attributes and values into tables variables to process for publish.  
                
				Finally genrate XML for products with their attributes and inserted into ZnodePublishedXml Znode Admin process xml from sql server to mongodb
				one by one.

 */

BEGIN
	
	BEGIN TRY
		SET NOCOUNT ON;
		DECLARE @VersionId Int, @CMSContentContainerId int
		--SET @VersionId = ( SELECT TOP 1 VersionId FROM ZnodePublishContetContainerVersionEntity WHERE PublishState = @RevisionState )

		DECLARE @SetLocaleId INT, @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleId(), @MaxCount INT =0 , @IncrementalId INT = 1;
		DECLARE @TBL_Locale TABLE (LocaleId INT , RowId INT IDENTITY(1,1));

		DECLARE @V_MediaServerThumbnailPath VARCHAR(4000);
          SET @V_MediaServerThumbnailPath =
         (
             SELECT ISNULL(CASE WHEN CDNURL = '' THEN NULL ELSE CDNURL END,URL) 
             FROM ZnodeMediaConfiguration ZMC 
			 --INNER JOIN ZnodeMediaServerMaster ZMSM ON (ZMSM.MediaServerMasterId = ZMC.MediaServerMasterId)
		     WHERE IsActive = 1 
         );
		--If @PreviewVersionId = 0 
		--	Begin
  -- 				INSERT INTO @Tbl_PreviewVersionId 
		--		SELECT distinct VersionId , PortalId, LocaleId FROM  ZnodePublishWebStoreEntity WHERE (PortalId = @PortalId or @PortalId=0 ) and PublishState ='PREVIEW'
		--	end
		--Else 
		--		INSERT INTO @Tbl_PreviewVersionId SELECT distinct VersionId , PortalId, LocaleId FROM  ZnodePublishWebStoreEntity 
		--		WHERE VersionId = @PreviewVersionId
		--If @ProductionVersionId = 0 
  -- 			Begin
		--		INSERT INTO @Tbl_ProductionVersionId 
		--		SELECT distinct VersionId , PortalId , LocaleId FROM  ZnodePublishWebStoreEntity WHERE (PortalId = @PortalId or @PortalId=0 ) and PublishState ='PRODUCTION'
		--	End 
		--Else 
		
		--	INSERT INTO @Tbl_ProductionVersionId SELECT distinct VersionId , PortalId, LocaleId FROM  ZnodePublishWebStoreEntity 
		--	WHERE VersionId = @ProductionVersionId
		--	DECLARE @SetLocaleId INT , @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleId(), @MaxCount INT =0 , @IncrementalId INT = 1  
		--DECLARE @TBL_Locale TABLE (LocaleId INT , RowId INT IDENTITY(1,1))

		DECLARE @TBL_GlobalAttributeGrouplist TABLE ([GlobalAttributeGroupId] INT , [AttributeGroupDisplayOrder] INT,Groups int )
		DECLARE @TBL_GlobalAttributelist      TABLE ([GlobalAttributeGroupId] INT , [GlobalAttributeId] INT,[AttributeDisplayOrder] int ,Attributes int )
		Declare	@EntityAttributeValueList as	table
		(
			IsInput bit, IsMedia BIT, AttributeValues int,WidgetGlobalAttributeValueId int,GlobalAttributeId int,AttributeValue nvarchar(max),
			GlobalAttributeValueId int,GlobalAttributeDefaultValueId int,AttributeDefaultValueCode nvarchar(300),
			AttributeDefaultValue nvarchar(300),MediaId int,MediaPath nvarchar(300) ,SwatchText nvarchar(300),DisplayOrder int,
			SingleAttributeValue nvarchar(max), CMSContainerProfileVariantId INT,LocaleId INT
		)
		Declare	@EntityAttributeSingleValueList as table(AttributeValues int,PortalGlobalAttributeValueId int,GlobalAttributeId int)

		Declare @LocaleId INT , @GetDate DATETIME =dbo.Fn_GetDate()

		IF @ContainerKey <> ''
		BEGIN
			Select @CMSContentContainerId= CMSContentContainerId 
			from ZnodeCMSContentContainer  
			WHERE ContainerKey = @ContainerKey
		END

		INSERT INTO @EntityAttributeValueList
		(
			IsInput, IsMedia,AttributeValues,WidgetGlobalAttributeValueId,GlobalAttributeId,GlobalAttributeValueId,GlobalAttributeDefaultValueId,
			AttributeValue ,MediaId,MediaPath,SingleAttributeValue,CMSContainerProfileVariantId, LocaleId
		)
		Select case when zga.GroupAttributeType in('Input','TextArea')   then 1  else 0 end ,
				0, 1, aa.WidgetGlobalAttributeValueId,aa.GlobalAttributeId,aa.WidgetGlobalAttributeValueId,bb.GlobalAttributeDefaultValueId,

			case when zga.GroupAttributeType in('Input','TextArea')   then null  else  bb.AttributeValue  end AttributeValue,	  
			bb.MediaId,CASE WHEN bb.MediaPath IS NOT NULL THEN @V_MediaServerThumbnailPath+bb.MediaPath ELSE bb.MediaPath END AS MediaPath ,
			case when zga.GroupAttributeType in('Input','TextArea')   then bb.AttributeValue   else null end  SingleAttributeValue,
			aa.CMSContainerProfileVariantId, bb.LocaleId
		FROM ZnodeWidgetGlobalAttributeValue aa
		INNER JOIN ZnodeWidgetGlobalAttributeValueLocale bb ON bb.WidgetGlobalAttributeValueId = aa.WidgetGlobalAttributeValueId 
		INNER JOIN View_ZnodeGlobalAttribute zga on zga.[GlobalAttributeId]=aa.[GlobalAttributeId]
		WHERE (aa.CMSContainerProfileVariantId = @ContainerProfileVariantId OR @ContainerProfileVariantId = 0)
		AND (AA.CMSContentContainerId = @CMSContentContainerId OR ISNULL(@CMSContentContainerId,0) = 0 )
		AND bb.MediaId IS NULL 
				

		INSERT INTO @EntityAttributeValueList
		(IsInput,IsMedia,AttributeValues,WidgetGlobalAttributeValueId,GlobalAttributeId,GlobalAttributeValueId,GlobalAttributeDefaultValueId,AttributeValue ,MediaId,MediaPath,SingleAttributeValue,CMSContainerProfileVariantId,LocaleId)
		Select 1,1 ,1, aa.WidgetGlobalAttributeValueId,aa.GlobalAttributeId,aa.WidgetGlobalAttributeValueId,null GlobalAttributeDefaultValueId,
			NULL AttributeValue,	  
			NULL MediaId,null MediaPath,
			NULL SingleAttributeValue, aa.CMSContainerProfileVariantId	,bb.LocaleId
		FROM dbo.ZnodeWidgetGlobalAttributeValue aa
		INNER JOIN ZnodeWidgetGlobalAttributeValueLocale bb ON bb.WidgetGlobalAttributeValueId = aa.WidgetGlobalAttributeValueId 
		INNER JOIN View_ZnodeGlobalAttribute zga on zga.[GlobalAttributeId]=aa.[GlobalAttributeId]
		WHERE (AA.CMSContentContainerId = @CMSContentContainerId OR ISNULL(@CMSContentContainerId,0) = 0 )
		AND zga.GroupAttributeType ='Media'


		UPDATE aa
		Set SingleAttributeValue= ( Select CASE WHEN bb.MediaPath IS NOT NULL THEN @V_MediaServerThumbnailPath+bb.MediaPath ELSE bb.MediaPath END AS MediaPath FROM  ZnodeWidgetGlobalAttributeValueLocale bb 
			WHERE bb.WidgetGlobalAttributeValueId = aa.WidgetGlobalAttributeValueId
			FOR XML PATH ('') )				
		FROM  @EntityAttributeValueList aa
		WHERE aa.IsMedia=1

		UPDATE aa
		Set SingleAttributeValue= replace(replace(SingleAttributeValue,'</MediaPath>',','),'<MediaPath>','')
		FROM  @EntityAttributeValueList aa
		WHERE aa.IsMedia=1

		UPDATE aa
		Set SingleAttributeValue= Substring(SingleAttributeValue,1,len(SingleAttributeValue)-1)
		FROM  @EntityAttributeValueList aa
		WHERE aa.IsMedia=1

		UPDATE aa
		SET AttributeDefaultValueCode= h.AttributeDefaultValueCode,
			SwatchText=h.SwatchText,
			AttributeValue=g.AttributeDefaultValue,
			GlobalAttributeDefaultValueId=g.GlobalAttributeDefaultValueId,
			DisplayOrder=h.DisplayOrder
		FROM  @EntityAttributeValueList aa
		INNER JOIN dbo.ZnodeGlobalAttributeDefaultValue h ON h.GlobalAttributeDefaultValueId = aa.GlobalAttributeDefaultValueId                                       
		INNER JOIN dbo.ZnodeGlobalAttributeDefaultValueLocale g ON h.GlobalAttributeDefaultValueId = g.GlobalAttributeDefaultValueId and aa.LocaleId = g.LocaleId
          
		INSERT INTO @TBL_GlobalAttributeGrouplist
		([GlobalAttributeGroupId] , [AttributeGroupDisplayOrder],Groups )
		SELECT ss.[GlobalAttributeGroupId],ss.[AttributeGroupDisplayOrder],1
		FROM [dbo].[ZnodeGlobalGroupEntityMapper] SS
		INNER JOIN dbo.ZnodeGlobalEntity aa on ss.[GlobalEntityId]=aa.[GlobalEntityId]
		WHERE aa.EntityName='Content Containers'
		--FOR XML PATH('')

		INSERT INTO @TBL_GlobalAttributelist
		([GlobalAttributeGroupId] , [GlobalAttributeId],[AttributeDisplayOrder],Attributes )
		SELECT aa.[GlobalAttributeGroupId],aa.[GlobalAttributeId] ,aa.[AttributeDisplayOrder],1
		FROM [dbo].[ZnodeGlobalAttributeGroupMapper] aa
		INNER JOIN @TBL_GlobalAttributeGrouplist ss on ss.GlobalAttributeGroupId=aa.GlobalAttributeGroupId
			
		IF object_id('tempdb..[#GlobalAttributeGrouplist]') IS NOT NULL
			drop table tempdb..#GlobalAttributeGrouplist

		CREATE TABLE #GlobalAttributeGrouplist 
		( 
			CMSContainerProfileVariantId INT,LocaleId	int,GlobalAttributeGroupId	int	,GroupCode	varchar	(200),AttributeGroupName nvarchar(600),AttributeGroupDisplayOrder int,
			GlobalAttributeId	int	,AttributeDisplayOrder	int	,AttributeCode	nvarchar	(600),AttributeName	nvarchar	(600),IsRequired	bit	,
			AttributeTypeName	varchar	(300),AttributeTypeId	int	,SingleAttributeValue	nvarchar(max),SelectValues	nvarchar(max)
		)

		SET @LocaleId = 0 

		INSERT INTO @TBL_Locale (LocaleId) 
		SELECT LocaleId FROM ZnodeLocale WHERE IsActive =1 AND (LocaleId  = @LocaleId OR @LocaleId = 0 )

		SET @MaxCount = ISNULL((SELECT MAx(RowId) FROM @TBL_Locale),0)
		WHILE @IncrementalId <= @MaxCount
		BEGIN 
			SET @SetLocaleId = (SELECT Top 1 LocaleId FROM @TBL_locale WHERE RowId = @IncrementalId)
			;With Cte_GetCmsContentContainerData AS 
			(
			Select distinct @SetLocaleId AS LocaleId, sv.CMSContainerProfileVariantId,
				aa.[GlobalAttributeGroupId] AS 'GlobalAttributeGroupId' ,
				zgag.GroupCode	AS 'GroupCode'		 ,  
				zgagl.AttributeGroupName  AS 'AttributeGroupName'   ,
				AttributeGroupDisplayOrder 	 , 
				ss.GlobalAttributeId	 AS 'GlobalAttributeId'	 ,
				ss.[AttributeDisplayOrder] AS 'AttributeDisplayOrder'	,
				zga.AttributeCode AS 'AttributeCode'	,			
				zgal.AttributeName AS 'AttributeName'	,
				zga.IsRequired AS 'IsRequired'	,
				zga.AttributeTypeName AS 'AttributeTypeName'      ,
				zga.AttributeTypeId AS 'AttributeTypeId' 		,
				sv.SingleAttributeValue AS 'SingleAttributeValue'	,	
	   
				( Select 
				SelectValuesEntity.DisplayOrder					as DisplayOrder,
				SelectValuesEntity.GlobalAttributeDefaultValueId as GlobalAttributeDefaultValueId,
				SelectValuesEntity.AttributeValue				as [Value]	,
				SelectValuesEntity.AttributeDefaultValueCode		as Code	,
				SelectValuesEntity.SwatchText                    as SwatchText	,
				SelectValuesEntity.MediaPath		         		as [Path]	
				FROM  @EntityAttributeValueList SelectValuesEntity 
				WHERE SelectValuesEntity.WidgetGlobalAttributeValueId = sv.WidgetGlobalAttributeValueId
				and SelectValuesEntity.LocaleId = sv.LocaleId and 
				zga.GroupAttributeType ='Select'
				FOR JSON Auto, INCLUDE_NULL_VALUES    
				)  as 'SelectValues'
			FROM 
				@TBL_GlobalAttributeGrouplist aa				
				INNER JOIN @TBL_GlobalAttributelist ss on  ss.GlobalAttributeGroupId=aa.GlobalAttributeGroupId
				INNER JOIN ZnodeGlobalAttributeGroup zgag on zgag.[GlobalAttributeGroupId]=aa.[GlobalAttributeGroupId]
				INNER JOIN ZnodeGlobalAttributeGroupLocale zgagl on zgagl.GlobalAttributeGroupId=zgag.GlobalAttributeGroupId
				INNER JOIN View_ZnodeGlobalAttribute zga       on zga.[GlobalAttributeId]=ss.[GlobalAttributeId]
				INNER JOIN ZnodeGlobalAttributeLocale zgal on zga.[GlobalAttributeId]=zgal.[GlobalAttributeId]
				INNER JOIN @EntityAttributeValueList sv   on sv.[GlobalAttributeId]=ss.[GlobalAttributeId]
				WHERE zgagl.LocaleId= zgal.LocaleId and 
				(sv.LocaleId = @SetLocaleId)  
			)
	     	, Cte_GetFirstFilterData AS
			(
				SELECT CMSContainerProfileVariantId,LocaleId,GlobalAttributeGroupId,GroupCode,AttributeGroupName,AttributeGroupDisplayOrder,
						GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName,IsRequired,AttributeTypeName,
						AttributeTypeId,SingleAttributeValue,SelectValues
				FROM Cte_GetCmsContentContainerData 
				WHERE LocaleId = @SetLocaleId
			)
			, Cte_GetDefaultFilterData AS
			(
				SELECT CMSContainerProfileVariantId,LocaleId,GlobalAttributeGroupId,GroupCode,AttributeGroupName,AttributeGroupDisplayOrder,
						GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName,IsRequired,AttributeTypeName,
						AttributeTypeId,SingleAttributeValue,SelectValues
				FROM  Cte_GetFirstFilterData 
				UNION ALL 
				SELECT CMSContainerProfileVariantId,LocaleId,GlobalAttributeGroupId,GroupCode,AttributeGroupName,AttributeGroupDisplayOrder,
						GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName,IsRequired,AttributeTypeName,
						AttributeTypeId,SingleAttributeValue,SelectValues
				FROM Cte_GetCmsContentContainerData CTEC 
				WHERE LocaleId = @DefaultLocaleId 
				AND NOT EXISTS (SELECT TOP 1 1 FROM Cte_GetFirstFilterData CTEFD WHERE CTEFD.GlobalAttributeGroupId = CTEC.GlobalAttributeGroupId )
			)
			INSERT INTO #GlobalAttributeGrouplist 
			(
				CMSContainerProfileVariantId,LocaleId,GlobalAttributeGroupId,GroupCode,AttributeGroupName,AttributeGroupDisplayOrder,
				GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName,IsRequired,AttributeTypeName,
				AttributeTypeId,SingleAttributeValue,SelectValues
			)
			SELECT DISTINCT CMSContainerProfileVariantId,@SetLocaleId,GlobalAttributeGroupId,GroupCode,AttributeGroupName,AttributeGroupDisplayOrder,
					GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName,IsRequired,AttributeTypeName,
					AttributeTypeId,SingleAttributeValue,SelectValues
			FROM Cte_GetDefaultFilterData
						
				SET @IncrementalId = @IncrementalId +1 
		End 
		--select * into ##GlobalAttributeGrouplist from #GlobalAttributeGrouplist
	--select distinct CMSContainerProfileVariantId,GlobalAttributeGroupId,GroupCode,AttributeGroupName,AttributeGroupDisplayOrder,LocaleId 
	--into #GroupMaster from #GlobalAttributeGrouplist
	
	--If (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  ) 
	--Begin
	--    --Data inserted into flat table ZnodePublishWidgetSliderBannerEntity (Replica of MongoDB Collection )  

	--	Delete from ZnodePublishContentContainerVariantEntity WHERE  VersionId = @VersionId
	 		 

	--	INSERT INTO ZnodePublishPortalGlobalAttributeEntity
	--	(
	--		VersionId,PublishStartTime,PortalId,PortalName,LocaleId,GlobalAttributeGroups
	--	)
	  	
			--Select Distinct PV.CMSContainerProfileVariantId,PV.LocaleId,  (Select 
			--A.GlobalAttributeGroupId AS 'GlobalAttributeGroupId',
			--A.GroupCode AS 'GroupCode',
			--A.AttributeGroupName AS 'AttributeGroupName',
			--A.AttributeGroupDisplayOrder AS 'AttributeGroupDisplayOrder',
			--A.LocaleId AS 'LocaleId', 
			--(
			--	Select DISTINCT GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName ,IsRequired ,	
			--	AttributeTypeName,AttributeTypeId,SingleAttributeValue,SelectValues 
			--	from #GlobalAttributeGrouplist B WHERE A.GlobalAttributeGroupId = B.GlobalAttributeGroupId 
			--	AND A.LocaleId = B.LocaleId AND A.CMSContainerProfileVariantId = B.CMSContainerProfileVariantId
			--	For JSON Path 
			--) AS 'GlobalAttributes'
			--from #GlobalAttributeGrouplist A WHERE A.CMSContainerProfileVariantId = PV.CMSContainerProfileVariantId AND A.LocaleId = PV.LocaleId For Json Path) GlobalAttributes
			--FROM  #GlobalAttributeGrouplist  PV 

			SELECT DISTINCT A.CMSContainerProfileVariantId,A.LocaleId,  
			REPLACE((
				SELECT DISTINCT GlobalAttributeGroupId, GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName ,IsRequired ,	
				AttributeTypeName,AttributeTypeId,SingleAttributeValue As AttributeValue,SelectValues 
				FROM #GlobalAttributeGrouplist B
				WHERE A.GlobalAttributeGroupId = B.GlobalAttributeGroupId 
				AND A.LocaleId = B.LocaleId AND A.CMSContainerProfileVariantId = B.CMSContainerProfileVariantId
				--AND GlobalAttributeId=32 and A.GlobalAttributeGroupId=23
				For JSON Path 
			),'\','') AS 'GlobalAttributes'
			FROM #GlobalAttributeGrouplist  A
	--End
	---------------------------- End Preview 
	--If (@RevisionState like '%Production%' OR @RevisionState = 'None')
	--Begin
	--	-- Only production version id will process 
	--	Delete from ZnodePublishPortalGlobalAttributeEntity WHERE  VersionId in (Select ProductionVersionId from @Tbl_ProductionVersionId)
	--	AND PortalId = @PortalId
	 		 

	--	INSERT INTO ZnodePublishPortalGlobalAttributeEntity
	--	(
	--		VersionId,PublishStartTime,PortalId,PortalName,LocaleId,GlobalAttributeGroups
	--	)
			  	
	--		Select Distinct PV.ProductionVersionId, Getdate(),  @PortalId,@StoreName, PV.LocaleId, (Select 
	--		A.GlobalAttributeGroupId AS 'GlobalAttributeGroupId',
	--		A.GroupCode AS 'GroupCode',
	--		A.AttributeGroupName AS 'AttributeGroupName',
	--		A.AttributeGroupDisplayOrder AS 'AttributeGroupDisplayOrder',
	--		A.LocaleId AS 'LocaleId', 
	--		(
	--			Select GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName ,IsRequired ,	
	--			AttributeTypeName,AttributeTypeId,SingleAttributeValue,SelectValues 
	--			from #GlobalAttributeGrouplist B WHERE A.GlobalAttributeGroupId = B.GlobalAttributeGroupId 
	--			AND A.LocaleId = B.LocaleId
	--			For JSON Path 
	--		) AS 'GlobalAttributes'
	--		from #GroupMaster A  WHERE A.LocaleId = PV.LocaleId  For Json Path) 
	--		FROM  @Tbl_ProductionVersionId  PV 

	--End

END TRY
BEGIN CATCH
	SELECT ERROR_MESSAGE(), ERROR_PROCEDURE();

END CATCH;
END;


























--58181

GO
Update ZnodeApplicationSetting
set Setting='<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>ERPTaskSchedulerId</name>      <headertext>Checkbox</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>ConnectorTouchPoints</name>      <headertext>Connector Touch Points</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>y</isallowlink>      <islinkactionurl>/TouchPointConfiguration/Create</islinkactionurl>      <islinkparamfield>ConnectorTouchPoints</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>SchedulerName</name>      <headertext>Scheduler Name</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>SchedulerType</name>      <headertext>Scheduler Type</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>Triggers</name>      <headertext>Triggers</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>NextRunTime</name>      <headertext>Next Run Time</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>LastRunResult</name>      <headertext>Last Run Result</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>SchedulerCreatedDate</name>      <headertext>Created Date</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>9</id>      <name>Status</name>      <headertext>Status</headertext>      <width>0</width>      <datatype>Boolean</datatype>      <columntype>Boolean</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>10</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>Trigger|Edit|Disable|History|Delete</format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>ConnectorTouchPoints|ConnectorTouchPoints|ConnectorTouchPoints|ConnectorTouchPoints|ERPTaskSchedulerId</islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Create Scheduler|Edit|Disable|History|Delete</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/TouchPointConfiguration/Trigger|/TouchPointConfiguration/Create|/TouchPointConfiguration/EnableDisableScheduler|/TouchPointConfiguration/SchedulerLogList|/TouchPointConfiguration/Delete</manageactionurl>      <manageparamfield>ConnectorTouchPoints|ConnectorTouchPoints,SchedulerCallFor|ERPTaskSchedulerId,IsEnabled|SchedulerName|ERPTaskSchedulerId</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
Where ItemName='View_ZnodeTouchPointConfiguration'
GO

Update ZnodeSearchProfileAttributeMapping 
set IsFacets = 0 
where SearchProfileId = 1 and IsFacets = 1 and AttributeCode <> 'Brand'
GO



IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishContentContainerAttributeValue')
	DROP PROC Znode_GetPublishContentContainerAttributeValue
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishContentContainerAttributeValue]
(
	@EntityName	NVARCHAR(200) = 0,
	@ContainerKey	NVARCHAR(200),
	@LocalId	INT = 0,
	@PortalId	INT = 0,
	@ProfileId	INT = 0
)
AS
/*
	 Summary :- This procedure is used to get the Content and Container attribute value as per filter pass
	 Unit Testing
	 BEGIN TRAN
	 EXEC [Znode_GetPublishContentContainerAttributeValue] @EntityName='Content Containers',@ContainerKey='',@LocalId=0,@PortalId=0,@ProfileId=0
	 ROLLBACK TRAN
*/
BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
		-- Variable Declaration as per the code requirement
		DECLARE @LocaleCode NVARCHAR(50),
				@LocalIdInput INT,
				@LocaleCodeInput NVARCHAR(50),
				@CMSContainerProfileVariantId INT,
				@GroupCode NVARCHAR(200) = NULL,
				@SelectedValue BIT = 0,
				@FamilyCode VARCHAR(200);

		SET @LocalIdInput = @LocalId

		SELECT @LocaleCode=Code FROM ZnodeLocale WITH (NOLOCK) WHERE LocaleId=@LocalId;
		SET @LocaleCodeInput = @LocaleCode

		--1. Specific Store, Specific User Profile, Selected Locale
		-- Based on input if count will 1 then this will take CMSContainerProfileVariantId from 1st loop else this will go for next loop.
		IF (SELECT COUNT(1) FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK) WHERE ISNULL(WPV.ProfileId,0)=@ProfileId  AND WPV.LocaleId=@LocalId)=1
		BEGIN
			SELECT @CMSContainerProfileVariantId=WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE ISNULL(WPV.ProfileId,0)=@ProfileId AND WPV.ContainerKey=@ContainerKey
			AND WPV.LocaleId=@LocalId
		END
		ELSE
		BEGIN
			SELECT @CMSContainerProfileVariantId=WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = @ProfileId ) AND (ISNULL(WPV.PortalId,0) = @PortalId )
			AND WPV.ContainerKey=@ContainerKey AND WPV.LocaleId=@LocalId
		END

		--2. Specific Store, Specific User Profile, Default Locale
		IF ISNULL(@CMSContainerProfileVariantId,0) = 0
		BEGIN
			SELECT @LocalId = LocaleId FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;
			SELECT @LocaleCode = Code FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;

			SELECT @CMSContainerProfileVariantId= WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = @ProfileId ) AND (ISNULL(WPV.PortalId,0) = @PortalId )
			AND WPV.ContainerKey=@ContainerKey AND WPV.LocaleId=@LocalId 

			IF ISNULL(@CMSContainerProfileVariantId,0) = 0
			BEGIN
				SET @LocalId = @LocalIdInput
				SET @LocaleCode = @LocaleCodeInput
			END
		
		END

		--3. Specific Store, Any User Profile, Selected Locale
		IF ISNULL(@CMSContainerProfileVariantId,0) = 0
		BEGIN
			SELECT @CMSContainerProfileVariantId= WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = 0 ) AND (ISNULL(WPV.PortalId,0) = @PortalId )
			AND WPV.ContainerKey=@ContainerKey AND WPV.LocaleId=@LocalId 
		END

		--4. Specific Store, Any User Profile, Default Locale
		IF ISNULL(@CMSContainerProfileVariantId,0) = 0
		BEGIN
			SELECT @LocalId = LocaleId FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;
			SELECT @LocaleCode = Code FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;

			SELECT @CMSContainerProfileVariantId= WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = 0 ) AND (ISNULL(WPV.PortalId,0) = @PortalId )
			AND WPV.ContainerKey=@ContainerKey AND WPV.LocaleId=@LocalId

			IF ISNULL(@CMSContainerProfileVariantId,0) = 0
			BEGIN
				SET @LocalId = @LocalIdInput
				SET @LocaleCode = @LocaleCodeInput
			END
		END
		
		--5. Any Store, Any User Profile, Selected Locale
		IF ISNULL(@CMSContainerProfileVariantId,0) = 0
		BEGIN
			SELECT @CMSContainerProfileVariantId= WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = 0 ) AND (ISNULL(WPV.PortalId,0) = 0 )
			AND WPV.ContainerKey=@ContainerKey AND WPV.LocaleId=@LocalId
		END

		--6. Any Store, Any User Profile, Default Locale
		IF ISNULL(@CMSContainerProfileVariantId,0) = 0
		BEGIN
			SELECT @LocalId = LocaleId FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;
			SELECT @LocaleCode = Code FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;

			SELECT @CMSContainerProfileVariantId= WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = 0 ) AND (ISNULL(WPV.PortalId,0) = 0 )
			AND WPV.ContainerKey=@ContainerKey AND WPV.LocaleId=@LocalId 

			IF ISNULL(@CMSContainerProfileVariantId,0) = 0
			BEGIN
				SET @LocalId = @LocalIdInput
				SET @LocaleCode = @LocaleCodeInput
			END
		END
		
		-- This will take FamilyCode based on the inputs.
		SELECT @FamilyCode=GAF.FamilyCode
		FROM ZnodeCMSContentContainer CCW WITH (NOLOCK)
		INNER JOIN ZnodeGlobalAttributeFamily GAF WITH (NOLOCK) ON CCW.FamilyId=GAF.GlobalAttributeFamilyId
		WHERE CCW.ContainerKey=@ContainerKey 
		AND EXISTS(SELECT * FROM ZnodePublishContentContainerVariantEntity CWPV WITH (NOLOCK) WHERE CCW.CMSContentContainerId = CWPV.CMSContentContainerId AND (ISNULL(CWPV.PortalId,0)=@PortalId));

		-- Based on input @EntityName='Content Containers' as fixed value this will execute nested SP.
		-- Nested SP will give 2 Output (1 Result set & 1 Msg.

		-- Declared table variable to combined nested sp data with the output of this sp.
		DECLARE	@PublishContainerGlobalAttributeValue As TABLE
		(ContentContainerName NVARCHAR(100), ContainerKey NVARCHAR(50), GlobalAttributes NVARCHAR(MAX), ContainerTemplateName NVARCHAR(100))

		IF @EntityName='Content Containers'
		begin
			INSERT INTO @PublishContainerGlobalAttributeValue
				(ContentContainerName, ContainerKey, GlobalAttributes, ContainerTemplateName)
			EXEC [dbo].[Znode_GetPublishContainerGlobalAttributeValue]
				@CMSContainerProfileVariantId=@CMSContainerProfileVariantId, @LocaleCode= @LocaleCode
		end
		
		-- This will take FamilyCode based on the inputs.
		SELECT @FamilyCode=GAF.FamilyCode
		FROM ZnodeCMSContentContainer CCW WITH (NOLOCK)
		INNER JOIN ZnodeGlobalAttributeFamily GAF WITH (NOLOCK) ON CCW.FamilyId=GAF.GlobalAttributeFamilyId
		WHERE CCW.ContainerKey=@ContainerKey 
		AND EXISTS(SELECT * FROM ZnodeCMSContainerProfileVariant CWPV WHERE CCW.CMSContentContainerId = CWPV.CMSContentContainerId AND (ISNULL(CWPV.PortalId,0)=@PortalId));

		IF ISNULL(@FamilyCode,'') = ''
		BEGIN
			-- This will take FamilyCode based on the inputs.
			SELECT @FamilyCode=GAF.FamilyCode
			FROM ZnodeCMSContentContainer CCW WITH (NOLOCK)
			INNER JOIN ZnodeGlobalAttributeFamily GAF WITH (NOLOCK) ON CCW.FamilyId=GAF.GlobalAttributeFamilyId
			WHERE CCW.ContainerKey=@ContainerKey 
			AND EXISTS(SELECT * FROM ZnodeCMSContainerProfileVariant CWPV WHERE CCW.CMSContentContainerId = CWPV.CMSContentContainerId AND (ISNULL(CWPV.PortalId,0)=0));
		END

		-- This will give 3rd result set of Attribute Groups Data.
		--SELECT GE.GlobalEntityId, GE.EntityName, GE.IsActive, GE.TableName, GE.IsFamilyUnique
		--	, GAF.GlobalAttributeFamilyId, GAF.FamilyCode, GAF.IsSystemDefined, GAF.GlobalEntityId
		--	, GFGM.GlobalFamilyGroupMapperId, GFGM.GlobalAttributeFamilyId, GFGM.GlobalAttributeGroupId
		--	, GFGM.AttributeGroupDisplayOrder
		--	, GAG.GlobalAttributeGroupId, GAG.GroupCode, GAG.DisplayOrder, GAG.IsSystemDefined, GAG.GlobalEntityId
		--	, GAGL.GlobalAttributeGroupLocaleId, GAGL.LocaleId, GAGL.GlobalAttributeGroupId, GAGL.AttributeGroupName
		--	, GAGL.[Description]
		--FROM ZnodeGlobalEntity GE WITH (NOLOCK)
		--INNER JOIN ZnodeGlobalAttributeFamily GAF WITH (NOLOCK) ON GE.GlobalEntityId=GAF.GlobalEntityId
		--INNER JOIN ZnodeGlobalFamilyGroupMapper GFGM WITH (NOLOCK) ON GAF.GlobalAttributeFamilyId=GFGM.GlobalAttributeFamilyId
		--INNER JOIN ZnodeGlobalAttributeGroup GAG WITH (NOLOCK) ON GFGM.GlobalAttributeGroupId=GAG.GlobalAttributeGroupId
		--INNER JOIN ZnodeGlobalAttributeGroupLocale GAGL WITH (NOLOCK) ON GAG.GlobalAttributeGroupId=GAGL.GlobalAttributeGroupId
		--WHERE GE.EntityName=@EntityName AND GAGL.LocaleId=@LocalId AND GAF.FamilyCode=@FamilyCode
		--ORDER BY GFGM.AttributeGroupDisplayOrder;

		-- This will give 4th result set of ContainerProfile & ContentContainer Data.

		SELECT DISTINCT CWPV.CMSContainerProfileVariantId, CWPV.CMSContentContainerId, CGAV.ContentContainerName, CWPV.ProfileId
			, CWPV.LocaleId, CWPV.CMSContainerTemplateId, CGAV.ContainerTemplateName
			, CCW.[Name], CCW.ContainerKey, CWPV.PortalId, CCW.FamilyId, CCW.Tags
			, CGAV.GlobalAttributes
		FROM ZnodePublishContentContainerVariantEntity CWPV WITH (NOLOCK)
		--INNER JOIN ZnodeCMSContainerProfileVariantLocale CWPVL WITH (NOLOCK) ON CWPV.CMSContainerProfileVariantId = CWPVL.CMSContainerProfileVariantId
		INNER JOIN ZnodeCMSContentContainer CCW WITH (NOLOCK) ON CWPV.CMSContentContainerId=CCW.CMSContentContainerId
		INNER JOIN @PublishContainerGlobalAttributeValue CGAV ON CCW.ContainerKey=CGAV.ContainerKey
			AND CWPV.CMSContainerProfileVariantId=@CMSContainerProfileVariantId
		WHERE (ISNULL(CWPV.ProfileId,0) = @ProfileId OR ISNULL(CWPV.ProfileId,0) = 0) AND CWPV.LocaleId=@LocalId AND CCW.ContainerKey=@ContainerKey AND ((ISNULL(CWPV.PortalId,0)=@PortalId OR ISNULL(CWPV.PortalId,0) = 0));

		-- This will give 5th result set of ContainerTemplate & ContentContainer Data.
		--SELECT CWT.CMSContainerTemplateId, CWT.[FileName], CWT.MediaId, CCW.[Name], CCW.FamilyId, CCW.Tags
		--FROM ZnodeCMSContentContainer CCW WITH (NOLOCK) 
		--INNER JOIN ZnodeCMSContainerProfileVariant CWPV ON CCW.CMSContentContainerId = CWPV.CMSContentContainerId AND (ISNULL(CWPV.PortalId,0)=@PortalId OR ISNULL(CWPV.PortalId,0) = 0)
		--INNER JOIN ZnodeCMSContainerProfileVariantLocale CWPVL ON CWPV.CMSContainerProfileVariantId = CWPVL.CMSContainerProfileVariantId
		--INNER JOIN  ZnodeCMSContainerTemplate CWT WITH (NOLOCK) ON (CWPVL.CMSContainerTemplateId = CWT.CMSContainerTemplateId OR ISNULL(CWPVL.CMSContainerTemplateId,0) = 0)
		--WHERE CCW.ContainerKey=@ContainerKey
	END TRY
	BEGIN CATCH
		SELECT ERROR_MESSAGE()
		DECLARE @Status BIT;
		SET @Status = 0;

		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(),
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetContentContainerAttributeValue
					@EntityName = '''+ISNULL(@EntityName,'''''')+
					''',@ContainerKey='+ISNULL(@ContainerKey,'''')+
					''',@LocalId='+ISNULL(CAST(@LocalId AS VARCHAR(20)),'''')+
					''',@PortalId='+ISNULL(CAST(@PortalId AS VARCHAR(20)),'''')+
					''',@ProfileId='+ISNULL(CAST(@ProfileId AS VARCHAR(20)),'''')
					
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_GetContentContainerAttributeValue',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetCatalogCategorySEODetail')
	DROP PROC Znode_GetCatalogCategorySEODetail
GO

CREATE PROCEDURE [dbo].[Znode_GetCatalogCategorySEODetail]
  (
	  @WhereClause      VARCHAR(MAX),
	  @Rows             INT           = 100,
	  @PageNo           INT           = 1,
	  @Order_BY         VARCHAR(1000) = '',
	  @RowsCount        INT OUT,
	  @LocaleId         INT           = 1,
	  @PortalId         INT
)
AS
BEGIN
	SET NOCOUNT ON;

	Declare @PimCatalogId INT, @SQL VARCHAR(MAX), @DefaultLocaleId VARCHAR(20)= dbo.Fn_GetDefaultLocaleId()

	SELECT @PimCatalogId = PimCatalogId 
	FROM ZnodePortalCatalog ZPC
	INNER JOIN ZnodePublishCatalog PC ON ZPC.PublishCatalogId = pc.PublishCatalogId WHERE PortalId = @PortalId


	IF OBJECT_ID('TEMPDB..#CategoryDetail') IS NOT NULL
		DROP TABLE #CategoryDetail

	IF OBJECT_ID('TEMPDB..##TempCategoryDetail') IS NOT NULL
		DROP TABLE ##TempCategoryDetail

		IF OBJECT_ID('TEMPDB..#znodeCatalogCategory') IS NOT NULL
		DROP TABLE #znodeCatalogCategory

	SELECT PimCategoryId, CategoryName, CategoryCode, LocaleId
	INTO #CategoryDetail
	FROM
	(
		SELECT ZPCAV.PimCategoryId,ZPA.AttributeCode,ZPCAVL.CategoryValue, ZPCAVL.LocaleId 
		FROM ZnodePimCategoryAttributeValue ZPCAV
		INNER JOIN ZnodePimCategoryAttributeValueLocale ZPCAVL on ZPCAV.PimCategoryAttributeValueId = ZPCAVL.PimCategoryAttributeValueId
		INNER JOIN ZnodePimAttribute ZPA on ZPCAV.PimAttributeId = ZPA.PimAttributeId
		where ZPA.AttributeCode in ( 'CategoryName', 'CategoryCode')
	)TB PIVOT(MAX(CategoryValue) FOR AttributeCode in ( CategoryName, CategoryCode))AS PVT
	
	

	SET @SQL = '

	select distinct ZPCH.PimCatalogId,ZPCP.PimCategoryId into #znodeCatalogCategory
	FROm ZnodePimCategoryProduct ZPCP
	Inner Join ZnodePimCategoryHierarchy ZPCH ON ZPCP.PimCategoryId = ZPCH.PimCategoryId

	;With CTE_CategoryDetail AS
	(
		SELECT DISTINCT PC.PimCatalogId, PC.CatalogName, CD.PimCategoryId, CD.CategoryCode, CD.CategoryName , ISNULL(CSD.SEOCode,CD.CategoryCode) as SEOCode , CSD.SEOUrl, CSDL.SEOTitle, CSDL.SEODescription, CSDL.SEOKeywords,
		case when  ZPPO.DisplayName IS NULL THEN '''' ELSE ZPPO.DisplayName END IsPublish , ActivationDate , ExpirationDate, 
		CH.IsActive, CD.LocaleId, CSDL.CanonicalURL, CSDL.RobotTag
		FROM #CategoryDetail CD
		INNER JOIN ZnodePimCategory ZPC ON (ZPC.PimCategoryId = CD.PimCategoryId)
		INNER JOIN  #znodeCatalogCategory PCC on CD.PimCategoryId = PCC.PimCategoryId
		INNER JOIN ZnodePimCatalog PC on PCC.PimCatalogId = PC.PimCatalogId
		LEFT JOIN ZnodePimCategoryHierarchy CH ON (CH.PimCategoryId = CD.PimCategoryId)
		LEFT JOIN ZnodeCMSSEOType CST ON CST.Name = ''Category''
		LEFT JOIN ZnodeCMSSEODetail CSD on CD.CategoryCode = CSD.SEOCode and CSD.CMSSEOTypeId = CST.CMSSEOTypeId AND CSD.PortalId = '+CAST(@PortalId AS VARCHAR(10))+'
		LEFT JOIN ZnodeCMSSEODetailLocale CSDL ON  CSD.CMSSEODetailId = CSDL.CMSSEODetailId AND CSDL.LocaleId =  '+CAST(@LocaleId AS VARCHAR(10))+'
		LEFT JOIN ZnodePublishState ZPPO ON (ZPPO.PublishStateId = CSD.PublishStateId)
		WHERE PCC.PimCatalogId = '+CAST(@PimCatalogId AS VARCHAR(10))+' AND CD.LocaleId IN ('+CAST(@LocaleId AS VARCHAR(50))+', '+CAST(@DefaultLocaleId AS VARCHAR(50))+') 
	)
	,CTE_CategoryDetail_SEO AS
	(
		SELECT DISTINCT null as PimCatalogId, '''' CatalogName, CD.PimCategoryId, CD.CategoryCode, CD.CategoryName , ISNULL(CSD.SEOCode,CD.CategoryCode) as SEOCode , CSD.SEOUrl, CSDL.SEOTitle, CSDL.SEODescription, CSDL.SEOKeywords,
		case when  ZPPO.DisplayName IS NULL THEN '''' ELSE ZPPO.DisplayName END IsPublish , ActivationDate , ExpirationDate, 
		CH.IsActive, CD.LocaleId, CSDL.CanonicalURL, CSDL.RobotTag
		FROM #CategoryDetail CD
		INNER JOIN ZnodePimCategory ZPC ON (ZPC.PimCategoryId = CD.PimCategoryId)
		LEFT JOIN ZnodePimCategoryHierarchy CH ON (CH.PimCategoryId = CD.PimCategoryId)
		LEFT JOIN ZnodeCMSSEOType CST ON CST.Name = ''Category''
		LEFT JOIN ZnodeCMSSEODetail CSD on CD.CategoryCode = CSD.SEOCode and CSD.CMSSEOTypeId = CST.CMSSEOTypeId AND CSD.PortalId = '+CAST(@PortalId AS VARCHAR(10))+'
		LEFT JOIN ZnodeCMSSEODetailLocale CSDL ON  CSD.CMSSEODetailId = CSDL.CMSSEODetailId AND CSDL.LocaleId =  '+CAST(@LocaleId AS VARCHAR(10))+'
		LEFT JOIN ZnodePublishState ZPPO ON (ZPPO.PublishStateId = CSD.PublishStateId)
		WHERE CD.LocaleId IN ('+CAST(@LocaleId AS VARCHAR(50))+', '+CAST(@DefaultLocaleId AS VARCHAR(50))+') 
		AND NOT EXISTS(select * from CTE_CategoryDetail CDC where CD.PimCategoryId = CDC.PimCategoryId )
	)
	,CTE_CategoryDetail_Locale as
	(
		SELECT PimCatalogId, CatalogName, PimCategoryId, CategoryCode,CategoryName, SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords,IsPublish,ActivationDate,ExpirationDate,IsActive, LocaleId, CanonicalURL, RobotTag
		FROM CTE_CategoryDetail CD
		WHERE CD.LocaleId ='+CAST(@LocaleId AS VARCHAR(50))+'
		union ALL
		SELECT PimCatalogId, CatalogName, PimCategoryId, CategoryCode,CategoryName, SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords,IsPublish,ActivationDate,ExpirationDate,IsActive, LocaleId, CanonicalURL, RobotTag
		FROM CTE_CategoryDetail_SEO CD
		WHERE CD.LocaleId ='+CAST(@LocaleId AS VARCHAR(50))+'
	)
	,CTE_CategoryDetail_BothLocale as
	(
		SELECT PimCatalogId, CatalogName, PimCategoryId, CategoryCode,CategoryName, SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords,IsPublish,ActivationDate,ExpirationDate,IsActive, CanonicalURL, RobotTag
		FROM CTE_CategoryDetail_Locale
		Union All
		SELECT PimCatalogId, CatalogName, PimCategoryId, CategoryCode,CategoryName, SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords,IsPublish,ActivationDate,ExpirationDate,IsActive, CanonicalURL, RobotTag
		FROM CTE_CategoryDetail CDS
		WHERE LocaleId ='+CAST(@DefaultLocaleId AS VARCHAR(50))+' AND
			NOT EXISTS( SELECT TOP 1 1 FROM CTE_CategoryDetail_Locale CSD1
						WHERE CDS.PimCategoryId = CSD1.PimCategoryId AND CDS.CatalogName = CSD1.CatalogName )
		Union All
		SELECT PimCatalogId, CatalogName, PimCategoryId, CategoryCode,CategoryName, SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords,IsPublish,ActivationDate,ExpirationDate,IsActive, CanonicalURL, RobotTag
		FROM CTE_CategoryDetail_SEO CDS2
		WHERE LocaleId ='+CAST(@DefaultLocaleId AS VARCHAR(50))+' AND
			NOT EXISTS( SELECT TOP 1 1 FROM CTE_CategoryDetail_Locale CSD1
						WHERE CDS2.PimCategoryId = CSD1.PimCategoryId AND CDS2.CatalogName = CSD1.CatalogName )
	)
	,CTE_CategoryDetail_WhereClause AS
	(
		SELECT PimCatalogId, CatalogName, PimCategoryId, CategoryCode,CategoryName, SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords,IsPublish,ActivationDate,ExpirationDate,IsActive, CanonicalURL, RobotTag, '+[dbo].[Fn_GetPagingRowId](@Order_BY, 'PimCategoryId')+',Count(*)Over() CountId
		FROM CTE_CategoryDetail_BothLocale CD
		WHERE 1 = 1 '+CASE WHEN @WhereClause = '' THEN '' ELSE ' AND '+@WhereClause END +'
	)
	SELECT PimCatalogId, CatalogName, PimCategoryId, CategoryCode,CategoryName, SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords,IsPublish,ActivationDate,ExpirationDate,IsActive, CanonicalURL, RobotTag, CountId
	INTO ##TempCategoryDetail
	FROM CTE_CategoryDetail_WhereClause
	'+[dbo].[Fn_GetPaginationWhereClause](@PageNo, @Rows);
	print @SQL
	EXEC (@SQL)

	SET @RowsCount = ISNULL((SELECT TOP 1 CountId FROM ##TempCategoryDetail ),0)

	SELECT  PimCategoryId, CategoryName, SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords,IsPublish, ActivationDate,ExpirationDate,IsActive, CanonicalURL, RobotTag 
	FROM ##TempCategoryDetail

	IF OBJECT_ID('TEMPDB..#CategoryDetail') IS NOT NULL
		DROP TABLE #CategoryDetail

	IF OBJECT_ID('TEMPDB..##TempCategoryDetail') IS NOT NULL
		DROP TABLE ##TempCategoryDetail

	IF OBJECT_ID('TEMPDB..#znodeCatalogCategory') IS NOT NULL
	DROP TABLE #znodeCatalogCategory

END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetERPTaskSchedulerDetail')
	DROP PROC Znode_GetERPTaskSchedulerDetail
GO

CREATE PROCEDURE [dbo].[Znode_GetERPTaskSchedulerDetail]
( @ERPTaskSchedulerId INT)
AS
  /*
    
    Summary:  List of erp task scheduler details by ERPTaskSchedulerId    		              
    Unit Testing         	
       EXEC Znode_GetERPTaskSchedulerDetail 1   
   */ 
	 BEGIN
         BEGIN TRY
             SET NOCOUNT ON;
             SELECT ERPTaskSchedulerId, 
					ISNULL(ERPConfiguratorId, 0) ERPConfiguratorId,
					SchedulerName, 
					SchedulerType,
					TouchPointName,
					SchedulerFrequency,
					StartDate,
					ZETS.CreatedBy,
					ZETS.CreatedDate,
					ZETS.ModifiedBy,
					ZETS.ModifiedDate,
					ZETS.IsEnabled,
					SchedulerCallFor,
					CronExpression,
					HangfireJobId
             FROM ZnodeERPTaskScheduler AS ZETS
             WHERE ZETS.ERPTaskSchedulerId = @ERPTaskSchedulerId;
         END TRY
         BEGIN CATCH
               DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetERPTaskSchedulerDetail @ERPTaskSchedulerId = '+CAST(@ERPTaskSchedulerId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		    
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetERPTaskSchedulerDetail',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO


IF NOT EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME = 'GroupIdentifier' AND TABLE_NAME = 'ZnodeOmsOrderLineItems')
BEGIN
	ALTER TABLE ZnodeOmsOrderLineItems ADD GroupIdentifier INT NULL
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.types WHERE is_table_type = 1 AND name = 'PromotionCoupons')
BEGIN
	CREATE TYPE [dbo].[PromotionCoupons] AS TABLE(
	[Code] [varchar](50) NULL,
	[IsExistInOrder] [bit] NULL,
	[OmsOrderId] [int] NULL
	)
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateOmsOrder')
	DROP PROC Znode_InsertUpdateOmsOrder
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateOmsOrder]
(
	@OrderXML XML,
	@UserId INT
)
AS
BEGIN
SET NOCOUNT ON;
BEGIN TRY
BEGIN TRAN OrderInsert
	DECLARE @GetDate DATETIME = GETDATE()
	DECLARE @OMSOrder TABLE(OmsOrderId INT,OrderNumber VARCHAR(200))
	DECLARE @OMSOrderDetail TABLE(OmsOrderId INT,OmsOrderDetailsId INT)
	DECLARE @OmsOrderLineItems TABLE(RowId INT IDENTITY(1,1),OmsOrderDetailsId INT,OmsOrderLineItemsId INT, Sku VARCHAR(600), ParentOmsOrderLineItemsId INT, GroupId NVARCHAR(MAX),OrderLineItemRelationshipTypeId INT,ParentSku VARCHAR(600), GroupIdentifier INT)
	DECLARE @OmsParentOrderLineItems TABLE(RowId INT IDENTITY(1,1),OmsOrderDetailsId INT,OmsOrderLineItemsId INT, Sku VARCHAR(600), ParentOmsOrderLineItemsId INT, GroupId NVARCHAR(MAX), OrderLineItemRelationshipTypeId INT, GroupIdentifier INT)

	DECLARE @OrderLineItemRelationshipTypeIdAddon int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'AddOns'
	);

	DECLARE @OrderLineItemRelationshipTypeIdSimple int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Simple'
	);

	DECLARE @OrderLineItemRelationshipTypeIdBundles int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Bundles'
	);

	DECLARE @OrderLineItemRelationshipTypeIdGroup int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Group'
	);

	DECLARE @OrderLineItemRelationshipTypeIdConfig int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Configurable'
	);


	CREATE TABLE #TempOrderData
	(
		RowId INT IDENTITY(1,1),OrderNumber VARCHAR(200), PublishStateId INT,OmsOrderId INT,OmsOrderStateId INT,
		DiscountAmount NUMERIC(28,6),SalesTax NUMERIC(28,6),TaxRate NUMERIC(28,6),IsOldOrder BIT,VAT NUMERIC(28,6),GST NUMERIC(28,6),
		PST NUMERIC(28,6),HST NUMERIC(28,6),Total NUMERIC(28,6),BillingAddressId INT,ShippingAddressId INT,ShippingId INT,
		PortalId INT,ShippingNumber NVARCHAR(max),TrackingNumber NVARCHAR(1000),CouponCode NVARCHAR(1000),
		PromoDescription NVARCHAR(max),ReferralUserId int,PurchaseOrderNumber NVARCHAR(1000),OmsPaymentStateId int,
		WebServiceDownloadDate datetime,PaymentSettingId int,PaymentTransactionToken NVARCHAR(600),ShipDate datetime,ReturnDate datetime,
		AddressId int,PoDocument NVARCHAR(600),IsActive bit,ExternalId NVARCHAR(1000),PaymentTypeId INT,CreatedBy INT,CreatedDate datetime,ModifiedBy INT,
		ModifiedDate datetime,CreditCardNumber VARCHAR(4),IsShippingCostEdited bit,IsTaxCostEdited bit,ShippingDifference NUMERIC(28,6),
		EstimateShippingCost NUMERIC(28,6),TransactionId NVARCHAR(800),Custom1 NVARCHAR(MAX),Custom2 NVARCHAR(MAX),Custom3 NVARCHAR(MAX),
		Custom4 NVARCHAR(MAX),Custom5 NVARCHAR(MAX),FirstName NVARCHAR(200),LastName NVARCHAR(200),CardType VARCHAR(50),CreditCardExpMonth INT,
		CreditCardExpYear INT,TotalAdditionalCost NUMERIC(28,6),PaymentDisplayName NVARCHAR(2000),PaymentExternalId NVARCHAR(2000),
		CultureCode VARCHAR(200),DisplayName NVARCHAR(2000),InHandDate datetime,IpAddress VARCHAR(100),JobName NVARCHAR(200),
		ShippingConstraintCode NVARCHAR(100),ShippingDiscount NUMERIC(28,6),ShippingHandlingCharges NUMERIC(28,6),ReturnCharges NUMERIC(28,6),
		IsCalculateTaxAfterDiscount bit,Email VARCHAR(50),PhoneNumber VARCHAR(50),OrderTotalWithoutVoucher NUMERIC(28,6),ImportDuty NUMERIC(28,6),
		TaxCost NUMERIC(28,6),ShippingCost NUMERIC(28,6), SubTotal NUMERIC(28,6),CurrencyCode VARCHAR(100),OverDueAmount NUMERIC(28,6), ShippingTypeId INT,
		AccountNumber NVARCHAR(4000),ShippingMethod NVARCHAR(4000),PaymentCode NVARCHAR(400) ,PaymentStatusId Int
	)

	CREATE TABLE #TempOrderBillingAddress
	(
		AddressId INT,BillingFirstName VARCHAR(300),BillingLastName VARCHAR(300),BillingCountry VARCHAR(3000),BillingStateCode VARCHAR(300),
		BillingPostalCode VARCHAR(50),BillingPhoneNumber VARCHAR(50),BillingEmailId VARCHAR(50),BillingStreet1 VARCHAR(300),BillingStreet2 VARCHAR(300),
		BillingCity VARCHAR(3000),BillingCompanyName NVARCHAR(1200)
	)
	
	CREATE TABLE #TempParentLineItemDetails
	(
		RowId INT IDENTITY(1,1),OrderLineItemRelationshipTypeId INT,OmsOrderDetailsId INT,OmsOrderShipmentId INT,RmaReasonForReturnId INT,Sku NVARCHAR(600),ProductName NVARCHAR(1000),
		Description NVARCHAR(max),Quantity NUMERIC(28,6),Price NUMERIC(28,6),Weight NUMERIC(28,6),DownloadLink NVARCHAR(max),DiscountAmount NUMERIC(28,6),
		ShipSeparately bit,ShipDate datetime,ReturnDate datetime,ShippingCost NUMERIC(28,6),PromoDescription NVARCHAR(max),TransactionNumber NVARCHAR(max),
		PaymentStatusId int,TrackingNumber NVARCHAR(max),IsAutoGeneratedTracking bit,OrderLineItemStateId int,IsRecurringBilling bit,RecurringBillingPeriod NVARCHAR(100),
		RecurringBillingCycles int,RecurringBillingFrequency NVARCHAR(100),RecurringBillingAmount NUMERIC(28,6),AppliedPromo NVARCHAR(max),CouponsApplied NVARCHAR(100),
		ExternalId NVARCHAR(1000),IsActive bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,AutoAddonSKU NVARCHAR(max),IsShippingReturn bit,
		PartialRefundAmount NUMERIC(28,6),Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),Custom4 NVARCHAR(max),Custom5 NVARCHAR(max),
		GroupId NVARCHAR(max),BundleQuantity int, TaxRuleId INT,TaxTransactionNumber NVARCHAR(1200),Comments NVARCHAR(MAX),SalesTax NUMERIC(28,6),VAT NUMERIC(28,6),
		GST NUMERIC(28,6),PST NUMERIC(28,6),HST NUMERIC(28,6),ImportDuty NUMERIC(28,6), GroupIdentifier INT
	)

	CREATE TABLE #TempChildLineItemDetails
	(
		RowId INT IDENTITY(1,1),OrderLineItemRelationshipTypeId INT,OmsOrderDetailsId INT,OmsOrderShipmentId INT,RmaReasonForReturnId INT,Sku NVARCHAR(600),ProductName NVARCHAR(1000),
		Description NVARCHAR(max),Quantity NUMERIC(28,6),Price NUMERIC(28,6),Weight NUMERIC(28,6),DownloadLink NVARCHAR(max),DiscountAmount NUMERIC(28,6),
		ShipSeparately bit,ShipDate datetime,ReturnDate datetime,ShippingCost NUMERIC(28,6),PromoDescription NVARCHAR(max),TransactionNumber NVARCHAR(max),
		PaymentStatusId int,TrackingNumber NVARCHAR(max),IsAutoGeneratedTracking bit,OrderLineItemStateId int,IsRecurringBilling bit,RecurringBillingPeriod NVARCHAR(100),
		RecurringBillingCycles int,RecurringBillingFrequency NVARCHAR(100),RecurringBillingAmount NUMERIC(28,6),AppliedPromo NVARCHAR(max),CouponsApplied NVARCHAR(100),
		ExternalId NVARCHAR(1000),IsActive bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,AutoAddonSKU NVARCHAR(max),IsShippingReturn bit,
		PartialRefundAmount NUMERIC(28,6),Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),Custom4 NVARCHAR(max),Custom5 NVARCHAR(max),
		GroupId NVARCHAR(max),BundleQuantity int, TaxRuleId INT,TaxTransactionNumber NVARCHAR(1200),Comments NVARCHAR(MAX),SalesTax NUMERIC(28,6),VAT NUMERIC(28,6),
		GST NUMERIC(28,6),PST NUMERIC(28,6),HST NUMERIC(28,6),ImportDuty NUMERIC(28,6), ParentSku NVARCHAR(600), GroupIdentifier INT
	)

	CREATE TABLE #TempOrderAttribute
	(
		AttributeCode NVARCHAR(1000),AttributeValue NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,
		ModifiedDate DATETIME,AttributeValueCode NVARCHAR(1000), Sku VARCHAR(600), GroupId NVARCHAR(max), GroupIdentifier INT
	)

	CREATE TABLE #OmsPersonalizeItem
	(
		PersonalizeCode NVARCHAR(400),PersonalizeValue NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,
		ModifiedDate DATETIME,DesignId NVARCHAR(4000),ThumbnailURL NVARCHAR(MAX), Sku VARCHAR(600), GroupId NVARCHAR(max),
		GroupIdentifier INT
	)

	CREATE TABLE #OmsOrderDiscount
	(
		OmsDiscountTypeId INT,DiscountCode VARCHAR(300),DiscountAmount NUMERIC(28,6),Description NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,
		ModifiedBy INT,ModifiedDate DATETIME,PerQuantityDiscount NUMERIC(28,6),DiscountMultiplier NUMERIC(28,6),ParentOmsOrderLineItemsId INT,
		DiscountLevelTypeId INT,PromotionName NVARCHAR(1200),PromotionTypeId INT,DiscountAppliedSequence INT,PromotionMessage NVARCHAR(MAX),Sku VARCHAR(600),
		GroupId NVARCHAR(max)
	)

	--------Getting Order details
	INSERT INTO #TempOrderData
	(
		OrderNumber, PublishStateId ,OmsOrderId ,OmsOrderStateId ,DiscountAmount ,SalesTax ,TaxRate ,IsOldOrder ,
		VAT ,GST ,PST ,HST ,Total ,BillingAddressId ,ShippingAddressId ,ShippingId ,PortalId,
		ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
		,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive
		,ExternalId,PaymentTypeId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
		,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName
		,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
		,DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
		,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty,TaxCost,ShippingCost, SubTotal,
		CurrencyCode,OverDueAmount, ShippingTypeId, AccountNumber, ShippingMethod, PaymentCode, PaymentStatusId
	)
	SELECT
		CASE WHEN Tbl.Col.value( 'OrderNumber[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderNumber[1]', 'NVARCHAR(Max)' ) END  AS OrderNumber,
		CASE WHEN Tbl.Col.value( 'PublishStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PublishStateId[1]', 'NVARCHAR(Max)' ) END AS PublishStateId,
		CASE WHEN Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderId,
		CASE WHEN Tbl.Col.value( 'OmsOrderStateId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderStateId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderStateId,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE  Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
		CASE WHEN Tbl.Col.value( 'TaxRate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TaxRate[1]', 'NVARCHAR(Max)' ) END AS TaxRate,
		CASE WHEN Tbl.Col.value('IsOldOrder[1]', 'NVARCHAR(2000)') = '' THEN NULL ELSE Tbl.Col.value('IsOldOrder[1]', 'NVARCHAR(2000)') END AS IsOldOrder,
		CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE  Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
		CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
		CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END  AS PST,
		CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END AS HST,
		CASE WHEN Tbl.Col.value( 'Total[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Total[1]', 'NVARCHAR(Max)' ) END AS Total,
		CASE WHEN Tbl.Col.value( 'BillingAddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'BillingAddressId[1]', 'NVARCHAR(Max)' ) END AS BillingAddressId,
		CASE WHEN Tbl.Col.value( 'ShippingAddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingAddressId[1]', 'NVARCHAR(Max)' ) END AS ShippingAddressId,
		CASE WHEN (Tbl.Col.value( 'ShippingId[1]', 'NVARCHAR(Max)' )) = '' THEN NULL ELSE (Tbl.Col.value( 'ShippingId[1]', 'NVARCHAR(Max)' )) END  AS ShippingId,
		CASE WHEN Tbl.Col.value( 'PortalId[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'PortalId[1]', 'NVARCHAR(Max)' ) END AS PortalId,
		Tbl.Col.value( 'ShippingNumber[1]', 'NVARCHAR(Max)' ) AS ShippingNumber,
		Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
		Tbl.Col.value( 'CouponCode[1]', 'NVARCHAR(Max)' ) AS CouponCode,
		Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
		CASE WHEN Tbl.Col.value( 'ReferralUserId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReferralUserId[1]', 'NVARCHAR(Max)' ) END  AS ReferralUserId,
		Tbl.Col.value( 'PurchaseOrderNumber[1]', 'NVARCHAR(Max)' ) AS PurchaseOrderNumber,
		CASE WHEN Tbl.Col.value( 'OmsPaymentStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsPaymentStateId[1]', 'NVARCHAR(Max)' ) END AS OmsPaymentStateId,
		Tbl.Col.value( 'WebServiceDownloadDate[1]', 'NVARCHAR(Max)' ) AS WebServiceDownloadDate,
		CASE WHEN Tbl.Col.value( 'PaymentSettingId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentSettingId[1]', 'NVARCHAR(Max)' ) END AS PaymentSettingId,
		Tbl.Col.value( 'PaymentTransactionToken[1]', 'NVARCHAR(Max)' ) AS PaymentTransactionToken,
		CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE @GetDate END AS ShipDate,
		CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
		CASE WHEN Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) END AS AddressId,
		Tbl.Col.value( 'PoDocument[1]', 'NVARCHAR(Max)' ) AS PoDocument,
		CASE WHEN Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) END  AS IsActive,
		Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
		CASE WHEN Tbl.Col.value( 'PaymentTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentTypeId[1]', 'NVARCHAR(Max)' ) END  AS PaymentTypeId,
		@UserId AS CreatedBy,
		@GetDate AS CreatedDate,
		@UserId AS ModifiedBy,
		@GetDate AS ModifiedDate,
		Tbl.Col.value( 'CreditCardNumber[1]', 'NVARCHAR(Max)' ) AS CreditCardNumber,
		CASE WHEN Tbl.Col.value( 'IsShippingCostEdited[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsShippingCostEdited[1]', 'NVARCHAR(Max)' ) END AS IsShippingCostEdited,
		CASE WHEN Tbl.Col.value( 'IsTaxCostEdited[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsTaxCostEdited[1]', 'NVARCHAR(Max)' ) END AS IsTaxCostEdited,
		Tbl.Col.value( 'ShippingDifference[1]', 'NVARCHAR(Max)' ) AS ShippingDifference,
		CASE WHEN Tbl.Col.value( 'EstimateShippingCost[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'EstimateShippingCost[1]', 'NVARCHAR(Max)' ) END AS EstimateShippingCost,
		Tbl.Col.value( 'TransactionId[1]', 'NVARCHAR(Max)' ) AS TransactionId,
		Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
		Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
		Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
		Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
		Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
		Tbl.Col.value( 'FirstName[1]', 'NVARCHAR(Max)' ) AS FirstName,
		Tbl.Col.value( 'LastName[1]', 'NVARCHAR(Max)' ) AS LastName,
		Tbl.Col.value( 'CardType[1]', 'NVARCHAR(Max)' ) AS CardType,
		Tbl.Col.value( 'CreditCardExpMonth[1]', 'NVARCHAR(Max)' ) AS CreditCardExpMonth,
		Tbl.Col.value( 'CreditCardExpYear[1]', 'NVARCHAR(Max)' ) AS CreditCardExpYear,
		CASE WHEN Tbl.Col.value( 'TotalAdditionalCost[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TotalAdditionalCost[1]', 'NVARCHAR(Max)' ) END AS TotalAdditionalCost,
		Tbl.Col.value( 'PaymentDisplayName[1]', 'NVARCHAR(Max)' ) AS PaymentDisplayName,
		Tbl.Col.value( 'PaymentExternalId[1]', 'NVARCHAR(Max)' ) AS PaymentExternalId,
		Tbl.Col.value( 'CultureCode[1]', 'NVARCHAR(Max)' ) AS CultureCode,
		Tbl.Col.value( 'DisplayName[1]', 'NVARCHAR(Max)' ) AS DisplayName,
		Tbl.Col.value( 'InHandDate[1]', 'NVARCHAR(Max)' ) AS InHandDate,
		Tbl.Col.value( 'IpAddress[1]', 'NVARCHAR(Max)' ) AS IpAddress,
		Tbl.Col.value( 'JobName[1]', 'NVARCHAR(Max)' ) AS JobName,
		Tbl.Col.value( 'ShippingConstraintCode[1]', 'NVARCHAR(Max)' ) AS ShippingConstraintCode,
		Tbl.Col.value( 'ShippingDiscount[1]', 'NVARCHAR(Max)' ) AS ShippingDiscount,
		Tbl.Col.value( 'ShippingHandlingCharges[1]', 'NVARCHAR(Max)' ) AS ShippingHandlingCharges,
		CASE WHEN Tbl.Col.value( 'ReturnCharges[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'ReturnCharges[1]', 'NVARCHAR(Max)' ) END AS ReturnCharges,
		CASE WHEN Tbl.Col.value( 'IsCalculateTaxAfterDiscount[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsCalculateTaxAfterDiscount[1]', 'NVARCHAR(Max)' ) END AS IsCalculateTaxAfterDiscount,
		Tbl.Col.value( 'Email[1]', 'NVARCHAR(Max)' ) AS Email,
		Tbl.Col.value( 'PhoneNumber[1]', 'NVARCHAR(Max)' ) AS PhoneNumber,
		CASE WHEN Tbl.Col.value( 'OrderTotalWithoutVoucher[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OrderTotalWithoutVoucher[1]', 'NVARCHAR(Max)' )  END AS OrderTotalWithoutVoucher,
		CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )='' THEN '' ELSE Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
		CASE WHEN Tbl.Col.value( 'TaxCost[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'TaxCost[1]', 'NVARCHAR(Max)' ) END  AS TaxCost,
		CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
		CASE WHEN Tbl.Col.value( 'SubTotal[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'SubTotal[1]', 'NVARCHAR(Max)' ) END AS SubTotal,
		Tbl.Col.value( 'CurrencyCode[1]', 'NVARCHAR(Max)' ) AS CurrencyCode,
		CASE WHEN Tbl.Col.value( 'OverDueAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OverDueAmount[1]', 'NVARCHAR(Max)' ) END AS OverDueAmount,
		CASE WHEN Tbl.Col.value( 'ShippingTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingTypeId[1]', 'NVARCHAR(Max)' ) END AS ShippingTypeId,
		Tbl.Col.value( 'AccountNumber[1]', 'NVARCHAR(Max)' ) AS AccountNumber,
		Tbl.Col.value( 'ShippingMethod[1]', 'NVARCHAR(Max)' ) AS ShippingMethod,
		Tbl.Col.value( 'PaymentCode[1]', 'NVARCHAR(Max)' ) AS PaymentCode,
		CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId
	FROM @OrderXML.nodes( '//PlaceOrderModel' ) AS Tbl(Col);

	--Getting billing address info
	INSERT INTO #TempOrderBillingAddress
	(
		AddressId,BillingFirstName,BillingLastName,BillingCompanyName,BillingStreet1,BillingStreet2,
		BillingCity,BillingStateCode,BillingPostalCode,BillingCountry,BillingPhoneNumber,BillingEmailId
	)
	SELECT
		Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) AS AddressId,
		Tbl.Col.value( 'FirstName[1]', 'NVARCHAR(Max)' ) AS FirstName,
		Tbl.Col.value( 'LastName[1]', 'NVARCHAR(Max)' ) AS LastName,
		Tbl.Col.value( 'CompanyName[1]', 'NVARCHAR(Max)' ) AS CompanyName,
		Tbl.Col.value( 'Street1[1]', 'NVARCHAR(Max)' ) AS Street1 ,
		Tbl.Col.value( 'Street2[1]', 'NVARCHAR(Max)' ) AS Street2,
		Tbl.Col.value( 'City[1]', 'NVARCHAR(Max)' ) AS City,
		Tbl.Col.value( 'StateCode[1]', 'NVARCHAR(Max)' ) AS StateCode,
		Tbl.Col.value( 'PostalCode[1]', 'NVARCHAR(Max)' ) AS PostalCode,
		Tbl.Col.value( 'Country[1]', 'NVARCHAR(Max)' ) AS Country,
		Tbl.Col.value( 'PhoneNumber[1]', 'NVARCHAR(Max)' ) AS PhoneNumber,
		Tbl.Col.value( 'EmailId[1]', 'NVARCHAR(Max)' ) AS EmailId
	FROM @OrderXML.nodes( '//PlaceOrderModel/BillingAddressModel' ) AS Tbl(Col);
	----Parent line item details insert
	INSERT INTO #TempParentLineItemDetails
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description,Quantity,
		Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber,
		PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles,
		RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy,
		ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity,
		TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty, GroupIdentifier
	)
	SELECT
		CASE WHEN Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemRelationshipTypeId,
		CASE WHEN Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) END  AS OmsOrderDetailsId,
		CASE WHEN Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderShipmentId,
		CASE WHEN Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) END AS RmaReasonForReturnId,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(2000)' ) AS ProductName,
		Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
		Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(Max)' ) AS Quantity,
		CASE WHEN Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) END AS Price,
		Tbl.Col.value( 'Weight[1]', 'NVARCHAR(Max)' ) AS Weight,
		Tbl.Col.value( 'DownloadLink[1]', 'NVARCHAR(Max)' ) AS DownloadLink,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		Tbl.Col.value( 'ShipSeparately[1]', 'NVARCHAR(Max)' ) AS ShipSeparately,
		CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE @GetDate END AS ShipDate,
		CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
		CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
		Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
		Tbl.Col.value( 'TransactionNumber[1]', 'NVARCHAR(Max)' ) AS TransactionNumber,
		CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId,
		Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
		CASE WHEN Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) END AS IsAutoGeneratedTracking,
		CASE WHEN Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemStateId,
		CASE WHEN Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) END AS IsRecurringBilling,
		Tbl.Col.value( 'RecurringBillingPeriod[1]', 'NVARCHAR(Max)' ) AS RecurringBillingPeriod,
		Tbl.Col.value( 'RecurringBillingCycles[1]', 'NVARCHAR(Max)' ) AS RecurringBillingCycles,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingFrequency,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingAmount,
		Tbl.Col.value( 'AppliedPromo[1]', 'NVARCHAR(Max)' ) AS AppliedPromo,
		Tbl.Col.value( 'CouponsApplied[1]', 'NVARCHAR(Max)' ) AS CouponsApplied,
		Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
		CASE WHEN Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) END AS IsActive,
		@UserId AS CreatedBy,
		@GetDate AS CreatedDate,
		@UserId AS ModifiedBy,
		@GetDate AS ModifiedDate,
		Tbl.Col.value( 'AutoAddonSKU[1]', 'NVARCHAR(Max)' ) AutoAddonSKU,
		CASE WHEN Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) END IsShippingReturn,
		CASE WHEN Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) END PartialRefundAmount,
		Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
		Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
		Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
		Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
		Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
		CASE WHEN Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) = ''  THEN NULL ELSE Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) END AS BundleQuantity,
		CASE WHEN Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) END AS TaxRuleId,
		Tbl.Col.value( 'TaxTransactionNumber[1]', 'NVARCHAR(Max)' ) AS TaxTransactionNumber,
		Tbl.Col.value( 'Comments[1]', 'NVARCHAR(Max)' ) AS Comments,
		CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
		CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
		CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
		CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END AS PST,
		CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END  AS HST,
		CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(Max)' ) AS GroupIdentifier
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel' ) AS Tbl(Col);

	----Child line item details insert
	INSERT INTO #TempChildLineItemDetails
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description,Quantity,
		Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber,
		PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles,
		RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy,
		ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity,
		TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty, ParentSku, GroupIdentifier
	)
	SELECT
		CASE WHEN Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemRelationshipTypeId,
		CASE WHEN Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderDetailsId,
		CASE WHEN Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderShipmentId,
		CASE WHEN Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) END AS RmaReasonForReturnId,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(2000)' ) AS ProductName,
		Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
		Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(Max)' ) AS Quantity,
		CASE WHEN Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) END AS Price,
		Tbl.Col.value( 'Weight[1]', 'NVARCHAR(Max)' ) AS Weight,
		Tbl.Col.value( 'DownloadLink[1]', 'NVARCHAR(Max)' ) AS DownloadLink,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		Tbl.Col.value( 'ShipSeparately[1]', 'NVARCHAR(Max)' ) AS ShipSeparately,
		CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE @GetDate END AS ShipDate,
		CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
		CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
		Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
		Tbl.Col.value( 'TransactionNumber[1]', 'NVARCHAR(Max)' ) AS TransactionNumber,
		CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId,
		Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
		CASE WHEN Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) END AS IsAutoGeneratedTracking,
		CASE WHEN Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemStateId,
		CASE WHEN Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) END AS IsRecurringBilling,
		Tbl.Col.value( 'RecurringBillingPeriod[1]', 'NVARCHAR(Max)' ) AS RecurringBillingPeriod,
		Tbl.Col.value( 'RecurringBillingCycles[1]', 'NVARCHAR(Max)' ) AS RecurringBillingCycles,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingFrequency,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingAmount,
		Tbl.Col.value( 'AppliedPromo[1]', 'NVARCHAR(Max)' ) AS AppliedPromo,
		Tbl.Col.value( 'CouponsApplied[1]', 'NVARCHAR(Max)' ) AS CouponsApplied,
		Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
		Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) AS IsActive,
		@UserId AS CreatedBy,
		@GetDate AS CreatedDate,
		@UserId AS ModifiedBy,
		@GetDate AS ModifiedDate,
		Tbl.Col.value( 'AutoAddonSKU[1]', 'NVARCHAR(Max)' ) AutoAddonSKU,
		CASE WHEN Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) END AS IsShippingReturn,
		CASE WHEN Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) END AS  PartialRefundAmount,
		Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
		Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
		Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
		Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
		Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
		CASE WHEN Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) END AS BundleQuantity,
		CASE WHEN Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) END AS TaxRuleId,
		Tbl.Col.value( 'TaxTransactionNumber[1]', 'NVARCHAR(Max)' ) AS TaxTransactionNumber,
		Tbl.Col.value( 'Comments[1]', 'NVARCHAR(Max)' ) AS Comments,
		CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
		CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
		CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
		CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END AS PST,
		CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END AS HST,
		CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE  Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
		Tbl.Col.value( 'ParentProductSKU[1]', 'NVARCHAR(Max)' ) AS ParentSku,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(Max)' ) AS GroupIdentifier
	FROM @OrderXML.nodes('//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/OrderLineItem/PlaceOrderlineItemCollection') AS Tbl(Col);

	--Updating parent for simple products
	UPDATE #TempChildLineItemDetails SET ParentSku = Sku WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdSimple
	AND OrderLineItemRelationshipTypeId IS NOT NULL

	--Inserting order number which are unique and getting in xml from code side
	INSERT INTO ZnodeOmsOrder(IsQuoteOrder,OrderNumber,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PublishStateId,IsOldOrder)
	OUTPUT INSERTED.OmsOrderId, INSERTED.OrderNumber INTO @OMSOrder
	SELECT 0 AS IsQuoteOrder, OrderNumber,OrderNumber AS ExternalId,@UserId,@GetDate,@UserId,@GetDate,PublishStateId, IsOldOrder
	FROM #TempOrderData
	WHERE ISNULL(OmsOrderId,0) = 0

	--If order is new then creating new order details
	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		INSERT INTO ZnodeOmsOrderDetails
		(
			OmsOrderId,PortalId,UserId,OrderDate,OmsOrderStateId,ShippingId,PaymentTypeId,BillingFirstName,BillingLastName
			,BillingCompanyName,BillingStreet1,BillingStreet2,BillingCity,BillingStateCode,BillingPostalCode,BillingCountry
			,BillingPhoneNumber,BillingEmailId,TaxCost,ShippingCost,SubTotal,DiscountAmount,CurrencyCode,OverDueAmount,Total
			,ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive
			,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
			,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
			,DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
			,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty
		)
		OUTPUT INSERTED.OmsOrderId, INSERTED.OmsOrderDetailsId INTO @OMSOrderDetail
		SELECT OO.OmsOrderId, OD.PortalId,@UserId,@GetDate,OD.OmsOrderStateId,OD.ShippingId,OD.PaymentTypeId,OBA.BillingFirstName,OBA.BillingLastName,OBA.BillingCompanyName,
			OBA.BillingStreet1,OBA.BillingStreet2,OBA.BillingCity,OBA.BillingStateCode,OBA.BillingPostalCode,OBA.BillingCountry,OBA.BillingPhoneNumber,OBA.BillingEmailId,OD.TaxCost,
			OD.ShippingCost,OD.SubTotal, OD.DiscountAmount,OD.CurrencyCode,OD.OverDueAmount,OD.Total
			,OD.ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,OD.BillingAddressId,PoDocument,CAST(1 AS BIT) AS IsActive
			,OD.ExternalId,OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
			,ShippingDifference,EstimateShippingCost,TransactionId,OD.Custom1,OD.Custom2,OD.Custom3,OD.Custom4,OD.Custom5,OD.FirstName,OD.LastName
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
			,OD.DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
			,IsCalculateTaxAfterDiscount,Email,OD.PhoneNumber,OrderTotalWithoutVoucher,ImportDuty
		FROM #TempOrderData OD
		INNER JOIN @OMSOrder OO ON OD.OrderNumber = OO.OrderNumber
		LEFT JOIN #TempOrderBillingAddress OBA ON OD.BillingAddressId = OBA.AddressId

	END
	--If order managed then creating new order details and disable old order details
	ELSE
	BEGIN
		Declare @OldOmsOrderDetailsId INT
		SET @OldOmsOrderDetailsId = (SELECT TOP 1 OOD.OmsOrderDetailsId FROM ZnodeOmsOrderDetails OOD  WITH (NOLOCK) 
									 WHERE EXISTS(SELECT * FROM  #TempOrderData OD WHERE OOD.OmsOrderId = OD.OmsOrderId) AND OOD.IsActive = 1)

		INSERT INTO ZnodeOmsOrderDetails
		(
			OmsOrderId,PortalId,UserId,OrderDate,OmsOrderStateId,ShippingId,PaymentTypeId,BillingFirstName,BillingLastName --1
			,BillingCompanyName,BillingStreet1,BillingStreet2,BillingCity,BillingStateCode,BillingPostalCode,BillingCountry --2
			,BillingPhoneNumber,BillingEmailId,TaxCost,ShippingCost,SubTotal,DiscountAmount,CurrencyCode,OverDueAmount,Total --3
			,ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId --4
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive --5
			,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited --6
			,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName --7
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName, --8
			PaymentExternalId,CultureCode, --9
			DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges --10
			,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty --11 
		)
		OUTPUT INSERTED.OmsOrderId, INSERTED.OmsOrderDetailsId INTO @OMSOrderDetail
		SELECT OO.OmsOrderId, OD.PortalId,@UserId,@GetDate,OD.OmsOrderStateId,OD.ShippingId,OD.PaymentTypeId,OBA.BillingFirstName,OBA.BillingLastName,--1
			OBA.BillingCompanyName,OBA.BillingStreet1,OBA.BillingStreet2,OBA.BillingCity,OBA.BillingStateCode,OBA.BillingPostalCode,OBA.BillingCountry, --2
			OBA.BillingPhoneNumber,OBA.BillingEmailId,OD.TaxCost,OD.ShippingCost,OD.SubTotal, OD.DiscountAmount,OD.CurrencyCode,OD.OverDueAmount,OD.Total, --3
			OD.ShippingNumber,OD.TrackingNumber,OD.CouponCode,OD.PromoDescription,OD.ReferralUserId,OD.PurchaseOrderNumber,OD.OmsPaymentStateId, --4
			OD.WebServiceDownloadDate,OD.PaymentSettingId,OD.PaymentTransactionToken,OD.ShipDate,OD.ReturnDate,OD.BillingAddressId,OD.PoDocument,CAST(1 AS BIT) AS IsActive --5
			,OD.ExternalId,OD.CreatedBy,OOD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.CreditCardNumber,OD.IsShippingCostEdited,OD.IsTaxCostEdited, --6
			OD.ShippingDifference,OD.EstimateShippingCost,OD.TransactionId,OD.Custom1,OD.Custom2,OD.Custom3,OD.Custom4,OD.Custom5,OD.FirstName,OD.LastName, --7
			OD.CardType,OD.CreditCardExpMonth,OD.CreditCardExpYear,OD.TotalAdditionalCost,CASE WHEN OD.PaymentSettingId = OOD.PaymentSettingId THEN OOD.PaymentDisplayName ELSE OD.PaymentDisplayName END AS PaymentDisplayName, --8
			CASE WHEN OD.PaymentSettingId = OOD.PaymentSettingId THEN OOD.PaymentExternalId ELSE OD.PaymentExternalId END AS PaymentExternalId,OD.CultureCode, --9 
			OD.DisplayName,OD.InHandDate,OD.IpAddress,OD.JobName,OD.ShippingConstraintCode,OD.ShippingDiscount,OD.ShippingHandlingCharges,OD.ReturnCharges, --10
			OD.IsCalculateTaxAfterDiscount,OD.Email,OD.PhoneNumber,OD.OrderTotalWithoutVoucher,OD.ImportDuty --11
		FROM #TempOrderData OD
		INNER JOIN ZnodeOmsOrder OO WITH (NOLOCK) ON OD.OrderNumber = OO.OrderNumber
		INNER JOIN ZnodeOmsOrderDetails OOD  WITH (NOLOCK) ON OO.OmsOrderId = OOD.OmsOrderId AND OOD.IsActive = 1
		LEFT JOIN #TempOrderBillingAddress OBA ON OD.BillingAddressId = OBA.AddressId
	
		DECLARE @OmsOrderStateIdCancelled int =  (select top 1 OmsOrderStateId FROM ZnodeOmsOrderState WHERE OrderStateName = 'CANCELLED')

		UPDATE ZnodeOmsOrderDetails SET IsActive = 0 , OmsOrderStateId = @OmsOrderStateIdCancelled
		WHERE OmsOrderDetailsId = @OldOmsOrderDetailsId

		UPDATE ZnodeOmsOrderLineItems SET IsActive = 0
		WHERE OmsOrderDetailsId = @OldOmsOrderDetailsId
	END

	----Geting new OmsOrderDetailsId always
	Declare @OmsOrderDetailsId INT
	SET @OmsOrderDetailsId = ( SELECT TOP 1 OmsOrderDetailsId FROM @OMSOrderDetail )

	--Insert Order notes only for new order details
	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		INSERT INTO ZnodeOmsNotes(OmsOrderDetailsId,Notes,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
		SELECT @OmsOrderDetailsId,Tbl.Col.value( 'AdditionalInstructions[1]', 'NVARCHAR(Max)' ) AS Notes,
			@UserId,@GetDate,@UserId,@GetDate
		FROM @OrderXML.nodes( '//PlaceOrderModel' ) AS Tbl(Col)
		WHERE Tbl.Col.value( 'AdditionalInstructions[1]', 'NVARCHAR(Max)' ) <> '';
	END

	----Inserting parent line item data
	INSERT INTO ZnodeOmsOrderLineItems
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description --1
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber --2
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles --3
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy --4
		,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, GroupIdentifier --5
	)
	OUTPUT INSERTED.OmsOrderDetailsId, INSERTED.OmsOrderLineItemsId, INSERTED.Sku,INSERTED.ParentOmsOrderLineItemsId, INSERTED.GroupId, INSERTED.OrderLineItemRelationshipTypeId,INSERTED.GroupIdentifier INTO @OmsParentOrderLineItems
	SELECT OrderLineItemRelationshipTypeId,@OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description--1
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber --2
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles --3
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,ISNULL(IsActive,1) AS IsActive,CreatedBy,CreatedDate,ModifiedBy --4
		,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, GroupIdentifier --5
	FROM #TempParentLineItemDetails PLID

	----Inserting child line item data
	INSERT INTO ZnodeOmsOrderLineItems
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description --1
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber --2
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles --3
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy --4
		,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, --5
		ParentSku, GroupIdentifier --6
	)
	OUTPUT INSERTED.OmsOrderDetailsId, INSERTED.OmsOrderLineItemsId, INSERTED.Sku,INSERTED.ParentOmsOrderLineItemsId, INSERTED.GroupId, INSERTED.OrderLineItemRelationshipTypeId, INSERTED.ParentSku, INSERTED.GroupIdentifier INTO @OmsOrderLineItems
	SELECT PLID.OrderLineItemRelationshipTypeId,@OmsOrderDetailsId,PLID.OmsOrderShipmentId,PLID.RmaReasonForReturnId,PLID.Sku,PLID.ProductName,PLID.Description, --1
		PLID.Quantity,PLID.Price,PLID.Weight,PLID.DownloadLink,PLID.DiscountAmount,PLID.ShipSeparately,PLID.ShipDate,PLID.ReturnDate,PLID.ShippingCost,PLID.PromoDescription,PLID.TransactionNumber, --2
		PLID.PaymentStatusId,PLID.TrackingNumber,PLID.IsAutoGeneratedTracking,PLID.OrderLineItemStateId,PLID.IsRecurringBilling,PLID.RecurringBillingPeriod,PLID.RecurringBillingCycles,--3
		PLID.RecurringBillingFrequency,PLID.RecurringBillingAmount,PLID.AppliedPromo,PLID.CouponsApplied,PLID.ExternalId,isnull(PLID.IsActive,1) AS IsActive,PLID.CreatedBy,PLID.CreatedDate,PLID.ModifiedBy, --4
		PLID.ModifiedDate,PLID.AutoAddonSKU,PLID.IsShippingReturn,PLID.PartialRefundAmount,PLID.Custom1,PLID.Custom2,PLID.Custom3,PLID.Custom4,PLID.Custom5,PLID.GroupId,PLID.BundleQuantity, --5
		case when PLID.OrderLineItemRelationshipTypeId = 5 then PLID.Sku else PLID.ParentSku end AS ParentSku, GroupIdentifier --6
	FROM #TempChildLineItemDetails PLID

	--Updating ParentOmsOrderLineItemsId for child line items for simple, group and configurable products
	UPDATE A SET A.ParentOmsOrderLineItemsId = (SELECT TOP 1 OmsOrderLineItemsId FROM @OmsParentOrderLineItems d WHERE d.GroupIdentifier = a.GroupIdentifier AND A.ParentSku = D.Sku  and ISNULL(a.GroupId,'-') = ISNULL(d.GroupId,'-'))
	FROM @OmsOrderLineItems a
	WHERE a.OrderLineItemRelationshipTypeId NOT IN ( @OrderLineItemRelationshipTypeIdAddon, @OrderLineItemRelationshipTypeIdGroup)  
	AND a.ParentOmsOrderLineItemsId IS NULL 
	
	--Updating ParentOmsOrderLineItemsId for child line items for group products
	IF EXISTS(SELECT * FROM @OmsOrderLineItems WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdGroup)
	BEGIN
		---Getting child lineitems for group product
		;WITH Cte_GroupProductChild AS
		(
			SELECT GroupIdentifier,Sku, ParentSku, OmsOrderLineItemsId, ParentOmsOrderLineItemsId,Dense_Rank()Over(Partition By GroupIdentifier ORDER BY OmsOrderLineItemsId) AS RowId1 
			FROM @OmsOrderLineItems
			WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdGroup
		)
		---Getting parent lineitems for group product
		,Cte_GroupProductParent AS 
		(
			SELECT GroupIdentifier,Sku, OmsOrderLineItemsId, Dense_Rank()Over(Partition By GroupIdentifier ORDER BY OmsOrderLineItemsId) AS RowId1 
			FROM @OmsParentOrderLineItems a
			WHERE OrderLineItemRelationshipTypeId IS NULL
			AND EXISTS(SELECT * FROM @OmsOrderLineItems b WHERE a.GroupIdentifier = b.GroupIdentifier AND a.Sku = b.ParentSku)
		)
		--Updating ParentOmsOrderLineItemsId on child for group products
		UPDATE a SET a.ParentOmsOrderLineItemsId = b.OmsOrderLineItemsId
		FROM Cte_GroupProductChild a
		INNER JOIN Cte_GroupProductParent B ON A.GroupIdentifier = B.GroupIdentifier AND a.RowId1 = b.RowId1 AND b.Sku = a.ParentSku 
	END

	---Updating ParentOmsOrderLineItemsId for addons if present
	IF EXISTS(SELECT * FROM @OmsOrderLineItems WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
	BEGIN
		--Updating ParentOmsOrderLineItemsId for addon with Simple products , group products and configurable products
		UPDATE b SET b.ParentOmsOrderLineItemsId = c.OmsOrderLineItemsId
		FROM @OmsOrderLineItems c
		INNER JOIN @OmsOrderLineItems b on b.ParentSku = c.Sku AND c.GroupIdentifier = b.GroupIdentifier
		WHERE c.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon and c.OrderLineItemRelationshipTypeId is not null
		and b.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
		AND b.ParentOmsOrderLineItemsId IS NULL
		
		--Updating ParentOmsOrderLineItemsId for addon with bundle products
		UPDATE c SET c.ParentOmsOrderLineItemsId = b.OmsOrderLineItemsId
		FROM @OmsOrderLineItems c
		INNER JOIN @OmsParentOrderLineItems b on B.sku = C.parentsku AND c.GroupIdentifier= b.GroupIdentifier
		WHERE B.OrderLineItemRelationshipTypeId is null 
		AND c.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
		AND C.ParentOmsOrderLineItemsId IS NULL
	 END

	 ---Updating ParentOmsOrderLineItemsId in main table
	 UPDATE a SET a.ParentOmsOrderLineItemsId = b.ParentOmsOrderLineItemsId
	 FROM  ZnodeOmsOrderLineItems a
	 INNER JOIN @OmsOrderLineItems b on a.OmsOrderLineItemsId = b.OmsOrderLineItemsId

	----Shipping details Start
	DECLARE @ShippingTypeId INT
	IF EXISTS(SELECT * FROM #TempOrderData WHERE ShippingTypeId IS NULL)
	BEGIN
		SET @ShippingTypeId = (SELECT TOP 1 ShippingTypeId FROM ZnodeShipping WHERE EXISTS(SELECT * FROM #TempOrderData WHERE ZnodeShipping.ShippingId = #TempOrderData.ShippingId))
	END
	ELSE
	BEGIN
		SET @ShippingTypeId = (SELECT TOP 1 ShippingTypeId FROM #TempOrderData)
	END
	IF EXISTS(SELECT * FROM ZnodeShippingTypes WITH (NOLOCK)  WHERE ShippingTypeId = @ShippingTypeId AND ClassName = 'ZnodeCustomerShipping')
	BEGIN
		INSERT INTO ZnodeOmsCustomerShipping(OmsOrderDetailsId,UserId,ShippingTypeId,AccountNumber,ShippingMethod,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT TOP 1 @OmsOrderDetailsId,@UserId,@ShippingTypeId,AccountNumber,ShippingMethod,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		FROM #TempOrderData
	END
	----Shipping details end

	----Order tax details start
	----Inserting order tax data
	INSERT INTO ZnodeOmsTaxOrderDetails(OmsOrderDetailsId,SalesTax,VAT,GST,PST,HST,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportDuty)
	SELECT @OmsOrderDetailsId,OD.SalesTax,OD.VAT,OD.GST,OD.PST,OD.HST,OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.ImportDuty
	FROM #TempOrderData OD

	----Inserting order tax data for parent line item
	INSERT INTO ZnodeOmsTaxOrderLineDetails
	(
		OmsOrderLineItemsId,TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty,
		CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
	)
	SELECT POLI.OmsOrderLineItemsId,CLID.TaxRuleId,CLID.TaxTransactionNumber,CLID.Comments,CLID.SalesTax,CLID.VAT,CLID.GST,CLID.PST,CLID.HST,CLID.ImportDuty,
	CLID.CreatedBy,CLID.CreatedDate,CLID.ModifiedBy,CLID.ModifiedDate
	FROM #TempParentLineItemDetails CLID
	INNER JOIN @OmsOrderLineItems POLI ON CLID.Sku = POLI.Sku AND ISNULL(CLID.GroupId,'') = ISNULL(POLI.GroupId,'') AND CLID.GroupIdentifier = POLI.GroupIdentifier
	WHERE POLI.ParentOmsOrderLineItemsId IS NULL

	----Inserting order tax data for child line item
	INSERT INTO ZnodeOmsTaxOrderLineDetails
	(
		OmsOrderLineItemsId,TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty,
		CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
	)
	SELECT POLI.OmsOrderLineItemsId,CLID.TaxRuleId,CLID.TaxTransactionNumber,CLID.Comments,CLID.SalesTax,CLID.VAT,CLID.GST,CLID.PST,CLID.HST,CLID.ImportDuty,
		CLID.CreatedBy,CLID.CreatedDate,CLID.ModifiedBy,CLID.ModifiedDate
	FROM #TempChildLineItemDetails CLID
	INNER JOIN @OmsOrderLineItems POLI ON CLID.Sku = POLI.Sku AND ISNULL(CLID.GroupId,'') = ISNULL(POLI.GroupId,'') AND CLID.GroupIdentifier = POLI.GroupIdentifier
	WHERE POLI.ParentOmsOrderLineItemsId IS NOT NULL
	----Order tax details end

	----Order attribte details start
	----Fetching order attributes FROM xml
	INSERT INTO #TempOrderAttribute(AttributeCode ,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AttributeValueCode,Sku,GroupId, GroupIdentifier )
	SELECT
		Tbl.Col.value( 'AttributeCode[1]', 'NVARCHAR(Max)' ) AS AttributeCode,
		Tbl.Col.value( 'AttributeValue[1]', 'NVARCHAR(Max)' ) AS AttributeValue,
		@UserId,@GetDate,@UserId,@GetDate,
		Tbl.Col.value( 'AttributeValueCode[1]', 'NVARCHAR(2000)' ) AS AttributeValueCode,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(2000)' ) AS GroupIdentifier
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/OrderLineItem/PlaceOrderlineItemCollection/OrderAttribute/PlaceOrderAttributeModel' ) AS Tbl(Col);

	----Inserting order attributes data
	INSERT INTO ZnodeOmsOrderAttribute(OmsOrderLineItemsId,AttributeCode,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AttributeValueCode)
	SELECT POLI.OmsOrderLineItemsId, OA.AttributeCode,OA.AttributeValue,OA.CreatedBy,OA.CreatedDate,OA.ModifiedBy,OA.CreatedDate,OA.AttributeValueCode
	FROM #TempOrderAttribute OA
	INNER JOIN @OmsOrderLineItems POLI ON OA.Sku = POLI.Sku AND ISNULL(OA.GroupId,'') = ISNULL(POLI.GroupId,'') AND OA.GroupIdentifier = POLI.GroupIdentifier
	----Order attribte details end

	----Personalise details start
	----Fetching personalize order data
	INSERT INTO #OmsPersonalizeItem(PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL,Sku,GroupId, GroupIdentifier)
	SELECT
		Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode,
		Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue,
		@UserId,@GetDate,@UserId,@GetDate,
		Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(2000)' ) AS DesignId,
		Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(2000)' ) AS ThumbnailURL,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(2000)' ) AS GroupIdentifier
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/PersonaliseDetails/PlaceOrderPersonaliseModel' ) AS Tbl(Col);

	--Inserting personalize order data
	INSERT INTO ZnodeOmsPersonalizeItem(OmsOrderLineItemsId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL)
	SELECT OmsOrderLineItemsId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL
	FROM #OmsPersonalizeItem OPI
	INNER JOIN @OmsParentOrderLineItems POLI ON OPI.Sku = POLI.Sku AND ISNULL(OPI.GroupId,'') = ISNULL(POLI.GroupId,'') AND OPI.GroupIdentifier = POLI.GroupIdentifier
	WHERE POLI.ParentOmsOrderLineItemsId IS NULL
	----Personalise details end

	----discount details start
	----Fetching order discount data
	INSERT INTO #OmsOrderDiscount
	(
		OmsDiscountTypeId ,DiscountCode,DiscountAmount ,Description ,CreatedBy ,CreatedDate ,
		ModifiedBy ,ModifiedDate ,PerQuantityDiscount,DiscountMultiplier ,DiscountLevelTypeId ,
		PromotionName ,PromotionTypeId ,DiscountAppliedSequence,PromotionMessage ,Sku,GroupId 
	)
	SELECT
	CASE WHEN Tbl.Col.value( 'OmsDiscountTypeId[1]', 'NVARCHAR(2000)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OmsDiscountTypeId[1]', 'NVARCHAR(2000)' ) END AS OmsDiscountTypeId,
		Tbl.Col.value( 'DiscountCode[1]', 'NVARCHAR(Max)' ) AS DiscountCode,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
		@UserId,@GetDate,@UserId,@GetDate,
		CASE WHEN Tbl.Col.value( 'PerQuantityDiscount[1]', 'NVARCHAR(2000)' )='' THEN NULL ELSE Tbl.Col.value( 'PerQuantityDiscount[1]', 'NVARCHAR(2000)' ) END AS PerQuantityDiscount,
		CASE WHEN Tbl.Col.value( 'DiscountMultiplier[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountMultiplier[1]', 'NVARCHAR(2000)' ) END AS DiscountMultiplier,
		CASE WHEN Tbl.Col.value( 'DiscountLevelTypeId[1]', 'NVARCHAR(2000)' )= '' THEN NULL ELSE Tbl.Col.value( 'DiscountLevelTypeId[1]', 'NVARCHAR(2000)' ) END AS DiscountLevelTypeId,
		Tbl.Col.value( 'PromotionName[1]', 'NVARCHAR(2000)' ) AS PromotionName,
		CASE WHEN Tbl.Col.value( 'PromotionTypeId[1]', 'NVARCHAR(2000)' )= '' THEN NULL ELSE Tbl.Col.value( 'PromotionTypeId[1]', 'NVARCHAR(2000)' ) END AS PromotionTypeId,
		Tbl.Col.value( 'DiscountAppliedSequence[1]', 'NVARCHAR(2000)' ) AS DiscountAppliedSequence,
		Tbl.Col.value( 'PromotionMessage[1]', 'NVARCHAR(2000)' ) AS PromotionMessage,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId
	FROM @OrderXML.nodes('//PlaceOrderModel/OrderDiscounts/PlaceOrderDiscountModel') AS Tbl(Col)

	----Inserting order discount data
	--Inserting product level discount for simple and group products
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,POLI.OmsOrderLineItemsId,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
		OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,POLI.ParentOmsOrderLineItemsId,
		OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	INNER JOIN @OmsOrderLineItems POLI ON OD.Sku = POLI.Sku AND ISNULL(OD.GroupId,'') = ISNULL(POLI.GroupId,'') 
	WHERE isnull(OD.Sku,'') <> '' AND POLI.OrderLineItemRelationshipTypeId IN (@OrderLineItemRelationshipTypeIdSimple , @OrderLineItemRelationshipTypeIdGroup)
	
	--Inserting product level discount for config and bundle products
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,POLI.ParentOmsOrderLineItemsId,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
	OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,NULL,
	OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	INNER JOIN @OmsOrderLineItems POLI ON OD.Sku = POLI.ParentSku AND ISNULL(OD.GroupId,'') = ISNULL(POLI.GroupId,'')
	WHERE isnull(OD.Sku,'') <> '' AND POLI.OrderLineItemRelationshipTypeId IN (@OrderLineItemRelationshipTypeIdBundles , @OrderLineItemRelationshipTypeIdConfig)
	
	--Inserting order level discount 
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,NULL,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
	OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,NULL,
	OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	WHERE isnull(OD.Sku,'') = ''
	----discount details end

	----Additional Cost details start
	IF OBJECT_ID('TEMPDB..#TempAdditionalCost') IS NOT NULL
	DROP TABLE #TempAdditionalCost
	--fetching additional cost details
	SELECT Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl1.Col.value( 'KeyName[1]', 'NVARCHAR(2000)' ) AS KeyName,
		CASE WHEN Tbl1.Col.value( 'KeyValue[1]', 'NVARCHAR(2000)' )='' THEN NULL ELSE Tbl1.Col.value( 'KeyValue[1]', 'NVARCHAR(2000)' ) END AS KeyValue,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId
	INTO #TempAdditionalCost
	FROM @OrderXML.nodes('//PlaceOrderModel/LineItems/PlaceOrderLineItemModel') AS Tbl(Col)
	CROSS APPLY Tbl.Col.nodes( '*:AdditionalCostList/AdditionalCost' ) AS Tbl1(Col);

	--Inserting additional cost details
	IF EXISTS(SELECT * FROM #TempAdditionalCost)
	BEGIN
		INSERT INTO ZnodeOmsOrderLineItemsAdditionalCost(OmsOrderLineItemsId,KeyName,KeyValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT OLI.OmsOrderLineItemsId, AC.KeyName, AC.KeyValue, @UserId, @GetDate, @UserId, @GetDate
		FROM #TempAdditionalCost AC
		INNER JOIN @OmsOrderLineItems OLI ON AC.Sku = OLI.Sku AND ISNULL(AC.GroupId,'') = ISNULL(OLI.GroupId,'') 
		WHERE OLI.ParentOmsOrderLineItemsId IS NULL
		AND ISNULL(AC.KeyName,'') <> ''
	END
	----Additional Cost details end

	----RMA details start
	IF (SELECT TOP 1 OmsOrderID FROM #TempOrderData) > 0
	BEGIN
		DECLARE @OmsOrderID INT, @OldOmsOrderDetailID INT
		SET @OmsOrderID = (SELECT TOP 1 OmsOrderId FROM #TempOrderData)
		SET @OldOmsOrderDetailID = (SELECT TOP 1 OmsOrderDetailsId FROM ZnodeOmsOrderDetails WHERE OmsOrderId = @OmsOrderID AND OmsOrderDetailsId <> @OmsOrderDetailsId ORDER BY OmsOrderDetailsId DESC)

		UPDATE ZnodeRmaReturnDetails
		SET OmsOrderDetailsId = @OmsOrderDetailsId
		WHERE OmsOrderId = @OmsOrderID

		SELECT OOLI.OmsOrderLineItemsId AS OldOmsOrderLineItemsId, OOLI.OmsOrderDetailsId, OOLI.Sku, LI.OmsOrderLineItemsId AS NewOmsOrderLineItemsId
		INTO #OldOrderLineItems
		FROM ZnodeOmsOrderLineItems OOLI WITH (NOLOCK)
		INNER JOIN @OmsOrderLineItems LI ON LI.Sku = OOLI.Sku
		WHERE OOLI.OmsOrderDetailsId = @OldOmsOrderDetailID --AND OOLI.ParentOmsOrderLineItemsId IS NULL
 
		UPDATE RRLI SET RRLI.OmsOrderLineItemsId = OldLI.NewOmsOrderLineItemsId
		FROM ZnodeRmaReturnLineItems RRLI
		INNER JOIN #OldOrderLineItems OldLI ON RRLI.OmsOrderLineItemsId = OldOmsOrderLineItemsId
	END
	----RMA details end

	COMMIT TRAN OrderInsert

	SELECT TOP 1 OmsOrderId,@OmsOrderDetailsId AS OmsOrderDetailsId, cast(1 AS bit)  AS Status, '' AS ErrorMessage
	FROM @OMSOrderDetail

END TRY
BEGIN CATCH
	ROLLBACK TRAN OrderInsert
	SELECT TOP 1 0 AS OmsOrderId,0 AS OmsOrderDetailsId, cast(0 AS bit)  AS Status, ERROR_MESSAGE() AS ErrorMessage

	INSERT INTO ZnodeOmsFailedOrderPayments(PaymentCode,PaymentDisplayName,TransactionToken,TotalAmount,UserName,UserId,Email,PaymentSettingId,OrderNumber,OrderDate,PaymentStatusId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
	SELECT TOP 1 PaymentCode,PaymentDisplayName, PaymentTransactionToken,Total,a.FirstName+' '+a.LastName,@UserId,a.Email,a.PaymentSettingId,a.OrderNumber,@GetDate,PaymentStatusId,@UserId,@GetDate,@UserId,@GetDate
	FROM #TempOrderData A

	DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertUpdateOmsOrder @OrderXML ='+CAST(@OrderXML AS VARCHAR(MAX))+' , @UserId = '+CAST(@UserId AS VARCHAR(50));

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName    = 'Znode_InsertUpdateOmsOrder',
	@ErrorInProcedure = @ERROR_PROCEDURE,
	@ErrorMessage     = @ErrorMessage,
	@ErrorLine        = @ErrorLine,
	@ErrorCall        = @ErrorCall;
	--If error throw in SP the deleting records FROM order tables if data inserted
	EXEC Znode_DeleteOrderById @OrderDetailId=@OmsOrderDetailsId,@Status=0
END CATCH

END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PostSubmitOrderProcess')
	DROP PROC Znode_PostSubmitOrderProcess
GO

CREATE PROCEDURE [dbo].[Znode_PostSubmitOrderProcess]
(
	@PostOrderXml XML,
	@InventoryData XML,
	@UserId INT,
	@PortalId INT = 0,
	@Status BIT OUT
)
AS
BEGIN
BEGIN TRY
--BEGIN TRAN PostOrder
	DECLARE @OmsOrderDetailsId INT
	DECLARE @OmsOrderId INT = (SELECT Tbl.Col.value( 'OrderID[1]', 'NVARCHAR(2000)' ) AS OrderId FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))
	
	DECLARE @IsGuest BIT = (SELECT Tbl.Col.value( 'IsGuest[1]', 'NVARCHAR(2000)' ) AS IsGuest FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))

	DECLARE @OmsCookieMappingId INT = (SELECT Tbl.Col.value( 'CookieMappingId[1]', 'NVARCHAR(2000)' ) AS CookieMappingId FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))
	DECLARE @BillingAddressId INT = (SELECT Tbl.Col.value( 'BillingAddressId[1]', 'NVARCHAR(2000)' ) AS BillingAddressId FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))
	
	DECLARE @IsReferralCommission BIT = (SELECT Tbl.Col.value( 'IsReferralCommission[1]', 'NVARCHAR(2000)' ) AS IsReferralCommission FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))
	DECLARE @CommissionAmount NUMERIC(26,6) = (SELECT Tbl.Col.value( 'CommissionAmount[1]', 'NVARCHAR(2000)' ) AS CommissionAmount FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))
	
	SET @OmsOrderDetailsId = (SELECT OmsOrderDetailsId from ZnodeOmsOrderDetails WHERE OmsOrderId = @OmsOrderId AND IsActive = 1)
	DECLARE @SetBillingShippingFlags BIT = (SELECT Tbl.Col.value( 'SetBillingShippingFlags[1]', 'NVARCHAR(2000)' ) AS SetBillingShippingFlags FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col)) 
	DECLARE @GetDate DATETIME = GETDATE()
	
	--Fetching required user details 
	DECLARE @ReferralCommissionTypeId INT, @ReferralCommission NUMERIC(28,6) , @FirstName VARCHAR(100)
	SELECT @FirstName = FirstName, @ReferralCommission = CASE WHEN ReferralCommission IS NULL THEN 0 ELSE ReferralCommission END, @ReferralCommissionTypeId = ReferralCommissionTypeId
	FROM ZnodeUser WITH (NOLOCK) 
	WHERE UserId = @UserId
	
	---Voucher model fetch
	CREATE TABLE #TempVoucher
	(
		VoucherBalance NUMERIC(28,6),VoucherNumber NVARCHAR(600),VoucherMessage NVARCHAR(MAX),IsVoucherValid BIT,
		IsVoucherApplied BIT,VoucherAmountUsed NUMERIC(28,6),VoucherName NVARCHAR(600),ExpirationDate DATETIME,
		CultureCode NVARCHAR(600),PortalId INT,IsExistInOrder BIT,UserId INT,IsActive BIT,OrderVoucherAmount NUMERIC(28,6)
	)

	INSERT INTO #TempVoucher
	(
		VoucherBalance ,VoucherNumber,VoucherMessage ,IsVoucherValid ,
		IsVoucherApplied ,VoucherAmountUsed ,VoucherName ,ExpirationDate ,
		CultureCode ,PortalId ,IsExistInOrder ,UserId ,IsActive ,OrderVoucherAmount 
	)
	SELECT Tbl.Col.value( 'VoucherBalance[1]', 'NVARCHAR(2000)' ) AS VoucherBalance,
		Tbl.Col.value( 'VoucherNumber[1]', 'NVARCHAR(2000)' ) AS VoucherNumber,
		Tbl.Col.value( 'VoucherMessage[1]', 'NVARCHAR(2000)' ) AS VoucherMessage,
		Tbl.Col.value( 'IsVoucherValid[1]', 'NVARCHAR(2000)' ) AS IsVoucherValid,
		Tbl.Col.value( 'IsVoucherApplied[1]', 'NVARCHAR(2000)' ) AS IsVoucherApplied,
		Tbl.Col.value( 'VoucherAmountUsed[1]', 'NVARCHAR(2000)' ) AS VoucherAmountUsed,
		Tbl.Col.value( 'VoucherName[1]', 'NVARCHAR(2000)' ) AS VoucherName,
		Tbl.Col.value( 'ExpirationDate[1]', 'NVARCHAR(2000)' ) AS ExpirationDate,
		Tbl.Col.value( 'CultureCode[1]', 'NVARCHAR(2000)' ) AS CultureCode,
		Tbl.Col.value( 'PortalId[1]', 'NVARCHAR(2000)' ) AS PortalId,
		Tbl.Col.value( 'IsExistInOrder[1]', 'NVARCHAR(2000)' ) AS IsExistInOrder,
		Tbl.Col.value( 'UserId[1]', 'NVARCHAR(2000)' ) AS UserId,	
		Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(2000)' ) AS IsActive,
		Tbl.Col.value( 'OrderVoucherAmount[1]', 'NVARCHAR(2000)' ) AS OrderVoucherAmount
	FROM @PostOrderXml.nodes('//PostOrderSubmitModel/Vouchers/VoucherModel') AS Tbl(Col)


	----Promotion coupon start
	DECLARE @TempPromotionCoupon DBO.PromotionCoupons

	INSERT INTO @TempPromotionCoupon
	SELECT Tbl.Col.value( 'Code[1]', 'NVARCHAR(2000)' ) AS Code,
		Tbl.Col.value( 'IsExistInOrder[1]', 'NVARCHAR(2000)' ) AS IsExistInOrder,@OmsOrderId AS OmsOrderId
	FROM @PostOrderXml.nodes('//PostOrderSubmitModel/Coupons/CouponModel') AS Tbl(Col)

	--Deduct promotion coupon count
	EXEC [Znode_PromotionCouponDeduct] @PromotionCoupons = @TempPromotionCoupon
	----Promotion coupon END
	
	--Deduct inventory quantity
	EXEC [Znode_UpdateInventoryPostOrder] @SkuXml = @InventoryData,@PortalId = @PortalId, @UserId= @UserId,@OmsOrderId=@OmsOrderId,@Status = 0

	----Voucher start
	IF EXISTS(SELECT * FROM #TempVoucher)
	BEGIN
		INSERT INTO ZnodeGiftCardHistory(GiftCardId,TransactionDate,TransactionAmount,OmsOrderDetailsId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Notes,RemainingAmount)
		SELECT GC.GiftCardId, @GetDate, VoucherAmountUsed,@OmsOrderDetailsId,CASE WHEN ISNULL(@IsGuest,0) IN ('TRUE','1') THEN NULL ELSE @UserId END, @GetDate, @UserId, @GetDate, 'Voucher is used to make payments for the order' as Notes, NULL AS RemainingAmount
		FROM #TempVoucher V
		INNER JOIN ZnodeGiftCard GC WITH (NOLOCK) ON V.VoucherNumber = GC.CardNumber

		IF EXISTS(SELECT * FROM #TempVoucher WHERE IsExistInOrder IN ('TRUE','1'))
		BEGIN
			UPDATE GC SET GC.RemainingAmount = V.VoucherBalance
			FROM #TempVoucher V
			INNER JOIN ZnodeGiftCard GC ON V.VoucherNumber = GC.CardNumber
			WHERE IsExistInOrder IN ('TRUE','1')
		END

		IF EXISTS(SELECT * FROM #TempVoucher WHERE IsExistInOrder IN ('FALSE','0'))
		BEGIN
			UPDATE GC SET GC.RemainingAmount = GC.RemainingAmount - V.VoucherAmountUsed
			FROM #TempVoucher V
			INNER JOIN ZnodeGiftCard GC ON V.VoucherNumber = GC.CardNumber
			WHERE IsExistInOrder IN ('FALSE','0')
		END
	END
	----Voucher end
	
	--Update user details
	IF @FirstName IS NULL
	BEGIN
		DECLARE @FirstName1 VARCHAR(300), @LastName VARCHAR(300), @PhoneNumber VARCHAR(300)
		SELECT @FirstName1=FirstName, @LastName=LastName, @PhoneNumber=PhoneNumber
		FROM ZnodeAddress WITH (NOLOCK)  WHERE AddressId = @BillingAddressId

		UPDATE ZnodeUser 
		SET FirstName = @FirstName, LastName = @LastName, PhoneNumber = @PhoneNumber
		WHERE UserId = @UserId
	END

	--Update address details
	IF @SetBillingShippingFlags IN ('TRUE','1')
	BEGIN
		UPDATE ZnodeAddress
		SET IsBilling = 1, IsShipping = 1
		WHERE AddressId = @BillingAddressId
	END

	--ReferralCommission details
	IF @IsReferralCommission IN ('TRUE','1')
	BEGIN
		INSERT INTO ZnodeOmsReferralCommission
		(
			UserId,OmsOrderDetailsId,OrderCommission,TransactionId,Description,ReferralCommission,ReferralCommissionTypeId
			,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		)
		SELECT @UserId,@OmsOrderDetailsId,CASE WHEN @ReferralCommissionTypeId =1 THEN ((@CommissionAmount * ISNULL(@ReferralCommission,0)) / 100) ELSE @ReferralCommission END AS OrderCommission,'' AS TransactionId,'' AS Description,@ReferralCommission,@ReferralCommissionTypeId
			,@UserId,@GetDate,@UserId,@GetDate
	END
	
	---OmsTaxOrderSummary details
	IF EXISTS(SELECT * FROM ZnodeOmsTaxOrderSummary WITH (NOLOCK)  WHERE OmsOrderDetailsId = @OmsOrderDetailsId)
	BEGIN
		DELETE FROM ZnodeOmsTaxOrderSummary WHERE OmsOrderDetailsId = @OmsOrderDetailsId
	END

	INSERT INTO ZnodeOmsTaxOrderSummary (OmsOrderDetailsId,Tax,Rate,TaxName,TaxTypeName)
	SELECT 	@OmsOrderDetailsId AS OmsOrderDetailsId,
		Tbl.Col.value( 'Tax[1]', 'NVARCHAR(2000)' ) AS Tax,
		Tbl.Col.value( 'Rate[1]', 'NVARCHAR(2000)' ) AS Rate,
		Tbl.Col.value( 'TaxName[1]', 'NVARCHAR(2000)' ) AS TaxName,
		Tbl.Col.value( 'TaxTypeName[1]', 'NVARCHAR(2000)' ) AS TaxTypeName
	FROM @PostOrderXml.nodes('//PostOrderSubmitModel/TaxSummaryList/TaxSummaryModel') AS Tbl(Col)
	WHERE Tbl.Col.value( 'Tax[1]', 'NVARCHAR(2000)' ) IS NOT NULL
	--------

	--Remove 
	EXEC [Znode_DeleteSavedCartItem] @OmsCookieMappingId = @OmsCookieMappingId, @UserId = @UserId,@PortalId = @PortalId,@Status = 0  

	SET @Status = 1
	--COMMIT TRAN PostOrder
END TRY
BEGIN CATCH
--ROLLBACK TRAN PostOrder
	SET @Status = 0
	
	DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PostSubmitOrderProcess @PostOrderXml ='+CAST(@PostOrderXml AS VARCHAR(MAX))+' , @InventoryData = '+CAST(@InventoryData AS VARCHAR(50))+',@UserId ='+CAST(@UserId AS VARCHAR(50))+',@PortalId ='+CAST(@PortalId AS VARCHAR(50))+',@Status ='+CAST(@Status AS VARCHAR(50));
	
	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName    = 'Znode_PostSubmitOrderProcess',
	@ErrorInProcedure = @ERROR_PROCEDURE,
	@ErrorMessage     = @ErrorMessage,
	@ErrorLine        = @ErrorLine,
	@ErrorCall        = @ErrorCall;
END CATCH

END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PromotionCouponDeduct')
	DROP PROC Znode_PromotionCouponDeduct
GO

CREATE PROCEDURE [dbo].[Znode_PromotionCouponDeduct]
(
	@PromotionCoupons DBO.PromotionCoupons READONLY
)
AS
BEGIN
SET NOCOUNT ON  
BEGIN TRY

		----Quantity decuction for promotion coupons
		UPDATE ZPC SET ZPC.AvailableQuantity = ZPC.AvailableQuantity-1 
		FROM ZnodePromotionCoupon ZPC
		WHERE EXISTS(SELECT * FROM @PromotionCoupons PC WHERE ZPC.Code = PC.Code AND ( PC.IsExistInOrder IN ('0','FALSE') OR ISNULL(PC.OmsOrderId,0) = 0 ))

		IF EXISTS(SELECT * FROM @PromotionCoupons WHERE IsExistInOrder IN ('1','TRUE') AND ISNULL(OmsOrderId,0) > 0)
		BEGIN
			--For existing order if coupon not used
			UPDATE ZPC SET ZPC.AvailableQuantity = ZPC.AvailableQuantity-1 
			FROM ZnodeOmsOrderDetails dtls 
			INNER JOIN ZnodeOmsOrderLineItems item on dtls.OmsOrderDetailsId = item.OmsOrderDetailsId 
			INNER JOIN [ZnodeOmsOrderDiscount] disc on (disc.OmsOrderLineItemId = item.OmsOrderLineItemsId or disc.OmsOrderDetailsId = dtls.OmsOrderDetailsId)
			INNER JOIN ZnodeOmsDiscountType typ on disc.OmsDiscountTypeId = typ.OmsDiscountTypeId
			INNER JOIN @PromotionCoupons PC ON BINARY_CHECKSUM(disc.discountcode) <> BINARY_CHECKSUM(PC.Code) AND ISNULL(PC.OmsOrderId,0) = dtls.OmsOrderId
			INNER JOIN ZnodePromotionCoupon ZPC ON PC.Code = ZPC.Code
			WHERE dtls.IsActive = 1 and typ.Name = 'COUPONCODE'
			AND PC.IsExistInOrder IN ('1','TRUE') 
		END

END TRY
BEGIN CATCH

	DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PromotionCouponDeduct '

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName    = 'Znode_PromotionCouponDeduct',
	@ErrorInProcedure = @ERROR_PROCEDURE,
	@ErrorMessage     = @ErrorMessage,
	@ErrorLine        = @ErrorLine,
	@ErrorCall        = @ErrorCall;
END CATCH

END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_UpdateInventoryPostOrder')
	DROP PROC Znode_UpdateInventoryPostOrder
GO

CREATE PROCEDURE [dbo].[Znode_UpdateInventoryPostOrder]
(
	@SkuXml xml,
	@PortalId int, 
	@UserId int, 
	@Status bit OUT, 
	@OmsOrderId INT,
	@IsDebug bit= 0
)
AS 
	/*
	Summary: (13671)   Inventory will be updated on the basis of "InventoryTracking" (Attribute Code) value in locale table 
				    If value id "DisablePurchasing" then subtracts currently selected quantity only when it will greater than zero.
				    If "AllowBackordering" then inventory will become negative
				    If "DontTrackInventory" then don't update inventory.
				    inventory will be get deducted from associated warehouse where quantity is available as per warehouse precedence. 
				    Validate total quantity 
	Input Parameters:
	SKU(Comma separated multiple), PortalId
	Unit Testing   
		Declare @Status bit 
		Exec Znode_UpdateInventory  @SkuXml = '<ArrayOfOrderWarehouseLineItemsModel>
		<OrderWarehouseLineItemsModel>
		<OrderLineItemId>418</OrderLineItemId>
		<SKU>ap1534</SKU>
		<InventoryTracking>DisablePurchasing</InventoryTracking>
		<Quantity>1.000000</Quantity>
		</OrderWarehouseLineItemsModel>
		<OrderWarehouseLineItemsModel>
		<OrderLineItemId>419</OrderLineItemId>
		<SKU>al8907</SKU>
		<InventoryTracking>DisablePurchasing</InventoryTracking>
		<Quantity>1.000000</Quantity>
		</OrderWarehouseLineItemsModel>
		</ArrayOfOrderWarehouseLineItemsModel>',@PortalId = 1,@UserId = 2,@Status = @Status

	*/
BEGIN
	BEGIN TRAN UpdateInventory;
	BEGIN TRY
		SET NOCOUNT ON;
		DECLARE @RoundOffValue INT= dbo.Fn_GetDefaultValue('InventoryRoundOff');
		DECLARE @TBL_XmlReturnToTable TABLE
		( 
			OrderLineItemId int, SKU nvarchar(max), InventoryTracking nvarchar(1000), Quantity numeric(28, 6),
			AllowBackOrder VARCHAR(100), SequenceNo int IDENTITY, OrderLineItemRelationshipTypeId int 
		);
		DECLARE @TBL_ErrorInventoryTracking TABLE
		( 
			SKU nvarchar(max), Quantity numeric(28, 6), InventoryTracking nvarchar(2000), AllowBackOrder varchar(100)
		);
		INSERT INTO @TBL_XmlReturnToTable( OrderLineItemId, SKU, InventoryTracking, Quantity,AllowBackOrder )
		SELECT Tbl.Col.value( 'OrderLineItemId[1]', 'INT' ) AS OrderLineItemId, Tbl.Col.value( 'SKU[1]', 'NVARCHAR(2000)' ) AS SKU, Tbl.Col.value( 'InventoryTracking[1]', 'NVARCHAR(2000)' ) AS InventoryTracking, Tbl.Col.value( 'Quantity[1]', 'Numeric(28,6)' ) AS Quantity
		, Tbl.Col.value( 'AllowBackOrder[1]', 'VARCHAR(100)' ) AS AllowBackOrder
		FROM @SkuXml.nodes( '//ArrayOfOrderWarehouseLineItemsModel/OrderWarehouseLineItemsModel' ) AS Tbl(Col)
		WHERE Tbl.Col.value( 'InventoryTracking[1]', 'NVARCHAR(2000)' ) <> 'DontTrackInventory' 
		AND Tbl.Col.value( 'Quantity[1]', 'Numeric(28,6)' ) > 0;

		DECLARE @Cur_WarehouseId int, @Cur_PortalId int, @Cur_PortalWarehouseId int, @Cur_WarehouseSequence int, @Cur_SKU varchar(200), @Cur_Quantity numeric(28, 6), @Cur_ReOrderLevel numeric(28, 6), @Cur_InventoryId int;

		DECLARE @RecurringQuantity numeric(28, 6), @BalanceQuantity numeric(28, 6)
		SET @Status = 0; 

		---Updating order line item
		UPDATE TBL SET OrderLineItemId = ZOOLI.OmsOrderLineItemsId, TBL.OrderLineItemRelationshipTypeId = ZOOLI.OrderLineItemRelationshipTypeId 
		FROM ZnodeOmsOrderLineItems ZOOLI WITH (NOLOCK)
		INNER JOIN @TBL_XmlReturnToTable TBL ON ZOOLI.Sku = TBL.SKU
		WHERE EXISTS(SELECT * FROM ZnodeOmsOrderDetails ZOOD WITH (NOLOCK) WHERE ZOOLI.OmsOrderDetailsId = ZOOD.OmsOrderDetailsId AND ZOOD.OmsOrderId = @OmsOrderId)
		AND ZOOLI.ParentOmsOrderLineItemsId IS NOT NULL

		DECLARE @TBL_CalculateQuntity TABLE
		( 
			WarehouseId int, SKU varchar(200), MainQuantity numeric(28, 6), InventoryId int, OrderQuantity numeric(28, 6), UpdatedQuantity numeric(28, 6), WarehouseSequenceId int, InventoryTracking nvarchar(2000)
			, AllowBackOrder varchar(100)
		);
		
		DECLARE @TBL_AllwareHouseToportal TABLE
		( 
			WarehouseId int, PortalId int, PortalWarehouseId int, WarehouseSequenceFirst int, WarehouseSequence int, SKU varchar(200), Quantity numeric(28, 6), ReOrderLevel numeric(28, 6), InventoryId int
		);
		
		SELECT WarehouseId, PortalId, PortalWarehouseId, Precedence
		INTO #PortalWarehouse
		FROM [ZnodePortalWarehouse] WITH (NOLOCK)
		WHERE PortalId = @PortalId
		UNION 
		SELECT WarehouseId, @PortalId AS PortalId, PortalWarehouseId, Precedence
		FROM [dbo].[ZnodePortalAlternateWarehouse] AS zpaw WITH (NOLOCK)
		WHERE EXISTS ( SELECT TOP 1 1 FROM [ZnodePortalWarehouse] AS a WHERE zpaw.PortalWarehouseId = a.PortalWarehouseId AND  a.PortalId = @PortalId)  
		
		INSERT INTO @TBL_AllwareHouseToportal( WarehouseId, PortalId, PortalWarehouseId, SKU, Quantity, ReOrderLevel, InventoryId, WarehouseSequence, WarehouseSequenceFirst )
		SELECT ZPW.WarehouseId, ZPW.PortalId, zpw.PortalWarehouseId, zi.SKU, zi.Quantity, zi.ReOrderLevel, zi.InventoryId, DENSE_RANK() OVER(ORDER BY ZPW.WarehouseId), 1
		FROM dbo.ZnodeInventory AS zi WITH (NOLOCK)
		LEFT JOIN #PortalWarehouse AS ZPW ON ZPW.WarehouseId = ZI.WareHouseId AND  ZPW.PortalId = @PortalId
		WHERE EXISTS ( SELECT TOP 1 1  FROM @TBL_XmlReturnToTable AS TBXRT WHERE RTRIM(LTRIM(TBXRT.SKU)) = RTRIM(LTRIM(zi.SKU))) 
		AND ZPW.WarehouseId IS NOT NULL
		ORDER BY ZPW.Precedence DESC

		--Total Avaialble qunatity in all warehouse 
		IF EXISTS ( SELECT TOP 1 1 FROM @TBL_XmlReturnToTable WHERE InventoryTracking = 'DisablePurchasing')
		BEGIN
			INSERT INTO @TBL_ErrorInventoryTracking 
			SELECT TBAHL.SKU, SUM(TBAHL.Quantity), InventoryTracking,TBXML.AllowBackOrder 
			FROM @TBL_XmlReturnToTable AS TBXML
			LEFT JOIN @TBL_AllwareHouseToportal AS TBAHL ON(TBAHL.SKU = TBXML.SKU) 
			INNER JOIN ZnodeOmsOrderLineItems b on (TBXML.orderlineitemid = b.OmsOrderLineItemsId)
			WHERE InventoryTracking = 'DisablePurchasing'
			AND b.OrderLineItemRelationshipTypeId IS NOT NULL
			GROUP BY TBXML.AllowBackOrder ,TBAHL.SKU, InventoryTracking HAVING SUM(TBAHL.Quantity) < 1 ORDER BY TBAHL.SKU;
			IF EXISTS ( SELECT TOP 1 1 FROM @TBL_ErrorInventoryTracking )
			BEGIN
				SET @Status = 0;
				RAISERROR(15600, -1, -1, 'DisablePurchasing');
			END;
		END;

		---Getting data for simple , configurable and group
		INSERT INTO @TBL_CalculateQuntity
		SELECT WarehouseId, TBXML.SKU, TBAHL.Quantity, TBAHL.InventoryId, TBXML.Quantity, NULL AS UpdatedQuantity, DENSE_RANK() 
		OVER(ORDER BY WarehouseSequenceFirst,WarehouseSequence), InventoryTracking, TBXML.AllowBackOrder
		FROM @TBL_XmlReturnToTable AS TBXML	
		INNER  JOIN @TBL_AllwareHouseToportal AS TBAHL ON(TBAHL.SKU = TBXML.SKU)
		WHERE EXISTS(SELECT * FROM ZnodeOmsOrderLineItems ZOOLI WHERE TBXML.OrderLineItemId = ZOOLI.OmsOrderLineItemsId
			AND ZOOLI.ParentOmsOrderLineItemsId IS NOT NULL) 
		AND isnull(TBXML.OrderLineItemRelationshipTypeId,0) <> (SELECT TOP 1 OrderLineItemRelationshipTypeId FROM ZnodeOmsOrderLineItemRelationshipType WHERE Name IN ('Bundles','Configurable','Group'))
		ORDER BY  WarehouseSequenceFirst,WarehouseSequence;

		---Getting data for bundle products
		INSERT INTO @TBL_CalculateQuntity
		SELECT WarehouseId, TBXML.SKU, TBAHL.Quantity, TBAHL.InventoryId, TBXML.Quantity, NULL AS UpdatedQuantity, DENSE_RANK() 
		OVER(ORDER BY WarehouseSequenceFirst,WarehouseSequence), InventoryTracking, TBXML.AllowBackOrder
		FROM @TBL_XmlReturnToTable AS TBXML	
		INNER  JOIN @TBL_AllwareHouseToportal AS TBAHL ON(TBAHL.SKU = TBXML.SKU)
		WHERE EXISTS(SELECT * FROM ZnodeOmsOrderLineItems ZOOLI where TBXML.OrderLineItemId = ZOOLI.OmsOrderLineItemsId and ZOOLI.ParentOmsOrderLineItemsId is null)
		AND TBXML.OrderLineItemRelationshipTypeId = (SELECT TOP 1 OrderLineItemRelationshipTypeId FROM ZnodeOmsOrderLineItemRelationshipType Where Name IN ('Bundles','Configurable','Group'))
		ORDER BY  WarehouseSequenceFirst,WarehouseSequence;

		;with cte as
		(
			SELECT WarehouseId,	a.SKU,	MainQuantity,	InventoryId,	WarehouseSequenceId,	a.InventoryTracking,	AllowBackOrder,sum(OrderQuantity) as OrderQuantity
			FROM @TBL_CalculateQuntity A
			GROUP BY WarehouseId,	a.SKU,	MainQuantity,	InventoryId,	WarehouseSequenceId,	InventoryTracking,	AllowBackOrder
		)
		UPDATE b set  b.OrderQuantity = a.OrderQuantity
		FROM cte a
		INNER JOIN @TBL_CalculateQuntity b on a.SKU = b.SKU and a.InventoryId = b.InventoryId and a.WarehouseId = b.WarehouseId

		
		UPDATE @TBL_CalculateQuntity 
		SET UpdatedQuantity = MainQuantity - OrderQuantity  
		WHERE WarehouseSequenceId = 1;
		 		
		DECLARE @CountToRepeate int= ( SELECT count( distinct WarehouseId) FROM @TBL_CalculateQuntity),@Initializationofloop int= 2;
       
		WHILE @Initializationofloop <= @CountToRepeate 
				AND EXISTS (SELECT TOP 1 1 FROM @TBL_CalculateQuntity AS a 
					WHERE UpdatedQuantity < 0  )
		BEGIN
		 
			UPDATE a  
			SET a.UpdatedQuantity = a.MainQuantity + b.UpdatedQuantity 
			FROM @TBL_CalculateQuntity a 
			INNER JOIN @TBL_CalculateQuntity b ON (a.Sku = b.Sku AND b.WarehouseSequenceId = (@Initializationofloop - 1)) 
			WHERE a.WarehouseSequenceId = @Initializationofloop 
			AND b.UpdatedQuantity < 0
			AND b.UpdatedQuantity IS NOT NULL 

			UPDATE @TBL_CalculateQuntity 
			SET UpdatedQuantity  = 0 
			WHERE WarehouseSequenceId = @Initializationofloop -1 
			AND UpdatedQuantity < 0
			AND UpdatedQuantity IS NOT NULL 

			SET @Initializationofloop = @Initializationofloop + 1;
		END; 
		
		
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_CalculateQuntity WHERE ISNULL(UpdatedQuantity,0) < 0 AND @CountToRepeate >1)
		BEGIN 
			UPDATE a  
			SET a.UpdatedQuantity = b.UpdatedQuantity 
			FROM @TBL_CalculateQuntity a 
			INNER JOIN @TBL_CalculateQuntity b ON (a.Sku = b.Sku AND b.WarehouseSequenceId = @Initializationofloop -1 ) 
			WHERE a.WarehouseSequenceId = 1 
			AND ISNULL(b.UpdatedQuantity,0) < 0

			UPDATE @TBL_CalculateQuntity 
			SET UpdatedQuantity  = 0 
			WHERE WarehouseSequenceId = @Initializationofloop -1 
			--AND  InventoryTracking <> 'AllowBackordering'
			AND ISNULL(UpdatedQuantity,0) < 0
		END 
			
			
		--If "AllowBackordering" then inventory will go to be negative conside only single warehouse
		IF EXISTS(SELECT TOP 1 1 FROM @TBL_XmlReturnToTable WHERE InventoryTracking = 'AllowBackordering')
		BEGIN
			UPDATE ZI SET Quantity = Isnull(TBCQ.UpdatedQuantity,0) 
			FROM dbo.ZnodeInventory ZI 
			INNER JOIN @TBL_CalculateQuntity TBCQ ON(Zi.InventoryId = TBCQ.InventoryId)
			WHERE InventoryTracking = 'AllowBackordering' AND  UpdatedQuantity IS NOT NULL  ;
			SET @Status = 1;
		END;
		
		-- If @InventoryTracking is "DisablePurchasing" then subtracts currently selected quantity only when it will greater than zero.
		IF EXISTS ( SELECT TOP 1 1 FROM @TBL_XmlReturnToTable WHERE InventoryTracking = 'DisablePurchasing')
		BEGIN
			SET @BalanceQuantity = 1;
			UPDATE ZI 
			SET Quantity = CASE WHEN TBCQ.UpdatedQuantity < 0 THEN 0 ELSE TBCQ.UpdatedQuantity END 
			FROM dbo.ZnodeInventory ZI 
			INNER JOIN  @TBL_CalculateQuntity TBCQ ON(Zi.InventoryId = TBCQ.InventoryId) WHERE InventoryTracking = 'DisablePurchasing'
			AND TBCQ.UpdatedQuantity IS NOT NULL 
			;
		END;
		
		INSERT INTO ZnodeOmsOrderWarehouse( OmsOrderLineItemsId, WarehouseId,Quantity, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate )
		SELECT OrderLineItemId, WarehouseId,CASE WHEN UpdatedQuantity = 0 THEN MainQuantity ELSE MainQuantity - UpdatedQuantity END , @UserId, dbo.Fn_GetDate(), @UserId, dbo.Fn_GetDate() 
		FROM @TBL_CalculateQuntity AS TBCQ 
		INNER JOIN @TBL_XmlReturnToTable AS TBXR
			   ON(TBXR.SKU = TBCQ.SKU) WHERE UpdatedQuantity IS NOT NULL;
  
		SELECT DISTINCT SKU,
		 [dbo].[Fn_GetDefaultPriceRoundOffReturnNumeric](UpdatedQuantity) AS Quantity,
		  InventoryTracking,CAST(AllowBackOrder AS BIT) AllowBackOrder
		FROM @TBL_CalculateQuntity
		WHERE UpdatedQuantity IS NOT NULL;

		SET @Status = 1;
		COMMIT TRAN UpdateInventory;
	END TRY
	BEGIN CATCH
	
		SET @Status = 0;
		SELECT SKU, Quantity, InventoryTracking,AllowBackOrder
		FROM @TBL_ErrorInventoryTracking;
		
		ROLLBACK TRAN UpdateInventory;
	END CATCH;
END;

GO


IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_SetPublishContentContainerGlobalAttributeEntity')
	DROP PROC Znode_SetPublishContentContainerGlobalAttributeEntity
GO

CREATE PROCEDURE [dbo].[Znode_SetPublishContentContainerGlobalAttributeEntity]
(
	 @ContainerKey VARCHAR(50) = ''
	 ,@ContainerProfileVariantId INT = 0
)
AS
    
/*
exec [Znode_SetPublishContentContainerGlobalAttributeEntity] @ContainerKey = 'HomePagePromo', @ContainerProfileVariantId = 0
    Summary :	Publish Product on the basis of publish catalog
				Retrive all Product details with attributes and INSERT INTO following tables 
				1.	ZnodePublishedXml
				2.	ZnodePublishCategoryProduct
				3.	ZnodePublishProduct
				4.	ZnodePublishProductDetail

                Product details include all the type of products link, grouped, configure and bundel products (include addon) their associated products 
				collect their attributes and values into tables variables to process for publish.  
                
				Finally genrate XML for products with their attributes and inserted into ZnodePublishedXml Znode Admin process xml from sql server to mongodb
				one by one.

 */

BEGIN
	
	BEGIN TRY
		SET NOCOUNT ON;
		DECLARE @VersionId Int, @CMSContentContainerId int
		--SET @VersionId = ( SELECT TOP 1 VersionId FROM ZnodePublishContetContainerVersionEntity WHERE PublishState = @RevisionState )

		DECLARE @SetLocaleId INT, @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleId(), @MaxCount INT =0 , @IncrementalId INT = 1;
		DECLARE @TBL_Locale TABLE (LocaleId INT , RowId INT IDENTITY(1,1));

		DECLARE @V_MediaServerThumbnailPath VARCHAR(4000);
          SET @V_MediaServerThumbnailPath =
         (
             SELECT ISNULL(CASE WHEN CDNURL = '' THEN NULL ELSE CDNURL END,URL) 
             FROM ZnodeMediaConfiguration ZMC 
			 --INNER JOIN ZnodeMediaServerMaster ZMSM ON (ZMSM.MediaServerMasterId = ZMC.MediaServerMasterId)
		     WHERE IsActive = 1 
         );
	
		DECLARE @TBL_GlobalAttributeGrouplist TABLE ([GlobalAttributeGroupId] INT , [AttributeGroupDisplayOrder] INT,Groups int )
		DECLARE @TBL_GlobalAttributelist      TABLE ([GlobalAttributeGroupId] INT , [GlobalAttributeId] INT,[AttributeDisplayOrder] int ,Attributes int )
		Declare	@EntityAttributeValueList as	table
		(
			IsInput bit, IsMedia BIT, AttributeValues int,WidgetGlobalAttributeValueId int,GlobalAttributeId int,AttributeValue nvarchar(max),
			GlobalAttributeValueId int,GlobalAttributeDefaultValueId int,AttributeDefaultValueCode nvarchar(300),
			AttributeDefaultValue nvarchar(300),MediaId int,MediaPath nvarchar(300) ,SwatchText nvarchar(300),DisplayOrder int,
			SingleAttributeValue nvarchar(max), CMSContainerProfileVariantId INT,LocaleId INT
		)
		Declare	@EntityAttributeSingleValueList as table(AttributeValues int,PortalGlobalAttributeValueId int,GlobalAttributeId int)

		Declare @LocaleId INT , @GetDate DATETIME =dbo.Fn_GetDate()

		IF @ContainerKey <> ''
		BEGIN
			Select @CMSContentContainerId= CMSContentContainerId 
			from ZnodeCMSContentContainer  
			WHERE ContainerKey = @ContainerKey
		END

		INSERT INTO @EntityAttributeValueList
		(
			IsInput, IsMedia,AttributeValues,WidgetGlobalAttributeValueId,GlobalAttributeId,GlobalAttributeValueId,GlobalAttributeDefaultValueId,
			AttributeValue ,MediaId,MediaPath,SingleAttributeValue,CMSContainerProfileVariantId, LocaleId
		)
		Select case when zga.GroupAttributeType in('Input','TextArea')   then 1  else 0 end ,
				0, 1, aa.WidgetGlobalAttributeValueId,aa.GlobalAttributeId,aa.WidgetGlobalAttributeValueId,bb.GlobalAttributeDefaultValueId,

			case when zga.GroupAttributeType in('Input','TextArea')   then null  else  bb.AttributeValue  end AttributeValue,	  
			bb.MediaId,CASE WHEN bb.MediaPath IS NOT NULL THEN @V_MediaServerThumbnailPath+bb.MediaPath ELSE bb.MediaPath END AS MediaPath ,
			case when zga.GroupAttributeType in('Input','TextArea')   then bb.AttributeValue   else null end  SingleAttributeValue,
			aa.CMSContainerProfileVariantId, bb.LocaleId
		FROM ZnodeWidgetGlobalAttributeValue aa
		INNER JOIN ZnodeWidgetGlobalAttributeValueLocale bb ON bb.WidgetGlobalAttributeValueId = aa.WidgetGlobalAttributeValueId 
		INNER JOIN View_ZnodeGlobalAttribute zga on zga.[GlobalAttributeId]=aa.[GlobalAttributeId]
		WHERE (aa.CMSContainerProfileVariantId = @ContainerProfileVariantId OR @ContainerProfileVariantId = 0)
		AND (AA.CMSContentContainerId = @CMSContentContainerId OR ISNULL(@CMSContentContainerId,0) = 0 )
		AND bb.MediaId IS NULL 
				

		INSERT INTO @EntityAttributeValueList
		(IsInput,IsMedia,AttributeValues,WidgetGlobalAttributeValueId,GlobalAttributeId,GlobalAttributeValueId,GlobalAttributeDefaultValueId,AttributeValue ,MediaId,MediaPath,SingleAttributeValue,CMSContainerProfileVariantId,LocaleId)
		Select 1,1 ,1, aa.WidgetGlobalAttributeValueId,aa.GlobalAttributeId,aa.WidgetGlobalAttributeValueId,null GlobalAttributeDefaultValueId,
			NULL AttributeValue,	  
			NULL MediaId,null MediaPath,
			NULL SingleAttributeValue, aa.CMSContainerProfileVariantId	,bb.LocaleId
		FROM dbo.ZnodeWidgetGlobalAttributeValue aa
		INNER JOIN ZnodeWidgetGlobalAttributeValueLocale bb ON bb.WidgetGlobalAttributeValueId = aa.WidgetGlobalAttributeValueId 
		INNER JOIN View_ZnodeGlobalAttribute zga on zga.[GlobalAttributeId]=aa.[GlobalAttributeId]
		WHERE (AA.CMSContentContainerId = @CMSContentContainerId OR ISNULL(@CMSContentContainerId,0) = 0 )
		AND zga.GroupAttributeType ='Media'

		UPDATE aa
		Set SingleAttributeValue= ( Select CASE WHEN bb.MediaPath IS NOT NULL THEN @V_MediaServerThumbnailPath+bb.MediaPath ELSE bb.MediaPath END AS MediaPath FROM  ZnodeWidgetGlobalAttributeValueLocale bb 
			WHERE bb.WidgetGlobalAttributeValueId = aa.WidgetGlobalAttributeValueId AND aa.LocaleId = bb.LocaleId
			FOR XML PATH ('') )				
		FROM  @EntityAttributeValueList aa
		WHERE aa.IsMedia=1

		UPDATE aa
		Set SingleAttributeValue= replace(replace(SingleAttributeValue,'</MediaPath>',','),'<MediaPath>','')
		FROM  @EntityAttributeValueList aa
		WHERE aa.IsMedia=1

		UPDATE aa
		Set SingleAttributeValue= Substring(SingleAttributeValue,1,len(SingleAttributeValue)-1)
		FROM  @EntityAttributeValueList aa
		WHERE aa.IsMedia=1

		UPDATE aa
		SET AttributeDefaultValueCode= h.AttributeDefaultValueCode,
			SwatchText=h.SwatchText,
			AttributeValue=g.AttributeDefaultValue,
			GlobalAttributeDefaultValueId=g.GlobalAttributeDefaultValueId,
			DisplayOrder=h.DisplayOrder
		FROM  @EntityAttributeValueList aa
		INNER JOIN dbo.ZnodeGlobalAttributeDefaultValue h ON h.GlobalAttributeDefaultValueId = aa.GlobalAttributeDefaultValueId                                       
		INNER JOIN dbo.ZnodeGlobalAttributeDefaultValueLocale g ON h.GlobalAttributeDefaultValueId = g.GlobalAttributeDefaultValueId and aa.LocaleId = g.LocaleId
          
		INSERT INTO @TBL_GlobalAttributeGrouplist
		([GlobalAttributeGroupId] , [AttributeGroupDisplayOrder],Groups )
		SELECT ss.[GlobalAttributeGroupId],ss.[AttributeGroupDisplayOrder],1
		FROM [dbo].[ZnodeGlobalGroupEntityMapper] SS
		INNER JOIN dbo.ZnodeGlobalEntity aa on ss.[GlobalEntityId]=aa.[GlobalEntityId]
		WHERE aa.EntityName='Content Containers'
		--FOR XML PATH('')

		INSERT INTO @TBL_GlobalAttributelist
		([GlobalAttributeGroupId] , [GlobalAttributeId],[AttributeDisplayOrder],Attributes )
		SELECT aa.[GlobalAttributeGroupId],aa.[GlobalAttributeId] ,aa.[AttributeDisplayOrder],1
		FROM [dbo].[ZnodeGlobalAttributeGroupMapper] aa
		INNER JOIN @TBL_GlobalAttributeGrouplist ss on ss.GlobalAttributeGroupId=aa.GlobalAttributeGroupId
			
		IF object_id('tempdb..[#GlobalAttributeGrouplist]') IS NOT NULL
			drop table tempdb..#GlobalAttributeGrouplist

		CREATE TABLE #GlobalAttributeGrouplist 
		( 
			CMSContainerProfileVariantId INT,LocaleId	int,GlobalAttributeGroupId	int	,GroupCode	varchar	(200),AttributeGroupName nvarchar(600),AttributeGroupDisplayOrder int,
			GlobalAttributeId	int	,AttributeDisplayOrder	int	,AttributeCode	nvarchar	(600),AttributeName	nvarchar	(600),IsRequired	bit	,
			AttributeTypeName	varchar	(300),AttributeTypeId	int	,SingleAttributeValue	nvarchar(max),SelectValues	nvarchar(max)
		)

		SET @LocaleId = 0 

		INSERT INTO @TBL_Locale (LocaleId) 
		SELECT LocaleId FROM ZnodeLocale WHERE IsActive =1 AND (LocaleId  = @LocaleId OR @LocaleId = 0 )

		SET @MaxCount = ISNULL((SELECT MAx(RowId) FROM @TBL_Locale),0)
		WHILE @IncrementalId <= @MaxCount
		BEGIN 
			SET @SetLocaleId = (SELECT Top 1 LocaleId FROM @TBL_locale WHERE RowId = @IncrementalId)
			;With Cte_GetCmsContentContainerData AS 
			(
			Select distinct @SetLocaleId AS LocaleId, sv.CMSContainerProfileVariantId,
				aa.[GlobalAttributeGroupId] AS 'GlobalAttributeGroupId' ,
				zgag.GroupCode	AS 'GroupCode'		 ,  
				zgagl.AttributeGroupName  AS 'AttributeGroupName'   ,
				AttributeGroupDisplayOrder 	 , 
				ss.GlobalAttributeId	 AS 'GlobalAttributeId'	 ,
				ss.[AttributeDisplayOrder] AS 'AttributeDisplayOrder'	,
				zga.AttributeCode AS 'AttributeCode'	,			
				zgal.AttributeName AS 'AttributeName'	,
				zga.IsRequired AS 'IsRequired'	,
				zga.AttributeTypeName AS 'AttributeTypeName'      ,
				zga.AttributeTypeId AS 'AttributeTypeId' 		,
				sv.SingleAttributeValue AS 'SingleAttributeValue'	,	
	   
				( Select 
				SelectValuesEntity.DisplayOrder					as DisplayOrder,
				SelectValuesEntity.GlobalAttributeDefaultValueId as GlobalAttributeDefaultValueId,
				SelectValuesEntity.AttributeValue				as [Value]	,
				SelectValuesEntity.AttributeDefaultValueCode		as Code	,
				SelectValuesEntity.SwatchText                    as SwatchText	,
				SelectValuesEntity.MediaPath		         		as [Path]	
				FROM  @EntityAttributeValueList SelectValuesEntity 
				WHERE SelectValuesEntity.WidgetGlobalAttributeValueId = sv.WidgetGlobalAttributeValueId
				and SelectValuesEntity.LocaleId = sv.LocaleId and 
				zga.GroupAttributeType ='Select'
				FOR JSON Auto, INCLUDE_NULL_VALUES    
				)  as 'SelectValues'
			FROM 
				@TBL_GlobalAttributeGrouplist aa				
				INNER JOIN @TBL_GlobalAttributelist ss on  ss.GlobalAttributeGroupId=aa.GlobalAttributeGroupId
				INNER JOIN ZnodeGlobalAttributeGroup zgag on zgag.[GlobalAttributeGroupId]=aa.[GlobalAttributeGroupId]
				INNER JOIN ZnodeGlobalAttributeGroupLocale zgagl on zgagl.GlobalAttributeGroupId=zgag.GlobalAttributeGroupId
				INNER JOIN View_ZnodeGlobalAttribute zga       on zga.[GlobalAttributeId]=ss.[GlobalAttributeId]
				INNER JOIN ZnodeGlobalAttributeLocale zgal on zga.[GlobalAttributeId]=zgal.[GlobalAttributeId]
				INNER JOIN @EntityAttributeValueList sv   on sv.[GlobalAttributeId]=ss.[GlobalAttributeId]
				WHERE zgagl.LocaleId= zgal.LocaleId and 
				(sv.LocaleId = @SetLocaleId)  
			)
	     	, Cte_GetFirstFilterData AS
			(
				SELECT CMSContainerProfileVariantId,LocaleId,GlobalAttributeGroupId,GroupCode,AttributeGroupName,AttributeGroupDisplayOrder,
						GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName,IsRequired,AttributeTypeName,
						AttributeTypeId,SingleAttributeValue,SelectValues
				FROM Cte_GetCmsContentContainerData 
				WHERE LocaleId = @SetLocaleId
			)
			, Cte_GetDefaultFilterData AS
			(
				SELECT CMSContainerProfileVariantId,LocaleId,GlobalAttributeGroupId,GroupCode,AttributeGroupName,AttributeGroupDisplayOrder,
						GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName,IsRequired,AttributeTypeName,
						AttributeTypeId,SingleAttributeValue,SelectValues
				FROM  Cte_GetFirstFilterData 
				UNION ALL 
				SELECT CMSContainerProfileVariantId,LocaleId,GlobalAttributeGroupId,GroupCode,AttributeGroupName,AttributeGroupDisplayOrder,
						GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName,IsRequired,AttributeTypeName,
						AttributeTypeId,SingleAttributeValue,SelectValues
				FROM Cte_GetCmsContentContainerData CTEC 
				WHERE LocaleId = @DefaultLocaleId 
				AND NOT EXISTS (SELECT TOP 1 1 FROM Cte_GetFirstFilterData CTEFD WHERE CTEFD.GlobalAttributeGroupId = CTEC.GlobalAttributeGroupId )
			)
			INSERT INTO #GlobalAttributeGrouplist 
			(
				CMSContainerProfileVariantId,LocaleId,GlobalAttributeGroupId,GroupCode,AttributeGroupName,AttributeGroupDisplayOrder,
				GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName,IsRequired,AttributeTypeName,
				AttributeTypeId,SingleAttributeValue,SelectValues
			)
			SELECT DISTINCT CMSContainerProfileVariantId,@SetLocaleId,GlobalAttributeGroupId,GroupCode,AttributeGroupName,AttributeGroupDisplayOrder,
					GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName,IsRequired,AttributeTypeName,
					AttributeTypeId,SingleAttributeValue,SelectValues
			FROM Cte_GetDefaultFilterData
						
				SET @IncrementalId = @IncrementalId +1 
		End 
		--select * into ##GlobalAttributeGrouplist from #GlobalAttributeGrouplist
	--select distinct CMSContainerProfileVariantId,GlobalAttributeGroupId,GroupCode,AttributeGroupName,AttributeGroupDisplayOrder,LocaleId 
	--into #GroupMaster from #GlobalAttributeGrouplist
	
	--If (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  ) 
	--Begin
	--    --Data inserted into flat table ZnodePublishWidgetSliderBannerEntity (Replica of MongoDB Collection )  

	--	Delete from ZnodePublishContentContainerVariantEntity WHERE  VersionId = @VersionId
	 		 

	--	INSERT INTO ZnodePublishPortalGlobalAttributeEntity
	--	(
	--		VersionId,PublishStartTime,PortalId,PortalName,LocaleId,GlobalAttributeGroups
	--	)
	  	
			--Select Distinct PV.CMSContainerProfileVariantId,PV.LocaleId,  (Select 
			--A.GlobalAttributeGroupId AS 'GlobalAttributeGroupId',
			--A.GroupCode AS 'GroupCode',
			--A.AttributeGroupName AS 'AttributeGroupName',
			--A.AttributeGroupDisplayOrder AS 'AttributeGroupDisplayOrder',
			--A.LocaleId AS 'LocaleId', 
			--(
			--	Select DISTINCT GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName ,IsRequired ,	
			--	AttributeTypeName,AttributeTypeId,SingleAttributeValue,SelectValues 
			--	from #GlobalAttributeGrouplist B WHERE A.GlobalAttributeGroupId = B.GlobalAttributeGroupId 
			--	AND A.LocaleId = B.LocaleId AND A.CMSContainerProfileVariantId = B.CMSContainerProfileVariantId
			--	For JSON Path 
			--) AS 'GlobalAttributes'
			--from #GlobalAttributeGrouplist A WHERE A.CMSContainerProfileVariantId = PV.CMSContainerProfileVariantId AND A.LocaleId = PV.LocaleId For Json Path) GlobalAttributes
			--FROM  #GlobalAttributeGrouplist  PV 

			SELECT DISTINCT A.CMSContainerProfileVariantId,A.LocaleId,  
			REPLACE((
				SELECT DISTINCT GlobalAttributeGroupId, GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName ,IsRequired ,	
				AttributeTypeName,AttributeTypeId,SingleAttributeValue As AttributeValue,SelectValues 
				FROM #GlobalAttributeGrouplist B
				WHERE A.GlobalAttributeGroupId = B.GlobalAttributeGroupId 
				AND A.LocaleId = B.LocaleId AND A.CMSContainerProfileVariantId = B.CMSContainerProfileVariantId
				--AND GlobalAttributeId=32 and A.GlobalAttributeGroupId=23
				For JSON Path 
			),'\','') AS 'GlobalAttributes'
			FROM #GlobalAttributeGrouplist  A
	--End
	---------------------------- End Preview 
	--If (@RevisionState like '%Production%' OR @RevisionState = 'None')
	--Begin
	--	-- Only production version id will process 
	--	Delete from ZnodePublishPortalGlobalAttributeEntity WHERE  VersionId in (Select ProductionVersionId from @Tbl_ProductionVersionId)
	--	AND PortalId = @PortalId
	 		 

	--	INSERT INTO ZnodePublishPortalGlobalAttributeEntity
	--	(
	--		VersionId,PublishStartTime,PortalId,PortalName,LocaleId,GlobalAttributeGroups
	--	)
			  	
	--		Select Distinct PV.ProductionVersionId, Getdate(),  @PortalId,@StoreName, PV.LocaleId, (Select 
	--		A.GlobalAttributeGroupId AS 'GlobalAttributeGroupId',
	--		A.GroupCode AS 'GroupCode',
	--		A.AttributeGroupName AS 'AttributeGroupName',
	--		A.AttributeGroupDisplayOrder AS 'AttributeGroupDisplayOrder',
	--		A.LocaleId AS 'LocaleId', 
	--		(
	--			Select GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName ,IsRequired ,	
	--			AttributeTypeName,AttributeTypeId,SingleAttributeValue,SelectValues 
	--			from #GlobalAttributeGrouplist B WHERE A.GlobalAttributeGroupId = B.GlobalAttributeGroupId 
	--			AND A.LocaleId = B.LocaleId
	--			For JSON Path 
	--		) AS 'GlobalAttributes'
	--		from #GroupMaster A  WHERE A.LocaleId = PV.LocaleId  For Json Path) 
	--		FROM  @Tbl_ProductionVersionId  PV 

	--End

END TRY
BEGIN CATCH
	SELECT ERROR_MESSAGE(), ERROR_PROCEDURE();

END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportValidatePimProductData')
	DROP PROC Znode_ImportValidatePimProductData
GO


CREATE PROCEDURE [dbo].[Znode_ImportValidatePimProductData]
(   @ImportHeadName     VARCHAR(200),
    @TableName          VARCHAR(200),
    @NewGUID            NVARCHAR(200),
    @TemplateId         INT,
    @UserId             INT,
    @LocaleId           INT           = 1,
    @IsCategory         INT           = 0,
    @DefaultFamilyId    INT           = 0,
    @ImportProcessLogId INT,
    @PriceListId        INT,
	@CountryCode VARCHAR(100) = '',
	@PimCatalogId         INT    = 0 ,
	@PortalId int = 0,
	@IsAccountAddress bit = 0 )
AS
     SET NOCOUNT ON;

/*
    Summary :   Import PimProduct / Price / Inventory / Category / Category Associated Data 
    Process :   Admin site will upload excel / csv file in database and create global temporary table
				Procedure Znode_ImportValidatePimProductData will validate data with attribute validation rule
				If datatype validation issue found in input daata will logged into table "ZnodeImportLog"
				If Data is correct and record count in table ZnodeImportLog will be 0 then process for import data into Base tables
				To import data call procedure "Znode_ImportPimProductData"
    		  
				SourceColumnName: CSV file column headers
				TargetColumnName: Attributecode from ZnodePimAttribute Table (Consider those Attributecodes configured with default family only)
*/

     BEGIN
         BEGIN TRY
             SET NOCOUNT ON;
             --BEGIN TRAN TRN_ImportValidProductData;
             DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
             DECLARE @SQLQuery NVARCHAR(MAX), @AttributeTypeName NVARCHAR(100), @AttributeCode NVARCHAR(300), @AttributeId INT, @IsRequired BIT, @SourceColumnName NVARCHAR(600), @ControlName VARCHAR(300), @ValidationName VARCHAR(100), @SubValidationName VARCHAR(300), @ValidationValue VARCHAR(300), @RegExp VARCHAR(300), @CreateDateString NVARCHAR(300), @DefaultLocaleId INT, @ImportHeadId INT, @CheckedSourceColumn NVARCHAR(600)= '', @Status BIT= 0,
			    @CsvColumnString nvarchar(max),
				@FailedRecordCount BIGINT,
				@SuccessRecordCount BIGINT
            --To get the total record count for update purpose in catch block
            SET @SQLQuery = 'SELECT '+CAST(@ImportProcessLogId AS VARCHAR(10))+',COUNT(*) FROM '+@TableName
			INSERT INTO Znode_ImportCsvRowCount
			EXEC (@SQLQuery) 

             DECLARE @FamilyAttributeDetail TABLE
             (PimAttributeId       INT,
              AttributeTypeName    VARCHAR(300),
              AttributeCode        VARCHAR(300),
              SourceColumnName     NVARCHAR(600),
              IsRequired           BIT,
              PimAttributeFamilyId INT
             );
             DECLARE @AttributeDetail TABLE
             (PimAttributeId    INT,
              AttributeTypeName VARCHAR(300),
              AttributeCode     VARCHAR(300),
              SourceColumnName  NVARCHAR(600),
              IsRequired        BIT,
              ControlName       VARCHAR(300),
              ValidationName    VARCHAR(100),
              SubValidationName VARCHAR(300),
              ValidationValue   VARCHAR(300),
              RegExp            VARCHAR(300)
             );

			CREATE TABLE #DefaultAttributeCode
			(AttributeTypeName          VARCHAR(300),
			PimAttributeDefaultValueId INT,
			PimAttributeId             INT,
			AttributeDefaultValueCode  VARCHAR(100)
			);

			IF( @ImportHeadName = 'B2BCustomer' )
			BEGIN
				EXEC ZnodeB2BCustomerMapping @ImportHeadName = @ImportHeadName, @TableName = @TableName
			END
		
             DECLARE @GlobalTempTableColumns TABLE(ColumnName NVARCHAR);
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM INFORMATION_SCHEMA.TABLES
                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#InvalidDefaultData'
             )
                 CREATE TABLE #InvalidDefaultData
                 (RowNumber  INT,
                  Value      NVARCHAR(MAX),
                  ColumnName NVARCHAR(600)
                 );
             ELSE
             DROP TABLE #InvalidDefaultData;
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM INFORMATION_SCHEMA.TABLES
                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#GlobalTempTableColumns'
             )
                 BEGIN

                     SET @SQLQuery = 'SELECT Column_Name, '''+@ImportHeadName+''' AS ImportHeadName  from tempdb.INFORMATION_SCHEMA.COLUMNS	where table_name = object_name(object_id('''+@TableName+'''),
					(select database_id from sys.databases where name = ''tempdb''))';
                     CREATE TABLE #GlobalTempTableColumns
                     (ColumnName   NVARCHAR(MAX),
                      TypeOfImport NVARCHAR(100)
                     );
                     INSERT INTO #GlobalTempTableColumns
                     (ColumnName,
                      TypeOfImport
                     )
                     EXEC sys.sp_sqlexec
                          @SQLQuery;
                 END;

             IF EXISTS
             (
                 SELECT TOP 1 1
                 FROM #GlobalTempTableColumns
                 WHERE ColumnName IN('PimCategoryId', 'PimProductId', 'RowNumber')
             )
                 BEGIN
                     INSERT INTO ZnodeImportLog
                     (ErrorDescription,
                      ColumnName,
                      Data,
                      GUID,
                      CreatedBy,
                      CreatedDate,
                      ModifiedBy,
                      ModifiedDate,
                      ImportProcessLogId
                     )
                     VALUES
                     (43,
                      '',
                      '',
                      @newGUID,
                      @UserId,
                      @GetDate,
                      @UserId,
                      @GetDate,
                      @ImportProcessLogId
                     );
                 END;
             SET @DefaultLocaleId = dbo.Fn_GetDefaultLocaleId();

             IF NOT EXISTS
             (
                 SELECT TOP 1 1  FROM ZnodeImportLog
                 WHERE Guid = @NewGUID
                       AND ErrorDescription IN(43, 42)
                 AND ImportProcessLogId = @ImportProcessLogId
             )
                 BEGIN
                     IF @ImportHeadName = 'Product'
                      BEGIN
						  IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
							  SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimProductId int null ';
						  ELSE 
							 SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimProductId int null Primary KEY CLUSTERED(RowNumber)';
						 
						  EXEC sys.sp_sqlexec @SQLQuery;
			         END;
                     ELSE
                     IF @ImportHeadName = 'Category'
                         BEGIN
							  IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimCategoryId int null ';
							  ElSE
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimCategoryId int null Primary KEY CLUSTERED(RowNumber) ';
						  
							  EXEC sys.sp_sqlexec @SQLQuery;
                         END;
                     ELSE
                         BEGIN
							IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1) ';
							Else 
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1) Primary KEY CLUSTERED(RowNumber)';
							
							EXEC sys.sp_sqlexec @SQLQuery;
                         END;;
                 END;

             SET @CreateDateString = CONVERT(VARCHAR(100), @UserId)+','''+CONVERT(VARCHAR(100), @GetDate)+''','+CONVERT(VARCHAR(100), @UserId)+','''+CONVERT(VARCHAR(100), @GetDate)+''', '+CONVERT(VARCHAR(100), @ImportProcessLogId);

             SELECT TOP 1 @ImportHeadId = ImportHeadId FROM ZnodeImportTemplate WHERE ImportTemplateId = @TemplateId;
             IF @DefaultFamilyId = 0
                AND @ImportHeadName IN('Product', 'Category')
                 BEGIN 
                     --Get all default attribute values in attribute 
                     INSERT INTO @FamilyAttributeDetail
                     (PimAttributeId,
                      AttributeTypeName,
                      AttributeCode,
                      SourceColumnName,
                      IsRequired,
                      PimAttributeFamilyId
                     )
                     --Call Process to insert data of defeult family with source column name and target column name 
                     EXEC Znode_ImportGetTemplateDetails
                          @TemplateId = @TemplateId,
                          @IsValidationRules = 0,
                          @IsIncludeRespectiveFamily = 1,
                          @IsCategory = @IsCategory,
                          @DefaultFamilyId = @DefaultFamilyId;

					---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;
             ELSE
             IF @ImportHeadName IN('Product', 'Category')
                 BEGIN
				 
                     --Get all default attribute values in attribute 
                     INSERT INTO @FamilyAttributeDetail
                     (PimAttributeId,
                      AttributeTypeName,
                      AttributeCode,
                      SourceColumnName,
                      IsRequired,
                      PimAttributeFamilyId
                     )
                     --Call Process to insert data of defeult family with source column name and target column name 
                     EXEC Znode_ImportGetTemplateDetails
                          @TemplateId = @TemplateId,
                          @IsValidationRules = 0,
                          @IsIncludeRespectiveFamily = 1,
                          @IsCategory = @IsCategory,
                          @DefaultFamilyId = @DefaultFamilyId;

					---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;      
             -- Check attributes are manditory and not provided with source table
		   	 
			if @TABLENAME	like '%tempdb..%'
				SET @SQLQuery = 'SELECT 42 AS ErrorDescription , SourceColumnName , '''' , '''+@NewGUID+''','+@CreateDateString+' from ZnodeImportTemplateMapping where ImportTemplateId = '+CONVERT(VARCHAR(100), @TemplateId)+' and ltrim(rtrim(SourceColumnName)) <> '''' AND ltrim(rtrim(SourceColumnName)) not in ( select isnull(Name ,'''') from tempdb.sys.columns where object_id = object_id('''+@TABLENAME+'''));';
			else 
				SET @SQLQuery = 'SELECT 42 AS ErrorDescription , SourceColumnName , '''' , '''+@NewGUID+''','+@CreateDateString+' from ZnodeImportTemplateMapping where ImportTemplateId = '+CONVERT(VARCHAR(100), @TemplateId)+' and ltrim(rtrim(SourceColumnName)) <> '''' AND ltrim(rtrim(SourceColumnName)) not in ( select isnull(Name ,'''') from sys.columns where object_id = object_id('''+@TABLENAME+'''));';
		 
			Declare @Tbl_CsvDynamicColulmns TABLE (ColumnName nvarchar(300), SequenceNumber int, DataType nvarchar(50),IsRequired bit )

			INSERT INTO @Tbl_CsvDynamicColulmns(ColumnName , SequenceNumber , DataType ,IsRequired)
			SELECT DISTINCT ZITM.SourceColumnName ,ZIAV.SequenceNumber, ZIAV.AttributeTypeName, ZIAV.IsRequired
			FROM ZnodeImportAttributeValidation ZIAV LEFT OUTER JOIN 
			ZnodeImportTemplate  ZIT ON ZIT.ImportHeadId =  ZIAV.ImportHeadId AND ZIT.ImportTemplateId  = @TemplateId
			LEFT OUTER JOIN ZnodeImportTemplateMapping  ZITM ON ZITM.ImportTemplateId = ZIT.ImportTemplateId  
			and ZIAV.AttributeCode = ZITM.TargetColumnName
			AND ZITM.ImportTemplateId  = @TemplateId
			WHERE ZIAV.ImportHeadId = @ImportHeadId --ORDER BY ZIAV.SequenceNumber


		    SELECT @CsvColumnString = SUBSTRING ((Select ',' +  ISNULL(ColumnName ,'NULL') from @Tbl_CsvDynamicColulmns ORDER BY SequenceNumber FOR XML PATH ('')),2,4000) 


     		INSERT INTO ZnodeImportLog(ErrorDescription, ColumnName, Data, GUID,CreatedBy, CreatedDate,  ModifiedBy,ModifiedDate,ImportProcessLogId
             )
             EXEC sys.sp_sqlexec  @SQLQuery;
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM ZnodeImportLog
                 WHERE Guid = @NewGUID
                       AND ErrorDescription IN(43, 42)
                 AND ImportProcessLogId = @ImportProcessLogId
             )
                 BEGIN
                     --Get all default attribute values in attribute 
                     IF @ImportHeadName IN('Product', 'Category')
                         BEGIN
                             -- Check attributes are manditory and not provided with source table
                             INSERT INTO ZnodeImportLog
                             (ErrorDescription,
                              ColumnName,
                              Data,
                              GUID,
                              CreatedBy,
                              CreatedDate,
                              ModifiedBy,
                              ModifiedDate,
                              ImportProcessLogId
                             )
                                    SELECT '14' AS ErrorDescription,
                                           AttributeCode,
                                           '',
                                           @NewGUID,
                                           @UserId,
                                           @GetDate,
                                           @UserId,
                                           @GetDate,
                                           @ImportProcessLogId
                                    FROM @FamilyAttributeDetail
                                    WHERE ISNULL(SourceColumnName, '') = ''
                                          AND IsRequired = 1;  

                             -- Read all attribute details with their datatype
                             INSERT INTO @AttributeDetail
                             (PimAttributeId,
                              AttributeTypeName,
                              AttributeCode,
                              SourceColumnName,
                              IsRequired,
                              ControlName,
                              ValidationName,
                              SubValidationName,
                              ValidationValue,
                              RegExp
                             )
                             EXEC Znode_ImportGetTemplateDetails
                                  @TemplateId=@TemplateId,
								  @DefaultFamilyId=@DefaultFamilyId;

							---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
							Delete FAD from @AttributeDetail FAD
							where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
							and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
										   inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode) 

                             DELETE FROM @AttributeDetail
                             WHERE AttributeTypeName = 'Image'
                                   AND ValidationName <> 'IsAllowMultiUpload';
							DELETE FROM @AttributeDetail
                             WHERE AttributeTypeName = 'File'
                                   AND ValidationName <> 'IsAllowMultiUpload';

                                     INSERT INTO #DefaultAttributeCode
                                     (AttributeTypeName,
                                      PimAttributeDefaultValueId,
                                      PimAttributeId,
                                      AttributeDefaultValueCode
                                     )
                                     --Call Process to insert default data value 
                                     EXEC Znode_ImportGetPimAttributeDefaultValue;

                                     DELETE FROM #DefaultAttributeCode
                                     WHERE AttributeTypeName = 'Yes/No';

                         END;
                     ELSE
                         BEGIN
					
					
                             --Read all attribute details with their datatype
                             INSERT INTO @AttributeDetail
                             (AttributeTypeName,
                              AttributeCode,
                              SourceColumnName,
                              IsRequired,
                              ControlName,
                              ValidationName,
                              SubValidationName,
                              ValidationValue,
                              RegExp
                             )
                             EXEC [Znode_ImportGetOtherTemplateDetails]
                                  @TemplateId = @TemplateId,
                                  @ImportHeadId = @ImportHeadId;

							IF @ImportHeadName IN('B2BCustomer')
							BEGIN

								INSERT INTO @AttributeDetail
								 (PimAttributeId,
								 AttributeTypeName,
								  AttributeCode,
								  SourceColumnName,
								  IsRequired,
								  ControlName,
								  ValidationName,
								  SubValidationName,
								  ValidationValue,
								  RegExp
								 )
								 EXEC [Znode_ImportGetGlobalTemplateDetails]
									  @TemplateId = @TemplateId,
									  @ImportHeadId = @ImportHeadId;

								
								INSERT INTO #DefaultAttributeCode
								(AttributeTypeName,
								PimAttributeDefaultValueId,
								PimAttributeId,
								AttributeDefaultValueCode
								)
								--Call Process to insert default data value 
								EXEC Znode_ImportGetGlobalAttributeDefaultValue;

								DELETE FROM #DefaultAttributeCode
								WHERE AttributeTypeName = 'Yes/No';

							END
						
                             --Check attributes are not mapped with any family of Pim Product
                             INSERT INTO ZnodeImportLog
                             (ErrorDescription,
                              ColumnName,
                              Data,
                              GUID,
                              CreatedBy,
                              CreatedDate,
                              ModifiedBy,
                              ModifiedDate,
                              ImportProcessLogId
                             )
                                    SELECT DISTINCT
                                           '14' AS ErrorDescription,
                                           AttributeCode,
                                           '',
                                           @NewGUID,
                                           @UserId,
                                           @GetDate,
                                           @UserId,
                                           @GetDate,
                                           @ImportProcessLogId
                                    FROM @AttributeDetail
                                    WHERE ISNULL(SourceColumnName, '') = ''   AND IsRequired = 1;  ;

                         END;
						
                     --	Check attributes are not mapped with (Default / Other) family of Pim Product
                     --	INSERT INTO ZnodeImportLog ( ErrorDescription , ColumnName , Data , GUID , CreatedBy , CreatedDate , ModifiedBy , ModifiedDate , ImportProcessLogId)
                     --	SELECT '1' AS ErrorDescription , SourceColumnName , '' , @NewGUID , @UserId , @GetDate , @UserId , @GetDate , @ImportProcessLogId
                     --	FROM @AttributeDetail WHERE PimAttributeId NOT IN ( SELECT zpfgm.PimAttributeId FROM dbo.ZnodePimFamilyGroupMapper AS zpfgm);
                     --	Verify data in global temporary table (column wise)
					
                     DECLARE Cr_Attribute CURSOR LOCAL FAST_FORWARD
                     FOR SELECT PimAttributeId,
                                AttributeTypeName,
                                AttributeCode,
                                IsRequired,
                                SourceColumnName,
                                ControlName,
                                ValidationName,
                                SubValidationName,
                                ValidationValue,
                                RegExp
                         FROM @AttributeDetail
                         WHERE ISNULL(SourceColumnName, '') <> '';
                     OPEN Cr_Attribute;
                     FETCH NEXT FROM Cr_Attribute INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @ControlName, @ValidationName, @SubValidationName, @ValidationValue, @RegExp;
                     WHILE @@FETCH_STATUS = 0
                         BEGIN
				             IF @AttributeTypeName = 'Number'
                                 BEGIN
							      EXEC Znode_ImportValidateNumber
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @ImportHeadId = @ImportHeadId,
                                          @ImportProcessLogId = @ImportProcessLogId;
                                 END;
							 -- Check invalid date
							
                             IF @AttributeTypeName = 'Date'
                                 BEGIN
                                     EXEC Znode_ImportValidateDate
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @ImportHeadId = @ImportHeadId,
                                          @ImportProcessLogId = @ImportProcessLogId;
                                 END;
							 -- Check Manditory Data
		 					 IF @IsRequired = 1 AND @CheckedSourceColumn <> @SourceColumnName
								BEGIN
									SET @CheckedSourceColumn = @SourceColumnName;
									EXEC Znode_ImportValidateManditoryData
									@TableName = @TableName,
									@SourceColumnName = @SourceColumnName,
									@CreateDateString = @CreateDateString,
									@ValidationName = @ValidationName,
									@ControlName = @ControlName,
									@ValidationValue = @ValidationValue,
									@NewGUID = @NewGUID,
									@ImportHeadId = @ImportHeadId;
								END;
							 --END 
							
                             IF @AttributeTypeName = 'Text'
                                 BEGIN
								 
						              EXEC Znode_ImportValidateManditoryText
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @LocaleId = @LocaleId,
                                          @DefaultLocaleId = @DefaultLocaleId,
                                          @AttributeId = @AttributeId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @ImportHeadId = @ImportHeadId;
                                 END;
                             IF @AttributeTypeName in ( 'Image','File')
                                 BEGIN
                                     EXEC Znode_ImportValidateImageData
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @LocaleId = @LocaleId,
                                          @DefaultLocaleId = @DefaultLocaleId,
                                          @AttributeId = @AttributeId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @ImportHeadId = @ImportHeadId;
                                 END;

					

                             --Check Default data value is valid 
                             IF @ImportHeadName IN('Product', 'Category','B2BCustomer')
                                 BEGIN
                                     IF @AttributeId IN
                                     (
                                         SELECT PimAttributeId
                                         FROM #DefaultAttributeCode
                                     )
                                         BEGIN
							
                                            IF  @AttributeTypeName = 'Multi Select'
											 BEGIN
										 		 ---Verify Image file is exists in media table or not 
												 SET @SQLQuery = ' INSERT INTO #InvalidDefaultData (RowNumber, Value, ColumnName) 
												 SELECT ROWNUMBER , (Select TOP 1 Item from dbo.split(' + @SourceColumnName + ','','')  SP WHERE NOT EXISTS 
												 (Select ToP 1 1 FROM #DefaultAttributeCode DAC WHERE 
												  DAC.AttributeTypeName <> ''Yes/No'' AND DAC.AttributeDefaultValueCode IS NOT NULL AND DAC.PimAttributeId = 
												 ' + CONVERT(VARCHAR(100), @AttributeId) + ' AND ltrim(rtrim(SP.Item) ) = DAC.AttributeDefaultValueCode
												 )), ''' + @SourceColumnName + ''' as [ColumnName]  FROM ' + @TableName
												 + ' Where ISnull(' + @SourceColumnName +  ','''') <> '''''
												EXEC sys.sp_sqlexec @SQLQuery;
											  END
											  ELSE IF @AttributeTypeName = 'Simple Select'
											  BEGIN
						
												---Verify Image file is exists in media table or not 
												 SET @SQLQuery = ' INSERT INTO #InvalidDefaultData (RowNumber, Value, ColumnName) 
												 SELECT ROWNUMBER , ' + @SourceColumnName + ' , ''' + @SourceColumnName + ''' as [ColumnName]  FROM ' + @TableName
												 + ' SP Where ISnull(' + @SourceColumnName +  ','''') <> '''' AND 
												  NOT EXISTS 
												 (Select TOP 1 1 FROM #DefaultAttributeCode DAC WHERE 
												  DAC.AttributeTypeName <> ''Yes/No'' AND DAC.AttributeDefaultValueCode IS NOT NULL AND DAC.PimAttributeId = 
												 ' + CONVERT(VARCHAR(100), @AttributeId) + ' AND ltrim(rtrim(SP.' + @SourceColumnName + ') ) = DAC.AttributeDefaultValueCode ) '
							
												EXEC sys.sp_sqlexec @SQLQuery;
											  END   
												-- Check Invalid Image 
												 SET @SQLQuery = 'SELECT ''9 '' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], 
												 Value AS  AttributeValue,RowNumber ,'''+@NewGUID+''',  '+@CreateDateString+' FROM #InvalidDefaultData Where Value IS NOT NULL'
												 INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, RowNumber, GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
												 EXEC sys.sp_sqlexec @SQLQuery;
												 Delete from #InvalidDefaultData

       
                                         END;
                                 END;
							
                             FETCH NEXT FROM Cr_Attribute INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @ControlName, @ValidationName, @SubValidationName, @ValidationValue, @RegExp;
                         END;
                     CLOSE Cr_Attribute;
                     DEALLOCATE Cr_Attribute;
                     --SELECT top 1 1 FROM @FamilyAttributeDetail where  iSNULL(SourceColumnName,'') = ''  and IsRequired = 1
                 END;
             
			 
			  
------------------------------------------------------------------------------------------
		 Declare @SQLQueryNew NVARCHAR(4000)
		 Declare @SourceColumnNameProduct nvarchar(4000) 
         IF @ImportHeadName IN('Product','Pricing','ProductAssociation','Inventory')
		 BEGIN
		 	 
		 SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'SKU'
		 AND ImportTemplateId = @TemplateId


			SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  SKU - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;			
		END
		ELSE IF @ImportHeadName IN('ProductAttribute')
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'AttributeCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  Attribute - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'ZipCode'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'ZIP'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  ZIPCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'Category'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'CategoryCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  CategoryCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'CategoryAssociation'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'CategoryName'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  CategoryName - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;

		END
		ELSE IF @ImportHeadName IN ('Customer','CustomerAddress')
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'UserName'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  UserName - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'SEODetails'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'Code'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  Code - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'Highlight'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'HighlightCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  HighlightCode - '' + ' + ' cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'AddonAssociation'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'SKU'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  SKU - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'AttributeDefaultValue'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'AttributeDefaultValueCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  AttributeDefaultValueCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
	-------------------------------------------------------------------------------------------------------------
	
	--------------------------------------------------------------------------------------------------------------------
			 
  		SET @SQLQuery = 'Delete FROM  '+@TableName+' Where Rownumber IN (Select Rownumber FROM ZnodeImportLog  WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND Rownumber IS NOT NULL)';
        EXEC sys.sp_sqlexec  @SQLQuery;
			 			
   
             IF @ImportHeadName IN('Product', 'Category')
                 BEGIN
                     IF NOT EXISTS
                     (
                         SELECT TOP 1 1
                         FROM @FamilyAttributeDetail
                         WHERE ISNULL(SourceColumnName, '') = ''
                               AND IsRequired = 1
                     ) AND NOT EXISTS
					 (
						 SELECT TOP 1 1
						 FROM ZnodeImportLog
						 WHERE Guid = @NewGUID
							   AND ErrorDescription IN(43, 42)
						 AND ImportProcessLogId = @ImportProcessLogId
					 )
                         BEGIN
                             IF @IsCategory = 0
                                 BEGIN

                                     EXEC Znode_ImportPimProductData
                                          @TableName = @TableName,
                                          @NewGUID = @NewGUID,
                                          @TemplateId = @TemplateId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @UserId = @UserId,
                                          @LocaleId = @LocaleId,
                                          @DefaultFamilyId = @DefaultFamilyId;

                                 END;
                             ELSE
                                 BEGIN
                                     EXEC Znode_ImportPimCategoryData
                                          @TableName = @TableName,
                                          @NewGUID = @NewGUID,
                                          @TemplateId = @TemplateId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @UserId = @UserId,
                                          @LocaleId = @LocaleId,
                                          @DefaultFamilyId = @DefaultFamilyId;
                                 END;
                         END
						 ELSE
							BEGIN
								-- Update Record count in log 
								
							
								--SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
								--EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount out
								--UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
								--WHERE ImportProcessLogId = @ImportProcessLogId;

								SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
								SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
								EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount out
								UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
								WHERE ImportProcessLogId = @ImportProcessLogId;
							END

                 END;
				IF NOT EXISTS
					 (
						 SELECT TOP 1 1
						 FROM ZnodeImportLog
						 WHERE Guid = @NewGUID
							   AND ErrorDescription IN(43, 42)
						 AND ImportProcessLogId = @ImportProcessLogId
					 )
             BEGIN
                 IF @ImportHeadName = 'Pricing'
                     BEGIN
                         EXEC [Znode_ImportPriceList]
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
                              @PriceListId = @PriceListId;
                     END;

                 IF @ImportHeadName = 'Inventory'
                     BEGIN
				
                         EXEC Znode_ImportInventory_Ver1
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID;
                     END;
                 IF @ImportHeadName = 'ZipCode'
                     BEGIN
						 EXEC Znode_ImportZipCode
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
							  @CountryCode = @CountryCode;
                     END;
					 IF @ImportHeadName = 'CategoryAssociation'
                     BEGIN
						 EXEC Znode_ImportCatalogCategory
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
							  @PimCatalogId = @PimCatalogId;
                     END;
					 IF @ImportHeadName = 'ProductAssociation'
                     BEGIN
						 EXEC Znode_ImportAssociateProducts
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID
                     END;
			
					 IF @ImportHeadName = 'SEODetails' AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportSEODetails
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
							  @LocaleId = @LocaleId,
							  @PortalId =@PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
							  @CsvColumnString = @CsvColumnString 

				
                     END;
				
					 IF @ImportHeadName = 'ProductAttribute' 
                     BEGIN
						 EXEC Znode_ImportAttributes
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
							  @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID
				
                     END;

					 IF @ImportHeadName = 'Customer' AND @PortalId > 0 
                     BEGIN
					
					
						 EXEC Znode_ImportCustomer
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = @PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
				
                     END;
					 
					 IF @ImportHeadName = 'UserApprovers' AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportUserApproval
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = @PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
				
                     END;

					 IF @ImportHeadName = 'B2BCustomer' AND @PortalId > 0 
                     BEGIN

							 EXEC Znode_ImportB2BCustomer
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = @PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
				
                     END;

					 IF @ImportHeadName = 'CustomerAddress' --AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportCustomerAddress
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = 7, -- not implemented from forntend 
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString,
							  @IsAccountAddress = @IsAccountAddress
				
                     END;
					 IF @ImportHeadName = 'ShippingAddress' --AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportCustomerAddress
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = 7, -- not implemented from forntend 
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString,
							  @IsAccountAddress = @IsAccountAddress
				
                     END;
					 IF @ImportHeadName = 'StoreLocator' --AND @PortalId > 0 
                     BEGIN
					 	 EXEC Znode_ImportStoreLocatorAddress
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
                     END;

					IF @ImportHeadName = 'Highlight'
					BEGIN
					EXEC Znode_ImportHighlight 
					@TableName = @TableName, 
					@Status = @Status, 
					@UserId = @UserId, 
					@ImportProcessLogId = @ImportProcessLogId, 
					@NewGUID = @NewGUID 
					END;

					IF @ImportHeadName = 'AddonAssociation'
					BEGIN
					EXEC Znode_ImportAddonAssociation 
					@TableName = @TableName, 
					@Status = @Status, 
					@UserId = @UserId, 
					@ImportProcessLogId = @ImportProcessLogId, 
					@NewGUID = @NewGUID,
					@PimCatalogId = @PimCatalogId
					END;

					IF @ImportHeadName = 'AttributeDefaultValue'
					BEGIN
					EXEC Znode_ImportAttributeDefaultValue 
					@TableName = @TableName, 
					@Status = @Status, 
					@UserId = @UserId, 
					@ImportProcessLogId = @ImportProcessLogId, 
					@NewGUID = @NewGUID
					
					END;

					IF @ImportHeadName = 'Voucher'
					BEGIN
						EXEC Znode_ImportVoucher 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID
					
					END;

					IF @ImportHeadName = 'Account'
					BEGIN
						
						EXEC Znode_ImportAccount 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID,
						@CsvColumnString = @CsvColumnString,
						@PortalId = @PortalId
					
					END;
				 
             END
			 ELSE 
				 BEGIN
					-- Update Record count in log 	
					SET @SQLQuery = ' Select @FailedRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
					EXEC	sp_executesql @SQLQuery , N'@FailedRecordCount BIGINT out' , @FailedRecordCount =@FailedRecordCount out
					SELECT @SuccessRecordCount = 0
									
					UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
					WHERE ImportProcessLogId = @ImportProcessLogId;

				 END

             EXEC Znode_ImportReadErrorLog
                  @ImportProcessLogId = @ImportProcessLogId,
                  @NewGUID = @NewGUID;
             DROP TABLE #GlobalTempTableColumns;

             -- Finally call product insert process if error not found in error log table 
             IF EXISTS
             (
                 SELECT TOP 1 1
                 FROM ZnodeImportLog
                 WHERE ImportProcessLogId = @ImportProcessLogId
                       AND Guid = @NewGUID
             )
                 BEGIN
                     --Update process with completed status for current import 
                     UPDATE ZnodeImportProcessLog
                       SET
                           Status = dbo.Fn_GetImportStatus(3),
                           ProcessCompletedDate = GETDATE()
                       WHERE ImportProcessLogId = @ImportProcessLogId;
                 END;
				 SET @SQLQuery = 'IF Object_id(''+@TableName+'') IS NOT NULL  DROP TABLE ' + @TableName
                 EXEC sys.sp_sqlexec @SQLQuery;

				 print 'end';
         END TRY
         BEGIN CATCH
			DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE()
			DECLARE @TempCount TABLE (Id INT)

			Declare @SQL Varchar(max) = 'Select Count(*) As Id From '+@TableName
			INSERT INTO @TempCount
			EXEC (@SQL)

             SELECT ERROR_MESSAGE(),
                    ERROR_LINE(),
                    ERROR_PROCEDURE();
             EXEC Znode_ImportReadErrorLog
                  @ImportProcessLogId = @ImportProcessLogId,
                  @NewGUID = @NewGUID; 
             
			 ---Import process updating fail due to database error
			UPDATE ZnodeImportProcessLog
			SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
			WHERE ImportProcessLogId = @ImportProcessLogId;

			---Loging error for Import process due to database error
		    INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		    SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

			--Updating total and fail record count
		    UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		    TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		    WHERE ImportProcessLogId = @ImportProcessLogId;

			SET @SQLQuery = 'Drop Table ' + @TableName
            EXEC sys.sp_sqlexec @SQLQuery;
             --ROLLBACK TRAN TRN_ImportValidProductData;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeleteUserDetails')
	DROP PROC Znode_DeleteUserDetails
GO


CREATE PROCEDURE [dbo].[Znode_DeleteUserDetails]  
(  
       @UserId VARCHAR(2000) = NULL ,  
       @Status INT OUT   ,   
    @UserIds Transferid READONLY ,   
    @IsForceFullyDelete BIT =0  ,@IsCallInternal   BIT = 0   
)  
AS  
/*  
Summary: This Procedure Is used to delete user details  
Unit Testing:  
EXEC Znode_DeleteUserDetails   
  
*/  
     BEGIN  
         BEGIN TRY  
             SET NOCOUNT ON;  
             BEGIN TRAN A;  
    DECLARE @StatusOut Table (Id INT ,Message NVARCHAR(max), Status BIT )  
             DECLARE @V_table TABLE (  
                                    USERID1 NVARCHAR(200)  
                                    );  
             DECLARE @V_tabledeleted TABLE (  
                                           UserId1      INT ,  
                                           AspnetUserid NVARCHAR(1000)  
                                           );  
             DECLARE @TBL_DeleteduserName TABLE (  
                                                id NVARCHAR(MAX)  
                                                );  
             INSERT INTO @V_tabledeleted  
                    SELECT ITEM , b.AspNetUserId  
                    FROM dbo.split ( @UserId , ','  
                                   ) AS a INNER JOIN ZnodeUser AS b ON ( a.Item = b.UserId )  
           WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeOmsOrderDetails zood WHERE zood.UserId= b.UserId)  
      AND UserId <> 2   
       INSERT INTO @V_tabledeleted            
       SELECT a.Id , b.AspNetUserId  
                    FROM @UserIds AS a   
     INNER JOIN ZnodeUser AS b ON ( a.Id = b.UserId )  
           WHERE (NOT EXISTS (SELECT TOP 1 1 FROM ZnodeOmsOrderDetails zood WHERE zood.UserId= b.UserId) OR @IsForceFullyDelete =1 )   
           AND UserId <> 2        
             DELETE FROM ZnodeUserProfile  
             WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS a  
                            WHERE a.UserId1 = ZnodeUserProfile.UserId  
                          );  
             DELETE FROM ZnodeUserAddress  
             WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS a  
                            WHERE a.UserId1 = ZnodeUserAddress.UserId  
                          );   
  
   --------  

 
   delete from ZnodeOmsPersonalizeCartItem   
   where OmsSavedCartLineItemId in (  
    select OmsSavedCartLineItemId  from ZnodeOmsSavedCartLineItem where OmsSavedCartId in (  
    select OmsSavedCartId FROM ZnodeOmsSavedCart  
    where OmsCookieMappingId in (select OmsCookieMappingId from ZnodeOmsCookieMapping  
           WHERE EXISTS ( SELECT TOP 1 1  
              FROM @V_tabledeleted AS a  
              WHERE a.UserId1 = ZnodeOmsCookieMapping.UserId  
               ))));  
  
   delete from ZnodeOmsSavedCartLineItem where OmsSavedCartId in (  
   select OmsSavedCartId FROM ZnodeOmsSavedCart  
   where OmsCookieMappingId in (select OmsCookieMappingId from ZnodeOmsCookieMapping  
           WHERE EXISTS ( SELECT TOP 1 1  
              FROM @V_tabledeleted AS a  
              WHERE a.UserId1 = ZnodeOmsCookieMapping.UserId  
               )));  
 
   DELETE FROM ZnodeOmsSavedCart  
   where OmsCookieMappingId in (select OmsCookieMappingId from ZnodeOmsCookieMapping  
           WHERE EXISTS ( SELECT TOP 1 1  
              FROM @V_tabledeleted AS a  
              WHERE a.UserId1 = ZnodeOmsCookieMapping.UserId  
               ));  
   
   DELETE FROM ZnodeOmsCookieMapping  
             WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS a  
                            WHERE a.UserId1 = ZnodeOmsCookieMapping.UserId  
                          );  
   
   DELETE ZGCH  
   FROM ZnodeGiftCardHistory ZGCH  
   INNER JOIN ZnodeGiftCard ZGC ON (ZGCH.GiftCardId = ZGC.GiftCardId)  
   WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS a  
                            WHERE a.UserId1 = ZGC.UserId)  
  
   DELETE FROM ZnodeGiftCard              
             WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS a  
                            WHERE a.UserId1 = ZnodeGiftCard.UserId  
                          );  
     ---------  
 
             DELETE FROM ZnodeAccountUserOrderApproval  
             WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS a  
                            WHERE a.UserId1 = ZnodeAccountUserOrderApproval.UserId  
                          );  
             DELETE FROM AspNetUserRoles  
             WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS a  
                            WHERE a.aspNetUserId = AspNetUserRoles.UserId  
                          );  
						
           
             DELETE FROM dbo.ZnodeAccountUserPermission  
             WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS a  
                            WHERE a.UserId1 = ZnodeAccountUserPermission.UserId  
                          );  
       
    DELETE FROM ZnodeSalesRepCustomerUserPortal  
             WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS a  
                            WHERE a.UserId1 = ZnodeSalesRepCustomerUserPortal.CustomerUserid  
                          );  
   
       delete from ZnodeSalesRepCustomerUserPortal   
    WHERE exists(select TOP 1 1  FROM ZnodeUserPortal ZUP where EXISTS ( SELECT TOP 1 1 FROM @V_tabledeleted AS a WHERE a.UserId1 = ZUP.UserId )  
                 and ZnodeSalesRepCustomerUserPortal.UserPortalId = ZUP.UserPortalId );  
       
    DELETE FROM ZnodeUserPortal  
             WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS a  
                            WHERE a.UserId1 = ZnodeUserPortal.UserId  
                          );  
						
             DELETE FROM ZnodeAccountUserOrderApproval  
             WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeAccountUserOrderApproval.UserId  
                                  OR  
                                  TBDL.UserId1 = ZnodeAccountUserOrderApproval.ApprovalUserId  
                          );  
						   
    DELETE FROM ZnodeOmsUsersReferralUrl   
     WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeOmsUsersReferralUrl.UserId  
                           );  
						    
    DELETE FROM ZnodeOmsReferralCommission   
    WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeOmsReferralCommission.UserId        
                          );  
						  
   DELETE FROM ZnodeUserWishList   
   WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeUserWishList.UserId        
                          );  
						   
    DELETE FROM ZnodeDepartmentUser   
    WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeDepartmentUser.UserId        
                          );  
						  
    DELETE FROM ZnodeUserPromotion   
    WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeUserPromotion.UserId        
                          );  
   
    DELETE FROM AspNetUserClaims   
    WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = AspNetUserClaims.UserId        
                          );   
					
    DELETE FROM ZnodeNote   
    WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeNote.UserId        
                          );   
  
    DELETE FROM ZnodeOmsQuotePersonalizeItem WHERE OmsQuoteLineItemId IN (SELECT OmsQuoteLineItemId FROM ZnodeOmsQuoteLineItem  WHERE OmsQuoteId IN (SELECT OmsQuoteId FROM ZnodeOmsQuote   
     WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeOmsQuote.UserId        
                          ) ))   
						  
    DELETE FROM ZnodeOmsQuoteLineItem  WHERE OmsQuoteId IN (SELECT OmsQuoteId FROM ZnodeOmsQuote   
     WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeOmsQuote.UserId        
                          ) )  
   
   DELETE FROM ZnodeUserApprovers  
   WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeUserApprovers.ApproverUserId        
                          )   
  
   
   DELETE FROM ZnodeOMSQuoteApproval   
     WHERE exists(select *  FROM ZnodeOmsQuote   
     WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeOmsQuote.UserId        
                          ) AND ZnodeOMSQuoteApproval.OMSQuoteId = ZnodeOmsQuote.OmsQuoteId) ;  
   
   DELETE FROM ZnodeOmsQuoteComment   
     WHERE exists(select *  FROM ZnodeOmsQuote   
     WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeOmsQuote.UserId        
                          ) AND ZnodeOmsQuoteComment.OMSQuoteId = ZnodeOmsQuote.OmsQuoteId) ;  
  
  
  
   DELETE FROM ZnodeOmsNotes   
     WHERE exists(select *  FROM ZnodeOmsQuote   
     WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeOmsQuote.UserId        
                          ) AND ZnodeOmsNotes.OMSQuoteId = ZnodeOmsQuote.OmsQuoteId) ;  
  
   DELETE FROM ZnodeOmsQuoteHistory   
     WHERE exists(select *  FROM ZnodeOmsQuote   
     WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeOmsQuote.UserId        
                          ) AND ZnodeOmsQuoteHistory.OMSQuoteId = ZnodeOmsQuote.OmsQuoteId) ;   
  
    DELETE FROM ZnodeOmsQuote   
     WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeOmsQuote.UserId        
                          );   
						 
    DELETE FROM ZnodeAccountUserPermission   
     WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeAccountUserPermission.UserId        
                          );  
						
     DELETE FROM ZnodePriceListUser   
     WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodePriceListUser.UserId        
                          );   
						  
     DELETE FROM ZnodeMediaFolderUser   
     WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeMediaFolderUser.UserId        
                          ); 
						  
     DELETE FROM ZnodeAccountUserOrderApproval   
     WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeAccountUserOrderApproval.UserId        
                          );   
						   
    DELETE FROM ZnodeOmsTemplateLineItem WHERE OmsTemplateId IN (SELECT OmsTemplateId   
    FROM ZnodeOmsTemplate WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeOmsTemplate.UserId        
                          ) )  
						
  
    DELETE FROM dbo.ZnodeFormBuilderGlobalAttributeValueLocale   WHERE FormBuilderGlobalAttributeValueId IN   
    (SELECT FormBuilderGlobalAttributeValueId  FROM dbo.ZnodeFormBuilderGlobalAttributeValue  WHERE FormBuilderSubmitId IN (SELECT FormBuilderSubmitId FROM dbo.ZnodeFormBuilderSubmit WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeFormBuilderSubmit.UserId        
                          ) ))  
  
     DELETE FROM dbo.ZnodeFormBuilderGlobalAttributeValue  WHERE FormBuilderSubmitId IN (SELECT FormBuilderSubmitId FROM dbo.ZnodeFormBuilderSubmit WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeFormBuilderSubmit.UserId        
                          ) )  
						
     DELETE FROM dbo.ZnodeFormBuilderSubmit WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeFormBuilderSubmit.UserId        
                          )    

    DELETE FROM ZnodeOmsTemplate  WHERE  EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeOmsTemplate.UserId        
                          )   
      
      
   DELETE FROM ZnodeCaseRequestHistory WHERE CaseRequestId IN (SELECT CaseRequestId  FROM ZnodeCaseRequest  WHERE EXISTS (SELECT TOP  1 1 FROM @V_tabledeleted AS TBDL WHERE TBDL.UserId1 = ZnodeCaseRequest.UserId))  
     DELETE FROM ZnodeCaseRequest  WHERE EXISTS (SELECT TOP  1 1 FROM @V_tabledeleted AS TBDL WHERE TBDL.UserId1 = ZnodeCaseRequest.UserId)  
     DECLARE @OrderId Transferid   
    INSERT INTO @OrderId   
    SELECT DISTINCT  a.OmsOrderId   
    FROM ZnodeOMsOrder A   
    INNER JOIN ZnodeOmsOrderDetails b ON(b.OmsOrderId = a.OmsOrderId)  
    WHERE EXISTS (SELECT TOP 1  1 FROM @V_tabledeleted t WHERE b.UserId = t.UserId1 )  
    INSERT INTO @StatusOut (Id ,Status)   
   EXEC  Znode_DeleteOrderById   @OmsOrderIds =@OrderId ,@Status = 0   
   UPDATE ZnodePublishCatalogLog  SET Userid =2   
   WHERE UserId IN (SELECT UserId1 FROM @V_tabledeleted t)  
  
      
    DELETE FROM ZnodeCMSCustomerReview WHERE UserId IN (SELECT UserId1 FROM @V_tabledeleted t)  
             DELETE FROM ZnodeBlogNewsCommentLocale where BlogNewsCommentId in (select BlogNewsCommentId from  ZnodeBlogNewsComment WHERE UserId IN  
     (SELECT UserId1 FROM @V_tabledeleted t))  
    DELETE FROM ZnodeBlogNewsComment WHERE UserId IN (SELECT UserId1 FROM @V_tabledeleted t)  
  
   -----------  

   DELETE FROM ZnodePublishedPortalXml  
   WHERE EXISTS(SELECT *  FROM ZnodePublishPortalLog  
      WHERE EXISTS ( SELECT TOP 1 1  
         FROM @V_tabledeleted AS TBDL  
         WHERE TBDL.UserId1 = ZnodePublishPortalLog.UserId  
      AND ZnodePublishedPortalXml.PublishPortalLogId = ZnodePublishPortalLog.PublishPortalLogId));  
  
   DELETE FROM ZnodePublishPortalLog  
   WHERE EXISTS ( SELECT TOP 1 1  
          FROM @V_tabledeleted AS TBDL  
          WHERE TBDL.UserId1 = ZnodePublishPortalLog.UserId        
           );   

   DELETE FROM ZnodeUserGlobalAttributeValueLocale  
   WHERE EXISTS(SELECT *  FROM ZnodeUserGlobalAttributeValue  
      WHERE EXISTS ( SELECT TOP 1 1  
         FROM @V_tabledeleted AS TBDL  
         WHERE TBDL.UserId1 = ZnodeUserGlobalAttributeValue.UserId  
      AND ZnodeUserGlobalAttributeValueLocale.UserGlobalAttributeValueId = ZnodeUserGlobalAttributeValue.UserGlobalAttributeValueId));   
   DELETE FROM ZnodeUserGlobalAttributeValue  
   WHERE EXISTS ( SELECT TOP 1 1  
          FROM @V_tabledeleted AS TBDL  
          WHERE TBDL.UserId1 = ZnodeUserGlobalAttributeValue.UserId        
           );   

   DELETE FROM ZnodeOMSQuoteApproval  
   WHERE EXISTS ( SELECT TOP 1 1  
          FROM @V_tabledeleted AS TBDL  
          WHERE TBDL.UserId1 = ZnodeOMSQuoteApproval.UserId        
           );   

   DELETE FROM AspNetUserLogins  
   WHERE EXISTS ( SELECT TOP 1 1  
          FROM @V_tabledeleted AS TBDL  
          WHERE TBDL.UserId1 = AspNetUserLogins.UserId        
           );   
  
   DELETE FROM ZnodePasswordLog  
   WHERE EXISTS ( SELECT TOP 1 1  
          FROM @V_tabledeleted AS TBDL  
          WHERE TBDL.aspNetUserId = ZnodePasswordLog.UserId        
           );   
   
   DELETE FROM ZnodeSavedReportViews  
   WHERE EXISTS ( SELECT TOP 1 1  
          FROM @V_tabledeleted AS TBDL  
          WHERE TBDL.UserId1 = ZnodeSavedReportViews.UserId        
           );   
 
   DELETE FROM ZnodeSearchActivity  
   WHERE EXISTS ( SELECT TOP 1 1  
          FROM @V_tabledeleted AS TBDL  
          WHERE TBDL.UserId1 = ZnodeSearchActivity.UserId        
           );   
  
   DELETE FROM ZnodeOmsCustomerShipping  
   WHERE EXISTS ( SELECT TOP 1 1  
          FROM @V_tabledeleted AS TBDL  
          WHERE TBDL.UserId1 = ZnodeOmsCustomerShipping.UserId        
           );   

   DELETE FROM ZnodeOMSQuoteApproval  
   WHERE EXISTS ( SELECT TOP 1 1  
          FROM @V_tabledeleted AS TBDL  
          WHERE TBDL.UserId1 = ZnodeOMSQuoteApproval.ApproverUserId        
           );   
     
   ------------  
     
  
   DELETE FROM ZnodeUser  
             OUTPUT deleted.UserId  
                    INTO @V_table  
             WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS a  
                            WHERE a.UserId1 = ZnodeUser.UserId  
                          );  
 
             DELETE FROM AspNetUsers  
             OUTPUT deleted.UserName  
                    INTO @TBL_DeleteduserName  
             WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS a  
                            WHERE a.AspnetUserid = AspNetUsers.Id  
                          );  
  
             DELETE FROM AspNetZnodeUser  
             WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @TBL_DeleteduserName AS TBUN  
                            WHERE TBUN.id = AspNetZnodeUser.AspNetZnodeUserId  
                          );  
      
     
     IF  @IsCallInternal = 0    
     BEGIN   
             IF ( SELECT COUNT(1)  
                  FROM @V_tabledeleted  
                ) = ( SELECT COUNT(1)  
                      FROM dbo.split ( @UserId , ','  
                                     )  
                    ) OR @UserId IS NULL   
                 BEGIN  
                     SELECT 0 AS ID , CAST(1 AS BIT) AS Status;  
                 END;  
             ELSE  
                 BEGIN  
                     SELECT 0 AS ID , CAST(0 AS BIT) AS Status;  
                 END;  
         END   
             SET @Status = 1;  
             COMMIT TRAN A;  
         END TRY  
         BEGIN CATCH  
   SELECT ERROR_MESSAGE()  
              DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeleteUserDetails @UserId = '+@UserId+',@Status='+CAST(@Status AS VARCHAR(200));  
             SET @Status = 0;  
             SELECT 0 AS ID,  
                    CAST(0 AS BIT) AS Status;  
    ROLLBACK TRAN A;  
             EXEC Znode_InsertProcedureErrorLog  
                  @ProcedureName = 'Znode_DeleteUserDetails',  
                  @ErrorInProcedure = @Error_procedure,  
                  @ErrorMessage = @ErrorMessage,  
                  @ErrorLine = @ErrorLine,  
                  @ErrorCall = @ErrorCall;  
         END CATCH;  
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateOmsOrder')
	DROP PROC Znode_InsertUpdateOmsOrder
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateOmsOrder]
(
	@OrderXML XML,
	@UserId INT
)
AS
BEGIN
SET NOCOUNT ON;
BEGIN TRY

	DECLARE @GetDate DATETIME = GETDATE()
	DECLARE @OMSOrder TABLE(OmsOrderId INT,OrderNumber VARCHAR(200))
	DECLARE @OMSOrderDetail TABLE(OmsOrderId INT,OmsOrderDetailsId INT)
	DECLARE @OmsOrderLineItems TABLE(RowId INT IDENTITY(1,1),OmsOrderDetailsId INT,OmsOrderLineItemsId INT, Sku VARCHAR(600), ParentOmsOrderLineItemsId INT, GroupId NVARCHAR(MAX),OrderLineItemRelationshipTypeId INT,ParentSku VARCHAR(600), GroupIdentifier INT)
	DECLARE @OmsParentOrderLineItems TABLE(RowId INT IDENTITY(1,1),OmsOrderDetailsId INT,OmsOrderLineItemsId INT, Sku VARCHAR(600), ParentOmsOrderLineItemsId INT, GroupId NVARCHAR(MAX), OrderLineItemRelationshipTypeId INT, GroupIdentifier INT)

	DECLARE @OrderLineItemRelationshipTypeIdAddon int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'AddOns'
	);

	DECLARE @OrderLineItemRelationshipTypeIdSimple int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Simple'
	);

	DECLARE @OrderLineItemRelationshipTypeIdBundles int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Bundles'
	);

	DECLARE @OrderLineItemRelationshipTypeIdGroup int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Group'
	);

	DECLARE @OrderLineItemRelationshipTypeIdConfig int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Configurable'
	);


	CREATE TABLE #TempOrderData
	(
		RowId INT IDENTITY(1,1),OrderNumber VARCHAR(200), PublishStateId INT,OmsOrderId INT,OmsOrderStateId INT,
		DiscountAmount NUMERIC(28,6),SalesTax NUMERIC(28,6),TaxRate NUMERIC(28,6),IsOldOrder BIT,VAT NUMERIC(28,6),GST NUMERIC(28,6),
		PST NUMERIC(28,6),HST NUMERIC(28,6),Total NUMERIC(28,6),BillingAddressId INT,ShippingAddressId INT,ShippingId INT,
		PortalId INT,ShippingNumber NVARCHAR(max),TrackingNumber NVARCHAR(1000),CouponCode NVARCHAR(1000),
		PromoDescription NVARCHAR(max),ReferralUserId int,PurchaseOrderNumber NVARCHAR(1000),OmsPaymentStateId int,
		WebServiceDownloadDate datetime,PaymentSettingId int,PaymentTransactionToken NVARCHAR(600),ShipDate datetime,ReturnDate datetime,
		AddressId int,PoDocument NVARCHAR(600),IsActive bit,ExternalId NVARCHAR(1000),PaymentTypeId INT,CreatedBy INT,CreatedDate datetime,ModifiedBy INT,
		ModifiedDate datetime,CreditCardNumber VARCHAR(4),IsShippingCostEdited bit,IsTaxCostEdited bit,ShippingDifference NUMERIC(28,6),
		EstimateShippingCost NUMERIC(28,6),TransactionId NVARCHAR(800),Custom1 NVARCHAR(MAX),Custom2 NVARCHAR(MAX),Custom3 NVARCHAR(MAX),
		Custom4 NVARCHAR(MAX),Custom5 NVARCHAR(MAX),FirstName NVARCHAR(200),LastName NVARCHAR(200),CardType VARCHAR(50),CreditCardExpMonth INT,
		CreditCardExpYear INT,TotalAdditionalCost NUMERIC(28,6),PaymentDisplayName NVARCHAR(2000),PaymentExternalId NVARCHAR(2000),
		CultureCode VARCHAR(200),DisplayName NVARCHAR(2000),InHandDate datetime,IpAddress VARCHAR(100),JobName NVARCHAR(200),
		ShippingConstraintCode NVARCHAR(100),ShippingDiscount NUMERIC(28,6),ShippingHandlingCharges NUMERIC(28,6),ReturnCharges NUMERIC(28,6),
		IsCalculateTaxAfterDiscount bit,Email VARCHAR(50),PhoneNumber VARCHAR(50),OrderTotalWithoutVoucher NUMERIC(28,6),ImportDuty NUMERIC(28,6),
		TaxCost NUMERIC(28,6),ShippingCost NUMERIC(28,6), SubTotal NUMERIC(28,6),CurrencyCode VARCHAR(100),OverDueAmount NUMERIC(28,6), ShippingTypeId INT,
		AccountNumber NVARCHAR(4000),ShippingMethod NVARCHAR(4000),PaymentCode NVARCHAR(400) ,PaymentStatusId Int
	)

	CREATE TABLE #TempOrderBillingAddress
	(
		AddressId INT,BillingFirstName VARCHAR(300),BillingLastName VARCHAR(300),BillingCountry VARCHAR(3000),BillingStateCode VARCHAR(300),
		BillingPostalCode VARCHAR(50),BillingPhoneNumber VARCHAR(50),BillingEmailId VARCHAR(50),BillingStreet1 VARCHAR(300),BillingStreet2 VARCHAR(300),
		BillingCity VARCHAR(3000),BillingCompanyName NVARCHAR(1200)
	)
	
	CREATE TABLE #TempParentLineItemDetails
	(
		RowId INT IDENTITY(1,1),OrderLineItemRelationshipTypeId INT,OmsOrderDetailsId INT,OmsOrderShipmentId INT,RmaReasonForReturnId INT,Sku NVARCHAR(600),ProductName NVARCHAR(1000),
		Description NVARCHAR(max),Quantity NUMERIC(28,6),Price NUMERIC(28,6),Weight NUMERIC(28,6),DownloadLink NVARCHAR(max),DiscountAmount NUMERIC(28,6),
		ShipSeparately bit,ShipDate datetime,ReturnDate datetime,ShippingCost NUMERIC(28,6),PromoDescription NVARCHAR(max),TransactionNumber NVARCHAR(max),
		PaymentStatusId int,TrackingNumber NVARCHAR(max),IsAutoGeneratedTracking bit,OrderLineItemStateId int,IsRecurringBilling bit,RecurringBillingPeriod NVARCHAR(100),
		RecurringBillingCycles int,RecurringBillingFrequency NVARCHAR(100),RecurringBillingAmount NUMERIC(28,6),AppliedPromo NVARCHAR(max),CouponsApplied NVARCHAR(100),
		ExternalId NVARCHAR(1000),IsActive bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,AutoAddonSKU NVARCHAR(max),IsShippingReturn bit,
		PartialRefundAmount NUMERIC(28,6),Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),Custom4 NVARCHAR(max),Custom5 NVARCHAR(max),
		GroupId NVARCHAR(max),BundleQuantity int, TaxRuleId INT,TaxTransactionNumber NVARCHAR(1200),Comments NVARCHAR(MAX),SalesTax NUMERIC(28,6),VAT NUMERIC(28,6),
		GST NUMERIC(28,6),PST NUMERIC(28,6),HST NUMERIC(28,6),ImportDuty NUMERIC(28,6), GroupIdentifier INT
	)

	CREATE TABLE #TempChildLineItemDetails
	(
		RowId INT IDENTITY(1,1),OrderLineItemRelationshipTypeId INT,OmsOrderDetailsId INT,OmsOrderShipmentId INT,RmaReasonForReturnId INT,Sku NVARCHAR(600),ProductName NVARCHAR(1000),
		Description NVARCHAR(max),Quantity NUMERIC(28,6),Price NUMERIC(28,6),Weight NUMERIC(28,6),DownloadLink NVARCHAR(max),DiscountAmount NUMERIC(28,6),
		ShipSeparately bit,ShipDate datetime,ReturnDate datetime,ShippingCost NUMERIC(28,6),PromoDescription NVARCHAR(max),TransactionNumber NVARCHAR(max),
		PaymentStatusId int,TrackingNumber NVARCHAR(max),IsAutoGeneratedTracking bit,OrderLineItemStateId int,IsRecurringBilling bit,RecurringBillingPeriod NVARCHAR(100),
		RecurringBillingCycles int,RecurringBillingFrequency NVARCHAR(100),RecurringBillingAmount NUMERIC(28,6),AppliedPromo NVARCHAR(max),CouponsApplied NVARCHAR(100),
		ExternalId NVARCHAR(1000),IsActive bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,AutoAddonSKU NVARCHAR(max),IsShippingReturn bit,
		PartialRefundAmount NUMERIC(28,6),Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),Custom4 NVARCHAR(max),Custom5 NVARCHAR(max),
		GroupId NVARCHAR(max),BundleQuantity int, TaxRuleId INT,TaxTransactionNumber NVARCHAR(1200),Comments NVARCHAR(MAX),SalesTax NUMERIC(28,6),VAT NUMERIC(28,6),
		GST NUMERIC(28,6),PST NUMERIC(28,6),HST NUMERIC(28,6),ImportDuty NUMERIC(28,6), ParentSku NVARCHAR(600), GroupIdentifier INT
	)

	CREATE TABLE #TempOrderAttribute
	(
		AttributeCode NVARCHAR(1000),AttributeValue NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,
		ModifiedDate DATETIME,AttributeValueCode NVARCHAR(1000), Sku VARCHAR(600), GroupId NVARCHAR(max), GroupIdentifier INT
	)

	CREATE TABLE #OmsPersonalizeItem
	(
		PersonalizeCode NVARCHAR(400),PersonalizeValue NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,
		ModifiedDate DATETIME,DesignId NVARCHAR(4000),ThumbnailURL NVARCHAR(MAX), Sku VARCHAR(600), GroupId NVARCHAR(max),
		GroupIdentifier INT
	)

	CREATE TABLE #OmsOrderDiscount
	(
		OmsDiscountTypeId INT,DiscountCode VARCHAR(300),DiscountAmount NUMERIC(28,6),Description NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,
		ModifiedBy INT,ModifiedDate DATETIME,PerQuantityDiscount NUMERIC(28,6),DiscountMultiplier NUMERIC(28,6),ParentOmsOrderLineItemsId INT,
		DiscountLevelTypeId INT,PromotionName NVARCHAR(1200),PromotionTypeId INT,DiscountAppliedSequence INT,PromotionMessage NVARCHAR(MAX),Sku VARCHAR(600),
		GroupId NVARCHAR(max)
	)

	--------Getting Order details
	INSERT INTO #TempOrderData
	(
		OrderNumber, PublishStateId ,OmsOrderId ,OmsOrderStateId ,DiscountAmount ,SalesTax ,TaxRate ,IsOldOrder ,
		VAT ,GST ,PST ,HST ,Total ,BillingAddressId ,ShippingAddressId ,ShippingId ,PortalId,
		ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
		,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive
		,ExternalId,PaymentTypeId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
		,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName
		,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
		,DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
		,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty,TaxCost,ShippingCost, SubTotal,
		CurrencyCode,OverDueAmount, ShippingTypeId, AccountNumber, ShippingMethod, PaymentCode, PaymentStatusId
	)
	SELECT
		CASE WHEN Tbl.Col.value( 'OrderNumber[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderNumber[1]', 'NVARCHAR(Max)' ) END  AS OrderNumber,
		CASE WHEN Tbl.Col.value( 'PublishStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PublishStateId[1]', 'NVARCHAR(Max)' ) END AS PublishStateId,
		CASE WHEN Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderId,
		CASE WHEN Tbl.Col.value( 'OmsOrderStateId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderStateId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderStateId,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE  Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
		CASE WHEN Tbl.Col.value( 'TaxRate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TaxRate[1]', 'NVARCHAR(Max)' ) END AS TaxRate,
		CASE WHEN Tbl.Col.value('IsOldOrder[1]', 'NVARCHAR(2000)') = '' THEN NULL ELSE Tbl.Col.value('IsOldOrder[1]', 'NVARCHAR(2000)') END AS IsOldOrder,
		CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE  Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
		CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
		CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END  AS PST,
		CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END AS HST,
		CASE WHEN Tbl.Col.value( 'Total[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Total[1]', 'NVARCHAR(Max)' ) END AS Total,
		CASE WHEN Tbl.Col.value( 'BillingAddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'BillingAddressId[1]', 'NVARCHAR(Max)' ) END AS BillingAddressId,
		CASE WHEN Tbl.Col.value( 'ShippingAddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingAddressId[1]', 'NVARCHAR(Max)' ) END AS ShippingAddressId,
		CASE WHEN (Tbl.Col.value( 'ShippingId[1]', 'NVARCHAR(Max)' )) = '' THEN NULL ELSE (Tbl.Col.value( 'ShippingId[1]', 'NVARCHAR(Max)' )) END  AS ShippingId,
		CASE WHEN Tbl.Col.value( 'PortalId[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'PortalId[1]', 'NVARCHAR(Max)' ) END AS PortalId,
		Tbl.Col.value( 'ShippingNumber[1]', 'NVARCHAR(Max)' ) AS ShippingNumber,
		Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
		Tbl.Col.value( 'CouponCode[1]', 'NVARCHAR(Max)' ) AS CouponCode,
		Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
		CASE WHEN Tbl.Col.value( 'ReferralUserId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReferralUserId[1]', 'NVARCHAR(Max)' ) END  AS ReferralUserId,
		Tbl.Col.value( 'PurchaseOrderNumber[1]', 'NVARCHAR(Max)' ) AS PurchaseOrderNumber,
		CASE WHEN Tbl.Col.value( 'OmsPaymentStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsPaymentStateId[1]', 'NVARCHAR(Max)' ) END AS OmsPaymentStateId,
		Tbl.Col.value( 'WebServiceDownloadDate[1]', 'NVARCHAR(Max)' ) AS WebServiceDownloadDate,
		CASE WHEN Tbl.Col.value( 'PaymentSettingId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentSettingId[1]', 'NVARCHAR(Max)' ) END AS PaymentSettingId,
		Tbl.Col.value( 'PaymentTransactionToken[1]', 'NVARCHAR(Max)' ) AS PaymentTransactionToken,
		CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE @GetDate END AS ShipDate,
		CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
		CASE WHEN Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) END AS AddressId,
		Tbl.Col.value( 'PoDocument[1]', 'NVARCHAR(Max)' ) AS PoDocument,
		CASE WHEN Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) END  AS IsActive,
		Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
		CASE WHEN Tbl.Col.value( 'PaymentTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentTypeId[1]', 'NVARCHAR(Max)' ) END  AS PaymentTypeId,
		@UserId AS CreatedBy,
		@GetDate AS CreatedDate,
		@UserId AS ModifiedBy,
		@GetDate AS ModifiedDate,
		Tbl.Col.value( 'CreditCardNumber[1]', 'NVARCHAR(Max)' ) AS CreditCardNumber,
		CASE WHEN Tbl.Col.value( 'IsShippingCostEdited[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsShippingCostEdited[1]', 'NVARCHAR(Max)' ) END AS IsShippingCostEdited,
		CASE WHEN Tbl.Col.value( 'IsTaxCostEdited[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsTaxCostEdited[1]', 'NVARCHAR(Max)' ) END AS IsTaxCostEdited,
		Tbl.Col.value( 'ShippingDifference[1]', 'NVARCHAR(Max)' ) AS ShippingDifference,
		CASE WHEN Tbl.Col.value( 'EstimateShippingCost[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'EstimateShippingCost[1]', 'NVARCHAR(Max)' ) END AS EstimateShippingCost,
		Tbl.Col.value( 'TransactionId[1]', 'NVARCHAR(Max)' ) AS TransactionId,
		Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
		Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
		Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
		Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
		Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
		Tbl.Col.value( 'FirstName[1]', 'NVARCHAR(Max)' ) AS FirstName,
		Tbl.Col.value( 'LastName[1]', 'NVARCHAR(Max)' ) AS LastName,
		Tbl.Col.value( 'CardType[1]', 'NVARCHAR(Max)' ) AS CardType,
		Tbl.Col.value( 'CreditCardExpMonth[1]', 'NVARCHAR(Max)' ) AS CreditCardExpMonth,
		Tbl.Col.value( 'CreditCardExpYear[1]', 'NVARCHAR(Max)' ) AS CreditCardExpYear,
		CASE WHEN Tbl.Col.value( 'TotalAdditionalCost[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TotalAdditionalCost[1]', 'NVARCHAR(Max)' ) END AS TotalAdditionalCost,
		Tbl.Col.value( 'PaymentDisplayName[1]', 'NVARCHAR(Max)' ) AS PaymentDisplayName,
		Tbl.Col.value( 'PaymentExternalId[1]', 'NVARCHAR(Max)' ) AS PaymentExternalId,
		Tbl.Col.value( 'CultureCode[1]', 'NVARCHAR(Max)' ) AS CultureCode,
		Tbl.Col.value( 'DisplayName[1]', 'NVARCHAR(Max)' ) AS DisplayName,
		Tbl.Col.value( 'InHandDate[1]', 'NVARCHAR(Max)' ) AS InHandDate,
		Tbl.Col.value( 'IpAddress[1]', 'NVARCHAR(Max)' ) AS IpAddress,
		Tbl.Col.value( 'JobName[1]', 'NVARCHAR(Max)' ) AS JobName,
		Tbl.Col.value( 'ShippingConstraintCode[1]', 'NVARCHAR(Max)' ) AS ShippingConstraintCode,
		Tbl.Col.value( 'ShippingDiscount[1]', 'NVARCHAR(Max)' ) AS ShippingDiscount,
		Tbl.Col.value( 'ShippingHandlingCharges[1]', 'NVARCHAR(Max)' ) AS ShippingHandlingCharges,
		CASE WHEN Tbl.Col.value( 'ReturnCharges[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'ReturnCharges[1]', 'NVARCHAR(Max)' ) END AS ReturnCharges,
		CASE WHEN Tbl.Col.value( 'IsCalculateTaxAfterDiscount[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsCalculateTaxAfterDiscount[1]', 'NVARCHAR(Max)' ) END AS IsCalculateTaxAfterDiscount,
		Tbl.Col.value( 'Email[1]', 'NVARCHAR(Max)' ) AS Email,
		Tbl.Col.value( 'PhoneNumber[1]', 'NVARCHAR(Max)' ) AS PhoneNumber,
		CASE WHEN Tbl.Col.value( 'OrderTotalWithoutVoucher[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OrderTotalWithoutVoucher[1]', 'NVARCHAR(Max)' )  END AS OrderTotalWithoutVoucher,
		CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )='' THEN '' ELSE Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
		CASE WHEN Tbl.Col.value( 'TaxCost[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'TaxCost[1]', 'NVARCHAR(Max)' ) END  AS TaxCost,
		CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
		CASE WHEN Tbl.Col.value( 'SubTotal[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'SubTotal[1]', 'NVARCHAR(Max)' ) END AS SubTotal,
		Tbl.Col.value( 'CurrencyCode[1]', 'NVARCHAR(Max)' ) AS CurrencyCode,
		CASE WHEN Tbl.Col.value( 'OverDueAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OverDueAmount[1]', 'NVARCHAR(Max)' ) END AS OverDueAmount,
		CASE WHEN Tbl.Col.value( 'ShippingTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingTypeId[1]', 'NVARCHAR(Max)' ) END AS ShippingTypeId,
		Tbl.Col.value( 'AccountNumber[1]', 'NVARCHAR(Max)' ) AS AccountNumber,
		Tbl.Col.value( 'ShippingMethod[1]', 'NVARCHAR(Max)' ) AS ShippingMethod,
		Tbl.Col.value( 'PaymentCode[1]', 'NVARCHAR(Max)' ) AS PaymentCode,
		CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId
	FROM @OrderXML.nodes( '//PlaceOrderModel' ) AS Tbl(Col);


	--Getting billing address info
	INSERT INTO #TempOrderBillingAddress
	(
		AddressId,BillingFirstName,BillingLastName,BillingCompanyName,BillingStreet1,BillingStreet2,
		BillingCity,BillingStateCode,BillingPostalCode,BillingCountry,BillingPhoneNumber,BillingEmailId
	)
	SELECT
		Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) AS AddressId,
		Tbl.Col.value( 'FirstName[1]', 'NVARCHAR(Max)' ) AS FirstName,
		Tbl.Col.value( 'LastName[1]', 'NVARCHAR(Max)' ) AS LastName,
		Tbl.Col.value( 'CompanyName[1]', 'NVARCHAR(Max)' ) AS CompanyName,
		Tbl.Col.value( 'Street1[1]', 'NVARCHAR(Max)' ) AS Street1 ,
		Tbl.Col.value( 'Street2[1]', 'NVARCHAR(Max)' ) AS Street2,
		Tbl.Col.value( 'City[1]', 'NVARCHAR(Max)' ) AS City,
		Tbl.Col.value( 'StateCode[1]', 'NVARCHAR(Max)' ) AS StateCode,
		Tbl.Col.value( 'PostalCode[1]', 'NVARCHAR(Max)' ) AS PostalCode,
		Tbl.Col.value( 'Country[1]', 'NVARCHAR(Max)' ) AS Country,
		Tbl.Col.value( 'PhoneNumber[1]', 'NVARCHAR(Max)' ) AS PhoneNumber,
		Tbl.Col.value( 'EmailId[1]', 'NVARCHAR(Max)' ) AS EmailId
	FROM @OrderXML.nodes( '//PlaceOrderModel/BillingAddressModel' ) AS Tbl(Col);
	----Parent line item details insert
	INSERT INTO #TempParentLineItemDetails
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description,Quantity,
		Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber,
		PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles,
		RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy,
		ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity,
		TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty, GroupIdentifier
	)
	SELECT
		CASE WHEN Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemRelationshipTypeId,
		CASE WHEN Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) END  AS OmsOrderDetailsId,
		CASE WHEN Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderShipmentId,
		CASE WHEN Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) END AS RmaReasonForReturnId,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(2000)' ) AS ProductName,
		Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
		Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(Max)' ) AS Quantity,
		CASE WHEN Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) END AS Price,
		Tbl.Col.value( 'Weight[1]', 'NVARCHAR(Max)' ) AS Weight,
		Tbl.Col.value( 'DownloadLink[1]', 'NVARCHAR(Max)' ) AS DownloadLink,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		Tbl.Col.value( 'ShipSeparately[1]', 'NVARCHAR(Max)' ) AS ShipSeparately,
		CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE @GetDate END AS ShipDate,
		CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
		CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
		Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
		Tbl.Col.value( 'TransactionNumber[1]', 'NVARCHAR(Max)' ) AS TransactionNumber,
		CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId,
		Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
		CASE WHEN Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) END AS IsAutoGeneratedTracking,
		CASE WHEN Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemStateId,
		CASE WHEN Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) END AS IsRecurringBilling,
		Tbl.Col.value( 'RecurringBillingPeriod[1]', 'NVARCHAR(Max)' ) AS RecurringBillingPeriod,
		Tbl.Col.value( 'RecurringBillingCycles[1]', 'NVARCHAR(Max)' ) AS RecurringBillingCycles,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingFrequency,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingAmount,
		Tbl.Col.value( 'AppliedPromo[1]', 'NVARCHAR(Max)' ) AS AppliedPromo,
		Tbl.Col.value( 'CouponsApplied[1]', 'NVARCHAR(Max)' ) AS CouponsApplied,
		Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
		CASE WHEN Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) END AS IsActive,
		@UserId AS CreatedBy,
		@GetDate AS CreatedDate,
		@UserId AS ModifiedBy,
		@GetDate AS ModifiedDate,
		Tbl.Col.value( 'AutoAddonSKU[1]', 'NVARCHAR(Max)' ) AutoAddonSKU,
		CASE WHEN Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) END IsShippingReturn,
		CASE WHEN Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) END PartialRefundAmount,
		Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
		Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
		Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
		Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
		Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
		CASE WHEN Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) = ''  THEN NULL ELSE Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) END AS BundleQuantity,
		CASE WHEN Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) END AS TaxRuleId,
		Tbl.Col.value( 'TaxTransactionNumber[1]', 'NVARCHAR(Max)' ) AS TaxTransactionNumber,
		Tbl.Col.value( 'Comments[1]', 'NVARCHAR(Max)' ) AS Comments,
		CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
		CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
		CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
		CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END AS PST,
		CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END  AS HST,
		CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(Max)' ) AS GroupIdentifier
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel' ) AS Tbl(Col);

	----Child line item details insert
	INSERT INTO #TempChildLineItemDetails
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description,Quantity,
		Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber,
		PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles,
		RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy,
		ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity,
		TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty, ParentSku, GroupIdentifier
	)
	SELECT
		CASE WHEN Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemRelationshipTypeId,
		CASE WHEN Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderDetailsId,
		CASE WHEN Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderShipmentId,
		CASE WHEN Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) END AS RmaReasonForReturnId,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(2000)' ) AS ProductName,
		Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
		Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(Max)' ) AS Quantity,
		CASE WHEN Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) END AS Price,
		Tbl.Col.value( 'Weight[1]', 'NVARCHAR(Max)' ) AS Weight,
		Tbl.Col.value( 'DownloadLink[1]', 'NVARCHAR(Max)' ) AS DownloadLink,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		Tbl.Col.value( 'ShipSeparately[1]', 'NVARCHAR(Max)' ) AS ShipSeparately,
		CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE @GetDate END AS ShipDate,
		CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
		CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
		Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
		Tbl.Col.value( 'TransactionNumber[1]', 'NVARCHAR(Max)' ) AS TransactionNumber,
		CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId,
		Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
		CASE WHEN Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) END AS IsAutoGeneratedTracking,
		CASE WHEN Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemStateId,
		CASE WHEN Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) END AS IsRecurringBilling,
		Tbl.Col.value( 'RecurringBillingPeriod[1]', 'NVARCHAR(Max)' ) AS RecurringBillingPeriod,
		Tbl.Col.value( 'RecurringBillingCycles[1]', 'NVARCHAR(Max)' ) AS RecurringBillingCycles,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingFrequency,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingAmount,
		Tbl.Col.value( 'AppliedPromo[1]', 'NVARCHAR(Max)' ) AS AppliedPromo,
		Tbl.Col.value( 'CouponsApplied[1]', 'NVARCHAR(Max)' ) AS CouponsApplied,
		Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
		Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) AS IsActive,
		@UserId AS CreatedBy,
		@GetDate AS CreatedDate,
		@UserId AS ModifiedBy,
		@GetDate AS ModifiedDate,
		Tbl.Col.value( 'AutoAddonSKU[1]', 'NVARCHAR(Max)' ) AutoAddonSKU,
		CASE WHEN Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) END AS IsShippingReturn,
		CASE WHEN Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) END AS  PartialRefundAmount,
		Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
		Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
		Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
		Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
		Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
		CASE WHEN Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) END AS BundleQuantity,
		CASE WHEN Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) END AS TaxRuleId,
		Tbl.Col.value( 'TaxTransactionNumber[1]', 'NVARCHAR(Max)' ) AS TaxTransactionNumber,
		Tbl.Col.value( 'Comments[1]', 'NVARCHAR(Max)' ) AS Comments,
		CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
		CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
		CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
		CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END AS PST,
		CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END AS HST,
		CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE  Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
		Tbl.Col.value( 'ParentProductSKU[1]', 'NVARCHAR(Max)' ) AS ParentSku,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(Max)' ) AS GroupIdentifier
	FROM @OrderXML.nodes('//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/OrderLineItem/PlaceOrderlineItemCollection') AS Tbl(Col);

	--Updating parent for simple products
	UPDATE #TempChildLineItemDetails SET ParentSku = Sku WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdSimple
	AND OrderLineItemRelationshipTypeId IS NOT NULL

BEGIN TRAN OrderInsert

	--Inserting order number which are unique and getting in xml from code side
	INSERT INTO ZnodeOmsOrder(IsQuoteOrder,OrderNumber,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PublishStateId,IsOldOrder)
	OUTPUT INSERTED.OmsOrderId, INSERTED.OrderNumber INTO @OMSOrder
	SELECT 0 AS IsQuoteOrder, OrderNumber,OrderNumber AS ExternalId,@UserId,@GetDate,@UserId,@GetDate,PublishStateId, IsOldOrder
	FROM #TempOrderData
	WHERE ISNULL(OmsOrderId,0) = 0

	--If order is new then creating new order details
	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		INSERT INTO ZnodeOmsOrderDetails
		(
			OmsOrderId,PortalId,UserId,OrderDate,OmsOrderStateId,ShippingId,PaymentTypeId,BillingFirstName,BillingLastName
			,BillingCompanyName,BillingStreet1,BillingStreet2,BillingCity,BillingStateCode,BillingPostalCode,BillingCountry
			,BillingPhoneNumber,BillingEmailId,TaxCost,ShippingCost,SubTotal,DiscountAmount,CurrencyCode,OverDueAmount,Total
			,ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive
			,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
			,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
			,DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
			,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty
		)
		OUTPUT INSERTED.OmsOrderId, INSERTED.OmsOrderDetailsId INTO @OMSOrderDetail
		SELECT OO.OmsOrderId, OD.PortalId,@UserId,@GetDate,OD.OmsOrderStateId,OD.ShippingId,OD.PaymentTypeId,OBA.BillingFirstName,OBA.BillingLastName,OBA.BillingCompanyName,
			OBA.BillingStreet1,OBA.BillingStreet2,OBA.BillingCity,OBA.BillingStateCode,OBA.BillingPostalCode,OBA.BillingCountry,OBA.BillingPhoneNumber,OBA.BillingEmailId,OD.TaxCost,
			OD.ShippingCost,OD.SubTotal, OD.DiscountAmount,OD.CurrencyCode,OD.OverDueAmount,OD.Total
			,OD.ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,OD.BillingAddressId,PoDocument,CAST(1 AS BIT) AS IsActive
			,OD.ExternalId,OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
			,ShippingDifference,EstimateShippingCost,TransactionId,OD.Custom1,OD.Custom2,OD.Custom3,OD.Custom4,OD.Custom5,OD.FirstName,OD.LastName
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
			,OD.DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
			,IsCalculateTaxAfterDiscount,Email,OD.PhoneNumber,OrderTotalWithoutVoucher,ImportDuty
		FROM #TempOrderData OD
		INNER JOIN @OMSOrder OO ON OD.OrderNumber = OO.OrderNumber
		LEFT JOIN #TempOrderBillingAddress OBA ON OD.BillingAddressId = OBA.AddressId

	END
	--If order managed then creating new order details and disable old order details
	ELSE
	BEGIN
		Declare @OldOmsOrderDetailsId INT
		SET @OldOmsOrderDetailsId = (SELECT TOP 1 OOD.OmsOrderDetailsId FROM ZnodeOmsOrderDetails OOD  WITH (NOLOCK) 
									 WHERE EXISTS(SELECT * FROM  #TempOrderData OD WHERE OOD.OmsOrderId = OD.OmsOrderId) AND OOD.IsActive = 1)

		INSERT INTO ZnodeOmsOrderDetails
		(
			OmsOrderId,PortalId,UserId,OrderDate,OmsOrderStateId,ShippingId,PaymentTypeId,BillingFirstName,BillingLastName --1
			,BillingCompanyName,BillingStreet1,BillingStreet2,BillingCity,BillingStateCode,BillingPostalCode,BillingCountry --2
			,BillingPhoneNumber,BillingEmailId,TaxCost,ShippingCost,SubTotal,DiscountAmount,CurrencyCode,OverDueAmount,Total --3
			,ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId --4
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive --5
			,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited --6
			,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName --7
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName, --8
			PaymentExternalId,CultureCode, --9
			DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges --10
			,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty --11 
		)
		OUTPUT INSERTED.OmsOrderId, INSERTED.OmsOrderDetailsId INTO @OMSOrderDetail
		SELECT OO.OmsOrderId, OD.PortalId,@UserId,@GetDate,OD.OmsOrderStateId,OD.ShippingId,OD.PaymentTypeId,OBA.BillingFirstName,OBA.BillingLastName,--1
			OBA.BillingCompanyName,OBA.BillingStreet1,OBA.BillingStreet2,OBA.BillingCity,OBA.BillingStateCode,OBA.BillingPostalCode,OBA.BillingCountry, --2
			OBA.BillingPhoneNumber,OBA.BillingEmailId,OD.TaxCost,OD.ShippingCost,OD.SubTotal, OD.DiscountAmount,OD.CurrencyCode,OD.OverDueAmount,OD.Total, --3
			OD.ShippingNumber,OD.TrackingNumber,OD.CouponCode,OD.PromoDescription,OD.ReferralUserId,OD.PurchaseOrderNumber,OD.OmsPaymentStateId, --4
			OD.WebServiceDownloadDate,OD.PaymentSettingId,OD.PaymentTransactionToken,OD.ShipDate,OD.ReturnDate,OD.BillingAddressId,OD.PoDocument,CAST(1 AS BIT) AS IsActive --5
			,OD.ExternalId,OD.CreatedBy,OOD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.CreditCardNumber,OD.IsShippingCostEdited,OD.IsTaxCostEdited, --6
			OD.ShippingDifference,OD.EstimateShippingCost,OD.TransactionId,OD.Custom1,OD.Custom2,OD.Custom3,OD.Custom4,OD.Custom5,OD.FirstName,OD.LastName, --7
			OD.CardType,OD.CreditCardExpMonth,OD.CreditCardExpYear,OD.TotalAdditionalCost,CASE WHEN OD.PaymentSettingId = OOD.PaymentSettingId THEN OOD.PaymentDisplayName ELSE OD.PaymentDisplayName END AS PaymentDisplayName, --8
			CASE WHEN OD.PaymentSettingId = OOD.PaymentSettingId THEN OOD.PaymentExternalId ELSE OD.PaymentExternalId END AS PaymentExternalId,OD.CultureCode, --9 
			OD.DisplayName,OD.InHandDate,OD.IpAddress,OD.JobName,OD.ShippingConstraintCode,OD.ShippingDiscount,OD.ShippingHandlingCharges,OD.ReturnCharges, --10
			OD.IsCalculateTaxAfterDiscount,OD.Email,OD.PhoneNumber,OD.OrderTotalWithoutVoucher,OD.ImportDuty --11
		FROM #TempOrderData OD
		INNER JOIN ZnodeOmsOrder OO WITH (NOLOCK) ON OD.OrderNumber = OO.OrderNumber
		INNER JOIN ZnodeOmsOrderDetails OOD  WITH (NOLOCK) ON OO.OmsOrderId = OOD.OmsOrderId AND OOD.IsActive = 1
		LEFT JOIN #TempOrderBillingAddress OBA ON OD.BillingAddressId = OBA.AddressId
	
		DECLARE @OmsOrderStateIdCancelled int =  (select top 1 OmsOrderStateId FROM ZnodeOmsOrderState WHERE OrderStateName = 'CANCELLED')

		UPDATE ZnodeOmsOrderDetails SET IsActive = 0 , OmsOrderStateId = @OmsOrderStateIdCancelled
		WHERE OmsOrderDetailsId = @OldOmsOrderDetailsId

		UPDATE ZnodeOmsOrderLineItems SET IsActive = 0
		WHERE OmsOrderDetailsId = @OldOmsOrderDetailsId
	END

	----Geting new OmsOrderDetailsId always
	Declare @OmsOrderDetailsId INT
	SET @OmsOrderDetailsId = ( SELECT TOP 1 OmsOrderDetailsId FROM @OMSOrderDetail )

	--Insert Order notes only for new order details
	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		INSERT INTO ZnodeOmsNotes(OmsOrderDetailsId,Notes,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
		SELECT @OmsOrderDetailsId,Tbl.Col.value( 'AdditionalInstructions[1]', 'NVARCHAR(Max)' ) AS Notes,
			@UserId,@GetDate,@UserId,@GetDate
		FROM @OrderXML.nodes( '//PlaceOrderModel' ) AS Tbl(Col)
		WHERE Tbl.Col.value( 'AdditionalInstructions[1]', 'NVARCHAR(Max)' ) <> '';
	END

	----Inserting parent line item data
	INSERT INTO ZnodeOmsOrderLineItems
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description --1
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber --2
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles --3
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy --4
		,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, GroupIdentifier --5
	)
	OUTPUT INSERTED.OmsOrderDetailsId, INSERTED.OmsOrderLineItemsId, INSERTED.Sku,INSERTED.ParentOmsOrderLineItemsId, INSERTED.GroupId, INSERTED.OrderLineItemRelationshipTypeId,INSERTED.GroupIdentifier INTO @OmsParentOrderLineItems
	SELECT OrderLineItemRelationshipTypeId,@OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description--1
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber --2
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles --3
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,ISNULL(IsActive,1) AS IsActive,CreatedBy,CreatedDate,ModifiedBy --4
		,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, GroupIdentifier --5
	FROM #TempParentLineItemDetails PLID

	----Inserting child line item data
	INSERT INTO ZnodeOmsOrderLineItems
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description --1
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber --2
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles --3
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy --4
		,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, --5
		ParentSku, GroupIdentifier --6
	)
	OUTPUT INSERTED.OmsOrderDetailsId, INSERTED.OmsOrderLineItemsId, INSERTED.Sku,INSERTED.ParentOmsOrderLineItemsId, INSERTED.GroupId, INSERTED.OrderLineItemRelationshipTypeId, INSERTED.ParentSku, INSERTED.GroupIdentifier INTO @OmsOrderLineItems
	SELECT PLID.OrderLineItemRelationshipTypeId,@OmsOrderDetailsId,PLID.OmsOrderShipmentId,PLID.RmaReasonForReturnId,PLID.Sku,PLID.ProductName,PLID.Description, --1
		PLID.Quantity,PLID.Price,PLID.Weight,PLID.DownloadLink,PLID.DiscountAmount,PLID.ShipSeparately,PLID.ShipDate,PLID.ReturnDate,PLID.ShippingCost,PLID.PromoDescription,PLID.TransactionNumber, --2
		PLID.PaymentStatusId,PLID.TrackingNumber,PLID.IsAutoGeneratedTracking,PLID.OrderLineItemStateId,PLID.IsRecurringBilling,PLID.RecurringBillingPeriod,PLID.RecurringBillingCycles,--3
		PLID.RecurringBillingFrequency,PLID.RecurringBillingAmount,PLID.AppliedPromo,PLID.CouponsApplied,PLID.ExternalId,isnull(PLID.IsActive,1) AS IsActive,PLID.CreatedBy,PLID.CreatedDate,PLID.ModifiedBy, --4
		PLID.ModifiedDate,PLID.AutoAddonSKU,PLID.IsShippingReturn,PLID.PartialRefundAmount,PLID.Custom1,PLID.Custom2,PLID.Custom3,PLID.Custom4,PLID.Custom5,PLID.GroupId,PLID.BundleQuantity, --5
		case when PLID.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdSimple then PLID.Sku else PLID.ParentSku end AS ParentSku, GroupIdentifier --6
	FROM #TempChildLineItemDetails PLID

	--Updating ParentOmsOrderLineItemsId for child line items for simple, group and configurable products
	UPDATE A SET A.ParentOmsOrderLineItemsId = (SELECT TOP 1 OmsOrderLineItemsId FROM @OmsParentOrderLineItems d WHERE d.GroupIdentifier = a.GroupIdentifier AND A.ParentSku = D.Sku  and ISNULL(a.GroupId,'-') = ISNULL(d.GroupId,'-'))
	FROM @OmsOrderLineItems a
	WHERE a.OrderLineItemRelationshipTypeId NOT IN ( @OrderLineItemRelationshipTypeIdAddon, @OrderLineItemRelationshipTypeIdGroup)  
	AND a.ParentOmsOrderLineItemsId IS NULL 
	
	--Updating ParentOmsOrderLineItemsId for child line items for group products
	IF EXISTS(SELECT * FROM @OmsOrderLineItems WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdGroup)
	BEGIN
		---Getting child lineitems for group product
		;WITH Cte_GroupProductChild AS
		(
			SELECT GroupIdentifier,Sku, ParentSku, OmsOrderLineItemsId, ParentOmsOrderLineItemsId,Dense_Rank()Over(Partition By GroupIdentifier ORDER BY OmsOrderLineItemsId) AS RowId1 
			FROM @OmsOrderLineItems
			WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdGroup
		)
		---Getting parent lineitems for group product
		,Cte_GroupProductParent AS 
		(
			SELECT GroupIdentifier,Sku, OmsOrderLineItemsId, Dense_Rank()Over(Partition By GroupIdentifier ORDER BY OmsOrderLineItemsId) AS RowId1 
			FROM @OmsParentOrderLineItems a
			WHERE OrderLineItemRelationshipTypeId IS NULL
			AND EXISTS(SELECT * FROM @OmsOrderLineItems b WHERE a.GroupIdentifier = b.GroupIdentifier AND a.Sku = b.ParentSku)
		)
		--Updating ParentOmsOrderLineItemsId on child for group products
		UPDATE a SET a.ParentOmsOrderLineItemsId = b.OmsOrderLineItemsId
		FROM Cte_GroupProductChild a
		INNER JOIN Cte_GroupProductParent B ON A.GroupIdentifier = B.GroupIdentifier AND a.RowId1 = b.RowId1 AND b.Sku = a.ParentSku 
	END

	---Updating ParentOmsOrderLineItemsId for addons if present
	IF EXISTS(SELECT * FROM @OmsOrderLineItems WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
	BEGIN
		--Updating ParentOmsOrderLineItemsId for addon with Simple products , group products and configurable products
		UPDATE b SET b.ParentOmsOrderLineItemsId = c.OmsOrderLineItemsId
		FROM @OmsOrderLineItems c
		INNER JOIN @OmsOrderLineItems b on b.ParentSku = c.Sku AND c.GroupIdentifier = b.GroupIdentifier
		WHERE c.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon and c.OrderLineItemRelationshipTypeId is not null
		and b.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
		AND b.ParentOmsOrderLineItemsId IS NULL
		
		--Updating ParentOmsOrderLineItemsId for addon with bundle products
		UPDATE c SET c.ParentOmsOrderLineItemsId = b.OmsOrderLineItemsId
		FROM @OmsOrderLineItems c
		INNER JOIN @OmsParentOrderLineItems b on B.sku = C.parentsku AND c.GroupIdentifier= b.GroupIdentifier
		WHERE B.OrderLineItemRelationshipTypeId is null 
		AND c.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
		AND C.ParentOmsOrderLineItemsId IS NULL
	 END
	 ---Updating ParentOmsOrderLineItemsId in main table
	 UPDATE a SET a.ParentOmsOrderLineItemsId = b.ParentOmsOrderLineItemsId
	 FROM  ZnodeOmsOrderLineItems a
	 INNER JOIN @OmsOrderLineItems b on a.OmsOrderLineItemsId = b.OmsOrderLineItemsId

	----Shipping details Start
	DECLARE @ShippingTypeId INT
	IF EXISTS(SELECT * FROM #TempOrderData WHERE ShippingTypeId IS NULL)
	BEGIN
		SET @ShippingTypeId = (SELECT TOP 1 ShippingTypeId FROM ZnodeShipping WHERE EXISTS(SELECT * FROM #TempOrderData WHERE ZnodeShipping.ShippingId = #TempOrderData.ShippingId))
	END
	ELSE
	BEGIN
		SET @ShippingTypeId = (SELECT TOP 1 ShippingTypeId FROM #TempOrderData)
	END
	IF EXISTS(SELECT * FROM ZnodeShippingTypes WITH (NOLOCK)  WHERE ShippingTypeId = @ShippingTypeId AND ClassName = 'ZnodeCustomerShipping')
	BEGIN
		INSERT INTO ZnodeOmsCustomerShipping(OmsOrderDetailsId,UserId,ShippingTypeId,AccountNumber,ShippingMethod,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT TOP 1 @OmsOrderDetailsId,@UserId,@ShippingTypeId,AccountNumber,ShippingMethod,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		FROM #TempOrderData
	END
	----Shipping details end

	----Order tax details start
	----Inserting order tax data
	IF (SELECT TOP 1 TaxCost FROM #TempOrderData) > 0
	BEGIN
		INSERT INTO ZnodeOmsTaxOrderDetails(OmsOrderDetailsId,SalesTax,VAT,GST,PST,HST,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportDuty)
		SELECT @OmsOrderDetailsId,OD.SalesTax,OD.VAT,OD.GST,OD.PST,OD.HST,OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.ImportDuty
		FROM #TempOrderData OD
	END

	----Inserting order tax data for parent line item
	INSERT INTO ZnodeOmsTaxOrderLineDetails
	(
		OmsOrderLineItemsId,TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty,
		CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
	)
	SELECT POLI.OmsOrderLineItemsId,CLID.TaxRuleId,CLID.TaxTransactionNumber,CLID.Comments,CLID.SalesTax,CLID.VAT,CLID.GST,CLID.PST,CLID.HST,CLID.ImportDuty,
	CLID.CreatedBy,CLID.CreatedDate,CLID.ModifiedBy,CLID.ModifiedDate
	FROM #TempParentLineItemDetails CLID
	INNER JOIN @OmsOrderLineItems POLI ON CLID.Sku = POLI.Sku AND ISNULL(CLID.GroupId,'') = ISNULL(POLI.GroupId,'') AND CLID.GroupIdentifier = POLI.GroupIdentifier
	WHERE POLI.ParentOmsOrderLineItemsId IS NULL
	AND (ISNULL(CLID.SalesTax,0)+ISNULL(CLID.VAT,0)+ISNULL(CLID.GST,0)+ISNULL(CLID.PST,0)+ISNULL(CLID.HST,0)) > 0

	----Inserting order tax data for child line item
	INSERT INTO ZnodeOmsTaxOrderLineDetails
	(
		OmsOrderLineItemsId,TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty,
		CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
	)
	SELECT POLI.OmsOrderLineItemsId,CLID.TaxRuleId,CLID.TaxTransactionNumber,CLID.Comments,CLID.SalesTax,CLID.VAT,CLID.GST,CLID.PST,CLID.HST,CLID.ImportDuty,
		CLID.CreatedBy,CLID.CreatedDate,CLID.ModifiedBy,CLID.ModifiedDate
	FROM #TempChildLineItemDetails CLID
	INNER JOIN @OmsOrderLineItems POLI ON CLID.Sku = POLI.Sku AND ISNULL(CLID.GroupId,'') = ISNULL(POLI.GroupId,'') AND CLID.GroupIdentifier = POLI.GroupIdentifier
	WHERE POLI.ParentOmsOrderLineItemsId IS NOT NULL
	AND (ISNULL(CLID.SalesTax,0)+ISNULL(CLID.VAT,0)+ISNULL(CLID.GST,0)+ISNULL(CLID.PST,0)+ISNULL(CLID.HST,0)) > 0
	----Order tax details end

	----Order attribte details start
	----Fetching order attributes FROM xml
	INSERT INTO #TempOrderAttribute(AttributeCode ,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AttributeValueCode,Sku,GroupId, GroupIdentifier )
	SELECT
		Tbl.Col.value( 'AttributeCode[1]', 'NVARCHAR(Max)' ) AS AttributeCode,
		Tbl.Col.value( 'AttributeValue[1]', 'NVARCHAR(Max)' ) AS AttributeValue,
		@UserId,@GetDate,@UserId,@GetDate,
		Tbl.Col.value( 'AttributeValueCode[1]', 'NVARCHAR(2000)' ) AS AttributeValueCode,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(2000)' ) AS GroupIdentifier
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/OrderLineItem/PlaceOrderlineItemCollection/OrderAttribute/PlaceOrderAttributeModel' ) AS Tbl(Col);

	----Inserting order attributes data
	INSERT INTO ZnodeOmsOrderAttribute(OmsOrderLineItemsId,AttributeCode,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AttributeValueCode)
	SELECT POLI.OmsOrderLineItemsId, OA.AttributeCode,OA.AttributeValue,OA.CreatedBy,OA.CreatedDate,OA.ModifiedBy,OA.CreatedDate,OA.AttributeValueCode
	FROM #TempOrderAttribute OA
	INNER JOIN @OmsOrderLineItems POLI ON OA.Sku = POLI.Sku AND ISNULL(OA.GroupId,'') = ISNULL(POLI.GroupId,'') AND OA.GroupIdentifier = POLI.GroupIdentifier
	----Order attribte details end

	----Personalise details start
	----Fetching personalize order data
	INSERT INTO #OmsPersonalizeItem(PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL,Sku,GroupId, GroupIdentifier)
	SELECT
		Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode,
		Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue,
		@UserId,@GetDate,@UserId,@GetDate,
		Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(2000)' ) AS DesignId,
		Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(2000)' ) AS ThumbnailURL,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(2000)' ) AS GroupIdentifier
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/PersonaliseDetails/PlaceOrderPersonaliseModel' ) AS Tbl(Col);

	--Inserting personalize order data
	INSERT INTO ZnodeOmsPersonalizeItem(OmsOrderLineItemsId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL)
	SELECT OmsOrderLineItemsId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL
	FROM #OmsPersonalizeItem OPI
	INNER JOIN @OmsParentOrderLineItems POLI ON OPI.Sku = POLI.Sku AND ISNULL(OPI.GroupId,'') = ISNULL(POLI.GroupId,'') AND OPI.GroupIdentifier = POLI.GroupIdentifier
	WHERE POLI.ParentOmsOrderLineItemsId IS NULL
	----Personalise details end

	----discount details start
	----Fetching order discount data
	INSERT INTO #OmsOrderDiscount
	(
		OmsDiscountTypeId ,DiscountCode,DiscountAmount ,Description ,CreatedBy ,CreatedDate ,
		ModifiedBy ,ModifiedDate ,PerQuantityDiscount,DiscountMultiplier ,DiscountLevelTypeId ,
		PromotionName ,PromotionTypeId ,DiscountAppliedSequence,PromotionMessage ,Sku,GroupId 
	)
	SELECT
	CASE WHEN Tbl.Col.value( 'OmsDiscountTypeId[1]', 'NVARCHAR(2000)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OmsDiscountTypeId[1]', 'NVARCHAR(2000)' ) END AS OmsDiscountTypeId,
		Tbl.Col.value( 'DiscountCode[1]', 'NVARCHAR(Max)' ) AS DiscountCode,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
		@UserId,@GetDate,@UserId,@GetDate,
		CASE WHEN Tbl.Col.value( 'PerQuantityDiscount[1]', 'NVARCHAR(2000)' )='' THEN NULL ELSE Tbl.Col.value( 'PerQuantityDiscount[1]', 'NVARCHAR(2000)' ) END AS PerQuantityDiscount,
		CASE WHEN Tbl.Col.value( 'DiscountMultiplier[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountMultiplier[1]', 'NVARCHAR(2000)' ) END AS DiscountMultiplier,
		CASE WHEN Tbl.Col.value( 'DiscountLevelTypeId[1]', 'NVARCHAR(2000)' )= '' THEN NULL ELSE Tbl.Col.value( 'DiscountLevelTypeId[1]', 'NVARCHAR(2000)' ) END AS DiscountLevelTypeId,
		Tbl.Col.value( 'PromotionName[1]', 'NVARCHAR(2000)' ) AS PromotionName,
		CASE WHEN Tbl.Col.value( 'PromotionTypeId[1]', 'NVARCHAR(2000)' )= '' THEN NULL ELSE Tbl.Col.value( 'PromotionTypeId[1]', 'NVARCHAR(2000)' ) END AS PromotionTypeId,
		Tbl.Col.value( 'DiscountAppliedSequence[1]', 'NVARCHAR(2000)' ) AS DiscountAppliedSequence,
		Tbl.Col.value( 'PromotionMessage[1]', 'NVARCHAR(2000)' ) AS PromotionMessage,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId
	FROM @OrderXML.nodes('//PlaceOrderModel/OrderDiscounts/PlaceOrderDiscountModel') AS Tbl(Col)

	----Inserting order discount data
	--Inserting product level discount for simple and group products
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,POLI.OmsOrderLineItemsId,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
		OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,POLI.ParentOmsOrderLineItemsId,
		OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	INNER JOIN @OmsOrderLineItems POLI ON OD.Sku = POLI.Sku AND ISNULL(OD.GroupId,'') = ISNULL(POLI.GroupId,'') 
	WHERE isnull(OD.Sku,'') <> '' AND POLI.OrderLineItemRelationshipTypeId IN (@OrderLineItemRelationshipTypeIdSimple , @OrderLineItemRelationshipTypeIdGroup)
	
	--Inserting product level discount for config and bundle products
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,POLI.ParentOmsOrderLineItemsId,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
	OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,NULL,
	OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	INNER JOIN @OmsOrderLineItems POLI ON OD.Sku = POLI.ParentSku AND ISNULL(OD.GroupId,'') = ISNULL(POLI.GroupId,'')
	WHERE isnull(OD.Sku,'') <> '' AND POLI.OrderLineItemRelationshipTypeId IN (@OrderLineItemRelationshipTypeIdBundles , @OrderLineItemRelationshipTypeIdConfig)
	
	--Inserting order level discount 
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,NULL,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
	OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,NULL,
	OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	WHERE isnull(OD.Sku,'') = ''
	----discount details end

	----Additional Cost details start
	IF OBJECT_ID('TEMPDB..#TempAdditionalCost') IS NOT NULL
	DROP TABLE #TempAdditionalCost
	--fetching additional cost details
	SELECT Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl1.Col.value( 'KeyName[1]', 'NVARCHAR(2000)' ) AS KeyName,
		CASE WHEN Tbl1.Col.value( 'KeyValue[1]', 'NVARCHAR(2000)' )='' THEN NULL ELSE Tbl1.Col.value( 'KeyValue[1]', 'NVARCHAR(2000)' ) END AS KeyValue,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId
	INTO #TempAdditionalCost
	FROM @OrderXML.nodes('//PlaceOrderModel/LineItems/PlaceOrderLineItemModel') AS Tbl(Col)
	CROSS APPLY Tbl.Col.nodes( '*:AdditionalCostList/AdditionalCost' ) AS Tbl1(Col);

	--Inserting additional cost details
	IF EXISTS(SELECT * FROM #TempAdditionalCost)
	BEGIN
		INSERT INTO ZnodeOmsOrderLineItemsAdditionalCost(OmsOrderLineItemsId,KeyName,KeyValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT OLI.OmsOrderLineItemsId, AC.KeyName, AC.KeyValue, @UserId, @GetDate, @UserId, @GetDate
		FROM #TempAdditionalCost AC
		INNER JOIN @OmsOrderLineItems OLI ON AC.Sku = OLI.Sku AND ISNULL(AC.GroupId,'') = ISNULL(OLI.GroupId,'') 
		WHERE OLI.ParentOmsOrderLineItemsId IS NULL
		AND ISNULL(AC.KeyName,'') <> ''
	END
	----Additional Cost details end
	
	DECLARE @OmsOrderId INT
	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		SET @OmsOrderId = (SELECT TOP 1 OmsOrderId FROM @OMSOrder)
	END
	ELSE
	BEGIN 
		SET @OmsOrderId = (SELECT TOP 1 OmsOrderId FROM #TempOrderData)
	END
	----RMA details start
	IF (SELECT TOP 1 OmsOrderId FROM #TempOrderData) > 0
	BEGIN
		DECLARE @OldOmsOrderDetailID INT
		SET @OmsOrderID = (SELECT TOP 1 OmsOrderId FROM #TempOrderData)
		SET @OldOmsOrderDetailID = (SELECT TOP 1 OmsOrderDetailsId FROM ZnodeOmsOrderDetails WHERE OmsOrderId = @OmsOrderID AND OmsOrderDetailsId <> @OmsOrderDetailsId ORDER BY OmsOrderDetailsId DESC)

		UPDATE ZnodeRmaReturnDetails
		SET OmsOrderDetailsId = @OmsOrderDetailsId
		WHERE OmsOrderId = @OmsOrderID

		SELECT OOLI.OmsOrderLineItemsId AS OldOmsOrderLineItemsId, OOLI.OmsOrderDetailsId, OOLI.Sku, LI.OmsOrderLineItemsId AS NewOmsOrderLineItemsId
		INTO #OldOrderLineItems
		FROM ZnodeOmsOrderLineItems OOLI WITH (NOLOCK)
		INNER JOIN @OmsOrderLineItems LI ON LI.Sku = OOLI.Sku
		WHERE OOLI.OmsOrderDetailsId = @OldOmsOrderDetailID --AND OOLI.ParentOmsOrderLineItemsId IS NULL
 
		UPDATE RRLI SET RRLI.OmsOrderLineItemsId = OldLI.NewOmsOrderLineItemsId
		FROM ZnodeRmaReturnLineItems RRLI
		INNER JOIN #OldOrderLineItems OldLI ON RRLI.OmsOrderLineItemsId = OldOmsOrderLineItemsId
	END
	----RMA details end
	
	---Inserting OrderTaxDetails
	IF(NOT EXISTS(SELECT 1 from ZnodeOmsTaxRule where OmsOrderId= @OmsOrderId)) AND (SELECT TOP 1 TaxCost FROM #TempOrderData) > 0
	BEGIN
		DECLARE @TaxCost Numeric(28,6), @TaxRuleId INT
		SET @TaxCost = (SELECT TOP 1 TaxCost FROM #TempOrderData)
		SET @TaxRuleId = (SELECT TOP 1 TaxRuleId FROM #TempChildLineItemDetails)

		 EXEC [Znode_InsertOrderTaxDetails] @OmsOrderId = @OmsOrderId, @TaxRuleId = @TaxRuleId, @TaxRate = @TaxCost, @Status = 0
	END

	COMMIT TRAN OrderInsert

	SELECT TOP 1 OmsOrderId,@OmsOrderDetailsId AS OmsOrderDetailsId, cast(1 AS bit)  AS Status, '' AS ErrorMessage
	FROM @OMSOrderDetail

END TRY
BEGIN CATCH
	ROLLBACK TRAN OrderInsert
	SELECT TOP 1 0 AS OmsOrderId,0 AS OmsOrderDetailsId, cast(0 AS bit)  AS Status, ERROR_MESSAGE() AS ErrorMessage

	INSERT INTO ZnodeOmsFailedOrderPayments(PaymentCode,PaymentDisplayName,TransactionToken,TotalAmount,UserName,UserId,Email,PaymentSettingId,OrderNumber,OrderDate,PaymentStatusId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
	SELECT TOP 1 PaymentCode,PaymentDisplayName, isnull(PaymentTransactionToken,''),Total,a.FirstName+' '+a.LastName,@UserId,a.Email,a.PaymentSettingId,a.OrderNumber,@GetDate,PaymentStatusId,@UserId,@GetDate,@UserId,@GetDate
	FROM #TempOrderData A
	
	DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertUpdateOmsOrder @OrderXML ='+CAST(@OrderXML AS VARCHAR(MAX))+' , @UserId = '+CAST(@UserId AS VARCHAR(50));

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName    = 'Znode_InsertUpdateOmsOrder',
	@ErrorInProcedure = @ERROR_PROCEDURE,
	@ErrorMessage     = @ErrorMessage,
	@ErrorLine        = @ErrorLine,
	@ErrorCall        = @ErrorCall;
	--If error throw in SP the deleting records FROM order tables if data inserted
	EXEC Znode_DeleteOrderById @OrderDetailId=@OmsOrderDetailsId,@Status=0
END CATCH

END

GO

Update ZnodeSearchFeature set HelpDescription = 'When an entered keyword is misspelled, Autocorrect helps in identifying the correct spelling to display the associated product.' 
where FeatureCode = 'AutoCorrect' and HelpDescription not like 'When an entered%'

GO

IF NOT EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME = 'IsActive' AND TABLE_NAME = 'ZnodePublishContentContainerVariantEntity')
BEGIN
	ALTER TABLE ZnodePublishContentContainerVariantEntity ADD IsActive BIT NULL
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeleteAssociatedVariants')
	DROP PROC Znode_DeleteAssociatedVariants
GO

CREATE PROCEDURE [dbo].[Znode_DeleteAssociatedVariants]
(
	@ContainerProfileVariantId  VARCHAR(2000),
	@Status  BIT = 0 OUT
)
AS
BEGIN
BEGIN TRY


	DECLARE @TBL_ContainerProfileVariantId TABLE(CMSContainerProfileVariantId INT); 
             
	INSERT INTO @TBL_ContainerProfileVariantId(CMSContainerProfileVariantId)
	SELECT Item FROM  dbo.Split(@ContainerProfileVariantId, ',')
		
	IF ((SELECT COUNT(1) FROM @TBL_ContainerProfileVariantId) = 1
	AND EXISTS(SELECT * FROM ZnodeCMSContainerProfileVariant 
			WHERE EXISTS(SELECT * FROM @TBL_ContainerProfileVariantId WP WHERE ZnodeCMSContainerProfileVariant.CMSContainerProfileVariantId = WP.CMSContainerProfileVariantId)
			AND ZnodeCMSContainerProfileVariant.ProfileId IS NULL AND ZnodeCMSContainerProfileVariant.PortalId IS NULL))
	BEGIN
		SET @Status = 0;
		SELECT 1 AS ID,
		CAST(0 AS BIT) AS [Status] ,'The default variant cannot be deleted.' AS Message;	
		RETURN
	END
	ELSE 
	BEGIN
		BEGIN TRAN DeleteAssociatedVariants
			DELETE WP
			FROM @TBL_ContainerProfileVariantId WP
			WHERE EXISTS(SELECT * FROM ZnodeCMSContainerProfileVariant WHERE ZnodeCMSContainerProfileVariant.CMSContainerProfileVariantId = WP.CMSContainerProfileVariantId AND ProfileId IS NULL AND PortalId IS NULL)
		
			DELETE  L FROM ZnodeWidgetGlobalAttributeValueLocale L	
			INNER JOIN ZnodeWidgetGlobalAttributeValue V ON L.WidgetGlobalAttributeValueId = V.WidgetGlobalAttributeValueId
			WHERE EXISTS(SELECT * FROM @TBL_ContainerProfileVariantId WP WHERE V.CMSContainerProfileVariantId = WP.CMSContainerProfileVariantId)

			DELETE ZnodeWidgetGlobalAttributeValue 
			WHERE EXISTS(SELECT * FROM @TBL_ContainerProfileVariantId WP WHERE ZnodeWidgetGlobalAttributeValue.CMSContainerProfileVariantId = WP.CMSContainerProfileVariantId)

			DELETE WPVL
			FROM ZnodeCMSContainerProfileVariantLocale WPVL
			WHERE EXISTS(SELECT * FROM ZnodeCMSContainerProfileVariant WPV
				WHERE EXISTS(SELECT * FROM @TBL_ContainerProfileVariantId WP WHERE WPV.CMSContainerProfileVariantId = WP.CMSContainerProfileVariantId)
				AND WPV.CMSContainerProfileVariantId = WPVL.CMSContainerProfileVariantId)

			DELETE ZnodeCMSContainerProfileVariant 
			WHERE EXISTS(SELECT * FROM @TBL_ContainerProfileVariantId WP WHERE ZnodeCMSContainerProfileVariant.CMSContainerProfileVariantId = WP.CMSContainerProfileVariantId)

			SET @Status = 1;
			SELECT 1 AS ID,
			CAST(1 AS BIT) AS [Status],'' as Message;	
		COMMIT TRAN DeleteAssociatedVariants;
	END
		

END TRY

BEGIN CATCH
	ROLLBACK TRAN DeleteAssociatedVariants;
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
	@ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeleteAssociatedVariants 
	@WidgetProfileVariantId = '+@ContainerProfileVariantId+',@Status='+CAST(@Status AS VARCHAR(50));

	SET @Status =0  
	SELECT 1 AS ID,@Status AS Status,'' Message;  
	
	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_DeleteAssociatedVariants',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	       
END CATCH

END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetCMSContainerProfileVariantlist')
	DROP PROC Znode_GetCMSContainerProfileVariantlist
GO

CREATE PROCEDURE [dbo].[Znode_GetCMSContainerProfileVariantlist]
(
	@WhereClause NVARCHAR(MAX)
	,@ContainerKey NVARCHAR(MAX)
	,@Rows INT = 100   
	,@PageNo INT = 1   
	,@Order_BY VARCHAR(1000) = ''
	,@RowsCount INT OUT
)
AS
-- EXEC Znode_GetCMSContainerProfileVariantlist '','',0,0,'',0
BEGIN  
BEGIN TRY 
SET NOCOUNT ON
	DECLARE @SQL NVARCHAR(MAX)
	CREATE TABLE #TBL_ContentContainer (CMSContainerProfileVariantId INT, ContainerKey NVARCHAR(MAX), PortalId INT, StoreName NVARCHAR(MAX), ProfileName NVARCHAR(200),CreatedByName VARCHAR(500), CreatedDate DATETIME, ModifiedByName VARCHAR(500),
		ModifiedDate DATETIME, IsDefaultVarient BIT,StoreCode VARCHAR(200),ProfileCode Varchar(200),RowId INT,CountNo INT,IsActive BIT,PublishStatus VARCHAR(32))  
	
	SELECT CAST(UserName AS NVARCHAR(500)) AS UserName , ZU.UserId
	INTO #Users
	FROM ZnodeUser ZU WITH (NOLOCK)
	WHERE EXISTS( SELECT * FROM ZnodeCMSContainerProfileVariant CWPV WHERE ZU.UserId = CWPV.CreatedBy )
	UNION
	SELECT UserName, ZU.UserId
	FROM ZnodeUser ZU
	WHERE EXISTS( SELECT * FROM ZnodeCMSContainerProfileVariant CWPV WHERE ZU.UserId = CWPV.ModifiedBy )

	SELECT DISTINCT WPV.CMSContainerProfileVariantId, ZCW.ContainerKey, WPV.PortalId, --ZCW.Tags,
		CASE WHEN WPV.PortalId IS NULL THEN  'Any Store' ELSE ZP.StoreName END StoreName  ,
		CASE WHEN WPV.ProfileId IS NULL THEN  'Any User Profile' ELSE ZPr.ProfileName END ProfileName, 
		U.UserName AS CreatedByName, WPV.CreatedDate, U1.UserName AS ModifiedByName, WPV.ModifiedDate,
		CAST(CASE WHEN WPV.ProfileId IS NULL AND WPV.PortalId IS NULL THEN 1 ELSE 0 END AS BIT) AS IsDefaultVarient,
		CASE WHEN WPV.PortalId IS NULL THEN  'AnyStore' ELSE ZP.StoreCode END StoreCode ,
		CASE WHEN WPV.ProfileId IS NULL THEN  'AnyUserProfile' ELSE ZPr.DefaultExternalAccountNo END ProfileCode,
		CPVL.IsActive As Status,ZPS.DisplayName As PublishStatus
	INTO #Cte_ContentContainerVarient
	FROM ZnodeCMSContentContainer ZCW 
	INNER JOIN ZnodeCMSContainerProfileVariant WPV ON WPV.CMSContentContainerId = ZCW.CMSContentContainerId
	LEFT JOIN ZnodeCMSContainerProfileVariantLocale CPVL ON WPV.CMSContainerProfileVariantId=CPVL.CMSContainerProfileVariantId
	LEFT JOIN ZnodePublishState ZPS ON WPV.PublishStateId=ZPS.PublishStateId
	LEFT JOIN ZnodePortal ZP ON (WPV.PortalId = ZP.PortalId ) 
	LEFT JOIN ZnodeProfile ZPr ON WPV.ProfileId = ZPr.ProfileId
	LEFT JOIN #Users U ON WPV.CreatedBy = U.UserId
	LEFT JOIN #Users U1 ON WPV.ModifiedBy = U1.UserId
	WHERE ZCW.ContainerKey = @ContainerKey 

	SET @SQL = '   
	;With Cte_ContentContainerVarientList AS
	(
		SELECT CMSContainerProfileVariantId, ContainerKey, PortalId, StoreName, ProfileName,CreatedByName, CreatedDate, ModifiedByName, ModifiedDate, IsDefaultVarient,StoreCode,ProfileCode,
		'+dbo.Fn_GetPagingRowId(@Order_BY,'IsDefaultVarient ASC,CMSContainerProfileVariantId DESC')+',Count(*)Over() CountNo,Status,PublishStatus
		FROM #Cte_ContentContainerVarient
		WHERE 1=1 '+dbo.Fn_GetFilterWhereClause(@WhereClause)+'
	)
	INSERT INTO #TBL_ContentContainer 
	SELECT * 
	FROM Cte_ContentContainerVarientList

	SELECT CMSContainerProfileVariantId as ContainerProfileVariantId, ContainerKey, PortalId, StoreName, ProfileName,CreatedByName, CreatedDate, ModifiedByName, ModifiedDate, IsDefaultVarient ,StoreCode,ProfileCode,IsActive,PublishStatus
	FROM #TBL_ContentContainer   
	'+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows) +'
	 ORDER BY RowId'

	EXEC (@SQL)
	SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM #TBL_ContentContainer ),0)  

END TRY
BEGIN CATCH
	DECLARE @Status BIT ;
	SET @Status = 0;
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= 
	ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 
	'EXEC Znode_GetCMSContainerProfileVariantlist @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',
	@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',
	@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));

	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;   

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_GetCMSContainerProfileVariantlist',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
END CATCH; 
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishContentContainerVariantEntity')
	DROP PROC Znode_PublishContentContainerVariantEntity
GO

CREATE PROCEDURE [dbo].[Znode_PublishContentContainerVariantEntity]
(
	 @ContainerKey VARCHAR(50) = ''
	,@RevisionState VARCHAR(50) = 'Production'
	,@UserId INT = 0
	,@OldPreviewId INT = 0
	,@OldProductionId INT = 0
	,@ContainerProfileVariantId INT = 0
	,@Status BIT = 0 OUTPUT
)
AS
/*
	if profileid and portalid will null then it must be publish.
	This Procedure is used to publish the Content Container Variant against the store 

	EXEC [Znode_PublishContentContainerVariantEntity] 1 2,3

	EXEC Znode_PublishContentContainerVariantEntity @@ContainerKey='',@RevisionState='Production',@UserId=2,
	@OldPreviewId=0,@OldProductionId=

	SELECT * FROM ZnodePublishContentContainerVariantEntity

*/
BEGIN 
BEGIN TRY 
SET NOCOUNT ON

	DECLARE @VersionId Int
	SET @VersionId = ( SELECT TOP 1 VersionId FROM ZnodePublishContetContainerVersionEntity WHERE PublishState = @RevisionState )

	IF ISNULL(@VersionId,0) = 0 AND @RevisionState = 'PREVIEW'
	BEGIN
		INSERT INTO ZnodePublishContetContainerVersionEntity(PublishStartTime,PublishState)
		SELECT GETDATE(),'PREVIEW'
		SET @VersionId = @@IDENTITY
	END
	
	IF ISNULL(@VersionId,0) = 0 AND @RevisionState = 'PRODUCTION'
 	BEGIN
		INSERT INTO ZnodePublishContetContainerVersionEntity(PublishStartTime,PublishState)
		SELECT GETDATE(),'PRODUCTION'
		SET @VersionId = @@IDENTITY
	END 


		DECLARE @SetLocaleId INT, @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleId(), @MaxCount INT =0 , @IncrementalId INT = 1;
		DECLARE @TBL_Locale TABLE (LocaleId INT , RowId INT IDENTITY(1,1));
		DECLARE @TBL_ContentContainerVariantEntity TABLE
			(CMSContainerProfileVariantId INT,PortalId INT, LocaleId INT, Name NVARCHAR(100), ContainerKey NVARCHAR(50),	CMSContentContainerId INT, ProfileId INT,
				CMSContainerTemplateId INT, CreatedBy INT, CreatedDate DATETIME, ModifiedBy INT, ModifiedDate DATETIME,IsActive BIT);

		INSERT INTO @TBL_Locale (LocaleId)
		SELECT LocaleId
		FROM ZnodeLocale
		WHERE IsActive =1 --AND (LocaleId = @LocaleId OR @LocaleId = 0);

		SET @MaxCount = ISNULL((SELECT MAx(RowId) FROM @TBL_Locale),0);

		WHILE @IncrementalId <= @MaxCount
		BEGIN 
			SET @SetLocaleId = (SELECT TOP 1 LocaleId FROM @TBL_locale WHERE  RowId = @IncrementalId);

			;WITH Cte_CMSContainerProfileVariant AS
			(
				SELECT DISTINCT WPV.CMSContainerProfileVariantId, ZCW.ContainerKey, WPV.PortalId, --ZCW.Tags,
					CASE WHEN WPV.PortalId IS NULL THEN  'Any Store' ELSE ZP.StoreName END StoreName  ,
					CASE WHEN WPV.ProfileId IS NULL THEN  'Any User Profile' ELSE ZPR.ProfileName END ProfileName, 
					GETDATE() As CreatedDate, GETDATE() As ModifiedDate,
					CAST(CASE WHEN WPV.ProfileId IS NULL AND WPV.PortalId IS NULL THEN 1 ELSE 0 END AS BIT) AS IsDefaultVarient,
					CASE WHEN WPV.PortalId IS NULL THEN  'AnyStore' ELSE ZP.StoreCode END StoreCode ,
					CASE WHEN WPV.ProfileId IS NULL THEN  'AnyUserProfile' ELSE ZPR.DefaultExternalAccountNo END ProfileCode,
					CPVL.LocaleId,ZCW.Name,ZCW.CMSContentContainerId,WPV.ProfileId,CPVL.CMSContainerTemplateId,CPVL.IsActive
				FROM ZnodeCMSContentContainer ZCW
				INNER JOIN ZnodeCMSContainerProfileVariant WPV ON WPV.CMSContentContainerId = ZCW.CMSContentContainerId
				INNER JOIN ZnodeCMSContainerProfileVariantLocale CPVL ON WPV.CMSContainerProfileVariantId=CPVL.CMSContainerProfileVariantId
				LEFT JOIN ZnodePortal ZP ON (WPV.PortalId = ZP.PortalId ) 
				LEFT JOIN ZnodeProfile ZPR ON WPV.ProfileId = ZPR.ProfileId
				WHERE (CPVL.LocaleId = @SetLocaleId) -- OR CPVL.LocaleId = @DefaultLocaleId
				--AND CPVL.IsActive = 1 
				AND (ZCW.ContainerKey = @ContainerKey OR @ContainerKey = '' )
				AND ( WPV.CMSContainerProfileVariantId = @ContainerProfileVariantId OR @ContainerProfileVariantId = 0)
			)
			, Cte_GetFirstFilterData AS
			(
				SELECT CMSContainerProfileVariantId,ContainerKey,PortalId,StoreName,ProfileName,CreatedDate,ModifiedDate,IsDefaultVarient,
					StoreCode,ProfileCode,LocaleId,Name,CMSContentContainerId,ProfileId,CMSContainerTemplateId,IsActive
				FROM Cte_CMSContainerProfileVariant
				WHERE LocaleId = @SetLocaleId
			)
			, Cte_GetDefaultFilterData AS
			(
				SELECT CMSContainerProfileVariantId,ContainerKey,PortalId,StoreName,ProfileName,CreatedDate,ModifiedDate,IsDefaultVarient,
					StoreCode,ProfileCode,LocaleId,Name,CMSContentContainerId,ProfileId,CMSContainerTemplateId,IsActive
				FROM Cte_GetFirstFilterData
				UNION ALL
				SELECT CMSContainerProfileVariantId,ContainerKey,PortalId,StoreName,ProfileName,CreatedDate,ModifiedDate,IsDefaultVarient,
					StoreCode,ProfileCode,LocaleId,Name,CMSContentContainerId,ProfileId,CMSContainerTemplateId,IsActive
				FROM Cte_CMSContainerProfileVariant CTEC
				WHERE  LocaleId = @DefaultLocaleId
					AND NOT EXISTS (SELECT TOP 1 1 FROM Cte_GetFirstFilterData CTEFD WHERE CTEFD.CMSContainerProfileVariantId = CTEC.CMSContainerProfileVariantId)
			)
			INSERT INTO @TBL_ContentContainerVariantEntity
				(CMSContainerProfileVariantId,PortalId, LocaleId, Name, ContainerKey,	CMSContentContainerId, ProfileId, CMSContainerTemplateId,
					CreatedBy, CreatedDate, ModifiedBy,	ModifiedDate,IsActive)
			SELECT CMSContainerProfileVariantId,PortalId, LocaleId, Name, ContainerKey,	CMSContentContainerId, ProfileId, CMSContainerTemplateId,
					@UserId, CreatedDate, @UserId,	ModifiedDate,IsActive
			FROM Cte_GetDefaultFilterData

			SET @IncrementalId = @IncrementalId +1;
		END 

		CREATE TABLE #ContentContainerGlobalAttribute(CMSContainerProfileVariantId INT,LocaleId INT, GlobalAttributes NVARCHAR(MAX))

		INSERT INTO #ContentContainerGlobalAttribute (CMSContainerProfileVariantId ,LocaleId , GlobalAttributes )
		EXEC [Znode_SetPublishContentContainerGlobalAttributeEntity] @ContainerKey = @ContainerKey, @ContainerProfileVariantId = @ContainerProfileVariantId
		-- Data inserted INTO flat table ZnodeBlogNewsEntity (Replica of MongoDB Collection )
		IF (@RevisionState like '%Preview%' ) 
		BEGIN
			--Data inserted INTO flat table ZnodePublishContentContainerVariantEntity (Replica of MongoDB Collection )
			DELETE FROM ZnodePublishContentContainerVariantEntity WHERE VersionId = @VersionId
			AND EXISTS(SELECT * FROM @TBL_ContentContainerVariantEntity cc WHERE ZnodePublishContentContainerVariantEntity.ContainerKey = CC.ContainerKey
						AND ZnodePublishContentContainerVariantEntity.CMSContainerProfileVariantId = CC.CMSContainerProfileVariantId)

			INSERT INTO ZnodePublishContentContainerVariantEntity
			(
				VersionId,PortalId,LocaleId,Name,ContainerKey,CMSContentContainerId,ProfileId,CMSContainerTemplateId,
				CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CMSContainerProfileVariantId, GlobalAttributes,IsActive
			)
			SELECT @VersionId,A.PortalId,A.LocaleId,Name,ContainerKey,CMSContentContainerId,ProfileId,CMSContainerTemplateId,
				CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,A.CMSContainerProfileVariantId, B.GlobalAttributes,A.IsActive
			FROM @TBL_ContentContainerVariantEntity A
			LEFT JOIN #ContentContainerGlobalAttribute B ON A.CMSContainerProfileVariantId = B.CMSContainerProfileVariantId AND A.LocaleId = B.LocaleId

			DELETE FROM ZnodePublishContentContainerVariantEntity WHERE VersionId = @OldPreviewId

		END
		---------------------------- END Preview 
		IF (@RevisionState LIKE '%Production%' OR @RevisionState = 'None')
		BEGIN
			-- Only production version id will process 
			DELETE FROM ZnodePublishContentContainerVariantEntity WHERE VersionId = @VersionId
			AND EXISTS(SELECT * FROM @TBL_ContentContainerVariantEntity cc WHERE ZnodePublishContentContainerVariantEntity.ContainerKey = CC.ContainerKey
					AND ZnodePublishContentContainerVariantEntity.CMSContainerProfileVariantId = CC.CMSContainerProfileVariantId)

			INSERT INTO ZnodePublishContentContainerVariantEntity
			(
				VersionId,PortalId,LocaleId,Name,ContainerKey,CMSContentContainerId,ProfileId,CMSContainerTemplateId,
				CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CMSContainerProfileVariantId,GlobalAttributes,IsActive
			)
			SELECT DISTINCT @VersionId,A.PortalId,A.LocaleId,Name,ContainerKey,CMSContentContainerId,ProfileId,CMSContainerTemplateId,
				CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,A.CMSContainerProfileVariantId,B.GlobalAttributes,A.IsActive
			FROM @TBL_ContentContainerVariantEntity A
			LEFT JOIN #ContentContainerGlobalAttribute B ON A.CMSContainerProfileVariantId = B.CMSContainerProfileVariantId AND A.LocaleId = B.LocaleId

			DELETE FROM ZnodePublishContentContainerVariantEntity WHERE VersionId = @OldProductionId
		
		END

		SET @Status =1 ;
		IF (@RevisionState = 'Preview')
			UPDATE B SET PublishStateId = (SELECT dbo.Fn_GetPublishStateIdForPreview()) --, ISPublish = 1 
			FROM @TBL_ContentContainerVariantEntity A
			INNER JOIN ZnodeCMSContainerProfileVariant B ON A.CMSContainerProfileVariantId = B.CMSContainerProfileVariantId
				
		ELSE IF (@RevisionState = 'Production' Or @RevisionState = 'None' )
			UPDATE B SET PublishStateId = (SELECT dbo.Fn_GetPublishStateIdForPublish()) --, ISPublish = 1 
			FROM @TBL_ContentContainerVariantEntity A
			INNER JOIN ZnodeCMSContainerProfileVariant B ON A.CMSContainerProfileVariantId = B.CMSContainerProfileVariantId
				

		SELECT 1 ID, @Status Status;
END TRY 
BEGIN CATCH
	SET @Status =0

	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishContentContainerVariantEntity
		@ContainerKey = '+CAST(@ContainerKey AS VARCHAR	(max))
		+',@ContainerProfileVariantId = ''' + CAST(@ContainerProfileVariantId AS VARCHAR(50))
		+',@RevisionState = ''' + CAST(@RevisionState AS VARCHAR(50))
		+',@UserId = ' + CAST(@UserId AS VARCHAR(20))
		+',@Status='+CAST(@Status AS VARCHAR(10));
		SELECT 0 AS ID,@Status AS Status;
	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_PublishContentContainerVariantEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_SaveVariantsData')
	DROP PROC Znode_SaveVariantsData
GO

CREATE PROCEDURE [dbo].[Znode_SaveVariantsData]
(
	@LocaleId INT,
	@CMSContainerTemplateId INT,
	@CMSContainerProfileVariantId INT,
	@UserId INT=0,
	@IsActive BIT,
	@status BIT OUT
)
AS
--EXEC Znode_SaveVariantsData 0,0,0,0,0,0
BEGIN
	BEGIN TRY
	BEGIN TRAN SaveVariantsData
		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
		DECLARE @PublishStateId INT =(SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE StateName='Draft');

		IF EXISTS (SELECT TOP 1 1 FROM ZnodeCMSContainerProfileVariantLocale WHERE CMSContainerProfileVariantId=@CMSContainerProfileVariantId)
		BEGIN
			IF EXISTS (SELECT TOP 1 1 FROM ZnodeCMSContainerProfileVariantLocale
						WHERE CMSContainerProfileVariantId=@CMSContainerProfileVariantId AND LocaleId=@LocaleId)
			BEGIN
				UPDATE ZnodeCMSContainerProfileVariantLocale
				SET CMSContainerTemplateId=@CMSContainerTemplateId, IsActive=@IsActive
				WHERE CMSContainerProfileVariantId=@CMSContainerProfileVariantId AND LocaleId=@LocaleId
					--AND CMSContainerTemplateId<>@CMSContainerTemplateId;

				UPDATE ZnodeCMSContainerProfileVariant
				SET PublishStateId = @PublishStateId,ModifiedBy=@UserId, ModifiedDate=@GetDate
				WHERE CMSContainerProfileVariantId=@CMSContainerProfileVariantId;

				UPDATE ZnodeCMSContentContainer
				SET PublishStateId=@PublishStateId,ModifiedBy=@UserId, ModifiedDate=@GetDate
				WHERE CMSContentContainerId=(SELECT CMSContentContainerId FROM ZnodeCMSContainerProfileVariant
											WHERE CMSContainerProfileVariantId=@CMSContainerProfileVariantId);
			END
			ELSE
			BEGIN
				INSERT INTO ZnodeCMSContainerProfileVariantLocale
					(CMSContainerProfileVariantId,CMSContainerTemplateId,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsActive)
				SELECT @CMSContainerProfileVariantId,@CMSContainerTemplateId,@LocaleId,@UserId,@GetDate,@UserId,@GetDate,@IsActive;

				UPDATE ZnodeCMSContainerProfileVariant
				SET PublishStateId = @PublishStateId,ModifiedBy=@UserId, ModifiedDate=@GetDate
				WHERE CMSContainerProfileVariantId=@CMSContainerProfileVariantId;

				UPDATE ZnodeCMSContentContainer
				SET PublishStateId=@PublishStateId,ModifiedBy=@UserId, ModifiedDate=@GetDate
				WHERE CMSContentContainerId=(SELECT CMSContentContainerId FROM ZnodeCMSContainerProfileVariant
											WHERE CMSContainerProfileVariantId=@CMSContainerProfileVariantId);
			END
		END
		ELSE
		BEGIN
			INSERT INTO ZnodeCMSContainerProfileVariantLocale
					(CMSContainerProfileVariantId,CMSContainerTemplateId,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsActive)
			SELECT @CMSContainerProfileVariantId,@CMSContainerTemplateId,@LocaleId,@UserId,@GetDate,@UserId,@GetDate,@IsActive;

			UPDATE ZnodeCMSContainerProfileVariant
				SET PublishStateId = @PublishStateId,ModifiedBy=@UserId, ModifiedDate=@GetDate
				WHERE CMSContainerProfileVariantId=@CMSContainerProfileVariantId;

			UPDATE ZnodeCMSContentContainer
			SET PublishStateId=@PublishStateId,ModifiedBy=@UserId, ModifiedDate=@GetDate
			WHERE CMSContentContainerId=(SELECT CMSContentContainerId FROM ZnodeCMSContainerProfileVariant
										WHERE CMSContainerProfileVariantId=@CMSContainerProfileVariantId);
		END

		SET @Status = 1;
		SELECT 1 AS ID, CAST(1 AS BIT) AS [Status];

	COMMIT TRAN SaveVariantsData;
	END TRY

	BEGIN CATCH
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
			@ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_SaveVariantsData 
			@LocaleId = '+CAST(@LocaleId AS VARCHAR(50))+',
			@CMSContainerTemplateId='+CAST(@CMSContainerTemplateId AS VARCHAR(50))+',
			@CMSContainerProfileVariantId='+CAST(@CMSContainerProfileVariantId AS VARCHAR(50))+',
			@UserId='+CAST(@UserId AS VARCHAR(50))+',
			@Status='+CAST(@Status AS VARCHAR(50));

		SET @Status =0
		SELECT 1 AS ID,@Status AS Status;
		ROLLBACK TRAN SaveVariantsData;
		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_SaveVariantsData',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;

	END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.sysconstraints WHERE OBJECT_NAME(CONSTID) = 'FK_ZnodePublishContentContainerVariantEntity_PortalId')
BEGIN
	ALTER TABLE ZnodePublishContentContainerVariantEntity DROP CONSTRAINT FK_ZnodePublishContentContainerVariantEntity_PortalId
END
IF EXISTS(SELECT * FROM SYS.sysconstraints WHERE OBJECT_NAME(CONSTID) = 'FK_ZnodePublishContentContainerVariantEntity_ProfileId')
BEGIN
	ALTER TABLE ZnodePublishContentContainerVariantEntity DROP CONSTRAINT FK_ZnodePublishContentContainerVariantEntity_ProfileId
END
IF EXISTS(SELECT * FROM SYS.sysconstraints WHERE OBJECT_NAME(CONSTID) = 'FK_ZnodePublishContentContainerVariantEntity_ZnodeCMSContainerProfileVariant')
BEGIN
	ALTER TABLE ZnodePublishContentContainerVariantEntity DROP CONSTRAINT FK_ZnodePublishContentContainerVariantEntity_ZnodeCMSContainerProfileVariant
END
IF EXISTS(SELECT * FROM SYS.sysconstraints WHERE OBJECT_NAME(CONSTID) = 'FK_ZnodeCMSWidgetProfileVariantLocale_ZnodeCMSContainerTemplate')
BEGIN
	ALTER TABLE ZnodeCMSContainerProfileVariantLocale DROP CONSTRAINT FK_ZnodeCMSWidgetProfileVariantLocale_ZnodeCMSContainerTemplate
END
IF EXISTS(SELECT * FROM SYS.sysconstraints WHERE OBJECT_NAME(CONSTID) = 'FK_ZnodePublishContentContainerVariantEntity_CMSContainerTemplateId')
BEGIN
	ALTER TABLE ZnodePublishContentContainerVariantEntity DROP CONSTRAINT FK_ZnodePublishContentContainerVariantEntity_CMSContainerTemplateId
END

GO

insert into ZnodeMenu(ParentMenuId,MenuName,MenuSequence,AreaName,ControllerName,ActionName,CSSClassName,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select (select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =
( select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')),
'Content Containers',2,null,'ContentContainer','List','z-widget-templates',1,
2,getdate(),2,getdate()
where NOT EXISTS (SELECT * FROM ZnodeMenu where MenuName='Content Containers')

insert into ZnodeMenu(ParentMenuId,MenuName,MenuSequence,AreaName,ControllerName,ActionName,CSSClassName,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select (select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =
( select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')),
'Content Containers',2,null,'ContentContainer','List','z-widget-templates',1,
2,getdate(),2,getdate()
where NOT EXISTS (SELECT * FROM ZnodeMenu where MenuName='Content Containers')

insert into ZnodeMenu(ParentMenuId,MenuName,MenuSequence,AreaName,ControllerName,ActionName,CSSClassName,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select (select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =
( select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')),
'Container Templates',2,null,'ContainerTemplate','List','z-widget-templates',1,
2,getdate(),2,getdate()
where NOT EXISTS (SELECT * FROM ZnodeMenu where MenuName='Container Templates')

insert into ZnodeMenu(ParentMenuId,MenuName,MenuSequence,AreaName,ControllerName,ActionName,CSSClassName,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select (select Top 1 MenuId from ZnodeMenu where MenuName = 'Containers' and ParentMenuId =
( select Top 1 MenuId from ZnodeMenu where MenuName = 'CMS')),
'Containers',2,null,'ContentContainer','List','z-widget-templates',1,
2,getdate(),2,getdate()
where NOT EXISTS (SELECT * FROM ZnodeMenu where MenuName='Containers')

UPDATE Znodemenu SET MenuName = 'Content Containers',ControllerName = 'ContentContainer' WHERE MenuName = 'Content Widgets' AND CSSClassName = 'z-content-widgets'
UPDATE Znodemenu SET MenuName = 'Content Containers',ControllerName = 'ContentContainer' WHERE MenuName = 'Content Containers' AND CSSClassName = 'z-content-widgets'
UPDATE Znodemenu SET MenuName = 'Containers',ControllerName = 'ContentContainer' WHERE MenuName = 'Containers' AND CSSClassName = 'z-content-widgets'
UPDATE Znodemenu SET MenuName = 'Container Templates',ControllerName = 'ContainerTemplate' WHERE MenuName = 'Widget Templates' AND CSSClassName = 'z-widget-templates'
UPDATE Znodemenu SET MenuName = 'Container Templates',ControllerName = 'ContainerTemplate' WHERE MenuName = 'Container Templates' AND CSSClassName = 'z-widget-templates'

GO

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'ContentContainer','List',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'ContentContainer' and ActionName = 'List')

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'ContentContainer','Create',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'ContentContainer' and ActionName = 'Create')

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'ContentContainer','Edit',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'ContentContainer' and ActionName = 'Edit')

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'ContentContainer','GetVariants',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'ContentContainer' and ActionName = 'GetVariants')

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'ContentContainer','GetUnassociatedProfiles',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'ContentContainer' and ActionName = 'GetUnassociatedProfiles')

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'ContentContainer','AssociateVariants',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'ContentContainer' and ActionName = 'AssociateVariants')

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'ContentContainer','AssociateWidgetTemplate',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'ContentContainer' and ActionName = 'AssociateWidgetTemplate')

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'ContentContainer','GetEntityAttributeDetails',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'ContentContainer' and ActionName = 'GetEntityAttributeDetails')

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'ContentContainer','SaveEntityDetails',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'ContentContainer' and ActionName = 'SaveEntityDetails')

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'ContentContainer','DeleteAssociatedVariant',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'ContentContainer' and ActionName = 'DeleteAssociatedVariant')

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'ContentContainer','Delete',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'ContentContainer' and ActionName = 'Delete')

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'ContentContainer','IsWidgetExist',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'ContentContainer' and ActionName = 'IsWidgetExist')

INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'ContentContainer','SaveAssociatedVariantData',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'SaveAssociatedVariantData')

INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'ContentContainer','EditAssociatedVariant',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'EditAssociatedVariant')

INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'ContentContainer','GetGlobalAttributesForDefaultData',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'GetGlobalAttributesForDefaultData')

INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'ContentContainer','GetAssociatedVariantList',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'GetAssociatedVariantList')

GO

SET IDENTITY_INSERT [dbo].[ZnodeCMSContainerProfileVariant] ON 
GO
DECLARE @PublishStateId INT
SELECT @PublishStateId=PublishStateId FROM ZnodePublishState WHERE PublishStateCode='DRAFT'
INSERT [dbo].[ZnodeCMSContainerProfileVariant] ([CMSContainerProfileVariantId], [CMSContentContainerId], [ProfileId], [PortalId], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [PublishStateId]) 
SELECT [CMSWidgetProfileVariantId], [CMSContentWidgetId], [ProfileId], [PortalId], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], @PublishStateId
FROM ZnodeCMSWidgetProfileVariant
WHERE CMSWidgetProfileVariantId NOT IN (SELECT CMSContainerProfileVariantId FROM [ZnodeCMSContainerProfileVariant])
GO
SET IDENTITY_INSERT [dbo].[ZnodeCMSContainerProfileVariant] OFF
GO

SET IDENTITY_INSERT [dbo].[ZnodeCMSContainerProfileVariantLocale] ON 
GO
DECLARE @IsActive BIT=1
INSERT [dbo].[ZnodeCMSContainerProfileVariantLocale] ([CMSContainerProfileVariantLocaleId], [CMSContainerProfileVariantId], [CMSContainerTemplateId], [LocaleId], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsActive]) 
SELECT [CMSWidgetProfileVariantLocaleId], [CMSWidgetProfileVariantId], [CMSWidgetTemplateId], [LocaleId], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], @IsActive
FROM ZnodeCMSWidgetProfileVariantLocale
WHERE CMSWidgetProfileVariantLocaleId NOT IN (SELECT CMSContainerProfileVariantLocaleId FROM [ZnodeCMSContainerProfileVariantLocale])
GO
SET IDENTITY_INSERT [dbo].[ZnodeCMSContainerProfileVariantLocale] OFF


GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetCMSContainerlist')
	DROP PROC Znode_GetCMSContainerlist
GO

CREATE PROCEDURE [dbo].[Znode_GetCMSContainerlist]  
(    
  @WhereClause NVARCHAR(Max)       
 ,@Rows INT = 100       
 ,@PageNo INT = 1       
 ,@Order_BY VARCHAR(1000) = ''    
 ,@RowsCount INT OUT    
)    
AS    
--EXEC Znode_GetCMSContainerlist @WhereClause = '',@RowsCount=0
BEGIN      
BEGIN TRY     
SET NOCOUNT ON        
	DECLARE @SQL NVARCHAR(MAX)    
	DECLARE @TBL_ContentContainer TABLE (ContentContainerId INT,ContainerKey NVARCHAR(max),Tags NVARCHAR(max),PublishStatus VARCHAR(32),CreatedByName NVARCHAR(600),CreatedDate DATETIME,ModifiedByName NVARCHAR(600),ModifiedDate DATETIME,RowId INT,CountNo INT)  
	
	IF OBJECT_ID('TEMPDB..#User') IS NOT NULL
		DROP TABLE #User

	SELECT ZU.UserId, ZU.UserName
	INTO #User
	FROM ZnodeUser ZU
	WHERE EXISTS(SELECT * FROM ZnodeCMSContentContainer ZCW WHERE ZU.UserId = ZCW.CreatedBy OR ZU.UserId = ZCW.ModifiedBy)

	
	SET @SQL = '   
	;With Cte_ContentContainer AS   
	(  
		SELECT DISTINCT ZCW.CMSContentContainerId, ZCW.ContainerKey as ContainerKey, ZCW.Tags, ZPS.DisplayName As PublishStatus ,U.UserName AS CreatedByName,ZCW.CreatedDate,U1.UserName AS ModifiedByName,ZCW.ModifiedDate
		FROM ZnodeCMSContentContainer ZCW
		LEFT JOIN ZnodePublishState ZPS ON ZCW.PublishStateId=ZPS.PublishStateId
		LEFT JOIN #User U ON U.UserId = ZCW.CreatedBy
		LEFT JOIN #User U1 ON U1.UserId = ZCW.ModifiedBy
	)  
	,Cte_ContentContainerList AS
	(
		SELECT CMSContentContainerId, ContainerKey, Tags,PublishStatus,CreatedByName,CreatedDate,ModifiedByName,ModifiedDate,
		'+dbo.Fn_GetPagingRowId(@Order_BY,'ContainerKey ASC')+',Count(*)Over() CountNo 
		FROM Cte_ContentContainer    
		WHERE 1=1 '+dbo.Fn_GetFilterWhereClause(@WhereClause)+'    
	)
	SELECT CMSContentContainerId,ContainerKey,Tags,PublishStatus,CreatedByName,CreatedDate,ModifiedByName,ModifiedDate,RowId,CountNo    
	FROM Cte_ContentContainerList   
	'+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows)  

	INSERT INTO @TBL_ContentContainer (ContentContainerId,ContainerKey,Tags,PublishStatus,CreatedByName,CreatedDate,ModifiedByName,ModifiedDate,RowId,CountNo)  
	EXEC (@SQL)  
	SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM @TBL_ContentContainer ),0)  

	SELECT ContentContainerId,ContainerKey,Tags,PublishStatus,CreatedByName,CreatedDate,ModifiedByName,ModifiedDate
	FROM @TBL_ContentContainer  
	ORDER BY RowId

END TRY    
BEGIN CATCH    
	DECLARE @Status BIT ;    
	SET @Status = 0;    
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= 
	ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 
	'EXEC Znode_GetCMSContainerlist @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',
	@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',
	@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));    
                      
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                       
        
	EXEC Znode_InsertProcedureErrorLog    
	@ProcedureName = 'Znode_GetCMSContainerlist',    
	@ErrorInProcedure = @Error_procedure,    
	@ErrorMessage = @ErrorMessage,    
	@ErrorLine = @ErrorLine,    
	@ErrorCall = @ErrorCall;                                
END CATCH; 
END;

GO


IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishContentContainerAttributeValue')
	DROP PROC Znode_GetPublishContentContainerAttributeValue
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishContentContainerAttributeValue]
(
	@EntityName	NVARCHAR(200) = 0,
	@ContainerKey	NVARCHAR(200),
	@LocalId	INT = 0,
	@PortalId	INT = 0,
	@ProfileId	INT = 0
)
AS
/*
	 Summary :- This procedure is used to get the Content and Container attribute value as per filter pass
	 Unit Testing
	 BEGIN TRAN
	 EXEC [Znode_GetPublishContentContainerAttributeValue] @EntityName='Content Containers',@ContainerKey='',@LocalId=0,@PortalId=0,@ProfileId=0
	 ROLLBACK TRAN
*/
BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
		-- Variable Declaration as per the code requirement
		DECLARE @LocaleCode NVARCHAR(50),
				@LocalIdInput INT,
				@LocaleCodeInput NVARCHAR(50),
				@CMSContainerProfileVariantId INT,
				@GroupCode NVARCHAR(200) = NULL,
				@SelectedValue BIT = 0,
				@FamilyCode VARCHAR(200);

		SET @LocalIdInput = @LocalId

		SELECT @LocaleCode=Code FROM ZnodeLocale WITH (NOLOCK) WHERE LocaleId=@LocalId;
		SET @LocaleCodeInput = @LocaleCode

		--1. Specific Store, Specific User Profile, Selected Locale
		-- Based on input if count will 1 then this will take CMSContainerProfileVariantId from 1st loop else this will go for next loop.
		IF (SELECT COUNT(1) FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK) WHERE ISNULL(WPV.ProfileId,0)=@ProfileId  AND WPV.LocaleId=@LocalId)=1
		BEGIN
			SELECT @CMSContainerProfileVariantId=WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE ISNULL(WPV.ProfileId,0)=@ProfileId AND WPV.ContainerKey=@ContainerKey
			AND WPV.LocaleId=@LocalId
			AND WPV.IsActive=1
		END
		ELSE
		BEGIN
			SELECT @CMSContainerProfileVariantId=WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = @ProfileId ) AND (ISNULL(WPV.PortalId,0) = @PortalId )
			AND WPV.ContainerKey=@ContainerKey AND WPV.LocaleId=@LocalId
			AND WPV.IsActive=1
		END

		--2. Specific Store, Specific User Profile, Default Locale
		IF ISNULL(@CMSContainerProfileVariantId,0) = 0
		BEGIN
			SELECT @LocalId = LocaleId FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;
			SELECT @LocaleCode = Code FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;

			SELECT @CMSContainerProfileVariantId= WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = @ProfileId ) AND (ISNULL(WPV.PortalId,0) = @PortalId )
			AND WPV.ContainerKey=@ContainerKey AND WPV.LocaleId=@LocalId
			AND WPV.IsActive=1

			IF ISNULL(@CMSContainerProfileVariantId,0) = 0
			BEGIN
				SET @LocalId = @LocalIdInput
				SET @LocaleCode = @LocaleCodeInput
			END
		
		END

		--3. Specific Store, Any User Profile, Selected Locale
		IF ISNULL(@CMSContainerProfileVariantId,0) = 0
		BEGIN
			SELECT @CMSContainerProfileVariantId= WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = 0 ) AND (ISNULL(WPV.PortalId,0) = @PortalId )
			AND WPV.ContainerKey=@ContainerKey AND WPV.LocaleId=@LocalId
			AND WPV.IsActive=1
		END

		--4. Specific Store, Any User Profile, Default Locale
		IF ISNULL(@CMSContainerProfileVariantId,0) = 0
		BEGIN
			SELECT @LocalId = LocaleId FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;
			SELECT @LocaleCode = Code FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;

			SELECT @CMSContainerProfileVariantId= WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = 0 ) AND (ISNULL(WPV.PortalId,0) = @PortalId )
			AND WPV.ContainerKey=@ContainerKey AND WPV.LocaleId=@LocalId
			AND WPV.IsActive=1

			IF ISNULL(@CMSContainerProfileVariantId,0) = 0
			BEGIN
				SET @LocalId = @LocalIdInput
				SET @LocaleCode = @LocaleCodeInput
			END
		END
		
		--5. Any Store, Any User Profile, Selected Locale
		IF ISNULL(@CMSContainerProfileVariantId,0) = 0
		BEGIN
			SELECT @CMSContainerProfileVariantId= WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = 0 ) AND (ISNULL(WPV.PortalId,0) = 0 )
			AND WPV.ContainerKey=@ContainerKey AND WPV.LocaleId=@LocalId
			AND WPV.IsActive=1
		END

		--6. Any Store, Any User Profile, Default Locale
		IF ISNULL(@CMSContainerProfileVariantId,0) = 0
		BEGIN
			SELECT @LocalId = LocaleId FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;
			SELECT @LocaleCode = Code FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;

			SELECT @CMSContainerProfileVariantId= WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = 0 ) AND (ISNULL(WPV.PortalId,0) = 0 )
			AND WPV.ContainerKey=@ContainerKey AND WPV.LocaleId=@LocalId
			AND WPV.IsActive=1

			IF ISNULL(@CMSContainerProfileVariantId,0) = 0
			BEGIN
				SET @LocalId = @LocalIdInput
				SET @LocaleCode = @LocaleCodeInput
			END
		END	
		-- This will take FamilyCode based on the inputs.
		SELECT @FamilyCode=GAF.FamilyCode
		FROM ZnodeCMSContentContainer CCW WITH (NOLOCK)
		INNER JOIN ZnodeGlobalAttributeFamily GAF WITH (NOLOCK) ON CCW.FamilyId=GAF.GlobalAttributeFamilyId
		WHERE CCW.ContainerKey=@ContainerKey 
		AND EXISTS(SELECT * FROM ZnodePublishContentContainerVariantEntity CWPV WITH (NOLOCK) WHERE CCW.CMSContentContainerId = CWPV.CMSContentContainerId AND (ISNULL(CWPV.PortalId,0)=@PortalId));

		-- Based on input @EntityName='Content Containers' as fixed value this will execute nested SP.
		-- Nested SP will give 2 Output (1 Result set & 1 Msg.

		-- Declared table variable to combined nested sp data with the output of this sp.
		DECLARE	@PublishContainerGlobalAttributeValue As TABLE
		(CMSContainerProfileVariantId INT, ContentContainerName NVARCHAR(100), ContainerKey NVARCHAR(50), GlobalAttributes NVARCHAR(MAX), ContainerTemplateName NVARCHAR(100))

		IF @EntityName='Content Containers'
		begin
			INSERT INTO @PublishContainerGlobalAttributeValue
				(CMSContainerProfileVariantId,ContentContainerName, ContainerKey, GlobalAttributes, ContainerTemplateName)
			EXEC [dbo].[Znode_GetPublishContainerGlobalAttributeValue]
				@CMSContainerProfileVariantId=@CMSContainerProfileVariantId, @LocaleCode= @LocaleCode
		end
		
		-- This will take FamilyCode based on the inputs.
		SELECT @FamilyCode=GAF.FamilyCode
		FROM ZnodeCMSContentContainer CCW WITH (NOLOCK)
		INNER JOIN ZnodeGlobalAttributeFamily GAF WITH (NOLOCK) ON CCW.FamilyId=GAF.GlobalAttributeFamilyId
		WHERE CCW.ContainerKey=@ContainerKey 
		AND EXISTS(SELECT * FROM ZnodeCMSContainerProfileVariant CWPV WHERE CCW.CMSContentContainerId = CWPV.CMSContentContainerId AND (ISNULL(CWPV.PortalId,0)=@PortalId));

		IF ISNULL(@FamilyCode,'') = ''
		BEGIN
			-- This will take FamilyCode based on the inputs.
			SELECT @FamilyCode=GAF.FamilyCode
			FROM ZnodeCMSContentContainer CCW WITH (NOLOCK)
			INNER JOIN ZnodeGlobalAttributeFamily GAF WITH (NOLOCK) ON CCW.FamilyId=GAF.GlobalAttributeFamilyId
			WHERE CCW.ContainerKey=@ContainerKey 
			AND EXISTS(SELECT * FROM ZnodeCMSContainerProfileVariant CWPV WHERE CCW.CMSContentContainerId = CWPV.CMSContentContainerId AND (ISNULL(CWPV.PortalId,0)=0));
		END

		-- This will give 3rd result set of Attribute Groups Data.
		--SELECT GE.GlobalEntityId, GE.EntityName, GE.IsActive, GE.TableName, GE.IsFamilyUnique
		--	, GAF.GlobalAttributeFamilyId, GAF.FamilyCode, GAF.IsSystemDefined, GAF.GlobalEntityId
		--	, GFGM.GlobalFamilyGroupMapperId, GFGM.GlobalAttributeFamilyId, GFGM.GlobalAttributeGroupId
		--	, GFGM.AttributeGroupDisplayOrder
		--	, GAG.GlobalAttributeGroupId, GAG.GroupCode, GAG.DisplayOrder, GAG.IsSystemDefined, GAG.GlobalEntityId
		--	, GAGL.GlobalAttributeGroupLocaleId, GAGL.LocaleId, GAGL.GlobalAttributeGroupId, GAGL.AttributeGroupName
		--	, GAGL.[Description]
		--FROM ZnodeGlobalEntity GE WITH (NOLOCK)
		--INNER JOIN ZnodeGlobalAttributeFamily GAF WITH (NOLOCK) ON GE.GlobalEntityId=GAF.GlobalEntityId
		--INNER JOIN ZnodeGlobalFamilyGroupMapper GFGM WITH (NOLOCK) ON GAF.GlobalAttributeFamilyId=GFGM.GlobalAttributeFamilyId
		--INNER JOIN ZnodeGlobalAttributeGroup GAG WITH (NOLOCK) ON GFGM.GlobalAttributeGroupId=GAG.GlobalAttributeGroupId
		--INNER JOIN ZnodeGlobalAttributeGroupLocale GAGL WITH (NOLOCK) ON GAG.GlobalAttributeGroupId=GAGL.GlobalAttributeGroupId
		--WHERE GE.EntityName=@EntityName AND GAGL.LocaleId=@LocalId AND GAF.FamilyCode=@FamilyCode
		--ORDER BY GFGM.AttributeGroupDisplayOrder;

		-- This will give 4th result set of ContainerProfile & ContentContainer Data.

		;WITH Cte_CMSContainerProfileVariant AS
		(
		SELECT DISTINCT CWPV.PublishContentContainerVariantEntityId,CWPV.CMSContainerProfileVariantId, CWPV.CMSContentContainerId, CGAV.ContentContainerName, CWPV.ProfileId
			, CWPV.LocaleId, CWPV.CMSContainerTemplateId, CGAV.ContainerTemplateName
			, CCW.[Name], CCW.ContainerKey, CWPV.PortalId, CCW.FamilyId, CCW.Tags
			, CGAV.GlobalAttributes
		FROM ZnodePublishContentContainerVariantEntity CWPV WITH (NOLOCK)
		INNER JOIN ZnodeCMSContentContainer CCW WITH (NOLOCK) ON CWPV.CMSContentContainerId=CCW.CMSContentContainerId
		INNER JOIN @PublishContainerGlobalAttributeValue CGAV ON CCW.ContainerKey=CGAV.ContainerKey
			AND CWPV.CMSContainerProfileVariantId=CGAV.CMSContainerProfileVariantId
		WHERE CWPV.IsActive=1 AND ( (ISNULL(CWPV.ProfileId,0) = @ProfileId OR ISNULL(CWPV.ProfileId,0) = 0) AND CWPV.LocaleId=@LocalId AND CCW.ContainerKey=@ContainerKey
			AND ((ISNULL(CWPV.PortalId,0)=@PortalId OR ISNULL(CWPV.PortalId,0) = 0)))
		)
		,Cte_GetFirstFilterData AS
		(
		SELECT DISTINCT CWPV.PublishContentContainerVariantEntityId,CWPV.CMSContainerProfileVariantId, CWPV.CMSContentContainerId, CGAV.ContentContainerName, CWPV.ProfileId
			, CWPV.LocaleId, CWPV.CMSContainerTemplateId, CGAV.ContainerTemplateName
			, CCW.[Name], CCW.ContainerKey, CWPV.PortalId, CCW.FamilyId, CCW.Tags
			, CGAV.GlobalAttributes
		FROM ZnodePublishContentContainerVariantEntity CWPV WITH (NOLOCK)
		INNER JOIN ZnodeCMSContentContainer CCW WITH (NOLOCK) ON CWPV.CMSContentContainerId=CCW.CMSContentContainerId
		INNER JOIN @PublishContainerGlobalAttributeValue CGAV ON CCW.ContainerKey=CGAV.ContainerKey
		WHERE CWPV.ProfileId IS NULL AND CCW.ContainerKey=@ContainerKey AND CWPV.PortalId IS NULL AND CWPV.LocaleId=@LocalId
		)

		SELECT DISTINCT CMSContainerProfileVariantId, CMSContentContainerId, ContentContainerName, ProfileId
			, LocaleId, CMSContainerTemplateId, ContainerTemplateName
			, [Name], ContainerKey, PortalId, FamilyId, Tags
			, GlobalAttributes
		FROM Cte_CMSContainerProfileVariant
		UNION
		SELECT DISTINCT CMSContainerProfileVariantId, CMSContentContainerId, ContentContainerName, ProfileId
			, LocaleId, CMSContainerTemplateId, ContainerTemplateName
			, [Name], ContainerKey, PortalId, FamilyId, Tags
			, GlobalAttributes
		FROM Cte_GetFirstFilterData CWPV
		WHERE NOT EXISTS (SELECT * FROM Cte_CMSContainerProfileVariant WHERE PublishContentContainerVariantEntityId=CWPV.PublishContentContainerVariantEntityId)
			AND NOT EXISTS (SELECT * FROM Cte_CMSContainerProfileVariant)

		-- This will give 5th result set of ContainerTemplate & ContentContainer Data.
		--SELECT CWT.CMSContainerTemplateId, CWT.[FileName], CWT.MediaId, CCW.[Name], CCW.FamilyId, CCW.Tags
		--FROM ZnodeCMSContentContainer CCW WITH (NOLOCK) 
		--INNER JOIN ZnodeCMSContainerProfileVariant CWPV ON CCW.CMSContentContainerId = CWPV.CMSContentContainerId AND (ISNULL(CWPV.PortalId,0)=@PortalId OR ISNULL(CWPV.PortalId,0) = 0)
		--INNER JOIN ZnodeCMSContainerProfileVariantLocale CWPVL ON CWPV.CMSContainerProfileVariantId = CWPVL.CMSContainerProfileVariantId
		--INNER JOIN  ZnodeCMSContainerTemplate CWT WITH (NOLOCK) ON (CWPVL.CMSContainerTemplateId = CWT.CMSContainerTemplateId OR ISNULL(CWPVL.CMSContainerTemplateId,0) = 0)
		--WHERE CCW.ContainerKey=@ContainerKey
	END TRY
	BEGIN CATCH
		SELECT ERROR_MESSAGE()
		DECLARE @Status BIT;
		SET @Status = 0;

		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(),
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetContentContainerAttributeValue
					@EntityName = '''+ISNULL(@EntityName,'''''')+
					''',@ContainerKey='+ISNULL(@ContainerKey,'''')+
					''',@LocalId='+ISNULL(CAST(@LocalId AS VARCHAR(20)),'''')+
					''',@PortalId='+ISNULL(CAST(@PortalId AS VARCHAR(20)),'''')+
					''',@ProfileId='+ISNULL(CAST(@ProfileId AS VARCHAR(20)),'''')
					
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_GetContentContainerAttributeValue',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishContentContainerVariantEntity')
	DROP PROC Znode_PublishContentContainerVariantEntity
GO

CREATE PROCEDURE [dbo].[Znode_PublishContentContainerVariantEntity]
(
	 @ContainerKey VARCHAR(50) = ''
	,@RevisionState VARCHAR(50) = 'Production'
	,@UserId INT = 0
	,@OldPreviewId INT = 0
	,@OldProductionId INT = 0
	,@ContainerProfileVariantId INT = 0
	,@Status BIT = 0 OUTPUT
)
AS
/*
	if profileid and portalid will null then it must be publish.
	This Procedure is used to publish the Content Container Variant against the store 

	EXEC [Znode_PublishContentContainerVariantEntity] 1 2,3

	EXEC Znode_PublishContentContainerVariantEntity @@ContainerKey='',@RevisionState='Production',@UserId=2,
	@OldPreviewId=0,@OldProductionId=

	SELECT * FROM ZnodePublishContentContainerVariantEntity

*/
BEGIN 
BEGIN TRY 
SET NOCOUNT ON

	DECLARE @VersionId Int
	SET @VersionId = ( SELECT TOP 1 VersionId FROM ZnodePublishContetContainerVersionEntity WHERE PublishState = @RevisionState )

	IF ISNULL(@VersionId,0) = 0 AND @RevisionState = 'PREVIEW'
	BEGIN
		INSERT INTO ZnodePublishContetContainerVersionEntity(PublishStartTime,PublishState)
		SELECT GETDATE(),'PREVIEW'
		SET @VersionId = @@IDENTITY
	END
	
	IF ISNULL(@VersionId,0) = 0 AND @RevisionState = 'PRODUCTION'
 	BEGIN
		INSERT INTO ZnodePublishContetContainerVersionEntity(PublishStartTime,PublishState)
		SELECT GETDATE(),'PRODUCTION'
		SET @VersionId = @@IDENTITY
	END 


		DECLARE @SetLocaleId INT, @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleId(), @MaxCount INT =0 , @IncrementalId INT = 1;
		DECLARE @TBL_Locale TABLE (LocaleId INT , RowId INT IDENTITY(1,1));
		DECLARE @TBL_ContentContainerVariantEntity TABLE
			(CMSContainerProfileVariantId INT,PortalId INT, LocaleId INT, Name NVARCHAR(100), ContainerKey NVARCHAR(50),	CMSContentContainerId INT, ProfileId INT,
				CMSContainerTemplateId INT, CreatedBy INT, CreatedDate DATETIME, ModifiedBy INT, ModifiedDate DATETIME,IsActive BIT);

		INSERT INTO @TBL_Locale (LocaleId)
		SELECT LocaleId
		FROM ZnodeLocale
		WHERE IsActive =1 --AND (LocaleId = @LocaleId OR @LocaleId = 0);

		SET @MaxCount = ISNULL((SELECT MAx(RowId) FROM @TBL_Locale),0);

		WHILE @IncrementalId <= @MaxCount
		BEGIN 
			SET @SetLocaleId = (SELECT TOP 1 LocaleId FROM @TBL_locale WHERE  RowId = @IncrementalId);

			;WITH Cte_CMSContainerProfileVariant AS
			(
				SELECT DISTINCT WPV.CMSContainerProfileVariantId, ZCW.ContainerKey, WPV.PortalId, --ZCW.Tags,
					CASE WHEN WPV.PortalId IS NULL THEN  'Any Store' ELSE ZP.StoreName END StoreName  ,
					CASE WHEN WPV.ProfileId IS NULL THEN  'Any User Profile' ELSE ZPR.ProfileName END ProfileName, 
					GETDATE() As CreatedDate, GETDATE() As ModifiedDate,
					CAST(CASE WHEN WPV.ProfileId IS NULL AND WPV.PortalId IS NULL THEN 1 ELSE 0 END AS BIT) AS IsDefaultVarient,
					CASE WHEN WPV.PortalId IS NULL THEN  'AnyStore' ELSE ZP.StoreCode END StoreCode ,
					CASE WHEN WPV.ProfileId IS NULL THEN  'AnyUserProfile' ELSE ZPR.DefaultExternalAccountNo END ProfileCode,
					CPVL.LocaleId,ZCW.Name,ZCW.CMSContentContainerId,WPV.ProfileId,CPVL.CMSContainerTemplateId,CPVL.IsActive
				FROM ZnodeCMSContentContainer ZCW
				INNER JOIN ZnodeCMSContainerProfileVariant WPV ON WPV.CMSContentContainerId = ZCW.CMSContentContainerId
				INNER JOIN ZnodeCMSContainerProfileVariantLocale CPVL ON WPV.CMSContainerProfileVariantId=CPVL.CMSContainerProfileVariantId
				LEFT JOIN ZnodePortal ZP ON (WPV.PortalId = ZP.PortalId ) 
				LEFT JOIN ZnodeProfile ZPR ON WPV.ProfileId = ZPR.ProfileId
				WHERE (CPVL.LocaleId = @SetLocaleId) -- OR CPVL.LocaleId = @DefaultLocaleId
				--AND CPVL.IsActive = 1 
				AND (ZCW.ContainerKey = @ContainerKey OR @ContainerKey = '' )
				AND ( WPV.CMSContainerProfileVariantId = @ContainerProfileVariantId OR @ContainerProfileVariantId = 0)
			)
			, Cte_GetFirstFilterData AS
			(
				SELECT CMSContainerProfileVariantId,ContainerKey,PortalId,StoreName,ProfileName,CreatedDate,ModifiedDate,IsDefaultVarient,
					StoreCode,ProfileCode,LocaleId,Name,CMSContentContainerId,ProfileId,CMSContainerTemplateId,IsActive
				FROM Cte_CMSContainerProfileVariant
				WHERE LocaleId = @SetLocaleId
			)
			, Cte_GetDefaultFilterData AS
			(
				SELECT CMSContainerProfileVariantId,ContainerKey,PortalId,StoreName,ProfileName,CreatedDate,ModifiedDate,IsDefaultVarient,
					StoreCode,ProfileCode,LocaleId,Name,CMSContentContainerId,ProfileId,CMSContainerTemplateId,IsActive
				FROM Cte_GetFirstFilterData
				UNION ALL
				SELECT CMSContainerProfileVariantId,ContainerKey,PortalId,StoreName,ProfileName,CreatedDate,ModifiedDate,IsDefaultVarient,
					StoreCode,ProfileCode,LocaleId,Name,CMSContentContainerId,ProfileId,CMSContainerTemplateId,IsActive
				FROM Cte_CMSContainerProfileVariant CTEC
				WHERE  LocaleId = @DefaultLocaleId
					AND NOT EXISTS (SELECT TOP 1 1 FROM Cte_GetFirstFilterData CTEFD WHERE CTEFD.CMSContainerProfileVariantId = CTEC.CMSContainerProfileVariantId)
			)
			INSERT INTO @TBL_ContentContainerVariantEntity
				(CMSContainerProfileVariantId,PortalId, LocaleId, Name, ContainerKey,	CMSContentContainerId, ProfileId, CMSContainerTemplateId,
					CreatedBy, CreatedDate, ModifiedBy,	ModifiedDate,IsActive)
			SELECT CMSContainerProfileVariantId,PortalId, LocaleId, Name, ContainerKey,	CMSContentContainerId, ProfileId, CMSContainerTemplateId,
					@UserId, CreatedDate, @UserId,	ModifiedDate,IsActive
			FROM Cte_GetDefaultFilterData

			SET @IncrementalId = @IncrementalId +1;
		END 

		CREATE TABLE #ContentContainerGlobalAttribute(CMSContainerProfileVariantId INT,LocaleId INT, GlobalAttributes NVARCHAR(MAX))

		INSERT INTO #ContentContainerGlobalAttribute (CMSContainerProfileVariantId ,LocaleId , GlobalAttributes )
		EXEC [Znode_SetPublishContentContainerGlobalAttributeEntity] @ContainerKey = @ContainerKey, @ContainerProfileVariantId = @ContainerProfileVariantId
		-- Data inserted INTO flat table ZnodeBlogNewsEntity (Replica of MongoDB Collection )
		IF (@RevisionState like '%Preview%' ) 
		BEGIN
			--Data inserted INTO flat table ZnodePublishContentContainerVariantEntity (Replica of MongoDB Collection )
			DELETE FROM ZnodePublishContentContainerVariantEntity WHERE VersionId = @VersionId
			AND EXISTS(SELECT * FROM @TBL_ContentContainerVariantEntity cc WHERE ZnodePublishContentContainerVariantEntity.ContainerKey = CC.ContainerKey
						AND ZnodePublishContentContainerVariantEntity.CMSContainerProfileVariantId = CC.CMSContainerProfileVariantId)
			OR NOT EXISTS (SELECT * FROM ZnodeCMSContainerProfileVariant cc WHERE ZnodePublishContentContainerVariantEntity.CMSContainerProfileVariantId = CC.CMSContainerProfileVariantId)

			INSERT INTO ZnodePublishContentContainerVariantEntity
			(
				VersionId,PortalId,LocaleId,Name,ContainerKey,CMSContentContainerId,ProfileId,CMSContainerTemplateId,
				CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CMSContainerProfileVariantId, GlobalAttributes,IsActive
			)
			SELECT @VersionId,A.PortalId,A.LocaleId,Name,ContainerKey,CMSContentContainerId,ProfileId,CMSContainerTemplateId,
				CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,A.CMSContainerProfileVariantId, B.GlobalAttributes,A.IsActive
			FROM @TBL_ContentContainerVariantEntity A
			LEFT JOIN #ContentContainerGlobalAttribute B ON A.CMSContainerProfileVariantId = B.CMSContainerProfileVariantId AND A.LocaleId = B.LocaleId

			DELETE FROM ZnodePublishContentContainerVariantEntity WHERE VersionId = @OldPreviewId

		END
		---------------------------- END Preview 
		IF (@RevisionState LIKE '%Production%' OR @RevisionState = 'None')
		BEGIN
			-- Only production version id will process 
			DELETE FROM ZnodePublishContentContainerVariantEntity WHERE VersionId = @VersionId
			AND EXISTS(SELECT * FROM @TBL_ContentContainerVariantEntity cc WHERE ZnodePublishContentContainerVariantEntity.ContainerKey = CC.ContainerKey
					AND ZnodePublishContentContainerVariantEntity.CMSContainerProfileVariantId = CC.CMSContainerProfileVariantId)
			OR NOT EXISTS (SELECT * FROM ZnodeCMSContainerProfileVariant cc WHERE ZnodePublishContentContainerVariantEntity.CMSContainerProfileVariantId = CC.CMSContainerProfileVariantId)

			INSERT INTO ZnodePublishContentContainerVariantEntity
			(
				VersionId,PortalId,LocaleId,Name,ContainerKey,CMSContentContainerId,ProfileId,CMSContainerTemplateId,
				CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CMSContainerProfileVariantId,GlobalAttributes,IsActive
			)
			SELECT DISTINCT @VersionId,A.PortalId,A.LocaleId,Name,ContainerKey,CMSContentContainerId,ProfileId,CMSContainerTemplateId,
				CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,A.CMSContainerProfileVariantId,B.GlobalAttributes,A.IsActive
			FROM @TBL_ContentContainerVariantEntity A
			LEFT JOIN #ContentContainerGlobalAttribute B ON A.CMSContainerProfileVariantId = B.CMSContainerProfileVariantId AND A.LocaleId = B.LocaleId

			DELETE FROM ZnodePublishContentContainerVariantEntity WHERE VersionId = @OldProductionId
		
		END

		SET @Status =1 ;
		IF (@RevisionState = 'Preview')
			UPDATE B SET PublishStateId = (SELECT dbo.Fn_GetPublishStateIdForPreview()) --, ISPublish = 1 
			FROM @TBL_ContentContainerVariantEntity A
			INNER JOIN ZnodeCMSContainerProfileVariant B ON A.CMSContainerProfileVariantId = B.CMSContainerProfileVariantId
				
		ELSE IF (@RevisionState = 'Production' Or @RevisionState = 'None' )
			UPDATE B SET PublishStateId = (SELECT dbo.Fn_GetPublishStateIdForPublish()) --, ISPublish = 1 
			FROM @TBL_ContentContainerVariantEntity A
			INNER JOIN ZnodeCMSContainerProfileVariant B ON A.CMSContainerProfileVariantId = B.CMSContainerProfileVariantId
				

		SELECT 1 ID, @Status Status;
END TRY 
BEGIN CATCH
	SET @Status =0

	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishContentContainerVariantEntity
		@ContainerKey = '+CAST(@ContainerKey AS VARCHAR	(max))
		+',@ContainerProfileVariantId = ''' + CAST(@ContainerProfileVariantId AS VARCHAR(50))
		+',@RevisionState = ''' + CAST(@RevisionState AS VARCHAR(50))
		+',@UserId = ' + CAST(@UserId AS VARCHAR(20))
		+',@Status='+CAST(@Status AS VARCHAR(10));
		SELECT 0 AS ID,@Status AS Status;
	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_PublishContentContainerVariantEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.sysconstraints WHERE OBJECT_NAME(CONSTID) = 'FK_ZnodePublishContentContainerVariantEntity_PortalId')
BEGIN
	ALTER TABLE ZnodePublishContentContainerVariantEntity DROP CONSTRAINT FK_ZnodePublishContentContainerVariantEntity_PortalId
END
IF EXISTS(SELECT * FROM SYS.sysconstraints WHERE OBJECT_NAME(CONSTID) = 'FK_ZnodePublishContentContainerVariantEntity_ProfileId')
BEGIN
	ALTER TABLE ZnodePublishContentContainerVariantEntity DROP CONSTRAINT FK_ZnodePublishContentContainerVariantEntity_ProfileId
END
IF EXISTS(SELECT * FROM SYS.sysconstraints WHERE OBJECT_NAME(CONSTID) = 'FK_ZnodePublishContentContainerVariantEntity_ZnodeCMSContainerProfileVariant')
BEGIN
	ALTER TABLE ZnodePublishContentContainerVariantEntity DROP CONSTRAINT FK_ZnodePublishContentContainerVariantEntity_ZnodeCMSContainerProfileVariant
END
IF EXISTS(SELECT * FROM SYS.sysconstraints WHERE OBJECT_NAME(CONSTID) = 'FK_ZnodeCMSWidgetProfileVariantLocale_ZnodeCMSContainerTemplate')
BEGIN
	ALTER TABLE ZnodeCMSContainerProfileVariantLocale DROP CONSTRAINT FK_ZnodeCMSWidgetProfileVariantLocale_ZnodeCMSContainerTemplate
END
IF EXISTS(SELECT * FROM SYS.sysconstraints WHERE OBJECT_NAME(CONSTID) = 'FK_ZnodePublishContentContainerVariantEntity_CMSContainerTemplateId')
BEGIN
	ALTER TABLE ZnodePublishContentContainerVariantEntity DROP CONSTRAINT FK_ZnodePublishContentContainerVariantEntity_CMSContainerTemplateId
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'ZnodeDevExpressReport_GetAbandonedCart')
	DROP PROC ZnodeDevExpressReport_GetAbandonedCart
GO



CREATE PROCEDURE [dbo].[ZnodeDevExpressReport_GetAbandonedCart]  
(
 @BeginDate    DATETIME        ,  
 @EndDate      DATETIME       ,  
 @StoreName   NVARCHAR(max) = '',  
 @ShowOnlyRegisteredUsers BIT = 1   
 
 )  
AS   
/*  
     Summary :- This Procedure is used to get frequently Appear users    
     Unit Testing   
     EXEC ZnodeDevExpressReport_GetAbandonedCart @BeginDate = '2019-02-20 17:34:03.953',@EndDate= '2019-02-20 17:34:03.953'  
	a.ModifiedDate,a.CreatedDate,
*/  
     BEGIN  
         BEGIN TRY  
         DECLARE @SQL NVARCHAR(MAX)  
         DECLARE @GetDate DATETIME = dbo.Fn_GetDate()

		IF OBJECT_ID('TEMPDB..#TBL_ReportOrderDetails') IS NOT NULL
		DROP TABLE #TBL_ReportOrderDetails

		IF OBJECT_ID('TEMPDB..#TBL_PortalId') IS NOT NULL
		DROP TABLE #TBL_PortalId

		IF OBJECT_ID('TEMPDB..#TBL_ProductPricing') IS NOT NULL
		DROP TABLE #TBL_ProductPricing


   CREATE TABLE #TBL_ReportOrderDetails  (OmsSavedCartId INT ,Quantity NUMERIC(28,6) 
   , CartCreatedAt datetime,CartUpdatedAt datetime,CustomerName VARCHAR(300),StoreName nvarchar(max),Email  VARCHAR(50),
   CustomerType  VARCHAR(50), SKU nvarchar(4000),PortalId INT
   );  
  
    Create TABLE  #TBL_PortalId  (PortalId INT );  
   INSERT INTO #TBL_PortalId  
   SELECT PortalId   
   FROM ZnodePortal ZP   
   INNER JOIN dbo.split(@StoreName,'|') SP ON (SP.Item = ZP.StoreName)  
  
   INSERT INTO #TBL_ReportOrderDetails  
   select DISTINCT a.OmsSavedCartId,sum(Quantity) as Quantity,MAX(a.CreatedDate) AS CartCreatedAt,  
   MAX(a.ModifiedDate) as CartUpdatedAt, CASE WHEN REPLACE(ISNULL(FirstName,'')+' '+ISNULL(LastName,''),' ','') = ''   
   THEN f.UserName ELSE ISNULL(FirstName,'')+' '+ISNULL(LastName,'') END  CustomerName , p.StoreName ,d.Email AS Email
   ,CASE WHEN  d.AspNetUserId IS NULL THEN 'Guest User' ELSE 'Registered User' END  CustomerType, b.SKU, p.PortalId
   from ZnodeOmsSavedCart a  
   INNER JOIN ZnodeOmsSavedCartLineItem b on a.OmsSavedCartId = b.OmsSavedCartId  
   INNER JOIN ZnodeOmsCookieMapping c on a.OmsCookieMappingId = c.OmsCookieMappingId  
   INNER JOIN ZnodePortal p on c.PortalId = p.PortalId  
   LEFT JOIN ZnodeUser d on c.UserId = d.UserId  
   LEFT JOIN AspNetUsers e on d.AspNetUserId = e.Id  
   LEFT JOIN AspNetZnodeUser f on f.AspNetZnodeUserId = e.UserName  
   WHERE 
    (EXISTS (SELECT TOP 1 1 FROM #TBL_PortalId rt WHERE rt.PortalId = p.PortalId)
				      OR NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PortalId )) 
	AND ((@ShowOnlyRegisteredUsers = 1 and d.AspNetUserId  IS NOT NULL) or (@ShowOnlyRegisteredUsers <> 1 ))
	AND CAST(b.ModifiedDate AS DATETIME) BETWEEN @BeginDate AND @EndDate 
   group by a.OmsSavedCartId,f.UserName, p.StoreName,FirstName, LastName  ,d.Email,d.AspNetUserId,b.SKU,p.PortalId
       
	   

    select DISTINCT a.OmsSavedCartId,sum(Quantity) as Quantity,MAX(b.CreatedDate) AS CartCreatedAt,  
   MAX(b.ModifiedDate) as CartUpdatedAt, CASE WHEN REPLACE(ISNULL(FirstName,'')+' '+ISNULL(LastName,''),' ','') = ''   
   THEN f.UserName ELSE ISNULL(FirstName,'')+' '+ISNULL(LastName,'') END  CustomerName , p.StoreName ,d.Email AS Email
   ,CASE WHEN  d.AspNetUserId IS NULL THEN 'Guest User' ELSE 'Registered User' END  CustomerType, b.SKU, p.PortalId
   INTO #tempabandonedcart 
   from ZnodeOmsSavedCart a  
   INNER JOIN ZnodeOmsSavedCartLineItem b on a.OmsSavedCartId = b.OmsSavedCartId  
   INNER JOIN ZnodeOmsCookieMapping c on a.OmsCookieMappingId = c.OmsCookieMappingId  
   INNER JOIN ZnodePortal p on c.PortalId = p.PortalId  
   LEFT JOIN ZnodeUser d on c.UserId = d.UserId  
   LEFT JOIN AspNetUsers e on d.AspNetUserId = e.Id  
   LEFT JOIN AspNetZnodeUser f on f.AspNetZnodeUserId = e.UserName  
   WHERE 
    (EXISTS (SELECT TOP 1 1 FROM #TBL_PortalId rt WHERE rt.PortalId = p.PortalId)
				      OR NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PortalId )) 
	AND ((@ShowOnlyRegisteredUsers = 1 and d.AspNetUserId  IS NOT NULL) or (@ShowOnlyRegisteredUsers <> 1 ))
	AND CAST(b.ModifiedDate AS DATETIME) BETWEEN @BeginDate AND @EndDate 
	AND b.OrderLineItemRelationshipTypeId NOT IN (SELECT OrderLineItemRelationshipTypeId FROM ZnodeOmsOrderLineItemRelationshipType
    WHERE Name = 'AddOns')
   group by a.OmsSavedCartId,f.UserName, p.StoreName,FirstName, LastName  ,d.Email,d.AspNetUserId,b.SKU,p.PortalId

   
	DECLARE @skuuu SelectColumnList, @PortalId TransferId
  
    INSERT INTO @skuuu
	SELECT SKU FROM #TBL_ReportOrderDetails

	INSERT INTO @PortalId
	SELECT DISTINCT PortalId FROM #TBL_ReportOrderDetails
	
	CREATE TABLE #TBL_ProductPricing  (SKU VARCHAR(1000),RetailPrice VARCHAR(1000) );
	
	 

	INSERT INTO #TBL_ProductPricing (SKU,RetailPrice)
	EXEC Znode_GetAbandonedProductPricingBySku  @skuuu, @PortalId, @GetDate
	 

   SELECT  DISTINCT A.OmsSavedCartId,MAx(A.CartCreatedAt) CartCreatedAt,MAX(A.CartUpdatedAt) CartUpdatedAt,A.CustomerName,A.StoreName,A.Email ,
   A.CustomerType , SUM(B.RetailPrice * A.Quantity) AS SubTotal 
   INTO #tempcarttt
   FROM #TBL_ReportOrderDetails  A
   INNER JOIN #TBL_ProductPricing B ON (A.SKU = B.SKU) -- addon
   GROUP BY A.OmsSavedCartId,A.CustomerName,A.StoreName,A.Email ,
   A.CustomerType
   ORDER BY A.StoreName DESC,CartUpdatedAt DESC,CustomerName DESC  
       
	  select c.OmsSavedCartId,a.CartCreatedAt, a.CartUpdatedAt,a.CustomerName,a.StoreName,a.Email
	  ,a.CustomerType,a.SubTotal, SUM(c.Quantity) Quantity ,COUNT(*) Products
	  from  #tempcarttt a
	  inner join #tempabandonedcart C on (a.OmsSavedCartId = c.OmsSavedCartId)
	  GROUP BY C.OmsSavedCartId ,a.CartCreatedAt, a.CartUpdatedAt,a.CustomerName,a.StoreName,a.Email
	  ,a.CustomerType,a.SubTotal

			IF OBJECT_ID('TEMPDB..#TBL_ReportOrderDetails') IS NOT NULL
			DROP TABLE #TBL_ReportOrderDetails

			IF OBJECT_ID('TEMPDB..#TBL_PortalId') IS NOT NULL
			DROP TABLE #TBL_PortalId

			IF OBJECT_ID('TEMPDB..#TBL_ProductPricing') IS NOT NULL
			DROP TABLE #TBL_ProductPricing
	                
         END TRY  
         BEGIN CATCH  
		
             DECLARE @Status BIT ;  
       SET @Status = 0;  
       DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),  
    @ErrorCall NVARCHAR(MAX)= 'EXEC ZnodeDevExpressReport_GetAbandonedCart @BeginDate='+CAST(@BeginDate AS VARCHAR(200))+',@EndDate='+CAST(@EndDate AS VARCHAR(200))+',@Status='+CAST(@Status AS VARCHAR(10));  
                    
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
      
             EXEC Znode_InsertProcedureErrorLog  
    @ProcedureName = 'ZnodeDevExpressReport_GetAbandonedCart',  
    @ErrorInProcedure = @Error_procedure,  
    @ErrorMessage = @ErrorMessage,  
    @ErrorLine = @ErrorLine,  
    @ErrorCall = @ErrorCall;  
         END CATCH;  
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetAbandonedProductPricingBySku')
	DROP PROC Znode_GetAbandonedProductPricingBySku
GO



CREATE PROCEDURE [dbo].[Znode_GetAbandonedProductPricingBySku]
(   
    @SKU              SelectColumnList READONLY,
    @PortalId         TransferId READONLY,
    @currentUtcDate   VARCHAR(100), -- this date is required for the user date r
    @UserId           INT          = 0 -- userid is optional 
    
	)
AS 
   /* 
    --Summary: Retrive Price of product from pricelist
    --Input Parameters:
    --UserId, SKU(Comma separated multiple), PortalId
    --Conditions :
    --1. If userId is null then check for PriceList having sku associated to profile which is associated to Portal having  PortalId and  having higher Precedence and valid ActivationDate and ExpirationDate for PriceList  and SKU also.
    --Unit Testing : 
    --EXEC Znode_GetPublishProductPricingBySku_2 @SKU = 'apple,apr234' , @PortalId = 34 , @currentUtcDate = '2016-09-17 00:00:00.000';
    --2. If There is no any PriceList having given sku associated to profile  then check for  
    --PriceList associated portal having PortalId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
    --Unit Testing : 
    --EXEC Znode_GetPublishProductPricingBySku_2 @SKU = 'apple,apr234' , @PortalId = 34 , @currentUtcDate = '2016-09-17 00:00:00.000';
    --3. If userId is not null then check for PriceList having sku associated to User having UserId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
    --4. If There is no any PriceList having given sku associated to user  then check for  
    --PriceList associated Account having UserId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
    --5. If There is no any PriceList having given sku associated to account  then check for  
    --PriceList associated Profile having PortalId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
    --6. If There is no any PriceList having given sku associated to Profile  then check for  
    --PriceList associated Portal having PortalId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
    --7. If in each case Precedence is same then get PriceList according to higher PriceListId ActivationDate and ExpirationDate for PriceList and SKU also.
    --8. Also get the Tier Price, Tier Quantity of given sku.
    --Unit Testing   
    --Exec Znode_GetPublishProductPricingBySku  @SKU = 'Levi''s T-Shirt & Jeans - Bundle Product',@PortalId = 1, @currentUtcDate = '2016-07-31 00:00:00.000'
	*/
    
     BEGIN
         BEGIN TRY
             SET NOCOUNT ON;
			 DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
             DECLARE @Tlb_SKU TABLE
             (SKU        VARCHAR(100),
              SequenceNo INT IDENTITY
             );

			  DECLARE @DefaultLocaleId INT = dbo.FN_GETDEFAULTLocaleId()

			IF OBJECT_ID('TEMPDB..#TLB_SKUPRICELIST') IS NOT NULL
			DROP TABLE #TLB_SKUPRICELIST

			IF OBJECT_ID('TEMPDB..#Tbl_PortalWisePriceList') IS NOT NULL
			DROP TABLE #Tbl_PortalWisePriceList

			IF OBJECT_ID('TEMPDB..#Tbl_PriceListWisePrice') IS NOT NULL
			DROP TABLE #Tbl_PriceListWisePrice

			 --IF @SKU = '' 
			 --BEGIN 
			 -- INSERT INTO @Tlb_SKU(SKU)
			 -- 	SELECT (SELECT ''+SKU FOR XML PATH('')) 
				--	FROM ZnodePublishProductDetail a
				--	WHERE LocaleId = @DefaultLocaleId


			 --END 
			 --ELSE 
			 --BEGIN
			 --  INSERT INTO @Tlb_SKU(SKU)
    --                SELECT Item
    --                FROM Dbo.split(@SKU, ',');
			  

			 --END 

          
             CREATE TABLE #TLB_SKUPRICELIST 
             (SKU          VARCHAR(100),
              RetailPrice  NUMERIC(28, 6),
              SalesPrice   NUMERIC(28, 6),
              PriceListId  INT,
              TierPrice    NUMERIC(28, 6),
              TierQuantity NUMERIC(28, 6),
			  ExternalId NVARCHAR(2000),
			  Custom1 NVARCHAR(MAX),
			  Custom2 NVARCHAR(MAX),
			  Custom3 NVARCHAR(MAX)
             );
             DECLARE @PriceListId INT, @PriceRoundOff INT;
             SELECT @PriceRoundOff = CONVERT( INT, FeatureValues)
             FROM ZnodeGlobalSetting
             WHERE FeatureName = 'PriceRoundOff';
		
             --Retrive portal wise pricelist  
             CREATE TABLE #Tbl_PortalWisePriceList 
             (PriceListId    INT,
              ActivationDate DATETIME,
              ExpirationDate DATETIME NULL,
              Precedence     INT,
			  SKU NVARCHAR(300)
             );
             --Retrive price for respective pricelist   
             CREATE TABLE #Tbl_PriceListWisePrice  
             (
				  PriceListId    INT,
				  SKU            VARCHAR(300),
				  SalesPrice     NUMERIC(28, 6),
				  RetailPrice    NUMERIC(28, 6),
				  UomId          INT,
				  UnitSize       NUMERIC(28, 6),
				  ActivationDate DATETIME,
				  ExpirationDate DATETIME NULL,
				  TierPrice      NUMERIC(28, 6),
				  TierQuantity   NUMERIC(28, 6),
				  TierUomId      INT,
				  TierUnitSize   NUMERIC(28, 6), 
				  ExternalId NVARCHAR(2000),
				  Custom1 NVARCHAR(MAX),
				  Custom2 NVARCHAR(MAX),
				  Custom3 NVARCHAR(MAX)
             );
			 DECLARE @Tbl_SKUWisePriceList TABLE (PriceListId INT, SKU NVARCHAR(300))

			 insert into @Tbl_SKUWisePriceList(PriceListId,SKU) 
			 SELECT  PriceListId,SKU from ZnodePrice ZP where exists (Select * from @SKU sku where ZP.SKU = sku.StringColumn)
			 Union
			 SELECT PriceListId,SKU  from ZnodePriceTier ZPT where exists (Select * from @SKU sku where ZPT.SKU = sku.StringColumn) 
			 
			

			 --1. If userId is null then check for PriceList having sku associated to profile which is associated to Portal having  PortalId and  having higher Precedence and valid ActivationDate and ExpirationDate for PriceList  and SKU also.
            IF @UserId = 0
                 BEGIN
					INSERT INTO #Tbl_PortalWisePriceList( PriceListId, ActivationDate, ExpirationDate, Precedence,SKU )
					SELECT a.PriceListId, ActivationDate, ISNULL(ExpirationDate, @GetDate), b.Precedence,tsw.SKU
					FROM ZnodePriceList AS a INNER JOIN ZnodePriceListProfile AS b ON a.PriceListId = b.PriceListId INNER JOIN ZnodePortalProfile AS c
						ON b.PortalProfileId = c.PortalProfileID AND  c.IsDefaultAnonymousProfile = 1 INNER JOIN ZnodePortalunit AS zupu ON a.CultureId = zupu.CultureId 
						inner join @Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
					WHERE @CurrentUtcDate BETWEEN a.ActivationDate AND ISNULL(a.ExpirationDate, @GetDate) AND 
					 EXISTS (SELECT TOP 1 1 FROM @PortalId WHERE Id = c.PortalId) -- c.PortalId = @PortalId
					ORDER BY b.Precedence;
		
			 
                     --2. If There is no any PriceList having given sku associated to profile  then check for PriceList associated portal having PortalId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
			IF Exists (Select top 1 1  FROM @Tbl_SKUWisePriceList tspl where NOT Exists (SELECT TOP 1 1 FROM #Tbl_PortalWisePriceList tpwl
				WHERE tspl.SKU = tpwl.SKU))
                         BEGIN
							INSERT INTO #Tbl_PortalWisePriceList( PriceListId, ActivationDate, ExpirationDate, Precedence,SKU )
							SELECT a.PriceListId, ActivationDate, ISNULL(ExpirationDate, @GetDate), b.Precedence,tsw.SKU
							FROM ZnodePriceList AS a INNER JOIN ZnodePriceListPortal AS b ON a.PriceListId = b.PriceListId
							INNER JOIN ZnodePortalunit AS zupu ON a.CultureId = zupu.CultureId   
							inner join @Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
							AND NOT EXISTS (Select TOP 1 1 FROM  #Tbl_PortalWisePriceList tpwl WHERE tpwl.SKU = tsw.SKU )
							WHERE @CurrentUtcDate BETWEEN a.ActivationDate 
							AND ISNULL(a.ExpirationDate, @GetDate) AND 
							 EXISTS (SELECT TOP 1 1 FROM @PortalId WHERE Id = b.PortalId) --b.PortalId = @PortalId
							ORDER BY b.Precedence
							;
							--Delete from @Tbl_SKUWisePriceList where PriceListId in (Select PriceListId from  #Tbl_PortalWisePriceList )
						
                         END;
                 END;
                     --3. If userId is not null then check for PriceList having sku associated to User having UserId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
             ELSE
                 BEGIN
				 
                     INSERT INTO #Tbl_PortalWisePriceList (PriceListId, ActivationDate, ExpirationDate, Precedence,SKU )
                            SELECT a.PriceListId, ActivationDate,ISNULL(ExpirationDate, @GetDate), b.Precedence,tsw.SKU
                            FROM ZnodePriceList AS a INNER JOIN ZnodePriceListUser AS b ON a.PriceListId = b.PriceListId
                                 INNER JOIN ZnodePortalunit zupu ON (a.CultureId = zupu.CultureId 
								 AND EXISTS (SELECT TOP 1 1 FROM @PortalId WHERE Id = zupu.PortalId) )--zupu.PortalId = @PortalId  )
								 inner join @Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
								 AND NOT EXISTS (Select TOP 1 1 FROM  #Tbl_PortalWisePriceList tpwl WHERE tpwl.SKU = tsw.SKU )
								 
                            WHERE @CurrentUtcDate BETWEEN a.ActivationDate AND ISNULL(a.ExpirationDate, @GetDate) AND b.UserID = @UserId
							ORDER BY b.Precedence ;

                --4. If There is no any PriceList having given sku associated to user  then check for PriceList associated Account having UserId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
				IF Exists (Select top 1 1  FROM @Tbl_SKUWisePriceList tspl where NOT Exists (SELECT TOP 1 1 FROM #Tbl_PortalWisePriceList tpwl
				WHERE tspl.SKU = tpwl.SKU))
						BEGIN
							INSERT INTO #Tbl_PortalWisePriceList( PriceListId, ActivationDate, ExpirationDate, Precedence,SKU )
								   SELECT a.PriceListId, ActivationDate, ISNULL(ExpirationDate, @GetDate), c.Precedence,tsw.SKU
								   FROM ZnodePriceList AS a INNER JOIN ZnodePriceListAccount AS c ON a.PriceListId = c.PriceListId
										INNER JOIN ZnodeUser AS d ON c.Accountid = d.Accountid INNER JOIN ZnodePortalunit AS zupu ON (a.CultureId = zupu.CultureId   
										AND EXISTS (SELECT TOP 1 1 FROM @PortalId WHERE Id = zupu.PortalId) )--AND zupu.PortalId = @PortalId
										inner join @Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
										AND NOT EXISTS (Select TOP 1 1 FROM  #Tbl_PortalWisePriceList tpwl WHERE tpwl.SKU = tsw.SKU )
								   WHERE @CurrentUtcDate BETWEEN a.ActivationDate AND ISNULL(a.ExpirationDate, @GetDate) AND d.UserID = @UserId
									ORDER BY c.Precedence
							--Delete from @Tbl_SKUWisePriceList where PriceListId in (Select PriceListId from  #Tbl_PortalWisePriceList )
						 END;
                     -- 5. If There is no any PriceList having given sku associated to account  then check for PriceList associated Profile having PortalId and having higher   Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
				IF Exists (Select top 1 1  FROM @Tbl_SKUWisePriceList tspl 
				where NOT Exists (SELECT TOP 1 1 FROM #Tbl_PortalWisePriceList tpwl
				WHERE tspl.SKU = tpwl.SKU))

                         BEGIN
                             INSERT INTO #Tbl_PortalWisePriceList(PriceListId,ActivationDate,ExpirationDate,Precedence,SKU)
                                    SELECT a.PriceListId, ActivationDate, ISNULL(ExpirationDate, @GetDate), b.Precedence,tsw.SKU
                                    FROM ZnodePriceList AS a
                                         INNER JOIN ZnodePriceListProfile AS b ON a.PriceListId = b.PriceListId 
										 INNER JOIN ZnodePortalProfile AS c ON (b.PortalProfileId = c.PortalProfileId  
										 AND EXISTS (SELECT TOP 1 1 FROM @PortalId WHERE Id = c.PortalId) )--AND c.PortalId = @PortalId 
                                         INNER JOIN dbo.ZnodeUserProfile zup ON c.ProfileId = zup.ProfileId AND IsDefault = 1
                                         INNER JOIN ZnodePortalunit zupu ON (a.CultureId = zupu.CultureId 
										 AND EXISTS (SELECT TOP 1 1 FROM @PortalId WHERE Id = zupu.PortalId) )--AND zupu.PortalId = @PortalId 
										 inner join @Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
										 AND NOT EXISTS (Select TOP 1 1 FROM  #Tbl_PortalWisePriceList tpwl WHERE tpwl.SKU = tsw.SKU )
                                    WHERE @CurrentUtcDate BETWEEN a.ActivationDate AND ISNULL(a.ExpirationDate, @GetDate) AND zup.UserId = @UserId;
									--Delete from @Tbl_SKUWisePriceList where PriceListId in (Select PriceListId from  #Tbl_PortalWisePriceList )

					     END;
                   

                     ---6. If There is no any PriceList having given sku associated to Profile  then check for priceList associated Portal having PortalId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
                  				IF Exists (Select top 1 1  FROM @Tbl_SKUWisePriceList tspl 
								where NOT Exists (SELECT TOP 1 1 FROM #Tbl_PortalWisePriceList tpwl
				WHERE tspl.SKU = tpwl.SKU))

                         BEGIN
							INSERT INTO #Tbl_PortalWisePriceList( PriceListId, ActivationDate, ExpirationDate, Precedence,SKU )
							SELECT a.PriceListId, ActivationDate, ISNULL(ExpirationDate, @GetDate), b.Precedence,tsw.SKU
							FROM ZnodePriceList AS a INNER JOIN ZnodePriceListPortal AS b ON a.PriceListId = b.PriceListId
								INNER JOIN ZnodePortalunit AS zupu ON a.CultureId = zupu.CultureId AND  zupu.PortalId = b.PortalId    
								inner join @Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
								AND NOT EXISTS (Select TOP 1 1 FROM  #Tbl_PortalWisePriceList tpwl WHERE tpwl.SKU = tsw.SKU )
								WHERE @CurrentUtcDate BETWEEN a.ActivationDate AND ISNULL(a.ExpirationDate, @GetDate) 
								AND EXISTS (SELECT TOP 1 1 FROM @PortalId WHERE Id = b.PortalId) --AND b.PortalId = @PortalId
							    ORDER BY b.Precedence
								;
								--Delete from @Tbl_SKUWisePriceList where PriceListId in (Select PriceListId from  #Tbl_PortalWisePriceList )
                         END;
						 
				--IF Exists (Select top 1 1  FROM @Tbl_SKUWisePriceList tspl where NOT Exists (SELECT TOP 1 1 FROM #Tbl_PortalWisePriceList tpwl
				--WHERE tspl.SKU = tpwl.SKU))
				--BEGIN
				
				--	INSERT INTO #Tbl_PortalWisePriceList( PriceListId, ActivationDate, ExpirationDate, Precedence,SKU )
				--	SELECT a.PriceListId, ActivationDate, ISNULL(ExpirationDate, @GetDate), b.Precedence,tsw.SKU
				--	FROM ZnodePriceList AS a INNER JOIN ZnodePriceListProfile AS b ON a.PriceListId = b.PriceListId INNER JOIN ZnodePortalProfile AS c
				--	ON b.ProfileId = c.ProfileId AND  c.IsDefaultAnonymousProfile = 1 INNER JOIN ZnodePortalunit AS zupu ON a.CurrencyId = zupu.CurrencyId
				--	inner join @Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
				--	AND NOT EXISTS (Select TOP 1 1 FROM  #Tbl_PortalWisePriceList tpwl WHERE tpwl.SKU = tsw.SKU )
				--	WHERE @CurrentUtcDate BETWEEN a.ActivationDate AND ISNULL(a.ExpirationDate, @GetDate) AND c.PortalId = @PortalId;
				--END

                 END;
			
             SET @PriceListId = 0;
             -- Check Activation date and expiry date 
             IF EXISTS( SELECT TOP 1 1 FROM #Tbl_PortalWisePriceList)
                 BEGIN
				
                     -- Declare  @d datetime
                     -- SET @d = @GetDate
                     -- Select ISNULL(ActivationDate,@d)  , ISNULL( ExpirationDate,@GetDate ),b.Precedence,* from ZnodePriceList  a inner join ZnodePriceListPortal b on a.PriceListId = b.PriceListId where @d between ISNULL(ActivationDate,@d) 
                     -- and ISNULL(ExpirationDate,@GetDate ) --and a.PriceListId <>  80
                     -- Order by ISNULL(ActivationDate,@d)  , ISNULL( ExpirationDate,@GetDate ) ,  b.Precedence DESC 
                     --	Retrive pricelist wise price
                   INSERT INTO #Tbl_PriceListWisePrice( PriceListId, SKU, SalesPrice, RetailPrice, UomId, UnitSize, ActivationDate, ExpirationDate, TierPrice, TierQuantity, TierUomId, TierUnitSize , ExternalId ,Custom1,Custom2,Custom3)
				   SELECT ZP.PriceListId, ZP.SKU, ZP.SalesPrice, ZP.RetailPrice, ZP.UomId, ZP.UnitSize, ISNULL(ZP.ActivationDate, @CurrentUtcDate), ISNULL(ZP.ExpirationDate, @GetDate), ZPT.Price, ZPT.Quantity, ZPT.UomId, ZPT.UnitSize, ZP.ExternalId,
				   ZPT.Custom1,ZPT.Custom2,ZPT.Custom3
				   FROM [ZnodePrice] AS ZP 
				   INNER JOIN @SKU AS TSKU ON ZP.SKU = TSKU.StringColumn 
				   LEFT OUTER JOIN ZnodePriceTier AS ZPT ON ZP.SKU = ZPT.SKU AND ZP.PriceListId = ZPT.PriceListId
				   WHERE ZP.PriceListId IN
				   (
					   SELECT TOP 1 PriceListId
					   FROM #Tbl_PortalWisePriceList AS TBPWPL
					   WHERE  TBPWPL.SKU = ZP.SKU
					   ORDER BY Precedence 
				   );
				   

                     -- Check Activation date and expiry date 
                    INSERT INTO #TLB_SKUPRICELIST( PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId,Custom1,Custom2,Custom3 )
					   SELECT DISTINCT  PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId,Custom1,Custom2,Custom3
					   FROM #Tbl_PriceListWisePrice
					   WHERE @currentUtcDate BETWEEN ActivationDate AND ISNULL(ExpirationDate, @GetDate);
					   
					  
					INSERT INTO #TLB_SKUPRICELIST( PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId ,Custom1,Custom2,Custom3)
					   SELECT PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId,Custom1,Custom2,Custom3
					   FROM #Tbl_PriceListWisePrice
					   WHERE SKU NOT IN(SELECT SKU FROM #TLB_SKUPRICELIST) and ActivationDate is null 
				
                 END;
                     -- Retrive data as per precedance from ZnodePriceListPortal table  
					
             ELSE
                 BEGIN
                     SET @PriceListId =( SELECT TOP 1 PriceListId FROM #Tbl_PortalWisePriceList ORDER BY Precedence  );

                     --Retrive pricelist wise price  
                     INSERT INTO #Tbl_PriceListWisePrice( PriceListId, SKU, SalesPrice, RetailPrice, UomId, UnitSize, ActivationDate, ExpirationDate, TierPrice, TierQuantity, TierUomId, TierUnitSize, ExternalId ,Custom1,Custom2,Custom3)
					 SELECT ZP.PriceListId, ZP.SKU, ZP.SalesPrice, ZP.RetailPrice, ZP.UomId, ZP.UnitSize, ISNULL(ZP.ActivationDate, @CurrentUtcDate), 
							ISNULL(ZP.ExpirationDate, @GetDate), ZPT.Price, ZPT.Quantity, ZPT.UomId, ZPT.UnitSize, zp.ExternalId,Custom1,Custom2,Custom3
					 FROM [ZnodePrice] AS ZP INNER JOIN @SKU AS TSKU ON ZP.SKU = TSKU.StringColumn LEFT OUTER JOIN ZnodePriceTier AS ZPT ON ZP.SKU = ZPT.SKU AND 
							   ZP.PriceListId = ZPT.PriceListId WHERE ZP.PriceListId = @PriceListId; 

                     -- Check Activation date and expiry date 
					INSERT INTO #TLB_SKUPRICELIST( PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId ,Custom1,Custom2,Custom3)
					SELECT PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId,Custom1,Custom2,Custom3
					FROM #Tbl_PriceListWisePrice WHERE @currentUtcDate BETWEEN ActivationDate AND ISNULL(ExpirationDate, @GetDate);
					
					INSERT INTO #TLB_SKUPRICELIST( PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId ,Custom1,Custom2,Custom3)
					SELECT PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId,Custom1,Custom2,Custom3
					FROM #Tbl_PriceListWisePrice
					WHERE SKU NOT IN ( SELECT SKU FROM #TLB_SKUPRICELIST) and ActivationDate is null;

                 END;
             SELECT DISTINCT SKU,
                      ROUND(RetailPrice, @PriceRoundOff) AS RetailPrice
             FROM #TLB_SKUPRICELIST AS TSPL
                  INNER JOIN ZnodePriceList AS ZPL ON TSPL.PriceListId = ZPL.PriceListId
                  INNER JOIN ZnodeCulture AS ZC ON ZPL.CultureId = ZC.CultureId    
				  LEFT JOIN ZnodeCurrency AS ZCC ON ZC.CurrencyId = ZCC.CurrencyId   
				  --ORDER BY TierQuantity ASC;

				IF OBJECT_ID('TEMPDB..#TLB_SKUPRICELIST') IS NOT NULL
				DROP TABLE #TLB_SKUPRICELIST

				IF OBJECT_ID('TEMPDB..#Tbl_PortalWisePriceList') IS NOT NULL
				DROP TABLE #Tbl_PortalWisePriceList

				IF OBJECT_ID('TEMPDB..#Tbl_PriceListWisePrice') IS NOT NULL
				DROP TABLE #Tbl_PriceListWisePrice

         END TRY
         BEGIN CATCH
              DECLARE @Status BIT ;
			SET @Status = 0;
			SELECT ERROR_MESSAGE()
			--DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishProductPricingBySku @SKU = '+@SKU+',@PortalId = '+CAST(@PortalId AS VARCHAR(10))+',@currentUtcDate = '+@currentUtcDate+',@UserId='+CAST(@UserId AS VARCHAR(100))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
			--SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
			--EXEC Znode_InsertProcedureErrorLog
			--	@ProcedureName = 'Znode_GetPublishProductPricingBySku',
			--	@ErrorInProcedure = @Error_procedure,
			--	@ErrorMessage = @ErrorMessage,
			--	@ErrorLine = @ErrorLine,
			--	@ErrorCall = @ErrorCall;
         END CATCH;
     END;
	 GO 

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishAssociatedAddonsJson')
	DROP PROC Znode_GetPublishAssociatedAddonsJson
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishAssociatedAddonsJson]
(
	@PublishCatalogId NVARCHAR(MAX) = 0,
	@PimProductId    TransferId Readonly,
	@VersionId        INT           = 0,
	@UserId           INT,														 
	@PimCategoryHierarchyId int = 0, 
	@LocaleId       TransferId READONLY,
	@PublishStateId INT = 0, 
	@VersionIdString  VARCHAR(100)= '',
	@Status		   Bit  OutPut,
	@RevisionType Varchar(50)
)
AS 
   
/*
    Summary : If PimcatalogId is provided get all products with Addons and provide above mentioned data
       If PimProductId is provided get all Addons if associated with given product id and provide above mentioned data
    			Input: @PublishCatalogId or @PimProductId
    		    output should be in XML format
       sample xml5
    Begin transaction  
	 declare  @PimProductId TransferId 
	 Declare @Status bit 
	 INSERT INTO @PimProductId  values (768)

			Exec [_Znode_GetPublishAssociatedAddonsJson]
				@PublishCatalogId = 0 ,
				@PimProductId   = @PimProductId,
				@UserId =2,														 
				@VersionIdString = '',--'1662,1664,1663,1665',
				@Status	 =@Status Out,
				@RevisionType= 'Production'
				rollback transaction
				--SELECT * from ZnodePublishVersionEntity 
   
	*/

BEGIN
    BEGIN TRY
    SET NOCOUNT ON 
		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
        DECLARE @LocaleIdIn INT, @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId()
		, @Counter INT= 1
		, @MaxRowId INT= 0;

    -- DECLARE @PimAddOnGroupId VARCHAR(MAX);

		CREATE TABLE #TBL_PublisshIds  (PublishProductId INT , PimProductId INT , PublishCatalogId INT)
		DECLARE @TBL_LocaleId TABLE (RowId    INT IDENTITY(1, 1),LocaleId INT);
		IF OBJECT_ID('tempdb..#VesionIds') is not null
		DROP TABLE #VesionIds
		Create Table #VesionIds(ZnodeCatalogId int , VersionId int , LocaleId int , RevisionType varchar(50) )

  		If @VersionIdString <> ''
		BEGIN
			Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)	
			SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType
			FROM ZnodePublishVersionEntity PV Inner join Split(@VersionIdString,',') S ON PV.VersionId = S.Item
		END
		Else 
		Begin
			If  (@RevisionType like '%Preview%'  OR @RevisionType like '%Production%')
			BEGIN
				Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)	
				SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV  where PV.IsPublishSuccess =1 
				AND PV.RevisionType ='Preview'
			END
			If  (@RevisionType like '%Production%' OR @RevisionType = 'None')
			BEGIN
				Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)	
				SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV  where PV.IsPublishSuccess =1 
				AND PV.RevisionType ='Production'
			END					
		End 

		IF (@PublishCatalogId IS NULL OR @PublishCatalogId = 0)
		BEGIN 
			INSERT INTO #TBL_PublisshIds 
			EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId,@userid,@PimProductId,1
		END 
		IF ISnull(@PimCategoryHierarchyId,0) <> 0 
		BEGIN 
			INSERT INTO #TBL_PublisshIds 
			EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId,@userid,@PimProductId,1,@PimCategoryHierarchyId 
		END 

		CREATE TABLE #TBL_PublishCatalogId (PublishCatalogId INT,PublishProductId INT,PimProductId  INT , VersionId INT ,LocaleId INT  );

		IF  ISnull(@PimCategoryHierarchyId,0) <> 0 
		BEGIN 
			INSERT INTO #TBL_PublishCatalogId 
			SELECT ZPP.PublishCatalogId , ZPP.PublishProductId,PimProductId, MAX(ZPCP.PublishCatalogLogId)  ,LocaleId 
			FROM ZnodePublishProduct ZPP 
			INNER JOIN ZnodePublishCatalogLog ZPCP ON (ZPCP.PublishCatalogId  = ZPP.PublishCatalogId)
			WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId   ) 
			AND ZPCP.Publishstateid = @PublishStateId
			GROUP BY ZPP.PublishCatalogId,ZPP.PublishProductId,PimProductId,LocaleId 
		END 
		ELSE 
		Begin
			INSERT INTO #TBL_PublishCatalogId  
			SELECT ZPP.PublishCatalogId , ZPP.PublishProductId,PimProductId,0  VersionId  ,0 LocaleId 
			FROM ZnodePublishProduct ZPP  
			WHERE EXISTS  (SELECT TOP 1 1 FROM #VesionIds ZPCP WHERE (ZPCP.ZnodeCatalogId  = ZPP.PublishCatalogId)) AND
			(EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId  
			AND  @PublishCatalogId = '0' )  OR (ZPP.PublishCatalogId =  @PublishCatalogId ))
		END
        DECLARE @TBL_AddonGroupLocale TABLE( PimAddonGroupId INT, DisplayType NVARCHAR(400),AddonGroupName NVARCHAR(MAX),LocaleId INT );
        INSERT INTO @TBL_LocaleId(LocaleId)
        SELECT LocaleId FROM ZnodeLocale MT  WHERE IsActive = 1 AND (EXISTS (SELECT TOP 1 1  FROM @LocaleId RT WHERE RT.Id = MT.LocaleId )
			OR NOT EXISTS (SELECT TOP 1 1 FROM @LocaleId ));
        SET @MaxRowId = ISNULL(( SELECT MAX(RowId) FROM @TBL_LocaleId ), 0);
    
        WHILE (@Counter <= @MaxRowId)
        BEGIN
            SET @LocaleIdIn =( SELECT LocaleId FROM @TBL_LocaleId WHERE RowId = @Counter );
            INSERT INTO @TBL_AddonGroupLocale (PimAddonGroupId, DisplayType, AddonGroupName)
            EXEC Znode_GetAddOnGroupLocale '', @LocaleIdIn;
	   		UPDATE @TBL_AddonGroupLocale SET LocaleId = @LocaleIdIn WHERE LocaleId IS NULL 
            SET @Counter = @Counter + 1;
        END;
		
		IF OBJECT_ID('tempdb..#AddonProductPublishedXML') is not null
		drop table #AddonProductPublishedXML
						
		SELECT  ZPPP.PublishProductId,ZPPP.PublishCatalogId,V.LocaleId,v.VersionId,
		ZPPP.[PublishProductId]  ZnodeProductId,
		ZPPP.[PublishCatalogId] ZnodeCatalogId,
		ZPP.PublishProductId  AssociatedZnodeProductId,
		ZPAOP.DisplayOrder DisplayOrder,
		ZPOPD.DisplayOrder AssociatedProductDisplayOrder,
		RequiredType ,
		DisplayType, 
		ISNULL((select ''+AddonGroupName for xml path('')),'') GroupName,
		ISnull(IsDefault,0) IsDefault
		INTO #AddonProductPublishedXML
		FROM [ZnodePimAddOnProductDetail] AS ZPOPD
		INNER JOIN [ZnodePimAddOnProduct] AS ZPAOP ON ZPOPD.[PimAddOnProductId] = ZPAOP.[PimAddOnProductId]
		INNER JOIN #TBL_PublishCatalogId ZPPP ON (ZPPP.PimProductId = ZPAOP.PimProductId )
		INNER JOIN #TBL_PublishCatalogId ZPP ON(ZPP.PimProductId = ZPOPD.[PimChildProductId] AND ZPP.PublishCatalogId = ZPPP.PublishCatalogId  )
		INNER JOIN #VesionIds V ON ZPPP.PublishCatalogId  = V.ZnodeCataLogId
		INNER JOIN @TBL_AddonGroupLocale TBAG ON (TBAG.PimAddonGroupId   = ZPAOP.PimAddonGroupId AND TBAG.LocaleId = V.LocaleId )
					
		If (isnull(@PublishCatalogId ,'') = '' and @VersionIdString = '') OR 
			(isnull(@PublishCatalogId ,'') = 0 and @VersionIdString = '')
		Begin 
			DELETE
			FROM ZnodePublishAddonEntity
			WHERE PublishAddonEntityId  IN (
											SELECT PublishAddonEntityId
											FROM ZnodePublishAddonEntity BP
											INNER JOIN #AddonProductPublishedXML A ON BP.ZnodeProductId =A.PublishProductId
												AND BP.ZnodeCatalogId = A.PublishCatalogId AND BP.VersionId = A.VersionId
											) 

			----Delete addon entries having parent data present but all addon removed
			DELETE ZPAE
			FROM ZnodePublishAddonEntity ZPAE
			WHERE EXISTS (SELECT * from [ZnodePimAddOnProduct] ZPAOP 
					INNER JOIN ZnodePublishProduct ZPPP ON (ZPPP.PimProductId = ZPAOP.PimProductId )
					WHERE ZPAE.ZnodeProductId = ZPPP.PublishProductId AND ZPAE.ZnodeCatalogId = ZPPP.PublishCatalogId)
			AND NOT EXISTS (SELECT * from [ZnodePimAddOnProductDetail] AS ZPOPD
					INNER JOIN [ZnodePimAddOnProduct] AS ZPAOP ON ZPOPD.[PimAddOnProductId] = ZPAOP.[PimAddOnProductId]
					INNER JOIN ZnodePublishProduct ZPPP ON (ZPPP.PimProductId = ZPOPD.PimChildProductId )
					WHERE ZPAE.AssociatedZnodeProductId = ZPPP.PublishProductId AND ZPAE.ZnodeCatalogId = ZPPP.PublishCatalogId)
		End 
					
		Insert into  ZnodePublishAddonEntity
		(VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,
			LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault)
		Select 
			VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,Isnull(AssociatedProductDisplayOrder,0),
			LocaleId,GroupName,DisplayType,DisplayOrder,1 IsRequired,RequiredType,IsDefault
		from #AddonProductPublishedXML
		
		SET @Status = 1;
            
    END TRY
    BEGIN CATCH
		SELECT ERROR_MESSAGE(),ERROR_PROCEDURE()
            
        SET @Status = 0;
        DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishAssociatedAddonsJson @PublishCatalogId = '+@PublishCatalogId+',@VersionId='+CAST(@VersionId AS VARCHAR(50))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
        SELECT 0 AS ID,
            CAST(0 AS BIT) AS Status;
        EXEC Znode_InsertProcedureErrorLog
            @ProcedureName = 'Znode_GetPublishAssociatedAddonsJson',
            @ErrorInProcedure = @Error_procedure,
            @ErrorMessage = @ErrorMessage,
            @ErrorLine = @ErrorLine,
            @ErrorCall = @ErrorCall;
    END CATCH;
END;	 	  	

GO

update ZnodeEmailTemplateLocale set Content = '<!DOCTYPE html><html><body><p></p>  <div>  <div style="font-family: Arial, Helvetica; font-size: 10px; text-align: left; color: #292a2a; border: solid 1px #c3c3c3; margin-top: 10px;">  <div style="background-color: #eff3fb; color: #292a2a; font-size: 1.5em; font-weight: bold; padding: .5em; border-bottom: solid 1px #c3c3c3;">#StoreLogo# #SiteName# Customer Receipt</div>  <div style="padding: 10px;">  <div style="font-family: Verdana; color: #333333; font-size: 11px;">#ReceiptText#</div>  <table style="font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" border="0" width="100%" cellspacing="3" cellpadding="0">  <tbody>  <tr>  <td colspan="5"><hr /></td>  </tr>  <tr>  <td colspan="2" align="left" nowrap="nowrap" width="25%">  <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Order Information</div>  </td>  <td colspan="2" align="left" nowrap="nowrap">  <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Customer Service</div>  </td>  </tr>  <tr>  <td align="left" nowrap="nowrap" width="10%"><strong>Order Number:</strong></td>  <td align="left" nowrap="nowrap" width="30%">#OrderId#</td>  <td align="left" nowrap="nowrap" width="4%"><strong>E-Mail:</strong></td>  <td align="left" nowrap="nowrap">#CustomerServiceEmail#</td>  </tr>  <tr>  <td align="left" nowrap="nowrap"><strong>Order Date:</strong></td>  <td align="left" nowrap="nowrap">#OrderDate#</td>  <td align="left" nowrap="nowrap"><strong>Phone:</strong></td>  <td align="left" nowrap="nowrap">#CustomerServicePhoneNumber#</td>  </tr>  <tr>  <td style="vertical-align: top;" align="left" nowrap="nowrap"><strong>Promotion Code:</strong></td>  <td align="left" nowrap="nowrap">#PromotionCode#</td>  <td></td>  <td></td>  </tr>  <tr>  <td align="left" nowrap="nowrap"><strong>Payment Method:</strong></td>  <td align="left" nowrap="nowrap">#PaymentName#</td>  <td></td>  <td></td>  </tr>  <tr>  <td align="left" nowrap="nowrap"><strong>#CardTransactionLabel#</strong></td>  <td align="left" nowrap="nowrap">#CardTransactionID#</td>  <td></td>  <td></td>  </tr>  <tr>  <td align="left" nowrap="nowrap" style="padding-right: 10px;"><strong>#PurchaseNumberLabel#</strong></td>  <td align="left" nowrap="nowrap">#PONumber#</td>  <td></td>  <td></td>  </tr>  <tr>  <td align="left" nowrap="nowrap"><strong>AccountNumber:</strong></td>  <td align="left" nowrap="nowrap">#AccountNumber#</td>  <td></td>  <td></td>  </tr>  <tr>  <td align="left" nowrap="nowrap"><strong>ShippingMethod:</strong></td>  <td align="left" nowrap="nowrap">#ShippingName#</td>  <td></td>  <td></td>  </tr>  <tr>  <td align="left" nowrap="nowrap"><strong>Job / Project Name:</strong></td>  <td align="left" nowrap="nowrap">#JobName#</td>  <td></td>  <td></td>  </tr>  <tr>  <td colspan="4"><hr /></td>  </tr>  <tr>  <td style="font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2" align="left" nowrap="nowrap" width="45%">  <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Billing Address</div>  </td>  <td colspan="2" align="left">  <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Shipping Address</div>  </td>  </tr>  <tr>  <td colspan="2" align="Left" nowrap="nowrap">#BillingAddress#</td>  <td colspan="3" valign="top">#ShippingAddress#</td>  </tr>  <tr>  <td align="Left" nowrap="nowrap" colspan="2"> </td>  <td valign="top" colspan="3"><hr /><span style="width: 130px; display: inline-block; font-weight: bold;">#LabelInHandDate#: </span>#InHandDate#<br /><span style="width: 130px; display: inline-block; font-weight: bold;">#LabelShippingConstraintsCode#: </span>#ShippingConstraintCode#<br /><br /></td>  </tr>  <tr>  <td colspan="7"></td>  </tr>  </tbody>  </table>  <div data-info="#AddressItems#">  <table width="100%" cellspacing="0" cellpadding="3">  <tbody>  <tr>  <td style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;" colspan="6">#ShipmentNo#</td>  </tr>  <tr>  <td style="color: black; font-size: 10px;" colspan="6">#ShipTo#</td>  </tr>  <tr style="background-color: #eff3fb;">  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>SKU</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Item</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Description</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" align="center"><strong>Qty</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Price</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="2"><strong>Total</strong></td>  </tr>  <tr data-info="#LineItems#OmsOrderShipmentID##">  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="10%">#SKU#</td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#Name#</td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#Description#  <p>#ShortDescription#</p>  #UOMDescription# <br /><br />#Column1#</td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="center" width="5%">#Quantity#</td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="20%">#Price#</td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%" colspan="2">#ExtendedPrice#</td>  </tr>  <tr data-info="#AmountLineItems#OmsOrderShipmentID##">  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="5" align="right"><strong>#Title#</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%" colspan="2">#Amount#</td>  </tr>  <tr data-info="#GrandAmountLineItems#">  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="5" align="right"><strong>#Title#</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%" colspan="2">#Amount#</td>  </tr>  <tr data-info="#TaxSummaryHead#">  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" colspan="5" align="right"><strong>#TaxName#</strong></td>  <td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" align="center" width="8%"><strong>#Rates#</strong></td>  <td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" align="right"><strong>#Amount#</strong></td>  </tr>  <tr data-info="#TaxSummary#">  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" colspan="5" align="right">#TaxName#</td>  <td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" align="center" width="8%">#Rates#</td>  <td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" align="right">#Amount#</td>  </tr>  <tr>  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #292a2a; font-size: 11px; padding: 0 5px 5px 5px;" colspan="5" align="right"><strong>Total</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%" colspan="2"><strong>#TotalCost#</strong></td>  </tr>  </tbody>  </table>  </div>  <table style="width: 100%; padding: 10px; display: inline-block;" cellspacing="0" cellpadding="3">  <tbody>  <tr>  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2" align="left" nowrap="nowrap">  <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">#AdditionalInstructLabel#</div>  </td>  </tr>  <tr>  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2">  <div style="width: 675px;" align="justify">#AdditionalInstructions#</div>  </td>  </tr>  <tr>  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2">  <div style="margin-bottom: 5px;"></div>  </td>  </tr>  <tr>  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2" align="left" nowrap="nowrap">#FeedBack#</td>  </tr>  </tbody>  </table>  </div>  </div>  </div></body></html>'
where EmailTemplateId = (select top 1 EmailTemplateId from ZnodeEmailTemplate where TemplateName='OrderReceipt')
and LocaleId = 1


GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetManageMessagelist')
	DROP PROC Znode_GetManageMessagelist
GO


Create procedure [dbo].[Znode_GetManageMessagelist]  
(    
  @WhereClause NVARCHAR(Max)       
 ,@Rows INT = 100       
 ,@PageNo INT = 1       
 ,@Order_BY VARCHAR(1000) = ''    
 ,@RowsCount INT OUT    
 ,@LocaleId INT =1    
)    
AS    
/*  
 Summary: Get Managed Message Details list for a PortalId  
 Unit Testing:  
 declare @p7 int  
 set @p7=NULL  
 exec sp_executesql N'Znode_GetManageMessagelist @WhereClause,@Rows,@PageNo,@Order_By,@RowCount OUT,@LocaleId',N'@WhereClause nvarchar(57),@Rows int,@PageNo int,@Order_By nvarchar(17),@RowCount int output,@LocaleId int',@WhereClause=N'localeid = 1 and (Po
rtalId in (''1'',''4'',''5'',''6'',''32'',''33''))',@Rows=50,@PageNo=1,@Order_By=N'PublishStatus asc',@RowCount=@p7 output,@LocaleId=1  
 select @p7   
  
 */  
BEGIN      
  BEGIN TRY     
    SET NOCOUNT ON        
    DECLARE @SQL NVARCHAR(MAX)    
        
 DECLARE @DefaultLocaleId VARCHAR(100)= dbo.Fn_GetDefaultLocaleId();  
    DECLARE @TBL_ManageMessage TABLE (CMSPortalMessageId INT,CMSMessageId INT,[Message] NVARCHAR(max),Location NVARCHAR(100),StoreName NVARCHAR(max)  
        ,LocaleId INT,PortalId INT,CMSMessageKeyId INT,MessageTag NVARCHAR(max),RowId INT,CountNo INT,PublishStatus NVARCHAR(max),IsGlobalContentBlock NVARCHAR(5))  
                
    SET @SQL = '   
     ;With Cte_ManageMessage AS   
     (  
     SELECT CMSPortalMessageId, CMSMessageId, [Message], Location,StoreName,LocaleId,PortalId,CMSMessageKeyId, MessageTag,  
     StateName as PublishStatus,IsGlobalContentBlock 
     FROM View_Getmanagemessagelist  
     WHERE  LocaleId IN ('+CAST(@LocaleId AS VARCHAR(50))+' , '+CAST(@DefaultLocaleId AS VARCHAR(50))+')   
     )  
  
     ,CTE_ManageMessageLocale As  
     (  
      SELECT CMSPortalMessageId, CMSMessageId, [Message], Location,StoreName,LocaleId,PortalId,CMSMessageKeyId  
      ,MessageTag,PublishStatus,IsGlobalContentBlock  
      FROM Cte_ManageMessage  
      WHERE LocaleId = '+CAST(@LocaleId AS VARCHAR(50))+'    
     )  
     ,CTE_ManageMessageBothLocale AS  
     (  
      SELECT CMSPortalMessageId, CMSMessageId, [Message], Location,StoreName,LocaleId,PortalId,CMSMessageKeyId, MessageTag,PublishStatus,IsGlobalContentBlock  
      FROM CTE_ManageMessageLocale  
      UNION ALL  
      SELECT CMSPortalMessageId, CMSMessageId, [Message], Location,StoreName,LocaleId,PortalId,CMSMessageKeyId, MessageTag,PublishStatus,IsGlobalContentBlock  
      FROM Cte_ManageMessage cmm  
      WHERE LocaleId = '+CAST(@DefaultLocaleId AS VARCHAR(50))+'   
      AND NOT EXISTS (SELECT TOP 1 1 FROM CTE_ManageMessageLocale CMML WHERE  CMML.CMSMessageKeyId = cmm.CMSMessageKeyId)  
     )  
  
     ,Cte_ManageMessageFilter AS   
     (  
      SELECT CMSPortalMessageId, CMSMessageId, [Message], Location,StoreName,LocaleId,PortalId,CMSMessageKeyId  
      ,MessageTag,PublishStatus,IsGlobalContentBlock ,'+dbo.Fn_GetPagingRowId(@Order_BY,'CMSPortalMessageId DESC')+',Count(*)Over() CountNo   
      FROM CTE_ManageMessageBothLocale   
      WHERE 1=1 '+dbo.Fn_GetFilterWhereClause(@WhereClause)+'  
     )  
     
     SELECT CMSPortalMessageId, CMSMessageId, [Message], Location,StoreName,LocaleId,PortalId,CMSMessageKeyId, MessageTag,PublishStatus,IsGlobalContentBlock,RowId,CountNo   
     FROM Cte_ManageMessageFilter  
     '+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows)  
  
     print @sql  
  
  
     INSERT INTO @TBL_ManageMessage (CMSPortalMessageId,CMSMessageId,[Message],Location,StoreName,LocaleId,PortalId,CMSMessageKeyId,MessageTag,PublishStatus,IsGlobalContentBlock,RowId,CountNo)  
     EXEC (@SQL)  
     SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM @TBL_ManageMessage ),0)  
	
     SELECT CMSPortalMessageId,CMSMessageId,[Message],Location,LocaleId,CASE WHEN PortalID IS NULL THEN 'All Store' ELSE StoreName END AS StoreName,
	 PortalId,CMSMessageKeyId,MessageTag,PublishStatus,IsGlobalContentBlock  
     FROM @TBL_ManageMessage  
      
  
  
   END TRY       
   BEGIN CATCH          
          DECLARE @Status BIT ;  
       SET @Status = 0;  
       DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),   
    @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetManageMessagelist @WhereClause = '''+ISNULL(@WhereClause,'''''')+''',@Rows='+ISNULL(CAST(@Rows AS  
   VARCHAR(50)),'''''')+',@PageNo='+ISNULL(CAST(@PageNo AS VARCHAR(50)),'''')+',@Order_BY='''+ISNULL(@Order_BY,'''''')+''',@RowsCount='+ISNULL(CAST(@RowsCount AS VARCHAR(50)),'''')+',@LocaleId = '+ISNULL(CAST(@LocaleId AS VARCHAR(50)),'''');  
                    
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
      
             EXEC Znode_InsertProcedureErrorLog  
    @ProcedureName = 'Znode_GetManageMessagelist',  
    @ErrorInProcedure = 'Znode_GetManageMessagelist',  
    @ErrorMessage = @ErrorMessage,  
    @ErrorLine = @ErrorLine,  
    @ErrorCall = @ErrorCall;    
   END CATCH       
END

GO

IF EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME = 'ContainerKey' AND TABLE_NAME = 'ZnodeCMSContentContainer')
BEGIN
	ALTER TABLE ZnodeCMSContentContainer ALTER COLUMN ContainerKey NVARCHAR(100) NOT NULL
END

IF EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME = 'ContainerKey' AND TABLE_NAME = 'ZnodePublishContentContainerEntity')
BEGIN
	ALTER TABLE ZnodePublishContentContainerEntity ALTER COLUMN ContainerKey NVARCHAR(100) NOT NULL
END

IF EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME = 'ContainerKey' AND TABLE_NAME = 'ZnodePublishContentContainerVariantEntity')
BEGIN
	ALTER TABLE ZnodePublishContentContainerVariantEntity ALTER COLUMN ContainerKey NVARCHAR(100) NOT NULL
END

GO
IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetCMSContainerProfileVariantlist')
	DROP PROC Znode_GetCMSContainerProfileVariantlist
GO

CREATE PROCEDURE [dbo].[Znode_GetCMSContainerProfileVariantlist]
(
	@WhereClause NVARCHAR(MAX)
	,@ContainerKey NVARCHAR(MAX)
	,@Rows INT = 100   
	,@PageNo INT = 1   
	,@Order_BY VARCHAR(1000) = ''
	,@RowsCount INT OUT
)
AS
-- EXEC Znode_GetCMSContainerProfileVariantlist '','',0,0,'',0
BEGIN  
BEGIN TRY 
SET NOCOUNT ON
	DECLARE @SQL NVARCHAR(MAX)
	IF OBJECT_ID('tempdb..#TBL_ContentContainer') IS NOT NULL
		DROP TABLE #TBL_ContentContainer;

	IF OBJECT_ID('tempdb..#Cte_ContentContainerVarient') IS NOT NULL
		DROP TABLE #Cte_ContentContainerVarient;

	IF OBJECT_ID('tempdb..#Users') IS NOT NULL
		DROP TABLE #Users;

	CREATE TABLE #TBL_ContentContainer (CMSContainerProfileVariantId INT, ContainerKey NVARCHAR(MAX), PortalId INT, StoreName NVARCHAR(MAX), ProfileName NVARCHAR(200),CreatedByName VARCHAR(500), CreatedDate DATETIME, ModifiedByName VARCHAR(500),
		ModifiedDate DATETIME, IsDefaultVarient BIT,StoreCode VARCHAR(200),ProfileCode Varchar(200),RowId INT,CountNo INT,IsActive BIT,PublishStatus VARCHAR(32))  
	
	SELECT CAST(UserName AS NVARCHAR(500)) AS UserName , ZU.UserId
	INTO #Users
	FROM ZnodeUser ZU WITH (NOLOCK)
	WHERE EXISTS( SELECT * FROM ZnodeCMSContainerProfileVariant CWPV WHERE ZU.UserId = CWPV.CreatedBy )
	UNION
	SELECT UserName, ZU.UserId
	FROM ZnodeUser ZU
	WHERE EXISTS( SELECT * FROM ZnodeCMSContainerProfileVariant CWPV WHERE ZU.UserId = CWPV.ModifiedBy )

	SELECT DISTINCT WPV.CMSContainerProfileVariantId, ZCW.ContainerKey, WPV.PortalId, --ZCW.Tags,
		CASE WHEN WPV.PortalId IS NULL THEN  'Any Store' ELSE ZP.StoreName END StoreName  ,
		CASE WHEN WPV.ProfileId IS NULL THEN  'Any User Profile' ELSE ZPr.ProfileName END ProfileName, 
		U.UserName AS CreatedByName, WPV.CreatedDate, U1.UserName AS ModifiedByName, WPV.ModifiedDate,
		CAST(CASE WHEN WPV.ProfileId IS NULL AND WPV.PortalId IS NULL THEN 1 ELSE 0 END AS BIT) AS IsDefaultVarient,
		CASE WHEN WPV.PortalId IS NULL THEN  'AnyStore' ELSE ZP.StoreCode END StoreCode ,
		CASE WHEN WPV.ProfileId IS NULL THEN  'AnyUserProfile' ELSE ZPr.DefaultExternalAccountNo END ProfileCode,
		CPVL.IsActive As Status,ZPS.DisplayName As PublishStatus
	INTO #Cte_ContentContainerVarient
	FROM ZnodeCMSContentContainer ZCW 
	INNER JOIN ZnodeCMSContainerProfileVariant WPV ON WPV.CMSContentContainerId = ZCW.CMSContentContainerId
	LEFT JOIN ZnodeCMSContainerProfileVariantLocale CPVL ON WPV.CMSContainerProfileVariantId=CPVL.CMSContainerProfileVariantId
	LEFT JOIN ZnodePublishState ZPS ON WPV.PublishStateId=ZPS.PublishStateId
	LEFT JOIN ZnodePortal ZP ON (WPV.PortalId = ZP.PortalId ) 
	LEFT JOIN ZnodeProfile ZPr ON WPV.ProfileId = ZPr.ProfileId
	LEFT JOIN #Users U ON WPV.CreatedBy = U.UserId
	LEFT JOIN #Users U1 ON WPV.ModifiedBy = U1.UserId
	WHERE ZCW.ContainerKey = @ContainerKey 

	SET @SQL = '   
	;With Cte_ContentContainerVarientList AS
	(
		SELECT CMSContainerProfileVariantId, ContainerKey, PortalId, StoreName, ProfileName,CreatedByName, CreatedDate, ModifiedByName, ModifiedDate, IsDefaultVarient,StoreCode,ProfileCode,
		'+dbo.Fn_GetPagingRowId(@Order_BY,'IsDefaultVarient ASC,CMSContainerProfileVariantId DESC')+',Count(*)Over() CountNo,Status,PublishStatus
		FROM #Cte_ContentContainerVarient
		WHERE 1=1 '+dbo.Fn_GetFilterWhereClause(@WhereClause)+'
	)
	INSERT INTO #TBL_ContentContainer 
	SELECT * 
	FROM Cte_ContentContainerVarientList

	SELECT CMSContainerProfileVariantId as ContainerProfileVariantId, ContainerKey, PortalId, StoreName, ProfileName,CreatedByName, CreatedDate, ModifiedByName, ModifiedDate, IsDefaultVarient ,StoreCode,ProfileCode,IsActive,PublishStatus
	FROM #TBL_ContentContainer   
	'+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows) +'
	 ORDER BY RowId'

	EXEC (@SQL)
	SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM #TBL_ContentContainer ),0)  

END TRY
BEGIN CATCH
	DECLARE @Status BIT ;
	SET @Status = 0;
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= 
	ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 
	'EXEC Znode_GetCMSContainerProfileVariantlist @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',
	@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',
	@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));

	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;   

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_GetCMSContainerProfileVariantlist',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
END CATCH; 
END;

GO
IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateOmsOrder')
	DROP PROC Znode_InsertUpdateOmsOrder
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateOmsOrder]
(
	@OrderXML XML,
	@UserId INT
)
AS
BEGIN
SET NOCOUNT ON;
BEGIN TRY

	DECLARE @GetDate DATETIME = GETDATE()
	DECLARE @OMSOrder TABLE(OmsOrderId INT,OrderNumber VARCHAR(200))
	DECLARE @OMSOrderDetail TABLE(OmsOrderId INT,OmsOrderDetailsId INT)
	DECLARE @OmsOrderLineItems TABLE(RowId INT IDENTITY(1,1),OmsOrderDetailsId INT,OmsOrderLineItemsId INT, Sku VARCHAR(600), ParentOmsOrderLineItemsId INT, GroupId NVARCHAR(MAX),OrderLineItemRelationshipTypeId INT,ParentSku VARCHAR(600), GroupIdentifier INT)
	DECLARE @OmsParentOrderLineItems TABLE(RowId INT IDENTITY(1,1),OmsOrderDetailsId INT,OmsOrderLineItemsId INT, Sku VARCHAR(600), ParentOmsOrderLineItemsId INT, GroupId NVARCHAR(MAX), OrderLineItemRelationshipTypeId INT, GroupIdentifier INT)

	DECLARE @OrderLineItemRelationshipTypeIdAddon int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'AddOns'
	);

	DECLARE @OrderLineItemRelationshipTypeIdSimple int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Simple'
	);

	DECLARE @OrderLineItemRelationshipTypeIdBundles int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Bundles'
	);

	DECLARE @OrderLineItemRelationshipTypeIdGroup int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Group'
	);

	DECLARE @OrderLineItemRelationshipTypeIdConfig int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Configurable'
	);


	CREATE TABLE #TempOrderData
	(
		RowId INT IDENTITY(1,1),OrderNumber VARCHAR(200), PublishStateId INT,OmsOrderId INT,OmsOrderStateId INT,
		DiscountAmount NUMERIC(28,6),SalesTax NUMERIC(28,6),TaxRate NUMERIC(28,6),IsOldOrder BIT,VAT NUMERIC(28,6),GST NUMERIC(28,6),
		PST NUMERIC(28,6),HST NUMERIC(28,6),Total NUMERIC(28,6),BillingAddressId INT,ShippingAddressId INT,ShippingId INT,
		PortalId INT,ShippingNumber NVARCHAR(max),TrackingNumber NVARCHAR(1000),CouponCode NVARCHAR(1000),
		PromoDescription NVARCHAR(max),ReferralUserId int,PurchaseOrderNumber NVARCHAR(1000),OmsPaymentStateId int,
		WebServiceDownloadDate datetime,PaymentSettingId int,PaymentTransactionToken NVARCHAR(600),ShipDate datetime,ReturnDate datetime,
		AddressId int,PoDocument NVARCHAR(600),IsActive bit,ExternalId NVARCHAR(1000),PaymentTypeId INT,CreatedBy INT,CreatedDate datetime,ModifiedBy INT,
		ModifiedDate datetime,CreditCardNumber VARCHAR(4),IsShippingCostEdited bit,IsTaxCostEdited bit,ShippingDifference NUMERIC(28,6),
		EstimateShippingCost NUMERIC(28,6),TransactionId NVARCHAR(800),Custom1 NVARCHAR(MAX),Custom2 NVARCHAR(MAX),Custom3 NVARCHAR(MAX),
		Custom4 NVARCHAR(MAX),Custom5 NVARCHAR(MAX),FirstName NVARCHAR(200),LastName NVARCHAR(200),CardType VARCHAR(50),CreditCardExpMonth INT,
		CreditCardExpYear INT,TotalAdditionalCost NUMERIC(28,6),PaymentDisplayName NVARCHAR(2000),PaymentExternalId NVARCHAR(2000),
		CultureCode VARCHAR(200),DisplayName NVARCHAR(2000),InHandDate datetime,IpAddress VARCHAR(100),JobName NVARCHAR(200),
		ShippingConstraintCode NVARCHAR(100),ShippingDiscount NUMERIC(28,6),ShippingHandlingCharges NUMERIC(28,6),ReturnCharges NUMERIC(28,6),
		IsCalculateTaxAfterDiscount bit,Email VARCHAR(50),PhoneNumber VARCHAR(50),OrderTotalWithoutVoucher NUMERIC(28,6),ImportDuty NUMERIC(28,6),
		TaxCost NUMERIC(28,6),ShippingCost NUMERIC(28,6), SubTotal NUMERIC(28,6),CurrencyCode VARCHAR(100),OverDueAmount NUMERIC(28,6), ShippingTypeId INT,
		AccountNumber NVARCHAR(4000),ShippingMethod NVARCHAR(4000),PaymentCode NVARCHAR(400) ,PaymentStatusId Int
	)

	CREATE TABLE #TempOrderBillingAddress
	(
		AddressId INT,BillingFirstName VARCHAR(300),BillingLastName VARCHAR(300),BillingCountry VARCHAR(3000),BillingStateCode VARCHAR(300),
		BillingPostalCode VARCHAR(50),BillingPhoneNumber VARCHAR(50),BillingEmailId VARCHAR(50),BillingStreet1 VARCHAR(300),BillingStreet2 VARCHAR(300),
		BillingCity VARCHAR(3000),BillingCompanyName NVARCHAR(1200)
	)
	
	CREATE TABLE #TempParentLineItemDetails
	(
		RowId INT IDENTITY(1,1),OrderLineItemRelationshipTypeId INT,OmsOrderDetailsId INT,OmsOrderShipmentId INT,RmaReasonForReturnId INT,Sku NVARCHAR(600),ProductName NVARCHAR(1000),
		Description NVARCHAR(max),Quantity NUMERIC(28,6),Price NUMERIC(28,6),Weight NUMERIC(28,6),DownloadLink NVARCHAR(max),DiscountAmount NUMERIC(28,6),
		ShipSeparately bit,ShipDate datetime,ReturnDate datetime,ShippingCost NUMERIC(28,6),PromoDescription NVARCHAR(max),TransactionNumber NVARCHAR(max),
		PaymentStatusId int,TrackingNumber NVARCHAR(max),IsAutoGeneratedTracking bit,OrderLineItemStateId int,IsRecurringBilling bit,RecurringBillingPeriod NVARCHAR(100),
		RecurringBillingCycles int,RecurringBillingFrequency NVARCHAR(100),RecurringBillingAmount NUMERIC(28,6),AppliedPromo NVARCHAR(max),CouponsApplied NVARCHAR(100),
		ExternalId NVARCHAR(1000),IsActive bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,AutoAddonSKU NVARCHAR(max),IsShippingReturn bit,
		PartialRefundAmount NUMERIC(28,6),Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),Custom4 NVARCHAR(max),Custom5 NVARCHAR(max),
		GroupId NVARCHAR(max),BundleQuantity int, TaxRuleId INT,TaxTransactionNumber NVARCHAR(1200),Comments NVARCHAR(MAX),SalesTax NUMERIC(28,6),VAT NUMERIC(28,6),
		GST NUMERIC(28,6),PST NUMERIC(28,6),HST NUMERIC(28,6),ImportDuty NUMERIC(28,6), GroupIdentifier INT
	)

	CREATE TABLE #TempChildLineItemDetails
	(
		RowId INT IDENTITY(1,1),OrderLineItemRelationshipTypeId INT,OmsOrderDetailsId INT,OmsOrderShipmentId INT,RmaReasonForReturnId INT,Sku NVARCHAR(600),ProductName NVARCHAR(1000),
		Description NVARCHAR(max),Quantity NUMERIC(28,6),Price NUMERIC(28,6),Weight NUMERIC(28,6),DownloadLink NVARCHAR(max),DiscountAmount NUMERIC(28,6),
		ShipSeparately bit,ShipDate datetime,ReturnDate datetime,ShippingCost NUMERIC(28,6),PromoDescription NVARCHAR(max),TransactionNumber NVARCHAR(max),
		PaymentStatusId int,TrackingNumber NVARCHAR(max),IsAutoGeneratedTracking bit,OrderLineItemStateId int,IsRecurringBilling bit,RecurringBillingPeriod NVARCHAR(100),
		RecurringBillingCycles int,RecurringBillingFrequency NVARCHAR(100),RecurringBillingAmount NUMERIC(28,6),AppliedPromo NVARCHAR(max),CouponsApplied NVARCHAR(100),
		ExternalId NVARCHAR(1000),IsActive bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,AutoAddonSKU NVARCHAR(max),IsShippingReturn bit,
		PartialRefundAmount NUMERIC(28,6),Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),Custom4 NVARCHAR(max),Custom5 NVARCHAR(max),
		GroupId NVARCHAR(max),BundleQuantity int, TaxRuleId INT,TaxTransactionNumber NVARCHAR(1200),Comments NVARCHAR(MAX),SalesTax NUMERIC(28,6),VAT NUMERIC(28,6),
		GST NUMERIC(28,6),PST NUMERIC(28,6),HST NUMERIC(28,6),ImportDuty NUMERIC(28,6), ParentSku NVARCHAR(600), GroupIdentifier INT
	)

	CREATE TABLE #TempOrderAttribute
	(
		AttributeCode NVARCHAR(1000),AttributeValue NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,
		ModifiedDate DATETIME,AttributeValueCode NVARCHAR(1000), Sku VARCHAR(600), GroupId NVARCHAR(max), GroupIdentifier INT
	)

	CREATE TABLE #OmsPersonalizeItem
	(
		PersonalizeCode NVARCHAR(400),PersonalizeValue NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,
		ModifiedDate DATETIME,DesignId NVARCHAR(4000),ThumbnailURL NVARCHAR(MAX), Sku VARCHAR(600), GroupId NVARCHAR(max),
		GroupIdentifier INT
	)

	CREATE TABLE #OmsOrderDiscount
	(
		OmsDiscountTypeId INT,DiscountCode VARCHAR(300),DiscountAmount NUMERIC(28,6),Description NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,
		ModifiedBy INT,ModifiedDate DATETIME,PerQuantityDiscount NUMERIC(28,6),DiscountMultiplier NUMERIC(28,6),ParentOmsOrderLineItemsId INT,
		DiscountLevelTypeId INT,PromotionName NVARCHAR(1200),PromotionTypeId INT,DiscountAppliedSequence INT,PromotionMessage NVARCHAR(MAX),Sku VARCHAR(600),
		GroupId NVARCHAR(max)
	)

	--------Getting Order details
	INSERT INTO #TempOrderData
	(
		OrderNumber, PublishStateId ,OmsOrderId ,OmsOrderStateId ,DiscountAmount ,SalesTax ,TaxRate ,IsOldOrder ,
		VAT ,GST ,PST ,HST ,Total ,BillingAddressId ,ShippingAddressId ,ShippingId ,PortalId,
		ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
		,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive
		,ExternalId,PaymentTypeId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
		,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName
		,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
		,DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
		,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty,TaxCost,ShippingCost, SubTotal,
		CurrencyCode,OverDueAmount, ShippingTypeId, AccountNumber, ShippingMethod, PaymentCode, PaymentStatusId
	)
	SELECT
		CASE WHEN Tbl.Col.value( 'OrderNumber[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderNumber[1]', 'NVARCHAR(Max)' ) END  AS OrderNumber,
		CASE WHEN Tbl.Col.value( 'PublishStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PublishStateId[1]', 'NVARCHAR(Max)' ) END AS PublishStateId,
		CASE WHEN Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderId,
		CASE WHEN Tbl.Col.value( 'OmsOrderStateId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderStateId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderStateId,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE  Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
		CASE WHEN Tbl.Col.value( 'TaxRate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TaxRate[1]', 'NVARCHAR(Max)' ) END AS TaxRate,
		CASE WHEN Tbl.Col.value('IsOldOrder[1]', 'NVARCHAR(2000)') = '' THEN NULL ELSE Tbl.Col.value('IsOldOrder[1]', 'NVARCHAR(2000)') END AS IsOldOrder,
		CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE  Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
		CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
		CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END  AS PST,
		CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END AS HST,
		CASE WHEN Tbl.Col.value( 'Total[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Total[1]', 'NVARCHAR(Max)' ) END AS Total,
		CASE WHEN Tbl.Col.value( 'BillingAddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'BillingAddressId[1]', 'NVARCHAR(Max)' ) END AS BillingAddressId,
		CASE WHEN Tbl.Col.value( 'ShippingAddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingAddressId[1]', 'NVARCHAR(Max)' ) END AS ShippingAddressId,
		CASE WHEN (Tbl.Col.value( 'ShippingId[1]', 'NVARCHAR(Max)' )) = '' THEN NULL ELSE (Tbl.Col.value( 'ShippingId[1]', 'NVARCHAR(Max)' )) END  AS ShippingId,
		CASE WHEN Tbl.Col.value( 'PortalId[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'PortalId[1]', 'NVARCHAR(Max)' ) END AS PortalId,
		Tbl.Col.value( 'ShippingNumber[1]', 'NVARCHAR(Max)' ) AS ShippingNumber,
		Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
		Tbl.Col.value( 'CouponCode[1]', 'NVARCHAR(Max)' ) AS CouponCode,
		Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
		CASE WHEN Tbl.Col.value( 'ReferralUserId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReferralUserId[1]', 'NVARCHAR(Max)' ) END  AS ReferralUserId,
		Tbl.Col.value( 'PurchaseOrderNumber[1]', 'NVARCHAR(Max)' ) AS PurchaseOrderNumber,
		CASE WHEN Tbl.Col.value( 'OmsPaymentStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsPaymentStateId[1]', 'NVARCHAR(Max)' ) END AS OmsPaymentStateId,
		Tbl.Col.value( 'WebServiceDownloadDate[1]', 'NVARCHAR(Max)' ) AS WebServiceDownloadDate,
		CASE WHEN Tbl.Col.value( 'PaymentSettingId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentSettingId[1]', 'NVARCHAR(Max)' ) END AS PaymentSettingId,
		Tbl.Col.value( 'PaymentTransactionToken[1]', 'NVARCHAR(Max)' ) AS PaymentTransactionToken,
		CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE @GetDate END AS ShipDate,
		CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
		CASE WHEN Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) END AS AddressId,
		Tbl.Col.value( 'PoDocument[1]', 'NVARCHAR(Max)' ) AS PoDocument,
		CASE WHEN Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) END  AS IsActive,
		Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
		CASE WHEN Tbl.Col.value( 'PaymentTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentTypeId[1]', 'NVARCHAR(Max)' ) END  AS PaymentTypeId,
		@UserId AS CreatedBy,
		@GetDate AS CreatedDate,
		@UserId AS ModifiedBy,
		@GetDate AS ModifiedDate,
		Tbl.Col.value( 'CreditCardNumber[1]', 'NVARCHAR(Max)' ) AS CreditCardNumber,
		CASE WHEN Tbl.Col.value( 'IsShippingCostEdited[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsShippingCostEdited[1]', 'NVARCHAR(Max)' ) END AS IsShippingCostEdited,
		CASE WHEN Tbl.Col.value( 'IsTaxCostEdited[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsTaxCostEdited[1]', 'NVARCHAR(Max)' ) END AS IsTaxCostEdited,
		Tbl.Col.value( 'ShippingDifference[1]', 'NVARCHAR(Max)' ) AS ShippingDifference,
		CASE WHEN Tbl.Col.value( 'EstimateShippingCost[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'EstimateShippingCost[1]', 'NVARCHAR(Max)' ) END AS EstimateShippingCost,
		Tbl.Col.value( 'TransactionId[1]', 'NVARCHAR(Max)' ) AS TransactionId,
		Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
		Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
		Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
		Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
		Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
		Tbl.Col.value( 'FirstName[1]', 'NVARCHAR(Max)' ) AS FirstName,
		Tbl.Col.value( 'LastName[1]', 'NVARCHAR(Max)' ) AS LastName,
		Tbl.Col.value( 'CardType[1]', 'NVARCHAR(Max)' ) AS CardType,
		Tbl.Col.value( 'CreditCardExpMonth[1]', 'NVARCHAR(Max)' ) AS CreditCardExpMonth,
		Tbl.Col.value( 'CreditCardExpYear[1]', 'NVARCHAR(Max)' ) AS CreditCardExpYear,
		CASE WHEN Tbl.Col.value( 'TotalAdditionalCost[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TotalAdditionalCost[1]', 'NVARCHAR(Max)' ) END AS TotalAdditionalCost,
		Tbl.Col.value( 'PaymentDisplayName[1]', 'NVARCHAR(Max)' ) AS PaymentDisplayName,
		Tbl.Col.value( 'PaymentExternalId[1]', 'NVARCHAR(Max)' ) AS PaymentExternalId,
		Tbl.Col.value( 'CultureCode[1]', 'NVARCHAR(Max)' ) AS CultureCode,
		Tbl.Col.value( 'DisplayName[1]', 'NVARCHAR(Max)' ) AS DisplayName,
		Tbl.Col.value( 'InHandDate[1]', 'NVARCHAR(Max)' ) AS InHandDate,
		Tbl.Col.value( 'IpAddress[1]', 'NVARCHAR(Max)' ) AS IpAddress,
		Tbl.Col.value( 'JobName[1]', 'NVARCHAR(Max)' ) AS JobName,
		Tbl.Col.value( 'ShippingConstraintCode[1]', 'NVARCHAR(Max)' ) AS ShippingConstraintCode,
		Tbl.Col.value( 'ShippingDiscount[1]', 'NVARCHAR(Max)' ) AS ShippingDiscount,
		Tbl.Col.value( 'ShippingHandlingCharges[1]', 'NVARCHAR(Max)' ) AS ShippingHandlingCharges,
		CASE WHEN Tbl.Col.value( 'ReturnCharges[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'ReturnCharges[1]', 'NVARCHAR(Max)' ) END AS ReturnCharges,
		CASE WHEN Tbl.Col.value( 'IsCalculateTaxAfterDiscount[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsCalculateTaxAfterDiscount[1]', 'NVARCHAR(Max)' ) END AS IsCalculateTaxAfterDiscount,
		Tbl.Col.value( 'Email[1]', 'NVARCHAR(Max)' ) AS Email,
		Tbl.Col.value( 'PhoneNumber[1]', 'NVARCHAR(Max)' ) AS PhoneNumber,
		CASE WHEN Tbl.Col.value( 'OrderTotalWithoutVoucher[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OrderTotalWithoutVoucher[1]', 'NVARCHAR(Max)' )  END AS OrderTotalWithoutVoucher,
		CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )='' THEN '' ELSE Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
		CASE WHEN Tbl.Col.value( 'TaxCost[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'TaxCost[1]', 'NVARCHAR(Max)' ) END  AS TaxCost,
		CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
		CASE WHEN Tbl.Col.value( 'SubTotal[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'SubTotal[1]', 'NVARCHAR(Max)' ) END AS SubTotal,
		Tbl.Col.value( 'CurrencyCode[1]', 'NVARCHAR(Max)' ) AS CurrencyCode,
		CASE WHEN Tbl.Col.value( 'OverDueAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OverDueAmount[1]', 'NVARCHAR(Max)' ) END AS OverDueAmount,
		CASE WHEN Tbl.Col.value( 'ShippingTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingTypeId[1]', 'NVARCHAR(Max)' ) END AS ShippingTypeId,
		Tbl.Col.value( 'AccountNumber[1]', 'NVARCHAR(Max)' ) AS AccountNumber,
		Tbl.Col.value( 'ShippingMethod[1]', 'NVARCHAR(Max)' ) AS ShippingMethod,
		Tbl.Col.value( 'PaymentCode[1]', 'NVARCHAR(Max)' ) AS PaymentCode,
		CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId
	FROM @OrderXML.nodes( '//PlaceOrderModel' ) AS Tbl(Col);


	--Getting billing address info
	INSERT INTO #TempOrderBillingAddress
	(
		AddressId,BillingFirstName,BillingLastName,BillingCompanyName,BillingStreet1,BillingStreet2,
		BillingCity,BillingStateCode,BillingPostalCode,BillingCountry,BillingPhoneNumber,BillingEmailId
	)
	SELECT
		Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) AS AddressId,
		Tbl.Col.value( 'FirstName[1]', 'NVARCHAR(Max)' ) AS FirstName,
		Tbl.Col.value( 'LastName[1]', 'NVARCHAR(Max)' ) AS LastName,
		Tbl.Col.value( 'CompanyName[1]', 'NVARCHAR(Max)' ) AS CompanyName,
		Tbl.Col.value( 'Street1[1]', 'NVARCHAR(Max)' ) AS Street1 ,
		Tbl.Col.value( 'Street2[1]', 'NVARCHAR(Max)' ) AS Street2,
		Tbl.Col.value( 'City[1]', 'NVARCHAR(Max)' ) AS City,
		Tbl.Col.value( 'StateCode[1]', 'NVARCHAR(Max)' ) AS StateCode,
		Tbl.Col.value( 'PostalCode[1]', 'NVARCHAR(Max)' ) AS PostalCode,
		Tbl.Col.value( 'Country[1]', 'NVARCHAR(Max)' ) AS Country,
		Tbl.Col.value( 'PhoneNumber[1]', 'NVARCHAR(Max)' ) AS PhoneNumber,
		Tbl.Col.value( 'EmailId[1]', 'NVARCHAR(Max)' ) AS EmailId
	FROM @OrderXML.nodes( '//PlaceOrderModel/BillingAddressModel' ) AS Tbl(Col);
	----Parent line item details insert
	INSERT INTO #TempParentLineItemDetails
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description,Quantity,
		Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber,
		PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles,
		RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy,
		ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity,
		TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty, GroupIdentifier
	)
	SELECT
		CASE WHEN Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemRelationshipTypeId,
		CASE WHEN Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) END  AS OmsOrderDetailsId,
		CASE WHEN Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderShipmentId,
		CASE WHEN Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) END AS RmaReasonForReturnId,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(2000)' ) AS ProductName,
		Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
		Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(Max)' ) AS Quantity,
		CASE WHEN Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) END AS Price,
		Tbl.Col.value( 'Weight[1]', 'NVARCHAR(Max)' ) AS Weight,
		Tbl.Col.value( 'DownloadLink[1]', 'NVARCHAR(Max)' ) AS DownloadLink,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		Tbl.Col.value( 'ShipSeparately[1]', 'NVARCHAR(Max)' ) AS ShipSeparately,
		CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE @GetDate END AS ShipDate,
		CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
		CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
		Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
		Tbl.Col.value( 'TransactionNumber[1]', 'NVARCHAR(Max)' ) AS TransactionNumber,
		CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId,
		Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
		CASE WHEN Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) END AS IsAutoGeneratedTracking,
		CASE WHEN Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemStateId,
		CASE WHEN Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) END AS IsRecurringBilling,
		Tbl.Col.value( 'RecurringBillingPeriod[1]', 'NVARCHAR(Max)' ) AS RecurringBillingPeriod,
		Tbl.Col.value( 'RecurringBillingCycles[1]', 'NVARCHAR(Max)' ) AS RecurringBillingCycles,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingFrequency,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingAmount,
		Tbl.Col.value( 'AppliedPromo[1]', 'NVARCHAR(Max)' ) AS AppliedPromo,
		Tbl.Col.value( 'CouponsApplied[1]', 'NVARCHAR(Max)' ) AS CouponsApplied,
		Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
		CASE WHEN Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) END AS IsActive,
		@UserId AS CreatedBy,
		@GetDate AS CreatedDate,
		@UserId AS ModifiedBy,
		@GetDate AS ModifiedDate,
		Tbl.Col.value( 'AutoAddonSKU[1]', 'NVARCHAR(Max)' ) AutoAddonSKU,
		CASE WHEN Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) END IsShippingReturn,
		CASE WHEN Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) END PartialRefundAmount,
		Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
		Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
		Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
		Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
		Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
		CASE WHEN Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) = ''  THEN NULL ELSE Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) END AS BundleQuantity,
		CASE WHEN Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) END AS TaxRuleId,
		Tbl.Col.value( 'TaxTransactionNumber[1]', 'NVARCHAR(Max)' ) AS TaxTransactionNumber,
		Tbl.Col.value( 'Comments[1]', 'NVARCHAR(Max)' ) AS Comments,
		CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
		CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
		CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
		CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END AS PST,
		CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END  AS HST,
		CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(Max)' ) AS GroupIdentifier
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel' ) AS Tbl(Col);

	----Child line item details insert
	INSERT INTO #TempChildLineItemDetails
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description,Quantity,
		Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber,
		PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles,
		RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy,
		ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity,
		TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty, ParentSku, GroupIdentifier
	)
	SELECT
		CASE WHEN Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemRelationshipTypeId,
		CASE WHEN Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderDetailsId,
		CASE WHEN Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderShipmentId,
		CASE WHEN Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) END AS RmaReasonForReturnId,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(2000)' ) AS ProductName,
		Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
		Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(Max)' ) AS Quantity,
		CASE WHEN Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) END AS Price,
		Tbl.Col.value( 'Weight[1]', 'NVARCHAR(Max)' ) AS Weight,
		Tbl.Col.value( 'DownloadLink[1]', 'NVARCHAR(Max)' ) AS DownloadLink,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		Tbl.Col.value( 'ShipSeparately[1]', 'NVARCHAR(Max)' ) AS ShipSeparately,
		CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE @GetDate END AS ShipDate,
		CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
		CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
		Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
		Tbl.Col.value( 'TransactionNumber[1]', 'NVARCHAR(Max)' ) AS TransactionNumber,
		CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId,
		Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
		CASE WHEN Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) END AS IsAutoGeneratedTracking,
		CASE WHEN Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemStateId,
		CASE WHEN Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) END AS IsRecurringBilling,
		Tbl.Col.value( 'RecurringBillingPeriod[1]', 'NVARCHAR(Max)' ) AS RecurringBillingPeriod,
		Tbl.Col.value( 'RecurringBillingCycles[1]', 'NVARCHAR(Max)' ) AS RecurringBillingCycles,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingFrequency,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingAmount,
		Tbl.Col.value( 'AppliedPromo[1]', 'NVARCHAR(Max)' ) AS AppliedPromo,
		Tbl.Col.value( 'CouponsApplied[1]', 'NVARCHAR(Max)' ) AS CouponsApplied,
		Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
		Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) AS IsActive,
		@UserId AS CreatedBy,
		@GetDate AS CreatedDate,
		@UserId AS ModifiedBy,
		@GetDate AS ModifiedDate,
		Tbl.Col.value( 'AutoAddonSKU[1]', 'NVARCHAR(Max)' ) AutoAddonSKU,
		CASE WHEN Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) END AS IsShippingReturn,
		CASE WHEN Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) END AS  PartialRefundAmount,
		Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
		Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
		Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
		Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
		Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
		CASE WHEN Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) END AS BundleQuantity,
		CASE WHEN Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) END AS TaxRuleId,
		Tbl.Col.value( 'TaxTransactionNumber[1]', 'NVARCHAR(Max)' ) AS TaxTransactionNumber,
		Tbl.Col.value( 'Comments[1]', 'NVARCHAR(Max)' ) AS Comments,
		CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
		CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
		CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
		CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END AS PST,
		CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END AS HST,
		CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE  Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
		Tbl.Col.value( 'ParentProductSKU[1]', 'NVARCHAR(Max)' ) AS ParentSku,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(Max)' ) AS GroupIdentifier
	FROM @OrderXML.nodes('//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/OrderLineItem/PlaceOrderlineItemCollection') AS Tbl(Col);

	--Updating parent for simple products
	UPDATE #TempChildLineItemDetails SET ParentSku = Sku WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdSimple
	AND OrderLineItemRelationshipTypeId IS NOT NULL

BEGIN TRAN OrderInsert

	--Inserting order number which are unique and getting in xml from code side
	INSERT INTO ZnodeOmsOrder(IsQuoteOrder,OrderNumber,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PublishStateId,IsOldOrder)
	OUTPUT INSERTED.OmsOrderId, INSERTED.OrderNumber INTO @OMSOrder
	SELECT 0 AS IsQuoteOrder, OrderNumber,OrderNumber AS ExternalId,@UserId,@GetDate,@UserId,@GetDate,PublishStateId, IsOldOrder
	FROM #TempOrderData
	WHERE ISNULL(OmsOrderId,0) = 0

	--If order is new then creating new order details
	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		INSERT INTO ZnodeOmsOrderDetails
		(
			OmsOrderId,PortalId,UserId,OrderDate,OmsOrderStateId,ShippingId,PaymentTypeId,BillingFirstName,BillingLastName
			,BillingCompanyName,BillingStreet1,BillingStreet2,BillingCity,BillingStateCode,BillingPostalCode,BillingCountry
			,BillingPhoneNumber,BillingEmailId,TaxCost,ShippingCost,SubTotal,DiscountAmount,CurrencyCode,OverDueAmount,Total
			,ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive
			,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
			,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
			,DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
			,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty
		)
		OUTPUT INSERTED.OmsOrderId, INSERTED.OmsOrderDetailsId INTO @OMSOrderDetail
		SELECT OO.OmsOrderId, OD.PortalId,@UserId,@GetDate,OD.OmsOrderStateId,OD.ShippingId,OD.PaymentTypeId,OBA.BillingFirstName,OBA.BillingLastName,OBA.BillingCompanyName,
			OBA.BillingStreet1,OBA.BillingStreet2,OBA.BillingCity,OBA.BillingStateCode,OBA.BillingPostalCode,OBA.BillingCountry,OBA.BillingPhoneNumber,OBA.BillingEmailId,OD.TaxCost,
			OD.ShippingCost,OD.SubTotal, OD.DiscountAmount,OD.CurrencyCode,OD.OverDueAmount,OD.Total
			,OD.ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,OD.BillingAddressId,PoDocument,CAST(1 AS BIT) AS IsActive
			,OD.ExternalId,OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
			,ShippingDifference,EstimateShippingCost,TransactionId,OD.Custom1,OD.Custom2,OD.Custom3,OD.Custom4,OD.Custom5,OD.FirstName,OD.LastName
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
			,OD.DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
			,IsCalculateTaxAfterDiscount,Email,OD.PhoneNumber,OrderTotalWithoutVoucher,ImportDuty
		FROM #TempOrderData OD
		INNER JOIN @OMSOrder OO ON OD.OrderNumber = OO.OrderNumber
		LEFT JOIN #TempOrderBillingAddress OBA ON OD.BillingAddressId = OBA.AddressId

	END
	--If order managed then creating new order details and disable old order details
	ELSE
	BEGIN
		Declare @OldOmsOrderDetailsId INT
		SET @OldOmsOrderDetailsId = (SELECT TOP 1 OOD.OmsOrderDetailsId FROM ZnodeOmsOrderDetails OOD  WITH (NOLOCK) 
									 WHERE EXISTS(SELECT * FROM  #TempOrderData OD WHERE OOD.OmsOrderId = OD.OmsOrderId) AND OOD.IsActive = 1)

		INSERT INTO ZnodeOmsOrderDetails
		(
			OmsOrderId,PortalId,UserId,OrderDate,OmsOrderStateId,ShippingId,PaymentTypeId,BillingFirstName,BillingLastName --1
			,BillingCompanyName,BillingStreet1,BillingStreet2,BillingCity,BillingStateCode,BillingPostalCode,BillingCountry --2
			,BillingPhoneNumber,BillingEmailId,TaxCost,ShippingCost,SubTotal,DiscountAmount,CurrencyCode,OverDueAmount,Total --3
			,ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId --4
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive --5
			,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited --6
			,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName --7
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName, --8
			PaymentExternalId,CultureCode, --9
			DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges --10
			,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty --11 
		)
		OUTPUT INSERTED.OmsOrderId, INSERTED.OmsOrderDetailsId INTO @OMSOrderDetail
		SELECT OO.OmsOrderId, OD.PortalId,@UserId,@GetDate,OD.OmsOrderStateId,OD.ShippingId,OD.PaymentTypeId,OBA.BillingFirstName,OBA.BillingLastName,--1
			OBA.BillingCompanyName,OBA.BillingStreet1,OBA.BillingStreet2,OBA.BillingCity,OBA.BillingStateCode,OBA.BillingPostalCode,OBA.BillingCountry, --2
			OBA.BillingPhoneNumber,OBA.BillingEmailId,OD.TaxCost,OD.ShippingCost,OD.SubTotal, OD.DiscountAmount,OD.CurrencyCode,OD.OverDueAmount,OD.Total, --3
			OD.ShippingNumber,OD.TrackingNumber,OD.CouponCode,OD.PromoDescription,OD.ReferralUserId,OD.PurchaseOrderNumber,OD.OmsPaymentStateId, --4
			OD.WebServiceDownloadDate,OD.PaymentSettingId,OD.PaymentTransactionToken,OD.ShipDate,OD.ReturnDate,OD.BillingAddressId,OD.PoDocument,CAST(1 AS BIT) AS IsActive --5
			,OD.ExternalId,OD.CreatedBy,OOD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.CreditCardNumber,OD.IsShippingCostEdited,OD.IsTaxCostEdited, --6
			OD.ShippingDifference,OD.EstimateShippingCost,OD.TransactionId,OD.Custom1,OD.Custom2,OD.Custom3,OD.Custom4,OD.Custom5,OD.FirstName,OD.LastName, --7
			OD.CardType,OD.CreditCardExpMonth,OD.CreditCardExpYear,OD.TotalAdditionalCost,CASE WHEN OD.PaymentSettingId = OOD.PaymentSettingId THEN OOD.PaymentDisplayName ELSE OD.PaymentDisplayName END AS PaymentDisplayName, --8
			CASE WHEN OD.PaymentSettingId = OOD.PaymentSettingId THEN OOD.PaymentExternalId ELSE OD.PaymentExternalId END AS PaymentExternalId,OD.CultureCode, --9 
			OD.DisplayName,OD.InHandDate,OD.IpAddress,OD.JobName,OD.ShippingConstraintCode,OD.ShippingDiscount,OD.ShippingHandlingCharges,OD.ReturnCharges, --10
			OD.IsCalculateTaxAfterDiscount,OD.Email,OD.PhoneNumber,OD.OrderTotalWithoutVoucher,OD.ImportDuty --11
		FROM #TempOrderData OD
		INNER JOIN ZnodeOmsOrder OO WITH (NOLOCK) ON OD.OrderNumber = OO.OrderNumber
		INNER JOIN ZnodeOmsOrderDetails OOD  WITH (NOLOCK) ON OO.OmsOrderId = OOD.OmsOrderId AND OOD.IsActive = 1
		LEFT JOIN #TempOrderBillingAddress OBA ON OD.BillingAddressId = OBA.AddressId
	
		DECLARE @OmsOrderStateIdCancelled int =  (select top 1 OmsOrderStateId FROM ZnodeOmsOrderState WHERE OrderStateName = 'CANCELLED')

		UPDATE ZnodeOmsOrderDetails SET IsActive = 0 , OmsOrderStateId = @OmsOrderStateIdCancelled
		WHERE OmsOrderDetailsId = @OldOmsOrderDetailsId

		UPDATE ZnodeOmsOrderLineItems SET IsActive = 0
		WHERE OmsOrderDetailsId = @OldOmsOrderDetailsId
	END

	----Geting new OmsOrderDetailsId always
	Declare @OmsOrderDetailsId INT
	SET @OmsOrderDetailsId = ( SELECT TOP 1 OmsOrderDetailsId FROM @OMSOrderDetail )

	--Insert Order notes only for new order details
	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		INSERT INTO ZnodeOmsNotes(OmsOrderDetailsId,Notes,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
		SELECT @OmsOrderDetailsId,Tbl.Col.value( 'AdditionalInstructions[1]', 'NVARCHAR(Max)' ) AS Notes,
			@UserId,@GetDate,@UserId,@GetDate
		FROM @OrderXML.nodes( '//PlaceOrderModel' ) AS Tbl(Col)
		WHERE Tbl.Col.value( 'AdditionalInstructions[1]', 'NVARCHAR(Max)' ) <> '';
	END

	----Inserting parent line item data
	INSERT INTO ZnodeOmsOrderLineItems
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description --1
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber --2
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles --3
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy --4
		,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, GroupIdentifier --5
	)
	OUTPUT INSERTED.OmsOrderDetailsId, INSERTED.OmsOrderLineItemsId, INSERTED.Sku,INSERTED.ParentOmsOrderLineItemsId, INSERTED.GroupId, INSERTED.OrderLineItemRelationshipTypeId,INSERTED.GroupIdentifier INTO @OmsParentOrderLineItems
	SELECT OrderLineItemRelationshipTypeId,@OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description--1
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber --2
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles --3
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,ISNULL(IsActive,1) AS IsActive,CreatedBy,CreatedDate,ModifiedBy --4
		,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, GroupIdentifier --5
	FROM #TempParentLineItemDetails PLID

	----Inserting child line item data
	INSERT INTO ZnodeOmsOrderLineItems
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description --1
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber --2
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles --3
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy --4
		,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, --5
		ParentSku, GroupIdentifier --6
	)
	OUTPUT INSERTED.OmsOrderDetailsId, INSERTED.OmsOrderLineItemsId, INSERTED.Sku,INSERTED.ParentOmsOrderLineItemsId, INSERTED.GroupId, INSERTED.OrderLineItemRelationshipTypeId, INSERTED.ParentSku, INSERTED.GroupIdentifier INTO @OmsOrderLineItems
	SELECT PLID.OrderLineItemRelationshipTypeId,@OmsOrderDetailsId,PLID.OmsOrderShipmentId,PLID.RmaReasonForReturnId,PLID.Sku,PLID.ProductName,PLID.Description, --1
		PLID.Quantity,PLID.Price,PLID.Weight,PLID.DownloadLink,PLID.DiscountAmount,PLID.ShipSeparately,PLID.ShipDate,PLID.ReturnDate,PLID.ShippingCost,PLID.PromoDescription,PLID.TransactionNumber, --2
		PLID.PaymentStatusId,PLID.TrackingNumber,PLID.IsAutoGeneratedTracking,PLID.OrderLineItemStateId,PLID.IsRecurringBilling,PLID.RecurringBillingPeriod,PLID.RecurringBillingCycles,--3
		PLID.RecurringBillingFrequency,PLID.RecurringBillingAmount,PLID.AppliedPromo,PLID.CouponsApplied,PLID.ExternalId,isnull(PLID.IsActive,1) AS IsActive,PLID.CreatedBy,PLID.CreatedDate,PLID.ModifiedBy, --4
		PLID.ModifiedDate,PLID.AutoAddonSKU,PLID.IsShippingReturn,PLID.PartialRefundAmount,PLID.Custom1,PLID.Custom2,PLID.Custom3,PLID.Custom4,PLID.Custom5,PLID.GroupId,PLID.BundleQuantity, --5
		case when PLID.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdSimple then PLID.Sku else PLID.ParentSku end AS ParentSku, GroupIdentifier --6
	FROM #TempChildLineItemDetails PLID

	--Updating ParentOmsOrderLineItemsId for child line items for simple, group and configurable products
	UPDATE A SET A.ParentOmsOrderLineItemsId = (SELECT TOP 1 OmsOrderLineItemsId FROM @OmsParentOrderLineItems d WHERE d.GroupIdentifier = a.GroupIdentifier AND A.ParentSku = D.Sku  and ISNULL(a.GroupId,'-') = ISNULL(d.GroupId,'-'))
	FROM @OmsOrderLineItems a
	WHERE a.OrderLineItemRelationshipTypeId NOT IN ( @OrderLineItemRelationshipTypeIdAddon, @OrderLineItemRelationshipTypeIdGroup)  
	AND a.ParentOmsOrderLineItemsId IS NULL 
	
	--Updating ParentOmsOrderLineItemsId for child line items for group products
	IF EXISTS(SELECT * FROM @OmsOrderLineItems WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdGroup)
	BEGIN
		---Getting child lineitems for group product
		;WITH Cte_GroupProductChild AS
		(
			SELECT GroupIdentifier,Sku, ParentSku, OmsOrderLineItemsId, ParentOmsOrderLineItemsId,Dense_Rank()Over(Partition By GroupIdentifier ORDER BY OmsOrderLineItemsId) AS RowId1 
			FROM @OmsOrderLineItems
			WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdGroup
		)
		---Getting parent lineitems for group product
		,Cte_GroupProductParent AS 
		(
			SELECT GroupIdentifier,Sku, OmsOrderLineItemsId, Dense_Rank()Over(Partition By GroupIdentifier ORDER BY OmsOrderLineItemsId) AS RowId1 
			FROM @OmsParentOrderLineItems a
			WHERE OrderLineItemRelationshipTypeId IS NULL
			AND EXISTS(SELECT * FROM @OmsOrderLineItems b WHERE a.GroupIdentifier = b.GroupIdentifier AND a.Sku = b.ParentSku)
		)
		--Updating ParentOmsOrderLineItemsId on child for group products
		UPDATE a SET a.ParentOmsOrderLineItemsId = b.OmsOrderLineItemsId
		FROM Cte_GroupProductChild a
		INNER JOIN Cte_GroupProductParent B ON A.GroupIdentifier = B.GroupIdentifier AND a.RowId1 = b.RowId1 AND b.Sku = a.ParentSku 
	END

	---Updating ParentOmsOrderLineItemsId for addons if present
	IF EXISTS(SELECT * FROM @OmsOrderLineItems WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
	BEGIN
		--Updating ParentOmsOrderLineItemsId for addon with Simple products , group products and configurable products
		UPDATE b SET b.ParentOmsOrderLineItemsId = c.OmsOrderLineItemsId
		FROM @OmsOrderLineItems c
		INNER JOIN @OmsOrderLineItems b on b.ParentSku = c.Sku AND c.GroupIdentifier = b.GroupIdentifier
		WHERE c.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon and c.OrderLineItemRelationshipTypeId is not null
		and b.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
		AND b.ParentOmsOrderLineItemsId IS NULL
		
		--Updating ParentOmsOrderLineItemsId for addon with bundle products
		UPDATE c SET c.ParentOmsOrderLineItemsId = b.OmsOrderLineItemsId
		FROM @OmsOrderLineItems c
		INNER JOIN @OmsParentOrderLineItems b on B.sku = C.parentsku AND c.GroupIdentifier= b.GroupIdentifier
		WHERE B.OrderLineItemRelationshipTypeId is null 
		AND c.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
		AND C.ParentOmsOrderLineItemsId IS NULL
	 END
	 ---Updating ParentOmsOrderLineItemsId in main table
	 UPDATE a SET a.ParentOmsOrderLineItemsId = b.ParentOmsOrderLineItemsId
	 FROM  ZnodeOmsOrderLineItems a
	 INNER JOIN @OmsOrderLineItems b on a.OmsOrderLineItemsId = b.OmsOrderLineItemsId

	----Shipping details Start
	DECLARE @ShippingTypeId INT
	IF EXISTS(SELECT * FROM #TempOrderData WHERE ShippingTypeId IS NULL)
	BEGIN
		SET @ShippingTypeId = (SELECT TOP 1 ShippingTypeId FROM ZnodeShipping WHERE EXISTS(SELECT * FROM #TempOrderData WHERE ZnodeShipping.ShippingId = #TempOrderData.ShippingId))
	END
	ELSE
	BEGIN
		SET @ShippingTypeId = (SELECT TOP 1 ShippingTypeId FROM #TempOrderData)
	END
	IF EXISTS(SELECT * FROM ZnodeShippingTypes WITH (NOLOCK)  WHERE ShippingTypeId = @ShippingTypeId AND ClassName = 'ZnodeCustomerShipping')
	BEGIN
		INSERT INTO ZnodeOmsCustomerShipping(OmsOrderDetailsId,UserId,ShippingTypeId,AccountNumber,ShippingMethod,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT TOP 1 @OmsOrderDetailsId,@UserId,@ShippingTypeId,AccountNumber,ShippingMethod,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		FROM #TempOrderData
	END
	----Shipping details end

	----Order tax details start
	----Inserting order tax data
	IF (SELECT TOP 1 TaxCost FROM #TempOrderData) > 0
	BEGIN
		INSERT INTO ZnodeOmsTaxOrderDetails(OmsOrderDetailsId,SalesTax,VAT,GST,PST,HST,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportDuty)
		SELECT @OmsOrderDetailsId,OD.SalesTax,OD.VAT,OD.GST,OD.PST,OD.HST,OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.ImportDuty
		FROM #TempOrderData OD
	END

	----Inserting order tax data for parent line item
	INSERT INTO ZnodeOmsTaxOrderLineDetails
	(
		OmsOrderLineItemsId,TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty,
		CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
	)
	SELECT POLI.OmsOrderLineItemsId,CLID.TaxRuleId,CLID.TaxTransactionNumber,CLID.Comments,CLID.SalesTax,CLID.VAT,CLID.GST,CLID.PST,CLID.HST,CLID.ImportDuty,
	CLID.CreatedBy,CLID.CreatedDate,CLID.ModifiedBy,CLID.ModifiedDate
	FROM #TempParentLineItemDetails CLID
	INNER JOIN @OmsParentOrderLineItems POLI ON CLID.Sku = POLI.Sku AND ISNULL(CLID.GroupId,'') = ISNULL(POLI.GroupId,'') AND CLID.GroupIdentifier = POLI.GroupIdentifier
	WHERE POLI.ParentOmsOrderLineItemsId IS NULL
	AND (ISNULL(CLID.SalesTax,0)+ISNULL(CLID.VAT,0)+ISNULL(CLID.GST,0)+ISNULL(CLID.PST,0)+ISNULL(CLID.HST,0)) > 0

	----Inserting order tax data for child line item
	INSERT INTO ZnodeOmsTaxOrderLineDetails
	(
		OmsOrderLineItemsId,TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty,
		CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
	)
	SELECT POLI.OmsOrderLineItemsId,CLID.TaxRuleId,CLID.TaxTransactionNumber,CLID.Comments,CLID.SalesTax,CLID.VAT,CLID.GST,CLID.PST,CLID.HST,CLID.ImportDuty,
		CLID.CreatedBy,CLID.CreatedDate,CLID.ModifiedBy,CLID.ModifiedDate
	FROM #TempChildLineItemDetails CLID
	INNER JOIN @OmsOrderLineItems POLI ON CLID.Sku = POLI.Sku AND ISNULL(CLID.GroupId,'') = ISNULL(POLI.GroupId,'') AND CLID.GroupIdentifier = POLI.GroupIdentifier
	WHERE POLI.ParentOmsOrderLineItemsId IS NOT NULL
	AND (ISNULL(CLID.SalesTax,0)+ISNULL(CLID.VAT,0)+ISNULL(CLID.GST,0)+ISNULL(CLID.PST,0)+ISNULL(CLID.HST,0)) > 0
	----Order tax details end

	----Order attribte details start
	----Fetching order attributes FROM xml
	INSERT INTO #TempOrderAttribute(AttributeCode ,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AttributeValueCode,Sku,GroupId, GroupIdentifier )
	SELECT
		Tbl.Col.value( 'AttributeCode[1]', 'NVARCHAR(Max)' ) AS AttributeCode,
		Tbl.Col.value( 'AttributeValue[1]', 'NVARCHAR(Max)' ) AS AttributeValue,
		@UserId,@GetDate,@UserId,@GetDate,
		Tbl.Col.value( 'AttributeValueCode[1]', 'NVARCHAR(2000)' ) AS AttributeValueCode,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(2000)' ) AS GroupIdentifier
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/OrderLineItem/PlaceOrderlineItemCollection/OrderAttribute/PlaceOrderAttributeModel' ) AS Tbl(Col);

	----Inserting order attributes data
	INSERT INTO ZnodeOmsOrderAttribute(OmsOrderLineItemsId,AttributeCode,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AttributeValueCode)
	SELECT POLI.OmsOrderLineItemsId, OA.AttributeCode,OA.AttributeValue,OA.CreatedBy,OA.CreatedDate,OA.ModifiedBy,OA.CreatedDate,OA.AttributeValueCode
	FROM #TempOrderAttribute OA
	INNER JOIN @OmsOrderLineItems POLI ON OA.Sku = POLI.Sku AND ISNULL(OA.GroupId,'') = ISNULL(POLI.GroupId,'') AND OA.GroupIdentifier = POLI.GroupIdentifier
	----Order attribte details end

	----Personalise details start
	----Fetching personalize order data
	INSERT INTO #OmsPersonalizeItem(PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL,Sku,GroupId, GroupIdentifier)
	SELECT
		Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode,
		Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue,
		@UserId,@GetDate,@UserId,@GetDate,
		Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(2000)' ) AS DesignId,
		Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(2000)' ) AS ThumbnailURL,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(2000)' ) AS GroupIdentifier
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/PersonaliseDetails/PlaceOrderPersonaliseModel' ) AS Tbl(Col);

	--Inserting personalize order data
	INSERT INTO ZnodeOmsPersonalizeItem(OmsOrderLineItemsId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL)
	SELECT OmsOrderLineItemsId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL
	FROM #OmsPersonalizeItem OPI
	INNER JOIN @OmsParentOrderLineItems POLI ON OPI.Sku = POLI.Sku AND ISNULL(OPI.GroupId,'') = ISNULL(POLI.GroupId,'') AND OPI.GroupIdentifier = POLI.GroupIdentifier
	WHERE POLI.ParentOmsOrderLineItemsId IS NULL
	----Personalise details end

	----discount details start
	----Fetching order discount data
	INSERT INTO #OmsOrderDiscount
	(
		OmsDiscountTypeId ,DiscountCode,DiscountAmount ,Description ,CreatedBy ,CreatedDate ,
		ModifiedBy ,ModifiedDate ,PerQuantityDiscount,DiscountMultiplier ,DiscountLevelTypeId ,
		PromotionName ,PromotionTypeId ,DiscountAppliedSequence,PromotionMessage ,Sku,GroupId 
	)
	SELECT
	CASE WHEN Tbl.Col.value( 'OmsDiscountTypeId[1]', 'NVARCHAR(2000)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OmsDiscountTypeId[1]', 'NVARCHAR(2000)' ) END AS OmsDiscountTypeId,
		Tbl.Col.value( 'DiscountCode[1]', 'NVARCHAR(Max)' ) AS DiscountCode,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
		@UserId,@GetDate,@UserId,@GetDate,
		CASE WHEN Tbl.Col.value( 'PerQuantityDiscount[1]', 'NVARCHAR(2000)' )='' THEN NULL ELSE Tbl.Col.value( 'PerQuantityDiscount[1]', 'NVARCHAR(2000)' ) END AS PerQuantityDiscount,
		CASE WHEN Tbl.Col.value( 'DiscountMultiplier[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountMultiplier[1]', 'NVARCHAR(2000)' ) END AS DiscountMultiplier,
		CASE WHEN Tbl.Col.value( 'DiscountLevelTypeId[1]', 'NVARCHAR(2000)' )= '' THEN NULL ELSE Tbl.Col.value( 'DiscountLevelTypeId[1]', 'NVARCHAR(2000)' ) END AS DiscountLevelTypeId,
		Tbl.Col.value( 'PromotionName[1]', 'NVARCHAR(2000)' ) AS PromotionName,
		CASE WHEN Tbl.Col.value( 'PromotionTypeId[1]', 'NVARCHAR(2000)' )= '' THEN NULL ELSE Tbl.Col.value( 'PromotionTypeId[1]', 'NVARCHAR(2000)' ) END AS PromotionTypeId,
		Tbl.Col.value( 'DiscountAppliedSequence[1]', 'NVARCHAR(2000)' ) AS DiscountAppliedSequence,
		Tbl.Col.value( 'PromotionMessage[1]', 'NVARCHAR(2000)' ) AS PromotionMessage,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId
	FROM @OrderXML.nodes('//PlaceOrderModel/OrderDiscounts/PlaceOrderDiscountModel') AS Tbl(Col)

	----Inserting order discount data
	--Inserting product level discount for simple and group products
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,POLI.OmsOrderLineItemsId,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
		OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,POLI.ParentOmsOrderLineItemsId,
		OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	INNER JOIN @OmsOrderLineItems POLI ON OD.Sku = POLI.Sku AND ISNULL(OD.GroupId,'') = ISNULL(POLI.GroupId,'') 
	WHERE isnull(OD.Sku,'') <> '' AND POLI.OrderLineItemRelationshipTypeId IN (@OrderLineItemRelationshipTypeIdSimple , @OrderLineItemRelationshipTypeIdGroup)
	
	--Inserting product level discount for config and bundle products
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,POLI.ParentOmsOrderLineItemsId,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
	OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,NULL,
	OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	INNER JOIN @OmsOrderLineItems POLI ON OD.Sku = POLI.ParentSku AND ISNULL(OD.GroupId,'') = ISNULL(POLI.GroupId,'')
	WHERE isnull(OD.Sku,'') <> '' AND POLI.OrderLineItemRelationshipTypeId IN (@OrderLineItemRelationshipTypeIdBundles , @OrderLineItemRelationshipTypeIdConfig)
	
	--Inserting order level discount 
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,NULL,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
	OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,NULL,
	OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	WHERE isnull(OD.Sku,'') = ''
	----discount details end

	----Additional Cost details start
	IF OBJECT_ID('TEMPDB..#TempAdditionalCost') IS NOT NULL
	DROP TABLE #TempAdditionalCost
	--fetching additional cost details
	SELECT Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl1.Col.value( 'KeyName[1]', 'NVARCHAR(2000)' ) AS KeyName,
		CASE WHEN Tbl1.Col.value( 'KeyValue[1]', 'NVARCHAR(2000)' )='' THEN NULL ELSE Tbl1.Col.value( 'KeyValue[1]', 'NVARCHAR(2000)' ) END AS KeyValue,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId
	INTO #TempAdditionalCost
	FROM @OrderXML.nodes('//PlaceOrderModel/LineItems/PlaceOrderLineItemModel') AS Tbl(Col)
	CROSS APPLY Tbl.Col.nodes( '*:AdditionalCostList/AdditionalCost' ) AS Tbl1(Col);

	--Inserting additional cost details
	IF EXISTS(SELECT * FROM #TempAdditionalCost)
	BEGIN
		INSERT INTO ZnodeOmsOrderLineItemsAdditionalCost(OmsOrderLineItemsId,KeyName,KeyValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT OLI.OmsOrderLineItemsId, AC.KeyName, AC.KeyValue, @UserId, @GetDate, @UserId, @GetDate
		FROM #TempAdditionalCost AC
		INNER JOIN @OmsOrderLineItems OLI ON AC.Sku = OLI.Sku AND ISNULL(AC.GroupId,'') = ISNULL(OLI.GroupId,'') 
		WHERE OLI.ParentOmsOrderLineItemsId IS NULL
		AND ISNULL(AC.KeyName,'') <> ''
	END
	----Additional Cost details end
	
	DECLARE @OmsOrderId INT
	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		SET @OmsOrderId = (SELECT TOP 1 OmsOrderId FROM @OMSOrder)
	END
	ELSE
	BEGIN 
		SET @OmsOrderId = (SELECT TOP 1 OmsOrderId FROM #TempOrderData)
	END
	----RMA details start
	IF (SELECT TOP 1 OmsOrderId FROM #TempOrderData) > 0
	BEGIN
		DECLARE @OldOmsOrderDetailID INT
		SET @OmsOrderID = (SELECT TOP 1 OmsOrderId FROM #TempOrderData)
		SET @OldOmsOrderDetailID = (SELECT TOP 1 OmsOrderDetailsId FROM ZnodeOmsOrderDetails WHERE OmsOrderId = @OmsOrderID AND OmsOrderDetailsId <> @OmsOrderDetailsId ORDER BY OmsOrderDetailsId DESC)

		UPDATE ZnodeRmaReturnDetails
		SET OmsOrderDetailsId = @OmsOrderDetailsId
		WHERE OmsOrderId = @OmsOrderID

		SELECT OOLI.OmsOrderLineItemsId AS OldOmsOrderLineItemsId, OOLI.OmsOrderDetailsId, OOLI.Sku, LI.OmsOrderLineItemsId AS NewOmsOrderLineItemsId
		INTO #OldOrderLineItems
		FROM ZnodeOmsOrderLineItems OOLI WITH (NOLOCK)
		INNER JOIN @OmsOrderLineItems LI ON LI.Sku = OOLI.Sku
		WHERE OOLI.OmsOrderDetailsId = @OldOmsOrderDetailID --AND OOLI.ParentOmsOrderLineItemsId IS NULL
 
		UPDATE RRLI SET RRLI.OmsOrderLineItemsId = OldLI.NewOmsOrderLineItemsId
		FROM ZnodeRmaReturnLineItems RRLI
		INNER JOIN #OldOrderLineItems OldLI ON RRLI.OmsOrderLineItemsId = OldOmsOrderLineItemsId
	END
	----RMA details end
	
	---Inserting OrderTaxDetails
	IF(NOT EXISTS(SELECT 1 from ZnodeOmsTaxRule where OmsOrderId= @OmsOrderId)) AND (SELECT TOP 1 TaxCost FROM #TempOrderData) > 0
	BEGIN
		DECLARE @TaxCost Numeric(28,6), @TaxRuleId INT
		SET @TaxCost = (SELECT TOP 1 TaxCost FROM #TempOrderData)
		SET @TaxRuleId = (SELECT TOP 1 TaxRuleId FROM #TempChildLineItemDetails)

		 EXEC [Znode_InsertOrderTaxDetails] @OmsOrderId = @OmsOrderId, @TaxRuleId = @TaxRuleId, @TaxRate = @TaxCost, @Status = 0
	END

	COMMIT TRAN OrderInsert

	SELECT TOP 1 OmsOrderId,@OmsOrderDetailsId AS OmsOrderDetailsId, cast(1 AS bit)  AS Status, '' AS ErrorMessage
	FROM @OMSOrderDetail

END TRY
BEGIN CATCH
	ROLLBACK TRAN OrderInsert
	SELECT TOP 1 0 AS OmsOrderId,0 AS OmsOrderDetailsId, cast(0 AS bit)  AS Status, ERROR_MESSAGE() AS ErrorMessage

	INSERT INTO ZnodeOmsFailedOrderPayments(PaymentCode,PaymentDisplayName,TransactionToken,TotalAmount,UserName,UserId,Email,PaymentSettingId,OrderNumber,OrderDate,PaymentStatusId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
	SELECT TOP 1 PaymentCode,PaymentDisplayName, isnull(PaymentTransactionToken,''),Total,a.FirstName+' '+a.LastName,@UserId,a.Email,a.PaymentSettingId,a.OrderNumber,@GetDate,PaymentStatusId,@UserId,@GetDate,@UserId,@GetDate
	FROM #TempOrderData A
	
	DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertUpdateOmsOrder @OrderXML ='+CAST(@OrderXML AS VARCHAR(MAX))+' , @UserId = '+CAST(@UserId AS VARCHAR(50));

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName    = 'Znode_InsertUpdateOmsOrder',
	@ErrorInProcedure = @ERROR_PROCEDURE,
	@ErrorMessage     = @ErrorMessage,
	@ErrorLine        = @ErrorLine,
	@ErrorCall        = @ErrorCall;
	--If error throw in SP the deleting records FROM order tables if data inserted
	EXEC Znode_DeleteOrderById @OrderDetailId=@OmsOrderDetailsId,@Status=0
END CATCH

END

GO
Update ZnodeApplicationSetting
set Setting = '<?xml version="1.0" encoding="UTF-8"?><columns><column><id>1</id><name>UserId</name><headertext>Customer ID</headertext><width>40</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format /><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>y</isconditional><isallowlink>y</isallowlink><islinkactionurl /><islinkparamfield /><ischeckbox>n</ischeckbox><checkboxparamfield /><iscontrol>n</iscontrol><controltype /><controlparamfield /><displaytext /><editactionurl /><editparamfield /><deleteactionurl /><deleteparamfield /><viewactionurl /><viewparamfield /><imageactionurl /><imageparamfield /><manageactionurl /><manageparamfield /><copyactionurl /><copyparamfield /><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class /><SearchControlType>--Select--</SearchControlType><SearchControlParameters /><DbParamField /><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>FullName</name><headertext>Full Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format /><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>y</isconditional><isallowlink>n</isallowlink><islinkactionurl /><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype /><controlparamfield /><displaytext>Full Name</displaytext><editactionurl /><editparamfield /><deleteactionurl /><deleteparamfield /><viewactionurl /><viewparamfield /><imageactionurl /><imageparamfield /><manageactionurl /><manageparamfield /><copyactionurl /><copyparamfield /><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>fullname</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters /><DbParamField /><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>UserName</name><headertext>Username</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format /><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl /><islinkparamfield>UserId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>UserId</checkboxparamfield><iscontrol>n</iscontrol><controltype /><controlparamfield /><displaytext /><editactionurl /><editparamfield /><deleteactionurl /><deleteparamfield /><viewactionurl /><viewparamfield /><imageactionurl /><imageparamfield /><manageactionurl /><manageparamfield /><copyactionurl /><copyparamfield /><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>username</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters /><DbParamField /><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>Email</name><headertext>Email ID</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format /><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl /><islinkparamfield>UserId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>UserId</checkboxparamfield><iscontrol>n</iscontrol><controltype /><controlparamfield /><displaytext /><editactionurl /><editparamfield /><deleteactionurl /><deleteparamfield /><viewactionurl /><viewparamfield /><imageactionurl /><imageparamfield /><manageactionurl /><manageparamfield /><copyactionurl /><copyparamfield /><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>email-id</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters /><DbParamField /><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>Accountname</name><headertext>Account Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format /><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl /><islinkparamfield>UserId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>UserId</checkboxparamfield><iscontrol>n</iscontrol><controltype /><controlparamfield /><displaytext /><editactionurl /><editparamfield /><deleteactionurl /><deleteparamfield /><viewactionurl /><viewparamfield /><imageactionurl /><imageparamfield /><manageactionurl /><manageparamfield /><copyactionurl /><copyparamfield /><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class /><SearchControlType>--Select--</SearchControlType><SearchControlParameters /><DbParamField /><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>RoleName</name><headertext>Role Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format /><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl /><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype /><controlparamfield /><displaytext>Phone Number</displaytext><editactionurl /><editparamfield /><deleteactionurl /><deleteparamfield /><viewactionurl /><viewparamfield /><imageactionurl /><imageparamfield /><manageactionurl /><manageparamfield /><copyactionurl /><copyparamfield /><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class /><SearchControlType>--Select--</SearchControlType><SearchControlParameters /><DbParamField /><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
Where ItemName = 'ZnodeGiftCardCustomer'

GO
IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PostSubmitOrderProcess')
	DROP PROC Znode_PostSubmitOrderProcess
GO

CREATE PROCEDURE [dbo].[Znode_PostSubmitOrderProcess]
(
	@PostOrderXml XML,
	@InventoryData XML,
	@UserId INT,
	@PortalId INT = 0,
	@Status BIT OUT
)
AS
BEGIN
BEGIN TRY
--BEGIN TRAN PostOrder
	DECLARE @OmsOrderDetailsId INT
	DECLARE @OmsOrderId INT = (SELECT Tbl.Col.value( 'OrderID[1]', 'NVARCHAR(2000)' ) AS OrderId FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))
	
	DECLARE @IsGuest BIT = (SELECT Tbl.Col.value( 'IsGuest[1]', 'NVARCHAR(2000)' ) AS IsGuest FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))

	DECLARE @OmsCookieMappingId INT = (SELECT Tbl.Col.value( 'CookieMappingId[1]', 'NVARCHAR(2000)' ) AS CookieMappingId FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))
	DECLARE @BillingAddressId INT = (SELECT Tbl.Col.value( 'BillingAddressId[1]', 'NVARCHAR(2000)' ) AS BillingAddressId FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))
	
	DECLARE @IsReferralCommission BIT = (SELECT Tbl.Col.value( 'IsReferralCommission[1]', 'NVARCHAR(2000)' ) AS IsReferralCommission FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))
	DECLARE @CommissionAmount NUMERIC(26,6) = (SELECT Tbl.Col.value( 'CommissionAmount[1]', 'NVARCHAR(2000)' ) AS CommissionAmount FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))
	
	SET @OmsOrderDetailsId = (SELECT OmsOrderDetailsId from ZnodeOmsOrderDetails WHERE OmsOrderId = @OmsOrderId AND IsActive = 1)
	DECLARE @SetBillingShippingFlags BIT = (SELECT Tbl.Col.value( 'SetBillingShippingFlags[1]', 'NVARCHAR(2000)' ) AS SetBillingShippingFlags FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col)) 
	DECLARE @GetDate DATETIME = GETDATE()
	
	--Fetching required user details 
	DECLARE @ReferralCommissionTypeId INT, @ReferralCommission NUMERIC(28,6) , @FirstName VARCHAR(100)
	SELECT @FirstName = FirstName, @ReferralCommission = CASE WHEN ReferralCommission IS NULL THEN 0 ELSE ReferralCommission END, @ReferralCommissionTypeId = ReferralCommissionTypeId
	FROM ZnodeUser WITH (NOLOCK) 
	WHERE UserId = @UserId
	
	---Voucher model fetch
	CREATE TABLE #TempVoucher
	(
		VoucherBalance NUMERIC(28,6),VoucherNumber NVARCHAR(600),VoucherMessage NVARCHAR(MAX),IsVoucherValid BIT,
		IsVoucherApplied BIT,VoucherAmountUsed NUMERIC(28,6),VoucherName NVARCHAR(600),ExpirationDate DATETIME,
		CultureCode NVARCHAR(600),PortalId INT,IsExistInOrder BIT,UserId INT,IsActive BIT,OrderVoucherAmount NUMERIC(28,6)
	)

	INSERT INTO #TempVoucher
	(
		VoucherBalance ,VoucherNumber,VoucherMessage ,IsVoucherValid ,
		IsVoucherApplied ,VoucherAmountUsed ,VoucherName ,ExpirationDate ,
		CultureCode ,PortalId ,IsExistInOrder ,UserId ,IsActive ,OrderVoucherAmount 
	)
	SELECT Tbl.Col.value( 'VoucherBalance[1]', 'NVARCHAR(2000)' ) AS VoucherBalance,
		Tbl.Col.value( 'VoucherNumber[1]', 'NVARCHAR(2000)' ) AS VoucherNumber,
		Tbl.Col.value( 'VoucherMessage[1]', 'NVARCHAR(2000)' ) AS VoucherMessage,
		Tbl.Col.value( 'IsVoucherValid[1]', 'NVARCHAR(2000)' ) AS IsVoucherValid,
		Tbl.Col.value( 'IsVoucherApplied[1]', 'NVARCHAR(2000)' ) AS IsVoucherApplied,
		Tbl.Col.value( 'VoucherAmountUsed[1]', 'NVARCHAR(2000)' ) AS VoucherAmountUsed,
		Tbl.Col.value( 'VoucherName[1]', 'NVARCHAR(2000)' ) AS VoucherName,
		Tbl.Col.value( 'ExpirationDate[1]', 'NVARCHAR(2000)' ) AS ExpirationDate,
		Tbl.Col.value( 'CultureCode[1]', 'NVARCHAR(2000)' ) AS CultureCode,
		Tbl.Col.value( 'PortalId[1]', 'NVARCHAR(2000)' ) AS PortalId,
		Tbl.Col.value( 'IsExistInOrder[1]', 'NVARCHAR(2000)' ) AS IsExistInOrder,
		Tbl.Col.value( 'UserId[1]', 'NVARCHAR(2000)' ) AS UserId,	
		Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(2000)' ) AS IsActive,
		Tbl.Col.value( 'OrderVoucherAmount[1]', 'NVARCHAR(2000)' ) AS OrderVoucherAmount
	FROM @PostOrderXml.nodes('//PostOrderSubmitModel/Vouchers/VoucherModel') AS Tbl(Col)


	----Promotion coupon start
	DECLARE @TempPromotionCoupon DBO.PromotionCoupons

	INSERT INTO @TempPromotionCoupon
	SELECT Tbl.Col.value( 'Code[1]', 'NVARCHAR(2000)' ) AS Code,
		Tbl.Col.value( 'IsExistInOrder[1]', 'NVARCHAR(2000)' ) AS IsExistInOrder,@OmsOrderId AS OmsOrderId
	FROM @PostOrderXml.nodes('//PostOrderSubmitModel/Coupons/CouponModel') AS Tbl(Col)

	--Deduct promotion coupon count
	EXEC [Znode_PromotionCouponDeduct] @PromotionCoupons = @TempPromotionCoupon
	----Promotion coupon END
	
	--Deduct inventory quantity
	EXEC [Znode_UpdateInventoryPostOrder] @SkuXml = @InventoryData,@PortalId = @PortalId, @UserId= @UserId,@OmsOrderId=@OmsOrderId,@Status = 0

	----Voucher start
	IF EXISTS(SELECT * FROM #TempVoucher)
	BEGIN
		INSERT INTO ZnodeGiftCardHistory(GiftCardId,TransactionDate,TransactionAmount,OmsOrderDetailsId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Notes,RemainingAmount)
		SELECT GC.GiftCardId, @GetDate, VoucherAmountUsed,@OmsOrderDetailsId,@UserId, @GetDate, @UserId, @GetDate, 'Voucher is used to make payments for the order' as Notes, NULL AS RemainingAmount
		FROM #TempVoucher V
		INNER JOIN ZnodeGiftCard GC WITH (NOLOCK) ON V.VoucherNumber = GC.CardNumber

		IF EXISTS(SELECT * FROM #TempVoucher WHERE IsExistInOrder IN ('TRUE','1'))
		BEGIN
			UPDATE GC SET GC.RemainingAmount = V.VoucherBalance
			FROM #TempVoucher V
			INNER JOIN ZnodeGiftCard GC ON V.VoucherNumber = GC.CardNumber
			WHERE IsExistInOrder IN ('TRUE','1')
		END

		IF EXISTS(SELECT * FROM #TempVoucher WHERE IsExistInOrder IN ('FALSE','0'))
		BEGIN
			UPDATE GC SET GC.RemainingAmount = GC.RemainingAmount - V.VoucherAmountUsed
			FROM #TempVoucher V
			INNER JOIN ZnodeGiftCard GC ON V.VoucherNumber = GC.CardNumber
			WHERE IsExistInOrder IN ('FALSE','0')
		END
	END
	----Voucher end
	
	--Update user details
	IF @FirstName IS NULL
	BEGIN
		DECLARE @FirstName1 VARCHAR(300), @LastName VARCHAR(300), @PhoneNumber VARCHAR(300)
		SELECT @FirstName1=FirstName, @LastName=LastName, @PhoneNumber=PhoneNumber
		FROM ZnodeAddress WITH (NOLOCK)  WHERE AddressId = @BillingAddressId

		UPDATE ZnodeUser 
		SET FirstName = @FirstName, LastName = @LastName, PhoneNumber = @PhoneNumber
		WHERE UserId = @UserId
	END

	--Update address details
	IF @SetBillingShippingFlags IN ('TRUE','1')
	BEGIN
		UPDATE ZnodeAddress
		SET IsBilling = 1, IsShipping = 1
		WHERE AddressId = @BillingAddressId
	END

	--ReferralCommission details
	IF @IsReferralCommission IN ('TRUE','1')
	BEGIN
		INSERT INTO ZnodeOmsReferralCommission
		(
			UserId,OmsOrderDetailsId,OrderCommission,TransactionId,Description,ReferralCommission,ReferralCommissionTypeId
			,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		)
		SELECT @UserId,@OmsOrderDetailsId,CASE WHEN @ReferralCommissionTypeId =1 THEN ((@CommissionAmount * ISNULL(@ReferralCommission,0)) / 100) ELSE @ReferralCommission END AS OrderCommission,'' AS TransactionId,'' AS Description,@ReferralCommission,@ReferralCommissionTypeId
			,@UserId,@GetDate,@UserId,@GetDate
	END
	
	---OmsTaxOrderSummary details
	IF EXISTS(SELECT * FROM ZnodeOmsTaxOrderSummary WITH (NOLOCK)  WHERE OmsOrderDetailsId = @OmsOrderDetailsId)
	BEGIN
		DELETE FROM ZnodeOmsTaxOrderSummary WHERE OmsOrderDetailsId = @OmsOrderDetailsId
	END

	INSERT INTO ZnodeOmsTaxOrderSummary (OmsOrderDetailsId,Tax,Rate,TaxName,TaxTypeName)
	SELECT 	@OmsOrderDetailsId AS OmsOrderDetailsId,
		Tbl.Col.value( 'Tax[1]', 'NVARCHAR(2000)' ) AS Tax,
		Tbl.Col.value( 'Rate[1]', 'NVARCHAR(2000)' ) AS Rate,
		Tbl.Col.value( 'TaxName[1]', 'NVARCHAR(2000)' ) AS TaxName,
		Tbl.Col.value( 'TaxTypeName[1]', 'NVARCHAR(2000)' ) AS TaxTypeName
	FROM @PostOrderXml.nodes('//PostOrderSubmitModel/TaxSummaryList/TaxSummaryModel') AS Tbl(Col)
	WHERE Tbl.Col.value( 'Tax[1]', 'NVARCHAR(2000)' ) IS NOT NULL
	--------

	--Remove 
	EXEC [Znode_DeleteSavedCartItem] @OmsCookieMappingId = @OmsCookieMappingId, @UserId = @UserId,@PortalId = @PortalId,@Status = 0  

	SET @Status = 1
	--COMMIT TRAN PostOrder
END TRY
BEGIN CATCH
--ROLLBACK TRAN PostOrder
	SET @Status = 0
	
	DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PostSubmitOrderProcess @PostOrderXml ='+CAST(@PostOrderXml AS VARCHAR(MAX))+' , @InventoryData = '+CAST(@InventoryData AS VARCHAR(50))+',@UserId ='+CAST(@UserId AS VARCHAR(50))+',@PortalId ='+CAST(@PortalId AS VARCHAR(50))+',@Status ='+CAST(@Status AS VARCHAR(50));
	
	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName    = 'Znode_PostSubmitOrderProcess',
	@ErrorInProcedure = @ERROR_PROCEDURE,
	@ErrorMessage     = @ErrorMessage,
	@ErrorLine        = @ErrorLine,
	@ErrorCall        = @ErrorCall;
END CATCH

END

GO
IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeleteOmsQuoteLineItem')
	DROP PROC Znode_DeleteOmsQuoteLineItem
GO

CREATE PROCEDURE Znode_DeleteOmsQuoteLineItem
(
	@OmsQuoteLineItemId INT,
	@ParentOmsQuoteLineItemId INT,
	@Status BIT OUT
)
AS
BEGIN
BEGIN TRY
BEGIN TRAN DeleteOmsQuoteLineItem
	--Deleting child line item
	DELETE FROM ZnodeOmsQuoteLineItem WHERE OmsQuoteLineItemId = @OmsQuoteLineItemId
	--Deleting parent line item if no child is present in it
	DELETE FROM ZnodeOmsQuoteLineItem WHERE OmsQuoteLineItemId = @ParentOmsQuoteLineItemId
	AND NOT EXISTS(SELECT * FROM ZnodeOmsQuoteLineItem WHERE ParentOmsQuoteLineItemId = @ParentOmsQuoteLineItemId)
COMMIT TRAN DeleteOmsQuoteLineItem
	SET @Status = 1
	SELECT 1 ID, CAST(@Status AS BIT) [Status];
END TRY
BEGIN CATCH
ROLLBACK TRAN DeleteOmsQuoteLineItem
	SET @Status = 0
	SELECT 1 ID, CAST(@Status AS BIT) [Status];
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeleteOmsQuoteLineItem @OmsQuoteLineItemId = '+CAST(@OmsQuoteLineItemId AS VARCHAR(200))+', @ParentOmsQuoteLineItemId='+CAST(@ParentOmsQuoteLineItemId AS VARCHAR(200));


    EXEC Znode_InsertProcedureErrorLog
        @ProcedureName = 'Znode_DeleteOmsQuoteLineItem',
        @ErrorInProcedure = @Error_procedure,
        @ErrorMessage = @ErrorMessage,
        @ErrorLine = @ErrorLine,
        @ErrorCall = @ErrorCall;
END CATCH
END

GO
IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetFilterPimProductId')
	DROP PROC Znode_GetFilterPimProductId
GO


CREATE PROCEDURE [dbo].[Znode_GetFilterPimProductId]
(
  @WhereClause XML 
 ,@PimProductId TransferId READONLY 
 ,@LocaleId   INT,
 @IsProductNotIn BIT = 1
)
AS 
BEGIN 
SET NOCOUNT ON 

		DECLARE  @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleID()
		DECLARE @SQL NVARCHAR(MAX)
		DECLARE @InternalProductWhereClause NVARCHAR(MAX)

		DECLARE @WorkingProcess INT = 0 

		DECLARE @TBL_FilterClause TABLE (ID INT IDENTITY(1,1),AttributeValue NVARCHAR(MAX),AttributeCode NVARCHAr(MAX),PimAttributeId INT ,AttributeTypeName VARCHAR(300),AttributeCodeOrg VARCHAR(600))

		DECLARE @WhereClauseXML XML = @WhereClause 

		SET @SQL  = ''

		IF EXISTS (SELECT TOP 1 1 FROM @WhereClauseXml.nodes ( '//ArrayOfWhereClauseModel/WhereClauseModel'  ) AS Tbl(Col) 
		WHERE Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(MAX)')  LIKE  '% in (%')
		BEGIN 
			SET @WorkingProcess = 1

				INSERT INTO @TBL_FilterClause (AttributeValue,AttributeCode,AttributeTypeName,PimAttributeId,AttributeCodeOrg)
			SELECT  Tbl.Col.value ( 'attributevalue[1]' , 'NVARCHAR(MAX)') AS AttributeValue
			,Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(MAX)') AS AttributeValue,ZTY.AttributeTypeName,ZPA.PimAttributeId,AttributeCode AttributeCodeOrg
			FROM @WhereClauseXml.nodes ( '//ArrayOfWhereClauseModel/WhereClauseModel'  ) AS Tbl(Col)
			LEFT JOIN  ZnodePimAttribute ZPA  ON ((Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(MAX)')  LIKE '%in (%' OR dbo.Fn_Trim(REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(MAX)'),' = ',''),'''','')) 
												= ZPA.AttributeCode ) AND IsCategory = 0 
			AND ( ZPA.IsShowOnGrid = 1 OR ZPA.IsConfigurable =1  )  )
			LEFT JOIN ZnodeAttributeType ZTY ON (ZTY.AttributeTypeId = ZPA.AttributeTypeId)

		END 
		ELSE 
		BEGIN 

			INSERT INTO @TBL_FilterClause (AttributeValue,AttributeCode,AttributeTypeName,PimAttributeId,AttributeCodeOrg)
			SELECT  Tbl.Col.value ( 'attributevalue[1]' , 'NVARCHAR(MAX)') AS AttributeValue
			,Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(MAX)') AS AttributeValue,ZTY.AttributeTypeName,ZPA.PimAttributeId,AttributeCode AttributeCodeOrg
			FROM @WhereClauseXml.nodes ( '//ArrayOfWhereClauseModel/WhereClauseModel'  ) AS Tbl(Col)
			LEFT JOIN ZnodePimAttribute ZPA  ON (dbo.Fn_Trim(REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(MAX)'),' = ',''),'''','')) 
												= ZPA.AttributeCode AND ZPA.IsCategory = 0 
			AND ( ZPA.IsShowOnGrid = 1 OR ZPA.IsConfigurable =1  )  )
			LEFT JOIN ZnodeAttributeType ZTY ON (ZTY.AttributeTypeId = ZPA.AttributeTypeId)

		END 

		CREATE TABLE #TBL_PimProductId (PimProductId INT)

		CREATE TABLE #TBL_PimProductIdDelete (PimProductId INT )

		INSERT INTO #TBL_PimProductId (PimProductId )
		SELECT Id 
		FROM @PimProductId

		SELECT ZPAV.PimProductId ,PimAttributeValueId ,ZPAV.CreatedDate,ZPAV.ModifiedDate,TBLA.AttributeCodeOrg AttributeCode
		INTO #TBL_AttributeValueId 
		FROM  ZnodePimAttributeValue ZPAV 
		INNER JOIN @TBL_FilterClause TBLA ON (TBLA.PimAttributeId = ZPAV.PimAttributeId)
		INNER JOIN #TBL_PimProductId YT ON (YT.PimProductId = ZPAV.PimProductId OR NOT EXISTS (SELECT TOP 1 1 #TBL_PimProductId))

		DELETE FROM #TBL_PimProductId

		INSERT INTO #TBL_PimProductId (PimProductId )
		SELECT DISTINCT PimProductId 
		FROM #TBL_AttributeValueId

		IF @WorkingProcess =1 
		BEGIN 
				DECLARE @PimAttributeId_in TransferId 

				INSERT INTO @PimAttributeId_in 
				SELECT PimAttributeId
				FROM  @TBL_FilterClause 
				WHERE AttributeTypeName IN ('Simple Select','Multi Select') 
				AND AttributeCode LIKE '%in (%'

				CREATE TABLE #TBL_AttributeDefaultValue_in ( PimAttributeId INT ,
							AttributeDefaultValueCode VARCHAR(MAX),IsEditable INT,AttributeDefaultValue NVARCHAR(MAX),DisplayOrder INT,PimAttributeDefaultValueId INT,IsDefault Bit  )    
				INSERT INTO #TBL_AttributeDefaultValue_in(PimAttributeId,AttributeDefaultValueCode,IsEditable,AttributeDefaultValue,DisplayOrder,PimAttributeDefaultValueId,IsDefault)
				EXEC Znode_GetAttributeDefaultValueLocaleNew_TansferId @PimAttributeId_in, @LocaleId;
 
				DECLARE @WhereClauseInCom NVARCHAR(MAX) = (SELECT TOP 1 AttributeValue FROM @TBL_FilterClause WHERE AttributeCode LIKE '%in (%') 


			SET @SQL = '
			;With Cte_AttributeValue AS 
			(
			SELECT PimAttributeValueId 
			FROM ZnodePimAttributeValueLocale 
			WHERE AttributeValue '+@WhereClauseInCom+'
			UNION ALL 
			SELECT ZPADV.PimAttributeValueID 
			FROM ZnodePimProductAttributeDefaultValue ZPADV 
			INNER JOIN #TBL_AttributeDefaultValue_in TBL ON (TBL.PimAttributeDefaultValueId = ZPADV.PimAttributeDefaultValueId)
			WHERE TBL.AttributeDefaultValue '+@WhereClauseInCom+'
			)
   
			SELECT PimProductId 
			FROM #TBL_AttributeValueId ZPAV 
			INNER JOIN  Cte_AttributeValue CTAC ON (CTAC.PimAttributeValueId = ZPAV.PimAttributeVaLueId )
			GROUP BY PimProductId
			UNION ALL  
			SELECT PimProductId 
			FROM ZnodePimProduct a
			INNER JOIN ZnodePimFamilyLocale b ON (b.PimAttributeFamilyId = a.PimAttributeFamilyId) 
			WHERE b.AttributeFamilyName '+@WhereClauseInCom+'
			GROUP BY PimProductId
			UNION ALL 
			SELECT  TBLAV.PimProductId 
			FROM ZnodePimProduct TBLAV
			WHERE CASE WHEN TBLAV.IsProductPublish  IS NULL THEN ''Not Published'' 
					WHEN TBLAV.IsProductPublish = 0 THEN ''Draft''
					ELSE  ''Published'' END '+@WhereClauseInCom+'
			GROUP BY TBLAV.PimProductId 
			'
   
			DELETE FROM #TBL_PimProductIdDelete 
			INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
			EXEC (@SQL)
			DELETE FROM #TBL_PimProductId
			INSERT INTO #TBL_PimProductId
			SELECT PimProductId FROM #TBL_PimProductIdDelete
			INSERT INTO #TBL_PimProductId
			SELECT -1 
			WHERE NOT EXISTS (SELECT TOP 1 1  FROM #TBL_PimProductId)

			DELETE  FROM @TBL_FilterClause WHERE AttributeCode LIKE '% in (%'

			DROP TABLE #TBL_AttributeDefaultValue_in
			SET @WorkingProcess  = 0 
   
		END 

		IF EXISTS (SELECT TOP 1 1 FROM @TBL_FilterClause WHERE AttributeCode <> '' AND ISNULL(AttributeValue,'') = '')
		BEGIN 
  
				SET  @InternalProductWhereClause = STUFF( (  SELECT ' INNER JOIN #TBL_AttributeValueId AS ZPAVL'+CAST(ID AS VARCHAR(200))+
												' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
												' )'				
										FROM @TBL_FilterClause
										WHERE ISNULL(AttributeValue,'') = ''
										FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				----Change for configurable product varient page seach
				SET @SQL = ' 
							SELECT  TBLAV.PimProductId 
							FROM #TBL_AttributeValueId TBLAV '+@InternalProductWhereClause+' 
							WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId )
							GROUP BY TBLAV.PimProductId 
						'
  

				DELETE FROM #TBL_PimProductIdDelete 
				INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
				EXEC (@SQL)
				DELETE FROM #TBL_PimProductId
				INSERT INTO #TBL_PimProductId
				SELECT PimProductId FROM #TBL_PimProductIdDelete
				INSERT INTO #TBL_PimProductId
				SELECT -1 
				WHERE NOT EXISTS (SELECT TOP 1 1  FROM #TBL_PimProductId)
				DELETE FROM @TBL_FilterClause WHERE ISNULL(AttributeValue,'') = ''
				IF NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) AND EXISTS (SELECT TOP 1 1  FROM @PimProductId Having Max (ID) = 0 )
				BEGIN
				INSERT INTO  #TBL_PimProductId (PimProductId)
				SELECT 0 
			END
  
		END 

		IF EXISTS (SELECT TOP 1 1 FROM @TBL_FilterClause WHERE AttributeTypeName IN ('Simple Select','Multi Select') )
		BEGIN
			DECLARE @PimAttributeId TransferId 

			INSERT INTO @PimAttributeId 
			SELECT DISTINCT PimAttributeId
			FROM  @TBL_FilterClause WHERE AttributeTypeName IN ('Simple Select','Multi Select') 

			CREATE TABLE #TBL_AttributeDefaultValue ( PimAttributeId INT ,
						AttributeDefaultValueCode VARCHAR(MAX),IsEditable INT,AttributeDefaultValue NVARCHAR(MAX),DisplayOrder INT,PimAttributeDefaultValueId INT,IsDefault BIT  )    
			INSERT INTO #TBL_AttributeDefaultValue(PimAttributeId,AttributeDefaultValueCode,IsEditable,AttributeDefaultValue,DisplayOrder,PimAttributeDefaultValueId,IsDefault)
			EXEC Znode_GetAttributeDefaultValueLocaleNew_TansferId @PimAttributeId, @LocaleId;
 
			IF @DefaultLocaleId = @LocaleID AND  @WorkingProcess = 0 
			BEGIN 

				IF @IsProductNotIn = 1 AND EXISTS(SELECT * FROM @TBL_FilterClause WHERE AttributeCodeOrg in ('Brand','Highlights'))
				BEGIN
					SET  @InternalProductWhereClause = STUFF( (  SELECT ' INNER JOIN Cte_AttributeValue AS ZPAVL'+CAST(ID AS VARCHAR(200))+
													' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
													+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+
													'.LocaleId='+CAST(@LocaleID AS VARCHAR(200))+' )'				
											FROM @TBL_FilterClause
											WHERE AttributeTypeName IN ('Simple Select','Multi Select')
											AND AttributeValue <> ''
											AND AttributeValue IS NOT NULL
											FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				END
				ELSE IF @IsProductNotIn = 0  AND EXISTS(SELECT * FROM @TBL_FilterClause WHERE AttributeCodeOrg not in ('Brand','Highlights'))
				BEGIN
					SET  @InternalProductWhereClause = STUFF( (  SELECT ' INNER JOIN Cte_AttributeValue AS ZPAVL'+CAST(ID AS VARCHAR(200))+
													' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
													+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+
													'.LocaleId='+CAST(@LocaleID AS VARCHAR(200))+' )'				
											FROM @TBL_FilterClause
											WHERE AttributeTypeName IN ('Simple Select','Multi Select')
											AND AttributeValue <> ''
											AND AttributeValue IS NOT NULL
											FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				END
				ELSE
				BEGIN
					SET  @InternalProductWhereClause = STUFF( (  SELECT ' INNER JOIN Cte_AttributeValue AS ZPAVL'+CAST(ID AS VARCHAR(200))+
													' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+
													'.LocaleId='+CAST(@LocaleID AS VARCHAR(200))+' )'				
											FROM @TBL_FilterClause
											WHERE AttributeTypeName IN ('Simple Select','Multi Select')
											AND AttributeValue <> ''
											AND AttributeValue IS NOT NULL
											FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				END
				
				SET @SQL = ' ;With Cte_AttributeValue AS 
							(
							SELECT TBLAV.PimAttributeValueId ,SUBSTRING((SELECT '',''+AttributeDefaultValueCode FROM #TBL_AttributeDefaultValue TTR 
							INNER JOIN ZnodePimProductAttributeDefaultValue ZPAVL ON (TTR.PimAttributeDefaultValueId = ZPAVL.PimAttributeDefaultValueId )
							WHERE ZPAVL.PimAttributeValueId = TBLAV.PimAttributeValueId  
							AND ZPAVL.LocaleId = '+Cast(@localeId AS VARCHAR(200))+'
							FOR XML PATH('''') ),2,4000) AttributeValue
								,  '+Cast(@localeId AS VARCHAR(200))+' LocaleId,TBLAV.AttributeCode,TBLAV.PimProductId
							FROM #TBL_AttributeValueId TBLAV
							'+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END+'
							GROUP BY TBLAV.PimAttributeValueId,TBLAV.AttributeCode,TBLAV.PimProductId
							)
  
						SELECT  TBLAV.PimProductId
						FROM #TBL_AttributeValueId TBLAV
						'+@InternalProductWhereClause+'	GROUP BY TBLAV.PimProductId '
			
				
			END 
			ELSE IF  @WorkingProcess = 0 
			BEGIN 

				SET  @InternalProductWhereClause = 
										STUFF( (  SELECT ' INNER JOIN Cte_AttributeValue AS ZPAVL'+CAST(ID AS VARCHAR(200))+
												' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
												' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+'  )'				
										FROM @TBL_FilterClause
										WHERE AttributeTypeName IN ('Simple Select','Multi Select')
										AND AttributeValue <> ''
										AND AttributeValue IS NOT NULL
										FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				SET @SQL = '  			 
							SELECT TBLAV.PimAttributeValueId,ZPAVL.PimAttributeDefaultValueId , ZPAVL.LocaleId ,COUNT(*)Over(Partition By TBLAV.PimAttributeValueId ,TBLAV.PimProductId ORDER BY TBLAV.PimAttributeValueId ,TBLAV.PimProductId  ) RowId
							INTO #temp_Table 
							FROM #TBL_AttributeValueId TBLAV 
							INNER JOIN ZnodePimProductAttributeDefaultValue ZPAVL ON (ZPAVL.PimAttributeValueId = TBLAV.PimAttributeValueId)
							WHERE (ZPAVL.LocaleId = '+Cast(@localeId AS VARCHAR(200))+' OR ZPAVL.LocaleId = '+Cast(@DefaultlocaleId AS VARCHAR(200))+')
				
							;with Cte_AttributeValue AS 
							(
							SELECT TBLAV.PimAttributeValueId ,SUBSTRING((SELECT '',''+AttributeDefaultValueCode FROM #TBL_AttributeDefaultValue TTR 
							INNER JOIN #temp_Table  ZPAVL ON (TTR.PimAttributeDefaultValueId = ZPAVL.PimAttributeDefaultValueId )
							WHERE ZPAVL.PimAttributeValueId = TBLAV.PimAttributeValueId  
							AND ZPAVL.LocaleId = CASE WHEN ZPAVL.RowId = 2 THEN '+CAST(@LocaleId AS Varchar(300))+' ELSE '+Cast(@DefaultLocaleId AS Varchar(300))+' END  
							FOR XML PATH('''') ),2,4000) AttributeValue,TBLAV.AttributeCode ,TBLAV.PimProductId 
							FROM #TBL_AttributeValueId TBLAV
							'+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END+'
							GROUP BY TBLAV.PimAttributeValueId,TBLAV.AttributeCode ,TBLAV.PimProductId 
							)
  
							SELECT   TBLAV.PimProductId
							FROM  #TBL_AttributeValueId TBLAV
							'+@InternalProductWhereClause+'	GROUP BY TBLAV.PimProductId '

			END 

			DELETE FROM #TBL_PimProductIdDelete 
			INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
			EXEC (@SQL)
			DELETE FROM #TBL_PimProductId
			INSERT INTO #TBL_PimProductId
			SELECT PimProductId FROM #TBL_PimProductIdDelete
 
			DROP TABLE #TBL_AttributeDefaultValue

		END 

		IF EXISTS (SELECT TOP 1 1 FROM @TBL_FilterClause WHERE AttributeTypeName IN ('Text','Number','Datetime','Yes/No','Date') )
		BEGIN  
   
				IF @DefaultLocaleId = @LocaleID AND @WorkingProcess = 0 
				BEGIN 
					SET  @InternalProductWhereClause = 
											STUFF( (  SELECT ' INNER JOIN View_PimProducttextValue AS ZPAVL'+CAST(ID AS VARCHAR(200))+
													' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
													' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+
													'.LocaleId='+CAST(@LocaleID AS VARCHAR(200))+' )'				
											FROM @TBL_FilterClause
											WHERE AttributeTypeName IN ('Text','Number','Datetime','Yes/No','Date')
											FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
 
					SET @SQL = '	SELECT  TBLAV.PimProductId 
								FROM #TBL_AttributeValueId TBLAV
								'+@InternalProductWhereClause+'
								'+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
											ELSE ' WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId   ) ' END 
								+' GROUP BY TBLAV.PimProductId '

			END 
			ELSE IF @WorkingProcess = 0 
			BEGIN 
				SET  @InternalProductWhereClause = 
										STUFF( (  SELECT ' INNER JOIN Cte_AttributeDetails AS ZPAVL'+CAST(ID AS VARCHAR(200))+
												' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
												' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+
												'.LocaleId = CASE WHEN ZPAVL'+CAST(ID AS VARCHAR(200))+'.RowId = 2 THEN  '+CAST(@LocaleId AS Varchar(300))+' ELSE '+Cast(@DefaultLocaleId AS Varchar(300))+' END  )'				
										FROM @TBL_FilterClause
										WHERE AttributeTypeName IN ('Text','Number','Datetime','Yes/No','Date')
										FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				SET @SQL = ' 
					;With Cte_AttributeDetails AS 
					(
					SELECT TBLAV.PimProductId,ZPAVL.AttributeValue,TBLAV.AttributeCode,ZPAVL.LocaleId ,COUNT(*)Over(Partition By TBLAV.PimProductId,TBLAV.AttributeCode ORDER BY TBLAV.PimProductId,TBLAV.AttributeCode  ) RowId
					FROM #TBL_AttributeValueId TBLAV 
					INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON (ZPAVL.PimAttributeValueId = TBLAV.PimAttributeValueId )
					WHERE (LocaleId = '+Cast(@DefaultLocaleId AS Varchar(300))+' OR LocaleId = '+CAST(@LocaleId AS Varchar(300))+' )'+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' AND EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END +'
					) 
					SELECT  TBLAV.PimProductId 
  					FROM #TBL_AttributeValueId TBLAV
					'+@InternalProductWhereClause+'
					GROUP BY TBLAV.PimProductId 
					'
			END 
			DELETE FROM #TBL_PimProductIdDelete 
			INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
			EXEC (@SQL)
			DELETE FROM #TBL_PimProductId
			INSERT INTO #TBL_PimProductId
			SELECT PimProductId FROM #TBL_PimProductIdDelete

		END 

		IF EXISTS (SELECT TOP 1 1 FROM @TBL_FilterClause WHERE AttributeTypeName IN ('Text Area') )
		BEGIN    
			IF @DefaultLocaleId = @LocaleID AND @WorkingProcess = 0 
			BEGIN 
				SET  @InternalProductWhereClause = 
											STUFF( (  SELECT ' INNER JOIN View_PimProductTextAreaValue AS ZPAVL'+CAST(ID AS VARCHAR(200))+
												' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
												' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+
												'.LocaleId='+CAST(@LocaleID AS VARCHAR(200))+' )'				
										FROM @TBL_FilterClause
										WHERE AttributeTypeName IN ('Text Area')
										FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
 
				SET @SQL = '
							SELECT  TBLAV.PimProductId 
							FROM #TBL_AttributeValueId TBLAV
							'+@InternalProductWhereClause+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END 
										+' GROUP BY TBLAV.PimProductId '
			END 
			ELSE IF @WorkingProcess = 0 
			BEGIN 
				SET  @InternalProductWhereClause = 
										STUFF( (  SELECT ' INNER JOIN Cte_AttributeDetails AS ZPAVL'+CAST(ID AS VARCHAR(200))+
												' ON ( TBLAV.PimProductId = ZPAVL'+CAST(ID AS VARCHAR(200))+'.PimProductId AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeCode '+AttributeCode+
												' AND ZPAVL'+CAST(ID AS VARCHAR(200))+'.AttributeValue '+AttributeValue+' AND ZPAVL'+CAST(ID AS VARCHAR(200))+
												'.LocaleId = CASE WHEN ZPAVL'+CAST(ID AS VARCHAR(200))+'.RowId = 2 THEN  '+CAST(@LocaleId AS Varchar(300))+' ELSE '+Cast(@DefaultLocaleId AS Varchar(300))+' END  )'				
										FROM @TBL_FilterClause
										WHERE AttributeTypeName IN ('Text Area')
										FOR XML PATH (''), TYPE).value('.', ' Nvarchar(MAX)'), 1, 0, '')
				SET @SQL = ' 
					;With Cte_AttributeDetails AS 
					(
					SELECT TBLAV.PimProductId,TBLAV.AttributeCode,ZPAVL.AttributeValue,ZPAVL.LocaleId ,COUNT(*)Over(Partition By TBLAV.PimProductId,TBLAV.AttributeCode ORDER BY TBLAV.PimProductId,TBLAV.AttributeCode  ) RowId
					FROM #TBL_AttributeValueId TBLAV 
					INNER JOIN ZnodePimProductAttributeTextAreaValue ZPAVL ON (ZPAVL.PimAttributeValueId = TBLAV.PimAttributeValueId )
					WHERE (LocaleId = '+Cast(@DefaultLocaleId AS Varchar(300))+' OR LocaleId = '+CAST(@LocaleId AS Varchar(300))+' )
	 
					) 
					SELECT  TBLAV.PimProductId 
  					FROM #TBL_AttributeValueId TBLAV
					'+@InternalProductWhereClause+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END 
										+' 
										GROUP BY TBLAV.PimProductId 	
										'
				END 
			DELETE FROM #TBL_PimProductIdDelete 
			INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
			EXEC (@SQL)
			DELETE FROM #TBL_PimProductId
			INSERT INTO #TBL_PimProductId
			SELECT PimProductId FROM #TBL_PimProductIdDelete

		END 
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_FilterClause WHERE AttributeCode  LIKE '%PublishStatus%' )
		BEGIN    
 
				SET @SQL = '
							SELECT  TBLAV.PimProductId 
							FROM ZnodePimProduct TBLAV
							WHERE CASE WHEN TBLAV.IsProductPublish  IS NULL THEN ''Not Published'' 
							WHEN TBLAV.IsProductPublish = 0 THEN ''Draft''
							ELSE  ''Published'' END '+(SELECT TOP 1 AttributeValue FROM @TBL_FilterClause WHERE AttributeCode LIKE '%PublishStatus%')+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' AND EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END 
										+' GROUP BY TBLAV.PimProductId '
  
				DELETE FROM #TBL_PimProductIdDelete 
				INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
				EXEC (@SQL)
				DELETE FROM #TBL_PimProductId
				INSERT INTO #TBL_PimProductId
				SELECT PimProductId FROM #TBL_PimProductIdDelete

		END 
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_FilterClause WHERE AttributeCode  LIKE '%AttributeFamily%' )
		BEGIN 

				;With Cte_attributeValue AS 
				(
					SELECT ZPAF.PimAttributeFamilyId,FamilyCode,AttributeFamilyName ,ZPFL.LocaleId
					FROM ZnodePimAttributeFamily ZPAF
					INNER JOIN ZnodePimFamilyLocale ZPFL ON (ZPFL.PimAttributeFamilyId = ZPAF.PimAttributeFamilyId) 
					WHERE ZPFL.LocaleId IN (@DefaultLocaleId,@LocaleId)
				) 
				, Cte_AttributeValueAttribute AS 
				(
					SELECT PimAttributeFamilyId,FamilyCode,AttributeFamilyName
					FROM Cte_attributeValue RTY 
					WHERE LocaleId = @LocaleId
				)
				, Cte_AttributeValueTht AS 
				(
					SELECT PimAttributeFamilyId,FamilyCode,AttributeFamilyName
					FROM Cte_AttributeValueAttribute
					UNION ALL 
					SELECT PimAttributeFamilyId,FamilyCode,AttributeFamilyName
					FROM Cte_attributeValue TYY  
					WHERE NOT EXISTS (SELECT TOP 1 1 FROM Cte_AttributeValueAttribute THE WHERE THE.PimAttributeFamilyId = TYY.PimAttributeFamilyId )
					AND TYY.LocaleId = @DefaultLocaleId
				)
				SELECT PimAttributeFamilyId,FamilyCode,AttributeFamilyName
				INTO #TBL_FamilyLocale
				FROM Cte_AttributeValueTht 


				SET @SQL = '
							SELECT  TBLAV.PimProductId 
							FROM ZnodePimProduct TBLAV 
							INNER JOIN #TBL_FamilyLocale THY ON (THY.PimAttributeFamilyId = TBLAV.PimAttributeFamilyId )
							WHERE AttributeFamilyName '+(SELECT TOP 1 AttributeValue FROM @TBL_FilterClause WHERE AttributeCode LIKE '%AttributeFamily%')+CASE WHEN NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId ) THEN '' 
										ELSE ' AND EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductId TBLP WHERE TBLP.PimProductId = TBLAV.PimProductId ) ' END 
										+' GROUP BY TBLAV.PimProductId '
  

			DELETE FROM #TBL_PimProductIdDelete 
			INSERT INTO #TBL_PimProductIdDelete  (PimProductId)
			EXEC (@SQL)
			DELETE FROM #TBL_PimProductId
			INSERT INTO #TBL_PimProductId
			SELECT PimProductId FROM #TBL_PimProductIdDelete

		END 
	
		SET @SQL = '
		IF EXISTS ( SELECT TOP 1 1 FROM tempdb..sysobjects WHERE name = ''##Temp_PimProductId'+CAST(@@SPID AS VARCHAR(500))+''' )
		BEGIN 
			DROP TABLE ##Temp_PimProductId'+CAST(@@SPID AS VARCHAR(500))+'
		END 
		CREATE TABLE ##Temp_PimProductId'+CAST(@@SPID AS VARCHAR(500))+' (PimProductId INT )
		INSERT INTO  ##Temp_PimProductId'+CAST(@@SPID AS VARCHAR(500))+'
		SELECT PimProductId 
		FROM #TBL_PimProductId
		'
		EXEC (@SQL)
		DROP TABLE #TBL_PimProductId
		DROP TABLE #TBL_AttributeValueId
		DROP TABLE #TBL_PimProductIdDelete
 END
 
GO
IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPimProductAttributeInventory')
	DROP PROC Znode_GetPimProductAttributeInventory
GO

CREATE  PROCEDURE [dbo].[Znode_GetPimProductAttributeInventory]
(   @SKU    SelectColumnList READONLY
    --@IsMultipleProduct BIT          = 0
	)
AS
/*
     Summary : - This procedure is used to find the inventory of product 
     Unit Testing 
	 begin tran
     Exec Znode_GetPimProductAttributeInventory 7
	 rollback tran
*/
     BEGIN
	 BEGIN TRAN PimProductAttributeFamilyId
         BEGIN TRY
             SET NOCOUNT ON;
			
			 IF OBJECT_ID('tempdb.dbo.#TBL_PimProductId', 'U') IS NOT NULL 
		     DROP TABLE #TBL_PimProductId
		 
			 SELECT StringColumn AS SKU INTO #TBL_PimProductId  FROM @SKU 
			
			-- DontTrackInventory cant have inventory
			SELECT sum(ZI.Quantity ) quantity  ,a.PimProductId 
			INTO #TBL_InventoryDetails
			FROM ZnodePimAttributeValue a 
			INNER JOIN  ZnodePimAttributeValueLocale b ON ( b.PimAttributeValueId = a.PimAttributeValueId )
			INNER JOIN ZnodePimAttribute c ON ( c.PimAttributeId=a.PimAttributeId )
			LEFT JOIN  ZnodeInventory ZI ON ZI.SKU = b.AttributeValue 
			LEFT JOIN ZnodeWarehouse ZW on (ZI.WarehouseId = ZW.WarehouseId)
			WHERE EXISTS(SELECT TOP 1 1 FROM #TBL_PimProductId TBP WHERE b.AttributeValue = TBP.SKU )
			AND c.AttributeCode = 'SKU'
			GROUP BY a.PimProductId 

			SELECT dISTINCT TOP 1 CASE WHEN  AttributeDefaultValueCode = 'DontTrackInventory' THEN 'DTI' 
			ELSE [dbo].[Fn_GetDefaultInventoryRoundOff](ISNULL(Quantity, 0))     END Quantity  ,tb.PimProductId 
			INTO #CTE_Getdetails
			FROM #TBL_InventoryDetails tb
			INNER JOIN ZnodePimAttributeValue PAV ON (PAV.PimProductId = tb.PimProductId)
			INNER JOIN ZnodePimProductAttributeDefaultValue a on (a.PimAttributeValueId = pav.PimAttributeValueId)
			INNER JOIN ZnodePimAttributeDefaultValue dv on (a.PimAttributeDefaultValueId = dv.PimAttributeDefaultValueId)
			INNER JOIN ZnodePimAttribute PA ON (PA.pimattributeId = PAV.pimAttributeid )
			WHERE  PA.Attributecode = 'OutOfStockOptions'
			 
		
			 SELECT   CAST(quantity AS NVARCHAR(100))  quantity ,PimProductId
			 FROM #CTE_Getdetails

			IF OBJECT_ID('tempdb.dbo.#TBL_PimProductId', 'U') IS NOT NULL 
			DROP TABLE #TBL_PimProductId
	
		 COMMIT TRAN PimProductAttributeFamilyId;
         END TRY
         BEGIN CATCH
				
          DECLARE @Status BIT ;
		  SET @Status = 0;
		  DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), 
		  @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		  @ErrorLine VARCHAR(100)= ERROR_LINE(), 
		  @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPimProductAttributeInventory' ;
              			 
          SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  ROLLBACK TRAN PimProductAttributeFamilyId;

          EXEC Znode_InsertProcedureErrorLog
            @ProcedureName = 'Znode_GetPimProductAttributeInventory',
            @ErrorInProcedure = @Error_procedure,
            @ErrorMessage = @ErrorMessage,
            @ErrorLine = @ErrorLine,
            @ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO
IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateOmsOrder')
	DROP PROC Znode_InsertUpdateOmsOrder
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateOmsOrder]
(
	@OrderXML XML,
	@UserId INT
)
AS
BEGIN
SET NOCOUNT ON;
BEGIN TRY

	DECLARE @GetDate DATETIME = GETDATE()
	DECLARE @OMSOrder TABLE(OmsOrderId INT,OrderNumber VARCHAR(200))
	DECLARE @OMSOrderDetail TABLE(OmsOrderId INT,OmsOrderDetailsId INT)
	DECLARE @OmsOrderLineItems TABLE(RowId INT IDENTITY(1,1),OmsOrderDetailsId INT,OmsOrderLineItemsId INT, Sku VARCHAR(600), ParentOmsOrderLineItemsId INT, GroupId NVARCHAR(MAX),OrderLineItemRelationshipTypeId INT,ParentSku VARCHAR(600), GroupIdentifier INT)
	DECLARE @OmsParentOrderLineItems TABLE(RowId INT IDENTITY(1,1),OmsOrderDetailsId INT,OmsOrderLineItemsId INT, Sku VARCHAR(600), ParentOmsOrderLineItemsId INT, GroupId NVARCHAR(MAX), OrderLineItemRelationshipTypeId INT, GroupIdentifier INT)

	DECLARE @OrderLineItemRelationshipTypeIdAddon int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'AddOns'
	);

	DECLARE @OrderLineItemRelationshipTypeIdSimple int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Simple'
	);

	DECLARE @OrderLineItemRelationshipTypeIdBundles int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Bundles'
	);

	DECLARE @OrderLineItemRelationshipTypeIdGroup int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Group'
	);

	DECLARE @OrderLineItemRelationshipTypeIdConfig int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Configurable'
	);


	CREATE TABLE #TempOrderData
	(
		RowId INT IDENTITY(1,1),OrderNumber VARCHAR(200), PublishStateId INT,OmsOrderId INT,OmsOrderStateId INT,
		DiscountAmount NUMERIC(28,6),SalesTax NUMERIC(28,6),TaxRate NUMERIC(28,6),IsOldOrder BIT,VAT NUMERIC(28,6),GST NUMERIC(28,6),
		PST NUMERIC(28,6),HST NUMERIC(28,6),Total NUMERIC(28,6),BillingAddressId INT,ShippingAddressId INT,ShippingId INT,
		PortalId INT,ShippingNumber NVARCHAR(max),TrackingNumber NVARCHAR(1000),CouponCode NVARCHAR(1000),
		PromoDescription NVARCHAR(max),ReferralUserId int,PurchaseOrderNumber NVARCHAR(1000),OmsPaymentStateId int,
		WebServiceDownloadDate datetime,PaymentSettingId int,PaymentTransactionToken NVARCHAR(600),ShipDate datetime,ReturnDate datetime,
		AddressId int,PoDocument NVARCHAR(600),IsActive bit,ExternalId NVARCHAR(1000),PaymentTypeId INT,CreatedBy INT,CreatedDate datetime,ModifiedBy INT,
		ModifiedDate datetime,CreditCardNumber VARCHAR(4),IsShippingCostEdited bit,IsTaxCostEdited bit,ShippingDifference NUMERIC(28,6),
		EstimateShippingCost NUMERIC(28,6),TransactionId NVARCHAR(800),Custom1 NVARCHAR(MAX),Custom2 NVARCHAR(MAX),Custom3 NVARCHAR(MAX),
		Custom4 NVARCHAR(MAX),Custom5 NVARCHAR(MAX),FirstName NVARCHAR(200),LastName NVARCHAR(200),CardType VARCHAR(50),CreditCardExpMonth INT,
		CreditCardExpYear INT,TotalAdditionalCost NUMERIC(28,6),PaymentDisplayName NVARCHAR(2000),PaymentExternalId NVARCHAR(2000),
		CultureCode VARCHAR(200),DisplayName NVARCHAR(2000),InHandDate datetime,IpAddress VARCHAR(100),JobName NVARCHAR(200),
		ShippingConstraintCode NVARCHAR(100),ShippingDiscount NUMERIC(28,6),ShippingHandlingCharges NUMERIC(28,6),ReturnCharges NUMERIC(28,6),
		IsCalculateTaxAfterDiscount bit,Email VARCHAR(50),PhoneNumber VARCHAR(50),OrderTotalWithoutVoucher NUMERIC(28,6),ImportDuty NUMERIC(28,6),
		TaxCost NUMERIC(28,6),ShippingCost NUMERIC(28,6), SubTotal NUMERIC(28,6),CurrencyCode VARCHAR(100),OverDueAmount NUMERIC(28,6), ShippingTypeId INT,
		AccountNumber NVARCHAR(4000),ShippingMethod NVARCHAR(4000),PaymentCode NVARCHAR(400) ,PaymentStatusId Int
	)

	CREATE TABLE #TempOrderBillingAddress
	(
		AddressId INT,BillingFirstName VARCHAR(300),BillingLastName VARCHAR(300),BillingCountry VARCHAR(3000),BillingStateCode VARCHAR(300),
		BillingPostalCode VARCHAR(50),BillingPhoneNumber VARCHAR(50),BillingEmailId VARCHAR(50),BillingStreet1 VARCHAR(300),BillingStreet2 VARCHAR(300),
		BillingCity VARCHAR(3000),BillingCompanyName NVARCHAR(1200)
	)
	
	CREATE TABLE #TempParentLineItemDetails
	(
		RowId INT IDENTITY(1,1),OrderLineItemRelationshipTypeId INT,OmsOrderDetailsId INT,OmsOrderShipmentId INT,RmaReasonForReturnId INT,Sku NVARCHAR(600),ProductName NVARCHAR(1000),
		Description NVARCHAR(max),Quantity NUMERIC(28,6),Price NUMERIC(28,6),Weight NUMERIC(28,6),DownloadLink NVARCHAR(max),DiscountAmount NUMERIC(28,6),
		ShipSeparately bit,ShipDate datetime,ReturnDate datetime,ShippingCost NUMERIC(28,6),PromoDescription NVARCHAR(max),TransactionNumber NVARCHAR(max),
		PaymentStatusId int,TrackingNumber NVARCHAR(max),IsAutoGeneratedTracking bit,OrderLineItemStateId int,IsRecurringBilling bit,RecurringBillingPeriod NVARCHAR(100),
		RecurringBillingCycles int,RecurringBillingFrequency NVARCHAR(100),RecurringBillingAmount NUMERIC(28,6),AppliedPromo NVARCHAR(max),CouponsApplied NVARCHAR(100),
		ExternalId NVARCHAR(1000),IsActive bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,AutoAddonSKU NVARCHAR(max),IsShippingReturn bit,
		PartialRefundAmount NUMERIC(28,6),Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),Custom4 NVARCHAR(max),Custom5 NVARCHAR(max),
		GroupId NVARCHAR(max),BundleQuantity int, TaxRuleId INT,TaxTransactionNumber NVARCHAR(1200),Comments NVARCHAR(MAX),SalesTax NUMERIC(28,6),VAT NUMERIC(28,6),
		GST NUMERIC(28,6),PST NUMERIC(28,6),HST NUMERIC(28,6),ImportDuty NUMERIC(28,6), GroupIdentifier INT
	)

	CREATE TABLE #TempChildLineItemDetails
	(
		RowId INT IDENTITY(1,1),OrderLineItemRelationshipTypeId INT,OmsOrderDetailsId INT,OmsOrderShipmentId INT,RmaReasonForReturnId INT,Sku NVARCHAR(600),ProductName NVARCHAR(1000),
		Description NVARCHAR(max),Quantity NUMERIC(28,6),Price NUMERIC(28,6),Weight NUMERIC(28,6),DownloadLink NVARCHAR(max),DiscountAmount NUMERIC(28,6),
		ShipSeparately bit,ShipDate datetime,ReturnDate datetime,ShippingCost NUMERIC(28,6),PromoDescription NVARCHAR(max),TransactionNumber NVARCHAR(max),
		PaymentStatusId int,TrackingNumber NVARCHAR(max),IsAutoGeneratedTracking bit,OrderLineItemStateId int,IsRecurringBilling bit,RecurringBillingPeriod NVARCHAR(100),
		RecurringBillingCycles int,RecurringBillingFrequency NVARCHAR(100),RecurringBillingAmount NUMERIC(28,6),AppliedPromo NVARCHAR(max),CouponsApplied NVARCHAR(100),
		ExternalId NVARCHAR(1000),IsActive bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,AutoAddonSKU NVARCHAR(max),IsShippingReturn bit,
		PartialRefundAmount NUMERIC(28,6),Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),Custom4 NVARCHAR(max),Custom5 NVARCHAR(max),
		GroupId NVARCHAR(max),BundleQuantity int, TaxRuleId INT,TaxTransactionNumber NVARCHAR(1200),Comments NVARCHAR(MAX),SalesTax NUMERIC(28,6),VAT NUMERIC(28,6),
		GST NUMERIC(28,6),PST NUMERIC(28,6),HST NUMERIC(28,6),ImportDuty NUMERIC(28,6), ParentSku NVARCHAR(600), GroupIdentifier INT
	)

	CREATE TABLE #TempOrderAttribute
	(
		AttributeCode NVARCHAR(1000),AttributeValue NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,
		ModifiedDate DATETIME,AttributeValueCode NVARCHAR(1000), Sku VARCHAR(600), GroupId NVARCHAR(max), GroupIdentifier INT
	)

	CREATE TABLE #OmsPersonalizeItem
	(
		PersonalizeCode NVARCHAR(400),PersonalizeValue NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,
		ModifiedDate DATETIME,DesignId NVARCHAR(4000),ThumbnailURL NVARCHAR(MAX), Sku VARCHAR(600), GroupId NVARCHAR(max),
		GroupIdentifier INT
	)

	CREATE TABLE #OmsOrderDiscount
	(
		OmsDiscountTypeId INT,DiscountCode VARCHAR(300),DiscountAmount NUMERIC(28,6),Description NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,
		ModifiedBy INT,ModifiedDate DATETIME,PerQuantityDiscount NUMERIC(28,6),DiscountMultiplier NUMERIC(28,6),ParentOmsOrderLineItemsId INT,
		DiscountLevelTypeId INT,PromotionName NVARCHAR(1200),PromotionTypeId INT,DiscountAppliedSequence INT,PromotionMessage NVARCHAR(MAX),Sku VARCHAR(600),
		GroupId NVARCHAR(max)
	)

	--------Getting Order details
	INSERT INTO #TempOrderData
	(
		OrderNumber, PublishStateId ,OmsOrderId ,OmsOrderStateId ,DiscountAmount ,SalesTax ,TaxRate ,IsOldOrder ,
		VAT ,GST ,PST ,HST ,Total ,BillingAddressId ,ShippingAddressId ,ShippingId ,PortalId,
		ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
		,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive
		,ExternalId,PaymentTypeId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
		,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName
		,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
		,DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
		,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty,TaxCost,ShippingCost, SubTotal,
		CurrencyCode,OverDueAmount, ShippingTypeId, AccountNumber, ShippingMethod, PaymentCode, PaymentStatusId
	)
	SELECT
		CASE WHEN Tbl.Col.value( 'OrderNumber[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderNumber[1]', 'NVARCHAR(Max)' ) END  AS OrderNumber,
		CASE WHEN Tbl.Col.value( 'PublishStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PublishStateId[1]', 'NVARCHAR(Max)' ) END AS PublishStateId,
		CASE WHEN Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderId,
		CASE WHEN Tbl.Col.value( 'OmsOrderStateId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderStateId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderStateId,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE  Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
		CASE WHEN Tbl.Col.value( 'TaxRate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TaxRate[1]', 'NVARCHAR(Max)' ) END AS TaxRate,
		CASE WHEN Tbl.Col.value('IsOldOrder[1]', 'NVARCHAR(2000)') = '' THEN NULL ELSE Tbl.Col.value('IsOldOrder[1]', 'NVARCHAR(2000)') END AS IsOldOrder,
		CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE  Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
		CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
		CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END  AS PST,
		CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END AS HST,
		CASE WHEN Tbl.Col.value( 'Total[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Total[1]', 'NVARCHAR(Max)' ) END AS Total,
		CASE WHEN Tbl.Col.value( 'BillingAddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'BillingAddressId[1]', 'NVARCHAR(Max)' ) END AS BillingAddressId,
		CASE WHEN Tbl.Col.value( 'ShippingAddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingAddressId[1]', 'NVARCHAR(Max)' ) END AS ShippingAddressId,
		CASE WHEN (Tbl.Col.value( 'ShippingId[1]', 'NVARCHAR(Max)' )) = '' THEN NULL ELSE (Tbl.Col.value( 'ShippingId[1]', 'NVARCHAR(Max)' )) END  AS ShippingId,
		CASE WHEN Tbl.Col.value( 'PortalId[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'PortalId[1]', 'NVARCHAR(Max)' ) END AS PortalId,
		Tbl.Col.value( 'ShippingNumber[1]', 'NVARCHAR(Max)' ) AS ShippingNumber,
		Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
		Tbl.Col.value( 'CouponCode[1]', 'NVARCHAR(Max)' ) AS CouponCode,
		Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
		CASE WHEN Tbl.Col.value( 'ReferralUserId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReferralUserId[1]', 'NVARCHAR(Max)' ) END  AS ReferralUserId,
		Tbl.Col.value( 'PurchaseOrderNumber[1]', 'NVARCHAR(Max)' ) AS PurchaseOrderNumber,
		CASE WHEN Tbl.Col.value( 'OmsPaymentStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsPaymentStateId[1]', 'NVARCHAR(Max)' ) END AS OmsPaymentStateId,
		Tbl.Col.value( 'WebServiceDownloadDate[1]', 'NVARCHAR(Max)' ) AS WebServiceDownloadDate,
		CASE WHEN Tbl.Col.value( 'PaymentSettingId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentSettingId[1]', 'NVARCHAR(Max)' ) END AS PaymentSettingId,
		Tbl.Col.value( 'PaymentTransactionToken[1]', 'NVARCHAR(Max)' ) AS PaymentTransactionToken,
		CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE @GetDate END AS ShipDate,
		CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
		CASE WHEN Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) END AS AddressId,
		Tbl.Col.value( 'PoDocument[1]', 'NVARCHAR(Max)' ) AS PoDocument,
		CASE WHEN Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) END  AS IsActive,
		Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
		CASE WHEN Tbl.Col.value( 'PaymentTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentTypeId[1]', 'NVARCHAR(Max)' ) END  AS PaymentTypeId,
		@UserId AS CreatedBy,
		@GetDate AS CreatedDate,
		@UserId AS ModifiedBy,
		@GetDate AS ModifiedDate,
		Tbl.Col.value( 'CreditCardNumber[1]', 'NVARCHAR(Max)' ) AS CreditCardNumber,
		CASE WHEN Tbl.Col.value( 'IsShippingCostEdited[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsShippingCostEdited[1]', 'NVARCHAR(Max)' ) END AS IsShippingCostEdited,
		CASE WHEN Tbl.Col.value( 'IsTaxCostEdited[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsTaxCostEdited[1]', 'NVARCHAR(Max)' ) END AS IsTaxCostEdited,
		Tbl.Col.value( 'ShippingDifference[1]', 'NVARCHAR(Max)' ) AS ShippingDifference,
		CASE WHEN Tbl.Col.value( 'EstimateShippingCost[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'EstimateShippingCost[1]', 'NVARCHAR(Max)' ) END AS EstimateShippingCost,
		Tbl.Col.value( 'TransactionId[1]', 'NVARCHAR(Max)' ) AS TransactionId,
		Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
		Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
		Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
		Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
		Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
		Tbl.Col.value( 'FirstName[1]', 'NVARCHAR(Max)' ) AS FirstName,
		Tbl.Col.value( 'LastName[1]', 'NVARCHAR(Max)' ) AS LastName,
		Tbl.Col.value( 'CardType[1]', 'NVARCHAR(Max)' ) AS CardType,
		Tbl.Col.value( 'CreditCardExpMonth[1]', 'NVARCHAR(Max)' ) AS CreditCardExpMonth,
		Tbl.Col.value( 'CreditCardExpYear[1]', 'NVARCHAR(Max)' ) AS CreditCardExpYear,
		CASE WHEN Tbl.Col.value( 'TotalAdditionalCost[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TotalAdditionalCost[1]', 'NVARCHAR(Max)' ) END AS TotalAdditionalCost,
		Tbl.Col.value( 'PaymentDisplayName[1]', 'NVARCHAR(Max)' ) AS PaymentDisplayName,
		Tbl.Col.value( 'PaymentExternalId[1]', 'NVARCHAR(Max)' ) AS PaymentExternalId,
		Tbl.Col.value( 'CultureCode[1]', 'NVARCHAR(Max)' ) AS CultureCode,
		Tbl.Col.value( 'DisplayName[1]', 'NVARCHAR(Max)' ) AS DisplayName,
		Tbl.Col.value( 'InHandDate[1]', 'NVARCHAR(Max)' ) AS InHandDate,
		Tbl.Col.value( 'IpAddress[1]', 'NVARCHAR(Max)' ) AS IpAddress,
		Tbl.Col.value( 'JobName[1]', 'NVARCHAR(Max)' ) AS JobName,
		Tbl.Col.value( 'ShippingConstraintCode[1]', 'NVARCHAR(Max)' ) AS ShippingConstraintCode,
		Tbl.Col.value( 'ShippingDiscount[1]', 'NVARCHAR(Max)' ) AS ShippingDiscount,
		Tbl.Col.value( 'ShippingHandlingCharges[1]', 'NVARCHAR(Max)' ) AS ShippingHandlingCharges,
		CASE WHEN Tbl.Col.value( 'ReturnCharges[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'ReturnCharges[1]', 'NVARCHAR(Max)' ) END AS ReturnCharges,
		CASE WHEN Tbl.Col.value( 'IsCalculateTaxAfterDiscount[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsCalculateTaxAfterDiscount[1]', 'NVARCHAR(Max)' ) END AS IsCalculateTaxAfterDiscount,
		Tbl.Col.value( 'Email[1]', 'NVARCHAR(Max)' ) AS Email,
		Tbl.Col.value( 'PhoneNumber[1]', 'NVARCHAR(Max)' ) AS PhoneNumber,
		CASE WHEN Tbl.Col.value( 'OrderTotalWithoutVoucher[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OrderTotalWithoutVoucher[1]', 'NVARCHAR(Max)' )  END AS OrderTotalWithoutVoucher,
		CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )='' THEN '' ELSE Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
		CASE WHEN Tbl.Col.value( 'TaxCost[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'TaxCost[1]', 'NVARCHAR(Max)' ) END  AS TaxCost,
		CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
		CASE WHEN Tbl.Col.value( 'SubTotal[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'SubTotal[1]', 'NVARCHAR(Max)' ) END AS SubTotal,
		Tbl.Col.value( 'CurrencyCode[1]', 'NVARCHAR(Max)' ) AS CurrencyCode,
		CASE WHEN Tbl.Col.value( 'OverDueAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OverDueAmount[1]', 'NVARCHAR(Max)' ) END AS OverDueAmount,
		CASE WHEN Tbl.Col.value( 'ShippingTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingTypeId[1]', 'NVARCHAR(Max)' ) END AS ShippingTypeId,
		Tbl.Col.value( 'AccountNumber[1]', 'NVARCHAR(Max)' ) AS AccountNumber,
		Tbl.Col.value( 'ShippingMethod[1]', 'NVARCHAR(Max)' ) AS ShippingMethod,
		Tbl.Col.value( 'PaymentCode[1]', 'NVARCHAR(Max)' ) AS PaymentCode,
		CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId
	FROM @OrderXML.nodes( '//PlaceOrderModel' ) AS Tbl(Col);


	--Getting billing address info
	INSERT INTO #TempOrderBillingAddress
	(
		AddressId,BillingFirstName,BillingLastName,BillingCompanyName,BillingStreet1,BillingStreet2,
		BillingCity,BillingStateCode,BillingPostalCode,BillingCountry,BillingPhoneNumber,BillingEmailId
	)
	SELECT
		Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) AS AddressId,
		Tbl.Col.value( 'FirstName[1]', 'NVARCHAR(Max)' ) AS FirstName,
		Tbl.Col.value( 'LastName[1]', 'NVARCHAR(Max)' ) AS LastName,
		Tbl.Col.value( 'CompanyName[1]', 'NVARCHAR(Max)' ) AS CompanyName,
		Tbl.Col.value( 'Street1[1]', 'NVARCHAR(Max)' ) AS Street1 ,
		Tbl.Col.value( 'Street2[1]', 'NVARCHAR(Max)' ) AS Street2,
		Tbl.Col.value( 'City[1]', 'NVARCHAR(Max)' ) AS City,
		Tbl.Col.value( 'StateCode[1]', 'NVARCHAR(Max)' ) AS StateCode,
		Tbl.Col.value( 'PostalCode[1]', 'NVARCHAR(Max)' ) AS PostalCode,
		Tbl.Col.value( 'Country[1]', 'NVARCHAR(Max)' ) AS Country,
		Tbl.Col.value( 'PhoneNumber[1]', 'NVARCHAR(Max)' ) AS PhoneNumber,
		Tbl.Col.value( 'EmailId[1]', 'NVARCHAR(Max)' ) AS EmailId
	FROM @OrderXML.nodes( '//PlaceOrderModel/BillingAddressModel' ) AS Tbl(Col);
	----Parent line item details insert
	INSERT INTO #TempParentLineItemDetails
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description,Quantity,
		Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber,
		PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles,
		RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy,
		ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity,
		TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty, GroupIdentifier
	)
	SELECT
		CASE WHEN Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemRelationshipTypeId,
		CASE WHEN Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) END  AS OmsOrderDetailsId,
		CASE WHEN Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderShipmentId,
		CASE WHEN Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) END AS RmaReasonForReturnId,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(2000)' ) AS ProductName,
		Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
		Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(Max)' ) AS Quantity,
		CASE WHEN Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) END AS Price,
		Tbl.Col.value( 'Weight[1]', 'NVARCHAR(Max)' ) AS Weight,
		Tbl.Col.value( 'DownloadLink[1]', 'NVARCHAR(Max)' ) AS DownloadLink,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		Tbl.Col.value( 'ShipSeparately[1]', 'NVARCHAR(Max)' ) AS ShipSeparately,
		CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE @GetDate END AS ShipDate,
		CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
		CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
		Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
		Tbl.Col.value( 'TransactionNumber[1]', 'NVARCHAR(Max)' ) AS TransactionNumber,
		CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId,
		Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
		CASE WHEN Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) END AS IsAutoGeneratedTracking,
		CASE WHEN Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemStateId,
		CASE WHEN Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) END AS IsRecurringBilling,
		Tbl.Col.value( 'RecurringBillingPeriod[1]', 'NVARCHAR(Max)' ) AS RecurringBillingPeriod,
		Tbl.Col.value( 'RecurringBillingCycles[1]', 'NVARCHAR(Max)' ) AS RecurringBillingCycles,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingFrequency,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingAmount,
		Tbl.Col.value( 'AppliedPromo[1]', 'NVARCHAR(Max)' ) AS AppliedPromo,
		Tbl.Col.value( 'CouponsApplied[1]', 'NVARCHAR(Max)' ) AS CouponsApplied,
		Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
		CASE WHEN Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) END AS IsActive,
		@UserId AS CreatedBy,
		@GetDate AS CreatedDate,
		@UserId AS ModifiedBy,
		@GetDate AS ModifiedDate,
		Tbl.Col.value( 'AutoAddonSKU[1]', 'NVARCHAR(Max)' ) AutoAddonSKU,
		CASE WHEN Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) END IsShippingReturn,
		CASE WHEN Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) END PartialRefundAmount,
		Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
		Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
		Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
		Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
		Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
		CASE WHEN Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) = ''  THEN NULL ELSE Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) END AS BundleQuantity,
		CASE WHEN Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) END AS TaxRuleId,
		Tbl.Col.value( 'TaxTransactionNumber[1]', 'NVARCHAR(Max)' ) AS TaxTransactionNumber,
		Tbl.Col.value( 'Comments[1]', 'NVARCHAR(Max)' ) AS Comments,
		CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
		CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
		CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
		CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END AS PST,
		CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END  AS HST,
		CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(Max)' ) AS GroupIdentifier
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel' ) AS Tbl(Col);

	----Child line item details insert
	INSERT INTO #TempChildLineItemDetails
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description,Quantity,
		Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber,
		PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles,
		RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy,
		ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity,
		TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty, ParentSku, GroupIdentifier
	)
	SELECT
		CASE WHEN Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemRelationshipTypeId,
		CASE WHEN Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderDetailsId,
		CASE WHEN Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderShipmentId,
		CASE WHEN Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) END AS RmaReasonForReturnId,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(2000)' ) AS ProductName,
		Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
		Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(Max)' ) AS Quantity,
		CASE WHEN Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) END AS Price,
		Tbl.Col.value( 'Weight[1]', 'NVARCHAR(Max)' ) AS Weight,
		Tbl.Col.value( 'DownloadLink[1]', 'NVARCHAR(Max)' ) AS DownloadLink,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		Tbl.Col.value( 'ShipSeparately[1]', 'NVARCHAR(Max)' ) AS ShipSeparately,
		CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE @GetDate END AS ShipDate,
		CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
		CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
		Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
		Tbl.Col.value( 'TransactionNumber[1]', 'NVARCHAR(Max)' ) AS TransactionNumber,
		CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId,
		Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
		CASE WHEN Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) END AS IsAutoGeneratedTracking,
		CASE WHEN Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemStateId,
		CASE WHEN Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) END AS IsRecurringBilling,
		Tbl.Col.value( 'RecurringBillingPeriod[1]', 'NVARCHAR(Max)' ) AS RecurringBillingPeriod,
		Tbl.Col.value( 'RecurringBillingCycles[1]', 'NVARCHAR(Max)' ) AS RecurringBillingCycles,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingFrequency,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingAmount,
		Tbl.Col.value( 'AppliedPromo[1]', 'NVARCHAR(Max)' ) AS AppliedPromo,
		Tbl.Col.value( 'CouponsApplied[1]', 'NVARCHAR(Max)' ) AS CouponsApplied,
		Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
		Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) AS IsActive,
		@UserId AS CreatedBy,
		@GetDate AS CreatedDate,
		@UserId AS ModifiedBy,
		@GetDate AS ModifiedDate,
		Tbl.Col.value( 'AutoAddonSKU[1]', 'NVARCHAR(Max)' ) AutoAddonSKU,
		CASE WHEN Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) END AS IsShippingReturn,
		CASE WHEN Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) END AS  PartialRefundAmount,
		Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
		Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
		Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
		Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
		Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
		CASE WHEN Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) END AS BundleQuantity,
		CASE WHEN Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) END AS TaxRuleId,
		Tbl.Col.value( 'TaxTransactionNumber[1]', 'NVARCHAR(Max)' ) AS TaxTransactionNumber,
		Tbl.Col.value( 'Comments[1]', 'NVARCHAR(Max)' ) AS Comments,
		CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
		CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
		CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
		CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END AS PST,
		CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END AS HST,
		CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE  Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
		Tbl.Col.value( 'ParentProductSKU[1]', 'NVARCHAR(Max)' ) AS ParentSku,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(Max)' ) AS GroupIdentifier
	FROM @OrderXML.nodes('//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/OrderLineItem/PlaceOrderlineItemCollection') AS Tbl(Col);

	--Updating parent for simple products
	UPDATE #TempChildLineItemDetails SET ParentSku = Sku WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdSimple
	AND OrderLineItemRelationshipTypeId IS NOT NULL

BEGIN TRAN OrderInsert

	--Inserting order number which are unique and getting in xml from code side
	INSERT INTO ZnodeOmsOrder(IsQuoteOrder,OrderNumber,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PublishStateId,IsOldOrder)
	OUTPUT INSERTED.OmsOrderId, INSERTED.OrderNumber INTO @OMSOrder
	SELECT 0 AS IsQuoteOrder, OrderNumber,OrderNumber AS ExternalId,@UserId,@GetDate,@UserId,@GetDate,PublishStateId, IsOldOrder
	FROM #TempOrderData
	WHERE ISNULL(OmsOrderId,0) = 0

	--If order is new then creating new order details
	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		INSERT INTO ZnodeOmsOrderDetails
		(
			OmsOrderId,PortalId,UserId,OrderDate,OmsOrderStateId,ShippingId,PaymentTypeId,BillingFirstName,BillingLastName
			,BillingCompanyName,BillingStreet1,BillingStreet2,BillingCity,BillingStateCode,BillingPostalCode,BillingCountry
			,BillingPhoneNumber,BillingEmailId,TaxCost,ShippingCost,SubTotal,DiscountAmount,CurrencyCode,OverDueAmount,Total
			,ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive
			,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
			,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
			,DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
			,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty
		)
		OUTPUT INSERTED.OmsOrderId, INSERTED.OmsOrderDetailsId INTO @OMSOrderDetail
		SELECT OO.OmsOrderId, OD.PortalId,@UserId,@GetDate,OD.OmsOrderStateId,OD.ShippingId,OD.PaymentTypeId,OBA.BillingFirstName,OBA.BillingLastName,OBA.BillingCompanyName,
			OBA.BillingStreet1,OBA.BillingStreet2,OBA.BillingCity,OBA.BillingStateCode,OBA.BillingPostalCode,OBA.BillingCountry,OBA.BillingPhoneNumber,OBA.BillingEmailId,OD.TaxCost,
			OD.ShippingCost,OD.SubTotal, OD.DiscountAmount,OD.CurrencyCode,OD.OverDueAmount,OD.Total
			,OD.ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,OD.BillingAddressId,PoDocument,CAST(1 AS BIT) AS IsActive
			,OD.ExternalId,OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
			,ShippingDifference,EstimateShippingCost,TransactionId,OD.Custom1,OD.Custom2,OD.Custom3,OD.Custom4,OD.Custom5,OD.FirstName,OD.LastName
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
			,OD.DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
			,IsCalculateTaxAfterDiscount,Email,OD.PhoneNumber,OrderTotalWithoutVoucher,ImportDuty
		FROM #TempOrderData OD
		INNER JOIN @OMSOrder OO ON OD.OrderNumber = OO.OrderNumber
		LEFT JOIN #TempOrderBillingAddress OBA ON OD.BillingAddressId = OBA.AddressId

	END
	--If order managed then creating new order details and disable old order details
	ELSE
	BEGIN
		Declare @OldOmsOrderDetailsId INT
		SET @OldOmsOrderDetailsId = (SELECT TOP 1 OOD.OmsOrderDetailsId FROM ZnodeOmsOrderDetails OOD  WITH (NOLOCK) 
									 WHERE EXISTS(SELECT * FROM  #TempOrderData OD WHERE OOD.OmsOrderId = OD.OmsOrderId) AND OOD.IsActive = 1)

		INSERT INTO ZnodeOmsOrderDetails
		(
			OmsOrderId,PortalId,UserId,OrderDate,OmsOrderStateId,ShippingId,PaymentTypeId,BillingFirstName,BillingLastName --1
			,BillingCompanyName,BillingStreet1,BillingStreet2,BillingCity,BillingStateCode,BillingPostalCode,BillingCountry --2
			,BillingPhoneNumber,BillingEmailId,TaxCost,ShippingCost,SubTotal,DiscountAmount,CurrencyCode,OverDueAmount,Total --3
			,ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId --4
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive --5
			,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited --6
			,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName --7
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName, --8
			PaymentExternalId,CultureCode, --9
			DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges --10
			,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty --11 
		)
		OUTPUT INSERTED.OmsOrderId, INSERTED.OmsOrderDetailsId INTO @OMSOrderDetail
		SELECT OO.OmsOrderId, OD.PortalId,@UserId,@GetDate,OD.OmsOrderStateId,OD.ShippingId,OD.PaymentTypeId,OBA.BillingFirstName,OBA.BillingLastName,--1
			OBA.BillingCompanyName,OBA.BillingStreet1,OBA.BillingStreet2,OBA.BillingCity,OBA.BillingStateCode,OBA.BillingPostalCode,OBA.BillingCountry, --2
			OBA.BillingPhoneNumber,OBA.BillingEmailId,OD.TaxCost,OD.ShippingCost,OD.SubTotal, OD.DiscountAmount,OD.CurrencyCode,OD.OverDueAmount,OD.Total, --3
			OD.ShippingNumber,OD.TrackingNumber,OD.CouponCode,OD.PromoDescription,OD.ReferralUserId,OD.PurchaseOrderNumber,OD.OmsPaymentStateId, --4
			OD.WebServiceDownloadDate,OD.PaymentSettingId,OD.PaymentTransactionToken,OD.ShipDate,OD.ReturnDate,OD.BillingAddressId,OD.PoDocument,CAST(1 AS BIT) AS IsActive --5
			,OD.ExternalId,OD.CreatedBy,OOD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.CreditCardNumber,OD.IsShippingCostEdited,OD.IsTaxCostEdited, --6
			OD.ShippingDifference,OD.EstimateShippingCost,OD.TransactionId,OD.Custom1,OD.Custom2,OD.Custom3,OD.Custom4,OD.Custom5,OD.FirstName,OD.LastName, --7
			OD.CardType,OD.CreditCardExpMonth,OD.CreditCardExpYear,OD.TotalAdditionalCost,CASE WHEN OD.PaymentSettingId = OOD.PaymentSettingId THEN OOD.PaymentDisplayName ELSE OD.PaymentDisplayName END AS PaymentDisplayName, --8
			CASE WHEN OD.PaymentSettingId = OOD.PaymentSettingId THEN OOD.PaymentExternalId ELSE OD.PaymentExternalId END AS PaymentExternalId,OD.CultureCode, --9 
			OD.DisplayName,OD.InHandDate,OD.IpAddress,OD.JobName,OD.ShippingConstraintCode,OD.ShippingDiscount,OD.ShippingHandlingCharges,OD.ReturnCharges, --10
			OD.IsCalculateTaxAfterDiscount,OD.Email,OD.PhoneNumber,OD.OrderTotalWithoutVoucher,OD.ImportDuty --11
		FROM #TempOrderData OD
		INNER JOIN ZnodeOmsOrder OO WITH (NOLOCK) ON OD.OrderNumber = OO.OrderNumber
		INNER JOIN ZnodeOmsOrderDetails OOD  WITH (NOLOCK) ON OO.OmsOrderId = OOD.OmsOrderId AND OOD.IsActive = 1
		LEFT JOIN #TempOrderBillingAddress OBA ON OD.BillingAddressId = OBA.AddressId
	
		DECLARE @OmsOrderStateIdCancelled int =  (select top 1 OmsOrderStateId FROM ZnodeOmsOrderState WHERE OrderStateName = 'CANCELLED')

		UPDATE ZnodeOmsOrderDetails SET IsActive = 0 , OmsOrderStateId = @OmsOrderStateIdCancelled
		WHERE OmsOrderDetailsId = @OldOmsOrderDetailsId

		UPDATE ZnodeOmsOrderLineItems SET IsActive = 0
		WHERE OmsOrderDetailsId = @OldOmsOrderDetailsId
	END

	----Geting new OmsOrderDetailsId always
	Declare @OmsOrderDetailsId INT
	SET @OmsOrderDetailsId = ( SELECT TOP 1 OmsOrderDetailsId FROM @OMSOrderDetail )

	--Insert Order notes only for new order details
	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		INSERT INTO ZnodeOmsNotes(OmsOrderDetailsId,Notes,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
		SELECT @OmsOrderDetailsId,Tbl.Col.value( 'AdditionalInstructions[1]', 'NVARCHAR(Max)' ) AS Notes,
			@UserId,@GetDate,@UserId,@GetDate
		FROM @OrderXML.nodes( '//PlaceOrderModel' ) AS Tbl(Col)
		WHERE Tbl.Col.value( 'AdditionalInstructions[1]', 'NVARCHAR(Max)' ) <> '';
	END

	----Inserting parent line item data
	INSERT INTO ZnodeOmsOrderLineItems
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description --1
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber --2
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles --3
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy --4
		,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, GroupIdentifier --5
	)
	OUTPUT INSERTED.OmsOrderDetailsId, INSERTED.OmsOrderLineItemsId, INSERTED.Sku,INSERTED.ParentOmsOrderLineItemsId, INSERTED.GroupId, INSERTED.OrderLineItemRelationshipTypeId,INSERTED.GroupIdentifier INTO @OmsParentOrderLineItems
	SELECT OrderLineItemRelationshipTypeId,@OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description--1
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber --2
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles --3
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,ISNULL(IsActive,1) AS IsActive,CreatedBy,CreatedDate,ModifiedBy --4
		,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, GroupIdentifier --5
	FROM #TempParentLineItemDetails PLID

	----Inserting child line item data
	INSERT INTO ZnodeOmsOrderLineItems
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description --1
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber --2
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles --3
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy --4
		,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, --5
		ParentSku, GroupIdentifier --6
	)
	OUTPUT INSERTED.OmsOrderDetailsId, INSERTED.OmsOrderLineItemsId, INSERTED.Sku,INSERTED.ParentOmsOrderLineItemsId, INSERTED.GroupId, INSERTED.OrderLineItemRelationshipTypeId, INSERTED.ParentSku, INSERTED.GroupIdentifier INTO @OmsOrderLineItems
	SELECT PLID.OrderLineItemRelationshipTypeId,@OmsOrderDetailsId,PLID.OmsOrderShipmentId,PLID.RmaReasonForReturnId,PLID.Sku,PLID.ProductName,PLID.Description, --1
		PLID.Quantity,PLID.Price,PLID.Weight,PLID.DownloadLink,PLID.DiscountAmount,PLID.ShipSeparately,PLID.ShipDate,PLID.ReturnDate,PLID.ShippingCost,PLID.PromoDescription,PLID.TransactionNumber, --2
		PLID.PaymentStatusId,PLID.TrackingNumber,PLID.IsAutoGeneratedTracking,PLID.OrderLineItemStateId,PLID.IsRecurringBilling,PLID.RecurringBillingPeriod,PLID.RecurringBillingCycles,--3
		PLID.RecurringBillingFrequency,PLID.RecurringBillingAmount,PLID.AppliedPromo,PLID.CouponsApplied,PLID.ExternalId,isnull(PLID.IsActive,1) AS IsActive,PLID.CreatedBy,PLID.CreatedDate,PLID.ModifiedBy, --4
		PLID.ModifiedDate,PLID.AutoAddonSKU,PLID.IsShippingReturn,PLID.PartialRefundAmount,PLID.Custom1,PLID.Custom2,PLID.Custom3,PLID.Custom4,PLID.Custom5,PLID.GroupId,PLID.BundleQuantity, --5
		case when PLID.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdSimple then PLID.Sku else PLID.ParentSku end AS ParentSku, GroupIdentifier --6
	FROM #TempChildLineItemDetails PLID

	--Updating ParentOmsOrderLineItemsId for child line items for simple, group and configurable products
	UPDATE A SET A.ParentOmsOrderLineItemsId = (SELECT TOP 1 OmsOrderLineItemsId FROM @OmsParentOrderLineItems d WHERE d.GroupIdentifier = a.GroupIdentifier AND A.ParentSku = D.Sku  and ISNULL(a.GroupId,'-') = ISNULL(d.GroupId,'-'))
	FROM @OmsOrderLineItems a
	WHERE a.OrderLineItemRelationshipTypeId NOT IN ( @OrderLineItemRelationshipTypeIdAddon, @OrderLineItemRelationshipTypeIdGroup)  
	AND a.ParentOmsOrderLineItemsId IS NULL 
	
	--Updating ParentOmsOrderLineItemsId for child line items for group products
	IF EXISTS(SELECT * FROM @OmsOrderLineItems WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdGroup)
	BEGIN
		---Getting child lineitems for group product
		;WITH Cte_GroupProductChild AS
		(
			SELECT GroupIdentifier,Sku, ParentSku, OmsOrderLineItemsId, ParentOmsOrderLineItemsId,Dense_Rank()Over(Partition By GroupIdentifier ORDER BY OmsOrderLineItemsId) AS RowId1 
			FROM @OmsOrderLineItems
			WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdGroup
		)
		---Getting parent lineitems for group product
		,Cte_GroupProductParent AS 
		(
			SELECT GroupIdentifier,Sku, OmsOrderLineItemsId, Dense_Rank()Over(Partition By GroupIdentifier ORDER BY OmsOrderLineItemsId) AS RowId1 
			FROM @OmsParentOrderLineItems a
			WHERE OrderLineItemRelationshipTypeId IS NULL
			AND EXISTS(SELECT * FROM @OmsOrderLineItems b WHERE a.GroupIdentifier = b.GroupIdentifier AND a.Sku = b.ParentSku)
		)
		--Updating ParentOmsOrderLineItemsId on child for group products
		UPDATE a SET a.ParentOmsOrderLineItemsId = b.OmsOrderLineItemsId
		FROM Cte_GroupProductChild a
		INNER JOIN Cte_GroupProductParent B ON A.GroupIdentifier = B.GroupIdentifier AND a.RowId1 = b.RowId1 AND b.Sku = a.ParentSku 
	END

	---Updating ParentOmsOrderLineItemsId for addons if present
	IF EXISTS(SELECT * FROM @OmsOrderLineItems WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
	BEGIN
		--Updating ParentOmsOrderLineItemsId for addon with Simple products , group products and configurable products
		UPDATE b SET b.ParentOmsOrderLineItemsId = c.OmsOrderLineItemsId
		FROM @OmsOrderLineItems c
		INNER JOIN @OmsOrderLineItems b on b.ParentSku = c.Sku AND c.GroupIdentifier = b.GroupIdentifier
		WHERE c.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon and c.OrderLineItemRelationshipTypeId is not null
		and b.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
		AND b.ParentOmsOrderLineItemsId IS NULL
		
		--Updating ParentOmsOrderLineItemsId for addon with bundle products
		UPDATE c SET c.ParentOmsOrderLineItemsId = b.OmsOrderLineItemsId
		FROM @OmsOrderLineItems c
		INNER JOIN @OmsParentOrderLineItems b on B.sku = C.parentsku AND c.GroupIdentifier= b.GroupIdentifier
		WHERE B.OrderLineItemRelationshipTypeId is null 
		AND c.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
		AND C.ParentOmsOrderLineItemsId IS NULL
	 END
	 ---Updating ParentOmsOrderLineItemsId in main table
	 UPDATE a SET a.ParentOmsOrderLineItemsId = b.ParentOmsOrderLineItemsId
	 FROM  ZnodeOmsOrderLineItems a
	 INNER JOIN @OmsOrderLineItems b on a.OmsOrderLineItemsId = b.OmsOrderLineItemsId

	----Shipping details Start
	DECLARE @ShippingTypeId INT
	IF EXISTS(SELECT * FROM #TempOrderData WHERE ShippingTypeId IS NULL)
	BEGIN
		SET @ShippingTypeId = (SELECT TOP 1 ShippingTypeId FROM ZnodeShipping WHERE EXISTS(SELECT * FROM #TempOrderData WHERE ZnodeShipping.ShippingId = #TempOrderData.ShippingId))
	END
	ELSE
	BEGIN
		SET @ShippingTypeId = (SELECT TOP 1 ShippingTypeId FROM #TempOrderData)
	END
	IF EXISTS(SELECT * FROM ZnodeShippingTypes WITH (NOLOCK)  WHERE ShippingTypeId = @ShippingTypeId AND ClassName = 'ZnodeCustomerShipping')
	BEGIN
		INSERT INTO ZnodeOmsCustomerShipping(OmsOrderDetailsId,UserId,ShippingTypeId,AccountNumber,ShippingMethod,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT TOP 1 @OmsOrderDetailsId,@UserId,@ShippingTypeId,AccountNumber,ShippingMethod,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		FROM #TempOrderData
	END
	----Shipping details end

	----Order tax details start
	----Inserting order tax data
	IF (SELECT TOP 1 TaxCost FROM #TempOrderData) > 0
	BEGIN
		INSERT INTO ZnodeOmsTaxOrderDetails(OmsOrderDetailsId,SalesTax,VAT,GST,PST,HST,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportDuty)
		SELECT @OmsOrderDetailsId,OD.SalesTax,OD.VAT,OD.GST,OD.PST,OD.HST,OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.ImportDuty
		FROM #TempOrderData OD
	END

	----Inserting order tax data for parent line item
	INSERT INTO ZnodeOmsTaxOrderLineDetails
	(
		OmsOrderLineItemsId,TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty,
		CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
	)
	SELECT POLI.OmsOrderLineItemsId,CLID.TaxRuleId,CLID.TaxTransactionNumber,CLID.Comments,CLID.SalesTax,CLID.VAT,CLID.GST,CLID.PST,CLID.HST,CLID.ImportDuty,
	CLID.CreatedBy,CLID.CreatedDate,CLID.ModifiedBy,CLID.ModifiedDate
	FROM #TempParentLineItemDetails CLID
	INNER JOIN @OmsParentOrderLineItems POLI ON CLID.Sku = POLI.Sku AND ISNULL(CLID.GroupId,'') = ISNULL(POLI.GroupId,'') AND CLID.GroupIdentifier = POLI.GroupIdentifier
	WHERE POLI.ParentOmsOrderLineItemsId IS NULL
	AND (ISNULL(CLID.SalesTax,0)+ISNULL(CLID.VAT,0)+ISNULL(CLID.GST,0)+ISNULL(CLID.PST,0)+ISNULL(CLID.HST,0)) > 0

	----Inserting order tax data for child line item
	INSERT INTO ZnodeOmsTaxOrderLineDetails
	(
		OmsOrderLineItemsId,TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty,
		CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
	)
	SELECT POLI.OmsOrderLineItemsId,CLID.TaxRuleId,CLID.TaxTransactionNumber,CLID.Comments,CLID.SalesTax,CLID.VAT,CLID.GST,CLID.PST,CLID.HST,CLID.ImportDuty,
		CLID.CreatedBy,CLID.CreatedDate,CLID.ModifiedBy,CLID.ModifiedDate
	FROM #TempChildLineItemDetails CLID
	INNER JOIN @OmsOrderLineItems POLI ON CLID.Sku = POLI.Sku AND ISNULL(CLID.GroupId,'') = ISNULL(POLI.GroupId,'') AND CLID.GroupIdentifier = POLI.GroupIdentifier
	WHERE POLI.ParentOmsOrderLineItemsId IS NOT NULL
	AND (ISNULL(CLID.SalesTax,0)+ISNULL(CLID.VAT,0)+ISNULL(CLID.GST,0)+ISNULL(CLID.PST,0)+ISNULL(CLID.HST,0)) > 0
	----Order tax details end

	----Order attribte details start
	----Fetching order attributes FROM xml
	INSERT INTO #TempOrderAttribute(AttributeCode ,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AttributeValueCode,Sku,GroupId, GroupIdentifier )
	SELECT
		Tbl.Col.value( 'AttributeCode[1]', 'NVARCHAR(Max)' ) AS AttributeCode,
		Tbl.Col.value( 'AttributeValue[1]', 'NVARCHAR(Max)' ) AS AttributeValue,
		@UserId,@GetDate,@UserId,@GetDate,
		Tbl.Col.value( 'AttributeValueCode[1]', 'NVARCHAR(2000)' ) AS AttributeValueCode,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(2000)' ) AS GroupIdentifier
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/OrderLineItem/PlaceOrderlineItemCollection/OrderAttribute/PlaceOrderAttributeModel' ) AS Tbl(Col);

	----Inserting order attributes data
	INSERT INTO ZnodeOmsOrderAttribute(OmsOrderLineItemsId,AttributeCode,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AttributeValueCode)
	SELECT POLI.OmsOrderLineItemsId, OA.AttributeCode,OA.AttributeValue,OA.CreatedBy,OA.CreatedDate,OA.ModifiedBy,OA.CreatedDate,OA.AttributeValueCode
	FROM #TempOrderAttribute OA
	INNER JOIN @OmsOrderLineItems POLI ON OA.Sku = POLI.Sku AND ISNULL(OA.GroupId,'') = ISNULL(POLI.GroupId,'') AND OA.GroupIdentifier = POLI.GroupIdentifier
	----Order attribte details end

	----Personalise details start
	----Fetching personalize order data
	INSERT INTO #OmsPersonalizeItem(PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL,Sku,GroupId, GroupIdentifier)
	SELECT
		Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode,
		Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue,
		@UserId,@GetDate,@UserId,@GetDate,
		Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(2000)' ) AS DesignId,
		Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(2000)' ) AS ThumbnailURL,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(2000)' ) AS GroupIdentifier
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/PersonaliseDetails/PlaceOrderPersonaliseModel' ) AS Tbl(Col);

	--Inserting personalize order data
	INSERT INTO ZnodeOmsPersonalizeItem(OmsOrderLineItemsId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL)
	SELECT OmsOrderLineItemsId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL
	FROM #OmsPersonalizeItem OPI
	INNER JOIN @OmsParentOrderLineItems POLI ON OPI.Sku = POLI.Sku AND ISNULL(OPI.GroupId,'') = ISNULL(POLI.GroupId,'') AND OPI.GroupIdentifier = POLI.GroupIdentifier
	WHERE POLI.ParentOmsOrderLineItemsId IS NULL
	----Personalise details end

	----discount details start
	----Fetching order discount data
	INSERT INTO #OmsOrderDiscount
	(
		OmsDiscountTypeId ,DiscountCode,DiscountAmount ,Description ,CreatedBy ,CreatedDate ,
		ModifiedBy ,ModifiedDate ,PerQuantityDiscount,DiscountMultiplier ,DiscountLevelTypeId ,
		PromotionName ,PromotionTypeId ,DiscountAppliedSequence,PromotionMessage ,Sku,GroupId 
	)
	SELECT
	CASE WHEN Tbl.Col.value( 'OmsDiscountTypeId[1]', 'NVARCHAR(2000)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OmsDiscountTypeId[1]', 'NVARCHAR(2000)' ) END AS OmsDiscountTypeId,
		Tbl.Col.value( 'DiscountCode[1]', 'NVARCHAR(Max)' ) AS DiscountCode,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
		@UserId,@GetDate,@UserId,@GetDate,
		CASE WHEN Tbl.Col.value( 'PerQuantityDiscount[1]', 'NVARCHAR(2000)' )='' THEN NULL ELSE Tbl.Col.value( 'PerQuantityDiscount[1]', 'NVARCHAR(2000)' ) END AS PerQuantityDiscount,
		CASE WHEN Tbl.Col.value( 'DiscountMultiplier[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountMultiplier[1]', 'NVARCHAR(2000)' ) END AS DiscountMultiplier,
		CASE WHEN Tbl.Col.value( 'DiscountLevelTypeId[1]', 'NVARCHAR(2000)' )= '' THEN NULL ELSE Tbl.Col.value( 'DiscountLevelTypeId[1]', 'NVARCHAR(2000)' ) END AS DiscountLevelTypeId,
		Tbl.Col.value( 'PromotionName[1]', 'NVARCHAR(2000)' ) AS PromotionName,
		CASE WHEN Tbl.Col.value( 'PromotionTypeId[1]', 'NVARCHAR(2000)' )= '' THEN NULL ELSE Tbl.Col.value( 'PromotionTypeId[1]', 'NVARCHAR(2000)' ) END AS PromotionTypeId,
		Tbl.Col.value( 'DiscountAppliedSequence[1]', 'NVARCHAR(2000)' ) AS DiscountAppliedSequence,
		Tbl.Col.value( 'PromotionMessage[1]', 'NVARCHAR(2000)' ) AS PromotionMessage,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId
	FROM @OrderXML.nodes('//PlaceOrderModel/OrderDiscounts/PlaceOrderDiscountModel') AS Tbl(Col)

	----Inserting order discount data
	--Inserting product level discount for simple and group products
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,POLI.OmsOrderLineItemsId,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
		OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,POLI.ParentOmsOrderLineItemsId,
		OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	INNER JOIN @OmsOrderLineItems POLI ON OD.Sku = POLI.Sku AND ISNULL(OD.GroupId,'') = ISNULL(POLI.GroupId,'') 
	WHERE isnull(OD.Sku,'') <> '' AND POLI.OrderLineItemRelationshipTypeId IN (@OrderLineItemRelationshipTypeIdSimple , @OrderLineItemRelationshipTypeIdGroup)
	
	--Inserting product level discount for config and bundle products
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,POLI.ParentOmsOrderLineItemsId,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
	OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,NULL,
	OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	INNER JOIN @OmsOrderLineItems POLI ON OD.Sku = POLI.ParentSku AND ISNULL(OD.GroupId,'') = ISNULL(POLI.GroupId,'')
	WHERE isnull(OD.Sku,'') <> '' AND POLI.OrderLineItemRelationshipTypeId IN (@OrderLineItemRelationshipTypeIdBundles , @OrderLineItemRelationshipTypeIdConfig)
	
	--Inserting order level discount 
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,NULL,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
	OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,NULL,
	OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	WHERE isnull(OD.Sku,'') = ''
	----discount details end

	----Additional Cost details start
	IF OBJECT_ID('TEMPDB..#TempAdditionalCost') IS NOT NULL
	DROP TABLE #TempAdditionalCost
	--fetching additional cost details
	SELECT Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl1.Col.value( 'KeyName[1]', 'NVARCHAR(2000)' ) AS KeyName,
		CASE WHEN Tbl1.Col.value( 'KeyValue[1]', 'NVARCHAR(2000)' )='' THEN NULL ELSE Tbl1.Col.value( 'KeyValue[1]', 'NVARCHAR(2000)' ) END AS KeyValue,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId
	INTO #TempAdditionalCost
	FROM @OrderXML.nodes('//PlaceOrderModel/LineItems/PlaceOrderLineItemModel') AS Tbl(Col)
	CROSS APPLY Tbl.Col.nodes( '*:AdditionalCostList/AdditionalCost' ) AS Tbl1(Col);

	--Inserting additional cost details
	IF EXISTS(SELECT * FROM #TempAdditionalCost)
	BEGIN
		INSERT INTO ZnodeOmsOrderLineItemsAdditionalCost(OmsOrderLineItemsId,KeyName,KeyValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT OLI.OmsOrderLineItemsId, AC.KeyName, AC.KeyValue, @UserId, @GetDate, @UserId, @GetDate
		FROM #TempAdditionalCost AC
		INNER JOIN @OmsOrderLineItems OLI ON AC.Sku = OLI.Sku AND ISNULL(AC.GroupId,'') = ISNULL(OLI.GroupId,'') 
		WHERE OLI.ParentOmsOrderLineItemsId IS NULL
		AND ISNULL(AC.KeyName,'') <> ''
	END
	----Additional Cost details end
	
	DECLARE @OmsOrderId INT
	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		SET @OmsOrderId = (SELECT TOP 1 OmsOrderId FROM @OMSOrder)
	END
	ELSE
	BEGIN 
		SET @OmsOrderId = (SELECT TOP 1 OmsOrderId FROM #TempOrderData)
	END
	----RMA details start
	IF (SELECT TOP 1 OmsOrderId FROM #TempOrderData) > 0
	BEGIN
		DECLARE @OldOmsOrderDetailID INT
		SET @OmsOrderID = (SELECT TOP 1 OmsOrderId FROM #TempOrderData)
		SET @OldOmsOrderDetailID = (SELECT TOP 1 OmsOrderDetailsId FROM ZnodeOmsOrderDetails WHERE OmsOrderId = @OmsOrderID AND OmsOrderDetailsId <> @OmsOrderDetailsId ORDER BY OmsOrderDetailsId DESC)

		UPDATE ZnodeRmaReturnDetails
		SET OmsOrderDetailsId = @OmsOrderDetailsId
		WHERE OmsOrderId = @OmsOrderID

		SELECT OOLI.OmsOrderLineItemsId AS OldOmsOrderLineItemsId, OOLI.OmsOrderDetailsId, OOLI.Sku, LI.OmsOrderLineItemsId AS NewOmsOrderLineItemsId
		INTO #OldOrderLineItems
		FROM ZnodeOmsOrderLineItems OOLI WITH (NOLOCK)
		INNER JOIN @OmsOrderLineItems LI ON LI.Sku = OOLI.Sku
		WHERE OOLI.OmsOrderDetailsId = @OldOmsOrderDetailID --AND OOLI.ParentOmsOrderLineItemsId IS NULL
 
		UPDATE RRLI SET RRLI.OmsOrderLineItemsId = OldLI.NewOmsOrderLineItemsId
		FROM ZnodeRmaReturnLineItems RRLI
		INNER JOIN #OldOrderLineItems OldLI ON RRLI.OmsOrderLineItemsId = OldOmsOrderLineItemsId
	END
	----RMA details end
	
	---Inserting OrderTaxDetails
	IF(NOT EXISTS(SELECT 1 from ZnodeOmsTaxRule where OmsOrderId= @OmsOrderId)) AND (SELECT TOP 1 TaxCost FROM #TempOrderData) > 0
	BEGIN
		DECLARE @TaxRate Numeric(28,6), @TaxRuleId INT
		SET @TaxRate = (SELECT TOP 1 TaxRate FROM #TempOrderData)
		SET @TaxRuleId = (SELECT TOP 1 TaxRuleId FROM #TempChildLineItemDetails)

		 EXEC [Znode_InsertOrderTaxDetails] @OmsOrderId = @OmsOrderId, @TaxRuleId = @TaxRuleId, @TaxRate = @TaxRate, @Status = 0
	END

	COMMIT TRAN OrderInsert

	SELECT TOP 1 OmsOrderId,@OmsOrderDetailsId AS OmsOrderDetailsId, cast(1 AS bit)  AS Status, '' AS ErrorMessage
	FROM @OMSOrderDetail

END TRY
BEGIN CATCH
	ROLLBACK TRAN OrderInsert
	SELECT TOP 1 0 AS OmsOrderId,0 AS OmsOrderDetailsId, cast(0 AS bit)  AS Status, ERROR_MESSAGE() AS ErrorMessage

	INSERT INTO ZnodeOmsFailedOrderPayments(PaymentCode,PaymentDisplayName,TransactionToken,TotalAmount,UserName,UserId,Email,PaymentSettingId,OrderNumber,OrderDate,PaymentStatusId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
	SELECT TOP 1 PaymentCode,PaymentDisplayName, isnull(PaymentTransactionToken,''),Total,a.FirstName+' '+a.LastName,@UserId,a.Email,a.PaymentSettingId,a.OrderNumber,@GetDate,PaymentStatusId,@UserId,@GetDate,@UserId,@GetDate
	FROM #TempOrderData A
	
	DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertUpdateOmsOrder @OrderXML ='+CAST(@OrderXML AS VARCHAR(MAX))+' , @UserId = '+CAST(@UserId AS VARCHAR(50));

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName    = 'Znode_InsertUpdateOmsOrder',
	@ErrorInProcedure = @ERROR_PROCEDURE,
	@ErrorMessage     = @ErrorMessage,
	@ErrorLine        = @ErrorLine,
	@ErrorCall        = @ErrorCall;
	--If error throw in SP the deleting records FROM order tables if data inserted
	EXEC Znode_DeleteOrderById @OrderDetailId=@OmsOrderDetailsId,@Status=0
END CATCH

END

GO
IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_UpdateInventoryPostOrder')
	DROP PROC Znode_UpdateInventoryPostOrder
GO

CREATE PROCEDURE [dbo].[Znode_UpdateInventoryPostOrder]
(
	@SkuXml xml,
	@PortalId int, 
	@UserId int, 
	@Status bit OUT, 
	@OmsOrderId INT,
	@IsDebug bit= 0
)
AS 
	/*
	Summary: (13671)   Inventory will be updated on the basis of "InventoryTracking" (Attribute Code) value in locale table 
				    If value id "DisablePurchasing" then subtracts currently selected quantity only when it will greater than zero.
				    If "AllowBackordering" then inventory will become negative
				    If "DontTrackInventory" then don't update inventory.
				    inventory will be get deducted from associated warehouse where quantity is available as per warehouse precedence. 
				    Validate total quantity 
	Input Parameters:
	SKU(Comma separated multiple), PortalId
	Unit Testing   
		Declare @Status bit 
		Exec Znode_UpdateInventory  @SkuXml = '<ArrayOfOrderWarehouseLineItemsModel>
		<OrderWarehouseLineItemsModel>
		<OrderLineItemId>418</OrderLineItemId>
		<SKU>ap1534</SKU>
		<InventoryTracking>DisablePurchasing</InventoryTracking>
		<Quantity>1.000000</Quantity>
		</OrderWarehouseLineItemsModel>
		<OrderWarehouseLineItemsModel>
		<OrderLineItemId>419</OrderLineItemId>
		<SKU>al8907</SKU>
		<InventoryTracking>DisablePurchasing</InventoryTracking>
		<Quantity>1.000000</Quantity>
		</OrderWarehouseLineItemsModel>
		</ArrayOfOrderWarehouseLineItemsModel>',@PortalId = 1,@UserId = 2,@Status = @Status

	*/
BEGIN
	BEGIN TRAN UpdateInventory;
	BEGIN TRY
		SET NOCOUNT ON;
		DECLARE @RoundOffValue INT= dbo.Fn_GetDefaultValue('InventoryRoundOff');
		DECLARE @TBL_XmlReturnToTable TABLE
		( 
			OrderLineItemId int, SKU nvarchar(max), InventoryTracking nvarchar(1000), Quantity numeric(28, 6),
			AllowBackOrder VARCHAR(100), SequenceNo int IDENTITY, OrderLineItemRelationshipTypeId int 
		);
		DECLARE @TBL_ErrorInventoryTracking TABLE
		( 
			SKU nvarchar(max), Quantity numeric(28, 6), InventoryTracking nvarchar(2000), AllowBackOrder varchar(100)
		);
		INSERT INTO @TBL_XmlReturnToTable( OrderLineItemId, SKU, InventoryTracking, Quantity,AllowBackOrder )
		SELECT Tbl.Col.value( 'OrderLineItemId[1]', 'INT' ) AS OrderLineItemId, Tbl.Col.value( 'SKU[1]', 'NVARCHAR(2000)' ) AS SKU, Tbl.Col.value( 'InventoryTracking[1]', 'NVARCHAR(2000)' ) AS InventoryTracking, Tbl.Col.value( 'Quantity[1]', 'Numeric(28,6)' ) AS Quantity
		, Tbl.Col.value( 'AllowBackOrder[1]', 'VARCHAR(100)' ) AS AllowBackOrder
		FROM @SkuXml.nodes( '//ArrayOfOrderWarehouseLineItemsModel/OrderWarehouseLineItemsModel' ) AS Tbl(Col)
		WHERE Tbl.Col.value( 'InventoryTracking[1]', 'NVARCHAR(2000)' ) <> 'DontTrackInventory' 
		AND Tbl.Col.value( 'Quantity[1]', 'Numeric(28,6)' ) > 0;

		DECLARE @Cur_WarehouseId int, @Cur_PortalId int, @Cur_PortalWarehouseId int, @Cur_WarehouseSequence int, @Cur_SKU varchar(200), @Cur_Quantity numeric(28, 6), @Cur_ReOrderLevel numeric(28, 6), @Cur_InventoryId int;

		DECLARE @RecurringQuantity numeric(28, 6), @BalanceQuantity numeric(28, 6)
		SET @Status = 0; 

		---Updating order line item
		UPDATE TBL SET OrderLineItemId = ZOOLI.OmsOrderLineItemsId, TBL.OrderLineItemRelationshipTypeId = ZOOLI.OrderLineItemRelationshipTypeId 
		FROM ZnodeOmsOrderLineItems ZOOLI WITH (NOLOCK)
		INNER JOIN @TBL_XmlReturnToTable TBL ON ZOOLI.Sku = TBL.SKU
		WHERE EXISTS(SELECT * FROM ZnodeOmsOrderDetails ZOOD WITH (NOLOCK) WHERE ZOOLI.OmsOrderDetailsId = ZOOD.OmsOrderDetailsId AND ZOOD.OmsOrderId = @OmsOrderId)
		AND ZOOLI.ParentOmsOrderLineItemsId IS NOT NULL

		DECLARE @TBL_CalculateQuntity TABLE
		( 
			WarehouseId int, SKU varchar(200), MainQuantity numeric(28, 6), InventoryId int, OrderQuantity numeric(28, 6), UpdatedQuantity numeric(28, 6), WarehouseSequenceId int, InventoryTracking nvarchar(2000)
			, AllowBackOrder varchar(100)
		);
		
		DECLARE @TBL_AllwareHouseToportal TABLE
		( 
			WarehouseId int, PortalId int, PortalWarehouseId int, WarehouseSequenceFirst int, WarehouseSequence int, SKU varchar(200), Quantity numeric(28, 6), ReOrderLevel numeric(28, 6), InventoryId int
		);
		
		SELECT WarehouseId, PortalId, PortalWarehouseId, Precedence
		INTO #PortalWarehouse
		FROM [ZnodePortalWarehouse] WITH (NOLOCK)
		WHERE PortalId = @PortalId
		UNION 
		SELECT WarehouseId, @PortalId AS PortalId, PortalWarehouseId, Precedence
		FROM [dbo].[ZnodePortalAlternateWarehouse] AS zpaw WITH (NOLOCK)
		WHERE EXISTS ( SELECT TOP 1 1 FROM [ZnodePortalWarehouse] AS a WHERE zpaw.PortalWarehouseId = a.PortalWarehouseId AND  a.PortalId = @PortalId)  
		
		INSERT INTO @TBL_AllwareHouseToportal( WarehouseId, PortalId, PortalWarehouseId, SKU, Quantity, ReOrderLevel, InventoryId, WarehouseSequence, WarehouseSequenceFirst )
		SELECT ZPW.WarehouseId, ZPW.PortalId, zpw.PortalWarehouseId, zi.SKU, zi.Quantity, zi.ReOrderLevel, zi.InventoryId, DENSE_RANK() OVER(ORDER BY ZPW.WarehouseId), 1
		FROM dbo.ZnodeInventory AS zi WITH (NOLOCK)
		LEFT JOIN #PortalWarehouse AS ZPW ON ZPW.WarehouseId = ZI.WareHouseId AND  ZPW.PortalId = @PortalId
		WHERE EXISTS ( SELECT TOP 1 1  FROM @TBL_XmlReturnToTable AS TBXRT WHERE RTRIM(LTRIM(TBXRT.SKU)) = RTRIM(LTRIM(zi.SKU))) 
		AND ZPW.WarehouseId IS NOT NULL
		ORDER BY ZPW.Precedence DESC

		--Total Avaialble qunatity in all warehouse 
		IF EXISTS ( SELECT TOP 1 1 FROM @TBL_XmlReturnToTable WHERE InventoryTracking = 'DisablePurchasing')
		BEGIN
			INSERT INTO @TBL_ErrorInventoryTracking 
			SELECT TBAHL.SKU, SUM(TBAHL.Quantity), InventoryTracking,TBXML.AllowBackOrder 
			FROM @TBL_XmlReturnToTable AS TBXML
			LEFT JOIN @TBL_AllwareHouseToportal AS TBAHL ON(TBAHL.SKU = TBXML.SKU) 
			INNER JOIN ZnodeOmsOrderLineItems b on (TBXML.orderlineitemid = b.OmsOrderLineItemsId)
			WHERE InventoryTracking = 'DisablePurchasing'
			AND b.OrderLineItemRelationshipTypeId IS NOT NULL
			GROUP BY TBXML.AllowBackOrder ,TBAHL.SKU, InventoryTracking HAVING SUM(TBAHL.Quantity) < 1 ORDER BY TBAHL.SKU;
			IF EXISTS ( SELECT TOP 1 1 FROM @TBL_ErrorInventoryTracking )
			BEGIN
				SET @Status = 0;
				RAISERROR(15600, -1, -1, 'DisablePurchasing');
			END;
		END;

		---Getting data for simple , configurable and group
		INSERT INTO @TBL_CalculateQuntity
		SELECT WarehouseId, TBXML.SKU, TBAHL.Quantity, TBAHL.InventoryId, TBXML.Quantity, NULL AS UpdatedQuantity, DENSE_RANK() 
		OVER(ORDER BY WarehouseSequenceFirst,WarehouseSequence), InventoryTracking, TBXML.AllowBackOrder
		FROM @TBL_XmlReturnToTable AS TBXML	
		INNER  JOIN @TBL_AllwareHouseToportal AS TBAHL ON(TBAHL.SKU = TBXML.SKU)
		WHERE EXISTS(SELECT * FROM ZnodeOmsOrderLineItems ZOOLI WHERE TBXML.OrderLineItemId = ZOOLI.OmsOrderLineItemsId
			AND ZOOLI.ParentOmsOrderLineItemsId IS NOT NULL) 
		AND isnull(TBXML.OrderLineItemRelationshipTypeId,0) <> (SELECT TOP 1 OrderLineItemRelationshipTypeId FROM ZnodeOmsOrderLineItemRelationshipType WHERE Name IN ('Bundles','Configurable','Group'))
		ORDER BY  WarehouseSequenceFirst,WarehouseSequence;

		---Getting data for bundle products
		INSERT INTO @TBL_CalculateQuntity
		SELECT WarehouseId, TBXML.SKU, TBAHL.Quantity, TBAHL.InventoryId, TBXML.Quantity, NULL AS UpdatedQuantity, DENSE_RANK() 
		OVER(ORDER BY WarehouseSequenceFirst,WarehouseSequence), InventoryTracking, TBXML.AllowBackOrder
		FROM @TBL_XmlReturnToTable AS TBXML	
		INNER  JOIN @TBL_AllwareHouseToportal AS TBAHL ON(TBAHL.SKU = TBXML.SKU)
		WHERE EXISTS(SELECT * FROM ZnodeOmsOrderLineItems ZOOLI where TBXML.OrderLineItemId = ZOOLI.OmsOrderLineItemsId and ZOOLI.ParentOmsOrderLineItemsId is null)
		AND TBXML.OrderLineItemRelationshipTypeId = (SELECT TOP 1 OrderLineItemRelationshipTypeId FROM ZnodeOmsOrderLineItemRelationshipType Where Name IN ('Bundles','Configurable','Group'))
		ORDER BY  WarehouseSequenceFirst,WarehouseSequence;

		;with cte as
		(
			SELECT WarehouseId,	a.SKU,	MainQuantity,	InventoryId,	WarehouseSequenceId,	a.InventoryTracking,	AllowBackOrder,sum(OrderQuantity) as OrderQuantity
			FROM @TBL_CalculateQuntity A
			GROUP BY WarehouseId,	a.SKU,	MainQuantity,	InventoryId,	WarehouseSequenceId,	InventoryTracking,	AllowBackOrder
		)
		UPDATE b set  b.OrderQuantity = a.OrderQuantity
		FROM cte a
		INNER JOIN @TBL_CalculateQuntity b on a.SKU = b.SKU and a.InventoryId = b.InventoryId and a.WarehouseId = b.WarehouseId

		
		UPDATE @TBL_CalculateQuntity 
		SET UpdatedQuantity = MainQuantity - OrderQuantity  
		WHERE WarehouseSequenceId = 1;
		 		
		DECLARE @CountToRepeate int= ( SELECT count( distinct WarehouseId) FROM @TBL_CalculateQuntity),@Initializationofloop int= 2;
       
		WHILE @Initializationofloop <= @CountToRepeate 
				AND EXISTS (SELECT TOP 1 1 FROM @TBL_CalculateQuntity AS a 
					WHERE UpdatedQuantity < 0  )
		BEGIN
		 
			UPDATE a  
			SET a.UpdatedQuantity = a.MainQuantity + b.UpdatedQuantity 
			FROM @TBL_CalculateQuntity a 
			INNER JOIN @TBL_CalculateQuntity b ON (a.Sku = b.Sku AND b.WarehouseSequenceId = (@Initializationofloop - 1)) 
			WHERE a.WarehouseSequenceId = @Initializationofloop 
			AND b.UpdatedQuantity < 0
			AND b.UpdatedQuantity IS NOT NULL 

			UPDATE @TBL_CalculateQuntity 
			SET UpdatedQuantity  = 0 
			WHERE WarehouseSequenceId = @Initializationofloop -1 
			AND UpdatedQuantity < 0
			AND UpdatedQuantity IS NOT NULL 

			SET @Initializationofloop = @Initializationofloop + 1;
		END; 
		
		
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_CalculateQuntity WHERE ISNULL(UpdatedQuantity,0) < 0 AND @CountToRepeate >1)
		BEGIN 
			UPDATE a  
			SET a.UpdatedQuantity = b.UpdatedQuantity 
			FROM @TBL_CalculateQuntity a 
			INNER JOIN @TBL_CalculateQuntity b ON (a.Sku = b.Sku AND b.WarehouseSequenceId = @Initializationofloop -1 ) 
			WHERE a.WarehouseSequenceId = 1 
			AND ISNULL(b.UpdatedQuantity,0) < 0

			UPDATE @TBL_CalculateQuntity 
			SET UpdatedQuantity  = 0 
			WHERE WarehouseSequenceId = @Initializationofloop -1 
			--AND  InventoryTracking <> 'AllowBackordering'
			AND ISNULL(UpdatedQuantity,0) < 0
		END 
			
			
		--If "AllowBackordering" then inventory will go to be negative conside only single warehouse
		IF EXISTS(SELECT TOP 1 1 FROM @TBL_XmlReturnToTable WHERE InventoryTracking = 'AllowBackordering')
		BEGIN
			UPDATE ZI SET Quantity = Isnull(TBCQ.UpdatedQuantity,0) 
			FROM dbo.ZnodeInventory ZI 
			INNER JOIN @TBL_CalculateQuntity TBCQ ON(Zi.InventoryId = TBCQ.InventoryId)
			WHERE InventoryTracking = 'AllowBackordering' AND  UpdatedQuantity IS NOT NULL  ;
			SET @Status = 1;
		END;
		
		-- If @InventoryTracking is "DisablePurchasing" then subtracts currently selected quantity only when it will greater than zero.
		IF EXISTS ( SELECT TOP 1 1 FROM @TBL_XmlReturnToTable WHERE InventoryTracking = 'DisablePurchasing')
		BEGIN
			SET @BalanceQuantity = 1;
			UPDATE ZI 
			SET Quantity = CASE WHEN TBCQ.UpdatedQuantity < 0 THEN 0 ELSE TBCQ.UpdatedQuantity END 
			FROM dbo.ZnodeInventory ZI 
			INNER JOIN  @TBL_CalculateQuntity TBCQ ON(Zi.InventoryId = TBCQ.InventoryId) WHERE InventoryTracking = 'DisablePurchasing'
			AND TBCQ.UpdatedQuantity IS NOT NULL 
			;
		END;
		
		INSERT INTO ZnodeOmsOrderWarehouse( OmsOrderLineItemsId, WarehouseId,Quantity, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate )
		SELECT OrderLineItemId, WarehouseId,CASE WHEN UpdatedQuantity = 0 THEN MainQuantity ELSE MainQuantity - UpdatedQuantity END , @UserId, dbo.Fn_GetDate(), @UserId, dbo.Fn_GetDate() 
		FROM @TBL_CalculateQuntity AS TBCQ 
		INNER JOIN @TBL_XmlReturnToTable AS TBXR
			   ON(TBXR.SKU = TBCQ.SKU) WHERE UpdatedQuantity IS NOT NULL;
  
		SELECT DISTINCT SKU,
		 [dbo].[Fn_GetDefaultPriceRoundOffReturnNumeric](UpdatedQuantity) AS Quantity,
		  InventoryTracking,CAST(AllowBackOrder AS BIT) AllowBackOrder
		FROM @TBL_CalculateQuntity
		WHERE UpdatedQuantity IS NOT NULL;

		SET @Status = 1;
		COMMIT TRAN UpdateInventory;
	END TRY
	BEGIN CATCH
	
		SET @Status = 0;
		SELECT SKU, Quantity, InventoryTracking,CAST(AllowBackOrder AS BIT) AllowBackOrder
		FROM @TBL_ErrorInventoryTracking;
		
		ROLLBACK TRAN UpdateInventory;
	END CATCH;
END;

GO

insert into ZnodeGlobalAttribute
(AttributeTypeId, AttributeCode, IsRequired, IsLocalizable, IsActive, DisplayOrder,HelpDescription,CreatedBy, CreatedDate, ModifiedBy,ModifiedDate, IsSystemDefined, GlobalEntityId)
select 
(select top 1  AttributeTypeId from ZnodeAttributeType where AttributeTypeName ='Number' ),N'SuccessBufferTime',1,1,0,14,'Success Buffer Time?',2,getdate(),2,getdate(),0 , (select top 1 GlobalEntityId from znodeGlobalEntity where EntityName ='Store')
where not exists (select AttributeCode from  ZnodeGlobalAttribute where AttributeCode ='SuccessBufferTime' )

insert into ZnodeGlobalAttribute
(AttributeTypeId, AttributeCode, IsRequired, IsLocalizable, IsActive, DisplayOrder,HelpDescription,CreatedBy, CreatedDate, ModifiedBy,ModifiedDate, IsSystemDefined, GlobalEntityId)
select 
(select top 1  AttributeTypeId from ZnodeAttributeType where AttributeTypeName ='Number' ),N'SuccessRandomTime',1,1,0,14,'Success Random Time?',2,getdate(),2,getdate(),0, (select top 1 GlobalEntityId from znodeGlobalEntity where EntityName ='Store')
where not exists  (select AttributeCode from  ZnodeGlobalAttribute where AttributeCode ='SuccessRandomTime')

insert into ZnodeGlobalAttribute
(AttributeTypeId, AttributeCode, IsRequired, IsLocalizable, IsActive, DisplayOrder,HelpDescription,CreatedBy, CreatedDate, ModifiedBy,ModifiedDate, IsSystemDefined, GlobalEntityId)
select 
(select top 1  AttributeTypeId from ZnodeAttributeType where AttributeTypeName ='Number' ),N'ErrorBufferTime',1,1,0,14,'Error Buffer Time?',2,getdate(),2,getdate(),0, (select top 1 GlobalEntityId from znodeGlobalEntity where EntityName ='Store')
where not exists  (select AttributeCode from  ZnodeGlobalAttribute where AttributeCode ='ErrorBufferTime')

insert into ZnodeGlobalAttribute
(AttributeTypeId, AttributeCode, IsRequired, IsLocalizable, IsActive, DisplayOrder,HelpDescription,CreatedBy, CreatedDate, ModifiedBy,ModifiedDate, IsSystemDefined, GlobalEntityId)
select 
(select top 1  AttributeTypeId from ZnodeAttributeType where AttributeTypeName ='Number' ),N'ErrorRandomTime',1,1,0,14,'Error Random Time?',2,getdate(),2,getdate(),0, (select top 1 GlobalEntityId from znodeGlobalEntity where EntityName ='Store')
where not exists  (select AttributeCode from  ZnodeGlobalAttribute where AttributeCode ='ErrorRandomTime')

insert into ZnodeGlobalAttribute
(AttributeTypeId, AttributeCode, IsRequired, IsLocalizable, IsActive, DisplayOrder,HelpDescription,CreatedBy, CreatedDate, ModifiedBy,ModifiedDate, IsSystemDefined, GlobalEntityId)
select 
(select top 1  AttributeTypeId from ZnodeAttributeType where AttributeTypeName ='Number' ),N'SuccessSignUpBufferTime',1,1,0,14,'Success SignUp Buffer Time?',2,getdate(),2,getdate(),0, (select top 1 GlobalEntityId from znodeGlobalEntity where EntityName ='Store')
where not exists  (select AttributeCode from  ZnodeGlobalAttribute where AttributeCode ='ErrorRandomTime')

insert into ZnodeGlobalAttribute
(AttributeTypeId, AttributeCode, IsRequired, IsLocalizable, IsActive, DisplayOrder,HelpDescription,CreatedBy, CreatedDate, ModifiedBy,ModifiedDate, IsSystemDefined, GlobalEntityId)
select 
(select top 1  AttributeTypeId from ZnodeAttributeType where AttributeTypeName ='Number' ),N'SuccessSignUpRandomTime',1,1,0,14,'Success SignUp Random Time?',2,getdate(),2,getdate(),0, (select top 1 GlobalEntityId from znodeGlobalEntity where EntityName ='Store')
where not exists  (select AttributeCode from  ZnodeGlobalAttribute where AttributeCode ='ErrorRandomTime')

insert into ZnodeGlobalAttribute
(AttributeTypeId, AttributeCode, IsRequired, IsLocalizable, IsActive, DisplayOrder,HelpDescription,CreatedBy, CreatedDate, ModifiedBy,ModifiedDate, IsSystemDefined, GlobalEntityId)
select 
(select top 1  AttributeTypeId from ZnodeAttributeType where AttributeTypeName ='Number' ),N'ErrorSignUpBufferTime',1,1,0,14,'Error SignUp Buffer Time?',2,getdate(),2,getdate(),0, (select top 1 GlobalEntityId from znodeGlobalEntity where EntityName ='Store')
where not exists  (select AttributeCode from  ZnodeGlobalAttribute where AttributeCode ='ErrorRandomTime')

insert into ZnodeGlobalAttribute
(AttributeTypeId, AttributeCode, IsRequired, IsLocalizable, IsActive, DisplayOrder,HelpDescription,CreatedBy, CreatedDate, ModifiedBy,ModifiedDate, IsSystemDefined, GlobalEntityId)
select 
(select top 1 AttributeTypeId from ZnodeAttributeType where AttributeTypeName ='Number' ),N'ErrorSignUpRandomTime',1,1,0,14,'Error SignUp Random Time?',2,getdate(),2,getdate(),0, (select top 1 GlobalEntityId from znodeGlobalEntity where EntityName ='Store')
where not exists  (select AttributeCode from  ZnodeGlobalAttribute where AttributeCode ='ErrorRandomTime')

INSERT INTO ZnodeGlobalAttributeLocale(LocaleId,GlobalAttributeId,AttributeName,Description,CreatedBy,
CreatedDate,ModifiedBy,ModifiedDate)
SELECT 1,(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='SuccessBufferTime'),'Success Buffer Time',
NULL,2,GETDATE(),2,GETDATE()
where not exists (select * from ZnodeGlobalAttributeLocale 
where GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='SuccessBufferTime'))

INSERT INTO ZnodeGlobalAttributeLocale(LocaleId,GlobalAttributeId,AttributeName,Description,CreatedBy,
CreatedDate,ModifiedBy,ModifiedDate)
SELECT 1,(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='SuccessRandomTime'),'Success Random Time',
NULL,2,GETDATE(),2,GETDATE()
where not exists (select * from ZnodeGlobalAttributeLocale 
where GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='SuccessRandomTime'))

INSERT INTO ZnodeGlobalAttributeLocale(LocaleId,GlobalAttributeId,AttributeName,Description,CreatedBy,
CreatedDate,ModifiedBy,ModifiedDate)
SELECT 1,(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='ErrorBufferTime'),'Error Buffer Time',
NULL,2,GETDATE(),2,GETDATE()
where not exists (select * from ZnodeGlobalAttributeLocale 
where GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='ErrorBufferTime'))


INSERT INTO ZnodeGlobalAttributeLocale(LocaleId,GlobalAttributeId,AttributeName,Description,CreatedBy,
CreatedDate,ModifiedBy,ModifiedDate)
SELECT 1,(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='ErrorRandomTime'),'Error Random Time',
NULL,2,GETDATE(),2,GETDATE()
where not exists (select * from ZnodeGlobalAttributeLocale 
where GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='ErrorRandomTime'))

insert into ZnodeGlobalAttributeGroup
(GroupCode,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsSystemDefined,GlobalEntityId)
select N'DelayTimeConfiguration', NULL, 2, GETDATE(), 2, GETDATE(), 0, (select top 1 GlobalEntityId from znodeGlobalEntity where EntityName ='Store')
where  not exists   (select top 1 GroupCode from ZnodeGlobalAttributeGroup where GroupCode =N'DelayTimeConfiguration') 

INSERT INTO ZnodeGlobalAttributeGroupLocale(LocaleId,GlobalAttributeGroupId,AttributeGroupName,Description,CreatedBy,CreatedDate,
ModifiedBy,ModifiedDate)
SELECT 1,(SELECT TOP 1 GlobalAttributeGroupId from ZnodeGlobalAttributeGroup where GroupCode=N'DelayTimeConfiguration'),'Delay Time Configuration',NULL,2,
GETDATE(),2,GETDATE()
where not exists (select * from ZnodeGlobalAttributeGroupLocale 
where GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId from ZnodeGlobalAttributeGroup where GroupCode=N'DelayTimeConfiguration'))

Insert into ZnodeGlobalAttributeDefaultValue
(GlobalAttributeId,AttributeDefaultValueCode,IsEditable,DisplayOrder,MediaId,SwatchText,IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select top 1  GlobalAttributeId, N'0',NULL,NULL,NULL,NULL,NULL,2,Getdate(),2,Getdate()
from ZnodeGlobalAttribute where AttributeCode ='SuccessBufferTime' and  GlobalAttributeId not in (select GlobalAttributeId from ZnodeGlobalAttributeDefaultValue)

Insert into ZnodeGlobalAttributeDefaultValue
(GlobalAttributeId,AttributeDefaultValueCode,IsEditable,DisplayOrder,MediaId,SwatchText,IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select top 1  GlobalAttributeId, N'0',NULL,NULL,NULL,NULL,NULL,2,Getdate(),2,Getdate()
from ZnodeGlobalAttribute where AttributeCode ='SuccessRandomTime' and  GlobalAttributeId not in (select GlobalAttributeId from ZnodeGlobalAttributeDefaultValue)

Insert into ZnodeGlobalAttributeDefaultValue
(GlobalAttributeId,AttributeDefaultValueCode,IsEditable,DisplayOrder,MediaId,SwatchText,IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select top 1  GlobalAttributeId, N'0',NULL,NULL,NULL,NULL,NULL,2,Getdate(),2,Getdate()
from ZnodeGlobalAttribute where AttributeCode ='ErrorBufferTime' and  GlobalAttributeId not in (select GlobalAttributeId from ZnodeGlobalAttributeDefaultValue)

Insert into ZnodeGlobalAttributeDefaultValue
(GlobalAttributeId,AttributeDefaultValueCode,IsEditable,DisplayOrder,MediaId,SwatchText,IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select top 1  GlobalAttributeId, N'0',NULL,NULL,NULL,NULL,NULL,2,Getdate(),2,Getdate()
from ZnodeGlobalAttribute where AttributeCode ='ErrorRandomTime' and  GlobalAttributeId not in (select GlobalAttributeId from ZnodeGlobalAttributeDefaultValue)
--
Insert into ZnodeGlobalAttributeDefaultValue
(GlobalAttributeId,AttributeDefaultValueCode,IsEditable,DisplayOrder,MediaId,SwatchText,IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select top 1  GlobalAttributeId, N'0',NULL,NULL,NULL,NULL,NULL,2,Getdate(),2,Getdate()
from ZnodeGlobalAttribute where AttributeCode ='SuccessSignUpBufferTime' and  GlobalAttributeId not in (select GlobalAttributeId from ZnodeGlobalAttributeDefaultValue)

Insert into ZnodeGlobalAttributeDefaultValue
(GlobalAttributeId,AttributeDefaultValueCode,IsEditable,DisplayOrder,MediaId,SwatchText,IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select top 1  GlobalAttributeId, N'0',NULL,NULL,NULL,NULL,NULL,2,Getdate(),2,Getdate()
from ZnodeGlobalAttribute where AttributeCode ='SuccessSignUpRandomTime' and  GlobalAttributeId not in (select GlobalAttributeId from ZnodeGlobalAttributeDefaultValue)

Insert into ZnodeGlobalAttributeDefaultValue
(GlobalAttributeId,AttributeDefaultValueCode,IsEditable,DisplayOrder,MediaId,SwatchText,IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select top 1  GlobalAttributeId, N'0',NULL,NULL,NULL,NULL,NULL,2,Getdate(),2,Getdate()
from ZnodeGlobalAttribute where AttributeCode ='ErrorSignUpBufferTime' and  GlobalAttributeId not in (select GlobalAttributeId from ZnodeGlobalAttributeDefaultValue)

Insert into ZnodeGlobalAttributeDefaultValue
(GlobalAttributeId,AttributeDefaultValueCode,IsEditable,DisplayOrder,MediaId,SwatchText,IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select top 1  GlobalAttributeId, N'0',NULL,NULL,NULL,NULL,NULL,2,Getdate(),2,Getdate()
from ZnodeGlobalAttribute where AttributeCode ='ErrorSignUpRandomTime' and  GlobalAttributeId not in (select GlobalAttributeId from ZnodeGlobalAttributeDefaultValue)

INSERT INTO ZnodeGlobalAttributeDefaultValueLocale(LocaleId,GlobalAttributeDefaultValueId,AttributeDefaultValue,Description,CreatedBy,CreatedDate,
ModifiedBy,ModifiedDate)
SELECT 1,(SELECT TOP 1 GlobalAttributeDefaultValueId from ZnodeGlobalAttributeDefaultValue where AttributeDefaultValueCode='0'),'0',NULL,2,
GETDATE(),2,GETDATE()
where not exists (select * from ZnodeGlobalAttributeDefaultValueLocale
where GlobalAttributeDefaultValueId=(SELECT TOP 1 GlobalAttributeDefaultValueId from ZnodeGlobalAttributeDefaultValue where AttributeDefaultValueCode='0'))

insert into ZnodeGlobalAttributeGroup
(GroupCode,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsSystemDefined,GlobalEntityId)
select N'DelayTimeConfiguration', NULL, 2, GETDATE(), 2, GETDATE(), 0, (select top 1 GlobalEntityId from znodeGlobalEntity where EntityName ='Store')
where  not exists   (select top 1 GroupCode from ZnodeGlobalAttributeGroup where GroupCode =N'DelayTimeConfiguration') 

GO

UPDATE ZnodeEmailTemplateLocale
SET Content = REPLACE(content,'Copyright @ 2021','Copyright @ 2022')
WHERE Content LIKE '%Copyright @ 2021%'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateQuoteLineItem')
	DROP PROC Znode_InsertUpdateQuoteLineItem
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateQuoteLineItem]
(   
	@OmsQuoteId      INT ,
    @UserId          INT = 0,
	@OmsSavedCartId  INT = 0,
    @Status          BIT OUT ,
	@SKUPriceForQuote [dbo].[SKUPriceForQuote] ReadOnly
)
AS 
   /* 
    Summary: This Procedure is used to save and edit the quote line item      
    Unit Testing   
    Exec Znode_InsertUpdateQuoteLineItem 2000,1527,0
   
	*/
     BEGIN
         BEGIN TRAN A;
         BEGIN TRY
             SET NOCOUNT ON;
			 DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
			 DECLARE  @OmsQuoteLineItemId INT;
			 DECLARE @TempOmsQuoteLineItem TABLE (OmsQuoteLineItemId INT , OmsSavedCartLineItemId INT , ParentOmsSavedCartLineItemId INT  )
			 DECLARE @OrderLineItemRelationshipTypeIdBundle INT = (SELECT TOP 1 OrderLineItemRelationshipTypeId FROM ZnodeOmsOrderLineItemRelationshipType WHERE Name = 'Bundles')

			CREATE TABLE #ZnodeOmsSavedCartLineItem
			(OmsSavedCartLineItemId	int,
			ParentOmsSavedCartLineItemId	int,
			OmsSavedCartId	int,
			SKU	nvarchar(200),
			Quantity	numeric(28,	13) ,
			OrderLineItemRelationshipTypeId	int,
			CustomText	nvarchar(MAX),
			CartAddOnDetails	nvarchar(MAX),
			Sequence	int,
			CreatedBy	int,
			CreatedDate	datetime,
			ModifiedBy	int,
			ModifiedDate	datetime,
			AutoAddon	nvarchar(MAX),
			OmsOrderId	int,
			Custom1	nvarchar(MAX),
			Custom2	nvarchar(MAX),
			Custom3	nvarchar(MAX),
			Custom4	nvarchar(MAX),
			Custom5	nvarchar(MAX),
			GroupId	nvarchar(MAX),
			ProductName	nvarchar(2000),
			Description	nvarchar(MAX),
			Price numeric(28,6),
			ShippingCost numeric(28,6),
			InitialPrice numeric(28,6),
			InitialShippingCost numeric(28,6),
			IsPriceEdit bit)
			 
			IF (isnull(@OmsSavedCartId,0) <> 0)
			BEGIN
				INSERT INTO #ZnodeOmsSavedCartLineItem(OmsSavedCartLineItemId,ParentOmsSavedCartLineItemId,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId,CustomText,CartAddOnDetails,
				                                       Sequence,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AutoAddon,OmsOrderId,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,Description)
				SELECT a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId,a.OmsSavedCartId,a.SKU,a.Quantity,a.OrderLineItemRelationshipTypeId,a.CustomText,a.CartAddOnDetails,
				       a.Sequence,a.CreatedBy,a.CreatedDate,a.ModifiedBy,a.ModifiedDate,a.AutoAddon,a.OmsOrderId,a.Custom1,a.Custom2,a.Custom3,a.Custom4,a.Custom5,a.GroupId,a.ProductName,a.Description 				
				FROM ZnodeOmsSavedCartLineItem  a 
				WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeOmsQuoteLineItem ty WHERE ty.OmsQuoteId = @OmsQuoteId) and a.OmsSavedCartId=@OmsSavedCartId
				
			END
			ELSE
			BEGIN
				INSERT INTO #ZnodeOmsSavedCartLineItem(OmsSavedCartLineItemId,ParentOmsSavedCartLineItemId,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId,CustomText,CartAddOnDetails,
				                                       Sequence,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AutoAddon,OmsOrderId,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,Description)
				SELECT a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId,a.OmsSavedCartId,a.SKU,a.Quantity,a.OrderLineItemRelationshipTypeId,a.CustomText,a.CartAddOnDetails,
				       a.Sequence,a.CreatedBy,a.CreatedDate,a.ModifiedBy,a.ModifiedDate,a.AutoAddon,a.OmsOrderId,a.Custom1,a.Custom2,a.Custom3,a.Custom4,a.Custom5,a.GroupId,a.ProductName,a.Description 
				FROM ZnodeOmsSavedCartLineItem  a 
				INNER JOIN ZnodeOmsSavedCart b ON (b.OmsSavedCartId = a.OmsSavedCartId)
				INNER JOIN ZnodeOmsCookieMapping c ON (c.OmsCookieMappingId = b.OmsCookieMappingId)
				WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeOmsQuoteLineItem ty WHERE ty.OmsQuoteId = @OmsQuoteId) 
				AND c.UserId = @UserId
			END

			UPDATE ZOSLI set ZOSLI.Price = SPQ.Price, ZOSLI.ShippingCost = SPQ.ShippingCost, ZOSLI.InitialPrice = SPQ.InitialPrice,
			ZOSLI.InitialShippingCost = SPQ.InitialShippingCost, ZOSLI.IsPriceEdit = SPQ.IsPriceEdit
			FROM #ZnodeOmsSavedCartLineItem ZOSLI
			INNER JOIN @SKUPriceForQuote SPQ ON ZOSLI.OmsSavedCartLineItemId = SPQ.OmsSavedCartLineItemId

			--To update price and ShippingCost for child entries of bundle product
			UPDATE ZOSLI set ZOSLI.Price = SPQ.Price, ZOSLI.ShippingCost = SPQ.ShippingCost, ZOSLI.InitialPrice = SPQ.InitialPrice,
			ZOSLI.InitialShippingCost = SPQ.InitialShippingCost, ZOSLI.IsPriceEdit= SPQ.IsPriceEdit
			FROM #ZnodeOmsSavedCartLineItem ZOSLI
			INNER JOIN @SKUPriceForQuote SPQ ON ZOSLI.ParentOmsSavedCartLineItemId = SPQ.OmsSavedCartLineItemId
			WHERE ZOSLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle


			IF OBJECT_ID('Tempdb..#desupdate1') IS NOT NULL  
			DROP TABLE Tempdb..#desupdate1 
			select ZnodeProductId,des into #desupdate1 from (
									   SELECT  ZnodeProductId, CONCAT( 'Qty: ',cast(cast(AssociatedProductBundleQuantity as int) as varchar(5)),'| ',sku,' - ', productname, char(10) ) des  FROM ZnodePublishBundleProductEntity  ZPBPE1
											inner join ZnodePublishProductDetail ZPP  on  ZPBPE1.AssociatedZnodeProductId = ZPP.PublishProductId
											)asd group by ZnodeProductId, des


			IF OBJECT_ID('Tempdb..#desupdate') IS NOT NULL  
			DROP TABLE Tempdb..#desupdate 

			select ZPBPE.des, asd.* into #desupdate from (
				select VLMP.PimProductId PPI , ZOSCL.* from #ZnodeOmsSavedCartLineItem ZOSCL 
							inner join [dbo].[View_LoadManageProduct] VLMP on VLMP.AttributeCode ='SKU' and VLMP.AttributeValue= ZOSCL.sku
							inner join (select * from ZnodepimAttributevalue where PimAttributeId = 10 and  PimAttributeValueId in (
											select PimAttributeValueId from ZnodePimProductAttributeDefaultValue where PimAttributeDefaultValueId in (
											select PimAttributeDefaultValueId from ZnodePimAttributeDefaultValue where AttributeDefaultValueCode = 'BundleProduct' ))) BP
												on BP.PimProductId =  VLMP.PimProductId ) asd
						cross apply
						 (
						SELECT   *
						FROM    (SELECT ZnodeProductId, '<p><span style="font-family: Arial, Helvetica, sans-serif; font-size: 10px;">' +
							(SELECT  des +' </br> '  
											FROM #desupdate1 AS p 
											WHERE p.ZnodeProductId = a.ZnodeProductId
											FOR XML PATH(''))
							
						+ '</span></p>' AS des
									FROM #desupdate1 a
									GROUP BY ZnodeProductId)  ZPBPE1
						inner join ZnodePublishProduct ZPP on  ZPBPE1.ZnodeProductId = ZPP.PublishProductId

						WHERE   Zpp.PimProductId = asd.PPI
      
						) 
				   ZPBPE

			UPDATE ZOSLI set ZOSLI.Description = SPQ.des
			FROM #ZnodeOmsSavedCartLineItem ZOSLI
			INNER JOIN #desupdate SPQ ON ZOSLI.OmsSavedCartLineItemId = SPQ.OmsSavedCartLineItemId or ZOSLI.ParentOmsSavedCartLineItemId = SPQ.OmsSavedCartLineItemId


			
			MERGE INTO ZnodeOmsQuoteLineItem TARGET 
			USING #ZnodeOmsSavedCartLineItem  SOURCE 
			ON (1=0 )
			WHEN NOT MATCHED THEN 
			INSERT   (ParentOmsQuoteLineItemId,OmsQuoteId,SKU,Quantity,OrderLineItemRelationshipTypeId
						,CustomText,CartAddOnDetails,Sequence,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,GroupId,ProductName,Description, Price, ShippingCost,
						InitialPrice, InitialShippingCost, IsPriceEdit)
			 
			VALUES ( NULL,@OmsQuoteId,SOURCE.SKU,SOURCE.Quantity,SOURCE.OrderLineItemRelationshipTypeId
						,SOURCE.CustomText,SOURCE.CartAddOnDetails,SOURCE.Sequence,SOURCE.CreatedBy,SOURCE.CreatedDate,SOURCE.ModifiedBy,SOURCE.ModifiedDate,SOURCE.GroupId,SOURCE.ProductName,SOURCE.Description, SOURCE.Price, SOURCE.ShippingCost,
						SOURCE.InitialPrice, SOURCE.InitialShippingCost, SOURCE.IsPriceEdit ) 
			
			OUTPUT Inserted.OmsQuoteLineItemId , SOURCE.OmsSavedCartLineItemId,Source.ParentOmsSavedCartLineItemId  INTO @TempOmsQuoteLineItem ;


			UPDATE a
			SET a.ParentOmsQuoteLineItemId =( SELECT TOP 1 b1.OmsQuoteLineItemId FROM  @TempOmsQuoteLineItem b1 WHERE b.ParentOmsSavedCartLineItemId  = b1.OmsSavedCartLineItemId)  
			FROM ZnodeOmsQuoteLineItem  a 
			INNER JOIN @TempOmsQuoteLineItem b ON (b.OmsQuoteLineItemId = a.OmsQuoteLineItemId)
			WHERE b.ParentOmsSavedCartLineItemId IS NOT NULL 



			INSERT INTO ZnodeOmsQuotePersonalizeItem (OmsQuoteLineItemId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
														,DesignId,ThumbnailURL)
			SELECT b.OmsQuoteLineItemId,PersonalizeCode,PersonalizeValue,a.CreatedBy,a.CreatedDate,a.ModifiedBy,a.ModifiedDate
														,DesignId,ThumbnailURL
			FROM ZnodeOmsPersonalizeCartItem a  
			INNER JOIN @TempOmsQuoteLineItem b ON (b.OmsSavedCartLineItemId =  a.OmsSavedCartLineItemId )         


             SET @Status = 1;
             COMMIT TRAN A;
         END TRY
         BEGIN CATCH
        
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertUpdateQuoteLineItem @CartLineItemXML = '+CAST('' AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
			 ROLLBACK TRAN A;
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_InsertUpdateQuoteLineItem',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetBrandDetailsLocale')
	DROP PROC Znode_GetBrandDetailsLocale
GO


CREATE PROCEDURE [dbo].[Znode_GetBrandDetailsLocale]  
( 
	@WhereClause  NVARCHAR(MAX),  
	@Rows    INT           = 10,  
	@PageNo   INT           = 1,  
	@Order_BY   VARCHAR(1000) = '',  
	@RowsCount  INT           = 0 OUT,  
	@LocaleId   INT           = 1,    
	@IsAssociated  BIT           = 0,  
	@PromotionId      INT     = 0   
)  
AS  
  /*  
     Summary :- This Procedure is used to get brand localies   
     Unit Testing   
  begin tran  
     EXEC Znode_GetBrandDetailsLocale ''isactive = 'true''',@RowsCount= 1,@LocaleId = 1   
  rollback tran    
 */  
BEGIN  
BEGIN TRY  
	SET NOCOUNT ON;  
	DECLARE @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId();  
	DECLARE @SeoId VARCHAR(MAX)= '', @SQL NVARCHAR(MAX); --, @SeoCode NVARCHAR(MAX) ;
	DECLARE @PaginationWhereClause VARCHAR(300)= dbo.Fn_GetRowsForPagination(@PageNo, @Rows, ' WHERE RowId')

	DECLARE @TBL_BrandDetails TABLE  
	(
		Description         NVARCHAR(MAX),  
		BrandId             INT,  
		BrandCode           VARCHAR(600),  
		DisplayOrder        INT,  
		IsActive            BIT,  
		WebsiteLink         NVARCHAR(1000),  
		BrandDetailLocaleId INT,  
		SEOFriendlyPageName NVARCHAR(600),  
		MediaPath           NVARCHAR(MAX),  
		MediaId             INT,  
		ImageName           VARCHAR(300),
		BrandName VARCHAR(100),	
		Custom1 NVARCHAR(MAX),	
		Custom2 NVARCHAR(MAX),
		Custom3 NVARCHAR(MAX),
		Custom4 NVARCHAR(MAX),
		Custom5 NVARCHAR(MAX)  
	);  
  
	DECLARE @AttributeId INT= [dbo].[Fn_GetProductBrandAttributeId]();  
	DECLARE @TBL_AttributeDefault TABLE  
	(
		PimAttributeId            INT,  
		AttributeDefaultValueCode VARCHAR(600),  
		IsEditable                BIT,  
		AttributeDefaultValue     NVARCHAR(MAX)  
		,DisplayOrder INT   
	); 
	
	DECLARE @TBL_SeoDetails TABLE  
	(
		CMSSEODetailId       INT,  
		SEOTitle             NVARCHAR(MAX),  
		SEOKeywords          NVARCHAR(MAX),  
		SEOURL               NVARCHAR(MAX),  
		ModifiedDate         DATETIME,  
		SEODescription       NVARCHAR(MAX),  
		MetaInformation      NVARCHAR(MAX),  
		IsRedirect           BIT,  
		CMSSEODetailLocaleId INT,  
		--SEOId                INT ,
		PublishStatus        NVARCHAR(20),
		SEOCode				NVARCHAR(4000),
		CanonicalURL  VARCHAR(200),
		RobotTag      VARCHAR(50)
			   
	);  
	DECLARE @TBL_BrandDetail TABLE  
	(
		Description          NVARCHAR(MAX),  
		BrandId              INT,  
		BrandCode            VARCHAR(600),  
		DisplayOrder         INT,  
		IsActive             BIT,  
		WebsiteLink          NVARCHAR(1000),  
		BrandDetailLocaleId  INT,  
		MediaPath            NVARCHAR(MAX),  
		MediaId              INT,  
		ImageName      VARCHAr(300) ,  
		CMSSEODetailId       INT,  
		SEOTitle             NVARCHAR(MAX),  
		SEOKeywords          NVARCHAR(MAX),  
		SEOURL               NVARCHAR(MAX),  
		ModifiedDate         DATETIME,  
		SEODescription       NVARCHAR(MAX),  
		MetaInformation      NVARCHAR(MAX),  
		IsRedirect           BIT,  
		CMSSEODetailLocaleId INT,  
		--SEOId                INT,  
		BrandName            NVARCHAR(MAX),  
		RowId                INT,  
		CountId              INT ,
		SEOCode              NVARCHAR(4000), 
		Custom1              NVARCHAR(MAX),
		Custom2              NVARCHAR(MAX),
		Custom3              NVARCHAR(MAX),
		Custom4              NVARCHAR(MAX),
		Custom5              NVARCHAR(MAX)
	);  
	IF @PromotionId > 0  
	BEGIN   
      
	SET @SeoId = ISNULL(SUBSTRING((SELECT ','+CAST(BrandId AS VARCHAR(50))  
	FROM ZnodePromotionBrand   
	WHERE PromotionId= @PromotionId  FOR XML PATH ('') ),2,4000),'0')  
  
	SET @WhereClause = CASE WHEN @IsAssociated = 1 THEN ' BrandId IN (' ELSE ' BrandId NOT IN (' END  +@SeoId+') AND '+CASE WHEN @WhereClause = '' THEN '1=1' ELSE @WhereClause END   
	SET @SeoId = ''  
	END    
 
	;WITH Cte_GetBrandBothLocale AS 
	(
		SELECT ZBDL.Description,ZBD.BrandId,LocaleId,ZBD.BrandCode,ZBD.DisplayOrder,ZBD.IsActive,ZBD.WebsiteLink,ZBDl.BrandDetailLocaleId,  
		SEOFriendlyPageName,[dbo].[Fn_GetMediaThumbnailMediaPath](Zm.path) MediaPath,ZBD.MediaId,Zm.path ImageName, ZBDL.BrandName, ZBD.Custom1, ZBD.Custom2, ZBD.Custom3, ZBD.Custom4, ZBD.Custom5 
		FROM ZnodeBrandDetails ZBD  
		LEFT JOIN ZnodeBrandDetailLocale ZBDL ON(ZBD.BrandId = ZBDL.BrandId)  
		LEFT JOIN ZnodeMedia ZM ON(ZM.MediaId = ZBD.MediaId)  
		WHERE LocaleId IN(@LocaleId, @DefaultLocaleId)  
              
	),  
	Cte_BrandFirstLocale AS 
	(
		SELECT Description,BrandId,LocaleId,BrandCode,DisplayOrder,IsActive,WebsiteLink,BrandDetailLocaleId,SEOFriendlyPageName,MediaPath,MediaId,ImageName , BrandName, Custom1, Custom2, Custom3, Custom4, Custom5  
		FROM Cte_GetBrandBothLocale CTGBBL  
		WHERE LocaleId = @LocaleId
	),  
	Cte_BrandDefaultLocale AS 
	(
		SELECT Description,BrandId,BrandCode,DisplayOrder,IsActive,WebsiteLink,BrandDetailLocaleId,SEOFriendlyPageName,MediaPath,MediaId,ImageName, BrandName, Custom1, Custom2, Custom3, Custom4, Custom5  
		FROM Cte_BrandFirstLocale  
		UNION ALL  
		SELECT Description,BrandId,BrandCode,DisplayOrder,IsActive,WebsiteLink,BrandDetailLocaleId,SEOFriendlyPageName,MediaPath,MediaId,ImageName , BrandName, Custom1, Custom2, Custom3, Custom4, Custom5 
		FROM Cte_GetBrandBothLocale CTBBL  
		WHERE LocaleId = @DefaultLocaleId  
		AND NOT EXISTS  
		(  
			SELECT TOP 1 1  
			FROM Cte_BrandFirstLocale CTBFL  
			WHERE CTBBL.BrandId = CTBFL.BrandId  
		)
	)  
  
	INSERT INTO @TBL_BrandDetails (Description,BrandId,BrandCode,DisplayOrder,IsActive,WebsiteLink,BrandDetailLocaleId,MediaPath,MediaId,ImageName, BrandName, Custom1, Custom2, Custom3, Custom4, Custom5)  
	SELECT Description,BrandId,BrandCode,DisplayOrder,IsActive,WebsiteLink,BrandDetailLocaleId,MediaPath,MediaId,ImageName , BrandName, Custom1, Custom2, Custom3, Custom4, Custom5 
	FROM Cte_BrandDefaultLocale CTEBD;  
            
	-----UPDATE BrandName FROM attributedefault value
	;WITH Cte_GetBrandNameLocale AS 
	(
		SELECT d.brandcode, a.AttributeDefaultValueCode, b.AttributeDefaultValue, b.LocaleId 
		FROM ZnodePimAttributeDefaultValue a
		INNER JOIN ZnodePimAttributeDefaultValueLocale b on a.PimAttributeDefaultValueId = b.PimAttributeDefaultValueId 
		INNER JOIN ZnodePimAttribute c on a.PimAttributeId = c.PimAttributeId
		INNER JOIN @TBL_BrandDetails d on a.AttributeDefaultValueCode = d.brandcode
		where c.attributecode = 'brand' and b.LocaleId IN(@LocaleId, @DefaultLocaleId)
              
	)
	,Cte_BrandNameFirstLocale AS 
	(
		SELECT brandcode, AttributeDefaultValueCode, AttributeDefaultValue, LocaleId  
		FROM Cte_GetBrandNameLocale CTGBBL  
		WHERE LocaleId = @LocaleId
	)
	,Cte_BrandDefaultLocale AS 
	(
		SELECT brandcode, AttributeDefaultValueCode, AttributeDefaultValue, LocaleId  
		FROM Cte_BrandNameFirstLocale  
		UNION ALL  
		SELECT brandcode, AttributeDefaultValueCode, AttributeDefaultValue, LocaleId  
		FROM Cte_GetBrandNameLocale CTBBL  
		WHERE LocaleId = @DefaultLocaleId  
		AND NOT EXISTS  
		(  
			SELECT TOP 1 1  
			FROM Cte_BrandNameFirstLocale CTBFL  
			WHERE CTBBL.brandcode = CTBFL.brandcode  
		)
	)  
	UPDATE b1 set b1.brandname = a1.AttributeDefaultValue
	FROM Cte_BrandDefaultLocale a1
	INNER JOIN @TBL_BrandDetails b1 on a1.brandcode = b1.brandcode

	DECLARE @SeoCode SelectColumnList
	INSERT INTO @SeoCode
	SELECT BrandCode FROM @TBL_BrandDetails

			
	INSERT INTO @TBL_SeoDetails (CMSSEODetailId,SEOTitle,SEOKeywords,SEOURL,ModifiedDate,SEODescription,MetaInformation,IsRedirect,CMSSEODetailLocaleId,PublishStatus,SEOCode
	,CanonicalURL,RobotTag)  
	EXEC Znode_GetSeoDetails @SeoCode,'Brand', @LocaleId;  
                  
	SELECT DISTINCT TBBD.*,TBSD.SEOTitle,TBSD.SEOKeywords,TBSD.SEOURL,TBSD.SEODescription,TBSD.MetaInformation,TBSD.IsRedirect,
		TBSD.PublishStatus,TBSD.SEOCode,TBSD.CanonicalURL,TBSD.RobotTag
	INTO #TM_BrandLocale  
	FROM @TBL_BrandDetails TBBD  
	LEFT JOIN @TBL_SeoDetails TBSD ON(TBSD.SEOCode = TBBD.BrandCode)  

	SET @SQL = '   
	;With Cte_BrandDetails AS   
	(  
		SELECT * ,'+[dbo].[Fn_GetPagingRowId](@Order_BY, 'BrandId DESC')+',Count(*)Over() CountId  
		FROM #TM_BrandLocale TMADV  
		WHERE 1=1  
		'+[dbo].[Fn_GetFilterWhereClause](@WhereClause)+'  
  
	)  
	SELECT Description  , BrandId , BrandCode , DisplayOrder  ,IsActive  ,WebsiteLink ,BrandDetailLocaleId   
		, MediaPath ,MediaId,ImageName ,SEOTitle ,SEOKeywords , SEOURL   
		, SEODescription   ,MetaInformation   ,IsRedirect   
		,BrandName ,RowId  ,CountId ,SEOCode,  Custom1, Custom2, Custom3, Custom4, Custom5   
	INTO #BrandDetailsPagination
	FROM Cte_BrandDetails  
	'+[dbo].[Fn_GetOrderByClause](@Order_BY, 'BrandId DESC')+' 
	
	SELECT Description  , BrandId , BrandCode , DisplayOrder  ,IsActive  ,WebsiteLink ,BrandDetailLocaleId   
		, MediaPath ,MediaId,ImageName ,SEOTitle ,SEOKeywords , SEOURL   
		, SEODescription   ,MetaInformation   ,IsRedirect   
		,BrandName ,RowId  ,CountId ,SEOCode,  Custom1, Custom2, Custom3, Custom4, Custom5
	FROM #BrandDetailsPagination'+@PaginationWhereClause+' '+dbo.Fn_GetOrderByClause(@Order_By, 'BrandId DESC');  
  
	INSERT INTO @TBL_BrandDetail  
	(  
		Description,BrandId,BrandCode,DisplayOrder,IsActive,WebsiteLink,  
		BrandDetailLocaleId,MediaPath,MediaId,ImageName,SEOTitle,  
		SEOKeywords,SEOURL,SEODescription,MetaInformation,IsRedirect,  
		BrandName,RowId,CountId ,SEOCode , Custom1, Custom2, Custom3, Custom4, Custom5   
	)  
	EXEC (@SQL);  
	
	SET @RowsCount = ISNULL(  
		(  
			SELECT TOP 1 CountId  
			FROM @TBL_BrandDetail  
		), 0);  


	SELECT BrandId,Description,BrandCode,DisplayOrder,IsActive,WebsiteLink,BrandDetailLocaleId,MediaPath,MediaId,ImageName,SEOTitle,SEOKeywords,SEOURL SEOFriendlyPageName,SEODescription,MetaInformation,IsRedirect,BrandName,@PromotionId PromotionId   
		,SEOCode,Custom1, Custom2, Custom3, Custom4, Custom5
	FROM @TBL_BrandDetail; 
	
END TRY  
BEGIN CATCH  
DECLARE @Status BIT ;  
	SET @Status = 0;  
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),   
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetBrandDetailsLocale @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@LocaleId = '+CAST(@LocaleId AS VARCHAR(50))
	+',@IsAssociated='+CAST(@IsAssociated AS VARCHAR(50))+',@PromotionId='+CAST(@PromotionId AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));  
                    
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
      
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_GetBrandDetailsLocale',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH;  
END;
	 

GO

INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'BlogNews','ActivateDeactivateBlogNews',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'BlogNews' and ActionName = 'ActivateDeactivateBlogNews')

INSERT INTO ZnodeActionMenu ( MenuId,	ActionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
 (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Blogs & News' AND ControllerName = 'BlogNews')	
    ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'BlogNews' and ActionName = 'ActivateDeactivateBlogNews') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = 
     (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Blogs & News' AND ControllerName = 'BlogNews') and ActionId = 
     (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'BlogNews' and ActionName = 'ActivateDeactivateBlogNews'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId,	ActionId, AccessPermissionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Blogs & News' AND ControllerName = 'BlogNews'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'BlogNews' and ActionName = 'ActivateDeactivateBlogNews')	
,2,2,Getdate(),2,Getdate() WHERE NOT EXISTS 
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Blogs & News' AND ControllerName = 'BlogNews') and ActionId = 
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'BlogNews' and ActionName = 'ActivateDeactivateBlogNews'))

GO

Update ZnodeSearchFeature set HelpDescription = 'When an entered keyword is misspelled, Autocorrect helps in identifying the correct spelling to display the associated product. Autocorrect does not work with query type Multimatch-Cross and therefore its value should be set as No for such scenario.' 
where FeatureCode = 'AutoCorrect' and HelpDescription not like '%No for such scenario.'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateDownloadableProductsOrderDetail')
	DROP PROC Znode_InsertUpdateDownloadableProductsOrderDetail
GO

 CREATE PROCEDURE [dbo].[Znode_InsertUpdateDownloadableProductsOrderDetail]
(  
	@OMSDownloadableProduct  OMSDownloadableProduct READONLY,
	@UserId INT, 
	@OmsOrderDetailsId INT
)		
AS 
/*
    Summary: This procedure is used to insert data into table ZnodeOmsDownloadableProductKey
			 retrive data FROM ZnodePimDownloadableProductKey table for specific key of respective SKU
			 as per sold quantity with different key.
			  
	Unit Testing: 
	begin transaction 
	declare @p7 int
	set @p7=NULL
	declare @p12 dbo.OMSDownloadableProduct
	INSERT INTO @p12 values(123,'234234234234',4)
	INSERT INTO @p12 values(123,'WTR 07M4431',4)
		exec sp_executesql N'Znode_InsertUpdateDownloadableProductsOrderDetail  @OMSDownloadableProduct_local,@UserId',
		N'@OMSDownloadableProduct_local [dbo].[OMSDownloadableProduct] READONLY, @UserId int 
	',@OMSDownloadableProduct_local=@p12,@UserId =2 
	SELECT @p7
	rollback transaction 


*/
BEGIN
BEGIN TRY
    SET NOCOUNT ON;
	Declare @RowCount int, @StartWith int ,@ItemNo int ,  @Quantity int , @SQLQuery  nvarchar(max),@SKU nvarchar(300), @OmsOrderLineItemsId int 
	Declare @SKUSoldWithKeys TABLE (SKU nvarchar(300),ProductName nvarchar(300),PimDownloadableProductKeyId int,DownloadableProductKey nvarchar(250),DownloadableProductURL nvarchar(2000))
	Declare @SKUSoldWithKeysOutPut TABLE (SKU nvarchar(300),ProductName nvarchar(300), PimDownloadableProductKeyId int,DownloadableProductKey nvarchar(250),DownloadableProductURL nvarchar(2000),[OmsOrderLineItemsId] [int] )

	DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
	SET @StartWith  =1 

	Declare @OMSDownloadableProduct_local AS TABLE
	(
		[RowNum] [int]  Identity(1,1),
		[OmsOrderLineItemsId] [int] NULL,
		[SKU] [varchar](300) NULL,
		[Quantity] [numeric](26, 8) NULL
	)
	
	INSERT INTO @OMSDownloadableProduct_local
	SELECT * FROM @OMSDownloadableProduct

	---Updating lineitemid on basis of sku and order details id
	UPDATE a SET OmsOrderLineItemsId = b.OmsOrderLineItemsId
	FROM @OMSDownloadableProduct_local a
	INNER JOIN ZnodeOmsOrderLineItems b WITH (NOLOCK) ON a.SKU = b.Sku
	WHERE b.ParentOmsOrderLineItemsId IS NOT NULL AND B.OmsOrderDetailsId = @OmsOrderDetailsId

	SELECT @RowCount = MAx(RowNum) FROM @OMSDownloadableProduct_local 
	While @StartWith <= @RowCount 
	Begin
		SET @SKU = ''
		SET @Quantity =  0 
		SET @OmsOrderLineItemsId = 0 

		SELECT @Quantity = Quantity ,@SKU = SKU , @OmsOrderLineItemsId = [OmsOrderLineItemsId]  FROM @OMSDownloadableProduct_local where RowNum = @StartWith 

		SET @SQLQuery   = 
		'SELECT TOP ' + Convert(Varchar(10), @Quantity ) + ' ZPDP.SKU,ZPDP.ProductName, ZPDPK.PimDownloadableProductKeyId, ZPDPK.DownloadableProductKey,ZPDPK.DownloadableProductURL
		FROM ZnodePimDownloadableProduct ZPDP WITH (NOLOCK) INNER JOIN  ZnodePimDownloadableProductKey ZPDPK WITH (NOLOCK)  ON 
		ZPDP.PimDownloadableProductId =ZPDPK.PimDownloadableProductId where ZPDP.SKU  =''' +  @SKU + ''' AND ZPDPK.IsUsed = 0 '

		INSERT INTO @SKUSoldWithKeys 
		EXEC sys.sp_sqlexec @SQLQuery;

		INSERT INTO @SKUSoldWithKeysOutPut(SKU,ProductName,PimDownloadableProductKeyId,DownloadableProductKey,DownloadableProductURL,[OmsOrderLineItemsId]) 
		SELECT ssk.SKU,ProductName,PimDownloadableProductKeyId,DownloadableProductKey,DownloadableProductURL,@OmsOrderLineItemsId  
		FROM @SKUSoldWithKeys ssk
		INNER JOIN @OMSDownloadableProduct_local ODL ON (ssk.SKU = ODL.SKU AND ODL.OmsOrderLineItemsId = @OmsOrderLineItemsId)

		INSERT INTO ZnodeOmsDownloadableProductKey (OmsOrderLineItemsId,PimDownloadableProductKeyId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT @OmsOrderLineItemsId, PimDownloadableProductKeyId,@UserId,@GetDate,@UserId,@GetDate  FROM @SKUSoldWithKeysOutPut ssko
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeOmsDownloadableProductKey ODP WITH (NOLOCK) WHERE ODP.OmsOrderLineItemsId =  @OmsOrderLineItemsId 
		AND ODP.PimDownloadableProductKeyId = ssko.PimDownloadableProductKeyId)
										
		UPDATE PDP SET PDP.IsUsed =1 
		FROM @SKUSoldWithKeysOutPut SSWK 
		INNER JOIN ZnodePimDownloadableProductKey PDP ON SSWK.PimDownloadableProductKeyId = PDP.PimDownloadableProductKeyId

		SET @StartWith  = @StartWith  + 1 
	End   
	SELECT * FROM @SKUSoldWithKeysOutPut 	
END TRY
BEGIN CATCH
DECLARE @Status BIT ;
	SET @Status = 0;
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertUpdateDownloadableProductsOrderDetail @OMSDownloadableProduct_local = '
			 
              			 
    SELECT 0 AS ID,CAST(0 AS BIT) AS Status,ERROR_MESSAGE();                    
		  
    EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_InsertUpdateDownloadableProductsOrderDetail',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;

END CATCH

END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_UpdateInventoryPostOrder')
	DROP PROC Znode_UpdateInventoryPostOrder
GO

CREATE PROCEDURE [dbo].[Znode_UpdateInventoryPostOrder]
(
	@SkuXml xml,
	@PortalId int, 
	@UserId int, 
	@Status bit OUT, 
	@OmsOrderId INT,
	@IsDebug bit= 0
)
AS 
	/*
	Summary: (13671)   Inventory will be updated on the basis of "InventoryTracking" (Attribute Code) value in locale table 
				    If value id "DisablePurchasing" then subtracts currently selected quantity only when it will greater than zero.
				    If "AllowBackordering" then inventory will become negative
				    If "DontTrackInventory" then don't update inventory.
				    inventory will be get deducted from associated warehouse where quantity is available as per warehouse precedence. 
				    Validate total quantity 
	Input Parameters:
	SKU(Comma separated multiple), PortalId
	Unit Testing   
		Declare @Status bit 
		Exec Znode_UpdateInventory  @SkuXml = '<ArrayOfOrderWarehouseLineItemsModel>
		<OrderWarehouseLineItemsModel>
		<OrderLineItemId>418</OrderLineItemId>
		<SKU>ap1534</SKU>
		<InventoryTracking>DisablePurchasing</InventoryTracking>
		<Quantity>1.000000</Quantity>
		</OrderWarehouseLineItemsModel>
		<OrderWarehouseLineItemsModel>
		<OrderLineItemId>419</OrderLineItemId>
		<SKU>al8907</SKU>
		<InventoryTracking>DisablePurchasing</InventoryTracking>
		<Quantity>1.000000</Quantity>
		</OrderWarehouseLineItemsModel>
		</ArrayOfOrderWarehouseLineItemsModel>',@PortalId = 1,@UserId = 2,@Status = @Status

	*/
BEGIN
	BEGIN TRAN UpdateInventory;
	BEGIN TRY
		SET NOCOUNT ON;
		DECLARE @RoundOffValue INT= dbo.Fn_GetDefaultValue('InventoryRoundOff');
		DECLARE @TBL_XmlReturnToTable TABLE
		( 
			OrderLineItemId int, SKU nvarchar(max), InventoryTracking nvarchar(1000), Quantity numeric(28, 6),
			AllowBackOrder VARCHAR(100), SequenceNo int IDENTITY, OrderLineItemRelationshipTypeId int 
		);
		DECLARE @TBL_ErrorInventoryTracking TABLE
		( 
			SKU nvarchar(max), Quantity numeric(28, 6), InventoryTracking nvarchar(2000), AllowBackOrder varchar(100)
		);
		INSERT INTO @TBL_XmlReturnToTable( OrderLineItemId, SKU, InventoryTracking, Quantity,AllowBackOrder )
		SELECT Tbl.Col.value( 'OrderLineItemId[1]', 'INT' ) AS OrderLineItemId, Tbl.Col.value( 'SKU[1]', 'NVARCHAR(2000)' ) AS SKU, Tbl.Col.value( 'InventoryTracking[1]', 'NVARCHAR(2000)' ) AS InventoryTracking, Tbl.Col.value( 'Quantity[1]', 'Numeric(28,6)' ) AS Quantity
		, Tbl.Col.value( 'AllowBackOrder[1]', 'VARCHAR(100)' ) AS AllowBackOrder
		FROM @SkuXml.nodes( '//ArrayOfOrderWarehouseLineItemsModel/OrderWarehouseLineItemsModel' ) AS Tbl(Col)
		WHERE Tbl.Col.value( 'InventoryTracking[1]', 'NVARCHAR(2000)' ) <> 'DontTrackInventory' 
		AND Tbl.Col.value( 'Quantity[1]', 'Numeric(28,6)' ) > 0;

		DECLARE @Cur_WarehouseId int, @Cur_PortalId int, @Cur_PortalWarehouseId int, @Cur_WarehouseSequence int, @Cur_SKU varchar(200), @Cur_Quantity numeric(28, 6), @Cur_ReOrderLevel numeric(28, 6), @Cur_InventoryId int;

		DECLARE @RecurringQuantity numeric(28, 6), @BalanceQuantity numeric(28, 6)
		SET @Status = 0; 

		---Updating order line item
		UPDATE TBL SET OrderLineItemId = ZOOLI.OmsOrderLineItemsId, TBL.OrderLineItemRelationshipTypeId = ZOOLI.OrderLineItemRelationshipTypeId 
		FROM ZnodeOmsOrderLineItems ZOOLI WITH (NOLOCK)
		INNER JOIN @TBL_XmlReturnToTable TBL ON ZOOLI.Sku = TBL.SKU
		WHERE EXISTS(SELECT * FROM ZnodeOmsOrderDetails ZOOD WITH (NOLOCK) WHERE ZOOLI.OmsOrderDetailsId = ZOOD.OmsOrderDetailsId AND ZOOD.OmsOrderId = @OmsOrderId)
		AND ZOOLI.ParentOmsOrderLineItemsId IS NOT NULL

		DECLARE @TBL_CalculateQuntity TABLE
		( 
			WarehouseId int, SKU varchar(200), MainQuantity numeric(28, 6), InventoryId int, OrderQuantity numeric(28, 6), UpdatedQuantity numeric(28, 6), WarehouseSequenceId int, InventoryTracking nvarchar(2000)
			, AllowBackOrder varchar(100)
		);
		
		DECLARE @TBL_AllwareHouseToportal TABLE
		( 
			WarehouseId int, PortalId int, PortalWarehouseId int, WarehouseSequenceFirst int, WarehouseSequence int, SKU varchar(200), Quantity numeric(28, 6), ReOrderLevel numeric(28, 6), InventoryId int
		);
		
		SELECT WarehouseId, PortalId, PortalWarehouseId, Precedence
		INTO #PortalWarehouse
		FROM [ZnodePortalWarehouse] WITH (NOLOCK)
		WHERE PortalId = @PortalId
		UNION 
		SELECT WarehouseId, @PortalId AS PortalId, PortalWarehouseId, Precedence
		FROM [dbo].[ZnodePortalAlternateWarehouse] AS zpaw WITH (NOLOCK)
		WHERE EXISTS ( SELECT TOP 1 1 FROM [ZnodePortalWarehouse] AS a WHERE zpaw.PortalWarehouseId = a.PortalWarehouseId AND  a.PortalId = @PortalId)  
		
		INSERT INTO @TBL_AllwareHouseToportal( WarehouseId, PortalId, PortalWarehouseId, SKU, Quantity, ReOrderLevel, InventoryId, WarehouseSequence, WarehouseSequenceFirst )
		SELECT ZPW.WarehouseId, ZPW.PortalId, zpw.PortalWarehouseId, zi.SKU, zi.Quantity, zi.ReOrderLevel, zi.InventoryId, DENSE_RANK() OVER(ORDER BY ZPW.WarehouseId), 1
		FROM dbo.ZnodeInventory AS zi WITH (NOLOCK)
		LEFT JOIN #PortalWarehouse AS ZPW ON ZPW.WarehouseId = ZI.WareHouseId AND  ZPW.PortalId = @PortalId
		WHERE EXISTS ( SELECT TOP 1 1  FROM @TBL_XmlReturnToTable AS TBXRT WHERE RTRIM(LTRIM(TBXRT.SKU)) = RTRIM(LTRIM(zi.SKU))) 
		AND ZPW.WarehouseId IS NOT NULL
		ORDER BY ZPW.Precedence DESC

		--Total Avaialble qunatity in all warehouse 
		IF EXISTS ( SELECT TOP 1 1 FROM @TBL_XmlReturnToTable WHERE InventoryTracking = 'DisablePurchasing')
		BEGIN
			INSERT INTO @TBL_ErrorInventoryTracking 
			SELECT TBAHL.SKU, SUM(TBAHL.Quantity), InventoryTracking,TBXML.AllowBackOrder 
			FROM @TBL_XmlReturnToTable AS TBXML
			LEFT JOIN @TBL_AllwareHouseToportal AS TBAHL ON(TBAHL.SKU = TBXML.SKU) 
			INNER JOIN ZnodeOmsOrderLineItems b on (TBXML.orderlineitemid = b.OmsOrderLineItemsId)
			WHERE InventoryTracking = 'DisablePurchasing'
			AND b.OrderLineItemRelationshipTypeId IS NOT NULL
			GROUP BY TBXML.AllowBackOrder ,TBAHL.SKU, InventoryTracking HAVING SUM(TBAHL.Quantity) < 1 ORDER BY TBAHL.SKU;
			IF EXISTS ( SELECT TOP 1 1 FROM @TBL_ErrorInventoryTracking )
			BEGIN
				SET @Status = 0;
				RAISERROR(15600, -1, -1, 'DisablePurchasing');
			END;
		END;

		---Getting data for simple , configurable and group
		INSERT INTO @TBL_CalculateQuntity
		SELECT WarehouseId, TBXML.SKU, TBAHL.Quantity, TBAHL.InventoryId, TBXML.Quantity, NULL AS UpdatedQuantity, DENSE_RANK() 
		OVER(ORDER BY WarehouseSequenceFirst,WarehouseSequence), InventoryTracking, TBXML.AllowBackOrder
		FROM @TBL_XmlReturnToTable AS TBXML	
		INNER  JOIN @TBL_AllwareHouseToportal AS TBAHL ON(TBAHL.SKU = TBXML.SKU)
		WHERE EXISTS(SELECT * FROM ZnodeOmsOrderLineItems ZOOLI WHERE TBXML.OrderLineItemId = ZOOLI.OmsOrderLineItemsId
			AND ZOOLI.ParentOmsOrderLineItemsId IS NOT NULL) 
		AND isnull(TBXML.OrderLineItemRelationshipTypeId,0) not in (SELECT OrderLineItemRelationshipTypeId FROM ZnodeOmsOrderLineItemRelationshipType WHERE Name IN ('Configurable','Group'))
		ORDER BY  WarehouseSequenceFirst,WarehouseSequence;

		---Getting data for bundle products
		INSERT INTO @TBL_CalculateQuntity
		SELECT WarehouseId, TBXML.SKU, TBAHL.Quantity, TBAHL.InventoryId, TBXML.Quantity, NULL AS UpdatedQuantity, DENSE_RANK() 
		OVER(ORDER BY WarehouseSequenceFirst,WarehouseSequence), InventoryTracking, TBXML.AllowBackOrder
		FROM @TBL_XmlReturnToTable AS TBXML	
		INNER  JOIN @TBL_AllwareHouseToportal AS TBAHL ON(TBAHL.SKU = TBXML.SKU)
		WHERE EXISTS(SELECT * FROM ZnodeOmsOrderLineItems ZOOLI where TBXML.OrderLineItemId = ZOOLI.OmsOrderLineItemsId and ZOOLI.ParentOmsOrderLineItemsId is null)
		AND TBXML.OrderLineItemRelationshipTypeId in (SELECT OrderLineItemRelationshipTypeId FROM ZnodeOmsOrderLineItemRelationshipType Where Name IN ('Configurable','Group'))
		ORDER BY  WarehouseSequenceFirst,WarehouseSequence;

		;with cte as
		(
			SELECT WarehouseId,	a.SKU,	MainQuantity,	InventoryId,	WarehouseSequenceId,	a.InventoryTracking,	AllowBackOrder,sum(OrderQuantity) as OrderQuantity
			FROM @TBL_CalculateQuntity A
			GROUP BY WarehouseId,	a.SKU,	MainQuantity,	InventoryId,	WarehouseSequenceId,	InventoryTracking,	AllowBackOrder
		)
		UPDATE b set  b.OrderQuantity = a.OrderQuantity
		FROM cte a
		INNER JOIN @TBL_CalculateQuntity b on a.SKU = b.SKU and a.InventoryId = b.InventoryId and a.WarehouseId = b.WarehouseId

		
		UPDATE @TBL_CalculateQuntity 
		SET UpdatedQuantity = MainQuantity - OrderQuantity  
		WHERE WarehouseSequenceId = 1;
		 		
		DECLARE @CountToRepeate int= ( SELECT count( distinct WarehouseId) FROM @TBL_CalculateQuntity),@Initializationofloop int= 2;
       
		WHILE @Initializationofloop <= @CountToRepeate 
				AND EXISTS (SELECT TOP 1 1 FROM @TBL_CalculateQuntity AS a 
					WHERE UpdatedQuantity < 0  )
		BEGIN
		 
			UPDATE a  
			SET a.UpdatedQuantity = a.MainQuantity + b.UpdatedQuantity 
			FROM @TBL_CalculateQuntity a 
			INNER JOIN @TBL_CalculateQuntity b ON (a.Sku = b.Sku AND b.WarehouseSequenceId = (@Initializationofloop - 1)) 
			WHERE a.WarehouseSequenceId = @Initializationofloop 
			AND b.UpdatedQuantity < 0
			AND b.UpdatedQuantity IS NOT NULL 

			UPDATE @TBL_CalculateQuntity 
			SET UpdatedQuantity  = 0 
			WHERE WarehouseSequenceId = @Initializationofloop -1 
			AND UpdatedQuantity < 0
			AND UpdatedQuantity IS NOT NULL 

			SET @Initializationofloop = @Initializationofloop + 1;
		END; 
		
		
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_CalculateQuntity WHERE ISNULL(UpdatedQuantity,0) < 0 AND @CountToRepeate >1)
		BEGIN 
			UPDATE a  
			SET a.UpdatedQuantity = b.UpdatedQuantity 
			FROM @TBL_CalculateQuntity a 
			INNER JOIN @TBL_CalculateQuntity b ON (a.Sku = b.Sku AND b.WarehouseSequenceId = @Initializationofloop -1 ) 
			WHERE a.WarehouseSequenceId = 1 
			AND ISNULL(b.UpdatedQuantity,0) < 0

			UPDATE @TBL_CalculateQuntity 
			SET UpdatedQuantity  = 0 
			WHERE WarehouseSequenceId = @Initializationofloop -1 
			--AND  InventoryTracking <> 'AllowBackordering'
			AND ISNULL(UpdatedQuantity,0) < 0
		END 
			
			
		--If "AllowBackordering" then inventory will go to be negative conside only single warehouse
		IF EXISTS(SELECT TOP 1 1 FROM @TBL_XmlReturnToTable WHERE InventoryTracking = 'AllowBackordering')
		BEGIN
			UPDATE ZI SET Quantity = Isnull(TBCQ.UpdatedQuantity,0) 
			FROM dbo.ZnodeInventory ZI 
			INNER JOIN @TBL_CalculateQuntity TBCQ ON(Zi.InventoryId = TBCQ.InventoryId)
			WHERE InventoryTracking = 'AllowBackordering' AND  UpdatedQuantity IS NOT NULL  ;
			SET @Status = 1;
		END;
		
		-- If @InventoryTracking is "DisablePurchasing" then subtracts currently selected quantity only when it will greater than zero.
		IF EXISTS ( SELECT TOP 1 1 FROM @TBL_XmlReturnToTable WHERE InventoryTracking = 'DisablePurchasing')
		BEGIN
			SET @BalanceQuantity = 1;
			UPDATE ZI 
			SET Quantity = CASE WHEN TBCQ.UpdatedQuantity < 0 THEN 0 ELSE TBCQ.UpdatedQuantity END 
			FROM dbo.ZnodeInventory ZI 
			INNER JOIN  @TBL_CalculateQuntity TBCQ ON(Zi.InventoryId = TBCQ.InventoryId) WHERE InventoryTracking = 'DisablePurchasing'
			AND TBCQ.UpdatedQuantity IS NOT NULL 
			;
		END;
		
		INSERT INTO ZnodeOmsOrderWarehouse( OmsOrderLineItemsId, WarehouseId,Quantity, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate )
		SELECT OrderLineItemId, WarehouseId,CASE WHEN UpdatedQuantity = 0 THEN MainQuantity ELSE MainQuantity - UpdatedQuantity END , @UserId, dbo.Fn_GetDate(), @UserId, dbo.Fn_GetDate() 
		FROM @TBL_CalculateQuntity AS TBCQ 
		INNER JOIN @TBL_XmlReturnToTable AS TBXR
			   ON(TBXR.SKU = TBCQ.SKU) WHERE UpdatedQuantity IS NOT NULL;
  
		SELECT DISTINCT SKU,
		 [dbo].[Fn_GetDefaultPriceRoundOffReturnNumeric](UpdatedQuantity) AS Quantity,
		  InventoryTracking,CAST(AllowBackOrder AS BIT) AllowBackOrder
		FROM @TBL_CalculateQuntity
		WHERE UpdatedQuantity IS NOT NULL;

		SET @Status = 1;
		COMMIT TRAN UpdateInventory;
	END TRY
	BEGIN CATCH
	
		SET @Status = 0;
		SELECT SKU, Quantity, InventoryTracking,CAST(AllowBackOrder AS BIT) AllowBackOrder
		FROM @TBL_ErrorInventoryTracking;
		
		ROLLBACK TRAN UpdateInventory;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetImportLogs')
	DROP PROC Znode_GetImportLogs
GO

CREATE PROCEDURE dbo.Znode_GetImportLogs
(
	@ImportProcessLogId INT
)
AS
/*
	Summary : Get import log details.
	Unit Testing  
	BEGIN TRAN
		EXEC Znode_GetImportLogs @ImportProcessLogId=1;
	ROLLBACK TRAN
*/
BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
		SELECT DISTINCT ImportProcessLogId,ImportTemplateId,Status,ProcessStartedDate,ProcessCompletedDate,CreatedDate,
			CreatedBy,ModifiedBy,ModifiedDate,ERPTaskSchedulerId,SuccessRecordCount,FailedRecordcount,
			TotalProcessedRecords,'' AS TemplateName,ImportName
		FROM
		(
			SELECT ZIP.ImportProcessLogId AS ImportProcessLogId,ZIP.ImportTemplateId AS ImportTemplateId,
				ZIP.[Status] AS [Status],ZIP.ProcessStartedDate AS ProcessStartedDate,
				ZIP.ProcessCompletedDate AS ProcessCompletedDate,ZIP.CreatedBy AS CreatedBy,
				ZIP.CreatedDate AS CreatedDate, ZIP.ModifiedBy AS ModifiedBy,ZIP.ModifiedDate AS ModifiedDate,
				ZIP.ERPTaskSchedulerId AS ERPTaskSchedulerId,ISNUll(ZIP.SuccessRecordCount,'0') AS SuccessRecordCount,
				ISNUll(ZIP.FailedRecordcount,'0') AS FailedRecordcount,ISNUll(ZIP.TotalProcessedRecords,'0') AS	TotalProcessedRecords,
				'' AS TemplateName,'' AS 'ImportName'
			FROM dbo.ZnodeImportProcessLog AS ZIP WITH(NOLOCK)
			--INNER JOIN ZnodeImportTemplate AS ZIT ON ZIP.ImportTemplateId = ZIT.ImportTemplateId
			--INNER JOIN ZnodeImportLog AS ZIL ON ZIP.ImportProcessLogId = ZIL.ImportProcessLogId
			WHERE ZIP.ImportProcessLogId=@ImportProcessLogId
		) logs
	END TRY
	BEGIN CATCH
		DECLARE @Status BIT;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(),
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetImportLogs @ImportProcessLogId = '+CAST(@ImportProcessLogId AS VARCHAR(50));
             
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_GetImportLogs',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;                              
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_MergeOmsSavedCartLineItems')
	DROP PROC Znode_MergeOmsSavedCartLineItems
GO


CREATE PROCEDURE [dbo].[Znode_MergeOmsSavedCartLineItems] 
(
	@OmsSavedCartId INT  
	,@OldOmsSavedCartId INT 
	,@UserId  INT 
	,@Status  BIT = 0  OUT
)
AS 
BEGIN 
 BEGIN TRY 
 SET NOCOUNT ON 

     DECLARE @AddOnOrderLineItemRelationshipTypeId INT = (SELECT TOP 1 OrderLineItemRelationshipTypeId 
															FROM ZnodeOmsOrderLineItemRelationshipType
															WHERE Name = 'Addons')
	 DECLARE @TBL_OmsSavedCartOld TABLE(SKU NVARCHAR(2000), OmsSavedCartLineItemId INT ,ParentSKU NVARCHAR(2000) , ParentOmsSavedCartLineItemId INT ,AddOnSKU NVARCHAR(2000), OmsSavedCartLineItemIdAddOn NVARCHAR(2000) ,PersonalizeCode NVARCHAR(1200), PersonalizeValue  NVARCHAr(max)  )

	 DECLARE @TBL_OmsSavedCartNew TABLE(SKU NVARCHAR(2000), OmsSavedCartLineItemId INT ,ParentSKU NVARCHAR(2000) , ParentOmsSavedCartLineItemId INT ,AddOnSKU NVARCHAR(2000), OmsSavedCartLineItemIdAddOn NVARCHAR(2000) ,PersonalizeCode NVARCHAR(1200), PersonalizeValue  NVARCHAr(max)  )

	 ----Adding dummy CookieMappingId if not present
	IF NOT EXISTS(SELECT * FROM ZnodeOmsCookieMapping where OmsCookieMappingId = 1)
	BEGIN
		SET IDENTITY_INSERT ZnodeOmsCookieMapping ON
		INSERT INTO ZnodeOmsCookieMapping(OmsCookieMappingId,UserId,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT 1,null,(select top 1 PortalId from ZnodePortal order by 1 ASC),2,getdate(),2,getdate()
		SET IDENTITY_INSERT ZnodeOmsCookieMapping OFF
	END

	----geting dummy OmsSavedCartId on basis of OmsCookieMappingId = 1 if not present then add
	Declare @OmsSavedCartIdDummy int = 0
	SET @OmsSavedCartIdDummy = (Select Top 1 OmsSavedCartId  from ZnodeOmsSavedCart With(NoLock) where OmsCookieMappingId = 1)
	IF ISNULL(@OmsSavedCartIdDummy ,0) = 0 
	BEGIN 
		INSERT INTO ZnodeOmsSavedCart(OmsCookieMappingId,SalesTax,RecurringSalesTax,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT  1,null,null,2,Getdate(),2,Getdate()
		SET @OmsSavedCartIdDummy  = @@IDENTITY
	END

	 SELECT OmsSavedCartLineItemId,  ParentOmsSavedCartLineItemId, SKU, Quantity, OrderLineItemRelationshipTypeId
	 INTO #ZnodeOmsSavedCartLineItemOld
	 FROM ZnodeOmsSavedCartLineItem a with(nolock)
	 WHERE OmsSavedCartId = @OldOmsSavedCartId 


	 SELECT OmsSavedCartLineItemId, PersonalizeCode, PersonalizeValue
	 INTO #ZnodeOmsPersonalizeCartItemOld
	 FROM ZnodeOmsPersonalizeCartItem a with(nolock)
	 WHERE EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsSavedCartLineItemOld t WHERE t.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)

	 SELECT OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, SKU, Quantity, OrderLineItemRelationshipTypeId
	 INTO #ZnodeOmsSavedCartLineItemNew
	 FROM ZnodeOmsSavedCartLineItem a with(nolock)
	 WHERE OmsSavedCartId = @OmsSavedCartId 


	 SELECT OmsSavedCartLineItemId, PersonalizeCode, PersonalizeValue 
	 INTO #ZnodeOmsPersonalizeCartItemNew
	 FROM ZnodeOmsPersonalizeCartItem a with(nolock)
	 WHERE EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsSavedCartLineItemNew t WHERE t.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)

	 

	 INSERT INTO @TBL_OmsSavedCartOld (SKU,OmsSavedCartLineItemId,ParentSKU,ParentOmsSavedCartLineItemId)
	 SELECT SKU , OmsSavedCartLineItemId,(SELECT TOP 1 SKU FROM #ZnodeOmsSavedCartLineItemOld TBL_B WHERE TBL_B.OmsSavedCartLineItemId = ISNULL(TBL_A.ParentOmsSavedCartLineItemId,0)  ) ParentSKU
				, ParentOmsSavedCartLineItemId
	 FROM #ZnodeOmsSavedCartLineItemOld TBL_A
	 WHERE OrderLineItemRelationshipTypeId IS NOT NULL AND OrderLineItemRelationshipTypeId <> @AddOnOrderLineItemRelationshipTypeId
	 
	

	 ;With Cte_UpdateOld AS 
	 (
		SELECT ParentOmsSavedCartLineItemId , SUBSTRING((SELECT ','+SKU FROM #ZnodeOmsSavedCartLineItemOld t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId FOR XML PATH('') ),2,4000)  SKU
		     , SUBSTRING((SELECT ','+CAST(OmsSavedCartLineItemId AS NVARCHAR(max)) FROM #ZnodeOmsSavedCartLineItemOld t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId FOR XML PATH('') ),2,4000)  OmsSavedCartLineItemId
		FROM #ZnodeOmsSavedCartLineItemOld a 
		WHERE a.OrderLineItemRelationshipTypeId = @AddOnOrderLineItemRelationshipTypeId
	 )
	 UPDATE TBL_O
	 SET TBL_O.AddOnSKU =  TBL_ON.SKU
		,TBL_O.OmsSavedCartLineItemIdAddOn =  TBL_ON.OmsSavedCartLineItemId
	 FROM @TBL_OmsSavedCartOld TBL_O 
	 INNER JOIN Cte_UpdateOld TBL_ON ON (TBL_ON.ParentOmsSavedCartLineItemId  = TBL_O.OmsSavedCartLineItemId )
	   
     UPDATE TBL_O
	 SET TBL_O.PersonalizeCode = TBL_ON.PersonalizeCode
		,TBL_O.PersonalizeValue =  TBL_ON.PersonalizeValue
	 FROM @TBL_OmsSavedCartOld TBL_O 
	 INNER JOIN #ZnodeOmsPersonalizeCartItemOld TBL_ON ON (TBL_ON.OmsSavedCartLineItemId  = TBL_O.OmsSavedCartLineItemId )

	  INSERT INTO @TBL_OmsSavedCartNew (SKU,OmsSavedCartLineItemId,ParentSKU,ParentOmsSavedCartLineItemId)
	    SELECT SKU , OmsSavedCartLineItemId,(SELECT TOP 1 SKU FROM #ZnodeOmsSavedCartLineItemNew TBL_B WHERE TBL_B.OmsSavedCartLineItemId = ISNULL( TBL_A.ParentOmsSavedCartLineItemId,0)   ) ParentSKU
					, ParentOmsSavedCartLineItemId
		FROM #ZnodeOmsSavedCartLineItemNew TBL_A
		WHERE OrderLineItemRelationshipTypeId IS NOT NULL AND OrderLineItemRelationshipTypeId <> @AddOnOrderLineItemRelationshipTypeId
	 
	 ;WITH Cte_UpdateNew AS 
	 (
		SELECT ParentOmsSavedCartLineItemId , SUBSTRING((SELECT ','+SKU FROM #ZnodeOmsSavedCartLineItemNew t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId FOR XML PATH('') ),2,4000)  SKU
		     , SUBSTRING((SELECT ','+CAST(OmsSavedCartLineItemId AS NVARCHAR(max)) FROM #ZnodeOmsSavedCartLineItemNew t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId FOR XML PATH('') ),2,4000)  OmsSavedCartLineItemId
		FROM #ZnodeOmsSavedCartLineItemNew a 
		WHERE a.OrderLineItemRelationshipTypeId = @AddOnOrderLineItemRelationshipTypeId
	 )
	 UPDATE TBL_O
	 SET TBL_O.AddOnSKU =  TBL_ON.SKU
		,TBL_O.OmsSavedCartLineItemIdAddOn =  TBL_ON.OmsSavedCartLineItemId
	 FROM @TBL_OmsSavedCartNew TBL_O 
	 INNER JOIN Cte_UpdateNew TBL_ON ON (TBL_ON.ParentOmsSavedCartLineItemId  = TBL_O.OmsSavedCartLineItemId )
	   
	 UPDATE TBL_O
	 SET TBL_O.PersonalizeCode = TBL_ON.PersonalizeCode
		,TBL_O.PersonalizeValue =  TBL_ON.PersonalizeValue
	 FROM @TBL_OmsSavedCartNew TBL_O 
	 INNER JOIN #ZnodeOmsPersonalizeCartItemNew TBL_ON ON (TBL_ON.OmsSavedCartLineItemId  = TBL_O.OmsSavedCartLineItemId )

	BEGIN TRAN DELETEOLDSAVECART
		IF EXISTS (SELECT * FROM ZnodeOmsSavedCartLineItem WHERE OmsSavedCartId=@OldOmsSavedCartId)
		BEGIN
			UPDATE a 
			SET  a.Quantity =  a.Quantity+d.Quantity 
			FROM ZnodeOmsSavedCartLineItem a 
			INNER JOIN @TBL_OmsSavedCartNew b ON (b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
			INNER JOIN @TBL_OmsSavedCartOld c ON (c.SKU = b.SKU AND c.ParentSKU = b.ParentSKU AND ISNULL(c.AddOnSKU,'-1') = ISNULL(b.AddOnSKU,'-1') AND ISNULL(c.PersonalizeCode,'-1') = ISNULL(b.PersonalizeCode,'-1') AND ISNULL(c.PersonalizeValue,'-1') = ISNULL(b.PersonalizeValue,'-1')) 
			INNER JOIN #ZnodeOmsSavedCartLineItemOld d ON (d.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId)
		END
		ELSE
		BEGIN
			UPDATE a 
			SET  a.Quantity =  d.Quantity 
			FROM ZnodeOmsSavedCartLineItem a 
			INNER JOIN @TBL_OmsSavedCartNew b ON (b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
			INNER JOIN @TBL_OmsSavedCartOld c ON (c.SKU = b.SKU AND c.ParentSKU = b.ParentSKU AND ISNULL(c.AddOnSKU,'-1') = ISNULL(b.AddOnSKU,'-1') AND ISNULL(c.PersonalizeCode,'-1') = ISNULL(b.PersonalizeCode,'-1') AND ISNULL(c.PersonalizeValue,'-1') = ISNULL(b.PersonalizeValue,'-1')) 
			INNER JOIN #ZnodeOmsSavedCartLineItemOld d ON (d.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId)
		END
	 
		 UPDATE  a
		 SET a.OmsSavedCartId = @OmsSavedCartId
		 FROM ZnodeOmsSavedCartLineItem a 
		 WHERE NOT EXISTS (SELECT TOP 1 1 FROM @TBL_OmsSavedCartOld b 
			 INNER JOIN @TBL_OmsSavedCartNew c ON (c.SKU = b.SKU AND c.ParentSKU = b.ParentSKU AND ISNULL(c.AddOnSKU,'-1') = ISNULL(b.AddOnSKU,'-1') AND ISNULL(c.PersonalizeCode,'-1') = ISNULL(b.PersonalizeCode,'-1') AND ISNULL(c.PersonalizeValue,'-1') = ISNULL(b.PersonalizeValue,'-1'))
			 WHERE b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
		 AND NOT EXISTS (SELECT TOP 1 1 FROM @TBL_OmsSavedCartOld b 
			 INNER JOIN @TBL_OmsSavedCartNew c ON (c.SKU = b.SKU AND c.ParentSKU = b.ParentSKU AND ISNULL(c.AddOnSKU,'-1') = ISNULL(b.AddOnSKU,'-1') AND ISNULL(c.PersonalizeCode,'-1') = ISNULL(b.PersonalizeCode,'-1') AND ISNULL(c.PersonalizeValue,'-1') = ISNULL(b.PersonalizeValue,'-1'))
			 WHERE b.ParentOmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
		 AND OmsSavedCartId = @OldOmsSavedCartId 

		 Update ZnodeOmsSavedCartLineItem SET OmsSavedCartId = @OmsSavedCartIdDummy  WHERE OmsSavedCartId = @OldOmsSavedCartId

		 ;WITH CTE_UpdateOrder 
		 AS 
		 (
		   SELECT Sequence,  ROW_NUMBER()Over(order BY OmsSavedCartLineItemId ASC) RowId
		   FROM ZnodeOmsSavedCartLineItem
		   WHERE  OmsSavedCartId = @OmsSavedCartId
	 
		 ) 
		 UPDATE CTE_UpdateOrder 
		 SET Sequence =RowId
	 

		 UPDATE ZnodeOmsSavedCart
		 SET ModifiedDate = GETDATE()
		 WHERE OmsSavedCartId = @OmsSavedCartId

	 COMMIT TRAN DELETEOLDSAVECART
	 SET @Status = 1 

 END TRY 
 BEGIN CATCH 
 ROLLBACK TRAN DELETEOLDSAVECART
  SELECT ERROR_MESSAGE()
   SET @Status = 0

	SET @Status = 0;
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_MergeOmsSavedCartLineItems @OmsSavedCartId = '+CAST(@OmsSavedCartId AS VARCHAR(max))+',@OldOmsSavedCartId='+CAST(@OldOmsSavedCartId AS VARCHAR(50))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status = '+CAST(@Status AS VARCHAR(50));

    SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

    EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_MergeOmsSavedCartLineItems',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
 END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPimProductAttributeInventory')
	DROP PROC Znode_GetPimProductAttributeInventory
GO

CREATE  PROCEDURE [dbo].[Znode_GetPimProductAttributeInventory]
(   @SKU    SelectColumnList READONLY
    --@IsMultipleProduct BIT          = 0
	)
AS
/*
     Summary : - This procedure is used to find the inventory of product 
     Unit Testing 
	 begin tran
     Exec Znode_GetPimProductAttributeInventory 7
	 rollback tran
*/
     BEGIN
	 BEGIN TRAN PimProductAttributeFamilyId
         BEGIN TRY
             SET NOCOUNT ON;
			
			 IF OBJECT_ID('tempdb.dbo.#TBL_PimProductId', 'U') IS NOT NULL 
		     DROP TABLE #TBL_PimProductId
		 
			 SELECT StringColumn AS SKU INTO #TBL_PimProductId  FROM @SKU 
			
			-- DontTrackInventory cant have inventory
			SELECT sum(ZI.Quantity ) quantity  ,a.PimProductId 
			INTO #TBL_InventoryDetails
			FROM ZnodePimAttributeValue a 
			INNER JOIN  ZnodePimAttributeValueLocale b ON ( b.PimAttributeValueId = a.PimAttributeValueId )
			INNER JOIN ZnodePimAttribute c ON ( c.PimAttributeId=a.PimAttributeId )
			LEFT JOIN  ZnodeInventory ZI ON ZI.SKU = b.AttributeValue 
			LEFT JOIN ZnodeWarehouse ZW on (ZI.WarehouseId = ZW.WarehouseId)
			WHERE EXISTS(SELECT TOP 1 1 FROM #TBL_PimProductId TBP WHERE b.AttributeValue = TBP.SKU )
			AND c.AttributeCode = 'SKU'
			GROUP BY a.PimProductId 

			SELECT DISTINCT CASE WHEN  AttributeDefaultValueCode = 'DontTrackInventory' THEN 'DTI' 
			ELSE [dbo].[Fn_GetDefaultInventoryRoundOff](ISNULL(Quantity, 0))     END Quantity  ,tb.PimProductId 
			INTO #CTE_Getdetails
			FROM #TBL_InventoryDetails tb
			INNER JOIN ZnodePimAttributeValue PAV ON (PAV.PimProductId = tb.PimProductId)
			INNER JOIN ZnodePimProductAttributeDefaultValue a on (a.PimAttributeValueId = pav.PimAttributeValueId)
			INNER JOIN ZnodePimAttributeDefaultValue dv on (a.PimAttributeDefaultValueId = dv.PimAttributeDefaultValueId)
			INNER JOIN ZnodePimAttribute PA ON (PA.pimattributeId = PAV.pimAttributeid )
			WHERE  PA.Attributecode = 'OutOfStockOptions'
			 
		
			 SELECT   CAST(quantity AS NVARCHAR(100))  quantity ,PimProductId
			 FROM #CTE_Getdetails

			IF OBJECT_ID('tempdb.dbo.#TBL_PimProductId', 'U') IS NOT NULL 
			DROP TABLE #TBL_PimProductId
	
		 COMMIT TRAN PimProductAttributeFamilyId;
         END TRY
         BEGIN CATCH
				
          DECLARE @Status BIT ;
		  SET @Status = 0;
		  DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), 
		  @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		  @ErrorLine VARCHAR(100)= ERROR_LINE(), 
		  @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPimProductAttributeInventory' ;
              			 
          SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  ROLLBACK TRAN PimProductAttributeFamilyId;

          EXEC Znode_InsertProcedureErrorLog
            @ProcedureName = 'Znode_GetPimProductAttributeInventory',
            @ErrorInProcedure = @Error_procedure,
            @ErrorMessage = @ErrorMessage,
            @ErrorLine = @ErrorLine,
            @ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishAssociatedAddonsJson')
	DROP PROC Znode_GetPublishAssociatedAddonsJson
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishAssociatedAddonsJson]
(
	@PublishCatalogId NVARCHAR(MAX) = 0,
	@PimProductId    TransferId Readonly,
	@VersionId        INT           = 0,
	@UserId           INT,														 
	@PimCategoryHierarchyId int = 0, 
	@LocaleId       TransferId READONLY,
	@PublishStateId INT = 0, 
	@VersionIdString  VARCHAR(100)= '',
	@Status		   Bit  OutPut,
	@RevisionType Varchar(50)
)
AS 
   
/*
    Summary : If PimcatalogId is provided get all products with Addons and provide above mentioned data
       If PimProductId is provided get all Addons if associated with given product id and provide above mentioned data
    			Input: @PublishCatalogId or @PimProductId
    		    output should be in XML format
       sample xml5
    Begin transaction  
	 declare  @PimProductId TransferId 
	 Declare @Status bit 
	 INSERT INTO @PimProductId  values (768)

			Exec [_Znode_GetPublishAssociatedAddonsJson]
				@PublishCatalogId = 0 ,
				@PimProductId   = @PimProductId,
				@UserId =2,														 
				@VersionIdString = '',--'1662,1664,1663,1665',
				@Status	 =@Status Out,
				@RevisionType= 'Production'
				rollback transaction
				--SELECT * from ZnodePublishVersionEntity 
   
	*/

BEGIN
    BEGIN TRY
    SET NOCOUNT ON 
		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
        DECLARE @LocaleIdIn INT, @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId()
		, @Counter INT= 1
		, @MaxRowId INT= 0;

    -- DECLARE @PimAddOnGroupId VARCHAR(MAX);

		CREATE TABLE #TBL_PublisshIds  (PublishProductId INT , PimProductId INT , PublishCatalogId INT)
		DECLARE @TBL_LocaleId TABLE (RowId    INT IDENTITY(1, 1),LocaleId INT);
		IF OBJECT_ID('tempdb..#VesionIds') is not null
		DROP TABLE #VesionIds
		Create Table #VesionIds(ZnodeCatalogId int , VersionId int , LocaleId int , RevisionType varchar(50) )

  		If @VersionIdString <> ''
		BEGIN
			Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)	
			SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType
			FROM ZnodePublishVersionEntity PV Inner join Split(@VersionIdString,',') S ON PV.VersionId = S.Item
		END
		Else 
		Begin
			If  (@RevisionType like '%Preview%'  OR @RevisionType like '%Production%')
			BEGIN
				Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)	
				SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV  where PV.IsPublishSuccess =1 
				AND PV.RevisionType ='Preview'
			END
			If  (@RevisionType like '%Production%' OR @RevisionType = 'None')
			BEGIN
				Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)	
				SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV  where PV.IsPublishSuccess =1 
				AND PV.RevisionType ='Production'
			END					
		End 

		IF (@PublishCatalogId IS NULL OR @PublishCatalogId = 0)
		BEGIN 
			INSERT INTO #TBL_PublisshIds 
			EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId,@userid,@PimProductId,1
		END 
		IF ISnull(@PimCategoryHierarchyId,0) <> 0 
		BEGIN 
			INSERT INTO #TBL_PublisshIds 
			EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId,@userid,@PimProductId,1,@PimCategoryHierarchyId 
		END 

		CREATE TABLE #TBL_PublishCatalogId (PublishCatalogId INT,PublishProductId INT,PimProductId  INT , VersionId INT ,LocaleId INT  );

		IF  ISnull(@PimCategoryHierarchyId,0) <> 0 
		BEGIN 
			INSERT INTO #TBL_PublishCatalogId 
			SELECT ZPP.PublishCatalogId , ZPP.PublishProductId,PimProductId, MAX(ZPCP.PublishCatalogLogId)  ,LocaleId 
			FROM ZnodePublishProduct ZPP 
			INNER JOIN ZnodePublishCatalogLog ZPCP ON (ZPCP.PublishCatalogId  = ZPP.PublishCatalogId)
			WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId   ) 
			AND ZPCP.Publishstateid = @PublishStateId
			GROUP BY ZPP.PublishCatalogId,ZPP.PublishProductId,PimProductId,LocaleId 
		END 
		ELSE 
		Begin
			INSERT INTO #TBL_PublishCatalogId  
			SELECT ZPP.PublishCatalogId , ZPP.PublishProductId,PimProductId,0  VersionId  ,0 LocaleId 
			FROM ZnodePublishProduct ZPP  
			WHERE EXISTS  (SELECT TOP 1 1 FROM #VesionIds ZPCP WHERE (ZPCP.ZnodeCatalogId  = ZPP.PublishCatalogId)) AND
			(EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId  
			AND  @PublishCatalogId = '0' )  OR (ZPP.PublishCatalogId =  @PublishCatalogId ))
		END
        DECLARE @TBL_AddonGroupLocale TABLE( PimAddonGroupId INT, DisplayType NVARCHAR(400),AddonGroupName NVARCHAR(MAX),LocaleId INT );
        INSERT INTO @TBL_LocaleId(LocaleId)
        SELECT LocaleId FROM ZnodeLocale MT  WHERE IsActive = 1 AND (EXISTS (SELECT TOP 1 1  FROM @LocaleId RT WHERE RT.Id = MT.LocaleId )
			OR NOT EXISTS (SELECT TOP 1 1 FROM @LocaleId ));
        SET @MaxRowId = ISNULL(( SELECT MAX(RowId) FROM @TBL_LocaleId ), 0);
    
        WHILE (@Counter <= @MaxRowId)
        BEGIN
            SET @LocaleIdIn =( SELECT LocaleId FROM @TBL_LocaleId WHERE RowId = @Counter );
            INSERT INTO @TBL_AddonGroupLocale (PimAddonGroupId, DisplayType, AddonGroupName)
            EXEC Znode_GetAddOnGroupLocale '', @LocaleIdIn;
	   		UPDATE @TBL_AddonGroupLocale SET LocaleId = @LocaleIdIn WHERE LocaleId IS NULL 
            SET @Counter = @Counter + 1;
        END;
		
		IF OBJECT_ID('tempdb..#AddonProductPublishedXML') is not null
		drop table #AddonProductPublishedXML
						
		SELECT  ZPPP.PublishProductId,ZPPP.PublishCatalogId,V.LocaleId,v.VersionId,
		ZPPP.[PublishProductId]  ZnodeProductId,
		ZPPP.[PublishCatalogId] ZnodeCatalogId,
		ZPP.PublishProductId  AssociatedZnodeProductId,
		ZPAOP.DisplayOrder DisplayOrder,
		ZPOPD.DisplayOrder AssociatedProductDisplayOrder,
		RequiredType ,
		DisplayType, 
		ISNULL((select ''+AddonGroupName for xml path('')),'') GroupName,
		ISnull(IsDefault,0) IsDefault
		INTO #AddonProductPublishedXML
		FROM [ZnodePimAddOnProductDetail] AS ZPOPD
		INNER JOIN [ZnodePimAddOnProduct] AS ZPAOP ON ZPOPD.[PimAddOnProductId] = ZPAOP.[PimAddOnProductId]
		INNER JOIN #TBL_PublishCatalogId ZPPP ON (ZPPP.PimProductId = ZPAOP.PimProductId )
		INNER JOIN #TBL_PublishCatalogId ZPP ON(ZPP.PimProductId = ZPOPD.[PimChildProductId] AND ZPP.PublishCatalogId = ZPPP.PublishCatalogId  )
		INNER JOIN #VesionIds V ON ZPPP.PublishCatalogId  = V.ZnodeCataLogId
		INNER JOIN @TBL_AddonGroupLocale TBAG ON (TBAG.PimAddonGroupId   = ZPAOP.PimAddonGroupId AND TBAG.LocaleId = V.LocaleId )
					
		If (isnull(@PublishCatalogId ,'') = '' and @VersionIdString = '') OR 
			(isnull(@PublishCatalogId ,'') = 0 and @VersionIdString = '')
		Begin 
			DELETE
			FROM ZnodePublishAddonEntity
			WHERE PublishAddonEntityId  IN (
											SELECT PublishAddonEntityId
											FROM ZnodePublishAddonEntity BP
											INNER JOIN #AddonProductPublishedXML A ON BP.ZnodeProductId =A.PublishProductId
												AND BP.ZnodeCatalogId = A.PublishCatalogId AND BP.VersionId = A.VersionId
											) 
			----Delete addon entries having parent data present but all addon removed
			DELETE ZPAE
			FROM ZnodePublishAddonEntity ZPAE
			WHERE EXISTS (SELECT * from [ZnodePimAddOnProduct] ZPAOP 
					INNER JOIN ZnodePublishProduct ZPPP ON (ZPPP.PimProductId = ZPAOP.PimProductId )
					WHERE ZPAE.ZnodeProductId = ZPPP.PublishProductId AND ZPAE.ZnodeCatalogId = ZPPP.PublishCatalogId)
			AND NOT EXISTS (SELECT * from [ZnodePimAddOnProductDetail] AS ZPOPD
					INNER JOIN [ZnodePimAddOnProduct] AS ZPAOP ON ZPOPD.[PimAddOnProductId] = ZPAOP.[PimAddOnProductId]
					INNER JOIN ZnodePublishProduct ZPPP ON (ZPPP.PimProductId = ZPOPD.PimChildProductId )
					WHERE ZPAE.AssociatedZnodeProductId = ZPPP.PublishProductId AND ZPAE.ZnodeCatalogId = ZPPP.PublishCatalogId)

			----Delete addon entries having parent data removed
			DELETE ZPAE
			FROM ZnodePublishAddonEntity ZPAE
			WHERE NOT EXISTS (SELECT * from [ZnodePimAddOnProduct] ZPAOP 
					INNER JOIN ZnodePublishProduct ZPPP ON (ZPPP.PimProductId = ZPAOP.PimProductId )
					WHERE ZPAE.ZnodeProductId = ZPPP.PublishProductId AND ZPAE.ZnodeCatalogId = ZPPP.PublishCatalogId)

		End 
					
		Insert into  ZnodePublishAddonEntity
		(VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,
			LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault)
		Select 
			VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,Isnull(AssociatedProductDisplayOrder,0),
			LocaleId,GroupName,DisplayType,DisplayOrder,1 IsRequired,RequiredType,IsDefault
		from #AddonProductPublishedXML
		
		SET @Status = 1;
            
    END TRY
    BEGIN CATCH
		SELECT ERROR_MESSAGE(),ERROR_PROCEDURE()
            
        SET @Status = 0;
        DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishAssociatedAddonsJson @PublishCatalogId = '+@PublishCatalogId+',@VersionId='+CAST(@VersionId AS VARCHAR(50))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
        SELECT 0 AS ID,
            CAST(0 AS BIT) AS Status;
        EXEC Znode_InsertProcedureErrorLog
            @ProcedureName = 'Znode_GetPublishAssociatedAddonsJson',
            @ErrorInProcedure = @Error_procedure,
            @ErrorMessage = @ErrorMessage,
            @ErrorLine = @ErrorLine,
            @ErrorCall = @ErrorCall;
    END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPimProductAttributeInventory')
	DROP PROC Znode_GetPimProductAttributeInventory
GO

CREATE PROCEDURE [dbo].[Znode_GetPimProductAttributeInventory]
(   @SKU    SelectColumnList READONLY,
	@LocaleId INT = 1
    --@IsMultipleProduct BIT          = 0
	)
AS
/*
     Summary : - This procedure is used to find the inventory of product 
     Unit Testing 
	 begin tran
     Exec Znode_GetPimProductAttributeInventory 7
	 rollback tran
*/
     BEGIN
	 BEGIN TRAN PimProductAttributeFamilyId
         BEGIN TRY
             SET NOCOUNT ON;
			
			 IF OBJECT_ID('tempdb.dbo.#TBL_PimProductId', 'U') IS NOT NULL 
		     DROP TABLE #TBL_PimProductId
		 
			 SELECT StringColumn AS SKU INTO #TBL_PimProductId  FROM @SKU 
			
			-- DontTrackInventory cant have inventory
			SELECT sum(ZI.Quantity ) quantity  ,a.PimProductId 
			INTO #TBL_InventoryDetails
			FROM ZnodePimAttributeValue a 
			INNER JOIN  ZnodePimAttributeValueLocale b ON ( b.PimAttributeValueId = a.PimAttributeValueId )
			INNER JOIN ZnodePimAttribute c ON ( c.PimAttributeId=a.PimAttributeId )
			LEFT JOIN  ZnodeInventory ZI ON ZI.SKU = b.AttributeValue 
			LEFT JOIN ZnodeWarehouse ZW on (ZI.WarehouseId = ZW.WarehouseId)
			WHERE EXISTS(SELECT TOP 1 1 FROM #TBL_PimProductId TBP WHERE b.AttributeValue = TBP.SKU )
			AND c.AttributeCode = 'SKU'
			GROUP BY a.PimProductId 

			SELECT DISTINCT CASE WHEN  AttributeDefaultValueCode = 'DontTrackInventory' THEN 'DTI' 
			ELSE [dbo].[Fn_GetDefaultInventoryRoundOff](ISNULL(Quantity, 0))     END Quantity  ,tb.PimProductId 
			INTO #CTE_Getdetails
			FROM #TBL_InventoryDetails tb
			INNER JOIN ZnodePimAttributeValue PAV ON (PAV.PimProductId = tb.PimProductId)
			INNER JOIN ZnodePimProductAttributeDefaultValue a on (a.PimAttributeValueId = pav.PimAttributeValueId)
			INNER JOIN ZnodePimAttributeDefaultValue dv on (a.PimAttributeDefaultValueId = dv.PimAttributeDefaultValueId)
			INNER JOIN ZnodePimAttribute PA ON (PA.pimattributeId = PAV.pimAttributeid )
			WHERE  PA.Attributecode = 'OutOfStockOptions' AND (a.LocaleId=@LocaleId OR @LocaleId=0)
			 
		
			 SELECT   CAST(quantity AS NVARCHAR(100))  quantity ,PimProductId
			 FROM #CTE_Getdetails

			IF OBJECT_ID('tempdb.dbo.#TBL_PimProductId', 'U') IS NOT NULL 
			DROP TABLE #TBL_PimProductId
	
		 COMMIT TRAN PimProductAttributeFamilyId;
         END TRY
         BEGIN CATCH
				
          DECLARE @Status BIT ;
		  SET @Status = 0;
		  DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), 
		  @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		  @ErrorLine VARCHAR(100)= ERROR_LINE(), 
		  @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPimProductAttributeInventory' ;
              			 
          SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  ROLLBACK TRAN PimProductAttributeFamilyId;

          EXEC Znode_InsertProcedureErrorLog
            @ProcedureName = 'Znode_GetPimProductAttributeInventory',
            @ErrorInProcedure = @Error_procedure,
            @ErrorMessage = @ErrorMessage,
            @ErrorLine = @ErrorLine,
            @ErrorCall = @ErrorCall;
         END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ManageProductListByAttributes')
	DROP PROC Znode_ManageProductListByAttributes
GO

CREATE PROCEDURE [dbo].[Znode_ManageProductListByAttributes]
(   @WhereClause      XML,
	@PimAttributeIds  VARCHAR(3000) = NULL,
	@Rows             INT           = 100,
	@PageNo           INT           = 0,
	@Order_BY         VARCHAR(1000) = '',
	@LocaleId         INT,
	@PimProductId     VARCHAR(max) = NULL,
	@IsProductNotIn   BIT           = 0,
	@RelatedProductId INT           = 0, 
	@IsDebug		    BIT = 0 
	)
AS
   /*  Summary:-  This Procedure is used for get product List with extra column attribute supllied to the procedure 
     Unit Testing 
     DECLARE @EDE INT = 0 
	 exec Znode_ManageProductListByAttributes @WhereClause='',@PimAttributeIds = '35,81',@Rows = 10,@PageNo=1,@Order_BY = '',@RelatedProductId = 53442,@PimProductId = '',@IsProductNotIn= 0 ,@LocaleId=1 --SELECT @EDE 
	
	*/
     BEGIN
         SET NOCOUNT ON;
         BEGIN TRY
		  --  SELECT '123112'
             DECLARE @SQL NVARCHAR(MAX), @AttributeCode_filter NVARCHAR(2000), @WhereClauseChanges NVARCHAR(MAX)= '',@OutPimProductIds varchar(max) ;
             SET @WhereClauseChanges = CONVERT(NVARCHAR(MAX), @WhereClause);
             DECLARE @PimAttributeFamilyId INT= Dbo.Fn_GetDefaultValue('PimFamily'), @RowsCount INT, @DefaultLocaleId INT= Dbo.Fn_GetDefaultlocaleId();
             DECLARE @TransferPimProductId TransferId 
			 DECLARE @TBL_PimMediaAttributeId TABLE (PimAttributeId INT ,AttributeCode VARCHAR(600))
			 INSERT INTO @TBL_PimMediaAttributeId (PimAttributeId,AttributeCode)
			 SELECT PimAttributeId,AttributeCode FROM Dbo.Fn_GetProductMediaAttributeId ()					 
			
	
			 DECLARE @ProductIdTable TABLE
             (PimProductId INT,
              CountId      INT,
              RowId        INT identity(1,1)
             );
             DECLARE @TBL_PimAttributeId TABLE
             (PimAttributeId INT,
              AttributeCode  VARCHAR(600)
             );
             INSERT INTO @TBL_PimAttributeId
             (PimAttributeId,
              AttributeCode
             )
                    SELECT PimAttributeId,
                           AttributeCode
                    FROM ZnodePimAttribute ZPA
                    WHERE EXISTS
                    (
                        SELECT TOP 1 1
                        FROM dbo.Split(@PimAttributeIds, ',') SP
                        WHERE SP.Item = ZPA.PimAttributeId
                    );
					
             SET @AttributeCode_filter = ISNULL(CAST((
                                                      SELECT CAST('<WhereClauseModel><attributecode>'+ '  = '+''''+TBPA.AttributeCode+''''+'</attributecode></WhereClauseModel>' AS XML )
                                                      FROM @TBL_PimAttributeId TBPA
                                                      FOR XML PATH(''),TYPE
                                                  ) AS NVARCHAR(max)),'');
          
		     SET @WhereClauseChanges = [dbo].[Fn_GetXmlWhereClauseForAttribute](@WhereClauseChanges,@AttributeCode_filter, @LocaleId);
             SET @WhereClause = CONVERT(XML, @WhereClauseChanges);	
	    
		  INSERT INTO @TransferPimProductId
		  SELECT ITEM
		  FROM DBO.SPLIT(@PIMPRODUCTID,',')
		  UNION ALL 
		  SELECT PimProductId 
		  FROM ZnodePimProductTypeAssociation  
		  WHERE PimParentProductId=  @RelatedProductId
		  AND @PIMPRODUCTID = '0'
		
		   DECLARE @AttributeCode NVARCHAR(max)
		   SET @AttributeCode = SUBSTRING ((SELECT ','+AttributeCode FROM [dbo].[Fn_GetProductGridAttributes]() qt WHERE (EXISTS (SELECT TOP 1 1 
				FROM dbo.split(@PimAttributeIds,',') TR WHERE tr.Item = qt.PimAttributeId)  OR AttributeCode = 'ProductType')
		   FOR XML PATH('')  ),2,4000)
	
	SET @IsProductNotIn = CASE WHEN @IsProductNotIn = 1 THEN 0 
	 WHEN @IsProductNotIn = 0 THEN 1  END
     DECLARE  @ProductListIdRTR TransferId
	 DECLARE @TAb Transferid 
	 DECLARE @tBL_mainList TABLE(Id INT , RowId INT )
	
	 INSERT INTO @ProductListIdRTR
	 EXEC Znode_GetProductList @IsProductNotIn ,@TransferPimProductId


	 IF CAST(@WhereClause AS NVARCHAR(max))<> N''
	 BEGIN 
	  
	  SET @SQL = 'SELECT PimProductId FROM ##Temp_PimProductId'+CAST(@@SPID AS VARCHAR(500))
	  --INSERT INTO @TAB 
	  EXEC Znode_GetFilterPimProductId @WhereClause,@ProductListIdRTR,@localeId
	  
      INSERT INTO @TAB 
	  EXEC (@SQL)
	 
	 END 
	 	
	 
	 IF EXISTS (SELECT Top 1 1 FROM @TAb )OR CAST(@WhereClause AS NVARCHAR(max)) <> N''
	 BEGIN 
	
	 SET @AttributeCode = dbo.FN_TRIM(REPLACE(REPLACE(@order_by,' DESC',''),' ASC',''))
	 INSERT INTO @TBL_MainList
	 EXEC Znode_GetOrderByPagingProduct @order_by,@rows,@PageNo, @TAb ,@AttributeCode,@localeId
	
	 END 
	 ELSE 
	 BEGIN
	 SET @AttributeCode = dbo.FN_TRIM(REPLACE(REPLACE(@order_by,' DESC',''),' ASC',''))
	 INSERT INTO @TBL_MainList
	 EXEC Znode_GetOrderByPagingProduct @order_by,@rows,@PageNo, @ProductListIdRTR ,@AttributeCode,@localeId 
	 END 
	
			 INSERT INTO @ProductIdTable
             (PimProductId) 
			 select id
			 from @TBL_MainList
		
             SET @AttributeCode_filter = SUBSTRING(
                                                  (
                                                      SELECT ','+TBPA.AttributeCode
                                                      FROM @TBL_PimAttributeId TBPA
                                                      FOR XML PATH('')
                                                  ), 1, 4000);
     

			 DECLARE @PimProductIds TransferId

			 INSERT INTO @PimProductIds ( Id )
			 SELECT distinct id FROM @TBL_MainList
														      		
             DECLARE @DefaultAttributeCode VARCHAR(MAX)= dbo.Fn_GetDefaultValue('AttributeCode');
          			
			 INSERT INTO @TBL_PimAttributeId
             (PimAttributeId,
              AttributeCode
             )
                    SELECT PimAttributeId,
                           AttributeCode
                    FROM ZnodePimAttribute ZPA
                    WHERE EXISTS
                    (
                        SELECT TOP 1 1
                        FROM dbo.Split(@DefaultAttributeCode, ',') SP
                        WHERE SP.Item = ZPA.AttributeCode
                    );
			
		

			INSERT INTO @TBL_PimAttributeId
             (PimAttributeId,
              AttributeCode
             )
                    SELECT PimAttributeId,
                           'OR_'+AttributeCode
                    FROM ZnodePimAttribute ZPA
                    WHERE EXISTS
                    (
                        SELECT TOP 1 1
                        FROM dbo.Split(@PimAttributeIds, ',') SP
                        WHERE SP.Item = ZPA.PimAttributeId
                    );
             
	
             SET @DefaultAttributeCode = @DefaultAttributeCode + @AttributeCode_filter;
             Create TABLE #TBL_AttributeDetails 
             (
				  PimProductId                INT ,
				  AttributeValue              NVARCHAR(MAX),
				  AttributeCode               VARCHAR(600),
				  PimAttributeId              INT,
				  PimProductTypeAssociationId INT,
				  DisplayOrder                INT,
				  IsNonEditableRow            BIT DEFAULT 0,
				  IsDefault bit
             );
             DECLARE @TBL_AttributeCode TABLE
             (
				  PimAttributeId INT,
				  AttributeCode  VARCHAR(300)
             );
             INSERT INTO @TBL_AttributeCode
             (
				  PimAttributeId,
				  AttributeCode
             )
                    SELECT PimAttributeId,
                           AttributeCode
                    FROM ZnodePimAttribute ZPA
                    WHERE EXISTS
                    (
                        SELECT TOP 1 1
                        FROM dbo.split(@DefaultAttributeCode, ',') SP
                        WHERE Sp.Item = ZPA.AttributeCode
                    );

             DECLARE @TBL_AttributeDefaultValue TABLE
             (
				PimAttributeId            INT,
				AttributeDefaultValueCode VARCHAR(100),
				IsEditable                BIT,
				AttributeDefaultValue     NVARCHAR(MAX),
				DisplayOrder INT
             );
			  
             DECLARE @PimAttributeId VARCHAR(MAX);
             SET @PimAttributeId = SUBSTRING(
                                            (
                                                SELECT ','+CAST(TBAC.PimAttributeId AS VARCHAR(50))
                                                FROM @TBL_AttributeCode TBAC
                                                     INNER JOIN ZnodePimAttributeDefaultValue ZPADV ON(ZPADV.PimAttributeId = TBAC.PimAttributeId)
                                                FOR XML PATH('')
                                            ), 2, 4000);

													
             INSERT INTO @TBL_AttributeDefaultValue
             (
				PimAttributeId,
				AttributeDefaultValueCode,
				IsEditable,
				AttributeDefaultValue,
				DisplayOrder
             )
             EXEC Znode_GetAttributeDefaultValueLocale
                  @PimAttributeId,
                  @LocaleId;

			
             INSERT INTO #TBL_AttributeDetails
             (
				  PimProductId,
				  AttributeValue,
				  AttributeCode,
				  PimAttributeId
             )
             EXEC Znode_GetProductsAttributeValue
                  @PimProductIds,
                  @DefaultAttributeCode,
                  @localeId;
				
			 INSERT INTO #TBL_AttributeDetails
             (
				  PimProductId,
				  AttributeValue,
				  AttributeCode,
				  PimAttributeId
             )
			SELECT ZPAV.PimProductId ,ZPPAVD.PimAttributeDefaultValueId,'OR_'+ZPA.AttributeCode,ZPA.PimAttributeId
			FROM ZnodePimAttributeValue ZPAV 
			INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = ZPAV.PimAttributeId) 
			INNER JOIN @ProductIdTable TBL ON (TBL.PimProductId = ZPAV.PimProductId )
			INNER JOIN ZnodePimProductAttributeDefaultValue ZPPAVD ON (ZPPAVD.PimAttributeValueId = ZPAV.PimAttributeValueId  )
			WHERE ZPPAVD.LocaleId = @DefaultLocaleId
			AND EXISTS (SELECT TOP 1 1 FROM dbo.Split(@PimAttributeIds,',') SP WHERE Sp.Item = ZPA.PimAttributeId )

				
			----------------------------------------------------------------------------------------------
			DECLARE @SKU SelectColumnList
			Create TABLE  #Temp_Inventory (Quantity NVARCHAR(MAX),PimProductId INT)

			INSERT INTO @SKU
			SELECT AttributeValue FROM #TBL_AttributeDetails
			WHERE AttributeCode = 'SKU'
						
			INSERT INTO #Temp_Inventory(Quantity,PimProductId)
			EXEC Znode_GetPimProductAttributeInventory @SKU=@SKU, @LocaleId=@LocaleId
						
			---------------------------------------------------------------------------------------------------------

             DECLARE @FamilyDetails TABLE
             (PimProductId         INT,
              PimAttributeFamilyId INT,
              FamilyName           NVARCHAR(3000)
             );

             INSERT INTO @FamilyDetails
             (PimAttributeFamilyId,
              PimProductId
             )
             EXEC [dbo].[Znode_GetPimProductAttributeFamilyId]
                  @PimProductIds,
                  1;
					  
             UPDATE a
               SET
                   FamilyName = b.AttributeFamilyName
             FROM @FamilyDetails a
                  INNER JOIN ZnodePimFamilyLocale b ON(a.PimAttributeFamilyId = b.PimAttributeFamilyId
                                                       AND LocaleId = @LocaleId);
             UPDATE a
               SET
                   FamilyName = b.AttributeFamilyName
             FROM @FamilyDetails a
                  INNER JOIN ZnodePimFamilyLocale b ON(a.PimAttributeFamilyId = b.PimAttributeFamilyId
                                                       AND LocaleId = @DefaultLocaleId)
             WHERE a.FamilyName IS NULL
                   OR a.FamilyName = '';
			
             --- Update the  product families name locale wise   

				   
			   SELECT TBA.PimProductId , TBA.PimAttributeId 
			   , SUBSTRING( ( SELECT ','+dbo.Fn_GetMediaThumbnailMediaPath (zm.PATH) 
			   FROM ZnodeMedia AS ZM
              
			   INNER JOIN #TBL_AttributeDetails AS TBAI ON (TBAI.AttributeValue  = CAST(ZM.MediaId AS VARCHAR(50)) )
			   INNER JOIN  @TBL_PimMediaAttributeId AS FNMA ON (FNMA.PImAttributeId = TBAI.PimATtributeId)
			   WHERE TBAI.PimProductId = TBA.PimProductId AND TBAI.PimAttributeId = TBA.PimAttributeId 
			   FOR XML PATH('') ), 2 , 4000) AS AttributeValue 
			   into #TBL_ProductMedia
			   FROM #TBL_AttributeDetails AS TBA 
			   INNER JOIN  @TBL_PimMediaAttributeId AS FNMA ON (FNMA.PImAttributeId = TBA.PimATtributeId )
                         
   
		       UPDATE TBAV SET AttributeValue = CTPM.AttributeVALue
			   FROM #TBL_AttributeDetails TBAV 
			   INNER JOIN #TBL_ProductMedia CTPM ON CTPM.PimProductId = TBAV.PimProductId  AND CTPM.PimAttributeId = TBAV.PimAttributeId 
			   AND CTPM.PimAttributeId = TBAV.PimAttributeId;
			  					
		
             UPDATE TBAD
               SET
                   PimProductTypeAssociationId = ZPTA.PimProductTypeAssociationId,
                   DisplayOrder = ZPTA.DisplayOrder, IsDefault = ZPTA.IsDefault
             FROM #TBL_AttributeDetails TBAD
                  INNER JOIN ZnodePimproductTypeAssociation ZPTA ON(ZPTA.PimProductId = TBAD.PimProductId)
             WHERE ZPTA.PimParentProductId = @RelatedProductId;
            
			-- DECLARE @AttributeCode NVARCHAR(4000);
             SET @AttributeCode = SUBSTRING(
                                           (
                                               SELECT DISTINCT
                                                      ','+QUOTENAME(AttributeCode)
                                               FROM @TBL_PimAttributeId
                                               FOR XML PATH('')
                                           ), 2, 4000);
             DECLARE @AttributeCode_Duplicate NVARCHAR(4000)= SUBSTRING(
                                                                       (
                                                                           SELECT 
                                                                                  ', Piv.'+QUOTENAME(AttributeCode)
                                                                           FROM ZnodePimAttribute ZPA
                                                                           WHERE EXISTS
                                                                           (
                                                                               SELECT TOP 1 1
                                                                               FROM dbo.Split(@PimAttributeIds, ',') SP
                                                                               WHERE SP.Item = ZPA.PimAttributeId
                                                                               ORDER BY AttributeCode
                                                                           )
																		   GROUP BY ZPA.AttributeCode,ZPA.DisplayOrder
																		   ORDER BY ZPA.DisplayOrder  DESC
                                                                           FOR XML PATH('')
                                                                       ), 1, 4000);
             DECLARE @AttributeCode_Duplicate_Data NVARCHAR(4000);
			 	 
			

			  SET  @AttributeCode_Duplicate_Data= SUBSTRING(
                                                                       (
                                                                           SELECT 
                                                                                  'AND Piv.'+QUOTENAME('OR_'+AttributeCode) +'= Isa.'+QUOTENAME(AttributeCode)+' '
                                                                           FROM ZnodePimAttribute ZPA
                                                                           WHERE EXISTS
                                                                           (
                                                                               SELECT TOP 1 1
                                                                               FROM dbo.Split(@PimAttributeIds, ',') SP
                                                                               WHERE SP.Item = ZPA.PimAttributeId
                                                                               ORDER BY AttributeCode
                                                                           )
																		   GROUP BY ZPA.AttributeCode,ZPA.DisplayOrder
																		   ORDER BY ZPA.DisplayOrder  DESC
                                                                           FOR XML PATH('')
                                                                       ), 4, 4000) +' '

            -- SET @AttributeCode_Duplicate_Data = REPLACE(SUBSTRING(@AttributeCode_Duplicate, 2, 4000), ',', '+'',''+');
             SELECT PimProductId,
                    AttributeValue,
                    AttributeCode,
                    PimProductTypeAssociationId,
                    DisplayOrder, IsDefault
             INTO #Temp_attribute
             FROM #TBL_AttributeDetails
             ORDER BY DisplayOrder;
             SELECT *
             INTO #temp_Family
             FROM @FamilyDetails;
             
			 DECLARE @IsSelectedAttributeValue TABLE
             (ProductId      INT,
              AttributeValue NVARCHAR(500),
              AttributeCode  NVARCHAR(500),
              PimAttributeId INT,PimAttributeDefaultValueId INT 
             );

			  
		   DECLARE @IsSelectedAttributeValueLocale TABLE
             (PimAttributeId            INT,
              AttributeDefaultValueCode NVARCHAR(600),
              IsEditable                BIT,
              AttributeDefaultValue     NVARCHAR(max),
			  DisplayOrder   INT 
             );
          

		  -- select @PimProductId ,@AttributeCode ,@LocaleId 
		  ;With Cte_AttributeVAkuestest AS 
		  (
		    SELECT ZPAV.PimAttributeId , ZPPAD.PimAttributeDefaultValueId ,ZPAV.PimProductId
			FROM ZnodePimAttributeVAlue ZPAV 
			INNER JOIN ZnodePimProductAttributeDefaultValue ZPPAD ON (ZPPAD.PimAttributeValueId = ZPAV.PimAttributeValueId)
			LEFT JOIN ZnodePimproductTypeAssociation ZPPTA on ZPAV.PimProductId = ZPPTA.PimProductId and ZPPTA.PimParentProductId = @RelatedProductId 
			WHERE EXISTS (SELECT TOP 1 1 FROM dbo.split(@PimAttributeIds,',') SP WHERE SP.Item = ZPAV.PimAttributeId )
			AND EXISTS (SELECT TOP 1 1 FROM dbo.split(@PimProductId,',') SP WHERE SP.Item = ZPAV.PimProductId )-- or @PimProductId = '0')
		) ,Cte_PimAttributeDefaultValueLocale AS 
		(
		  SELECT  AttributeDefaultValue ,PimAttributeId,PimProductId,CTA.PimAttributeDefaultValueId
		  FROM ZnodePimAttributeDefaultValueLocale CTA  
		  INNER JOIN Cte_AttributeVAkuestest CTB ON (CTB.PimAttributeDefaultValueId = CTA.PimAttributeDefaultValueId)		
		  WHERE LocaleId = @DefaultLocaleId 
		  UNION 
		  SELECT  AttributeDefaultValue ,PimAttributeId,PimProductId,CTA.PimAttributeDefaultValueId
		  FROM ZnodePimAttributeDefaultValueLocale CTA 
		  INNER JOIN Cte_AttributeVAkuestest CTB ON (CTB.PimAttributeDefaultValueId = CTA.PimAttributeDefaultValueId)		
		  WHERE LocaleId = @DefaultLocaleId 	
		)
		,Cte_AttributeValueForCode 
		As
		(
		  SELECT AttributeDefaultValue AtributeValue , AttributeCode ,PimProductId ,a.PimAttributeDefaultValueId
		  FROM Cte_PimAttributeDefaultValueLocale a
		  INNER JOIN ZnodePimAttribute b ON (b.PimAttributeId = a.PimAttributeId )
		)
			 INSERT INTO @IsSelectedAttributeValue (ProductId,AttributeCode,AttributeValue,PimAttributeDefaultValueId)
             SELECT PimProductId,AttributeCode,AtributeValue,PimAttributeDefaultValueId
			 FROM Cte_AttributeValueForCode
             
			 --INSERT INTO @IsSelectedAttributeValueLocale
    --         EXEC Znode_GetAttributeDefaultValueLocale
    --              @PimAttributeIds,
    --              @LocaleId;
             
			 --UPDATE izav
    --           SET
    --               izav.AttributeValue = isval.AttributeDefaultValue
    --         FROM @IsSelectedAttributeValue izav
    --              INNER JOIN @IsSelectedAttributeValueLocale isval ON izav.AttributeValue = isval.AttributeDefaultValueCode AND izav.PimAttributeId = isval.PimAttributeId ;
             

			 SELECT * 
			 --SUBSTRING(
    --                         (
    --                             SELECT ','+isav.AttributeValue
    --                             FROM @IsSelectedAttributeValue isav
				--				 INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = ISAV.PimAttributeID )
    --                             WHERE isa.ProductId = isav.ProductId
    --                             ORDER BY ZPA.DisplayOrder DESC
    --                             FOR XML PATH('')
    --                         ), 2, 4000) AttributeValue,
							

             INTO #IsSelectedAttribute
             FROM @IsSelectedAttributeValue isa
			; 
				 
			 IF @IsDebug = 1 
			 BEGIN 
			 SELECT * FROM @IsSelectedAttributeValue izav

			 SELECT * FROM #IsSelectedAttribute

			 END 
             --select * from @IsSelectedAttributeValue
             --select @AttributeCode_Duplicate,@AttributeCode_Duplicate_data
             --select * from #IsSelectedAttribute
			 
             SET @AttributeCode = REPLACE(@AttributeCode, ',[DisplayOrder]', '');
             SET @SQL = '
			     
				 ;with Cte_Getvalue AS (
				 SELECT ProductId , '+SUBSTRING(@AttributeCode_Duplicate, 2, 4000)+'
				 FROM ( SELECT ProductId,AttributeCode,PimAttributeDefaultValueId FROM #IsSelectedAttribute gt ) dd 
				 PIVOT ( MAX (PimAttributeDefaultValueId) FOR AttributeCode IN ('+REPLACE(SUBSTRING(@AttributeCode_Duplicate, 2, 4000),'Piv.','')+')  ) PIV 
				 )

				SELECT DISTINCT  piv.PimProductTypeAssociationId, zpp.PimProductid ProductId, [ProductName],ProductType ,ISNULL(zf.FamilyName,'''')  AttributeFamily , [SKU]
						  , CASE WHEN [IsActive] IS NULL THEN ''false'' ELSE   [IsActive]  END  [Status],  piv.[ProductImage] ImagePath,[Assortment],DisplayOrder  ,'+CAST(@LocaleId AS VARCHAR(50))+' LocaleId
						  ,DENSE_RANK()Over(Order By'+SUBSTRING(@AttributeCode_Duplicate, 2, 4000)+') CombinationId '+@AttributeCode_Duplicate+'
					, CASE When isa.ProductId Is Null then 0 ELSE 1 END IsNonEditableRow,'+ CAST(@RelatedProductId AS VARCHAR(50))+' RelatedProductId, IDD.Quantity AvailableInventory, piv.IsDefault
				FROM ZNodePimProduct zpp 
				LEFT JOIN  #temp_Family zf ON (zf.PimProductId = zpp.PimProductId)
				INNER JOIN #Temp_attribute 
				PIVOT 
				(
				Max(AttributeValue) FOR AttributeCode  IN ( '+@AttributeCode+')
				)Piv  
				ON (Piv.PimProductId = zpp.PimProductid) 
				LEFT JOIN #Temp_Inventory IDD ON (IDD.PimProductId = Piv.PimProductId)
				--LEFT JOIN ZnodeMedia zm ON (zm.MediaId = piv.[ProductImage])
				LEFT OUTER JOIN Cte_Getvalue isa ON ('+@AttributeCode_Duplicate_Data+')
				    '+' Order BY '+ISNULL(CASE
                                                  WHEN @Order_BY = ''
                                                  THEN 'DisplayOrder'
                                                  ELSE @Order_BY
                                              END, 'DisplayOrder');
		
	
             -- SELECT '''+SUBSTRINg(REPLACE(@AttributeCode_Duplicate,'Piv.',''),2,4000)+''' Ids
			 
             SELECT AttributeCode
             FROM ZnodePimAttribute ZPA
             WHERE EXISTS
             (
                 SELECT TOP 1 1
                 FROM dbo.Split(@PimAttributeIds, ',') SP
                 WHERE SP.Item = ZPA.PimAttributeId
             );
             
			PRINT @SQL
             EXEC SP_executesql
                  @SQL;
        
     IF EXISTS (SELECT Top 1 1 FROM @TAb ) OR CAST(@WhereClause AS NVARCHAR(max)) <> N''
	 BEGIN 

		  SELECT (SELECT COUNT(1) FROM @TAb) AS RowsCount   
	 END 
	 ELSE 
	 BEGIN
	 		  SELECT (SELECT COUNT(1) FROM @ProductListIdRTR) AS RowsCount   
	 END ;

             DROP TABLE #Temp_attribute;
             DROP TABLE #temp_Family;
   
             -- find the all locale values 
         END TRY
         BEGIN CATCH
		  SELECT ERROR_MESSAGE()
                DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ManageProductListByAttributes @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@PimAttributeIds='+@PimAttributeIds+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@LocaleId = '+CAST(@LocaleId AS VARCHAR(50))+',@PimProductId='+@PimProductId+',@IsProductNotIn='+CAST(@IsProductNotIn AS VARCHAR(50))+',@RelatedProductId='+CAST(@RelatedProductId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_ManageProductListByAttributes',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ManageProductList_XML')
	DROP PROC Znode_ManageProductList_XML
GO

CREATE PROCEDURE [dbo].[Znode_ManageProductList_XML]
(   @WhereClause						 XML,
    @Rows								 INT           = 100,
    @PageNo								 INT           = 1,
    @Order_BY			 VARCHAR(1000) = '',
    @LocaleId			 INT           = 1,
    @PimProductId		 VARCHAR(2000) = 0,
    @IsProductNotIn	 BIT           = 0,
	@IsCallForAttribute BIT		   = 0,
	@AttributeCode      VARCHAR(max ) = '' ,
	@PimCatalogId   INT = 0,
	@IsCatalogFilter   BIT            = 0,
	@IsDebug            Bit		   = 0,
	@publishstatus   NVARCHAR(200) = '' 
	)
AS
    
/*
		  Summary:-   This Procedure is used for get product List  
				    Procedure will pivot verticle table(ZnodePimattributeValues) into horizontal table with columns 
				    ProductId,ProductName,ProductType,AttributeFamily,SKU,Price,Quantity,IsActive,ImagePath,Assortment,LocaleId,DisplayOrder
        
		  Unit Testing
		  
exec Znode_ManageProductList_XML @WhereClause=N'',@Rows=50,@PageNo=1,@Order_By=N'',@LocaleId=1,@PimProductId=N'',@IsProductNotIn=1,@IsCallForAttribute=0,@AttributeCode=''
          select * from ZnodeAttributeType  WHERE AttributeValue LIKE '%&%'
		  UPDATE VieW_lOADMANAGEpRODUCT SET  AttributeValue = 'A & B'  WHERE AttributeValue LIKE '% and %' AND PimProductId = 158
    */

     BEGIN
         SET NOCOUNT ON;
         BEGIN TRY
		 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
             DECLARE @PimProductIds TransferId, --VARCHAR(MAX), 
					 @FirstWhereClause NVARCHAR(MAX)= '', 
					 @SQL NVARCHAR(MAX)= '' ,
					 @OutPimProductIds VARCHAR(max),
					 @ProductXML NVARCHAR(max) ;
			Declare @publishstatusid table (id int);

			if isnull(@publishstatus,'') <>''
				begin
				declare @sql1 nvarchar(2000)='';
				DECLARE @ParmDefinition NVARCHAR(500); 
				set @sql1 = N'select  PublishStateId from ZnodePublishState where DisplayName ' +  @publishstatus +'';
				
				 ----EXEC (@sql1);
				 insert into @publishstatusid
				 EXEC (@sql1)
				  
				 --set @publishstatusid = @p

				 ----set @sql1 = N' SET @publishstatusid1 =( select top 1  PublishStateId from ZnodePublishState where DisplayName like ''%' + @publishstatus +'%'')';
				
				 --------EXEC (@sql1);
				 ----set @ParmDefinition ='@publishstatusid1 int output';
				 ---- EXECUTE sp_executesql @sql1, @ParmDefinition, @publishstatusid1 = @publishstatusid output

				End

             DECLARE @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId()
					 ,@RowsCount INT =0 ;
             DECLARE @TransferPimProductId TransferId 
			 DECLARE @TBL_AttributeDefaultValue TABLE
             (PimAttributeId            INT,
              AttributeDefaultValueCode VARCHAR(100),
              IsEditable                BIT,
              AttributeDefaultValue     NVARCHAR(MAX)
			  ,DisplayOrder INT 
			  ,PimAttributedefaultValueId INT 
             );
             DECLARE @TBL_AttributeDetails AS TABLE
             (PimProductId   INT,
              AttributeValue NVARCHAR(MAX),
              AttributeCode  VARCHAR(600),
              PimAttributeId INT,
			  AttributeDefaultValue NVARCHAR(MAX)
             );
			 Create table #TBL_AttributeDetailsLocale
             (PimProductId   INT,
              AttributeValue NVARCHAR(MAX),
              AttributeCode  VARCHAR(600),
              PimAttributeId INT
             );
			 DECLARE @TBL_MultiSelectAttribute TABLE (PimAttributeId INT , AttributeCode VARCHAR(600))
			
			 DECLARE @TBL_MediaAttribute TABLE (Id INT ,PimAttributeId INT ,AttributeCode VARCHAR(600) )
			 
			 DECLARE @TBL_ProductIds TABLE 
			 (
			  PimProductId INT,
			  ModifiedDate DATETIME  
			 )

			 DECLARE @FamilyDetails TABLE
             (
			  PimProductId         INT,
              PimAttributeFamilyId INT,
              FamilyName           NVARCHAR(Max)
             );
             DECLARE @DefaultAttributeFamily INT= dbo.Fn_GetDefaultPimProductFamilyId();
             DECLARE @ProductIdTable TABLE
             (PimProductId INT,
              CountId      INT,
              RowId        INT IDENTITY(1,1)
             );
          		
             IF EXISTS ( SELECT TOP 1 1 FROM @WhereClause.nodes ( '//ArrayOfWhereClauseModel/WhereClauseModel'  ) AS Tbl(Col)
			 WHERE LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''',''))))  =  'Brand'
                OR LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''','')))) = 'Vendor'
                OR LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''',''))))  =  'ShippingCostRules'
                OR LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''','')))) =  'Highlights') and @IsCallForAttribute=1
                 BEGIN
                DECLARE @AttributeCodeValue TABLE (AttributeValue NVARCHAr(max),AttributeCode NVARCHAR(max))

				INSERT INTO @AttributeCodeValue(AttributeValue,AttributeCode)
				SELECT  Tbl.Col.value ( 'attributevalue[1]' , 'NVARCHAR(max)') AS AttributeValue
						 ,Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)') AS AttributeCode
				FROM @WhereClause.nodes ( '//ArrayOfWhereClauseModel/WhereClauseModel'  ) AS Tbl(Col)
				WHERE LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''',''))))  =  'Brand'
                OR LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''',''))))  = 'Vendor'
                OR LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''',''))))  =  'ShippingCostRules'
                OR LTRIM(RTRIM((REPLACE(REPLACE(Tbl.Col.value ( 'attributecode[1]' , 'NVARCHAR(max)'),' = ',''),'''',''))))  =  'Highlights'
		
				SET @SQL =   
				           ';WIth Cte_DefaultValue AS (
										  SELECT AttributeDefaultValueCode , ZPDF.PimAttributeId ,FNPA.AttributeCode
										  FROM ZnodePImAttributeDefaultValue ZPDF
										  INNER JOIN [dbo].[Fn_GetProductDefaultFilterAttributes] () FNPA ON ( FNPA.PimAttributeId = ZPDF.PimAttributeId) 
										)
										, Cte_productIds AS 
										(
										  SELECT a.PimProductId, c.AttributeCode , CTDV.AttributeDefaultValueCode AttributeValue,b.ModifiedDate 
										  FROM  ZnodePimAttributeValue a
										  LEFT JOIN ZnodePimAttribute c ON(c.PimAttributeId = a.PimAttributeId)
										  LEFT JOIN ZnodePimAttributeValueLocale b ON(b.PimAttributeValueId = a.PimAttributeValueId)  
										  INNER JOIN Cte_DefaultValue CTDV ON (CTDV.AttributeCode = c.AttributeCode 
										  AND EXISTS (SELECT TOP 1 1 FROM dbo.split(b.AttributeValue,'','') SP WHERE SP.Item = CTDV.AttributeDefaultValueCode) )
										  Union all 
										  
											SELECT a.PimProductId,c.AttributeCode,ZPADV.AttributeDefaultValueCode AttributeValue ,a.ModifiedDate 
											FROM ZnodePimProductAttributeDefaultValue ZPPADV
											INNER JOIN ZnodePimAttributeDefaultValue ZPADV ON (ZPPADV.PimAttributeDefaultValueId = ZPADV.PimAttributeDefaultValueId)
											LEFT JOIN ZnodePimAttributeValue a ON (a.PimAttributeValueId = ZPPADV.PimAttributeValueId )
											LEFT JOIN ZnodePimAttribute c ON ( c.PimAttributeId=a.PimAttributeId )
											INNER JOIN Cte_DefaultValue CTDV ON (CTDV.AttributeCode = c.AttributeCode )
										)										
										SELECT PimProductId ,ModifiedDate
										FROM Cte_productIds WHERE  AttributeCode '+(SELECT TOP 1 AttributeCode  FROM @AttributeCodeValue )+' AND 
										AttributeValue '+(SELECT TOP 1 AttributeValue  FROM @AttributeCodeValue )+' 
										GROUP BY PimProductId,ModifiedDate Order By ModifiedDate DESC ';


					 SET @Order_BY = CASE WHEN @Order_BY = '' THEN 'ModifiedDate DESC' ELSE @Order_BY END 
					 	
					 SET @WhereClause = CAST(REPLACE(CAST(@WhereClause AS NVARCHAR(max)),'<WhereClauseModel><attributecode>'''+(SELECT TOP 1 AttributeCode  FROM @AttributeCodeValue )+'''</attributecode><attributevalue>'''+(SELECT TOP 1 AttributeValue   FROM @AttributeCodeValue )+'''</attributevalue></WhereClauseModel>','') AS XML )
					
				     INSERT INTO @TBL_ProductIds ( PimProductId, ModifiedDate )
					 EXEC (@SQL);
			  					 
					
						 INSERT INTO @ProductIdTable( PimProductId )
						 SELECT PimProductId 
						 FROM @TBL_ProductIds
					

                     INSERT INTO @TransferPimProductId
					 SELECT PimProductId
                     FROM @ProductIdTable
                   
				   			  
     DELETE FROM @ProductIdTable;
   --  SET @WhereClause = CAST(REPLACE(CAST(@WhereClause AS NVARCHAR(MAX)), @FirstWhereClause, ' 1 = 1') AS XML);
                 END
	            ELSE IF @PimProductId <> ''
			    BEGIN 
		
				 INSERT INTO @TransferPimProductId(id)
				 SELECT Item 
				 FROM dbo.split(@PimProductId,',')
			    END 
		
			
	 DECLARE  @ProductListIdRTR TransferId
	 DECLARE @TAb Transferid 
	 --DECLARE @tBL_mainList TABLE (Id INT,RowId INT)
	 Create table #TBL_ProductMainList (Id INT,RowId INT)

	 	IF @PimProductId <> ''  OR   @IsCallForAttribute=1 --OR (CAST(@WhereClause AS NVARCHAR(max))= N'' AND @Order_by <> N'' AND @AttributeCode = N'')
		BEGIN 
	 SET @IsProductNotIn = CASE WHEN @IsProductNotIn = 0 THEN 1  
					 WHEN @IsProductNotIn = 1 THEN 0 END 
		END 
	
	 INSERT INTO @ProductListIdRTR
	 EXEC Znode_GetProductList  @IsProductNotIn,@TransferPimProductId, @PimCatalogId,@IsCatalogFilter
 
	 IF CAST(@WhereClause AS NVARCHAR(max))<> N''
	 BEGIN 
	 
	  SET @SQL = 'SELECT Distinct PimProductId FROM ##Temp_PimProductId'+CAST(@@SPID AS VARCHAR(500))

	  EXEC Znode_GetFilterPimProductId @WhereClause,@ProductListIdRTR,@localeId,@IsProductNotIn
	  
      INSERT INTO @TAB 
	  EXEC (@SQL)
	 
	 END 
	 
	

	 IF EXISTS (SELECT Top 1 1 FROM @TAb ) OR CAST(@WhereClause AS NVARCHAR(max)) <> N''
	 BEGIN 
	 
	 SET @AttributeCode = REPLACE(dbo.FN_TRIM(REPLACE(REPLACE(@order_by,' DESC',''),' ASC','')),'DisplayOrder','ProductName')
	 SET @order_by = REPLACE(@order_by,'DisplayOrder','ProductName')
	 INSERT INTO #TBL_ProductMainList(id,RowId)
	 EXEC Znode_GetOrderByPagingProduct @order_by,@rows,@PageNo, @TAb ,@AttributeCode,@localeId
	 
	 END 
	 ELSE 
	 BEGIN
	      
	 SET @AttributeCode = REPLACE(dbo.FN_TRIM(REPLACE(REPLACE(@order_by,' DESC',''),' ASC','')),'DisplayOrder','ProductName')
	 SET @order_by = REPLACE(@order_by,'DisplayOrder','ProductName')
	 INSERT INTO #TBL_ProductMainList(id,RowId)
	 EXEC Znode_GetOrderByPagingProduct @order_by,@rows,@PageNo, @ProductListIdRTR ,@AttributeCode,@localeId 
	 END 
          

  			 INSERT INTO @PimProductIds ( Id  )
			 SELECT DISTINCT id FROM #TBL_ProductMainList

			 DECLARE @TBL_PimProductIds transferId 
			 INSERT INTO @TBL_PimProductIds
			 SELECT id 
             FROM @PimProductIds
			 			 	
			 DECLARE @PimAttributeIds TransferId  
			 INSERT INTO @PimAttributeIds
			 SELECT PimAttributeId  
			 FROM [dbo].[Fn_GetProductGridAttributes]()
			 
			

			 INSERT INTO @TBL_AttributeDetails
             (PimProductId,
              AttributeValue,
              AttributeCode,
              PimAttributeId,
			  AttributeDefaultValue
             )
             EXEC Znode_GetProductsAttributeValue_newTesting
                  @TBL_PimProductIds,
                  @PimAttributeIds,
                  @localeId;
			
			
			UPDATE @TBL_AttributeDetails
			SET AttributeValue = ISNULL(AttributeValue,'')
			WHERE AttributeValue IS NULL 

----------------------------------------------------------------------------------------------------

			

		    declare @SKU SelectColumnList
			declare @TBL_Inventorydetails table (Quantity NVARCHAR(MAx),PimProductId INT)

			INSERT INTO @SKU
			SELECT AttributeValue 
			FROM @TBL_AttributeDetails
			WHERE AttributeCode = 'SKU'
 
 			INSERT INTO @TBL_Inventorydetails(Quantity,PimProductId)
			EXEC Znode_GetPimProductAttributeInventory @SKU=@SKU, @LocaleId=@LocaleId

			 INSERT INTO @FamilyDetails
             (PimAttributeFamilyId,
              PimProductId
             )
             EXEC [dbo].[Znode_GetPimProductAttributeFamilyId]
                  @PimProductIds,
                  1;
             
		 UPDATE a
               SET
                   FamilyName = b.AttributeFamilyName
             FROM @FamilyDetails a
                  INNER JOIN ZnodePimFamilyLocale b ON(a.PimAttributeFamilyId = b.PimAttributeFamilyId
                                                       AND LocaleId = @LocaleId);
             UPDATE a
               SET
                   FamilyName = b.AttributeFamilyName
             FROM @FamilyDetails a
                  INNER JOIN ZnodePimFamilyLocale b ON(a.PimAttributeFamilyId = b.PimAttributeFamilyId
                                                       AND LocaleId = @DefaultLocaleId)
             WHERE a.FamilyName IS NULL
                   OR a.FamilyName = '';
           	
			INSERT INTO @TBL_AttributeDetails             (PimProductId,              AttributeValue,              AttributeCode,              PimAttributeId             )
			SELECT PimProductId ,FamilyName, 'AttributeFamily',NULL
			FROM @FamilyDetails 
			

			  
					INSERT INTO @TBL_AttributeDetails             (PimProductId,              AttributeValue,              AttributeCode,              PimAttributeId             )
					SELECT a.ID PimProductId ,th.DisplayName, 'PublishStatus',NULL
					FROM @PimProductIds a 
					INNER JOIN ZnodePimProduct b ON (b.PimProductId = a.ID)
					LEFT JOIN ZnodePublishState th ON (th.PublishStateId = b.PublishStateId)
				 
			
		 IF isnull(@publishstatus,'') = ''

                 BEGIN
					INSERT INTO #TBL_AttributeDetailsLocale (PimProductId ,PimAttributeId,AttributeCode )
						SELECT  TBLAD.PimProductId ,TBLAD.PimAttributeId,TBLAD.AttributeCode 
						FROM @TBL_AttributeDetails TBLAD 
						GROUP BY  TBLAD.PimProductId ,TBLAD.PimAttributeId,TBLAD.AttributeCode 
				 end 
				 else
				 begin
						INSERT INTO #TBL_AttributeDetailsLocale (PimProductId ,PimAttributeId,AttributeCode )
							SELECT  TBLAD.PimProductId ,TBLAD.PimAttributeId,TBLAD.AttributeCode 
							FROM @TBL_AttributeDetails TBLAD where TBLAD.PimProductId  
									in (select PimProductId from @TBL_AttributeDetails  t where t.AttributeCode = 'PublishStatus'
										and AttributeValue in (select DisplayName from ZnodePublishState where PublishStateId in (select id from @publishstatusid)))
								
							GROUP BY  TBLAD.PimProductId ,TBLAD.PimAttributeId,TBLAD.AttributeCode 
				 End
		
	    UPDATE TBLPP 
		SET AttributeValue = CTDD.AttributeValue 
		FROM  @TBL_AttributeDetails CTDD 
		INNER JOIN #TBL_AttributeDetailsLocale TBLPP ON (TBLPP.PimProductId = CTDD.PimProductId AND TBLPP.AttributeCode  = CTDD.AttributeCode)
		WHERE TBLPP.AttributeValue IS NULL 

    	SET @ProductXML =  '<MainProduct>'+ STUFF( (  SELECT '<Product>'+'<PimProductId>'+CAST(TBAD.PimProductId AS VARCHAR(50))+'</PimProductId>'
																		+'<AvailableInventory>'+CAST(ISNULL(IDD.[Quantity],'') AS VARCHAR(50))+'</AvailableInventory>'
		+ STUFF(    (  SELECT '<'+TBADI.AttributeCode+'>'+CAST( (SELECT  ''+TBADI.AttributeValue FOR XML PATH('')) AS NVARCHAR(max))+'</'+TBADI.AttributeCode+'>'   
															FROM #TBL_AttributeDetailsLocale TBADI      
															 WHERE TBADI.PimProductId = TBAD.PimProductId 
															 ORDER BY TBADI.PimProductId DESC
															 FOR XML PATH (''), TYPE
																).value('.', ' Nvarchar(max)'), 1, 0, '')+'</Product>'	   

		FROM #TBL_AttributeDetailsLocale TBAD
		INNER JOIN #TBL_ProductMainList TBPI ON (TBAD.PimProductid = TBPI.id )
		LEFT JOIN @TBL_ProductIds TPT ON TBAD.PimProductId = TPT.PimProductId
		LEFT JOIN @TBL_InventoryDetails IDD ON (TBPI.id = IDD.PimProductId)
		GROUP BY TBAD.pimProductid, TPT.ModifiedDate,TBPI.RowId,IDD.Quantity
		ORDER BY TBPI.RowId 
		FOR XML PATH (''),TYPE).value('.', ' Nvarchar(max)'), 1, 0, '')+'</MainProduct>'
			--FOR XML PATH ('MainProduct'))
 

			SELECT  CAST(@ProductXML AS XML ) ProductXMl
		   
		     SELECT AttributeCode ,  ZPAL.AttributeName
			 FROM ZnodePimAttribute ZPA 
			 LEFT JOIN ZnodePiMAttributeLOcale ZPAL ON (ZPAL.PimAttributeId = ZPA.PimAttributeId )
             WHERE LocaleId = 1  
			 AND  IsCategory = 0 
			 AND ZPA.IsShowOnGrid = 1  
			 UNION ALL 
			 SELECT 'PublishStatus','Publish Status'

     IF EXISTS (SELECT Top 1 1 FROM @TAb )
	 BEGIN 

		  SELECT (SELECT COUNT(1) FROM @TAb) AS RowsCount   
	 END 
	 ELSE 
	 BEGIN
	 		  SELECT (SELECT COUNT(1) FROM @ProductListIdRTR) AS RowsCount   
	 END 
		;

             -- find the all locale values 
         END TRY
         BEGIN CATCH
		    SELECT ERROR_MESSAGE()
                DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ManageProductList_XML @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@LocaleId = '+CAST(@LocaleId AS VARCHAR(50))+',@PimProductId='+@PimProductId+',@IsProductNotIn='+CAST(@IsProductNotIn AS VARCHAR(50))+',@IsCallForAttribute='+CAST(@IsCallForAttribute AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_ManageProductList_XML',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;

         END CATCH;

     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ManageProductTypeAssociationList')
	DROP PROC Znode_ManageProductTypeAssociationList
GO

CREATE PROCEDURE [dbo].[Znode_ManageProductTypeAssociationList]    
(   @WhereClause      NVARCHAR(MAX) = '',    
    @Rows             INT           = 10,    
    @PageNo           INT           = 1,    
    @Order_BY         VARCHAR(1000) = '',    
    @RelatedProductId INT           = 0,    
    @IsAssociated     BIT           = 0,    
    @RowsCount        INT OUT,    
    @LocaleId         INT           = 1)    
AS    
/*    
Summary: This Procedure is used to manage Product association    
Unit Testing :    
 EXEC [Znode_ManageProductTypeAssociationList] '', @RowsCount = 0,@RelatedProductId = 44    
*/    
     BEGIN    
         SET NOCOUNT ON;    
         BEGIN TRY    
             DECLARE @SQL NVARCHAR(MAX), @AlternetOrderBy NVARCHAR(2000),@OutPimProductIds VARCHAR(max);    
             DECLARE @DefaultLocaleId INT= Dbo.Fn_GetDefaultValue('Locale');    
             DECLARE @DefaultAttributeFamily INT= Dbo.Fn_GetDefaultValue('PimFamily');    
    DECLARE @ProductIdTable TABLE (  PimProductId int, CountId int, RowId int IDENTITY(1,1));    
    DECLARE @ProductAttributeDetials TABLE ( PimProductId int, AttributeCode nvarchar(600), AttributeValue nvarchar(max), LocaleId int);    
    DECLARE @OrderByDisplay INT= 0;    
    DECLARE @ProductFinalDetails TABLE( PimProductId int, ProductName nvarchar(max), SKU nvarchar(max));                 
    DECLARE @PimProductId VARCHAR(MAX)= '';    
             DECLARE @TransferPimProductId TransferId     
    DECLARE @TBL_PimMediaAttributeId TABLE (PimAttributeId INT ,AttributeCode VARCHAR(600))    
    INSERT INTO @TBL_PimMediaAttributeId (PimAttributeId,AttributeCode)    
    SELECT PimAttributeId,AttributeCode FROM Dbo.Fn_GetProductMediaAttributeId ()    
    
    IF @Order_BY LIKE '%DisplayOrder%'    
             BEGIN    
                SET @OrderByDisplay = 1;    
             END;    
    
            INSERT INTO @TransferPimProductId      
   SELECT PimProductId    
   FROM ZnodePimProductTypeAssociation     
   WHERE PimParentProductId = @RelatedProductId    
            ORDER BY CASE WHEN @Order_By LIKE '% DESC%' THEN CASE WHEN @OrderByDisplay = 1 THEN DisplayOrder ELSE 1 END ELSE 1 END DESC,    
                    CASE WHEN @Order_By LIKE '% ASC%'  THEN CASE WHEN @OrderByDisplay = 1 THEN DisplayOrder ELSE 1 END ELSE 1 END    
         
 SET @IsAssociated = CASE WHEN @IsAssociated = 1 THEN 0     
  WHEN @IsAssociated = 0 THEN 1  END    
    
      
     DECLARE  @ProductListIdRTR TransferId    
  DECLARE @TAb Transferid     
  DECLARE @tBL_mainList TABLE(id INT , RowId INT )    
     
  INSERT INTO @ProductListIdRTR    
  EXEC Znode_GetProductList @IsAssociated ,@TransferPimProductId    
    
  IF CAST(@WhereClause AS NVARCHAR(max))<> N''    
  BEGIN     
       
   SET @SQL = 'SELECT PimProductId FROM ##Temp_PimProductId'+CAST(@@SPID AS VARCHAR(500))    
       
   EXEC Znode_GetFilterPimProductId @WhereClause,@ProductListIdRTR,@localeId    
       
      INSERT INTO @TAB     
   EXEC (@SQL)    
      
  END     
  DECLARE @AttributeCode varchar(600)    
  IF EXISTS (SELECT Top 1 1 FROM @TAb ) OR CAST(@WhereClause AS NVARCHAR(max)) <> N''    
  BEGIN     
     
  SET @AttributeCode = dbo.FN_TRIM(REPLACE(REPLACE(@order_by,' DESC',''),' ASC',''))    
    
  INSERT INTO @TBL_MainList    
  EXEC Znode_GetOrderByPagingProduct @order_by,@rows,@PageNo, @TAb ,@AttributeCode,@localeId    
     
  END     
  ELSE     
  BEGIN    
   SET @AttributeCode = dbo.FN_TRIM(REPLACE(REPLACE(@order_by,' DESC',''),' ASC',''))    
        
      
  INSERT INTO @TBL_MainList    
  EXEC Znode_GetOrderByPagingProduct @order_by,@rows,@PageNo, @ProductListIdRTR ,@AttributeCode,@localeId     
  END      
      
     
    INSERT INTO @ProductIdTable    
             (PimProductId)     
   SELECT id FROM @TBL_MainList                
    
    DECLARE @PimProductIds TransferId    
    
    INSERT INTO @PimProductIds ( Id )     
    SELECT PimProductId FROM @ProductIdTable    
    
    DECLARE @DefaultAttributeCode  TRANSFERID    
     INSERT INTO @DefaultAttributeCode    
     SELECT  PimAttributeId FROM [dbo].[Fn_GetProductGridAttributes]()     
                
                
    --select * from @DefaultAttributeCode    
    
    DECLARE @TBL_AttributeDetails AS TABLE (PimProductId int, AttributeValue nvarchar(max), AttributeCode varchar(600), PimAttributeId int, AttributeDefaultValue NVARCHAR(MAX));    
    
        
             DECLARE @TBL_AttributeDefaultValue TABLE (PimAttributeId INT, AttributeDefaultValueCode VARCHAR(100), IsEditable BIT,AttributeDefaultValue NVARCHAR(MAX),DisplayOrder INT);    
                
    INSERT INTO @TBL_AttributeDetails( PimProductId, AttributeValue, AttributeCode, PimAttributeId , AttributeDefaultValue)    
    EXEC Znode_GetProductsAttributeValue_newTesting @PimProductIds, @DefaultAttributeCode, @LocaleId;      
       
       
        
   INSERT INTO @TBL_AttributeDetails             (PimProductId,              AttributeValue,              AttributeCode,              PimAttributeId             )    
   SELECT a.PimProductId ,CASE WHEN IsProductPublish = 1 THEN   'Published' WHEN IsProductPublish = 0 THEN 'Draft'  ELSE 'Not Published' END, 'PublishStatus',NULL    
   FROM @ProductIdTable a     
   INNER JOIN ZnodePimProduct b ON (b.PimProductId = a.PimProductId)    
    
   --select * from @TBL_AttributeDetails    
    
   ------------------------------------------------------------------------------------------------    
    
   declare @SKU SelectColumnList    
   declare @TBL_Inventorydetails table (Quantity NVARCHAR(MAx),PimProductId INT)    
    
   INSERT INTO @SKU    
   SELECT AttributeValue FROM @TBL_AttributeDetails    
   WHERE AttributeCode = 'SKU'    
    
   --select * from @SKU    
       
   INSERT INTO @TBL_InventoryDetails(Quantity,PimProductId)    
   EXEC Znode_GetPimProductAttributeInventory @SKU=@SKU, @LocaleId=@LocaleId
    
    
   ---------------------------------------------    
    
             DECLARE @FamilyDetails TABLE    
             (PimProductId         INT,    
              PimAttributeFamilyId INT,    
              FamilyName           NVARCHAR(3000)    
             );    
             INSERT INTO @FamilyDetails    
             (PimAttributeFamilyId,    
              PimProductId    
             )    
             EXEC [dbo].[Znode_GetPimProductAttributeFamilyId]    
                  @PimProductIds,    
                  1;     
             -- find the product families      
    --;WITH Cte_ProductMedia    
    --           AS (SELECT TBA.PimProductId , TBA.PimAttributeId     
    --  , SUBSTRING( ( SELECT ','+URL+ZMSM.ThumbnailFolderName+'/'+ zm.PATH     
    --  FROM ZnodeMedia AS ZM    
    --           INNER JOIN ZnodeMediaConfiguration ZMC  ON (ZM.MediaConfigurationId = ZMC.MediaConfigurationId)    
    --  INNER JOIN ZnodeMediaServerMaster ZMSM ON (ZMSM.MediaServerMasterId = ZMC.MediaServerMasterId)    
    --  INNER JOIN @TBL_AttributeDetails AS TBAI ON (TBAI.AttributeValue  = CAST(ZM.MediaId AS VARCHAR(50)))    
    --  INNER JOIN  @TBL_PimMediaAttributeId AS FNMA ON (FNMA.PImAttributeId = TBAI.PimATtributeId)    
    --  WHERE TBAI.PimProductId = TBA.PimProductId AND TBAI.PimAttributeId = TBA.PimAttributeId     
    --  FOR XML PATH('')), 2 , 4000) AS AttributeValue     
    --  FROM @TBL_AttributeDetails AS TBA     
    --  INNER JOIN  @TBL_PimMediaAttributeId AS FNMA ON (FNMA.PImAttributeId = TBA.PimATtributeId ))    
                              
    --    UPDATE TBAV SET AttributeValue = CTPM.AttributeVALue    
    -- FROM @TBL_AttributeDetails TBAV     
    -- INNER JOIN Cte_ProductMedia CTPM ON CTPM.PimProductId = TBAV.PimProductId  AND CTPM.PimAttributeId = TBAV.PimAttributeId     
    -- AND CTPM.PimAttributeId = TBAV.PimAttributeId;    
         
             UPDATE a    
               SET    
                   FamilyName = b.AttributeFamilyName    
             FROM @FamilyDetails a    
                  INNER JOIN ZnodePimFamilyLocale b ON(a.PimAttributeFamilyId = b.PimAttributeFamilyId    
                                                       AND LocaleId = @LocaleId);    
             UPDATE a    
               SET    
                   FamilyName = b.AttributeFamilyName    
             FROM @FamilyDetails a    
                  INNER JOIN ZnodePimFamilyLocale b ON(a.PimAttributeFamilyId = b.PimAttributeFamilyId    
                                                       AND LocaleId = @DefaultLocaleId)    
             WHERE a.FamilyName IS NULL    
                   OR a.FamilyName = '';    
       
   INSERT INTO @TBL_AttributeDetails             (PimProductId,              AttributeValue,              AttributeCode,              PimAttributeId             )    
   SELECT PimProductId ,FamilyName, 'AttributeFamily',NULL    
   FROM @FamilyDetails     
        
      
             --- Update the  product families name locale wise       
        UPDATE  @TBL_AttributeDetails SET PimAttributeId = 0 WHERE PimAttributeId IS nULL     
      DECLARE @ProductXML XML     
    
    
    
      SET @ProductXML =   '<MainProduct>'+ STUFF( (  SELECT '<Product>'    
                                                      +'<PimProductTypeAssociationId>'+CAST(ISNULL(ZPTA.PimProductTypeAssociationId,'') AS VARCHAR(50))+'</PimProductTypeAssociationId>'    
               +'<PimProductId>'+CAST(zpp.PimProductId AS VARCHAR(50))+'</PimProductId>'    
               +'<RelatedProductId>'+CAST(ISNULL(ZPTA.PimParentProductId,'') AS VARCHAR(50))+'</RelatedProductId>'    
               +'<DisplayOrder>'+CAST(ZPTA.[DisplayOrder] AS VARCHAR(50))+'</DisplayOrder>'    
       +'<BundleQuantity>'+CAST(ISNULL(ZPTA.[BundleQuantity],'1') AS VARCHAR(50))+'</BundleQuantity>'    
               +'<AvailableInventory>'+CAST(ISNULL(IDD.[Quantity],'') AS VARCHAR(50))+'</AvailableInventory>'    
    
   + STUFF(    (  SELECT '<'+TBADI.AttributeCode+'>'+CAST( (SELECT ''+TBADI.AttributeValue FOR XML PATH('')) AS NVARCHAR(max))+'</'+TBADI.AttributeCode+'>'       
               FROM @TBL_AttributeDetails TBADI          
                WHERE TBADI.PimProductId = zpp.PimProductId     
                ORDER BY TBADI.PimProductId DESC    
                FOR XML PATH (''), TYPE    
                ).value('.', ' Nvarchar(max)'), 1, 0, '')+'</Product>'        
    
    FROM @ProductIdTable AS zpp    
    INNER JOIN @TBL_MainList TMM ON (TMM.id = zpp.PimProductId)    
    LEFT JOIN @TBL_InventoryDetails IDD ON (zpp.PimProductId = IDD.PimProductId)    
             LEFT JOIN ZnodePimProductTypeAssociation ZPTA ON(ZPTA.PimProductId = Zpp.PimProductId    
                                                                    AND ZPTA.PimParentProductId = @RelatedProductId)    
             ORDER BY CASE    
                          WHEN @Order_By LIKE '% DESC%'    
                          THEN CASE    
                                   WHEN @OrderByDisplay = 1    
                                   THEN ZPTA.DisplayOrder    
           ELSE 1    
                               END    
                          ELSE 1    
                      END DESC,    
                      CASE    
                          WHEN @Order_By LIKE '% ASC%'    
                          THEN CASE    
                                   WHEN @OrderByDisplay = 1    
                                   THEN ZPTA.DisplayOrder    
                                   ELSE 1    
                               END    
                          ELSE 1    
                      END,TMM.RowId    
   FOR XML PATH (''),TYPE).value('.', ' Nvarchar(max)'), 1, 0, '')+'</MainProduct>'    
     
   SELECT  CAST(@ProductXML AS XML )  ProductXMl    
         
       SELECT AttributeCode ,  ZPAL.AttributeName    
    FROM ZnodePimAttribute ZPA     
    LEFT JOIN ZnodePiMAttributeLOcale ZPAL ON (ZPAL.PimAttributeId = ZPA.PimAttributeId )    
             WHERE LocaleId = 1      
    AND  IsCategory = 0     
    AND ZPA.IsShowOnGrid = 1      
    UNION ALL     
    SELECT 'PublishStatus','Publish Status'    
    
    
      IF EXISTS (SELECT Top 1 1 FROM @TAb )    
    BEGIN     
    
     SELECT (SELECT COUNT(1) FROM @TAb) AS RowsCount       
    END     
    ELSE     
    BEGIN    
       SELECT (SELECT COUNT(1) FROM @ProductListIdRTR) AS RowsCount       
    END     
    
         END TRY    
         BEGIN CATCH    
               DECLARE @Status BIT ;    
       SET @Status = 0;    
       DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ManageProductTypeAssociationList @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@LocaleId = '+CAST(@LocaleId AS VARCHAR(50))+',@RelatedProductId='+CAST(@RelatedProductId AS VARCHAR(50))+',@IsAssociated='+CAST(@IsAssociated AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));    
                      
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                        
        
             EXEC Znode_InsertProcedureErrorLog    
    @ProcedureName = 'Znode_ManageProductTypeAssociationList',    
    @ErrorInProcedure = @Error_procedure,    
    @ErrorMessage = @ErrorMessage,    
    @ErrorLine = @ErrorLine,    
    @ErrorCall = @ErrorCall;    
         END CATCH;    
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSearchProfile')
	DROP PROC Znode_InsertUpdateSearchProfile
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSearchProfile]
(   @SearchProfileId       int,
    @ProfileName           nvarchar(200),
	@SearchQueryTypeId     int,
	@SearchSubQueryTypeId  int,
    @SearchProfileFeatureList SearchProfileFeatureList readonly ,
    @SearchProfileAttributeList SearchProfileAttributeList readonly ,
    @UserId                INT,
	@PublishCatalogId      int,
	@Operator			   nvarchar(20),	
	@IsDefault             bit=0 ,
	@SearchProfileFieldValue  SearchProfileFieldValueFactor  readonly
	 )
AS 
   /* 
    Summary: This Procedure is used to save and edit the quote line item      
    Unit Testing   
    Exec Znode_InsertUpdateQuoteLineItem 
	Unit Testing

	 GO 
	declare @p7 dbo.SearchProfileFetureList
	insert into @p7 values(N'0',1)

	declare @p8 dbo.SearchProfileAttributeList
	insert into @p8 values(N'ProductSpecification',0,0,1)
	insert into @p8 values(N'ShortDescription',0,0,3)
	insert into @p8 values(N'ProductName',0,0,2)
	insert into @p8 values(N'FeatureDescription',0,0,4)
	insert into @p8 values(N'SKU',0,0,5)

	exec sp_executesql N'Znode_InsertUpdateSearchProfile  @SearchProfileId,@ProfileName,@SearchQueryTypeId,@SearchSubQueryTypeId,@SearchProfileFeatureList,@SearchProfileAttributeList,@UserId,@PublishCatalogId,@Operator,@IsDefault',N'@SearchProfileId int,@Prof
ileName nvarchar(17),@SearchQueryTypeId int,@SearchSubQueryTypeId int,@SearchProfileFeatureList [dbo].[SearchProfileFetureList] READONLY,@SearchProfileAttributeList [dbo].[SearchProfileAttributeList] READONLY,@UserId int,@PublishCatalogId int,@Operator nva
rchar(2),@IsDefault bit',@SearchProfileId=0,@ProfileName=N'FineFoodsProfile1',@SearchQueryTypeId=2,@SearchSubQueryTypeId=0,@SearchProfileFeatureList=@p7,@SearchProfileAttributeList=@p8,@UserId=0,@PublishCatalogId=3,@Operator=N'OR',@IsDefault=0
   
	*/
	   BEGIN
	DECLARE @GetDate DATETIME = dbo.Fn_GetDate(),@PublishCatalogSearchProfileId int ,@ReturnMessage  NVARCHAR(max)= ''
  
         BEGIN TRAN A;
         BEGIN TRY


	


		  If Isnull(@SearchProfileId,0)=0  
		  Begin
			IF EXISTS (SELECT TOP 1 1 from ZnodeSearchProfile ZSP WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogSearchProfile PCP WHERE PCP.PublishCatalogId =@PublishCatalogId AND PCP.SearchProfileId =ZSP.SearchProfileId   ) AND ProfileName = @ProfileName  )
			BEGIN 
				SELECT @SearchProfileId AS ID,'ProfileName Already Exists' As MessageDetails,CAST(0 AS BIT) AS Status;   	  
				Return ; 
			END 
			INSERT INTO [dbo].[ZnodeSearchProfile] ([ProfileName],[SearchQueryTypeId],[SearchSubQueryTypeId],[Operator],[CreatedBy],[CreatedDate],[ModifiedBy],[ModifiedDate])
			Select @ProfileName,@SearchQueryTypeId,@SearchSubQueryTypeId,@Operator,@UserId,@GetDate,@UserId,@GetDate
			Set @SearchProfileId=SCOPE_IDENTITY()
		  End
		  else 
		  Begin
			IF EXISTS (SELECT TOP 1 1  FROM [ZnodeSearchProfile] ZSP WHERE [ProfileName] = @ProfileName AND 
			EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogSearchProfile PCP WHERE PCP.PublishCatalogId =@PublishCatalogId AND PCP.SearchProfileId =ZSP.SearchProfileId   ) AND 
			 ZSP.SearchProfileId <>  Isnull(@SearchProfileId,0)  )
			BEGIN 
				SELECT @SearchProfileId AS ID,'ProfileName Already Exists' As MessageDetails,CAST(0 AS BIT) AS Status;   	  
				Return ; 
			END 

		    Update a
			Set a.[ProfileName]=@ProfileName,
			a.SearchQueryTypeId=@SearchQueryTypeId,
			a.SearchSubQueryTypeId=@SearchSubQueryTypeId,
			a.Operator = @Operator,
			a.ModifiedBy=@UserId,
			a.ModifiedDate=@GetDate
			from [dbo].[ZnodeSearchProfile] a
			Where SearchProfileId=@SearchProfileId
		    
		  End 

		  delete f
		  from ZnodeSearchProfileAttributeMapping f
		  Where SearchProfileId=@SearchProfileId
		  and not exists(Select 1 from @SearchProfileAttributeList d
		  where f.AttributeCode=d.AttributeCode )
		  AND f.IsFacets = 0

		  INSERT INTO [dbo].ZnodeSearchProfileAttributeMapping([SearchProfileId],[AttributeCode],[IsFacets],[IsUseInSearch],[BoostValue],[CreatedBy],[CreatedDate],[ModifiedBy],[ModifiedDate])
		  Select @SearchProfileId,[AttributeCode],[IsFacets],[IsUseInSearch],[BoostValue],@UserId [CreatedBy],@GetDate[CreatedDate],@UserId [ModifiedBy],@GetDate [ModifiedDate]
		   from @SearchProfileAttributeList d
		  where  not exists(Select 1 from ZnodeSearchProfileAttributeMapping f
		  where f.AttributeCode=d.AttributeCode 
		  and f.SearchProfileId=@SearchProfileId)

		  Update f
		  Set f.[IsFacets]=(CASE WHEN d.[IsFacets]=0 THEN f.[IsFacets] ELSE d.[IsFacets] END),f.[IsUseInSearch]=d.[IsUseInSearch],
		  f.[BoostValue]=d.[BoostValue]
		  From [dbo].ZnodeSearchProfileAttributeMapping f
		  inner join @SearchProfileAttributeList d
		  on f.AttributeCode=d.AttributeCode
		   and f.SearchProfileId=@SearchProfileId
		   --WHERE f.IsUseInSearch = 1

		    UPDATE f
			SET f.[IsUseInSearch]=0
			FROM [dbo].ZnodeSearchProfileAttributeMapping f
			LEFT JOIN @SearchProfileAttributeList d ON f.AttributeCode=d.AttributeCode AND f.SearchProfileId=@SearchProfileId
			WHERE f.SearchProfileId=@SearchProfileId AND d.[IsUseInSearch] IS NULL

		   delete f
		  from [ZnodeSearchProfileFeatureMapping] f
		  Where SearchProfileId=@SearchProfileId
		  and not exists(Select 1 from @SearchProfileFeatureList d
		  where f.SearchFeatureId=d.SearchProfileFeatureId )

		  INSERT INTO [dbo].[ZnodeSearchProfileFeatureMapping]([SearchProfileId],SearchFeatureId,[SearchFeatureValue],[CreatedBy],[CreatedDate],[ModifiedBy],[ModifiedDate])
		  Select @SearchProfileId,d.SearchProfileFeatureId,[SearchFeatureValue]
		  ,@UserId [CreatedBy],@GetDate[CreatedDate],@UserId [ModifiedBy],@GetDate [ModifiedDate]
		   from @SearchProfileFeatureList d
		  where  not exists(Select 1 from [ZnodeSearchProfileFeatureMapping] f
		  where f.SearchFeatureId=d.SearchProfileFeatureId 
		  and f.SearchProfileId=@SearchProfileId)

		  Update f
		  Set f.[SearchFeatureValue]=d.SearchFeatureValue,
		  f.ModifiedBy=@UserId,
		  f.ModifiedDate=@GetDate
		  From [dbo].[ZnodeSearchProfileFeatureMapping] f
		  inner join @SearchProfileFeatureList d
		  on f.SearchFeatureId=d.SearchProfileFeatureId  and f.SearchProfileId=@SearchProfileId
          
		   Select @PublishCatalogSearchProfileId=PublishCatalogSearchProfileId
		   From  [dbo].[ZnodePublishCatalogSearchProfile]
		   Where [PublishCatalogId]=@PublishCatalogId and  SearchProfileId = @SearchProfileId 


		   If @IsDefault=1
		      update [ZnodePublishCatalogSearchProfile]
			  set [IsDefault]=@IsDefault,
			  ModifiedBy=@UserId,
		      ModifiedDate=@GetDate
			  From  [ZnodePublishCatalogSearchProfile]
			  Where PublishCatalogSearchProfileId!=@PublishCatalogSearchProfileId
			  and [PublishCatalogId]=@PublishCatalogId

		   If Isnull(@PublishCatalogSearchProfileId,0)>0
		   Begin
		      update [ZnodePublishCatalogSearchProfile]
			  set [IsDefault]=@IsDefault,
			  ModifiedBy=@UserId,
		      ModifiedDate=@GetDate
			  From  [ZnodePublishCatalogSearchProfile]
			  Where PublishCatalogSearchProfileId=@PublishCatalogSearchProfileId
		   End
		   Else
		   INSERT INTO [dbo].[ZnodePublishCatalogSearchProfile] ([PublishCatalogId],[SearchProfileId],[IsDefault],[CreatedBy],[CreatedDate],[ModifiedBy],[ModifiedDate])
		   Select @PublishCatalogId,@SearchProfileId,@IsDefault,@UserId,@GetDate,@UserId,@GetDate

		   DELETE VF
		   FROM ZnodeSearchProfileFieldValueFactor VF
		   WHERE VF.SearchProfileId = @SearchProfileId
		   AND NOT EXISTS (SELECT 1 FROM @SearchProfileFieldValue SFP WHERE SFP.FieldName = VF.FieldName)


		   INSERT INTO ZnodeSearchProfileFieldValueFactor (SearchProfileId,FieldName,FieldValueFactor,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		   SELECT @SearchProfileId,SPF.FieldName,SPF.FieldValueFactor,@UserId,@GetDate,@UserId,@GetDate
		   FROM @SearchProfileFieldValue SPF
		   WHERE NOT EXISTS (SELECT 1 FROM ZnodeSearchProfileFieldValueFactor pf WHERE pf.FieldName = SPF.FieldName AND pf.SearchProfileId = @SearchProfileId)

		   UPDATE VF
		   SET FieldValueFactor = SPF.FieldValueFactor
		   FROM ZnodeSearchProfileFieldValueFactor VF
		   INNER JOIN @SearchProfileFieldValue SPF ON (SPF.FieldName = VF.FieldName) AND VF.SearchProfileId = @SearchProfileId


		  SELECT @SearchProfileId AS ID,'Successfull' MessageDetails,CAST(1 AS BIT) AS Status;   			
			 COMMIT TRAN A;
         END TRY
         BEGIN CATCH
        
		    -- SET @Status = 0;
		  ----   DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			 ----@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertUpdateQuoteLineItem @CartLineItemXML = '+CAST(@CartLineItemXML AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,'UnSuccessfull' MessageDetails,CAST(0 AS BIT) AS Status;                    
			 ROLLBACK TRAN A;
    --         EXEC Znode_InsertProcedureErrorLog
				--@ProcedureName = 'Znode_InsertUpdateQuoteLineItem',
				--@ErrorInProcedure = @Error_procedure,
				--@ErrorMessage = @ErrorMessage,
				--@ErrorLine = @ErrorLine,
				--@ErrorCall = @ErrorCall;
         END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishContentContainerAttributeValue')
	DROP PROC Znode_GetPublishContentContainerAttributeValue
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishContentContainerAttributeValue]
(
	@EntityName	NVARCHAR(200) = 0,
	@ContainerKey	NVARCHAR(200),
	@LocalId	INT = 0,
	@PortalId	INT = 0,
	@ProfileId	INT = 0
)
AS
/*
	 Summary :- This procedure is used to get the Content and Container attribute value as per filter pass
	 Unit Testing
	 BEGIN TRAN
	 EXEC [Znode_GetPublishContentContainerAttributeValue] @EntityName='Content Containers',@ContainerKey='',@LocalId=0,@PortalId=0,@ProfileId=0
	 ROLLBACK TRAN
*/
BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
		-- Variable Declaration as per the code requirement
		DECLARE @LocaleCode NVARCHAR(50),
				@LocalIdInput INT,
				@LocaleCodeInput NVARCHAR(50),
				@CMSContainerProfileVariantId INT,
				@GroupCode NVARCHAR(200) = NULL,
				@SelectedValue BIT = 0,
				@FamilyCode VARCHAR(200);

		SET @LocalIdInput = @LocalId

		SELECT @LocaleCode=Code FROM ZnodeLocale WITH (NOLOCK) WHERE LocaleId=@LocalId;
		SET @LocaleCodeInput = @LocaleCode

		--1. Specific Store, Specific User Profile, Selected Locale
		-- Based on input if count will 1 then this will take CMSContainerProfileVariantId from 1st loop else this will go for next loop.
		IF (SELECT COUNT(1) FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK) WHERE ISNULL(WPV.ProfileId,0)=@ProfileId  AND WPV.LocaleId=@LocalId)=1
		BEGIN
			SELECT @CMSContainerProfileVariantId=WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE ISNULL(WPV.ProfileId,0)=@ProfileId AND WPV.ContainerKey=@ContainerKey
			AND WPV.LocaleId=@LocalId
			AND WPV.IsActive=1
		END
		ELSE
		BEGIN
			SELECT @CMSContainerProfileVariantId=WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = @ProfileId ) AND (ISNULL(WPV.PortalId,0) = @PortalId )
			AND WPV.ContainerKey=@ContainerKey AND WPV.LocaleId=@LocalId
			AND WPV.IsActive=1
		END

		--2. Specific Store, Specific User Profile, Default Locale
		IF ISNULL(@CMSContainerProfileVariantId,0) = 0
		BEGIN
			SELECT @LocalId = LocaleId FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;
			SELECT @LocaleCode = Code FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;

			SELECT @CMSContainerProfileVariantId= WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = @ProfileId ) AND (ISNULL(WPV.PortalId,0) = @PortalId )
			AND WPV.ContainerKey=@ContainerKey AND WPV.LocaleId=@LocalId
			AND WPV.IsActive=1

			IF ISNULL(@CMSContainerProfileVariantId,0) = 0
			BEGIN
				SET @LocalId = @LocalIdInput
				SET @LocaleCode = @LocaleCodeInput
			END
		
		END

		--3. Specific Store, Any User Profile, Selected Locale
		IF ISNULL(@CMSContainerProfileVariantId,0) = 0
		BEGIN
			SELECT @CMSContainerProfileVariantId= WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = 0 ) AND (ISNULL(WPV.PortalId,0) = @PortalId )
			AND WPV.ContainerKey=@ContainerKey AND WPV.LocaleId=@LocalId
			AND WPV.IsActive=1
		END

		--4. Specific Store, Any User Profile, Default Locale
		IF ISNULL(@CMSContainerProfileVariantId,0) = 0
		BEGIN
			SELECT @LocalId = LocaleId FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;
			SELECT @LocaleCode = Code FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;

			SELECT @CMSContainerProfileVariantId= WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = 0 ) AND (ISNULL(WPV.PortalId,0) = @PortalId )
			AND WPV.ContainerKey=@ContainerKey AND WPV.LocaleId=@LocalId
			AND WPV.IsActive=1

			IF ISNULL(@CMSContainerProfileVariantId,0) = 0
			BEGIN
				SET @LocalId = @LocalIdInput
				SET @LocaleCode = @LocaleCodeInput
			END
		END
		
		--5. Any Store, Any User Profile, Selected Locale
		IF ISNULL(@CMSContainerProfileVariantId,0) = 0
		BEGIN
			SELECT @CMSContainerProfileVariantId= WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = 0 ) AND (ISNULL(WPV.PortalId,0) = 0 )
			AND WPV.ContainerKey=@ContainerKey AND WPV.LocaleId=@LocalId
			AND WPV.IsActive=1
		END

		--6. Any Store, Any User Profile, Default Locale
		IF ISNULL(@CMSContainerProfileVariantId,0) = 0
		BEGIN
			SELECT @LocalId = LocaleId FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;
			SELECT @LocaleCode = Code FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;

			SELECT @CMSContainerProfileVariantId= WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = 0 ) AND (ISNULL(WPV.PortalId,0) = 0 )
			AND WPV.ContainerKey=@ContainerKey AND WPV.LocaleId=@LocalId
			AND WPV.IsActive=1

			IF ISNULL(@CMSContainerProfileVariantId,0) = 0
			BEGIN
				SET @LocalId = @LocalIdInput
				SET @LocaleCode = @LocaleCodeInput
			END
		END	
		-- This will take FamilyCode based on the inputs.
		SELECT @FamilyCode=GAF.FamilyCode
		FROM ZnodeCMSContentContainer CCW WITH (NOLOCK)
		INNER JOIN ZnodeGlobalAttributeFamily GAF WITH (NOLOCK) ON CCW.FamilyId=GAF.GlobalAttributeFamilyId
		WHERE CCW.ContainerKey=@ContainerKey 
		AND EXISTS(SELECT * FROM ZnodePublishContentContainerVariantEntity CWPV WITH (NOLOCK) WHERE CCW.CMSContentContainerId = CWPV.CMSContentContainerId AND (ISNULL(CWPV.PortalId,0)=@PortalId));

		-- Based on input @EntityName='Content Containers' as fixed value this will execute nested SP.
		-- Nested SP will give 2 Output (1 Result set & 1 Msg.

		-- Declared table variable to combined nested sp data with the output of this sp.
		DECLARE	@PublishContainerGlobalAttributeValue As TABLE
		(CMSContainerProfileVariantId INT, ContentContainerName NVARCHAR(100), ContainerKey NVARCHAR(50), GlobalAttributes NVARCHAR(MAX), ContainerTemplateName NVARCHAR(100))

		IF @EntityName='Content Containers'
		begin
			INSERT INTO @PublishContainerGlobalAttributeValue
				(CMSContainerProfileVariantId,ContentContainerName, ContainerKey, GlobalAttributes, ContainerTemplateName)
			EXEC [dbo].[Znode_GetPublishContainerGlobalAttributeValue]
				@CMSContainerProfileVariantId=@CMSContainerProfileVariantId, @LocaleCode= @LocaleCode
		end
		
		-- This will take FamilyCode based on the inputs.
		SELECT @FamilyCode=GAF.FamilyCode
		FROM ZnodeCMSContentContainer CCW WITH (NOLOCK)
		INNER JOIN ZnodeGlobalAttributeFamily GAF WITH (NOLOCK) ON CCW.FamilyId=GAF.GlobalAttributeFamilyId
		WHERE CCW.ContainerKey=@ContainerKey 
		AND EXISTS(SELECT * FROM ZnodeCMSContainerProfileVariant CWPV WHERE CCW.CMSContentContainerId = CWPV.CMSContentContainerId AND (ISNULL(CWPV.PortalId,0)=@PortalId));

		IF ISNULL(@FamilyCode,'') = ''
		BEGIN
			-- This will take FamilyCode based on the inputs.
			SELECT @FamilyCode=GAF.FamilyCode
			FROM ZnodeCMSContentContainer CCW WITH (NOLOCK)
			INNER JOIN ZnodeGlobalAttributeFamily GAF WITH (NOLOCK) ON CCW.FamilyId=GAF.GlobalAttributeFamilyId
			WHERE CCW.ContainerKey=@ContainerKey 
			AND EXISTS(SELECT * FROM ZnodeCMSContainerProfileVariant CWPV WHERE CCW.CMSContentContainerId = CWPV.CMSContentContainerId AND (ISNULL(CWPV.PortalId,0)=0));
		END

		-- This will give 3rd result set of Attribute Groups Data.
		--SELECT GE.GlobalEntityId, GE.EntityName, GE.IsActive, GE.TableName, GE.IsFamilyUnique
		--	, GAF.GlobalAttributeFamilyId, GAF.FamilyCode, GAF.IsSystemDefined, GAF.GlobalEntityId
		--	, GFGM.GlobalFamilyGroupMapperId, GFGM.GlobalAttributeFamilyId, GFGM.GlobalAttributeGroupId
		--	, GFGM.AttributeGroupDisplayOrder
		--	, GAG.GlobalAttributeGroupId, GAG.GroupCode, GAG.DisplayOrder, GAG.IsSystemDefined, GAG.GlobalEntityId
		--	, GAGL.GlobalAttributeGroupLocaleId, GAGL.LocaleId, GAGL.GlobalAttributeGroupId, GAGL.AttributeGroupName
		--	, GAGL.[Description]
		--FROM ZnodeGlobalEntity GE WITH (NOLOCK)
		--INNER JOIN ZnodeGlobalAttributeFamily GAF WITH (NOLOCK) ON GE.GlobalEntityId=GAF.GlobalEntityId
		--INNER JOIN ZnodeGlobalFamilyGroupMapper GFGM WITH (NOLOCK) ON GAF.GlobalAttributeFamilyId=GFGM.GlobalAttributeFamilyId
		--INNER JOIN ZnodeGlobalAttributeGroup GAG WITH (NOLOCK) ON GFGM.GlobalAttributeGroupId=GAG.GlobalAttributeGroupId
		--INNER JOIN ZnodeGlobalAttributeGroupLocale GAGL WITH (NOLOCK) ON GAG.GlobalAttributeGroupId=GAGL.GlobalAttributeGroupId
		--WHERE GE.EntityName=@EntityName AND GAGL.LocaleId=@LocalId AND GAF.FamilyCode=@FamilyCode
		--ORDER BY GFGM.AttributeGroupDisplayOrder;

		-- This will give 4th result set of ContainerProfile & ContentContainer Data.

		;WITH Cte_CMSContainerProfileVariant AS
		(
		SELECT DISTINCT CWPV.PublishContentContainerVariantEntityId,CWPV.CMSContainerProfileVariantId, CWPV.CMSContentContainerId, CGAV.ContentContainerName, CWPV.ProfileId
			, CWPV.LocaleId, CWPV.CMSContainerTemplateId, CGAV.ContainerTemplateName
			, CCW.[Name], CCW.ContainerKey, CWPV.PortalId, CCW.FamilyId, CCW.Tags
			, CGAV.GlobalAttributes
		FROM ZnodePublishContentContainerVariantEntity CWPV WITH (NOLOCK)
		INNER JOIN ZnodeCMSContentContainer CCW WITH (NOLOCK) ON CWPV.CMSContentContainerId=CCW.CMSContentContainerId
		INNER JOIN @PublishContainerGlobalAttributeValue CGAV ON CCW.ContainerKey=CGAV.ContainerKey
			AND CWPV.CMSContainerProfileVariantId=CGAV.CMSContainerProfileVariantId
		WHERE CWPV.IsActive=1 AND ( (ISNULL(CWPV.ProfileId,0) = @ProfileId OR ISNULL(CWPV.ProfileId,0) = 0) AND CWPV.LocaleId=@LocalId AND CCW.ContainerKey=@ContainerKey
			AND ((ISNULL(CWPV.PortalId,0)=@PortalId OR ISNULL(CWPV.PortalId,0) = 0)))
		)
		,Cte_GetFirstFilterData AS
		(
		SELECT DISTINCT CWPV.PublishContentContainerVariantEntityId,CWPV.CMSContainerProfileVariantId, CWPV.CMSContentContainerId, CGAV.ContentContainerName, CWPV.ProfileId
			, CWPV.LocaleId, CWPV.CMSContainerTemplateId, CGAV.ContainerTemplateName
			, CCW.[Name], CCW.ContainerKey, CWPV.PortalId, CCW.FamilyId, CCW.Tags
			, CGAV.GlobalAttributes
		FROM ZnodePublishContentContainerVariantEntity CWPV WITH (NOLOCK)
		INNER JOIN ZnodeCMSContentContainer CCW WITH (NOLOCK) ON CWPV.CMSContentContainerId=CCW.CMSContentContainerId
		INNER JOIN @PublishContainerGlobalAttributeValue CGAV ON CCW.ContainerKey=CGAV.ContainerKey
		WHERE CWPV.ProfileId IS NULL AND CCW.ContainerKey=@ContainerKey AND CWPV.PortalId IS NULL AND CWPV.LocaleId=@LocalId
		)

		SELECT DISTINCT CMSContainerProfileVariantId, CMSContentContainerId, ContentContainerName, ProfileId
			, LocaleId, CMSContainerTemplateId, ContainerTemplateName
			, [Name], ContainerKey, PortalId, FamilyId, Tags
			, GlobalAttributes
		FROM Cte_CMSContainerProfileVariant
		UNION
		SELECT DISTINCT CMSContainerProfileVariantId, CMSContentContainerId, ContentContainerName, ProfileId
			, LocaleId, CMSContainerTemplateId, ContainerTemplateName
			, [Name], ContainerKey, PortalId, FamilyId, Tags
			, GlobalAttributes
		FROM Cte_GetFirstFilterData CWPV
		WHERE NOT EXISTS (SELECT * FROM Cte_CMSContainerProfileVariant WHERE PublishContentContainerVariantEntityId=CWPV.PublishContentContainerVariantEntityId)
			AND NOT EXISTS (SELECT * FROM Cte_CMSContainerProfileVariant)

		-- This will give 5th result set of ContainerTemplate & ContentContainer Data.
		--SELECT CWT.CMSContainerTemplateId, CWT.[FileName], CWT.MediaId, CCW.[Name], CCW.FamilyId, CCW.Tags
		--FROM ZnodeCMSContentContainer CCW WITH (NOLOCK) 
		--INNER JOIN ZnodeCMSContainerProfileVariant CWPV ON CCW.CMSContentContainerId = CWPV.CMSContentContainerId AND (ISNULL(CWPV.PortalId,0)=@PortalId OR ISNULL(CWPV.PortalId,0) = 0)
		--INNER JOIN ZnodeCMSContainerProfileVariantLocale CWPVL ON CWPV.CMSContainerProfileVariantId = CWPVL.CMSContainerProfileVariantId
		--INNER JOIN  ZnodeCMSContainerTemplate CWT WITH (NOLOCK) ON (CWPVL.CMSContainerTemplateId = CWT.CMSContainerTemplateId OR ISNULL(CWPVL.CMSContainerTemplateId,0) = 0)
		--WHERE CCW.ContainerKey=@ContainerKey
	END TRY
	BEGIN CATCH
		SELECT ERROR_MESSAGE()
		DECLARE @Status BIT;
		SET @Status = 0;

		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(),
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishContentContainerAttributeValue
					@EntityName = '''+ISNULL(@EntityName,'''''')+
					''',@ContainerKey='+ISNULL(@ContainerKey,'''')+
					''',@LocalId='+ISNULL(CAST(@LocalId AS VARCHAR(20)),'''')+
					''',@PortalId='+ISNULL(CAST(@PortalId AS VARCHAR(20)),'''')+
					''',@ProfileId='+ISNULL(CAST(@ProfileId AS VARCHAR(20)),'''')
					
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_GetPublishContentContainerAttributeValue',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetWidgetGlobalAttributeValue')
	DROP PROC Znode_GetWidgetGlobalAttributeValue
GO

CREATE PROCEDURE [dbo].[Znode_GetWidgetGlobalAttributeValue]
(
    @EntityName       nvarchar(200) = 0,
    @GlobalEntityValueId   INT = 0,
	@LocaleCode       VARCHAR(100) = '',
    @GroupCode  nvarchar(200) = null,
    @SelectedValue bit = 0
)
AS
 BEGIN
 BEGIN TRY
 declare @EntityValue nvarchar(200), @LocaleId int, @WidgetId int, @DefaultLocaleId INT

 

  DECLARE @V_MediaServerThumbnailPath VARCHAR(4000);
          SET @V_MediaServerThumbnailPath =
         (
             SELECT ISNULL(CASE WHEN CDNURL = '' THEN NULL ELSE CDNURL END,URL) 
             FROM ZnodeMediaConfiguration ZMC 
			 --INNER JOIN ZnodeMediaServerMaster ZMSM ON (ZMSM.MediaServerMasterId = ZMC.MediaServerMasterId)
		     WHERE IsActive = 1 
         );

 Select @EntityValue= Name,@WidgetId = CCW.CMSContentContainerId from ZnodeCMSContentContainer CCW
 inner join ZnodeCMSContainerProfileVariant CWPV  on CCW.CMSContentContainerId = CWPV.CMSContentContainerId
 Where CWPV.CMSContainerProfileVariantId = @GlobalEntityValueId

 	DECLARE @GlobalFamilyId int
	SET  @GlobalFamilyId = (select top 1 FM.GlobalAttributeFamilyId from ZnodeGlobalEntity GE inner join  ZnodeGlobalEntityFamilyMapper FM
	on GE.GlobalEntityId = FM.GlobalEntityId
	where GE.EntityName =  @EntityName and  (FM.GlobalEntityValueId = @GlobalEntityValueId ))
  

            Declare	@EntityAttributeList as	table  (GlobalEntityId int,EntityName nvarchar(300),EntityValue nvarchar(max),
			GlobalAttributeGroupId int,GlobalAttributeId int,AttributeTypeId int,AttributeTypeName nvarchar(300),
			 AttributeCode nvarchar(300) ,IsRequired bit,IsLocalizable bit,AttributeName  nvarchar(300) , HelpDescription nvarchar(max),DisplayOrder int
			) 
			 
			Declare @EntityAttributeValidationList  as	table  
			( GlobalAttributeId int, ControlName nvarchar(300), ValidationName nvarchar(300),SubValidationName nvarchar(300),
			 RegExp nvarchar(300), ValidationValue nvarchar(300),IsRegExp Bit)

			Declare	@EntityAttributeValueList as	table  (GlobalAttributeId int,AttributeValue nvarchar(max),
			GlobalAttributeValueId int,GlobalAttributeDefaultValueId int,AttributeDefaultValueCode nvarchar(300),
			AttributeDefaultValue nvarchar(300),
			MediaId int,MediaPath nvarchar(300),IsEditable bit,DisplayOrder int )



			Declare	@EntityAttributeDefaultValueList as	table  (GlobalAttributeDefaultValueId int,GlobalAttributeId int,
			AttributeDefaultValueCode nvarchar(300),AttributeDefaultValue nvarchar(300),RowId int,IsEditable bit,DisplayOrder int )

			set @LocaleId = (select top 1 LocaleId from ZnodeLocale where Code = @LocaleCode)
			set @DefaultLocaleId = (select top 1 LocaleId from ZnodeLocale WHERE IsDefault = 1)

			if isnull(@LocaleId,0)=0
				set @LocaleId = (select top 1 LocaleId from ZnodeLocale WHERE IsDefault = 1)

            IF ISnull(@GroupCode, '') = ''
            Begin
			
				insert into @EntityAttributeList
					(	GlobalEntityId ,EntityName ,EntityValue ,
					GlobalAttributeGroupId ,GlobalAttributeId ,AttributeTypeId ,AttributeTypeName ,
					AttributeCode  ,IsRequired ,IsLocalizable ,AttributeName,HelpDescription,DisplayOrder  ) 
				SELECT qq.GlobalEntityId,qq.EntityName,@EntityValue EntityValue,ww.GlobalAttributeGroupId,
					c.GlobalAttributeId,c.AttributeTypeId,q.AttributeTypeName,c.AttributeCode,c.IsRequired,
					c.IsLocalizable,f.AttributeName,c.HelpDescription,c.DisplayOrder
				 FROM dbo.ZnodeGlobalEntity AS qq
					  INNER JOIN dbo.ZnodeGlobalAttributeFamily AS w ON qq.GlobalEntityId = w.GlobalEntityId
					  INNER JOIN dbo.ZnodeGlobalFamilyGroupMapper AS FGM ON FGM.GlobalAttributeFamilyId = w.GlobalAttributeFamilyId
					  INNER JOIN dbo.ZnodeGlobalAttributeGroupMapper AS ww ON ww.GlobalAttributeGroupId = FGM.GlobalAttributeGroupId
					  INNER JOIN dbo.ZnodeGlobalAttribute AS c ON ww.GlobalAttributeId = c.GlobalAttributeId
					  INNER JOIN dbo.ZnodeAttributeType AS q ON c.AttributeTypeId = q.AttributeTypeId
					  INNER JOIN dbo.ZnodeGlobalAttributeLocale AS f ON c.GlobalAttributeId = f.GlobalAttributeId
					  Where qq.EntityName=@EntityName AND ( f.LocaleId = isnull(@LocaleId, 0 ) or isnull(@LocaleId,0) = 0 )
					  and w.GlobalAttributeFamilyId = @GlobalFamilyId

				insert into @EntityAttributeList
				SELECT qq.GlobalEntityId,qq.EntityName,@EntityValue EntityValue,ww.GlobalAttributeGroupId,
					c.GlobalAttributeId,c.AttributeTypeId,q.AttributeTypeName,c.AttributeCode,c.IsRequired,
					c.IsLocalizable,f.AttributeName,c.HelpDescription,c.DisplayOrder
				 FROM dbo.ZnodeGlobalEntity AS qq
					  INNER JOIN dbo.ZnodeGlobalAttributeFamily AS w ON qq.GlobalEntityId = w.GlobalEntityId
					  INNER JOIN dbo.ZnodeGlobalFamilyGroupMapper AS FGM ON FGM.GlobalAttributeFamilyId = w.GlobalAttributeFamilyId
					  INNER JOIN dbo.ZnodeGlobalAttributeGroupMapper AS ww ON ww.GlobalAttributeGroupId = FGM.GlobalAttributeGroupId
					  INNER JOIN dbo.ZnodeGlobalAttribute AS c ON ww.GlobalAttributeId = c.GlobalAttributeId
					  INNER JOIN dbo.ZnodeAttributeType AS q ON c.AttributeTypeId = q.AttributeTypeId
					  INNER JOIN dbo.ZnodeGlobalAttributeLocale AS f ON c.GlobalAttributeId = f.GlobalAttributeId
					  Where qq.EntityName=@EntityName AND ( f.LocaleId = isnull(@DefaultLocaleId, 0 ) or isnull(@DefaultLocaleId,0) = 0 )
					  and w.GlobalAttributeFamilyId = @GlobalFamilyId
					AND NOT EXISTS(SELECT * FROM @EntityAttributeList Z
						WHERE qq.GlobalEntityId = Z.GlobalEntityId AND qq.EntityName = Z.EntityName AND c.GlobalAttributeId = Z.GlobalAttributeId)

				IF NOT EXISTS(SELECT * FROM @EntityAttributeList)
				BEGIN
					insert into @EntityAttributeList
					(	GlobalEntityId ,EntityName ,EntityValue ,
					GlobalAttributeGroupId ,GlobalAttributeId ,AttributeTypeId ,AttributeTypeName ,
					AttributeCode  ,IsRequired ,IsLocalizable ,AttributeName,HelpDescription,DisplayOrder  ) 
					SELECT qq.GlobalEntityId,qq.EntityName,@EntityValue EntityValue,ww.GlobalAttributeGroupId,
						c.GlobalAttributeId,c.AttributeTypeId,q.AttributeTypeName,c.AttributeCode,c.IsRequired,
						c.IsLocalizable,f.AttributeName,c.HelpDescription,c.DisplayOrder
					 FROM dbo.ZnodeGlobalEntity AS qq
					  INNER JOIN dbo.ZnodeGlobalAttributeFamily AS w ON qq.GlobalEntityId = w.GlobalEntityId
					  INNER JOIN dbo.ZnodeGlobalFamilyGroupMapper AS FGM ON FGM.GlobalAttributeFamilyId = w.GlobalAttributeFamilyId
					  INNER JOIN dbo.ZnodeGlobalAttributeGroupMapper AS ww ON ww.GlobalAttributeGroupId = FGM.GlobalAttributeGroupId
					  INNER JOIN dbo.ZnodeGlobalAttribute AS c ON ww.GlobalAttributeId = c.GlobalAttributeId
					  INNER JOIN dbo.ZnodeAttributeType AS q ON c.AttributeTypeId = q.AttributeTypeId
					  INNER JOIN dbo.ZnodeGlobalAttributeLocale AS f ON c.GlobalAttributeId = f.GlobalAttributeId
					  Where qq.EntityName=@EntityName ---AND ( f.LocaleId = isnull(@DefaultLocaleId, 0 ) or isnull(@DefaultLocaleId,0) = 0 )
					  --and w.GlobalAttributeFamilyId = @GlobalFamilyId
				END
			
			
			END
			Else

               Begin
                       insert into @EntityAttributeList
                               ( GlobalEntityId ,EntityName ,EntityValue ,
                               GlobalAttributeGroupId ,GlobalAttributeId ,AttributeTypeId ,AttributeTypeName ,
                               AttributeCode  ,IsRequired ,IsLocalizable ,AttributeName,HelpDescription,DisplayOrder  )
                               SELECT qq.GlobalEntityId,qq.EntityName,@EntityValue EntityValue,ww.GlobalAttributeGroupId,
                               c.GlobalAttributeId,c.AttributeTypeId,q.AttributeTypeName,c.AttributeCode,c.IsRequired,
                               c.IsLocalizable,f.AttributeName,c.HelpDescription,c.DisplayOrder
                        FROM dbo.ZnodeGlobalEntity AS qq
						INNER JOIN dbo.ZnodeGlobalAttributeFamily AS w ON qq.GlobalEntityId = w.GlobalEntityId
					  INNER JOIN dbo.ZnodeGlobalFamilyGroupMapper AS FGM ON FGM.GlobalAttributeFamilyId = w.GlobalAttributeFamilyId
					  INNER JOIN dbo.ZnodeGlobalAttributeGroupMapper AS ww ON ww.GlobalAttributeGroupId = FGM.GlobalAttributeGroupId
					  INNER JOIN dbo.ZnodeGlobalAttribute AS c ON ww.GlobalAttributeId = c.GlobalAttributeId
					  INNER JOIN dbo.ZnodeAttributeType AS q ON c.AttributeTypeId = q.AttributeTypeId
					  INNER JOIN dbo.ZnodeGlobalAttributeLocale AS f ON c.GlobalAttributeId = f.GlobalAttributeId
					  Where qq.EntityName=@EntityName AND ( f.LocaleId = isnull(@LocaleId, 0 ) or isnull(@LocaleId,0) = 0 )
					  and w.GlobalAttributeFamilyId = @GlobalFamilyId	
                                 AND exists( select 1 from ZnodeGlobalAttributeGroup g where ww.GlobalAttributeGroupId = g.GlobalAttributeGroupId and g.GroupCode = @GroupCode )	
        
					IF NOT EXISTS(SELECT * FROM @EntityAttributeList)
					BEGIN
						insert into @EntityAttributeList
                               ( GlobalEntityId ,EntityName ,EntityValue ,
                               GlobalAttributeGroupId ,GlobalAttributeId ,AttributeTypeId ,AttributeTypeName ,
                               AttributeCode  ,IsRequired ,IsLocalizable ,AttributeName,HelpDescription,DisplayOrder  )
                               SELECT qq.GlobalEntityId,qq.EntityName,@EntityValue EntityValue,ww.GlobalAttributeGroupId,
                               c.GlobalAttributeId,c.AttributeTypeId,q.AttributeTypeName,c.AttributeCode,c.IsRequired,
                               c.IsLocalizable,f.AttributeName,c.HelpDescription,c.DisplayOrder
						FROM dbo.ZnodeGlobalEntity AS qq
						INNER JOIN dbo.ZnodeGlobalAttributeFamily AS w ON qq.GlobalEntityId = w.GlobalEntityId
						  INNER JOIN dbo.ZnodeGlobalFamilyGroupMapper AS FGM ON FGM.GlobalAttributeFamilyId = w.GlobalAttributeFamilyId
						  INNER JOIN dbo.ZnodeGlobalAttributeGroupMapper AS ww ON ww.GlobalAttributeGroupId = FGM.GlobalAttributeGroupId
						  INNER JOIN dbo.ZnodeGlobalAttribute AS c ON ww.GlobalAttributeId = c.GlobalAttributeId
						  INNER JOIN dbo.ZnodeAttributeType AS q ON c.AttributeTypeId = q.AttributeTypeId
						  INNER JOIN dbo.ZnodeGlobalAttributeLocale AS f ON c.GlobalAttributeId = f.GlobalAttributeId
						  Where qq.EntityName=@EntityName --AND ( f.LocaleId = isnull(@DefaultLocaleId, 0 ) or isnull(@DefaultLocaleId,0) = 0 )
						  --and w.GlobalAttributeFamilyId = @GlobalFamilyId	
                          AND exists( select 1 from ZnodeGlobalAttributeGroup g where ww.GlobalAttributeGroupId = g.GlobalAttributeGroupId and g.GroupCode = @GroupCode )	
        
					END
			   
			   
			   END


		  INSERT INTO @EntityAttributeValidationList
		  (GlobalAttributeId,ControlName , ValidationName ,SubValidationName ,
		RegExp, ValidationValue,IsRegExp)

		

		 Select aa.GlobalAttributeId,i.ControlName,i.Name AS ValidationName,j.ValidationName AS SubValidationName,
		j.RegExp,k.Name AS ValidationValue,CAST(CASE WHEN j.RegExp IS NULL THEN 0 ELSE 1 END AS BIT) AS IsRegExp
		
		fROM @EntityAttributeList aa
		  inner  JOIN dbo.ZnodeGlobalAttributeValidation AS k ON k.GlobalAttributeId = aa.GlobalAttributeId
          inner  JOIN dbo.ZnodeAttributeInputValidation AS i ON k.InputValidationId = i.InputValidationId
          LEFT  JOIN dbo.ZnodeAttributeInputValidationRule AS j ON k.InputValidationRuleId = j.InputValidationRuleId

		  insert into @EntityAttributeValueList
		  (GlobalAttributeId,GlobalAttributeValueId,GlobalAttributeDefaultValueId,AttributeValue ,MediaId,MediaPath)
		  Select DISTINCT GlobalAttributeId,aa.WidgetGlobalAttributeValueId,bb.GlobalAttributeDefaultValueId,
		  case when bb.MediaPath is not null then  @V_MediaServerThumbnailPath+bb.MediaPath--+'~'+convert(nvarchar(10),bb.MediaId) 
		  else bb.AttributeValue end,		  
		  bb.MediaId,bb.MediaPath
		  from  dbo.ZnodeWidgetGlobalAttributeValue aa
		   inner join ZnodeWidgetGlobalAttributeValueLocale bb ON bb.WidgetGlobalAttributeValueId = aa.WidgetGlobalAttributeValueId 
		  Where  aa.CMSContainerProfileVariantId=@GlobalEntityValueId and aa.CMSContentContainerId = @WidgetId		
		  AND ( bb.LocaleId = isnull(@LocaleId, 0 ) or isnull(@LocaleId,0) = 0 )
	

		  update aa
		  Set AttributeDefaultValueCode= h.AttributeDefaultValueCode,
              AttributeDefaultValue=g.AttributeDefaultValue,
			  GlobalAttributeDefaultValueId=g.GlobalAttributeDefaultValueId,
			  AttributeValue=case when aa.AttributeValue is  null then h.AttributeDefaultValueCode else aa.AttributeValue end,
			  IsEditable = ISNULL(h.IsEditable, 1),DisplayOrder = h.DisplayOrder
		  from  @EntityAttributeValueList aa
		  inner JOIN dbo.ZnodeGlobalAttributeDefaultValue h ON h.GlobalAttributeDefaultValueId = aa.GlobalAttributeDefaultValueId                                       
          inner JOIN dbo.ZnodeGlobalAttributeDefaultValueLocale g ON h.GlobalAttributeDefaultValueId = g.GlobalAttributeDefaultValueId
		  WHERE ( G.LocaleId = isnull(@LocaleId, 0 ) or isnull(@LocaleId,0) = 0 )
          
		  insert into @EntityAttributeDefaultValueList
		  (GlobalAttributeDefaultValueId,GlobalAttributeId,AttributeDefaultValueCode,
			AttributeDefaultValue ,RowId ,IsEditable ,DisplayOrder )
		  Select  h.GlobalAttributeDefaultValueId, aa.GlobalAttributeId,h.AttributeDefaultValueCode,g.AttributeDefaultValue,0,ISNULL(h.IsEditable, 1),
		  h.DisplayOrder
		  from  @EntityAttributeList aa
		  inner JOIN dbo.ZnodeGlobalAttributeDefaultValue h ON h.GlobalAttributeId = aa.GlobalAttributeId
          inner JOIN dbo.ZnodeGlobalAttributeDefaultValueLocale g ON h.GlobalAttributeDefaultValueId = g.GlobalAttributeDefaultValueId
		  WHERE ( G.LocaleId = isnull(@LocaleId, 0 ) or isnull(@LocaleId,0) = 0 )
		 
			if not exists (Select 1 from @EntityAttributeList )
			Begin
			insert into @EntityAttributeList
			(	GlobalEntityId ,EntityName ,EntityValue ,
			GlobalAttributeGroupId ,GlobalAttributeId ,AttributeTypeId ,AttributeTypeName ,
			AttributeCode  ,IsRequired ,IsLocalizable ,AttributeName,HelpDescription  ) 
			SELECT qq.GlobalEntityId,qq.EntityName,@EntityValue EntityValue,0 GlobalAttributeGroupId,
			0 GlobalAttributeId,0 AttributeTypeId,''AttributeTypeName,''AttributeCode,0 IsRequired,
			0 IsLocalizable,'' AttributeName,'' HelpDescription
			FROM dbo.ZnodeGlobalEntity AS qq
			 Where qq.EntityName=@EntityName 
			End
				

			SELECT GlobalEntityId,EntityName,EntityValue,GlobalAttributeGroupId,
			AA.GlobalAttributeId,AttributeTypeId,AttributeTypeName,AttributeCode,IsRequired,
			IsLocalizable,AttributeName,ControlName,ValidationName,SubValidationName,RegExp,
			ValidationValue,cast(isnull(IsRegExp,0) as bit)  IsRegExp,
			HelpDescription,AttributeValue,GlobalAttributeValueId,bb.GlobalAttributeDefaultValueId,
			aab.AttributeDefaultValueCode,
			aab.AttributeDefaultValue,isnull(aab.RowId,0)   RowId,cast(isnull(aab.IsEditable,0) as bit)   IsEditable
			,bb.MediaId,AA.DisplayOrder
			fROM @EntityAttributeList AA				
			left join @EntityAttributeDefaultValueList aab on aab.GlobalAttributeId=AA.GlobalAttributeId	
			left join @EntityAttributeValidationList vl on vl.GlobalAttributeId=aa.GlobalAttributeId			
			LEFT JOIN @EntityAttributeValueList BB ON BB.GlobalAttributeId=AA.GlobalAttributeId		 
		    and ( (ISNULL(aab.GlobalAttributeDefaultValueId,0)=ISNULL(bb.GlobalAttributeDefaultValueId,0))
			or  ( bb.MediaId is not null and isnull(vl.ValidationName,'')='IsAllowMultiUpload'  and bb.GlobalAttributeDefaultValueId is null )
			or  ( bb.MediaId is  null and  bb.GlobalAttributeDefaultValueId is null ))
			order by AA.DisplayOrder, aab.DisplayOrder

			SELECT 1 AS ID,CAST(1 AS BIT) AS Status;       
		  END TRY
         BEGIN CATCH
		 SELECT ERROR_MESSAGE()
             DECLARE @Status BIT ;
		  SET @Status = 0;

		  DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
		   @ErrorLine VARCHAR(100)= ERROR_LINE(),
		   @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetWidgetGlobalAttributeValue 
		   @EntityName = '+@EntityName+',@GlobalEntityValueId='+CAST(@GlobalEntityValueId AS VARCHAR(10))+',@LocaleCode='+@LocaleCode+',
		   @GroupCode = '+@GroupCode+',@SelectedValue = '+CAST(@SelectedValue AS VARCHAR(10));   
		 
          EXEC Znode_InsertProcedureErrorLog
            @ProcedureName = 'Znode_GetWidgetGlobalAttributeValue',
            @ErrorInProcedure = @Error_procedure,
            @ErrorMessage = @ErrorMessage,
            @ErrorLine = @ErrorLine,
            @ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_SetPublishContentContainerGlobalAttributeEntity')
	DROP PROC Znode_SetPublishContentContainerGlobalAttributeEntity
GO

CREATE PROCEDURE [dbo].[Znode_SetPublishContentContainerGlobalAttributeEntity]
(
	 @ContainerKey VARCHAR(50) = ''
	 ,@ContainerProfileVariantId INT = 0
)
AS
    
/*
exec [Znode_SetPublishContentContainerGlobalAttributeEntity] @ContainerKey = 'HomePagePromo', @ContainerProfileVariantId = 0
    Summary :	Publish Product on the basis of publish catalog
				Retrive all Product details with attributes and INSERT INTO following tables 
				1.	ZnodePublishedXml
				2.	ZnodePublishCategoryProduct
				3.	ZnodePublishProduct
				4.	ZnodePublishProductDetail

                Product details include all the type of products link, grouped, configure and bundel products (include addon) their associated products 
				collect their attributes and values into tables variables to process for publish.  
                
				Finally genrate XML for products with their attributes and inserted into ZnodePublishedXml Znode Admin process xml from sql server to mongodb
				one by one.

 */

BEGIN
	
	BEGIN TRY
		SET NOCOUNT ON;
		DECLARE @VersionId Int, @CMSContentContainerId int
		--SET @VersionId = ( SELECT TOP 1 VersionId FROM ZnodePublishContetContainerVersionEntity WHERE PublishState = @RevisionState )

		DECLARE @SetLocaleId INT, @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleId(), @MaxCount INT =0 , @IncrementalId INT = 1;
		DECLARE @TBL_Locale TABLE (LocaleId INT , RowId INT IDENTITY(1,1));

		DECLARE @V_MediaServerThumbnailPath VARCHAR(4000);
          SET @V_MediaServerThumbnailPath =
         (
             SELECT ISNULL(CASE WHEN CDNURL = '' THEN NULL ELSE CDNURL END,URL) 
             FROM ZnodeMediaConfiguration ZMC 
			 --INNER JOIN ZnodeMediaServerMaster ZMSM ON (ZMSM.MediaServerMasterId = ZMC.MediaServerMasterId)
		     WHERE IsActive = 1 
         );
	
		DECLARE @TBL_GlobalAttributeGrouplist TABLE ([GlobalAttributeGroupId] INT , [AttributeGroupDisplayOrder] INT,Groups int )
		DECLARE @TBL_GlobalAttributelist      TABLE ([GlobalAttributeGroupId] INT , [GlobalAttributeId] INT,[AttributeDisplayOrder] int ,Attributes int )
		Declare	@EntityAttributeValueList as	table
		(
			IsInput bit, IsMedia BIT, AttributeValues int,WidgetGlobalAttributeValueId int,GlobalAttributeId int,AttributeValue nvarchar(max),
			GlobalAttributeValueId int,GlobalAttributeDefaultValueId int,AttributeDefaultValueCode nvarchar(300),
			AttributeDefaultValue nvarchar(300),MediaId int,MediaPath nvarchar(300) ,SwatchText nvarchar(300),DisplayOrder int,
			SingleAttributeValue nvarchar(max), CMSContainerProfileVariantId INT,LocaleId INT
		)
		Declare	@EntityAttributeSingleValueList as table(AttributeValues int,PortalGlobalAttributeValueId int,GlobalAttributeId int)

		Declare @LocaleId INT , @GetDate DATETIME =dbo.Fn_GetDate()

		IF @ContainerKey <> ''
		BEGIN
			Select @CMSContentContainerId= CMSContentContainerId 
			from ZnodeCMSContentContainer  
			WHERE ContainerKey = @ContainerKey
		END

		INSERT INTO @EntityAttributeValueList
		(
			IsInput, IsMedia,AttributeValues,WidgetGlobalAttributeValueId,GlobalAttributeId,GlobalAttributeValueId,GlobalAttributeDefaultValueId,
			AttributeValue ,MediaId,MediaPath,SingleAttributeValue,CMSContainerProfileVariantId, LocaleId
		)
		Select case when zga.GroupAttributeType in('Input','TextArea')   then 1  else 0 end ,
				0, 1, aa.WidgetGlobalAttributeValueId,aa.GlobalAttributeId,aa.WidgetGlobalAttributeValueId,bb.GlobalAttributeDefaultValueId,

			case when zga.GroupAttributeType in('Input','TextArea')   then null  else  bb.AttributeValue  end AttributeValue,	  
			bb.MediaId,CASE WHEN bb.MediaPath IS NOT NULL THEN @V_MediaServerThumbnailPath+bb.MediaPath ELSE bb.MediaPath END AS MediaPath ,
			case when zga.GroupAttributeType in('Input','TextArea')   then bb.AttributeValue   else null end  SingleAttributeValue,
			aa.CMSContainerProfileVariantId, bb.LocaleId
		FROM ZnodeWidgetGlobalAttributeValue aa
		INNER JOIN ZnodeWidgetGlobalAttributeValueLocale bb ON bb.WidgetGlobalAttributeValueId = aa.WidgetGlobalAttributeValueId 
		INNER JOIN View_ZnodeGlobalAttribute zga on zga.[GlobalAttributeId]=aa.[GlobalAttributeId]
		WHERE (aa.CMSContainerProfileVariantId = @ContainerProfileVariantId OR @ContainerProfileVariantId = 0)
		AND (AA.CMSContentContainerId = @CMSContentContainerId OR ISNULL(@CMSContentContainerId,0) = 0 )
		AND bb.MediaId IS NULL 
				

		INSERT INTO @EntityAttributeValueList
		(IsInput,IsMedia,AttributeValues,WidgetGlobalAttributeValueId,GlobalAttributeId,GlobalAttributeValueId,GlobalAttributeDefaultValueId,AttributeValue ,MediaId,MediaPath,SingleAttributeValue,CMSContainerProfileVariantId,LocaleId)
		Select 1,1 ,1, aa.WidgetGlobalAttributeValueId,aa.GlobalAttributeId,aa.WidgetGlobalAttributeValueId,null GlobalAttributeDefaultValueId,
			NULL AttributeValue,	  
			NULL MediaId,null MediaPath,
			NULL SingleAttributeValue, aa.CMSContainerProfileVariantId	,bb.LocaleId
		FROM dbo.ZnodeWidgetGlobalAttributeValue aa
		INNER JOIN ZnodeWidgetGlobalAttributeValueLocale bb ON bb.WidgetGlobalAttributeValueId = aa.WidgetGlobalAttributeValueId 
		INNER JOIN View_ZnodeGlobalAttribute zga on zga.[GlobalAttributeId]=aa.[GlobalAttributeId]
		WHERE (AA.CMSContentContainerId = @CMSContentContainerId OR ISNULL(@CMSContentContainerId,0) = 0 )
		AND zga.GroupAttributeType ='Media'

		UPDATE aa
		Set SingleAttributeValue= ( Select CASE WHEN bb.MediaPath IS NOT NULL THEN @V_MediaServerThumbnailPath+bb.MediaPath ELSE bb.MediaPath END AS MediaPath FROM  ZnodeWidgetGlobalAttributeValueLocale bb 
			WHERE bb.WidgetGlobalAttributeValueId = aa.WidgetGlobalAttributeValueId AND aa.LocaleId = bb.LocaleId
			FOR XML PATH ('') )				
		FROM  @EntityAttributeValueList aa
		WHERE aa.IsMedia=1

		UPDATE aa
		Set SingleAttributeValue= replace(replace(SingleAttributeValue,'</MediaPath>',','),'<MediaPath>','')
		FROM  @EntityAttributeValueList aa
		WHERE aa.IsMedia=1

		UPDATE aa
		Set SingleAttributeValue= Substring(SingleAttributeValue,1,len(SingleAttributeValue)-1)
		FROM  @EntityAttributeValueList aa
		WHERE aa.IsMedia=1 and aa.SingleAttributeValue<>''

		UPDATE aa
		SET AttributeDefaultValueCode= h.AttributeDefaultValueCode,
			SwatchText=h.SwatchText,
			AttributeValue=g.AttributeDefaultValue,
			GlobalAttributeDefaultValueId=g.GlobalAttributeDefaultValueId,
			DisplayOrder=h.DisplayOrder
		FROM  @EntityAttributeValueList aa
		INNER JOIN dbo.ZnodeGlobalAttributeDefaultValue h ON h.GlobalAttributeDefaultValueId = aa.GlobalAttributeDefaultValueId                                       
		INNER JOIN dbo.ZnodeGlobalAttributeDefaultValueLocale g ON h.GlobalAttributeDefaultValueId = g.GlobalAttributeDefaultValueId and aa.LocaleId = g.LocaleId
          
		INSERT INTO @TBL_GlobalAttributeGrouplist
		([GlobalAttributeGroupId] , [AttributeGroupDisplayOrder],Groups )
		SELECT ss.[GlobalAttributeGroupId],ss.[AttributeGroupDisplayOrder],1
		FROM [dbo].[ZnodeGlobalGroupEntityMapper] SS
		INNER JOIN dbo.ZnodeGlobalEntity aa on ss.[GlobalEntityId]=aa.[GlobalEntityId]
		WHERE aa.EntityName='Content Containers'
		--FOR XML PATH('')

		INSERT INTO @TBL_GlobalAttributelist
		([GlobalAttributeGroupId] , [GlobalAttributeId],[AttributeDisplayOrder],Attributes )
		SELECT aa.[GlobalAttributeGroupId],aa.[GlobalAttributeId] ,aa.[AttributeDisplayOrder],1
		FROM [dbo].[ZnodeGlobalAttributeGroupMapper] aa
		INNER JOIN @TBL_GlobalAttributeGrouplist ss on ss.GlobalAttributeGroupId=aa.GlobalAttributeGroupId
			
		IF object_id('tempdb..[#GlobalAttributeGrouplist]') IS NOT NULL
			drop table tempdb..#GlobalAttributeGrouplist

		CREATE TABLE #GlobalAttributeGrouplist 
		( 
			CMSContainerProfileVariantId INT,LocaleId	int,GlobalAttributeGroupId	int	,GroupCode	varchar	(200),AttributeGroupName nvarchar(600),AttributeGroupDisplayOrder int,
			GlobalAttributeId	int	,AttributeDisplayOrder	int	,AttributeCode	nvarchar	(600),AttributeName	nvarchar	(600),IsRequired	bit	,
			AttributeTypeName	varchar	(300),AttributeTypeId	int	,SingleAttributeValue	nvarchar(max),SelectValues	nvarchar(max)
		)

		SET @LocaleId = 0 

		INSERT INTO @TBL_Locale (LocaleId) 
		SELECT LocaleId FROM ZnodeLocale WHERE IsActive =1 AND (LocaleId  = @LocaleId OR @LocaleId = 0 )

		SET @MaxCount = ISNULL((SELECT MAx(RowId) FROM @TBL_Locale),0)
		WHILE @IncrementalId <= @MaxCount
		BEGIN 
			SET @SetLocaleId = (SELECT Top 1 LocaleId FROM @TBL_locale WHERE RowId = @IncrementalId)
			;With Cte_GetCmsContentContainerData AS 
			(
			Select distinct @SetLocaleId AS LocaleId, sv.CMSContainerProfileVariantId,
				aa.[GlobalAttributeGroupId] AS 'GlobalAttributeGroupId' ,
				zgag.GroupCode	AS 'GroupCode'		 ,  
				zgagl.AttributeGroupName  AS 'AttributeGroupName'   ,
				AttributeGroupDisplayOrder 	 , 
				ss.GlobalAttributeId	 AS 'GlobalAttributeId'	 ,
				ss.[AttributeDisplayOrder] AS 'AttributeDisplayOrder'	,
				zga.AttributeCode AS 'AttributeCode'	,			
				zgal.AttributeName AS 'AttributeName'	,
				zga.IsRequired AS 'IsRequired'	,
				zga.AttributeTypeName AS 'AttributeTypeName'      ,
				zga.AttributeTypeId AS 'AttributeTypeId' 		,
				sv.SingleAttributeValue AS 'SingleAttributeValue'	,	
	   
				( Select 
				SelectValuesEntity.DisplayOrder					as DisplayOrder,
				SelectValuesEntity.GlobalAttributeDefaultValueId as GlobalAttributeDefaultValueId,
				SelectValuesEntity.AttributeValue				as [Value]	,
				SelectValuesEntity.AttributeDefaultValueCode		as Code	,
				SelectValuesEntity.SwatchText                    as SwatchText	,
				SelectValuesEntity.MediaPath		         		as [Path]	
				FROM  @EntityAttributeValueList SelectValuesEntity 
				WHERE SelectValuesEntity.WidgetGlobalAttributeValueId = sv.WidgetGlobalAttributeValueId
				and SelectValuesEntity.LocaleId = sv.LocaleId and 
				zga.GroupAttributeType ='Select'
				FOR JSON Auto, INCLUDE_NULL_VALUES    
				)  as 'SelectValues'
			FROM 
				@TBL_GlobalAttributeGrouplist aa				
				INNER JOIN @TBL_GlobalAttributelist ss on  ss.GlobalAttributeGroupId=aa.GlobalAttributeGroupId
				INNER JOIN ZnodeGlobalAttributeGroup zgag on zgag.[GlobalAttributeGroupId]=aa.[GlobalAttributeGroupId]
				INNER JOIN ZnodeGlobalAttributeGroupLocale zgagl on zgagl.GlobalAttributeGroupId=zgag.GlobalAttributeGroupId
				INNER JOIN View_ZnodeGlobalAttribute zga       on zga.[GlobalAttributeId]=ss.[GlobalAttributeId]
				INNER JOIN ZnodeGlobalAttributeLocale zgal on zga.[GlobalAttributeId]=zgal.[GlobalAttributeId]
				INNER JOIN @EntityAttributeValueList sv   on sv.[GlobalAttributeId]=ss.[GlobalAttributeId]
				WHERE zgagl.LocaleId= zgal.LocaleId and 
				(sv.LocaleId = @SetLocaleId)  
			)
	     	, Cte_GetFirstFilterData AS
			(
				SELECT CMSContainerProfileVariantId,LocaleId,GlobalAttributeGroupId,GroupCode,AttributeGroupName,AttributeGroupDisplayOrder,
						GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName,IsRequired,AttributeTypeName,
						AttributeTypeId,SingleAttributeValue,SelectValues
				FROM Cte_GetCmsContentContainerData 
				WHERE LocaleId = @SetLocaleId
			)
			, Cte_GetDefaultFilterData AS
			(
				SELECT CMSContainerProfileVariantId,LocaleId,GlobalAttributeGroupId,GroupCode,AttributeGroupName,AttributeGroupDisplayOrder,
						GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName,IsRequired,AttributeTypeName,
						AttributeTypeId,SingleAttributeValue,SelectValues
				FROM  Cte_GetFirstFilterData 
				UNION ALL 
				SELECT CMSContainerProfileVariantId,LocaleId,GlobalAttributeGroupId,GroupCode,AttributeGroupName,AttributeGroupDisplayOrder,
						GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName,IsRequired,AttributeTypeName,
						AttributeTypeId,SingleAttributeValue,SelectValues
				FROM Cte_GetCmsContentContainerData CTEC 
				WHERE LocaleId = @DefaultLocaleId 
				AND NOT EXISTS (SELECT TOP 1 1 FROM Cte_GetFirstFilterData CTEFD WHERE CTEFD.GlobalAttributeGroupId = CTEC.GlobalAttributeGroupId )
			)
			INSERT INTO #GlobalAttributeGrouplist 
			(
				CMSContainerProfileVariantId,LocaleId,GlobalAttributeGroupId,GroupCode,AttributeGroupName,AttributeGroupDisplayOrder,
				GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName,IsRequired,AttributeTypeName,
				AttributeTypeId,SingleAttributeValue,SelectValues
			)
			SELECT DISTINCT CMSContainerProfileVariantId,@SetLocaleId,GlobalAttributeGroupId,GroupCode,AttributeGroupName,AttributeGroupDisplayOrder,
					GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName,IsRequired,AttributeTypeName,
					AttributeTypeId,SingleAttributeValue,SelectValues
			FROM Cte_GetDefaultFilterData
						
				SET @IncrementalId = @IncrementalId +1 
		End 
		--select * into ##GlobalAttributeGrouplist from #GlobalAttributeGrouplist
	--select distinct CMSContainerProfileVariantId,GlobalAttributeGroupId,GroupCode,AttributeGroupName,AttributeGroupDisplayOrder,LocaleId 
	--into #GroupMaster from #GlobalAttributeGrouplist
	
	--If (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  ) 
	--Begin
	--    --Data inserted into flat table ZnodePublishWidgetSliderBannerEntity (Replica of MongoDB Collection )  

	--	Delete from ZnodePublishContentContainerVariantEntity WHERE  VersionId = @VersionId
	 		 

	--	INSERT INTO ZnodePublishPortalGlobalAttributeEntity
	--	(
	--		VersionId,PublishStartTime,PortalId,PortalName,LocaleId,GlobalAttributeGroups
	--	)
	  	
			--Select Distinct PV.CMSContainerProfileVariantId,PV.LocaleId,  (Select 
			--A.GlobalAttributeGroupId AS 'GlobalAttributeGroupId',
			--A.GroupCode AS 'GroupCode',
			--A.AttributeGroupName AS 'AttributeGroupName',
			--A.AttributeGroupDisplayOrder AS 'AttributeGroupDisplayOrder',
			--A.LocaleId AS 'LocaleId', 
			--(
			--	Select DISTINCT GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName ,IsRequired ,	
			--	AttributeTypeName,AttributeTypeId,SingleAttributeValue,SelectValues 
			--	from #GlobalAttributeGrouplist B WHERE A.GlobalAttributeGroupId = B.GlobalAttributeGroupId 
			--	AND A.LocaleId = B.LocaleId AND A.CMSContainerProfileVariantId = B.CMSContainerProfileVariantId
			--	For JSON Path 
			--) AS 'GlobalAttributes'
			--from #GlobalAttributeGrouplist A WHERE A.CMSContainerProfileVariantId = PV.CMSContainerProfileVariantId AND A.LocaleId = PV.LocaleId For Json Path) GlobalAttributes
			--FROM  #GlobalAttributeGrouplist  PV 

			SELECT DISTINCT A.CMSContainerProfileVariantId,A.LocaleId,  
			REPLACE((
				SELECT DISTINCT GlobalAttributeGroupId, GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName ,IsRequired ,	
				AttributeTypeName,AttributeTypeId,SingleAttributeValue As AttributeValue,SelectValues 
				FROM #GlobalAttributeGrouplist B
				WHERE A.GlobalAttributeGroupId = B.GlobalAttributeGroupId 
				AND A.LocaleId = B.LocaleId AND A.CMSContainerProfileVariantId = B.CMSContainerProfileVariantId
				--AND GlobalAttributeId=32 and A.GlobalAttributeGroupId=23
				For JSON Path 
			),'\','') AS 'GlobalAttributes'
			FROM #GlobalAttributeGrouplist  A
	--End
	---------------------------- End Preview 
	--If (@RevisionState like '%Production%' OR @RevisionState = 'None')
	--Begin
	--	-- Only production version id will process 
	--	Delete from ZnodePublishPortalGlobalAttributeEntity WHERE  VersionId in (Select ProductionVersionId from @Tbl_ProductionVersionId)
	--	AND PortalId = @PortalId
	 		 

	--	INSERT INTO ZnodePublishPortalGlobalAttributeEntity
	--	(
	--		VersionId,PublishStartTime,PortalId,PortalName,LocaleId,GlobalAttributeGroups
	--	)
			  	
	--		Select Distinct PV.ProductionVersionId, Getdate(),  @PortalId,@StoreName, PV.LocaleId, (Select 
	--		A.GlobalAttributeGroupId AS 'GlobalAttributeGroupId',
	--		A.GroupCode AS 'GroupCode',
	--		A.AttributeGroupName AS 'AttributeGroupName',
	--		A.AttributeGroupDisplayOrder AS 'AttributeGroupDisplayOrder',
	--		A.LocaleId AS 'LocaleId', 
	--		(
	--			Select GlobalAttributeId,AttributeDisplayOrder,AttributeCode,AttributeName ,IsRequired ,	
	--			AttributeTypeName,AttributeTypeId,SingleAttributeValue,SelectValues 
	--			from #GlobalAttributeGrouplist B WHERE A.GlobalAttributeGroupId = B.GlobalAttributeGroupId 
	--			AND A.LocaleId = B.LocaleId
	--			For JSON Path 
	--		) AS 'GlobalAttributes'
	--		from #GroupMaster A  WHERE A.LocaleId = PV.LocaleId  For Json Path) 
	--		FROM  @Tbl_ProductionVersionId  PV 

	--End

END TRY
BEGIN CATCH
	SELECT ERROR_MESSAGE(), ERROR_PROCEDURE();

END CATCH;
END;

GO

DECLARE @PublishStateId INT;
SELECT @PublishStateId=PublishStateId FROM ZnodePublishState WHERE PublishStateCode='DRAFT'

--ZnodeGlobalEntity
INSERT INTO ZnodeGlobalEntity (EntityName,IsActive,TableName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsFamilyUnique)
SELECT 'Content Containers',1,'ZnodeWidgetGlobalAttributeValue',2, GETDATE(), 2, GETDATE(), 0
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalEntity WHERE GlobalEntityId=(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers'))

--ZnodeGlobalAttributeFamily
INSERT [dbo].[ZnodeGlobalAttributeFamily] ([FamilyCode], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId]) 
SELECT N'HomepageMarketingContentBlock', 2, GETDATE(), 2, GETDATE(), 0,
	(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomepageMarketingContentBlock')

INSERT [dbo].[ZnodeGlobalAttributeFamily] ([FamilyCode], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId]) 
SELECT N'HomePageTicker', 2, GETDATE(), 2, GETDATE(), 0,
	(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageTicker')

INSERT [dbo].[ZnodeGlobalAttributeFamily] ([FamilyCode], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId]) 
SELECT N'HomePageAdSpace', 2, GETDATE(), 2, GETDATE(), 0,
	(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageAdSpace')

INSERT [dbo].[ZnodeGlobalAttributeFamily] ([FamilyCode], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId]) 
SELECT N'CartPageAdSpace', 2, GETDATE(), 2, GETDATE(), 0,
	(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='CartPageAdSpace')


--ZnodeGlobalAttributeFamilyLocale
INSERT [dbo].[ZnodeGlobalAttributeFamilyLocale] ([LocaleId], [GlobalAttributeFamilyId], [AttributeFamilyName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomepageMarketingContentBlock'),
N'HomePage Promo', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeFamilyLocale WHERE GlobalAttributeFamilyId=(SELECT GlobalAttributeFamilyId 
	FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomepageMarketingContentBlock'))

INSERT [dbo].[ZnodeGlobalAttributeFamilyLocale] ([LocaleId], [GlobalAttributeFamilyId], [AttributeFamilyName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageTicker'),
N'Home Page Ticker', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeFamilyLocale WHERE GlobalAttributeFamilyId=(SELECT GlobalAttributeFamilyId 
	FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageTicker'))

INSERT [dbo].[ZnodeGlobalAttributeFamilyLocale] ([LocaleId], [GlobalAttributeFamilyId], [AttributeFamilyName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageAdSpace'),
N'Home Page Ad Space', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeFamilyLocale WHERE GlobalAttributeFamilyId=(SELECT GlobalAttributeFamilyId 
	FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageAdSpace'))

INSERT [dbo].[ZnodeGlobalAttributeFamilyLocale] ([LocaleId], [GlobalAttributeFamilyId], [AttributeFamilyName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate])  
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='CartPageAdSpace'),
N'Cart Page Ad Space', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeFamilyLocale WHERE GlobalAttributeFamilyId=(SELECT GlobalAttributeFamilyId 
	FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='CartPageAdSpace'))


-- ZnodeCMSContentContainer
INSERT [dbo].[ZnodeCMSContentContainer] ([Name], [ContainerKey], [FamilyId], [Tags], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [PublishStateId]) 
SELECT N'Home Page Promo', N'HomePagePromo', 
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomepageMarketingContentBlock'), 
N'', 2, GETDATE(), 2, GETDATE(), @PublishStateId
WHERE NOT EXISTS (SELECT * FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')

INSERT [dbo].[ZnodeCMSContentContainer] ([Name], [ContainerKey], [FamilyId], [Tags], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [PublishStateId]) 
SELECT N'Home Page Ticker', N'HomePageTicker', 
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageTicker'), 
N'', 2, GETDATE(), 2, GETDATE(), @PublishStateId
WHERE NOT EXISTS (SELECT * FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePageTicker')

INSERT [dbo].[ZnodeCMSContentContainer] ([Name], [ContainerKey], [FamilyId], [Tags], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [PublishStateId]) 
SELECT N'Home Page Ad Space', N'AdSpace', 
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageAdSpace'), 
NULL, 2, GETDATE(), 2, GETDATE(), @PublishStateId
WHERE NOT EXISTS (SELECT * FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')

INSERT [dbo].[ZnodeCMSContentContainer] ([Name], [ContainerKey], [FamilyId], [Tags], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [PublishStateId]) 
SELECT N'Cart Page Ad Spaces', N'CartPageAdSpace', 
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='CartPageAdSpace'), 
NULL, 2, GETDATE(), 2, GETDATE(), @PublishStateId
WHERE NOT EXISTS (SELECT * FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')


--ZnodeCMSContainerProfileVariant
INSERT [dbo].[ZnodeCMSContainerProfileVariant] ([CMSContentContainerId], [ProfileId], [PortalId], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [PublishStateId]) 
SELECT (SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo'), 
NULL, NULL, 2, GETDATE(), 2, GETDATE(), @PublishStateId
WHERE EXISTS (SELECT * FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
AND NOT EXISTS (SELECT * FROM ZnodeCMSContainerProfileVariant WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)

INSERT [dbo].[ZnodeCMSContainerProfileVariant] ([CMSContentContainerId], [ProfileId], [PortalId], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [PublishStateId]) 
SELECT (SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePageTicker'), 
NULL, NULL, 2, GETDATE(), 2, GETDATE(), @PublishStateId
WHERE EXISTS (SELECT * FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePageTicker')
AND NOT EXISTS (SELECT * FROM ZnodeCMSContainerProfileVariant WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer 
	WHERE ContainerKey='HomePageTicker') AND ProfileId IS NULL AND PortalId IS NULL)

INSERT [dbo].[ZnodeCMSContainerProfileVariant] ([CMSContentContainerId], [ProfileId], [PortalId], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [PublishStateId]) 
SELECT (SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey IN ('AdSpace')), 
NULL, NULL, 2, GETDATE(), 2, GETDATE(), @PublishStateId
WHERE EXISTS (SELECT * FROM ZnodeCMSContentContainer WHERE ContainerKey IN ('AdSpace') )
AND NOT EXISTS (SELECT * FROM ZnodeCMSContainerProfileVariant WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer 
	WHERE ContainerKey IN ('AdSpace')) AND ProfileId IS NULL AND PortalId IS NULL)

INSERT [dbo].[ZnodeCMSContainerProfileVariant] ([CMSContentContainerId], [ProfileId], [PortalId], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [PublishStateId]) 
SELECT (SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey IN ('CartPageAdSpace')), 
NULL, NULL, 2, GETDATE(), 2, GETDATE(), @PublishStateId
WHERE EXISTS (SELECT * FROM ZnodeCMSContentContainer WHERE ContainerKey IN ('CartPageAdSpace') )
AND NOT EXISTS (SELECT * FROM ZnodeCMSContainerProfileVariant WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer 
	WHERE ContainerKey IN ('CartPageAdSpace')) AND ProfileId IS NULL AND PortalId IS NULL)


-- Update Publish Status
UPDATE ZnodeCMSContentContainer
SET PublishStateId=@PublishStateId
WHERE ContainerKey IN ('HomePagePromo','HomePageTicker','AdSpace','CartPageAdSpace')

UPDATE CPV
SET CPV.PublishStateId=@PublishStateId
FROM ZnodeCMSContainerProfileVariant CPV
INNER JOIN ZnodeCMSContentContainer CC ON CPV.CMSContentContainerId=CC.CMSContentContainerId
WHERE CC.ContainerKey IN ('HomePagePromo','HomePageTicker','AdSpace','CartPageAdSpace')


--ZnodeCMSContainerProfileVariantLocale
INSERT [dbo].[ZnodeCMSContainerProfileVariantLocale] ([CMSContainerProfileVariantId], [CMSContainerTemplateId], [LocaleId], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsActive]) 
SELECT 
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL),
NULL, 
1, 2, GETDATE(), 2, GETDATE(), 1
WHERE NOT EXISTS (SELECT * FROM ZnodeCMSContainerProfileVariantLocale WHERE CMSContainerProfileVariantId=(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL))

INSERT [dbo].[ZnodeCMSContainerProfileVariantLocale] ([CMSContainerProfileVariantId], [CMSContainerTemplateId], [LocaleId], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsActive]) 
SELECT 
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL),
NULL, 
1, 2, GETDATE(), 2, GETDATE(), 1
WHERE NOT EXISTS (SELECT * FROM ZnodeCMSContainerProfileVariantLocale WHERE CMSContainerProfileVariantId=(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL))

INSERT [dbo].[ZnodeCMSContainerProfileVariantLocale] ([CMSContainerProfileVariantId], [CMSContainerTemplateId], [LocaleId], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsActive]) 
SELECT 
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePageTicker') AND ProfileId IS NULL AND PortalId IS NULL),
NULL, 
1, 2, GETDATE(), 2, GETDATE(), 1
WHERE NOT EXISTS (SELECT * FROM ZnodeCMSContainerProfileVariantLocale WHERE CMSContainerProfileVariantId=(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePageTicker') AND ProfileId IS NULL AND PortalId IS NULL))

INSERT [dbo].[ZnodeCMSContainerProfileVariantLocale] ([CMSContainerProfileVariantId], [CMSContainerTemplateId], [LocaleId], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsActive]) 
SELECT 
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
NULL, 
1, 2, GETDATE(), 2, GETDATE(), 1
WHERE NOT EXISTS (SELECT * FROM ZnodeCMSContainerProfileVariantLocale WHERE CMSContainerProfileVariantId=(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL))

INSERT [dbo].[ZnodeCMSContainerProfileVariantLocale] ([CMSContainerProfileVariantId], [CMSContainerTemplateId], [LocaleId], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsActive]) 
SELECT 
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
NULL, 
1, 2, GETDATE(), 2, GETDATE(), 1
WHERE NOT EXISTS (SELECT * FROM ZnodeCMSContainerProfileVariantLocale WHERE CMSContainerProfileVariantId=(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL))



--ZnodeGlobalEntityFamilyMapper

INSERT INTO ZnodeGlobalEntityFamilyMapper (GlobalAttributeFamilyId,GlobalEntityId,GlobalEntityValueId)
SELECT 
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomepageMarketingContentBlock'),
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalEntityFamilyMapper
	WHERE GlobalAttributeFamilyId=(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomepageMarketingContentBlock')
	AND GlobalEntityId=(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
	AND GlobalEntityValueId=(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
)

INSERT INTO ZnodeGlobalEntityFamilyMapper (GlobalAttributeFamilyId,GlobalEntityId,GlobalEntityValueId)
SELECT 
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageTicker'),
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePageTicker') AND ProfileId IS NULL AND PortalId IS NULL)
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalEntityFamilyMapper
	WHERE GlobalAttributeFamilyId=(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageTicker')
	AND GlobalEntityId=(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
	AND GlobalEntityValueId=(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePageTicker') AND ProfileId IS NULL AND PortalId IS NULL)
)

INSERT INTO ZnodeGlobalEntityFamilyMapper (GlobalAttributeFamilyId,GlobalEntityId,GlobalEntityValueId)
SELECT 
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='CartPageAdSpace'),
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalEntityFamilyMapper
	WHERE GlobalAttributeFamilyId=(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='CartPageAdSpace')
	AND GlobalEntityId=(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
	AND GlobalEntityValueId=(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
)





INSERT INTO ZnodeGlobalEntityFamilyMapper (GlobalAttributeFamilyId,GlobalEntityId,GlobalEntityValueId)
SELECT 
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageAdSpace'),
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalEntityFamilyMapper
	WHERE GlobalAttributeFamilyId=(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageAdSpace')
	AND GlobalEntityId=(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
	AND GlobalEntityValueId=(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
)


--ZnodeMediaServerMaster
INSERT INTO ZnodeMediaServerMaster (ServerName,PartialViewName,IsOtherServer,ThumbnailFolderName,ClassName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 'Local','Local',0,'Thumbnail','LocalAgent',2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeMediaServerMaster WHERE MediaServerMasterId=(SELECT TOP 1 MediaServerMasterId FROM ZnodeMediaServerMaster WHERE PartialViewName='Local'))


-- ZnodeMedia
INSERT [dbo].[ZnodeMedia] ([MediaConfigurationId], [Path], [FileName], [Size], [Height], [Width], [Length], [Type], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [Version]) 
SELECT (SELECT TOP 1 MediaConfigurationId FROM ZnodeMediaConfiguration 
	WHERE MediaServerMasterId=(SELECT TOP 1 MediaServerMasterId FROM ZnodeMediaServerMaster WHERE PartialViewName='Local') AND IsActive=1),
N'42bff3d2-0dbf-4b6d-b1be-321537912ad03945ac03-7e20-488b-a690-028e7bea2325ad-dewalt-lawncare.jpg', N'3945ac03-7e20-488b-a690-028e7bea2325ad-dewalt-lawncare.jpg', N'239347', N'500       ', N'750       ', N'239347    ', N'.jpg', 2, GETDATE(), 2, GETDATE(), 0
WHERE NOT EXISTS (SELECT * FROM ZnodeMedia WHERE [FileName]='3945ac03-7e20-488b-a690-028e7bea2325ad-dewalt-lawncare.jpg')

INSERT [dbo].[ZnodeMedia] ([MediaConfigurationId], [Path], [FileName], [Size], [Height], [Width], [Length], [Type], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [Version]) 
SELECT (SELECT TOP 1 MediaConfigurationId FROM ZnodeMediaConfiguration
	WHERE MediaServerMasterId=(SELECT TOP 1 MediaServerMasterId FROM ZnodeMediaServerMaster WHERE PartialViewName='Local') AND IsActive=1),
N'847cd3a7-bcbd-4c94-b881-e67872a7fad93225d329-4e61-4158-bd65-5402a20dfc5bad-100off-tools.jpg', N'3225d329-4e61-4158-bd65-5402a20dfc5bad-100off-tools.jpg', N'107304', N'500       ', N'750       ', N'107304    ', N'.jpg', 2, GETDATE(), 2, GETDATE(), 0
WHERE NOT EXISTS (SELECT * FROM ZnodeMedia WHERE [FileName]='3225d329-4e61-4158-bd65-5402a20dfc5bad-100off-tools.jpg')

INSERT [dbo].[ZnodeMedia] ([MediaConfigurationId], [Path], [FileName], [Size], [Height], [Width], [Length], [Type], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [Version]) 
SELECT(SELECT TOP 1 MediaConfigurationId FROM ZnodeMediaConfiguration 
	WHERE MediaServerMasterId=(SELECT TOP 1 MediaServerMasterId FROM ZnodeMediaServerMaster WHERE PartialViewName='Local') AND IsActive=1),
N'fd3a3779-19c9-47a7-82db-5ec81554abc3d4e1e90e-b63b-421b-a4b1-607bfb644f0brouter-short.jpg', N'd4e1e90e-b63b-421b-a4b1-607bfb644f0brouter-short.jpg', N'81401', N'449       ', N'1400      ', N'81401     ', N'.jpg', 2, GETDATE(), 2, GETDATE(), 0
WHERE NOT EXISTS (SELECT * FROM ZnodeMedia WHERE [FileName]='d4e1e90e-b63b-421b-a4b1-607bfb644f0brouter-short.jpg')

INSERT [dbo].[ZnodeMedia] ([MediaConfigurationId], [Path], [FileName], [Size], [Height], [Width], [Length], [Type], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [Version]) 
SELECT (SELECT TOP 1 MediaConfigurationId FROM ZnodeMediaConfiguration 
	WHERE MediaServerMasterId=(SELECT TOP 1 MediaServerMasterId FROM ZnodeMediaServerMaster WHERE PartialViewName='Local') AND IsActive=1),
N'846b4bc5-a7db-4489-8305-7b07d4f6c45a9d640c1a-53d0-479a-b614-487ac5ca9d13router-small.jpg', N'9d640c1a-53d0-479a-b614-487ac5ca9d13router-small.jpg', N'52407', N'449       ', N'800       ', N'52407     ', N'.jpg', 2, GETDATE(), 2, GETDATE(), 1
WHERE NOT EXISTS (SELECT * FROM ZnodeMedia WHERE [FileName]='9d640c1a-53d0-479a-b614-487ac5ca9d13router-small.jpg')


--ZnodeGlobalAttributeGroup

INSERT [dbo].[ZnodeGlobalAttributeGroup] ([GroupCode], [DisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId]) 
SELECT N'HomepageMarketingContentBlock', NULL, 2, GETDATE(), 2, GETDATE(), 0,
	(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomepageMarketingContentBlock')

INSERT [dbo].[ZnodeGlobalAttributeGroup] ([GroupCode], [DisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId]) 
SELECT N'DisplayOptions', NULL, 2, GETDATE(), 2, GETDATE(), 0,
	(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroup WHERE GroupCode='DisplayOptions')

INSERT [dbo].[ZnodeGlobalAttributeGroup] ([GroupCode], [DisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId]) 
SELECT N'HomePageTicker', NULL, 2, GETDATE(), 2, GETDATE(), 0,
	(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomePageTicker')

INSERT [dbo].[ZnodeGlobalAttributeGroup] ([GroupCode], [DisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId]) 
SELECT N'AdSpace', NULL, 2, GETDATE(), 2, GETDATE(), 0,
	(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace')

INSERT [dbo].[ZnodeGlobalAttributeGroup] ([GroupCode], [DisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId]) 
SELECT N'AdSpace2', NULL, 2, GETDATE(), 2, GETDATE(), 0,
	(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace2')

INSERT [dbo].[ZnodeGlobalAttributeGroup] ([GroupCode], [DisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId]) 
SELECT N'CartPageAdSpace1', NULL, 2, GETDATE(), 2, GETDATE(), 0,
	(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace1')

INSERT [dbo].[ZnodeGlobalAttributeGroup] ([GroupCode], [DisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId]) 
SELECT N'CartPageAdSpace2', NULL, 2, GETDATE(), 2, GETDATE(), 0,
	(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace2')

INSERT [dbo].[ZnodeGlobalAttributeGroup] ([GroupCode], [DisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId]) 
SELECT N'CartPageAdSpace', NULL, 2, GETDATE(), 2, GETDATE(), 0,
	(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace')









-- ZnodeGlobalAttributeGroupLocale

INSERT [dbo].[ZnodeGlobalAttributeGroupLocale] ([LocaleId], [GlobalAttributeGroupId], [AttributeGroupName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT
1, 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomepageMarketingContentBlock'),
N'Marketing Content Block', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupLocale WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomepageMarketingContentBlock'))

INSERT [dbo].[ZnodeGlobalAttributeGroupLocale] ([LocaleId], [GlobalAttributeGroupId], [AttributeGroupName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate])
SELECT
1, 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='DisplayOptions'),
N'Display Options', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupLocale WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='DisplayOptions'))

INSERT [dbo].[ZnodeGlobalAttributeGroupLocale] ([LocaleId], [GlobalAttributeGroupId], [AttributeGroupName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT
1, 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomePageTicker'),
N'Home Page Ticker', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupLocale WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomePageTicker'))

INSERT [dbo].[ZnodeGlobalAttributeGroupLocale] ([LocaleId], [GlobalAttributeGroupId], [AttributeGroupName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT
1, 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace'),
N'Ad Space', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupLocale WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace'))

INSERT [dbo].[ZnodeGlobalAttributeGroupLocale] ([LocaleId], [GlobalAttributeGroupId], [AttributeGroupName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT
1, 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace2'),
N'Ad Space2', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupLocale WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace2'))

INSERT [dbo].[ZnodeGlobalAttributeGroupLocale] ([LocaleId], [GlobalAttributeGroupId], [AttributeGroupName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT
1, 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace1'),
N'Cart Page Ad Space1', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupLocale WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace1'))

INSERT [dbo].[ZnodeGlobalAttributeGroupLocale] ([LocaleId], [GlobalAttributeGroupId], [AttributeGroupName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT
1, 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace2'),
N'Cart Page Ad Space2', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupLocale WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace2'))

INSERT [dbo].[ZnodeGlobalAttributeGroupLocale] ([LocaleId], [GlobalAttributeGroupId], [AttributeGroupName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT
1, 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace'),
N'Cart Page Ad Space', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupLocale WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace'))


--ZnodeGlobalFamilyGroupMapper
INSERT INTO ZnodeGlobalFamilyGroupMapper (GlobalAttributeFamilyId,GlobalAttributeGroupId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomepageMarketingContentBlock'),
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomepageMarketingContentBlock'),
999, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalFamilyGroupMapper WHERE GlobalAttributeFamilyId=
	(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomepageMarketingContentBlock')
	AND GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomepageMarketingContentBlock')
)

INSERT INTO ZnodeGlobalFamilyGroupMapper (GlobalAttributeFamilyId,GlobalAttributeGroupId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomepageMarketingContentBlock'),
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='DisplayOptions'),
999, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalFamilyGroupMapper WHERE GlobalAttributeFamilyId=
	(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomepageMarketingContentBlock')
	AND GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='DisplayOptions')
)

INSERT INTO ZnodeGlobalFamilyGroupMapper (GlobalAttributeFamilyId,GlobalAttributeGroupId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageTicker'),
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomePageTicker'),
999, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalFamilyGroupMapper WHERE GlobalAttributeFamilyId=
	(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageTicker')
	AND GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomePageTicker')
)

INSERT INTO ZnodeGlobalFamilyGroupMapper (GlobalAttributeFamilyId,GlobalAttributeGroupId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageAdSpace'),
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace'),
999, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalFamilyGroupMapper WHERE GlobalAttributeFamilyId=
	(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageAdSpace')
	AND GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace')
)

INSERT INTO ZnodeGlobalFamilyGroupMapper (GlobalAttributeFamilyId,GlobalAttributeGroupId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageAdSpace'),
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace2'),
999, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalFamilyGroupMapper WHERE GlobalAttributeFamilyId=
	(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageAdSpace')
	AND GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace2')
)

INSERT INTO ZnodeGlobalFamilyGroupMapper (GlobalAttributeFamilyId,GlobalAttributeGroupId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='CartPageAdSpace'),
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace1'),
999, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalFamilyGroupMapper WHERE GlobalAttributeFamilyId=
	(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='CartPageAdSpace')
	AND GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace1')
)

INSERT INTO ZnodeGlobalFamilyGroupMapper (GlobalAttributeFamilyId,GlobalAttributeGroupId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='CartPageAdSpace'),
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace2'),
999, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalFamilyGroupMapper WHERE GlobalAttributeFamilyId=
	(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='CartPageAdSpace')
	AND GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace2')
)

INSERT INTO ZnodeGlobalFamilyGroupMapper (GlobalAttributeFamilyId,GlobalAttributeGroupId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='CartPageAdSpace'),
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace'),
999, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalFamilyGroupMapper WHERE GlobalAttributeFamilyId=
	(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='CartPageAdSpace')
	AND GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace')
)





--ZnodeGlobalAttribute

INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId]) 
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'), 
N'PromoTitle1', 0, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoTitle1')

INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'),
N'PromoLargeImage', 0, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoLargeImage')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'),
N'PromoSmallImage', 0, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoSmallImage')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'),
N'PromoCTAText', 0,
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTAText')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'),
N'PromoCTALinkURL', 0, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTALinkURL')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'), 
N'HomePageTicker', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='HomePageTicker')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'), 
N'AdSpaceImage1', 0, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage1')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'),
N'TitleForImage1', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage1')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'),  
N'TextForImage1', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='TextForImage1')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'),
N'CTALinkURL1', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL1')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'), 
N'AdSpaceImage2', 0, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage2')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'), 
N'TitleForImage2', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage2')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'), 
N'TextorImage2', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='TextorImage2')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'),
N'CTALinkURL2', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL2')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'), 
N'CartPageTitle1', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle1')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'), 
N'CartPageText1', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText1')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'),
N'C2', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='C2')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'), 
N'CartPageTitle2', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle2')
																																																					  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'), 
N'CartPageText3', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText3')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'), 
N'CartPageTitle3', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle3')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'), 
N'CartPageText03', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText03')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'),
N'C3', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='C3')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'),
N'BackgroundColor', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='BackgroundColor')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'),
N'ContentAlignment', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='ContentAlignment')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'),
N'C1', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='C1')



--ZnodeGlobalAttributeLocale


INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='BackgroundColor'),
N'BackgroundColor', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='BackgroundColor'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='ContentAlignment'),
N'ContentAlignment', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='ContentAlignment'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle1'),
N'Title', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle1'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle2'),
N'Title', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle2'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle3'),
N'Title', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle3'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText3'),
N'Description', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText3'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText1'),
N'Description', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText1'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText03'),
N'Description', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText03'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C2'),
N'CTA Link URL', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C2'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C3'),
N'CTA Link URL', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C3'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C1'),
N'CTA Link URL', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C1'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage1'),
N'Ad Space Image 1', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage1'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage2'),
N'Ad Space Image 2', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage2'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage1'),
N'Title For Image 1', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage1'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage2'),
N'Title For Image 2', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage2'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextForImage1'),
N'Text For Image 1', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextForImage1'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextorImage2'),
N'Text For Image 2', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextorImage2'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL1'),
N'CTA Link URL 1', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL1'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL2'),
N'CTA Link URL 2', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL2'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoSmallImage'),
N'Promo Small Image', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoSmallImage'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoLargeImage'),
N'Promo Large Image', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoLargeImage'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTAText'),
N'Promo CTA Text', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTAText'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTALinkURL'),
N'Prom CTA Link URL', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTALinkURL'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='HomePageTicker'),
N'Home Page Ticker', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='HomePageTicker'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoTitle1'),
N'Promo Title', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoTitle1'))






--ZnodeGlobalAttributeGroupMapper

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomepageMarketingContentBlock'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoTitle1'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomepageMarketingContentBlock')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoTitle1'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomepageMarketingContentBlock'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoLargeImage'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomepageMarketingContentBlock')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoLargeImage'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomepageMarketingContentBlock'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoSmallImage'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomepageMarketingContentBlock')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoSmallImage'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomepageMarketingContentBlock'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTAText'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomepageMarketingContentBlock')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTAText'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomepageMarketingContentBlock'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTALinkURL'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomepageMarketingContentBlock')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTALinkURL'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomePageTicker'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='HomePageTicker'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomePageTicker')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='HomePageTicker'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage1'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage1'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage1'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage1'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextForImage1'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextForImage1'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL1'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL1'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace2'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage2'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace2')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage2'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace2'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage2'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace2')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage2'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace2'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextorImage2'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace2')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextorImage2'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace2'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL2'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace2')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL2'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace1'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle1'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace1')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle1'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace1'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText1'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace1')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText1'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace2'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C2'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace2')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C2'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace2'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle2'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace2')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle2'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace2'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText03'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace2')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText03'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText3'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText3'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle3'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle3'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C3'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C3'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='DisplayOptions'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='BackgroundColor'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='DisplayOptions')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='BackgroundColor'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='DisplayOptions'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='ContentAlignment'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='DisplayOptions')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='ContentAlignment'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace1'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C1'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace1')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C1'))


--ZnodeWidgetGlobalAttributeValue

INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoTitle1'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoTitle1'))


INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoLargeImage'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoLargeImage'))


INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoSmallImage'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoSmallImage'))


INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTAText'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTAText'))


INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTALinkURL'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTALinkURL'))


INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePageTicker'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePageTicker') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='HomePageTicker'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePageTicker')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePageTicker') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='HomePageTicker'))


INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage1'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePageTicker')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage1'))


INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage1'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePageTicker')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage1'))


INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextForImage1'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePageTicker')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextForImage1'))


INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL1'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePageTicker')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL1'))

INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage2'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePageTicker')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage2'))

INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage2'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePageTicker')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage2'))

INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextorImage2'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePageTicker')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextorImage2'))

INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL2'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePageTicker')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL2'))

INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle1'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle1'))


INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText1'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText1'))


INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C2'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C2'))

INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle2'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle2'))

INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText03'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText03'))

INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText3'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText3'))

INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle3'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle3'))

INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C3'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C3'))





INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='BackgroundColor'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='BackgroundColor'))


INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='ContentAlignment'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='ContentAlignment'))





INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C1'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C1'))


--ZnodeWidgetGlobalAttributeValueLocale

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoTitle1')
),
1, N'Getting the fine edges with <br />The Cordless Dewalt Router ZX-3000', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoTitle1')
	) AND LocaleId=1
)


INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTAText')
),
1, N'View Product', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTAText')
	) AND LocaleId=1
)



INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTALinkURL')
),
1, N'/mountain-plumbing-10-inch-traditional-round-rain-head', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTALinkURL')
	) AND LocaleId=1
)




INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoLargeImage')
),
1, NULL, 2, GETDATE(), 2, GETDATE(), NULL, 
(SELECT TOP 1 MediaId FROM ZnodeMedia WHERE [Path]='fd3a3779-19c9-47a7-82db-5ec81554abc3d4e1e90e-b63b-421b-a4b1-607bfb644f0brouter-short.jpg'),
N'fd3a3779-19c9-47a7-82db-5ec81554abc3d4e1e90e-b63b-421b-a4b1-607bfb644f0brouter-short.jpg'
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoLargeImage')
	AND MediaId=(SELECT TOP 1 MediaId FROM ZnodeMedia WHERE [Path]='fd3a3779-19c9-47a7-82db-5ec81554abc3d4e1e90e-b63b-421b-a4b1-607bfb644f0brouter-short.jpg')
	) AND LocaleId=1
)


INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoSmallImage')
),
1, NULL, 2, GETDATE(), 2, GETDATE(), NULL, 
(SELECT TOP 1 MediaId FROM ZnodeMedia WHERE [Path]='846b4bc5-a7db-4489-8305-7b07d4f6c45a9d640c1a-53d0-479a-b614-487ac5ca9d13router-small.jpg'),
N'846b4bc5-a7db-4489-8305-7b07d4f6c45a9d640c1a-53d0-479a-b614-487ac5ca9d13router-small.jpg'
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoSmallImage')
	AND MediaId=(SELECT TOP 1 MediaId FROM ZnodeMedia WHERE [Path]='846b4bc5-a7db-4489-8305-7b07d4f6c45a9d640c1a-53d0-479a-b614-487ac5ca9d13router-small.jpg')
	) AND LocaleId=1
)


INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePageTicker')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePageTicker') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='HomePageTicker')
),
1, N'Save 20% during the holidays! Enter Holidays2021 at checkout.', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePageTicker')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePageTicker') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='HomePageTicker')
	) AND LocaleId=1
)

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage1')
),
1, N'DeWalt Guaranteed Tough one', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage1')
	) AND LocaleId=1
)

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextForImage1')
),
1, N'Outdoor Power Equipment Designed to Handle the Most Demanding Yards', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextForImage1')
	) AND LocaleId=1
)

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL1')
),
1, N'#', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL1')
	) AND LocaleId=1
)

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage2')
),
1, N'Up To $100 OFF', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage2')
	) AND LocaleId=1
)

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextorImage2')
),
1, N'Select Tools + Free Delivery', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextorImage2')
	) AND LocaleId=1
)

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL2')
),
1, N'/cordless-woodworking', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL2')
	) AND LocaleId=1
)




INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage1')
),
1, NULL, 2, GETDATE(), 2, GETDATE(), NULL, 
(SELECT TOP 1 MediaId FROM ZnodeMedia WHERE [Path]=N'42bff3d2-0dbf-4b6d-b1be-321537912ad03945ac03-7e20-488b-a690-028e7bea2325ad-dewalt-lawncare.jpg'),
N'42bff3d2-0dbf-4b6d-b1be-321537912ad03945ac03-7e20-488b-a690-028e7bea2325ad-dewalt-lawncare.jpg'
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage1')
	AND MediaId=(SELECT TOP 1 MediaId FROM ZnodeMedia WHERE [Path]='42bff3d2-0dbf-4b6d-b1be-321537912ad03945ac03-7e20-488b-a690-028e7bea2325ad-dewalt-lawncare.jpg')
	) AND LocaleId=1
)

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage2')
),
1, NULL, 2, GETDATE(), 2, GETDATE(), NULL, 
(SELECT TOP 1 MediaId FROM ZnodeMedia WHERE [Path]=N'847cd3a7-bcbd-4c94-b881-e67872a7fad93225d329-4e61-4158-bd65-5402a20dfc5bad-100off-tools.jpg'),
N'847cd3a7-bcbd-4c94-b881-e67872a7fad93225d329-4e61-4158-bd65-5402a20dfc5bad-100off-tools.jpg'
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage2')
	AND MediaId=(SELECT TOP 1 MediaId FROM ZnodeMedia WHERE [Path]='847cd3a7-bcbd-4c94-b881-e67872a7fad93225d329-4e61-4158-bd65-5402a20dfc5bad-100off-tools.jpg')
	) AND LocaleId=1
)



INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle1')
),
1, N'Buy Online. Pick-up in store.', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle1')
	) AND LocaleId=1
)

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath]) 
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText1')
),
1, N'Pick-up in store in under 2 hours', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText1')
	) AND LocaleId=1
)

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath]) 
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C2')
),
1, N'Get up to $100 off!', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C2')
	) AND LocaleId=1
)

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle2')
),
1, N'Get a Maxwell''s Credit Card and receive $25 off your purchase of $25+', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle2')
	) AND LocaleId=1
)

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath]) 
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText03')
),
1, N'#', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText03')
	) AND LocaleId=1
)

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath]) 
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText3')
),
1, N'Parts Service Repair', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText3')
	) AND LocaleId=1
)

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath]) 
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle3')
),
1, N'Find a service pro near you', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle3')
	) AND LocaleId=1
)

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath]) 
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C3')
),
1, N'#', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C3')
	) AND LocaleId=1
)



INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath]) 
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='BackgroundColor')
),
1, N'grey', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='BackgroundColor')
	) AND LocaleId=1
)

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath]) 
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='ContentAlignment')
),
1, N'Vertical', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='ContentAlignment')
	) AND LocaleId=1
)



INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath]) 
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C1')
),
1, N'#', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C1')
	) AND LocaleId=1
)



--ZnodeGlobalAttributeValidation

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'BackgroundColor'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'BackgroundColor')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'BackgroundColor'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'BackgroundColor')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'BackgroundColor'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'BackgroundColor')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'BackgroundColor'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'BackgroundColor')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'ContentAlignment'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'ContentAlignment')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'ContentAlignment'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'ContentAlignment')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'ContentAlignment'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'ContentAlignment')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'ContentAlignment'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'ContentAlignment')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))


INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageTitle1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageTitle1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'ContentAlignment'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'WYSIWYGEnabledProperty' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'ContentAlignment')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'WYSIWYGEnabledProperty'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageTitle2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageTitle2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageTitle2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'WYSIWYGEnabledProperty' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageTitle2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'WYSIWYGEnabledProperty'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageTitle3'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageTitle3')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageTitle3'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'WYSIWYGEnabledProperty' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageTitle3')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'WYSIWYGEnabledProperty'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageText3'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageText3')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageText3'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'WYSIWYGEnabledProperty' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageText3')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'WYSIWYGEnabledProperty'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageText1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageText1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageText1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'WYSIWYGEnabledProperty' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageText1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'WYSIWYGEnabledProperty'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageText03'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageText03')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageText03'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'WYSIWYGEnabledProperty' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageText03')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'WYSIWYGEnabledProperty'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))


INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C3'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C3')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C3'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C3')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C3'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C3')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C3'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C3')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))



INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,NULL,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxFileSize' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,NULL,'20',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxFileSize'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'IsAllowMultiUpload'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'IsAllowMultiUpload'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,NULL,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxFileSize' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,NULL,'20',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxFileSize'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'IsAllowMultiUpload'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'IsAllowMultiUpload'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')))


INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TitleForImage1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TitleForImage1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TitleForImage1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'WYSIWYGEnabledProperty' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TitleForImage1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'WYSIWYGEnabledProperty'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TitleForImage2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TitleForImage2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TitleForImage2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'WYSIWYGEnabledProperty' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TitleForImage2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'WYSIWYGEnabledProperty'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TextForImage1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TextForImage1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TextForImage1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'WYSIWYGEnabledProperty' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TextForImage1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'WYSIWYGEnabledProperty'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TextorImage2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TextorImage2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TextorImage2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'WYSIWYGEnabledProperty' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TextorImage2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'WYSIWYGEnabledProperty'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))



INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))



INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoSmallImage'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,NULL,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoSmallImage')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoSmallImage'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxFileSize' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,NULL,'20',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoSmallImage')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxFileSize'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoSmallImage'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'IsAllowMultiUpload'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoSmallImage')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'IsAllowMultiUpload'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoLargeImage'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,NULL,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoLargeImage')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoLargeImage'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxFileSize' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,NULL,'20',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoLargeImage')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxFileSize'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoLargeImage'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'IsAllowMultiUpload'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoLargeImage')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'IsAllowMultiUpload'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')))



INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTAText'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTAText')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTAText'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTAText')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTAText'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTAText')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTAText'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTAText')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTALinkURL'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTALinkURL')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTALinkURL'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTALinkURL')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTALinkURL'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTALinkURL')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTALinkURL'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTALinkURL')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))




INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'HomePageTicker'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'HomePageTicker')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'HomePageTicker'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'WYSIWYGEnabledProperty' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'HomePageTicker')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'WYSIWYGEnabledProperty'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoTitle1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoTitle1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoTitle1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'WYSIWYGEnabledProperty' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoTitle1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'WYSIWYGEnabledProperty'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))


--ZnodeGlobalGroupEntityMapper
INSERT INTO ZnodeGlobalGroupEntityMapper(GlobalAttributeGroupId,GlobalEntityId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'HomepageMarketingContentBlock'),
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'),999, 2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalGroupEntityMapper WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'HomepageMarketingContentBlock')
      AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'))

INSERT INTO ZnodeGlobalGroupEntityMapper(GlobalAttributeGroupId,GlobalEntityId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'DisplayOptions'),
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'),999, 2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalGroupEntityMapper WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'DisplayOptions')
      AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'))

INSERT INTO ZnodeGlobalGroupEntityMapper(GlobalAttributeGroupId,GlobalEntityId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'HomePageTicker'),
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'),999, 2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalGroupEntityMapper WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'HomePageTicker')
      AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'))

INSERT INTO ZnodeGlobalGroupEntityMapper(GlobalAttributeGroupId,GlobalEntityId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'AdSpace'),
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'),999, 2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalGroupEntityMapper WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'AdSpace')
      AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'))

INSERT INTO ZnodeGlobalGroupEntityMapper(GlobalAttributeGroupId,GlobalEntityId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'AdSpace2'),
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'),999, 2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalGroupEntityMapper WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'AdSpace2')
      AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'))

INSERT INTO ZnodeGlobalGroupEntityMapper(GlobalAttributeGroupId,GlobalEntityId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'CartPageAdSpace1'),
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'),999, 2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalGroupEntityMapper WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'CartPageAdSpace1')
      AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'))

INSERT INTO ZnodeGlobalGroupEntityMapper(GlobalAttributeGroupId,GlobalEntityId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'CartPageAdSpace2'),
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'),999, 2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalGroupEntityMapper WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'CartPageAdSpace2')
      AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'))

INSERT INTO ZnodeGlobalGroupEntityMapper(GlobalAttributeGroupId,GlobalEntityId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'CartPageAdSpace'),
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'),999, 2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalGroupEntityMapper WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'CartPageAdSpace')
      AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'))

GO
IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishContainerGlobalAttributeValue')
	DROP PROC Znode_GetPublishContainerGlobalAttributeValue
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishContainerGlobalAttributeValue]
(
    @CMSContainerProfileVariantId   INT = 0,
	@LocaleCode VARCHAR(100) = ''
)
AS
BEGIN
	BEGIN TRY
		DECLARE @LocaleId INT
		SET @LocaleId = ISNULL(( SELECT TOP 1 LocaleId FROM ZnodeLocale WHERE Code = @LocaleCode),0)

		IF OBJECT_ID('tempdb..#ContainerVariantEntity') IS NOT NULL
			DROP TABLE #ContainerVariantEntity;

		SELECT DISTINCT ZPCCVE.CMSContainerProfileVariantId,ZPCCVE.Name as ContentContainerName ,ZPCCVE.ContainerKey, 
			REPLACE(REPLACE(ZPCCVE.GlobalAttributes,'[',''),']','') AS GlobalAttributes, ZCCT.Name AS ContainerTemplateName
		INTO #ContainerVariantEntity
		FROM ZnodePublishContentContainerVariantEntity ZPCCVE
		LEFT JOIN ZnodeCMSContainerTemplate ZCCT ON ISNULL(ZPCCVE.CMSContainerTemplateId,0) = ZCCT.CMSContainerTemplateId
		WHERE ZPCCVE.CMSContainerProfileVariantId = @CMSContainerProfileVariantId AND (ISNULL(ZPCCVE.LocaleId,0) = @LocaleId OR ISNULL(@LocaleId,0) = 0)

		--SELECT t.CMSContainerProfileVariantId,t.ContentContainerName,t.ContainerKey,
		--	'['+STRING_AGG( t.GlobalAttributes,',') WITHIN GROUP (ORDER BY ContainerKey)+']'
		--	,t.ContainerTemplateName
		--FROM #ContainerVariantEntity t
		--GROUP BY t.CMSContainerProfileVariantId,t.ContentContainerName,t.ContainerKey,t.ContainerTemplateName;

		SELECT DISTINCT t2.CMSContainerProfileVariantId,t2.ContentContainerName,t2.ContainerKey,
			'['+STUFF((
			SELECT DISTINCT ',' + t1.GlobalAttributes
			FROM #ContainerVariantEntity t1
			WHERE t1.CMSContainerProfileVariantId=t2.CMSContainerProfileVariantId AND t1.ContentContainerName=t2.ContentContainerName
				AND t1.ContainerKey=t2.ContainerKey
			FOR XML PATH('')
			), 1, 1, '')+']' As GlobalAttributes
			, t2.ContainerTemplateName
		FROM #ContainerVariantEntity t2

		--SELECT ZPCCVE.Name as ContentContainerName ,ZPCCVE.ContainerKey, ZPCCVE.GlobalAttributes, ZCCT.Name AS ContainerTemplateName
		--FROM ZnodePublishContentContainerVariantEntity ZPCCVE
		--LEFT JOIN ZnodeCMSContainerTemplate ZCCT ON ISNULL(ZPCCVE.CMSContainerTemplateId,0) = ZCCT.CMSContainerTemplateId
		--WHERE ZPCCVE.CMSContainerProfileVariantId = @CMSContainerProfileVariantId AND (ISNULL(ZPCCVE.LocaleId,0) = @LocaleId OR ISNULL(@LocaleId,0) = 0)

		--SELECT 1 AS ID,CAST(1 AS BIT) AS Status;       
	END TRY
	BEGIN CATCH
		SELECT ERROR_MESSAGE()
		DECLARE @Status BIT ;
		SET @Status = 0;

		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(),
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishContainerGlobalAttributeValue 					
					@CMSContainerProfileVariantId='+CAST(@CMSContainerProfileVariantId AS VARCHAR(10))
					+''',@LocaleCode='+ISNULL(@LocaleCode,'''')
					
		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_GetPublishContainerGlobalAttributeValue',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_SetPublishContainerEntity')
	DROP PROC Znode_SetPublishContainerEntity
GO

CREATE PROCEDURE [dbo].[Znode_SetPublishContainerEntity]
(
	 @PreviewVersionId INT = 0
	,@IsPreviewEnable INT = 0
	,@ProductionVersionId INT = 0
	,@RevisionState VARCHAR(50) = 'PRODUCTION'
	,@ContainerKey NVARCHAR(50) = ''
	,@UserId INT = 0
	,@Status INT = 0 OUTPUT
)
AS
/*

	This Procedure is used to publish the Content Container and its varients publish

	EXEC  [Znode_SetPublishContainerEntity] @VersionId = 0,@PreviewVersionId=0,@IsPreviewEnable=1,@ProductionVersionId=0,
		@RevisionState='Preview',@ContainerKey='DiwaliOffer11',@UserId=2,@Status=0

				EXEC  [Znode_SetPublishContainerEntity] @PreviewVersionId=0,@IsPreviewEnable=1,@ProductionVersionId=0,
		@RevisionState='Preview',@ContainerKey='',@UserId=2,@Status=0

		EXEC  [Znode_SetPublishContainerEntity] @VersionId = 0,@PreviewVersionId=0,@IsPreviewEnable=0,@ProductionVersionId=0,
		@RevisionState='Production',@ContainerKey='',@UserId=2,@Status=0

*/
BEGIN 
BEGIN TRY 
SET NOCOUNT ON
BEGIN TRAN ContentContainer

	DECLARE @OldPreviewId INT, @OldProductionId INT
	IF @PreviewVersionId = 0 AND @ContainerKey = '' AND @RevisionState = 'PREVIEW'
	BEGIN
		SET @OldPreviewId = ( SELECT TOP 1 VersionId FROM ZnodePublishContetContainerVersionEntity WHERE PublishState ='PREVIEW')
			
		INSERT INTO ZnodePublishContetContainerVersionEntity(PublishStartTime,PublishState)
		SELECT GETDATE(),'PREVIEW'
		SET @PreviewVersionId = @@IDENTITY

		DELETE FROM ZnodePublishContetContainerVersionEntity WHERE VersionId = @OldPreviewId 
	END
	ELSE IF @RevisionState = 'PREVIEW'
	BEGIN
		INSERT INTO ZnodePublishContetContainerVersionEntity(PublishStartTime,PublishState)
		SELECT GETDATE(),'PREVIEW'
		WHERE NOT EXISTS (SELECT * FROM ZnodePublishContetContainerVersionEntity WHERE PublishState <> 'PREVIEW')
		
		SET @PreviewVersionId = ( SELECT TOP 1 VersionId FROM ZnodePublishContetContainerVersionEntity WHERE PublishState ='PREVIEW')
	END
			
	IF @ProductionVersionId = 0 AND @ContainerKey = '' AND @RevisionState = 'PRODUCTION'
 	BEGIN
		SET @OldProductionId = ( SELECT TOP 1 VersionId FROM ZnodePublishContetContainerVersionEntity WHERE PublishState ='PRODUCTION')
			
		INSERT INTO ZnodePublishContetContainerVersionEntity(PublishStartTime,PublishState)
		SELECT GETDATE(),'PRODUCTION'
		SET @ProductionVersionId = @@IDENTITY

		DELETE FROM ZnodePublishContetContainerVersionEntity WHERE VersionId = @OldProductionId 
	END 
	ELSE IF @RevisionState = 'PRODUCTION'
	BEGIN
		INSERT INTO ZnodePublishContetContainerVersionEntity(PublishStartTime,PublishState)
		SELECT GETDATE(),'PRODUCTION'
		WHERE NOT EXISTS (SELECT * FROM ZnodePublishContetContainerVersionEntity WHERE PublishState <> 'PRODUCTION')

		SET @ProductionVersionId = ( SELECT TOP 1 VersionId FROM ZnodePublishContetContainerVersionEntity WHERE PublishState ='PRODUCTION')
	END

	
	DECLARE @TBL_ContentContainerEntity TABLE
	(
		CMSContentContainerId INT, Name NVARCHAR(100), ContainerKey NVARCHAR(50),	FamilyId INT, Tags NVARCHAR(1000),
		CreatedBy INT, CreatedDate DATETIME, ModifiedBy INT,	ModifiedDate DATETIME
	);

	INSERT INTO @TBL_ContentContainerEntity(CMSContentContainerId, Name, ContainerKey, FamilyId, Tags, CreatedDate, ModifiedDate)
	SELECT DISTINCT ZCW.CMSContentContainerId, ZCW.Name, ZCW.ContainerKey, ZCW.FamilyId, ZCW.Tags,
		GETDATE(), GETDATE()
	FROM ZnodeCMSContentContainer ZCW WITH (NOLOCK)
	WHERE ( ZCW.ContainerKey = @ContainerKey OR ISNULL(@ContainerKey,'') = '' )

	IF (@RevisionState LIKE '%Preview%') 
	BEGIN
		--Data inserted INTO flat table ZnodePublishContentContainerEntity 
		DELETE FROM ZnodePublishContentContainerEntity WHERE VersionId = @PreviewVersionId
		AND EXISTS(SELECT * FROM @TBL_ContentContainerEntity cc WHERE ZnodePublishContentContainerEntity.ContainerKey = CC.ContainerKey)

		INSERT INTO ZnodePublishContentContainerEntity
		(
			VersionId,Name,ContainerKey,FamilyId,Tags,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		)
		SELECT @PreviewVersionId,Name, ContainerKey, FamilyId, Tags, @UserId, CreatedDate, @UserId, ModifiedDate
		FROM @TBL_ContentContainerEntity A

		DELETE FROM ZnodePublishContentContainerEntity WHERE VersionId = @OldPreviewId

	END
	---------------------------- END Preview 
	IF (@RevisionState LIKE '%Production%' OR @RevisionState = 'None')
	BEGIN

		-- Only production version id will process 
		DELETE FROM ZnodePublishContentContainerEntity WHERE VersionId = @ProductionVersionId
		AND EXISTS(SELECT * FROM @TBL_ContentContainerEntity cc WHERE ZnodePublishContentContainerEntity.ContainerKey = CC.ContainerKey)
		
		INSERT INTO ZnodePublishContentContainerEntity
		(
			VersionId,Name,ContainerKey,FamilyId,Tags,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		)
		SELECT @ProductionVersionId,Name, ContainerKey, FamilyId, Tags, @UserId, CreatedDate, @UserId, ModifiedDate
		FROM @TBL_ContentContainerEntity A
				
		DELETE FROM ZnodePublishContentContainerEntity WHERE VersionId = @OldProductionId
	END

	-- Content container varient publish
	EXEC [Znode_PublishContentContainerVariantEntity] @ContainerKey = @ContainerKey,@RevisionState=@RevisionState, @UserId = @UserId,@OldPreviewId=@OldPreviewId,@OldProductionId=@OldProductionId,@Status = 0
	
	SET @Status =1 ;
	IF (@RevisionState = 'Preview')
		UPDATE B SET PublishStateId = (SELECT dbo.Fn_GetPublishStateIdForPreview()) --, ISPublish = 1 
		FROM @TBL_ContentContainerEntity A
		INNER JOIN ZnodeCMSContentContainer B ON A.CMSContentContainerId = B.CMSContentContainerId
				
	ELSE IF (@RevisionState = 'Production' Or @RevisionState = 'None' )
		UPDATE B SET PublishStateId = (SELECT dbo.Fn_GetPublishStateIdForPublish()) --, ISPublish = 1 
		FROM @TBL_ContentContainerEntity A
		INNER JOIN ZnodeCMSContentContainer B ON A.CMSContentContainerId = B.CMSContentContainerId
	
COMMIT TRAN ContentContainer
SELECT 1 ID, @Status Status;
END TRY 
BEGIN CATCH
	SET @Status =0
	ROLLBACK TRAN ContentContainer
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
	@ErrorLine VARCHAR(100)= ERROR_LINE(),
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_SetPublishContainerEntity
	@PreviewVersionId = ' + CAST(@PreviewVersionId AS VARCHAR(20))
	+',@IsPreviewEnable='+CAST(@IsPreviewEnable AS VARCHAR(10))
	+',@ProductionVersionId = ' + CAST(@ProductionVersionId AS VARCHAR(20))
	+',@RevisionState = ''' + CAST(@RevisionState AS VARCHAR(50))
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20))
	+',@Status='+CAST(@Status AS VARCHAR(10));
	SELECT 0 AS ID,CAST(@Status AS BIT) AS Status;

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_SetPublishContainerEntity',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetERPTaskSchedulerDetail')
	DROP PROC Znode_GetERPTaskSchedulerDetail
GO

CREATE PROCEDURE [dbo].[Znode_GetERPTaskSchedulerDetail]
( @ERPTaskSchedulerId INT)
AS
  /*
    
    Summary:  List of erp task scheduler details by ERPTaskSchedulerId    		              
    Unit Testing         	
       EXEC Znode_GetERPTaskSchedulerDetail 1   
   */ 
	 BEGIN
         BEGIN TRY
             SET NOCOUNT ON;
             SELECT ERPTaskSchedulerId, 
					ISNULL(ERPConfiguratorId, 0) ERPConfiguratorId,
					SchedulerName, 
					SchedulerType,
					TouchPointName,
					SchedulerFrequency,
					CASE WHEN ISNULL(StartDate,'1900-01-01 00:00:00.000')='1900-01-01 00:00:00.000' THEN null ELSE StartDate END AS StartDate,
					ZETS.CreatedBy,
					ZETS.CreatedDate,
					ZETS.ModifiedBy,
					ZETS.ModifiedDate,
					ZETS.IsEnabled,
					SchedulerCallFor,
					CronExpression,
					HangfireJobId
             FROM ZnodeERPTaskScheduler AS ZETS
             WHERE ZETS.ERPTaskSchedulerId = @ERPTaskSchedulerId;
         END TRY
         BEGIN CATCH
               DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetERPTaskSchedulerDetail @ERPTaskSchedulerId = '+CAST(@ERPTaskSchedulerId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		    
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetERPTaskSchedulerDetail',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemQuantityWrapper')
	DROP PROC Znode_InsertUpdateSaveCartLineItemQuantityWrapper
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemQuantityWrapper]
(
	@CartLineItemXML xml, 
	@UserId int,
	@PortalId Int,
	@OmsCookieMappingId INT = 0 
)
AS 
   /* 
    Summary: THis Procedure is USed to save and edit the saved cart line item      
    Unit Testing 
	begin tran  
    Exec Znode_InsertUpdateSaveCartLineItem @CartLineItemXML= '<ArrayOfSavedCartLineItemModel>
  <SavedCartLineItemModel>
    <OmsSavedCartLineItemId>0</OmsSavedCartLineItemId>
    <ParentOmsSavedCartLineItemId>0</ParentOmsSavedCartLineItemId>
    <OmsSavedCartId>1259</OmsSavedCartId>
    <SKU>BlueGreenYellow</SKU>
    <Quantity>1.000000</Quantity>
    <OrderLineItemRelationshipTypeId>0</OrderLineItemRelationshipTypeId>
    <Sequence>1</Sequence>
    <AddonProducts>YELLOW</AddonProducts>
    <BundleProducts />
    <ConfigurableProducts>GREEN</ConfigurableProducts>
  </SavedCartLineItemModel>
  <SavedCartLineItemModel>
    <OmsSavedCartLineItemId>0</OmsSavedCartLineItemId>
    <ParentOmsSavedCartLineItemId>0</ParentOmsSavedCartLineItemId>
    <OmsSavedCartId>1259</OmsSavedCartId>
    <SKU>ap1534</SKU>
    <Quantity>1.0</Quantity>
    <OrderLineItemRelationshipTypeId>0</OrderLineItemRelationshipTypeId>
    <Sequence>2</Sequence>
    <AddonProducts >PINK</AddonProducts>
    <BundleProducts />
    <ConfigurableProducts />
    <PersonaliseValuesList>Address~Hello</PersonaliseValuesList>
  </SavedCartLineItemModel>
</ArrayOfSavedCartLineItemModel>' , @UserId=1 ,@Status=0
	rollback tran
*/
BEGIN
BEGIN TRAN InsertUpdateSaveCartLineItem;
BEGIN TRY
SET NOCOUNT ON;
	--Declared the variables
	DECLARE @GetDate datetime= dbo.Fn_GetDate();
	DECLARE @AddOnQuantity numeric(28, 6)= 0;
	DECLARE @IsAddProduct   BIT = 0 
	DECLARE @OmsSavedCartLineItemId INT = 0
	
	DECLARE @TBL_SavecartLineitems TABLE
	( 
		RowId int IDENTITY(1,1), OmsSavedCartLineItemId int, ParentOmsSavedCartLineItemId int, OmsSavedCartId int, SKU nvarchar(600), Quantity numeric(28, 6), OrderLineItemRelationshipTypeID int, CustomText nvarchar(max), 
		CartAddOnDetails nvarchar(max), Sequence int, AddOnValueIds varchar(max), BundleProductIds varchar(max), ConfigurableProductIds varchar(max), GroupProductIds varchar(max), PersonalisedAttribute XML, 
		AutoAddon varchar(max), OmsOrderId int, ItemDetails nvarchar(max),
		Custom1	nvarchar(max),Custom2 nvarchar(max),Custom3 nvarchar(max),Custom4
		nvarchar(max),Custom5 nvarchar(max),GroupId NVARCHAR(max) ,ProductName Nvarchar(1000) , Description NVARCHAR(max),AddOnQuantity NVARCHAR(max)
	);

	--Set the OrderLineItemRelationshipTypeId for Addons product
	DECLARE @OrderLineItemRelationshipTypeIdAddon int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'AddOns'
	);
	--Set the OrderLineItemRelationshipTypeId for simple product
	DECLARE @OrderLineItemRelationshipTypeIdSimple int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Simple'
	);
	--Set the OrderLineItemRelationshipTypeId for group product
	DECLARE @OrderLineItemRelationshipTypeIdGroup int=
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Group'
	);
	--Set the OrderLineItemRelationshipTypeId for Configurable product
	DECLARE @OrderLineItemRelationshipTypeIdConfigurable int=
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Configurable'
	);
	--Set the OrderLineItemRelationshipTypeId for Bundles product	
	DECLARE @OrderLineItemRelationshipTypeIdBundle int=
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Bundles'
	);

	-----Getting OmsSaveCartId FROM @OmsCookieMappingId
	DECLARE @OmsSavedCartId int
	--Getting OmsCookieMappingId on basis of @UserId and portalid if @UserId > 0 (Not a guest User)
	IF isnull(@OmsCookieMappingId,0)=0 and isnull(@UserId,0) <> 0  
	Begin
		SET @OmsCookieMappingId = (SELECT top 1 OmsCookieMappingId FROM ZnodeOmsCookieMapping with (nolock) where isnull(UserId,0) = @UserID AND isnull(PortalId,0) = @PortalId)
	END

	IF Not Exists(SELECT top 1 OmsCookieMappingId FROM ZnodeOmsCookieMapping with (nolock) Where OmsCookieMappingId = @OmsCookieMappingId)
	Begin
		INSERT INTO ZnodeOmsCookieMapping (UserId,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT case when @UserId = 0 then null else @UserId end ,@PortalId,@UserId,@GetDate,@UserId,@GetDate

		SET @OmsCookieMappingId = @@IDENTITY
	End
	----To get the oms savecartid on basis of @OmsCookieMappingId 
	SET @OmsSavedCartId = (SELECT top 1 OmsSavedCartId FROM ZnodeOmsSavedCart with (nolock) where OmsCookieMappingId = @OmsCookieMappingId)
	
	----If omssavecartid not present in ZnodeOmsSavedCart table then inserting new record to generated omssavecartid 
	IF isnull(@OmsSavedCartId,0) = 0
	BEGIN
		INSERT INTO ZnodeOmsSavedCart(OmsCookieMappingId,SalesTax,RecurringSalesTax,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT @OmsCookieMappingId,Null,Null,@UserId,@GetDate,@UserId,@GetDate

		SET @OmsSavedCartId = @@IDENTITY
	END

	--Fetching data FROM xml to table format and inserted into table @TBL_SavecartLineitems
	INSERT INTO @TBL_SavecartLineitems( OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU, Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence, AddOnValueIds, BundleProductIds, ConfigurableProductIds, GroupProductIds, PersonalisedAttribute, AutoAddon, OmsOrderId, ItemDetails,
	Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,Description,AddOnQuantity )
	SELECT Tbl.Col.value( 'OmsSavedCartLineItemId[1]', 'NVARCHAR(2000)' ) AS OmsSavedCartLineItemId, Tbl.Col.value( 'ParentOmsSavedCartLineItemId[1]', 'NVARCHAR(2000)' ) AS ParentOmsSavedCartLineItemId, @OmsSavedCartId AS OmsSavedCartId, Tbl.Col.value( 'SKU[1]', 'NVARCHAR(2000)' ) AS SKU, Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(2000)' ) AS Quantity
	, Tbl.Col.value( 'OrderLineItemRelationshipTypeID[1]', 'NVARCHAR(2000)' ) AS OrderLineItemRelationshipTypeID, Tbl.Col.value( 'CustomText[1]', 'NVARCHAR(2000)' ) AS CustomText, Tbl.Col.value( 'CartAddOnDetails[1]', 'NVARCHAR(2000)' ) AS CartAddOnDetails, Tbl.Col.value( 'Sequence[1]', 'NVARCHAR(2000)' ) AS Sequence, Tbl.Col.value( 'AddonProducts[1]', 'NVARCHAR(2000)' ) AS AddOnValueIds, ISNULL(Tbl.Col.value( 'BundleProducts[1]', 'NVARCHAR(2000)' ),'') AS BundleProductIds, ISNULL(Tbl.Col.value( 'ConfigurableProducts[1]', 'NVARCHAR(2000)' ),'') AS ConfigurableProductIds, ISNULL(Tbl.Col.value( 'GroupProducts[1]', 'NVARCHAR(Max)' ),'') AS GroupProductIds, 
			Tbl.Col.query('(PersonaliseValuesDetail/node())') AS PersonaliseValuesDetail, Tbl.Col.value( 'AutoAddon[1]', 'NVARCHAR(Max)' ) AS AutoAddon, Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(Max)' ) AS OmsOrderId,
			Tbl.Col.value( 'ItemDetails[1]', 'NVARCHAR(Max)' ) AS ItemDetails,
			Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
			Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
			Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
			Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
			Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
			Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
			Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(Max)' ) AS ProductName,
			Tbl.Col.value( 'Description[1]', 'NVARCHAR(Max)' ) AS Description, 
			Tbl.Col.value( 'AddOnQuantity[1]', 'NVARCHAR(2000)' ) AS AddOnQuantity
	FROM @CartLineItemXML.nodes( '//ArrayOfSavedCartLineItemModel/SavedCartLineItemModel' ) AS Tbl(Col);
			  
	IF OBJECT_ID('tempdb..#TBL_SavecartLineitems') is not null
		DROP TABLE #TBL_SavecartLineitems

	IF OBJECT_ID('tempdb..#OldValueForAddon') is not null
		DROP TABLE #OldValueForAddon

	SELECT * INTO #TBL_SavecartLineitems FROM @TBL_SavecartLineitems
			
	UPDATE ZnodeOmsSavedCart
	SET ModifiedDate = GETDATE()
	WHERE OmsSavedCartId = (SELECT TOP 1  OmsSavedCartId FROM @TBL_SavecartLineitems)

	UPDATE  @TBL_SavecartLineitems
	SET 	Description = ISNUll(Description,'') 

	--Save cart execution code for bundle product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' )
	BEGIN 				
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
		BEGIN 
			SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0 )

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0)
			, ModifiedDate = @GetDate
			WHERE ( OmsSavedCartLineItemId = @OmsSavedCartLineItemId  
			OR ParentOmsSavedCartLineItemId =  @OmsSavedCartLineItemId   ) 

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
			FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
			INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
			WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
			AND SCLI.BundleProductIds <> ''

			--After update the existing cart with new save cart then deleting those records which are updated
			DELETE	FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0
		END 

		--Getting bundle save cart line item entries into table to pass for bundle prodcut sp
		DECLARE @TBL_bundleProduct TT_SavecartLineitems 
		INSERT INTO @TBL_bundleProduct 
		SELECT *  
		FROM @TBL_SavecartLineitems 
		WHERE ISNULL(BundleProductIds,'') <> '' 
				
		EXEC Znode_InsertUpdateSaveCartLineItemBundle @TBL_bundleProduct,@userId,@OrderLineItemRelationshipTypeIdBundle,@OrderLineItemRelationshipTypeIdAddon
				 
		DELETE FROM  @TBL_SavecartLineitems WHERE ISNULL(BundleProductIds,'') <> '' 
		SET @OmsSavedCartLineItemId = 0 
	END 
	--Save cart execution code for configurable product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' )
	BEGIN 				
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
		BEGIN 

			SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0 )
				 
			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
			, ModifiedDate = @GetDate
			WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
			FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
			INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
			WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
			AND SCLI.ConfigurableProductIds <> ''

			--After update the existing cart with new save cart then deleting those records which are updated
			DELETE	FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0
		END 
		--Getting bundle save cart line item entries into table to pass for configurable prodcut sp
		DECLARE @TBL_Configurable TT_SavecartLineitems 
		INSERT INTO @TBL_Configurable 
		SELECT *  
		FROM @TBL_SavecartLineitems 
		WHERE ISNULL(ConfigurableProductIds,'') <> '' 
		  
		EXEC Znode_InsertUpdateSaveCartLineItemConfigurable @TBL_Configurable,@userId,@OrderLineItemRelationshipTypeIdConfigurable,@OrderLineItemRelationshipTypeIdAddon
				  
		DELETE FROM @TBL_SavecartLineitems 
		WHERE ISNULL(ConfigurableProductIds,'') <> ''
		SET @OmsSavedCartLineItemId = 0  
	END 
	--Save cart execution code for group product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' )
	BEGIN 				
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
		BEGIN 
			--Updating the existing save cart for group product
			SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0 )
			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
			WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
			FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
			INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
			WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
			AND SCLI.GroupProductIds <> ''

			--After update the existing cart with new save cart then deleting those records which are updated
			DELETE	FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0
		END 
		--Getting bundle save cart line item entries into table to pass for group prodcut sp
		DECLARE @TBL_Group TT_SavecartLineitems 
		INSERT INTO @TBL_Group 
		SELECT *  
		FROM @TBL_SavecartLineitems 
		WHERE ISNULL(GroupProductIds,'') <> '' 
		
		EXEC Znode_InsertUpdateSaveCartLineItemGroup @TBL_Group,@userId,@OrderLineItemRelationshipTypeIdGroup,@OrderLineItemRelationshipTypeIdAddon
		
		--After update the existing cart with new save cart then deleting those records which are updated
		DELETE FROM @TBL_SavecartLineitems WHERE ISNULL(GroupProductIds,'') <> ''
		SET @OmsSavedCartLineItemId = 0  
	END 
	
	--This part is for updating the cart for existing line items for simple product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId <> 0  ) 
	BEGIN 
				 
		SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId <> 0 )
		UPDATE ZnodeOmsSavedCartLineItem 
		SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
		, ModifiedDate = @GetDate
		WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId

		UPDATE ZnodeOmsSavedCartLineItem 
		SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
		INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = @OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
		WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					
		DELETE	FROM @TBL_SavecartLineitems WHERE OmsSavedCartLineItemId <> 0
	END 
	--Save cart execution code for Simple product
	DECLARE @OmsInsertedData TABLE (OmsSavedCartLineItemId INT )
	--Inserting the personalise data into variable table @TBL_Personalise for inserting the personalise data for new products
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId int,SKU Varchar(600) ,PersonalizeCode NVARCHAr(max),PersonalizeValue NVARCHAr(max),DesignId NVARCHAr(max), ThumbnailURL NVARCHAr(max))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.SKU
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(Max)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(Max)' ) AS ThumbnailURL
	FROM @TBL_SavecartLineitems a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col) 
			  
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise1 TABLE (OmsSavedCartLineItemId INT ,PersonalizeCode NVARCHAr(max),PersonalizeValue NVARCHAr(max),DesignId NVARCHAr(max), ThumbnailURL NVARCHAr(max))
	INSERT INTO @TBL_Personalise1
	SELECT DISTINCT a.OmsSavedCartLineItemId 
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(Max)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(Max)' ) AS ThumbnailURL
	FROM (SELECT TOP 1 OmsSavedCartLineItemId,PersonalisedAttribute Valuex FROM  #TBL_SavecartLineitems TRTR ) a 
	CROSS APPLY	a.Valuex.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  
		    
			
	CREATE TABLE #NewSavecartLineitemDetails 
	(
		GenId INT IDENTITY(1,1),RowId	INT	,OmsSavedCartLineItemId	INT	 ,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	INT
		,SKU	NVARCHAR(MAX) ,Quantity	NUMERIC(28,6)	,OrderLineItemRelationshipTypeID	INT	,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	int	,AutoAddon	varchar(MAX)	,OmsOrderId	INT	,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX)
	)
	
	--Getting new save cart data
	INSERT INTO #NewSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU 
	FROM @TBL_SavecartLineitems a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
	
	--Getting new simple product save cart data
	INSERT INTO #NewSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, @OrderLineItemRelationshipTypeIdSimple, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU 
	FROM @TBL_SavecartLineitems  a 
	WHERE ISNULL(BundleProductIds,'') =  '' 
	AND  ISNULL(GroupProductIds,'') = ''	AND ISNULL(	ConfigurableProductIds,'') = ''
		GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity,  CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
			
	--Getting new Group,Bundle and Configurable products save cart data if addon is present for any line item
	INSERT INTO #NewSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
		,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
		WHEN  GroupProductIds <> '' THEN GroupProductIds 
		WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU 
	FROM @TBL_SavecartLineitems  a 
	WHERE AddOnValueIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
	
	CREATE TABLE #OldSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old save cart data if present for same SKU in the new save cart data for simple product	 
	INSERT INTO #OldSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM ZnodeOmsSavedCartLineItem a with (nolock)  
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.SKU,'')   )   
	AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple   

	--Getting the old save cart Parent data 
	INSERT INTO #OldSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
	AND  b.OrderLineItemRelationshipTypeID IS NULL 
		 
	DELETE a FROM #OldSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 
		
	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldSavecartLineitemDetails
		
	--Getting the old save cart addon data for old line items if present
	INSERT INTO #OldSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
	AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

	------Merge Addon for same product
	IF EXISTS(SELECT * FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'') <> '' )
	BEGIN

		INSERT INTO #OldValueForAddon 
		SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
		FROM ZnodeOmsSavedCartLineItem b with (nolock)
		INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
								( SELECT  ', ' + SKU FROM    
									( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
										where a.OmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
										FOR XML PATH('')
								), 1, 2, ''
								) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a where a.ParentOmsSavedCartLineItemId is not null and OrderLineItemRelationshipTypeID<>1

		SELECT distinct a.SKU, STUFF(
									( SELECT  ', ' + x.AddOnValueIds FROM    
									( SELECT DISTINCT b.AddOnValueIds FROM @TBL_SavecartLineitems b
										where a.SKU=b.SKU ) x
										FOR XML PATH('')
									), 1, 2, ''
								) AddOns
		INTO #AddOnAdded
		FROM @TBL_SavecartLineitems a

		IF NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
		BEGIN
			DELETE FROM #OldSavecartLineitemDetails
		END

	END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_SavecartLineitems ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldSavecartLineitemDetails a WHERE	
	ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN 
		
		DELETE FROM #OldSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
	    
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  <> '' )
		BEGIN 
		 
			DECLARE @parenTofAddon  TABLE( ParentOmsSavedCartLineItemId INT  )  
			INSERT INTO  @parenTofAddon 
			SELECT  ParentOmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  

			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ParentOmsSavedCartLineItemId FROM  @parenTofAddon)   
				AND ParentOmsSavedCartLineItemId IS NOT NULL  
				AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldSavecartLineitemDetails m)
			AND ParentOmsSavedCartLineItemId IS  NULL  
		 
		END 
		ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		BEGIN 

			DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple  )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
			OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		    
			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldSavecartLineitemDetails m)
			AND ParentOmsSavedCartLineItemId IS  NULL  

		END
		ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  = '' )
		BEGIN 

			DELETE FROM #OldSavecartLineitemDetails
		END 
	END 

	--Getting the personalise data for old save cart if present
	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)

	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		DELETE FROM #OldSavecartLineitemDetails
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 
		   
			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
			SELECT OmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
			OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		      
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 

			DELETE n FROM #OldSavecartLineitemDetails n WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
			OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
	   
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		BEGIN 
			DELETE FROM #OldSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		END 
	  
	END 

	--If already exists cart 
	IF EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails )
	BEGIN
		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU not having personalise value for new cart item
		;WITH cte AS
		(
			SELECT distinct b.*
			FROM @TBL_SavecartLineitems a 
			INNER JOIN #OldSavecartLineitemDetails b on ( a.SKU = b.sku)
			where isnull(cast(a.PersonalisedAttribute AS varchar(max)),'') = ''
		)
		,cte2 AS
		(
			SELECT c.ParentOmsSavedCartLineItemId
			FROM #OldSavecartLineitemDetails a
			INNER JOIN ZnodeOmsSavedCartLineItem c on a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		)
		DELETE a FROM #OldSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU having personalise value for new cart item
		;WITH cte AS
		(
			SELECT distinct b.*, 
				a.PersonalizeCode
				,a.PersonalizeValue
			FROM @TBL_Personalise a 
			INNER JOIN #OldSavecartLineitemDetails b on ( a.SKU = b.sku)
			where a.PersonalizeValue <> ''
		)
		,cte2 AS
		(
			SELECT a.ParentOmsSavedCartLineItemId, b.PersonalizeCode, b.PersonalizeValue
			FROM #OldSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
			WHERE NOT EXISTS(SELECT * FROM cte c where b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and b.PersonalizeCode = c.PersonalizeCode 
						and b.PersonalizeValue = c.PersonalizeValue )
		)
		DELETE a FROM #OldSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,b.ParentOmsSavedCartLineItemId , a.SKU AS SKU
				,a.PersonalizeCode
				,a.PersonalizeValue
				,a.DesignId
				,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldSavecartLineitemDetails b on a.SKU = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM #OldSavecartLineitemDetails b1 
		WHERE NOT EXISTS(SELECT * FROM cte c where (b1.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or b1.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId))
		AND EXISTS(SELECT * FROM cte)

		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
	-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldSavecartLineitemDetails b ON a.SKU = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
			--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewSavecartLineitemDetails  b ON a.SKU = b.SKU
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0 AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		from CTE_OldPersonalizeCodeCount a
		inner join CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		inner join #OldSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		
		--Delete parent entry if child not present
		DELETE a FROM #OldSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

	--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
	--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
	
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.SKU
						,d.PersonalizeCode
				,d.PersonalizeValue
				,d.DesignId
				,d.ThumbnailURL
				FROM @TBL_SavecartLineitems a 
				INNER JOIN #OldSavecartLineitemDetails b on a.SKU = b.SKU
				INNER JOIN @TBL_Personalise d on d.SKU = a.SKU
				INNER JOIN ZnodeOmsPersonalizeCartItem  c  with (nolock)  on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
				WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM cte a1		  
		INNER JOIN #OldSavecartLineitemDetails b1 on a1.sku = b1.SKU
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c where a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and a1.PersonalizeValue = c.PersonalizeValue)

		--Updating the cart if old and new cart data matches 
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5, 
		a.ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewSavecartLineitemDetails ty ON (ty.SKU = b.SKU)

	END 
	--Inserting the new save cart data if old and new cart data not match
	ELSE 
	BEGIN 
	    --Getting the new save cart data and generating row no. for new save cart insert
		SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU  
		INTO #InsertNewSavecartLineitem   
		FROM  #NewSavecartLineitemDetails  
		GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails ,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU   
		ORDER BY RowId, Id   
       	
		--Removing the line item having Quantity <=0	     
		DELETE FROM #InsertNewSavecartLineitem WHERE Quantity <=0  
  
		--Updating the rowid into new save cart line item as new line item is merged into existing save cart item
		;WITH VTTY AS   
		(  
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
			FROM #InsertNewSavecartLineitem m  
			INNER JOIN  #InsertNewSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU   
			WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon   
		)   
		UPDATE m1   
		SET m1.RowId = TYU.RowId  
		FROM #InsertNewSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  
        
		--Deleting the new save cart line item if cart line item is merged
		;WITH VTRET AS   
		(  
			SELECT RowId,id,Min(NewRowId) NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID  
			FROM #InsertNewSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID
			Having  SKU = ParentSKU  AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdSimple
		)   
		DELETE FROM #InsertNewSavecartLineitem WHERE NewRowId IN (SELECT NewRowId FROM VTRET)  

		--Inserting the new cart line item if not merged in existing save cart line item
		INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description)  
		OUTPUT INSERTED.OmsSavedCartLineItemId  INTO @OmsInsertedData 
		SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description   
		FROM  #InsertNewSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU  
		INTO #ParentOmsSavedCartId
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		AND CASE WHEN EXISTS (SELECT TOP 1 1 FROM #InsertNewSavecartLineitem TU WHERE TU.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple)  THEN ISNULL(a.OrderLineItemRelationshipTypeID,0) ELSE 0 END = 0 
		GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #ParentOmsSavedCartId  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
		AND a.ParentOmsSavedCartLineItemId IS nULL   

		SELECT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(Order BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #NewSimpleProduct
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c on b.sku = c.sku and b.OmsSavedCartId=c.OmsSavedCartId and b.Id = 1 
		WHERE ( ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  and c.ParentOmsSavedCartLineItemId is null

		--Updating ParentOmsSavedCartLineItemId for newly added save cart line item
		;WITH table_update AS 
		(
			SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId  ) RowIdNo
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
			AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
			AND a.ParentOmsSavedCartLineItemId IS NULL  
			AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
			AND EXISTS (SELECT TOP 1 1 FROM #NewSimpleProduct TI WHERE TI.SKU = a.SKU)
		)
		UPDATE a SET  
		a.ParentOmsSavedCartLineItemId =(SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewSimpleProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewSimpleProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU   GROUP BY r.ParentSKU, r.SKU  )    IS NOT NULL 
	 
		;WITH Cte_Th AS   
		(             
			SELECT RowId    
			FROM #InsertNewSavecartLineitem a   
			GROUP BY RowId   
			HAVING COUNT(NewRowId) <= 1   
		)   
		UPDATE a SET a.Quantity =  NULL , a.ModifiedDate = @GetDate  
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		AND OrderLineItemRelationshipTypeId IS NOT NULL     

		;WITH Cte_UpdateSequence AS   
		(  
			SELECT OmsSavedCartLineItemId ,Row_Number()Over(Order By OmsSavedCartLineItemId) RowId , Sequence   
			FROM ZnodeOmsSavedCartLineItem with (nolock)  
			WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		)   
		UPDATE Cte_UpdateSequence  
		SET  Sequence = RowId  
	
		----To update saved cart item personalise value FROM given line item	
		IF EXISTS(SELECT * FROM @TBL_Personalise1 where isnull(PersonalizeValue,'') <> '' and isnull(OmsSavedCartLineItemId,0) <> 0)
		BEGIN
			DELETE FROM ZnodeOmsPersonalizeCartItem 
			WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise1 yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )

			MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
			USING @TBL_Personalise1 SOURCE
			ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			WHEN NOT MATCHED THEN 
			INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
							,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
			VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
							,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
		END		
	
		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN ZnodeOmsSavedCartLineItem b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS NOT NULL 
	
		DELETE FROM ZnodeOmsPersonalizeCartItem 
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
						
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
		ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
		WHEN NOT MATCHED THEN 
		INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
					,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
		VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
					,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
  
		
		 
	END 

	Declare @OutputTable Table (CartCount numeric(28,6))

	INSERT INTO @OutputTable
	EXEC [Znode_GetOmsSavedCartLineItemCount] @OmsCookieMappingId = @OmsCookieMappingId,@UserId=@UserId,@PortalId=@UserId
	

	SELECT CAST(1 AS bit) AS Status,@OmsSavedCartId AS SavedCartId,@OmsCookieMappingId AS CookieMappingId,CartCount
	FROM @OutputTable

COMMIT TRAN InsertUpdateSaveCartLineItem;
END TRY
BEGIN CATCH
	SELECT ERROR_MESSAGE()	
	DECLARE @Error_procedure varchar(1000)= ERROR_PROCEDURE(), @ErrorMessage nvarchar(max)= ERROR_MESSAGE(), @ErrorLine varchar(100)= ERROR_LINE(), @ErrorCall nvarchar(max)= 'EXEC Znode_InsertUpdateSaveCartLineItem @CartLineItemXML = '+CAST(@CartLineItemXML
	AS varchar(max))+',@UserId = '+CAST(@UserId AS varchar(50))+',@PortalId='+CAST(@PortalId AS varchar(10))+',@OmsCookieMappingId='+CAST(@OmsCookieMappingId AS varchar(10));

	SELECT 0 AS ID, CAST(0 AS bit) AS Status,ERROR_MESSAGE();
	ROLLBACK TRAN InsertUpdateSaveCartLineItem;
	EXEC Znode_InsertProcedureErrorLog @ProcedureName = 'Znode_InsertUpdateSaveCartLineItem', @ErrorInProcedure = @Error_procedure, @ErrorMessage = @ErrorMessage, @ErrorLine = @ErrorLine, @ErrorCall = @ErrorCall;
END CATCH;
END;


GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetGiftCardHistoryList')
	DROP PROC Znode_GetGiftCardHistoryList
GO

CREATE PROCEDURE [dbo].[Znode_GetGiftCardHistoryList]  
(  
	@WhereClause NVARCHAR(max),  
    @Rows        INT            = 100,  
    @PageNo      INT            = 1,  
    @Order_BY    VARCHAR(1000)  = '',  
    @RowsCount   INT  out
  )    
AS  
/*  
    Summary: This procedure is used to find the GiftCardhistoryList

     EXEC [Znode_GetGiftCardHistoryList] @WhereClause='' , @RowsCount= 0,@ExpirationDate = ''  
*/  
 
BEGIN  
BEGIN TRY  
SET NOCOUNT ON;  
             
	DECLARE @SQL NVARCHAR(MAX);

	CREATE TABLE #TBL_GiftCardHistoryList (OmsOrderDetailsId int,OmsOrderId INT,OrderNumber NVARCHAR(600),TransactionAmount NUMERIC(28,6),TransactionDate DATETIME,UserName NVARCHAR(512),CustomerName NVARCHAR(512),PortalId INT,UserId INT,OmsUserId INT,GiftCardId INT,Notes VARCHAR(MAX), CultureCode VARCHAR(100), RowId INT, CountNo INT )  
 
	SET @SQL ='  
 
	;WITH CTE_GetGiftHistoryCard AS  
	(  
		SELECT ZOD.OmsOrderDetailsId,ZGH.GiftCardHistoryId, CASE WHEN ZOD.OmsOrderId IS NULL THEN 0 ELSE ZOD.OmsOrderId END  AS OmsOrderId ,ZO.OrderNumber,ZGH.TransactionAmount,ZGH.TransactionDate,ZU.Email As UserName,
		CASE WHEN ZU.FirstName IS NULL THEN '''' ELSE ZU.FirstName END + CASE WHEN ZU.LastName IS NULL  THEN '''' ELSE '' ''+ZU.LastName END as CustomerName,ZGC.PortalId,ZGC.UserId,ZOD.UserId as OmsUserId,ZGC.GiftCardId,ZGH.Notes,zc.CultureCode,ZGC.IsActive,ZGH.RemainingAmount
		FROM ZnodeGiftCard ZGC  
		INNER JOIN ZnodeGiftCardHistory ZGH ON (ZGC.GiftCardId = ZGH.GiftCardId)  
		LEFT JOIN ZnodeOmsOrderDetails ZOD on (ZGH.OmsOrderDetailsId = ZOD.OmsOrderDetailsId )
		INNER JOIN ZnodePortal ZP ON (ZGC.PortalId = ZP.PortalId)  
		INNER JOIN ZnodePortalUnit zpu on (zp.PortalId = zpu.PortalId)  
		LEFT JOIN ZnodeCulture zc on (zc.CultureId = zpu.CultureId)    
		LEFT JOIN ZnodeOmsOrder ZO on (ZOD.OmsOrderId = ZO.OmsOrderId)  
		LEFT JOIN ZnodeUser ZU ON (ZU.UserId = CASE WHEN ZOD.UserId IS NULL then ZGC.UserId ELSE ZOD.UserId END)
	)  
	, CTE_GetGiftCardHistoryList AS  
	(  
		SELECT OmsOrderDetailsId,GiftCardHistoryId, OmsOrderId ,OrderNumber,case when isnull(OmsOrderDetailsId,0)=0 then RemainingAmount Else TransactionAmount End as TransactionAmount,TransactionDate,UserName,CustomerName,PortalId,UserId,OmsUserId,GiftCardId,Notes,CultureCode,IsActive,RemainingAmount,
		'+dbo.Fn_GetPagingRowId(@Order_BY,'GiftCardHistoryId DESC')+',Count(*)Over() CountNo  
		FROM CTE_GetGiftHistoryCard  
		WHERE 1=1 '+dbo.Fn_GetFilterWhereClause(@WhereClause)+'      
	)  
	SELECT OmsOrderDetailsId,OmsOrderId ,OrderNumber,ISNull(TransactionAmount,0) AS TransactionAmount,TransactionDate,UserName,CustomerName,PortalId,UserId,OmsUserId,GiftCardId,Notes,CultureCode,RowId,CountNo
	FROM CTE_GetGiftCardHistoryList  
	'+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows)  
 
	 INSERT INTO #TBL_GiftCardHistoryList  
	 EXEC(@SQL)  

	 SET @RowsCount =ISNULL((SELECT TOP 1 CountNo FROM #TBL_GiftCardHistoryList ),0)  

	 ;With CTE_GiftCardHistory as
	  (
		  SELECT Distinct ZOD.OmsOrderId,GiftHistory.GiftCardId,Gift.RemainingAmount, min(GiftHistory.OmsOrderDetailsId) as OmsOrderDetailsId
		  FROM ZnodeGiftCardHistory GiftHistory
		  inner join ZnodeGiftCard Gift ON GiftHistory.GiftCardId = Gift.GiftCardId
		  LEFT JOIN ZnodeOmsOrderDetails ZOD on (GiftHistory.OmsOrderDetailsId = ZOD.OmsOrderDetailsId)
		  LEFT JOIN ZnodeOmsOrder ZO on (ZOD.OmsOrderId = ZO.OmsOrderId)  
		  WHERE EXISTS(select * from  #TBL_GiftCardHistoryList Gift where GiftHistory.GiftCardId = Gift.GiftCardId)
		  GROUP BY ZOD.OmsOrderId,GiftHistory.GiftCardId,Gift.RemainingAmount
	  )
	  ,CTE_OrderVoucherAmount AS
	  (
		  SELECT Distinct ISNULL(cte.OmsOrderId,0) AS OmsOrderId,cte.OmsOrderDetailsId,Hist.GiftCardId,
		  CASE WHEN cte.OmsOrderId IS NOT NULL THEN Hist.TransactionAmount ELSE Cte.RemainingAmount END as OrderVoucherAmount
		  FROM ZnodeGiftCardHistory Hist
		  LEFT join CTE_GiftCardHistory Cte on Hist.GiftCardId = Cte.GiftCardId and ISNULL (Hist.OmsOrderDetailsId,0) = ISNULL(Cte.OmsOrderDetailsId,0)
		  WHERE EXISTS(select * from  #TBL_GiftCardHistoryList Gift where Hist.GiftCardId = Gift.GiftCardId)
		  AND CASE WHEN cte.OmsOrderId IS not NULL THEN Hist.TransactionAmount ELSE Cte.RemainingAmount END IS NOT NULL
	)
	SELECT Hist.OmsOrderId ,Hist.OrderNumber,Hist.TransactionDate,Hist.UserName,Hist.CustomerName,
	Hist.PortalId,Hist.UserId,Hist.OmsUserId,Hist.GiftCardId,Hist.Notes,Hist.CultureCode, Hist.TransactionAmount as TransactionAmount
	FROM #TBL_GiftCardHistoryList Hist
	INNER JOIN CTE_OrderVoucherAmount Voucher ON Hist.GiftCardId = Voucher.GiftCardId AND Voucher.OmsOrderId = Hist.OmsOrderId
	and ISNULL (Hist.OmsOrderDetailsId,0) = ISNULL(Voucher.OmsOrderDetailsId,0)


END TRY  
BEGIN CATCH  
	DECLARE @Status BIT ;  
	SET @Status = 0;  
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetGiftCardHIstoryList @WhereClause = '+CAST(@WhereClause AS VARCHAR(MAX))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+'@Status='+CAST(@Status AS VARCHAR(10));  
                   
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
     
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_GetGiftCardHistoryList',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_CatalogProductDraftForPublish')
	DROP PROC Znode_CatalogProductDraftForPublish
GO

CREATE PROCEDURE Znode_CatalogProductDraftForPublish
(
	@PublishCatalogId INT
)
AS
BEGIN
BEGIN TRY 
SET NOCOUNT ON 
	SELECT ZPCP.PimProductId
	INTO #DraftProduct
	FROM ZnodePimCategoryProduct ZPCP WITH(NOLOCK)
	INNER JOIN ZnodePimCategoryHierarchy ZPCH WITH(NOLOCK) ON ZPCP.PimCategoryId = ZPCH.PimCategoryId 
	WHERE EXISTS(SELECT * FROM ZnodePublishCatalog ZPC WITH(NOLOCK) WHERE ZPC.PublishCatalogId = @PublishCatalogId AND ZPCH.PimCatalogId = ZPC.PimCatalogId )

	Update ZPP SET PublishStateId = 2, IsProductPublish = 0 , ModifiedDate = GETDATE() 
	FROM ZnodePimProduct ZPP 
	WHERE EXISTS(SELECT * FROM #DraftProduct DP WHERE ZPP.PimProductId = DP.PimProductId)

	Update ZPP SET PublishStateId = 2, IsProductPublish = 0 , ModifiedDate = GETDATE() 
	FROM ZnodePimProduct ZPP WITH(NOLOCK)
	where EXISTS(SELECT * FROM ZnodePimProductTypeAssociation PTA WITH(NOLOCK) WHERE ZPP.PimProductId = PTA.PimProductId 
			AND EXISTS(SELECT * FROM #DraftProduct DP WHERE PTA.PimParentProductId = DP.PimProductId))

	Update ZPP SET PublishStateId = 2, IsProductPublish = 0 , ModifiedDate = GETDATE() 
	FROM ZnodePimProduct ZPP WITH(NOLOCK)
	where EXISTS(SELECT * FROM ZnodePimLinkProductDetail PTA WITH(NOLOCK) WHERE ZPP.PimProductId = PTA.PimProductId 
			AND EXISTS(SELECT * FROM #DraftProduct DP WHERE PTA.PimParentProductId = DP.PimProductId))

	Update ZPP SET PublishStateId = 2, IsProductPublish = 0 , ModifiedDate = GETDATE() 
	FROM ZnodePimProduct ZPP WITH(NOLOCK)
	where EXISTS(SELECT * FROM ZnodePimLinkProductDetail PTA WITH(NOLOCK) WHERE ZPP.PimProductId = PTA.PimProductId 
			AND EXISTS(SELECT * FROM #DraftProduct DP WHERE PTA.PimParentProductId = DP.PimProductId))

	Update ZPP SET PublishStateId = 2, IsProductPublish = 0 , ModifiedDate = GETDATE() 
	FROM ZnodePimProduct ZPP
	where EXISTS(SELECT * FROM ZnodePimAddOnProduct PTA WITH(NOLOCK)
			INNER JOIN ZnodePimAddOnProductDetail ZPA1 WITH(NOLOCK) ON PTA.PimAddOnProductId = ZPA1.PimAddOnProductId
			WHERE ZPP.PimProductId = PTA.PimProductId 
			AND EXISTS(SELECT * FROM #DraftProduct DP WHERE ZPA1.PimChildProductId = DP.PimProductId))
END TRY
BEGIN CATCH
    DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_CatalogProductDraftForPublish @PublishCatalogId = '+CAST(@PublishCatalogId AS VARCHAR(200));

    EXEC Znode_InsertProcedureErrorLog
        @ProcedureName = 'Znode_CatalogProductDraftForPublish',
        @ErrorInProcedure = @Error_procedure,
        @ErrorMessage = @ErrorMessage,
        @ErrorLine = @ErrorLine,
        @ErrorCall = @ErrorCall;
           
END CATCH;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdatePimCatalogProductDetailJson')
	DROP PROC Znode_InsertUpdatePimCatalogProductDetailJson

GO


CREATE PROCEDURE [dbo].[Znode_InsertUpdatePimCatalogProductDetailJson] 
(
	@PublishCatalogId INT = 0, 
	@LocaleId TransferId READONLY, 
	@UserId INT = 0   
)
AS 

--declare @LocaleId TransferId
--INSERT INTO @LocaleId
--SELECT 1
--exec [Znode_InsertUpdatePimCatalogProductDetailJson] @PublishCatalogId=3,@LocaleId=@LocaleId,@UserId=2

--declare @LocaleId TransferId
--INSERT INTO @LocaleId
--SELECT 1
----union 
----SELECT 4
----union 
----SELECT 2
--exec [Znode_POC_InsertUpdatePimCatalogProductDetail] @PublishCatalogId=3,@LocaleId=@LocaleId,@UserId=2
BEGIN 
BEGIN TRY 

  SET NOCOUNT ON 
       DECLARE @LocaleId_In INT = 0 , @DefaultLocaleId INT = dbo.FN_GETDefaultLocaleId()
			   ,@Date DATETIME = dbo.fn_GetDate()
	   DECLARE @PimMediaAttributeId INT = dbo.Fn_GetProductImageAttributeId()		   

	   CREATE TABLE #PimDefaultValueLocale  (PimAttributeDefaultJsonId INT  PRIMARY KEY ,PimAttributeDefaultValueId INT ,LocaleId INT, DefaultValueJson	nvarchar(max) )

	   CREATE TABLE #AttributeValueLocale  (Id int Identity,  PimProductId INT, AttributeCode Varchar(300), AttributeValue varchar(max), AttributeEntity varchar(max), LocaleId int )

	    ----To get the localwise product data
		SELECT DISTINCT ZPAV.PimProductId, ZPP.PublishProductId, ZPAVL.LocaleId
		INTO #ProductLocaleWise
		FROM ZnodePimAttributeValue ZPAV
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		INNER JOIN ZnodePublishProduct ZPP ON ZPAV.PimProductId = ZPP.PimProductId
		WHERE ZPAV.PimAttributeId = (SELECT PimAttributeId FROM ZnodePimAttribute WHERE AttributeCode = 'SKU')
			
		INSERT INTO #ProductLocaleWise
		SELECT DISTINCT ZPAV.PimProductId, ZPP.PublishProductId, ZPAVL.LocaleId
		FROM ZnodePimAttributeValue ZPAV
		INNER JOIN ZnodePimProductAttributeDefaultValue ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		INNER JOIN ZnodePublishProduct ZPP ON ZPAV.PimProductId = ZPP.PimProductId
		WHERE NOT EXISTS(SELECT * FROM #ProductLocaleWise X WHERE ZPAV.PimProductId = X.PimProductId AND ZPAVL.LocaleId = X.LocaleId)
		
		INSERT INTO #ProductLocaleWise
		SELECT DISTINCT ZPAV.PimProductId, ZPP.PublishProductId, ZPAVL.LocaleId
		FROM ZnodePimAttributeValue ZPAV
		INNER JOIN ZnodePimProductAttributeTextAreaValue ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		INNER JOIN ZnodePublishProduct ZPP ON ZPAV.PimProductId = ZPP.PimProductId
		WHERE NOT EXISTS(SELECT * FROM #ProductLocaleWise X WHERE ZPAV.PimProductId = X.PimProductId AND ZPAVL.LocaleId = X.LocaleId)
		
		INSERT INTO #ProductLocaleWise
		SELECT DISTINCT ZPAV.PimProductId, ZPP.PublishProductId, ZPAVL.LocaleId
		FROM ZnodePimAttributeValue ZPAV
		INNER JOIN ZnodePimProductAttributeMedia ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		INNER JOIN ZnodePublishProduct ZPP ON ZPAV.PimProductId = ZPP.PimProductId
		WHERE NOT EXISTS(SELECT * FROM #ProductLocaleWise X WHERE ZPAV.PimProductId = X.PimProductId AND ZPAVL.LocaleId = X.LocaleId)
		------------

		SELECT BTM.PimProductId , ZPCPD.PublishProductId, ZPCPD.PublishCatalogId,BTM.ModifiedDate
		INTO #ProductAttributeXML
		FROM ZnodePublishProductAttributeJson BTM 
		INNER JOIN ZnodePublishProduct ZPP1 ON BTM.PimProductId = ZPP1.PimProductId
		INNER JOIN ZnodePublishCatalogProductDetail ZPCPD ON ZPP1.PublishProductId = ZPCPD.PublishProductId AND ZPCPD.PublishCatalogId = ZPP1.PublishCatalogId 
		WHERE ZPCPD.PublishCatalogId =  @PublishCatalogId 

	    -------- Products Attribute modified 
		SELECT DISTINCT ZPP.PublishProductId,  ZPCC.PimCategoryHierarchyId 
		INTO #ModifiedProducts
		FROM ZnodePublishProduct  ZPP
		INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
		INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimProductId = ZPP.PimProductId )
		INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = ZPAV.PimAttributeId)
		INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategoryProduct ZPCC  ON (ZPP.PublishProductId = ZPCC.PublishProductId AND ZPCC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategory ZPPC ON (ISNULL(ZPPC.PimCategoryHierarchyId,0) = ISNULL(ZPCC.PimCategoryHierarchyId,0) AND ZPPC.PublishCategoryId = ZPCC.PublishCategoryId)
		WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
		AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId AND ZPFGM.PimAttributeId = ZPAV.PimAttributeId))
		AND EXISTS (SELECT TOP 1 1 FROM #ProductAttributeXML BTM WHERE BTM.PimProductId = ZPP.PimProductId AND BTM.PublishCatalogId = ZPP.PublishCatalogId
						AND (BTM.ModifiedDate < ZPAV.ModifiedDate OR BTM.ModifiedDate < ZPA.ModifiedDate)   ) 
		
		-------- Products not published  
		INSERT INTO #ModifiedProducts
		SELECT ZPP.PublishProductId,  ZPCC.PimCategoryHierarchyId 
		FROM ZnodePublishProduct  ZPP
		INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
		INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategoryProduct ZPCC  ON (ZPP.PublishProductId = ZPCC.PublishProductId AND ZPCC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategory ZPPC ON (ISNULL(ZPPC.PimCategoryHierarchyId,0) = ISNULL(ZPCC.PimCategoryHierarchyId,0) AND ZPPC.PublishCategoryId = ZPCC.PublishCategoryId)
		WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
		AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId ))--AND ZPFGM.PimAttributeId = ZPAV.PimAttributeId))
		AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 INNER JOIN ZnodePublishState ZPS ON ZPP1.PublishStateId = ZPS.PublishStateId
					WHERE StateName <> 'Publish' AND ZPP.PimProductId = ZPP1.PimProductId )	
			
		-------- Products associated to catalog or category or modified catalog category products
		INSERT INTO #ModifiedProducts		
		SELECT ZPP.PublishProductId,  ZPCC.PimCategoryHierarchyId 
		FROM ZnodePublishProduct  ZPP
		INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
		INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZPP.PublishCatalogId)
		INNER JOIN ZnodePimCategoryProduct ZPCC1 ON  ZPP.PimProductId = ZPCC1.PimProductId 
		INNER JOIN ZnodePimCategoryHierarchy ZPCH ON ZPCC1.PimCategoryId = ZPCH.PimCategoryId AND ZPC.PimCatalogId = ZPCH.PimCatalogId 
		LEFT JOIN ZnodePublishCategoryProduct ZPCC  ON (ZPP.PublishProductId = ZPCC.PublishProductId AND ZPCC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategory ZPPC ON (ISNULL(ZPPC.PimCategoryHierarchyId,0) = ISNULL(ZPCC.PimCategoryHierarchyId,0) AND ZPPC.PublishCategoryId = ZPCC.PublishCategoryId)
		WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
		AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId ))--AND ZPFGM.PimAttributeId = ZPAV.PimAttributeId))
		AND EXISTS (SELECT TOP 1 1 FROM #ProductAttributeXML BTM WHERE BTM.PimProductId = ZPCC1.PimProductId AND BTM.PublishCatalogId = ZPP.PublishCatalogId
						AND (BTM.ModifiedDate < ZPCC1.ModifiedDate )   ) 

		-------- Link Product modified 
		INSERT INTO #ModifiedProducts	
		SELECT ZPP.PublishProductId,  ZPCC.PimCategoryHierarchyId 
		FROM ZnodePublishProduct  ZPP
		INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
		INNER JOIN ZnodePimLinkProductDetail ZPAV ON (ZPAV.PimParentProductId = ZPP.PimProductId )
		INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategoryProduct ZPCC  ON (ZPP.PublishProductId = ZPCC.PublishProductId AND ZPCC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategory ZPPC ON (ISNULL(ZPPC.PimCategoryHierarchyId,0) = ISNULL(ZPCC.PimCategoryHierarchyId,0) AND ZPPC.PublishCategoryId = ZPCC.PublishCategoryId)
		WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
		--AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId AND ZPFGM.PimAttributeId = ZPAV.PimAttributeId))
		AND EXISTS (SELECT TOP 1 1 FROM #ProductAttributeXML BTM WHERE BTM.PimProductId = ZPP.PimProductId AND BTM.PublishCatalogId = ZPP.PublishCatalogId
						AND (BTM.ModifiedDate < ZPAV.ModifiedDate)   ) 

		--------Associated child Products (varients, Group) not published	
		INSERT INTO #ModifiedProducts	
		SELECT ZPP.PublishProductId,  ZPCC.PimCategoryHierarchyId 
		FROM ZnodePublishProduct  ZPP
		INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
		INNER JOIN ZnodePimProductTypeAssociation ZPAV ON (ZPAV.PimProductId = ZPP.PimProductId )
		INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategoryProduct ZPCC  ON (ZPP.PublishProductId = ZPCC.PublishProductId AND ZPCC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategory ZPPC ON (ISNULL(ZPPC.PimCategoryHierarchyId,0) = ISNULL(ZPCC.PimCategoryHierarchyId,0) AND ZPPC.PublishCategoryId = ZPCC.PublishCategoryId)
		WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
		AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 INNER JOIN ZnodePublishState ZPS ON ZPP1.PublishStateId = ZPS.PublishStateId
					WHERE StateName <> 'Publish' AND ZPAV.PimProductId = ZPP1.PimProductId )


		--------Link child Products (Bundle) not published 	
		INSERT INTO #ModifiedProducts
		SELECT ZPP.PublishProductId,  ZPCC.PimCategoryHierarchyId 
		FROM ZnodePublishProduct  ZPP
		INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
		INNER JOIN ZnodePimLinkProductDetail ZPAV ON (ZPAV.PimProductId = ZPP.PimProductId )
		INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategoryProduct ZPCC  ON (ZPP.PublishProductId = ZPCC.PublishProductId AND ZPCC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategory ZPPC ON (ISNULL(ZPPC.PimCategoryHierarchyId,0) = ISNULL(ZPCC.PimCategoryHierarchyId,0) AND ZPPC.PublishCategoryId = ZPCC.PublishCategoryId)
		WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
		AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 INNER JOIN ZnodePublishState ZPS ON ZPP1.PublishStateId = ZPS.PublishStateId
					WHERE StateName <> 'Publish' AND ZPAV.PimProductId = ZPP1.PimProductId )

		----Getting products of newly added category hierarchy 
		INSERT INTO #ModifiedProducts		
		SELECT ZPP.PublishProductId,  ZPCC.PimCategoryHierarchyId
		FROM ZnodePublishProduct  ZPP
		INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
		INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZPP.PublishCatalogId)
		INNER JOIN ZnodePimCategoryProduct ZPCC1 ON  ZPP.PimProductId = ZPCC1.PimProductId 
		INNER JOIN ZnodePimCategoryHierarchy ZPCH ON ZPCC1.PimCategoryId = ZPCH.PimCategoryId AND ZPC.PimCatalogId = ZPCH.PimCatalogId 
		LEFT JOIN ZnodePublishCategoryProduct ZPCC  ON (ZPP.PublishProductId = ZPCC.PublishProductId AND ZPCC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategory ZPPC ON (ISNULL(ZPPC.PimCategoryHierarchyId,0) = ISNULL(ZPCC.PimCategoryHierarchyId,0) AND ZPPC.PublishCategoryId = ZPCC.PublishCategoryId)
		WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
		AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId ))--AND ZPFGM.PimAttributeId = ZPAV.PimAttributeId))
		AND NOT EXISTS(SELECT * FROM ZnodePublishCatalogProductDetail ZPCPPD WHERE ZPCPPD.PimCategoryHierarchyId =  ZPCH.PimCategoryHierarchyId AND ZPCPPD.PublishCatalogId = ZPP.PublishCatalogId ) 

		---------------------Category associated to catalog or category or modified catalog
		SELECT ZPCH.PimCategoryId, ZPC1.PublishCategoryId, ZPCH.PimCategoryHierarchyId
		INTO #ModifiedCategory
		FROM ZnodePimCategoryHierarchy ZPCH 
		INNER JOIN ZnodePublishCategory ZPC1 ON ZPCH.PimCategoryId = ZPC1.PimCategoryId 
        WHERE ZPC1.PublishCatalogId =  @PublishCatalogId 
		AND EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogProductDetail BTM  
		WHERE BTM.PublishCatalogId = ZPC1.PublishCatalogId AND (BTM.ModifiedDate < ZPCH.ModifiedDate )   )
		AND NOT EXISTS(SELECT * FROM #ModifiedProducts MP WHERE  ISNULL(ZPCH.PimCategoryHierarchyId,0) = ISNULL(MP.PimCategoryHierarchyId,0))

		-------- Category associated to catalog or category or modified catalog
		INSERT INTO #ModifiedProducts		
		SELECT ZPP.PublishProductId,  ZPCC.PimCategoryHierarchyId 
		FROM ZnodePublishProduct  ZPP
		INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
		INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZPP.PublishCatalogId)
		INNER JOIN ZnodePimCategoryProduct ZPCC1 ON  ZPP.PimProductId = ZPCC1.PimProductId 
		INNER JOIN ZnodePimCategoryHierarchy ZPCH ON ZPCC1.PimCategoryId = ZPCH.PimCategoryId AND ZPC.PimCatalogId = ZPCH.PimCatalogId 
		LEFT JOIN ZnodePublishCategoryProduct ZPCC  ON (ZPP.PublishProductId = ZPCC.PublishProductId AND ZPCC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategory ZPPC ON (ISNULL(ZPPC.PimCategoryHierarchyId,0) = ISNULL(ZPCC.PimCategoryHierarchyId,0) AND ZPPC.PublishCategoryId = ZPCC.PublishCategoryId)
		WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
		AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId ))
		AND EXISTS (SELECT TOP 1 1 FROM #ModifiedCategory BTM WHERE BTM.PimCategoryHierarchyId = ZPCH.PimCategoryHierarchyId  ) 
		------------------

		--Getting all products of catalog for publish first time 
		SELECT ZPP.PublishProductId,  ZPAV.PimAttributeId, ZPP.PublishCatalogId , ZPCC.PimCategoryHierarchyId , ZPCC.PublishCategoryId,
		       ZPAV.PimAttributeValueId, ZPC.CatalogName ,ZPP.PimProductId ,ZPA.AttributeCode				
		INTO #ZnodePublishCategoryProduct
		FROM ZnodePublishProduct  ZPP
		INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
		INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimProductId = ZPP.PimProductId )
		INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = ZPAV.PimAttributeId)
		INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategoryProduct ZPCC  ON (ZPP.PublishProductId = ZPCC.PublishProductId AND ZPCC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategory ZPPC ON (ISNULL(ZPPC.PimCategoryHierarchyId,0) = ISNULL(ZPCC.PimCategoryHierarchyId,0) AND ZPPC.PublishCategoryId = ZPCC.PublishCategoryId)
		WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
		AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId AND ZPFGM.PimAttributeId = ZPAV.PimAttributeId))
		AND NOT EXISTS (SELECT TOP 1 1 FROM #ProductAttributeXML BTM WHERE BTM.PimProductId = ZPP.PimProductId AND BTM.PublishCatalogId = ZPP.PublishCatalogId)
		
		--Getting all products of catalog for publish which are modified after last publish
		INSERT INTO #ZnodePublishCategoryProduct 
		SELECT ZPP.PublishProductId,  ZPAV.PimAttributeId, ZPP.PublishCatalogId , ZPCC.PimCategoryHierarchyId , ZPCC.PublishCategoryId
			   ,ZPAV.PimAttributeValueId, ZPC.CatalogName--,CASE WHEN ZPCC.PublishProductId IS NULL THEN 1 ELSE  dense_rank()Over(ORDER BY ZPCC.PimCategoryHierarchyId,ZPCC.PublishProductId) END  ProductIndex 	
			   ,ZPP.PimProductId ,ZPA.AttributeCode				
		FROM ZnodePublishProduct  ZPP
		INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
		INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimProductId = ZPP.PimProductId )
		INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = ZPAV.PimAttributeId)
		INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategoryProduct ZPCC  ON (ZPP.PublishProductId = ZPCC.PublishProductId AND ZPCC.PublishCatalogId = ZPP.PublishCatalogId)
		LEFT JOIN ZnodePublishCategory ZPPC ON (ZPPC.PimCategoryHierarchyId = ZPCC.PimCategoryHierarchyId AND ZPPC.PublishCategoryId = ZPCC.PublishCategoryId)
		WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
		AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId AND ZPFGM.PimAttributeId = ZPAV.PimAttributeId))
		AND EXISTS (SELECT * FROM #ModifiedProducts MP WHERE ZPP.PublishProductId = MP.PublishProductId 
			AND ISNULL(ZPCC.PimCategoryHierarchyId,0) = ISNULL(MP.PimCategoryHierarchyId,0) ) 
		AND NOT EXISTS(SELECT * FROM #ZnodePublishCategoryProduct ZPCP WHERE ZPP.PublishProductId = ZPCP.PublishProductId AND
			ZPAV.PimAttributeId=ZPCP.PimAttributeId AND ZPP.PublishCatalogId=ZPCP.PublishCatalogId 
			AND ISNULL(ZPCC.PimCategoryHierarchyId,0)= ISNULL(ZPCP.PimCategoryHierarchyId,0))

		CREATE INDEX IDX_#ZnodePublishCategoryProduct_PimProductId ON #ZnodePublishCategoryProduct(PimProductId)
		CREATE INDEX IDX_#ZnodePublishCategoryProduct_PublishCategoryId ON #ZnodePublishCategoryProduct(PublishCategoryId)

		CREATE INDEX IDX_#ZnodePublishCategoryProduct_PimAttributeValueId ON #ZnodePublishCategoryProduct(PimAttributeValueId)
		CREATE INDEX IDX_#ZnodePublishCategoryProduct_PimAttributeId ON #ZnodePublishCategoryProduct(PimAttributeId)
		 
		------Getting All Link Product Details
		SELECT ZPLPD.PimParentProductId, ZPLPD.PimProductId, ZPLPD.PimAttributeId, ZPAVL.AttributeValue as SKU
		INTO #LinkProduct
		FROM ZnodePimLinkProductDetail ZPLPD 
		INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimProductId = ZPLPD.PimProductId)
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		WHERE EXISTS(SELECT * FROM ZnodePimAttribute ZPA WHERE ZPA.PimAttributeId = ZPAV.PimAttributeId AND ZPA.AttributeCode = 'SKU')
		
		 ----Getting products link product value entity
	     INSERT INTO #AttributeValueLocale ( PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId )
	     SELECT ZPLP.PimParentProductId ,ZPAX.AttributeCode, '' AttributeValue , 
		 JSON_MODIFY( JSON_Modify(ZPAX.AttributeJson , '$.AttributeValues' , 
		 ISNULL(SUBSTRING ( (SELECT ','+cast( LP.SKU as varchar(600))
							FROM #LinkProduct LP
							WHERE LP.PimParentProductId = ZPLP.PimParentProductId 
							AND LP.PimAttributeId = ZPLP.PimAttributeId FOR XML PATH('')),2,8000),'') ),'$.SelectValues',Json_Query('[]'))   

							, ZPAX.LocaleId
		 FROM ZnodePimLinkProductDetail ZPLP
		 INNER JOIN ZnodePimAttributeJSON ZPAX ON (ZPAX.PimAttributeId = ZPLP.PimAttributeId )
		 WHERE EXISTS(SELECT * FROM #ZnodePublishCategoryProduct PPCP  WHERE (ZPLP.PimParentProductId = PPCP.PimProductId ))
		 GROUP BY ZPLP.PimParentProductId ,ZPAX.AttributeCode , ZPAX.AttributeJSON,ZPAX.LocaleId,ZPAX.AttributeCode,ZPLP.PimAttributeId


		  ----Getting product attribute value entity
	      INSERT INTO #AttributeValueLocale ( PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId )
		  SELECT PPCP.PimProductId , ZPA.AttributeCode,ZPAVL.AttributeValue ,
					JSON_MODIFY(
					JSON_MODIFY (Json_Query( ZPAX.AttributeJSON  ) , '$.AttributeValues' ,  ISNULL(ZPAVL.AttributeValue,'') )    
					,'$.SelectValues',Json_Query('[]'))   
					AS 'AttributeEntity', 
				 ZPAVL.LocaleId
		  FROM ZnodePimAttributeValue PPCP
		  INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = PPCP.PimAttributeId)
		  INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON (PPCP.PimAttributeValueId =ZPAVL.PimAttributeValueId)
		  INNER JOIN ZnodePimAttributeJSON ZPAX ON (ZPAX.PimAttributeId = ZPA.PimAttributeId AND ZPAX.LocaleId = ZPAVL.LocaleId)
		  WHERE EXISTS(SELECT * FROM #ZnodePublishCategoryProduct PPCP1  WHERE PPCP1.PimProductId = PPCP.PimProductId)--(PPCP1.PimAttributeValueId =PPCP.PimAttributeValueId) AND (ZPA.PimAttributeId = PPCP1.PimAttributeId))
		  AND NOT EXISTS(SELECT * FROM #AttributeValueLocale AVL WHERE PPCP.PimProductId = AVL.PimProductId AND ZPA.AttributeCode = AVL.AttributeCode AND ZPAVL.LocaleId = AVL.LocaleId )
		  AND NOT EXISTS(SELECT * FROM ZnodePimConfigureProductAttribute UOP WHERE ZPAX.PimAttributeId = UOP.PimAttributeId AND PPCP.PimProductId = UOP.PimProductId )

		  ----Getting product attribute value entity getting for other locale with default attribute json
		  INSERT INTO #AttributeValueLocale ( PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId )
		  SELECT PPCP.PimProductId , ZPA.AttributeCode,ZPAVL.AttributeValue ,
					JSON_MODIFY(
					JSON_MODIFY (Json_Query( ZPAX.AttributeJSON  ) , '$.AttributeValues' ,  ISNULL(ZPAVL.AttributeValue,'') )    
					,'$.SelectValues',Json_Query('[]'))   
					AS 'AttributeEntity', 
				 ZPAVL.LocaleId
		  FROM ZnodePimAttributeValue PPCP
		  INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = PPCP.PimAttributeId)
		  INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON (PPCP.PimAttributeValueId =ZPAVL.PimAttributeValueId)
		  INNER JOIN ZnodePimAttributeJSON ZPAX ON (ZPAX.PimAttributeId = ZPA.PimAttributeId)
		  WHERE ZPAX.LocaleId = @DefaultLocaleId AND ZPAVL.LocaleId <> @DefaultLocaleId AND
		  EXISTS(SELECT * FROM #ZnodePublishCategoryProduct PPCP1  WHERE PPCP1.PimProductId = PPCP.PimProductId)--(PPCP1.PimAttributeValueId =PPCP.PimAttributeValueId) AND (ZPA.PimAttributeId = PPCP1.PimAttributeId))
		  AND NOT EXISTS(SELECT * FROM #AttributeValueLocale AVL WHERE PPCP.PimProductId = AVL.PimProductId AND ZPA.AttributeCode = AVL.AttributeCode AND ZPAVL.LocaleId = AVL.LocaleId )
		  AND NOT EXISTS(SELECT * FROM ZnodePimConfigureProductAttribute UOP WHERE ZPAX.PimAttributeId = UOP.PimAttributeId AND PPCP.PimProductId = UOP.PimProductId )


		  IF OBJECT_ID('TEMPDB..#ZnodePublishCatalogProductDetail') IS NOT NULL
			DROP TABLE #ZnodePublishCatalogProductDetail

		  IF OBJECT_ID('TEMPDB..#ZnodePublishCatalogProductDetail1') IS NOT NULL
			DROP TABLE #ZnodePublishCatalogProductDetail1

		  IF OBJECT_ID('TEMPDB..#TBL_ProductRequiredAttribute') IS NOT NULL
			DROP TABLE #TBL_ProductRequiredAttribute

		  
		CREATE TABLE #TBL_ProductRequiredAttribute (PimProductId INT,SKU VARCHAR(600),ProductName VARCHAR(600), IsActive VARCHAR(10), LocaleId INT)

		INSERT INTO #TBL_ProductRequiredAttribute(PimProductId, LocaleId)
		SELECT DISTINCT PimProductId, LocaleId FROM #AttributeValueLocale

		UPDATE #TBL_ProductRequiredAttribute 
		SET SKU = b.AttributeValue
		FROM #TBL_ProductRequiredAttribute a
		INNER JOIN #AttributeValueLocale b ON a.PimproductId = b.PimProductId AND a.LocaleId = b.LocaleId
		WHERE b.AttributeCode = 'SKU'

		UPDATE #TBL_ProductRequiredAttribute 
		SET ProductName = b.AttributeValue
		FROM #TBL_ProductRequiredAttribute a
		INNER JOIN #AttributeValueLocale b ON a.PimproductId = b.PimProductId AND a.LocaleId = b.LocaleId
		WHERE b.AttributeCode = 'ProductName'

		UPDATE #TBL_ProductRequiredAttribute 
		SET IsActive = b.AttributeValue
		FROM #TBL_ProductRequiredAttribute a
		INNER JOIN #AttributeValueLocale b ON a.PimproductId = b.PimProductId AND a.LocaleId = b.LocaleId
		WHERE b.AttributeCode = 'IsActive'

		  CREATE INDEX IDX_#TBL_ProductRequiredAttribute_PimProductId ON #TBL_ProductRequiredAttribute(PimProductId)

		  SELECT ZPI.PublishProductId, ZPI.PublishCatalogId ,TYU.PublishCategoryId,ZPI.CatalogName,ISNULL(ZPI.PimCategoryHierarchyId,0) PimCategoryHierarchyId
					,TPAR.SKU,TPAR.ProductName,TPAR.IsActive,TYU.PublishCategoryName CategoryName,ISNULL(TYU.LocaleId,TPAR.LocaleId) as LocaleId
		   INTO #ZnodePublishCatalogProductDetail
		   FROM #ZnodePublishCategoryProduct ZPI
		   INNER JOIN #TBL_ProductRequiredAttribute TPAR ON (TPAR.PimProductId = ZPI.PimProductId )
		   LEFT JOIN ZnodePublishCategoryDetail TYU ON (TYU.PublishCategoryId = ZPI.PublishCategoryId AND TPAR.LocaleId = TYU.LocaleId )
		   GROUP BY PublishProductId, PublishCatalogId ,TYU.PublishCategoryId,CatalogName,PimCategoryHierarchyId
					,SKU,ProductName,TPAR.IsActive,PublishCategoryName, TYU.LocaleId, TPAR.LocaleId

			
			CREATE INDEX IDX_#ZnodePublishCatalogProductDetail ON #ZnodePublishCatalogProductDetail(PublishProductId,PublishCatalogId,PimCategoryHierarchyId,LocaleId)

			SELECT PublishProductId,PublishCatalogId,PimCategoryHierarchyId,SKU,ProductName,CategoryName, CatalogName, LocaleId ,IsActive
			      ,CASE WHEN PublishProductId IS NULL THEN 1 ELSE Row_Number()Over(Partition by PublishCatalogId,PublishProductId,LocaleId ORDER BY PublishProductId,PimCategoryHierarchyId,LocaleId) END  ProductIndex
			INTO #ZnodePublishCatalogProductDetail1
			FROM #ZnodePublishCatalogProductDetail


			INSERT INTO #ZnodePublishCatalogProductDetail1 (PublishProductId,PublishCatalogId,PimCategoryHierarchyId,SKU,ProductName,CategoryName, CatalogName, LocaleId ,IsActive,ProductIndex)
			SELECT PublishProductId,PublishCatalogId,PimCategoryHierarchyId,SKU,ProductName,CategoryName, CatalogName, b.Id ,IsActive,ProductIndex
			FROM #ZnodePublishCatalogProductDetail1 a
			CROSS APPLY @LocaleId b 
			WHERE NOT EXISTS(SELECT * FROM #ZnodePublishCatalogProductDetail1 c WHERE a.PublishProductId = c.PublishProductId AND b.Id = c.LocaleId  )
			AND a.LocaleId = @DefaultLocaleId 
			AND a.PublishCatalogId = @PublishCatalogId

			DELETE ZPCPD 
			FROM ZnodePublishCatalogProductDetail ZPCPD
			WHERE NOT EXISTS(SELECT * FROM #ProductLocaleWise ZPCPD1 WHERE ZPCPD.PublishProductId = ZPCPD1.PublishProductId 
			                 AND ZPCPD.LocaleId = ZPCPD1.LocaleId )  
			AND ZPCPD.PublishCatalogId = @PublishCatalogId

			DELETE ZPCPD 
			FROM ZnodePublishCatalogProductDetail ZPCPD
			WHERE EXISTS(SELECT * FROM #ZnodePublishCatalogProductDetail ZPCPD1 WHERE 
						ZPCPD.PublishProductId = ZPCPD1.PublishProductId 
			            AND ZPCPD.LocaleId = ZPCPD1.LocaleId 
						AND ISNULL(ZPCPD1.PimCategoryHierarchyId,0)  <> 0 ) AND ZPCPD.PimCategoryHierarchyId =0
			AND ZPCPD.PublishCatalogId = @PublishCatalogId
			
			----Update data ZnodePublishCatalogProductDetail 
			UPDATE TARGET
			SET  TARGET.ProductIndex	=SOURCE.ProductIndex
				,TARGET.ModifiedBy		= @UserId	
				,TARGET.ModifiedDate	= @Date
			FROM ZnodePublishCatalogProductDetail TARGET
			INNER JOIN #ZnodePublishCatalogProductDetail1 SOURCE
			ON (
		        SOURCE.PublishProductId = TARGET.PublishProductId
				AND SOURCE.PublishCatalogId = TARGET.PublishCatalogId 
				AND ISNULL(SOURCE.PimCategoryHierarchyId,0) = ISNULL(TARGET.PimCategoryHierarchyId,0)
				AND SOURCE.LocaleId = TARGET.LocaleId --@LocaleId_In
				)
			WHERE TARGET.PublishCatalogId = @PublishCatalogId

			----Update data ZnodePublishCatalogProductDetail 
			UPDATE TARGET
			SET  
				TARGET.ProductName		=SOURCE.ProductName
				,TARGET.CatalogName		=SOURCE.CatalogName
				,TARGET.IsActive		=case when SOURCE.IsActive in ('0','false') then 0 else 1 end 
				,TARGET.ModifiedBy		= @UserId	
				,TARGET.ModifiedDate	= @Date
			FROM ZnodePublishCatalogProductDetail TARGET
			INNER JOIN #ZnodePublishCatalogProductDetail1 SOURCE
			ON (
		        TARGET.SKU = SOURCE.SKU
				AND SOURCE.LocaleId = TARGET.LocaleId --@LocaleId_In
				)
			WHERE TARGET.PublishCatalogId = @PublishCatalogId

			
		----Update data ZnodePublishCatalogProductDetail 
		UPDATE TARGET
		SET  
			TARGET.CategoryName	=SOURCE.CategoryName
			,TARGET.ModifiedBy		= @UserId	
			,TARGET.ModifiedDate	= @Date
		FROM ZnodePublishCatalogProductDetail TARGET
		INNER JOIN #ZnodePublishCatalogProductDetail1 SOURCE
		ON (
		    TARGET.SKU = SOURCE.SKU
			AND SOURCE.LocaleId = TARGET.LocaleId 
			AND ISNULL(SOURCE.PimCategoryHierarchyId,0) = ISNULL(TARGET.PimCategoryHierarchyId,0)
			)
		WHERE ISNULL(TARGET.PimCategoryHierarchyId,0) <> 0
		AND TARGET.PublishCatalogId = @PublishCatalogId

		----Insert data ZnodePublishCatalogProductDetail 
		INSERT INTO ZnodePublishCatalogProductDetail
			( PublishProductId,PublishCatalogId,PimCategoryHierarchyId,SKU,ProductName,CategoryName, CatalogName,
				LocaleId ,IsActive,ProductIndex,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
		SELECT SOURCE.PublishProductId ,SOURCE.PublishCatalogId ,SOURCE.PimCategoryHierarchyId ,SOURCE.SKU ,SOURCE.ProductName
		,SOURCE.CategoryName ,SOURCE.CatalogName ,SOURCE.LocaleId ,SOURCE.IsActive ,SOURCE.ProductIndex ,@UserId ,@Date ,@UserId ,@Date
		FROM #ZnodePublishCatalogProductDetail1 SOURCE
		WHERE NOT EXISTS(SELECT * FROM ZnodePublishCatalogProductDetail TARGET WHERE SOURCE.PublishProductId = TARGET.PublishProductId
						AND SOURCE.PublishCatalogId = TARGET.PublishCatalogId 
						AND SOURCE.PimCategoryHierarchyId = TARGET.PimCategoryHierarchyId 
						AND TARGET.LocaleId = SOURCE.LocaleId )
		AND SOURCE.PublishCatalogId = @PublishCatalogId
					
		----		  
		INSERT INTO ZnodePublishCatalogProductDetail (PublishProductId,PublishCatalogId,PimCategoryHierarchyId,SKU,ProductName,CategoryName, CatalogName,
				LocaleId ,IsActive,ProductIndex,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT PublishProductId,PublishCatalogId,PimCategoryHierarchyId,SKU,ProductName,CategoryName, CatalogName,
				b.Id ,IsActive,ProductIndex,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		FROM ZnodePublishCatalogProductDetail a
		CROSS APPLY @LocaleId b 
		WHERE NOT EXISTS(SELECT * FROM ZnodePublishCatalogProductDetail c WHERE a.PublishProductId = c.PublishProductId AND b.Id = c.LocaleId  )
		AND a.LocaleId = @DefaultLocaleId
		AND a.PublishCatalogId = @PublishCatalogId

		DELETE ZPCPD FROM ZnodePublishCatalogProductDetail ZPCPD
		INNER JOIN ZnodePublishProduct ZPD ON ZPCPD.PublishProductId = ZPD.PublishProductId AND ZPCPD.PublishCatalogId = ZPD.PublishCatalogId
		INNER JOIN ZnodePublishCatalog ZPC ON ZPCPD.PublishCatalogId = ZPC.PublishCatalogId
		WHERE NOT EXISTS(SELECT * FROM ZnodePimCategoryProduct ZPCC 
			    INNER JOIN ZnodePimCategoryHierarchy ZPCH ON ZPCC.PimCategoryId = ZPCH.PimCategoryId WHERE ZPD.PimProductId = ZPCC.PimProductId AND ZPC.PimCatalogId = ZPCH.PimCatalogId AND ZPCPD.PimCategoryHierarchyId = ZPCH.PimCategoryHierarchyId)
		AND ZPCPD.PimCategoryHierarchyId <> 0
		AND ZPCPD.PublishCatalogId = @PublishCatalogId

		----Updating the SKU into table ZnodePublishCatalogProductDetail
		UPDATE ZnodePublishCatalogProductDetail 
		SET SKU = b.AttributeValue
		FROM ZnodePublishCatalogProductDetail a
		INNER JOIN ZnodePublishProduct ZPP ON a.PublishProductId = ZPP.PublishProductId
		INNER JOIN #AttributeValueLocale b ON ZPP.PimproductId = b.PimProductId AND a.LocaleId = b.LocaleId
		WHERE b.AttributeCode = 'SKU'
		AND a.PublishCatalogId = @PublishCatalogId

		----Updating the ProductName into table ZnodePublishCatalogProductDetail
		UPDATE ZnodePublishCatalogProductDetail 
		SET ProductName = b.AttributeValue
		FROM ZnodePublishCatalogProductDetail a
		INNER JOIN ZnodePublishProduct ZPP ON a.PublishProductId = ZPP.PublishProductId
		INNER JOIN #AttributeValueLocale b ON ZPP.PimproductId = b.PimProductId AND a.LocaleId = b.LocaleId
		WHERE b.AttributeCode = 'ProductName'
		AND a.PublishCatalogId = @PublishCatalogId

		----Updating the IsActive into table ZnodePublishCatalogProductDetail
		UPDATE ZnodePublishCatalogProductDetail 
		SET IsActive = b.AttributeValue
		FROM ZnodePublishCatalogProductDetail a
		INNER JOIN ZnodePublishProduct ZPP ON a.PublishProductId = ZPP.PublishProductId
		INNER JOIN #AttributeValueLocale b ON ZPP.PimproductId = b.PimProductId AND a.LocaleId = b.LocaleId
		WHERE b.AttributeCode = 'IsActive'
		AND a.PublishCatalogId = @PublishCatalogId

		---- To clean Older Hierarchies associations.
		DELETE ZPCPD
		FROM ZnodePublishCatalogProductDetail ZPCPD
		WHERE NOT EXISTS (select top 1 1 from ZnodePimCategoryHierarchy ZPCH where (ZPCPD.PimCategoryHierarchyId = ZPCH.PimCategoryHierarchyId))
		AND ISNULL(ZPCPD.PimCategoryHierarchyId,0) <>0

		SELECT a.PimProductId,  a.PimAttributeId
		INTO #PimProductAttributeDefaultValue
		FROM ZnodePimAttributeValue a 
		INNER JOIN ZnodePimProductAttributeDefaultValue b ON a.PimAttributeValueId = b.PimAttributeValueId 

		CREATE INDEX Idx_#PimProductAttributeDefaultValue ON #PimProductAttributeDefaultValue (PimProductId,PimAttributeId)

		INSERT INTO #PimDefaultValueLocale
		SELECT PimAttributeDefaultJsonId,PimAttributeDefaultValueId,LocaleId ,DefaultValueJson
		FROM ZnodePimAttributeDefaultJSON

		SELECT  AA.DefaultValueJson , ZPADV.PimAttributeValueId, AA.LocaleId 
		INTO #PimAttributeDefaultXML
		FROM ZnodePimAttributeDefaultJSON AA 
		INNER JOIN #PimDefaultValueLocale GH ON (GH.PimAttributeDefaultJsonId = AA.PimAttributeDefaultJsonId AND AA.LocaleId = GH.LocaleId)
		INNER JOIN ZnodePimProductAttributeDefaultValue ZPADV ON ( ZPADV.PimAttributeDefaultValueId = AA.PimAttributeDefaultValueId AND AA.LocaleId = ZPADV.LocaleId)

		--To get the data localwise
		INSERT INTO #PimAttributeDefaultXML (DefaultValueJson, PimAttributeValueId, LocaleId)
		SELECT A.DefaultValueJson , A.PimAttributeValueId,b.id FROM #PimAttributeDefaultXML A CROSS APPLY  @LocaleId b  
		WHERE NOT EXISTS ( SELECT * FROM #PimAttributeDefaultXML c WHERE a.PimAttributeValueId  = c.PimAttributeValueId AND c.LocaleId = b.Id )
		AND b.Id <> @DefaultLocaleId

		----Getting child facets for merging		  
		SELECT DISTINCT ZPPADV.PimAttributeDefaultValueId, ZPAV_Parent.PimAttributeValueId, ZPPADV.LocaleId
		INTO #PimChildProductFacets
		FROM ZnodePimAttributeValue ZPAV_Parent
		INNER JOIN ZnodePimProductTypeAssociation ZPPTA ON ZPAV_Parent.PimProductId = ZPPTA.PimParentProductId
		INNER JOIN ZnodePimAttributeValue ZPAV_Child ON ZPPTA.PimProductId = ZPAV_Child.PimProductId AND ZPAV_Parent.PimAttributeId = ZPAV_Child.PimAttributeId
		INNER JOIN ZnodePimProductAttributeDefaultValue ZPPADV ON ZPAV_Child.PimAttributeValueId = ZPPADV.PimAttributeValueId 
		WHERE EXISTS(SELECT * FROM ZnodePimFrontendProperties ZPFP WHERE ZPAV_Parent.PimAttributeId = ZPFP.PimAttributeId AND ZPFP.IsFacets = 1)
		AND EXISTS(SELECT * FROM #ZnodePublishCategoryProduct ZPPC WHERE ZPAV_Parent.PimProductId = ZPPC.PimProductId )
		AND NOT EXISTS(SELECT * FROM ZnodePimProductAttributeDefaultValue ZPPADV1 WHERE ZPAV_Parent.PimAttributeValueId = ZPPADV1.PimAttributeValueId 
		                AND ZPPADV1.PimAttributeDefaultValueId = ZPPADV.PimAttributeDefaultValueId )

		----Merging childs facet attribute Default value XML for parent
		INSERT INTO #PimAttributeDefaultXML (DefaultValueJson, PimAttributeValueId, LocaleId)
		SELECT ZPADX.DefaultValueJson, ZPPADV.PimAttributeValueId, ZPPADV.LocaleId
		FROM #PimChildProductFacets ZPPADV		  
		INNER JOIN ZnodePimAttributeDefaultJSON ZPADX ON ( ZPPADV.PimAttributeDefaultValueId = ZPADX.PimAttributeDefaultValueId AND ZPPADV.LocaleId = ZPADX.LocaleId)

		CREATE INDEX Idx_#PimDefaultValueLocale ON #PimDefaultValueLocale(PimAttributeDefaultJsonId,LocaleId)

		CREATE INDEX Idx_#PimAttributeDefaultXML ON #PimAttributeDefaultXML(PimAttributeValueId,LocaleId)
		INCLUDE (DefaultValueJson)

		----Getting default attribute value entity
		INSERT INTO #AttributeValueLocale
		
		SELECT PPCP.PimProductId, PPCP.AttributeCode,'' AttributeValue,
		JSON_MODIFY (JSON_MODIFY (ZPAX.AttributeJson,'$.AttributeValues',''), '$.SelectValues',
			
				ISNULL((SELECT 
							ISNULL(JSON_VALUE(DefaultValueJson, '$.Code'),'') Code 
							,ISNULL(JSON_VALUE(DefaultValueJson, '$.LocaleId'),0) LocaleId
							,ISNULL(JSON_VALUE(DefaultValueJson, '$.Value'),'') Value
							,ISNULL(JSON_VALUE(DefaultValueJson, '$.AttributeDefaultValue'),'') AttributeDefaultValue
							,ISNULL(JSON_VALUE(DefaultValueJson, '$.DisplayOrder'),0) DisplayOrder
							,ISNULL(JSON_VALUE(DefaultValueJson, '$.IsEditable'),'false') IsEditable
							,ISNULL(JSON_VALUE(DefaultValueJson, '$.SwatchText'),'') SwatchText
							,ISNULL(JSON_VALUE(DefaultValueJson, '$.Path'),'') Path
					FROM #PimAttributeDefaultXML aa
					WHERE (aa.PimAttributeValueId = PPCP.PimAttributeValueId AND AA.LocaleId = ZPAX.LocaleId ) For JSON Auto 
				),'[]') 
				) 
			 AttributeEntity 
		 , ZPAX.LocaleId
		 FROM #ZnodePublishCategoryProduct PPCP 
		 INNER JOIN ZnodePimAttributeJSON ZPAX ON (ZPAX.PimAttributeId = PPCP.PimAttributeId)
		 WHERE 
		 NOT EXISTS(SELECT * FROM #AttributeValueLocale AVL WHERE PPCP.PimProductId = AVL.PimProductId AND PPCP.AttributeCode = AVL.AttributeCode AND ZPAX.LocaleId = AVL.LocaleId )
		 AND EXISTS(SELECT * FROM #PimProductAttributeDefaultValue a  WHERE PPCP.PimProductId = a.PimProductId AND ZPAX.PimAttributeId = a.PimAttributeId )
		 AND EXISTS(SELECT * FROM ZnodePimAttributeValue a INNER JOIN ZnodePimProductAttributeDefaultValue b ON a.PimAttributeValueId = b.PimAttributeValueId 
		            AND PPCP.PimProductId = a.PimProductId AND ZPAX.PimAttributeId = a.PimAttributeId )
		 AND NOT EXISTS(SELECT * FROM ZnodePimConfigureProductAttribute UOP WHERE ZPAX.PimAttributeId = UOP.PimAttributeId AND PPCP.PimProductId = UOP.PimProductId )

		 
		 ----Getting text attribute value entity
		 INSERT INTO #AttributeValueLocale ( PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId )
		 SELECT PPCP.PimProductId , ZPA.AttributeCode,'' AttributeValue ,
		 JSON_MODIFY (JSON_MODIFY (Json_Query( ZPAX.AttributeJSON  ) , '$.AttributeValues' ,  ISNULL(ZPAVL.AttributeValue,'') ) ,'$.SelectValues',Json_Query('[]'))
		    AS 'AttributeEntity', 
		 ZPAVL.LocaleId
		 FROM ZnodePimAttributeValue PPCP
		 INNER JOIN ZnodePimProductAttributeTextAreaValue ZPAVL ON (PPCP.PimAttributeValueId =ZPAVL.PimAttributeValueId)
		 INNER JOIN ZnodePimAttributeJSON ZPAX ON (ZPAX.PimAttributeId = PPCP.PimAttributeId AND ZPAX.LocaleId = ZPAVL.LocaleId)
		 INNER JOIN ZnodePimAttribute ZPA ON PPCP.PimAttributeId = ZPA.PimAttributeId
	     WHERE EXISTS(SELECT * FROM #ZnodePublishCategoryProduct PPCP1 WHERE PPCP1.PimProductId = PPCP.PimProductId) --(PPCP1.PimAttributeValueId =ZPAVL.PimAttributeValueId) AND (ZPAX.PimAttributeId = PPCP1.PimAttributeId))
		 AND NOT EXISTS(SELECT * FROM #AttributeValueLocale AVL WHERE PPCP.PimProductId = AVL.PimProductId AND ZPA.AttributeCode = AVL.AttributeCode AND ZPAVL.LocaleId = AVL.LocaleId )
		group by PPCP.PimProductId , ZPA.AttributeCode,ZPAX.AttributeJson,ZPAVL.LocaleId,ZPAVL.AttributeValue

		 ----Getting custome field value entity
		 INSERT INTO #AttributeValueLocale ( PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId )
 		 SELECT ZPCFX.PimProductId , ZPCFX.CustomCode, '' AttributeValue ,
		 JSON_MODIFY (Json_Query( ZPCFX.CustomeFiledJson) ,'$.SelectValues',Json_Query('[]')) 
		 AttributeEntity, 
		 ZPCFX.LocaleId
		 FROM ZnodePimCustomeFieldJSON ZPCFX 
		 WHERE EXISTS(SELECT * FROM #ZnodePublishCategoryProduct PPCP WHERE (PPCP.PimProductId = ZPCFX.PimProductId ))
		 AND NOT EXISTS(SELECT * FROM #AttributeValueLocale AVL WHERE ZPCFX.PimProductId = AVL.PimProductId AND ZPCFX.CustomCode = AVL.AttributeCode AND ZPCFX.LocaleId = AVL.LocaleId )
		 group by ZPCFX.PimProductId , ZPCFX.CustomCode, ZPCFX.CustomeFiledJson , ZPCFX.LocaleId

		  ----Getting image attribute value entity
		 INSERT INTO #AttributeValueLocale ( PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId )
		 SELECT PPCP.PimProductId, ZPA.AttributeCode,'' AttributeValue,
		 JSON_MODIFY (JSON_MODIFY (Json_Query( ZPAX.AttributeJSON  ) , '$.AttributeValues',  
		 ISNULL((SELECT stuff( (SELECT ','+ZPPAM.MediaPath FROM ZnodePimProductAttributeMedia ZPPAM WHERE (ZPPAM.PimAttributeValueId = PPCP.PimAttributeValueId)
				 FOR XML PATH(''),Type).value('.', 'varchar(max)'), 1, 1, '')
				 
				 ),'') ) ,'$.SelectValues',Json_Query('[]'))   
				 AS 'AttributeEntity', 
				 ZPAX.LocaleId
		 FROM ZnodePimAttributeValue PPCP 
		 INNER JOIN ZnodePimAttributeJSON ZPAX ON (ZPAX.PimAttributeId = PPCP.PimAttributeId)
		 INNER JOIN ZnodePimAttribute ZPA ON ZPA.PimAttributeId = PPCP.PimAttributeId
		 WHERE NOT EXISTS(SELECT * FROM #AttributeValueLocale AVL WHERE PPCP.PimProductId = AVL.PimProductId AND ZPA.AttributeCode = AVL.AttributeCode AND ZPAX.LocaleId = AVL.LocaleId )
		 AND EXISTS(SELECT * FROM ZnodePimProductAttributeMedia b WHERE PPCP.PimAttributeValueId = b.PimAttributeValueId )
		 AND EXISTS(SELECT * FROM #ZnodePublishCategoryProduct PPCP1 WHERE PPCP.PimProductId = PPCP1.PimProductId )
		 AND NOT EXISTS(SELECT * FROM ZnodePimConfigureProductAttribute UOP WHERE ZPAX.PimAttributeId = UOP.PimAttributeId AND PPCP.PimProductId = UOP.PimProductId )

		 -------------configurable attribute 		 
		
		INSERT INTO #AttributeValueLocale ( PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId )
		SELECT DISTINCT UOP.PimProductId,c.AttributeCode,'' AttributeValue ,--'<Attributes><AttributeEntity>'+
		JSON_MODIFY (ISNULL(JSON_MODIFY (c.AttributeJson,'$.AttributeValues',''),'')  ,'$.SelectValues',
			ISNULL((SELECT DISTINCT 
							ISNULL(JSON_VALUE(AA.DefaultValueJson, '$.Code'),'') Code 
							,ISNULL(JSON_VALUE(AA.DefaultValueJson, '$.LocaleId'),0) LocaleId
							,ISNULL(JSON_VALUE(AA.DefaultValueJson, '$.Value'),'') Value
							,ISNULL(JSON_VALUE(AA.DefaultValueJson, '$.AttributeDefaultValue'),'') AttributeDefaultValue
							,ISNULL(JSON_VALUE(AA.DefaultValueJson, '$.DisplayOrder'),0) DisplayOrder
							,ISNULL(JSON_VALUE(AA.DefaultValueJson, '$.IsEditable'),'false') IsEditable
							,ISNULL(JSON_VALUE(AA.DefaultValueJson, '$.SwatchText'),'') SwatchText
							,ISNULL(JSON_VALUE(AA.DefaultValueJson, '$.Path'),'') Path 
							,ISNULL(ZPA.DisplayOrder,0)  AS VariantDisplayOrder 
							,ISNULL(ZPAVL_SKU.AttributeValue,'')   AS VariantSKU 
							,ISNULL(ZM.Path,'') AS VariantImagePath 
						 FROM ZnodePimAttributeDefaultJSON AA 
						 INNER JOIN ZnodePimProductAttributeDefaultValue ZPADV ON ( ZPADV.PimAttributeDefaultValueId = AA.PimAttributeDefaultValueId )
						 INNER JOIN ZnodePimAttributeValue ZPAV1 ON (ZPAV1.PimAttributeValueId= ZPADV.PimAttributeValueId )
						 -- check/join for active variants 
						 INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimProductId =ZPAV1.PimProductId)
						 INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON (ZPAV.PimAttributevalueid = ZPAVL.PimAttributeValueId AND ZPAVL.AttributeValue = 'True')
						 INNER JOIN ZnodePimProductTypeAssociation YUP ON (YUP.PimProductId = ZPAV1.PimProductId)
						 -- SKU
						 INNER JOIN ZnodePimAttributeValue ZPAV_SKU ON(YUP.PimProductId = ZPAV_SKU.PimProductId)
						 INNER JOIN ZnodePimAttributeValueLocale ZPAVL_SKU ON (ZPAVL_SKU.PimAttributeValueId = ZPAV_SKU.PimAttributeValueId)
						 LEFT JOIN ZnodePimAttributeValue ZPAV12 ON (ZPAV12.PimProductId= YUP.PimProductId  AND ZPAV12.PimAttributeId = @PimMediaAttributeId ) 
						 LEFT JOIN ZnodePimProductAttributeMedia ZPAVM ON (ZPAVM.PimAttributeValueId= ZPAV12.PimAttributeValueId ) 
						 LEFT JOIN ZnodeMedia ZM ON (ZM.MediaId = ZPAVM.MediaId)
						 LEFT JOIN ZnodePimAttribute ZPA ON (ZPA.PimattributeId = ZPAV1.PimAttributeId)
						 WHERE (YUP.PimParentProductId  = UOP.PimProductId AND ZPAV1.pimAttributeId = UOP.PimAttributeId )
						 -- Active Variants
						 AND ZPAV.PimAttributeId = (SELECT TOP 1 PimAttributeId FROM ZnodePimAttribute WHERE AttributeCode = 'IsActive')
						 -- VariantSKU
						 AND ZPAV_SKU.PimAttributeId = (SELECT PimAttributeId FROM ZnodePimAttribute WHERE AttributeCode = 'SKU')
		FOR JSON auto),'[]')) SelectValuesEntity ,
		c.LocaleId
		FROM ZnodePimConfigureProductAttribute UOP 
		INNER JOIN ZnodePimAttributeJSON c   ON (c.PimAttributeId = UOP.PimAttributeId )
		WHERE  EXISTS(SELECT * FROM #ZnodePublishCategoryProduct PPCP1 WHERE UOP.PimProductId = PPCP1.PimProductId )

		-------------configurable attribute 

		CREATE INDEX IDX_#AttributeValueLocale ON #AttributeValueLocale(PimProductId,AttributeCode,LocaleId)
		CREATE INDEX IDX_#AttributeValueLocale_Id ON #AttributeValueLocale(ID)
		 	
		DELETE ZPPAX FROM ZnodePublishProductAttributeJson ZPPAX
		WHERE exists (SELECT * FROM #AttributeValueLocale AVL WHERE ZPPAX.PimProductId = AVL.PimProductId AND AVL.LocaleId = ZPPAX.LocaleId )
		AND NOT EXISTS(SELECT * FROM #AttributeValueLocale AVL WHERE ZPPAX.PimProductId = AVL.PimProductId AND AVL.LocaleId = ZPPAX.LocaleId AND ZPPAX.AttributeCode = AVL.AttributeCode )

		DECLARE @MaxCount INT, @MinRow INT, @MaxRow INT, @Rows numeric(10,2);
		SELECT @MaxCount = COUNT(*) FROM #AttributeValueLocale;

		SELECT @Rows = 200000
        
		SELECT @MaxCount = CEILING(@MaxCount / @Rows);

		IF OBJECT_ID('tempdb..#Temp_ImportLoop') IS NOT NULL
            DROP TABLE #Temp_ImportLoop;
        
		---- To get the min AND max rows for import in loop
		;WITH cte AS 
		(
			SELECT RowId = 1, 
				   MinRow = 1, 
                   MaxRow = cast(@Rows as int)
            UNION ALL
            SELECT RowId + 1, 
                   MinRow + cast(@Rows as int), 
                   MaxRow + cast(@Rows as int)
            FROM cte
            WHERE RowId + 1 <= @MaxCount
		)
        SELECT RowId, MinRow, MaxRow
        INTO #Temp_ImportLoop
        FROM cte
		OPTION (maxrecursion 0);

		--Cursor for rows wise execution in bulk
		DECLARE cur_BulkData CURSOR LOCAL FAST_FORWARD
        FOR SELECT MinRow, MaxRow FROM #Temp_ImportLoop
		WHERE EXISTS(SELECT * FROM #AttributeValueLocale);

        OPEN cur_BulkData;
        FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow;

        WHILE @@FETCH_STATUS = 0
        BEGIN
	         UPDATE ZnodePublishProductAttributeJson SET IsUpdateLocaleWise = 0 WHERE ISNULL(IsUpdateLocaleWise,0) = 1
			  ----Update Product Attribute XML
			 UPDATE ZPPAX SET ZPPAX.Attributes = AVL.AttributeEntity, ZPPAX.ModifiedBy = @UserId, ZPPAX.ModifiedDate = GETDATE() 
			        , ZPPAX.IsUpdateLocaleWise = 0
			 FROM ZnodePublishProductAttributeJson ZPPAX 
			 INNER JOIN #AttributeValueLocale AVL ON ZPPAX.PimProductId = AVL.PimProductId AND AVL.LocaleId = ZPPAX.LocaleId AND ZPPAX.AttributeCode = AVL.AttributeCode 
			 WHERE  AVL.Id BETWEEN @MinRow AND @MaxRow AND AVL.AttributeEntity is not null
		 
			 ----Insert Product Attribute XML
			 INSERT INTO ZnodePublishProductAttributeJson(PimProductId,LocaleId,AttributeCode,Attributes,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			 SELECT AVL.PimProductId, AVL.LocaleId, AVL.AttributeCode, cast(AVL.AttributeEntity as varchar(max)), @UserId CreatedBy, GETDATE() CreatedDate, @UserId ModifiedBy, GETDATE() ModifiedDate
			 FROM #AttributeValueLocale AVL
			 WHERE NOT EXISTS(SELECT * FROM ZnodePublishProductAttributeJson ZPPAX WHERE AVL.PimProductId = ZPPAX.PimProductId AND  AVL.LocaleId = ZPPAX.LocaleId AND AVL.AttributeCode = ZPPAX.AttributeCode )
			 AND  AVL.Id BETWEEN @MinRow AND @MaxRow AND AVL.AttributeEntity is not null
			 GROUP BY AVL.PimProductId, AVL.AttributeEntity, AVL.LocaleId, AVL.AttributeCode

			 FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow;
        END;
		CLOSE cur_BulkData;
		DEALLOCATE cur_BulkData;

		DELETE ZPPAX
		FROM ZnodePublishProductAttributeJson ZPPAX
		WHERE LocaleId <> @DefaultLocaleId
		AND exists( SELECT * FROM ZnodePublishProductAttributeJson ZPPAX1 WHERE ZPPAX.AttributeCode = ZPPAX1.AttributeCode AND ZPPAX.PimProductId = ZPPAX1.PimProductId )
		AND NOT EXISTS(SELECT * FROM #ProductLocaleWise AVL WHERE AVL.PimProductId = ZPPAX.PimProductId AND  AVL.LocaleId = ZPPAX.LocaleId )
		
		
		DELETE  ZPPAX
		FROM ZnodePublishProductAttributeJson ZPPAX
		WHERE NOT EXISTS(SELECT * FROM #ProductLocaleWise ZLW WHERE ZPPAX.PimProductId = ZLW.PimProductId 
			                AND ZPPAX.LocaleId = ZLW.LocaleId )

		SELECT PimProductId,Attributes Attributes,AttributeCode
		INTO #ZnodePublishProductAttributeJson
		FROM ZnodePublishProductAttributeJson 
		WHERE LocaleId = @DefaultLocaleId

		INSERT INTO ZnodePublishProductAttributeJson (PimProductId,Attributes,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AttributeCode)
		SELECT PimProductId,Attributes,b.id,@UserId,GETDATE(),@UserId,GETDATE(),AttributeCode
		FROM #ZnodePublishProductAttributeJson a
		CROSS APPLY @LocaleId b 
		WHERE NOT EXISTS(SELECT * FROM ZnodePublishProductAttributeJson c WHERE a.PimProductId = c.PimProductId AND b.Id = c.LocaleId AND a.AttributeCode = c.AttributeCode )
		AND b.Id <> @DefaultLocaleId
					  
END TRY
BEGIN CATCH
    DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertUpdatePimCatalogProductDetailJson @PublishCatalogId = '+CAST(@PublishCatalogId AS VARCHAR(200))+',@UserId='+CAST(@UserId AS VARCHAR(200));


    EXEC Znode_InsertProcedureErrorLog
        @ProcedureName = 'Znode_InsertUpdatePimCatalogProductDetailJson',
        @ErrorInProcedure = @Error_procedure,
        @ErrorMessage = @ErrorMessage,
        @ErrorLine = @ErrorLine,
        @ErrorCall = @ErrorCall;
            
            
END CATCH;
END

GO

INSERT INTO ZnodeEmailTemplate(TemplateName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 'ProductKeyOrderReceipt',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeEmailTemplate WHERE TemplateName = 'ProductKeyOrderReceipt' )

INSERT INTO ZnodeEmailTemplateAreas(Name,Code,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 'ProductKeyOrderReceipt','ProductKeyOrderReceipt',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeEmailTemplateAreas WHERE name = 'ProductKeyOrderReceipt' )

INSERT INTO ZnodeEmailTemplateLocale(EmailTemplateId,Subject,Descriptions,Content,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (SELECT TOP 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName = 'ProductKeyOrderReceipt' ),
'Product Key Order Receipt','ProductKeyOrderReceipt','<!DOCTYPE html><html><body><div style="padding: 10px;">  <div>  <div style="font-family: Arial, Helvetica; font-size: 10px; text-align: left; color: #292a2a; border: solid 1px #c3c3c3; margin-top: 10px;">  <div style="background-color: #212529; color: #ffffff; font-size: 1.5em; font-weight: bold; padding: .5em; border-bottom: solid 1px #c3c3c3;"><strong><span style="font-family: Roboto, Arial, sans-serif;">Please use following keys to activate&nbsp;your&nbsp;product</span></strong></div>  <div style="padding: 10px;">  <div style="font-family: Verdana; color: #333333; font-size: 11px;">&nbsp;</div>  <div data-info="#AddressItems#">  <table width="100%" cellspacing="0" cellpadding="3">  <tbody>  <tr style="height: 12px; background-color: #eff3fb;">  <td style="padding: 0px 5px; border: 1px solid silver; height: 12px; color: #333333; font-family: Verdana, Helvetica, sans-serif; font-size: 10px;"><strong>SKU</strong></td>  <td style="padding: 0px 5px; border: 1px solid silver; height: 12px; color: #333333; font-family: Verdana, Helvetica, sans-serif; font-size: 10px;"><strong>Item</strong></td>  <td style="padding: 0px 5px; border: 1px solid silver; height: 12px; color: #333333; font-family: Verdana, Helvetica, sans-serif; font-size: 10px;"><strong>Key</strong></td>  </tr>  <tr id="#DownloadableProductKey#" style="height: 12.63px;">  <td style="padding: 0px 5px; border: 1px solid silver; height: 12.63px; color: #333333; font-family: Verdana, Helvetica, sans-serif; font-size: 10px;" align="left" width="10%">#SKU#&nbsp;</td>  <td style="padding: 0px 5px; border: 1px solid silver; height: 12.63px; color: #333333; font-family: Verdana, Helvetica, sans-serif; font-size: 10px;" align="left" width="25%">#Name#</td>  <td style="padding: 0px 5px; border: 1px solid silver; height: 12.63px; color: #333333; font-family: Verdana, Helvetica, sans-serif; font-size: 10px;" align="left" width="25%">#Keys#&nbsp;</td>  </tr>  </tbody>  </table>  </div>  </div>  </div>  </div>  </div></body></html>',
1,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeEmailTemplateLocale WHERE EmailTemplateId = (SELECT TOP 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName = 'ProductKeyOrderReceipt' )
AND LocaleId = 1 )

INSERT INTO ZnodeEmailTemplateMapper(EmailTemplateId,PortalId,EmailTemplateAreasId,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsEnableBcc)
SELECT (SELECT TOP 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName = 'ProductKeyOrderReceipt' ), PortalId,
(SELECT TOP 1 EmailTemplateAreasId FROM ZnodeEmailTemplateAreas WHERE Name = 'ProductKeyOrderReceipt'),1,2,GETDATE(),2,GETDATE(),0
FROM ZnodePortal zp
WHERE NOT EXISTS(SELECT * FROM ZnodeEmailTemplateMapper ZETM WHERE ZETM.EmailTemplateId = (SELECT TOP 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName = 'ProductKeyOrderReceipt' )
	AND ZETM.PortalId = zp.PortalId AND EmailTemplateAreasId = (SELECT TOP 1 EmailTemplateAreasId FROM ZnodeEmailTemplateAreas WHERE Name = 'ProductKeyOrderReceipt'))

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportInsertUpdateWidgetGlobalAttributeValue')
	DROP PROC Znode_ImportInsertUpdateWidgetGlobalAttributeValue
GO

CREATE PROCEDURE [dbo].[Znode_ImportInsertUpdateWidgetGlobalAttributeValue]
(
    @GlobalEntityValueDetail  [GlobalEntityValueDetail] READONLY,
    @UserId            INT       ,
    @status            BIT    OUT,
    @IsNotReturnOutput BIT    = 0 
)
AS
     BEGIN
         BEGIN TRAN A;
         BEGIN TRY
			 DECLARE @GlobalEntityId INT,
			  @MultiSelectGroupAttributeTypeName nvarchar(200)='Select'
			 ,@MediaGroupAttributeTypeName nvarchar(200)='Media'
             DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
			 declare  @CMSContentWidgetId int
			 declare  @CMSWidgetProfileVariantId int
			 DECLARE @TBL_Widget TABLE (CMSWidgetProfileVariantId [int] NULL)
			 DECLARE @TBL_DeleteUser TABLE (CMSWidgetProfileVariantId [int] NULL,WidgetGlobalAttributeValueId int, LocaleId int)
			 DECLARE @TBL_AttributeDefaultValueList TABLE 
			   (NewWidgetGlobalAttributeValueId int,WidgetGlobalAttributeValueId int,[AttributeValue] [varchar](300),[GlobalAttributeDefaultValueId] int,
			   [GlobalAttributeId] int,MediaId int,WidgetGlobalAttributeValueLocaleId int,LocaleId int)


			 DECLARE @TBL_MediaValueList TABLE 
			   (NewWidgetGlobalAttributeValueId int,WidgetGlobalAttributeValueId int,GlobalAttributeId int,
			   MediaId int,MediaPath nvarchar(300),WidgetGlobalAttributeValueLocaleId int,LocaleId int)


		 	 DECLARE @TBL_GlobalEntityValueDetail TABLE ([GlobalAttributeId] [int] NULL,
				[AttributeCode] [varchar](300),[GlobalAttributeDefaultValueId] [int],[GlobalAttributeValueId] [int],
				[LocaleId] [int],CMSWidgetProfileVariantId [int], [AttributeValue] [nvarchar](max),WidgetGlobalAttributeValueId int,
				NewWidgetGlobalAttributeValueId int,GroupAttributeTypeName [varchar](300))
				
				SELECT TOP 1 @CMSWidgetProfileVariantId = GlobalEntityValueId FROM @GlobalEntityValueDetail;

				 Select @CMSContentWidgetId = CCW.CMSContentContainerId from ZnodeCMSContentContainer CCW
				 inner join ZnodeCMSContainerProfileVariant CWPV  on CCW.CMSContentContainerId = CWPV.CMSContentContainerId
				 Where CWPV.CMSContainerProfileVariantId = @CMSWidgetProfileVariantId

				Insert into @TBL_GlobalEntityValueDetail
				([GlobalAttributeId],[AttributeCode],[GlobalAttributeDefaultValueId],
				[GlobalAttributeValueId],[LocaleId],CMSWidgetProfileVariantId,[AttributeValue],GroupAttributeTypeName)
				Select dd.[GlobalAttributeId],dd.[AttributeCode],case when [GlobalAttributeDefaultValueId]=0 then null else 
				[GlobalAttributeDefaultValueId] end [GlobalAttributeDefaultValueId],
				case when [GlobalAttributeValueId]=0 then null else 
				[GlobalAttributeValueId] end [GlobalAttributeValueId],[LocaleId],[GlobalEntityValueId],[AttributeValue],ss.GroupAttributeType
				From @GlobalEntityValueDetail dd
				inner join [View_ZnodeGlobalAttribute] ss on ss.GlobalAttributeId=dd.GlobalAttributeId

				Update ss
				Set ss.WidgetGlobalAttributeValueId=dd.WidgetGlobalAttributeValueId
				From @TBL_GlobalEntityValueDetail ss
				inner join ZnodeWidgetGlobalAttributeValue dd on dd.CMSContainerProfileVariantId=ss.CMSWidgetProfileVariantId
				and dd.GlobalAttributeId=ss.GlobalAttributeId
				
				insert into @TBL_Widget(CMSWidgetProfileVariantId)
				Select distinct  CMSWidgetProfileVariantId from @TBL_GlobalEntityValueDetail;

                insert into @TBL_DeleteUser(CMSWidgetProfileVariantId ,WidgetGlobalAttributeValueId , LocaleId)
				Select p.CMSWidgetProfileVariantId,a.WidgetGlobalAttributeValueId, b.LocaleId
				from ZnodeWidgetGlobalAttributeValue a
				INNER JOIN ZnodeWidgetGlobalAttributeValueLocale B ON A.WidgetGlobalAttributeValueId = B.WidgetGlobalAttributeValueId
				inner join @TBL_Widget p on p.CMSWidgetProfileVariantId=a.CMSContainerProfileVariantId
				Where not exists(select 1 from @TBL_GlobalEntityValueDetail dd 
				where dd.CMSWidgetProfileVariantId=a.CMSContainerProfileVariantId and dd.GlobalAttributeId=a.GlobalAttributeId
				)
				             
				Delete From ZnodeWidgetGlobalAttributeValueLocale
				WHere exists (select 1 from @TBL_DeleteUser dd 
					Where dd.WidgetGlobalAttributeValueId=ZnodeWidgetGlobalAttributeValueLocale.WidgetGlobalAttributeValueId
					and ZnodeWidgetGlobalAttributeValueLocale.LocaleId = dd.LocaleId)
				and exists (select 1 from @TBL_GlobalEntityValueDetail dd 
					Where ZnodeWidgetGlobalAttributeValueLocale.LocaleId = dd.LocaleId)

				Delete From ZnodeWidgetGlobalAttributeValue
				WHere exists (select 1 from @TBL_DeleteUser dd 
				Where dd.WidgetGlobalAttributeValueId=ZnodeWidgetGlobalAttributeValue.WidgetGlobalAttributeValueId)
				and not exists(select * from ZnodeWidgetGlobalAttributeValueLocale where ZnodeWidgetGlobalAttributeValue.WidgetGlobalAttributeValueId = ZnodeWidgetGlobalAttributeValueLocale.WidgetGlobalAttributeValueId)
							

				INSERT INTO [dbo].[ZnodeWidgetGlobalAttributeValue]
				([CMSContentContainerId],[CMSContainerProfileVariantId],[GlobalAttributeId],[GlobalAttributeDefaultValueId],[CreatedBy],[CreatedDate],
				[ModifiedBy],[ModifiedDate])
				Select @CMSContentWidgetId,[CMSWidgetProfileVariantId],[GlobalAttributeId],[GlobalAttributeDefaultValueId]
				,@UserId [CreatedBy],@GetDate [CreatedDate],@UserId [ModifiedBy],@GetDate [ModifiedDate]
				From @TBL_GlobalEntityValueDetail dd
				WHERE WidgetGlobalAttributeValueId IS NULL		
				AND NOT EXISTS(SELECT * FROM ZnodeWidgetGlobalAttributeValue WGAV WHERE WGAV.CMSContentContainerId = @CMSContentWidgetId 
					AND WGAV.CMSContainerProfileVariantId = dd.CMSWidgetProfileVariantId AND WGAV.GlobalAttributeId = dd.GlobalAttributeId )

				Update dd
				Set dd.NewWidgetGlobalAttributeValueId=WGAV.WidgetGlobalAttributeValueId
				From @TBL_GlobalEntityValueDetail dd
				inner join [ZnodeWidgetGlobalAttributeValue] WGAV on WGAV.CMSContentContainerId = @CMSContentWidgetId 
					AND WGAV.CMSContainerProfileVariantId = dd.CMSWidgetProfileVariantId AND WGAV.GlobalAttributeId = dd.GlobalAttributeId

				INSERT INTO [dbo].[ZnodeWidgetGlobalAttributeValueLocale]
			   ([WidgetGlobalAttributeValueId],[LocaleId],[AttributeValue],[CreatedBy],[CreatedDate],[ModifiedBy]
			   ,[ModifiedDate])
				Select NewWidgetGlobalAttributeValueId,[LocaleId],[AttributeValue],@UserId [CreatedBy],@GetDate [CreatedDate],
				@UserId [ModifiedBy],@GetDate [ModifiedDate]
				From @TBL_GlobalEntityValueDetail dd
				WHERE NewWidgetGlobalAttributeValueId IS not NULL
				and isnull([AttributeValue],'') <>''    
				and isnull(GroupAttributeTypeName,'') != @MultiSelectGroupAttributeTypeName
				and isnull(GroupAttributeTypeName,'') != @MediaGroupAttributeTypeName	
				AND NOT EXISTS(SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WGAV WHERE WGAV.[WidgetGlobalAttributeValueId] = DD.NewWidgetGlobalAttributeValueId
					AND WGAV.[LocaleId] = DD.[LocaleId])
				
				Update ss
				Set ss.AttributeValue=dd.AttributeValue,ss.ModifiedDate=@GetDate,ss.ModifiedBy=@UserId
				From @TBL_GlobalEntityValueDetail dd
				inner join [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ss on ss.WidgetGlobalAttributeValueId =dd.WidgetGlobalAttributeValueId AND SS.[LocaleId] = DD.[LocaleId]
				Where isnull(GroupAttributeTypeName,'') != @MultiSelectGroupAttributeTypeName
				and isnull(GroupAttributeTypeName,'') != @MediaGroupAttributeTypeName	

				insert into @TBL_AttributeDefaultValueList
				(NewWidgetGlobalAttributeValueId,WidgetGlobalAttributeValueId,dd.AttributeValue,GlobalAttributeId,LocaleId)
				Select dd.NewWidgetGlobalAttributeValueId, dd.WidgetGlobalAttributeValueId,ss.Item,dd.GlobalAttributeId,dd.LocaleId
				From @TBL_GlobalEntityValueDetail dd
				cross apply dbo.Split(dd.AttributeValue,',') ss
				Where isnull(GroupAttributeTypeName,'') = @MultiSelectGroupAttributeTypeName

				Update dd
				Set dd.GlobalAttributeDefaultValueId=ss.GlobalAttributeDefaultValueId
				from  @TBL_AttributeDefaultValueList DD
				inner join [ZnodeGlobalAttributeDefaultValue] ss on dd.GlobalAttributeId=ss.GlobalAttributeId
				and dd.AttributeValue=ss.AttributeDefaultValueCode

				Update dd
				Set dd.WidgetGlobalAttributeValueLocaleId=ss.WidgetGlobalAttributeValueLocaleId
				from  @TBL_AttributeDefaultValueList DD
				inner join [ZnodeWidgetGlobalAttributeValueLocale] ss on dd.WidgetGlobalAttributeValueId=ss.WidgetGlobalAttributeValueId
				and ss.GlobalAttributeDefaultValueId=dd.GlobalAttributeDefaultValueId and dd.LocaleId = ss.LocaleId

				delete ss
				From @TBL_GlobalEntityValueDetail dd
				inner join [ZnodeWidgetGlobalAttributeValueLocale] ss on dd.WidgetGlobalAttributeValueId=ss.WidgetGlobalAttributeValueId
				Where isnull(GroupAttributeTypeName,'') = @MultiSelectGroupAttributeTypeName and dd.LocaleId = ss.LocaleId
				and not exists (Select 1 from @TBL_AttributeDefaultValueList cc 
				where cc.WidgetGlobalAttributeValueLocaleId=ss.WidgetGlobalAttributeValueLocaleId )
				and exists(select * from @TBL_GlobalEntityValueDetail dd1 where dd1.LocaleId = ss.LocaleId)

				INSERT INTO [dbo].[ZnodeWidgetGlobalAttributeValueLocale]
			   ([WidgetGlobalAttributeValueId],[LocaleId],GlobalAttributeDefaultValueId,[CreatedBy],[CreatedDate],[ModifiedBy]
			   ,[ModifiedDate])
				Select ss.NewWidgetGlobalAttributeValueId,dd.[LocaleId],ss.GlobalAttributeDefaultValueId,@UserId [CreatedBy],@GetDate [CreatedDate],
				@UserId [ModifiedBy],@GetDate [ModifiedDate]
				From @TBL_GlobalEntityValueDetail dd
				inner join @TBL_AttributeDefaultValueList ss on dd.GlobalAttributeId=ss.GlobalAttributeId
				and ss.NewWidgetGlobalAttributeValueId=dd.NewWidgetGlobalAttributeValueId
				WHERE isnull(dd.GroupAttributeTypeName,'') = @MultiSelectGroupAttributeTypeName
				AND NOT EXISTS(SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WGAV WHERE WGAV.[WidgetGlobalAttributeValueId] = ss.NewWidgetGlobalAttributeValueId
					AND WGAV.[LocaleId] = DD.[LocaleId])

				INSERT INTO [dbo].[ZnodeWidgetGlobalAttributeValueLocale]
			   ([WidgetGlobalAttributeValueId],[LocaleId],GlobalAttributeDefaultValueId,[CreatedBy],[CreatedDate],[ModifiedBy]
			   ,[ModifiedDate])
				Select ss.WidgetGlobalAttributeValueId,dd.[LocaleId],ss.GlobalAttributeDefaultValueId,@UserId [CreatedBy],@GetDate [CreatedDate],
				@UserId [ModifiedBy],@GetDate [ModifiedDate]
				From @TBL_GlobalEntityValueDetail dd
				inner join @TBL_AttributeDefaultValueList ss on dd.GlobalAttributeId=ss.GlobalAttributeId
				and ss.WidgetGlobalAttributeValueId=dd.WidgetGlobalAttributeValueId				
				WHERE isnull(dd.GroupAttributeTypeName,'') = @MultiSelectGroupAttributeTypeName
				and ss.WidgetGlobalAttributeValueLocaleId is null 
				AND NOT EXISTS(SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WGAV WHERE WGAV.[WidgetGlobalAttributeValueId] = ss.WidgetGlobalAttributeValueId
					AND WGAV.[LocaleId] = DD.[LocaleId])


				insert into @TBL_MediaValueList
				(NewWidgetGlobalAttributeValueId,WidgetGlobalAttributeValueId,GlobalAttributeId,MediaId,LocaleId)
				Select dd.NewWidgetGlobalAttributeValueId, dd.WidgetGlobalAttributeValueId,GlobalAttributeId,Case when ss.Item = 0 then null else ss.Item end,dd.LocaleId
				From @TBL_GlobalEntityValueDetail dd
				cross apply dbo.Split(dd.AttributeValue,',') ss
				Where isnull(GroupAttributeTypeName,'') = @MediaGroupAttributeTypeName

				Update dd
				Set dd.MediaPath=ss.Path
				from  @TBL_MediaValueList DD
				inner join ZnodeMedia ss on dd.MediaId=ss.MediaId

				Update dd
				Set dd.WidgetGlobalAttributeValueLocaleId=ss.WidgetGlobalAttributeValueLocaleId
				from  @TBL_MediaValueList DD
				inner join [ZnodeWidgetGlobalAttributeValueLocale] ss on dd.WidgetGlobalAttributeValueId=ss.WidgetGlobalAttributeValueId
				and ss.MediaId=dd.MediaId and dd.LocaleId = ss.LocaleId

				delete ss
				From @TBL_GlobalEntityValueDetail dd
				inner join [ZnodeWidgetGlobalAttributeValueLocale] ss on dd.WidgetGlobalAttributeValueId=ss.WidgetGlobalAttributeValueId and ss.GlobalAttributeDefaultValueId = dd.GlobalAttributeDefaultValueId
				Where isnull(GroupAttributeTypeName,'') = @MediaGroupAttributeTypeName
				and not exists (Select 1 from @TBL_MediaValueList cc 
					where cc.MediaId=ss.MediaId and dd.LocaleId = cc.LocaleId
					and cc.WidgetGlobalAttributeValueId=dd.WidgetGlobalAttributeValueId )
				and exists(select * from @TBL_GlobalEntityValueDetail dd1 where dd1.LocaleId = ss.LocaleId)

				INSERT INTO [dbo].[ZnodeWidgetGlobalAttributeValueLocale]
			   ([WidgetGlobalAttributeValueId],[LocaleId],MediaId,MediaPath,[CreatedBy],[CreatedDate],[ModifiedBy]
			   ,[ModifiedDate])
				Select ss.NewWidgetGlobalAttributeValueId,dd.[LocaleId],ss.MediaId,ss.MediaPath,@UserId [CreatedBy],@GetDate [CreatedDate],
				@UserId [ModifiedBy],@GetDate [ModifiedDate]
				From @TBL_GlobalEntityValueDetail dd
				inner join @TBL_MediaValueList ss on dd.GlobalAttributeId=ss.GlobalAttributeId
				and ss.NewWidgetGlobalAttributeValueId=dd.NewWidgetGlobalAttributeValueId
				WHERE isnull(dd.GroupAttributeTypeName,'') = @MediaGroupAttributeTypeName
				AND NOT EXISTS(SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WGAV WHERE WGAV.[WidgetGlobalAttributeValueId] = ss.NewWidgetGlobalAttributeValueId
					AND WGAV.[LocaleId] = DD.[LocaleId])

				INSERT INTO [dbo].[ZnodeWidgetGlobalAttributeValueLocale]
			   ([WidgetGlobalAttributeValueId],[LocaleId],MediaId,MediaPath,[CreatedBy],[CreatedDate],[ModifiedBy]
			   ,[ModifiedDate])
				Select ss.WidgetGlobalAttributeValueId,dd.[LocaleId],ss.MediaId,ss.MediaPath,@UserId [CreatedBy],@GetDate [CreatedDate],
				@UserId [ModifiedBy],@GetDate [ModifiedDate]
				From @TBL_GlobalEntityValueDetail dd
				inner join @TBL_MediaValueList ss on dd.GlobalAttributeId=ss.GlobalAttributeId
				and ss.WidgetGlobalAttributeValueId=dd.WidgetGlobalAttributeValueId				
				WHERE isnull(dd.GroupAttributeTypeName,'') = @MediaGroupAttributeTypeName
				and ss.WidgetGlobalAttributeValueLocaleId is null 
				AND NOT EXISTS(SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WGAV WHERE WGAV.[WidgetGlobalAttributeValueId] = ss.WidgetGlobalAttributeValueId
					AND WGAV.[LocaleId] = DD.[LocaleId])

				--Update dd 
				--Set dd.MediaPath=ss.MediaPath
				--from [ZnodeWidgetGlobalAttributeValueLocale] dd
    --            inner join @TBL_MediaValueList ss on 
				--ss.WidgetGlobalAttributeValueLocaleId =dd.WidgetGlobalAttributeValueLocaleId
				
				Update wgavl 
				Set wgavl.MediaPath=ss.MediaPath, wgavl.MediaId = ss.MediaId
				from [ZnodeWidgetGlobalAttributeValueLocale] wgavl
				inner join @TBL_GlobalEntityValueDetail dd on wgavl.WidgetGlobalAttributeValueId =dd.WidgetGlobalAttributeValueId AND wgavl.[LocaleId] = DD.[LocaleId]	 	 
                inner join @TBL_MediaValueList ss on dd.GlobalAttributeId=ss.GlobalAttributeId and ss.WidgetGlobalAttributeValueId=dd.WidgetGlobalAttributeValueId AND ss.[LocaleId] = DD.[LocaleId]						 
				WHERE isnull(dd.GroupAttributeTypeName,'') = @MediaGroupAttributeTypeName
		
		     SELECT 1 AS ID,CAST(1 AS BIT) AS Status;    
			   
             COMMIT TRAN A;
         END TRY
         BEGIN CATCH
             SELECT ERROR_MESSAGE()
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
			 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportInsertUpdateGlobalEntity @UserId = '+CAST(@UserId AS VARCHAR(50))+',@IsNotReturnOutput='+CAST(@IsNotReturnOutput AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
			ROLLBACK TRAN A;
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_ImportInsertUpdateWidgetGlobalAttributeValue',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPortalBrandDetail')
	DROP PROC Znode_GetPortalBrandDetail

GO

CREATE PROCEDURE [dbo].[Znode_GetPortalBrandDetail]  
( @WhereClause  NVARCHAR(MAX)='',  
  @Rows    INT           = 2147483647,  
  @PageNo   INT           = 1,  
  @Order_BY   VARCHAR(1000) = '',  
  @RowsCount  INT           = 0 OUT,  
  @LocaleId   INT           = 1,
  @PortalId     INT           = null ,     
  @IsAssociated  BIT           = 0,  
  @PromotionId      INT     = 0   
)  
AS  
  /*  
     Summary :- This Procedure is used to get brand localies   
     Unit Testing   
  begin tran  
     EXEC [Znode_GetPortalBrandDetail_R] @WhereClause='',@PortalId=null, @IsAssociated = 0
	 EXEC [Znode_GetPortalBrandDetail_R] @WhereClause   = '' ,    
     @Rows                    = 100 ,    
     @PageNo                  = 1 ,    
     @Order_BY      = '' ,    
     @RowsCount     =0  ,    
     @PortalId= 1 ,    
     @IsAssociated            = 1  
  rollback tran    
 */  
BEGIN  
BEGIN TRY  
        SET NOCOUNT ON;  
        DECLARE @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId();  
        DECLARE @SeoId VARCHAR(MAX)= '', @SQL NVARCHAR(MAX); --, @SeoCode NVARCHAR(MAX) ;
		DECLARE @PaginationWhereClause VARCHAR(300)= dbo.Fn_GetRowsForPagination(@PageNo, @Rows, ' WHERE RowId')
        
		DECLARE @TBL_BrandDetails TABLE  
        (
			Description         NVARCHAR(MAX),  
			BrandId             INT,  
			BrandCode           VARCHAR(600),  
			DisplayOrder        INT,  
			IsActive            BIT,  
			WebsiteLink         NVARCHAR(1000),  
			BrandDetailLocaleId INT,  
			SEOFriendlyPageName NVARCHAR(600),  
			MediaPath           NVARCHAR(MAX),  
			MediaId             INT,  
			ImageName           VARCHAR(300),
			BrandName			VARCHAR(100),	
			Custom1				NVARCHAR(MAX),	
			Custom2				NVARCHAR(MAX),
			Custom3				NVARCHAR(MAX),
			Custom4				NVARCHAR(MAX),
			Custom5				NVARCHAR(MAX),
			PortalId			Int,
			IsAssociated        Bit 
        );  
  
    DECLARE @AttributeId INT= [dbo].[Fn_GetProductBrandAttributeId]();  
             
	DECLARE @TBL_AttributeDefault TABLE  
    (
		PimAttributeId            INT,  
		AttributeDefaultValueCode VARCHAR(600),  
		IsEditable                BIT,  
		AttributeDefaultValue     NVARCHAR(MAX),
		DisplayOrder			  INT   
    );  

    DECLARE @TBL_SeoDetails TABLE  
    (
		CMSSEODetailId       INT,  
		SEOTitle             NVARCHAR(MAX),  
		SEOKeywords          NVARCHAR(MAX),  
		SEOURL               NVARCHAR(MAX),  
		ModifiedDate         DATETIME,  
		SEODescription       NVARCHAR(MAX),  
		MetaInformation      NVARCHAR(MAX),  
		IsRedirect           BIT,  
		CMSSEODetailLocaleId INT,  
		--SEOId                INT ,
		PublishStatus        NVARCHAR(20),
		SEOCode				 NVARCHAR(4000),
		CanonicalURL		 VARCHAR(200),
		RobotTag			 VARCHAR(50)			   
    );  

    DECLARE @TBL_BrandDetail TABLE  
    (
		Description          NVARCHAR(MAX),  
		BrandId              INT,  
		BrandCode            VARCHAR(600),  
		DisplayOrder         INT,  
		IsActive             BIT,  
		WebsiteLink          NVARCHAR(1000),  
		BrandDetailLocaleId  INT,  
		MediaPath            NVARCHAR(MAX),  
		MediaId              INT,  
		ImageName      VARCHAr(300) ,  
		CMSSEODetailId       INT,  
		SEOTitle             NVARCHAR(MAX),  
		SEOKeywords          NVARCHAR(MAX),  
		SEOURL               NVARCHAR(MAX),  
		ModifiedDate         DATETIME,  
		SEODescription       NVARCHAR(MAX),  
		MetaInformation      NVARCHAR(MAX),  
		IsRedirect           BIT,  
		CMSSEODetailLocaleId INT,  
		--SEOId                INT,  
		BrandName            NVARCHAR(MAX),  
		RowId                INT,  
		CountId              INT ,
		SEOCode              NVARCHAR(4000), 
		Custom1              NVARCHAR(MAX),
		Custom2              NVARCHAR(MAX),
		Custom3              NVARCHAR(MAX),
		Custom4              NVARCHAR(MAX),
		Custom5              NVARCHAR(MAX),
		PortalId			 INT
    );  
             
	IF @PromotionId > 0  
    BEGIN         
		 SET @SeoId = ISNULL(SUBSTRING((SELECT ','+CAST(BrandId AS VARCHAR(50))  
		 FROM ZnodePromotionBrand   
		 WHERE PromotionId= @PromotionId  FOR XML PATH ('') ),2,4000),'0')  
  
		 SET @WhereClause = CASE WHEN @IsAssociated = 1 THEN ' BrandId IN (' ELSE ' BrandId NOT IN (' END  +@SeoId+') AND '+CASE WHEN @WhereClause = '' THEN '1=1' ELSE @WhereClause END   
		 SET @SeoId = ''  
    END    
  
    ;WITH Cte_GetBrandBothLocale AS 
	(
		SELECT ZBDL.Description,ZBD.BrandId,LocaleId,ZBD.BrandCode,isnull(ZPB.DisplayOrder,999) as DisplayOrder,ZBD.IsActive,ZBD.WebsiteLink,ZBDl.BrandDetailLocaleId,  
			SEOFriendlyPageName,[dbo].[Fn_GetMediaThumbnailMediaPath](Zm.path) MediaPath,ZBD.MediaId,Zm.path ImageName, ZBDL.BrandName, ZBD.Custom1, ZBD.Custom2, ZBD.Custom3, ZBD.Custom4, ZBD.Custom5, ZPB.PortalId,
			CASE WHEN ZPB.PortalBrandId IS NULL THEN 0 ELSE 1 END IsAssociated
		FROM ZnodeBrandDetails ZBD 
		LEFT JOIN ZnodePortalBrand ZPB ON ZBD.BrandId = ZPB.BrandId AND (ZPB.PortalId = @PortalId OR isnull(@PortalId,0) = 0 )
		LEFT JOIN ZnodeBrandDetailLocale ZBDL ON(ZBD.BrandId = ZBDL.BrandId)  
		LEFT JOIN ZnodeMedia ZM ON(ZM.MediaId = ZBD.MediaId)  
		WHERE LocaleId IN(@LocaleId, @DefaultLocaleId)  
		
              
    ),  
    Cte_BrandFirstLocale AS 
	(
		SELECT Description,BrandId,LocaleId,BrandCode,DisplayOrder,IsActive,WebsiteLink,BrandDetailLocaleId,SEOFriendlyPageName,MediaPath,MediaId,ImageName , BrandName, Custom1, Custom2, Custom3, Custom4, Custom5, PortalId , IsAssociated
        FROM Cte_GetBrandBothLocale CTGBBL  
        WHERE LocaleId = @LocaleId
	),  
    Cte_BrandDefaultLocale AS 
	(
		SELECT Description,BrandId,BrandCode,DisplayOrder,IsActive,WebsiteLink,BrandDetailLocaleId,SEOFriendlyPageName,MediaPath,MediaId,ImageName, BrandName, Custom1, Custom2, Custom3, Custom4, Custom5, PortalId, IsAssociated  
        FROM Cte_BrandFirstLocale  
        UNION ALL  
        SELECT Description,BrandId,BrandCode,DisplayOrder,IsActive,WebsiteLink,BrandDetailLocaleId,SEOFriendlyPageName,MediaPath,MediaId,ImageName , BrandName, Custom1, Custom2, Custom3, Custom4, Custom5, PortalId, IsAssociated
		FROM Cte_GetBrandBothLocale CTBBL  
		WHERE LocaleId = @DefaultLocaleId  
		AND NOT EXISTS  
		(  
			SELECT TOP 1 1  
			FROM Cte_BrandFirstLocale CTBFL  
			WHERE CTBBL.BrandId = CTBFL.BrandId  
		)
	)    
    INSERT INTO @TBL_BrandDetails (Description,BrandId,BrandCode,DisplayOrder,IsActive,WebsiteLink,BrandDetailLocaleId,MediaPath,MediaId,ImageName, BrandName, Custom1, Custom2, Custom3, Custom4, Custom5, PortalId, IsAssociated)  
    SELECT Description,BrandId,BrandCode,DisplayOrder,IsActive,WebsiteLink,BrandDetailLocaleId,MediaPath,MediaId,ImageName , BrandName, Custom1, Custom2, Custom3, Custom4, Custom5, PortalId, IsAssociated
    FROM Cte_BrandDefaultLocale CTEBD;  
       
	-----Update BrandName from attributedefault value
	;WITH Cte_GetBrandNameLocale AS 
	(
		select d.brandcode, a.AttributeDefaultValueCode, b.AttributeDefaultValue, b.LocaleId 
		from ZnodePimAttributeDefaultValue a
		inner join ZnodePimAttributeDefaultValueLocale b on a.PimAttributeDefaultValueId = b.PimAttributeDefaultValueId 
		inner join ZnodePimAttribute c on a.PimAttributeId = c.PimAttributeId
		inner join @TBL_BrandDetails d on a.AttributeDefaultValueCode = d.brandcode
		where c.attributecode = 'brand' and b.LocaleId IN(@LocaleId, @DefaultLocaleId)
              
    )
	,Cte_BrandNameFirstLocale AS 
	(
		SELECT brandcode, AttributeDefaultValueCode, AttributeDefaultValue, LocaleId  
        FROM Cte_GetBrandNameLocale CTGBBL  
        WHERE LocaleId = @LocaleId
	)
	,Cte_BrandDefaultLocale AS 
	(
		SELECT brandcode, AttributeDefaultValueCode, AttributeDefaultValue, LocaleId  
        FROM Cte_BrandNameFirstLocale  
        UNION ALL  
        SELECT brandcode, AttributeDefaultValueCode, AttributeDefaultValue, LocaleId  
		FROM Cte_GetBrandNameLocale CTBBL  
		WHERE LocaleId = @DefaultLocaleId  
		AND NOT EXISTS  
		(  
			SELECT TOP 1 1  
			FROM Cte_BrandNameFirstLocale CTBFL  
			WHERE CTBBL.brandcode = CTBFL.brandcode  
		)
	)  
	update b1 set b1.brandname = a1.AttributeDefaultValue
	from Cte_BrandDefaultLocale a1
	inner join @TBL_BrandDetails b1 on a1.brandcode = b1.brandcode
	
	DECLARE @SeoCode SelectColumnList
	INSERT INTO @SeoCode
	SELECT BrandCode FROM @TBL_BrandDetails
				
    INSERT INTO @TBL_SeoDetails 
	(
		CMSSEODetailId,SEOTitle,SEOKeywords,SEOURL,ModifiedDate,SEODescription,MetaInformation,IsRedirect,
		CMSSEODetailLocaleId,PublishStatus,SEOCode,CanonicalURL,RobotTag
	)  
    EXEC Znode_GetSeoDetails @SeoCode, 'Brand', @LocaleId;  
			              
    SELECT DISTINCT TBBD.*,TBSD.SEOTitle,TBSD.SEOKeywords,TBSD.SEOURL,TBSD.SEODescription,TBSD.MetaInformation,TBSD.IsRedirect,
		TBSD.PublishStatus,TBSD.SEOCode,TBSD.CanonicalURL,TBSD.RobotTag 
    INTO #TM_BrandLocale  
    FROM @TBL_BrandDetails TBBD  
    LEFT JOIN @TBL_SeoDetails TBSD ON(TBSD.SEOCode = TBBD.BrandCode)  
    --INNER JOIN @TBL_AttributeDefault TBAD ON(TBAD.AttributeDefaultValueCode = TBBD.BrandCode);  
  
	SET @SQL = 
	'  
     SELECT * ,Count(*)Over() CountId  
     into #Cte_BrandDetails
	 FROM #TM_BrandLocale TMADV  
     WHERE IsAssociated = '+cast(@IsAssociated as varchar(10))+'  
     '+[dbo].[Fn_GetFilterWhereClause](@WhereClause)+'  
     
    SELECT '+[dbo].[Fn_GetPagingRowId](@Order_BY, 'BrandId DESC')+',Description  , BrandId , BrandCode , DisplayOrder  ,IsActive  ,WebsiteLink ,BrandDetailLocaleId   
         , MediaPath ,MediaId,ImageName  ,SEOTitle ,SEOKeywords , SEOURL   
          ,  SEODescription   ,MetaInformation   ,IsRedirect   
         ,BrandName  ,CountId ,SEOCode,  Custom1, Custom2, Custom3, Custom4, Custom5, PortalId  
    into #BrandDetails 
	FROM #Cte_BrandDetails  
    '+[dbo].[Fn_GetOrderByClause](@Order_BY, 'BrandId DESC')+' 
	
	select Description  , BrandId , BrandCode , DisplayOrder  ,IsActive  ,WebsiteLink ,BrandDetailLocaleId   
         , MediaPath ,MediaId,ImageName  ,SEOTitle ,SEOKeywords , SEOURL   
          ,  SEODescription   ,MetaInformation   ,IsRedirect   
         ,BrandName ,RowId  ,CountId ,SEOCode,  Custom1, Custom2, Custom3, Custom4, Custom5, PortalId 
	from #BrandDetails'+@PaginationWhereClause+' '+dbo.Fn_GetOrderByClause(@Order_By, 'BrandId DESC');  
  
	print @SQL
     INSERT INTO @TBL_BrandDetail  
     (  
		Description,BrandId,BrandCode,DisplayOrder,IsActive,WebsiteLink,  
		BrandDetailLocaleId,MediaPath,MediaId,ImageName,SEOTitle,  
		SEOKeywords,SEOURL,SEODescription,MetaInformation,IsRedirect,  
		BrandName,RowId,CountId ,SEOCode , Custom1, Custom2, Custom3, Custom4, Custom5, PortalId   
     )  
     EXEC (@SQL);  
             
	SET @RowsCount = ISNULL(  
                        (  
                            SELECT TOP 1 CountId  
                            FROM @TBL_BrandDetail  
                        ), 0);  
    SELECT BrandId,Description,BrandCode,DisplayOrder,IsActive,WebsiteLink,BrandDetailLocaleId,MediaPath,MediaId,ImageName,SEOTitle,SEOKeywords,SEOURL SEOFriendlyPageName,SEODescription,MetaInformation,IsRedirect,BrandName,@PromotionId PromotionId   
    ,SEOCode,Custom1, Custom2, Custom3, Custom4, Custom5, PortalId
	FROM @TBL_BrandDetail;  
	
END TRY  
BEGIN CATCH  
	DECLARE @Status BIT ;  
	SET @Status = 0;  
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),   
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPortalBrandDetail @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@LocaleId = '+CAST(@LocaleId AS VARCHAR(50))
	+',@PortalId='+CAST(@PortalId AS VARCHAR(50))+',@IsAssociated='+CAST(@IsAssociated AS VARCHAR(50))+',@PromotionId='+CAST(@PromotionId AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));  
                    
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
      
		EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_GetPortalBrandDetail',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH;  
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'ZnodeReport_DashboardTopAccounts')
	DROP PROC ZnodeReport_DashboardTopAccounts

GO

CREATE PROCEDURE [dbo].[ZnodeReport_DashboardTopAccounts]              
(            
	@PortalId  bigint  = null,        
	@AccountId bigint  = null,    
	@SalesRepUserId int = 0                
)              
AS              
/*              
     Summary:- This procedure is used to get the order details              
    Unit Testing:              
     EXEC [ZnodeReport_DashboardTopAccounts]  @PortalId=7, @AccountId=0 ,@SalesRepUserId=0         
*/              
BEGIN              
BEGIN TRY              
    SET NOCOUNT ON;    
	----Verifying that the @SalesRepUserId is having 'Sales Rep' role
	IF NOT EXISTS
	(
	SELECT * FROM ZnodeUser ZU
	INNER JOIN AspNetZnodeUser ANZU ON ZU.UserName = ANZU.UserName
	INNER JOIN AspNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName
	INNER JOIN AspNetUserRoles ANUR ON ANU.Id = ANUR.UserId
	Where Exists(select * from AspNetRoles ANR Where Name = 'Sales Rep' AND ANUR.RoleId = ANR.Id)
	AND ZU.UserId = @SalesRepUserId
	)  
	Begin
	SET @SalesRepUserId = 0
	End            
 
	DECLARE @TopItem TABLE (ItemName nvarchar(100),CustomerName nvarchar(200),ItemId nvarchar(10),ItemCode nvarchar(100), Total numeric(28,6),ItemDate datetime,Symbol NVARCHAR(10))            
             
    INSERT INTO @TopItem(ItemId, ItemName,CustomerName,ItemCode,ItemDate,Total,Symbol)          
       
	select ZA.AccountId,ZA.[Name], isnull(ZU.FirstNAme,'')+' '+isnull(ZU.LastName,'') as UserName,ZA.AccountCode, ZU.CreatedDate,0,''        
	from ZnodeAccount ZA      
	left join ZnodeUser ZU on ZU.AccountId = ZA.AccountId      
	left join  ZnodePortalAccount ZUP on ZUP.AccountId = ZA.AccountId          
	WHERE (ZUP.PortalId = @PortalId OR ISNULL(@PortalId,0) = 0) AND (ZA.AccountId = @AccountId OR  ISNULL(@AccountId,0) = 0)            
	and (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = @SalesRepUserId and ZU.UserId = SalRep.CustomerUserid) or @SalesRepUserId = 0)        
   
   SELECT TOP 5 ItemId,ItemCode, ItemName,CustomerName,ItemDate,Total,Symbol FROM @TopItem Order by  Convert(numeric,Total )  desc                
   
END TRY              
             
BEGIN CATCH              
	DECLARE @Status BIT ;              
	SET @Status = 0;              
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),              
	@ErrorCall NVARCHAR(MAX)= 'EXEC ZnodeReport_DashboardTopAccount @PortalId = '+@PortalId;            
                               
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                                  
                 
	EXEC Znode_InsertProcedureErrorLog              
	@ProcedureName = 'ZnodeReport_DashboardTopAccount',              
	@ErrorInProcedure = @Error_procedure,              
	@ErrorMessage = @ErrorMessage,              
	@ErrorLine = @ErrorLine,              
	@ErrorCall = @ErrorCall;              
END CATCH              
             
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_AdminUsersByUserId')
	DROP PROC Znode_AdminUsersByUserId

GO

CREATE PROCEDURE [dbo].[Znode_AdminUsersByUserId]
(	@RoleName		VARCHAR(200),
    @UserName		VARCHAR(200),
    @WhereClause	XML,
    @Rows			INT           = 100,
    @PageNo			INT           = 1,
    @Order_By		VARCHAR(1000) = '',
    @RowCount		INT        = 0 OUT,
	@IsCallOnSite   BIT = 0 ,
	@PortalId		VARCHAR(1000) = 0,
	@IsGuestUser    BIT = 0,
	@ColumnName     dbo.SelectColumnList ReadOnly,
	@SalesRepUserId Int = 0,
	@IsSalesRepList  Bit = 0
)
AS
   /* 
      Summary: List of users with details and shows link with ASPNet tables 
      This procedure is used for finding both users and admin users 
      here use three view "View_RoleUsers" for check  @UserName is present or not 
      "View_AdminUserDetail"  this view use for admin users 
      "View_CustomerUserDetail" Use for customer users 
      Unit Testing   
	  SELECT * FROM ZnodeUser 
      DECLARE @EDE INT=0  EXEC Znode_AdminUsersByUserId '','admin@znode.com',@WhereClause='',@Order_By='',@PageNo= 1 ,@Rows= 214,@IsCallOnSite='false',@PortalId=0,@RowCount=@EDE OUT  SELECT @EDE
   */
     BEGIN
         BEGIN TRY
            SET NOCOUNT ON;
			
            DECLARE @SQL NVARCHAR(MAX)= '', @PaginationWhereClause VARCHAR(300)= dbo.Fn_GetRowsForPagination(@PageNo, @Rows, ' WHERE RowId');
             
			----Verifying that the @SalesRepUserId is having 'Sales Rep' role
			IF NOT EXISTS
			(
				SELECT * FROM ZnodeUser ZU
				INNER JOIN AspNetZnodeUser ANZU ON ZU.UserName = ANZU.UserName
				INNER JOIN AspNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName
				INNER JOIN AspNetUserRoles ANUR ON ANU.Id = ANUR.UserId
				Where Exists(select * from AspNetRoles ANR Where Name = 'Sales Rep' AND ANUR.RoleId = ANR.Id) 
				AND ZU.UserId = @SalesRepUserId
			)   
			Begin
				SET @SalesRepUserId = 0
			End

			IF OBJECT_ID('tempdb..#TBL_RowCount') is not null
				DROP TABLE #TBL_RowCount
			Create table #TBL_RowCount(RowsCount int )
			-----Split where clause XMl 
			CREATE TABLE #WhereColumnList(RowId Int identity, filterName varchar(max), WhereCondition varchar(max))
			insert into #WhereColumnList(filterName,WhereCondition)
			SELECT 
					Tbl.Col.value('key[1]', 'varchar(max)') as filterName,
					Tbl.Col.value('condition[1]', 'varchar(max)') WhereCondition
			FROM   @WhereClause.nodes('//filter') Tbl(Col) 
			----Address column in global search
			declare @AddressGlobalSearch varchar(1000)
			declare @GlobalSearch varchar(100)
			select @GlobalSearch = substring(WhereCondition,charindex(' like ',WhereCondition), charindex(' OR ',WhereCondition)-charindex(' like ',WhereCondition)) 
			from #WhereColumnList
			where filtername like '%|%'
			and filtername <> ''
			and filterName in ('CityName','CountryName','PostalCode','StateName','CompanyName') 

			if isnull(@GlobalSearch,'') <> ''
			begin
				select @AddressGlobalSearch = '('+'CityName '+ @GlobalSearch+' OR '+'CountryName '+ @GlobalSearch+' OR '+'PostalCode '+ @GlobalSearch+' OR '+'StateName '+ @GlobalSearch+' OR '+'CompanyName '+ @GlobalSearch+')'
			end
			else
			begin
				SET @AddressGlobalSearch = ''
			end
			----Global search where clause
			declare @WhereClauseGlobal varchar(1000)=''
			select @WhereClauseGlobal = ISNULL(WhereCondition,'')
			from #WhereColumnList
			where filtername like '%|%'
			and filtername <> ''
			
			----Where clause columns except Address columns
			declare @WhereClause1 varchar(max) 
			select @WhereClause1 = COALESCE(@WhereClause1 + '', '') + WhereCondition+' And '
			--case when @WhereClause1 <> ''  then ' And ' else '' end
			from #WhereColumnList a
			where filterName not like '%|%' and
			filterName not in ('CountryName','CityName','StateName','PostalCode','CompanyName')
			and filtername <> ''

			if @WhereClause1 <> ''
			begin
				set @WhereClause1=isnull(substring(@WhereClause1,1,len(@WhereClause1)-3),'')
			end
			else
			begin
				set @WhereClause1 = ''
			end

			----Where clause columns
			declare @AddressColumnWhereClause varchar(max) 
			select @AddressColumnWhereClause = COALESCE(@AddressColumnWhereClause + '', '') + WhereCondition+' And '
			from #WhereColumnList a
			where filterName not like '%|%' and
			filterName in ('CountryName','CityName','StateName','PostalCode','CompanyName')
			and filtername <> ''
			
			if isnull(@AddressColumnWhereClause,'') <> ''
			begin
				set @AddressColumnWhereClause=isnull(substring(@AddressColumnWhereClause,1,len(@AddressColumnWhereClause)-3),'')
            end
			else
			begin
				set @AddressColumnWhereClause = ''
			end

			declare @WhereClauseAll varchar(max)
			select @WhereClauseAll = COALESCE(@WhereClauseAll + '', '') + WhereCondition+' And '
			from #WhereColumnList a

			set @WhereClauseAll=isnull(substring(@WhereClauseAll,1,len(@WhereClauseAll)-3),'')
			-------------- 

			IF @PortalId  <> '0' 
			BEGIN 
				IF @IsSalesRepList IN (1, 'True')
				BEGIN
					SELECT @PortalId = STUFF((SELECT CONCAT(', ', ISNULL(ZUP2.PortalId,@PortalId))
						FROM dbo.ZnodeUserPortal ZUP2 WITH (NOLOCK)
						WHERE ZUP1.UserId = ZUP2.UserId
						FOR XML PATH ('')), 1, 2, '')
					FROM dbo.ZnodeUserPortal ZUP1 WITH (NOLOCK)
					WHERE ZUP1.UserId=(SELECT TOP 1 UserId FROM ZnodeUser WITH (NOLOCK) WHERE UserName=@UserName)
					GROUP BY ZUP1.UserId;
				END

			    SET @WhereClauseAll = CASE WHEN  @WhereClauseAll = '' THEN ' (PortalId IN ('+@PortalId+') OR PortalId IS NULL) ' ELSE @WhereClauseAll+' AND (PortalId IN ('+@PortalId+') OR PortalId IS NULL) ' END 

				SET @WhereClause1 = CASE WHEN  @WhereClause1 = '' THEN ' (isnull(PortalId,0) IN ('+@PortalId+') OR PortalId IS NULL) ' ELSE @WhereClause1+' AND (isnull(PortalId,0) IN ('+@PortalId+') OR PortalId IS NULL) ' END 
			
			END 
			IF EXISTS ( SELECT TOP 1 1 FROM View_RoleUsers  WHERE Username = @UserName   )  AND @RoleName <> ''  
			-- this check for admin user
       		BEGIN
				SET @SQL = ' SELECT  A.UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,A.CreatedBy,A.CreatedDate,A.ModifiedBy,A.ModifiedDate
				,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
				,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId ,CustomerPaymentGUID
				INTO #Cte_AdminUserDetail
				FROM View_AdminUserDetail A
				'+CASE WHEN @PortalId  <> '0' THEN ' INNER JOIN ZnodeUserPortal ZUP ON (ZUP.UserId = A.UserId) 'ELSE '' END  +'	 
				'+dbo.Fn_GetWhereClause(@WhereClauseAll, ' WHERE ')+'
				
				;with Cte_AdminUserDetailRowId AS 
				(
				SELECT UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
				,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
				,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId,CustomerPaymentGUID ,RANK()Over('+dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC')+',UserId DESC) RowId
				FROM  #Cte_AdminUserDetail a
				where (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
				)
					 
				SELECT UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
				,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
				,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId,CustomerPaymentGUID ,RowId 
				INTO #AccountDetails
				FROM Cte_AdminUserDetailRowId 
					 
				SET @Count= ISNULL((SELECT  Count(1) FROM #AccountDetails ),0)
					 
				SELECT DISTINCT UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
				,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
				,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId ,CustomerPaymentGUID
				FROM #AccountDetails '+@PaginationWhereClause+' '+dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC' );
				EXEC SP_executesql
				@SQL,
				N'@Count INT OUT',
				@Count = @RowCount OUT;
			END;
			-- For Customer user
            ELSE   
			BEGIN
				IF @roleName = ''
				BEGIN
					if OBJECT_ID('tempdb..##CustomerUserAddDetail') is not null
					drop table ##CustomerUserAddDetail

					if OBJECT_ID('tempdb..##View_CustomerUserAddDetail') is not null
					drop table ##View_CustomerUserAddDetail
				
					if OBJECT_ID('tempdb..##UserList') is not null
					drop table ##UserList

					CREATE TABLE ##UserList(UserId int,AddressID int)

					declare @UserList varchar(1000)=''

					------To get the list of user having adress column in global search
					if (@AddressGlobalSearch <> '')
					begin
				
					set @UserList = 'select a.UserId, b.AddressID	from ZnodeUserAddress a	inner join ZnodeAddress b on a.AddressId = b.AddressId	where '+@AddressGlobalSearch
					--print @UserList
					insert into ##UserList(UserId, b.AddressID)
					exec (@UserList)
			
					end
					----To get the list of user having adress column in where clause 
					if (@AddressColumnWhereClause <> '')
					begin
					
					set @UserList = 'select a.UserId, b.AddressID	from ZnodeUserAddress a	inner join ZnodeAddress b on a.AddressId = b.AddressId	where '+@AddressColumnWhereClause
					--print @UserList
					insert into ##UserList(UserId,AddressID)
					exec (@UserList)
					
					end

					If @IsGuestUser= 0 
					AND
					NOT Exists (Select filterName from #WhereColumnList where filterName in ('accountid','isaccountcustomer','UserId') and filtername <> '')
					-- Customer List with GuestUsers
					Begin
						SET @SQL = 
							'SELECT a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
							 a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATE, a.CreatedDate) CreatedDate,A.ModifiedBy,
							 CONVERT( DATE, a.ModifiedDate) ModifiedDate, 0 RoleId,
							 CASE WHEN A.AccountId IS NULL THEN '''' ELSE r.name END as RoleName,
							 CASE	WHEN B.LockoutEndDateUtc IS NULL
							 THEN CAST(1 AS    BIT)	ELSE CAST(0 AS BIT)
							 END IsActive,	CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
				
							 (ISNULL(RTRIM(LTRIM(a.FirstName)), '''')+'' ''+ISNULL(RTRIM(LTRIM(a.MiddleName)), '''')+CASE
							 WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '''') = ''''	THEN ''''
							 ELSE '' ''	END+ISNULL(RTRIM(LTRIM(a.LastName)), '''')) 
				
							 FullName,
							 e.Name AccountName
							 ,a.AccountId,a.ExternalId,	CASE	WHEN a.AccountId IS NULL THEN 0	ELSE 1	END IsAccountCustomer,
							 a.BudgetAmount,
							 '''' TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser,a.CustomerPaymentGUID
							 --,CASE WHEN zp.StoreName IS NULL THEN ''ALL'' ELSE zp.StoreName END StoreName,
							 ,ISnull(zp.StoreName , ''ALL'')StoreName,
							 up.PortalId as PortalId, e.AccountCode
							 into ##View_CustomerUserAddDetail
							 FROM ZnodeUser a
							 INNER JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
							 INNER JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
							 LEFT JOIN ZnodeUserPortal up ON(up.UserId = a.UserId)  
							 LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
							 LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
							 LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
							 LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)
							 WHERE (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid ) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
							' 
						EXEC (@SQL)
					End	
					Else If @IsGuestUser= 1 
					Begin
							SET @SQL='SELECT a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
							a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATE, a.CreatedDate) CreatedDate,A.ModifiedBy,
							CONVERT( DATE, a.ModifiedDate) ModifiedDate,ur.RoleId,r.Name RoleName,
							CASE WHEN B.LockoutEndDateUtc IS NULL THEN CAST(1 AS    BIT) ELSE CAST(0 AS BIT) END IsActive,
							CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
							(ISNULL(RTRIM(LTRIM(a.FirstName)), '''')+'' ''+ISNULL(RTRIM(LTRIM(a.MiddleName)), '''')+CASE
							WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '''') = '''' THEN '''' ELSE '' '' END+ISNULL(RTRIM(LTRIM(a.LastName)), '''')) FullName,
							e.Name AccountName,a.AccountId,a.ExternalId,
							CASE WHEN a.AccountId IS NULL THEN 0 ELSE 1	END IsAccountCustomer,
							a.BudgetAmount,r.TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser,a.CustomerPaymentGUID
							,CASE WHEN zp.StoreName IS NULL THEN ''ALL'' ELSE zp.StoreName END StoreName,
							CASE WHEN a.AccountId IS NULL THEN up.PortalId ELSE ZPA.PortalId END as PortalId,e.AccountCode
							into ##View_CustomerUserAddDetail
							FROM ZnodeUser a
							LEFT JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
							LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
							LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
							LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)                       
							LEFT JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
							LEFT JOIN ZnodeUserPortal up ON(up.UserId = a.UserId)  
							LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
							LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = a.AccountId) 
							WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUSer ZUQ WHERE ZUQ.UserId = a.UserId AND ZUQ.EmailOptIn = 1 AND ZUQ.AspNetUserId IS NULL )
							AND a.AspNetuserId is null
							AND (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid ) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
							'
						EXEC (@SQL)
					End
					Else IF Exists (Select filterName from #WhereColumnList where filterName in ('UserId') and filtername <> '')
					and  @IsGuestUser= 0   
					-- Customer List for user edit single user 
					Begin
					SET @SQL='SELECT a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
							a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATE, a.CreatedDate) CreatedDate,A.ModifiedBy,
							CONVERT( DATE, a.ModifiedDate) ModifiedDate,ur.RoleId,r.Name RoleName,
							CASE WHEN B.LockoutEndDateUtc IS NULL THEN CAST(1 AS    BIT) ELSE CAST(0 AS BIT) END IsActive,
							CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
							(ISNULL(RTRIM(LTRIM(a.FirstName)), '''')+'' ''+ISNULL(RTRIM(LTRIM(a.MiddleName)), '''')+CASE
							WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '''') = '''' THEN '''' ELSE '' '' END+ISNULL(RTRIM(LTRIM(a.LastName)), '''')) FullName,
							e.Name AccountName,a.AccountId,a.ExternalId,
							CASE WHEN a.AccountId IS NULL THEN 0 ELSE 1	END IsAccountCustomer,
							a.BudgetAmount,r.TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser,a.CustomerPaymentGUID
							,CASE WHEN zp.StoreName IS NULL THEN ''ALL'' ELSE zp.StoreName END StoreName,
							CASE WHEN a.AccountId IS NULL THEN up.PortalId ELSE ZPA.PortalId END as PortalId,e.AccountCode
							into ##View_CustomerUserAddDetail
							FROM ZnodeUser a
							LEFT JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
							LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
							LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
							LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)                       
							LEFT JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
							LEFT JOIN ZnodeUserPortal up ON(up.UserId = a.UserId)  
							LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
							LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = a.AccountId) 
							WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUSer ZUQ WHERE ZUQ.UserId = a.UserId AND ZUQ.EmailOptIn = 1 AND ZUQ.AspNetUserId IS NULL )
							AND (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid ) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
							'
						EXEC (@SQL)
					End	
					Else -- Account user List 
					Begin
							SELECT a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
							a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATE, a.CreatedDate) CreatedDate,A.ModifiedBy,
							CONVERT( DATE, a.ModifiedDate) ModifiedDate,ur.RoleId,r.Name RoleName,
							CASE WHEN B.LockoutEndDateUtc IS NULL THEN CAST(1 AS    BIT) ELSE CAST(0 AS BIT) END IsActive,
							CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
							(ISNULL(RTRIM(LTRIM(a.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(a.MiddleName)), '')+CASE
							WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '') = '' THEN '' ELSE ' ' END+ISNULL(RTRIM(LTRIM(a.LastName)), '')) FullName,
							e.Name AccountName,a.AccountId,a.ExternalId,
							CASE WHEN a.AccountId IS NULL THEN 0 ELSE 1	END IsAccountCustomer,
							a.BudgetAmount,r.TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser,a.CustomerPaymentGUID
							,CASE WHEN zp.StoreName IS NULL THEN 'ALL' ELSE zp.StoreName END StoreName,
							CASE WHEN a.AccountId IS NULL THEN up.PortalId ELSE ZPA.PortalId END as PortalId, e.AccountCode
							into ##View_CustomerUserAddDetail
							FROM ZnodeUser a
							LEFT JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
							LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
							LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
							LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)                       
							LEFT JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
							LEFT JOIN ZnodeUserPortal up ON(up.UserId = a.UserId)  
							LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
							LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = a.AccountId) 
							WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUSer ZUQ WHERE ZUQ.UserId = a.UserId AND ZUQ.EmailOptIn = 1 AND ZUQ.AspNetUserId IS NULL )
							AND (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = @SalesRepUserId and a.UserId = SalRep.CustomerUserid ) or @SalesRepUserId = 0)
					End


					alter table ##View_CustomerUserAddDetail 
					add DepartmentId int, PermissionsName varchar(200), PermissionCode varchar(200), DepartmentName varchar(300), AccountPermissionAccessId int,
					AccountUserOrderApprovalId int, ApprovalName varchar(1000) , ApprovalUserId int
					--, PortalId int , StoreName varchar(1000)
					,CountryName varchar(1000),CityName varchar(1000),StateName varchar(1000),PostalCode varchar(1000), CompanyName varchar(1000),
					SalesRepUserName varchar(600),SalesRepFullName varchar(1000)

	
					IF ((@AddressGlobalSearch like '%CountryName%' OR @AddressGlobalSearch like '%CityName%' OR @AddressGlobalSearch like '%StateName%' OR @AddressGlobalSearch like '%PostalCode%' OR @AddressGlobalSearch like '%CompanyName%')
					and exists(select * from ##UserList))
					BEGIN
						update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
						PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName
						from ##View_CustomerUserAddDetail a
						inner join ZnodeUserAddress ZUA on a.UserId = ZUA.UserId
						inner  JOIN ZnodeAddress ZA on ZA.AddressId = zua.AddressId
						where exists(select * from ##UserList UL where a.UserId = UL.UserId and UL.AddressId = ZA.AddressId )

						update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
						PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName
						from ##View_CustomerUserAddDetail a
						inner join ZnodeAccountAddress ZAA on a.AccountId = ZAA.AccountId
						inner  JOIN ZnodeAddress ZA on ZA.AddressId = ZAA.AddressId
						where isnull(a.AccountId,0)<> 0-- is not null
						and exists(select * from ##UserList UL where a.UserId = UL.UserId and UL.AddressID = ZA.AddressId)
						and (a.CountryName is null OR a.CityName is null OR a.StateName is null or a.PostalCode is null or a.CompanyName is null)
		
					END

					--CREATE NONCLUSTERED INDEX IND_101
					--ON [dbo].[##View_CustomerUserAddDetail] ([userId],[AspNetuserId])

					SET @SQL = '			
						
						create table #AccountDetail
						(
							UserId int,AspNetuserId nvarchar(200),UserName nvarchar(200),FirstName nvarchar(200),MiddleName nvarchar(200),LastName nvarchar(200),
							PhoneNumber nvarchar(100),Email nvarchar(100),EmailOptIn bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,
							RoleId varchar(200),RoleName varchar(200),IsActive bit,IsLock bit,FullName  varchar(1000),AccountName  varchar(200),PermissionsName  varchar(200),
							DepartmentName  varchar(200),DepartmentId int,AccountId int,AccountPermissionAccessId int, ExternalId  varchar(200),BudgetAmount numeric(10,6),
							AccountUserOrderApprovalId int,ApprovalName varchar(200),ApprovalUserId int,PermissionCode varchar(500),CustomerPaymentGUID varchar(500),
							StoreName varchar(200),PortalId int,CountryName varchar(200), CityName varchar(200), StateName varchar(200), PostalCode varchar(200), CompanyName varchar(200)
							,SalesRepUserName varchar(200),SalesRepFullName varchar(200) ,RowId int identity , AccountCode nvarchar(100)
						) 
						'+
						+' insert into #AccountDetail(UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
						EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,FullName,
						AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
						BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode,CustomerPaymentGUID
						,StoreName,PortalId, CountryName, CityName, StateName, PostalCode, CompanyName, AccountCode)
						SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
						EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,FullName,
						AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
						BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode,CustomerPaymentGUID 
						,StoreName,PortalId, CountryName, CityName, StateName, PostalCode, CompanyName, AccountCode
						FROM ##View_CustomerUserAddDetail where 1=1'+
						dbo.Fn_GetWhereClause(@WhereClauseGlobal+case when @WhereClauseGlobal<>'' and @WhereClause1 <> '' then ' And '+@WhereClause1 else @WhereClause1 end, ' AND ')+
						dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC') + '
			
						Insert Into #TBL_RowCount Values(@@RowCount)
							
						SELECT  UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
						EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,FullName,
						AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
						BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode ,CustomerPaymentGUID,StoreName,PortalId,
						CountryName, CityName, StateName, PostalCode, CompanyName, SalesRepUserName, SalesRepFullName, AccountCode
						,Row_Number()Over('+dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC')+')  RowNumber
						into ##CustomerUserAddDetail
						FROM #AccountDetail '+@PaginationWhereClause  +' '+ dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC');

					EXEC (@SQL)
				
					Select @RowCount= isnull(RowsCount  ,0) from #TBL_RowCount

					ALTER TABLE ##CustomerUserAddDetail ADD AddressId Int
					--To get data for DepartmentId
					update CUD SET DepartmentId = i.DepartmentId
					from ##CustomerUserAddDetail cud
					INNER JOIN ZnodeDepartmentUser i ON(i.UserId = cud.UserId)

					--To get data for PermissionsName
					update CUD SET PermissionsName = h.PermissionsName, PermissionCode = h.PermissionCode
					from ##CustomerUserAddDetail cud
					INNER JOIN ZnodeAccountUserPermission f ON(f.UserId = cud.UserId)
					INNER JOIN ZnodeAccountPermissionAccess g ON(g.AccountPermissionAccessId = f.AccountPermissionAccessId)
					INNER JOIN ZnodeAccessPermission h ON(h.AccessPermissionId = g.AccessPermissionId)

					------To get data for DepartmentName
					update CUD SET DepartmentName = j.DepartmentName
					from ##CustomerUserAddDetail cud
					INNER JOIN ZnodeDepartmentUser i ON(i.UserId = cud.UserId)
					INNER JOIN ZnodeDepartment j ON(j.DepartmentId = i.DepartmentId)

					--To get data for AccountPermissionAccessId
					update CUD SET AccountPermissionAccessId = f.AccountPermissionAccessId
					from ##CustomerUserAddDetail cud
					INNER JOIN ZnodeAccountUserPermission f ON(f.UserId = cud.UserId)

					--To get data for AccountPermissionAccessId
					update CUD SET AccountPermissionAccessId = f.AccountPermissionAccessId
					from ##CustomerUserAddDetail cud
					INNER JOIN ZnodeAccountUserPermission f ON(f.UserId = cud.UserId)
	
					--To get data for AccountUserOrderApprovalId
					update CUD SET AccountUserOrderApprovalId = ZAUOA.AccountUserOrderApprovalId
					from ##CustomerUserAddDetail cud
					INNER JOIN ZnodeAccountUserOrderApproval ZAUOA ON cud.UserId = ZAUOA.UserID
	
					--To get data for ApprovalName,ApprovalUserId
					update CUD SET ApprovalName = ISNULL(RTRIM(LTRIM(ZU.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '')
					+CASE
					WHEN ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '') = ''
					THEN ''
					ELSE ' '
					END,
					ApprovalUserId = ZAUOA.ApprovalUserId
					from ##CustomerUserAddDetail cud
					INNER JOIN ZnodeAccountUserOrderApproval ZAUOA ON cud.UserId = ZAUOA.UserID
					INNER JOIN ZnodeUser ZU ON(ZU.UserId = ZAUOA.ApprovalUserId)
	
					----To get data for PortalId
					--update CUD SET PortalId = CASE
					--								WHEN cud.AccountId IS NULL
					--								THEN up.PortalId
					--								ELSE ZPA.PortalId
					--							END 
					--from ##CustomerUserAddDetail cud
					--   LEFT JOIN ZnodeUserPortal up ON(up.UserId = cud.UserId) 
					--LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = cud.AccountId) 
	
					----To get data for CountryName, CityName, StateName, PostalCode, CompanyName
					IF (EXISTS(SELECT * FROM @ColumnName where ([StringColumn] LIKE '%CountryName%' OR [StringColumn] LIKE '%CityName%' OR [StringColumn] LIKE '%StateName%' OR [StringColumn] LIKE '%PostalCode%' OR [StringColumn] LIKE '%CompanyName%'))
					OR (@WhereClauseAll like '%CountryName%' OR @WhereClauseAll like '%CityName%' OR @WhereClauseAll like '%StateName%' OR @WhereClauseAll like '%PostalCode%' OR @WhereClauseAll like '%CompanyName%'))
					BEGIN
			 
						update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
						PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName, a.AddressId = ZA.AddressId
						from ##CustomerUserAddDetail a
						inner join ZnodeAccountAddress ZAA on a.AccountId = ZAA.AccountId
						inner  JOIN ZnodeAddress ZA on ZA.AddressId = ZAA.AddressId
						where isnull(a.AccountId,0)<> 0-- is not null
	 
						update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
						PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName, a.AddressId = ZA.AddressId
						from ##CustomerUserAddDetail a
						inner join ZnodeUserAddress ZUA on a.UserId = ZUA.UserId
						inner  JOIN ZnodeAddress ZA on ZA.AddressId = zua.AddressId
					END

					----Updating SalesRep for user if any 
					update CUAD
					set CUAD.SalesRepUserName = azu.UserName, 
					CUAD.SalesRepFullName = (ISNULL(RTRIM(LTRIM(ZU.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '')
					+CASE
					WHEN ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '') = ''
					THEN ''
					ELSE ' '
					END+ISNULL(RTRIM(LTRIM(ZU.LastName)), '')) 
					from ##CustomerUserAddDetail CUAD
					inner join ZnodeSalesRepCustomerUserPortal SRCUP ON CUAD.UserId = SRCUP.CustomerUserid 
					inner join ZnodeUser ZU ON SRCUP.SalesRepUserId = ZU.UserId
					inner join ASPNetUsers ANU ON(ZU.AspNetuserId = ANU.Id)
					inner join AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = ANU.UserName)

					if ( exists(select * from ##UserList) OR @AddressColumnWhereClause <> '')
					begin
						SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
						EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,
						Isnull(FirstName,'') +  ' ' + ISnull(LastName,'')  FullName,
						AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
						BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode ,CustomerPaymentGUID,StoreName,PortalId,
						CountryName, CityName, StateName, PostalCode, CompanyName, SalesRepUserName, SalesRepFullName, AccountCode
						from ##CustomerUserAddDetail CUAD
						where exists(select * from ##UserList UL where CUAD.UserId = UL.UserId and CUAD.AddressId = UL.AddressID )
						Order by RowNumber
					end
					else
					begin
						SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
						EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,
						Isnull(FirstName,'') +  ' ' + ISnull(LastName,'')  FullName,
						AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
						BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode ,CustomerPaymentGUID,StoreName,PortalId,
						CountryName, CityName, StateName, PostalCode, CompanyName, SalesRepUserName, SalesRepFullName, AccountCode
						from ##CustomerUserAddDetail
						Order by RowNumber
					end
	
					if OBJECT_ID('tempdb..##CustomerUserAddDetail') is not null
					drop table ##CustomerUserAddDetail

					if OBJECT_ID('tempdb..##View_CustomerUserAddDetail') is not null
					drop table ##View_CustomerUserAddDetail
				
				END;
            ELSE
				BEGIN
					SELECT * FROM View_CustomerUserDetail AS VICUD WHERE 1 = 0;
					SET @RowCount = 0;
				END;
            END;			
         END TRY
         BEGIN CATCH
            DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_AdminUsersByUserId @RoleName = '+@RoleName+' ,@UserName='+@UserName+',@WhereClause='+cast(@WhereClause as varchar(max))+' ,@Rows= '+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_By='+@Order_By+',@RowCount='+CAST(@RowCount AS VARCHAR(50));
            EXEC Znode_InsertProcedureErrorLog
            @ProcedureName    = 'Znode_AdminUsersByUserId',
            @ErrorInProcedure = @ERROR_PROCEDURE,
            @ErrorMessage     = @ErrorMessage,
            @ErrorLine        = @ErrorLine,
            @ErrorCall        = @ErrorCall;
         END CATCH;


     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_SetPublishPortalBrandEntity')
	DROP PROC Znode_SetPublishPortalBrandEntity

GO

CREATE PROCEDURE [dbo].[Znode_SetPublishPortalBrandEntity]
(
   @PortalId  INT = 0 
  ,@LocaleId  INT = 0 
  ,@PreviewVersionId INT = 0 
  ,@IsPreviewEnable int = 0 
  ,@ProductionVersionId INT = 0 
  ,@RevisionState varchar(50) = '' 
  ,@UserId int = 0 
  ,@Status int = 0 OUTPUT
)
AS
/*
    This Procedure is used to publish the blog news against the store 
  
	EXEC ZnodeSetPublishPortalBrandEntity 1 2,3
	A. 
		1. Preview - Preview
		2. None    - Production   --- 
		3. Production - Preview/Production
	B.
		select * from ZnodePublishStateApplicationTypeMapping
		select * from ZnodePublishState where PublishStateId in (3,4) 
		select * from ZnodePublishPortalLog 
	C.
		Select * from ZnodePublishState where IsDefaultContentState = 1  and IsContentState = 1  --Production 
    
	Unit testing 
	
	Exec [ZnodeSetPublishPortalBrandEntity]
	   @PortalId  = 7 
	  ,@LocaleId  = 0 
	  ,@PreviewVersionId = 0 
	  ,@ProductionVersionId = 0 
	  ,@RevisionState = 'Production' 
	  ,@CMSMappingId = 0
	  ,@UserId = 0 
  
	*/
BEGIN 
BEGIN TRY 
SET NOCOUNT ON
   
   Begin 
		DECLARE @Tbl_PreviewVersionId    TABLE    (PreviewVersionId int , PortalId int , LocaleId int)
		DECLARE @Tbl_ProductionVersionId TABLE    (ProductionVersionId int  , PortalId int , LocaleId int)

		If @PreviewVersionId = 0 
			Begin
   				Insert into @Tbl_PreviewVersionId 
				SELECT distinct VersionId , PortalId, LocaleId from  ZnodePublishWebStoreEntity where (PortalId = @PortalId or @PortalId=0 ) and  (LocaleId = 	@LocaleId OR @LocaleId = 0  ) and PublishState ='PREVIEW'
			end
		Else 
				Insert into @Tbl_PreviewVersionId SELECT distinct VersionId , PortalId, LocaleId from  ZnodePublishWebStoreEntity 
				where VersionId = @PreviewVersionId
		If @ProductionVersionId = 0 
   			Begin
				Insert into @Tbl_ProductionVersionId 
				SELECT distinct VersionId , PortalId , LocaleId from  ZnodePublishWebStoreEntity where (PortalId = @PortalId or @PortalId=0 ) and  (LocaleId = 	@LocaleId OR @LocaleId = 0  ) and PublishState ='PRODUCTION'
			End 
		Else 
			Insert into @Tbl_ProductionVersionId SELECT distinct VersionId , PortalId, LocaleId from  ZnodePublishWebStoreEntity 
			where VersionId = @ProductionVersionId
 
		DECLARE @SetLocaleId INT , @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleId(), @MaxCount INT =0 , @IncrementalId INT = 1  
		DECLARE @TBL_Locale TABLE (LocaleId INT , RowId INT IDENTITY(1,1))
		
			DECLARE @TBL_BrandDetails TABLE  
        (
			Description         NVARCHAR(MAX),  
			BrandId             INT,  
			BrandCode           VARCHAR(600),  
			DisplayOrder        INT,  
			IsActive            BIT,  
			WebsiteLink         NVARCHAR(1000),  
			BrandDetailLocaleId INT,  
			SEOFriendlyPageName NVARCHAR(600),  
			MediaPath           NVARCHAR(MAX),  
			MediaId             INT,  
			ImageName           VARCHAR(300),
			BrandName			VARCHAR(100),	
			Custom1				NVARCHAR(MAX),	
			Custom2				NVARCHAR(MAX),
			Custom3				NVARCHAR(MAX),
			Custom4				NVARCHAR(MAX),
			Custom5				NVARCHAR(MAX),
			PortalId			Int,
			IsAssociated        Bit 
        );  
  
    DECLARE @AttributeId INT= [dbo].[Fn_GetProductBrandAttributeId]();  
             
	DECLARE @TBL_AttributeDefault TABLE  
    (
		PimAttributeId            INT,  
		AttributeDefaultValueCode VARCHAR(600),  
		IsEditable                BIT,  
		AttributeDefaultValue     NVARCHAR(MAX),
		DisplayOrder			  INT   
    );  

    DECLARE @TBL_SeoDetails TABLE  
    (
		CMSSEODetailId       INT,  
		SEOTitle             NVARCHAR(MAX),  
		SEOKeywords          NVARCHAR(MAX),  
		SEOURL               NVARCHAR(MAX),  
		ModifiedDate         DATETIME,  
		SEODescription       NVARCHAR(MAX),  
		MetaInformation      NVARCHAR(MAX),  
		IsRedirect           BIT,  
		CMSSEODetailLocaleId INT,  
		--SEOId                INT ,
		PublishStatus        NVARCHAR(20),
		SEOCode				 NVARCHAR(4000),
		CanonicalURL		 VARCHAR(200),
		RobotTag			 VARCHAR(50)			   
    );  

    DECLARE @TBL_BrandDetail TABLE  
    (
		Description          NVARCHAR(MAX),  
		BrandId              INT,  
		BrandCode            VARCHAR(600),  
		DisplayOrder         INT,  
		IsActive             BIT,  
		WebsiteLink          NVARCHAR(1000),  
		BrandDetailLocaleId  INT,  
		MediaPath            NVARCHAR(MAX),  
		MediaId              INT,  
		ImageName      VARCHAr(300) ,  
		CMSSEODetailId       INT,  
		SEOTitle             NVARCHAR(MAX),  
		SEOKeywords          NVARCHAR(MAX),  
		SEOURL               NVARCHAR(MAX),  
		ModifiedDate         DATETIME,  
		SEODescription       NVARCHAR(MAX),  
		MetaInformation      NVARCHAR(MAX),  
		IsRedirect           BIT,  
		CMSSEODetailLocaleId INT,  
		--SEOId                INT,  
		BrandName            NVARCHAR(MAX),  
		RowId                INT,  
		CountId              INT ,
		SEOCode              NVARCHAR(4000), 
		Custom1              NVARCHAR(MAX),
		Custom2              NVARCHAR(MAX),
		Custom3              NVARCHAR(MAX),
		Custom4              NVARCHAR(MAX),
		Custom5              NVARCHAR(MAX),
		PortalId			 INT
    );  

		iF object_id('tempdb..[#TBL_BrandDetail]') IS NOT NULL
			drop table tempdb..#TBL_BrandDetail
		Create Table #TBL_BrandDetail
		(
			Description          NVARCHAR(MAX),  
			BrandId              INT,  
			BrandCode            VARCHAR(600),  
			DisplayOrder         INT,  
			IsActive             BIT,  
			WebsiteLink          NVARCHAR(1000),  
			BrandDetailLocaleId  INT,  
			MediaPath            NVARCHAR(MAX),  
			MediaId              INT,  
			ImageName      VARCHAr(300) ,  
			CMSSEODetailId       INT,  
			SEOTitle             NVARCHAR(MAX),  
			SEOKeywords          NVARCHAR(MAX),  
			SEOFriendlyPageName  NVARCHAR(MAX),  
			ModifiedDate         DATETIME,  
			SEODescription       NVARCHAR(MAX),  
			MetaInformation      NVARCHAR(MAX),  
			IsRedirect           BIT,  
			CMSSEODetailLocaleId INT,  
			--SEOId                INT,  
			BrandName            NVARCHAR(MAX),  
			PromotionId		     INT,
			RowId                INT,  
			CountId              INT ,
			SEOCode              NVARCHAR(4000), 
			Custom1              NVARCHAR(MAX),
			Custom2              NVARCHAR(MAX),
			Custom3              NVARCHAR(MAX),
			Custom4              NVARCHAR(MAX),
			Custom5              NVARCHAR(MAX),
			PortalId			 INT,
			LocaleId             INT  
		);  
		
		
		;WITH Cte_GetBrandBothLocale AS 
	(
		SELECT ZBDL.Description,ZBD.BrandId,LocaleId,ZBD.BrandCode,isnull(ZPB.DisplayOrder,999) as DisplayOrder,ZBD.IsActive,ZBD.WebsiteLink,ZBDl.BrandDetailLocaleId,  
			SEOFriendlyPageName,[dbo].[Fn_GetMediaThumbnailMediaPath](Zm.path) MediaPath,ZBD.MediaId,Zm.path ImageName, ZBDL.BrandName, ZBD.Custom1, ZBD.Custom2, ZBD.Custom3, ZBD.Custom4, ZBD.Custom5, ZPB.PortalId,
			CASE WHEN ZPB.PortalBrandId IS NULL THEN 0 ELSE 1 END IsAssociated
		FROM ZnodeBrandDetails ZBD 
		LEFT JOIN ZnodePortalBrand ZPB ON ZBD.BrandId = ZPB.BrandId AND (ZPB.PortalId = @PortalId OR isnull(@PortalId,0) = 0 )
		LEFT JOIN ZnodeBrandDetailLocale ZBDL ON(ZBD.BrandId = ZBDL.BrandId)  
		LEFT JOIN ZnodeMedia ZM ON(ZM.MediaId = ZBD.MediaId)  
		WHERE LocaleId IN(@LocaleId, @DefaultLocaleId)  
		
              
    ),  
    Cte_BrandFirstLocale AS 
	(
		SELECT Description,BrandId,LocaleId,BrandCode,DisplayOrder,IsActive,WebsiteLink,BrandDetailLocaleId,SEOFriendlyPageName,MediaPath,MediaId,ImageName , BrandName, Custom1, Custom2, Custom3, Custom4, Custom5, PortalId , IsAssociated
        FROM Cte_GetBrandBothLocale CTGBBL  
        WHERE LocaleId = @LocaleId
	),  
    Cte_BrandDefaultLocale AS 
	(
		SELECT Description,BrandId,BrandCode,DisplayOrder,IsActive,WebsiteLink,BrandDetailLocaleId,SEOFriendlyPageName,MediaPath,MediaId,ImageName, BrandName, Custom1, Custom2, Custom3, Custom4, Custom5, PortalId, IsAssociated  
        FROM Cte_BrandFirstLocale  
        UNION ALL  
        SELECT Description,BrandId,BrandCode,DisplayOrder,IsActive,WebsiteLink,BrandDetailLocaleId,SEOFriendlyPageName,MediaPath,MediaId,ImageName , BrandName, Custom1, Custom2, Custom3, Custom4, Custom5, PortalId, IsAssociated
		FROM Cte_GetBrandBothLocale CTBBL  
		WHERE LocaleId = @DefaultLocaleId  
		AND NOT EXISTS  
		(  
			SELECT TOP 1 1  
			FROM Cte_BrandFirstLocale CTBFL  
			WHERE CTBBL.BrandId = CTBFL.BrandId  
		)
	)    
	INSERT INTO @TBL_BrandDetails (Description,BrandId,BrandCode,DisplayOrder,IsActive,WebsiteLink,BrandDetailLocaleId,SEOFriendlyPageName,MediaPath,MediaId,ImageName, BrandName, Custom1, Custom2, Custom3, Custom4, Custom5, PortalId, IsAssociated)  
    SELECT Description,BrandId,BrandCode,DisplayOrder,IsActive,WebsiteLink,BrandDetailLocaleId,SEOFriendlyPageName,MediaPath,MediaId,ImageName , BrandName, Custom1, Custom2, Custom3, Custom4, Custom5, PortalId, IsAssociated
    FROM Cte_BrandDefaultLocale CTEBD;
       
	-----Update BrandName from attributedefault value
	;WITH Cte_GetBrandNameLocale AS 
	(
		select d.brandcode, a.AttributeDefaultValueCode, b.AttributeDefaultValue, b.LocaleId 
		from ZnodePimAttributeDefaultValue a
		inner join ZnodePimAttributeDefaultValueLocale b on a.PimAttributeDefaultValueId = b.PimAttributeDefaultValueId 
		inner join ZnodePimAttribute c on a.PimAttributeId = c.PimAttributeId
		inner join @TBL_BrandDetails d on a.AttributeDefaultValueCode = d.brandcode
		where c.attributecode = 'brand' and b.LocaleId IN(@LocaleId, @DefaultLocaleId)
              
    )
	,Cte_BrandNameFirstLocale AS 
	(
		SELECT brandcode, AttributeDefaultValueCode, AttributeDefaultValue, LocaleId  
        FROM Cte_GetBrandNameLocale CTGBBL  
        WHERE LocaleId = @LocaleId
	)
	,Cte_BrandDefaultLocale AS 
	(
		SELECT brandcode, AttributeDefaultValueCode, AttributeDefaultValue, LocaleId  
        FROM Cte_BrandNameFirstLocale  
        UNION ALL  
        SELECT brandcode, AttributeDefaultValueCode, AttributeDefaultValue, LocaleId  
		FROM Cte_GetBrandNameLocale CTBBL  
		WHERE LocaleId = @DefaultLocaleId  
		AND NOT EXISTS  
		(  
			SELECT TOP 1 1  
			FROM Cte_BrandNameFirstLocale CTBFL  
			WHERE CTBBL.brandcode = CTBFL.brandcode  
		)
	)  
	update b1 set b1.brandname = a1.AttributeDefaultValue
	from Cte_BrandDefaultLocale a1
	inner join @TBL_BrandDetails b1 on a1.brandcode = b1.brandcode

	DECLARE @SeoCode SelectColumnList
	INSERT INTO @SeoCode
	SELECT BrandCode FROM @TBL_BrandDetails
				

    INSERT INTO @TBL_SeoDetails 
	(
		CMSSEODetailId,SEOTitle,SEOKeywords,SEOURL,ModifiedDate,SEODescription,MetaInformation,IsRedirect,
		CMSSEODetailLocaleId,PublishStatus,SEOCode,CanonicalURL,RobotTag
	)  
    EXEC Znode_GetSeoDetails @SeoCode, 'Brand', @LocaleId;  
			              
    SELECT TBBD.*,TBSD.*
    INTO #TM_BrandLocale  
    FROM @TBL_BrandDetails TBBD  
    INNER JOIN @TBL_SeoDetails TBSD ON(TBSD.SEOCode = TBBD.BrandCode)  
	INNER JOIN ZnodeCmsSeoDetail CSD ON TBSD.CMSSEODetailId = CSD.CMSSEODetailId AND TBBD.PortalId = CSD.PortalId
	
	INSERT INTO #TM_BrandLocale
	SELECT DISTINCT TBBD.*,TBSD.*
    FROM @TBL_BrandDetails TBBD  
    LEFT JOIN @TBL_SeoDetails TBSD ON(TBSD.SEOCode = TBBD.BrandCode) 
	WHERE NOT EXISTS(SELECT * FROM #TM_BrandLocale BL WHERE TBBD.BrandId = BL.BrandId AND TBBD.BrandDetailLocaleId = BL.BrandDetailLocaleId)

		INSERT INTO @TBL_Locale (LocaleId) SELECT LocaleId FROM ZnodeLocale WHERE IsActive =1 AND (LocaleId  = @LocaleId OR @LocaleId = 0 )

		SET @MaxCount = ISNULL((SELECT MAx(RowId) FROM @TBL_Locale),0)
		WHILE @IncrementalId <= @MaxCount
		BEGIN 
			SET @SetLocaleId = (SELECT Top 1 LocaleId FROM @TBL_locale WHERE RowId = @IncrementalId)
			
			Insert into #TBL_BrandDetail
			(BrandId,Description,BrandCode,DisplayOrder,IsActive,WebsiteLink,BrandDetailLocaleId,MediaPath,MediaId,ImageName,CMSSEODetailId,SEOTitle,SEOKeywords,SEOFriendlyPageName,SEODescription,MetaInformation,IsRedirect,CMSSEODetailLocaleId,BrandName,
			PromotionId ,SEOCode,Custom1, Custom2, Custom3, Custom4, Custom5, PortalId,LocaleId)
			select BrandId,Description,BrandCode,DisplayOrder,IsActive,WebsiteLink,BrandDetailLocaleId,MediaPath,MediaId,ImageName,CMSSEODetailId,SEOTitle,SEOKeywords,SEOFriendlyPageName,SEODescription,MetaInformation,IsRedirect,CMSSEODetailLocaleId,BrandName,
			0 PromotionId ,SEOCode,Custom1, Custom2, Custom3, Custom4, Custom5, PortalId ,@SetLocaleId from #TM_BrandLocale 
			where  PortalId = @PortalId
		SET @IncrementalId = @IncrementalId +1 
		END 
	End


	If @IsPreviewEnable = 1 AND ( @RevisionState like '%Preview%'  OR @RevisionState like '%Production%' ) 
	Begin
	    --Data inserted into flat table ZnodePublishPortalBrandEntity (Replica of MongoDB Collection )  
		Delete from ZnodePublishPortalBrandEntity where PortalId = @PortalId  and VersionId in 
		( Select PreviewVersionId from @Tbl_PreviewVersionId)
		
		Insert Into ZnodePublishPortalBrandEntity 
		(VersionId,PublishStartTime,PortalId,LocaleId, BrandId,BrandCode,BrandName,MediaId ,WebsiteLink,Description,PublishState,
		 SEOTitle,SEOKeywords,SEODescription,SEOFriendlyPageName ,DisplayOrder,IsActive,MediaPath,CMSSEODetailId,CMSSEODetailLocaleId,
		 BrandDetailLocaleId,ImageName,Custom1,Custom2,Custom3,Custom4,Custom5)
		SELECT B.PreviewVersionId , Getdate(),B.PortalId ,B.LocaleId ,a.BrandId,BrandCode,BrandName,MediaId ,WebsiteLink,
		       Description,'PREVIEW',SEOTitle,SEOKeywords,SEODescription,SEOFriendlyPageName ,a.DisplayOrder,IsActive,MediaPath,
			   CMSSEODetailId,CMSSEODetailLocaleId,BrandDetailLocaleId,ImageName,Custom1,Custom2,Custom3,Custom4,Custom5
		FROM #TBL_BrandDetail A inner join @TBL_PreviewVersionId B on 
		@PortalId= B.PortalId and A.LocaleId = b.LocaleId
		inner join ZnodePortalBrand ZPB on a.BrandId = ZPB.BrandId and b.PortalId = ZPB.PortalId

	End
	-------------------------- End Preview 
	If (@RevisionState like '%Production%' OR @RevisionState = 'None')
	Begin
		-- Only production version id will process 
		Delete from ZnodePublishPortalBrandEntity where PortalId = @PortalId  and VersionId in (select ProductionVersionId from @TBL_ProductionVersionId)
		
		Insert Into ZnodePublishPortalBrandEntity 
		(VersionId,PublishStartTime,PortalId,LocaleId,BrandId,BrandCode,BrandName,MediaId
		 ,WebsiteLink,Description,PublishState,SEOTitle,SEOKeywords,SEODescription,SEOFriendlyPageName
		 ,DisplayOrder,IsActive,MediaPath,CMSSEODetailId,CMSSEODetailLocaleId,BrandDetailLocaleId,ImageName)
		SELECT B.ProductionVersionId , Getdate(),B.PortalId ,B.LocaleId
		,a.BrandId,BrandCode,BrandName,MediaId
		,WebsiteLink,Description,'PREVIEW',SEOTitle,SEOKeywords,SEODescription,SEOFriendlyPageName
		,a.DisplayOrder,IsActive,MediaPath,CMSSEODetailId,CMSSEODetailLocaleId,BrandDetailLocaleId,ImageName
		FROM #TBL_BrandDetail A inner join @TBL_ProductionVersionId B on 
		@PortalId= B.PortalId and A.LocaleId = b.LocaleId
		inner join ZnodePortalBrand ZPB on a.BrandId = ZPB.BrandId and b.PortalId = ZPB.PortalId
	End
	SET @Status =1 
END TRY 
BEGIN CATCH 
	SET @Status = 0;
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC ZnodeSetPublishPortalBrandEntity 
		@PortalId = '+CAST(@PortalId AS VARCHAR	(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))
		+',@PreviewVersionId = ' + CAST(@PreviewVersionId  AS varchar(20))
		+',@ProductionVersionId = ' + CAST(@ProductionVersionId  AS varchar(20))
		+',@RevisionState = ''' + CAST(@RevisionState  AS varchar(50))
		+',@UserId = ' + CAST(@UserId AS varchar(20));	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		                			 
	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'ZnodeSetPublishPortalBrandEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;

	END CATCH
END

GO

UPDATE ZnodePaymentType SET BehaviorType='COD' WHERE Code = 'INVOICEME' AND BehaviorType <> 'COD'
