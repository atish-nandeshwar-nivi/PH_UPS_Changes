IF EXISTS (SELECT TOP 1 1 FROM Sys.Tables WHERE Name = 'ZnodeMultifront')
BEGIN 
IF EXISTS (SELECT TOP 1 1 FROM ZnodeMultifront where BuildVersion =   973 and VersionName = 'Znode_Multifront_9_7_3_GA' )
BEGIN 
PRINT 'Script is already executed....'
 SET NOEXEC ON 
END 
END
ELSE 
BEGIN 
  SET NOEXEC ON
END 
INSERT INTO [dbo].[ZnodeMultifront] ( [VersionName], [Descriptions], [MajorVersion], [MinorVersion], [LowerVersion], [BuildVersion], [PatchIndex], [CreatedBy], 
[CreatedDate], [ModifiedBy], [ModifiedDate]) 
VALUES ( N'Znode_Multifront_9_7_3_GA', N'Upgrade GA Release by 973',9,7,3,973,0,2, GETDATE(),2, GETDATE())
GO 
SET ANSI_NULLS ON

GO

IF EXISTS (SELECT * FROM SYS.TABLES WHERE NAME='ZnodeProductFeed')
AND NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME='PortalId' AND TABLE_NAME='ZnodeProductFeed')
BEGIN
	TRUNCATE TABLE ZnodeProductFeed
END

GO
IF EXISTS(SELECT TOP 1 PortalId FROM znodePortal WHERE storecode = 'MaxwellsHardware')
BEGIN
	insert into ZnodeCMSWidgetTitleConfiguration(TitleCode,CMSWidgetsId,WidgetsKey,CMSMappingId,TypeOFMapping,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
	select 'Register for a Business Account',(select top 1 CMSWidgetsId from ZnodeCMSWidgets where code = 'LinkPanel'),'2243',
	 (select top 1 PortalId from znodePortal where storecode = 'MaxwellsHardware'),'PortalMapping',2,getdate(),2,getdate()
	where not exists(select * from ZnodeCMSWidgetTitleConfiguration where TitleCode = 'Register for a Business Account'
	and CMSWidgetsId = (select top 1 CMSWidgetsId from ZnodeCMSWidgets where code = 'LinkPanel') and WidgetsKey = '2243'
	and CMSMappingId = (select top 1 PortalId from znodePortal where storecode = 'MaxwellsHardware'))


	insert into ZnodeCMSWidgetTitleConfigurationLocale(
	CMSWidgetTitleConfigurationId,MediaId,Title,Url,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsNewTab,DisplayOrder)
	select (select top 1 CMSWidgetTitleConfigurationId from ZnodeCMSWidgetTitleConfiguration where TitleCode = 'Register for a Business Account')
	,0,'Register for a Business Account','/provideyourbusinessform',1,2,getdate(),2,getdate(),0,999
	where not exists(select * from ZnodeCMSWidgetTitleConfigurationLocale where CMSWidgetTitleConfigurationId = (select top 1 CMSWidgetTitleConfigurationId from ZnodeCMSWidgetTitleConfiguration where TitleCode = 'Register for a Business Account')
	and LocaleId = 1 )

	insert into ZnodeCMSWidgetTitleConfiguration(TitleCode,CMSWidgetsId,WidgetsKey,CMSMappingId,TypeOFMapping,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
	select 'Promotional Products',(select top 1 CMSWidgetsId from ZnodeCMSWidgets where code = 'LinkPanel'),'2253',
	 (select top 1 PortalId from znodePortal where storecode = 'MaxwellsHardware'),'PortalMapping',2,getdate(),2,getdate()
	where not exists(select * from ZnodeCMSWidgetTitleConfiguration where TitleCode = 'Promotional Products'
	and CMSWidgetsId = (select top 1 CMSWidgetsId from ZnodeCMSWidgets where code = 'LinkPanel') and WidgetsKey = '2253'
	and CMSMappingId = (select top 1 PortalId from znodePortal where storecode = 'MaxwellsHardware'))


	insert into ZnodeCMSWidgetTitleConfigurationLocale(
	CMSWidgetTitleConfigurationId,MediaId,Title,Url,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsNewTab,DisplayOrder)
	select (select top 1 CMSWidgetTitleConfigurationId from ZnodeCMSWidgetTitleConfiguration where TitleCode = 'Promotional Products')
	,0,'Promotional Products','/promotional_products',1,2,getdate(),2,getdate(),0,999
	where not exists(select * from ZnodeCMSWidgetTitleConfigurationLocale where CMSWidgetTitleConfigurationId = (select top 1 CMSWidgetTitleConfigurationId from ZnodeCMSWidgetTitleConfiguration where TitleCode = 'Promotional Products')
	and LocaleId = 1 )
END

GO
update ZnodeMenuActionsPermission set MenuId=(select Top 1 MenuId from ZnodeMenu where MenuName='Orders') where ActionId=(select Top 1 ActionId from ZnodeActions where ActionName='FailedOrderTransactionList');
update ZnodeActionMenu set MenuId= (select Top 1 MenuId from ZnodeMenu where MenuName='Orders') where ActionId=(select Top 1 ActionId from ZnodeActions where ActionName='FailedOrderTransactionList');
update ZnodeActions set ControllerName='Order' where ActionName='FailedOrderTransactionList';

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetGiftCardDetails')
	DROP PROC Znode_GetGiftCardDetails
GO

CREATE PROCEDURE [dbo].[Znode_GetGiftCardDetails]
(
	@VoucherCodes Varchar(max),
	@OmsOrderDetailsId   int
)
AS
BEGIN  
    BEGIN TRY  
        DECLARE @IsApplied as bit = 1;
        SET NOCOUNT ON;
        ;With Cte_GiftCart as
        (
            Select Gift.GiftCardId,GiftHistory.OmsOrderDetailsId,Gift.PortalId,Gift.Name as VoucherName,Gift.CardNumber as VoucherNumber,GiftHistory.TransactionAmount as VoucherAmountUsed
            , @IsApplied as IsVoucherApplied, ISNULL(Gift.RemainingAmount,0) as VoucherBalance, Gift.IsActive as IsActive,Gift.ExpirationDate, 
            ISNULL(Gift.RemainingAmount,0) as RemainingAmount, ZOD.OmsOrderId
            , ROW_NUMBER() OVER (ORDER BY ZOD.OmsOrderId) As Rn
            from ZnodeGiftCard Gift
            INNER JOIN ZnodeGiftCardHistory GiftHistory ON Gift.GiftCardId = GiftHistory.GiftCardId
            LEFT JOIN ZnodeOmsOrderDetails ZOD on (GiftHistory.OmsOrderDetailsId = ZOD.OmsOrderDetailsId AND ZOD.IsActive = 1)
            LEFT JOIN ZnodeOmsOrder ZO on (ZOD.OmsOrderId = ZO.OmsOrderId)
            Where Gift.CardNumber in (select ltrim(rtrim(Item)) From dbo.Split(@VoucherCodes,',')) AND GiftHistory.OmsOrderDetailsId = @OmsOrderDetailsId
        )
        ,Cte_GiftCart1 as
        (
           SELECT ZOD.OmsOrderId,GiftHistory.GiftCardId,ISNULL(Gift.RemainingAmount,0) as RemainingAmount, min(GiftHistory.OmsOrderDetailsId) as OmsOrderDetailsId
           FROM ZnodeGiftCardHistory GiftHistory
           inner join ZnodeGiftCard Gift ON GiftHistory.GiftCardId = Gift.GiftCardId
           LEFT JOIN ZnodeOmsOrderDetails ZOD on (GiftHistory.OmsOrderDetailsId = ZOD.OmsOrderDetailsId AND ZOD.IsActive = 1)
           LEFT JOIN ZnodeOmsOrder ZO on (ZOD.OmsOrderId = ZO.OmsOrderId)  
           WHERE EXISTS(select * from  Cte_GiftCart Gift where GiftHistory.GiftCardId = Gift.GiftCardId)
           GROUP BY ZOD.OmsOrderId,GiftHistory.GiftCardId,Gift.RemainingAmount
        )
        ,CTE_OrderVoucherAmount AS
       (
           SELECT ISNULL(cte.OmsOrderId,0) AS OmsOrderId,cte.OmsOrderDetailsId,Hist.GiftCardId, 
           CASE WHEN cte.OmsOrderId IS NOT NULL THEN Hist.TransactionAmount ELSE Cte.RemainingAmount END as OrderVoucherAmount, ROW_NUMBER() OVER (ORDER BY cte.OmsOrderId) As Rn
           FROM ZnodeGiftCardHistory Hist
           LEFT join Cte_GiftCart1 Cte on Hist.GiftCardId = Cte.GiftCardId and Hist.OmsOrderDetailsId = Cte.OmsOrderDetailsId
           WHERE EXISTS(select * from  Cte_GiftCart Gift where Hist.GiftCardId = Gift.GiftCardId AND Hist.OmsOrderDetailsId = Gift.OmsOrderDetailsId)
           AND CASE WHEN cte.OmsOrderId IS NOT NULL THEN Hist.TransactionAmount ELSE Cte.RemainingAmount END IS NOT NULL
        )
        Select a.GiftCardId, PortalId,VoucherName,VoucherNumber,VoucherAmountUsed,
          IsVoucherApplied, VoucherBalance, IsActive,ExpirationDate, RemainingAmount, OrderVoucherAmount
        from Cte_GiftCart a
        inner join CTE_OrderVoucherAmount b on a.GiftCardId = b.GiftCardId  AND isnull(a.OmsOrderId,0) = isnull(b.OmsOrderId,0) AND a.Rn=b.Rn
        Order By a.ExpirationDate, a.RemainingAmount

    END TRY  
    BEGIN CATCH  
   
        DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),  
        @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetGiftCardDetails @VoucherCodes = '+CAST(@VoucherCodes AS VARCHAR(MAX))+',@OmsOrderDetailsId='+CAST(@OmsOrderDetailsId AS VARCHAR(50))                  
        EXEC Znode_InsertProcedureErrorLog  
        @ProcedureName = 'Znode_GetGiftCardDetails',  
        @ErrorInProcedure = @Error_procedure,  
        @ErrorMessage = @ErrorMessage,  
        @ErrorLine = @ErrorLine,  
        @ErrorCall = @ErrorCall;  
    END CATCH  
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemBundle')
	DROP PROC Znode_InsertUpdateSaveCartLineItemBundle
GO


CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemBundle]
 (
	 @SaveCartLineItemType TT_SavecartLineitems READONLY  
	,@Userid  INT = 0
	,@OrderLineItemRelationshipTypeIdBundle INT
	,@OrderLineItemRelationshipTypeIdAddon INT
 )
AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 
    --Declared the variables
    DECLARE @GetDate datetime= dbo.Fn_GetDate(); 
   
	DECLARE @OmsInsertedData TABLE (OmsSavedCartLineItemId INT ) 	
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId INT,BundleProductIds VARCHAR(600) ,PersonalizeCode NVARCHAR(MAX),PersonalizeValue NVARCHAR(MAX),DesignId NVARCHAR(MAX), ThumbnailURL NVARCHAR(MAX))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.BundleProductIds
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(MAX)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(MAX)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(MAX)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(MAX)' ) AS ThumbnailURL
	FROM @SaveCartLineItemType a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col) 

	CREATE TABLE #NewBundleSavecartLineitemDetails 
	(
		GenId INT IDENTITY(1,1),RowId	INT	,OmsSavedCartLineItemId	INT	 ,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	INT
		,SKU	NVARCHAR(MAX) ,Quantity	NUMERIC(28,6)	,OrderLineItemRelationshipTypeID	INT	,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	INT	,AutoAddon	VARCHAR(MAX)	,OmsOrderId	INT	,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX),
		CustomUnitPrice NUMERIC(28,6)
	)
	
	--Getting new save cart data(bundle product)
	INSERT INTO #NewBundleSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU ,
		CustomUnitPrice
	FROM @SaveCartLineItemType a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,CustomUnitPrice
	 
	--Getting new bundle product save cart data
	INSERT INTO #NewBundleSavecartLineitemDetails 
	SELECT   Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, BundleProductIds
				,Quantity, @OrderLineItemRelationshipTypeIdBundle, CustomText, CartAddOnDetails, Sequence
				,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU,
				CustomUnitPrice
	FROM @SaveCartLineItemType  a 
	WHERE BundleProductIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, BundleProductIds
	,Quantity,  CustomText, CartAddOnDetails, Sequence ,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU,CustomUnitPrice
		
	--Getting new Bundle products save cart data if addon is present for any line item
	INSERT INTO #NewBundleSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
	,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
			WHEN  GroupProductIds <> '' THEN GroupProductIds 
			WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU , CustomUnitPrice
	FROM @SaveCartLineItemType  a 
	WHERE AddOnValueIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU,CustomUnitPrice

    CREATE TABLE #OldBundleSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old bundle save cart data if present for same SKU in the new save cart data for bundle product		 
	INSERT INTO #OldBundleSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM ZnodeOmsSavedCartLineItem a   
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.BundleProductIds,'')   )   
    AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle   

	--Getting the old save cart Parent data
	INSERT INTO #OldBundleSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b 
	INNER JOIN #OldBundleSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
	AND  b.OrderLineItemRelationshipTypeID IS NULL 

	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldBundleSavecartLineitemDetails

	DELETE a FROM #OldBundleSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldBundleSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 

	--Getting the old bundle product save cart addon data for old line items if present
	INSERT INTO #OldBundleSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b 
	INNER JOIN #OldBundleSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
	AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon	

		------Merge Addon for same product
		IF EXISTS(SELECT * FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
		BEGIN

			INSERT INTO #OldValueForAddon 
			SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
			FROM ZnodeOmsSavedCartLineItem b 
			INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
			WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
			AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
									( SELECT  ', ' + SKU FROM    
										( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
											WHERE a.ParentOmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
											FOR XML PATH('')
									), 1, 2, ''
									) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a WHERE a.ParentOmsSavedCartLineItemId is not null and OrderLineItemRelationshipTypeID<>1

		SELECT distinct a.BundleProductIds SKU, STUFF(
										( SELECT  ', ' + x.AddOnValueIds FROM    
										( SELECT DISTINCT b.AddOnValueIds FROM @SaveCartLineItemType b
											WHERE a.SKU=b.SKU ) x
											FOR XML PATH('')
										), 1, 2, ''
									) AddOns
		INTO #AddOnAdded
		FROM @SaveCartLineItemType a

		if NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
		begin
			DELETE FROM #OldBundleSavecartLineitemDetails
		end

		END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @SaveCartLineItemType ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldBundleSavecartLineitemDetails a WHERE	
	ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
	AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN 
		
		DELETE FROM #OldBundleSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
		BEGIN 

			 DECLARE @parenTofAddon INT  = 0 
			 SET @parenTofAddon = (SELECT TOP 1 ParentOmsSavedCartLineItemId 
			 FROM #OldBundleSavecartLineitemDetails a
			 WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
			 AND (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem  t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId AND   t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			  )

			 DELETE FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId <> @parenTofAddon  AND ParentOmsSavedCartLineItemId IS NOT NULL  

			 DELETE FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldBundleSavecartLineitemDetails m)
			 AND ParentOmsSavedCartLineItemId IS  NULL  
		 
			 IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			  BEGIN 
				DELETE FROM #OldBundleSavecartLineitemDetails
			  END 
			IF (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem   WHERE ParentOmsSavedCartLineItemId =@parenTofAddon AND   OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			BEGIN 
				DELETE FROM #OldBundleSavecartLineitemDetails
			END 

		 END 
		 ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) >= 1 
		 BEGIN 
		    DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM ZnodeOmsSavedCartLineItem a 
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
			OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		 END 
		 ELSE IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  BEGIN 
		    DELETE FROM #OldBundleSavecartLineitemDetails
		  END 
		   ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		      AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  = '' )
		 BEGIN 
		   DELETE FROM #OldBundleSavecartLineitemDetails
		 END 

	END 
	
	--Getting the personalise data for old save cart if present
	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		DELETE FROM #OldBundleSavecartLineitemDetails
	END 
	ELSE 
	BEGIN 
		 IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) <>
		     (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM ZnodeOmsSavedCartLineItem WHERE ParentOmsSavedCartLineItemId IS nULL and OmsSavedCartLineItemId in (select OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails)  )
		 BEGIN 
		   
			   DELETE FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
			   SELECT OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			   AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
			   OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			   AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		 
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) <>
		     (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM ZnodeOmsSavedCartLineItem WHERE ParentOmsSavedCartLineItemId IS nULL and OmsSavedCartLineItemId in (select OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails)  )
		 BEGIN 
		   
			   DELETE n FROM #OldBundleSavecartLineitemDetails n WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
			   OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
		
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		        AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldBundleSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
		       AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		 BEGIN 
		     DELETE FROM #OldBundleSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		 END 
		END 

	IF EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails )
	BEGIN 
		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU not having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*
			FROM @SaveCartLineItemType a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on ( a.BundleProductIds = b.SKU or a.SKU = b.sku)
			WHERE isnull(cast(a.PersonalisedAttribute AS varchar(max)),'') = ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId
			FROM #OldBundleSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
		)
		DELETE a FROM #OldBundleSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*, 
				a.PersonalizeCode
				,a.PersonalizeValue
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on ( a.BundleProductIds = b.SKU )
			WHERE isnull(a.PersonalizeValue,'') <> ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId, b.PersonalizeCode, b.PersonalizeValue
			FROM #OldBundleSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
			WHERE NOT EXISTS(SELECT * FROM cte c WHERE b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and b.PersonalizeCode = c.PersonalizeCode 
								and b.PersonalizeValue = c.PersonalizeValue )
		)
		DELETE a FROM #OldBundleSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)


		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,b.ParentOmsSavedCartLineItemId , a.BundleProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on a.BundleProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM #OldBundleSavecartLineitemDetails b1 
		WHERE NOT EXISTS(SELECT * FROM cte c WHERE (b1.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or b1.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId))
		AND EXISTS(SELECT * FROM cte)
		-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b ON a.BundleProductIds = b.SKU
			LEFT JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
			--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewBundleSavecartLineitemDetails b ON a.BundleProductIds = b.SKU
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		from CTE_OldPersonalizeCodeCount a
		inner join CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		inner join #OldBundleSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
	
		--Delete parent entry if child not present
		DELETE a FROM #OldBundleSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldBundleSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.BundleProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on a.BundleProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE c1
		FROM cte a1		  
		INNER JOIN #OldBundleSavecartLineitemDetails b1 on a1.SKU = b1.SKU
		INNER JOIN #OldBundleSavecartLineitemDetails c1 on (b1.ParentOmsSavedCartLineItemId = c1.OmsSavedCartLineItemId OR b1.OmsSavedCartLineItemId = c1.OmsSavedCartLineItemId)
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c WHERE a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and a1.PersonalizeValue = c.PersonalizeValue)

		--Updating the cart if old and new cart data matches	
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5,
		a.ModifiedDate = @GetDate,
		a.CustomUnitPrice = ty.CustomUnitPrice
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldBundleSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewBundleSavecartLineitemDetails ty ON (ty.SKU = b.SKU)
		WHERE a.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon

		 UPDATE a
		 SET a.Quantity = a.Quantity+s.AddOnQuantity,
		 a.ModifiedDate = @GetDate
		 FROM ZnodeOmsSavedCartLineItem a
		 INNER JOIN #OldBundleSavecartLineitemDetails b ON (a.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		 INNER JOIN @SaveCartLineItemType S on a.OmsSavedCartId = s.OmsSavedCartId and a.SKU = s.AddOnValueIds
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon

		 --UPDATE Ab SET ab.Quantity = a.Quantity   
   --      FROM ZnodeOmsSavedCartLineItem a  
   --      INNER JOIN ZnodeOmsSavedCartLineItem ab ON (ab.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)  
   --      INNER JOIN @SaveCartLineItemType b ON (a.OmsSavedCartId = b.OmsSavedCartId  )   
		 --WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle  

		 UPDATE Ab 
		 SET Ab.Quantity = Ab.Quantity+ty.Quantity,
		 Ab.Custom1 = ty.Custom1,
		 Ab.Custom2 = ty.Custom2,
		 Ab.Custom3 = ty.Custom3,
		 Ab.Custom4 = ty.Custom4,
		 Ab.Custom5 = ty.Custom5,
		 ab.ModifiedDate = @GetDate, 
		 ab.CustomUnitPrice = ty.CustomUnitPrice  
         FROM ZnodeOmsSavedCartLineItem a  
         INNER JOIN ZnodeOmsSavedCartLineItem ab ON (ab.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)  
         INNER JOIN @SaveCartLineItemType b ON (a.OmsSavedCartId = b.OmsSavedCartId  ) 
		 INNER JOIN #NewBundleSavecartLineitemDetails ty ON (ty.SKU = b.SKU)  
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle  
		 AND EXISTS(SELECT * FROM #OldBundleSavecartLineitemDetails ov WHERE a.OmsSavedCartLineItemId = ov.OmsSavedCartLineItemId)  

	END 
	IF NOT EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails )
	BEGIN 
			
		UPDATE #NewBundleSavecartLineitemDetails
		SET ParentSKU = (SELECT TOP 1 SKU FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID IS NULL )
		WHERE OrderLineItemRelationshipTypeID  = @OrderLineItemRelationshipTypeIdAddon 
		AND EXISTS (SELECT TOP 1 1 FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle) 
		
		--Getting the new save cart data and generating row no. for new save cart insert
		SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU ,CustomUnitPrice 
		 INTO #InsertNewBundleSavecartLineitem   
		 FROM  #NewBundleSavecartLineitemDetails  
		 GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU ,CustomUnitPrice
		 ORDER BY RowId, Id   
   
		--Removing the line item having Quantity <=0 
		DELETE FROM #InsertNewBundleSavecartLineitem WHERE Quantity <=0  

		;WITH Add_Dup AS
		(
			SELECT  Min(NewRowId)NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID 
			FROM  #InsertNewBundleSavecartLineitem
			GROUP BY SKU ,ParentSKU  ,OrderLineItemRelationshipTypeID
			HAVING OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon	
		)
		DELETE FROM #InsertNewBundleSavecartLineitem
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM Add_Dup WHERE Add_Dup.NewRowId = #InsertNewBundleSavecartLineitem.NewRowId)
		AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		--Updating the rowid INTo new save cart line item AS new line item is merged INTo existing save cart item
		 ;WITH VTTY AS   
		(  
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
			   FROM #InsertNewBundleSavecartLineitem m  
			INNER JOIN  #InsertNewBundleSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU   
			WHERE m.OrderLineItemRelationshipTypeID IN ( @OrderLineItemRelationshipTypeIdAddon , @OrderLineItemRelationshipTypeIdBundle)   
		)   
		UPDATE m1   
		SET m1.RowId = TYU.RowId  
		FROM #InsertNewBundleSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  
      
		--Deleting the new save cart line item if cart line item is merged
		;WITH VTRET AS   
		(  
			SELECT RowId,id,Min(NewRowId)NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID   
			FROM #InsertNewBundleSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU  ,OrderLineItemRelationshipTypeID  
			Having  SKU = ParentSKU  AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		)   
		DELETE FROM #InsertNewBundleSavecartLineitem WHERE NewRowId  IN (SELECT NewRowId FROM VTRET)   
     
	   --Inserting the new cart line item if not merged in existing save cart line item
       INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description,CustomUnitPrice)  
       OUTPUT INSERTED.OmsSavedCartLineItemId  INTO @OmsInsertedData 
	   SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description , CustomUnitPrice 
       FROM  #InsertNewBundleSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU 
		INTO #Cte_newData 
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
		AND a.ParentOmsSavedCartLineItemId IS nULL  
		AND  EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) 
  
		--------------------------------------------------------------------------------------------------------

		SELECT  MIN(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU  
		INTO #ParentOmsSavedCartId
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #ParentOmsSavedCartId  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon   
		AND  EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) 
		AND  a.sequence in (SELECT  MIN(ab.sequence) FROM ZnodeOmsSavedCartLineItem ab WHERE a.OmsSavedCartId = ab.OmsSavedCartId and 
		 a.SKU = ab.sku and ab.OrderLineItemRelationshipTypeId is not null  ) 

		-----------------------------------------------------------------------------------------------------

		SELECT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(Order BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #NewBuldleProduct
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( CASE WHEN EXISTS (SELECT TOP 1 1 FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle) THEN 0 ELSE 1 END = b.id OR b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c on b.sku = c.sku and b.OmsSavedCartId=c.OmsSavedCartId and b.Id = 1
		WHERE ( CASE WHEN EXISTS (SELECT TOP 1 1 FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle) THEN 0 ELSE 1 END = ISNULL(a.ParentOmsSavedCartLineItemId,0) OR ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  AND c.ParentOmsSavedCartLineItemId IS NULL
			AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewBundleSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId)  
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)

	   ;WITH table_update AS 
	   (
		 SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId  ) RowIdNo
		 FROM ZnodeOmsSavedCartLineItem a
		 WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		 AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
		 AND a.ParentOmsSavedCartLineItemId IS NULL  
		 AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewBundleSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
		 AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
	   )
		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewBuldleProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId) 
			FROM #NewBuldleProduct  r  
			WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )    IS NOT NULL 
	 
  
		;WITH Cte_Th AS   
		(             
			  SELECT RowId    
			 FROM #InsertNewBundleSavecartLineitem a   
			 GROUP BY RowId   
			 HAVING COUNT(NewRowId) <= 1   
		)   
		UPDATE a SET a.Quantity =  NULL,
			a.ModifiedDate = @GetDate   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		 AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE Ab SET ab.Quantity = a.Quantity,
			ab.ModifiedDate = @GetDate, ab.CustomUnitPrice = b.CustomUnitPrice   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN ZnodeOmsSavedCartLineItem ab ON (ab.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)  
		INNER JOIN @SaveCartLineItemType b ON (a.OmsSavedCartId = b.OmsSavedCartId  )   
		WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle  

		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewBundleSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		AND OrderLineItemRelationshipTypeId IS NOT NULL     
       
	   ;WITH Cte_UpdateSequence AS   
		 (  
		   SELECT OmsSavedCartLineItemId ,Row_Number()Over(Order By OmsSavedCartLineItemId) RowId , Sequence   
		   FROM ZnodeOmsSavedCartLineItem   
		   WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewBundleSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		 )   
		UPDATE Cte_UpdateSequence  
		SET  Sequence = RowId  
			
		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN ZnodeOmsSavedCartLineItem b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS not nULL
		and b.OmsSavedCartLineItemId = (select min(OmsSavedCartLineItemId) FROM @OmsInsertedData d WHERE b.OmsSavedCartLineItemId = d.OmsSavedCartLineItemId)
	 
		DELETE FROM ZnodeOmsPersonalizeCartItem	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
			
		----Inserting saved cart item personalise value FROM given line item
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
			   ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			   WHEN NOT MATCHED THEN 
				INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
				VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
  
		
		END 
END TRY
BEGIN CATCH 
  SELECT ERROR_MESSAGE()
END CATCH 
END


GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPaymentSetting')
	DROP PROC Znode_GetPaymentSetting
GO

CREATE PROCEDURE [dbo].[Znode_GetPaymentSetting]
(
  @WhereClause  NVARCHAR(Max)  = '',
  @Rows         INT            = 100,
  @PageNo       INT            = 1,
  @Order_BY     VARCHAR(1000)  = ' DisplayOrder ASC',
  @RowsCount    INT OUT            ,
  @PortalId     INT            = 0 ,
  @ProfileId    INT            = 0 ,
  @UserId       INT			   = 0 ,
  @IsAssociated INT            = 0
)
AS
 /*
   Summary :- This procedure is used to get the associated and Unassociated list of paymentsetting for portal and profile

   Unit Testing

   DECLARE @profilei int = 0
   EXEC Znode_GetPaymentSetting @WhereClause = '', @RowsCount =  @profilei OUT ,@PortalId = 0 ,@ProfileId= 0 ,@IsAssociated = 0 ,@UserId= 0  SELECT  @profilei

 */
 BEGIN
  BEGIN TRY
   SET NOCOUNT ON
     DECLARE @SQL NVARCHAR(MAX)= '',@FilterWhereClause VARCHAR(2000) = '' ,@InternalOrderBy VARCHAR(2000)= ''

	 DECLARE @TBL_PaymentSetting TABLE (PaymentSettingId INT, PaymentApplicationSettingId INT,PaymentTypeId INT,PaymentGatewayId INT
										,PaymentName VARCHAR(600),IsActive BIT,DisplayOrder INT,IsTestMode BIT,IsPoDocUploadEnable BIT
										,IsPoDocRequire BIT,CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,ModifiedDate DATETIME
										,PortalId INT,StoreName NVARCHAR(max),IsAssociated BIT,ProfileId int,ProfileName NVARCHAR(200),
										PaymentTypeName VARCHAr(500),GatewayName VARCHAR(300),RowId INT,CountNo INT,PaymentDisplayName nvarchar(1200),
										PaymentExternalId VARCHAR(100),IsApprovalRequired BIT,PaymentCode VARCHAR(200),GatewayCode VARCHAR(200),
										IsCallToPaymentAPI BIT,IsBillingAddressOptional Bit,IsOABRequired BIT,PortalPaymentGroupId INT,PublishState VARCHAR(50),IsUsedForWebStorePayment BIT )


     IF ISNULL(@UserId,0) <> 0  OR (ISNULL(@PortalId,0) > 0 AND ISNULL(@ProfileId,0) > 0)
	 BEGIN
	  DECLARE  @PortalIds VARCHAR(2000) = '' ,@ProfileIds VARCHAR(2000) = '' ,@PaymentSettingIds VARCHAR(2000)
	  IF ISNULL(@UserId,0) <> 0
	  BEGIN
	  
	  SET @PortalIds = @PortalId
	  EXEC Znode_GetUserPortalAndProfile @UserId ,@PortalIds OUT,@ProfileIds OUT
	  
	  END
	  ELSE
	  BEGIN
	 
	   SET @PortalIds = @PortalId
	   SET @ProfileIds = @ProfileId

	  END
	  SET @ProfileIds = CASE WHEN CAST(@ProfileId AS VARCHAr(200))  <= '0' THEN @ProfileIds ELSE CAST(@ProfileId AS VARCHAr(200)) END 
	  EXEC Znode_GetCommonPaymentSetting @PortalIds,@ProfileIds,@PaymentSettingIds OUT

	  SET @FilterWhereClause = ' AND  PaymentSettingId IN ('+ISNULL(@PaymentSettingIds,'0')+') '

	 END

	 SELECT PaymentSettingId ,ZPPG.PortalPaymentGroupId,ZPA.PortalId 
	 INTO #ZnodePortalPaymentApprovers
	 FROM ZnodePortalPaymentApprovers ZPPA 
	 INNER JOIN [ZnodePortalPaymentGroup] ZPPG ON( ZPPA.PortalPaymentGroupId = ZPPG.PortalPaymentGroupId)  
     INNER JOIN [ZnodePortalApproval] ZPA ON (ZPA.PortalApprovalId = ZPPG.PortalApprovalId) 
	 WHERE  ZPA.EnableApprovalManagement =1 AND ZPA.PortalId = @PortalId AND ZPPG.isActive = 1 
	 



	IF ISNULL(@PortalId,0) > 0 AND (   ISNULL(@ProfileId,0) = 0)
	BEGIN
	
	 SET @SQL = '
	             ;With Cte_PaymentSetting AS
				 (
				 SELECT  ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,ZPS.DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,ZP.PortalId,ZP.StoreName, 0 as IsAssociated, NULL ProfileId, NULL ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName
						, CASE WHEN ZPPS.PaymentDisplayName IS NULL OR ZPPS.PaymentDisplayName = ''''  THEN ZPS.PaymentDisplayName ELSE ZPPS.PaymentDisplayName END   PaymentDisplayName,  ZPPS.PaymentExternalId ,
						 CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI, ZPS.IsBillingAddressOptional,ISNULL(ZPS.IsOABRequired,0) IsOABRequired
						 ,YU.PortalPaymentGroupId, ZPPOS.DisplayName PublishState , ZPPS.IsUsedForWebStorePayment
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
				 CROSS APPLY ZnodePortal ZP
				 LEFT JOIN ZnodePortalPaymentSetting ZPPS on ( ZPPS.PortalId = ZP.PortalId AND ZPPS.PaymentSettingId = ZPS.PaymentSettingId)
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = ZPPS.PublishStateId )
				 WHERE  ISNULL(ZPPS.IsUsedForWebStorePayment,0) =  CASE WHEN '+CAST(@IsAssociated AS VARCHAR(10)) +' = 1 THEN  1  ELSE 0 END
				 )

				 '
	 --IF @userId <> 0 
	 --BEGIN 
		--SET @IsAssociated = 1  	
	 --END 
	 
	 SET @FilterWhereClause = ' WHERE PortalId = '+CAST(@PortalId AS VARCHAR(50))
	 SET @InternalOrderBy = ' PaymentSettingId,PortalId '
    END
	ELSE IF ISNULL(@ProfileId,0) > 0 AND ( ISNULL(@UserId,0) = 0 AND  ISNULL(@PortalId,0) = 0)
	BEGIN
	  SET @SQL = '
	            ;With Cte_PaymenTSetting AS
				 (
				 SELECT  ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,CASE WHEN '+CAST(@ProfileId AS VARCHAR(200))+' >= 0 AND '+CAST(@IsAssociated AS VARCHAR(200))+' = 1 THEN ISNULL(ZPPS.DisplayOrder,ZPS.DisplayOrder) ELSE ZPS.DisplayOrder END AS DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,NULL PortalId,NULL StoreName, CASE WHEN ZPPS.ProfilePaymentSettingId IS NULL THEN 0 ELSE 1 END IsAssociated ,ZP.ProfileId,ZP.ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName
						,ZPS.PaymentDisplayName	, NULL PaymentExternalId,
						 CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired  , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI, ZPS.IsBillingAddressOptional,0 IsOABRequired,YU.PortalPaymentGroupId
						 , ISNULL(ZPPOS.DisplayName,''Production'' )  PublishState , 0 AS IsUsedForWebStorePayment
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
				 CROSS APPLY ZnodeProfile ZP
				 LEFT JOIN ZnodeProfilePaymentSetting ZPPS on ( ZPPS.ProfileId = ZP.ProfileId AND ZPPS.PaymentSettingId = ZPS.PaymentSettingId)
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = ZPPS.PublishStateId)
				 )
               '
	   SET @FilterWhereClause = ' WHERE ProfileId = '+CAST(@ProfileId AS VARCHAR(50))+'
									AND  IsAssociated = '+CAST(@IsAssociated AS VARCHAR(50))+CASE WHEN @FilterWhereClause = '' THEN ' ' ELSE @FilterWhereClause END 
	  SET @InternalOrderBy = ' PaymentSettingId,ProfileId '
	END
	ELSE
	BEGIN
	  SET @SQL = '
	            ;With Cte_PaymenTSetting AS
				 (
				 SELECT   ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,NULL PortalId,NULL StoreName, NULL IsAssociated ,NULL ProfileId,NULL ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName	
						,  CASE WHEN '+CAST(@PortalId AS VARCHAR(100))+' > 0  AND ZPPS.PaymentDisplayName  IS NOT NULL  THEN ZPPS.PaymentDisplayName  ELSE  ZPS.PaymentDisplayName   END PaymentDisplayName   , NULL PaymentExternalId, CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired 
						 , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,YU.PortalPaymentGroupId
						 , ISNULL(ZPPOS.DisplayName,''Production'' )  PublishState , 0 AS IsUsedForWebStorePayment
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId AND YOPU.ProfileId = '+CAST(@ProfileId AS NVARCHAr(200))+')
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId) 
				 LEFT JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId  = ZPPS.PaymentSettingId AND ZPPS.PortalId = CASE WHEN '+CAST(@PortalId AS VARCHAR(100))+' > 0  THEN '+CAST(@PortalId AS VARCHAR(100))+' ELSE  YU.PortalId END    )
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = '+CASE WHEN  CAST(@ProfileId AS VARCHAr(200))  > '0' AND EXISTS (SELECT TOP 1 1 FROM ZnodeProfilePaymentSetting NT WHERE NT.ProfileId  = @ProfileId ) 
				 THEN  ' YOPU.PublishStateId '  ELSE ' ZPPS.PublishStateId ' END +')
				  ) '
	 SET @FilterWhereClause = CASE WHEN @FilterWhereClause ='' THEN ' WHERE 1=1 ' ELSE ' WHERE 1=1 '+@FilterWhereClause END
	 SET @InternalOrderBy = ' PaymentSettingId '
	END

	SET @SQL = @SQL+ ', Cte_PaymentSettingFilter AS
				 (

					SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName , PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,IsUsedForWebStorePayment
						,'+dbo.Fn_GetPagingRowId(@Order_BY,@InternalOrderBy)+',Count(*)Over() CountNo

					FROM Cte_PaymenTSetting
				    '+@FilterWhereClause+'
					'+dbo.Fn_GetFilterWhereClause(@WhereClause)+'
				 )

				 SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI,IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,IsUsedForWebStorePayment,RowId ,CountNo
				 FROM Cte_PaymentSettingFilter '
				 +[dbo].[Fn_GetPaginationWhereClause](@PageNo,@Rows)

     PRINT  @SQL 
	
	 INSERT INTO @TBL_PaymentSetting (PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,
						IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI,IsBillingAddressOptional,IsOABRequired,
						PortalPaymentGroupId,PublishState,IsUsedForWebStorePayment,RowID,CountNo)
	 EXEC (@SQL)

	IF @IsAssociated = 1 AND @ProfileId = 0
	BEGIN
		 SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
							,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
							,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState
		 FROM @TBL_PaymentSetting
		 WHERE ISNULL(IsUsedForWebStorePayment,0) = 1
		 ORDER BY RowID,DisplayOrder
		 SET @RowsCount = ISNULL((SELECT top 1 CountNo FROM @TBL_PaymentSetting),0)
	END
	ELSE
	BEGIN
		SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
							,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
							,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState
		 FROM @TBL_PaymentSetting
		 WHERE ISNULL(IsUsedForWebStorePayment,0) = 0
		 ORDER BY RowID,DisplayOrder
		 
		 SET @RowsCount = ISNULL((SELECT top 1 CountNo FROM @TBL_PaymentSetting),0)
		 
	END
	

  END TRY
  BEGIN CATCH
             DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPaymentSetting @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@PortalId='+CAST(@PortalId AS VARCHAR(50))+',@ProfileId='+CAST(@ProfileId AS VARCHAR(50))+',@IsAssociated='+CAST(@IsAssociated AS VARCHAR(50))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));

             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetPaymentSetting',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
  END CATCH
 END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'NC_Idx_ZnodeImportProcessLog_ImportTemplateId' AND object_id = OBJECT_ID('ZnodeImportProcessLog'))
BEGIN
    CREATE NONCLUSTERED INDEX NC_Idx_ZnodeImportProcessLog_ImportTemplateId ON ZnodeImportProcessLog (ImportTemplateId);	
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportVoucher')
	DROP PROC Znode_ImportVoucher
GO

CREATE PROCEDURE [dbo].[Znode_ImportVoucher](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN Voucher;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		-- Retrive RoundOff Value from global setting 

		DECLARE @InsertVoucherData TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY,RowNumber int, StoreCode varchar(400),VoucherName varchar(600), VoucherNumber varchar(600),
			VoucherAmount varchar(600),UserName varchar(600), ExpirationDate Datetime,IsActive varchar(100),RemainingAmount varchar(600),
			RestrictVoucherToACustomer varchar(100), StartDate datetime, GUID nvarchar(400)
		);
		
		SET @SSQL = 'Select RowNumber,StoreCode, VoucherName,VoucherNumber,VoucherAmount,UserName,ExpirationDate,
						IsActive,RemainingAmount,RestrictVoucherToACustomer,StartDate,GUID FROM '+@TableName;
		INSERT INTO @InsertVoucherData( RowNumber,StoreCode, VoucherName,VoucherNumber,VoucherAmount,UserName,ExpirationDate,
										IsActive,RemainingAmount,RestrictVoucherToACustomer,StartDate,GUID)
		EXEC sys.sp_sqlexec @SSQL;

		select ANZU.UserName, ANU.Id, ZU.UserId
		into #TempUserData
		from AspNetZnodeUser ANZU 
		inner join AspNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName
		inner join ZnodeUser ZU ON ANU.Id = ZU.AspNetUserId

		select ZUP.PortalId, ZUP.UserId, ZP.StoreCode
		into #TempUserPortal
		from ZnodeUserPortal ZUP 
		INNER JOIN ZnodePortal ZP ON ZUP.PortalId = ZP.PortalId

		update @InsertVoucherData set VoucherNumber = [dbo].[Fn_RandomString](10)
		where isnull(ltrim(rtrim(VoucherNumber)),'') = ''

		-- Start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '70', 'StoreCode', StoreCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE ii.StoreCode not in 
			   (
				   SELECT StoreCode FROM ZnodePortal 
			   );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '65', 'ExpirationDate', ExpirationDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE (ii.ExpirationDate < ii.StartDate OR ii.ExpirationDate < @GetDate)

		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--	   SELECT '65', 'ExpirationDate', ExpirationDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		--	   FROM @InsertVoucherData AS ii
		--	   WHERE ii.ExpirationDate < @GetDate

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '8', 'StartDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE isnull(ii.StartDate,'') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '8', 'ExpirationDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE isnull(ii.ExpirationDate,'') = ''
		
		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--	   SELECT '67', 'UserName', UserName, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		--	   FROM @InsertVoucherData AS ii
		--	   WHERE isnull(ii.UserName,'') <> '' and not exists ( SELECT VoucherNumber FROM #TempUserData U where ii.UserName = U.UserName);
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '67', 'UserName', UserName, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii			 
			   WHERE isnull(ii.UserName,'') <> '' 
			   and not exists ( SELECT * FROM #TempUserData U where ii.UserName = U.UserName 
			   and not exists(select * from #TempUserPortal UP where U.UserId = UP.UserId and ii.StoreCode = UP.StoreCode))
			 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '71', 'VoucherNumber', VoucherNumber, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE len(ltrim(rtrim(ii.VoucherNumber))) <> 10 
	
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No','')
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '5', 'ExpirationDate', ExpirationDate, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			WHERE isdate(ii.ExpirationDate) = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '5', 'StartDate', StartDate, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			WHERE isdate(ii.StartDate) = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '69', 'RemainingAmount', RemainingAmount, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			WHERE ii.VoucherAmount <> ii.RemainingAmount

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'RestrictVoucherToACustomer', RestrictVoucherToACustomer, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			WHERE ii.RestrictVoucherToACustomer not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT distinct '2', 'VoucherAmount', VoucherAmount, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			CROSS APPLY ZnodeCulture b
			WHERE  VoucherAmount like '%[a-z]%' or VoucherAmount like '%'+b.Symbol+'%'
			and b.Symbol is not null 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT distinct '2', 'RemainingAmount', RemainingAmount, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii
			CROSS APPLY ZnodeCulture b
			WHERE  RemainingAmount like '%[a-z]%' or RemainingAmount like '%'+b.Symbol+'%'
			and b.Symbol is not null 


		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ VoucherName - ' + ISNULL(VoucherName,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN @InsertVoucherData IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertVoucherData
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertVoucherData
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;
	
		UPDATE ZGC set ExpirationDate = ICD.ExpirationDate, UserId = @UserId, ModifiedBy = @UserId, ModifiedDate = @GetDate, IsActive = ICD.IsActive,
				RemainingAmount = ICD.RemainingAmount, RestrictToCustomerAccount = ICD.RestrictVoucherToACustomer, Name = ICD.VoucherName, StartDate = ICD.StartDate
		from ZnodeGiftCard ZGC
		inner join @InsertVoucherData ICD ON ICD.VoucherNumber = ZGC.CardNumber
		inner join ZnodePortal ZP ON ICD.StoreCode = ZP.StoreCode and ZGC.PortalId = ZP.PortalId
		left join #TempUserData ZU ON ICD.UserName = ZU.UserName

		insert into ZnodeGiftCard(PortalId,Name,CardNumber,Amount,UserId,ExpirationDate,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsActive,RemainingAmount,RestrictToCustomerAccount,StartDate)
		select ZP.PortalId, ICD.VoucherName, ICD.VoucherNumber, ICD.VoucherAmount, ZU.UserId, ICD.ExpirationDate, @UserId, @Getdate, @UserId, @Getdate, ICD.IsActive, ICD.RemainingAmount, ICD.RestrictVoucherToACustomer, ICD.StartDate
		From @InsertVoucherData ICD 
		inner join ZnodePortal ZP ON ICD.StoreCode = ZP.StoreCode 
		left join #TempUserData ZU ON ICD.UserName = ZU.UserName
		where not exists(select * from ZnodeGiftCard ZGC where ICD.VoucherNumber = ZGC.CardNumber )

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN Voucher;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN Voucher

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		 DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportVoucher @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));

		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportVoucher',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

update ZnodeApplicationSetting 
set OrderByFields='CreatedDate|Desc' 
where ItemName='ZnodeGiftCard'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetSkuListForInventoryAndPrice')
	DROP PROC Znode_GetSkuListForInventoryAndPrice
GO

CREATE  PROCEDURE [dbo].[Znode_GetSkuListForInventoryAndPrice](
       @WhereClause VARCHAR(MAX) ,
       @Rows        INT           = 100 ,
       @PageNo      INT           = 1 ,
       @Order_BY    VARCHAR(1000) = '' ,
       @RowsCount   INT = 0  OUT ,
       @LocaleId    INT           = 1 ,
       @PriceListId INT           = 0)
AS 
   /* 
    Summary : this procedure is used to Get the inventory list by sku 
    Unit Testing 
     EXEC Znode_GetSkuListForInventoryAndPrice  '',@Order_BY = '',@RowsCount= 1 ,@Rows = 100,@PageNo= 1,@PriceListId = 26,@LocaleId =1 
     SELECT * FROM ZnodePublishProduct WHERE PimProductid  = 4
   */
     BEGIN
         BEGIN TRY
		 DECLARE @SQLqry NVARCHAR(MAX)=''
		     DECLARE @PimProductIds TransferId, --NVARCHAR(max)= '', 
					@OutPimProductIds NVARCHAR(max)= '',
					@PimAttributeId NVARCHAR(max)=''
			 DECLARE @pimSkuAttributeId VARCHAR(50) = [dbo].[Fn_GetProductSKUAttributeId] ()
			 DECLARE @PimProductNameAttributeId VARCHAR(50) = [dbo].[Fn_GetProductNameAttributeId]()
			 DECLARE @PimProductTypeAttributeId VARCHAR(50) = [dbo].[Fn_GetProductTypeAttributeId]()
			 DECLARE @PimIsDownlodableAttributeId VARCHAR(50) = [dbo].[Fn_GetIsDownloadableAttributeId]()
			 DECLARE @PimProductImageAttributeId VARCHAR(50) = [dbo].[Fn_GetProductImageAttributeId]()

			 DECLARE @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleId()
			 DECLARE @TransferPimProductId TransferId 
			 DECLARE @IsProductNotIn BIT = 1 
			 DECLARE @IMamgePAth NVARCHAR(max) = [dbo].[Fn_GetServerThumbnailMediaPath]()

			 DECLARE @ProductIdTable TABLE
             (
				PimProductId INT,
				CountId      INT,
				RowId        INT IDENTITY(1,1)
             );

			 --DECLARE @TBL_AttributeDetails AS TABLE
    --         (
				--PimProductId   INT,
				--AttributeValue NVARCHAR(MAX),
				--AttributeCode  VARCHAR(600),
				--PimAttributeId INT
    --         );
			 CREATE TABLE #TBL_AttributeDetails
			 (
				PimProductId   INT,
				AttributeValue NVARCHAR(MAX),
				AttributeCode  VARCHAR(600),
				PimAttributeId INT
             );
             IF @PriceListId > 0
             BEGIN
				INSERT INTO @TransferPimProductId 
				SELECT Distinct PimProductId 
				FROM  [dbo].[View_PimProductAttributeValueLocale] VIMP
				INNER JOIN ZnodePrice  ZP ON (Zp.SKU = VIMP.AttributeValue )
				WHERE VIMP.PimAttributeid = @pimSkuAttributeId
				AND VIMP.LocaleId = @LocaleId
				AND ZP.PriceListId = @PriceListId
					
               SET @IsProductNotIn = 1 --CASE WHEN @PimProductIds IS NULL OR @PimProductIds = '' then 1 else 0 end 

			   IF NOT EXISTS (SELECT TOP 1 1 FROM @TransferPimProductId )
			   BEGIN 
					INSERT INTO @TransferPimProductId
					SELECT '-1'
			   END 
			 --  set @PimProductIds = CASE WHEN @PimProductIds IS NULL OR @PimProductIds = '' then  else @PimProductIds end 
		     END;
			-- SELECT * FROM ZnodePrice WHERE PriceListId = 21
			DECLARE @AttributeCode NVARCHAR(max)= '',@SQL NVARCHAR(max)=''
 DECLARE  @ProductListIdRTR TransferId
	 DECLARE @TAb Transferid 
	 DECLARE @tBL_mainList TABLE (Id INT,RowId INT)
	 --	IF @PimProductId <> ''  OR   @IsCallForAttribute=1
		--BEGIN 
	 --SET @IsProductNotIn = CASE WHEN @IsProductNotIn = 0 THEN 1  
		--			 WHEN @IsProductNotIn = 1 THEN 0 END 
		--END 
	 INSERT INTO @ProductListIdRTR
	 EXEC Znode_GetProductList  0,@TransferPimProductId
	 
	 IF CAST(@WhereClause AS NVARCHAR(max))<> N''
	 BEGIN 
	 
	  SET @SQL = 'SELECT DISTINCT PimProductId FROM ##Temp_PimProductId'+CAST(@@SPID AS VARCHAR(500))

	  EXEC Znode_GetFilterPimProductId @WhereClause,@ProductListIdRTR,@localeId
	  
      INSERT INTO @TAB 
	  EXEC (@SQL)
	 
	 END 

	 IF EXISTS (SELECT Top 1 1 FROM @TAb ) OR CAST(@WhereClause AS NVARCHAR(max)) <> N''
	 BEGIN 
	 
	 SET @AttributeCode = REPLACE(dbo.FN_TRIM(REPLACE(REPLACE(@order_by,' DESC',''),' ASC','')),'DisplayOrder','ProductName')
	 SET @order_by = REPLACE(@order_by,'DisplayOrder','ProductName')
	 INSERT INTO @TBL_MainList(id,RowId)
	 EXEC Znode_GetOrderByPagingProduct @order_by,@rows,@PageNo, @TAb ,@AttributeCode,@localeId
	 
	 END 
	 ELSE 
	 BEGIN
	  
	 SET @AttributeCode = REPLACE(dbo.FN_TRIM(REPLACE(REPLACE(@order_by,' DESC',''),' ASC','')),'DisplayOrder','ProductName')
	 SET @order_by = REPLACE(@order_by,'DisplayOrder','ProductName')
	 INSERT INTO @TBL_MainList(id,RowId)
	 EXEC Znode_GetOrderByPagingProduct @order_by,@rows,@PageNo, @ProductListIdRTR ,@AttributeCode,@localeId 
	 END 
	 --SELECT * 
		--	 FROM @TBL_MainList
		

			 INSERT INTO @ProductIdTable (PimProductId)              
			 SELECT Id 
			 FROM @TBL_MainList SP 
				  	           
             --SET @PimProductIds = SUBSTRING((SELECT ','+CAST(PimProductId AS VARCHAR(100)) FROM @ProductIdTable FOR XML PATH('')), 2, 4000);
			 INSERT INTO @PimProductIds ( Id )
			 SELECT PimProductId FROM @ProductIdTable

             SET @PimAttributeId = @pimSkuAttributeId  + ',' + @PimProductNameAttributeId + ',' +@PimProductTypeAttributeId + ',' + @PimIsDownlodableAttributeId + ',' + @PimProductImageAttributeId ;
			
			  DECLARE @FamilyDetails TABLE
             (
				PimProductId         INT,
				PimAttributeFamilyId INT,
				FamilyName           NVARCHAR(3000)
             );	


			 INSERT INTO @FamilyDetails ( PimAttributeFamilyId, PimProductId )
             EXEC [dbo].[Znode_GetPimProductAttributeFamilyId] @PimProductIds, 1;

             UPDATE a
             SET  FamilyName = b.AttributeFamilyName
             FROM @FamilyDetails a
             INNER JOIN ZnodePimFamilyLocale b ON(a.PimAttributeFamilyId = b.PimAttributeFamilyId AND LocaleId = @LocaleId);

             UPDATE a
             SET FamilyName = b.AttributeFamilyName
             FROM @FamilyDetails a 
			 INNER JOIN ZnodePimFamilyLocale b ON(a.PimAttributeFamilyId = b.PimAttributeFamilyId AND LocaleId = @DefaultLocaleId)
             WHERE a.FamilyName IS NULL OR a.FamilyName = '';

			 
             --INSERT INTO @TBL_AttributeDetails ( PimProductId, AttributeValue, AttributeCode, PimAttributeId )
             INSERT INTO #TBL_AttributeDetails( PimProductId, AttributeValue, AttributeCode, PimAttributeId )
			 EXEC Znode_GetProductsAttributeValue @PimProductIds, @PimAttributeId, @localeId;
			 
			-- INSERT INTO @TBL_AttributeDetails ( PimProductId, AttributeValue, AttributeCode )
			INSERT INTO #TBL_AttributeDetails( PimProductId, AttributeValue, AttributeCode )
			 SELECT PimProductId,FamilyName ,'AttributeFamily' AttributeCode 
			 FROM @FamilyDetails 
		    
			IF @Order_BY=''
			BEGIN
			SET @Order_BY='PimProductId ASC'
			END

			SET @SQLqry =';With Cte_pimProductDetails1 AS
			(
			  SELECT PimProductId,AttributeValue,AttributeCode FROM #TBL_AttributeDetails
			)
			SELECT PimProductId,ProductName,SKU,Convert ( BIT, CASE when ISNULL(IsDownloadable,0)= ''true'' then 1 else 0 END )IsDownloadable,ZM.[Path] ProductImage, AttributeFamily,[ProductType]
			FROM Cte_pimProductDetails1 CTEPD
			PIVOT
			(
				Max(AttributeValue) FOR AttributeCode IN ([ProductName],[SKU],[IsDownloadable],[ProductImage],[AttributeFamily],[ProductType])
			) PIV
			LEFT JOIN ZnodeMedia ZM ON (ZM.MediaId = Piv.[ProductImage]) ORDER BY '+@Order_BY+''
			
			EXEC (@SQLqry)
			
			--;With Cte_pimProductDetails AS
			--(
			--  SELECT PimProductId,AttributeValue,AttributeCode FROM #TBL_AttributeDetails
			--)
			--SELECT PimProductId,ProductName,SKU,Convert ( BIT, CASE when ISNULL(IsDownloadable,0)= 'true' then 1 else 0 END )IsDownloadable,@IMamgePAth+ZM.[Path] ProductImage, AttributeFamily,[ProductType]
			--FROM Cte_pimProductDetails CTEPD
			--PIVOT
			--(
			--	Max(AttributeValue) FOR AttributeCode IN ([ProductName],[SKU],[IsDownloadable],[ProductImage],[AttributeFamily],[ProductType])
			--) PIV
			--LEFT JOIN ZnodeMedia ZM ON (ZM.MediaId = Piv.[ProductImage])
			--order by ProductName desc
			  
			
				  IF EXISTS (SELECT Top 1 1 FROM @TAb )
	 BEGIN 

		  SELECT @RowsCount= (SELECT COUNT(1) FROM @TAb)   
	 END 
	 ELSE 
	 BEGIN
	 		  SELECT  @RowsCount= (SELECT COUNT(1) FROM @ProductListIdRTR) 
	 END 
	 
	 
         END TRY
         BEGIN CATCH
              DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
			 @ErrorLine VARCHAR(100)= ERROR_LINE(),
			 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetSkuListForInventoryAndPrice @WhereClause = '''+ISNULL(@WhereClause,'''''')+''',@Rows='+ISNULL(CAST(@Rows AS
			VARCHAR(50)),'''''')+',@PageNo='+ISNULL(CAST(@PageNo AS VARCHAR(50)),'''')+',@Order_BY='''+ISNULL(@Order_BY,'''''')+''',@RowsCount='+ISNULL(CAST(@RowsCount AS VARCHAR(50)),'''')+',
			@LocaleId = '+ISNULL(CAST(@LocaleId AS VARCHAR(50)),'''')+',@PriceListId='+ISNULL(CAST(@PriceListId AS VARCHAR(50)),'''');
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetSkuListForInventoryAndPrice',
				@ErrorInProcedure = 'Znode_GetSkuListForInventoryAndPrice',
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_AdminUsersByUserId')
	DROP PROC Znode_AdminUsersByUserId
GO

CREATE PROCEDURE [dbo].[Znode_AdminUsersByUserId]
(	
	@RoleName		VARCHAR(200),
    @UserName		VARCHAR(200),
    @WhereClause	XML,
    @Rows			INT           = 100,
    @PageNo			INT           = 1,
    @Order_By		VARCHAR(1000) = '',
    @RowCount		INT        = 0 OUT,
	@IsCallOnSite   BIT = 0 ,
	@PortalId		VARCHAR(1000) = 0,
	@IsGuestUser    BIT = 0,
	@ColumnName     dbo.SelectColumnList ReadOnly,
	@SalesRepUserId Int = 0,
	@IsSalesRepList Bit = 0
)
AS
/* 
    Summary: List of users with details and shows link with ASPNet tables 
    This procedure is used for finding both users and admin users 
    here use three view "View_RoleUsers" for check  @UserName is present or not 
    "View_AdminUserDetail"  this view use for admin users 
    "View_CustomerUserDetail" Use for customer users 
    Unit Testing   
	SELECT * FROM ZnodeUser 
    DECLARE @EDE INT=0  EXEC Znode_AdminUsersByUserId '','admin@znode.com',@WhereClause='',@Order_By='',@PageNo= 1 ,@Rows= 214,@IsCallOnSite='false',@PortalId=0,@RowCount=@EDE OUT  SELECT @EDE
*/
BEGIN
    BEGIN TRY
    SET NOCOUNT ON;
			
		DECLARE @SQL NVARCHAR(MAX)= '', @PaginationWhereClause VARCHAR(300)= dbo.Fn_GetRowsForPagination(@PageNo, @Rows, ' WHERE RowId');
             
		----Verifying that the @SalesRepUserId is having 'Sales Rep' role
		IF NOT EXISTS
		(
			SELECT * FROM ZnodeUser ZU
			INNER JOIN AspNetZnodeUser ANZU ON ZU.UserName = ANZU.UserName
			INNER JOIN AspNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName
			INNER JOIN AspNetUserRoles ANUR ON ANU.Id = ANUR.UserId
			Where Exists(select * from AspNetRoles ANR Where Name = 'Sales Rep' AND ANUR.RoleId = ANR.Id) 
			AND ZU.UserId = @SalesRepUserId
		)   
		Begin
			SET @SalesRepUserId = 0
		End

		IF OBJECT_ID('tempdb..#TBL_RowCount') is not null
			DROP TABLE #TBL_RowCount
		Create table #TBL_RowCount(RowsCount int )
		-----Split where clause XMl 
		CREATE TABLE #WhereColumnList(RowId Int identity, filterName varchar(max), WhereCondition varchar(max))
		insert into #WhereColumnList(filterName,WhereCondition)
		SELECT 
				Tbl.Col.value('key[1]', 'varchar(max)') as filterName,
				Tbl.Col.value('condition[1]', 'varchar(max)') WhereCondition
		FROM   @WhereClause.nodes('//filter') Tbl(Col) 
		----Address column in global search
		declare @AddressGlobalSearch varchar(1000)
		declare @GlobalSearch varchar(100)
		select @GlobalSearch = substring(WhereCondition,charindex(' like ',WhereCondition), charindex(' OR ',WhereCondition)-charindex(' like ',WhereCondition)) 
		from #WhereColumnList
		where filtername like '%|%'
		and filtername <> ''
		and filterName in ('CityName','CountryName','PostalCode','StateName','CompanyName') 

		if isnull(@GlobalSearch,'') <> ''
		begin
			select @AddressGlobalSearch = '('+'CityName '+ @GlobalSearch+' OR '+'CountryName '+ @GlobalSearch+' OR '+'PostalCode '+ @GlobalSearch+' OR '+'StateName '+ @GlobalSearch+' OR '+'CompanyName '+ @GlobalSearch+')'
		end
		else
		begin
			SET @AddressGlobalSearch = ''
		end
		----Global search where clause
		declare @WhereClauseGlobal varchar(1000)=''
		select @WhereClauseGlobal = ISNULL(WhereCondition,'')
		from #WhereColumnList
		where filtername like '%|%'
		and filtername <> ''
			
		----Where clause columns except Address columns
		declare @WhereClause1 varchar(max) 
		select @WhereClause1 = COALESCE(@WhereClause1 + '', '') + WhereCondition+' And '
		--case when @WhereClause1 <> ''  then ' And ' else '' end
		from #WhereColumnList a
		where filterName not like '%|%' and
		filterName not in ('CountryName','CityName','StateName','PostalCode','CompanyName')
		and filtername <> ''

		if @WhereClause1 <> ''
		begin
			set @WhereClause1=isnull(substring(@WhereClause1,1,len(@WhereClause1)-3),'')
		end
		else
		begin
			set @WhereClause1 = ''
		end

		----Where clause columns
		declare @AddressColumnWhereClause varchar(max) 
		select @AddressColumnWhereClause = COALESCE(@AddressColumnWhereClause + '', '') + WhereCondition+' And '
		from #WhereColumnList a
		where filterName not like '%|%' and
		filterName in ('CountryName','CityName','StateName','PostalCode','CompanyName')
		and filtername <> ''
			
		if isnull(@AddressColumnWhereClause,'') <> ''
		begin
			set @AddressColumnWhereClause=isnull(substring(@AddressColumnWhereClause,1,len(@AddressColumnWhereClause)-3),'')
		end
		else
		begin
			set @AddressColumnWhereClause = ''
		end

		declare @WhereClauseAll varchar(max)
		select @WhereClauseAll = COALESCE(@WhereClauseAll + '', '') + WhereCondition+' And '
		from #WhereColumnList a

		set @WhereClauseAll=isnull(substring(@WhereClauseAll,1,len(@WhereClauseAll)-3),'')
		-------------- 

		IF @PortalId  <> '0' 
		BEGIN 
			IF @IsSalesRepList IN (1, 'True')
			BEGIN
				SELECT @PortalId = STUFF((SELECT CONCAT(', ', ISNULL(ZUP2.PortalId,@PortalId))
					FROM dbo.ZnodeUserPortal ZUP2 WITH (NOLOCK)
					WHERE ZUP1.UserId = ZUP2.UserId
					FOR XML PATH ('')), 1, 2, '')
				FROM dbo.ZnodeUserPortal ZUP1 WITH (NOLOCK)
				WHERE ZUP1.UserId=(SELECT TOP 1 UserId FROM ZnodeUser WITH (NOLOCK) WHERE UserName=@UserName)
				GROUP BY ZUP1.UserId;
			END

			SET @WhereClauseAll = CASE WHEN  @WhereClauseAll = '' THEN ' (PortalId IN ('+@PortalId+') OR PortalId IS NULL) ' ELSE @WhereClauseAll+' AND (PortalId IN ('+@PortalId+') OR PortalId IS NULL) ' END 

			SET @WhereClause1 = CASE WHEN  @WhereClause1 = '' THEN ' (isnull(PortalId,0) IN ('+@PortalId+') OR PortalId IS NULL) ' ELSE @WhereClause1+' AND (isnull(PortalId,0) IN ('+@PortalId+') OR PortalId IS NULL) ' END 
			
		END 
		IF EXISTS ( SELECT TOP 1 1 FROM View_RoleUsers  WHERE Username = @UserName   )  AND @RoleName <> ''  
		-- this check for admin user
		BEGIN
			SET @SQL = ' SELECT  A.UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,A.CreatedBy,A.CreatedDate,A.ModifiedBy,A.ModifiedDate
			,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
			,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId ,CustomerPaymentGUID
			INTO #Cte_AdminUserDetail
			FROM View_AdminUserDetail A
			'+CASE WHEN @PortalId  <> '0' THEN ' INNER JOIN ZnodeUserPortal ZUP ON (ZUP.UserId = A.UserId) 'ELSE '' END  +'	 
			'+dbo.Fn_GetWhereClause(@WhereClauseAll, ' WHERE ')+'
				
			;with Cte_AdminUserDetailRowId AS 
			(
			SELECT UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
			,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
			,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId,CustomerPaymentGUID ,RANK()Over('+dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC')+',UserId DESC) RowId
			FROM  #Cte_AdminUserDetail a
			where (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
			)
					 
			SELECT UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
			,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
			,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId,CustomerPaymentGUID ,RowId 
			INTO #AccountDetails
			FROM Cte_AdminUserDetailRowId 
					 
			SET @Count= ISNULL((SELECT  Count(DISTINCT UserId) FROM #AccountDetails ),0)
					 
			SELECT DISTINCT UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
			,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
			,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId ,CustomerPaymentGUID
			FROM #AccountDetails '+@PaginationWhereClause+' '+dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC' );
			EXEC SP_executesql
			@SQL,
			N'@Count INT OUT',
			@Count = @RowCount OUT;
		END;
		-- For Customer user
		ELSE   
		BEGIN
			IF @roleName = ''
			BEGIN
				if OBJECT_ID('tempdb..##CustomerUserAddDetail') is not null
				drop table ##CustomerUserAddDetail

				if OBJECT_ID('tempdb..##View_CustomerUserAddDetail') is not null
				drop table ##View_CustomerUserAddDetail
				
				if OBJECT_ID('tempdb..##UserList') is not null
				drop table ##UserList

				CREATE TABLE ##UserList(UserId int,AddressID int)

				declare @UserList varchar(1000)=''

				------To get the list of user having adress column in global search
				if (@AddressGlobalSearch <> '')
				begin
				
				set @UserList = 'select a.UserId, b.AddressID	from ZnodeUserAddress a	inner join ZnodeAddress b on a.AddressId = b.AddressId	where '+@AddressGlobalSearch
				--print @UserList
				insert into ##UserList(UserId, b.AddressID)
				exec (@UserList)
			
				end
				----To get the list of user having adress column in where clause 
				if (@AddressColumnWhereClause <> '')
				begin
					
				set @UserList = 'select a.UserId, b.AddressID	from ZnodeUserAddress a	inner join ZnodeAddress b on a.AddressId = b.AddressId	where '+@AddressColumnWhereClause
				--print @UserList
				insert into ##UserList(UserId,AddressID)
				exec (@UserList)
					
				end

				If @IsGuestUser= 0 
				AND
				NOT Exists (Select filterName from #WhereColumnList where filterName in ('accountid','isaccountcustomer','UserId') and filtername <> '')
				-- Customer List with GuestUsers
				Begin
					SET @SQL = 
						'SELECT a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
							a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATE, a.CreatedDate) CreatedDate,A.ModifiedBy,
							CONVERT( DATE, a.ModifiedDate) ModifiedDate, 0 RoleId,
							CASE WHEN A.AccountId IS NULL THEN '''' ELSE r.name END as RoleName,
							CASE	WHEN B.LockoutEndDateUtc IS NULL
							THEN CAST(1 AS    BIT)	ELSE CAST(0 AS BIT)
							END IsActive,	CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
				
							(ISNULL(RTRIM(LTRIM(a.FirstName)), '''')+'' ''+ISNULL(RTRIM(LTRIM(a.MiddleName)), '''')+CASE
							WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '''') = ''''	THEN ''''
							ELSE '' ''	END+ISNULL(RTRIM(LTRIM(a.LastName)), '''')) 
				
							FullName,
							e.Name AccountName
							,a.AccountId,a.ExternalId,	CASE	WHEN a.AccountId IS NULL THEN 0	ELSE 1	END IsAccountCustomer,
							a.BudgetAmount,
							'''' TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser,a.CustomerPaymentGUID
							--,CASE WHEN zp.StoreName IS NULL THEN ''ALL'' ELSE zp.StoreName END StoreName,
							,ISnull(zp.StoreName , ''ALL'')StoreName,
							up.PortalId as PortalId, e.AccountCode
							into ##View_CustomerUserAddDetail
							FROM ZnodeUser a
							INNER JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
							INNER JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
							LEFT JOIN ZnodeUserPortal up ON(up.UserId = a.UserId)  
							LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
							LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
							LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
							LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)
							WHERE (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid ) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
						' 
					EXEC (@SQL)
				End	
				Else If @IsGuestUser= 1 
				Begin
						SET @SQL='SELECT a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
						a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATE, a.CreatedDate) CreatedDate,A.ModifiedBy,
						CONVERT( DATE, a.ModifiedDate) ModifiedDate,ur.RoleId,r.Name RoleName,
						CASE WHEN B.LockoutEndDateUtc IS NULL THEN CAST(1 AS    BIT) ELSE CAST(0 AS BIT) END IsActive,
						CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
						(ISNULL(RTRIM(LTRIM(a.FirstName)), '''')+'' ''+ISNULL(RTRIM(LTRIM(a.MiddleName)), '''')+CASE
						WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '''') = '''' THEN '''' ELSE '' '' END+ISNULL(RTRIM(LTRIM(a.LastName)), '''')) FullName,
						e.Name AccountName,a.AccountId,a.ExternalId,
						CASE WHEN a.AccountId IS NULL THEN 0 ELSE 1	END IsAccountCustomer,
						a.BudgetAmount,r.TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser,a.CustomerPaymentGUID
						,CASE WHEN zp.StoreName IS NULL THEN ''ALL'' ELSE zp.StoreName END StoreName,
						CASE WHEN a.AccountId IS NULL THEN up.PortalId ELSE ZPA.PortalId END as PortalId,e.AccountCode
						into ##View_CustomerUserAddDetail
						FROM ZnodeUser a
						LEFT JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
						LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
						LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
						LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)                       
						LEFT JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
						LEFT JOIN ZnodeUserPortal up ON(up.UserId = a.UserId)  
						LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
						LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = a.AccountId) 
						WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUSer ZUQ WHERE ZUQ.UserId = a.UserId AND ZUQ.EmailOptIn = 1 AND ZUQ.AspNetUserId IS NULL )
						AND a.AspNetuserId is null
						AND (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid ) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
						'
					EXEC (@SQL)
				End
				Else IF Exists (Select filterName from #WhereColumnList where filterName in ('UserId') and filtername <> '')
				and  @IsGuestUser= 0   
				-- Customer List for user edit single user 
				Begin
				SET @SQL='SELECT a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
						a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATE, a.CreatedDate) CreatedDate,A.ModifiedBy,
						CONVERT( DATE, a.ModifiedDate) ModifiedDate,ur.RoleId,r.Name RoleName,
						CASE WHEN B.LockoutEndDateUtc IS NULL THEN CAST(1 AS    BIT) ELSE CAST(0 AS BIT) END IsActive,
						CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
						(ISNULL(RTRIM(LTRIM(a.FirstName)), '''')+'' ''+ISNULL(RTRIM(LTRIM(a.MiddleName)), '''')+CASE
						WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '''') = '''' THEN '''' ELSE '' '' END+ISNULL(RTRIM(LTRIM(a.LastName)), '''')) FullName,
						e.Name AccountName,a.AccountId,a.ExternalId,
						CASE WHEN a.AccountId IS NULL THEN 0 ELSE 1	END IsAccountCustomer,
						a.BudgetAmount,r.TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser,a.CustomerPaymentGUID
						,CASE WHEN zp.StoreName IS NULL THEN ''ALL'' ELSE zp.StoreName END StoreName,
						CASE WHEN a.AccountId IS NULL THEN up.PortalId ELSE ZPA.PortalId END as PortalId,e.AccountCode
						into ##View_CustomerUserAddDetail
						FROM ZnodeUser a
						LEFT JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
						LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
						LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
						LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)                       
						LEFT JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
						LEFT JOIN ZnodeUserPortal up ON(up.UserId = a.UserId)  
						LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
						LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = a.AccountId) 
						WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUSer ZUQ WHERE ZUQ.UserId = a.UserId AND ZUQ.EmailOptIn = 1 AND ZUQ.AspNetUserId IS NULL )
						AND (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid ) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
						'
					EXEC (@SQL)
				End	
				Else -- Account user List 
				Begin
						SELECT a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
						a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATE, a.CreatedDate) CreatedDate,A.ModifiedBy,
						CONVERT( DATE, a.ModifiedDate) ModifiedDate,ur.RoleId,r.Name RoleName,
						CASE WHEN B.LockoutEndDateUtc IS NULL THEN CAST(1 AS    BIT) ELSE CAST(0 AS BIT) END IsActive,
						CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
						(ISNULL(RTRIM(LTRIM(a.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(a.MiddleName)), '')+CASE
						WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '') = '' THEN '' ELSE ' ' END+ISNULL(RTRIM(LTRIM(a.LastName)), '')) FullName,
						e.Name AccountName,a.AccountId,a.ExternalId,
						CASE WHEN a.AccountId IS NULL THEN 0 ELSE 1	END IsAccountCustomer,
						a.BudgetAmount,r.TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser,a.CustomerPaymentGUID
						,CASE WHEN zp.StoreName IS NULL THEN 'ALL' ELSE zp.StoreName END StoreName,
						CASE WHEN a.AccountId IS NULL THEN up.PortalId ELSE ZPA.PortalId END as PortalId, e.AccountCode
						into ##View_CustomerUserAddDetail
						FROM ZnodeUser a
						LEFT JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
						LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
						LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
						LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)                       
						LEFT JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
						LEFT JOIN ZnodeUserPortal up ON(up.UserId = a.UserId)  
						LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
						LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = a.AccountId) 
						WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUSer ZUQ WHERE ZUQ.UserId = a.UserId AND ZUQ.EmailOptIn = 1 AND ZUQ.AspNetUserId IS NULL )
						AND (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = @SalesRepUserId and a.UserId = SalRep.CustomerUserid ) or @SalesRepUserId = 0)
				End


				alter table ##View_CustomerUserAddDetail 
				add DepartmentId int, PermissionsName varchar(200), PermissionCode varchar(200), DepartmentName varchar(300), AccountPermissionAccessId int,
				AccountUserOrderApprovalId int, ApprovalName varchar(1000) , ApprovalUserId int
				--, PortalId int , StoreName varchar(1000)
				,CountryName varchar(1000),CityName varchar(1000),StateName varchar(1000),PostalCode varchar(1000), CompanyName varchar(1000),
				SalesRepUserName varchar(600),SalesRepFullName varchar(1000)

	
				IF ((@AddressGlobalSearch like '%CountryName%' OR @AddressGlobalSearch like '%CityName%' OR @AddressGlobalSearch like '%StateName%' OR @AddressGlobalSearch like '%PostalCode%' OR @AddressGlobalSearch like '%CompanyName%')
				and exists(select * from ##UserList))
				BEGIN
					update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
					PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName
					from ##View_CustomerUserAddDetail a
					inner join ZnodeUserAddress ZUA on a.UserId = ZUA.UserId
					inner  JOIN ZnodeAddress ZA on ZA.AddressId = zua.AddressId
					where exists(select * from ##UserList UL where a.UserId = UL.UserId and UL.AddressId = ZA.AddressId )

					update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
					PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName
					from ##View_CustomerUserAddDetail a
					inner join ZnodeAccountAddress ZAA on a.AccountId = ZAA.AccountId
					inner  JOIN ZnodeAddress ZA on ZA.AddressId = ZAA.AddressId
					where isnull(a.AccountId,0)<> 0-- is not null
					and exists(select * from ##UserList UL where a.UserId = UL.UserId and UL.AddressID = ZA.AddressId)
					and (a.CountryName is null OR a.CityName is null OR a.StateName is null or a.PostalCode is null or a.CompanyName is null)
		
				END

				--CREATE NONCLUSTERED INDEX IND_101
				--ON [dbo].[##View_CustomerUserAddDetail] ([userId],[AspNetuserId])

				SET @SQL = '			
						
					create table #AccountDetail
					(
						UserId int,AspNetuserId nvarchar(200),UserName nvarchar(200),FirstName nvarchar(200),MiddleName nvarchar(200),LastName nvarchar(200),
						PhoneNumber nvarchar(100),Email nvarchar(100),EmailOptIn bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,
						RoleId varchar(200),RoleName varchar(200),IsActive bit,IsLock bit,FullName  varchar(1000),AccountName  varchar(200),PermissionsName  varchar(200),
						DepartmentName  varchar(200),DepartmentId int,AccountId int,AccountPermissionAccessId int, ExternalId  varchar(200),BudgetAmount numeric(10,6),
						AccountUserOrderApprovalId int,ApprovalName varchar(200),ApprovalUserId int,PermissionCode varchar(500),CustomerPaymentGUID varchar(500),
						StoreName varchar(200),PortalId int,CountryName varchar(200), CityName varchar(200), StateName varchar(200), PostalCode varchar(200), CompanyName varchar(200)
						,SalesRepUserName varchar(200),SalesRepFullName varchar(200) ,RowId int identity , AccountCode nvarchar(100)
					) 
					'+
					+' insert into #AccountDetail(UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
					EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,FullName,
					AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
					BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode,CustomerPaymentGUID
					,StoreName,PortalId, CountryName, CityName, StateName, PostalCode, CompanyName, AccountCode)
					SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
					EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,FullName,
					AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
					BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode,CustomerPaymentGUID 
					,StoreName,PortalId, CountryName, CityName, StateName, PostalCode, CompanyName, AccountCode
					FROM ##View_CustomerUserAddDetail where 1=1'+
					dbo.Fn_GetWhereClause(@WhereClauseGlobal+case when @WhereClauseGlobal<>'' and @WhereClause1 <> '' then ' And '+@WhereClause1 else @WhereClause1 end, ' AND ')+
					dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC') + '
			
					Insert Into #TBL_RowCount Values(@@RowCount)
							
					SELECT  UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
					EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,FullName,
					AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
					BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode ,CustomerPaymentGUID,StoreName,PortalId,
					CountryName, CityName, StateName, PostalCode, CompanyName, SalesRepUserName, SalesRepFullName, AccountCode
					,Row_Number()Over('+dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC')+')  RowNumber
					into ##CustomerUserAddDetail
					FROM #AccountDetail '+@PaginationWhereClause  +' '+ dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC');

				EXEC (@SQL)
				
				Select @RowCount= isnull(RowsCount  ,0) from #TBL_RowCount

				ALTER TABLE ##CustomerUserAddDetail ADD AddressId Int
				--To get data for DepartmentId
				update CUD SET DepartmentId = i.DepartmentId
				from ##CustomerUserAddDetail cud
				INNER JOIN ZnodeDepartmentUser i ON(i.UserId = cud.UserId)

				--To get data for PermissionsName
				update CUD SET PermissionsName = h.PermissionsName, PermissionCode = h.PermissionCode
				from ##CustomerUserAddDetail cud
				INNER JOIN ZnodeAccountUserPermission f ON(f.UserId = cud.UserId)
				INNER JOIN ZnodeAccountPermissionAccess g ON(g.AccountPermissionAccessId = f.AccountPermissionAccessId)
				INNER JOIN ZnodeAccessPermission h ON(h.AccessPermissionId = g.AccessPermissionId)

				------To get data for DepartmentName
				update CUD SET DepartmentName = j.DepartmentName
				from ##CustomerUserAddDetail cud
				INNER JOIN ZnodeDepartmentUser i ON(i.UserId = cud.UserId)
				INNER JOIN ZnodeDepartment j ON(j.DepartmentId = i.DepartmentId)

				--To get data for AccountPermissionAccessId
				update CUD SET AccountPermissionAccessId = f.AccountPermissionAccessId
				from ##CustomerUserAddDetail cud
				INNER JOIN ZnodeAccountUserPermission f ON(f.UserId = cud.UserId)

				--To get data for AccountPermissionAccessId
				update CUD SET AccountPermissionAccessId = f.AccountPermissionAccessId
				from ##CustomerUserAddDetail cud
				INNER JOIN ZnodeAccountUserPermission f ON(f.UserId = cud.UserId)
	
				--To get data for AccountUserOrderApprovalId
				update CUD SET AccountUserOrderApprovalId = ZAUOA.AccountUserOrderApprovalId
				from ##CustomerUserAddDetail cud
				INNER JOIN ZnodeAccountUserOrderApproval ZAUOA ON cud.UserId = ZAUOA.UserID
	
				--To get data for ApprovalName,ApprovalUserId
				update CUD SET ApprovalName = ISNULL(RTRIM(LTRIM(ZU.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '')
				+CASE
				WHEN ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '') = ''
				THEN ''
				ELSE ' '
				END,
				ApprovalUserId = ZAUOA.ApprovalUserId
				from ##CustomerUserAddDetail cud
				INNER JOIN ZnodeAccountUserOrderApproval ZAUOA ON cud.UserId = ZAUOA.UserID
				INNER JOIN ZnodeUser ZU ON(ZU.UserId = ZAUOA.ApprovalUserId)
	
				----To get data for PortalId
				--update CUD SET PortalId = CASE
				--								WHEN cud.AccountId IS NULL
				--								THEN up.PortalId
				--								ELSE ZPA.PortalId
				--							END 
				--from ##CustomerUserAddDetail cud
				--   LEFT JOIN ZnodeUserPortal up ON(up.UserId = cud.UserId) 
				--LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = cud.AccountId) 
	
				----To get data for CountryName, CityName, StateName, PostalCode, CompanyName
				IF (EXISTS(SELECT * FROM @ColumnName where ([StringColumn] LIKE '%CountryName%' OR [StringColumn] LIKE '%CityName%' OR [StringColumn] LIKE '%StateName%' OR [StringColumn] LIKE '%PostalCode%' OR [StringColumn] LIKE '%CompanyName%'))
				OR (@WhereClauseAll like '%CountryName%' OR @WhereClauseAll like '%CityName%' OR @WhereClauseAll like '%StateName%' OR @WhereClauseAll like '%PostalCode%' OR @WhereClauseAll like '%CompanyName%'))
				BEGIN
			 
					update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
					PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName, a.AddressId = ZA.AddressId
					from ##CustomerUserAddDetail a
					inner join ZnodeAccountAddress ZAA on a.AccountId = ZAA.AccountId
					inner  JOIN ZnodeAddress ZA on ZA.AddressId = ZAA.AddressId
					where isnull(a.AccountId,0)<> 0-- is not null
	 
					update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
					PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName, a.AddressId = ZA.AddressId
					from ##CustomerUserAddDetail a
					inner join ZnodeUserAddress ZUA on a.UserId = ZUA.UserId
					inner  JOIN ZnodeAddress ZA on ZA.AddressId = zua.AddressId
				END

				----Updating SalesRep for user if any 
				update CUAD
				set CUAD.SalesRepUserName = azu.UserName, 
				CUAD.SalesRepFullName = (ISNULL(RTRIM(LTRIM(ZU.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '')
				+CASE
				WHEN ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '') = ''
				THEN ''
				ELSE ' '
				END+ISNULL(RTRIM(LTRIM(ZU.LastName)), '')) 
				from ##CustomerUserAddDetail CUAD
				inner join ZnodeSalesRepCustomerUserPortal SRCUP ON CUAD.UserId = SRCUP.CustomerUserid 
				inner join ZnodeUser ZU ON SRCUP.SalesRepUserId = ZU.UserId
				inner join ASPNetUsers ANU ON(ZU.AspNetuserId = ANU.Id)
				inner join AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = ANU.UserName)

				if ( exists(select * from ##UserList) OR @AddressColumnWhereClause <> '')
				begin
					SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
					EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,
					Isnull(FirstName,'') +  ' ' + ISnull(LastName,'')  FullName,
					AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
					BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode ,CustomerPaymentGUID,StoreName,PortalId,
					CountryName, CityName, StateName, PostalCode, CompanyName, SalesRepUserName, SalesRepFullName, AccountCode
					from ##CustomerUserAddDetail CUAD
					where exists(select * from ##UserList UL where CUAD.UserId = UL.UserId and CUAD.AddressId = UL.AddressID )
					Order by RowNumber
				end
				else
				begin
					SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
					EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,
					Isnull(FirstName,'') +  ' ' + ISnull(LastName,'')  FullName,
					AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
					BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode ,CustomerPaymentGUID,StoreName,PortalId,
					CountryName, CityName, StateName, PostalCode, CompanyName, SalesRepUserName, SalesRepFullName, AccountCode
					from ##CustomerUserAddDetail
					Order by RowNumber
				end
	
				if OBJECT_ID('tempdb..##CustomerUserAddDetail') is not null
				drop table ##CustomerUserAddDetail

				if OBJECT_ID('tempdb..##View_CustomerUserAddDetail') is not null
				drop table ##View_CustomerUserAddDetail
				
			END;
			ELSE
			BEGIN
				SELECT * FROM View_CustomerUserDetail AS VICUD WHERE 1 = 0;
				SET @RowCount = 0;
			END;
		END;			
    END TRY
    BEGIN CATCH
		DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_AdminUsersByUserId @RoleName = '+@RoleName+' ,@UserName='+@UserName+',@WhereClause='+cast(@WhereClause as varchar(max))+' ,@Rows= '+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_By='+@Order_By+',@RowCount='+CAST(@RowCount AS VARCHAR(50));
		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName    = 'Znode_AdminUsersByUserId',
		@ErrorInProcedure = @ERROR_PROCEDURE,
		@ErrorMessage     = @ErrorMessage,
		@ErrorLine        = @ErrorLine,
		@ErrorCall        = @ErrorCall;
    END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_UpdateQuoteStatus')
	DROP PROC Znode_UpdateQuoteStatus
GO


CREATE PROCEDURE [dbo].[Znode_UpdateQuoteStatus]
(   
	@OmsQuoteId      VARCHAR(2000),
    @OmsOrderStateId INT           = NULL,
    @Status          INT           = 0 OUT, -- 1 for  sucessfull delete and update 
	@ExceptUpdateStatus VARCHAR(max) = '', -- in this status Quote are not updated 
	@ModifiedBy INT = 0 , 
	@IsAdminUser BIT = 0 
)
AS
  /* 
	Summary :- This Procedure is used to update the Quote status 
				returns 0 or 1 as result depends upon the status
	Unit Testing 
	begin tran
	DECLARE @OutIds INT = 0 
	EXEC Znode_UpdateQuoteStatus '306,281,263',80,@OutIds OUT,'Ordered,Draft'
	SELECT @OutIds
	rollback tran
	SELECT * FROM [ZNodeUserQuoteOrderLineItem]  WHERE omsQuoteId IN (306,281,263)
	SELECT * FROM ZnodeOmsOrderState
   */
BEGIN 
	BEGIN TRY
	SET NOCOUNT ON;
		DECLARE @TBL_NotUpdateStatus TABLE (value  VARCHAR(max))
		DECLARE @RejectOmsOrderStateId INT = (SELECT TOP 1 OmsOrderStateId FROM ZnodeOmsOrderState WHERE OrderStateName = 'REJECTED')
		DECLARE @ApprovedOmsOrderStateId INT = (SELECT TOP 1 OmsOrderStateId FROM ZnodeOmsOrderState WHERE OrderStateName = 'APPROVED')
		DECLARE @TBL_UpdateApprovalState TABLE (UserId INT ,ApprovalLevelId INT ,ApproverUserId INT, ApproverOrder INT   )
		DECLARE @TBL_OrderState TABLE
        (FirstName  VARCHAR(100),
        LastName   VARCHAR(100),
        Email      VARCHAR(50),
        [Status]   NVARCHAR(MAX),
        OmsQuoteId INT,
        UserId     INT,
        PortalId   INT,
		OmsOrderStateId INT
        );
             
		IF @ExceptUpdateStatus = '' 
		BEGIN 
			INSERT INTO @TBL_NotUpdateStatus 
			SELECT value 
			FROM dbo.[Fn_GetProcedureAttributeDefault]('OrderState') FNGP
		END 
		ELSE 
		BEGIN 
			INSERT INTO @TBL_NotUpdateStatus 
			SELECT item 
			FROM dbo.split(@ExceptUpdateStatus,',') FNGP
		END 

		IF EXISTS (SELECT TOP 1 1  FROM  ZnodeUser ZU 
							INNER JOIN AspNetUsers AU ON (AU.Id = ZU.AspNetUserId)
							INNER JOIN AspNetUserRoles RTY ON (RTY.UserId = AU.Id)
							INNER JOIN AspNetRoles TU ON (TU.Id = RTY.RoleId)
							WHERE ZU.UserId = @ModifiedBy  AND (ISNULL(TU.TypeOfRole,'') <> 'B2B' AND   TU.Name <> 'Customer'))
	BEGIN 
		SET @IsAdminUser = 1 
	END 


	DECLARE @OmsQuoteIds TABLE (OmsQuoteId INT )
	INSERT INTO  @OmsQuoteIds
	SELECT Item
    FROM dbo.Split(@OmsQuoteId, ',') SP

			 	 
		INSERT INTO @TBL_OrderState
        (FirstName,
        LastName,
        Email,
        [Status],
        OmsQuoteId,
        UserId,
        PortalId,
		OmsOrderStateId
        )
            SELECT ZU.FirstName,
                    Zu.LastName,
                    ZU.Email,
                    ZOOS.OrderStateName,
                    ZOQ.OmsQuoteId,
                    ZU.UserId,
                    ZOQ.PortalId,
					ZOOS.OmsOrderStateId
            FROM ZnodeUser ZU
                    INNER JOIN ZnodeOmsQuote ZOQ ON(ZOQ.UserId = ZU.UserId)
                    INNER JOIN ZnodeOmsOrderState ZOOS ON(ZOOS.OmsOrderStateId = ZOQ.OmsOrderStateId)
            WHERE EXISTS
            (
                SELECT TOP 1 1
                FROM @OmsQuoteIds SP
                WHERE ZOQ.OmsQuoteId = SP.OmsQuoteId
            );
         

	DECLARE @ApproverUserId TABLE (ApproverUserId INT )
	INSERT INTO @ApproverUserId
	SELECT  ApproverUserId 
	FROM ZnodeUserApprovers 
	WHERE ApproverOrder IN (SELECT ApproverOrder  FROM  ZnodeUserApprovers 
				WHERE ApproverUserId = @ModifiedBy 
				AND USERId  = ( SELECT TOP 1 UserId FROM ZnodeOMSQuoteApproval ZOQ WHERE EXISTS
            (
                SELECT TOP 1 1
                FROM @OmsQuoteIds SP
                WHERE ZOQ.OmsQuoteId = SP.OmsQuoteId
            ) )
	) AND USERId  = ( SELECT TOP 1 UserId FROM ZnodeOMSQuoteApproval 
	WHERE EXISTS
            (
                SELECT TOP 1 1
                FROM @OmsQuoteIds SP
                WHERE ZnodeOMSQuoteApproval.OmsQuoteId = SP.OmsQuoteId
            ) )
			 
	INSERT INTO @ApproverUserId
	SELECT ApproverUserId 
	FROM ZnodeUserApprovers a 
	INNER JOIN ZnodePortalApproval b ON (b.PortalApprovalId= a.PortalApprovalId)
	WHERE a.IsActive = 1 
	AND b.PortalId = (SELECT TOP 1 PortalId FROM ZnodeOmsQuote asd WHERE EXISTS
            (
                SELECT TOP 1 1
                FROM @OmsQuoteIds SP
                WHERE asd.OmsQuoteId = SP.OmsQuoteId
            ) )



	UPDATE ZnodeOMSQuoteApproval
        SET OmsOrderStateId = @OmsOrderStateId
		, ModifiedBy = @ModifiedBy,ModifiedDate = GetDate()
        WHERE EXISTS
        (
            SELECT 1
            FROM dbo.Split(@OmsQuoteId, ',') AS f
            WHERE f.item = ZnodeOMSQuoteApproval.OmsQuoteId
        )
        AND ( (NOT EXISTS 
        (
            SELECT TOP 1 1
            FROM @TBL_OrderState TBOS
            WHERE EXISTS
            (
                SELECT TOP 1 1
                FROM @TBL_NotUpdateStatus FNGP
                WHERE FNGP.Value = TBOS.[Status]
            )
            AND ZnodeOMSQuoteApproval.OmsQuoteId = TBOS.OmsQuoteId
        )
		AND( ApproverUserId = @ModifiedBy  OR ApproverUserId  
		IN (SELECT ApproverUserId FROM @ApproverUserId) OR @IsAdminUser = 1 ))) ; 
			 
		DECLARE @AmountOfQuote NUMERIC(28,8) = (SELECT TOP 1 QuoteOrderTotal FROM ZnodeOmsQuote WHERE OmsQuoteId = @OmsQuoteId  )

	INSERT INTO @TBL_UpdateApprovalState 
	SELECT UserId  ,ApproverLevelId  ,ApproverUserId , ApproverOrder
	FROM ZnodeUserApprovers a 
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeOMSQuoteApproval TY 
	WHERE TY.UserId = a.UserId 
	AND TY.ApproverOrder = a.ApproverOrder  
	AND  TY.OmsOrderStateId = @ApprovedOmsOrderStateId
	AND EXISTS
        (
            SELECT 1
            FROM dbo.Split(@OmsQuoteId, ',') AS f
            WHERE f.item = TY.OmsQuoteId
        )
		)
	AND EXISTS (SELECT TOP 1 1 FROM ZnodeOMSQuoteApproval TY 
	WHERE TY.UserId = a.UserId 
	AND EXISTS
        (
            SELECT 1
            FROM dbo.Split(@OmsQuoteId, ',') AS f
            WHERE f.item = TY.OmsQuoteId
        ) )
		AND  a.FromBudgetAmount <= @AmountOfQuote
			
	UPDATE ZnodeOMSQuoteApproval 
	SET IsApprovalRoutingComplete = 1 
		, ModifiedBy = @ModifiedBy,ModifiedDate = GetDate()
        WHERE EXISTS
        (
            SELECT 1
            FROM dbo.Split(@OmsQuoteId, ',') AS f
            WHERE f.item = ZnodeOMSQuoteApproval.OmsQuoteId
        )
        AND (NOT EXISTS (SELECT TOP 1 1  FROM @TBL_UpdateApprovalState) OR @IsAdminUser = 1) 
		AND (@IsAdminUser = 1 OR ZnodeOMSQuoteApproval.ApproverUserId = @ModifiedBy)
		;

	--- SELECT @IsAdminUser 

		UPDATE ZnodeOmsQuote
        SET OmsOrderStateId = @OmsOrderStateId
		,IsConvertedToOrder = CASE WHEN @OmsOrderStateId IN (SELECT OmsOrderStateId FROM ZnodeOmsOrderState WHERE OrderStateName = 'REJECTED') 
								THEN 1  
								WHEN @OmsOrderStateId IN (SELECT OmsOrderStateId FROM ZnodeOmsOrderState WHERE OrderStateName IN ('APPROVED','PENDING APPROVAL')
										AND NOT EXISTS (SELECT * FROM ZnodeOmsOrder WHERE OMSQuoteId=ZnodeOmsQuote.OMSQuoteId)) 
								THEN 0
								ELSE IsConvertedToOrder END 
		, ModifiedBy = @ModifiedBy
		,ModifiedDate = GetDate()
        WHERE EXISTS
        (
            SELECT 1
            FROM dbo.Split(@OmsQuoteId, ',') AS f
            WHERE f.item = ZnodeOmsQuote.OmsQuoteId
        )
        AND ((
		NOT EXISTS
        (
            SELECT TOP 1 1
            FROM @TBL_OrderState TBOS
            WHERE EXISTS
            (
                SELECT TOP 1 1
                FROM @TBL_NotUpdateStatus FNGP
                WHERE FNGP.Value = TBOS.[Status]
            )
            AND ZnodeOmsQuote.OmsQuoteId = TBOS.OmsQuoteId
        )
		AND (EXISTS (SELECT TOP 1  1  FROM ZnodeOMSQuoteApproval TY WHERE TY.OmsQuoteId = ZnodeOmsQuote.OmsQuoteId AND TY.IsApprovalRoutingComplete = 1   )
		OR EXISTS (SELECT TOP 1 1   FROM ZnodeOMSQuoteApproval TY WHERE TY.OmsQuoteId = ZnodeOmsQuote.OmsQuoteId  AND TY.OmsOrderStateId = @RejectOmsOrderStateId)) 
		) OR @IsAdminUser = 1 ) ;
			
		IF NOT EXISTS
        (
            SELECT TOP 1 1
            FROM @TBL_OrderState TBOS
            WHERE EXISTS
            (
                SELECT TOP 1 1
                FROM @TBL_NotUpdateStatus FNGP
                WHERE FNGP.Value = TBOS.[Status]
            )
        )  AND EXISTS (SELECT TOP 1 1 FROM @TBL_OrderState TBOS) 
            BEGIN
            SELECT a.FirstName,
                    a.LastName,
                    a.Email,
                    ZOOS.OrderStateName [Status],
                    a.OmsQuoteId,
                    a.UserId,
                    a.PortalId, 
					ZOOS2.OrderStateName ChildOrderStatus,
					aa.QuoteOrderTotal,
					ZOOS2.OmsOrderStateId 
                FROM @TBL_OrderState a 
				INNER JOIN ZnodeOmsQuote aa ON (aa.OmsQuoteId =a.OmsQuoteId)
				INNER JOIN ZnodeOmsOrderState ZOOS ON(ZOOS.OmsOrderStateId =  aa.OmsOrderStateId )
				INNER JOIN ZnodeOmsOrderState ZOOS2 ON(ZOOS2.OmsOrderStateId =  @OmsOrderStateId )
                SET @Status = 1;
                  
            END;
        ELSE
            BEGIN
                SET @Status = 0;
            END;
    END TRY
    BEGIN CATCH
              
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_UpdateQuoteStatus @OmsQuoteId = '+@OmsQuoteId+',@OmsOrderStateId='+CAST(@OmsOrderStateId AS VARCHAR(50))+',@ExceptUpdateStatus='+@ExceptUpdateStatus+',@Status='+CAST(@Status AS VARCHAR(10))+',@ModifiedBy='+@ModifiedBy;
              			 
        SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
        EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_UpdateQuoteStatus',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
    END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportPriceList')
	DROP PROC Znode_ImportPriceList
GO

CREATE PROCEDURE [dbo].[Znode_ImportPriceList]
(
	@TableName nvarchar(100),
	@Status bit OUT, 
	@UserId int, 
	@ImportProcessLogId int,
	@NewGUId nvarchar(200),
	@PriceListId int )
AS 
	/*
	----Summary:  Import RetailPrice List 
	----		  Input XML data extracted in table format (table variable name:  #InsertPriceForValidation) by using  @xml.nodes 
	----		  Validate data column wise and store error log into @ErrorLogForInsertPrice table 
	----          Remove wrong data from table #InsertPriceForValidation and inserted correct data into @InsertPrice table for 
	----		  further processing (Importing to target database )
	---- Version 1 : Required Validation 
	---- UomName should not be null 
	---- Data for this RetailPrice list is already available  
	---- Version 2 : Required Validation 
	---- If UomName will be null then insert first record from UomTable and If UomName is wrong then raise error
	---- SKU with retailprice data is available with price list id will insert 
	---- multiple SKU with retail price is available then updated last sku details to price table and price tier table for respective price list
	----1. Import functionality should be provided only for single price list (Validate - Pending) 
	----  Tier price : TierStartQuantity should not between TierStartQuantity and TierEndQuantity for already existing SKU 
	----  In case of update details for SKU if any kind of price value will null then avoid it to update on existing value. 
	----2. From XML only SKU and RetailPrice is mandatory
	----3. SKUActivation date sholud be less than SKUExpriration date
	----4. Activation date sholud be less than Expiration date
	----5. If Tier RetailPrice has values and TierSartQuantity /TierEndQuantity or both has null value then it should not get updated/created.
	----6. ActivationDate and ExpirationDate value for tier price will be SKUActivationDate SKUExprirationDate 
	--- Change History : 
	--Remove column which is used to store range of qunatity by single column Quantity from table ZnodeTierProduct 
	--Manditory Retail price in Znodepricetable 
	-- SKUActivationfrom date and to date will used for tier price will store in single table ZnodePrice
	--Unit Testing   
	
*/
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
	    DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
		
		IF OBJECT_ID('#InsertPriceForValidation', 'U') IS NOT NULL 
			DROP TABLE #InsertPriceForValidation
		ELSE 
			CREATE TABLE #InsertPriceForValidation 
			(SKU varchar(300) NULL, TierStartQuantity varchar(300) NULL, RetailPrice varchar(300) NULL, SalesPrice varchar(300) NULL, TierPrice varchar(300) NULL, SKUActivationDate varchar(300) NULL, SKUExpirationDate varchar(300) NULL,
			Custom1 varchar(300) NULL, Custom2 varchar(300) NULL, Custom3 varchar(300) NULL,CostPrice varchar(100), RowNumber varchar(300) NULL)

		IF OBJECT_ID('#InsertPrice', 'U') IS NOT NULL 
			DROP TABLE #InsertPrice
		ELSE 
			CREATE TABLE #InsertPrice 
			( 
				SKU varchar(300), TierStartQuantity numeric(28, 6) NULL, RetailPrice numeric(28, 6) NULL, SalesPrice numeric(28, 6) NULL, TierPrice numeric(28, 6) NULL, SKUActivationDate varchar(300) NULL, SKUExpirationDate varchar(300) NULL,
				Custom1 varchar(300) NULL, Custom2 varchar(300) NULL, Custom3 varchar(300) NULL,CostPrice numeric(28, 6), RowNumber varchar(300)
			);
	
	
		DECLARE @SKU TABLE
		( 
				SKU nvarchar(300)
		);
		INSERT INTO @SKU
			   SELECT b.AttributeValue
			   FROM ZnodePimAttributeValue AS a
					INNER JOIN
					ZnodePimAttributeValueLocale AS b
					ON a.PimAttributeId = dbo.Fn_GetProductSKUAttributeId() AND 
					   a.PimAttributeValueId = b.PimAttributeValueId;


		DECLARE @RoundOffValue int, @MessageDisplay nvarchar(100); 
		-- Retrive RoundOff Value from global setting 

		SELECT @RoundOffValue = FeatureValues FROM ZnodeGlobalSetting WHERE FeatureName = 'PriceRoundOff';
	
		--@MessageDisplay will use to display validate message for input inventory value  

		DECLARE @sSql nvarchar(max);
		SET @sSql = ' Select @MessageDisplay_new = Convert(Numeric(28, '+CONVERT(nvarchar(200), @RoundOffValue)+'), 999999.000000000 ) ';
		EXEC SP_EXecutesql @sSql, N'@MessageDisplay_new NVARCHAR(100) OUT', @MessageDisplay_new = @MessageDisplay OUT;
		

		SET @SSQL = 'Select SKU,TierStartQuantity ,RetailPrice,SalesPrice,TierPrice,SKUActivationDate ,SKUExpirationDate ,
		 Custom1, Custom2, Custom3,CostPrice, RowNumber FROM '+@TableName;
		INSERT INTO #InsertPriceForValidation( SKU, TierStartQuantity, RetailPrice, SalesPrice, TierPrice, SKUActivationDate, SKUExpirationDate,
		 Custom1, Custom2, Custom3,CostPrice, RowNumber )
		EXEC sys.sp_sqlexec @SSQL;

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '113', 'TierPrice', TierPrice, @NewGUId, RowNumber , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #InsertPriceForValidation
				WHERE  CONVERT(varchar(100), TierPrice) ='' AND CONVERT(varchar(100), TierStartQuantity) <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '114', 'TierStartQuantity', TierStartQuantity, @NewGUId, RowNumber , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #InsertPriceForValidation
				WHERE  CONVERT(varchar(100), TierStartQuantity) ='' AND CONVERT(varchar(100), TierPrice) <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '2', 'TierPrice', TierPrice, @NewGUId, RowNumber , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #InsertPriceForValidation
				WHERE (isnumeric(TierPrice)=0  
				or exists(select * from ZnodeCulture where Symbol is not null and TierPrice like '%'+Symbol+'%')) and ISNULL(TierPrice,'')<>''
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '2', 'SalesPrice', SalesPrice, @NewGUId, RowNumber , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #InsertPriceForValidation
				WHERE (isnumeric(SalesPrice)=0	or exists(select * from ZnodeCulture where Symbol is not null and SalesPrice like '%'+Symbol+'%'))
				and ISNULL(SalesPrice,'')<>''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '2', 'RetailPrice', RetailPrice, @NewGUId, RowNumber , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #InsertPriceForValidation
				WHERE (isnumeric(RetailPrice)=0 or exists(select * from ZnodeCulture where Symbol is not null and RetailPrice like '%'+Symbol+'%')) and ISNULL(RetailPrice,'')<>''
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '2', 'CostPrice', CostPrice, @NewGUId, RowNumber , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #InsertPriceForValidation
				WHERE (isnumeric(CostPrice)=0	or exists(select * from ZnodeCulture where Symbol is not null and CostPrice like '%'+Symbol+'%'))
				and ISNULL(CostPrice,'')<>''

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	        SELECT '53', 'TierStartQuantity', TierStartQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	        FROM #InsertPriceForValidation 
			   WHERE TierStartQuantity IN
			   (
				   select TierStartQuantity from #InsertPriceForValidation
					group by TierStartQuantity
					having count(1)>1
			   ) AND ISNULL(TierStartQuantity,'') <> ''

		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ SKU - ' + ISNULL(SKU,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN #InsertPriceForValidation IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL
			   			  	
	    --- Delete Invalid Data after functional validation 
		DELETE FROM #InsertPriceForValidation
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId AND 
				  Guid = @NewGUId
		);
		-- 1)  Validation for SKU is pending Proper data not found and 
		--Discussion still open for Publish version where we create SKU and use the SKU code for validation 
		--Select * from ZnodePimAttributeValue  where PimAttributeId =248
		--select * from View_ZnodePimAttributeValue Vzpa Inner join ZnodePimAttribute Zpa on Vzpa.PimAttributeId=Zpa.PimAttributeId where Zpa.AttributeCode = 'SKU'
		--Select * from ZnodePimAttribute where AttributeCode = 'SKU'
		--------------------------------------------------------------------------------------
		--2)  Start Data Type Validation for XML Data  
		--------------------------------------------------------------------------------------			
		---------------------------------------------------------------------------------------
		---------If UOM will blank then retrive top -- Finctionality pending 
		---Validate 
		
		INSERT INTO #InsertPrice( SKU, TierStartQuantity, RetailPrice, SalesPrice, TierPrice, SKUActivationDate, SKUExpirationDate,
		 Custom1, Custom2, Custom3,CostPrice, RowNumber )
			   SELECT SKU,
					  CASE
					  WHEN CONVERT(Varchar(100),TierStartQuantity) = '' THEN 0
					  ELSE CONVERT(numeric(28, 6), TierStartQuantity)
					  END, CONVERT(numeric(28, 6), RetailPrice),
															  CASE
															  WHEN SalesPrice = '' THEN NULL
															  ELSE CONVERT(numeric(28, 6), SalesPrice)
															  END,
															  CASE
															  WHEN TierPrice = '' THEN NULL
															  ELSE CONVERT(numeric(28, 6), TierPrice)
															  END, SKUActivationDate, SKUExpirationDate,
															   Custom1, Custom2, Custom3,
															   CASE
															  WHEN CostPrice = '' THEN NULL
															  ELSE CONVERT(numeric(28, 6), CostPrice)
															  END, RowNumber
			   FROM #InsertPriceForValidation;
			 
		--------------------------------------------------------------------------------------
		--- start Functional Validation 
		--------------------------------------------------------------------------------------
		--- Verify SKU is present or not 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '98', 'SKU', SKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM #InsertPrice AS ii
		WHERE ii.SKU NOT IN
		(
			SELECT SKU
			FROM @SKU
		);

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '39', 'SKUActivationDate', SKUActivationDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertPrice AS IP
			   WHERE cast(SKUActivationDate as datetime) > cast(SKUExpirationDate as datetime) AND 
					 ISNULL(SKUExpirationDate, '') <> '';
					 
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '108', 'TierStartQuantity', TierStartQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertPriceForValidation
			   WHERE( TierPrice IS NULL OR TierPrice = '0') AND  TierStartQuantity  = '';
			  
			  
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '109', 'TierPrice', TierPrice, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertPriceForValidation WHERE( TierPrice IS NULL OR  TierPrice = '') AND TierStartQuantity  <> 0;

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '26', 'TierStartQuantity', TierStartQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertPriceForValidation IPV
			   WHERE TierStartQuantity = ''  
				AND	( TierPrice <> ''  OR TierPrice IS NULL ) 

			  
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '26', 'TierStartQuantity', TierStartQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertPriceForValidation IPV
			   WHERE TierStartQuantity <> '' AND 
			    ISNULL(CAST(TierStartQuantity AS numeric(28, 6)), 0) <= 0 
				AND	( TierPrice <> ''  OR TierPrice IS NULL ) 
		
		
				  
		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ SKU - ' + ISNULL(SKU,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN #InsertPrice IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

			 
 	
		-- End Function Validation 	
		---------------------------
		--- Delete Invalid Data after functional validation 
		DELETE FROM #InsertPrice
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId AND 
				  Guid = @NewGUId
		);
	
		-- Remove duplicate records 
		--insert into @RemoveDuplicateInsertPrice
		--(SKU,TierStartQuantity, RetailPrice , SalesPrice , TierPrice , Uom , UnitSize , PriceListCode , PriceListName , CurrencyId , ActivationDate , ExpirationDate 
		--, SKUActivationDate , SKUExpirationDate , RowNumber )
		--Select SKU,TierStartQuantity, RetailPrice , SalesPrice , TierPrice , Uom , UnitSize , PriceListCode , PriceListName , CurrencyId , ActivationDate , ExpirationDate 
		--, SKUActivationDate , SKUExpirationDate , RowNumber FROM @InsertPrice 
		
		--Delete from @InsertPrice 

		--insert into @InsertPrice (SKU,TierStartQuantity, RetailPrice , SalesPrice , TierPrice , Uom , UnitSize , PriceListCode , PriceListName , CurrencyId , ActivationDate , ExpirationDate 
		--, SKUActivationDate , SKUExpirationDate , RowNumber)
		--Select SKU,TierStartQuantity, RetailPrice , SalesPrice , TierPrice , Uom , UnitSize , PriceListCode , PriceListName , CurrencyId , ActivationDate , ExpirationDate 
		--, SKUActivationDate , SKUExpirationDate , RowNumber from @RemoveDuplicateInsertPrice rdip WHERE rdip.RowNumber IN
		--(
		--	SELECT MAX(ipi.RowNumber) FROM @InsertPrice ipi WHERE rdip.PriceListCode = ipi.PriceListCode AND rdip.SKU = ipi.SKU
		--);

		--Validate StartQuantity and EndQuantity from PriceTier : This validation only for existing data 
		--INSERT INTO @ErrorLogForInsertPrice (RowNumber,SKU,TierStartQuantity ,RetailPrice ,SalesPrice,TierPrice,Uom ,UnitSize,PriceListCode,PriceListName,CurrencyId ,ActivationDate,ExpirationDate,SKUActivationDate,SKUExpirationDate,SequenceNumber,ErrorDescription) 
		--Select IP.RowNumber,IP.SKU,IP.TierStartQuantity ,IP.RetailPrice ,IP.SalesPrice,IP.TierPrice,IP.Uom ,IP.UnitSize,IP.PriceListCode,IP.PriceListName,IP.CurrencyId ,IP.ActivationDate,IP.ExpirationDate,IP.SKUActivationDate,IP.SKUExpirationDate,IP.SequenceNumber,
		--'TierStartQuantity already exists in PriceTier table for SKU '
		--From @InsertPrice IP  Inner join
		--ZnodePriceList Zpl ON Zpl.Listcode = IP.PriceListcode and Zpl.ListName = IP.PriceListName
		--INNER JOIN ZnodeUOM Zu ON ltrim(rtrim(IP.Uom)) = ltrim(rtrim(Zu.Uom)) 
		--INNER JOIN ZnodePriceTier ZPT  ON ZPT.PriceListId = Zpl.PriceListId 
		--AND ZPT.SKU = IP.SKU
		--Where IP.TierStartQuantity  = ZPT.Quantity  
		--- Delete Invalid Data after  Validate StartQuantity and EndQuantity from PriceTier
		
		--INSERT INTO ZnodeUOM (Uom,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		--Select distinct ltrim(rtrim(Uom)) , @UserId,@GetDate,@UserId,@GetDate  from @InsertPrice 
		--where ltrim(rtrim(Uom)) not in (Select ltrim(rtrim(UOM)) From ZnodeUOM where UOM  is not null )
		
		DECLARE @FailedRecordCount BIGINT, @SuccessRecordCount BIGINT 
	
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;

		SELECT @SuccessRecordCount = COUNT(DISTINCT ROWNUMBER) FROM #InsertPrice WHERE 	ROWNUMBER IS NOT NULL ;

		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;

		UPDATE ZP
				SET ZP.SalesPrice = IP.SalesPrice, ZP.RetailPrice = CASE
				WHEN CONVERT(varchar(100), ISNULL(IP.RetailPrice, '')) <> '' THEN IP.RetailPrice
				END, ZP.ActivationDate = CASE
				WHEN ISNULL(IP.SKUActivationDate, '') <> '' THEN IP.SKUActivationDate
				ELSE NULL
				END, ZP.ExpirationDate = CASE
				WHEN ISNULL(IP.SKUExpirationDate, '') <> '' THEN IP.SKUExpirationDate
				ELSE NULL
				END, ZP.ModifiedBy = @UserId, ZP.ModifiedDate = @GetDate,
				ZP.CostPrice =IP.CostPrice
		FROM #InsertPrice IP INNER JOIN ZnodePrice ZP ON ZP.PriceListId = @PriceListId AND  ZP.SKU = IP.SKU  
			 --Retrive last record from price list of specific SKU ListCode and Name 									
		WHERE IP.RowNumber IN
		(
			SELECT MAX(IPI.RowNumber) FROM #InsertPrice AS IPI WHERE IPI.SKU = IP.SKU 
		);
		INSERT INTO ZnodePrice( PriceListId, SKU, SalesPrice, RetailPrice, ActivationDate, ExpirationDate, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate,CostPrice )
			   SELECT @PriceListId, IP.SKU, IP.SalesPrice, IP.RetailPrice,
																						   CASE
																						   WHEN ISNULL(IP.SKUActivationDate, '') = '' THEN NULL
																						   ELSE IP.SKUActivationDate
																						   END,
																						   CASE
																						   WHEN ISNULL(IP.SKUExpirationDate, '') = '' THEN NULL
																						   ELSE IP.SKUExpirationDate
																						   END, @UserId, @GetDate, @UserId, @GetDate,IP.CostPrice
			   FROM #InsertPrice AS IP
			   WHERE NOT EXISTS
			   (
				   SELECT TOP 1 1
				   FROM ZnodePrice
				   WHERE ZnodePrice.PriceListId = @PriceListId AND 
						 ZnodePrice.SKU = IP.SKU 
			   ) AND 
					 IP.RowNumber IN
			   (
					SELECT MAX(IPI.RowNumber)
					FROM #InsertPrice AS IPI
					WHERE IPI.SKU = IP.SKU 
			   );

			 

		IF EXISTS
		(
			SELECT TOP 1 1
			FROM #InsertPrice
			WHERE CONVERT(varchar(100), TierStartQuantity) <> '' AND 
				  (CONVERT(varchar(100), TierPrice) <> '' OR CONVERT (varchar(100), TierPrice) IS NOT NULL)
		)
		BEGIN
		
			UPDATE ZPT
			  SET ZPT.Price = IP.TierPrice, ZPT.ModifiedBy = @UserId, ZPT.ModifiedDate = @GetDate,
			  ZPT.Custom1 = IP.Custom1,ZPT.Custom2 = IP.Custom2, ZPT.Custom3 = IP.Custom3 
			FROM #InsertPrice IP INNER JOIN ZnodePriceTier ZPT ON ZPT.PriceListId = @PriceListId AND  ZPT.SKU = IP.SKU AND ZPT.Quantity = IP.TierStartQuantity 
		    --Retrive last record from price list of specific SKU ListCode and Name 
			WHERE IP.RowNumber IN
			(
				SELECT MAX(IPI.RowNumber) FROM #InsertPrice AS IPI WHERE IPI.SKU = IP.SKU AND IPI.TierStartQuantity = IP.TierStartQuantity 
			);

			INSERT INTO ZnodePriceTier( PriceListId, SKU, Price, Quantity, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, Custom1, Custom2, Custom3 )
				   SELECT @PriceListId, IP.SKU, IP.TierPrice, IP.TierStartQuantity,  @UserId, @GetDate, @UserId, @GetDate, Custom1, Custom2, Custom3
				   FROM #InsertPrice AS IP 
				   WHERE NOT EXISTS
				   (
					   SELECT TOP 1 1 FROM ZnodePriceTier WHERE ZnodePriceTier.PriceListId = @PriceListId AND  ZnodePriceTier.SKU = IP.SKU AND 
							 ZnodePriceTier.Quantity = IP.TierStartQuantity
				   ) AND  IP.RowNumber IN
				   (
					   SELECT MAX(IPI.RowNumber) FROM #InsertPrice AS IPI WHERE IPI.SKU = IP.SKU AND  IPI.TierStartQuantity = IP.TierStartQuantity
				   );
		END;  

		SET @Status = 1;
		
		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		-- COMMIT TRAN ImportProducts;
		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportPriceList @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PriceListId='+CAST(@PriceListId AS VARCHAR(max));
		
		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportPriceList',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;

	END CATCH;
END;

GO

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'ProductFeed','IsFileNameExist',1,2,Getdate(),2,Getdate()
where not exists(select * from ZnodeActions where ControllerName = 'ProductFeed' and ActionName = 'IsFileNameExist')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
 (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Product Feeds' AND ControllerName = 'ProductFeed')
    ,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'ProductFeed' and ActionName= 'IsFileNameExist') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
     (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Product Feeds' AND ControllerName = 'ProductFeed') and ActionId =
     (select TOP 1 ActionId from ZnodeActions where ControllerName = 'ProductFeed' and ActionName= 'IsFileNameExist'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Product Feeds' AND ControllerName = 'ProductFeed')
,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'ProductFeed' and ActionName= 'IsFileNameExist')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Product Feeds' AND ControllerName = 'ProductFeed') and ActionId =
     (select TOP 1 ActionId from ZnodeActions where ControllerName = 'ProductFeed' and ActionName= 'IsFileNameExist'))

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_AdminUsersByUserId')
	DROP PROC Znode_AdminUsersByUserId
GO

CREATE PROCEDURE [dbo].[Znode_AdminUsersByUserId]
(	
	@RoleName		VARCHAR(200),
    @UserName		VARCHAR(200),
    @WhereClause	XML,
    @Rows			INT           = 100,
    @PageNo			INT           = 1,
    @Order_By		VARCHAR(1000) = '',
    @RowCount		INT        = 0 OUT,
	@IsCallOnSite   BIT = 0 ,
	@PortalId		VARCHAR(1000) = 0,
	@IsGuestUser    BIT = 0,
	@ColumnName     dbo.SelectColumnList ReadOnly,
	@SalesRepUserId Int = 0,
	@IsSalesRepList Bit = 0
)
AS
/* 
    Summary: List of users with details and shows link with ASPNet tables 
    This procedure is used for finding both users and admin users 
    here use three view "View_RoleUsers" for check  @UserName is present or not 
    "View_AdminUserDetail"  this view use for admin users 
    "View_CustomerUserDetail" Use for customer users 
    Unit Testing   
	SELECT * FROM ZnodeUser 
    DECLARE @EDE INT=0  EXEC Znode_AdminUsersByUserId '','admin@znode.com',@WhereClause='',@Order_By='',@PageNo= 1 ,@Rows= 214,@IsCallOnSite='false',@PortalId=0,@RowCount=@EDE OUT  SELECT @EDE
*/
BEGIN
    BEGIN TRY
    SET NOCOUNT ON;
			
		DECLARE @SQL NVARCHAR(MAX)= '', @PaginationWhereClause VARCHAR(300)= dbo.Fn_GetRowsForPagination(@PageNo, @Rows, ' WHERE RowId');
             
		----Verifying that the @SalesRepUserId is having 'Sales Rep' role
		IF NOT EXISTS
		(
			SELECT * FROM ZnodeUser ZU
			INNER JOIN AspNetZnodeUser ANZU ON ZU.UserName = ANZU.UserName
			INNER JOIN AspNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName
			INNER JOIN AspNetUserRoles ANUR ON ANU.Id = ANUR.UserId
			Where Exists(select * from AspNetRoles ANR Where Name = 'Sales Rep' AND ANUR.RoleId = ANR.Id) 
			AND ZU.UserId = @SalesRepUserId
		)   
		Begin
			SET @SalesRepUserId = 0
		End

		IF OBJECT_ID('tempdb..#TBL_RowCount') is not null
			DROP TABLE #TBL_RowCount
		Create table #TBL_RowCount(RowsCount int )
		-----Split where clause XMl 
		CREATE TABLE #WhereColumnList(RowId Int identity, filterName varchar(max), WhereCondition varchar(max))
		insert into #WhereColumnList(filterName,WhereCondition)
		SELECT 
				Tbl.Col.value('key[1]', 'varchar(max)') as filterName,
				Tbl.Col.value('condition[1]', 'varchar(max)') WhereCondition
		FROM   @WhereClause.nodes('//filter') Tbl(Col) 
		----Address column in global search
		declare @AddressGlobalSearch varchar(1000)
		declare @GlobalSearch varchar(100)
		select @GlobalSearch = substring(WhereCondition,charindex(' like ',WhereCondition), charindex(' OR ',WhereCondition)-charindex(' like ',WhereCondition)) 
		from #WhereColumnList
		where filtername like '%|%'
		and filtername <> ''
		and filterName in ('CityName','CountryName','PostalCode','StateName','CompanyName') 

		if isnull(@GlobalSearch,'') <> ''
		begin
			select @AddressGlobalSearch = '('+'CityName '+ @GlobalSearch+' OR '+'CountryName '+ @GlobalSearch+' OR '+'PostalCode '+ @GlobalSearch+' OR '+'StateName '+ @GlobalSearch+' OR '+'CompanyName '+ @GlobalSearch+')'
		end
		else
		begin
			SET @AddressGlobalSearch = ''
		end
		----Global search where clause
		declare @WhereClauseGlobal varchar(1000)=''
		select @WhereClauseGlobal = ISNULL(WhereCondition,'')
		from #WhereColumnList
		where filtername like '%|%'
		and filtername <> ''
			
		----Where clause columns except Address columns
		declare @WhereClause1 varchar(max) 
		select @WhereClause1 = COALESCE(@WhereClause1 + '', '') + WhereCondition+' And '
		--case when @WhereClause1 <> ''  then ' And ' else '' end
		from #WhereColumnList a
		where filterName not like '%|%' and
		filterName not in ('CountryName','CityName','StateName','PostalCode','CompanyName')
		and filtername <> ''

		if @WhereClause1 <> ''
		begin
			set @WhereClause1=isnull(substring(@WhereClause1,1,len(@WhereClause1)-3),'')
		end
		else
		begin
			set @WhereClause1 = ''
		end

		----Where clause columns
		declare @AddressColumnWhereClause varchar(max) 
		select @AddressColumnWhereClause = COALESCE(@AddressColumnWhereClause + '', '') + WhereCondition+' And '
		from #WhereColumnList a
		where filterName not like '%|%' and
		filterName in ('CountryName','CityName','StateName','PostalCode','CompanyName')
		and filtername <> ''
			
		if isnull(@AddressColumnWhereClause,'') <> ''
		begin
			set @AddressColumnWhereClause=isnull(substring(@AddressColumnWhereClause,1,len(@AddressColumnWhereClause)-3),'')
		end
		else
		begin
			set @AddressColumnWhereClause = ''
		end

		declare @WhereClauseAll varchar(max)
		select @WhereClauseAll = COALESCE(@WhereClauseAll + '', '') + WhereCondition+' And '
		from #WhereColumnList a

		set @WhereClauseAll=isnull(substring(@WhereClauseAll,1,len(@WhereClauseAll)-3),'')
		-------------- 

		IF @PortalId  <> '0' 
		BEGIN 
			IF @IsSalesRepList IN (1, 'True')
			BEGIN
				SELECT @PortalId = STUFF((SELECT CONCAT(', ', ISNULL(ZUP2.PortalId,@PortalId))
					FROM dbo.ZnodeUserPortal ZUP2 WITH (NOLOCK)
					WHERE ZUP1.UserId = ZUP2.UserId
					FOR XML PATH ('')), 1, 2, '')
				FROM dbo.ZnodeUserPortal ZUP1 WITH (NOLOCK)
				WHERE ZUP1.UserId=(SELECT TOP 1 UserId FROM ZnodeUser WITH (NOLOCK) WHERE UserName=@UserName)
				GROUP BY ZUP1.UserId;
			END

			SET @WhereClauseAll = CASE WHEN  @WhereClauseAll = '' THEN ' (PortalId IN ('+@PortalId+') OR PortalId IS NULL) ' ELSE @WhereClauseAll+' AND (PortalId IN ('+@PortalId+') OR PortalId IS NULL) ' END 

			SET @WhereClause1 = CASE WHEN  @WhereClause1 = '' THEN ' (isnull(PortalId,0) IN ('+@PortalId+') OR PortalId IS NULL) ' ELSE @WhereClause1+' AND (isnull(PortalId,0) IN ('+@PortalId+') OR PortalId IS NULL) ' END 
			
		END 
		IF EXISTS ( SELECT TOP 1 1 FROM View_RoleUsers  WHERE Username = @UserName   )  AND @RoleName <> ''  
		-- this check for admin user
		BEGIN
			SET @SQL = ' SELECT  A.UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,A.CreatedBy,A.CreatedDate,A.ModifiedBy,A.ModifiedDate
			,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
			,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId ,CustomerPaymentGUID
			INTO #Cte_AdminUserDetail
			FROM View_AdminUserDetail A
			'+CASE WHEN @PortalId  <> '0' THEN ' INNER JOIN ZnodeUserPortal ZUP ON (ZUP.UserId = A.UserId) 'ELSE '' END  +'	 
			'+dbo.Fn_GetWhereClause(@WhereClauseAll, ' WHERE ')+'
				
			;with Cte_AdminUserDetailRowId AS 
			(
			SELECT UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
			,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
			,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId,CustomerPaymentGUID ,RANK()Over('+dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC')+',UserId DESC) RowId
			FROM  #Cte_AdminUserDetail a
			where (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
			)
					 
			SELECT UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
			,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
			,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId,CustomerPaymentGUID ,RowId 
			INTO #AccountDetails
			FROM Cte_AdminUserDetailRowId 
					 
			SET @Count= ISNULL((SELECT  Count(DISTINCT UserId) FROM #AccountDetails ),0)
					 
			SELECT DISTINCT UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
			,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
			,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId ,CustomerPaymentGUID
			FROM #AccountDetails '+@PaginationWhereClause+' '+dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC' );
			EXEC SP_executesql
			@SQL,
			N'@Count INT OUT',
			@Count = @RowCount OUT;
		END;
		-- For Customer user
		ELSE   
		BEGIN
			IF @roleName = ''
			BEGIN
				if OBJECT_ID('tempdb..#CustomerUserAddDetail') is not null
				drop table #CustomerUserAddDetail

				if OBJECT_ID('tempdb..#View_CustomerUserAddDetail') is not null
				drop table #View_CustomerUserAddDetail
				
				if OBJECT_ID('tempdb..#UserList') is not null
				drop table #UserList

				CREATE TABLE #UserList(UserId int,AddressID int)

				declare @UserList varchar(1000)=''

				------To get the list of user having adress column in global search
				if (@AddressGlobalSearch <> '')
				begin
				
				set @UserList = 'select a.UserId, b.AddressID	from ZnodeUserAddress a	inner join ZnodeAddress b on a.AddressId = b.AddressId	where '+@AddressGlobalSearch
				--print @UserList
				insert into #UserList(UserId, b.AddressID)
				exec (@UserList)
			
				end
				----To get the list of user having adress column in where clause 
				if (@AddressColumnWhereClause <> '')
				begin
					
				set @UserList = 'select a.UserId, b.AddressID	from ZnodeUserAddress a	inner join ZnodeAddress b on a.AddressId = b.AddressId	where '+@AddressColumnWhereClause
				--print @UserList
				insert into #UserList(UserId,AddressID)
				exec (@UserList)
					
				end

				CREATE TABLE #View_CustomerUserAddDetail (
					UserId INT,AspNetuserId NVARCHAR(256),UserName NVARCHAR(512),FirstName VARCHAR(100),MiddleName	VARCHAR(100),LastName	VARCHAR(100),
					PhoneNumber VARCHAR(50),Email VARCHAR(50),EmailOptIn BIT,CreatedBy	INT, CreatedDate DATETIME,	ModifiedBy	INT ,
					ModifiedDate	DATETIME, RoleId NVARCHAR(256),RoleName  NVARCHAR(512), 	IsActive BIT,	IsLock BIT,	FullName  NVARCHAR(MAX),
					AccountName	 NVARCHAR(512) ,AccountId INT,	ExternalId  NVARCHAR(MAX),	IsAccountCustomer	BIT ,
					BudgetAmount NUMERIC(18,6),	TypeOfRole	 NVARCHAR(512) ,IsGuestUser	BIT ,CustomerPaymentGUID  NVARCHAR(MAX),
					StoreName	 NVARCHAR(512) ,PortalId	INT ,AccountCode  NVARCHAR(200))

					CREATE TABLE #CustomerUserAddDetail(
					UserId INT,AspNetuserId NVARCHAR(256),UserName NVARCHAR(512),FirstName VARCHAR(100),MiddleName	VARCHAR(100),LastName	VARCHAR(100),
					PhoneNumber VARCHAR(50),Email VARCHAR(50),EmailOptIn BIT,CreatedBy	INT, CreatedDate DATETIME,	ModifiedBy	INT ,
					ModifiedDate	DATETIME, RoleId NVARCHAR(256),RoleName  NVARCHAR(512), 	IsActive BIT,	IsLock BIT,	FullName  NVARCHAR(MAX),
					AccountName	 NVARCHAR(512)  ,PermissionsName NVARCHAR(256),DepartmentName NVARCHAR(256) ,DepartmentId INT ,AccountId INT,
					AccountPermissionAccessId INT, ExternalId  NVARCHAR(MAX),BudgetAmount  NUMERIC(18,6),AccountUserOrderApprovalId INT ,ApprovalName NVARCHAR(256),
					ApprovalUserId INT ,PermissionCode NVARCHAR(256) ,CustomerPaymentGUID NVARCHAR(256) ,StoreName NVARCHAR(256),
					PortalId INT,CountryName NVARCHAR(256) , CityName NVARCHAR(256) , StateName NVARCHAR(256), PostalCode NVARCHAR(256),
					CompanyName NVARCHAR(256) , SalesRepUserName NVARCHAR(256) , SalesRepFullName NVARCHAR(256), AccountCode NVARCHAR(200)
					,RowNumber INT )

				If @IsGuestUser= 0 
				AND
				NOT Exists (Select filterName from #WhereColumnList where filterName in ('accountid','isaccountcustomer','UserId') and filtername <> '')
				-- Customer List with GuestUsers
				Begin
					SET @SQL = 
						'INSERT INTO #View_CustomerUserAddDetail
						SELECT a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
							a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATE, a.CreatedDate) CreatedDate,A.ModifiedBy,
							CONVERT( DATE, a.ModifiedDate) ModifiedDate, 0 RoleId,
							CASE WHEN A.AccountId IS NULL THEN '''' ELSE r.name END as RoleName,
							CASE	WHEN B.LockoutEndDateUtc IS NULL
							THEN CAST(1 AS    BIT)	ELSE CAST(0 AS BIT)
							END IsActive,	CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
				
							(ISNULL(RTRIM(LTRIM(a.FirstName)), '''')+'' ''+ISNULL(RTRIM(LTRIM(a.MiddleName)), '''')+CASE
							WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '''') = ''''	THEN ''''
							ELSE '' ''	END+ISNULL(RTRIM(LTRIM(a.LastName)), '''')) 
				
							FullName,
							e.Name AccountName
							,a.AccountId,a.ExternalId,	CASE	WHEN a.AccountId IS NULL THEN 0	ELSE 1	END IsAccountCustomer,
							a.BudgetAmount,
							'''' TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser,a.CustomerPaymentGUID
							--,CASE WHEN zp.StoreName IS NULL THEN ''ALL'' ELSE zp.StoreName END StoreName,
							,ISnull(zp.StoreName , ''ALL'')StoreName,
							up.PortalId as PortalId, e.AccountCode
							
							FROM ZnodeUser a
							INNER JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
							INNER JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
							LEFT JOIN ZnodeUserPortal up ON(up.UserId = a.UserId)  
							LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
							LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
							LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
							LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)
							WHERE (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid ) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
						' 
					EXEC (@SQL)
				End	
				Else If @IsGuestUser= 1 
				Begin
						SET @SQL='INSERT into #View_CustomerUserAddDetail
						SELECT a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
						a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATE, a.CreatedDate) CreatedDate,A.ModifiedBy,
						CONVERT( DATE, a.ModifiedDate) ModifiedDate,ur.RoleId,r.Name RoleName,
						CASE WHEN B.LockoutEndDateUtc IS NULL THEN CAST(1 AS    BIT) ELSE CAST(0 AS BIT) END IsActive,
						CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
						(ISNULL(RTRIM(LTRIM(a.FirstName)), '''')+'' ''+ISNULL(RTRIM(LTRIM(a.MiddleName)), '''')+CASE
						WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '''') = '''' THEN '''' ELSE '' '' END+ISNULL(RTRIM(LTRIM(a.LastName)), '''')) FullName,
						e.Name AccountName,a.AccountId,a.ExternalId,
						CASE WHEN a.AccountId IS NULL THEN 0 ELSE 1	END IsAccountCustomer,
						a.BudgetAmount,r.TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser,a.CustomerPaymentGUID
						,CASE WHEN zp.StoreName IS NULL THEN ''ALL'' ELSE zp.StoreName END StoreName,
						CASE WHEN a.AccountId IS NULL THEN up.PortalId ELSE ZPA.PortalId END as PortalId,e.AccountCode
						
						FROM ZnodeUser a
						LEFT JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
						LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
						LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
						LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)                       
						LEFT JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
						LEFT JOIN ZnodeUserPortal up ON(up.UserId = a.UserId)  
						LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
						LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = a.AccountId) 
						WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUSer ZUQ WHERE ZUQ.UserId = a.UserId AND ZUQ.EmailOptIn = 1 AND ZUQ.AspNetUserId IS NULL )
						AND a.AspNetuserId is null
						AND (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid ) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
						'
					EXEC (@SQL)
				End
				Else IF Exists (Select filterName from #WhereColumnList where filterName in ('UserId') and filtername <> '')
				and  @IsGuestUser= 0   
				-- Customer List for user edit single user 
				Begin
				SET @SQL='INSERT INTO #View_CustomerUserAddDetail
				SELECT a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
						a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATE, a.CreatedDate) CreatedDate,A.ModifiedBy,
						CONVERT( DATE, a.ModifiedDate) ModifiedDate,ur.RoleId,r.Name RoleName,
						CASE WHEN B.LockoutEndDateUtc IS NULL THEN CAST(1 AS    BIT) ELSE CAST(0 AS BIT) END IsActive,
						CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
						(ISNULL(RTRIM(LTRIM(a.FirstName)), '''')+'' ''+ISNULL(RTRIM(LTRIM(a.MiddleName)), '''')+CASE
						WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '''') = '''' THEN '''' ELSE '' '' END+ISNULL(RTRIM(LTRIM(a.LastName)), '''')) FullName,
						e.Name AccountName,a.AccountId,a.ExternalId,
						CASE WHEN a.AccountId IS NULL THEN 0 ELSE 1	END IsAccountCustomer,
						a.BudgetAmount,r.TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser,a.CustomerPaymentGUID
						,CASE WHEN zp.StoreName IS NULL THEN ''ALL'' ELSE zp.StoreName END StoreName,
						CASE WHEN a.AccountId IS NULL THEN up.PortalId ELSE ZPA.PortalId END as PortalId,e.AccountCode
						
						FROM ZnodeUser a
						LEFT JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
						LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
						LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
						LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)                       
						LEFT JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
						LEFT JOIN ZnodeUserPortal up ON(up.UserId = a.UserId)  
						LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
						LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = a.AccountId) 
						WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUSer ZUQ WHERE ZUQ.UserId = a.UserId AND ZUQ.EmailOptIn = 1 AND ZUQ.AspNetUserId IS NULL )
						AND (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid ) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
						'
					EXEC (@SQL)
				End	
				Else -- Account user List 
				Begin	
						INSERT into #View_CustomerUserAddDetail
						SELECT a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
						a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATE, a.CreatedDate) CreatedDate,A.ModifiedBy,
						CONVERT( DATE, a.ModifiedDate) ModifiedDate,ur.RoleId,r.Name RoleName,
						CASE WHEN B.LockoutEndDateUtc IS NULL THEN CAST(1 AS    BIT) ELSE CAST(0 AS BIT) END IsActive,
						CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
						(ISNULL(RTRIM(LTRIM(a.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(a.MiddleName)), '')+CASE
						WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '') = '' THEN '' ELSE ' ' END+ISNULL(RTRIM(LTRIM(a.LastName)), '')) FullName,
						e.Name AccountName,a.AccountId,a.ExternalId,
						CASE WHEN a.AccountId IS NULL THEN 0 ELSE 1	END IsAccountCustomer,
						a.BudgetAmount,r.TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser,a.CustomerPaymentGUID
						,CASE WHEN zp.StoreName IS NULL THEN 'ALL' ELSE zp.StoreName END StoreName,
						CASE WHEN a.AccountId IS NULL THEN up.PortalId ELSE ZPA.PortalId END as PortalId, e.AccountCode
						
						FROM ZnodeUser a
						LEFT JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
						LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
						LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
						LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)                       
						LEFT JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
						LEFT JOIN ZnodeUserPortal up ON(up.UserId = a.UserId)  
						LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
						LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = a.AccountId) 
						WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUSer ZUQ WHERE ZUQ.UserId = a.UserId AND ZUQ.EmailOptIn = 1 AND ZUQ.AspNetUserId IS NULL )
						AND (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = @SalesRepUserId and a.UserId = SalRep.CustomerUserid ) or @SalesRepUserId = 0)
				End


				alter table #View_CustomerUserAddDetail 
				add DepartmentId int, PermissionsName varchar(200), PermissionCode varchar(200), DepartmentName varchar(300), AccountPermissionAccessId int,
				AccountUserOrderApprovalId int, ApprovalName varchar(1000) , ApprovalUserId int
				--, PortalId int , StoreName varchar(1000)
				,CountryName varchar(1000),CityName varchar(1000),StateName varchar(1000),PostalCode varchar(1000), CompanyName varchar(1000),
				SalesRepUserName varchar(600),SalesRepFullName varchar(1000)

	
				IF ((@AddressGlobalSearch like '%CountryName%' OR @AddressGlobalSearch like '%CityName%' OR @AddressGlobalSearch like '%StateName%' OR @AddressGlobalSearch like '%PostalCode%' OR @AddressGlobalSearch like '%CompanyName%')
				and exists(select * from #UserList))
				BEGIN
					update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
					PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName
					from #View_CustomerUserAddDetail a
					inner join ZnodeUserAddress ZUA on a.UserId = ZUA.UserId
					inner  JOIN ZnodeAddress ZA on ZA.AddressId = zua.AddressId
					where exists(select * from #UserList UL where a.UserId = UL.UserId and UL.AddressId = ZA.AddressId )

					update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
					PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName
					from #View_CustomerUserAddDetail a
					inner join ZnodeAccountAddress ZAA on a.AccountId = ZAA.AccountId
					inner  JOIN ZnodeAddress ZA on ZA.AddressId = ZAA.AddressId
					where isnull(a.AccountId,0)<> 0-- is not null
					and exists(select * from #UserList UL where a.UserId = UL.UserId and UL.AddressID = ZA.AddressId)
					and (a.CountryName is null OR a.CityName is null OR a.StateName is null or a.PostalCode is null or a.CompanyName is null)
		
				END

				--CREATE NONCLUSTERED INDEX IND_101
				--ON [dbo].[#View_CustomerUserAddDetail] ([userId],[AspNetuserId])

				SET @SQL = '			
						
					create table #AccountDetail
					(
						UserId int,AspNetuserId nvarchar(200),UserName nvarchar(200),FirstName nvarchar(200),MiddleName nvarchar(200),LastName nvarchar(200),
						PhoneNumber nvarchar(100),Email nvarchar(100),EmailOptIn bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,
						RoleId varchar(200),RoleName varchar(200),IsActive bit,IsLock bit,FullName  varchar(1000),AccountName  varchar(200),PermissionsName  varchar(200),
						DepartmentName  varchar(200),DepartmentId int,AccountId int,AccountPermissionAccessId int, ExternalId  varchar(200),BudgetAmount numeric(10,6),
						AccountUserOrderApprovalId int,ApprovalName varchar(200),ApprovalUserId int,PermissionCode varchar(500),CustomerPaymentGUID varchar(500),
						StoreName varchar(200),PortalId int,CountryName varchar(200), CityName varchar(200), StateName varchar(200), PostalCode varchar(200), CompanyName varchar(200)
						,SalesRepUserName varchar(200),SalesRepFullName varchar(200) ,RowId int identity , AccountCode nvarchar(100)
					) 
					'+
					+' insert into #AccountDetail(UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
					EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,FullName,
					AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
					BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode,CustomerPaymentGUID
					,StoreName,PortalId, CountryName, CityName, StateName, PostalCode, CompanyName, AccountCode)
					SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
					EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,FullName,
					AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
					BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode,CustomerPaymentGUID 
					,StoreName,PortalId, CountryName, CityName, StateName, PostalCode, CompanyName, AccountCode
					FROM #View_CustomerUserAddDetail where 1=1'+
					dbo.Fn_GetWhereClause(@WhereClauseGlobal+case when @WhereClauseGlobal<>'' and @WhereClause1 <> '' then ' And '+@WhereClause1 else @WhereClause1 end, ' AND ')+
					dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC') + '
			
					Insert Into #TBL_RowCount Values(@@RowCount)
					INSERT INTO #CustomerUserAddDetail		
					SELECT  UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
					EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,FullName,
					AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
					BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode ,CustomerPaymentGUID,StoreName,PortalId,
					CountryName, CityName, StateName, PostalCode, CompanyName, SalesRepUserName, SalesRepFullName, AccountCode
					,Row_Number()Over('+dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC')+')  RowNumber
					
					FROM #AccountDetail '+@PaginationWhereClause  +' '+ dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC');

				EXEC (@SQL)
				
				Select @RowCount= isnull(RowsCount  ,0) from #TBL_RowCount

				ALTER TABLE #CustomerUserAddDetail ADD AddressId Int
				--To get data for DepartmentId
				update CUD SET DepartmentId = i.DepartmentId
				from #CustomerUserAddDetail cud
				INNER JOIN ZnodeDepartmentUser i ON(i.UserId = cud.UserId)

				--To get data for PermissionsName
				update CUD SET PermissionsName = h.PermissionsName, PermissionCode = h.PermissionCode
				from #CustomerUserAddDetail cud
				INNER JOIN ZnodeAccountUserPermission f ON(f.UserId = cud.UserId)
				INNER JOIN ZnodeAccountPermissionAccess g ON(g.AccountPermissionAccessId = f.AccountPermissionAccessId)
				INNER JOIN ZnodeAccessPermission h ON(h.AccessPermissionId = g.AccessPermissionId)

				------To get data for DepartmentName
				update CUD SET DepartmentName = j.DepartmentName
				from #CustomerUserAddDetail cud
				INNER JOIN ZnodeDepartmentUser i ON(i.UserId = cud.UserId)
				INNER JOIN ZnodeDepartment j ON(j.DepartmentId = i.DepartmentId)

				--To get data for AccountPermissionAccessId
				update CUD SET AccountPermissionAccessId = f.AccountPermissionAccessId
				from #CustomerUserAddDetail cud
				INNER JOIN ZnodeAccountUserPermission f ON(f.UserId = cud.UserId)

				--To get data for AccountPermissionAccessId
				update CUD SET AccountPermissionAccessId = f.AccountPermissionAccessId
				from #CustomerUserAddDetail cud
				INNER JOIN ZnodeAccountUserPermission f ON(f.UserId = cud.UserId)
	
				--To get data for AccountUserOrderApprovalId
				update CUD SET AccountUserOrderApprovalId = ZAUOA.AccountUserOrderApprovalId
				from #CustomerUserAddDetail cud
				INNER JOIN ZnodeAccountUserOrderApproval ZAUOA ON cud.UserId = ZAUOA.UserID
	
				--To get data for ApprovalName,ApprovalUserId
				update CUD SET ApprovalName = ISNULL(RTRIM(LTRIM(ZU.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '')
				+CASE
				WHEN ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '') = ''
				THEN ''
				ELSE ' '
				END,
				ApprovalUserId = ZAUOA.ApprovalUserId
				from #CustomerUserAddDetail cud
				INNER JOIN ZnodeAccountUserOrderApproval ZAUOA ON cud.UserId = ZAUOA.UserID
				INNER JOIN ZnodeUser ZU ON(ZU.UserId = ZAUOA.ApprovalUserId)
	
				----To get data for PortalId
				--update CUD SET PortalId = CASE
				--								WHEN cud.AccountId IS NULL
				--								THEN up.PortalId
				--								ELSE ZPA.PortalId
				--							END 
				--from #CustomerUserAddDetail cud
				--   LEFT JOIN ZnodeUserPortal up ON(up.UserId = cud.UserId) 
				--LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = cud.AccountId) 
	
				----To get data for CountryName, CityName, StateName, PostalCode, CompanyName
				IF (EXISTS(SELECT * FROM @ColumnName where ([StringColumn] LIKE '%CountryName%' OR [StringColumn] LIKE '%CityName%' OR [StringColumn] LIKE '%StateName%' OR [StringColumn] LIKE '%PostalCode%' OR [StringColumn] LIKE '%CompanyName%'))
				OR (@WhereClauseAll like '%CountryName%' OR @WhereClauseAll like '%CityName%' OR @WhereClauseAll like '%StateName%' OR @WhereClauseAll like '%PostalCode%' OR @WhereClauseAll like '%CompanyName%'))
				BEGIN
			 
					update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
					PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName, a.AddressId = ZA.AddressId
					from #CustomerUserAddDetail a
					inner join ZnodeAccountAddress ZAA on a.AccountId = ZAA.AccountId
					inner  JOIN ZnodeAddress ZA on ZA.AddressId = ZAA.AddressId
					where isnull(a.AccountId,0)<> 0-- is not null
	 
					update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
					PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName, a.AddressId = ZA.AddressId
					from #CustomerUserAddDetail a
					inner join ZnodeUserAddress ZUA on a.UserId = ZUA.UserId
					inner  JOIN ZnodeAddress ZA on ZA.AddressId = zua.AddressId
				END

				----Updating SalesRep for user if any 
				update CUAD
				set CUAD.SalesRepUserName = azu.UserName, 
				CUAD.SalesRepFullName = (ISNULL(RTRIM(LTRIM(ZU.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '')
				+CASE
				WHEN ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '') = ''
				THEN ''
				ELSE ' '
				END+ISNULL(RTRIM(LTRIM(ZU.LastName)), '')) 
				from #CustomerUserAddDetail CUAD
				inner join ZnodeSalesRepCustomerUserPortal SRCUP ON CUAD.UserId = SRCUP.CustomerUserid 
				inner join ZnodeUser ZU ON SRCUP.SalesRepUserId = ZU.UserId
				inner join ASPNetUsers ANU ON(ZU.AspNetuserId = ANU.Id)
				inner join AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = ANU.UserName)

				if ( exists(select * from #UserList) OR @AddressColumnWhereClause <> '')
				begin
					SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
					EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,
					Isnull(FirstName,'') +  ' ' + ISnull(LastName,'')  FullName,
					AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
					BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode ,CustomerPaymentGUID,StoreName,PortalId,
					CountryName, CityName, StateName, PostalCode, CompanyName, SalesRepUserName, SalesRepFullName, AccountCode
					from #CustomerUserAddDetail CUAD
					where exists(select * from #UserList UL where CUAD.UserId = UL.UserId and CUAD.AddressId = UL.AddressID )
					Order by RowNumber
				end
				else
				begin
					SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
					EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,
					Isnull(FirstName,'') +  ' ' + ISnull(LastName,'')  FullName,
					AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
					BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode ,CustomerPaymentGUID,StoreName,PortalId,
					CountryName, CityName, StateName, PostalCode, CompanyName, SalesRepUserName, SalesRepFullName, AccountCode
					from #CustomerUserAddDetail
					Order by RowNumber
				end

	                if OBJECT_ID('tempdb..#CustomerUserAddDetail') is not null
					drop table #CustomerUserAddDetail

					if OBJECT_ID('tempdb..#View_CustomerUserAddDetail') is not null
					drop table #View_CustomerUserAddDetail

				    if OBJECT_ID('tempdb..#UserList') is not null
					drop table #UserList 
				
			END;
			ELSE
			BEGIN
				SELECT * FROM View_CustomerUserDetail AS VICUD WHERE 1 = 0;
				SET @RowCount = 0;
			END;
		END;			
    END TRY
    BEGIN CATCH
		DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_AdminUsersByUserId @RoleName = '+@RoleName+' ,@UserName='+@UserName+',@WhereClause='+cast(@WhereClause as varchar(max))+' ,@Rows= '+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_By='+@Order_By+',@RowCount='+CAST(@RowCount AS VARCHAR(50));
		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName    = 'Znode_AdminUsersByUserId',
		@ErrorInProcedure = @ERROR_PROCEDURE,
		@ErrorMessage     = @ErrorMessage,
		@ErrorLine        = @ErrorLine,
		@ErrorCall        = @ErrorCall;
    END CATCH;
END;

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'AvataxIsSellerImporterOfRecord' AND Object_ID = Object_ID(N'dbo.ZnodeOmsTaxRule'))
BEGIN
	ALTER TABLE ZnodeOmsTaxRule ADD AvataxIsSellerImporterOfRecord Bit NULL;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertOrderTaxDetails')
	DROP PROC Znode_InsertOrderTaxDetails
GO

CREATE PROCEDURE [dbo].[Znode_InsertOrderTaxDetails]
(
	@OmsOrderId INT,
	@TaxRuleId INT,
	@TaxRate    DECIMAL(18, 5),
	@AvataxIsSellerImporterOfRecord bit,
	@status     BIT OUT
)
AS
/* Summary :- This Procedure is used to insert the  TaxRule Data
     Unit Testing
   EXEC [Znode_InsertOrderTaxDetails] @OmsOrderId = 1467, @TaxRuleId = 10
*/
BEGIN
	SET NOCOUNT ON;

	BEGIN TRAN
	BEGIN TRY
		DECLARE @GetDate DATETIME = dbo.Fn_GetDate();

--------Insert TaxRule Data
		if(NOT EXISTS(SELECT 1 from ZnodeOmsTaxRule where OmsOrderId= @OmsOrderId))
		BEGIN
			INSERT INTO ZnodeOmsTaxRule
			(
			OmsOrderId,TaxRuleId,TaxRuleTypeId,TaxClassId,DestinationCountryCode,DestinationStateCode,CountyFIPS,Precedence,
			SalesTax,VAT,GST,PST,HST,TaxShipping,Custom1,Custom2,Custom3,ExternalID,ZipCode,CreatedBy,CreatedDate,ModifiedBy,
			ModifiedDate,AvataxIsSellerImporterOfRecord
			)
		--OUTPUT INSERTED.OmsOrderId INTO @ZnodeOmsTaxRule
			SELECT
			@OmsOrderId,TaxRuleId,TaxRuleTypeId,TaxClassId,DestinationCountryCode,DestinationStateCode,CountyFIPS,Precedence,
			(CASE When @TaxRate > 0 then @TaxRate ELSE SalesTax END) AS SalesTax,VAT,GST,PST,HST,TaxShipping,Custom1,Custom2,Custom3,
			ExternalID,ZipCode,CreatedBy,@GetDate,ModifiedBy,@GetDate,@AvataxIsSellerImporterOfRecord
			FROM ZnodeTaxRule
			WHERE TaxRuleId = @TaxRuleId
		END
		SET @status = 1;
	COMMIT TRAN
	END TRY
    BEGIN CATCH
       --DECLARE @Status BIT ;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertOrderTaxDetails @OmsOrderId = '+CAST(@OmsOrderId AS VARCHAR(10))+',@TaxRuleId='+CAST(@TaxRuleId AS VARCHAR(50))
             
        --SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		ROLLBACK TRAN
        EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_InsertOrderTaxDetails',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
    END CATCH;
END


GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateOmsOrder')
	DROP PROC Znode_InsertUpdateOmsOrder
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateOmsOrder]
(
	@OrderXML XML,
	@UserId INT
)
AS
BEGIN
SET NOCOUNT ON;
BEGIN TRY

	DECLARE @GetDate DATETIME = GETDATE()
	DECLARE @OMSOrder TABLE(OmsOrderId INT,OrderNumber VARCHAR(200))
	DECLARE @OMSOrderDetail TABLE(OmsOrderId INT,OmsOrderDetailsId INT)
	DECLARE @OmsOrderLineItems TABLE(RowId INT IDENTITY(1,1),OmsOrderDetailsId INT,OmsOrderLineItemsId INT, Sku VARCHAR(600), ParentOmsOrderLineItemsId INT, GroupId NVARCHAR(MAX),OrderLineItemRelationshipTypeId INT,ParentSku VARCHAR(600), GroupIdentifier INT)
	DECLARE @OmsParentOrderLineItems TABLE(RowId INT IDENTITY(1,1),OmsOrderDetailsId INT,OmsOrderLineItemsId INT, Sku VARCHAR(600), ParentOmsOrderLineItemsId INT, GroupId NVARCHAR(MAX), OrderLineItemRelationshipTypeId INT, GroupIdentifier INT)

	DECLARE @OrderLineItemRelationshipTypeIdAddon int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'AddOns'
	);

	DECLARE @OrderLineItemRelationshipTypeIdSimple int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Simple'
	);

	DECLARE @OrderLineItemRelationshipTypeIdBundles int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Bundles'
	);

	DECLARE @OrderLineItemRelationshipTypeIdGroup int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Group'
	);

	DECLARE @OrderLineItemRelationshipTypeIdConfig int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Configurable'
	);


	CREATE TABLE #TempOrderData
	(
		RowId INT IDENTITY(1,1),OrderNumber VARCHAR(200), PublishStateId INT,OmsOrderId INT,OmsOrderStateId INT,
		DiscountAmount NUMERIC(28,6),SalesTax NUMERIC(28,6),TaxRate NUMERIC(28,6),IsOldOrder BIT,VAT NUMERIC(28,6),GST NUMERIC(28,6),
		PST NUMERIC(28,6),HST NUMERIC(28,6),Total NUMERIC(28,6),BillingAddressId INT,ShippingAddressId INT,ShippingId INT,
		PortalId INT,ShippingNumber NVARCHAR(max),TrackingNumber NVARCHAR(1000),CouponCode NVARCHAR(1000),
		PromoDescription NVARCHAR(max),ReferralUserId int,PurchaseOrderNumber NVARCHAR(1000),OmsPaymentStateId int,
		WebServiceDownloadDate datetime,PaymentSettingId int,PaymentTransactionToken NVARCHAR(600),ShipDate datetime,ReturnDate datetime,
		AddressId int,PoDocument NVARCHAR(600),IsActive bit,ExternalId NVARCHAR(1000),PaymentTypeId INT,CreatedBy INT,CreatedDate datetime,ModifiedBy INT,
		ModifiedDate datetime,CreditCardNumber VARCHAR(4),IsShippingCostEdited bit,IsTaxCostEdited bit,ShippingDifference NUMERIC(28,6),
		EstimateShippingCost NUMERIC(28,6),TransactionId NVARCHAR(800),Custom1 NVARCHAR(MAX),Custom2 NVARCHAR(MAX),Custom3 NVARCHAR(MAX),
		Custom4 NVARCHAR(MAX),Custom5 NVARCHAR(MAX),FirstName NVARCHAR(200),LastName NVARCHAR(200),CardType VARCHAR(50),CreditCardExpMonth INT,
		CreditCardExpYear INT,TotalAdditionalCost NUMERIC(28,6),PaymentDisplayName NVARCHAR(2000),PaymentExternalId NVARCHAR(2000),
		CultureCode VARCHAR(200),DisplayName NVARCHAR(2000),InHandDate datetime,IpAddress VARCHAR(100),JobName NVARCHAR(200),
		ShippingConstraintCode NVARCHAR(100),ShippingDiscount NUMERIC(28,6),ShippingHandlingCharges NUMERIC(28,6),ReturnCharges NUMERIC(28,6),
		IsCalculateTaxAfterDiscount bit,Email VARCHAR(50),PhoneNumber VARCHAR(50),OrderTotalWithoutVoucher NUMERIC(28,6),ImportDuty NUMERIC(28,6),
		TaxCost NUMERIC(28,6),ShippingCost NUMERIC(28,6), SubTotal NUMERIC(28,6),CurrencyCode VARCHAR(100),OverDueAmount NUMERIC(28,6), ShippingTypeId INT,
		AccountNumber NVARCHAR(4000),ShippingMethod NVARCHAR(4000),PaymentCode NVARCHAR(400) ,PaymentStatusId Int, RemainingOrderAmount NUMERIC(28,6),AvataxIsSellerImporterOfRecord bit
	)

	CREATE TABLE #TempOrderBillingAddress
	(
		AddressId INT,BillingFirstName VARCHAR(300),BillingLastName VARCHAR(300),BillingCountry VARCHAR(3000),BillingStateCode VARCHAR(300),
		BillingPostalCode VARCHAR(50),BillingPhoneNumber VARCHAR(50),BillingEmailId VARCHAR(50),BillingStreet1 VARCHAR(300),BillingStreet2 VARCHAR(300),
		BillingCity VARCHAR(3000),BillingCompanyName NVARCHAR(1200)
	)
	
	CREATE TABLE #TempParentLineItemDetails
	(
		RowId INT IDENTITY(1,1),OrderLineItemRelationshipTypeId INT,OmsOrderDetailsId INT,OmsOrderShipmentId INT,RmaReasonForReturnId INT,Sku NVARCHAR(600),ProductName NVARCHAR(1000),
		Description NVARCHAR(max),Quantity NUMERIC(28,6),Price NUMERIC(28,6),Weight NUMERIC(28,6),DownloadLink NVARCHAR(max),DiscountAmount NUMERIC(28,6),
		ShipSeparately bit,ShipDate datetime,ReturnDate datetime,ShippingCost NUMERIC(28,6),PromoDescription NVARCHAR(max),TransactionNumber NVARCHAR(max),
		PaymentStatusId int,TrackingNumber NVARCHAR(max),IsAutoGeneratedTracking bit,OrderLineItemStateId int,IsRecurringBilling bit,RecurringBillingPeriod NVARCHAR(100),
		RecurringBillingCycles int,RecurringBillingFrequency NVARCHAR(100),RecurringBillingAmount NUMERIC(28,6),AppliedPromo NVARCHAR(max),CouponsApplied NVARCHAR(100),
		ExternalId NVARCHAR(1000),IsActive bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,AutoAddonSKU NVARCHAR(max),IsShippingReturn bit,
		PartialRefundAmount NUMERIC(28,6),Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),Custom4 NVARCHAR(max),Custom5 NVARCHAR(max),
		GroupId NVARCHAR(max),BundleQuantity int, TaxRuleId INT,TaxTransactionNumber NVARCHAR(1200),Comments NVARCHAR(MAX),SalesTax NUMERIC(28,6),VAT NUMERIC(28,6),
		GST NUMERIC(28,6),PST NUMERIC(28,6),HST NUMERIC(28,6),ImportDuty NUMERIC(28,6), GroupIdentifier INT
	)

	CREATE TABLE #TempChildLineItemDetails
	(
		RowId INT IDENTITY(1,1),OrderLineItemRelationshipTypeId INT,OmsOrderDetailsId INT,OmsOrderShipmentId INT,RmaReasonForReturnId INT,Sku NVARCHAR(600),ProductName NVARCHAR(1000),
		Description NVARCHAR(max),Quantity NUMERIC(28,6),Price NUMERIC(28,6),Weight NUMERIC(28,6),DownloadLink NVARCHAR(max),DiscountAmount NUMERIC(28,6),
		ShipSeparately bit,ShipDate datetime,ReturnDate datetime,ShippingCost NUMERIC(28,6),PromoDescription NVARCHAR(max),TransactionNumber NVARCHAR(max),
		PaymentStatusId int,TrackingNumber NVARCHAR(max),IsAutoGeneratedTracking bit,OrderLineItemStateId int,IsRecurringBilling bit,RecurringBillingPeriod NVARCHAR(100),
		RecurringBillingCycles int,RecurringBillingFrequency NVARCHAR(100),RecurringBillingAmount NUMERIC(28,6),AppliedPromo NVARCHAR(max),CouponsApplied NVARCHAR(100),
		ExternalId NVARCHAR(1000),IsActive bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,AutoAddonSKU NVARCHAR(max),IsShippingReturn bit,
		PartialRefundAmount NUMERIC(28,6),Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),Custom4 NVARCHAR(max),Custom5 NVARCHAR(max),
		GroupId NVARCHAR(max),BundleQuantity int, TaxRuleId INT,TaxTransactionNumber NVARCHAR(1200),Comments NVARCHAR(MAX),SalesTax NUMERIC(28,6),VAT NUMERIC(28,6),
		GST NUMERIC(28,6),PST NUMERIC(28,6),HST NUMERIC(28,6),ImportDuty NUMERIC(28,6), ParentSku NVARCHAR(600), GroupIdentifier INT
	)

	CREATE TABLE #TempOrderAttribute
	(
		AttributeCode NVARCHAR(1000),AttributeValue NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,
		ModifiedDate DATETIME,AttributeValueCode NVARCHAR(1000), Sku VARCHAR(600), GroupId NVARCHAR(max), GroupIdentifier INT
	)

	CREATE TABLE #OmsPersonalizeItem
	(
		PersonalizeCode NVARCHAR(400),PersonalizeValue NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,
		ModifiedDate DATETIME,DesignId NVARCHAR(4000),ThumbnailURL NVARCHAR(MAX), Sku VARCHAR(600), GroupId NVARCHAR(max),
		GroupIdentifier INT
	)

	CREATE TABLE #OmsOrderDiscount
	(
		OmsDiscountTypeId INT,DiscountCode VARCHAR(300),DiscountAmount NUMERIC(28,6),Description NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,
		ModifiedBy INT,ModifiedDate DATETIME,PerQuantityDiscount NUMERIC(28,6),DiscountMultiplier NUMERIC(28,6),ParentOmsOrderLineItemsId INT,
		DiscountLevelTypeId INT,PromotionName NVARCHAR(1200),PromotionTypeId INT,DiscountAppliedSequence INT,PromotionMessage NVARCHAR(MAX),Sku VARCHAR(600),
		GroupId NVARCHAR(max)
	)

	--------Getting Order details
	INSERT INTO #TempOrderData
	(
		OrderNumber, PublishStateId ,OmsOrderId ,OmsOrderStateId ,DiscountAmount ,SalesTax ,TaxRate ,IsOldOrder ,
		VAT ,GST ,PST ,HST ,Total ,BillingAddressId ,ShippingAddressId ,ShippingId ,PortalId,
		ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
		,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive
		,ExternalId,PaymentTypeId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
		,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName
		,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
		,DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
		,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty,TaxCost,ShippingCost, SubTotal,
		CurrencyCode,OverDueAmount, ShippingTypeId, AccountNumber, ShippingMethod, PaymentCode, PaymentStatusId,RemainingOrderAmount,AvataxIsSellerImporterOfRecord
	)
	SELECT
		CASE WHEN Tbl.Col.value( 'OrderNumber[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderNumber[1]', 'NVARCHAR(Max)' ) END  AS OrderNumber,
		CASE WHEN Tbl.Col.value( 'PublishStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PublishStateId[1]', 'NVARCHAR(Max)' ) END AS PublishStateId,
		CASE WHEN Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderId,
		CASE WHEN Tbl.Col.value( 'OmsOrderStateId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderStateId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderStateId,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE  Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
		CASE WHEN Tbl.Col.value( 'TaxRate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TaxRate[1]', 'NVARCHAR(Max)' ) END AS TaxRate,
		CASE WHEN Tbl.Col.value('IsOldOrder[1]', 'NVARCHAR(2000)') = '' THEN NULL ELSE Tbl.Col.value('IsOldOrder[1]', 'NVARCHAR(2000)') END AS IsOldOrder,
		CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE  Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
		CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
		CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END  AS PST,
		CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END AS HST,
		CASE WHEN Tbl.Col.value( 'Total[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Total[1]', 'NVARCHAR(Max)' ) END AS Total,
		CASE WHEN Tbl.Col.value( 'BillingAddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'BillingAddressId[1]', 'NVARCHAR(Max)' ) END AS BillingAddressId,
		CASE WHEN Tbl.Col.value( 'ShippingAddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingAddressId[1]', 'NVARCHAR(Max)' ) END AS ShippingAddressId,
		CASE WHEN (Tbl.Col.value( 'ShippingId[1]', 'NVARCHAR(Max)' )) = '' THEN NULL ELSE (Tbl.Col.value( 'ShippingId[1]', 'NVARCHAR(Max)' )) END  AS ShippingId,
		CASE WHEN Tbl.Col.value( 'PortalId[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'PortalId[1]', 'NVARCHAR(Max)' ) END AS PortalId,
		Tbl.Col.value( 'ShippingNumber[1]', 'NVARCHAR(Max)' ) AS ShippingNumber,
		Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
		Tbl.Col.value( 'CouponCode[1]', 'NVARCHAR(Max)' ) AS CouponCode,
		Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
		CASE WHEN Tbl.Col.value( 'ReferralUserId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReferralUserId[1]', 'NVARCHAR(Max)' ) END  AS ReferralUserId,
		Tbl.Col.value( 'PurchaseOrderNumber[1]', 'NVARCHAR(Max)' ) AS PurchaseOrderNumber,
		CASE WHEN Tbl.Col.value( 'OmsPaymentStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsPaymentStateId[1]', 'NVARCHAR(Max)' ) END AS OmsPaymentStateId,
		Tbl.Col.value( 'WebServiceDownloadDate[1]', 'NVARCHAR(Max)' ) AS WebServiceDownloadDate,
		CASE WHEN Tbl.Col.value( 'PaymentSettingId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentSettingId[1]', 'NVARCHAR(Max)' ) END AS PaymentSettingId,
		Tbl.Col.value( 'PaymentTransactionToken[1]', 'NVARCHAR(Max)' ) AS PaymentTransactionToken,
		CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE @GetDate END AS ShipDate,
		CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
		CASE WHEN Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) END AS AddressId,
		Tbl.Col.value( 'PoDocument[1]', 'NVARCHAR(Max)' ) AS PoDocument,
		CASE WHEN Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) END  AS IsActive,
		Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
		CASE WHEN Tbl.Col.value( 'PaymentTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentTypeId[1]', 'NVARCHAR(Max)' ) END  AS PaymentTypeId,
		@UserId AS CreatedBy,
		@GetDate AS CreatedDate,
		@UserId AS ModifiedBy,
		@GetDate AS ModifiedDate,
		Tbl.Col.value( 'CreditCardNumber[1]', 'NVARCHAR(Max)' ) AS CreditCardNumber,
		CASE WHEN Tbl.Col.value( 'IsShippingCostEdited[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsShippingCostEdited[1]', 'NVARCHAR(Max)' ) END AS IsShippingCostEdited,
		CASE WHEN Tbl.Col.value( 'IsTaxCostEdited[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsTaxCostEdited[1]', 'NVARCHAR(Max)' ) END AS IsTaxCostEdited,
		Tbl.Col.value( 'ShippingDifference[1]', 'NVARCHAR(Max)' ) AS ShippingDifference,
		CASE WHEN Tbl.Col.value( 'EstimateShippingCost[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'EstimateShippingCost[1]', 'NVARCHAR(Max)' ) END AS EstimateShippingCost,
		Tbl.Col.value( 'TransactionId[1]', 'NVARCHAR(Max)' ) AS TransactionId,
		Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
		Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
		Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
		Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
		Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
		Tbl.Col.value( 'FirstName[1]', 'NVARCHAR(Max)' ) AS FirstName,
		Tbl.Col.value( 'LastName[1]', 'NVARCHAR(Max)' ) AS LastName,
		Tbl.Col.value( 'CardType[1]', 'NVARCHAR(Max)' ) AS CardType,
		Tbl.Col.value( 'CreditCardExpMonth[1]', 'NVARCHAR(Max)' ) AS CreditCardExpMonth,
		Tbl.Col.value( 'CreditCardExpYear[1]', 'NVARCHAR(Max)' ) AS CreditCardExpYear,
		CASE WHEN Tbl.Col.value( 'TotalAdditionalCost[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TotalAdditionalCost[1]', 'NVARCHAR(Max)' ) END AS TotalAdditionalCost,
		Tbl.Col.value( 'PaymentDisplayName[1]', 'NVARCHAR(Max)' ) AS PaymentDisplayName,
		Tbl.Col.value( 'PaymentExternalId[1]', 'NVARCHAR(Max)' ) AS PaymentExternalId,
		Tbl.Col.value( 'CultureCode[1]', 'NVARCHAR(Max)' ) AS CultureCode,
		Tbl.Col.value( 'DisplayName[1]', 'NVARCHAR(Max)' ) AS DisplayName,
		Tbl.Col.value( 'InHandDate[1]', 'NVARCHAR(Max)' ) AS InHandDate,
		Tbl.Col.value( 'IpAddress[1]', 'NVARCHAR(Max)' ) AS IpAddress,
		Tbl.Col.value( 'JobName[1]', 'NVARCHAR(Max)' ) AS JobName,
		Tbl.Col.value( 'ShippingConstraintCode[1]', 'NVARCHAR(Max)' ) AS ShippingConstraintCode,
		Tbl.Col.value( 'ShippingDiscount[1]', 'NVARCHAR(Max)' ) AS ShippingDiscount,
		Tbl.Col.value( 'ShippingHandlingCharges[1]', 'NVARCHAR(Max)' ) AS ShippingHandlingCharges,
		CASE WHEN Tbl.Col.value( 'ReturnCharges[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'ReturnCharges[1]', 'NVARCHAR(Max)' ) END AS ReturnCharges,
		CASE WHEN Tbl.Col.value( 'IsCalculateTaxAfterDiscount[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsCalculateTaxAfterDiscount[1]', 'NVARCHAR(Max)' ) END AS IsCalculateTaxAfterDiscount,
		Tbl.Col.value( 'Email[1]', 'NVARCHAR(Max)' ) AS Email,
		Tbl.Col.value( 'PhoneNumber[1]', 'NVARCHAR(Max)' ) AS PhoneNumber,
		CASE WHEN Tbl.Col.value( 'OrderTotalWithoutVoucher[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OrderTotalWithoutVoucher[1]', 'NVARCHAR(Max)' )  END AS OrderTotalWithoutVoucher,
		CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )='' THEN '' ELSE Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
		CASE WHEN Tbl.Col.value( 'TaxCost[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'TaxCost[1]', 'NVARCHAR(Max)' ) END  AS TaxCost,
		CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
		CASE WHEN Tbl.Col.value( 'SubTotal[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'SubTotal[1]', 'NVARCHAR(Max)' ) END AS SubTotal,
		Tbl.Col.value( 'CurrencyCode[1]', 'NVARCHAR(Max)' ) AS CurrencyCode,
		CASE WHEN Tbl.Col.value( 'OverDueAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OverDueAmount[1]', 'NVARCHAR(Max)' ) END AS OverDueAmount,
		CASE WHEN Tbl.Col.value( 'ShippingTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingTypeId[1]', 'NVARCHAR(Max)' ) END AS ShippingTypeId,
		Tbl.Col.value( 'AccountNumber[1]', 'NVARCHAR(Max)' ) AS AccountNumber,
		Tbl.Col.value( 'ShippingMethod[1]', 'NVARCHAR(Max)' ) AS ShippingMethod,
		Tbl.Col.value( 'PaymentCode[1]', 'NVARCHAR(Max)' ) AS PaymentCode,
		CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId,
		CASE WHEN Tbl.Col.value( 'RemainingOrderAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'RemainingOrderAmount[1]', 'NVARCHAR(Max)' ) END AS RemainingOrderAmount,
		CASE WHEN Tbl.Col.value( 'AvataxIsSellerImporterOfRecord[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'AvataxIsSellerImporterOfRecord[1]', 'NVARCHAR(Max)' ) END AS AvataxIsSellerImporterOfRecord
	FROM @OrderXML.nodes( '//PlaceOrderModel' ) AS Tbl(Col);


	--Getting billing address info
	INSERT INTO #TempOrderBillingAddress
	(
		AddressId,BillingFirstName,BillingLastName,BillingCompanyName,BillingStreet1,BillingStreet2,
		BillingCity,BillingStateCode,BillingPostalCode,BillingCountry,BillingPhoneNumber,BillingEmailId
	)
	SELECT
		Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) AS AddressId,
		Tbl.Col.value( 'FirstName[1]', 'NVARCHAR(Max)' ) AS FirstName,
		Tbl.Col.value( 'LastName[1]', 'NVARCHAR(Max)' ) AS LastName,
		Tbl.Col.value( 'CompanyName[1]', 'NVARCHAR(Max)' ) AS CompanyName,
		Tbl.Col.value( 'Street1[1]', 'NVARCHAR(Max)' ) AS Street1 ,
		Tbl.Col.value( 'Street2[1]', 'NVARCHAR(Max)' ) AS Street2,
		Tbl.Col.value( 'City[1]', 'NVARCHAR(Max)' ) AS City,
		Tbl.Col.value( 'StateCode[1]', 'NVARCHAR(Max)' ) AS StateCode,
		Tbl.Col.value( 'PostalCode[1]', 'NVARCHAR(Max)' ) AS PostalCode,
		Tbl.Col.value( 'Country[1]', 'NVARCHAR(Max)' ) AS Country,
		Tbl.Col.value( 'PhoneNumber[1]', 'NVARCHAR(Max)' ) AS PhoneNumber,
		Tbl.Col.value( 'EmailId[1]', 'NVARCHAR(Max)' ) AS EmailId
	FROM @OrderXML.nodes( '//PlaceOrderModel/BillingAddressModel' ) AS Tbl(Col);
	----Parent line item details insert
	INSERT INTO #TempParentLineItemDetails
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description,Quantity,
		Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber,
		PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles,
		RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy,
		ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity,
		TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty, GroupIdentifier
	)
	SELECT
		CASE WHEN Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemRelationshipTypeId,
		CASE WHEN Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) END  AS OmsOrderDetailsId,
		CASE WHEN Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderShipmentId,
		CASE WHEN Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) END AS RmaReasonForReturnId,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(2000)' ) AS ProductName,
		Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
		Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(Max)' ) AS Quantity,
		CASE WHEN Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) END AS Price,
		Tbl.Col.value( 'Weight[1]', 'NVARCHAR(Max)' ) AS Weight,
		Tbl.Col.value( 'DownloadLink[1]', 'NVARCHAR(Max)' ) AS DownloadLink,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		Tbl.Col.value( 'ShipSeparately[1]', 'NVARCHAR(Max)' ) AS ShipSeparately,
		CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE @GetDate END AS ShipDate,
		CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
		CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
		Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
		Tbl.Col.value( 'TransactionNumber[1]', 'NVARCHAR(Max)' ) AS TransactionNumber,
		CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId,
		Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
		CASE WHEN Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) END AS IsAutoGeneratedTracking,
		CASE WHEN Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemStateId,
		CASE WHEN Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) END AS IsRecurringBilling,
		Tbl.Col.value( 'RecurringBillingPeriod[1]', 'NVARCHAR(Max)' ) AS RecurringBillingPeriod,
		Tbl.Col.value( 'RecurringBillingCycles[1]', 'NVARCHAR(Max)' ) AS RecurringBillingCycles,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingFrequency,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingAmount,
		Tbl.Col.value( 'AppliedPromo[1]', 'NVARCHAR(Max)' ) AS AppliedPromo,
		Tbl.Col.value( 'CouponsApplied[1]', 'NVARCHAR(Max)' ) AS CouponsApplied,
		Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
		CASE WHEN Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) END AS IsActive,
		@UserId AS CreatedBy,
		@GetDate AS CreatedDate,
		@UserId AS ModifiedBy,
		@GetDate AS ModifiedDate,
		Tbl.Col.value( 'AutoAddonSKU[1]', 'NVARCHAR(Max)' ) AutoAddonSKU,
		CASE WHEN Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) END IsShippingReturn,
		CASE WHEN Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) END PartialRefundAmount,
		Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
		Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
		Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
		Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
		Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
		CASE WHEN Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) = ''  THEN NULL ELSE Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) END AS BundleQuantity,
		CASE WHEN Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) END AS TaxRuleId,
		Tbl.Col.value( 'TaxTransactionNumber[1]', 'NVARCHAR(Max)' ) AS TaxTransactionNumber,
		Tbl.Col.value( 'Comments[1]', 'NVARCHAR(Max)' ) AS Comments,
		CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
		CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
		CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
		CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END AS PST,
		CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END  AS HST,
		CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(Max)' ) AS GroupIdentifier
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel' ) AS Tbl(Col);

	----Child line item details insert
	INSERT INTO #TempChildLineItemDetails
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description,Quantity,
		Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber,
		PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles,
		RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy,
		ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity,
		TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty, ParentSku, GroupIdentifier
	)
	SELECT
		CASE WHEN Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemRelationshipTypeId,
		CASE WHEN Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderDetailsId,
		CASE WHEN Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderShipmentId,
		CASE WHEN Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) END AS RmaReasonForReturnId,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(2000)' ) AS ProductName,
		Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
		Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(Max)' ) AS Quantity,
		CASE WHEN Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) END AS Price,
		Tbl.Col.value( 'Weight[1]', 'NVARCHAR(Max)' ) AS Weight,
		Tbl.Col.value( 'DownloadLink[1]', 'NVARCHAR(Max)' ) AS DownloadLink,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		Tbl.Col.value( 'ShipSeparately[1]', 'NVARCHAR(Max)' ) AS ShipSeparately,
		CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE @GetDate END AS ShipDate,
		CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
		CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
		Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
		Tbl.Col.value( 'TransactionNumber[1]', 'NVARCHAR(Max)' ) AS TransactionNumber,
		CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId,
		Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
		CASE WHEN Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) END AS IsAutoGeneratedTracking,
		CASE WHEN Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemStateId,
		CASE WHEN Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) END AS IsRecurringBilling,
		Tbl.Col.value( 'RecurringBillingPeriod[1]', 'NVARCHAR(Max)' ) AS RecurringBillingPeriod,
		Tbl.Col.value( 'RecurringBillingCycles[1]', 'NVARCHAR(Max)' ) AS RecurringBillingCycles,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingFrequency,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingAmount,
		Tbl.Col.value( 'AppliedPromo[1]', 'NVARCHAR(Max)' ) AS AppliedPromo,
		Tbl.Col.value( 'CouponsApplied[1]', 'NVARCHAR(Max)' ) AS CouponsApplied,
		Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
		Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) AS IsActive,
		@UserId AS CreatedBy,
		@GetDate AS CreatedDate,
		@UserId AS ModifiedBy,
		@GetDate AS ModifiedDate,
		Tbl.Col.value( 'AutoAddonSKU[1]', 'NVARCHAR(Max)' ) AutoAddonSKU,
		CASE WHEN Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) END AS IsShippingReturn,
		CASE WHEN Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) END AS  PartialRefundAmount,
		Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
		Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
		Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
		Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
		Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
		CASE WHEN Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) END AS BundleQuantity,
		CASE WHEN Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) END AS TaxRuleId,
		Tbl.Col.value( 'TaxTransactionNumber[1]', 'NVARCHAR(Max)' ) AS TaxTransactionNumber,
		Tbl.Col.value( 'Comments[1]', 'NVARCHAR(Max)' ) AS Comments,
		CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
		CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
		CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
		CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END AS PST,
		CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END AS HST,
		CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE  Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
		Tbl.Col.value( 'ParentProductSKU[1]', 'NVARCHAR(Max)' ) AS ParentSku,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(Max)' ) AS GroupIdentifier
	FROM @OrderXML.nodes('//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/OrderLineItem/PlaceOrderlineItemCollection') AS Tbl(Col);

	--Updating parent for simple products
	UPDATE #TempChildLineItemDetails SET ParentSku = Sku WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdSimple
	AND OrderLineItemRelationshipTypeId IS NOT NULL

BEGIN TRAN OrderInsert

	--Inserting order number which are unique and getting in xml from code side
	INSERT INTO ZnodeOmsOrder(IsQuoteOrder,OrderNumber,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PublishStateId,IsOldOrder)
	OUTPUT INSERTED.OmsOrderId, INSERTED.OrderNumber INTO @OMSOrder
	SELECT 0 AS IsQuoteOrder, OrderNumber,OrderNumber AS ExternalId,@UserId,@GetDate,@UserId,@GetDate,PublishStateId, CAST(0 AS BIT)
	FROM #TempOrderData
	WHERE ISNULL(OmsOrderId,0) = 0

	--If order is new then creating new order details
	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		INSERT INTO ZnodeOmsOrderDetails
		(
			OmsOrderId,PortalId,UserId,OrderDate,OmsOrderStateId,ShippingId,PaymentTypeId,BillingFirstName,BillingLastName
			,BillingCompanyName,BillingStreet1,BillingStreet2,BillingCity,BillingStateCode,BillingPostalCode,BillingCountry
			,BillingPhoneNumber,BillingEmailId,TaxCost,ShippingCost,SubTotal,DiscountAmount,CurrencyCode,OverDueAmount,Total
			,ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive
			,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
			,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
			,DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
			,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty,RemainingOrderAmount
		)
		OUTPUT INSERTED.OmsOrderId, INSERTED.OmsOrderDetailsId INTO @OMSOrderDetail
		SELECT OO.OmsOrderId, OD.PortalId,@UserId,@GetDate,OD.OmsOrderStateId,OD.ShippingId,OD.PaymentTypeId,OBA.BillingFirstName,OBA.BillingLastName,OBA.BillingCompanyName,
			OBA.BillingStreet1,OBA.BillingStreet2,OBA.BillingCity,OBA.BillingStateCode,OBA.BillingPostalCode,OBA.BillingCountry,OBA.BillingPhoneNumber,OBA.BillingEmailId,OD.TaxCost,
			OD.ShippingCost,OD.SubTotal, OD.DiscountAmount,OD.CurrencyCode,OD.OverDueAmount,OD.Total
			,OD.ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,OD.BillingAddressId,PoDocument,CAST(1 AS BIT) AS IsActive
			,OD.ExternalId,OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
			,ShippingDifference,EstimateShippingCost,TransactionId,OD.Custom1,OD.Custom2,OD.Custom3,OD.Custom4,OD.Custom5,OD.FirstName,OD.LastName
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
			,OD.DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
			,IsCalculateTaxAfterDiscount,Email,OD.PhoneNumber,OrderTotalWithoutVoucher,ImportDuty,OD.RemainingOrderAmount
		FROM #TempOrderData OD
		INNER JOIN @OMSOrder OO ON OD.OrderNumber = OO.OrderNumber
		LEFT JOIN #TempOrderBillingAddress OBA ON OD.BillingAddressId = OBA.AddressId

	END
	--If order managed then creating new order details and disable old order details
	ELSE
	BEGIN
		Declare @OldOmsOrderDetailsId INT
		SET @OldOmsOrderDetailsId = (SELECT TOP 1 OOD.OmsOrderDetailsId FROM ZnodeOmsOrderDetails OOD  WITH (NOLOCK) 
									 WHERE EXISTS(SELECT * FROM  #TempOrderData OD WHERE OOD.OmsOrderId = OD.OmsOrderId) AND OOD.IsActive = 1)

		INSERT INTO ZnodeOmsOrderDetails
		(
			OmsOrderId,PortalId,UserId,OrderDate,OmsOrderStateId,ShippingId,PaymentTypeId,BillingFirstName,BillingLastName --1
			,BillingCompanyName,BillingStreet1,BillingStreet2,BillingCity,BillingStateCode,BillingPostalCode,BillingCountry --2
			,BillingPhoneNumber,BillingEmailId,TaxCost,ShippingCost,SubTotal,DiscountAmount,CurrencyCode,OverDueAmount,Total --3
			,ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId --4
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive --5
			,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited --6
			,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName --7
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName, --8
			PaymentExternalId,CultureCode, --9
			DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges --10
			,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty,RemainingOrderAmount --11 
		)
		OUTPUT INSERTED.OmsOrderId, INSERTED.OmsOrderDetailsId INTO @OMSOrderDetail
		SELECT OO.OmsOrderId, OD.PortalId,@UserId,@GetDate,OD.OmsOrderStateId,OD.ShippingId,OD.PaymentTypeId,OBA.BillingFirstName,OBA.BillingLastName,--1
			OBA.BillingCompanyName,OBA.BillingStreet1,OBA.BillingStreet2,OBA.BillingCity,OBA.BillingStateCode,OBA.BillingPostalCode,OBA.BillingCountry, --2
			OBA.BillingPhoneNumber,OBA.BillingEmailId,OD.TaxCost,OD.ShippingCost,OD.SubTotal, OD.DiscountAmount,OD.CurrencyCode,OD.OverDueAmount,OD.Total, --3
			OD.ShippingNumber,OD.TrackingNumber,OD.CouponCode,OD.PromoDescription,OD.ReferralUserId,OD.PurchaseOrderNumber,OD.OmsPaymentStateId, --4
			OD.WebServiceDownloadDate,OD.PaymentSettingId,OD.PaymentTransactionToken,OD.ShipDate,OD.ReturnDate,OD.BillingAddressId,OD.PoDocument,CAST(1 AS BIT) AS IsActive --5
			,OD.ExternalId,OD.CreatedBy,OOD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.CreditCardNumber,OD.IsShippingCostEdited,OD.IsTaxCostEdited, --6
			OD.ShippingDifference,OD.EstimateShippingCost,OD.TransactionId,OD.Custom1,OD.Custom2,OD.Custom3,OD.Custom4,OD.Custom5,OD.FirstName,OD.LastName, --7
			OD.CardType,OD.CreditCardExpMonth,OD.CreditCardExpYear,OD.TotalAdditionalCost,CASE WHEN OD.PaymentSettingId = OOD.PaymentSettingId THEN OOD.PaymentDisplayName ELSE OD.PaymentDisplayName END AS PaymentDisplayName, --8
			CASE WHEN OD.PaymentSettingId = OOD.PaymentSettingId THEN OOD.PaymentExternalId ELSE OD.PaymentExternalId END AS PaymentExternalId,OD.CultureCode, --9 
			OD.DisplayName,OD.InHandDate,OD.IpAddress,OD.JobName,OD.ShippingConstraintCode,OD.ShippingDiscount,OD.ShippingHandlingCharges,OD.ReturnCharges, --10
			OD.IsCalculateTaxAfterDiscount,OD.Email,OD.PhoneNumber,OD.OrderTotalWithoutVoucher,OD.ImportDuty,OD.RemainingOrderAmount --11
		FROM #TempOrderData OD
		INNER JOIN ZnodeOmsOrder OO WITH (NOLOCK) ON OD.OrderNumber = OO.OrderNumber
		INNER JOIN ZnodeOmsOrderDetails OOD  WITH (NOLOCK) ON OO.OmsOrderId = OOD.OmsOrderId AND OOD.IsActive = 1
		LEFT JOIN #TempOrderBillingAddress OBA ON OD.BillingAddressId = OBA.AddressId
	
		DECLARE @OmsOrderStateIdCancelled int =  (select top 1 OmsOrderStateId FROM ZnodeOmsOrderState WHERE OrderStateName = 'CANCELED')

		UPDATE ZnodeOmsOrderDetails SET IsActive = 0 , OmsOrderStateId = @OmsOrderStateIdCancelled
		WHERE OmsOrderDetailsId = @OldOmsOrderDetailsId

		UPDATE ZnodeOmsOrderLineItems SET IsActive = 0
		WHERE OmsOrderDetailsId = @OldOmsOrderDetailsId
	END

	----Geting new OmsOrderDetailsId always
	Declare @OmsOrderDetailsId INT
	SET @OmsOrderDetailsId = ( SELECT TOP 1 OmsOrderDetailsId FROM @OMSOrderDetail )

	--Insert Order notes only for new order details
	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		INSERT INTO ZnodeOmsNotes(OmsOrderDetailsId,Notes,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
		SELECT @OmsOrderDetailsId,Tbl.Col.value( 'AdditionalInstructions[1]', 'NVARCHAR(Max)' ) AS Notes,
			@UserId,@GetDate,@UserId,@GetDate
		FROM @OrderXML.nodes( '//PlaceOrderModel' ) AS Tbl(Col)
		WHERE Tbl.Col.value( 'AdditionalInstructions[1]', 'NVARCHAR(Max)' ) <> '';
	END

	----Inserting parent line item data
	INSERT INTO ZnodeOmsOrderLineItems
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description --1
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber --2
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles --3
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy --4
		,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, GroupIdentifier --5
	)
	OUTPUT INSERTED.OmsOrderDetailsId, INSERTED.OmsOrderLineItemsId, INSERTED.Sku,INSERTED.ParentOmsOrderLineItemsId, INSERTED.GroupId, INSERTED.OrderLineItemRelationshipTypeId,INSERTED.GroupIdentifier INTO @OmsParentOrderLineItems
	SELECT OrderLineItemRelationshipTypeId,@OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description--1
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber --2
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles --3
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,ISNULL(IsActive,1) AS IsActive,CreatedBy,CreatedDate,ModifiedBy --4
		,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, GroupIdentifier --5
	FROM #TempParentLineItemDetails PLID

	----Inserting child line item data
	INSERT INTO ZnodeOmsOrderLineItems
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description --1
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber --2
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles --3
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy --4
		,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, --5
		ParentSku, GroupIdentifier --6
	)
	OUTPUT INSERTED.OmsOrderDetailsId, INSERTED.OmsOrderLineItemsId, INSERTED.Sku,INSERTED.ParentOmsOrderLineItemsId, INSERTED.GroupId, INSERTED.OrderLineItemRelationshipTypeId, INSERTED.ParentSku, INSERTED.GroupIdentifier INTO @OmsOrderLineItems
	SELECT PLID.OrderLineItemRelationshipTypeId,@OmsOrderDetailsId,PLID.OmsOrderShipmentId,PLID.RmaReasonForReturnId,PLID.Sku,PLID.ProductName,PLID.Description, --1
		PLID.Quantity,PLID.Price,PLID.Weight,PLID.DownloadLink,PLID.DiscountAmount,PLID.ShipSeparately,PLID.ShipDate,PLID.ReturnDate,PLID.ShippingCost,PLID.PromoDescription,PLID.TransactionNumber, --2
		PLID.PaymentStatusId,PLID.TrackingNumber,PLID.IsAutoGeneratedTracking,PLID.OrderLineItemStateId,PLID.IsRecurringBilling,PLID.RecurringBillingPeriod,PLID.RecurringBillingCycles,--3
		PLID.RecurringBillingFrequency,PLID.RecurringBillingAmount,PLID.AppliedPromo,PLID.CouponsApplied,PLID.ExternalId,isnull(PLID.IsActive,1) AS IsActive,PLID.CreatedBy,PLID.CreatedDate,PLID.ModifiedBy, --4
		PLID.ModifiedDate,PLID.AutoAddonSKU,PLID.IsShippingReturn,PLID.PartialRefundAmount,PLID.Custom1,PLID.Custom2,PLID.Custom3,PLID.Custom4,PLID.Custom5,PLID.GroupId,PLID.BundleQuantity, --5
		case when PLID.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdSimple then PLID.Sku else PLID.ParentSku end AS ParentSku, GroupIdentifier --6
	FROM #TempChildLineItemDetails PLID

	--Updating ParentOmsOrderLineItemsId for child line items for simple, group and configurable products
	UPDATE A SET A.ParentOmsOrderLineItemsId = (SELECT TOP 1 OmsOrderLineItemsId FROM @OmsParentOrderLineItems d WHERE d.GroupIdentifier = a.GroupIdentifier AND A.ParentSku = D.Sku  and ISNULL(a.GroupId,'-') = ISNULL(d.GroupId,'-'))
	FROM @OmsOrderLineItems a
	WHERE a.OrderLineItemRelationshipTypeId NOT IN ( @OrderLineItemRelationshipTypeIdAddon, @OrderLineItemRelationshipTypeIdGroup)  
	AND a.ParentOmsOrderLineItemsId IS NULL 
	
	--Updating ParentOmsOrderLineItemsId for child line items for group products
	IF EXISTS(SELECT * FROM @OmsOrderLineItems WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdGroup)
	BEGIN
		---Getting child lineitems for group product
		;WITH Cte_GroupProductChild AS
		(
			SELECT GroupIdentifier,Sku, ParentSku, OmsOrderLineItemsId, ParentOmsOrderLineItemsId,Dense_Rank()Over(Partition By GroupIdentifier ORDER BY OmsOrderLineItemsId) AS RowId1 
			FROM @OmsOrderLineItems
			WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdGroup
		)
		---Getting parent lineitems for group product
		,Cte_GroupProductParent AS 
		(
			SELECT GroupIdentifier,Sku, OmsOrderLineItemsId, Dense_Rank()Over(Partition By GroupIdentifier ORDER BY OmsOrderLineItemsId) AS RowId1 
			FROM @OmsParentOrderLineItems a
			WHERE OrderLineItemRelationshipTypeId IS NULL
			AND EXISTS(SELECT * FROM @OmsOrderLineItems b WHERE a.GroupIdentifier = b.GroupIdentifier AND a.Sku = b.ParentSku)
		)
		--Updating ParentOmsOrderLineItemsId on child for group products
		UPDATE a SET a.ParentOmsOrderLineItemsId = b.OmsOrderLineItemsId
		FROM Cte_GroupProductChild a
		INNER JOIN Cte_GroupProductParent B ON A.GroupIdentifier = B.GroupIdentifier AND a.RowId1 = b.RowId1 AND b.Sku = a.ParentSku 
	END

	---Updating ParentOmsOrderLineItemsId for addons if present
	IF EXISTS(SELECT * FROM @OmsOrderLineItems WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
	BEGIN
		--Updating ParentOmsOrderLineItemsId for addon with Simple products , group products and configurable products
		UPDATE b SET b.ParentOmsOrderLineItemsId = c.OmsOrderLineItemsId
		FROM @OmsOrderLineItems c
		INNER JOIN @OmsOrderLineItems b on b.ParentSku = c.Sku AND c.GroupIdentifier = b.GroupIdentifier
		WHERE c.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon and c.OrderLineItemRelationshipTypeId is not null
		and b.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
		AND b.ParentOmsOrderLineItemsId IS NULL
		
		--Updating ParentOmsOrderLineItemsId for addon with bundle products
		UPDATE c SET c.ParentOmsOrderLineItemsId = b.OmsOrderLineItemsId
		FROM @OmsOrderLineItems c
		INNER JOIN @OmsParentOrderLineItems b on B.sku = C.parentsku AND c.GroupIdentifier= b.GroupIdentifier
		WHERE B.OrderLineItemRelationshipTypeId is null 
		AND c.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
		AND C.ParentOmsOrderLineItemsId IS NULL
	 END
	 ---Updating ParentOmsOrderLineItemsId in main table
	 UPDATE a SET a.ParentOmsOrderLineItemsId = b.ParentOmsOrderLineItemsId
	 FROM  ZnodeOmsOrderLineItems a
	 INNER JOIN @OmsOrderLineItems b on a.OmsOrderLineItemsId = b.OmsOrderLineItemsId

	----Shipping details Start
	DECLARE @ShippingTypeId INT
	IF EXISTS(SELECT * FROM #TempOrderData WHERE ShippingTypeId IS NULL)
	BEGIN
		SET @ShippingTypeId = (SELECT TOP 1 ShippingTypeId FROM ZnodeShipping WHERE EXISTS(SELECT * FROM #TempOrderData WHERE ZnodeShipping.ShippingId = #TempOrderData.ShippingId))
	END
	ELSE
	BEGIN
		SET @ShippingTypeId = (SELECT TOP 1 ShippingTypeId FROM #TempOrderData)
	END
	IF EXISTS(SELECT * FROM ZnodeShippingTypes WITH (NOLOCK)  WHERE ShippingTypeId = @ShippingTypeId AND ClassName = 'ZnodeCustomerShipping')
	BEGIN
		INSERT INTO ZnodeOmsCustomerShipping(OmsOrderDetailsId,UserId,ShippingTypeId,AccountNumber,ShippingMethod,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT TOP 1 @OmsOrderDetailsId,@UserId,@ShippingTypeId,AccountNumber,ShippingMethod,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		FROM #TempOrderData
	END
	----Shipping details end

	----Order tax details start
	----Inserting order tax data
	IF (SELECT TOP 1 TaxCost FROM #TempOrderData) > 0
	BEGIN
		INSERT INTO ZnodeOmsTaxOrderDetails(OmsOrderDetailsId,SalesTax,VAT,GST,PST,HST,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportDuty)
		SELECT @OmsOrderDetailsId,OD.SalesTax,OD.VAT,OD.GST,OD.PST,OD.HST,OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.ImportDuty
		FROM #TempOrderData OD
	END

	----Inserting order tax data for parent line item
	INSERT INTO ZnodeOmsTaxOrderLineDetails
	(
		OmsOrderLineItemsId,TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty,
		CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
	)
	SELECT POLI.OmsOrderLineItemsId,CLID.TaxRuleId,CLID.TaxTransactionNumber,CLID.Comments,CLID.SalesTax,CLID.VAT,CLID.GST,CLID.PST,CLID.HST,CLID.ImportDuty,
	CLID.CreatedBy,CLID.CreatedDate,CLID.ModifiedBy,CLID.ModifiedDate
	FROM #TempParentLineItemDetails CLID
	INNER JOIN @OmsParentOrderLineItems POLI ON CLID.Sku = POLI.Sku AND ISNULL(CLID.GroupId,'') = ISNULL(POLI.GroupId,'') AND CLID.GroupIdentifier = POLI.GroupIdentifier
	WHERE POLI.ParentOmsOrderLineItemsId IS NULL
	AND (ISNULL(CLID.SalesTax,0)+ISNULL(CLID.VAT,0)+ISNULL(CLID.GST,0)+ISNULL(CLID.PST,0)+ISNULL(CLID.HST,0)) > 0

	----Inserting order tax data for child line item
	INSERT INTO ZnodeOmsTaxOrderLineDetails
	(
		OmsOrderLineItemsId,TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty,
		CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
	)
	SELECT POLI.OmsOrderLineItemsId,CLID.TaxRuleId,CLID.TaxTransactionNumber,CLID.Comments,CLID.SalesTax,CLID.VAT,CLID.GST,CLID.PST,CLID.HST,CLID.ImportDuty,
		CLID.CreatedBy,CLID.CreatedDate,CLID.ModifiedBy,CLID.ModifiedDate
	FROM #TempChildLineItemDetails CLID
	INNER JOIN @OmsOrderLineItems POLI ON CLID.Sku = POLI.Sku AND ISNULL(CLID.GroupId,'') = ISNULL(POLI.GroupId,'') AND CLID.GroupIdentifier = POLI.GroupIdentifier
	WHERE POLI.ParentOmsOrderLineItemsId IS NOT NULL
	AND (ISNULL(CLID.SalesTax,0)+ISNULL(CLID.VAT,0)+ISNULL(CLID.GST,0)+ISNULL(CLID.PST,0)+ISNULL(CLID.HST,0)) > 0
	----Order tax details end

	----Order attribte details start
	----Fetching order attributes FROM xml
	INSERT INTO #TempOrderAttribute(AttributeCode ,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AttributeValueCode,Sku,GroupId, GroupIdentifier )
	SELECT
		Tbl.Col.value( 'AttributeCode[1]', 'NVARCHAR(Max)' ) AS AttributeCode,
		Tbl.Col.value( 'AttributeValue[1]', 'NVARCHAR(Max)' ) AS AttributeValue,
		@UserId,@GetDate,@UserId,@GetDate,
		Tbl.Col.value( 'AttributeValueCode[1]', 'NVARCHAR(2000)' ) AS AttributeValueCode,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(2000)' ) AS GroupIdentifier
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/OrderLineItem/PlaceOrderlineItemCollection/OrderAttribute/PlaceOrderAttributeModel' ) AS Tbl(Col);

	----Inserting order attributes data
	INSERT INTO ZnodeOmsOrderAttribute(OmsOrderLineItemsId,AttributeCode,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AttributeValueCode)
	SELECT POLI.OmsOrderLineItemsId, OA.AttributeCode,OA.AttributeValue,OA.CreatedBy,OA.CreatedDate,OA.ModifiedBy,OA.CreatedDate,OA.AttributeValueCode
	FROM #TempOrderAttribute OA
	INNER JOIN @OmsOrderLineItems POLI ON OA.Sku = POLI.Sku AND ISNULL(OA.GroupId,'') = ISNULL(POLI.GroupId,'') AND OA.GroupIdentifier = POLI.GroupIdentifier
	----Order attribte details end

	----Personalise details start
	----Fetching personalize order data
	INSERT INTO #OmsPersonalizeItem(PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL,Sku,GroupId, GroupIdentifier)
	SELECT
		Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode,
		Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue,
		@UserId,@GetDate,@UserId,@GetDate,
		Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(2000)' ) AS DesignId,
		Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(2000)' ) AS ThumbnailURL,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(2000)' ) AS GroupIdentifier
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/PersonaliseDetails/PlaceOrderPersonaliseModel' ) AS Tbl(Col);

	--Inserting personalize order data
	INSERT INTO ZnodeOmsPersonalizeItem(OmsOrderLineItemsId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL)
	SELECT OmsOrderLineItemsId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL
	FROM #OmsPersonalizeItem OPI
	INNER JOIN @OmsParentOrderLineItems POLI ON OPI.Sku = POLI.Sku AND ISNULL(OPI.GroupId,'') = ISNULL(POLI.GroupId,'') AND OPI.GroupIdentifier = POLI.GroupIdentifier
	WHERE POLI.ParentOmsOrderLineItemsId IS NULL
	----Personalise details end

	----discount details start
	----Fetching order discount data
	INSERT INTO #OmsOrderDiscount
	(
		OmsDiscountTypeId ,DiscountCode,DiscountAmount ,Description ,CreatedBy ,CreatedDate ,
		ModifiedBy ,ModifiedDate ,PerQuantityDiscount,DiscountMultiplier ,DiscountLevelTypeId ,
		PromotionName ,PromotionTypeId ,DiscountAppliedSequence,PromotionMessage ,Sku,GroupId 
	)
	SELECT
	CASE WHEN Tbl.Col.value( 'OmsDiscountTypeId[1]', 'NVARCHAR(2000)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OmsDiscountTypeId[1]', 'NVARCHAR(2000)' ) END AS OmsDiscountTypeId,
		Tbl.Col.value( 'DiscountCode[1]', 'NVARCHAR(Max)' ) AS DiscountCode,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
		@UserId,@GetDate,@UserId,@GetDate,
		CASE WHEN Tbl.Col.value( 'PerQuantityDiscount[1]', 'NVARCHAR(2000)' )='' THEN NULL ELSE Tbl.Col.value( 'PerQuantityDiscount[1]', 'NVARCHAR(2000)' ) END AS PerQuantityDiscount,
		CASE WHEN Tbl.Col.value( 'DiscountMultiplier[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountMultiplier[1]', 'NVARCHAR(2000)' ) END AS DiscountMultiplier,
		CASE WHEN Tbl.Col.value( 'DiscountLevelTypeId[1]', 'NVARCHAR(2000)' )= '' THEN NULL ELSE Tbl.Col.value( 'DiscountLevelTypeId[1]', 'NVARCHAR(2000)' ) END AS DiscountLevelTypeId,
		Tbl.Col.value( 'PromotionName[1]', 'NVARCHAR(2000)' ) AS PromotionName,
		CASE WHEN Tbl.Col.value( 'PromotionTypeId[1]', 'NVARCHAR(2000)' )= '' THEN NULL ELSE Tbl.Col.value( 'PromotionTypeId[1]', 'NVARCHAR(2000)' ) END AS PromotionTypeId,
		Tbl.Col.value( 'DiscountAppliedSequence[1]', 'NVARCHAR(2000)' ) AS DiscountAppliedSequence,
		Tbl.Col.value( 'PromotionMessage[1]', 'NVARCHAR(2000)' ) AS PromotionMessage,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId
	FROM @OrderXML.nodes('//PlaceOrderModel/OrderDiscounts/PlaceOrderDiscountModel') AS Tbl(Col)

	----Inserting order discount data
	--Inserting product level discount for simple and group products
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,POLI.OmsOrderLineItemsId,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
		OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,POLI.ParentOmsOrderLineItemsId,
		OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	INNER JOIN @OmsOrderLineItems POLI ON OD.Sku = POLI.Sku AND ISNULL(OD.GroupId,'') = ISNULL(POLI.GroupId,'') 
	WHERE isnull(OD.Sku,'') <> '' AND POLI.OrderLineItemRelationshipTypeId IN (@OrderLineItemRelationshipTypeIdSimple , @OrderLineItemRelationshipTypeIdGroup)
	
	--Inserting product level discount for config and bundle products
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,POLI.ParentOmsOrderLineItemsId,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
	OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,NULL,
	OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	INNER JOIN @OmsOrderLineItems POLI ON OD.Sku = POLI.ParentSku AND ISNULL(OD.GroupId,'') = ISNULL(POLI.GroupId,'')
	WHERE isnull(OD.Sku,'') <> '' AND POLI.OrderLineItemRelationshipTypeId IN (@OrderLineItemRelationshipTypeIdBundles , @OrderLineItemRelationshipTypeIdConfig)
	
	--Inserting order level discount 
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,NULL,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
	OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,NULL,
	OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	WHERE isnull(OD.Sku,'') = ''
	----discount details end

	----Additional Cost details start
	IF OBJECT_ID('TEMPDB..#TempAdditionalCost') IS NOT NULL
	DROP TABLE #TempAdditionalCost
	--fetching additional cost details
	SELECT Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl1.Col.value( 'KeyName[1]', 'NVARCHAR(2000)' ) AS KeyName,
		CASE WHEN Tbl1.Col.value( 'KeyValue[1]', 'NVARCHAR(2000)' )='' THEN NULL ELSE Tbl1.Col.value( 'KeyValue[1]', 'NVARCHAR(2000)' ) END AS KeyValue,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId
	INTO #TempAdditionalCost
	FROM @OrderXML.nodes('//PlaceOrderModel/LineItems/PlaceOrderLineItemModel') AS Tbl(Col)
	CROSS APPLY Tbl.Col.nodes( '*:AdditionalCostList/AdditionalCost' ) AS Tbl1(Col);

	--Inserting additional cost details
	IF EXISTS(SELECT * FROM #TempAdditionalCost)
	BEGIN
		INSERT INTO ZnodeOmsOrderLineItemsAdditionalCost(OmsOrderLineItemsId,KeyName,KeyValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT OLI.OmsOrderLineItemsId, AC.KeyName, AC.KeyValue, @UserId, @GetDate, @UserId, @GetDate
		FROM #TempAdditionalCost AC
		INNER JOIN @OmsOrderLineItems OLI ON AC.Sku = OLI.Sku AND ISNULL(AC.GroupId,'') = ISNULL(OLI.GroupId,'') 
		WHERE OLI.ParentOmsOrderLineItemsId IS NULL
		AND ISNULL(AC.KeyName,'') <> ''
	END
	----Additional Cost details end
	
	DECLARE @OmsOrderId INT
	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		SET @OmsOrderId = (SELECT TOP 1 OmsOrderId FROM @OMSOrder)
	END
	ELSE
	BEGIN 
		SET @OmsOrderId = (SELECT TOP 1 OmsOrderId FROM #TempOrderData)
	END
	----RMA details start
	IF (SELECT TOP 1 OmsOrderId FROM #TempOrderData) > 0
	BEGIN
		DECLARE @OldOmsOrderDetailID INT
		SET @OmsOrderID = (SELECT TOP 1 OmsOrderId FROM #TempOrderData)
		SET @OldOmsOrderDetailID = (SELECT TOP 1 OmsOrderDetailsId FROM ZnodeOmsOrderDetails WHERE OmsOrderId = @OmsOrderID AND OmsOrderDetailsId <> @OmsOrderDetailsId ORDER BY OmsOrderDetailsId DESC)

		UPDATE ZnodeRmaReturnDetails
		SET OmsOrderDetailsId = @OmsOrderDetailsId
		WHERE OmsOrderId = @OmsOrderID

		SELECT OOLI.OmsOrderLineItemsId AS OldOmsOrderLineItemsId, OOLI.OmsOrderDetailsId, OOLI.Sku, LI.OmsOrderLineItemsId AS NewOmsOrderLineItemsId
		INTO #OldOrderLineItems
		FROM ZnodeOmsOrderLineItems OOLI WITH (NOLOCK)
		INNER JOIN @OmsOrderLineItems LI ON LI.Sku = OOLI.Sku
		WHERE OOLI.OmsOrderDetailsId = @OldOmsOrderDetailID --AND OOLI.ParentOmsOrderLineItemsId IS NULL
 
		UPDATE RRLI SET RRLI.OmsOrderLineItemsId = OldLI.NewOmsOrderLineItemsId
		FROM ZnodeRmaReturnLineItems RRLI
		INNER JOIN #OldOrderLineItems OldLI ON RRLI.OmsOrderLineItemsId = OldOmsOrderLineItemsId
	
		UPDATE ZnodeOmsOrder set IsOldOrder = 0
		where OmsOrderId = @OmsOrderID
	END
	----RMA details end
	
	---Inserting OrderTaxDetails
	IF(NOT EXISTS(SELECT 1 from ZnodeOmsTaxRule where OmsOrderId= @OmsOrderId))
	BEGIN
		DECLARE @TaxRate Numeric(28,6), @TaxRuleId INT, @AvataxIsSellerImporterOfRecord bit
		SET @TaxRate = (SELECT TOP 1 TaxRate FROM #TempOrderData)
		SET @TaxRuleId = (SELECT TOP 1 TaxRuleId FROM #TempChildLineItemDetails)
		SET @AvataxIsSellerImporterOfRecord = (SELECT TOP 1 AvataxIsSellerImporterOfRecord FROM #TempOrderData)

		 EXEC [Znode_InsertOrderTaxDetails] @OmsOrderId = @OmsOrderId, @TaxRuleId = @TaxRuleId, @TaxRate = @TaxRate, @AvataxIsSellerImporterOfRecord = @AvataxIsSellerImporterOfRecord, @Status = 0
	END

	COMMIT TRAN OrderInsert

	SELECT TOP 1 OmsOrderId,@OmsOrderDetailsId AS OmsOrderDetailsId, cast(1 AS bit)  AS Status, '' AS ErrorMessage
	FROM @OMSOrderDetail

END TRY
BEGIN CATCH
	ROLLBACK TRAN OrderInsert
	SELECT TOP 1 0 AS OmsOrderId,0 AS OmsOrderDetailsId, cast(0 AS bit)  AS Status, ERROR_MESSAGE() AS ErrorMessage

	INSERT INTO ZnodeOmsFailedOrderPayments(PaymentCode,PaymentDisplayName,TransactionToken,TotalAmount,UserName,UserId,Email,PaymentSettingId,OrderNumber,OrderDate,PaymentStatusId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
	SELECT TOP 1 PaymentCode,PaymentDisplayName, isnull(PaymentTransactionToken,''),Total,a.FirstName+' '+a.LastName,@UserId,a.Email,a.PaymentSettingId,a.OrderNumber,@GetDate,PaymentStatusId,@UserId,@GetDate,@UserId,@GetDate
	FROM #TempOrderData A
	
	DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertUpdateOmsOrder @OrderXML ='+CAST(@OrderXML AS VARCHAR(MAX))+' , @UserId = '+CAST(@UserId AS VARCHAR(50));

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName    = 'Znode_InsertUpdateOmsOrder',
	@ErrorInProcedure = @ERROR_PROCEDURE,
	@ErrorMessage     = @ErrorMessage,
	@ErrorLine        = @ErrorLine,
	@ErrorCall        = @ErrorCall;
	--If error throw in SP the deleting records FROM order tables if data inserted
	EXEC Znode_DeleteOrderById @OrderDetailId=@OmsOrderDetailsId,@Status=0
END CATCH

END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'SMSOptIn' AND Object_ID = Object_ID(N'dbo.ZnodeUser'))
BEGIN
	ALTER TABLE ZnodeUser ADD SMSOptIn BIT DEFAULT ((0)) NOT NULL;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_AdminUserDetailsByUserId')
	DROP PROC Znode_AdminUserDetailsByUserId
GO

CREATE PROCEDURE [dbo].[Znode_AdminUserDetailsByUserId]
(	
	@UserId INT
)
AS
/* 
    Summary: SP used to get the User details using UserId
    EXEC [Znode_AdminUserDetailsByUserId] @UserId = 1005
*/
BEGIN
BEGIN TRY
SET NOCOUNT ON;
	if OBJECT_ID('tempdb..#View_CustomerUserAddDetail') is not null
		drop table #View_CustomerUserAddDetail

	SELECT top 1 a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
			a.Email,a.EmailOptIn,a.CreatedBy,a.SMSOptIn,CONVERT( DATE, a.CreatedDate) CreatedDate,A.ModifiedBy,
			CONVERT( DATE, a.ModifiedDate) ModifiedDate,ur.RoleId,r.Name RoleName,
			CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
			e.Name AccountName,a.AccountId,a.ExternalId,
			CAST(CASE WHEN a.AccountId IS NULL THEN 0 ELSE 1 END AS    BIT) AS IsAccountCustomer,
			a.BudgetAmount,r.TypeOfRole,CAST(CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END AS    BIT) AS IsGuestUser,
			a.CustomerPaymentGUID,
			(ISNULL(RTRIM(LTRIM(a.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(a.MiddleName)), '')
			+CASE
				WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '') = ''
				THEN ''
				ELSE ' '
			END+ISNULL(RTRIM(LTRIM(a.LastName)), '')) FullName
	,CASE WHEN zp.StoreName IS NULL THEN 'ALL' ELSE zp.StoreName END StoreName,
	CASE WHEN a.AccountId IS NULL THEN up.PortalId ELSE ZPA.PortalId END as PortalId
	into #View_CustomerUserAddDetail
	FROM ZnodeUser a
	left JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
	LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
	LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
	LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)                       
	LEFT JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
	LEFT JOIN ZnodeUserPortal up ON(up.UserId = a.UserId)  
	LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
	LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = a.AccountId) 
	WHERE a.UserId = @UserId


	alter table #View_CustomerUserAddDetail 
	Add DepartmentId int, AccountPermissionAccessId int,SalesRepUserName varchar(600),SalesRepId Int,
	PermissionsName varchar(200), PermissionCode varchar(200),SalesRepFullName varchar(1000)

	--To get data for DepartmentId
	update CUD SET DepartmentId = i.DepartmentId
	from #View_CustomerUserAddDetail cud
	INNER JOIN ZnodeDepartmentUser i ON(i.UserId = cud.UserId)

	--To get data for AccountPermissionAccessId
	update CUD SET AccountPermissionAccessId = f.AccountPermissionAccessId
	from #View_CustomerUserAddDetail cud
	INNER JOIN ZnodeAccountUserPermission f ON(f.UserId = cud.UserId)

	----Updating SalesRep for user if any 
	update CUAD
	set CUAD.SalesRepUserName = azu.UserName, SalesRepId = SRCUP.SalesRepUserId,
	CUAD.SalesRepFullName = (ISNULL(RTRIM(LTRIM(ZU.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '')
								+CASE
									WHEN ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '') = ''
									THEN ''
									ELSE ' '
								END+ISNULL(RTRIM(LTRIM(ZU.LastName)), '')) 
	from #View_CustomerUserAddDetail CUAD
	inner join ZnodeSalesRepCustomerUserPortal SRCUP ON CUAD.UserId = SRCUP.CustomerUserid 
	inner join ZnodeUser ZU ON SRCUP.SalesRepUserId = ZU.UserId
	inner join ASPNetUsers ANU ON(ZU.AspNetuserId = ANU.Id)
	inner join AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = ANU.UserName)

	--To get data for PermissionsName
	update CUD SET PermissionsName = h.PermissionsName, PermissionCode = h.PermissionCode
	from #View_CustomerUserAddDetail cud
    INNER JOIN ZnodeAccountUserPermission f ON(f.UserId = cud.UserId)
    INNER JOIN ZnodeAccountPermissionAccess g ON(g.AccountPermissionAccessId = f.AccountPermissionAccessId)
    INNER JOIN ZnodeAccessPermission h ON(h.AccessPermissionId = g.AccessPermissionId)

	SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,FullName,PhoneNumber, Email,EmailOptIn,SMSOptIn,CreatedBy,CreatedDate,
		   ModifiedBy, ModifiedDate,RoleId,RoleName,IsLock,AccountName,AccountId,ExternalId,IsAccountCustomer,BudgetAmount,
		   TypeOfRole,IsGuestUser,CustomerPaymentGUID,StoreName, PortalId,DepartmentId, AccountPermissionAccessId,
		   SalesRepUserName,SalesRepFullName,isnull(SalesRepId,0) as SalesRepId, PermissionsName, PermissionCode
	FROM #View_CustomerUserAddDetail

	if OBJECT_ID('tempdb..#View_CustomerUserAddDetail') is not null
		drop table #View_CustomerUserAddDetail

END TRY
BEGIN CATCH
	DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_AdminUserDetailsByUserId @UserId ='+CAST(@UserId AS VARCHAR(10));
	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName    = 'Znode_AdminUserDetailsByUserId',
	@ErrorInProcedure = @ERROR_PROCEDURE,
	@ErrorMessage     = @ErrorMessage,
	@ErrorLine        = @ErrorLine,
	@ErrorCall        = @ErrorCall;
END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCustomer')
	DROP PROC Znode_ImportCustomer
GO

CREATE PROCEDURE [dbo].[Znode_ImportCustomer]
(
	  @TableName NVARCHAR(100), 
	  @Status BIT OUT, 
	  @UserId INT, 
	  @ImportProcessLogId INT, 
	  @NewGUId NVARCHAR(200), 
	  @LocaleId INT= 0,
	  @PortalId INT ,
	  @CsvColumnString NVARCHAR(max)
)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Customer Details
	
	-- Unit Testing : 
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(max),@AspNetZnodeUserId NVARCHAR(256),@ASPNetUsersId NVARCHAR(256),
		@PasswordHash NVARCHAR(max),@SecurityStamp NVARCHAR(max),@RoleId NVARCHAR(256),@IsAllowGlobalLevelUserCreation NVARCHAR(10)
		Declare @ProfileId  INT
		DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		 
		SET @SecurityStamp = '0wVYOZNK4g4kKz9wNs-UHw2'
		SET @PasswordHash = 'APy4Tm1KbRG6oy7h3r85UDh/lCW4JeOi2O2Mfsb3OjkpWTp1YfucMAvvcmUqNaSOlA==';
		SELECT  @RoleId  = Id FROM AspNetRoles WHERE   NAME = 'Customer'  

		SELECT @IsAllowGlobalLevelUserCreation = FeatureValues FROM ZnodeGlobalsetting WHERE FeatureName = 'AllowGlobalLevelUserCreation'

		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
		-- Retrive RoundOff Value FROM global setting 

		-- Three type of import required three table varible for product , category and brand
		CREATE TABLE #InsertCustomer 
		( 
			RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, UserName NVARCHAR(512) ,FirstName	NVARCHAR(200),
			LastName NVARCHAR(200), BudgetAmount	NUMERIC,Email	NVARCHAR(100),PhoneNumber	NVARCHAR(100),
		    EmailOptIn	varchar(100)	,ReferralStatus	NVARCHAR(40),IsActive	varchar(100)	,ExternalId	NVARCHAR(max),CreatedDate DATETIME,
			ProfileName varchar(200),AccountCode NVARCHAR(100),DepartmentName varchar(300),RoleName NVARCHAR(256), GUID NVARCHAR(400)
			,PerOrderLimit INT,	PerOrderAnnualLimit NVARCHAR(100),BillingAccountNumber NVARCHAR(100),EnableUserShippingAddressSuggestion  NVARCHAR(100),
			EnablePowerBIReportOnWebStore BIT,Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),
			Custom4 NVARCHAR(max),Custom5 NVARCHAR(max), SMSOptIn varchar(100)
		);

		SET @SSQL = 'INSERT INTO #InsertCustomer( RowNumber,' + @CsvColumnString + ',GUID)
		             SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+ @TableName;
		
		EXEC sys.sp_sqlexec @SSQL;
				
		SELECT TOP 1 @ProfileId   =  ProfileId FROM ZnodePortalprofile WHERE Portalid = @Portalid and IsDefaultRegistedProfile=1
		IF( Isnull(@ProfileId ,0) = 0 ) 
		Begin
		
		
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '62', 'Default Portal Profile', '', @NewGUId, 1 , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
							
				UPDATE ZnodeImportProcessLog
				SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
				WHERE ImportProcessLogId = @ImportProcessLogId;
			

				SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog 
				WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
				SELECT @SuccessRecordCount = 0

				UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
				TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
				WHERE ImportProcessLogId = @ImportProcessLogId;

				DELETE FROM #InsertCustomer 
				SET @Status = 0;

				COMMIT TRAN A;
				Return 0 
		End

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '104', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName not like '%_@_%_.__%' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '35', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName like '%;%'
				
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '30', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ltrim(rtrim(ii.UserName)) IN 
		(SELECT ltrim(rtrim(UserName))  FROM #InsertCustomer GROUP BY ltrim(rtrim(UserName))  having count(*) > 1 )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '104', 'Email', Email, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.Email not like '%_@_%_.__%' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'IsActive',  IsActive , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '77', 'AccountCode', ii.AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer ii 
		WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !='' 
		AND NOT EXISTS(SELECT * FROM ZnodeAccount za INNER JOIN ZnodePortalAccount zpa on za.AccountId = zpa.AccountId
			WHERE  ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za.AccountCode and zpa.PortalId = @PortalId )
		AND EXISTS(SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount za1 WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za1.AccountCode );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '73', 'AccountCode', AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !=''   and ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') not IN 
		(
			SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount   
		);

		

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '88', 'AccountCode', AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !='' and  exists
		(
			SELECT top 1 1 FROM  AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	 
		INNER JOIN ZnodeAccount ZA on  ZU.AccountId = ZA.AccountId
		WHERE ANZU.UserName = ii.UserName and  ZA.AccountCode != ii.AccountCode
		);

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '92', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ISNULL(LTRIM(RTRIM(ii.RoleName)),'') <> '' and  ISNULL(LTRIM(RTRIM(ii.RoleName)),'') IN ('User','Manager','Administrator')
		AND EXISTS(SELECT * FROM ZnodeUser a INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				--INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)						
				INNER JOIN AspNetUserRoles u on u.UserId = b.Id
				INNER JOIN AspNetRoles ZD on u.RoleId = zd.Id
				WHERE (ii.UserName = c.UserName) and ISNULL(LTRIM(RTRIM(ii.RoleName)),'') <> ZD.Name )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '75', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') ='' and ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '74', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE --ltrim(rtrim(ii.RoleName)) not IN ('User','Manager','Administrator') and ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and
			ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and not exists (SELECT top 1 1 FROM  AspNetRoles ANR WHERE name IN ('User','Manager','Administrator') and  ANR.name =ii.RoleName)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '76', 'DepartmentName', DepartmentName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') <> ''
		AND NOT EXISTS(SELECT * FROM  ZnodeAccount ZA INNER JOIN ZnodeDepartment ZD on ZA.AccountId = ZD.AccountId
			WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = ltrim(rtrim(za.AccountCode))
			and ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') = ltrim(rtrim(ZD.DepartmentName)))

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'EmailOptIn',  EmailOptIn , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.EmailOptIn NOT IN ('True','1','Yes','FALSE','0','No','');

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'SMSOptIn',  SMSOptIn , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.SMSOptIn NOT IN ('True','1','Yes','FALSE','0','No','');

		UPDATE ZIL
		SET ZIL.ColumnName =   ZIL.ColumnName + ' [ UserName - ' + ISNULL(UserName,'') + ' ] '
		FROM ZnodeImportLog ZIL 
		INNER JOIN #InsertCustomer IPA ON (ZIL.RowNumber = IPA.RowNumber)
		WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		--Note : Content page import is not required 
		
		-- END Function Validation 	
		-----------------------------------------------
		--- Delete Invalid Data after functional validatin  

		DELETE FROM #InsertCustomer
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
			--AND GUID = @NewGUID
		);


		-- Update Record count IN log 
        
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		SELECT @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertCustomer
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- END

		-- Insert Product Data 
				
				
				DECLARE @InsertedAspNetZnodeUser TABLE (AspNetZnodeUserId NVARCHAR(256) ,UserName NVARCHAR(512),PortalId INT )
				DECLARE @InsertedASPNetUsers TABLE (Id NVARCHAR(256) ,UserName NVARCHAR(512))
				DECLARE @InsertZnodeUser TABLE (UserId INT,AspNetUserId NVARCHAR(256),CreatedDate DATETIME )

				UPDATE ANU SET 
				ANU.PhoneNumber	= IC.PhoneNumber, 
					ANU.LockoutEndDateUtc = case when IC.IsActive IN('0','No','False') then @GetDate when IC.IsActive IN('1','Yes','True') then null else ANU.LockoutEndDateUtc END
				FROM AspNetZnodeUser ANZU 
				INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
				WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
				----Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

				UPDATE ZU SET 
				ZU.FirstName	= IC.FirstName,
				ZU.LastName		= IC.LastName,
				--ZU.MiddleName	= IC.MiddleName,
				ZU.BudgetAmount = IC.BudgetAmount,
				ZU.Email		= IC.Email,
				ZU.PhoneNumber	= IC.PhoneNumber,
				ZU.EmailOptIn	= (CASE IC.EmailOptIn WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.EmailOptIn,0) As BIT) END),
				ZU.IsActive		= (CASE IC.IsActive WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.IsActive,0) As BIT) END),
				ZU.Custom1 = IC.Custom1,
				ZU.Custom2 = IC.Custom2,
				ZU.Custom3 = IC.Custom3,
				ZU.Custom4 = IC.Custom4,
				ZU.Custom5 = IC.Custom5,
				ZU.SMSOptIn	= (CASE IC.SMSOptIn WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 WHEN ISNULL(IC.SMSOptIn,'') THEN ZU.SMSOptIn ELSE CAST(ISNULL(IC.SMSOptIn,0) As BIT) END)
				--ZU.ExternalId = ExternalId
				FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
				WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
				--WHERE Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

				INSERT INTO AspNetZnodeUser (AspNetZnodeUserId, UserName, PortalId)		
				OUTPUT INSERTED.AspNetZnodeUserId, INSERTED.UserName, INSERTED.PortalId	INTO  @InsertedAspNetZnodeUser 			 
				SELECT NEWID(),IC.UserName, @PortalId FROM #InsertCustomer IC 
				WHERE NOT EXISTS (SELECT TOP 1 1  FROM AspNetZnodeUser ANZ 
					WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZ.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END 
					AND ANZ.UserName = IC.UserName)

				INSERT INTO ASPNetUsers (Id,Email,EmailConfirmed,PasswordHash,SecurityStamp,PhoneNumber,PhoneNumberConfirmed,TwoFactorEnabled,
				LockoutEndDateUtc,LockOutEnabled,AccessFailedCount,PasswordChangedDate,UserName)
				OUTPUT inserted.Id, inserted.UserName INTO @InsertedASPNetUsers
				SELECT NewId(), Email,0 ,@PasswordHash,@SecurityStamp,PhoneNumber,0,0,case when A.IsActive IN ('0','False','No') then @GetDate else null END LockoutEndDateUtc,1 LockoutEnabled,
				0,@GetDate,AspNetZnodeUserId FROM #InsertCustomer A INNER JOIN @InsertedAspNetZnodeUser  B 
				ON A.UserName = B.UserName
			
				INSERT INTO  ZnodeUser(AspNetUserId,FirstName,LastName,CustomerPaymentGUID,Email,PhoneNumber,EmailOptIn,
				IsActive,ExternalId, CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,UserName,Custom1,Custom2,Custom3,Custom4,Custom5,SMSOptIn)
				OUTPUT Inserted.UserId, Inserted.AspNetUserId,Inserted.CreatedDate INTO @InsertZnodeUser
				SELECT IANU.Id AspNetUserId ,IC.FirstName,IC.LastName,null CustomerPaymentGUID,IC.Email
				,IC.PhoneNumber,
				(CASE IC.EmailOptIn WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.EmailOptIn,0) As BIT) END),
				(CASE IC.IsActive WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.IsActive,0) As BIT) END),
				IC.ExternalId, @UserId,
				CASE WHEN IC.CreatedDate IS NULL OR IC.CreatedDate = '' THEN  @Getdate ELSE IC.CreatedDate END,
				@UserId,@Getdate,IC.UserName,IC.Custom1,IC.Custom2,IC.Custom3,IC.Custom4,IC.Custom5,
					(CASE IC.SMSOptIn WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.SMSOptIn,0) As BIT) END)
				FROM #InsertCustomer IC INNER JOIN 
				@InsertedAspNetZnodeUser IANZU ON IC.UserName = IANZU.UserName  INNER JOIN 
				@InsertedASPNetUsers IANU ON IANZU.AspNetZnodeUserId = IANU.UserName 
	  	     
				INSERT INTO AspNetUserRoles (UserId,RoleId)  SELECT AspNetUserId, @RoleID FROM @InsertZnodeUser 
				INSERT INTO ZnodeUserPortal (UserId,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
				SELECT UserId, @PortalId , @UserId, IZU.CreatedDate,@UserId,@Getdate 
				FROM @InsertZnodeUser IZU

				INSERT INTO ZnodeAccountUserPermission(UserId,AccountPermissionAccessId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT UserId, 4 , @UserId, @Getdate,@UserId,@Getdate 
				FROM @InsertZnodeUser IZU
		
				------------INSERT INTO ZnodeUserGlobalAttributeValue
	
				IF OBJECT_ID('tempdb..#globaldata') IS NOT NULL 
					DROP TABLE #globaldata
				
				SELECT ZU.userid,PerOrderLimit,
					PerOrderAnnualLimit,
					BillingAccountNumber,
					EnableUserShippingAddressSuggestion,
					EnablePowerBIReportOnWebStore 
				INTO #globaldata
				FROM znodeuser ZU INNER JOIN  #InsertCustomer IC on IC.Email =ZU.EMAIL
				WHERE ZU.userid IN (SELECT userid FROM @InsertZnodeUser)
				GROUP BY ZU.userid,PerOrderLimit,
									PerOrderAnnualLimit,
									BillingAccountNumber,
									EnableUserShippingAddressSuggestion,
									EnablePowerBIReportOnWebStore 

				IF OBJECT_ID('tempdb..#globaldata1') IS NOT NULL DROP TABLE #globaldata1
				SELECT * INTO #globaldata1 FROM (SELECT userid, Cast(PerOrderLimit as varchar(100)) PerOrderLimit,
				 Cast(PerOrderAnnualLimit as varchar(100)) PerOrderAnnualLimit,
				 Cast(BillingAccountNumber as varchar(100)) BillingAccountNumber,
				 Cast(case when cast(EnableUserShippingAddressSuggestion as varchar(10))= '1' or cast(EnableUserShippingAddressSuggestion as varchar(10)) ='YES' or  cast(EnableUserShippingAddressSuggestion as varchar(10)) ='True' then 'True' else 'False'  END  as varchar(100)) EnableUserShippingAddressSuggestion,
				 Cast(case when cast(EnablePowerBIReportOnWebStore as varchar(10))= '1'  or cast(EnablePowerBIReportOnWebStore as varchar(10)) ='YES' or  cast(EnablePowerBIReportOnWebStore as varchar(10)) ='True' then 'True' else 'False' END  as varchar(100)) EnablePowerBIReportOnWebStore FROM #globaldata) ab
				UNPIVOT  
				   (avalue FOR acode IN   
					  (PerOrderLimit,
				PerOrderAnnualLimit,
				BillingAccountNumber,
				EnableUserShippingAddressSuggestion,
				EnablePowerBIReportOnWebStore)  
				)AS unpvt;  

				INSERT INTO ZnodeUserGlobalAttributeValue (UserId,	GlobalAttributeId,	GlobalAttributeDefaultValueId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
				SELECT g.Userid,ZGA.GlobalAttributeId,null,null,@UserId,@Getdate,@UserId,@Getdate
					FROM #globaldata1 g INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.acode
					WHERE NOT EXISTS (SELECT top 1 1 FROM ZnodeUserGlobalAttributeValue ZGAV WHERE ZGAV.Userid =g.Userid and ZGA.GlobalAttributeId=ZGAV.GlobalAttributeId)

				INSERT INTO ZnodeUserGlobalAttributeValuelocale(UserGlobalAttributeValueId,	LocaleId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate,	GlobalAttributeDefaultValueId,	MediaId,	MediaPath)
				SELECT UserGlobalAttributeValueId, @LocaleId,avalue ,@UserId,@Getdate,@UserId,@Getdate,null,null,null
					FROM ZnodeUserGlobalAttributeValue ZUGAV INNER JOIN #globaldata1 g on ZUGAV.userid =g.userid
						INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.acode and ZGA.GlobalAttributeId = ZUGAV.GlobalAttributeId
						WHERE NOT EXISTS (SELECT Top 1 1 FROM ZnodeUserGlobalAttributeValuelocale z WHERE z.UserGlobalAttributeValueId = ZUGAV.UserGlobalAttributeValueId)

				---------------------------------------------------------------------------------

				declare @Profile table (ProfileId INT)

				INSERT INTO ZnodeProfile (ProfileName,ShowOnPartnerSignup,Weighting,TaxExempt,DefaultExternalAccountNo,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ParentProfileId)
				OUTPUT inserted.ProfileId INTO @Profile(ProfileId)
				SELECT Distinct ProfileName, 0, null,0, replace(ltrim(rtrim(ProfileName)),' ','') as DefaultExternalAccountNo, @UserId,@Getdate, @UserId,@Getdate, null as ParentProfileId				
				FROM #InsertCustomer IC
				WHERE NOT EXISTS(SELECT * FROM ZnodeProfile ZP WHERE IC.ProfileName = ZP.ProfileName )
				AND ISNULL(ic.ProfileName,'') <> ''

				INSERT INTO ZnodePortalProfile (PortalId,	ProfileId,	IsDefaultAnonymousProfile,	IsDefaultRegistedProfile,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
				SELECT @PortalId, ProfileId, 0 AS IsDefaultAnonymousProfile, 0 AS IsDefaultRegistedProfile, @UserId,@Getdate, @UserId,@Getdate
				FROM @Profile

				UPDATE ZnodeUserProfile 
				SET ProfileId = COALESCE(ZP.ProfileId,@ProfileId)
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeUserProfile u ON u.UserId = a.UserId
				LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
				--WHERE IC.ProfileName <> ''
				
				INSERT INTO ZnodeUserProfile (ProfileId,UserId,IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT COALESCE(ZP.ProfileId,@ProfileId)  , a.UserId, 1 , @UserId,a.CreatedDate,@UserId,@Getdate 
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeUserProfile u WHERE u.UserId = a.UserId )
				AND EXISTS(SELECT * FROM @InsertZnodeUser IZU WHERE A.UserId = IZU.UserId)

				---to update accountid agaist user
				UPDATE ZU SET ZU.AccountId = ZA.AccountId 
				FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	 
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName
				INNER JOIN ZnodeAccount ZA ON ZA.AccountCode = IC.AccountCode 
				--INNER JOIN @InsertZnodeUser IZU on IZU.UserId =ZU.UserId
				WHERE Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0) and isnull(IC.AccountCode,'') <> ''
				
				update ZDU set ZDU.DepartmentId = ZD.DepartmentId, ModifiedBy = @UserId, ModifiedDate = @Getdate
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
				INNER JOIN ZnodeDepartmentUser ZDU on ZDU.UserId = a.UserId
				WHERE isnull(IC.DepartmentName,'') <> ''

				INSERT INTO ZnodeDepartmentUser(UserId,DepartmentId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT a.UserId, ZD.DepartmentId, @UserId,a.CreatedDate,@UserId,@Getdate 
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeDepartmentUser u WHERE u.UserId = a.UserId)
				AND isnull(IC.DepartmentName,'') <> ''
		
				update u set u.RoleId = ZD.Id
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
				INNER JOIN AspNetUserRoles u on u.UserId = b.Id
				WHERE isnull(IC.RoleName,'') <> ''
				
				INSERT INTO AspNetUserRoles(UserId,RoleId)
				SELECT b.Id as ASPNetUserId, ZD.Id as RoleId
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM AspNetUserRoles u WHERE u.UserId = b.Id)
				AND EXISTS(SELECT * FROM @InsertZnodeUser IZU WHERE A.UserId = IZU.UserId)
				AND isnull(IC.RoleName,'') <> ''


		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
		 DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCustomer @TableName = '+CAST(@TableName AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@PortalId='+CAST(@PortalId AS VARCHAR(10))+',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max));
              	
		 ---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

        EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportCustomer',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

DELETE FROM ZnodeImportAttributeValidation
WHERE ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Customer')
	AND AttributeCode IN ('EmailOptIn','IsActive')
	AND (SELECT COUNT(1) FROM ZnodeImportAttributeValidation
		WHERE AttributeCode IN ('EmailOptIn','IsActive')
			AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Customer'))>2
		
INSERT INTO ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
	,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Text','EmailOptIn',(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Customer'),0,'Text','RegularExpression',
	NULL,'','',NULL,2,GETDATE(),2,GETDATE(),7
WHERE NOT EXISTS(SELECT * FROM ZnodeImportAttributeValidation WHERE AttributeTypeName ='Text' AND AttributeCode = 'EmailOptIn' 
      AND ControlName = 'Text' AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Customer')
	  AND ValidationName = 'RegularExpression')

INSERT INTO ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
	,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Text','IsActive',(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Customer'),1,'Text','RegularExpression',
	NULL,'','',NULL,2,GETDATE(),2,GETDATE(),8
WHERE NOT EXISTS(SELECT * FROM ZnodeImportAttributeValidation WHERE AttributeTypeName ='Text' AND AttributeCode = 'IsActive' 
      AND ControlName = 'Text' AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Customer')
	  AND ValidationName = 'RegularExpression')

UPDATE ZnodeImportAttributeValidation
SET SequenceNumber=SequenceNumber+1
WHERE SequenceNumber>7 AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Customer')
	AND NOT EXISTS (SELECT * FROM ZnodeImportAttributeValidation WHERE AttributeCode='SMSOptIn'
		AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Customer'))

INSERT INTO ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
	,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Text','SMSOptIn',(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Customer'),0,'Text','RegularExpression',
	NULL,'','',NULL,2,GETDATE(),2,GETDATE(),8
WHERE NOT EXISTS(SELECT * FROM ZnodeImportAttributeValidation WHERE AttributeTypeName ='Text' AND AttributeCode = 'SMSOptIn' 
      AND ControlName = 'Text' AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Customer')
	  AND ValidationName = 'RegularExpression')

INSERT INTO ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'CustomerTemplate'),
'SMSOptIn','SMSOptIn',0,0,0,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
	WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'CustomerTemplate') 
		AND SourceColumnName ='SMSOptIn')

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemGroup')
	DROP PROC Znode_InsertUpdateSaveCartLineItemGroup
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemGroup]
(
	 @SaveCartLineItemType TT_SavecartLineitems READONLY  
	,@Userid  INT = 0 
	,@OrderLineItemRelationshipTypeIdGroup INT
	,@OrderLineItemRelationshipTypeIdAddon INT
)
AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 
	--Declared the variables
	DECLARE @GetDate datetime= dbo.Fn_GetDate(); 
	
	DECLARE @OmsInsertedData TABLE (SKU varchar(600),OmsSavedCartLineItemId INT ) 	
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId INT,GroupProductIds VARCHAR(600) ,PersonalizeCode NVARCHAR(MAX),PersonalizeValue NVARCHAR(MAX),DesignId NVARCHAR(MAX), ThumbnailURL NVARCHAR(MAX))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.GroupProductIds
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(MAX)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(MAX)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(MAX)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(MAX)' ) AS ThumbnailURL
	FROM @SaveCartLineItemType a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  

	CREATE TABLE #NewGroupSavecartLineitemDetails 
	(
		GenId INT IDENTITY(1,1),RowId	INT ,OmsSavedCartLineItemId	INT,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	int
		,SKU	NVARCHAR(MAX) ,Quantity	numeric(28,6)	,OrderLineItemRelationshipTypeID	INT ,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	INT ,AutoAddon	VARCHAR(MAX)	,OmsOrderId	INT ,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX),
		CustomUnitPrice NUMERIC(28,6)
	)
	 
	--Getting new save cart data(group product)
	INSERT INTO #NewGroupSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU ,CustomUnitPrice
	FROM @SaveCartLineItemType a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,CustomUnitPrice
	 
	--Getting new group product save cart data
	INSERT INTO #NewGroupSavecartLineitemDetails 
	SELECT   Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, GroupProductIds
				,Quantity, @OrderLineItemRelationshipTypeIdGroup, CustomText, CartAddOnDetails, Sequence
				,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU,CustomUnitPrice  
	FROM @SaveCartLineItemType  a 
	WHERE GroupProductIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, GroupProductIds
		,Quantity,  CustomText, CartAddOnDetails, Sequence ,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU,CustomUnitPrice
		
	--Getting new group products save cart data if addon is present for any line item
	INSERT INTO #NewGroupSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
		,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
			WHEN  GroupProductIds <> '' THEN GroupProductIds 
			WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU ,CustomUnitPrice
	FROM @SaveCartLineItemType  a 
	WHERE AddOnValueIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU,CustomUnitPrice
		 

	CREATE TABLE #OldGroupSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old group save cart data if present for same SKU in the new save cart data for group product	 	 
	INSERT INTO #OldGroupSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM ZnodeOmsSavedCartLineItem a with (nolock)  
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.GroupProductIds,'')   )   
		AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup   

	--Getting the old save cart Parent data
	INSERT INTO #OldGroupSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldGroupSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
		AND  b.OrderLineItemRelationshipTypeID IS NULL 

	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldGroupSavecartLineitemDetails

	DELETE a FROM #OldGroupSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldGroupSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 

	--Getting the old config product save cart addon data for old line items if present
	INSERT INTO #OldGroupSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldGroupSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

	------Merge Addon for same product
	IF EXISTS(SELECT * FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
	BEGIN
		INSERT INTO #OldValueForAddon 
		SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
		FROM ZnodeOmsSavedCartLineItem b 
		INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
		WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
								( SELECT  ', ' + SKU FROM    
									( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
										where a.OmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
										FOR XML PATH('')
								), 1, 2, ''
								) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a where a.ParentOmsSavedCartLineItemId is not null and OrderLineItemRelationshipTypeID<>1

		SELECT DISTINCT a.GroupProductIds SKU, STUFF(
									( SELECT  ', ' + x.AddOnValueIds FROM    
									( SELECT DISTINCT b.AddOnValueIds FROM @SaveCartLineItemType b
										where a.SKU=b.SKU ) x
										FOR XML PATH('')
									), 1, 2, ''
								) AddOns
		INTO #AddOnAdded
		FROM @SaveCartLineItemType a

		IF NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
		BEGIN
			DELETE FROM #OldGroupSavecartLineitemDetails
		END
	END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @SaveCartLineItemType ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldGroupSavecartLineitemDetails a WHERE	
		ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
		AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN
		DELETE FROM #OldGroupSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
		BEGIN
			DECLARE @parenTofAddon  TABLE( ParentOmsSavedCartLineItemId INT  )  
			INSERT INTO  @parenTofAddon 
			SELECT  ParentOmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails a
			WHERE a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
			AND (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem  t with (nolock) WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId AND   t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  
			DELETE 
			FROM #OldGroupSavecartLineitemDetails 
			WHERE OmsSavedCartLineItemId NOT IN (SELECT ParentOmsSavedCartLineItemId FROM  @parenTofAddon)   
				AND ParentOmsSavedCartLineItemId IS NOT NULL  
				AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

			 DELETE 
			 FROM #OldGroupSavecartLineitemDetails 
			 WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldGroupSavecartLineitemDetails m)
				AND ParentOmsSavedCartLineItemId IS  NULL  

			IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			BEGIN 
				DELETE FROM #OldGroupSavecartLineitemDetails
			END 
			IF (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem with (nolock)  WHERE ParentOmsSavedCartLineItemId IN (SELECT ParentOmsSavedCartLineItemId FROM @parenTofAddon)AND   OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			BEGIN 
				DELETE FROM #OldGroupSavecartLineitemDetails
			END
		END 
		ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		BEGIN 
			-- SELECT 3
		    DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup  )
				AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE 
			FROM #OldGroupSavecartLineitemDetails 
			WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
				OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		    
			DELETE 
			FROM #OldGroupSavecartLineitemDetails 
			WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldGroupSavecartLineitemDetails m)
				AND ParentOmsSavedCartLineItemId IS NULL
		END
		ELSE IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		BEGIN 
			DELETE FROM #OldGroupSavecartLineitemDetails
		END 
		ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
			AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  = '' )
		BEGIN 
			DELETE FROM #OldGroupSavecartLineitemDetails
		END  
	END

	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	--Getting the personalise data for old save cart if present	
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN
		DELETE FROM #OldGroupSavecartLineitemDetails
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 
			DELETE 
			FROM #OldGroupSavecartLineitemDetails 
			WHERE OmsSavedCartLineItemId IN (
				SELECT OmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
				AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues)) 
				OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
				AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues))
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
			AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
			AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) <>
				(SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM ZnodeOmsSavedCartLineItem WHERE ParentOmsSavedCartLineItemId IS nULL and OmsSavedCartLineItemId in (select OmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails)  )
		BEGIN
			DELETE n 
			FROM #OldGroupSavecartLineitemDetails n 
			WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
			OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
			AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldGroupSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
			AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		BEGIN 
			DELETE FROM #OldGroupSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		END 
	END
	
	IF EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails)
	BEGIN
		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU not having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*
			FROM @SaveCartLineItemType a 
					INNER JOIN #OldGroupSavecartLineitemDetails b on ( a.GroupProductIds = b.SKU or a.SKU = b.sku)
					where isnull(cast(a.PersonalisedAttribute AS varchar(max)),'') = ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId
			FROM #OldGroupSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
		)
		DELETE a FROM #OldGroupSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*, 
			a.PersonalizeCode
			,a.PersonalizeValue
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b on ( a.GroupProductIds = b.SKU)
			where isnull(a.PersonalizeValue,'') <> ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId, b.PersonalizeCode, b.PersonalizeValue
			FROM #OldGroupSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
			WHERE NOT EXISTS(SELECT * FROM cte c where b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and b.PersonalizeCode = c.PersonalizeCode 
								and b.PersonalizeValue = c.PersonalizeValue )
		)
		DELETE a FROM #OldGroupSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,b.ParentOmsSavedCartLineItemId , a.GroupProductIds
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b on a.GroupProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM #OldGroupSavecartLineitemDetails b1 
		WHERE NOT EXISTS(SELECT * FROM cte c where (b1.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or b1.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId))
		AND EXISTS(SELECT * FROM cte)

		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.GroupProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b on a.GroupProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE c1
		FROM cte a1		  
		INNER JOIN #OldGroupSavecartLineitemDetails b1 on a1.SKU = b1.SKU
		INNER JOIN #OldGroupSavecartLineitemDetails c1 on (b1.ParentOmsSavedCartLineItemId = c1.OmsSavedCartLineItemId OR b1.OmsSavedCartLineItemId = c1.OmsSavedCartLineItemId)
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c where a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and a1.PersonalizeValue = c.PersonalizeValue)
		-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b ON a.GroupProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
				--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewGroupSavecartLineitemDetails b ON a.GroupProductIds = b.SKU
			WHERE ISNULL(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		from CTE_OldPersonalizeCodeCount a
		INNER JOIN CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		INNER JOIN #OldGroupSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		
		--Delete parent entry if child not present
		DELETE a FROM #OldGroupSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldGroupSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

		--Updating the cart if old and new cart data matches
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
			a.Custom1 = ty.Custom1,
			a.Custom2 = ty.Custom2,
			a.Custom3 = ty.Custom3,
			a.Custom4 = ty.Custom4,
			a.Custom5 = ty.Custom5,
			a.ModifiedDate = @GetDate ,
			a.CustomUnitPrice = ty.CustomUnitPrice
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldGroupSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewGroupSavecartLineitemDetails ty ON (ty.SKU = b.SKU)
		WHERE a.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon

		UPDATE a
		SET a.Quantity = a.Quantity+s.AddOnQuantity,
			a.ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldGroupSavecartLineitemDetails b ON (a.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN @SaveCartLineItemType S on a.OmsSavedCartId = s.OmsSavedCartId and a.SKU = s.AddOnValueIds
		WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
	END

	--Added condition to add new product which is coming with existing product.
	IF OBJECT_ID('tempdb..#NewRowId') IS NOT NULL
		DROP TABLE #NewRowId;

	SELECT N.RowId
	INTO #NewRowId
	FROM #NewGroupSavecartLineitemDetails N
	LEFT JOIN #OldGroupSavecartLineitemDetails O ON N.OmsSavedCartId=O.OmsSavedCartId AND N.SKU=O.SKU
	WHERE O.SKU IS NULL

	--Inserting the new save cart data if old and new cart data not match
	IF NOT EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails)
		OR EXISTS (SELECT TOP 1 1 FROM #NewRowId) --Added condition to add new product which is coming with existing product.
	BEGIN
		SELECT RowId, Id ,Row_number()Over(ORDER BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
			,CustomText,CartAddOnDetails,ROW_NUMBER()Over(ORDER BY NewId() ) Sequence ,AutoAddon  
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU ,CustomUnitPrice 
		INTO #InsertNewGroupSavecartLineitem   
		FROM #NewGroupSavecartLineitemDetails
		WHERE RowId IN (SELECT RowId FROM #NewRowId) OR ParentSKU IS NULL
		GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU, CustomUnitPrice
		ORDER BY RowId, Id

		--Removing the line item having Quantity <=0 
		DELETE 
		FROM #InsertNewGroupSavecartLineitem
		WHERE Quantity <=0
  
		--Updating the rowid into new save cart line item as new line item is merged into existing save cart item
		;WITH VTTY AS
		(
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU
			FROM #InsertNewGroupSavecartLineitem m
			INNER JOIN  #InsertNewGroupSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU
			WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon
		)
		UPDATE m1   
		SET m1.RowId = TYU.RowId
		FROM #InsertNewGroupSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  

		;WITH VTRET AS   
		(
			SELECT RowId,id,Min(NewRowId)NewRowId ,SKU ,ParentSKU, OrderLineItemRelationshipTypeId 
			FROM #InsertNewGroupSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU  ,OrderLineItemRelationshipTypeId
			HAVING SKU = ParentSKU AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		)
		DELETE 
		FROM #InsertNewGroupSavecartLineitem 
		WHERE NewRowId  IN (SELECT NewRowId FROM VTRET)   
     
		--Inserting the new cart line item if not merged in existing save cart line item
		INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
			,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description,CustomUnitPrice)  
		OUTPUT INSERTED.SKU,INSERTED.OmsSavedCartLineItemId  INTO @OmsInsertedData 
		SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
			,CustomText,CartAddOnDetails,ROW_NUMBER()Over(ORDER BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description, CustomUnitPrice
		FROM  #InsertNewGroupSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
			,b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU 
		INTO  #Cte_newData
		FROM ZnodeOmsSavedCartLineItem a  with (nolock)
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
				AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID	  

		UPDATE a 
		SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  ORDER BY b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
			AND a.ParentOmsSavedCartLineItemId IS nULL   
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
  
		-----------------------------------------------------------------------------------------------------------------------------------

		SELECT  MIN(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId
			,b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU
		INTO #Cte_newData1
		FROM ZnodeOmsSavedCartLineItem a with (nolock)
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
				AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID	  

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData1  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  ORDER BY b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon   
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND  a.sequence in (SELECT  MIN(ab.sequence) FROM ZnodeOmsSavedCartLineItem ab where a.OmsSavedCartId = ab.OmsSavedCartId and 
				a.SKU = ab.sku and ab.OrderLineItemRelationshipTypeId is not null  ) 

		----------------------------------------------------------------------------------------------------------------------------

		SELECT DISTINCT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(ORDER BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #Cte_newAddon
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c with (nolock) on b.sku = c.sku and b.OmsSavedCartId=c.OmsSavedCartId and b.Id = 1
		WHERE ( ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
			AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon
			AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewGroupSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) and c.ParentOmsSavedCartLineItemId is null

		---- Added to get distinct records.
		--SELECT *,ROW_NUMBER()OVER(ORDER BY OmsSavedCartLineItemId) RowIdNo 
		--INTO #Cte_newAddon 
		--FROM #Cte_newAddon1

		SELECT DISTINCT OmsSavedCartLineItemId,RowId,SKU,ParentSKU,MIN(RowIdNo) As RowIdNo
		INTO #Cte_newAddon1
		FROM #Cte_newAddon
		GROUP BY OmsSavedCartLineItemId,RowId,SKU,ParentSKU;

		DELETE FROM #Cte_newAddon;

		INSERT INTO #Cte_newAddon
		SELECT OmsSavedCartLineItemId,RowId,SKU,ParentSKU,ROW_NUMBER() OVER (ORDER BY RowId,RowIdNo) As RowIdNo
		FROM #Cte_newAddon1;

		;WITH table_update AS 
		(
			SELECT * , ROW_NUMBER()Over(ORDER BY OmsSavedCartLineItemId  ) RowIdNo
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
				AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
				AND a.ParentOmsSavedCartLineItemId IS NULL  
				AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewGroupSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
				AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
		)
		UPDATE a 
		SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #Cte_newAddon  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId)  FROM #Cte_newAddon  r  
			WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )    IS nOT NULL 

		;WITH Cte_Th AS   
		(             
			SELECT RowId    
			FROM #InsertNewGroupSavecartLineitem a   
			GROUP BY RowId   
			HAVING COUNT(NewRowId) <= 1   
		 )
		UPDATE a 
		SET a.Quantity =  NULL,
			a.ModifiedDate = @GetDate   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		 AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewGroupSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
			AND OrderLineItemRelationshipTypeId IS NOT NULL     
       
	   ;WITH Cte_UpdateSequence AS   
		(  
			SELECT OmsSavedCartLineItemId ,Row_Number()Over(ORDER BY OmsSavedCartLineItemId) RowId , Sequence   
			FROM ZnodeOmsSavedCartLineItem with (nolock)  
			WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewGroupSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		)   
		UPDATE Cte_UpdateSequence  
		SET Sequence = RowId  
			
		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN @TBL_Personalise c ON a.SKU = c.GroupProductIds
		INNER JOIN ZnodeOmsSavedCartLineItem b WITH (NOLOCK) ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS NOT NULL  

		DELETE FROM ZnodeOmsPersonalizeCartItem	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
			
		----Inserting saved cart item personalise value FROM given line item
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
			   ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			   WHEN NOT MATCHED THEN 
				INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
				VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
	END 

	END TRY
	BEGIN CATCH 
		SELECT ERROR_MESSAGE()
	END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetDomainList')
	DROP PROC Znode_GetDomainList
GO

CREATE PROCEDURE [dbo].[Znode_GetDomainList]
(
	@WhereClause NVARCHAR(MAX),
    @Rows        INT           = 100,
    @PageNo      INT           = 1,
    @Order_BY    VARCHAR(100)  = '',
    @RowsCount   INT OUT
)
AS 
/*
	 Summary :- This Procedure is used to get the publish status of the Portal 
	 Unit Testig 
	 EXEC  Znode_GetDomainList '',100,1,'',0
	 select * from ZnodeDomain
*/
   BEGIN 
		BEGIN TRY 
			SET NOCOUNT ON 

			
			 DECLARE @SQL  NVARCHAR(MAX) 
			 DECLARE @TBL_Domainid TABLE (DomainId INT, PortalId INT,ApiKey NVARCHAR(MAX),DomainName NVARCHAR(MAX),IsActive BIT,ApplicationType NVARCHAR(MAX),IsDefault
			 BIT,StoreName NVARCHAR(MAX),PortalGlobalAttributeValueId INT,AttributeValue NVARCHAR(MAX),GlobalAttributeId INT,AttributeCode NVARCHAR(MAX),Countid INT,RowID INT)
	 
			SET @SQL = '
			;With Cte_Domain AS 
			(

			SELECT [Extent1].[DomainId] AS [DomainId], [Extent1].[PortalId] , [Extent1].[DomainName] AS [DomainName], 
			[Extent1].[IsActive] , [Extent1].[ApiKey] AS [ApiKey], [Extent1].[ApplicationType] AS [ApplicationType], 
			[Extent1].[IsDefault] AS [IsDefault], [Extent2].[StoreName] AS [StoreName], [Extent3].[PortalGlobalAttributeValueId] , 
			[Extent3].[AttributeValue] AS [AttributeValue], [Extent4].[GlobalAttributeId] , [Extent4].[AttributeCode] AS [AttributeCode]
			FROM [dbo].[ZnodeDomain] AS [Extent1]
			INNER JOIN [dbo].[ZnodePortal] AS [Extent2] ON [Extent1].[PortalId] = [Extent2].[PortalId]
			INNER JOIN [dbo].[ZnodePortalGlobalAttributeValue] AS [Extent3] ON [Extent1].[PortalId] = [Extent3].[PortalId]
			INNER JOIN [dbo].[ZnodeGlobalAttribute] AS [Extent4] ON [Extent3].[GlobalAttributeId] = [Extent4].[GlobalAttributeId]	
			INNER JOIN [dbo].[ZnodePortalGlobalAttributeValueLocale] AS [Extent5] ON [Extent3].[PortalGlobalAttributeValueId] = [Extent5].[PortalGlobalAttributeValueId]
			WHERE N''true'' = [Extent5].[AttributeValue]
			and ([Extent1].[IsActive] = 1) AND ([Extent1].[ApplicationType] IN (''WebStore'',''WebstorePreview'')) AND ( [Extent4].[AttributeCode] in (''IsCloudflareEnabled'' ,''CloudflareZoneId'')) 
		

			 )
			 ,Cte_DomainStatus AS 
			 (
			SELECT DomainId , PortalId ,ApiKey,DomainName ,IsActive ,ApplicationType ,IsDefault,StoreName,PortalGlobalAttributeValueId,AttributeValue ,GlobalAttributeId ,
			AttributeCode, '+[dbo].[Fn_GetPagingRowId](@Order_BY,'PortalId  DESC')+',Count(*) over() CountId  FROM Cte_Domain 
			WHERE 1=1 '+[dbo].[Fn_GetFilterWhereClause](@WhereClause)+' 
			)	 
			SELECT DomainId , PortalId ,ApiKey,DomainName ,IsActive ,ApplicationType ,IsDefault,StoreName,PortalGlobalAttributeValueId,AttributeValue ,GlobalAttributeId ,
			AttributeCode,CountId,RowID
			FROM Cte_DomainStatus
			'+[dbo].[Fn_GetPaginationWhereClause](@PageNo,@Rows)
	
	         PRINT @SQL
			 INSERT INTO @TBL_Domainid (DomainId , PortalId ,ApiKey,DomainName ,IsActive ,ApplicationType ,IsDefault,StoreName,PortalGlobalAttributeValueId,AttributeValue ,GlobalAttributeId ,
			 AttributeCode,CountId,RowID)
			 EXEC (@SQL)

			 SET @RowsCount = ISNULL((SELECT top 1 CountId FROM @TBL_Domainid),0)

		 
			 SELECT DomainId ,PortalId ,ApiKey,DomainName ,IsActive ,ApplicationType ,IsDefault,StoreName,PortalGlobalAttributeValueId,AttributeValue ,GlobalAttributeId ,
		     AttributeCode
			 FROM @TBL_Domainid
	 
		 END TRY 
		 BEGIN CATCH 
			DECLARE @Status BIT ;
			SET @Status = 0;
			DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetDomainList @WhereClause = '+@WhereClause+',@Rows='+CAST(@Rows AS
			VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
			SELECT 0 AS ID,CAST(0 AS BIT) AS Status; 
			select ERROR_MESSAGE()

			EXEC Znode_InsertProcedureErrorLog
					@ProcedureName = 'Znode_GetDomainList',
					@ErrorInProcedure = @Error_procedure,
					@ErrorMessage = @ErrorMessage,
					@ErrorLine = @ErrorLine,
					@ErrorCall = @ErrorCall;
		 END CATCH 
   END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPaymentSettingByUserDetails')
	DROP PROC Znode_GetPaymentSettingByUserDetails
GO

CREATE PROCEDURE [dbo].[Znode_GetPaymentSettingByUserDetails]
(
	@PortalId	INT,
	@UserId		INT,
	@RowsCount  INT OUT
)
AS
/*
	Summary: This Procedure is used to get payment details according to associated profile or portal.

	Unit Testing:

	EXEC [Znode_GetPaymentSettingByUserDetails] @PortalId=1, @UserId=1, @RowsCount=0
*/	
BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
		DECLARE @GuestProfileId INT;

		SELECT TOP 1 @GuestProfileId=ProfileId FROM ZnodeProfile WHERE ProfileName = 'Anonymous' AND @UserId = -1

		IF OBJECT_ID('tempdb..#ZnodePortalPaymentApprovers') IS NOT NULL
			DROP TABLE #ZnodePortalPaymentApprovers
		--Getting the payment portal approver details
		SELECT PaymentSettingId ,ZPPG.PortalPaymentGroupId,ZPA.PortalId 
		INTO #ZnodePortalPaymentApprovers
		FROM ZnodePortalPaymentApprovers ZPPA 
		INNER JOIN [ZnodePortalPaymentGroup] ZPPG ON( ZPPA.PortalPaymentGroupId = ZPPG.PortalPaymentGroupId)
		INNER JOIN [ZnodePortalApproval] ZPA ON (ZPA.PortalApprovalId = ZPPG.PortalApprovalId) 
		WHERE ZPA.EnableApprovalManagement =1 AND ZPA.PortalId = @PortalId AND ZPPG.isActive = 1 
	
		--When any User Profile is associated with the user account
		--OR When User is associated with single Profile.
		--OR When two or more User Profiles are associated with the user account
		IF (EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP 
					INNER JOIN ZnodePortalProfile ZPP ON ZUP.ProfileId=ZPP.ProfileId
					INNER JOIN ZnodeProfilePaymentSetting ZPS ON ZUP.ProfileId=ZPS.ProfileId
					INNER JOIN ZnodePortalPaymentSetting ZPS1 ON ZPP.PortalId=ZPS1.PortalId
					WHERE ZUP.UserId=@UserId AND ZPP.PortalId=@PortalId)

			OR EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP 
					INNER JOIN ZnodePortalProfile ZPP ON ZUP.ProfileId=ZPP.ProfileId
					INNER JOIN ZnodeProfilePaymentSetting ZPS ON ZUP.ProfileId=ZPS.ProfileId
					INNER JOIN ZnodePortalPaymentSetting ZPS1 ON ZPP.PortalId=ZPS1.PortalId
					WHERE ZUP.ProfileId=@GuestProfileId AND ZPP.PortalId=@PortalId)
			)
		BEGIN
			IF EXISTS (	SELECT TOP 1 1 
						FROM ZnodePaymentSetting ZPS
						INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
						LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
						INNER JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId )
						INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
						INNER JOIN ZnodeProfile ZP ON ZP.ProfileId = YOPU.ProfileId
						INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
						WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1 AND
							(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId AND YOPU.ProfileId = ZUP.ProfileId)
							OR EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE @UserId = -1 AND ZUP.ProfileId = @GuestProfileId)))
			BEGIN
				SELECT DISTINCT ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,
					ZPS.IsActive,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,
					ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate,ZPPS.PortalId,ZP1.StoreName, 
					NULL IsAssociated ,YOPU.ProfileId,ZP.ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName,
						CASE WHEN @PortalId > 0 AND ZPPS.PaymentDisplayName IS NOT NULL
							THEN ZPPS.PaymentDisplayName ELSE ZPS.PaymentDisplayName END PaymentDisplayName, 
					NULL PaymentExternalId, CAST(CASE WHEN YU.PaymentSettingId IS NOT NULL THEN 1 ELSE 0 END As BIT) AS IsApprovalRequired,
					ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,
					YU.PortalPaymentGroupId,'' AS PublishState
					--, ISNULL(ZPPOS.DisplayName,'Production' ) PublishState 
				FROM ZnodePaymentSetting ZPS
				INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				INNER JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId )
				INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
				INNER JOIN ZnodeProfile ZP ON ZP.ProfileId = YOPU.ProfileId
				INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
				LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId) 
				--LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = '+CASE WHEN CAST(@ProfileId AS VARCHAr(200)) > '0' AND EXISTS (SELECT TOP 1 1 FROM ZnodeProfilePaymentSetting NT WHERE NT.ProfileId = @ProfileId ) 
				--THEN ' YOPU.PublishStateId ' ELSE ' ZPPS.PublishStateId ' END +') 
				WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1 AND
					(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId AND YOPU.ProfileId = ZUP.ProfileId)
					OR EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE @UserId = -1 AND ZUP.ProfileId = @GuestProfileId));

				SET @RowsCount=@@ROWCOUNT
			END
			ELSE
			BEGIN
				SELECT DISTINCT ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,
					ZPS.IsActive,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,
					ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate,ZPPS.PortalId,ZP1.StoreName, 
					NULL IsAssociated ,YOPU.ProfileId,ZP.ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName,
						CASE WHEN @PortalId > 0 AND ZPPS.PaymentDisplayName IS NOT NULL
							THEN ZPPS.PaymentDisplayName ELSE ZPS.PaymentDisplayName END PaymentDisplayName, 
					NULL PaymentExternalId, CAST(CASE WHEN YU.PaymentSettingId IS NOT NULL THEN 1 ELSE 0 END As BIT) AS IsApprovalRequired,
					ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,
					YU.PortalPaymentGroupId,'' AS PublishState
					--, ISNULL(ZPPOS.DisplayName,'Production' ) PublishState 
				FROM ZnodePaymentSetting ZPS
				INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				LEFT JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId )
				INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
				LEFT JOIN ZnodeProfile ZP ON ZP.ProfileId = YOPU.ProfileId
				INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
				LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
				WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1 AND
					(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId AND YOPU.ProfileId = ZUP.ProfileId)
					OR EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE @UserId = -1 AND ZUP.ProfileId = @GuestProfileId));

				SET @RowsCount=@@ROWCOUNT
			END
		END
		--When User is associated with Profile but this Profile is not associated with any portal.
		ELSE IF EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE ((ZUP.UserId = @UserId AND ZUP.ProfileId IS NOT NULL) OR (@UserId = -1 AND ZUP.ProfileId = @GuestProfileId))
							AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalProfile WHERE ProfileId=ZUP.ProfileId AND PortalId=@PortalId))
		BEGIN
			SELECT DISTINCT ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,
				ZPS.IsActive,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,
				ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate,ZPPS.PortalId,ZP1.StoreName, 
				NULL IsAssociated, NULL As ProfileId,ZP.ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName,
					CASE WHEN @PortalId > 0 AND ZPPS.PaymentDisplayName IS NOT NULL
						THEN ZPPS.PaymentDisplayName ELSE ZPS.PaymentDisplayName END PaymentDisplayName, 
				NULL PaymentExternalId, CAST(CASE WHEN YU.PaymentSettingId IS NOT NULL THEN 1 ELSE 0 END As BIT) AS IsApprovalRequired,
				ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,
				YU.PortalPaymentGroupId,'' AS PublishState
				--, ISNULL(ZPPOS.DisplayName,'Production' ) PublishState 
			FROM ZnodePaymentSetting ZPS
			INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
			LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
			LEFT JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId )
			INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
			LEFT JOIN ZnodeProfile ZP ON ZP.ProfileId = YOPU.ProfileId
			INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
			LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId) 
			--LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = '+CASE WHEN CAST(@ProfileId AS VARCHAr(200)) > '0' AND EXISTS (SELECT TOP 1 1 FROM ZnodeProfilePaymentSetting NT WHERE NT.ProfileId = @ProfileId ) 
			--THEN ' YOPU.PublishStateId ' ELSE ' ZPPS.PublishStateId ' END +') 
			WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1 AND
				(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId)
				OR EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE @UserId = -1 AND ZUP.ProfileId = @GuestProfileId));

			SET @RowsCount=@@ROWCOUNT;
		END
		--When User is not associated with any Profile.
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE (ZUP.UserId = @UserId OR (@UserId = -1 AND ZUP.ProfileId = @GuestProfileId)))
		BEGIN
			SELECT DISTINCT ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,
				ZPS.IsActive,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,
				ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate,ZPPS.PortalId,ZP1.StoreName, 
				NULL IsAssociated ,NULL ProfileId,ZP.ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName,
					CASE WHEN @PortalId > 0 AND ZPPS.PaymentDisplayName IS NOT NULL
						THEN ZPPS.PaymentDisplayName ELSE ZPS.PaymentDisplayName END PaymentDisplayName, 
				NULL PaymentExternalId, CAST(CASE WHEN YU.PaymentSettingId IS NOT NULL THEN 1 ELSE 0 END As BIT) AS IsApprovalRequired,
				ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,
				YU.PortalPaymentGroupId,'' AS PublishState
				--, ISNULL(ZPPOS.DisplayName,'Production' ) PublishState 
			FROM ZnodePaymentSetting ZPS
			INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
			LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
			LEFT JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId )
			INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
			LEFT JOIN ZnodeProfile ZP ON ZP.ProfileId = YOPU.ProfileId
			INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
			LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId) 
			--LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = '+CASE WHEN CAST(@ProfileId AS VARCHAr(200)) > '0' AND EXISTS (SELECT TOP 1 1 FROM ZnodeProfilePaymentSetting NT WHERE NT.ProfileId = @ProfileId ) 
			--THEN ' YOPU.PublishStateId ' ELSE ' ZPPS.PublishStateId ' END +') 
			WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1
				AND ((ISNULL(@GuestProfileId,0)=0 AND ZP.ProfileName<>'Anonymous') OR (ISNULL(@GuestProfileId,0)<>0 AND ZP.ProfileName='Anonymous'))

			SET @RowsCount=@@ROWCOUNT
		END

		ELSE
		BEGIN
			SELECT DISTINCT ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,
				ZPS.IsActive,ZPS.DisplayOrder AS DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,
				ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate,ZPPS.PortalId,ZP1.StoreName, NULL IsAssociated ,NULL AS ProfileId,
				NULL AS ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName,
				CASE WHEN @PortalId > 0 AND ZPPS.PaymentDisplayName IS NOT NULL
					THEN ZPPS.PaymentDisplayName ELSE ZPS.PaymentDisplayName END PaymentDisplayName, 
				NULL PaymentExternalId, CAST(CASE WHEN YU.PaymentSettingId IS NOT NULL THEN 1 ELSE 0 END As BIT) AS IsApprovalRequired,
				ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,
				YU.PortalPaymentGroupId,'' AS PublishState	--, ISNULL(ZPPOS.DisplayName,'Production' ) PublishState 
			FROM ZnodePaymentSetting ZPS
			INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
			LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
			INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
			INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
			LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
			--LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = '+CASE WHEN CAST(@ProfileId AS VARCHAr(200)) > '0' AND EXISTS (SELECT TOP 1 1 FROM ZnodeProfilePaymentSetting NT WHERE NT.ProfileId = @ProfileId ) 
			--THEN ' YOPU.PublishStateId ' ELSE ' ZPPS.PublishStateId ' END +') 
			WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1

			SET @RowsCount=@@ROWCOUNT
		END
	END TRY
	BEGIN CATCH
		DECLARE @Status BIT;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(),
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPaymentSettingByUserDetails @PortalId='+CAST(@PortalId AS VARCHAR(50))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50));

		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_GetPaymentSettingByUserDetails',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetShippingListByUserDetails')
	DROP PROC Znode_GetShippingListByUserDetails
GO

CREATE PROCEDURE [dbo].[Znode_GetShippingListByUserDetails]
(
	@PortalId	INT,
	@UserId		INT,
	@RowsCount  INT OUT
)
AS
/*
	Summary: This Procedure is used to get shipping details according to associated profile or portal.

	Unit Testing:

	EXEC [Znode_GetShippingListByUserDetails]  @PortalId=1, @UserId=1, @RowsCount=0
*/
BEGIN
	BEGIN TRY
		SET NOCOUNT ON;
		DECLARE @GuestProfileId INT;

		SELECT TOP 1 @GuestProfileId=ProfileId FROM ZnodeProfile WHERE ProfileName = 'Anonymous' AND @UserId = -1

		--When any User Profile is associated with the user account
		--OR When User is associated with single Profile.
		--OR When two or more User Profiles are associated with the user account
		IF (EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP 
					INNER JOIN ZnodePortalProfile ZPP ON ZUP.ProfileId=ZPP.ProfileId
					INNER JOIN ZnodeProfileShipping ZPS ON ZUP.ProfileId=ZPS.ProfileId
					INNER JOIN ZnodePortalShipping ZPS1 ON ZPP.PortalId=ZPS1.PortalId
					WHERE ZUP.UserId=@UserId AND ZPP.PortalId=@PortalId)

			OR EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP 
					INNER JOIN ZnodePortalProfile ZPP ON ZUP.ProfileId=ZPP.ProfileId
					INNER JOIN ZnodeProfileShipping ZPS ON ZUP.ProfileId=ZPS.ProfileId
					INNER JOIN ZnodePortalShipping ZPS1 ON ZPP.PortalId=ZPS1.PortalId
					WHERE ZUP.ProfileId=@GuestProfileId AND ZPP.PortalId=@PortalId)
			)
		BEGIN
			IF EXISTS (SELECT TOP 1 1
						FROM ZnodeShipping ZS
						INNER JOIN ZnodeShippingTypes ZST ON (ZST.ShippingTypeId = ZS.ShippingTypeId)
						INNER JOIN ZnodeProfileShipping ZPP ON (ZPP.ShippingId = ZS.ShippingId)
						INNER JOIN ZnodePortalShipping ZPS ON (@PortalId=ZPS.PortalId AND ZS.ShippingId = ZPS.ShippingId)
						INNER JOIN ZnodeProfile ZP ON ZP.ProfileId = ZPP.ProfileId
						INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPS.PortalId
						WHERE ZPS.PortalId = @PortalId AND ZS.IsActive=1 AND
							(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId AND ZPP.ProfileId = ZUP.ProfileId)
							OR EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE @UserId = -1 AND ZUP.ProfileId = @GuestProfileId))
						)
			BEGIN
				SELECT DISTINCT ZPP.ProfileId, ZP.ProfileName,ZPS.PortalId, ZP1.StoreName,ZS.ShippingId,ZS.ShippingTypeId,ZS.ShippingCode,
					ZS.HandlingCharge,ZS.HandlingChargeBasedOn,ZS.DestinationCountryCode,ZS.StateCode,ZS.CountyFIPS,ZS.Description,
					ZS.IsActive,ISNULL(ZPP.DisplayOrder, ZS.DisplayOrder) DisplayOrder,ZS.ZipCode,ZS.CreatedDate,ZS.ModifiedDate, 
					NULL IsAssociated ,ZST.Name ShippingTypeName , ZPS.PortalShippingId, ZPP.ProfileShippingId,ZS.ShippingName,
					ZST.ClassName,ZS.DeliveryTimeframe
				FROM ZnodeShipping ZS
				INNER JOIN ZnodeShippingTypes ZST ON (ZST.ShippingTypeId = ZS.ShippingTypeId)
				INNER JOIN ZnodeProfileShipping ZPP ON (ZPP.ShippingId = ZS.ShippingId)
				INNER JOIN ZnodePortalShipping ZPS ON (@PortalId=ZPS.PortalId AND ZS.ShippingId = ZPS.ShippingId)
				INNER JOIN ZnodeProfile ZP ON ZP.ProfileId = ZPP.ProfileId
				INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPS.PortalId
				WHERE ZPS.PortalId = @PortalId AND ZS.IsActive=1 AND
					(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId AND ZPP.ProfileId = ZUP.ProfileId)
					OR EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE @UserId = -1 AND ZUP.ProfileId = @GuestProfileId));

				SET @RowsCount=@@ROWCOUNT
			END

			ELSE
			BEGIN
				SELECT DISTINCT ZPP.ProfileId, ZP.ProfileName,ZPS.PortalId, ZP1.StoreName,ZS.ShippingId,ZS.ShippingTypeId,ZS.ShippingCode,
					ZS.HandlingCharge,ZS.HandlingChargeBasedOn,ZS.DestinationCountryCode,ZS.StateCode,ZS.CountyFIPS,ZS.Description,
					ZS.IsActive,ISNULL(ZPP.DisplayOrder, ZS.DisplayOrder) DisplayOrder,ZS.ZipCode,ZS.CreatedDate,ZS.ModifiedDate, 
					NULL IsAssociated ,ZST.Name ShippingTypeName , ZPS.PortalShippingId, ZPP.ProfileShippingId,ZS.ShippingName,
					ZST.ClassName,ZS.DeliveryTimeframe
				FROM ZnodeShipping ZS
				INNER JOIN ZnodeShippingTypes ZST ON (ZST.ShippingTypeId = ZS.ShippingTypeId)
				LEFT JOIN ZnodeProfileShipping ZPP ON (ZPP.ShippingId = ZS.ShippingId)
				INNER JOIN ZnodePortalShipping ZPS ON (@PortalId=ZPS.PortalId AND ZS.ShippingId = ZPS.ShippingId)
				LEFT JOIN ZnodeProfile ZP ON ZP.ProfileId = ZPP.ProfileId
				INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPS.PortalId
				WHERE ZPS.PortalId = @PortalId AND ZS.IsActive=1 AND
					(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId)
					OR EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE @UserId = -1 AND ZUP.ProfileId = @GuestProfileId));
				
				SET @RowsCount=@@ROWCOUNT
			END
		END
		--When User is associated with Profile but this Profile is not associated with any portal.
		ELSE IF EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE ((ZUP.UserId = @UserId AND ZUP.ProfileId IS NOT NULL) OR (@UserId = -1 AND ZUP.ProfileId = @GuestProfileId))
							AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalProfile WHERE ProfileId=ZUP.ProfileId AND PortalId=@PortalId))
		BEGIN
			SELECT DISTINCT ZPP.ProfileId, ZP.ProfileName,ZPS.PortalId, ZP1.StoreName,ZS.ShippingId,ZS.ShippingTypeId,ZS.ShippingCode,
				ZS.HandlingCharge,ZS.HandlingChargeBasedOn,ZS.DestinationCountryCode,ZS.StateCode,ZS.CountyFIPS,ZS.Description,
				ZS.IsActive,ISNULL(ZPP.DisplayOrder, ZS.DisplayOrder) DisplayOrder,ZS.ZipCode,ZS.CreatedDate,ZS.ModifiedDate, 
				NULL IsAssociated ,ZST.Name ShippingTypeName , ZPS.PortalShippingId, ZPP.ProfileShippingId,ZS.ShippingName,
				ZST.ClassName,ZS.DeliveryTimeframe
			FROM ZnodeShipping ZS
			INNER JOIN ZnodeShippingTypes ZST ON (ZST.ShippingTypeId = ZS.ShippingTypeId)
			INNER JOIN ZnodeProfileShipping ZPP ON (ZPP.ShippingId = ZS.ShippingId)
			LEFT JOIN ZnodePortalShipping ZPS ON (@PortalId=ZPS.PortalId AND ZS.ShippingId = ZPS.ShippingId)
			INNER JOIN ZnodeProfile ZP ON ZP.ProfileId = ZPP.ProfileId
			LEFT JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPS.PortalId
			WHERE ZPS.PortalId = @PortalId AND ZS.IsActive=1 AND
				(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId)
				OR EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE @UserId = -1 AND ZUP.ProfileId = @GuestProfileId))

			SET @RowsCount=@@ROWCOUNT
		END
		--When User is not associated with any Profile.
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE (ZUP.UserId = @UserId OR (@UserId = -1 AND ZUP.ProfileId = @GuestProfileId)))
		BEGIN
			SELECT DISTINCT ZPP.ProfileId, ZP.ProfileName, ZPS.PortalId, ZP1.StoreName,ZS.ShippingId,ZS.ShippingTypeId,ZS.ShippingCode,
				ZS.HandlingCharge,ZS.HandlingChargeBasedOn,ZS.DestinationCountryCode,ZS.StateCode,ZS.CountyFIPS,ZS.Description,
				ZS.IsActive,ISNULL(ZPP.DisplayOrder, ZS.DisplayOrder) DisplayOrder,ZS.ZipCode,ZS.CreatedDate,ZS.ModifiedDate, 
				NULL IsAssociated ,ZST.Name ShippingTypeName , ZPS.PortalShippingId, ZPP.ProfileShippingId,ZS.ShippingName,
				ZST.ClassName,ZS.DeliveryTimeframe
			FROM ZnodeShipping ZS
			INNER JOIN ZnodeShippingTypes ZST ON (ZST.ShippingTypeId = ZS.ShippingTypeId)
			LEFT JOIN ZnodeProfileShipping ZPP ON (ZPP.ShippingId = ZS.ShippingId)
			INNER JOIN ZnodePortalShipping ZPS ON (@PortalId=ZPS.PortalId AND ZS.ShippingId = ZPS.ShippingId)
			LEFT JOIN ZnodeProfile ZP ON ZP.ProfileId = ZPP.ProfileId
			INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPS.PortalId
			WHERE ZPS.PortalId = @PortalId AND ZS.IsActive=1
				AND ((ISNULL(@GuestProfileId,0)=0 AND ZP.ProfileName<>'Anonymous') OR (ISNULL(@GuestProfileId,0)<>0 AND ZP.ProfileName='Anonymous'))

			SET @RowsCount=@@ROWCOUNT
		END
		ELSE
		BEGIN
			SELECT DISTINCT NULL ProfileId,NULL ProfileName, ZPS.PortalId, ZP1.StoreName,ZS.ShippingId,ZS.ShippingTypeId,ZS.ShippingCode,
				ZS.HandlingCharge,ZS.HandlingChargeBasedOn,ZS.DestinationCountryCode,ZS.StateCode,ZS.CountyFIPS,ZS.Description,
				ZS.IsActive,ISNULL(ZS.DisplayOrder,'') DisplayOrder,ZS.ZipCode,ZS.CreatedDate,ZS.ModifiedDate, 
				NULL IsAssociated ,ZST.Name ShippingTypeName, ZPS.PortalShippingId, NULL ProfileShippingId,ZS.ShippingName,
				ZST.ClassName,ZS.DeliveryTimeframe
			FROM ZnodeShipping ZS
			INNER JOIN ZnodeShippingTypes ZST ON (ZST.ShippingTypeId = ZS.ShippingTypeId)
			INNER JOIN ZnodePortalShipping ZPS ON (@PortalId=ZPS.PortalId AND ZS.ShippingId = ZPS.ShippingId)
			INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPS.PortalId
			WHERE ZPS.PortalId = @PortalId AND ZS.IsActive=1

			SET @RowsCount=@@ROWCOUNT
		END
	END TRY
	BEGIN CATCH
		DECLARE @Status BIT;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(),
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetShippingListByUserDetails @PortalId='+CAST(@PortalId AS VARCHAR(50))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50));

        SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

        EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_GetShippingListByUserDetails',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS ( SELECT TOP 1 1 FROM ZnodeCurrency WHERE CurrencyName = 'Serbian Dinar' AND CurrencyCode = '')
BEGIN
	UPDATE ZnodeCurrency 
	SET CurrencyCode = 'RSD'
	WHERE CurrencyName = 'Serbian Dinar' AND CurrencyCode = ''
END

GO

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'Store','AssociateOfflinePaymentSetting',1,2,Getdate(),2,Getdate()
where not exists(select * from ZnodeActions where ControllerName = 'Store' and ActionName = 'AssociateOfflinePaymentSetting')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
 (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Stores' AND ControllerName = 'Store')
    ,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Store' and ActionName= 'AssociateOfflinePaymentSetting') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
     (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Stores' AND ControllerName = 'Store') and ActionId =
     (select TOP 1 ActionId from ZnodeActions where ControllerName = 'Store' and ActionName= 'AssociateOfflinePaymentSetting'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Stores' AND ControllerName = 'Store')
,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Store' and ActionName= 'AssociateOfflinePaymentSetting')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Stores' AND ControllerName = 'Store') and ActionId =
     (select TOP 1 ActionId from ZnodeActions where ControllerName = 'Store' and ActionName= 'AssociateOfflinePaymentSetting'))

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportVoucher')
	DROP PROC Znode_ImportVoucher
GO

CREATE PROCEDURE [dbo].[Znode_ImportVoucher](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN Voucher;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		-- Retrive RoundOff Value from global setting 

		DECLARE @InsertVoucherData TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY,RowNumber int, StoreCode varchar(400),VoucherName varchar(600), VoucherNumber varchar(600),
			VoucherAmount varchar(600),UserName varchar(600), ExpirationDate Datetime,IsActive varchar(100),RemainingAmount varchar(600),
			RestrictVoucherToACustomer varchar(100), StartDate datetime, GUID nvarchar(400)
		);
		
		SET @SSQL = 'Select RowNumber,StoreCode, VoucherName,VoucherNumber,VoucherAmount,UserName,ExpirationDate,
						IsActive,RemainingAmount,RestrictVoucherToACustomer,StartDate,GUID FROM '+@TableName;
		INSERT INTO @InsertVoucherData( RowNumber,StoreCode, VoucherName,VoucherNumber,VoucherAmount,UserName,ExpirationDate,
										IsActive,RemainingAmount,RestrictVoucherToACustomer,StartDate,GUID)
		EXEC sys.sp_sqlexec @SSQL;

		select ANZU.UserName, ANU.Id, ZU.UserId
		into #TempUserData
		from AspNetZnodeUser ANZU 
		inner join AspNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName
		inner join ZnodeUser ZU ON ANU.Id = ZU.AspNetUserId

		select ZUP.PortalId, ZUP.UserId, ZP.StoreCode
		into #TempUserPortal
		from ZnodeUserPortal ZUP 
		INNER JOIN ZnodePortal ZP ON ZUP.PortalId = ZP.PortalId

		update @InsertVoucherData set VoucherNumber = [dbo].[Fn_RandomString](10)
		where isnull(ltrim(rtrim(VoucherNumber)),'') = ''

		-- Start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '70', 'StoreCode', StoreCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE ii.StoreCode not in 
			   (
				   SELECT StoreCode FROM ZnodePortal 
			   );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '65', 'ExpirationDate', ExpirationDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE (ii.ExpirationDate < ii.StartDate OR ii.ExpirationDate < @GetDate)

		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--	   SELECT '65', 'ExpirationDate', ExpirationDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		--	   FROM @InsertVoucherData AS ii
		--	   WHERE ii.ExpirationDate < @GetDate

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '8', 'StartDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE isnull(ii.StartDate,'') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '8', 'ExpirationDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE isnull(ii.ExpirationDate,'') = ''
		
		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--	   SELECT '67', 'UserName', UserName, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		--	   FROM @InsertVoucherData AS ii
		--	   WHERE isnull(ii.UserName,'') <> '' and not exists ( SELECT VoucherNumber FROM #TempUserData U where ii.UserName = U.UserName);
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '67', 'UserName', UserName, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii			 
			   WHERE isnull(ii.UserName,'') <> '' 
			   and not exists ( SELECT * FROM #TempUserData U where ii.UserName = U.UserName 
			   and not exists(select * from #TempUserPortal UP where U.UserId = UP.UserId and ii.StoreCode = UP.StoreCode))
			 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '71', 'VoucherNumber', VoucherNumber, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE len(ltrim(rtrim(ii.VoucherNumber))) <> 10 
	
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No','')
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '5', 'ExpirationDate', ExpirationDate, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			WHERE isdate(ii.ExpirationDate) = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '5', 'StartDate', StartDate, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			WHERE isdate(ii.StartDate) = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '69', 'RemainingAmount', RemainingAmount, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			WHERE ii.VoucherAmount <> ii.RemainingAmount

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'RestrictVoucherToACustomer', RestrictVoucherToACustomer, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			WHERE ii.RestrictVoucherToACustomer not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT distinct '2', 'VoucherAmount', VoucherAmount, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			CROSS APPLY ZnodeCulture b
			WHERE  VoucherAmount like '%[a-z]%' or VoucherAmount like '%'+b.Symbol+'%'
			and b.Symbol is not null 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT distinct '2', 'RemainingAmount', RemainingAmount, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii
			CROSS APPLY ZnodeCulture b
			WHERE  RemainingAmount like '%[a-z]%' or RemainingAmount like '%'+b.Symbol+'%'
			and b.Symbol is not null 


		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ VoucherName - ' + ISNULL(VoucherName,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN @InsertVoucherData IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertVoucherData
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertVoucherData
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;
	
		UPDATE ZGC set ExpirationDate = ICD.ExpirationDate, UserId = ZU.UserId, ModifiedBy = @UserId, ModifiedDate = @GetDate, IsActive = ICD.IsActive,
				RemainingAmount = ICD.RemainingAmount, RestrictToCustomerAccount = ICD.RestrictVoucherToACustomer, Name = ICD.VoucherName, StartDate = ICD.StartDate
		from ZnodeGiftCard ZGC
		inner join @InsertVoucherData ICD ON ICD.VoucherNumber = ZGC.CardNumber
		inner join ZnodePortal ZP ON ICD.StoreCode = ZP.StoreCode and ZGC.PortalId = ZP.PortalId
		left join #TempUserData ZU ON ICD.UserName = ZU.UserName

		insert into ZnodeGiftCard(PortalId,Name,CardNumber,Amount,UserId,ExpirationDate,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsActive,RemainingAmount,RestrictToCustomerAccount,StartDate)
		select ZP.PortalId, ICD.VoucherName, ICD.VoucherNumber, ICD.VoucherAmount, ZU.UserId, ICD.ExpirationDate, @UserId, @Getdate, @UserId, @Getdate, ICD.IsActive, ICD.RemainingAmount, ICD.RestrictVoucherToACustomer, ICD.StartDate
		From @InsertVoucherData ICD 
		inner join ZnodePortal ZP ON ICD.StoreCode = ZP.StoreCode 
		left join #TempUserData ZU ON ICD.UserName = ZU.UserName
		where not exists(select * from ZnodeGiftCard ZGC where ICD.VoucherNumber = ZGC.CardNumber )

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN Voucher;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN Voucher

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		 DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportVoucher @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));

		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportVoucher',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetProductFeedList')
	DROP PROC Znode_GetProductFeedList
GO

CREATE PROCEDURE [dbo].[Znode_GetProductFeedList]  
		(
		@PortalId   VARCHAR(2000) = NULL,  
		@SKU  SelectColumnList READONLY,  
		@LocaleId   INT,  
		@FeedType   NVARCHAR(MAX) = NULL   
		)
		AS  
/*  
Summary: This Procedure is used to get effective keyword feeding of Product list  
 SELECT * FROM ZnodePublishProductDetail  
 SELECT * FROM ZnodePublishProduct WHERE PublishCatalogId = 3  
 SELECT * FROM ZnodePortalCatalog   
 Unit Testing:  
 EXEC [Znode_GetProductFeedList] @PortalId='0',@ProductIds = '116,117,118'  
 ,@LocaleId=1,@FeedType='Bing'   
  
		*/  
		BEGIN  
		BEGIN TRY  
		SET NOCOUNT ON;        
           
		IF OBJECT_ID('tempdb..#TBL_DomainName') IS NOT NULL
		DROP TABLE #TBL_DomainName

		IF OBJECT_ID('tempdb..#TBL_SEODetails') IS NOT NULL
		DROP TABLE #TBL_SEODetails

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_PortalIds') IS NOT NULL
		DROP TABLE #TBL_PortalIds

		DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
		CREATE TABLE #TBL_DomainName 
		(PortalId   INT,
		DomainName NVARCHAR(300),
		RowId      INT
		);  	
         
		CREATE TABLE #TBL_SEODetails   
		(loc                   NVARCHAR(MAX),  
		lastmod               DATETIME,  
		[g:condition]         VARCHAR(100),  
		[description]         NVARCHAR(MAX),  
		[g:id]                INT,  
		link                  VARCHAR(100),  
		[g:identifier_exists] VARCHAR(200),  
		DomainName            NVARCHAR(300),  
		PortalId              INT , 
		SEOCode             NVARCHAR(4000), 
		CanonicalURL        VARCHAR(200), 
		RobotTag            VARCHAR(50)
		);  
		--CREATE TABLE #TBL_CompleteDetailes   
		--(loc                   NVARCHAR(MAX),  
		--lastmod               DATETIME,  
		--[g:condition]         VARCHAR(100),  
		--[description]         NVARCHAR(MAX),  
		--[g:id]                INT,  
		--link                  VARCHAR(100),  
		--[g:identifier_exists] VARCHAR(200),  
		--DomainName            NVARCHAR(300),  
		--PortalId              INT,  
		--[g:availability]      NVARCHAR(1000),  
		--SKU                   NVARCHAR(1000),  
		--SEOCode               NVARCHAR(4000),
		--CanonicalURL        VARCHAR(200), 
		--RobotTag            VARCHAR(50) 
		--);  
		DECLARE @DefaultLocaleId INT=dbo.Fn_GetDefaultLocaleId()  ;
		CREATE TABLE #TBL_PortalIds (PortalId INT);  
			
		select * into #SKU from @SKU
		create index IDX_#SKU on #SKU(StringColumn)
		
		INSERT INTO #TBL_PortalIds  
		SELECT Zp.PortalId   
		FROM Znodeportal AS ZP   
		INNER JOIN ZnodePortalCatalog AS ZPC ON(ZPC.PortalId = Zp.PortalId)  
		INNER JOIN ZnodePublishCatalog AS ZPPC ON(ZPPC.PublishCatalogId = ZPC.PublishCatalogId)   
		INNER JOIN ZNodePublishProduct AS ZPP ON(ZPP.PublishCatalogId = ZPPC.PublishCatalogId)  
		INNER JOIN ZnodePublishProductDetail AS PPD ON (PPD.PublishProductId = ZPP.PublishProductId)  
		WHERE EXISTS(SELECT TOP 1 1 FROM #SKU AS Sp WHERE sp.StringColumn  = PPD.SKU OR StringColumn = '0')  
		AND EXISTS(SELECT TOP 1 1 FROM DBO.Split(@PortalId, ',') AS Sp  
		WHERE(CAST(sp.Item AS INT)) = Zp.PortalId  OR @PortalId = '0')  
		AND EXISTS (SELECT TOP 1 1 FROM ZnodeDomain ZD WHERE ZP.PortalId = ZD.PortalId  
		AND IsActive = 1 AND ApplicationType = 'Webstore' AND IsDefault = 1)  
		GROUP BY Zp.PortalId;   
		
		INSERT INTO #TBL_DomainName   
		SELECT  PortalId,DomainName,ROW_NUMBER() OVER(PARTITION BY PortalId ORDER BY DomainName)   
		FROM ZnodeDomain AS ZD   
		WHERE EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZD.PortalId)  
		AND IsActive = 1 AND ApplicationType = 'Webstore' AND IsDefault = 1 
 
		IF EXISTS(SELECT * FROM #SKU)
        BEGIN
		    --INSERT INTO #Cte_SeoDetailsWithLocale(CMSSEODetailId ,loc ,lastmod ,[g:condition] ,[description] ,[g:id] ,link ,[g:identifier_exists] ,DomainName ,PortalId,LocaleId ,SEOCode ,CanonicalURL ,RobotTag)
			SELECT DISTINCT ZCSD.CMSSEODetailId,ZCSD.SEOURL AS loc,ZCSD.ModifiedDate AS lastmod,'new' AS [g:condition],ZCSDL.SEODescription AS [description],ZPCC.PublishProductId AS [g:id],  
            '' AS link,'false' AS [g:identifier_exists],TBDN.DomainName,ZPC.PortalId,ISNULL(ZCSDL.LocaleId, @DefaultLocaleId) AS LocaleId , ZCSD.SEOCode , ZCSDL.CanonicalURL, ZCSDL.RobotTag 
			INTO #Cte_SeoDetailsWithLocale
			FROM ZNodePublishProduct AS ZPCC   
			INNER JOIN ZnodePortalCatalog AS ZPC ON(ZPC.PublishCatalogId = ZPCC.PublishCatalogId)  
			LEFT JOIN ZnodePublishProductDetail AS PPD ON (PPD.PublishProductId = ZPCC.PublishProductId)  
			--INNER JOIN @TBL_PortalIds TBLP ON (TBLP.PortalId = ZPC.PortalId)  
			LEFT JOIN ZnodeCMSSEODetail AS ZCSD ON(PPD.SKU = ZCSD.SEOCode and ZCSD.PortalId = ZPC.PortalId)  
			LEFT JOIN ZnodeCMSSEOType AS ZCST ON(ZCST.CMSSEOTypeId = ZCSD.CMSSEOTypeId AND ZCST.Name = 'Product')  
			LEFT JOIN ZnodeCMSSEODetailLocale AS ZCSDL ON(ZCSDL.CMSSEODetailId = ZCSD.CMSSEODetailId AND ZCSDL.LocaleId IN(@LocaleId, @DefaultLocaleId))  
			LEFT JOIN #TBL_DomainName AS TBDN ON(TBDN.RowId = 1 AND TBDN.PortalId = zpc.PortalId )   
			WHERE EXISTS(SELECT TOP 1 1 FROM #SKU AS Sp  
			WHERE (sp.StringColumn  = PPD.SKU) )--OR StringColumn = '0')  
			AND EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZPC.PortalId)  
				
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag  
			INTO #Cte_SeoDetailsWithFirstLocale
			FROM #Cte_SeoDetailsWithLocale   
			WHERE LocaleId = @LocaleId  
    
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode , CanonicalURL, RobotTag 
			INTO #Cte_SeoDetailsWithDefaultLocale
			FROM #Cte_SeoDetailsWithFirstLocale  
			
			INSERT INTO #Cte_SeoDetailsWithDefaultLocale 
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag  
			FROM #Cte_SeoDetailsWithLocale AS CTSDWL  
			WHERE LocaleId = @DefaultLocaleId   
			AND NOT EXISTS(SELECT TOP 1 1 FROM #Cte_SeoDetailsWithFirstLocale AS CTSDWDL WHERE CTSDWDL.CMSSEODetailId = CTSDWL.CMSSEODetailId)  
          
			INSERT INTO #TBL_SEODetails  
			SELECT DISTINCT loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId ,SEOCode, CanonicalURL, RobotTag  
			FROM #Cte_SeoDetailsWithDefaultLocale;  

			--CREATE INDEX Idx_#TBL_SEODetails ON #TBL_SEODetails([g:id])

			SELECT TBSD.loc,TBSD.lastmod,TBSD.[g:condition],TBSD.[description],TBSD.[g:id],TBSD.link,TBSD.[g:identifier_exists],TBSD.DomainName,TBSD.PortalId,  
			CASE WHEN SUM(ZI.Quantity) > 0 THEN 'In Stock' ELSE CASE WHEN @FeedType = 'Google' THEN 'Out Of Stock' ELSE 'Not In Stock' END  
			END AS [g:availability],
			ZPPD.SKU ,TBSD.SEOCode, TBSD.CanonicalURL, TBSD.RobotTag
			INTO #TBL_CompleteDetailes  
			FROM ZnodePublishProduct AS ZPP   
			LEFT JOIN #TBL_SEODetails AS TBSD ON(ZPP.PublishProductId = TBSD.[g:id] )  
			LEFT JOIN ZnodePublishProductDetail AS ZPPD ON(ZPPD.PublishProductId = ZPP.PublishProductId AND ZPPD.LocaleId = @LocaleId)  
			LEFT JOIN ZnodePortalWarehouse AS ZPW ON(ZPW.PortalId = TBSD.PortalId)  
			LEFT JOIN ZnodePortalAlternateWarehouse AS ZAPW ON(ZAPW.PortalWarehouseId = ZPW.PortalWarehouseId)  
			LEFT JOIN ZnodeInventory AS ZI ON(ZI.SKU = ZPPD.SKU AND (ZI.WarehouseId = ZPW.WarehouseId OR ZI.WarehouseId = ZAPW.WarehouseId))  
			WHERE EXISTS(SELECT TOP 1 1 FROM #SKU AS Sp WHERE (sp.StringColumn  = ZPPD.SKU))-- OR sp.StringColumn = '0')
			AND EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = TBSD.PortalId)	
			GROUP BY loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,TBSD.PortalId,ZPPD.SKU,ZPPD.LocaleId, TBSD.SEOCode, TBSD.CanonicalURL, TBSD.RobotTag;    
			
			DECLARE @MediaConfiguration NVARCHAR(2000)=((SELECT TOP 1 ISNULL(CASE WHEN CDNURL = '' THEN NULL ELSE CDNURL END,URL) FROM ZnodeMediaConfiguration WHERE IsActive = 1));    
  
			CREATE INDEX Idx_#TBL_CompleteDetailes ON #TBL_CompleteDetailes(PortalId,SKU)
	
	
			SELECT zp.PortalId,round(ZPS.RetailPrice,2) as RetailPrice,Zps.SKU,tbcd.SEOCode,ROW_NUMBER() OVER(PARTITION BY Zps.SKU,zp.PortalId ORDER BY ZPS.RetailPrice) AS RowId  
			INTO #Cte_PortalList
			FROM ZnodePriceList AS ZPL   
			LEFT JOIN ZnodePriceListPortal AS ZPLP ON ZPL.PriceListId = ZPLP.PriceListId  
			LEFT JOIN ZnodeCulture AS zc ON ZPL.CultureId = zc.CultureId
			LEFT JOIN ZnodePortal AS zp ON ZPLP.PortalId = zp.PortalId  
			LEFT JOIN ZnodePrice AS Zps ON(Zps.PriceListId = ZPL.PriceListId)   
			LEFT JOIN #TBL_CompleteDetailes AS TBCD ON(TBCD.PortalId = Zp.PortalId AND TBCD.SKU = Zps.Sku)   
			WHERE CAST(@GetDate AS DATE) BETWEEN ZPL.ActivationDate AND ZPL.ExpirationDate   
			AND EXISTS( SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZPLP.PortalId)   
			GROUP BY zp.PortalId,ZPS.RetailPrice,Zps.SKU ,TBCD.SEOCode  
 
			SELECT loc,lastmod,[g:condition],[description],[g:id],link,[g:availability],[g:identifier_exists],DomainName,TBCD.PortalId  
			,CTPL.RetailPrice AS [g:price],@MediaConfiguration AS MediaConfiguration, TBCD.SEOCode, TBCD.CanonicalURL, TBCD.RobotTag 
			FROM #TBL_CompleteDetailes AS TBCD   
			LEFT JOIN #Cte_PortalList AS CTPL ON(CTPL.PortalId = TBCD.PortalId AND CTPL.SKU = TBCD.SKU AND CTPL.RowID = 1)  
			WHERE  EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = TBCD.PortalId )  


		END
     	ELSE
		BEGIN
		    --INSERT INTO #Cte_SeoDetailsWithLocale(CMSSEODetailId ,loc ,lastmod ,[g:condition] ,[description] ,[g:id] ,link ,[g:identifier_exists] ,DomainName ,PortalId,LocaleId ,SEOCode ,CanonicalURL ,RobotTag)
			SELECT DISTINCT ZCSD.CMSSEODetailId,ZCSD.SEOURL AS loc,ZCSD.ModifiedDate AS lastmod,'new' AS [g:condition],ZCSDL.SEODescription AS [description],ZPCC.PublishProductId AS [g:id],  
			'' AS link,'false' AS [g:identifier_exists],TBDN.DomainName,ZPC.PortalId,ISNULL(ZCSDL.LocaleId, @DefaultLocaleId) AS LocaleId , ZCSD.SEOCode , ZCSDL.CanonicalURL, ZCSDL.RobotTag 
			INTO #Cte_SeoDetailsWithLocale1
			FROM ZNodePublishProduct AS ZPCC   
			INNER JOIN ZnodePortalCatalog AS ZPC ON(ZPC.PublishCatalogId = ZPCC.PublishCatalogId)  
			LEFT JOIN ZnodePublishProductDetail AS PPD ON (PPD.PublishProductId = ZPCC.PublishProductId)  
			-- INNER JOIN @TBL_PortalIds TBLP ON (TBLP.PortalId = ZPC.PortalId)  
			LEFT JOIN ZnodeCMSSEODetail AS ZCSD ON(PPD.SKU = ZCSD.SEOCode and ZCSD.PortalId = ZPC.PortalId)  
			LEFT JOIN ZnodeCMSSEOType AS ZCST ON(ZCST.CMSSEOTypeId = ZCSD.CMSSEOTypeId AND ZCST.Name = 'Product')  
			LEFT JOIN ZnodeCMSSEODetailLocale AS ZCSDL ON(ZCSDL.CMSSEODetailId = ZCSD.CMSSEODetailId AND ZCSDL.LocaleId IN(@LocaleId, @DefaultLocaleId))  
			LEFT JOIN #TBL_DomainName AS TBDN ON(TBDN.RowId = 1 AND TBDN.PortalId = zpc.PortalId )   
			WHERE EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZPC.PortalId)
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag  
			INTO #Cte_SeoDetailsWithFirstLocale1
			FROM #Cte_SeoDetailsWithLocale1   
			WHERE LocaleId = @LocaleId  
    
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode , CanonicalURL, RobotTag 
			INTO #Cte_SeoDetailsWithDefaultLocale1
			FROM #Cte_SeoDetailsWithFirstLocale1  
			
			INSERT INTO #Cte_SeoDetailsWithDefaultLocale1 
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag  
			FROM #Cte_SeoDetailsWithLocale1 AS CTSDWL  
			WHERE LocaleId = @DefaultLocaleId   
			AND NOT EXISTS(SELECT TOP 1 1 FROM #Cte_SeoDetailsWithFirstLocale AS CTSDWDL WHERE CTSDWDL.CMSSEODetailId = CTSDWL.CMSSEODetailId)  
          
			INSERT INTO #TBL_SEODetails  
			SELECT DISTINCT loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId ,SEOCode, CanonicalURL, RobotTag  
			FROM #Cte_SeoDetailsWithDefaultLocale1;  
		  
			SELECT TBSD.loc,TBSD.lastmod,TBSD.[g:condition],TBSD.[description],TBSD.[g:id],TBSD.link,TBSD.[g:identifier_exists],TBSD.DomainName,TBSD.PortalId,  
			CASE WHEN SUM(ZI.Quantity) > 0 THEN 'In Stock' ELSE CASE WHEN @FeedType = 'Google' THEN 'Out Of Stock' ELSE 'Not In Stock' END  
			END AS [g:availability],
			ZPPD.SKU ,TBSD.SEOCode, TBSD.CanonicalURL, TBSD.RobotTag  
			INTO #TBL_CompleteDetailes1
			FROM ZnodePublishProduct AS ZPP   
			LEFT JOIN #TBL_SEODetails AS TBSD ON(ZPP.PublishProductId = TBSD.[g:id] )  
			LEFT JOIN ZnodePublishProductDetail AS ZPPD ON(ZPPD.PublishProductId = ZPP.PublishProductId AND ZPPD.LocaleId = @LocaleId )  
			LEFT JOIN ZnodePortalWarehouse AS ZPW ON(ZPW.PortalId = TBSD.PortalId)  
			LEFT JOIN ZnodePortalAlternateWarehouse AS ZAPW ON(ZAPW.PortalWarehouseId = ZPW.PortalWarehouseId)  
			LEFT JOIN ZnodeInventory AS ZI ON(ZI.SKU = ZPPD.SKU AND (ZI.WarehouseId = ZPW.WarehouseId OR ZI.WarehouseId = ZAPW.WarehouseId))  
			WHERE EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = TBSD.PortalId )	
			GROUP BY loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,TBSD.PortalId,ZPPD.SKU,ZPPD.LocaleId, TBSD.SEOCode, TBSD.CanonicalURL, TBSD.RobotTag;    
			

			DECLARE @MediaConfiguration1 NVARCHAR(2000)=((SELECT TOP 1 ISNULL(CASE WHEN CDNURL = '' THEN NULL ELSE CDNURL END,URL) FROM ZnodeMediaConfiguration WHERE IsActive = 1));    
  
			CREATE INDEX Idx_#TBL_CompleteDetailes1 ON #TBL_CompleteDetailes(PortalId,SKU)
	
	
			SELECT zp.PortalId,round(ZPS.RetailPrice,2) as RetailPrice,Zps.SKU,tbcd.SEOCode,ROW_NUMBER() OVER(PARTITION BY Zps.SKU,zp.PortalId ORDER BY ZPS.RetailPrice) AS RowId  
			INTO #Cte_PortalList1
			FROM ZnodePriceList AS ZPL   
			LEFT JOIN ZnodePriceListPortal AS ZPLP ON ZPL.PriceListId = ZPLP.PriceListId  
			LEFT JOIN ZnodeCulture AS zc ON ZPL.CultureId = zc.CultureId
			LEFT JOIN ZnodePortal AS zp ON ZPLP.PortalId = zp.PortalId  
			LEFT JOIN ZnodePrice AS Zps ON(Zps.PriceListId = ZPL.PriceListId)   
			LEFT JOIN #TBL_CompleteDetailes AS TBCD ON(TBCD.PortalId = Zp.PortalId AND TBCD.SKU = Zps.Sku)   
			WHERE CAST(@GetDate AS DATE) BETWEEN ZPL.ActivationDate AND ZPL.ExpirationDate   
			AND EXISTS( SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZPLP.PortalId)   
			GROUP BY zp.PortalId,ZPS.RetailPrice,Zps.SKU ,TBCD.SEOCode  
 
			SELECT loc,lastmod,[g:condition],[description],[g:id],link,[g:availability],[g:identifier_exists],DomainName,TBCD.PortalId  
			,CTPL.RetailPrice AS [g:price],@MediaConfiguration AS MediaConfiguration, TBCD.SEOCode, TBCD.CanonicalURL, TBCD.RobotTag 
			FROM #TBL_CompleteDetailes1 AS TBCD   
			LEFT JOIN #Cte_PortalList1 AS CTPL ON(CTPL.PortalId = TBCD.PortalId AND CTPL.SKU = TBCD.SKU AND CTPL.RowID = 1)  
			WHERE  EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = TBCD.PortalId )  

		END
 
		IF OBJECT_ID('tempdb..#TBL_DomainName') IS NOT NULL
		DROP TABLE #TBL_DomainName

		IF OBJECT_ID('tempdb..#TBL_SEODetails') IS NOT NULL
		DROP TABLE #TBL_SEODetails

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_PortalIds') IS NOT NULL
		DROP TABLE #TBL_PortalIds
		
		END TRY  
		BEGIN CATCH  
			DECLARE @Status BIT ;  
			SET @Status = 0;  
			DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetProductFeedList @PortalId = '+@PortalId+',@LocaleId='+CAST(@LocaleId AS VARCHAR(50))+',@FeedType='+CAST(@FeedType AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));  
                 
			SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
     
			EXEC Znode_InsertProcedureErrorLog  
			@ProcedureName = 'Znode_GetProductFeedList',  
			@ErrorInProcedure = @Error_procedure,  
			@ErrorMessage = @ErrorMessage,  
			@ErrorLine = @ErrorLine,  
			@ErrorCall = @ErrorCall;  
		END CATCH  
   
		END
		;


GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPimProductCategoryList')
	DROP PROC Znode_GetPimProductCategoryList
GO

CREATE PROCEDURE [dbo].[Znode_GetPimProductCategoryList]      
(   
	@WhereClause   XML,      
	@Rows          INT           = 100,      
	@PageNo        INT           = 1,      
	@Order_BY      VARCHAR(1000) = '',      
	@RowsCount     INT OUT,      
	@LocaleId      INT           = 1,      
	@PimProductIdInput INT,      
	@IsAssociated  BIT           = 0,    
	@AttributeCode VARCHAR(max) = ''      
)      
AS       
/*      
Summary :- This Procedure is used to get the product list for category products       
The result is fetched order by DisplayOrder or status as per requirement in both asc and desc      
          
Unit Testing       
begin tran      
EXEC Znode_GetPimCategoryProductList '',@RowsCount = 0, @PimCategoryId = 22,@Order_BY ='DisplayOrder asc'      
rollback tran      
*/      
BEGIN      
BEGIN TRY      
SET NOCOUNT ON;      
                 
	DECLARE @TransferPimCategoryId TransferId       
	CREATE TABLE #TBL_AttributeDetails (PimCategoryAttributeValueId INT,PimCategoryId   INT,AttributeValue NVARCHAR(MAX),  
	AttributeCode  VARCHAR(600),PimAttributeId INT);      
                  
	DECLARE @OrderByDisplay INT= 0;      
	DECLARE @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId();      
                   
	CREATE TABLE #TBL_ProductIdTable ([PimProductId] INT,[CountId] INT,PimCategoryId  INT,RowId INT);      
      
	DECLARE   
	@PimAttributeId VARCHAR(MAX)      
		   
      
	DECLARE @PimProductIds TransferId      
      
	IF @Order_BY LIKE '%DisplayOrder%'      
	BEGIN      
		SET @OrderByDisplay = 1;      
	END;      
	ELSE      
	IF @Order_BY LIKE '%Status%'      
	BEGIN      
		SET @OrderByDisplay = 2;      
	END; 
	
	CREATE TABLE #TBL_PimMediaAttributeId  (PimAttributeId INT ,AttributeCode VARCHAR(600))      
	INSERT INTO #TBL_PimMediaAttributeId (PimAttributeId,AttributeCode)      
	SELECT PimAttributeId,AttributeCode FROM Dbo.Fn_GetCategoryMediaAttributeId()      
      
	INSERT INTO @TransferPimCategoryId      
	SELECT PimCategoryId 
	FROM ZnodePimCategoryProduct ZCP 
	WHERE ZCP.PimProductId = @PimProductIdInput       
	ORDER BY CASE WHEN @Order_By LIKE '% DESC%'      
				THEN       
					CASE WHEN @OrderByDisplay = 1       
						THEN ZCP.DisplayOrder       
						WHEN @OrderByDisplay = 2       
						THEN ZCP.Status      
						ELSE 1 
					END       
					ELSE 1 
				END DESC,      
				CASE WHEN @Order_By LIKE '% ASC%'       
					THEN      
						CASE WHEN @OrderByDisplay = 1       
							THEN ZCP.DisplayOrder       
							WHEN @OrderByDisplay = 2      
							THEN ZCP.Status      
							ELSE 1 
						END      
						ELSE 1 
					END 
		 
		       
	IF NOT EXISTS (SELECT TOP 1 1 FROM @TransferPimCategoryId  )      
	BEGIN       
		INSERT INTO @TransferPimCategoryId      
		SELECT '0'      
		--SET @IsAssociated = 0       
	END       
        
      
	DECLARE @SQL NVARcHAR(max)= ''      
	DECLARE  @ProductListIdRTR TransferId      
	DECLARE @TAb Transferid       
	DECLARE @tBL_mainList TABLE (Id INT,CountId INT,RowId INT)      
       
	SET @IsAssociated = CASE WHEN @IsAssociated = 0 THEN 1  WHEN @IsAssociated = 1 THEN 0 END       
       
		
	INSERT INTO @ProductListIdRTR      
	EXEC Znode_GetCategoryList  @IsAssociated,@TransferPimCategoryId      
        
 
	DECLARE @CategoryIDS NVARCHAR(2000) = SUBSTRING((SELECT ','+CAST(ID AS VARCHAR(200)) FROM @ProductListIdRTR FOR XML PATH('')), 2, 4000)      
 
       
	BEGIN      
        
	SET @AttributeCode = REPLACE(dbo.FN_TRIM(REPLACE(REPLACE(@order_by,' DESC',''),' ASC','')),'PimCategoryId','CategoryName')      
	SET @order_by = REPLACE(@order_by,'PimCategoryId','CategoryName')      
      
	INSERT INTO @TBL_MainList(id,CountId,RowId)      
	EXEC Znode_GetCategoryIdForPaging @WhereClause , @Rows , @PageNo , @Order_BY , @RowsCount , @LocaleId , @AttributeCode , @CategoryIDS , @IsAssociated;      
       
	END       
	INSERT INTO #TBL_ProductIdTable(PimCategoryId,RowId)       
	SELECT ID ,RowId FROM @TBL_MainList SP       
      
	INSERT INTO @PimProductIds ( Id )      
	SELECT Id FROM @TBL_MainList SP      
      
	UPDATE #TBL_ProductIdTable SET PimProductId = @PimProductIdInput;      
	SET @PimAttributeId = SUBSTRING((SELECT ','+CAST(PimAttributeId AS VARCHAR(50))   
	FROM [dbo].[Fn_GetGridPimCategoryAttributes]() FOR XML PATH('')), 2, 4000);      
                   
	INSERT INTO #TBL_AttributeDetails(PimCategoryAttributeValueId,PimCategoryId, AttributeValue,AttributeCode,PimAttributeId)      
	EXEC Znode_GetCategoryAttributeValueId @PimProductIds,@PimAttributeId,@LocaleId;      
                 
      
	;WITH Cte_ProductMedia      
	AS (
		SELECT TBA.PimCategoryId , TBA.PimAttributeId       
		, SUBSTRING( ( SELECT ','+ISNULL(ZMC.CDNURL,ZMC.URL)+ZMSM.ThumbnailFolderName+'/'+ zm.PATH             
		FROM ZnodeMedia AS ZM      
		INNER JOIN ZnodeMediaConfiguration ZMC  ON (ZM.MediaConfigurationId = ZMC.MediaConfigurationId)      
		INNER JOIN ZnodeMediaServerMaster ZMSM ON (ZMSM.MediaServerMasterId = ZMC.MediaServerMasterId)      
		INNER JOIN #TBL_AttributeDetails AS TBAI ON (TBAI.AttributeValue  = CAST(ZM.MediaId AS VARCHAR(50)) )      
		INNER JOIN  #TBL_PimMediaAttributeId AS FNMA ON (FNMA.PImAttributeId = TBAI.PimATtributeId)      
		WHERE TBAI.PimCategoryId = TBA.PimCategoryId AND TBAI.PimAttributeId = TBA.PimAttributeId       
		FOR XML PATH('') ), 2 , 4000) AS AttributeValue , SUBSTRING( ( SELECT ','+AttributeValue      
		FROM  #TBL_AttributeDetails AS TBAI      
		WHERE TBAI.PimCategoryId = TBA.PimCategoryId AND TBAI.PimAttributeId = TBA.PimAttributeId       
		FOR XML PATH('') ), 2 , 4000) MediaIds        
		FROM #TBL_AttributeDetails AS TBA       
		INNER JOIN  #TBL_PimMediaAttributeId AS FNMA ON (FNMA.PImAttributeId = TBA.PimATtributeId )      
     )                           
	UPDATE TBAV SET AttributeValue = CTPM.AttributeVALue      
	FROM #TBL_AttributeDetails TBAV       
	INNER JOIN Cte_ProductMedia CTPM ON CTPM.PimCategoryId = TBAV.PimCategoryId  AND CTPM.PimAttributeId = TBAV.PimAttributeId       
	AND CTPM.PimAttributeId = TBAV.PimAttributeId;      
          
      
	SELECT ISNULL(ZPCP.PimCategoryProductId,0) AS PimCategoryProductId, zpp.[PimCategoryId] AS [Categoryid],zpp.[PimCategoryId],ISNULL(ZPCP.[PimProductId],0) AS PimProductId,[CategoryName],[CategoryCode],      
	CASE WHEN ZPCP.Status IS NULL THEN CAST(0 AS BIT) ELSE CAST(ZPCP.Status AS BIT) END AS [Status],      
	piv.[CategoryImage] [ImagePath],ZPCP.DisplayOrder       
          
	FROM #TBL_ProductIdTable AS zpp      
	LEFT JOIN ZnodePimCategoryProduct ZPCP ON(ZPCP.PimProductId = Zpp.PimProductId AND ZPCP.PimCategoryId = Zpp.PimCategoryId)      
	INNER JOIN (SELECT PimCategoryId,AttributeValue,AttributeCode FROM #TBL_AttributeDetails) TB      
	PIVOT(MAX([AttributeValue])       
	FOR [AttributeCode] IN([CategoryName],[CategoryCode],[IsActive],[CategoryImage])) AS Piv ON(Piv.[PimCategoryId] = zpp.[PimCategoryId])      
	ORDER BY CASE WHEN @Order_By LIKE '% DESC%' THEN CASE WHEN @OrderByDisplay = 1 THEN ZPCP.DisplayOrder       
	WHEN @OrderByDisplay = 2 THEN ZPCP.Status ELSE 1 END ELSE 1 END DESC,      
	CASE WHEN @Order_By LIKE '% ASC%' THEN CASE WHEN @OrderByDisplay = 1 THEN ZPCP.DisplayOrder      
	WHEN @OrderByDisplay = 2 THEN ZPCP.Status ELSE 1 END ELSE 1 END,zpp.RowId;      
        
	SELECT @RowsCount=ISNULL((SELECT top 1 countId FROM @TBL_MainList),0)     
    
      
      
END TRY      
BEGIN CATCH      
	SELECT ERROR_MESSAGE()      
	DECLARE @Status BIT ;      
	SET @Status = 0;      
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),      
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPimProductCategoryList @WhereClause = '+  
	CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@LocaleId = '  
	+CAST(@LocaleId AS VARCHAR(50))+',@PimProductIdInput='+CAST(@PimProductIdInput AS VARCHAR(50))+',@IsAssociated='+CAST(@IsAssociated AS VARCHAR(50))+',@RowsCount='+  
	CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));      
                        
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                          
          
	EXEC Znode_InsertProcedureErrorLog      
	@ProcedureName = 'Znode_GetPimProductCategoryList',      
	@ErrorInProcedure = @Error_procedure,      
	@ErrorMessage = @ErrorMessage,      
	@ErrorLine = @ErrorLine,      
	@ErrorCall = @ErrorCall;      
END CATCH;      
END;

GO

update ZnodeApplicationSetting 
set Setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>PimCategoryId</name><headertext>Checkbox</headertext><width>30</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>PimCategoryId</name><headertext>ID</headertext><width>40</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>Image</name><headertext>Image</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>Edit</format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>PimCategoryId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield>ImagePath,CategoryName</imageparamfield><manageactionurl>/Pim/Category/Edit</manageactionurl><manageparamfield>PimCategoryId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>imageicon</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>CategoryName</name><headertext>Category</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>CategoryCode</name><headertext>Category Code</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName = 'UnAssociatedCategoriesToProduct'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeleteCMSSlider')
	DROP PROC Znode_DeleteCMSSlider
GO

CREATE PROCEDURE [dbo].[Znode_DeleteCMSSlider]
( @CMSSliderId VARCHAR(MAX),
  @Status      BIT OUT)
AS 
 /*  
     Summary:Remove CMS Slider with details
			 Before delete check is not associated with ZnodeCMSWidgetSliderBanner 
			 output dataset contain the status if passed @CMSSliderId all ids are deleted then this will true other wise false 
			 Delete table sequence 
			 1.[ZnodeCMSSliderBanner]
			 2.[ZnodeCMSSlider]
     Unit Testing  
			 begin tran 
			 EXEC [Znode_DeletePimCatalog] 7,0
			 rollback tran
   */
     BEGIN
         BEGIN TRAN DeleteCMSSlider;
         BEGIN TRY
             SET NOCOUNT ON;
			 -- table hold the CMSSliderId 
             DECLARE @TBL_CMSSliderIds TABLE(CMSSliderId INT);
             INSERT INTO @TBL_CMSSliderIds
                    SELECT item
                    FROM dbo.Split(@CMSSliderId, ',');

			DELETE FROM ZnodeCMSWidgetSliderBanner
			WHERE EXISTS
			(
				 SELECT TOP 1 1
                 FROM @TBL_CMSSliderIds AS TBDCS
                 WHERE TBDCS.CMSSliderId = ZnodeCMSWidgetSliderBanner.CMSSliderId
			);

             DECLARE @TBL_DeleteCMSSliderId TABLE(CMSSliderId INT);
             INSERT INTO @TBL_DeleteCMSSliderId
                    SELECT ZCS.CMSSliderId
                    FROM [dbo].ZnodeCMSSlider AS ZCS
                         INNER JOIN @TBL_CMSSliderIds AS TBCS ON(ZCS.CMSSliderId = TBCS.CMSSliderId)
                    WHERE NOT EXISTS
                    (   -- check CMSSliderId is not exists in ZnodeCMSWidgetSliderBanner
                        SELECT TOP 1 1
                        FROM ZnodeCMSWidgetSliderBanner AS ZCWSB
                        WHERE ZCWSB.CMSSliderId = ZCS.CMSSliderId
                    ); 

             DELETE FROM ZnodeCMSSliderBannerLocale
             WHERE EXISTS
             (
                 SELECT TOP 1 1
                 FROM ZnodeCMSSliderBanner
                 WHERE EXISTS
                 (
                     SELECT TOP 1 1
                     FROM @TBL_DeleteCMSSliderId AS TBDCS
                     WHERE TBDCS.CMSSliderId = ZnodeCMSSliderBanner.CMSSliderId
                 )
                       AND ZnodeCMSSliderBanner.CMSSliderBannerId = ZnodeCMSSliderBannerLocale.CMSSliderBannerId
             );
             DELETE FROM ZnodeCMSSliderBanner
             WHERE EXISTS
             (
                 SELECT TOP 1 1
                 FROM @TBL_DeleteCMSSliderId AS TBDCS
                 WHERE TBDCS.CMSSliderId = ZnodeCMSSliderBanner.CMSSliderId
             );
             DELETE FROM ZnodeCMSSlider
             WHERE EXISTS
             (
                 SELECT TOP 1 1
                 FROM @TBL_DeleteCMSSliderId AS TBDCS
                 WHERE TBDCS.CMSSliderId = ZnodeCMSSlider.CMSSliderId
             );
             IF
             (
                 SELECT COUNT(1)
                 FROM @TBL_DeleteCMSSliderId
             ) =
             (   -- if count of both query are equal then dataset status true other wise false
                 SELECT COUNT(1)
                 FROM @TBL_CMSSliderIds
             )  
                 BEGIN
                     SELECT 1 AS ID,
                            CAST(1 AS BIT) AS [Status];  
                     SET @Status = 1;
                 END;
             ELSE
                 BEGIN
                     SELECT 0 AS ID,
                            CAST(0 AS BIT) AS [Status];
                     SET @Status = 0;
                 END;
             COMMIT TRAN DeleteCMSSlider;
         END TRY
         BEGIN CATCH
             DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeleteCMSSlider @CMSSliderId = '+CAST(@CMSSliderId AS VARCHAR(100))+',@Status='+CAST(@Status AS VARCHAR(50));
             SELECT 0 AS ID,
                    CAST(0 AS BIT) AS [Status];
             SET @Status = 0;
			 ROLLBACK TRAN DeleteCMSSlider;
             EXEC Znode_InsertProcedureErrorLog
                  @ProcedureName = 'Znode_DeleteCMSSlider',
                  @ErrorInProcedure = @Error_procedure,
                  @ErrorMessage = @ErrorMessage,
                  @ErrorLine = @ErrorLine,
                  @ErrorCall = @ErrorCall;
             ROLLBACK TRAN DeleteCMSSlider;
         END CATCH;
     END;


GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'ZnodeReport_DashboardOrders')
	DROP PROC ZnodeReport_DashboardOrders
GO

CREATE PROCEDURE [dbo].[ZnodeReport_DashboardOrders]              
(            
	@PortalId  bigint  = null,        
	@AccountId bigint  = null  ,    
	@SalesRepUserId int = 0              
)              
AS              
/*              
Summary:- This procedure is used to get the order details              
Unit Testing:              
EXEC [ZnodeReport_DashboardOrders]              
*/              
BEGIN              
BEGIN TRY              
SET NOCOUNT ON;              
	DECLARE @TopItem TABLE (ItemName nvarchar(100),CustomerName nvarchar(1000),ItemId nvarchar(10), Total numeric(28,6) , Date datetime,Symbol NVARCHAR(10))              
           
                 
	DECLARE @RoundOffValue INT= dbo.Fn_GetDefaultValue('PriceRoundOff')          
   
	----Verifying that the @SalesRepUserId is having 'Sales Rep' role
	IF NOT EXISTS
	(
		SELECT * FROM ZnodeUser ZU
		INNER JOIN AspNetZnodeUser ANZU ON ZU.UserName = ANZU.UserName
		INNER JOIN AspNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName
		INNER JOIN AspNetUserRoles ANUR ON ANU.Id = ANUR.UserId
		Where Exists(select * from AspNetRoles ANR Where Name = 'Sales Rep' AND ANUR.RoleId = ANR.Id)
		AND ZU.UserId = @SalesRepUserId
	)  
	Begin
		SET @SalesRepUserId = 0
	End    
             
	DECLARE @TBL_CultureCurrency TaBLE (Symbol Varchar(100),CurrencyCode varchar(100))              
	INSERT INTO @TBL_CultureCurrency (Symbol,CurrencyCode)              
	SELECT Symbol,CultureCode FROM  ZnodeCulture ZC              
	DECLARE @PortalCurrencySymbol nvarchar(20)          
	DECLARE @DefaultCurrencySymbol nvarchar(20)            
           
	SET @PortalCurrencySymbol = [dbo].[Fn_GetPortalCurrencySymbol](CAST(@PortalID AS INTEGER) )          
	SET @DefaultCurrencySymbol = [dbo].[Fn_GetDefaultCurrencySymbol]()          
         
	IF @PortalCurrencySymbol IS NULL          
	UPDATE @TBL_CultureCurrency SET Symbol  =@DefaultCurrencySymbol WHERE  Symbol IS NULL          
	ELSE          
	UPDATE @TBL_CultureCurrency SET Symbol  =@PortalCurrencySymbol WHERE  Symbol IS NULL          
   
	IF @AccountId = -1
	Begin
		INSERT INTO @TopItem(ItemId, ItemName,CustomerName,Date,Total,Symbol)          
		SELECT Zoo.OmsOrderId,Zoo.OrderNumber,ISNULL(RTRIM(LTRIM(ZODD.FirstName)),'')          
		+' '+ISNULL(RTRIM(LTRIM(ZODD.LastName)),'') UserName ,ZODD.OrderDate,round(ZODD.Total,@RoundOffValue),        
		COALESCE (ZC.Symbol,[dbo].[Fn_GetPortalCurrencySymbol](CAST(@PortalId AS INTEGER)),[dbo].[Fn_GetDefaultCurrencySymbol]())          
		FROM ZnodeOmsOrder (nolock) ZOO          
		INNER JOIN ZnodeOmsOrderDetails (nolock) ZODD ON (ZODD.OmsOrderId = ZOO.OmsOrderId AND  ZODD.IsActive = 1)          
		INNER JOIN ZnodePortal (nolock) ZP ON (ZP.PortalId = ZODD.portalId )          
		INNER JOIN ZnodePublishState ZODPS ON (ZODPS.PublishStateId = ZOO.PublishStateId)          
		LEFT JOIN ZnodePaymentType (nolock) ZPS ON (ZPS.PaymentTypeId = ZODD.PaymentTypeId )          
		LEFT JOIN  ZnodeOmsOrderStateShowToCustomer (nolock) ZOSC ON (ZOSC.OmsOrderStateId = ZODD.OmsOrderStateId)          
		LEFT JOIN ZnodeOmsOrderState (nolock) ZOS ON (ZOS.OmsOrderStateId = ZODD.OmsOrderStateId)          
		LEFT JOIN ZnodeOmsPaymentState (nolock) ZOPS ON (ZOPS.OmsPaymentStateId = ZODD.OmsPaymentStateId)          
		LEft JOIN ZnodeUser ZU ON (ZU.UserId = ZODD.UserId)          
		LEFT JOIN [dbo].[View_GetUserDetails]  (nolock) ZVGD ON (ZVGD.UserId = ZODD.CreatedBy )          
		LEFT JOIN [dbo].[View_GetUserDetails]  (nolock) ZVGDI ON (ZVGDI.UserId = ZODD.ModifiedBy)          
		LEFT JOIN ZnodeShipping ZS ON (ZS.ShippingId = ZODD.ShippingId)          
		LEFT OUTER JOIN ZnodePaymentSetting (nolock) ZPSS ON (ZPSS.PaymentSettingId = ZODD.PaymentSettingId)          
		LEFT JOIN ZnodePortalPaymentSetting (nolock) ZPPS ON (ZPPS.PaymentSettingId = ZPSS.PaymentSettingId  AND ZPPS.PortalId = ZODD.PortalId   )          
		LEFT JOIN @TBL_CultureCurrency ZC ON (ZC.CurrencyCode = ZODD.CultureCode )        
		WHERE (ZP.PortalId = @PortalId OR  ISNULL(@PortalId,0) = 0)        
		and (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = @SalesRepUserId and ZU.UserId = SalRep.CustomerUserid) or @SalesRepUserId = 0)      
		and not Exists(Select * from ZnodeAccount ZA Where isnull(ZU.AccountId,0) = ZA.AccountId)
	End
	Else
	Begin
		INSERT INTO @TopItem(ItemId, ItemName,CustomerName,Date,Total,Symbol)          
		SELECT Zoo.OmsOrderId,Zoo.OrderNumber,ISNULL(RTRIM(LTRIM(ZODD.FirstName)),'')          
		+' '+ISNULL(RTRIM(LTRIM(ZODD.LastName)),'') UserName ,ZODD.OrderDate,round(ZODD.Total,@RoundOffValue),        
		COALESCE (ZC.Symbol,[dbo].[Fn_GetPortalCurrencySymbol](CAST(@PortalId AS INTEGER)),[dbo].[Fn_GetDefaultCurrencySymbol]())          
		FROM ZnodeOmsOrder (nolock) ZOO          
		INNER JOIN ZnodeOmsOrderDetails (nolock) ZODD ON (ZODD.OmsOrderId = ZOO.OmsOrderId AND  ZODD.IsActive = 1)          
		INNER JOIN ZnodePortal (nolock) ZP ON (ZP.PortalId = ZODD.portalId )          
		INNER JOIN ZnodePublishState ZODPS ON (ZODPS.PublishStateId = ZOO.PublishStateId)          
		LEFT JOIN ZnodePaymentType (nolock) ZPS ON (ZPS.PaymentTypeId = ZODD.PaymentTypeId )          
		LEFT JOIN  ZnodeOmsOrderStateShowToCustomer (nolock) ZOSC ON (ZOSC.OmsOrderStateId = ZODD.OmsOrderStateId)          
		LEFT JOIN ZnodeOmsOrderState (nolock) ZOS ON (ZOS.OmsOrderStateId = ZODD.OmsOrderStateId)          
		LEFT JOIN ZnodeOmsPaymentState (nolock) ZOPS ON (ZOPS.OmsPaymentStateId = ZODD.OmsPaymentStateId)          
		LEFT JOIN ZnodeUser ZU ON (ZU.UserId = ZODD.UserId)          
		LEFT JOIN [dbo].[View_GetUserDetails]  (nolock) ZVGD ON (ZVGD.UserId = ZODD.CreatedBy )          
		LEFT JOIN [dbo].[View_GetUserDetails]  (nolock) ZVGDI ON (ZVGDI.UserId = ZODD.ModifiedBy)          
		LEFT JOIN ZnodeShipping ZS ON (ZS.ShippingId = ZODD.ShippingId)          
		LEFT OUTER JOIN ZnodePaymentSetting (nolock) ZPSS ON (ZPSS.PaymentSettingId = ZODD.PaymentSettingId)          
		LEFT JOIN ZnodePortalPaymentSetting (nolock) ZPPS ON (ZPPS.PaymentSettingId = ZPSS.PaymentSettingId  AND ZPPS.PortalId = ZODD.PortalId   )          
		LEFT JOIN @TBL_CultureCurrency ZC ON (ZC.CurrencyCode = ZODD.CultureCode )        
		WHERE (ZP.PortalId = @PortalId OR  ISNULL(@PortalId,0) = 0) AND (ZU.AccountId = @AccountId OR  ISNULL(@AccountId,0) = 0)        
		and (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = @SalesRepUserId and ZU.UserId = SalRep.CustomerUserid) or @SalesRepUserId = 0)      
	End

	SELECT TOP 5 ItemId, ItemName,CustomerName,Date,Total,Symbol FROM @TopItem Order by  Convert(datetime,Date )  desc                
   
END TRY              
             
BEGIN CATCH              
	DECLARE @Status BIT ;        
	SET @Status = 0;              
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),              
	@ErrorCall NVARCHAR(MAX)= 'EXEC ZnodeReport_DashboardOrders @PortalId = '+@PortalId;            
                               
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                                  
                 
	EXEC Znode_InsertProcedureErrorLog              
	@ProcedureName = 'ZnodeReport_DashboardOrders',              
	@ErrorInProcedure = @Error_procedure,              
	@ErrorMessage = @ErrorMessage,              
	@ErrorLine = @ErrorLine,              
	@ErrorCall = @ErrorCall;              
END CATCH              
             
END;

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'ElasticSearchEvent' AND Object_ID = Object_ID(N'dbo.ZnodePublishAddonEntity'))
BEGIN
	ALTER TABLE ZnodePublishAddonEntity ADD ElasticSearchEvent INT;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'ElasticSearchEvent' AND Object_ID = Object_ID(N'dbo.ZnodePublishBundleProductEntity'))
BEGIN
	ALTER TABLE ZnodePublishBundleProductEntity ADD ElasticSearchEvent INT;
END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'Ind_ZnodePublishCatalogProductDetail_PublishCatalogId_LocaleId' AND object_id = OBJECT_ID('ZnodePublishCatalogProductDetail'))
BEGIN
    CREATE NONCLUSTERED INDEX [Ind_ZnodePublishCatalogProductDetail_PublishCatalogId_LocaleId]
    ON [dbo].[ZnodePublishCatalogProductDetail]([PublishCatalogId] ASC, [LocaleId] ASC)
    INCLUDE([PublishProductId]);
END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'Ind_ZnodePublishCatalogProductDetail_PublishCatalogId_ModifiedDate' AND object_id = OBJECT_ID('ZnodePublishCatalogProductDetail'))
BEGIN
    CREATE NONCLUSTERED INDEX [Ind_ZnodePublishCatalogProductDetail_PublishCatalogId_ModifiedDate]
    ON [dbo].[ZnodePublishCatalogProductDetail]([PublishCatalogId] ASC, [ModifiedDate] ASC);
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'ElasticSearchEvent' AND Object_ID = Object_ID(N'dbo.ZnodePublishCategoryEntity'))
BEGIN
	ALTER TABLE ZnodePublishCategoryEntity ADD ElasticSearchEvent INT;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'ElasticSearchEvent' AND Object_ID = Object_ID(N'dbo.ZnodePublishConfigurableProductEntity'))
BEGIN
	ALTER TABLE ZnodePublishConfigurableProductEntity ADD ElasticSearchEvent INT;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'ElasticSearchEvent' AND Object_ID = Object_ID(N'dbo.ZnodePublishGroupProductEntity'))
BEGIN
	ALTER TABLE ZnodePublishGroupProductEntity ADD ElasticSearchEvent INT;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'ElasticSearchEvent' AND Object_ID = Object_ID(N'dbo.ZnodePublishProductEntity'))
BEGIN
	ALTER TABLE ZnodePublishProductEntity ADD ElasticSearchEvent INT;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'ElasticSearchEvent' AND Object_ID = Object_ID(N'dbo.ZnodePublishSeoEntity'))
BEGIN
	ALTER TABLE ZnodePublishSeoEntity ADD ElasticSearchEvent INT;
END

GO

IF EXISTS (SELECT * FROM sysobjects WHERE xtype IN (N'FN', N'IF', N'TF') AND id = object_id(N'FN_GetCatalogPortalActiveLocale'))
    DROP FUNCTION FN_GetCatalogPortalActiveLocale
GO

CREATE FUNCTION DBO.FN_GetCatalogPortalActiveLocale
(
    @PublishCatalogId INT
)
RETURNS @Items TABLE
(
    LocaleId Int
)
AS
BEGIN
    INSERT INTO @Items(LocaleId)
    SELECT LocaleId FROM ZnodeLocale MT WHERE IsActive =1 
    AND EXISTS(SELECT * FROM ZnodePortalCatalog ZPC 
        INNER JOIN ZnodePortalLocale ZPL ON ZPC.PortalId = ZPL.PortalId
        WHERE ZPC.PublishCatalogId = @PublishCatalogId AND MT.LocaleId = ZPL.LocaleId )
        --AND (LocaleId  = @LocaleId OR @LocaleId = 0 )

    --If catalog not associated with stire then getting default active locale for catalog
    IF NOT EXISTS(SELECT * FROM @Items)
        INSERT INTO @Items (LocaleId) 
        SELECT LocaleId FROM ZnodeLocale MT WHERE IsActive =1 and IsDefault = 1

    RETURN
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeletePublishCatalogEntity')
	DROP PROC Znode_DeletePublishCatalogEntity
GO

CREATE PROCEDURE [dbo].[Znode_DeletePublishCatalogEntity]
(
    @PublishCatalogId  INT = 0 
   ,@UserId int = 0
   ,@IsRevertPublish bit = 0 
   ,@NewGUID nvarchar(500) 

)
AS
/*
	To Remove all publish catalog details from related entities
	Unit Testing : 
	Declare @Status bit 
	Exec [dbo].[ZnodePublishPortalEntity]
     @PortalId  = 1 
	,@LocaleId  = 0 
	,@RevisionState = 'PRODUCTION' 
	,@UserId = 2
	,@Status = @Status 
	--Select @Status 
*/
BEGIN
SET NOCOUNT ON
BEGIN TRY 
Begin Transaction 
--SET NOCOUNT ON
		Declare @Status Bit =0, @IsPreviewEnable  int,  @Batch INT;
		IF object_id('tempdb..[#Tbl_VersionEntity]') IS NOT NULL
			drop table tempdb..#Tbl_VersionEntity
		
		Create Table #Tbl_VersionEntity(PublishCatalogId int , VersionId int , LocaleId int , PublishType varchar(50))
		Insert into #Tbl_VersionEntity (PublishCatalogId , VersionId , LocaleId , PublishType )
			select ZnodeCatalogId , VersionId , LocaleId , RevisionType  from ZnodePublishVersionEntity   where ZnodeCatalogId = @PublishCatalogId 
			and  IsPublishSuccess =0  

		IF object_id('tempdb..[#Tbl_VersionEntityforCatalog]') IS NOT NULL
			drop table tempdb..#Tbl_VersionEntityforCatalog
		
		Create Table #Tbl_VersionEntityforCatalog(PublishCatalogId int , VersionId int , LocaleId int , PublishType varchar(50))
		Insert into #Tbl_VersionEntityforCatalog(PublishCatalogId , VersionId , LocaleId , PublishType )
		select ZnodeCatalogId , VersionId , LocaleId , RevisionType  from ZnodePublishVersionEntity   where ZnodeCatalogId = @PublishCatalogId 
		and  IsPublishSuccess = 0  

		IF object_id('tempdb..[#Tbl_OldVersionEntityforCatalog]') IS NOT NULL
			drop table tempdb..#Tbl_OldVersionEntityforCatalog
		
		Create Table #Tbl_OldVersionEntityforCatalog(PublishCatalogId int , VersionId int , LocaleId int , PublishType varchar(50),IsPublishSuccess bit )
		Insert into #Tbl_OldVersionEntityforCatalog(PublishCatalogId , VersionId , LocaleId , PublishType ,IsPublishSuccess)
		select ZnodeCatalogId , VersionId , LocaleId, RevisionType  ,IsPublishSuccess from ZnodePublishVersionEntity   where ZnodeCatalogId = @PublishCatalogId 
		and  IsPublishSuccess = 1  

		IF object_id('tempdb..[#Tbl_OldVersionEntityforDeletion]') IS NOT NULL
		drop table tempdb..#Tbl_OldVersionEntityforDeletion

		Create Table #Tbl_OldVersionEntityforDeletion(PublishCatalogId int , VersionId int , LocaleId int , PublishType varchar(50),IsPublishSuccess bit )
		Insert into #Tbl_OldVersionEntityforDeletion(PublishCatalogId , VersionId , LocaleId , PublishType ,IsPublishSuccess)
		select ZnodeCatalogId , VersionId , LocaleId, RevisionType  ,IsPublishSuccess from ZnodePublishVersionEntity   where ZnodeCatalogId = @PublishCatalogId 
		and  IsPublishSuccess = 1  and RevisionType  in 
		(Select distinct PublishType from #Tbl_VersionEntity where ZnodeCatalogId = #Tbl_VersionEntity.PublishCatalogId  )

		If @IsRevertPublish = 0 AND @PublishCatalogId > 0 AND Exists (Select Top 1 1 from #Tbl_VersionEntity ) 
		Begin 
			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =90, 
			IsCompleted  = 1,
			IsFailed =0
			where  JobId = @NewGUID

			Delete  From ZnodePublishCatalogEntity Where  VersionId NOT IN  (Select VersionId from #Tbl_VersionEntity) AND ZnodeCatalogId = @PublishCatalogId  
				AND VersionId IN  (SELECT VersionId from #Tbl_OldVersionEntityforDeletion) 
			SET @Batch= 1;
			WHILE @Batch > 0
			BEGIN 
				Delete  TOP (10000) From ZnodePublishProductEntity Where ElasticSearchEvent = 2
				SET @Batch= @@ROWCOUNT;
				-- CHECKPOINT;    -- if simple
				-- BACKUP LOG ... -- if full
			END

			Delete  From ZnodePublishAddOnEntity Where  VersionId NOT IN (Select VersionId from #Tbl_VersionEntity)  AND ZnodeCatalogId = @PublishCatalogId 
			AND VersionId IN  (SELECT VersionId from #Tbl_OldVersionEntityforDeletion) 

			
			Delete  From ZnodePublishCategoryEntity Where ElasticSearchEvent = 2

			Delete  From ZnodePublishBundleProductEntity Where ElasticSearchEvent = 2

			Delete  From ZnodePublishGroupProductEntity Where ElasticSearchEvent = 2

			Delete  From ZnodePublishConfigurableProductEntity Where ElasticSearchEvent = 2

			Delete  From ZnodePublishSEOEntity Where CMSSEOTypeId in (1,2,4) 
			and ElasticSearchEvent = 2

			--Delete  From ZnodePublishVersionEntity Where  VersionId NOT IN (Select VersionId from #Tbl_VersionEntity) AND ZnodeCatalogId = @PublishCatalogId 
			--AND VersionId IN  (SELECT VersionId from #Tbl_OldVersionEntityforDeletion) 

			Update ZnodePublishVersionEntity  SET IsPublishSuccess= 1 where IsPublishSuccess = 0
			and ZnodeCatalogId  = @PublishCatalogId   

						
			Update a SET IsCatalogPublished =1,  PublishStateId = DBO.Fn_GetPublishStateIdForPublish(), ModifiedDate = Getdate()  
			from ZnodePublishCatalogLog a
			where  PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()
			and PublishCatalogLogId = (select max(PublishCatalogLogId) from ZnodePublishCatalogLog b where a.PimCatalogId = b.PimCatalogId and a.LocaleId = b.LocaleId and b.PublishStateId = DBO.Fn_GetPublishStateIdForProcessing())

			Update a SET IsCatalogPublished =1,  PublishStateId = DBO.Fn_GetPublishStateIdForPreview(), ModifiedDate = Getdate()  
			from ZnodePublishCatalogLog a
			where  PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()
			and PublishCatalogLogId = (select min(PublishCatalogLogId) from ZnodePublishCatalogLog b where a.PimCatalogId = b.PimCatalogId and a.LocaleId = b.LocaleId and b.PublishStateId = DBO.Fn_GetPublishStateIdForProcessing())


			Insert into ZnodePublishPreviewLogEntity
			(VersionId,PublishStartTime,IsDisposed,SourcePublishState,EntityId,EntityType,LogMessage,LogCreatedDate,PreviousVersionId,LocaleId,LocaleDisplayValue)
				Select A.VersionId,NULL,NULL,A.PublishType,@PublishCatalogId,'catalog','catalog has been published successfully' , Getdate(),  
				(select TOP 1 VersionId   from #Tbl_OldVersionEntityforCatalog where LocaleId = A.LocaleId AND PublishType = A.PublishType
				AND  PublishCatalogId = A.PublishCatalogId and  IsPublishSuccess =1 ),
				A.LocaleId,B.Name
				from #Tbl_VersionEntity  A  Inner join ZnodeLocale B on A.LocaleId = B.LocaleId 

			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =100, 
			IsCompleted  = 1,
			IsFailed =0
			where  JobId = @NewGUID

			--UPDATE ZnodePimProduct SET IsProductPublish = 1,PublishStateId =  DBO.Fn_GetPublishStateIdForPublish()  
			--WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishProduct ZPP WHERE ZPP.PimProductId = ZnodePimProduct.PimProductId AND ZPP.PublishCatalogId = @PublishCatalogId)

			--UPDATE ZnodePublishCatalogLog 
			--SET IsProductPublished = 1 
			--,PublishProductId = (SELECT  COUNT(DISTINCT PublishProductId) FROM ZnodePublishCategoryProduct ZPP WHERE ZPP.PublishCatalogId = ZnodePublishCatalogLog.PublishCatalogId AND ZPP.PublishCategoryId IS NOT NULL) 
			--WHERE EXISTS (SELECT TOP 1 1 FROM #Tbl_VersionEntity TY  WHERE  TY.VersionId =ZnodePublishCatalogLog.PublishCatalogLogId )  

		End
		Else If @IsRevertPublish = 1 AND @PublishCatalogId > 0 
		Begin 
			
			Delete  From ZnodePublishCatalogEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
			SET @Batch= 1;
			WHILE @Batch > 0
			BEGIN 
				Delete  TOP (10000) From ZnodePublishProductEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
				SET @Batch= @@ROWCOUNT;
				-- CHECKPOINT;    -- if simple
				-- BACKUP LOG ... -- if full
			END
			Delete  From ZnodePublishAddOnEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
			Delete  From ZnodePublishCategoryEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
			Delete  From ZnodePublishBundleProductEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
			Delete  From ZnodePublishGroupProductEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
			Delete  From ZnodePublishConfigurableProductEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
			Delete  From ZnodePublishSEOEntity Where CMSSEOTypeId in (1,2,4) and  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) 
			--AND PortalId in 
			--	(Select ZPC.PortalId  from ZnodePublishVersionEntity  ZPVE inner join ZnodePortalCatalog  
			--		ZPC ON ZPVE.ZnodeCatalogId = ZPC.PublishCatalogId where  (ZPC.PublishCatalogId = @PublishCatalogId ))

			Delete  From ZnodePublishVersionEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 

			INSERT INTO ZnodePublishCatalogErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'Elastic-index genration get failed : ', '' , 'Fail' , Getdate(), 
			@UserId , '' 
			
			Update ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed() ,
			IsCatalogPublished = 0  , ModifiedDate = Getdate()
			where PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()

			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =100, 
			IsCompleted  = 1,
			IsFailed =1
			where  JobId = @NewGUID

		END 
		Else If @IsRevertPublish = 1 AND Isnull(@PublishCatalogId,0) = 0 
		Begin 
			INSERT INTO ZnodePublishCatalogErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'Publish failed, Check connection failure ', '' , 'Fail' , Getdate(), @UserId , '' 
			
			Update ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed() ,
			IsCatalogPublished =0, IsCategoryPublished = 0 ,IsProductPublished = 0 , ModifiedDate = Getdate()
			where PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()
						
			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =80, 
			IsCompleted  = 0,
			IsFailed =1
			where  JobId = @NewGUID

		end

		SET @Status = 1
		Commit Transaction 
		SELECT @PublishCatalogId AS id,@Status AS Status;   
END TRY 
BEGIN CATCH 
	SET @Status =0  
	 SELECT 1 AS ID,@Status AS Status;   
	 Rollback transaction
	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeletePublishCatalogEntity 
		@PublishCatalogId = '+CAST(@PublishCatalogId  AS VARCHAR	(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@IsRevertPublish='+CAST(@IsRevertPublish AS VARCHAR(10))
		+',@UserId = ' + CAST(@UserId AS varchar(20));	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
	
	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_DeletePublishCatalogEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishAssociatedAddonsJson')
	DROP PROC Znode_GetPublishAssociatedAddonsJson
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishAssociatedAddonsJson]
(
	@PublishCatalogId NVARCHAR(MAX) = 0,
	@PimProductId    TransferId Readonly,
	@VersionId        INT           = 0,
	@UserId           INT,														 
	@PimCategoryHierarchyId int = 0, 
	@LocaleId       TransferId READONLY,
	@PublishStateId INT = 0, 
	@VersionIdString  VARCHAR(2000)= '',
	@Status		   Bit  OutPut,
	@RevisionType Varchar(50)
)
AS 
   
/*
    Summary : If PimcatalogId is provided get all products with Addons and provide above mentioned data
       If PimProductId is provided get all Addons if associated with given product id and provide above mentioned data
    			Input: @PublishCatalogId or @PimProductId
    		    output should be in XML format
       sample xml5
    Begin transaction  
	 declare  @PimProductId TransferId 
	 Declare @Status bit 
	 INSERT INTO @PimProductId  values (768)

			Exec [_Znode_GetPublishAssociatedAddonsJson]
				@PublishCatalogId = 0 ,
				@PimProductId   = @PimProductId,
				@UserId =2,														 
				@VersionIdString = '',--'1662,1664,1663,1665',
				@Status	 =@Status Out,
				@RevisionType= 'Production'
				rollback transaction
				--SELECT * from ZnodePublishVersionEntity 
   
	*/

BEGIN
    BEGIN TRY
    SET NOCOUNT ON 
		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
        DECLARE @LocaleIdIn INT, @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId()
		, @Counter INT= 1
		, @MaxRowId INT= 0;

    -- DECLARE @PimAddOnGroupId VARCHAR(MAX);

		CREATE TABLE #TBL_PublisshIds  (PublishProductId INT , PimProductId INT , PublishCatalogId INT)
		DECLARE @TBL_LocaleId TABLE (RowId    INT IDENTITY(1, 1),LocaleId INT);
		IF OBJECT_ID('tempdb..#VesionIds') is not null
		DROP TABLE #VesionIds
		Create Table #VesionIds(ZnodeCatalogId int , VersionId int , LocaleId int , RevisionType varchar(50) )

  		If @VersionIdString <> ''
		BEGIN
			Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)	
			SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType
			FROM ZnodePublishVersionEntity PV Inner join Split(@VersionIdString,',') S ON PV.VersionId = S.Item
		END
		Else 
		Begin
			If  (@RevisionType like '%Preview%'  OR @RevisionType like '%Production%')
			BEGIN
				Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)	
				SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV  where PV.IsPublishSuccess =1 
				AND PV.RevisionType ='Preview'
			END
			If  (@RevisionType like '%Production%' OR @RevisionType = 'None')
			BEGIN
				Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)	
				SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV  where PV.IsPublishSuccess =1 
				AND PV.RevisionType ='Production'
			END					
		End 

		IF (@PublishCatalogId IS NULL OR @PublishCatalogId = 0)
		BEGIN 
			INSERT INTO #TBL_PublisshIds 
			EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId,@userid,@PimProductId,1
		END 
		IF ISnull(@PimCategoryHierarchyId,0) <> 0 
		BEGIN 
			INSERT INTO #TBL_PublisshIds 
			EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId,@userid,@PimProductId,1,@PimCategoryHierarchyId 
		END 

		CREATE TABLE #TBL_PublishCatalogId (PublishCatalogId INT,PublishProductId INT,PimProductId  INT , VersionId INT ,LocaleId INT  );

		IF  ISnull(@PimCategoryHierarchyId,0) <> 0 
		BEGIN 
			INSERT INTO #TBL_PublishCatalogId 
			SELECT ZPP.PublishCatalogId , ZPP.PublishProductId,PimProductId, MAX(ZPCP.PublishCatalogLogId)  ,LocaleId 
			FROM ZnodePublishProduct ZPP 
			INNER JOIN ZnodePublishCatalogLog ZPCP ON (ZPCP.PublishCatalogId  = ZPP.PublishCatalogId)
			WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId   ) 
			AND ZPCP.Publishstateid = @PublishStateId
			GROUP BY ZPP.PublishCatalogId,ZPP.PublishProductId,PimProductId,LocaleId 
		END 
		ELSE 
		Begin
			INSERT INTO #TBL_PublishCatalogId  
			SELECT ZPP.PublishCatalogId , ZPP.PublishProductId,PimProductId,0  VersionId  ,0 LocaleId 
			FROM ZnodePublishProduct ZPP  
			WHERE EXISTS  (SELECT TOP 1 1 FROM #VesionIds ZPCP WHERE (ZPCP.ZnodeCatalogId  = ZPP.PublishCatalogId)) AND
			(EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId  
			AND  @PublishCatalogId = '0' )  OR (ZPP.PublishCatalogId =  @PublishCatalogId ))
		END
        DECLARE @TBL_AddonGroupLocale TABLE( PimAddonGroupId INT, DisplayType NVARCHAR(400),AddonGroupName NVARCHAR(MAX),LocaleId INT );
        INSERT INTO @TBL_LocaleId(LocaleId)
        SELECT LocaleId FROM ZnodeLocale MT  WHERE IsActive = 1 AND (EXISTS (SELECT TOP 1 1  FROM @LocaleId RT WHERE RT.Id = MT.LocaleId )
			OR NOT EXISTS (SELECT TOP 1 1 FROM @LocaleId ));
        SET @MaxRowId = ISNULL(( SELECT MAX(RowId) FROM @TBL_LocaleId ), 0);
    
        WHILE (@Counter <= @MaxRowId)
        BEGIN
            SET @LocaleIdIn =( SELECT LocaleId FROM @TBL_LocaleId WHERE RowId = @Counter );
            INSERT INTO @TBL_AddonGroupLocale (PimAddonGroupId, DisplayType, AddonGroupName)
            EXEC Znode_GetAddOnGroupLocale '', @LocaleIdIn;
	   		UPDATE @TBL_AddonGroupLocale SET LocaleId = @LocaleIdIn WHERE LocaleId IS NULL 
            SET @Counter = @Counter + 1;
        END;
		
		IF OBJECT_ID('tempdb..#AddonProductPublishedXML') is not null
		drop table #AddonProductPublishedXML
						
		SELECT  ZPPP.PublishProductId,ZPPP.PublishCatalogId,V.LocaleId,v.VersionId,
		ZPPP.[PublishProductId]  ZnodeProductId,
		ZPPP.[PublishCatalogId] ZnodeCatalogId,
		ZPP.PublishProductId  AssociatedZnodeProductId,
		ZPAOP.DisplayOrder DisplayOrder,
		ZPOPD.DisplayOrder AssociatedProductDisplayOrder,
		RequiredType ,
		DisplayType, 
		ISNULL((select ''+AddonGroupName for xml path('')),'') GroupName,
		ISnull(IsDefault,0) IsDefault
		INTO #AddonProductPublishedXML
		FROM [ZnodePimAddOnProductDetail] AS ZPOPD
		INNER JOIN [ZnodePimAddOnProduct] AS ZPAOP ON ZPOPD.[PimAddOnProductId] = ZPAOP.[PimAddOnProductId]
		INNER JOIN #TBL_PublishCatalogId ZPPP ON (ZPPP.PimProductId = ZPAOP.PimProductId )
		INNER JOIN #TBL_PublishCatalogId ZPP ON(ZPP.PimProductId = ZPOPD.[PimChildProductId] AND ZPP.PublishCatalogId = ZPPP.PublishCatalogId  )
		INNER JOIN #VesionIds V ON ZPPP.PublishCatalogId  = V.ZnodeCataLogId
		INNER JOIN @TBL_AddonGroupLocale TBAG ON (TBAG.PimAddonGroupId   = ZPAOP.PimAddonGroupId AND TBAG.LocaleId = V.LocaleId )
					
		If (isnull(@PublishCatalogId ,'') = '' and @VersionIdString = '') OR 
			(isnull(@PublishCatalogId ,'') = 0 and @VersionIdString = '')
		Begin 
			UPDATE ZnodePublishAddonEntity 
			SET ElasticSearchEvent = 2
			WHERE PublishAddonEntityId  IN (
											SELECT PublishAddonEntityId
											FROM ZnodePublishAddonEntity BP
											INNER JOIN #AddonProductPublishedXML A ON BP.ZnodeProductId =A.PublishProductId
												AND BP.ZnodeCatalogId = A.PublishCatalogId AND BP.VersionId = A.VersionId
											) 
			----Delete addon entries having parent data present but all addon removed
			UPDATE ZPAE 
			SET ElasticSearchEvent = 2 
			FROM ZnodePublishAddonEntity ZPAE
			WHERE EXISTS (SELECT * from [ZnodePimAddOnProduct] ZPAOP 
					INNER JOIN ZnodePublishProduct ZPPP ON (ZPPP.PimProductId = ZPAOP.PimProductId )
					WHERE ZPAE.ZnodeProductId = ZPPP.PublishProductId AND ZPAE.ZnodeCatalogId = ZPPP.PublishCatalogId)
			AND NOT EXISTS (SELECT * from [ZnodePimAddOnProductDetail] AS ZPOPD
					INNER JOIN [ZnodePimAddOnProduct] AS ZPAOP ON ZPOPD.[PimAddOnProductId] = ZPAOP.[PimAddOnProductId]
					INNER JOIN ZnodePublishProduct ZPPP ON (ZPPP.PimProductId = ZPOPD.PimChildProductId )
					WHERE ZPAE.AssociatedZnodeProductId = ZPPP.PublishProductId AND ZPAE.ZnodeCatalogId = ZPPP.PublishCatalogId)

			----Delete addon entries having parent data removed
			UPDATE ZPAE 
			SET ElasticSearchEvent = 2
			FROM ZnodePublishAddonEntity ZPAE
			WHERE NOT EXISTS (SELECT * from [ZnodePimAddOnProduct] ZPAOP 
					INNER JOIN ZnodePublishProduct ZPPP ON (ZPPP.PimProductId = ZPAOP.PimProductId )
					WHERE ZPAE.ZnodeProductId = ZPPP.PublishProductId AND ZPAE.ZnodeCatalogId = ZPPP.PublishCatalogId)

		End 
				
		UPDATE PCE SET PCE.AssociatedProductDisplayOrder = Isnull(CE.AssociatedProductDisplayOrder,0),
			PCE.GroupName = CE.GroupName,PCE.DisplayType = CE.DisplayType,
			PCE.DisplayOrder = CE.DisplayOrder,
			PCE.IsRequired = 1 ,PCE.RequiredType = CE.RequiredType,PCE.IsDefault = CE.IsDefault,
			PCE.ElasticSearchEvent = 2
		FROM #AddonProductPublishedXML CE
		INNER JOIN ZnodePublishAddonEntity PCE ON CE.VersionId = PCE.VersionId
		AND PCE.LocaleId = CE.LocaleId AND PCE.ZnodeCatalogId = CE.PublishCatalogId AND CE.ZnodeProductId = PCE.ZnodeProductId
		AND PCE.AssociatedZnodeProductId = CE.AssociatedZnodeProductId AND PCE.ElasticSearchEvent <> 2

		Insert into  ZnodePublishAddonEntity
		(VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,
			LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault,ElasticSearchEvent)
		Select 
			VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,Isnull(AssociatedProductDisplayOrder,0),
			LocaleId,GroupName,DisplayType,DisplayOrder,1 IsRequired,RequiredType,IsDefault, 1 AS ElasticSearchEvent
		from #AddonProductPublishedXML CE
		WHERE NOT EXISTS(SELECT * FROM ZnodePublishAddonEntity PCE WHERE CE.VersionId = PCE.VersionId
		AND PCE.LocaleId = CE.LocaleId AND PCE.ZnodeCatalogId = CE.PublishCatalogId AND CE.ZnodeProductId = PCE.ZnodeProductId
		AND PCE.AssociatedZnodeProductId = CE.AssociatedZnodeProductId AND PCE.ElasticSearchEvent <> 2)
		
		SET @Status = 1;
            
    END TRY
    BEGIN CATCH
		SELECT ERROR_MESSAGE(),ERROR_PROCEDURE()
            
        SET @Status = 0;
        DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishAssociatedAddonsJson @PublishCatalogId = '+@PublishCatalogId+',@VersionId='+CAST(@VersionId AS VARCHAR(50))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
        SELECT 0 AS ID,
            CAST(0 AS BIT) AS Status;
        EXEC Znode_InsertProcedureErrorLog
            @ProcedureName = 'Znode_GetPublishAssociatedAddonsJson',
            @ErrorInProcedure = @Error_procedure,
            @ErrorMessage = @ErrorMessage,
            @ErrorLine = @ErrorLine,
            @ErrorCall = @ErrorCall;
    END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishAssociatedProductsJson')
	DROP PROC Znode_GetPublishAssociatedProductsJson
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishAssociatedProductsJson]    
(       
     @PublishCatalogId VARCHAR(MAX) = '',    
     @PimProductId     TransferId Readonly,    
     @ProductType      VARCHAR(300) = 'BundleProduct',    
     @VersionId        INT          = 0,    
     @UserId           INT,    
     @PimCategoryHierarchyId int = 0,    
     @PublishStateId INT = 0  ,    
     @VersionIdString  VARCHAR(2000)= '',    
     @Status  BIT  Output,    
     @RevisionType Varchar(50) = ''    
)    
AS    
  /*    
    Summary : If PimcatalogId is provided then get all  Bundles / Group / Configurable product and  provide above mentioned data    
              If PimProductId is provided then get all Bundles / Group / Configurable if associated with given product id and provide above mentioned data    
       Input: @PublishCatalogId or @PimProductId    
       Output should be in XML format    
             Required o/p    
       <BundleProductEntity>    
       <ZnodeProductId></ZnodeProductId>    
       <ZnodeCatalogId></ZnodeCatalogId>    
       <AsscociadedZnodeProductIds></AsscociadedZnodeProductIds>    
       </BundleProductEntity>    
    Unit Testing     
    BundleProduct    
 DECLARE     
    EXEC [dbo].[Znode_GetPublishAssociatedProducts] @PublishCatalogId = 1  , @ProductType = 'BundleProduct' ,@userId = 2     
    EXEC [dbo].[Znode_GetPublishAssociatedProducts] @PublishCatalogId =2 , @ProductType = 'ConfigurableProduct',@userId = 2 ,@PimCategoryHierarchyId = 7     
    Group Product    
    EXEC [dbo].[Znode_GetPublishAssociatedProducts]  @PublishCatalogId ='2',@PimProductIdh =''  , @PimProducttType = 'GroupedProduct'    
    EXEC [dbo].[Znode_GetPublishAssociatedProducts]  @PublishCatalogId ='',@PimProductId ='200066'  , @PimProducttType = 'GroupedProduct'    
    EXEC [dbo].[Znode_GetPublishAssociatedProducts] @PimProductId ='200066'  , @PimProducttType = 'GroupedProduct'    
   */    
BEGIN    
BEGIN TRAN GetPublishAssociatedProducts;    
BEGIN TRY    
SET NOCOUNT ON;    
      
    IF OBJECT_ID('tempdb..#VesionIds') is not null    
    DROP TABLE #VesionIds    
    Create Table #VesionIds(ZnodeCatalogId int , VersionId int , LocaleId int , RevisionType varchar(50) )    
    
      If @VersionIdString <> ''       
    Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)     
    SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV Inner join Split(@VersionIdString,',') S ON PV.VersionId = S.Item    
    Else     
    Begin    
     If  (@RevisionType like '%Preview%'  OR @RevisionType like '%Production%' )    
      Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)     
      SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV  where PV.IsPublishSuccess =1     
      AND PV.RevisionType ='Preview'    
    
     If  (@RevisionType like '%Production%' OR @RevisionType = 'None')    
      Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)     
      SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV  where PV.IsPublishSuccess =1     
      AND PV.RevisionType ='Production'    
     end     
    
   IF OBJECT_ID('tempdb..#TBL_PublishCatalogId') is not null    
    DROP TABLE #TBL_PublishCatalogId    
       
   CREATE TABLE #TBL_PublishCatalogId (PublishCatalogId INT,PublishProductId INT,PimProductId  INT , VersionId INT,LocaleId INT  );    
   DECLARE  @PimAttributeId INT = [dbo].[Fn_GetProductTypeAttributeId]()    
     ,@PimAttributeDefaultValueId INT = (SELECT TOP 1 PimAttributeDefaultValueId FROM ZnodePimAttributeDefaultValue WHERE AttributeDefaultValueCode = @ProductType)    
     ,@DefaultLocaleId INT = dbo.fn_getDefaultlocaleId()     
   DECLARE @GetDate DATETIME =dbo.Fn_GetDate()    
        
   IF OBJECT_ID('tempdb..#TBL_PublisshIds') is not null    
   DROP TABLE #TBL_PublisshIds    
   Create TABLE #TBL_PublisshIds (PublishProductId INT , PimProductId INT , PublishCatalogId INT)    
    
   DECLARE  @PimProductId_New TransferId    
          
    IF  @PublishCatalogId IS NULL  OR @PublishCatalogId = 0     
    BEGIN     
    INSERT INTO #TBL_PublisshIds     
    Select ZPP.PublishProductId ,ZPP.PimProductId , ZPP.PublishCatalogId from ZnodePublishProduct ZPP Inner join @PimProductId  PPI on ZPP.PimProductId = PPI.ID    
      --EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId,@userid,@PimProductId,1    
          
      INSERT INTO @PimProductId_New    
      SELECT DISTINCT PimProductId FROM #TBL_PublisshIds    
    
     -- SELECT  @PimProductId     
    END     
        
    IF  ISnull(@PimCategoryHierarchyId,0) <> 0     
    BEGIN     
        
      INSERT INTO #TBL_PublisshIds     
      EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId,@userid,@PimProductId,1,@PimCategoryHierarchyId    
          
      --SET @PimProductId = SUBSTRING((SELECT DISTINCT ','+CAST(PimProductId AS VARCHAr(50)) FROM #TBL_PublisshIds FOR XML PATH ('')),2,8000 )    
    
      INSERT INTO @PimProductId_New    
      SELECT PimProductId FROM #TBL_PublisshIds    
    
          
    END     
    
    IF  ISnull(@PimCategoryHierarchyId,0) <> 0     
    BEGIN     
     INSERT INTO #TBL_PublishCatalogId     
     SELECT ZPP.PublishCatalogId , ZPP.PublishProductId,ZPP.PimProductId,MAX(ZPCP.PublishCatalogLogId) ,ZPCP.LocaleID      
     FROM ZnodePublishProduct ZPP     
     INNER JOIN ZnodePimAttributeValue ZPV ON (ZPV.PimProductId = ZPP.PimProductId )    
     INNER JOIN ZnodePimProductAttributeDefaultValue ZPAVL ON (ZPAVL.PimAttributeValueId = ZPV.PimAttributeValueId)    
     LEFT JOIN  ZnodePublishCatalogLog ZPCP ON (ZPCP.PublishCatalogId  = ZPP.PublishCatalogId)    
     WHERE (EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId   )     
     AND  (ZPP.PublishCatalogId =  @PublishCatalogId ))    
     AND ZPV.PimAttributeId  = @PimAttributeId    
     AND ZPAVL.PimAttributeDefaultValueId= @PimAttributeDefaultValueId    
     AND ZPAVL.LocaleId = @DefaultLocaleId    
     AND ISNULL(ZPCP.LocaleId,0) <> 0     
     AND ZPCP.PublishStateId= @PublishStateId    
     AND EXISTS(SELECT * FROM ZnodeLocale ZL where ZL.IsActive = 1  and ZPCP.LocaleId = ZL.LocaleId )    
     GROUP BY ZPP.PublishCatalogId , ZPP.PublishProductId,ZPP.PimProductId,ZPCP.LocaleID     
         
    END    
    ELSE     
    BEGIN     
        
    IF NOT EXISTS (SELECT TOP 1 1 FROM @PimProductId ) AND @PublishCatalogId <> 0    
    BEGIN    
      INSERT INTO #TBL_PublishCatalogId     
      SELECT distinct ZPP.PublishCatalogId , ZPP.PublishProductId,ZPP.PimProductId,  ZPCP.VersionId PublishCatalogLogId ,ZPCP.LocaleID     
      FROM ZnodePublishProduct ZPP     
      INNER JOIN ZnodePimAttributeValue ZPV ON (ZPV.PimProductId = ZPP.PimProductId )    
      INNER JOIN ZnodePimProductAttributeDefaultValue ZPAVL ON (ZPAVL.PimAttributeValueId = ZPV.PimAttributeValueId)    
      INNER JOIN  #VesionIds  ZPCP ON (ZPCP.ZnodeCatalogId  = ZPP.PublishCatalogId AND ISNULL(ZPCP.LocaleId,0) <> 0 )            
      WHERE     
      --(EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId  AND  @PublishCatalogId = '' )     
      --OR     
      (ZPP.PublishCatalogId =  @PublishCatalogId )    
      AND ZPV.PimAttributeId  = @PimAttributeId    
      AND ZPAVL.PimAttributeDefaultValueId= @PimAttributeDefaultValueId    
      AND ZPAVL.LocaleId = @DefaultLocaleId    
      AND EXISTS(SELECT * FROM ZnodeLocale ZL where ZL.IsActive = 1  and ZPCP.LocaleId = ZL.LocaleId )    
    END    
    ELSE    
    BEGIN    
      INSERT INTO #TBL_PublishCatalogId     
          
      SELECT distinct ZPP.PublishCatalogId , ZPP.PublishProductId,ZPP.PimProductId,  ZPCP.VersionId PublishCatalogLogId ,ZPCP.LocaleID     
      FROM ZnodePublishProduct ZPP     
      INNER JOIN ZnodePimAttributeValue ZPV ON (ZPV.PimProductId = ZPP.PimProductId )    
      INNER JOIN ZnodePimProductAttributeDefaultValue ZPAVL ON (ZPAVL.PimAttributeValueId = ZPV.PimAttributeValueId)    
      LEFT JOIN  #VesionIds ZPCP ON (ZPCP.ZnodeCatalogId  = ZPP.PublishCatalogId AND ISNULL(ZPCP.LocaleId,0) <> 0 )            
      WHERE (EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId  AND ZPP.PublishCatalogId = SP.PublishCatalogId) )    
      AND ZPV.PimAttributeId  = @PimAttributeId    
      AND ZPAVL.PimAttributeDefaultValueId= @PimAttributeDefaultValueId    
      AND ZPAVL.LocaleId = @DefaultLocaleId    
      AND EXISTS(SELECT * FROM ZnodeLocale ZL where ZL.IsActive = 1  and ZPCP.LocaleId = ZL.LocaleId )    
      --GROUP BY ZPP.PublishCatalogId , ZPP.PublishProductId,ZPP.PimProductId,ZPCP.LocaleID,    
    
    END     
         
    END    
        
             DECLARE @TBL_ProductTypeXML TABLE    
             (PublishProductId INT,    
			  PublishCatalogId INT,    
              ReturnXML        XML,    
              VersionId        INT    
             );    
             DECLARE @TBL_PimProductId TABLE    
             ([PimProductId]   INT,    
              PublishCatalogId INT,    
			  PublishProductId INT    
             );    
                
             DECLARE @TBL_PimAssociatedEntity TABLE    
             (    
				ZnodeProductId INT,    
				ZnodeCatalogId INT,    
				AsscociadedZnodeProductIds VARCHAR(MAX),    
				ConfigurableProductEntity NVARCHAR(MAX),    
				LocaleId INT,    
				DisplayOrder INT,    
				VersionId INT    
             );    
    
    If @ProductType = 'BundleProduct' AND Exists (Select TOP 1 1 from #TBL_PublishCatalogId)    
    Begin    
               IF OBJECT_ID('tempdb..#BundleProductPublishedXML') is not null    
					drop table #BundleProductPublishedXML    
    
		 IF (isnull(@PublishCatalogId ,'') = '' or isnull(@PublishCatalogId,0) = 0) and @VersionIdString = ''    
		 Begin     
			  UPDATE ZnodePublishBundleProductEntity SET ElasticSearchEvent = 2 
			  where not exists(select * from ZnodePublishProduct where ZnodePublishBundleProductEntity.ZnodeProductId = ZnodePublishProduct.PublishProductId)    
          
			  UPDATE ZnodePublishBundleProductEntity SET ElasticSearchEvent = 2 
			  where Exists ( Select TOP 1 1 from     
			  #TBL_PublishCatalogId A where ZnodePublishBundleProductEntity.ZnodeCatalogId =A.PublishCatalogId AND     
			  ZnodePublishBundleProductEntity.ZnodeProductId  = A.PublishProductId )    
			  AND Exists (SELECT TOP 1 1 FRoM #VesionIds     
			  Where ZnodePublishBundleProductEntity.VersionId =  #VesionIds.VersionId)    
		END     
    
		 UPDATE ZPBP SET AssociatedProductDisplayOrder = ISNULL(ZPTA.DisplayOrder,0),AssociatedProductBundleQuantity = ISNULL(ZPTA.BundleQuantity,1)
		 FROM #TBL_PublishCatalogId TBP    
		 INNER JOIN ZnodePimProductTypeAssociation ZPTA ON(ZPTA.PimParentProductId = TBP.PimProductId)    
		 INNER JOIN ZnodePublishProduct TBPU ON (TBPU.PimProductId = ZPTA.PimProductId AND TBPU.PublishCatalogId = TBP.PublishCatalogId )
		 INNER JOIN ZnodePublishBundleProductEntity ZPBP on  TBP.VersionId = ZPBP.VersionId AND TBP.PublishProductId = ZPBP.ZnodeProductId
			AND TBP.PublishCatalogId = ZPBP.ZnodeCatalogId AND TBPU.PublishProductId = ZPBP.AssociatedZnodeProductId
		 WHERE ZPBP.ElasticSearchEvent <> 2 


		 INSERT INTO ZnodePublishBundleProductEntity     
		 (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,AssociatedProductBundleQuantity)    
		 SELECT TBP.VersionId, TBP.PublishProductId, TBP.PublishCatalogId ,    
		 TBPU.PublishProductId AssociatedZnodeProductId,ISNULL(ZPTA.DisplayOrder,0)  AssociatedProductDisplayOrder,ISNULL(ZPTA.BundleQuantity,1)  AS AssociatedProductBundleQuantity  
		 FROM #TBL_PublishCatalogId TBP    
		 INNER JOIN ZnodePimProductTypeAssociation ZPTA ON(ZPTA.PimParentProductId = TBP.PimProductId)    
		 INNER JOIN ZnodePublishProduct TBPU ON (TBPU.PimProductId = ZPTA.PimProductId AND TBPU.PublishCatalogId = TBP.PublishCatalogId )
		 WHERE NOT EXISTS(SELECT * FROM ZnodePublishBundleProductEntity ZPBP WHERE  TBP.VersionId = ZPBP.VersionId AND TBP.PublishProductId = ZPBP.ZnodeProductId
			AND TBP.PublishCatalogId = ZPBP.ZnodeCatalogId AND TBPU.PublishProductId = ZPBP.AssociatedZnodeProductId AND ZPBP.ElasticSearchEvent <> 2 )
   End     
   
   If @ProductType = 'GroupedProduct' AND Exists (Select TOP 1 1 from #TBL_PublishCatalogId)    
   Begin    
		 IF (isnull(@PublishCatalogId ,'') = '' or isnull(@PublishCatalogId,0) = 0) and @VersionIdString = ''    
		 Begin     
			  UPDATE ZnodePublishGroupProductEntity SET ElasticSearchEvent = 2     
			  WHERE NOT EXISTS(SELECT * FROM ZnodePublishProduct WHERE ZnodePublishGroupProductEntity.ZnodeProductId = ZnodePublishProduct.PublishProductId)    
            
			  UPDATE ZnodePublishGroupProductEntity SET ElasticSearchEvent = 2  
			  where Exists ( Select TOP 1 1 from     
				  #TBL_PublishCatalogId A where ZnodePublishGroupProductEntity.ZnodeCatalogId =A.PublishCatalogId AND     
				  ZnodePublishGroupProductEntity.ZnodeProductId  = A.PublishProductId )    
				  AND Exists (SELECT TOP 1 1 FRoM #VesionIds     
			   Where ZnodePublishGroupProductEntity.VersionId =  #VesionIds.VersionId)    
		 end     
    
	  UPDATE ZPGP SET AssociatedProductDisplayOrder = ISNULL(ZPTA.DisplayOrder,0)
	  FROM #TBL_PublishCatalogId TBP    
      INNER JOIN ZnodePimProductTypeAssociation ZPTA ON(ZPTA.PimParentProductId = TBP.PimProductId)    
      INNER JOIN ZnodePublishProduct TBPU ON (TBPU.PimProductId = ZPTA.PimProductId AND TBPU.PublishCatalogId = TBP.PublishCatalogId )    
	  INNER JOIN ZnodePublishGroupProductEntity ZPGP ON ZPGP.VersionId = TBP.VersionId AND ZPGP.ZnodeProductId = TBP.PublishProductId 
		AND ZPGP.ZnodeCatalogId = TBP.PublishCatalogId AND ZPGP.AssociatedZnodeProductId = TBPU.PublishProductId AND ZPGP.ElasticSearchEvent <> 2  

      INSERT INTO ZnodePublishGroupProductEntity(VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder)    
      SELECT TBP.VersionId, TBP.PublishProductId ,TBP.PublishCatalogId ,TBPU.PublishProductId ,ISNULL(ZPTA.DisplayOrder,0)    
      FROM #TBL_PublishCatalogId TBP    
      INNER JOIN ZnodePimProductTypeAssociation ZPTA ON(ZPTA.PimParentProductId = TBP.PimProductId)    
      INNER JOIN ZnodePublishProduct TBPU ON (TBPU.PimProductId = ZPTA.PimProductId AND TBPU.PublishCatalogId = TBP.PublishCatalogId )    
	  WHERE NOT EXISTS(SELECT * FROM ZnodePublishGroupProductEntity ZPGP WHERE ZPGP.VersionId = TBP.VersionId AND ZPGP.ZnodeProductId = TBP.PublishProductId 
		AND ZPGP.ZnodeCatalogId = TBP.PublishCatalogId AND ZPGP.AssociatedZnodeProductId = TBPU.PublishProductId AND ZPGP.ElasticSearchEvent <> 2  )
   End     
            
			
   If @ProductType = 'ConfigurableProduct' AND Exists (Select TOP 1 1 from #TBL_PublishCatalogId)    
   Begin    
		 If (isnull(@PublishCatalogId ,'') = '' or isnull(@PublishCatalogId,0) = 0) and @VersionIdString = ''    
		 Begin    
			  UPDATE ZnodePublishConfigurableProductEntity SET ElasticSearchEvent = 2       
			  where not exists(select * from ZnodePublishProduct where ZnodePublishConfigurableProductEntity.ZnodeProductId = ZnodePublishProduct.PublishProductId)    
        
			  UPDATE ZnodePublishConfigurableProductEntity SET ElasticSearchEvent = 2  
			  where Exists ( Select TOP 1 1 from     
			  #TBL_PublishCatalogId A where ZnodePublishConfigurableProductEntity.ZnodeCatalogId =A.PublishCatalogId AND     
			  ZnodePublishConfigurableProductEntity.ZnodeProductId  = A.PublishProductId )     
			  AND Exists (SELECT TOP 1 1 FRoM #VesionIds     
			   Where ZnodePublishConfigurableProductEntity.VersionId =  #VesionIds.VersionId)    
		 end     
    
		SELECT DISTINCT TBP.VersionId, TBP.PublishProductId ,    
			  TBP.PublishCatalogId ,    
			  Isnull(TBPU.PublishProductId,0) AssociatedZnodeProductId,     
			  ISNULL(ZPTA.DisplayOrder,0) DisplayOrder,'[]' SelectValues,          
			  '[' + Isnull(SUBSTRING((SELECT Distinct ','+ +'"'+CAST(ZPA.AttributeCode AS VARCHAR(50)) +'"'     
			  FROM ZnodePimConfigureProductAttribute ZPCPA     
			  LEFT JOIN ZnodePimAttribute ZPA ON Zpa.PimAttributeId = ZPCPA.PimAttributeId 
			  WHERE ZPTA.PimParentProductId = ZPCPA.PimProductId
			  FOR XML PATH ('') ),2,2000),Null) +']' as ConfigurableAttributeCodes    
			  , ZPTA.IsDefault  
		  INTO #TempConfigurableProductEntity 
		 FROM #TBL_PublishCatalogId TBP    
		 INNER JOIN ZnodePimProductTypeAssociation ZPTA ON(ZPTA.PimParentProductId = TBP.PimProductId)    
		 INNER JOIN ZnodePublishProduct TBPU ON (TBPU.PimProductId = ZPTA.PimProductId AND TBPU.PublishCatalogId = TBP.PublishCatalogId )    
    
		 UPDATE ZPCP SET ZPCP.AssociatedProductDisplayOrder = AssociatedProductDisplayOrder,
			ConfigurableAttributeCodes = TBP.ConfigurableAttributeCodes,IsDefault = TBP.IsDefault
		 FROM #TempConfigurableProductEntity TBP    
		 INNER JOIN ZnodePublishConfigurableProductEntity ZPCP ON ZPCP.VersionId = TBP.VersionId 
			AND ZPCP.ZnodeProductId = TBP.PublishProductId AND ZPCP.ZnodeCatalogId = TBP.PublishCatalogId AND ZPCP.AssociatedZnodeProductId = TBP.AssociatedZnodeProductId

		  Insert into ZnodePublishConfigurableProductEntity 
		  (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,    
		  SelectValues,ConfigurableAttributeCodes, IsDefault)    
		  SELECT DISTINCT TBP.VersionId, TBP.PublishProductId ,    
			  TBP.PublishCatalogId , TBP.AssociatedZnodeProductId,TBP.DisplayOrder ,TBP.SelectValues,          
			  TBP.ConfigurableAttributeCodes, TBP.IsDefault  
		 FROM #TempConfigurableProductEntity TBP    
		 WHERE NOT EXISTS(SELECT * FROM ZnodePublishConfigurableProductEntity ZPCP WHERE ZPCP.VersionId = TBP.VersionId 
			AND ZPCP.ZnodeProductId = TBP.PublishProductId AND ZPCP.ZnodeCatalogId = TBP.PublishCatalogId AND ZPCP.AssociatedZnodeProductId = TBP.AssociatedZnodeProductId)

      IF OBJECT_ID('tempdb..#TBL_PublishCatalogId') is not null    
       drop table #TBL_PublishCatalogId    
    
      IF OBJECT_ID('tempdb..#ConfigurableProductPublishedXML') is not null    
       drop table #ConfigurableProductPublishedXML    
    
End     
COMMIT TRAN GetPublishAssociatedProducts;    
SET @Status = 1;    
END TRY    
	BEGIN CATCH    
	SELECT ERROR_MESSAGE()    
	SET @Status = 0;    
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishAssociatedProductsJson @PublishCatalogId = '+@PublishCatalogId+',@ProductType= '+@ProductType+',@VersionId='+CAST(@VersionId AS VARCHAR(50))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));    
                      
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                        
	ROLLBACK TRANSACTION GetPublishAssociatedProducts;    
	EXEC Znode_InsertProcedureErrorLog    
	@ProcedureName = 'Znode_GetPublishAssociatedProductsJson',    
	@ErrorInProcedure = @Error_procedure,    
	@ErrorMessage = @ErrorMessage,    
	@ErrorLine = @ErrorLine,    
	@ErrorCall = @ErrorCall;    
END CATCH;    
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishCategoryJson')
	DROP PROC Znode_GetPublishCategoryJson
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishCategoryJson]
(   
	@PublishCatalogId INT,
	@UserId           INT,
	@Status           BIT = 0 OUT,
	@IsDebug          BIT = 0,
	@VersionIdString  VARCHAR(2000)= '',
	@LocaleId         TransferID READONLY,
	@RevisionState    VARCHAR(50) = ''
)
AS 
/*
Summary:Publish category with their respective products and details 
The result is fetched in xml form   
Unit Testing   
Begin transaction 
SELECT * FROM ZnodePIMAttribute 
SELECT * FROM ZnodePublishCatalog 
SELECT * FROM ZnodePublishCategory WHERE publishCAtegoryID = 167 


EXEC [Znode_GetPublishCategory] @PublishCatalogId = 3,@VersionId = 0 ,@UserId =2 ,@IsDebug = 1 
     


Rollback Transaction 
*/
BEGIN
BEGIN TRAN GetPublishCategory;
BEGIN TRY
SET NOCOUNT ON;
	DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
	DECLARE @LocaleIdIn INT= 0, @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId(), @Counter INT= 1, @MaxId INT= 0, @CategoryIdCount INT;
	DECLARE @IsActive BIT= [dbo].[Fn_GetIsActiveTrue]();
	DECLARE @AttributeIds VARCHAR(MAX)= '', @PimCategoryIds VARCHAR(MAX)= '', @DeletedPublishCategoryIds VARCHAR(MAX)= '', @DeletedPublishProductIds VARCHAR(MAX);
	--get the pim catalog id 
	DECLARE @PimCatalogId INT=(SELECT PimCatalogId FROM ZnodePublishcatalog WHERE PublishCatalogId = @PublishCatalogId); 

	DECLARE @TBL_AttributeIds TABLE
	(
		PimAttributeId       INT,
		ParentPimAttributeId INT,
		AttributeTypeId      INT,
		AttributeCode        VARCHAR(600),
		IsRequired           BIT,
		IsLocalizable        BIT,
		IsFilterable         BIT,
		IsSystemDefined      BIT,
		IsConfigurable       BIT,
		IsPersonalizable     BIT,
		DisplayOrder         INT,
		HelpDescription      VARCHAR(MAX),
		IsCategory           BIT,
		IsHidden             BIT,
		CreatedDate          DATETIME,
		ModifiedDate         DATETIME,
		AttributeName        NVARCHAR(MAX),
		AttributeTypeName    VARCHAR(300)
	);
	DECLARE @TBL_AttributeDefault TABLE
	(
		PimAttributeId            INT,
		AttributeDefaultValueCode VARCHAR(100),
		IsEditable                BIT,
		AttributeDefaultValue     NVARCHAR(MAX)
		,DisplayOrder   INT
	);
	DECLARE @TBL_AttributeValue TABLE
	(
		PimCategoryAttributeValueId INT,
		PimCategoryId               INT,
		CategoryValue               NVARCHAR(MAX),
		AttributeCode               VARCHAR(300),
		PimAttributeId              INT
	);
	DECLARE @TBL_LocaleIds TABLE
	(
		RowId     INT IDENTITY(1, 1),
		LocaleId  INT,
		IsDefault BIT
	);
	DECLARE @TBL_PimCategoryIds TABLE
	(
		PimCategoryId       INT,
		PimParentCategoryId INT,
		DisplayOrder        INT,
		ActivationDate      DATETIME,
		ExpirationDate      DATETIME,
		CategoryName        NVARCHAR(MAX),
		ProfileId           VARCHAR(MAX),
		IsActive            BIT,
		PimCategoryHierarchyId INT,
		ParentPimCategoryHierarchyId INT ,
		CategoryCode  NVARCHAR(MAX)             
	);


	DECLARE @TBL_PublishPimCategoryIds TABLE
	(
		PublishCategoryId       INT,
		PimCategoryId           INT,
		PublishProductId        varchar(max),
		PublishParentCategoryId INT ,
		PimCategoryHierarchyId INT ,parentPimCategoryHierarchyId INT,
		RowIndex INT
	);
	DECLARE @TBL_DeletedPublishCategoryIds TABLE
	(
		PublishCategoryId INT,
		PublishProductId  INT
	);
	DECLARE @TBL_CategoryXml TABLE
	(
		PublishCategoryId INT,
		CategoryXml       XML,
		LocaleId          INT
	);
	INSERT INTO @TBL_LocaleIds
	(
		LocaleId,
		IsDefault
	)
	-- here collect all locale ids
	SELECT LocaleId,IsDefault FROM ZnodeLocale MT WHERE IsActive = @IsActive
	AND (EXISTS (SELECT TOP 1 1  FROM @LocaleId RT WHERE RT.Id = MT.LocaleId )
	OR NOT EXISTS (SELECT TOP 1 1 FROM @LocaleId ));

	IF OBJECT_ID('tempdb..#VesionIds') is not null
		DROP TABLE #VesionIds
  				 
	SELECT PV.* INTO #VesionIds FROM ZnodePublishVersionEntity PV Inner join Split(@VersionIdString,',') S ON PV.VersionId = S.Item
		

	if object_id('tempdb..#CategoryData')is not null
		DROP TABLE #CategoryData

	------------for CategoryCode update
	SELECT ZPCAL.CategoryValue as CategoryCode,MAX(ZPC.PublishCategoryId) as PublishCategoryId ,ZPCA.PimCategoryId, ZPoC.PortalId
	INTO #CategoryData
	FROM ZnodePimCategoryAttributeValue ZPCA
	INNER JOIN ZnodePimCategoryAttributeValueLocale ZPCAL on ZPCA.PimCategoryAttributeValueId = ZPCAL.PimCategoryAttributeValueId
	INNER JOIN ZnodePimAttribute ZPA ON ZPCA.PimAttributeId = ZPA.PimAttributeId
	INNER JOIN ZnodePublishCategory ZPC on ZPCA.PimCategoryId = ZPC.PimCategoryId
	INNER JOIN ZnodePortalCatalog ZPoC on ZPC.PublishCatalogId = ZPoC.PublishCatalogId
	WHERE ZPA.AttributeCode = 'CategoryCode' AND ZPC.PublishCatalogId = @PublishCatalogId
	AND EXISTS(SELECT * FROM ZnodeCMSWidgetCategory ZCWC WHERE ZPC.PublishCategoryId = ZCWC.PublishCategoryId )
	GROUP BY ZPCAL.CategoryValue, ZPCA.PimCategoryId, ZPoC.PortalId

	UPDATE ZCWC SET ZCWC.CategoryCode = CD.CategoryCode
	FROM ZnodeCMSWidgetCategory ZCWC
	INNER JOIN #CategoryData CD ON ZCWC.PublishCategoryId = CD.PublishCategoryId and ZCWC.CMSMappingId = CD.PortalId
	WHERE ZCWC.TypeOFMapping = 'PortalMapping'
	----------

	INSERT INTO @TBL_PimCategoryIds(PimCategoryId,PimParentCategoryId,DisplayOrder,ActivationDate,ExpirationDate,IsActive,PimCategoryHierarchyId,ParentPimCategoryHierarchyId)
	SELECT DISTINCT ZPCH.PimCategoryId,ZPCH2.PimCategoryId  PimParentCategoryId,ZPCH.DisplayOrder,ZPCH.ActivationDate,ZPCH.ExpirationDate,ZPCH.IsActive ,ZPCH.PimCategoryHierarchyId,ZPCH.ParentPimCategoryHierarchyId
	FROM ZnodePimCategoryHierarchy AS ZPCH 
	LEFT JOIN ZnodePimCategoryHierarchy AS ZPCH2 ON (ZPCH2.PimCategoryHierarchyId = ZPCH. ParentPimCategoryHierarchyId ) 
	WHERE ZPCH.PimCatalogId = @PimCatalogId; 
	
	-- here is find the deleted publish category id on basis of publish catalog
	INSERT INTO @TBL_DeletedPublishCategoryIds(PublishCategoryId,PublishProductId)
	SELECT ZPC.PublishCategoryId,ZPCP.PublishProductId 
	FROM ZnodePublishCategoryProduct ZPCP
	INNER JOIN ZnodePublishCategory AS ZPC ON(ZPCP.PublishCategoryId = ZPC.PublishCategoryId AND ZPCP.PublishCatalogId = ZPC.PublishCatalogId)                                                  
	INNER JOIN ZnodePublishProduct ZPP ON(zpp.PublishProductId = zpcp.PublishProductId AND zpp.PublishCatalogId = zpcp.PublishCatalogId)
	INNER JOIN ZnodePublishCatalog ZPCC ON(ZPCC.PublishCatalogId = ZPCP.PublishCatalogId)
	WHERE ZPC.PublishCatalogId = @PublishCataLogId 
	AND NOT EXISTS(SELECT TOP 1 1 FROM ZnodePimCategoryHierarchy AS TBPC WHERE TBPC.PimCategoryId = ZPC.PimCategoryId AND TBPC.PimCategoryHierarchyId = ZPC.PimCategoryHierarchyId
	AND TBPC.PimCatalogId = ZPCC.PimCatalogId);

	-- here is find the deleted publish category id on basis of publish catalog
	SET @DeletedPublishCategoryIds = ISNULL(SUBSTRING((SELECT ','+CAST(PublishCategoryId AS VARCHAR(50)) FROM @TBL_DeletedPublishCategoryIds AS ZPC
				GROUP BY ZPC.PublishCategoryId FOR XML PATH('') ), 2, 4000), '');
	-- here is find the deleted publish category id on basis of publish catalog
	SET @DeletedPublishProductIds = '';
	
	EXEC Znode_DeletePublishCatalog @PublishCatalogIds = @PublishCatalogId,@PublishCategoryIds = @DeletedPublishCategoryIds,@PublishProductIds = @DeletedPublishProductIds; 
		
	MERGE INTO ZnodePublishCategory TARGET USING  @TBL_PimCategoryIds SOURCE ON
	(
		TARGET.PimCategoryId = SOURCE.PimCategoryId 
		AND TARGET.PublishCatalogId = @PublishCataLogId 
		AND TARGET.PimCategoryHierarchyId = SOURCE.PimCategoryHierarchyId
	)
	WHEN MATCHED THEN UPDATE SET TARGET.PimParentCategoryId = SOURCE.PimParentCategoryId,TARGET.CreatedBy = @UserId,TARGET.CreatedDate = @GetDate,
	TARGET.ModifiedBy = @UserId,TARGET.ModifiedDate = @GetDate,PimCategoryHierarchyId = SOURCE.PimCategoryHierarchyId,ParentPimCategoryHierarchyId=SOURCE.ParentPimCategoryHierarchyId
	WHEN NOT MATCHED THEN INSERT(PimCategoryId,PublishCatalogId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PimCategoryHierarchyId,ParentPimCategoryHierarchyId) 
	VALUES(SOURCE.PimCategoryId,@PublishCatalogId,@UserId,@GetDate,@UserId,@GetDate,SOURCE.PimCategoryHierarchyId,SOURCE.ParentPimCategoryHierarchyId)
	OUTPUT INSERTED.PublishCategoryId,INSERTED.PimCategoryId,INSERTED.PimCategoryHierarchyId,INSERTED.parentPimCategoryHierarchyId INTO @TBL_PublishPimCategoryIds(PublishCategoryId,PimCategoryId,PimCategoryHierarchyId,parentPimCategoryHierarchyId);
     
	-- here update the publish parent category id
	UPDATE ZPC SET [PimParentCategoryId] =TBPC.[PimCategoryId] 
	FROM ZnodePublishCategory ZPC
	INNER JOIN ZnodePublishCategory TBPC ON(ZPC.parentPimCategoryHierarchyId = TBPC.PimCategoryHierarchyId  ) 
	WHERE ZPC.PublishCatalogId =@PublishCatalogId
	AND ZPC.ParentPimCategoryHierarchyId IS NOT NULL
	AND TBPC.PublishCatalogId =@PublishCatalogId;

	UPDATE a
	SET  a.PublishParentCategoryId = b.PublishCategoryId
	FROM ZnodePublishCategory a 
	INNER JOIN ZnodePublishCategory b   ON (a.parentpimCategoryHierarchyId = b.pimCategoryHierarchyId)
	WHERE a.parentpimCategoryHierarchyId IS NOT NULL 
	AND a.PublishCatalogId =@PublishCatalogId
	AND b.PublishCatalogId =@PublishCatalogId

	UPDATE a set a.PublishParentCategoryId = NULL
	FROM ZnodePublishCategory a 
	WHERE a.parentpimCategoryHierarchyId IS NULL AND PimParentCategoryId IS NULL
	AND a.PublishCatalogId = @PublishCatalogId AND a.PublishParentCategoryId IS NOT NULL

	SET @MaxId =(SELECT MAX(RowId)FROM @TBL_LocaleIds);
	DECLARE @TransferID TRANSFERID 
	INSERT INTO @TransferID 
	SELECT DISTINCT  PimCategoryId
	FROM @TBL_PublishPimCategoryIds 

	SET @PimCategoryIds = SUBSTRING((SELECT ','+CAST(PimCategoryId AS VARCHAR(50)) FROM @TBL_PublishPimCategoryIds FOR XML PATH('')), 2, 4000);
		
	WHILE @Counter <= @MaxId -- Loop on Locale id 
	BEGIN
		SET @LocaleIdIn =(SELECT LocaleId FROM @TBL_LocaleIds WHERE RowId = @Counter);
                   
		SET @AttributeIds = SUBSTRING((SELECT ','+CAST(ZPCAV.PimAttributeId AS VARCHAR(50)) FROM ZnodePimCategoryAttributeValue ZPCAV 
				WHERE EXISTS(SELECT TOP 1 1 FROM @TBL_PimCategoryIds TBPC WHERE TBPC.PimCategoryId = ZPCAV.PimCategoryId) GROUP BY ZPCAV.PimAttributeId FOR XML PATH('')), 2, 4000);
                
		SET @CategoryIdCount =(SELECT COUNT(1) FROM @TBL_PimCategoryIds);

		INSERT INTO @TBL_AttributeIds (PimAttributeId,ParentPimAttributeId,AttributeTypeId,AttributeCode,IsRequired,IsLocalizable,IsFilterable,IsSystemDefined,
		IsConfigurable,IsPersonalizable,DisplayOrder,HelpDescription,IsCategory,IsHidden,CreatedDate,ModifiedDate,AttributeName,AttributeTypeName)
		EXEC [Znode_GetPimAttributesDetails] @AttributeIds,@LocaleIdIn;

		INSERT INTO @TBL_AttributeDefault (PimAttributeId,AttributeDefaultValueCode,IsEditable,AttributeDefaultValue,DisplayOrder)
		EXEC [dbo].[Znode_GetAttributeDefaultValueLocale] @AttributeIds,@LocaleIdIn;

		INSERT INTO @TBL_AttributeValue (PimCategoryAttributeValueId,PimCategoryId,CategoryValue,AttributeCode,PimAttributeId)
		EXEC [dbo].[Znode_GetCategoryAttributeValueId] @TransferID,@AttributeIds,@LocaleIdIn;


		;WITH Cte_UpdateDefaultAttributeValue AS 
		(
			SELECT TBAV.PimCategoryId,TBAV.PimAttributeId,SUBSTRING((SELECT ','+AttributeDefaultValue FROM @TBL_AttributeDefault TBD WHERE TBAV.PimAttributeId = TBD.PimAttributeId
			AND EXISTS(SELECT TOP 1 1 FROM Split(TBAV.CategoryValue, ',') SP WHERE SP.Item = TBD.AttributeDefaultValueCode)FOR XML PATH('')), 2, 4000) DefaultCategoryAttributeValue
			FROM @TBL_AttributeValue TBAV WHERE EXISTS(SELECT TOP 1 1 FROM @TBL_AttributeDefault TBAD WHERE TBAD.PimAttributeId = TBAV.PimAttributeId)
		)	 
		-- update the default value with locale 
		UPDATE TBAV SET CategoryValue = CTUDFAV.DefaultCategoryAttributeValue FROM @TBL_AttributeValue TBAV 
		INNER JOIN Cte_UpdateDefaultAttributeValue CTUDFAV ON(CTUDFAV.PimCategoryId = TBAV.PimCategoryId AND CTUDFAV.PimAttributeId = TBAV.PimAttributeId)
		WHERE CategoryValue IS NULL ;
					 
		-- here is update the media path  
		;WITH Cte_productMedia AS 
		(
			SELECT TBA.PimCategoryId,TBA.PimAttributeId,
			Isnull(
			(STUFF((SELECT ','+zm.PATH FROM ZnodeMedia ZM WHERE EXISTS
			(SELECT TOP 1 1 FROM dbo.split(TBA.CategoryValue, ',') SP
			WHERE SP.Item = CAST(Zm.MediaId AS VARCHAR(50)))FOR XML PATH(''),Type).value('.', 'varchar(max)'), 1, 1,'')) ,'no-image.png')
			CategoryValue
			FROM @TBL_AttributeValue TBA WHERE EXISTS(SELECT TOP 1 1 FROM [dbo].[Fn_GetProductMediaAttributeId]() FNMA WHERE FNMA.PImAttributeId = TBA.PimATtributeId)
		)
		UPDATE TBAV SET CategoryValue = CTCM.CategoryValue 
		FROM @TBL_AttributeValue TBAV 
		INNER JOIN Cte_productMedia CTCM ON(CTCM.PimCategoryId = TBAV.PimCategoryId
		AND CTCM.PimAttributeId = TBAV.PimAttributeId);
					 					
		;WITH Cte_PublishProductIds AS 
		(
			SELECT TBPC.PublishcategoryId,SUBSTRING((SELECT ','+CAST(PublishProductId AS VARCHAR(50))
			FROM ZnodePublishCategoryProduct ZPCP 
			WHERE ZPCP.PublishCategoryId = TBPC.publishCategoryId
			AND ZPCP.PimCategoryHierarchyId = TBPC.PimCategoryHierarchyId
			AND ZPCP.PublishCatalogId = @PublishCatalogId FOR XML PATH('')), 2, 8000) PublishProductId ,PimCategoryHierarchyId
			FROM @TBL_PublishPimCategoryIds TBPC
		)
		UPDATE TBPPC SET PublishProductId = CTPP.PublishProductId FROM @TBL_PublishPimCategoryIds TBPPC INNER JOIN Cte_PublishProductIds CTPP ON(TBPPC.PublishCategoryId = CTPP.PublishCategoryId 
		AND TBPPC.PimCategoryHierarchyId = CTPP.PimCategoryHierarchyId);

		;WITH Cte_CategoryProfile AS 
		(
			SELECT PimCategoryId,ZPCC.PimCategoryHierarchyId,
			SUBSTRING(( SELECT ','+CAST(ProfileId AS VARCHAR(50)) 
			FROM ZnodeProfile ZPC 
			INNER JOIN ZnodePimCategoryHierarchy ZPRCC ON(ZPRCC.PimCategoryHierarchyId = ZPCC.PimCategoryHierarchyId
			AND ZPRCC.PimCatalogId = ZPC.PimCatalogId) 
			WHERE ZPC.PimCatalogId = ZPCC.PimCatalogId FOR XML PATH('')), 2, 4000) ProfileIds
			FROM ZnodePimCategoryHierarchy ZPCC 
			WHERE EXISTS(SELECT TOP 1 1 FROM @TBL_PimCategoryIds TBPC 
			WHERE TBPC.PimCategoryId = ZPCC.PimCategoryId AND ZPCC.PimCatalogId = @PimCatalogId 
			AND ZPCC.PimCategoryHierarchyId = TBPC.PimCategoryHierarchyId)
		)                          
		UPDATE TBPC SET TBPC.ProfileId = CTCP.ProfileIds FROM @TBL_PimCategoryIds TBPC 
		LEFT JOIN Cte_CategoryProfile CTCP ON(CTCP.PimCategoryId = TBPC.PimCategoryId AND CTCP.PimCategoryHierarchyId = TBPC.PimCategoryHierarchyId );
                         
				     
		UPDATE TBPC SET TBPC.CategoryName = TBAV.CategoryValue FROM @TBL_PimCategoryIds TBPC INNER JOIN @TBL_AttributeValue TBAV ON(TBAV.PimCategoryId = TBPC.PimCategoryId
		AND EXISTS(SELECT TOP 1 1 FROM [dbo].[Fn_GetCategoryNameAttribute]() FNGCNA WHERE FNGCNA.PimAttributeId = TBAV.PimAttributeId));


		UPDATE TBPC SET TBPC.CategoryCode = TBAV.CategoryValue FROM @TBL_PimCategoryIds TBPC INNER JOIN @TBL_AttributeValue TBAV ON(TBAV.PimCategoryId = TBPC.PimCategoryId
		AND EXISTS(SELECT TOP 1 1 FROM dbo.Fn_GetCategoryCodeAttribute() FNGCNA WHERE FNGCNA.PimAttributeId = TBAV.PimAttributeId))

		-- here update the publish category details 
		;WITH Cte_UpdateCategoryDetails AS 
		(
			SELECT TBC.PimCategoryId,PublishCategoryId,CategoryName, TBPPC.PimCategoryHierarchyId,CategoryCode
			FROM @TBL_PimCategoryIds TBC
			INNER JOIN @TBL_PublishPimCategoryIds TBPPC ON(TBC.PimCategoryId = TBPPC.PimCategoryId AND TBC.PimCategoryHierarchyId = TBPPC.PimCategoryHierarchyId)
		)						
		MERGE INTO ZnodePublishCategoryDetail TARGET USING Cte_UpdateCategoryDetails SOURCE ON(TARGET.PublishCategoryId = SOURCE.PublishCategoryId
		AND TARGET.LocaleId = @LocaleIdIn)
		WHEN MATCHED THEN UPDATE SET PublishCategoryId = SOURCE.PublishcategoryId,PublishCategoryName = SOURCE.CategoryName,LocaleId = @LocaleIdIn,ModifiedBy = @userId,ModifiedDate = @GetDate,CategoryCode=SOURCE.CategoryCode
		WHEN NOT MATCHED THEN INSERT(PublishCategoryId,PublishCategoryName,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CategoryCode) VALUES
		(SOURCE.PublishCategoryId,SOURCE.CategoryName,@LocaleIdIn,@userId,@GetDate,@userId,@GetDate,SOURCE.CategoryCode);

		IF OBJECT_ID('tempdb..#Index') is not null
		BEGIN 
			DROP TABLE #Index
		END 

		CREATE TABLE #Index (RowIndex int ,PimCategoryId int , PimCategoryHierarchyId  int,ParentPimCategoryHierarchyId int )		
		INSERT INTO  #Index ( RowIndex ,PimCategoryId , PimCategoryHierarchyId,ParentPimCategoryHierarchyId)
		SELECT CAST(Row_number() OVER (Partition By TBL.PimCategoryId Order by ISNULL(TBL.PimCategoryId,0) desc) AS VARCHAR(100))
		,ZPC.PimCategoryId, ZPC.PimCategoryHierarchyId, ZPC.ParentPimCategoryHierarchyId
		FROM @TBL_PublishPimCategoryIds TBL
		INNER JOIN ZnodePublishCategory ZPC ON (TBL.PimCategoryId = ZPC.PimCategoryId AND TBL.PimCategoryHierarchyId = ZPC.PimCategoryHierarchyId)
		WHERE ZPC.PublishCatalogId = @PublishCatalogId

		UPDATE TBP SET  TBP.[RowIndex]=  IDX.RowIndex 
		FROM @TBL_PublishPimCategoryIds TBP INNER JOIN #Index IDX ON (IDX.PimCategoryId = TBP.PimCategoryId AND IDX.PimCategoryHierarchyId = TBP.PimCategoryHierarchyId)  
					
		IF OBJECT_ID('Tempdb..#CategoryEntity') IS NOT NULL
			DROP TABLE #CategoryEntity
						
					
		SELECT ISNULL(TYU.VersionId,'') VersionId,TBPC.PublishCategoryId ZnodeCategoryId,
		ISNULL(CategoryName, '') Name,ISNULL(CategoryCode,'') CategoryCode,
		ZPC.PublishCatalogId, ZPC.CatalogName ,
		Isnull('[' + THR.PublishParentCategoryId + ']',NULL) TempZnodeParentCategoryIds,
		ISNULL('[' + TBPC.PublishProductId + ']', NULL)  TempProductIds,
		@LocaleIdIn LocaleId,TBC.IsActive,ISNULL(DisplayOrder, '0') DisplayOrder,
		ISNULL(
		(
			SELECT TBA.AttributeCode,TBA.AttributeName,ISNULL(IsUseInSearch, 0) IsUseInSearch,
			ISNULL(IsHtmlTags, 0) IsHtmlTags,ISNULL(IsComparable, 0) IsComparable,
			TBAV.CategoryValue AttributeValues,TBA.AttributeTypeName 
			FROM @TBL_AttributeValue TBAV
			INNER JOIN @TBL_AttributeIds TBA ON(TBAV.PimAttributeId = TBA.PimAttributeId) 
			LEFT JOIN ZnodePimFrontendProperties ZPFP ON(ZPFP.PimAttributeId = TBA.PimAttributeId)
			WHERE TBC.PimCategoryId = TBAV.PimCategoryId  
			FOR JSON PATH) 
		, '[]')  as Attributes,
		ActivationDate,ExpirationDate,ISNULL(TBPC.RowIndex,1) CategoryIndex
		--,ProfileId TempProfileIds
		INTO #CategoryEntity
		FROM @TBL_PublishPimCategoryIds TBPC 
		INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId= @PublishCatalogId)
		LEFT JOIN #VesionIds TYU ON (TYU.ZnodeCatalogId = @PublishCatalogId AND TYU.LocaleId = @LocaleIdIn)
		INNER JOIN ZnodePublishCAtegory THR ON (THR.PimCategoryHierarchyId = TBPC.PimCategoryHierarchyId AND THR.PimCategoryId = TBPC.PimCategoryId AND THR.PublishCatalogId= @PublishCatalogId )
		INNER JOIN @TBL_PimCategoryIds TBC ON(TBC.PimCategoryId = TBPC.PimCategoryId AND TBC.PimCategoryHierarchyId = TBPC.PimCategoryHierarchyId) 
					
		UPDATE PCE SET PCE.ElasticSearchEvent = 2 FROM ZnodePublishCategoryEntity PCE
		WHERE NOT EXISTS(SELECT * FROM #CategoryEntity CE WHERE CE.VersionId = PCE.VersionId AND PCE.ZnodeCategoryId = CE.ZnodeCategoryId
		AND PCE.LocaleId = CE.LocaleId AND PCE.ZnodeCatalogId = CE.PublishCatalogId )
		AND PCE.LocaleId = @LocaleIdIn

		UPDATE PCE SET PCE.Name = CE.Name, PCE.ZnodeParentCategoryIds = CE.TempZnodeParentCategoryIds, PCE.ProductIds = CE.TempProductIds,
			PCE.IsActive = CE.IsActive,PCE.DisplayOrder = CE.DisplayOrder,PCE.Attributes = CE.Attributes,
			PCE.ActivationDate = CE.ActivationDate,PCE.ExpirationDate = CE.ExpirationDate,PCE.CategoryIndex = CE.CategoryIndex, PCE.ElasticSearchEvent = 1
		FROM ZnodePublishCategoryEntity PCE
		INNER JOIN #CategoryEntity CE ON CE.VersionId = PCE.VersionId AND PCE.ZnodeCategoryId = CE.ZnodeCategoryId
		AND PCE.LocaleId = CE.LocaleId AND PCE.ZnodeCatalogId = CE.PublishCatalogId
		AND PCE.LocaleId = @LocaleIdIn

		INSERT INTO ZnodePublishCategoryEntity
		(
			VersionId,ZnodeCategoryId,
			Name,CategoryCode,
			ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds,
			ProductIds,LocaleId,IsActive,DisplayOrder,
			Attributes,
			ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent
		)
		SELECT VersionId,ZnodeCategoryId,
		Name,CategoryCode,
		PublishCatalogId,CatalogName,TempZnodeParentCategoryIds,
		TempProductIds,LocaleId,IsActive,DisplayOrder,
		Attributes,
		ActivationDate,ExpirationDate,CategoryIndex, 1 as ElasticSearchEvent
		FROM #CategoryEntity CE
		WHERE NOT EXISTS(SELECT * FROM ZnodePublishCategoryEntity PCE WHERE CE.VersionId = PCE.VersionId AND PCE.ZnodeCategoryId = CE.ZnodeCategoryId
		AND PCE.LocaleId = CE.LocaleId AND PCE.ZnodeCatalogId = CE.PublishCatalogId )
		AND CE.LocaleId = @LocaleIdIn
					
		DELETE FROM @TBL_AttributeIds;
		DELETE FROM @TBL_AttributeDefault;
		DELETE FROM @TBL_AttributeValue;
		SET @Counter = @Counter + 1;
	END;
	
	UPDATE ZnodePublishCatalogLog 
	SET PublishCategoryId = (SELECT COunt(DISTINCT PimCategoryId ) 
	FROM @TBL_PublishPimCategoryIds WHERE PublishCatalogId =@PublishCatalogId), 
	IsCategoryPublished = 1 
	WHERE PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()

	------------for CategoryPublishId update
	SELECT ZPCAL.CategoryValue as CategoryCode,MAX(ZPC.PublishCategoryId) as PublishCategoryId ,ZPCA.PimCategoryId,ZPoC.PortalId
	INTO #CategoryData1
	FROM ZnodePimCategoryAttributeValue ZPCA
	INNER JOIN ZnodePimCategoryAttributeValueLocale ZPCAL on ZPCA.PimCategoryAttributeValueId = ZPCAL.PimCategoryAttributeValueId
	INNER JOIN ZnodePimAttribute ZPA ON ZPCA.PimAttributeId = ZPA.PimAttributeId
	INNER JOIN ZnodePublishCategory ZPC on ZPCA.PimCategoryId = ZPC.PimCategoryId
	INNER JOIN ZnodePortalCatalog ZPoC on ZPC.PublishCatalogId = ZPoC.PublishCatalogId
	WHERE ZPA.AttributeCode = 'CategoryCode' AND ZPC.PublishCatalogId = @PublishCatalogId
	GROUP BY ZPCAL.CategoryValue, ZPCA.PimCategoryId, ZPoC.PortalId

	UPDATE ZCWC SET ZCWC.PublishCategoryId = CD.PublishCategoryId
	FROM ZnodeCMSWidgetCategory ZCWC
	INNER JOIN #CategoryData1 CD ON ZCWC.CategoryCode = CD.CategoryCode and ZCWC.CMSMappingId = CD.PortalId
	WHERE ZCWC.TypeOFMapping = 'PortalMapping'

	IF (@RevisionState = 'PREVIEW')
		UPDATE ZnodePimCategory SET PublishStateId = Dbo.Fn_GetPublishStateIdForPreview() WHERE pimCategoryId IN (SELECT PimCategoryId FROM @TBL_PublishPimCategoryIds)
	Else 
		UPDATE ZnodePimCategory SET PublishStateId = Dbo.Fn_GetPublishStateIdForPublish() WHERE pimCategoryId IN (SELECT PimCategoryId FROM @TBL_PublishPimCategoryIds)

COMMIT TRAN GetPublishCategory;
SET @Status =1 
END TRY
BEGIN CATCH
	SELECT ERROR_MESSAGE();
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishCategory @PublishCatalogId = '+CAST(@PublishCatalogId AS VARCHAR(50))+',@UserId ='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(50));
	SET @Status = 0;
	ROLLBACK TRAN GetPublishCategory;
	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_GetPublishCategoryJson',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishProductJson')
	DROP PROC Znode_GetPublishProductJson
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishProductJson]  
(  
	@PublishCatalogId INT = 0   
	,@PimProductId     TransferId Readonly  
	,@UserId     INT = 0   
	,@PimCatalogId     INT = 0   
	,@VersionIdString  VARCHAR(2000)= ''  
	,@Status     Bit  OutPut  
	,@RevisionState   Varchar(50) = ''  
	,@IsDraftProductsOnly BIT = 1  
)  
WITH RECOMPILE 
AS  
/*  
DECLARE @rrte transferId   
INSERT INTO @rrte  
SELECT 1  
  
EXEC [_POC_Znode_GetPublishProductbulk] @PublishCatalogId=9,@UserId= 2 ,@localeIDs = @rrte,@PublishStateId = 3   
  
*/  
BEGIN  
BEGIN Try   
	SET NOCOUNT ON;  
	SET @Status = 0    
	Declare  @RevisionType VARCHAR(50) = ''   
	Declare @VersionId int = 0   
	DECLARE @PortalId INT = (SELECT TOP 1 POrtalId FROM ZnodePortalCatalog WHERE PublishCatalogId = @PublishCatalogId)  
	DECLARE @PriceListId INT = (SELECT TOP 1 PriceListId FROM ZnodePriceListPortal WHERE PortalId = @PortalId )  
	DECLARE @DomainUrl varchar(max) = (SELECT TOp 1 URL FROM ZnodeMediaConfiguration WHERE IsActive =1)  
	DECLARE @MaxSmallWidth INT  = (SELECT TOP 1  MAX(MaxSmallWidth) FROM ZnodeGlobalMediaDisplaySetting)  
	DECLARE @PimMediaAttributeId INT = dbo.Fn_GetProductImageAttributeId()  
  
	DECLARE @TBL_LocaleId  TABLE (RowId INT IDENTITY(1,1) PRIMARY KEY  , LocaleId INT , VersionId int,RevisionType varchar(50)  )  
	DECLARE @LocaleIds transferId   

	INSERT INTO @TBL_LocaleId (LocaleId,VersionId,RevisionType)  
	SELECT PV.LocaleId , PV.VersionId , PV.RevisionType  
	FROM ZnodePublishVersionEntity PV INNER JOIN Split(@VersionIdString,',') S ON PV.VersionId = S.Item  

	 --Getting active local for catalog which are associated to store
	INSERT INTO @LocaleIds (Id) 
	SELECT LocaleId FROM DBO.FN_GetCatalogPortalActiveLocale(@PublishCatalogId)
   
	DECLARE --@ProductNamePimAttributeId INT = dbo.Fn_GetProductNameAttributeId(),  
	@DefaultLocaleId INT= Dbo.Fn_GetDefaultLocaleId(),@LocaleId INT = 0   
	--,@SkuPimAttributeId  INT =  dbo.Fn_GetProductSKUAttributeId() , @IsActivePimAttributeId INT =  dbo.Fn_GetProductIsActiveAttributeId()  
	DECLARE @GetDate DATETIME =dbo.Fn_GetDate()  
  
	DECLARE @DefaultPortal int, @IsAllowIndexing int  
	SELECT @DefaultPortal = ZPC.PortalId, @IsAllowIndexing = 1 FROM ZnodePimCatalog ZPC INNER JOIN ZnodePublishCatalog ZPC1 ON ZPC.PimCatalogId = ZPC1.PimCatalogId WHERE ZPC1.PublishCatalogId =  @PublishCatalogId AND isnull(ZPC.IsAllowIndexing,0) = 1   
     
	-----DELETE unwanted publish data  
	DELETE ZPC FROM ZnodePublishCategoryProduct ZPC  
	WHERE NOT EXISTS(SELECT * FROM ZnodePublishCategory ZC WHERE ZPC.PublishCategoryId = ZC.PublishCategoryId )  
  
	DELETE ZPP FROM ZnodePublishCategoryProduct ZPP  
	WHERE NOT EXISTS(SELECT * FROM ZnodePublishProduct ZP WHERE ZPP.PublishProductId = ZP.PublishProductId )  
  
	DELETE ZPP FROM ZnodePublishCatalogProductDetail ZPP  
	WHERE NOT EXISTS(SELECT * FROM ZnodePublishProduct ZP WHERE ZPP.PublishProductId = ZP.PublishProductId )  
  
	DELETE ZPCP FROM ZnodePublishCatalogProductDetail ZPCP  
	INNER JOIN ZnodePublishProduct b on ZPCP.PublishProductId = b.PublishProductId   
	WHERE NOT EXISTS(SELECT * FROM ZnodePimCategoryProduct a  
	INNER JOIN ZnodePimCategoryHierarchy ZPCH on ZPCH.PimCategoryID = a.PimCategoryId   
	WHERE b.PimProductId = A.PimProductId AND ZPCP.PimCategoryHierarchyId = ZPCH.PimCategoryHierarchyId)  
	AND isnull(ZPCP.PimCategoryHierarchyId,0) <> 0 AND b.PublishCatalogId = @PublishCatalogId  
	---------  
  
	DECLARE @Counter INT =1 ,@maxCountId INT = (SELECT max(RowId) FROM @TBL_LocaleId )   
  
	CREATE TABLE #ZnodePrice (RetailPrice numeric(28,13),SalesPrice numeric(28,13),CurrencyCode varchar(100), CultureCode varchar(100), CurrencySuffix varchar(100), PublishProductId int)  
   
	CREATE TABLE #ProductSKU (SEOUrl nvarchar(max), SEODescription  nvarchar(max),SEOKeywords  nvarchar(max),SEOTitle  nvarchar(max), PublishProductId int)  
  
	CREATE TABLE #ProductImages (PublishProductId int, ImageSmallPath  varchar(max))  
  
	EXEC Znode_InsertUpdateAttributeDefaultValueJson 1   
	EXEC Znode_InsertUpdateCustomeFieldJson 1   
	EXEC Znode_InsertUpdatePimAttributeJson 1   
  
	---To draft all catalog products AND associated products for full catalog publish  
	IF @IsDraftProductsOnly = 0  
	BEGIN  
		EXEC Znode_CatalogProductDraftForPublish @PublishCatalogId=@PublishCatalogId   
	END  

	UPDATE ZnodePublishProductEntity SET ElasticSearchEvent = 0

	EXEC [Znode_InsertUpdatePimCatalogProductDetailJson] @PublishCatalogId=@PublishCatalogId,@LocaleId=@LocaleIds ,@UserId=@UserId ,@IsDraftProductsOnly = @IsDraftProductsOnly 


	IF (@IsAllowIndexing=1)  
	BEGIN   
		INSERT INTO #ZnodePrice  
		SELECT RetailPrice,SalesPrice,ZC.CurrencyCode,ZCC.CultureCode ,ZCC.Symbol CurrencySuffix,TYU.PublishProductId  
		FROM ZnodePrice ZP   
		INNER JOIN ZnodePriceList ZPL ON (ZPL.PriceListId = ZP.PriceListId)  
		INNER JOIN ZnodeCurrency ZC oN (ZC.CurrencyId = ZPL.CurrencyId )  
		INNER JOIN ZnodeCulture ZCC ON (ZCC.CultureId = ZPL.CultureId)  
		INNER JOIN ZnodePublishProductDetail TY ON (TY.SKU = ZP.SKU )   
		INNER JOIN ZnodePublishProduct TYU ON (TYU.PublishProductId = TY.PublishProductId)   
		WHERE ZP.PriceListId = @PriceListId   
		AND TY.LocaleId = @DefaultLocaleId  
		AND TYU.PublishCatalogId = @PublishCatalogId  
		AND EXISTS (SELECT TOP 1 1 FROM ZnodePriceListPortal ZPLP   
		INNER JOIN ZnodePimCatalog ZPC on ZPC.PortalId=ZPLP.PortalId WHERE ZPLP.PriceListId=ZP.PriceListId )  
		AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 WHERE TYU.PimProductId = ZPP1.PimProductId )  
		--+ CAST(@DefaultPortal AS VARCHAr(100)) + '/'  
		INSERT INTO #ProductImages  
		SELECT  TYU.PublishProductId , @DomainUrl +'Catalog/'  + CAST(@MaxSmallWidth AS VARCHAR(100)) + '/' + RT.MediaPath AS ImageSmallPath     
		FROM ZnodePimAttributeValue ZPAV   
		INNER JOIN ZnodePublishProduct TYU ON (TYU.PimProductId  = ZPAV.PimProductId)  
		INNER JOIN ZnodePimProductAttributeMedia  RT ON ( RT.PimAttributeValueId = ZPAV.PimAttributeValueId )  
		WHERE  TYU.PublishCatalogId = @PublishCatalogId  
		AND RT.LocaleId = @DefaultLocaleId  
		AND ZPAV.PimAttributeId = (SELECT TOp 1 PimAttributeId FROM ZnodePimAttribute WHERE AttributeCode = 'ProductImage')  
		AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 WHERE TYU.PimProductId = ZPP1.PimProductId )  
   
		INSERT INTO #ProductSKU   
		SELECT ZCSD.SEOUrl , ZCDL.SEODescription,ZCDL.SEOKeywords ,ZCDL.SEOTitle, TYU.PublishProductId  
		FROM ZnodeCMSSEODetail ZCSD   
		INNER JOIN ZnodeCMSSEODetailLocale ZCDL ON (ZCDL.CMSSEODetailId = ZCSD.CMSSEODetailId)  
		INNER JOIN ZnodePublishProductDetail TY ON (TY.SKU = ZCSD.SEOCode AND ZCDL.LocaleId = TY.LocaleId)   
		INNER JOIN ZnodePublishProduct TYU ON (TYU.PublishProductId = TY.PublishProductId)  
		WHERE CMSSEOTypeId = (SELECT TOP 1 CMSSEOTypeId FROM ZnodeCMSSEOType WHERE Name = 'Product')   
		AND ZCDL.LocaleId = @DefaultLocaleId  
		AND TYU.PublishCatalogId = @PublishCatalogId  
		--AND ZCSD.PublishStateId = @PublishStateId  
		AND ZCSD.PortalId = @DefaultPortal  
		AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 WHERE TYU.PimProductId = ZPP1.PimProductId )  
  
	END  
   
	CREATE NONCLUSTERED INDEX Idx_#ProductSKU_PublishProductId ON [dbo].[#ProductSKU] ([PublishProductId])  
	CREATE NONCLUSTERED INDEX Idx_#ProductImages_PublishProductId ON [dbo].#ProductImages ([PublishProductId])  
	CREATE NONCLUSTERED INDEX Idx_#ZnodePrice_PublishProductId ON [dbo].#ZnodePrice ([PublishProductId])  
	
	SELECT DISTINCT PublishProductId, x.LocaleId 
	INTO #PublishProducts 
	FROM ZnodePublishProduct ZPP
	INNER JOIN ##AttributeValueLocale x ON X.PimProductId = ZPP.PimProductId
	WHERE ZPP.PublishCatalogId = @PublishCatalogId

	CREATE INDEX #PublishProducts_PublishProductId on #PublishProducts(PublishProductId,LocaleId)
	--Creating products complete attribute json
	SELECT ZPP.Pimproductid, 
			ZPCPD.PimCatalogProductDetailId,ZPCPD.PublishProductId
			,ZPCPD.PublishCatalogId,ZPCPD.PimCategoryHierarchyId
			,ZPCPD.SKU,ZPCPD.ProductName,ZPCPD.CategoryName,ZPCPD.CatalogName
			,ZPCPD.LocaleId,ZPCPD.IsActive,ZPCPD.ProfileIds,ZPCPD.ProductIndex, 
		'[' +  
		(SELECT STUFF((SELECT ','+ AttributeEntity FROM ##AttributeValueLocale a   
		WHERE a.pimproductid = ZPP.pimproductid AND a.LocaleId = ZPCPD.LocaleId   
		FOR XML Path (''),Type).value('.', 'varchar(max)') ,1,1,'')  )   
		+ ']' AS ProductXML  
	INTO #ProductAttributeXML  
	FROM [ZnodePublishCatalogProductDetail] ZPCPD   
	INNER JOIN ZnodePublishProduct ZPP ON ZPCPD.PublishProductId = ZPP.PublishProductId AND ZPCPD.PublishCatalogId = ZPP.PublishCatalogId --WHERE TY.PimProductId = ZPP.PimProductId  AND TY.LocaleId = ZPCPD.LocaleId   
	WHERE ZPCPD.PublishCatalogId = @PublishCatalogId  
	AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId AND ZPCPD.LocaleId = X.LocaleId )
	GROUP BY ZPP.Pimproductid,ZPCPD.PimCatalogProductDetailId,ZPCPD.PublishProductId
			,ZPCPD.PublishCatalogId,ZPCPD.PimCategoryHierarchyId
			,ZPCPD.SKU,ZPCPD.ProductName,ZPCPD.CategoryName,ZPCPD.CatalogName
			,ZPCPD.LocaleId,ZPCPD.IsActive,ZPCPD.ProfileIds,ZPCPD.ProductIndex

	CREATE NONCLUSTERED INDEX Idx_#ProductAttributeXML_PimProductId_LocaleId  
	ON [dbo].#ProductAttributeXML (PimProductId,LocaleId)  
	
	IF (SELECT COUNT(*) FROM @LocaleIds) > 1
	BEGIN
		--INSERT INTO #ProductAttributeXML(Pimproductid,LocaleId,PublishProductId,ProductXML)
		SELECT ZPP.Pimproductid, 
			ZPCPD.PimCatalogProductDetailId,ZPCPD.PublishProductId
			,ZPCPD.PublishCatalogId,ZPCPD.PimCategoryHierarchyId
			,ZPCPD.SKU,ZPCPD.ProductName,ZPCPD.CategoryName,ZPCPD.CatalogName
			,ZPCPD.LocaleId,ZPCPD.IsActive,ZPCPD.ProfileIds,ZPCPD.ProductIndex,
			'[' +  
			(SELECT STUFF((SELECT ','+ AttributeEntity FROM ##AttributeValueLocale a   
			WHERE a.pimproductid = ZPP.pimproductid AND a.LocaleId = @DefaultLocaleId   
			FOR XML Path (''),Type).value('.', 'varchar(max)') ,1,1,'')  )   
			+ ']' AS ProductXML  
		INTO #ProductAttributeXML_LocaleWise
		FROM [ZnodePublishCatalogProductDetail] ZPCPD   
		INNER JOIN ZnodePublishProduct ZPP ON ZPCPD.PublishProductId = ZPP.PublishProductId AND ZPCPD.PublishCatalogId = ZPP.PublishCatalogId --WHERE TY.PimProductId = ZPP.PimProductId  AND TY.LocaleId = ZPCPD.LocaleId   
		WHERE ZPCPD.PublishCatalogId = @PublishCatalogId  
		AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId)
		AND NOT EXISTS(SELECT * FROM #ProductAttributeXML X WHERE ZPCPD.PublishProductId = X.PublishProductId AND X.LocaleId = ZPCPD.LocaleId )
		AND ZPCPD.LocaleId <> @DefaultLocaleId
		GROUP BY ZPP.Pimproductid, 
			ZPCPD.PimCatalogProductDetailId,ZPCPD.PublishProductId
			,ZPCPD.PublishCatalogId,ZPCPD.PimCategoryHierarchyId
			,ZPCPD.SKU,ZPCPD.ProductName,ZPCPD.CategoryName,ZPCPD.CatalogName
			,ZPCPD.LocaleId,ZPCPD.IsActive,ZPCPD.ProfileIds,ZPCPD.ProductIndex

		CREATE NONCLUSTERED INDEX Idx_#ProductAttributeXML_LocaleWise_PimProductId_LocaleId  
		ON [dbo].#ProductAttributeXML (PimProductId,LocaleId) 
	END
	


	DECLARE @MaxCount INT, @MinRow INT, @MaxRow INT, @Rows numeric(10,2);  
	SELECT @MaxCount = COUNT(*) FROM [ZnodePublishCatalogProductDetail] ZPCPD WHERE PublishCatalogId = @PublishCatalogId  
	AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId)
  
	SELECT @Rows = 50000  
          
	SELECT @MaxCount = CEILING(@MaxCount / @Rows);  
  
	SELECT PimCatalogProductDetailId, PublishProductId,Row_Number() over(Order by PublishProductId) ID into #ZnodePublishCatalogProductDetail 
	FROM [ZnodePublishCatalogProductDetail] ZPCPD WHERE PublishCatalogId = @PublishCatalogId  
	AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId)
  
	UPDATE ZPPAX SET ZPPAX.ElasticSearchEvent = 2
	FROM ZnodePublishProductEntity ZPPAX
	WHERE NOT EXISTS(SELECT * from [ZnodePublishCatalogProductDetail] ZLW WHERE ZPPAX.ZnodeProductId = ZLW.PublishProductId 
						AND ZPPAX.LocaleId = ZLW.LocaleId AND ZPPAX.ZnodeCatalogId = ZLW.PublishCatalogId )
	AND ZPPAX.ZnodeCatalogId = @PublishCatalogId 

	--Delete products from category from publish tables which are removed from one category and added into other category
	UPDATE ZPPE SET ZPPE.ElasticSearchEvent = 2 FROM ZnodePublishProductEntity ZPPE
	WHERE NOT EXISTS(SELECT * FROM ZnodePublishCategoryProduct ZPCP WHERE ZPPE.ZnodeCategoryIds = ZPCP.PublishCategoryId AND ZPPE.ZnodeProductId = ZPCP.PublishProductId
	AND ZPPE.ZnodeCatalogId = ZPCP.PublishCatalogId)
	AND ZPPE.ZnodeCatalogId = @PublishCatalogId

 --   --Delete data which are not present in catalog publish
	--Declare @Batch Bigint
	--SET @Batch = 1;
	--WHILE @Batch > 0
	--BEGIN 
	--	--BEGIN TRAN DelProd
	--		DELETE top (5000)  ZPPAX
	--		from ZnodePublishProductEntity ZPPAX
	--		WHERE NOT EXISTS(SELECT * from [ZnodePublishCatalogProductDetail] ZLW WHERE ZPPAX.ZnodeProductId = ZLW.PublishProductId 
	--							AND ZPPAX.LocaleId = ZLW.LocaleId AND ZPPAX.ZnodeCatalogId = ZLW.PublishCatalogId )
	--		AND ZPPAX.ZnodeCatalogId = @PublishCatalogId  
	--	--COMMIT TRAN DelProd
	--	SET @Batch = @@ROWCOUNT;
	--END
	
	SELECT ZPCP.PublishCategoryId,ZPCP.PublishProductId,ZPCP.PublishCatalogId,ZPCP.PimCategoryHierarchyId,ZPC.PimCategoryId,ZPCCF.PimProductId ,ZPCCF.DisplayOrder
	INTO #TempPublishCategoryProduct
	FROM ZnodePublishCategoryProduct ZPCP 
	INNER JOIN ZnodePublishProduct ZPP ON ZPCP.PublishProductId = ZPP.PublishProductId AND ZPCP.PublishCatalogId = ZPP.PublishCatalogId
	INNER JOIN ZnodePublishCategory ZPC ON (ZPCP.PublishCatalogId = ZPC.PublishCatalogId AND   ZPC.PublishCategoryId = ZPCP.PublishCategoryId AND ZPCP.PimCategoryHierarchyId = ZPC.PimCategoryHierarchyId)
	INNER JOIN ZnodePimCategoryProduct ZPCCF ON (ZPCCF.PimCategoryId = ZPC.PimCategoryId  AND ZPCCF.PimProductId = ZPP.PimProductId )
	WHERE EXISTS(SELECT * FROM [ZnodePublishCatalogProductDetail] ZPCPD WHERE (ZPCP.PublishProductId = ZPCPD.PublishProductId AND ZPCP.PublishCatalogId = ZPCPD.PublishCatalogId AND ZPCP.PimCategoryHierarchyId = ZPCPD.PimCategoryHierarchyId))		
	AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCP.PublishProductId = X.PublishProductId)
	AND ZPCP.PublishCatalogId = @PublishCatalogId 

	CREATE NONCLUSTERED INDEX Id_#TempPublishCategoryProduct_1 ON #TempPublishCategoryProduct(PublishProductId,PublishCatalogId,PimCategoryHierarchyId)

	IF OBJECT_ID('tempdb..#Temp_ImportLoop') IS NOT NULL  
		DROP TABLE #Temp_ImportLoop;  
          
	---- To get the min AND max rows for import in loop  
	;WITH cte AS   
	(  
		SELECT RowId = 1,   
		MinRow = 1,   
		MaxRow = cast(@Rows as int)  
		UNION ALL  
		SELECT RowId + 1,   
		MinRow + cast(@Rows as int),   
		MaxRow + cast(@Rows as int)  
		FROM cte  
		WHERE RowId + 1 <= @MaxCount  
	)  
	SELECT RowId, MinRow, MaxRow  
	INTO #Temp_ImportLoop  
	FROM cte  
	OPTION (maxrecursion 0);  

	DECLARE cur_BulkData CURSOR LOCAL FAST_FORWARD  
	FOR SELECT MinRow, MaxRow, B.LocaleId , B.RevisionType  ,b.VersionId
	FROM #Temp_ImportLoop L  
	CROSS APPLY @TBL_LocaleId B;  
  
	OPEN cur_BulkData;  
	FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow,@LocaleId, @RevisionType ,@VersionId 
	WHILE @@FETCH_STATUS = 0  
	BEGIN  
		IF OBJECT_ID('TEMPDB..#ProductEntity') IS NOT NULL
				DROP TABLE #ProductEntity

		IF OBJECT_ID('TEMPDB..#ProductEntity_LocaleWise') IS NOT NULL
			DROP TABLE #ProductEntity_LocaleWise
			
		SELECT   
			CAST(@VersionId AS VARCHAR(50)) VersionId --1   
			,CAST(ZPCPD.ProductIndex AS VARCHAr(100)) + CAST(ISNULL(ZPCP.PublishCategoryId,'')  AS VARCHAR(50))  + CAST(Isnull(ZPCPD.PublishCatalogId ,'')  AS VARCHAR(50)) + CAST( Isnull(ZPCPD.LocaleId,'') AS VARCHAR(50)) IndexId  --2  
			,CAST(ZPCPD.PublishProductId AS VARCHAR(50)) PublishProductId,CAST(ZPCPD.PublishCatalogId  AS VARCHAR(50)) PublishCatalogId  --3   
			,CAST(ISNULL(ZPCPD.SKU ,'') AS NVARCHAR(2000)) SKU,CAST( Isnull(ZPCPD.LocaleId,'') AS VARCHAR(50)) LocaleId -- 4   
			,CAST(isnull(ZPCPD.ProductName,'') AS NVARCHAR(2000) )  ProductName ,CAST(ISNULL(ZPCP.PublishCategoryId,'')  AS VARCHAR(50)) PublishCategoryId  -- 5   
			--'{"Attributes":[' + PAX.ProductXML + ']'  
			,CAST(ISNULL(ZPCPD.IsActive ,'0') AS VARCHAR(50)) IsActive ,ZPCPD.ProductXML,'[]' Brands,CAST(isnull(ZPCPD.CategoryName,'') AS NVARCHAR(2000)) CategoryName  --6  
			,CAST(Isnull(ZPCPD.CatalogName,'')  AS NVARCHAR(2000)) CatalogName,CAST(ISNULL(ZPCP.DisplayOrder,'') AS VARCHAR(50)) DisplayOrder  -- 7   
			,@RevisionType RevisionType, 0 AssociatedProductDisplayOrder,-- pending  -- 8   
			ZPCPD.ProductIndex,  -- 9  
			Case When @IsAllowIndexing = 1 then  ISNULL(CAST(TBZP.SalesPrice  AS VARCHAr(500)),'') else '' end SalesPrice ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(CAST(TBZP.RetailPrice  AS VARCHAr(500)),'') else '' end RetailPrice ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CultureCode ,'') else '' end CultureCode ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CurrencySuffix ,'') else '' end CurrencySuffix ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CurrencyCode ,'') else '' end CurrencyCode ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEODescription,'') else '' end SEODescriptionForIndex,  
			Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEOKeywords,'') else '' end SEOKeywords,  
			Case When @IsAllowIndexing = 1 then  ISNULL(SEOTitle,'') else '' end SEOTitle,  
			Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEOUrl ,'') else '' end SEOUrl,  
			Case When @IsAllowIndexing = 1 then  ISNULL(TBPI.ImageSmallPath,'') else '' end ImageSmallPath,  
			CAST(ISNULL(LOWER(ZPCPD.SKU) ,'') AS NVARCHAR(2000)) Lower_SKU--, z.Id    		
		INTO #ProductEntity
		FROM #ProductAttributeXML ZPCPD  
		INNER JOIN ZnodePublishCatalog ZPCV ON (ZPCV.PublishCatalogId = ZPCPD.PublishCatalogId)  
		--INNER JOIN #ProductAttributeXML PAX ON PAX.PublishProductId = ZPCPD.PublishProductId  AND PAX.LocaleId = ZPCPD.LocaleId   
		LEFT JOIN  #ZnodePrice TBZP ON (TBZP.PublishProductId = ZPCPD.PublishProductId)  
		LEFT JOIN  #ProductSKU TBPS ON (TBPS.PublishProductId = ZPCPD.PublishProductId)  
		LEFT JOIN  #ProductImages TBPI ON (TBPI.PublishProductId = ZPCPD.PublishProductId)  
		LEFT JOIN #TempPublishCategoryProduct ZPCP  ON (ZPCP.PublishProductId = ZPCPD.PublishProductId AND ZPCP.PublishCatalogId = ZPCPD.PublishCatalogId AND ZPCP.PimCategoryHierarchyId = ZPCPD.PimCategoryHierarchyId)
		WHERE ZPCPD.LocaleId = @LocaleId  
		AND EXISTS(SELECT * FROM #ZnodePublishCatalogProductDetail z WHERE ZPCPD.PimCatalogProductDetailId = z.PimCatalogProductDetailId AND z.Id BETWEEN @MinRow AND @MaxRow)
		AND ZPCPD.PublishCatalogId = @PublishCatalogId  
		AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId)

		CREATE INDEX Idx_#ProductEntity ON #ProductEntity (PublishProductId,PublishCatalogId,LocaleId,PublishCategoryId)

		UPDATE A SET a.SKU = b.SKU,A.SKULower = Lower_SKU,A.Name = B.ProductName, A.Brands = B.Brands, A.CategoryName = B.CategoryName, A.CatalogName = B.CatalogName,
			A.DisplayOrder = B.DisplayOrder, A.AssociatedProductDisplayOrder = B.AssociatedProductDisplayOrder,
			A.SalesPrice = B.SalesPrice, A.RetailPrice = B.RetailPrice, A.SeoDescription=B.SEODescriptionForIndex,
			A.SeoKeywords = B.SEOKeywords, A.SeoTitle = B.SEOTitle, A.SeoUrl = B.SEOUrl, A.ImageSmallPath = B.ImageSmallPath,
			A.ProductIndex = B.ProductIndex, A.IsActive = B.IsActive, A.IndexId = B.IndexId, A.Attributes = B.ProductXML,
			A.ElasticSearchEvent = 1
		FROM ZnodePublishProductEntity A
		INNER JOIN #ProductEntity B ON A.ZnodeProductId = B.PublishProductId AND A.ZnodeCatalogId = B.PublishCatalogId AND A.LocaleId = B.LocaleId 
			AND ISNULL(A.ZnodeCategoryIds,0) = ISNULL(B.PublishCategoryId,0) AND A.VersionId = B.VersionId AND A.ElasticSearchEvent <> 2

		INSERT INTO ZnodePublishProductEntity (  
			VersionId, --1  
			IndexId, --2   
			ZnodeProductId,ZnodeCatalogId, --3  
			SKU,LocaleId, --4   
			Name,ZnodeCategoryIds, --5  
			IsActive,Attributes,Brands,CategoryName, --6   
			CatalogName,DisplayOrder, --7   
			RevisionType,AssociatedProductDisplayOrder, --8  
			ProductIndex,--9  
			SalesPrice,RetailPrice,CultureCode,CurrencySuffix,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent)  
		SELECT VersionId, --1  
			IndexId, --2   
			PublishProductId,PublishCatalogId, --3  
			SKU,LocaleId, --4   
			ProductName,PublishCategoryId, --5  
			IsActive,ProductXML,Brands,CategoryName, --6   
			CatalogName,DisplayOrder, --7   
			RevisionType,AssociatedProductDisplayOrder, --8  
			ProductIndex,--9  
			SalesPrice,RetailPrice,CultureCode,CurrencySuffix,CurrencyCode,SEODescriptionForIndex,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,Lower_SKU,1 AS ElasticSearchEvent
		FROM #ProductEntity B
		WHERE NOT EXISTS(SELECT * FROM ZnodePublishProductEntity A WHERE A.ZnodeProductId = B.PublishProductId AND A.ZnodeCatalogId = B.PublishCatalogId AND A.LocaleId = B.LocaleId 
			AND ISNULL(A.ZnodeCategoryIds,0) = ISNULL(B.PublishCategoryId,0) AND A.VersionId = B.VersionId AND A.ElasticSearchEvent <> 2)
			--select * from #ProductEntity where PublishProductId = 191 
		IF @LocaleId <> @DefaultLocaleId
		BEGIN
			SELECT 
				CAST(@VersionId AS VARCHAR(50)) VersionId --1 
				,CAST(ZPCPD.ProductIndex AS VARCHAr(100)) + CAST(ISNULL(ZPCP.PublishCategoryId,'')  AS VARCHAR(50))  + CAST(Isnull(ZPCPD.PublishCatalogId ,'')  AS VARCHAR(50)) + CAST( Isnull(ZPCPD.LocaleId,'') AS VARCHAR(50)) IndexId  --2
				,CAST(ZPCPD.PublishProductId AS VARCHAR(50)) PublishProductId,CAST(ZPCPD.PublishCatalogId  AS VARCHAR(50)) PublishCatalogId  --3 
				,CAST(ISNULL(ZPCPD.SKU ,'') AS NVARCHAR(2000)) SKU,CAST( Isnull(ZPCPD.LocaleId,'') AS VARCHAR(50)) LocaleId -- 4 
				,CAST(isnull(ZPCPD.ProductName,'') AS NVARCHAR(2000) )  ProductName ,CAST(ISNULL(ZPCP.PublishCategoryId,'')  AS VARCHAR(50)) PublishCategoryId  -- 5 
				,CAST(ISNULL(ZPCPD.IsActive ,'0') AS VARCHAR(50)) IsActive ,ZPCPD.ProductXML,'[]' Brands,CAST(isnull(ZPCPD.CategoryName,'') AS NVARCHAR(2000)) CategoryName  --6
				,CAST(Isnull(ZPCPD.CatalogName,'')  AS NVARCHAR(2000)) CatalogName,CAST(ISNULL(ZPCP.DisplayOrder,'') AS VARCHAR(50)) DisplayOrder  -- 7 
				,@RevisionType as RevisionType, 0 AssociatedProductDisplayOrder,-- pending  -- 8 
				ZPCPD.ProductIndex,  -- 9
				Case When @IsAllowIndexing = 1 then  ISNULL(CAST(TBZP.SalesPrice  AS VARCHAr(500)),'') else '' end SalesPrice , 
				Case When @IsAllowIndexing = 1 then  ISNULL(CAST(TBZP.RetailPrice  AS VARCHAr(500)),'') else '' end RetailPrice , 
				Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CultureCode ,'') else '' end CultureCode , 
				Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CurrencySuffix ,'') else '' end CurrencySuffix , 
				Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CurrencyCode ,'') else '' end CurrencyCode , 
				Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEODescription,'') else '' end SEODescriptionForIndex,
				Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEOKeywords,'') else '' end SEOKeywords,
				Case When @IsAllowIndexing = 1 then  ISNULL(SEOTitle,'') else '' end SEOTitle,
				Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEOUrl ,'') else '' end SEOUrl,
				Case When @IsAllowIndexing = 1 then  ISNULL(TBPI.ImageSmallPath,'') else '' end ImageSmallPath,
				CAST(ISNULL(LOWER(ZPCPD.SKU) ,'') AS NVARCHAR(2000)) Lower_SKU
			INTO #ProductEntity_LocaleWise
			FROM #ProductAttributeXML_LocaleWise ZPCPD
			INNER JOIN ZnodePublishCatalog ZPCV ON (ZPCV.PublishCatalogId = ZPCPD.PublishCatalogId)
			--INNER JOIN #ProductAttributeXML_LocaleWise PAX ON PAX.PublishProductId = ZPCPD.PublishProductId  AND PAX.LocaleId = ZPCPD.LocaleId 
			LEFT JOIN  #ZnodePrice TBZP ON (TBZP.PublishProductId = ZPCPD.PublishProductId)
			LEFT JOIN  #ProductSKU TBPS ON (TBPS.PublishProductId = ZPCPD.PublishProductId)
			LEFT JOIN  #ProductImages TBPI ON (TBPI.PublishProductId = ZPCPD.PublishProductId)
			LEFT JOIN #TempPublishCategoryProduct ZPCP  ON (ZPCP.PublishProductId = ZPCPD.PublishProductId AND ZPCP.PublishCatalogId = ZPCPD.PublishCatalogId AND ZPCP.PimCategoryHierarchyId = ZPCPD.PimCategoryHierarchyId)
			WHERE ZPCPD.LocaleId = @LocaleId 
			AND EXISTS(SELECT * FROM #ZnodePublishCatalogProductDetail z WHERE ZPCPD.PimCatalogProductDetailId = z.PimCatalogProductDetailId AND z.Id BETWEEN @MinRow AND @MaxRow)
			AND ZPCPD.PublishCatalogId = @PublishCatalogId

			CREATE INDEX Idx_#ProductEntity_LocaleWise ON #ProductEntity (PublishProductId,PublishCatalogId,LocaleId,PublishCategoryId)

			UPDATE A SET a.SKU = b.SKU,A.SKULower = Lower_SKU,A.Name = B.ProductName, A.Brands = B.Brands, A.CategoryName = B.CategoryName, A.CatalogName = B.CatalogName,
				A.DisplayOrder = B.DisplayOrder, A.AssociatedProductDisplayOrder = B.AssociatedProductDisplayOrder,
				A.SalesPrice = B.SalesPrice, A.RetailPrice = B.RetailPrice, A.SeoDescription=B.SEODescriptionForIndex,
				A.SeoKeywords = B.SEOKeywords, A.SeoTitle = B.SEOTitle, A.SeoUrl = B.SEOUrl, A.ImageSmallPath = B.ImageSmallPath,
				A.ProductIndex = B.ProductIndex, A.IsActive = B.IsActive, A.IndexId = B.IndexId, A.Attributes = B.ProductXML,
				A.ElasticSearchEvent = 1
			FROM ZnodePublishProductEntity A
			INNER JOIN #ProductEntity_LocaleWise B ON A.ZnodeProductId = B.PublishProductId AND A.ZnodeCatalogId = B.PublishCatalogId AND A.LocaleId = B.LocaleId 
				AND ISNULL(A.ZnodeCategoryIds,0) = ISNULL(B.PublishCategoryId,0) AND A.VersionId = B.VersionId AND A.ElasticSearchEvent <> 2

			INSERT INTO ZnodePublishProductEntity (
			VersionId, --1
			IndexId, --2 
			ZnodeProductId,ZnodeCatalogId, --3
			SKU,LocaleId, --4 
			Name,ZnodeCategoryIds, --5
			IsActive,Attributes,Brands,CategoryName, --6 
			CatalogName,DisplayOrder, --7 
			RevisionType,AssociatedProductDisplayOrder, --8
			ProductIndex,--9
			SalesPrice,RetailPrice,CultureCode,CurrencySuffix,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent)
			SELECT VersionId --1 
				,IndexId  --2
				,PublishProductId,PublishCatalogId  --3 
				,SKU,LocaleId -- 4 
				,ProductName ,PublishCategoryId  -- 5 
				,IsActive ,ProductXML,Brands,CategoryName  --6
				,CatalogName,DisplayOrder  -- 7 
				,RevisionType, AssociatedProductDisplayOrder,-- pending  -- 8 
				ProductIndex,  -- 9
				SalesPrice , 
				RetailPrice , 
				CultureCode , 
				CurrencySuffix , 
				CurrencyCode , 
				SEODescriptionForIndex,
				SEOKeywords,
				SEOTitle,
				SEOUrl,
				ImageSmallPath,
				Lower_SKU,1 as ElasticSearchEvent
			FROM #ProductEntity_LocaleWise B
			WHERE NOT EXISTS(SELECT * FROM ZnodePublishProductEntity A WHERE A.ZnodeProductId = B.PublishProductId AND A.ZnodeCatalogId = B.PublishCatalogId AND A.LocaleId = B.LocaleId 
				AND ISNULL(A.ZnodeCategoryIds,0) = ISNULL(B.PublishCategoryId,0) AND A.VersionId = B.VersionId AND A.ElasticSearchEvent <> 2)
		
			--select * from #ProductEntity_LocaleWise where PublishProductId = 191 

		END

		SET @VersionId = 0  

		IF OBJECT_ID('tempdb..#ProductEntity') is not null
			DROP TABLE #ProductEntity

		IF OBJECT_ID('TEMPDB..#TempProductEntity_LocaleWise') IS NOT NULL
			DROP TABLE #TempProductEntity_LocaleWise

	FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow,@LocaleId, @RevisionType ,@VersionId 
	END;  
	CLOSE cur_BulkData;  
	DEALLOCATE cur_BulkData;  
  
  
	IF @RevisionState = 'PREVIEW'   
		UPDATE ZnodePimProduct SET IsProductPublish = 1,PublishStateId =  DBO.Fn_GetPublishStateIdForPreview()    
		WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishProduct ZPP WHERE ZPP.PimProductId = ZnodePimProduct.PimProductId   
		AND ZPP.PublishCatalogId = @PublishCatalogId)  
	Else  
		UPDATE ZnodePimProduct SET IsProductPublish = 1,PublishStateId =  DBO.Fn_GetPublishStateIdForPublish()    
		WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishProduct ZPP WHERE ZPP.PimProductId = ZnodePimProduct.PimProductId   
		AND ZPP.PublishCatalogId = @PublishCatalogId) 
		

	UPDATE ZnodePublishCatalogLog   
	SET IsProductPublished = 1   
	,PublishProductId = (SELECT  COUNT(DISTINCT PublishProductId) FROM ZnodePublishCategoryProduct ZPP   
		WHERE ZPP.PublishCatalogId = ZnodePublishCatalogLog.PublishCatalogId AND ZPP.PublishCategoryId IS NOT NULL)   
	WHERE ZnodePublishCatalogLog.PublishCatalogId = @PublishCatalogId  
	and PublishStateId = (SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE PublishStateCode = 'Processing' ) 
    
	--UPDATE ZnodePublishCatalogLog   
	--SET IsProductPublished = 1   
	--,PublishProductId = (SELECT  COUNT(DISTINCT PublishProductId) FROM ZnodePublishCatalogProductDetail ZPP   
	--	WHERE ZPP.PublishCatalogId = ZnodePublishCatalogLog.PublishCatalogId AND ZPP.PimCategoryHierarchyId <> 0)   
	--WHERE ZnodePublishCatalogLog.PublishCatalogId = @PublishCatalogId  
	--AND PublishStateId = (SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE PublishStateCode = 'Processing' )  

	SET @Status = 1   

	IF OBJECT_ID('tempdb..##AttributeValueLocale') IS NOT NULL  
		DROP TABLE ##AttributeValueLocale; 

END TRY   
BEGIN CATCH   
	SELECT ERROR_MESSAGE()
	 SET @Status =0    
	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	  @ErrorLine VARCHAR(100)= ERROR_LINE(),  
	  @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishProductJson   
		 @PublishCatalogId = '+CAST(@PublishCatalogId AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))  
	  +',@PimCatalogId = ' + CAST(@PimCatalogId AS varchar(20))  
	  +',@VersionIdString= ' + CAST(@VersionIdString AS varchar(20))  
       
	 EXEC Znode_InsertProcedureErrorLog  
	  @ProcedureName = 'Znode_GetPublishProductJson',  
	  @ErrorInProcedure = @Error_procedure,  
	  @ErrorMessage = @ErrorMessage,  
	  @ErrorLine = @ErrorLine,  
	  @ErrorCall = @ErrorCall;  
END CATCH  
  
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertPublishProductIds')
	DROP PROC Znode_InsertPublishProductIds
GO

CREATE PROCEDURE [dbo].[Znode_InsertPublishProductIds]
(
	@PublishCatalogId           INT            = NULL,
	@UserId                     INT				  ,
	@PimProductId               TransferId Readonly,
	@IsCallAssociated           BIT           = 0,
	@PimCategoryHierarchyId	 INT		   = 0  ,
	@IsDebug					 INT		   = 0     
)
AS
    
/*
  Summary :	Publish Product on the basis of publish catalog
				Retrive all Product details with attributes and INSERT INTO following tables 
				1.	ZnodePublishedXml
				2.	ZnodePublishCategoryProduct
				3.	ZnodePublishProduct
				4.	ZnodePublishProductDetail

                Product details include all the type of products link, grouped, configure and bundel products (include addon) their associated products 
				collect their attributes and values into tables variables to process for publish.  
                
				Finally genrate XML for products with their attributes and inserted into ZnodePublishedXml Znode Admin process xml from sql server to mongodb
				one by one.

     Unit Testing
    
     SELECT * FROM ZnodePimCustomField WHERE CustomCode = 'Test'
     SELECT * FROM ZnodePimCatalogCategory WHERE pimCatalogId = 3 AND PimProductId = 181
     SELECT * FROM ZnodePimCustomFieldLocale WHERE PimCustomFieldId = 1
	 SELECT * FROM ZnodePublishProduct WHERE PublishProductid = 213 = 30
     select * from znodepublishcatalog
	 SELECT * FROM view_loadmanageProduct WHERE Attributecode = 'ProductNAme' AND AttributeValue LIKE '%Apple%'
     SELECT * FROM ZnodePimCategoryProduct WHERE  PimProductId = 181
	 SELECT * FROM ZnodePimCatalogcategory WHERE pimcatalogId = 3 
     EXEC Znode_GetPublishProducts  @PublishCatalogId = 5 ,@UserId= 2 ,@NotReturnXML= NULL,@PimProductId = 117,@IsDebug= 1 
	 	DECLARE @ttr TransferId 
	INSERT INTO @ttr  
	SELECT 25719 
     EXEC Znode_InsertPublishProductIds  @PublishCatalogId = 3,@UserId= 2  ,@PimProductId = @ttr  ,@IsDebug= 1 
     EXEC Znode_GetPublishProducts  @PublishCatalogId =1,@UserId= 2 ,@RequiredXML= 1	
	 SELECT * FROM 	ZnodePimCatalogCategory  WHERE pimcatalogId = 3  
	 SELECT * FROM [dbo].[ZnodePimCategoryHierarchy]  WHERE pimcatalogId = 3 
    */ 

BEGIN
--  BEGIN TRAN InsertPublishProductIds;
BEGIN TRY
SET NOCOUNT ON;
		
	DECLARE @GetDate DATETIME = dbo.Fn_GetDate(); 
	DECLARE @PimCatalogId int= ISNULL((SELECT PimCatalogId FROM ZnodePublishcatalog WHERE PublishCatalogId = @PublishCatalogId), 0);  --- this variable is used to carry y pim catalog id by using published catalog id
	DECLARE 
	@ProductNamePimAttributeId INT = dbo.Fn_GetProductNameAttributeId(),
	@DefaultLocaleId INT= Dbo.Fn_GetDefaultLocaleId(),
	@LocaleId INT = 0,
	@SkuPimAttributeId  INT =  dbo.Fn_GetProductSKUAttributeId(), 
	@IsActivePimAttributeId INT =  dbo.Fn_GetProductIsActiveAttributeId(),
	@ProductTypeAttributeId INT = dbo.Fn_GetProductTypeAttributeId()

	DECLARE @TBL_LocaleId  TABLE (RowId INT IDENTITY(1,1) PRIMARY KEY  , LocaleId INT )

	INSERT INTO @TBL_LocaleId (LocaleId) 
	SELECT  LocaleId
	FROM ZnodeLocale MT 
	WHERE IsActive = 1
	AND EXISTS(SELECT * FROM ZnodePortalCatalog ZPC 
			INNER JOIN ZnodePortalLocale ZPL ON ZPC.PortalId = ZPL.PortalId
			WHERE ZPC.PublishCatalogId = @PublishCatalogId AND MT.LocaleId = ZPL.LocaleId )
	
	IF NOT EXISTS(SELECT * FROM @TBL_LocaleId)
		INSERT INTO @TBL_LocaleId  
		SELECT  LocaleId
		FROM ZnodeLocale 
		WHERE IsActive = 1-- AND IsDefault = 1
			 
	-- This variable used to carry the locale in loop 
	-- This variable is used to carry the default locale which is globaly set
	DECLARE @Counter INT =1 ,@maxCountId INT = (SELECT max(RowId) FROM @TBL_LocaleId ) 
	DECLARE @DeletePublishProductId VARCHAR(MAX)= '', @PimProductIds VARCHAR(MAX)= '', @PimAttributeId VARCHAR(MAX)= '';
	DECLARE @TBL_CategoryHierarchyIds TABLE (CategoryId int,ParentCategoryId int ) 
	DECLARE @TBL_PublishCategoryIds TABLE (PublishCategoryId  int ) 
		
	-- This table will used to hold the all currently active locale ids  
			 
	IF Object_ID ('tempdb..#ActiveProduct') is not null
		DROP TABLE #ActiveProduct

	IF Object_ID ('tempdb..#TBL_PimProductIds') is not null
		DROP TABLE #TBL_PimProductIds
		
	IF Object_ID ('tempdb..#ZnodePublishCategoryProduct') is not null
		DROP TABLE #ZnodePublishCategoryProduct;

	SELECT ZPCP.PimCategoryId, ZPCP.PimProductId, ZPC.PublishCategoryId,ZPP.PublishProductId
	INTO #ZnodePublishCategoryProduct
	FROM [dbo].[ZnodePimCategoryProduct] ZPCP
	INNER JOIN ZnodePublishCategory ZPC ON ZPCP.PimCategoryId = ZPC.PimCategoryId
	INNER JOIN ZnodePublishProduct ZPP ON ZPCP.PimProductId = ZPP.PimProductId
	WHERE EXISTS( SELECT TOP 1 1 FROM @PimProductId SP WHERE SP.Id = ZPCP.PimProductId)

	DELETE FROM ZnodePublishCategoryProduct
	WHERE NOT EXISTS (SELECT TOP 1 1 from #ZnodePublishCategoryProduct Z where Z.PublishProductId = ZnodePublishCategoryProduct.PublishProductId and Z.PublishCategoryId = ZnodePublishCategoryProduct.PublishCategoryId)
	AND EXISTS(SELECT TOP 1 1 FROM #ZnodePublishCategoryProduct Z where Z.PublishProductId = ZnodePublishCategoryProduct.PublishProductId)
	
	-- This table hold the complete xml of product with other information like category and catalog
	CREATE TABLE #TBL_PimProductIds(PimProductId INT  ,PimCategoryId INT,PimCatalogId INT,PublishCatalogId INT,IsParentProducts BIT ,DisplayOrder INT,ProductName NVARCHAR(MAX),SKU  NVARCHAR(MAX),
		IsActive NVARCHAR(MAX),PimAttributeFamilyId INT ,ProfileId   VARCHAR(MAX),CategoryDisplayOrder INT ,ProductIndex INT,PimCategoryHierarchyId INT ,PRIMARY KEY (PimCatalogId,PimCategoryId,PimCategoryHierarchyId,PimProductId)  )

	-- This table is used to hold the product which publish in current process 
	Create TABLE #TBL_PublishProductIds (PublishProductId  INT  ,PimProductId INT,PublishCatalogId  INT
			,PublishCategoryId VARCHAR(MAX),CategoryProfileIds VARCHAR(max),VersionId INT , PRIMARY KEY (PimProductId,PublishProductId,PublishCatalogId)); 
	 
	--Retrive category data : parent / client
	---------------
	-- this check is used when this procedure is call by internal procedure to publish only product and no need to return publish xml;    
	--Collected list of products for  publish 
       
	If @PimCategoryHierarchyId = 0 
	BEGIN

		INSERT INTO #TBL_PimProductIds ( PimProductId, PimCategoryId, IsParentProducts, DisplayOrder, PimCatalogId,CategoryDisplayOrder,PublishCatalogId,PimCategoryHierarchyId )
		SELECT DISTINCT ZPCC.PimProductId, ZPCC.PimCategoryId, 1 AS IsParentProducts, NULL AS DisplayOrder, ZPCH.PimCatalogId,ZPCC.DisplayOrder ,ZPC.PublishCatalogId,ISNULL(ZPCH.PimCategoryHierarchyId,0)
		FROM ZnodePimCategoryProduct AS ZPCC
		INNER JOIN ZnodePimCategoryHierarchy ZPCH ON ZPCC.PimCategoryId = ZPCH.PimCategoryId
		INNER JOIN ZnodePublishCatalog ZPC ON ZPC.PimCatalogId = ZPCH.PimCatalogId
		WHERE  (ZPCH.PimCatalogId = @PimCatalogId OR EXISTS( SELECT TOP 1 1 FROM @PimProductId SP WHERE SP.Id = ZPCC.PimProductId) ) AND ZPCC.PimProductId IS NOT NULL
		--AND EXISTS ( SELECT * FROM #ActiveProduct PAV WHERE ZPCC.PimProductId = PAV.PimProductId )

	END
	ELSE
	BEGIN
				
		INSERT INTO @TBL_CategoryHierarchyIds(CategoryId , ParentCategoryId )
		Select Distinct PimCategoryId , Null FROM (
		SELECT PimCategoryId,ParentPimCategoryId from DBO.[Fn_GetRecurciveCategoryIds](@PimCategoryHierarchyId,@PimCatalogId)
		Union 
		Select PimCategoryId , null  from ZnodePimCategoryHierarchy where PimCategoryHierarchyId = @PimCategoryHierarchyId 
		Union 
		Select PimCategoryId , null  from [Fn_GetRecurciveCategoryIds_new] (@PimCategoryHierarchyId,@PimCatalogId) ) Category  

		INSERT INTO  @TBL_PublishCategoryIds 
		select ZPC.PublishCategoryId from ZnodePublishCategory ZPC 
		Inner join  @TBL_CategoryHierarchyIds CT1 On 
		ZPC.PimCategoryId = CT1.CategoryId 	
			
		INSERT INTO #TBL_PimProductIds ( PimProductId, PimCategoryId, IsParentProducts, DisplayOrder, PimCatalogId,CategoryDisplayOrder,PublishCatalogId,PimCategoryHierarchyId )
		SELECT DISTINCT ZPCC.PimProductId, ZPCC.PimCategoryId, 1 AS IsParentProducts, NULL AS DisplayOrder, ZPCH.PimCatalogId,ZPCC.DisplayOrder ,ZPC.PublishCatalogId,ISNULL(ZPCH.PimCategoryHierarchyId,0)
		FROM ZnodePimCategoryProduct AS ZPCC
		INNER JOIN ZnodePimCategoryHierarchy ZPCH ON ZPCC.PimCategoryId = ZPCH.PimCategoryId
		INNER JOIN ZnodePublishCatalog ZPC ON ZPC.PimCatalogId = ZPCH.PimCatalogId
		WHERE  (ZPCH.PimCatalogId = @PimCatalogId OR EXISTS( SELECT TOP 1 1 FROM @PimProductId SP WHERE SP.Id = ZPCC.PimProductId) ) AND ZPCC.PimProductId IS NOT NULL
		--AND EXISTS ( SELECT * FROM #ActiveProduct PAV WHERE ZPCC.PimProductId = PAV.PimProductId )
		AND (ZPCC.PimCategoryId in(Select CategoryId from @TBL_CategoryHierarchyIds) ) 


		SELECT ZPCP.PublishCatalogId,THO.PimProductId,PimCategoryHierarchyId,ProductIndex
		INTO #TBL_PublishCategoryProduct 
		FROM ZnodePublishCategoryProduct ZPCP 
		INNER JOIN ZnodePublishProduct THO ON (THO.PublishProductId = ZPCP.PublishProductId  AND ZPCP.PublishCatalogId = THO.PublishCatalogId)
		WHERE ZPCP.PublishCatalogId = @PublishCatalogId
		AND EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductIds TYU WHERE TYU.PimProductId  =  THO.PimProductId )

		UPDATE  #TBL_PimProductIds 
		SET ProductIndex = CASE WHEN EXISTS (SELECT TOP 1 1 FROM #TBL_PublishCategoryProduct TH WHERE TH.PimProductId = #TBL_PimProductIds.PimProductId 
		AND #TBL_PimProductIds.PimCategoryHierarchyId = TH.PimCategoryHierarchyId  ) THEN (SELECT TOP  1 ProductIndex FROM #TBL_PublishCategoryProduct TM WHERE TM.PimProductId = #TBL_PimProductIds.PimProductId 
		AND #TBL_PimProductIds.PimCategoryHierarchyId = TM.PimCategoryHierarchyId  )

		WHEN EXISTS (SELECT TOP 1 1 FROM #TBL_PublishCategoryProduct TH WHERE TH.PimProductId = #TBL_PimProductIds.PimProductId 
		AND #TBL_PimProductIds.PimCategoryHierarchyId <> TH.PimCategoryHierarchyId  )  
		THEN (SELECT TOP  1 MAX(isnull(ProductIndex,0))+1  FROM #TBL_PublishCategoryProduct TM1 WHERE TM1.PimProductId = #TBL_PimProductIds.PimProductId 
		) ELSE  1  END 
			
	END
					
	--Collected list of link products for  publish
	INSERT INTO #TBL_PimProductIds( PimProductId, PimCategoryId, IsParentProducts, DisplayOrder, PimCatalogId , PublishCatalogId,PimCategoryHierarchyId)
	SELECT ZPLPD.PimProductId, Isnull(ZPCC.PimCategoryId,0), 0 AS IsParentProducts, NULL AS DisplayOrder, CTPP.PimCatalogId,CTPP.PublishCatalogId,isnull(ZPCH.PimCategoryHierarchyId,0)
	FROM ZnodePimLinkProductDetail AS ZPLPD
	INNER JOIN #TBL_PimProductIds AS CTPP ON ZPLPD.PimParentProductId = CTPP.PimProductId AND  IsParentProducts = 1 
	LEFT JOIN ZnodePimCategoryProduct AS ZPCC ON ZPCC.PimProductId = ZPLPD.PimProductId 
	LEFT JOIN ZnodePimCategoryHierarchy ZPCH ON ZPCH.PimCatalogId = CTPP.PimCatalogId and ZPCC.PimCategoryId = ZPCH.PimCategoryId
	WHERE NOT EXISTS ( SELECT TOP 1 1 FROM #TBL_PimProductIds AS CTPPI WHERE CTPPI.PimProductId = ZPLPD.PimProductId) 
	GROUP BY ZPLPD.PimProductId, ZPCC.PimCategoryId,CTPP.PimCatalogId,CTPP.PublishCatalogId ,ZPCH.PimCategoryHierarchyId

		
	--Collected list of Addon products for  publish
  
	INSERT INTO #TBL_PimProductIds( PimProductId, PimCategoryId, IsParentProducts, DisplayOrder, PimCatalogId,PublishCatalogId,PimCategoryHierarchyId)
	SELECT ZPAPD.PimChildProductId, ISNULL(ZPCC.PimCategoryId,0) AS PublishCategoryId, 0 AS IsParentProducts, null AS DisplayOrder,CTALP.PimCatalogId,CTALP.PublishCatalogId,ISNULL(ZPCH.PimCategoryHierarchyId,0)
	FROM ZnodePimAddOnProductDetail AS ZPAPD 
	INNER JOIN ZnodePimAddOnProduct AS ZPAP ON ZPAP.PimAddOnProductId = ZPAPD.PimAddOnProductId
	INNER JOIN #TBL_PimProductIds AS CTALP ON CTALP.PimProductId = ZPAP.PimProductId AND  IsParentProducts = 1
	LEFT JOIN ZnodePimCategoryProduct AS ZPCC ON ZPCC.PimProductId = ZPAPD.PimChildProductId 
	LEFT JOIN ZnodePimCategoryHierarchy ZPCH ON ZPCH.PimCatalogId = CTALP.PimCatalogId and ZPCH.PimCategoryId = ZPCC.PimCategoryId
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductIds AS CTALPI WHERE CTALPI.PimProductId = ZPAPD.PimChildProductId) 
	GROUP BY ZPAPD.PimChildProductId, ZPCC.PimCategoryId , CTALP.PimCatalogId,CTALP.PublishCatalogId,ZPCH.PimCategoryHierarchyId

	
	--Collected list of Bundle / Group / Config products for  publish
	INSERT INTO #TBL_PimProductIds(PimProductId,PimCategoryId,IsParentProducts,DisplayOrder,PimCatalogId,PublishCatalogId,PimCategoryHierarchyId)
	SELECT ZPTA.PimProductId,ISNULL(ZPCC.PimCategoryId,0),0 AS IsParentProducts,NULL DisplayOrder,CTAAP.PimCatalogId,CTAAP.PublishCatalogId,ISNULL(ZPCH.PimCategoryHierarchyId,0)
	FROM ZnodePimProductTypeAssociation AS ZPTA INNER JOIN #TBL_PimProductIds AS CTAAP ON CTAAP.PimProductId = ZPTA.PimParentProductId AND IsParentProducts = 1
	LEFT JOIN ZnodePimCategoryProduct AS ZPCC ON ZPCC.PimProductId = ZPTA.PimProductId 
	LEFT JOIN ZnodePimCategoryHierarchy ZPCH ON ZPCH.PimCatalogId = CTAAP.PimCatalogId AND ZPCC.PimCategoryId = ZPCH.PimCategoryId
	WHERE NOT EXISTS( SELECT TOP 1 1 FROM #TBL_PimProductIds AS CTAAPI WHERE CTAAPI.PimProductId = ZPTA.PimProductId)
	GROUP BY ZPTA.PimProductId,ZPCC.PimCategoryId,CTAAP.PimCatalogId,CTAAP.PublishCatalogId,ZPCH.PimCategoryHierarchyId
        				

	UPDATE TBPP
	SET PublishCatalogId = ZPC.PublishCatalogId 
	FROM #TBL_PimProductIds TBPP 
	INNER JOIN ZnodePublishCatalog ZPC ON ZpC.PimCatalogId = TBPP.PimCatalogId;
        
	DECLARE @PublishProductId TRANSFERId 
				

	IF @PublishCatalogId IS NOT NULL AND @PublishCatalogId <> 0 
	BEGIN
		If @PimCategoryHierarchyId = 0 
		BEGIN
									 				 	
			INSERT INTO @PublishProductId
			SELECT DISTINCT ZPP.PublishProductId 
			FROM ZnodePublishProduct AS ZPP 
			Left JOIN ZnodePublishCategoryProduct ZPPC ON (ZPPC.PublishProductId = ZPP.PublishProductId AND ZPPC.PublishCatalogId = ZPP.PublishCatalogId)
			--INNER JOIN ZnodePublishCategory ZPC ON (ZPC.PublishCategoryId = ZPPC.PublishCategoryId)
			WHERE NOT EXISTS
			(SELECT TOP 1 1 FROM #TBL_PimProductIds AS TBP WHERE ZPP.PimProductId = TBP.PimProductId 
			AND TBP.PublishCatalogId = ZPP.PublishCatalogId 
			AND ISNULL(TBP.PimCategoryHierarchyId,0) = ISNULL(ZPPC.PimCategoryHierarchyId,0) )
			AND ZPP.PublishCatalogId = @PublishCatalogId
			--Remove extra products from catalog
				
		END
		ELSE 
		BEGIN
		
			INSERT INTO @PublishProductId
			SELECT DISTINCT ZPP.PublishProductId 
			FROM ZnodePublishProduct AS ZPP 
			INNER JOIN ZnodePublishCategoryProduct ZPPC ON (ZPPC.PublishProductId = ZPP.PublishProductId AND ZPPC.PublishCatalogId = ZPP.PublishCatalogId)
			INNER JOIN ZnodePublishCategory ZPC ON (ZPC.PublishCatalogId = ZPPC.PublishCatalogId  AND   ZPC.PublishCategoryId = ZPPC.PublishCategoryId)
			WHERE NOT EXISTS
			(SELECT TOP 1 1 FROM #TBL_PimProductIds AS TBP WHERE ZPP.PimProductId = TBP.PimProductId 
			AND TBP.PublishCatalogId = ZPP.PublishCatalogId 
			AND ISNULL(TBP.PimCategoryHierarchyId,0) = ISNULL(ZPPC.PimCategoryHierarchyId,0))
			AND ZPP.PublishCatalogId = @PublishCatalogId
			AND ZPC.PimCategoryId  in 
			(
			Select CategoryId from @TBL_CategoryHierarchyIds
			)
			
		END
	END
	ELSE IF @IsCallAssociated = 0 
	BEGIN 
		
		DECLARE @TBL_ProductIdscollect TABLE(PublishProductId INT , PimproductId INT , PublishcatalogId  INT  , ProductType NVARCHAr(max))
		If @PimCategoryHierarchyId = 0 
		BEGIN

			INSERT INTO @TBL_ProductIdscollect (PublishProductId,PimproductId,PublishcatalogId,ProductType)
			SELECT PublishProductId,ZPAV.PimproductId,TBPOCI.PublishcatalogId,ZPATF.AttributeDefaultValueCode
			FROM ZnodePimAttributeValue ZPAV 
			INNER JOIN ZnodePimProductAttributeDefaultValue ZPADV ON (ZPADV.PimAttributeValueId = ZPAV.PimAttributeValueId )
			INNER JOIN #TBL_PimProductIds TBLIDF ON (TBLIDF.PimProductId = ZPAV.PimProductId )
			INNER JOIN ZnodePublishProduct TBPOCI ON (TBPOCI.PimProductId = TBLIDF.PimProductId AND TBPOCI.PublishCatalogId = TBLIDF.PublishCatalogId 	)
			INNER JOIN ZnodePimAttributeDefaultValue ZPATF ON (ZPATF.PimAttributeId =  @ProductTypeAttributeId 
			AND ZPADV.PimAttributeDefaultValueId = ZPATF.PimAttributeDefaultValueId )
			WHERE  IsParentProducts = 1	
			AND LocaleId =@DefaultLocaleId
		END 
		Else 
		BEGIN
					
			INSERT INTO @TBL_ProductIdscollect (PublishProductId,PimproductId,PublishcatalogId,ProductType)
			SELECT TBPOCI.PublishProductId,ZPAV.PimproductId,TBPOCI.PublishcatalogId,ZPATF.AttributeDefaultValueCode
			FROM ZnodePimAttributeValue ZPAV 
			INNER JOIN ZnodePimProductAttributeDefaultValue ZPADV ON (ZPADV.PimAttributeValueId = ZPAV.PimAttributeValueId )
			INNER JOIN #TBL_PimProductIds TBLIDF ON (TBLIDF.PimProductId = ZPAV.PimProductId )
			INNER JOIN ZnodePublishProduct TBPOCI ON (TBPOCI.PimProductId = TBLIDF.PimProductId AND TBPOCI.PublishCatalogId = TBLIDF.PublishCatalogId 	)
			INNER JOIN ZnodePimAttributeDefaultValue ZPATF ON (ZPATF.PimAttributeId =  @ProductTypeAttributeId 
			AND ZPADV.PimAttributeDefaultValueId = ZPATF.PimAttributeDefaultValueId )
			INNER JOIN ZnodePublishCategoryProduct  ZPCP ON ZPCP.PublishCatalogId = TBPOCI.PublishCatalogId AND 
			ZPCP.PublishProductId = TBPOCI.PublishProductId
			INNER JOIN ZnodePublishCategory ZPC ON  (ZPC.PublishCatalogId = ZPCP.PublishCatalogId  AND ZPC.PublishCategoryId = ZPCP.PublishCategoryId)
			WHERE  IsParentProducts = 1	AND LocaleId =@DefaultLocaleId
			AND ZPC.PimCategoryId  in ( Select CategoryId from @TBL_CategoryHierarchyIds ) 
		END 
		
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_ProductIdscollect WHERE ProductType IN ('GroupedProduct','BundleProduct','ConfigurableProduct','SimpleProduct') ) 
		BEGIN 
	
			DECLARE @TBL_DeleteTrackProduct TABLE (PublishProductId INT,AssociatedZnodeProductId INT  ,PublishCatalogId INT,PublishCatalogLogId INT ,IsDelete BIT , PublishCategoryId int  )

			;With Cte_PublishProduct AS
			(
				SELECT TBL.PublishProductId,PimproductId,TBL.PublishcatalogId,ProductType ,MAx(PublishCatalogLogId) PublishCatalogLogId
				FROM  @TBL_ProductIdscollect TBL 
				INNER JOIN ZnodePublishCatalogLog TBLG ON (TBLG.PublishCatalogId = TBL.PublishcatalogId)
				WHERE IsCatalogPublished = 1 
				GROUP BY TBL.PublishProductId,PimproductId,TBL.PublishcatalogId,ProductType

			)
			, Cte_ConfigData AS 
			(
				SELECT ZPP2.PublishProductId  AssociatedZnodeProductId,ZPP.PublishProductId,ZPXML.PimproductId,ZPP.PublishcatalogId,ProductType,CTR.PublishCatalogLogId
				FROM ZnodePublishAssociatedProduct ZPXML 
				INNER JOIN ZnodePublishProduct ZPP ON (ZPP.PimProductId = ZPXML.ParentPimProductId)
				INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId  = ZPP.PublishCatalogId AND ZPC.PimCatalogID = ZPXML.PimCatalogId )
				INNER JOIN Cte_PublishProduct CTR ON ( CTR.PublishProductId = ZPP.PublishProductId)
				INNER JOIN ZnodePublishProduct ZPP2 ON (ZPP2.PimProductId  = ZPXML.PimProductId AND ZPP2.PublishCatalogId = ZPP.PublishCatalogId )
				LEFT JOIN ZnodePublishCategoryProduct ZPPC ON (ZPPC.PublishProductId = ZPP2.PublishProductId  AND ZPPC.PublishCatalogId = ZPP.PublishCatalogId )
				WHERE  (ZPPC.PublishCategoryId in (Select PublishCategoryId from @TBL_PublishCategoryIds) OR @PimCategoryHierarchyId = 0 ) 
			
			)
			INSERT INTO @TBL_DeleteTrackProduct (PublishProductId,AssociatedZnodeProductId,PublishcatalogId,PublishCatalogLogId)
			SELECT ZPP.PublishProductId,AssociatedZnodeProductId,PublishcatalogId,PublishCatalogLogId 
			FROM Cte_ConfigData ZPP	
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM  #TBL_PublishProductIds TBLP WHERE TBLP.PublishProductId = ZPP.AssociatedZnodeProductId)

			;With Cte_updateStatus AS
			(
		 
				SELECT  PublishProductId,PublishcatalogId
				FROM @TBL_DeleteTrackProduct CTR 
				WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishAssociatedProduct ZPXML 
				INNER JOIN ZnodePublishProduct ZPP ON (ZPP.PimProductId = ZPXML.ParentPimProductId)
				INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId  = ZPP.PublishCatalogId AND ZPC.PimCatalogID = ZPXML.PimCatalogId )
				INNER JOIN ZnodePublishProduct ZPP2 ON (ZPP2.PimProductId  = ZPXML.PimProductId AND ZPP2.PublishCatalogId = ZPP.PublishCatalogId )
				WHERE  CTR.PublishProductId = ZPP2.PublishProductId 
				AND CTR.PublishCatalogId = ZPP.PublishCatalogId ) 
		
			)

			UPDATE a 
			SET IsDelete = CASE WHEN TYR.PublishProductId IS NULL THEN 1 ELSE 0 END 
			FROM @TBL_DeleteTrackProduct a 
			LEFT JOIN Cte_updateStatus TYR ON (TYR.PublishProductId = a.PublishProductId AND TYR.PublishCatalogId = a.PublishCatalogId)

		
			INSERT INTO @PublishProductId 
			SELECT DISTINCT AssociatedZnodeProductId 
			FROM @TBL_DeleteTrackProduct
			WHERE IsDelete =1  
			--	AND 1=0

		END 

	
		INSERT INTO @PublishProductId
		SELECT distinct PublishProductid
		FROM ZnodePublishProduct ZPP
		INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId =  ZPP.PublishCatalogId )
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimCategoryProduct ZPPP inner join ZnodePimCategoryHierarchy ZPCH ON ZPPP.PimCategoryId =ZPCH.PimCategoryId
		WHERE (ZPCH.PimCatalogid = ZPc.PimCatalogId AND ZPPP.PimProductId = ZPP.PimProductId))  
		AND EXISTS (SELECT TOP 1 1 FROM #TBL_PimProductIds TYR WHERE TYR.PimProductId = ZPP.PimProductId )
		AND NOT EXISTS (SELECT TOP 1 1 FROM @PublishProductId YTR WHERE YTR.Id = ZPP.PublishProductId  )
		AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCategoryProduct TY WHERE TY.PublishProductId = ZPP.PublishProductId AND TY.PublishCatalogId = ZPP.PublishcatalogId  )
	--AND  1=0	
	END  

		
	EXEC dbo.Znode_DeletePublishCatalogProduct  @PublishProductIds = @PublishProductId,@PublishCatalogId = @PublishCatalogId ,
	@PimCategoryHierarchyId  =@PimCategoryHierarchyId  ,
	@PimCatalogId  = @PimCatalogId 

		
	UPDATE ZPP SET ZPP.CreatedBy = @UserId, ZPP.CreatedDate = @GetDate, ZPP.ModifiedBy = @UserId, ZPP.ModifiedDate = @GetDate
	OUTPUT INSERTED.PublishProductId, INSERTED.PimProductId, INSERTED.PublishCatalogId INTO #TBL_PublishProductIds(PublishProductId, PimProductId, PublishCatalogId)		
	FROM ZnodePublishProduct ZPP
	WHERE EXISTS (SELECT * FROM #TBL_PimProductIds TBP WHERE TBP.PimProductId= ZPP.PimProductId AND TBP.PublishCatalogId = ZPP.PublishCatalogId)

	INSERT INTO ZnodePublishProduct(PimProductId, PublishCatalogId, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate)
	OUTPUT INSERTED.PublishProductId, INSERTED.PimProductId, INSERTED.PublishCatalogId INTO #TBL_PublishProductIds(PublishProductId, PimProductId, PublishCatalogId)
	SELECT DISTINCT TBP.PimProductId, TBP.PublishCatalogId, @UserId, @GetDate, @UserId, @GetDate 
	FROM #TBL_PimProductIds AS TBP
	WHERE NOT EXISTS(SELECT * FROM ZnodePublishProduct ZPP WHERE TBP.PimProductId= ZPP.PimProductId AND TBP.PublishCatalogId = ZPP.PublishCatalogId )

	-- Here used the ouput clause to catch what data inserted or updated into variable table
	
	IF Object_ID ('tempdb..#TB_CategoryProduct') is not null
		DROP TABLE #TB_CategoryProduct

	Create TABLE #TB_CategoryProduct(PublishProductId int , PublishCategoryId int, PublishCatalogId int , PimCategoryHierarchyId int ,ProductIndex int  )
	
	IF Isnull(@PublishCatalogId,0)  = 0  
	BEGIN
		INSERT INTO #TB_CategoryProduct 
		(PublishProductId, PublishCategoryId, PublishCatalogId, PimCategoryHierarchyId,	ProductIndex )
		SELECT PublishProductId,
			ISNULL(ZPC.PublishCategoryId,0)PublishCategoryId,
			TBP.PublishCatalogId,ZPC.PimCategoryHierarchyId,
			CASE WHEN ISNULL(@PimCategoryHierarchyId,0) <> 0  THEN TBP.ProductIndex 
			ELSE ROW_NUMBER()Over(Partition BY TBPP.PublishProductId Order BY ISNULL(ZPC.PublishCategoryId,0)) END  ProductIndex
		FROM #TBL_PimProductIds AS TBP 
		LEFT JOIN ZnodePublishCategory AS ZPC ON (ISNULL(TBP.PimCategoryId, 0) = ISNULL(ZPC.PimCategoryId, -1) AND ZPC.PublishCatalogId = TBP.PublishCatalogId 
		AND ISNULL(ZPC.PimCategoryHierarchyId, 0) = ISNULL(TBP.PimCategoryHierarchyId, -1))
		INNER JOIN #TBL_PublishProductIds AS TBPP ON TBP.PimProductId = TBPP.PimProductId
		AND TBP.PublishCatalogId = TBPP.PublishCatalogId
		Where (ZPC.PimCategoryHierarchyId <> 0 )
	GROUP BY PublishProductId, ZPC.PublishCategoryId, TBP.PublishCatalogId,ZPC.PimCategoryHierarchyId,TBP.ProductIndex
	END
	ELSE 	
	BEGIN
		INSERT INTO #TB_CategoryProduct 
		(PublishProductId, PublishCategoryId, PublishCatalogId, PimCategoryHierarchyId,	ProductIndex )
		SELECT PublishProductId,
			ISNULL(ZPC.PublishCategoryId,0)PublishCategoryId,
			TBP.PublishCatalogId,ZPC.PimCategoryHierarchyId,CASE WHEN ISNULL(@PimCategoryHierarchyId,0) <> 0  
			THEN TBP.ProductIndex ELSE     ROW_NUMBER()Over(Partition BY TBPP.PublishProductId 
			Order BY ISNULL(ZPC.PublishCategoryId,0)) END  ProductIndex
		FROM #TBL_PimProductIds AS TBP 
		LEFT JOIN ZnodePublishCategory AS ZPC ON (ISNULL(TBP.PimCategoryId, 0) = ISNULL(ZPC.PimCategoryId, -1) AND ZPC.PublishCatalogId = TBP.PublishCatalogId 
		AND ISNULL(ZPC.PimCategoryHierarchyId, 0) = ISNULL(TBP.PimCategoryHierarchyId, -1))
		INNER JOIN #TBL_PublishProductIds AS TBPP ON TBP.PimProductId = TBPP.PimProductId
		AND TBP.PublishCatalogId = TBPP.PublishCatalogId
		GROUP BY PublishProductId, ZPC.PublishCategoryId, TBP.PublishCatalogId,ZPC.PimCategoryHierarchyId,TBP.ProductIndex
	END
	
	UPDATE TARGET SET TARGET.PublishCategoryId = CASE WHEN SOURCE.PublishCategoryId = 0 THEN NULL ELSE SOURCE.PublishCategoryId END 
	,TARGET.CreatedBy = @UserId, TARGET.CreatedDate = @GetDate, TARGET.ModifiedBy = @UserId, 
	TARGET.ModifiedDate = @GetDate,TARGET.PimCategoryHierarchyId = SOURCE.PimCategoryHierarchyId				
	,ProductIndex = case when Source.ProductIndex is null then 1 else  Source.ProductIndex end
	FROM ZnodePublishCategoryProduct TARGET
	INNER JOIN #TB_Categoryproduct SOURCE ON TARGET.PublishCatalogId = SOURCE.PublishCatalogId AND ISNULL(TARGET.PublishCategoryId, 0) = ISNULL(SOURCE.PublishCategoryId, 0) AND TARGET.PublishProductId = SOURCE.PublishProductId 

			
	INSERT INTO ZnodePublishCategoryProduct(PublishProductId,PublishCategoryId,PublishCatalogId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PimCategoryHierarchyId,ProductIndex) 
	SELECT SOURCE.PublishProductId,CASE WHEN SOURCE.PublishCategoryId =0 THEN NULL ELSE SOURCE.PublishCategoryId  END , SOURCE.PublishCatalogId,@UserId,@GetDate,@userId,@GetDate,SOURCE.PimCategoryHierarchyId,case when Source.ProductIndex is null then 1 else  Source.ProductIndex end
	FROM #TB_Categoryproduct SOURCE
	WHERE NOT EXISTS(SELECT * FROM ZnodePublishCategoryProduct TARGET WHERE TARGET.PublishCatalogId = SOURCE.PublishCatalogId AND ISNULL(TARGET.PublishCategoryId, 0) = ISNULL(SOURCE.PublishCategoryId, 0) AND TARGET.PublishProductId = SOURCE.PublishProductId )

	--Getting default locale data for attributes ProductName, SKU and IsActive
	SELECT A.PimProductId,A.PimAttributeId,B.AttributeValue,B.ZnodePimAttributeValueLocaleId,B.LocaleId --,Row_Number() Over(Partition By a.PimProductId,a.PimAttributeId ORDER BY a.PimProductId,a.PimAttributeId  ) RowId
	INTO #TBL_AttributeVAlue
	FROM ZnodePimAttributeValue a   
	INNER JOIN  ZnodePimAttributeValueLocale b ON ( b.PimAttributeValueId = a.PimAttributeValueId )  
	INNER JOIN ZnodePimAttribute c ON ( c.PimAttributeId=a.PimAttributeId )
	WHERE LocaleId = @DefaultLocaleId 
	AND EXISTS (SELECT TOP 1 1 FROM #TBL_PublishProductIds ZPP WHERE (ZPP.PimProductId = A.PimProductId) )
	AND (C.PimAttributeId in ( @ProductNamePimAttributeId  ,  @SKUPimAttributeId , @IsActivePimAttributeId  ))

	
	WHILE @Counter <= @maxCountId
	BEGIN 
		SET @LocaleId = (SELECT TOP 1 LocaleId FROM @TBL_LocaleId WHERE RowId = @Counter)
		
		IF @DefaultLocaleId <> @LocaleId
		BEGIN
			DELETE FROM #TBL_AttributeVAlue WHERE LocaleId = @LocaleId
			
			INSERT INTO #TBL_AttributeVAlue
			SELECT A.PimProductId,A.PimAttributeId,B.AttributeValue,B.ZnodePimAttributeValueLocaleId,B.LocaleId --,Row_Number() Over(Partition By a.PimProductId,a.PimAttributeId ORDER BY a.PimProductId,a.PimAttributeId  ) RowId
			FROM ZnodePimAttributeValue a   
			INNER JOIN  ZnodePimAttributeValueLocale b ON ( b.PimAttributeValueId = a.PimAttributeValueId )  
			INNER JOIN ZnodePimAttribute c ON ( c.PimAttributeId=a.PimAttributeId )
			WHERE LocaleId = @LocaleId
			AND EXISTS (SELECT TOP 1 1 FROM #TBL_PublishProductIds ZPP WHERE (ZPP.PimProductId = A.PimProductId) )
			AND (C.PimAttributeId in ( @ProductNamePimAttributeId  ,  @SKUPimAttributeId , @IsActivePimAttributeId  ))
		END
		
		SELECT A.PimProductId,A.PimAttributeId,A.AttributeValue,A.ZnodePimAttributeValueLocaleId,A.LocaleId,Row_Number() Over(Partition By a.PimProductId,a.PimAttributeId ORDER BY a.PimProductId,a.PimAttributeId  ) RowId
		INTO #TBL_AttributeVAlue1
		FROM #TBL_AttributeVAlue A
		
		SELECT   ZPP.PublishProductId ,TBLA.AttributeValue PRoductName,TBLAI.AttributeValue SKU ,ISNULL(TBLAII.AttributeValue,'0') IsActive
		INTO #ZnodePublishProductDetail
		FROM  #TBL_PublishProductIds zpp
		INNER JOIN #TBL_AttributeVAlue1 TBLA ON (TBLA.PimAttributeId = @ProductNamePimAttributeId AND TBLA.PimProductId = ZPP.PimProductId AND TBLA.LocaleId  = CASE WHEN TBLA.RowId = 2 THEN  @LocaleId ELSE @DefaultLocaleId END )
		INNER JOIN #TBL_AttributeVAlue1 TBLAI ON (TBLAI.PimAttributeId = @SKUPimAttributeId AND TBLAI.PimProductId = ZPP.PimProductId AND TBLAI.LocaleId  = CASE WHEN TBLAI.RowId = 2 THEN  @LocaleId ELSE @DefaultLocaleId END )
		INNER JOIN #TBL_AttributeVAlue1 TBLAII ON (TBLAII.PimAttributeId = @IsActivePimAttributeId AND TBLAII.PimProductId = ZPP.PimProductId AND TBLAII.LocaleId  = CASE WHEN TBLAII.RowId = 2 THEN  @LocaleId ELSE @DefaultLocaleId END )
		GROUP BY ZPP.PublishProductId,TBLA.AttributeValue,TBLAI.AttributeValue,TBLAII.AttributeValue 
		
		UPDATE TARGET SET TARGET.ProductName   = SOURCE.ProductName
		,TARGET.SKU			 = SOURCE.SKU
		,TARGET.IsActive	= SOURCE.IsActive
		,TARGET.ModifiedBy	 = @userid
		,TARGET.ModifiedDate  = @GetDate
		FROM ZnodePublishProductDetail TARGET
		INNER JOIN #ZnodePublishProductDetail SOURCE ON TARGET.PublishProductId = SOURCE.PublishProductId 
		WHERE TARGET.LocaleId = @LocaleId 

		INSERT INTO ZnodePublishProductDetail (PublishProductId,ProductName,SKU,IsActive,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT SOURCE.PublishProductId ,SOURCE.ProductName ,SOURCE.SKU ,SOURCE.IsActive ,@LocaleId ,@userId ,@GetDate ,@userId ,@GetDate
		FROM #ZnodePublishProductDetail SOURCE
		WHERE NOT EXISTS(SELECT * FROM ZnodePublishProductDetail TARGET WHERE TARGET.PublishProductId = SOURCE.PublishProductId AND TARGET.LocaleId = @LocaleId )

		IF OBJECT_ID('TEMPDB..#TBL_AttributeVAlue1') IS NOT NULL 
			DROP TABLE #TBL_AttributeVAlue1 
		IF OBJECT_ID('TEMPDB..#ZnodePublishProductDetail') IS NOT NULL 
			DROP TABLE #ZnodePublishProductDetail
		
		SET @Counter = @counter + 1 
	END 
	   
	IF @PublishCatalogId IS NULL OR @PublishCatalogId =0 
	BEGIN 
		SELECT PublishProductId, PimProductId, PublishCatalogId 
		FROM #TBL_PublishProductIds
	END 
	IF (ISnull(@PimCategoryHierarchyId ,0) <> 0 ) 
	BEGIN
		SELECT PublishProductId, PimProductId, PublishCatalogId 
		FROM #TBL_PublishProductIds
	End 

--COMMIT TRAN InsertPublishProductIds;
END TRY 
BEGIN CATCH 
	SELECT ERROR_MESSAGE()
	UPDATE ZnodePublishCatalogLog 
	SET IsCatalogPublished = 0 
	,IscategoryPublished = 0 
	,IsProductPublished = 0 
	,PublishStateId = 1 
	WHERE PublishCatalogLogId IN (SELECT Max(PublishCatalogLogId) FROM ZnodePublishCatalogLog WHERE PublishCatalogId = @PublishCatalogId  GROUP BY PublishStateId , PublishCatalogId )
END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdatePimCatalogProductDetailJson')
	DROP PROC Znode_InsertUpdatePimCatalogProductDetailJson
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdatePimCatalogProductDetailJson] 
(
	@PublishCatalogId INT = 0, 
	@LocaleId TransferId READONLY, 
	@UserId INT = 0,
	@IsDraftProductsOnly BIT = 1
)
AS 

--declare @LocaleId TransferId
--INSERT INTO @LocaleId
--SELECT 1
--exec [Znode_InsertUpdatePimCatalogProductDetailJson_New] @PublishCatalogId=8,@LocaleId=@LocaleId,@UserId=2,@IsDraftProductsOnly=1
--select * from ZnodePublishCatalog
--declare @LocaleId TransferId
--INSERT INTO @LocaleId
--SELECT 1
----union 
----SELECT 4
----union 
----SELECT 2
--exec [Znode_POC_InsertUpdatePimCatalogProductDetail] @PublishCatalogId=3,@LocaleId=@LocaleId,@UserId=2
BEGIN 
BEGIN TRY 

  SET NOCOUNT ON 
	   IF OBJECT_ID('tempdb..##AttributeValueLocale') IS NOT NULL
		DROP TABLE ##AttributeValueLocale

       DECLARE @LocaleId_In INT = 0 , @DefaultLocaleId INT = dbo.FN_GETDefaultLocaleId()
			   ,@Date DATETIME = dbo.fn_GetDate(),@IsActiveAttributeId int , @SKUAttributeId int
	   DECLARE @PimMediaAttributeId INT = dbo.Fn_GetProductImageAttributeId()		   

	   select @IsActiveAttributeId = PimAttributeId from ZnodePimAttribute where AttributeCode = 'IsActive'
	   select @SKUAttributeId = PimAttributeId from ZnodePimAttribute where AttributeCode = 'SKU'

	   CREATE TABLE #PimDefaultValueLocale  (PimAttributeDefaultJsonId INT  PRIMARY KEY ,PimAttributeDefaultValueId INT ,LocaleId INT, DefaultValueJson	nvarchar(max) )

	   CREATE TABLE ##AttributeValueLocale  (Id int Identity,  PimProductId INT, AttributeCode Varchar(300), AttributeValue varchar(max), AttributeEntity varchar(max), LocaleId int )
	   
	   --Creating indexes on temp table
	   CREATE INDEX Idx_#AttributeValueLocale_1 ON ##AttributeValueLocale(PimProductId,AttributeCode,LocaleId)
	   CREATE INDEX Idx_#AttributeValueLocale_2 ON [dbo].[##AttributeValueLocale] ([AttributeCode])
	   INCLUDE ([PimProductId],[AttributeValue],[LocaleId])

	   CREATE TABLE #ZnodePublishCategoryProduct
	   (
			PublishProductId INT,  PimAttributeId INT, PublishCatalogId INT, PimCategoryHierarchyId INT,PublishCategoryId INT, 
			PimAttributeValueId INT, CatalogName NVARCHAR(600),PimProductId INT,AttributeCode VARCHAR(600)
		)
		
		--CREATE INDEX #ZnodePublishCategoryProduct_2 ON #ZnodePublishCategoryProduct(PimAttributeId)
		--CREATE INDEX #ZnodePublishCategoryProduct_3 ON #ZnodePublishCategoryProduct(PimProductId,AttributeCode)
	   --SELECT PimProductId, PimAttributeId, PimAttributeValueId, ModifiedDate INTO ZnodePimAttributeValue FROM ZnodePimAttributeValue
	   --CREATE INDEX ZnodePimAttributeValue_PimAttributeValueId ON ZnodePimAttributeValue(PimAttributeValueId)
	   CREATE TABLE #ModifiedProducts1 (PublishProductId INT, PimCategoryHierarchyId INT,PimProductId INT)

	    --Fetching product SKU record which are active
	    Select ZPAV.PimProductId , ZPAVL.AttributeValue ,ZPAVL.LocaleId
		INTO  #VariantSKU 
		From ZnodePimAttributeValue ZPAV 
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON (ZPAV.PimAttributevalueid = ZPAVL.PimAttributeValueId )  
		Where ZPAV.PimAttributeId = @SKUAttributeId
		and exists(Select ZPAV.PimProductId From ZnodePimAttributeValue ZPAV1 INNER JOIN ZnodePimAttributeValueLocale ZPAVL1
				ON (ZPAV1.PimAttributevalueid = ZPAVL1.PimAttributeValueId AND ZPAVL1.AttributeValue = 'True')
				 Where ZPAV1.PimAttributeId = @IsActiveAttributeId and ZPAV.PimProductId = ZPAV1.PimProductId)
		AND EXISTS(SELECT * FROM @LocaleId L WHERE ZPAVL.LocaleId = L.Id)

		CREATE INDEX Idx_#VariantSKU ON #VariantSKU(PimProductId) INCLUDE(AttributeValue)

		--Getting last successful publish datetime
	    DECLARE @PublishModifiedDate Datetime
		SET @PublishModifiedDate =
		(SELECT TOP 1 ModifiedDate 
		FROM ZnodePublishCatalogLog 
		WHERE PublishCatalogId = @PublishCatalogId AND PublishStateId = (SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE StateName = 'Publish')
		ORDER BY ModifiedDate DESC)

		--SELECT ZPP1.PimProductId , ZPCPD.PublishProductId, ZPCPD.PublishCatalogId,PCL.ModifiedDate
		--INTO #ProductAttributeXML
		--FROM ZnodePublishProduct ZPP1
		--INNER JOIN ZnodePublishCatalogProductDetail ZPCPD ON ZPP1.PublishProductId = ZPCPD.PublishProductId AND ZPCPD.PublishCatalogId = ZPP1.PublishCatalogId 
		--CROSS APPLY #ZnodePublishCatalogLog PCL 
		--WHERE ZPCPD.PublishCatalogId =  @PublishCatalogId 

		--Getting publish product data with different category hierarchy
		SELECT ZPCC.PublishProductId , ZPCC.PublishCatalogId, ZPPC.PimCategoryHierarchyId, ZPPC.PublishCategoryId
		INTO #PublishCategoryProductData
		FROM ZnodePublishCategoryProduct ZPCC
		INNER JOIN ZnodePublishCategory ZPPC ON (ISNULL(ZPPC.PimCategoryHierarchyId,0) = ISNULL(ZPCC.PimCategoryHierarchyId,0) AND ZPPC.PublishCategoryId = ZPCC.PublishCategoryId)
		WHERE ZPCC.PublishCatalogId = @PublishCatalogId

		IF @IsDraftProductsOnly = 1
		BEGIN
			--All product of catalog updaing to draft as new locale is active
			IF (SELECT COUNT(*) FROM @LocaleId) <> (SELECT COUNT(DISTINCT LocaleId) FROM ZnodePublishProductEntity WHERE ZnodeCatalogId = @PublishCatalogId)
			BEGIN
				DECLARE @PublishStateIdForDraftState INT = dbo.Fn_GetPublishStateIdForDraftState()
				UPDATE ZPP SET PublishStateId = @PublishStateIdForDraftState
				FROM ZnodePimProduct ZPP
				WHERE EXISTS(SELECT * FROM ZnodePublishProduct ZPP1 WHERE ZPP.PimProductId = ZPP1.PimProductId AND ZPP1.PublishCatalogId = @PublishCatalogId)

			END

			---------- Products Attribute modified
			SELECT DISTINCT ZPP.PublishProductId,ZPP.PublishCatalogId, ZPP.PimProductId--,  ZPCC.PimCategoryHierarchyId 
			INTO #ModifiedProducts
			FROM ZnodePublishProduct  ZPP
			INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
			WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
			AND EXISTS(SELECT * FROM ZnodePimAttributeValue ZPAV
				INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = ZPAV.PimAttributeId)  WHERE (ZPAV.PimProductId = ZPP.PimProductId )
				AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId AND ZPFGM.PimAttributeId = ZPAV.PimAttributeId))
				AND ZPAV.ModifiedDate > @PublishModifiedDate)

			----------Attributes modified so considering all products associated to those attributes
			INSERT INTO #ModifiedProducts
			SELECT DISTINCT ZPP.PublishProductId,ZPP.PublishCatalogId, ZPP.PimProductId--,  ZPCC.PimCategoryHierarchyId 
			FROM ZnodePublishProduct  ZPP
			INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
			WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
			AND EXISTS(SELECT * FROM ZnodePimAttributeValue ZPAV
				INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = ZPAV.PimAttributeId)  WHERE (ZPAV.PimProductId = ZPP.PimProductId )
				AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId AND ZPFGM.PimAttributeId = ZPAV.PimAttributeId))
				AND ZPA.ModifiedDate > @PublishModifiedDate)
			
			-------- Products not published  
			INSERT INTO #ModifiedProducts
			SELECT ZPP.PublishProductId,ZPP.PublishCatalogId,ZPP.PimProductId
			FROM ZnodePublishProduct  ZPP
			INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
			WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
			AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId ))--AND ZPFGM.PimAttributeId = ZPAV.PimAttributeId))
			AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 INNER JOIN ZnodePublishState ZPS ON ZPP1.PublishStateId = ZPS.PublishStateId
						WHERE StateName <> 'Publish' AND ZPP.PimProductId = ZPP1.PimProductId )	
			AND NOT EXISTS(SELECT * FROM #ModifiedProducts X WHERE ZPP.PublishProductId = X.PublishProductId)
			
			-------- Products associated to catalog or category or modified catalog category products
			INSERT INTO #ModifiedProducts		
			SELECT ZPP.PublishProductId,ZPP.PublishCatalogId,ZPP.PimProductId
			FROM ZnodePublishProduct  ZPP
			INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
			INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZPP.PublishCatalogId)
			WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
			AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId ))--AND ZPFGM.PimAttributeId = ZPAV.PimAttributeId))
			AND EXISTS(SELECT * FROM ZnodePimCategoryProduct ZPCC1 WHERE  ZPP.PimProductId = ZPCC1.PimProductId  
				AND ZPCC1.ModifiedDate>@PublishModifiedDate)
			AND NOT EXISTS(SELECT * FROM #ModifiedProducts X WHERE ZPP.PublishProductId = X.PublishProductId)

			---------- Link Product modified
			INSERT INTO #ModifiedProducts	
			SELECT ZPP.PublishProductId,ZPP.PublishCatalogId,ZPP.PimProductId
			FROM ZnodePublishProduct  ZPP
			INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
			WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
			AND EXISTS(SELECT * FROM ZnodePimLinkProductDetail ZPAV WHERE (ZPAV.PimParentProductId = ZPP.PimProductId ) 
				AND  ZPAV.ModifiedDate> @PublishModifiedDate )
			AND NOT EXISTS(SELECT * FROM #ModifiedProducts X WHERE ZPP.PublishProductId = X.PublishProductId)

							
			------Associated child Products (varients, Group) not published	
			INSERT INTO #ModifiedProducts	
			SELECT ZPP.PublishProductId,ZPP.PublishCatalogId,ZPP.PimProductId
			FROM ZnodePublishProduct  ZPP
			INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
			WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
			AND EXISTS(SELECT * FROM ZnodePimProductTypeAssociation ZPAV WHERE (ZPAV.PimProductId = ZPP.PimProductId ) 
				AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 INNER JOIN ZnodePublishState ZPS ON ZPP1.PublishStateId = ZPS.PublishStateId
						WHERE StateName <> 'Publish' AND ZPAV.PimProductId = ZPP1.PimProductId ))
			AND NOT EXISTS(SELECT * FROM #ModifiedProducts X WHERE ZPP.PublishProductId = X.PublishProductId)
			
			--------Link child Products (Bundle) not published 	
			INSERT INTO #ModifiedProducts
			SELECT ZPP.PublishProductId,ZPP.PublishCatalogId,ZPP.PimProductId
			FROM ZnodePublishProduct  ZPP
			INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
			WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
			AND EXISTS(SELECT * FROM ZnodePimLinkProductDetail ZPAV WHERE (ZPAV.PimProductId = ZPP.PimProductId )
				AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 INNER JOIN ZnodePublishState ZPS ON ZPP1.PublishStateId = ZPS.PublishStateId
						WHERE StateName <> 'Publish' AND ZPAV.PimProductId = ZPP1.PimProductId ))
			AND NOT EXISTS(SELECT * FROM #ModifiedProducts X WHERE ZPP.PublishProductId = X.PublishProductId)

			----Getting products of newly added category hierarchy 
			INSERT INTO #ModifiedProducts		
			SELECT ZPP.PublishProductId,ZPP.PublishCatalogId,ZPP.PimProductId
			FROM ZnodePublishProduct  ZPP
			INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
			INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZPP.PublishCatalogId)
			WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
			AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId ))--AND ZPFGM.PimAttributeId = ZPAV.PimAttributeId))
			AND EXISTS(SELECT * FROM ZnodePimCategoryProduct ZPCC1  
					INNER JOIN ZnodePimCategoryHierarchy ZPCH ON ZPCC1.PimCategoryId = ZPCH.PimCategoryId AND ZPC.PimCatalogId = ZPCH.PimCatalogId  
					WHERE ZPP.PimProductId = ZPCC1.PimProductId 
					AND ZPCH.ModifiedDate > @PublishModifiedDate)
			AND NOT EXISTS(SELECT * FROM #ModifiedProducts X WHERE ZPP.PublishProductId = X.PublishProductId)
			
			SELECT ZnodeProductId, ZnodeCatalogId
			INTO #TempPublishProductEntity
			FROM ZnodePublishProductEntity
			WHERE ZnodeCatalogId = @PublishCatalogId

			IF EXISTS(SELECT * FROM #TempPublishProductEntity)
			BEGIN
				CREATE INDEX Id_#TempPublishProductEntity ON #TempPublishProductEntity(ZnodeProductId,ZnodeCatalogId)
				--Getting product data which are associated with catalog and not present in product entity table
				INSERT INTO #ModifiedProducts		
				SELECT ZPP.PublishProductId,ZPP.PublishCatalogId,ZPP.PimProductId
				FROM ZnodePublishProduct ZPP
				INNER JOIN ZnodePublishCatalogProductDetail ZPCPD ON ZPP.PublishProductId = ZPCPD.PublishProductId AND ZPP.PublishCatalogId = ZPCPD.PublishCatalogId
				WHERE NOT EXISTS(SELECT * FROM #TempPublishProductEntity b where b.ZnodeProductId= ZPCPD.PublishProductId AND B.ZnodeCatalogId = ZPCPD.PublishCatalogId )
				AND NOT EXISTS(SELECT * FROM #ModifiedProducts X WHERE ZPP.PublishProductId = X.PublishProductId)
			END

			--Fetching pimcategoryhierarchyid for published product
			INSERT INTO #ModifiedProducts1(PublishProductId, PimCategoryHierarchyId,PimProductId)
			SELECT DISTINCT ZPP.PublishProductId, ZPCC.PimCategoryHierarchyId,ZPP.PimProductId
			FROM #ModifiedProducts ZPP
			LEFT JOIN #PublishCategoryProductData ZPCC  ON (ZPP.PublishProductId = ZPCC.PublishProductId AND ZPCC.PublishCatalogId = ZPP.PublishCatalogId )
			
			---------------------Category associated to catalog or category or modified catalog
			SELECT ZPCH.PimCategoryId, ZPC1.PublishCategoryId, ZPCH.PimCategoryHierarchyId
			INTO #ModifiedCategory1
			FROM ZnodePimCategoryHierarchy ZPCH 
			INNER JOIN ZnodePublishCategory ZPC1 ON ZPCH.PimCategoryId = ZPC1.PimCategoryId 
			WHERE ZPC1.PublishCatalogId =  @PublishCatalogId 
			AND EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogProductDetail BTM  
			WHERE BTM.PublishCatalogId = ZPC1.PublishCatalogId AND (BTM.ModifiedDate < ZPCH.ModifiedDate )   )
			AND NOT EXISTS(SELECT * FROM #ModifiedProducts1 MP WHERE  ISNULL(ZPCH.PimCategoryHierarchyId,0) = ISNULL(MP.PimCategoryHierarchyId,0))

			--INSERT INTO #ModifiedProducts1(PublishProductId, PimCategoryHierarchyId,PimProductId)	
			--SELECT BTM.PublishProductId, BTM.PimCategoryHierarchyId, ZPP.PimProductId
			--FROM ZnodePublishCatalogProductDetail BTM  
			--INNER JOIN ZnodePublishProduct ZPP ON BTM.PublishProductId = ZPP.PublishProductId AND BTM.PublishCatalogId = ZPP.PublishCatalogId
			--WHERE BTM.PublishCatalogId = @PublishCatalogId AND ISNULL(BTM.IsNotPublish,0) = 1
			
			IF EXISTS(SELECT TOP 1 1 FROM #ModifiedCategory1 )
			BEGIN
				-------- Category associated to catalog or category or modified catalog
				INSERT INTO #ModifiedProducts1		
				SELECT ZPP.PublishProductId,  ZPCC.PimCategoryHierarchyId,ZPP.PimProductId 
				FROM ZnodePublishProduct  ZPP
				INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
				INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZPP.PublishCatalogId)
				INNER JOIN ZnodePimCategoryProduct ZPCC1 ON  ZPP.PimProductId = ZPCC1.PimProductId 
				INNER JOIN ZnodePimCategoryHierarchy ZPCH ON ZPCC1.PimCategoryId = ZPCH.PimCategoryId AND ZPC.PimCatalogId = ZPCH.PimCatalogId 
				LEFT JOIN #PublishCategoryProductData ZPCC  ON (ZPP.PublishProductId = ZPCC.PublishProductId AND ZPCC.PublishCatalogId = ZPP.PublishCatalogId)
				WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
				AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId ))
				AND EXISTS (SELECT TOP 1 1 FROM #ModifiedCategory1 BTM WHERE BTM.PimCategoryHierarchyId = ZPCH.PimCategoryHierarchyId  )
				AND NOT EXISTS(SELECT * FROM #ModifiedProducts1 X WHERE ZPP.PublishProductId = X.PublishProductId)
				------------------
			END
			
			--CREATE INDEX #ModifiedProducts1_PublishProductId ON #ModifiedProducts1(PublishProductId,PimCategoryHierarchyId)	
			--Getting all products of catalog for publish which are modified after last publish
			INSERT INTO #ZnodePublishCategoryProduct (PublishProductId,  PimAttributeId, PublishCatalogId , PimCategoryHierarchyId , PublishCategoryId,
					   PimAttributeValueId, CatalogName ,PimProductId ,AttributeCode)
			SELECT ZPP.PublishProductId,  ZPAV.PimAttributeId, ZPP.PublishCatalogId , ZPCC.PimCategoryHierarchyId , ZPCC.PublishCategoryId
					,ZPAV.PimAttributeValueId, ZPC.CatalogName--,CASE WHEN ZPCC.PublishProductId IS NULL THEN 1 ELSE  dense_rank()Over(ORDER BY ZPCC.PimCategoryHierarchyId,ZPCC.PublishProductId) END  ProductIndex 	
					,ZPP.PimProductId ,ZPA.AttributeCode				
			FROM ZnodePublishProduct  ZPP
			INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
			INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimProductId = ZPP.PimProductId )
			INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = ZPAV.PimAttributeId)
			INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZPP.PublishCatalogId)
			LEFT JOIN #PublishCategoryProductData ZPCC  ON (ZPP.PublishProductId = ZPCC.PublishProductId AND ZPCC.PublishCatalogId = ZPP.PublishCatalogId)
			WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
			AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId AND ZPFGM.PimAttributeId = ZPAV.PimAttributeId))
			AND EXISTS (SELECT * FROM #ModifiedProducts1 MP WHERE ZPP.PublishProductId = MP.PublishProductId  ) 

		END
		ELSE 
		BEGIN	
			--Getting all products of catalog for publish first time 
			INSERT INTO #ZnodePublishCategoryProduct(PublishProductId,  PimAttributeId, PublishCatalogId , PimCategoryHierarchyId , PublishCategoryId,
				   PimAttributeValueId, CatalogName ,PimProductId ,AttributeCode)
			SELECT ZPP.PublishProductId,  ZPAV.PimAttributeId, ZPP.PublishCatalogId , ZPCC.PimCategoryHierarchyId , ZPCC.PublishCategoryId,
				   ZPAV.PimAttributeValueId, ZPC.CatalogName ,ZPP.PimProductId ,ZPA.AttributeCode				
			FROM ZnodePublishProduct  ZPP
			INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
			INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimProductId = ZPP.PimProductId )
			INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = ZPAV.PimAttributeId)
			INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZPP.PublishCatalogId)
			LEFT JOIN #PublishCategoryProductData ZPCC  ON (ZPP.PublishProductId = ZPCC.PublishProductId AND ZPCC.PublishCatalogId = ZPP.PublishCatalogId)
			WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
			AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId AND ZPFGM.PimAttributeId = ZPAV.PimAttributeId))
			AND EXISTS(SELECT * FROM ZnodePimCategoryProduct ZPCP Inner Join ZnodePimCategoryHierarchy ZPCH ON ZPCP.PimCategoryId = ZPCH.PimCategoryId
			WHERE ZPCP.PimProductId = ZPP.PimProductId AND ZPCH.PimCatalogId = ZPC.PimCatalogId)
		
			--Fetching pimcategoryhierarchyid
			INSERT INTO #ModifiedProducts1(PublishProductId, PimCategoryHierarchyId,PimProductId)
			SELECT DISTINCT PublishProductId, PimCategoryHierarchyId,PimProductId
			FROM #ZnodePublishCategoryProduct ZPCC 
			
		END
		
		CREATE INDEX #ModifiedProducts1_PimProductId ON #ModifiedProducts1(PimProductId)

		SELECT ZPAV.PimProductId, ZPP.PublishProductId, ZPAV.LocaleId
		into #ProductLocaleWise
		FROM #VariantSKU ZPAV
		INNER JOIN ZnodePublishProduct ZPP on ZPAV.PimProductId = ZPP.PimProductId
		WHERE EXISTS(SELECT * FROM @LocaleId L WHERE ZPAV.LocaleId = L.Id)
		AND ZPP.PublishCatalogId = @PublishCatalogId

		IF (SELECT COUNT(*) FROM @LocaleId) > 1
		BEGIN
			INSERT INTO #ProductLocaleWise(PimProductId,PublishProductId,LocaleId)
			SELECT a.PimProductId,a.PublishProductId,b.Id
			FROM #ProductLocaleWise a
			CROSS APPLY @LocaleId b 
			WHERE LocaleId = @DefaultLocaleId
			AND b.Id <> @DefaultLocaleId
			AND NOT EXISTS(select * from #ProductLocaleWise c where a.PimProductId = c.PimProductId and c.LocaleId = b.Id)
		END

		------------
		Select Distinct PimProductId,PublishProductId, PublishCatalogId ,PublishCategoryId,CatalogName,PimCategoryHierarchyId
	    into #ZnodePublishCategoryProductForValidation from #ZnodePublishCategoryProduct

		
		CREATE INDEX #ZnodePublishCategoryProductForValidation_PimProductId ON #ZnodePublishCategoryProductForValidation(PimProductId)

		CREATE INDEX IDX_#ZnodePublishCategoryProduct_1 ON #ZnodePublishCategoryProduct(PimProductId)
		
		CREATE INDEX IDX_#ZnodePublishCategoryProduct_3 ON #ZnodePublishCategoryProduct(PublishCategoryId)

		--
		

		------Getting All Link Product Details
		SELECT ZPLPD.PimParentProductId, ZPLPD.PimProductId, ZPLPD.PimAttributeId, ZPAV.AttributeValue as SKU
		INTO #LinkProduct
		FROM ZnodePimLinkProductDetail ZPLPD 
		INNER JOIN #VariantSKU ZPAV ON (ZPAV.PimProductId = ZPLPD.PimProductId)
		WHERE EXISTS(SELECT * FROM #ModifiedProducts1 X WHERE X.PimProductId = ZPLPD.PimParentProductId)
		
		CREATE INDEX #LinkProduct_1 ON #LinkProduct(PimParentProductId,PimAttributeId)
		
		----Getting products link product value entity
	     INSERT INTO ##AttributeValueLocale ( PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId )
	     SELECT ZPLP.PimParentProductId ,ZPAX.AttributeCode, '' AttributeValue , 
		 JSON_MODIFY( JSON_Modify(ZPAX.AttributeJson , '$.AttributeValues' , 
		 ISNULL(SUBSTRING ( (SELECT ','+cast( LP.SKU as varchar(600))
							FROM #LinkProduct LP
							WHERE LP.PimParentProductId = ZPLP.PimParentProductId 
							AND LP.PimAttributeId = ZPLP.PimAttributeId FOR XML PATH('')),2,8000),'') ),'$.SelectValues',Json_Query('[]'))   

							, ZPAX.LocaleId
		 FROM ZnodePimLinkProductDetail ZPLP
		 INNER JOIN ZnodePimAttributeJSON ZPAX ON (ZPAX.PimAttributeId = ZPLP.PimAttributeId )
		 WHERE EXISTS(SELECT * FROM #ZnodePublishCategoryProductForValidation PPCP  WHERE (ZPLP.PimParentProductId = PPCP.PimProductId ))
		 AND EXISTS(SELECT * FROM @LocaleId L WHERE ZPAX.LocaleId = L.Id)
		 GROUP BY ZPLP.PimParentProductId ,ZPAX.AttributeCode , ZPAX.AttributeJSON,ZPAX.LocaleId,ZPAX.AttributeCode,ZPLP.PimAttributeId
		
		----Getting product attribute value entity 
		SELECT PPCP.PimProductId , ZPA.AttributeCode,
		ISNULL(ZPAVL.AttributeValue,'') AttributeValue,
		ZPAVL.LocaleId,ZPA.PimAttributeId---,ZPAX.AttributeJSON
		into #ZnodePimAttributeValueLocale
		FROM ZnodePimAttributeValue PPCP
		INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = PPCP.PimAttributeId)
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON (PPCP.PimAttributeValueId =ZPAVL.PimAttributeValueId)
		WHERE EXISTS(SELECT * FROM #ZnodePublishCategoryProductForValidation PPCP1  WHERE PPCP1.PimProductId = PPCP.PimProductId)
		AND NOT EXISTS(select * from ZnodePimConfigureProductAttribute UOP where PPCP.PimProductId = UOP.PimProductId AND PPCP.PimAttributeId = UOP.PimAttributeId)

		create index #ZnodePimAttributeValueLocale_1 on #ZnodePimAttributeValueLocale(PimProductId,AttributeCode,LocaleId)
		create index #ZnodePimAttributeValueLocale_2 on #ZnodePimAttributeValueLocale(PimAttributeId)
		
		SELECT ZPAVL.PimProductId , ZPAVL.AttributeCode,ZPAVL.AttributeValue ,
				JSON_MODIFY(
				JSON_MODIFY (Json_Query( ZPAX.AttributeJSON  ) , '$.AttributeValues' ,  ISNULL(ZPAVL.AttributeValue,'') )    
				,'$.SelectValues',Json_Query('[]'))   
				AS 'AttributeEntity'
				, 
				ZPAVL.LocaleId
		INTO #TempValueLocale
		FROM #ZnodePimAttributeValueLocale ZPAVL  
		INNER JOIN ZnodePimAttributeJSON ZPAX ON (ZPAX.PimAttributeId = ZPAVL.PimAttributeId and ZPAX.LocaleId = ZPAVL.LocaleId)
		WHERE EXISTS(Select Id from @LocaleId x where ZPAVL.LocaleId = x.Id) 
		AND NOT EXISTS(select * from ##AttributeValueLocale AVL where ZPAVL.PimProductId = AVL.PimProductId and ZPAVL.AttributeCode = AVL.AttributeCode and ZPAVL.LocaleId = AVL.LocaleId )
		
		
		----Creating products attribute wise json of attribute value entity
		INSERT INTO ##AttributeValueLocale ( PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId )
		SELECT PimProductId,AttributeCode,AttributeValue,AttributeEntity,LocaleId
		FROM #TempValueLocale

		 IF (SELECT COUNT(*) from @LocaleId) > 1
		 BEGIN
				----Getting product attribute value entity getting for other locale with default attribute json
				  INSERT INTO ##AttributeValueLocale ( PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId )
				  SELECT ZPAVL.PimProductId , ZPAVL.AttributeCode,ZPAVL.AttributeValue ,
							JSON_MODIFY(
							JSON_MODIFY (Json_Query( ZPAX.AttributeJSON  ) , '$.AttributeValues' ,  ISNULL(ZPAVL.AttributeValue,'') )    
							,'$.SelectValues',Json_Query('[]'))   
							AS 'AttributeEntity', 
						 ZPAVL.LocaleId
				  FROM #ZnodePimAttributeValueLocale ZPAVL 
				  INNER JOIN ZnodePimAttributeJSON ZPAX ON (ZPAX.PimAttributeId = ZPAVL.PimAttributeId AND ZPAX.LocaleId = @DefaultLocaleId)
				  WHERE ZPAX.LocaleId = @DefaultLocaleId AND ZPAVL.LocaleId <> @DefaultLocaleId 
				  AND EXISTS(SELECT * FROM @LocaleId L WHERE ZPAVL.LocaleId = L.Id) 
				  AND NOT EXISTS(SELECT * FROM ##AttributeValueLocale AVL where ZPAVL.PimProductId = AVL.PimProductId and ZPAVL.AttributeCode = AVL.AttributeCode and ZPAVL.LocaleId = AVL.LocaleId )
		END
			
		IF OBJECT_ID('TEMPDB..#ZnodePublishCatalogProductDetail') IS NOT NULL
			DROP TABLE #ZnodePublishCatalogProductDetail

		IF OBJECT_ID('TEMPDB..#ZnodePublishCatalogProductDetail1') IS NOT NULL
			DROP TABLE #ZnodePublishCatalogProductDetail1

		IF OBJECT_ID('TEMPDB..#TBL_ProductRequiredAttribute') IS NOT NULL
			DROP TABLE #TBL_ProductRequiredAttribute
		  
		CREATE TABLE #TBL_ProductRequiredAttribute (PimProductId INT,SKU VARCHAR(600),ProductName VARCHAR(600), IsActive VARCHAR(10), LocaleId INT)

		--Getting disctinct products locale wise
		INSERT INTO #TBL_ProductRequiredAttribute(PimProductId, LocaleId)
		SELECT DISTINCT PimProductId, LocaleId FROM ##AttributeValueLocale

		--Updating SKU
		UPDATE #TBL_ProductRequiredAttribute 
		SET SKU = b.AttributeValue
		FROM #TBL_ProductRequiredAttribute a
		INNER JOIN ##AttributeValueLocale b ON a.PimproductId = b.PimProductId AND a.LocaleId = b.LocaleId
		WHERE b.AttributeCode = 'SKU'

		--Updating ProductName
		UPDATE #TBL_ProductRequiredAttribute 
		SET ProductName = b.AttributeValue
		FROM #TBL_ProductRequiredAttribute a
		INNER JOIN ##AttributeValueLocale b ON a.PimproductId = b.PimProductId AND a.LocaleId = b.LocaleId
		WHERE b.AttributeCode = 'ProductName'

		--Updating IsActive
		UPDATE #TBL_ProductRequiredAttribute 
		SET IsActive = b.AttributeValue
		FROM #TBL_ProductRequiredAttribute a
		INNER JOIN ##AttributeValueLocale b ON a.PimproductId = b.PimProductId AND a.LocaleId = b.LocaleId
		WHERE b.AttributeCode = 'IsActive'

		  --CREATE INDEX IDX_#TBL_ProductRequiredAttribute_PimProductId ON #TBL_ProductRequiredAttribute(PimProductId)	  
		  SELECT ZPI.PublishProductId, ZPI.PublishCatalogId ,TYU.PublishCategoryId,ZPI.CatalogName,ISNULL(ZPI.PimCategoryHierarchyId,0) PimCategoryHierarchyId
					,TPAR.SKU,TPAR.ProductName,TPAR.IsActive,TYU.PublishCategoryName CategoryName,ISNULL(TYU.LocaleId,TPAR.LocaleId) as LocaleId
		   INTO #ZnodePublishCatalogProductDetail
		   FROM #ZnodePublishCategoryProduct ZPI
		   INNER JOIN #TBL_ProductRequiredAttribute TPAR ON (TPAR.PimProductId = ZPI.PimProductId )
		   LEFT JOIN ZnodePublishCategoryDetail TYU ON (TYU.PublishCategoryId = ZPI.PublishCategoryId AND TPAR.LocaleId = TYU.LocaleId )
		   GROUP BY PublishProductId, PublishCatalogId ,TYU.PublishCategoryId,CatalogName,PimCategoryHierarchyId
					,SKU,ProductName,TPAR.IsActive,PublishCategoryName, TYU.LocaleId, TPAR.LocaleId
  
			CREATE INDEX IDX_#ZnodePublishCatalogProductDetail ON #ZnodePublishCatalogProductDetail(PublishProductId,PublishCatalogId,PimCategoryHierarchyId,LocaleId)

			--Creating product index
			SELECT PublishProductId,PublishCatalogId,PimCategoryHierarchyId,SKU,ProductName,CategoryName, CatalogName, LocaleId ,IsActive
			      ,CASE WHEN PublishProductId IS NULL THEN 1 ELSE Row_Number()Over(Partition by PublishCatalogId,PublishProductId,LocaleId ORDER BY PublishProductId,PimCategoryHierarchyId,LocaleId) END  ProductIndex
			INTO #ZnodePublishCatalogProductDetail1
			FROM #ZnodePublishCatalogProductDetail Temp
			WHERE EXISTS(SELECT * FROM #ProductLocaleWise PL WHERE Temp.PublishProductId = PL.PublishProductId)
			  
			--Getting locale wise product which are not present for other locale (other than default locale)  
			INSERT INTO #ZnodePublishCatalogProductDetail1 (PublishProductId,PublishCatalogId,PimCategoryHierarchyId,SKU,ProductName,CategoryName, CatalogName, LocaleId ,IsActive,ProductIndex)
			SELECT PublishProductId,PublishCatalogId,PimCategoryHierarchyId,SKU,ProductName,CategoryName, CatalogName, b.Id ,IsActive,ProductIndex
			FROM #ZnodePublishCatalogProductDetail1 a
			CROSS APPLY @LocaleId b 
			WHERE NOT EXISTS(SELECT * FROM #ZnodePublishCatalogProductDetail1 c WHERE a.PublishProductId = c.PublishProductId AND b.Id = c.LocaleId  )
			AND a.LocaleId = @DefaultLocaleId 
			AND a.PublishCatalogId = @PublishCatalogId

			----Deleting product data which are not present
			--DELETE ZPCPD 
			--FROM ZnodePublishCatalogProductDetail ZPCPD
			--WHERE NOT EXISTS(SELECT * FROM #ProductLocaleWise ZPCPD1 WHERE ZPCPD.PublishProductId = ZPCPD1.PublishProductId 
			--                 AND ZPCPD.LocaleId = ZPCPD1.LocaleId )  
			--AND ZPCPD.PublishCatalogId = @PublishCatalogId
			
			--Deleting product data which are not present in category hierarchy
			DELETE ZPCPD 
			FROM ZnodePublishCatalogProductDetail ZPCPD
			WHERE EXISTS(SELECT * FROM #ZnodePublishCatalogProductDetail ZPCPD1 WHERE 
						ZPCPD.PublishProductId = ZPCPD1.PublishProductId 
			            AND ZPCPD.LocaleId = ZPCPD1.LocaleId 
						AND ISNULL(ZPCPD1.PimCategoryHierarchyId,0)  <> 0 ) AND ZPCPD.PimCategoryHierarchyId =0
			AND ZPCPD.PublishCatalogId = @PublishCatalogId
			
			create index #ZnodePublishCatalogProductDetail1_1 on #ZnodePublishCatalogProductDetail1(SKU,LocaleId)
			create index #ZnodePublishCatalogProductDetail1_2 on #ZnodePublishCatalogProductDetail1(PublishProductId,PublishCatalogId,PimCategoryHierarchyId,LocaleId)
			----Update data ZnodePublishCatalogProductDetail 
			UPDATE TARGET
			SET  TARGET.ProductIndex	=SOURCE.ProductIndex
				,TARGET.SKU = SOURCE.SKU
				,TARGET.ModifiedBy		= @UserId	
				,TARGET.ModifiedDate	= @Date
			FROM ZnodePublishCatalogProductDetail TARGET
			INNER JOIN #ZnodePublishCatalogProductDetail1 SOURCE
			ON (
		        SOURCE.PublishProductId = TARGET.PublishProductId
				AND SOURCE.PublishCatalogId = TARGET.PublishCatalogId 
				AND ISNULL(SOURCE.PimCategoryHierarchyId,0) = ISNULL(TARGET.PimCategoryHierarchyId,0)
				AND SOURCE.LocaleId = TARGET.LocaleId --@LocaleId_In
				)
			WHERE TARGET.PublishCatalogId = @PublishCatalogId

			----Update data ZnodePublishCatalogProductDetail 
			UPDATE TARGET
			SET  
				TARGET.ProductName		=SOURCE.ProductName
				,TARGET.CatalogName		=SOURCE.CatalogName
				,TARGET.IsActive		=case when SOURCE.IsActive in ('0','false') then 0 else 1 end 
				,TARGET.ModifiedBy		= @UserId	
				,TARGET.ModifiedDate	= @Date
			FROM ZnodePublishCatalogProductDetail TARGET
			INNER JOIN #ZnodePublishCatalogProductDetail1 SOURCE
			ON (
		        TARGET.SKU = SOURCE.SKU
				AND SOURCE.LocaleId = TARGET.LocaleId --@LocaleId_In
				)
			WHERE TARGET.PublishCatalogId = @PublishCatalogId

			
		----Update data ZnodePublishCatalogProductDetail 
		UPDATE TARGET
		SET  
			TARGET.CategoryName	=SOURCE.CategoryName
			,TARGET.ModifiedBy		= @UserId	
			,TARGET.ModifiedDate	= @Date
		FROM ZnodePublishCatalogProductDetail TARGET
		INNER JOIN #ZnodePublishCatalogProductDetail1 SOURCE
		ON (
		    TARGET.SKU = SOURCE.SKU
			AND SOURCE.LocaleId = TARGET.LocaleId 
			AND ISNULL(SOURCE.PimCategoryHierarchyId,0) = ISNULL(TARGET.PimCategoryHierarchyId,0)
			)
		WHERE ISNULL(TARGET.PimCategoryHierarchyId,0) <> 0
		AND TARGET.PublishCatalogId = @PublishCatalogId

		----Insert data ZnodePublishCatalogProductDetail 
		INSERT INTO ZnodePublishCatalogProductDetail
			( PublishProductId,PublishCatalogId,PimCategoryHierarchyId,SKU,ProductName,CategoryName, CatalogName,
				LocaleId ,IsActive,ProductIndex,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
		SELECT SOURCE.PublishProductId ,SOURCE.PublishCatalogId ,SOURCE.PimCategoryHierarchyId ,SOURCE.SKU ,SOURCE.ProductName
		,SOURCE.CategoryName ,SOURCE.CatalogName ,SOURCE.LocaleId ,SOURCE.IsActive ,SOURCE.ProductIndex ,@UserId ,@Date ,@UserId ,@Date
		FROM #ZnodePublishCatalogProductDetail1 SOURCE
		WHERE NOT EXISTS(SELECT * FROM ZnodePublishCatalogProductDetail TARGET WHERE SOURCE.PublishProductId = TARGET.PublishProductId
						AND SOURCE.PublishCatalogId = TARGET.PublishCatalogId 
						AND SOURCE.PimCategoryHierarchyId = TARGET.PimCategoryHierarchyId 
						AND TARGET.LocaleId = SOURCE.LocaleId )
		AND SOURCE.PublishCatalogId = @PublishCatalogId
				
		----Inserting product data for other locale		  
		INSERT INTO ZnodePublishCatalogProductDetail (PublishProductId,PublishCatalogId,PimCategoryHierarchyId,SKU,ProductName,CategoryName, CatalogName,
				LocaleId ,IsActive,ProductIndex,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT PublishProductId,PublishCatalogId,PimCategoryHierarchyId,SKU,ProductName,CategoryName, CatalogName,
				b.Id ,IsActive,ProductIndex,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		FROM ZnodePublishCatalogProductDetail a
		CROSS APPLY @LocaleId b 
		WHERE NOT EXISTS(SELECT * FROM ZnodePublishCatalogProductDetail c WHERE a.PublishProductId = c.PublishProductId AND b.Id = c.LocaleId  )
		AND a.LocaleId = @DefaultLocaleId
		AND a.PublishCatalogId = @PublishCatalogId
		
		DELETE ZPCPD FROM ZnodePublishCatalogProductDetail ZPCPD
		INNER JOIN ZnodePublishProduct ZPD ON ZPCPD.PublishProductId = ZPD.PublishProductId AND ZPCPD.PublishCatalogId = ZPD.PublishCatalogId
		INNER JOIN ZnodePublishCatalog ZPC ON ZPCPD.PublishCatalogId = ZPC.PublishCatalogId
		WHERE NOT EXISTS(SELECT * FROM ZnodePimCategoryProduct ZPCC 
			    INNER JOIN ZnodePimCategoryHierarchy ZPCH ON ZPCC.PimCategoryId = ZPCH.PimCategoryId WHERE ZPD.PimProductId = ZPCC.PimProductId AND ZPC.PimCatalogId = ZPCH.PimCatalogId AND ZPCPD.PimCategoryHierarchyId = ZPCH.PimCategoryHierarchyId)
		AND ZPCPD.PimCategoryHierarchyId <> 0
		AND ZPCPD.PublishCatalogId = @PublishCatalogId
		
		----Updating the SKU into table ZnodePublishCatalogProductDetail
		UPDATE ZnodePublishCatalogProductDetail 
		SET SKU = b.AttributeValue
		FROM ZnodePublishCatalogProductDetail a
		INNER JOIN ZnodePublishProduct ZPP ON a.PublishProductId = ZPP.PublishProductId
		INNER JOIN ##AttributeValueLocale b ON ZPP.PimproductId = b.PimProductId AND a.LocaleId = b.LocaleId
		WHERE b.AttributeCode = 'SKU'
		AND a.PublishCatalogId = @PublishCatalogId

		----Updating the ProductName into table ZnodePublishCatalogProductDetail
		UPDATE ZnodePublishCatalogProductDetail 
		SET ProductName = b.AttributeValue
		FROM ZnodePublishCatalogProductDetail a
		INNER JOIN ZnodePublishProduct ZPP ON a.PublishProductId = ZPP.PublishProductId
		INNER JOIN ##AttributeValueLocale b ON ZPP.PimproductId = b.PimProductId AND a.LocaleId = b.LocaleId
		WHERE b.AttributeCode = 'ProductName'
		AND a.PublishCatalogId = @PublishCatalogId

		----Updating the IsActive into table ZnodePublishCatalogProductDetail
		UPDATE ZnodePublishCatalogProductDetail 
		SET IsActive = b.AttributeValue
		FROM ZnodePublishCatalogProductDetail a
		INNER JOIN ZnodePublishProduct ZPP ON a.PublishProductId = ZPP.PublishProductId
		INNER JOIN ##AttributeValueLocale b ON ZPP.PimproductId = b.PimProductId AND a.LocaleId = b.LocaleId
		WHERE b.AttributeCode = 'IsActive'
		AND a.PublishCatalogId = @PublishCatalogId
		
		---- To clean Older Hierarchies associations.
		DELETE ZPCPD
		FROM ZnodePublishCatalogProductDetail ZPCPD
		WHERE NOT EXISTS (select top 1 1 from ZnodePimCategoryHierarchy ZPCH where (ZPCPD.PimCategoryHierarchyId = ZPCH.PimCategoryHierarchyId))
		AND ISNULL(ZPCPD.PimCategoryHierarchyId,0) <>0
		
		SELECT a.PimProductId,  a.PimAttributeId, a.PimAttributeValueId, b.PimAttributeDefaultValueId, b.LocaleId
		INTO #PimProductAttributeDefaultValue
		FROM ZnodePimAttributeValue a 
		INNER JOIN ZnodePimProductAttributeDefaultValue b ON a.PimAttributeValueId = b.PimAttributeValueId 
		WHERE EXISTS(SELECT * FROM #ZnodePublishCategoryProductForValidation X WHERE X.PimProductId = a.PimProductId)
		
		CREATE INDEX Idx_#PimProductAttributeDefaultValue ON #PimProductAttributeDefaultValue (PimProductId,PimAttributeId)
		--CREATE INDEX Idx_#PimProductAttributeDefaultValue_1 ON #PimProductAttributeDefaultValue (PimAttributeDefaultValueId,LocaleId)

		SELECT  AA.DefaultValueJson , ZPADV.PimAttributeValueId, AA.LocaleId 
		INTO #PimAttributeDefaultXML
		FROM ZnodePimAttributeDefaultJSON AA 
		INNER JOIN #PimProductAttributeDefaultValue ZPADV ON ( ZPADV.PimAttributeDefaultValueId = AA.PimAttributeDefaultValueId AND AA.LocaleId = ZPADV.LocaleId)
		
		--create index #PimAttributeDefaultXML on #PimAttributeDefaultXML(PimAttributeValueId,LocaleId)
		--To get the data localwise
		IF (SELECT COUNT(*) FROM @LocaleId)>1
		BEGIN
			INSERT INTO #PimAttributeDefaultXML (DefaultValueJson, PimAttributeValueId, LocaleId)
			SELECT A.DefaultValueJson , A.PimAttributeValueId,b.id 
			FROM #PimAttributeDefaultXML A CROSS APPLY  @LocaleId b  
			WHERE NOT EXISTS ( SELECT * FROM #PimAttributeDefaultXML c WHERE a.PimAttributeValueId  = c.PimAttributeValueId AND c.LocaleId = b.Id )
			AND b.Id <> @DefaultLocaleId
		END
		
		------Getting child facets for merging   
		SELECT DISTINCT ZPPADV.PimAttributeDefaultValueId, ZPAV_Parent.PimAttributeValueId, ZPPADV.LocaleId
		INTO #PimChildProductFacets
		FROM ZnodePimAttributeValue ZPAV_Parent
		INNER JOIN ZnodePimProductTypeAssociation ZPPTA ON ZPAV_Parent.PimProductId = ZPPTA.PimParentProductId
		INNER JOIN #PimProductAttributeDefaultValue ZPPADV ON ZPPTA.PimProductId = ZPPADV.PimProductId AND ZPAV_Parent.PimAttributeId = ZPPADV.PimAttributeId
		WHERE EXISTS(SELECT * FROM ZnodePimFrontendProperties ZPFP WHERE ZPAV_Parent.PimAttributeId = ZPFP.PimAttributeId AND ZPFP.IsFacets = 1)
		AND EXISTS(SELECT * FROM #ZnodePublishCategoryProduct ZPPC WHERE ZPAV_Parent.PimProductId = ZPPC.PimProductId )
		AND NOT EXISTS(SELECT * FROM #PimProductAttributeDefaultValue ZPPADV1 WHERE ZPAV_Parent.PimAttributeValueId = ZPPADV1.PimAttributeValueId 
		                AND ZPPADV1.PimAttributeDefaultValueId = ZPPADV.PimAttributeDefaultValueId )

		----Merging childs facet attribute Default value XML for parent
		INSERT INTO #PimAttributeDefaultXML (DefaultValueJson, PimAttributeValueId, LocaleId)
		SELECT ZPADX.DefaultValueJson, ZPPADV.PimAttributeValueId, ZPPADV.LocaleId
		FROM #PimChildProductFacets ZPPADV		  
		INNER JOIN ZnodePimAttributeDefaultJSON ZPADX ON ( ZPPADV.PimAttributeDefaultValueId = ZPADX.PimAttributeDefaultValueId AND ZPPADV.LocaleId = ZPADX.LocaleId)
		
		CREATE INDEX Idx_#PimDefaultValueLocale ON #PimDefaultValueLocale(PimAttributeDefaultJsonId,LocaleId)

		CREATE INDEX Idx_#PimAttributeDefaultXML ON #PimAttributeDefaultXML(PimAttributeValueId,LocaleId)
		INCLUDE (DefaultValueJson)

		CREATE INDEX #ZnodePublishCategoryProduct_2 ON #ZnodePublishCategoryProduct(PimProductId,PimAttributeId)
		--CREATE INDEX #ZnodePublishCategoryProduct_3 ON #ZnodePublishCategoryProduct(PimProductId,AttributeCode)
		
		SELECT PPCP.PimProductId, PPCP.AttributeCode,PPCP.PimAttributeValueId, PPCP.PimAttributeId,ZPAX.AttributeJson,ZPAX.LocaleId
		INTO #ZnodeProductattributeDefaultData
		FROM #ZnodePublishCategoryProduct PPCP
		INNER JOIN ZnodePimAttributeJSON ZPAX ON (ZPAX.PimAttributeId = PPCP.PimAttributeId)
		WHERE EXISTS(SELECT * FROM #PimProductAttributeDefaultValue a  WHERE PPCP.PimProductId = a.PimProductId AND PPCP.PimAttributeId = a.PimAttributeId )
		AND EXISTS(SELECT * FROM @LocaleId L WHERE ZPAX.LocaleId = L.Id)
		AND NOT EXISTS(SELECT * FROM ZnodePimConfigureProductAttribute UOP WHERE PPCP.PimProductId = UOP.PimProductId AND PPCP.PimAttributeId = UOP.PimAttributeId )
		--AND NOT EXISTS(SELECT * FROM ##AttributeValueLocale AVL WHERE PPCP.PimProductId = AVL.PimProductId AND PPCP.AttributeCode = AVL.AttributeCode AND ZPAX.LocaleId = AVL.LocaleId )
		 
	
		--CREATE INDEX IDX_#ZnodeProductattributeDefaultData_1 ON #ZnodeProductattributeDefaultData(PimProductId,PimAttributeId)
		CREATE INDEX IDX_#ZnodeProductattributeDefaultData_2 ON #ZnodeProductattributeDefaultData(PimProductId,AttributeCode,LocaleId)
		CREATE INDEX IDX_#ZnodeProductattributeDefaultData_3 ON #ZnodeProductattributeDefaultData(PimAttributeValueId,LocaleId)
		
		SELECT PPCP.PimProductId, PPCP.AttributeCode,'' AttributeValue,
		JSON_MODIFY (JSON_MODIFY (PPCP.AttributeJson,'$.AttributeValues',''), '$.SelectValues',
			
				ISNULL((SELECT 
							ISNULL(JSON_VALUE(DefaultValueJson, '$.Code'),'') Code 
							,ISNULL(JSON_VALUE(DefaultValueJson, '$.LocaleId'),0) LocaleId
							,ISNULL(JSON_VALUE(DefaultValueJson, '$.Value'),'') Value
							,ISNULL(JSON_VALUE(DefaultValueJson, '$.AttributeDefaultValue'),'') AttributeDefaultValue
							,ISNULL(JSON_VALUE(DefaultValueJson, '$.DisplayOrder'),0) DisplayOrder
							,ISNULL(JSON_VALUE(DefaultValueJson, '$.IsEditable'),'false') IsEditable
							,ISNULL(JSON_VALUE(DefaultValueJson, '$.SwatchText'),'') SwatchText
							,ISNULL(JSON_VALUE(DefaultValueJson, '$.Path'),'') Path
					FROM #PimAttributeDefaultXML aa
					WHERE (aa.PimAttributeValueId = PPCP.PimAttributeValueId AND AA.LocaleId = PPCP.LocaleId ) For JSON Auto 
				),'[]') 
				) 
			 AttributeEntity 
		 , PPCP.LocaleId
		 INTO #DefaultData
		 FROM #ZnodeProductattributeDefaultData PPCP 
		 WHERE NOT EXISTS(SELECT * FROM ##AttributeValueLocale AVL WHERE PPCP.PimProductId = AVL.PimProductId AND PPCP.AttributeCode = AVL.AttributeCode AND PPCP.LocaleId = AVL.LocaleId )
		
		----Getting default attribute value entity
		INSERT INTO ##AttributeValueLocale		
		SELECT PimProductId,AttributeCode,'' AttributeValue,AttributeEntity,LocaleId
		FROM #DefaultData
		
		 
		--Getting text attribute value entity		
		SELECT PPCP.PimProductId , ZPA.AttributeCode,ISNULL(ZPAVL.AttributeValue,'') AttributeValue,ZPAVL.LocaleId,ZPA.PimAttributeId
		INTO #TempTxtArea
		FROM ZnodePimAttributeValue PPCP
		INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = PPCP.PimAttributeId)
		INNER JOIN ZnodePimProductAttributeTextAreaValue ZPAVL ON (PPCP.PimAttributeValueId =ZPAVL.PimAttributeValueId)
		WHERE EXISTS (Select * from @LocaleId x where ZPAVL.LocaleId = x.Id) AND
		EXISTS(SELECT * FROM #ZnodePublishCategoryProductForValidation PPCP1  WHERE PPCP1.PimProductId = PPCP.PimProductId)
		
		CREATE INDEX Idx_#TempTxtArea_1 ON #TempTxtArea(PimAttributeId,LocaleId)
		CREATE INDEX Idx_#TempTxtArea_2 ON #TempTxtArea(PimProductId,AttributeCode,LocaleId)

		--Getting tex area attribute value entity		
		SELECT ZPAVL.PimProductId , ZPAVL.AttributeCode,'' AttributeValue ,
			JSON_MODIFY (JSON_MODIFY (Json_Query( ZPAX.AttributeJSON  ) , '$.AttributeValues' ,  ISNULL(ZPAVL.AttributeValue,'') ) ,'$.SelectValues',Json_Query('[]'))
		    AS 'AttributeEntity', 
		 ZPAVL.LocaleId
		INTO #TempTxtAreaEntity
		FROM #TempTxtArea ZPAVL 
		INNER JOIN ZnodePimAttributeJSON ZPAX ON (ZPAX.PimAttributeId = ZPAVL.PimAttributeId AND ZPAVL.LocaleId = ZPAX.LocaleId)

		IF (SELECT COUNT(*) FROM @LocaleId) > 1
		BEGIN
			----Getting product attribute value entity getting for other locale with text area attribute json
			INSERT INTO #TempTxtAreaEntity(PimProductId,AttributeCode,AttributeValue,AttributeEntity,LocaleId)
			SELECT ZPAVL.PimProductId , ZPAVL.AttributeCode,'' AttributeValue ,
				JSON_MODIFY (JSON_MODIFY (Json_Query( ZPAX.AttributeJSON  ) , '$.AttributeValues' ,  ISNULL(ZPAVL.AttributeValue,'') ) ,'$.SelectValues',Json_Query('[]'))
				AS 'AttributeEntity', 
			 ZPAVL.LocaleId
			FROM #TempTxtArea ZPAVL 
			INNER JOIN ZnodePimAttributeJSON ZPAX ON (ZPAX.PimAttributeId = ZPAVL.PimAttributeId AND ZPAX.LocaleId = @DefaultLocaleId)
			WHERE Exists (SELECT TOP 1 1 FROM @LocaleId X WHERE X.Id =  ZPAVL.LocaleId )
			AND ZPAX.LocaleId = @DefaultLocaleId AND ZPAVL.LocaleId <> @DefaultLocaleId
			AND NOT EXISTS(SELECT * FROM #TempTxtAreaEntity ZPAVL1 WHERE ZPAVL.PimProductId = ZPAVL1.PimProductId AND ZPAVL.AttributeCode = ZPAVL1.AttributeCode AND ZPAVL.LocaleId = ZPAVL1.LocaleId)
		END
		
		INSERT INTO ##AttributeValueLocale ( PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId )
		Select PimProductId , AttributeCode,'' AttributeValue ,AttributeEntity, LocaleId 
		FROM #TempTxtAreaEntity

		 ----Getting custom field value entity
		 INSERT INTO ##AttributeValueLocale ( PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId )
 		 SELECT ZPCFX.PimProductId , ZPCFX.CustomCode, '' AttributeValue ,
			JSON_MODIFY (Json_Query( ZPCFX.CustomeFiledJson) ,'$.SelectValues',Json_Query('[]')) AttributeEntity, 
			ZPCFX.LocaleId
		 FROM ZnodePimCustomeFieldJSON ZPCFX 
		 WHERE EXISTS (Select * from @LocaleId x where ZPCFX.LocaleId = x.Id) 
		 AND EXISTS(SELECT * FROM #ZnodePublishCategoryProduct PPCP WHERE (PPCP.PimProductId = ZPCFX.PimProductId ))
		 AND NOT EXISTS(SELECT * FROM ##AttributeValueLocale AVL WHERE ZPCFX.PimProductId = AVL.PimProductId AND ZPCFX.CustomCode = AVL.AttributeCode AND ZPCFX.LocaleId = AVL.LocaleId )
		 GROUP BY ZPCFX.PimProductId , ZPCFX.CustomCode, ZPCFX.CustomeFiledJson , ZPCFX.LocaleId
		 
		 --Getting Media attribute value entity		
		SELECT PPCP.PimProductId , ZPA.AttributeCode,ISNULL(ZPAVL.MediaPath,'') AttributeValue,ZPAVL.LocaleId,ZPA.PimAttributeId,PPCP.PimAttributeValueId
		INTO #TempMedia
		FROM ZnodePimAttributeValue PPCP
		INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = PPCP.PimAttributeId)
		INNER JOIN ZnodePimProductAttributeMedia ZPAVL ON (PPCP.PimAttributeValueId =ZPAVL.PimAttributeValueId)
		WHERE EXISTS (SELECT * FROM @LocaleId x where ZPAVL.LocaleId = x.Id) AND
		EXISTS(SELECT * FROM #ZnodePublishCategoryProductForValidation PPCP1  WHERE PPCP1.PimProductId = PPCP.PimProductId)
		
		CREATE INDEX #TempMedia_1 ON #TempMedia(PimAttributeValueId,LocaleId)
		CREATE INDEX #TempMedia_2 ON #TempMedia(PimAttributeId)
		CREATE INDEX #TempMedia_3 ON #TempMedia(PimProductId,AttributeCode,LocaleId)

		 ----Getting image attribute value entity
		 INSERT INTO ##AttributeValueLocale ( PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId )
		 SELECT PPCP.PimProductId, PPCP.AttributeCode,'' AttributeValue,
		 JSON_MODIFY (JSON_MODIFY (Json_Query( ZPAX.AttributeJSON  ) , '$.AttributeValues',  
		 ISNULL((SELECT stuff( (SELECT ','+ZPPAM.AttributeValue FROM #TempMedia ZPPAM WHERE (ZPPAM.PimAttributeValueId = PPCP.PimAttributeValueId AND PPCP.LocaleId = ZPAX.LocaleId )
				 FOR XML PATH(''),Type).value('.', 'varchar(max)'), 1, 1, '')
				 
				 ),'') ) ,'$.SelectValues',Json_Query('[]'))   
				 AS 'AttributeEntity', 
				 ZPAX.LocaleId
		 FROM #TempMedia PPCP 
		 INNER JOIN ZnodePimAttributeJSON ZPAX ON (ZPAX.PimAttributeId = PPCP.PimAttributeId AND ZPAX.LocaleId = PPCP.LocaleId)
		 WHERE Exists (SELECT TOP 1 1 FROM @LocaleId X WHERE X.Id =  ZPAX.LocaleId )  
		 AND NOT EXISTS(SELECT * FROM ##AttributeValueLocale AVL WHERE PPCP.PimProductId = AVL.PimProductId AND PPCP.AttributeCode = AVL.AttributeCode AND ZPAX.LocaleId = PPCP.LocaleId )
		 AND NOT EXISTS(SELECT * FROM ZnodePimConfigureProductAttribute UOP WHERE ZPAX.PimAttributeId = UOP.PimAttributeId AND PPCP.PimProductId = UOP.PimProductId )
	
		 IF (SELECT COUNT(*) FROM @LocaleId) > 1
		 BEGIN
				----Getting product attribute value entity getting for other locale with default attribute json
				INSERT INTO ##AttributeValueLocale ( PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId )
				 SELECT PPCP.PimProductId, PPCP.AttributeCode,'' AttributeValue,
				 JSON_MODIFY (JSON_MODIFY (Json_Query( ZPAX.AttributeJSON  ) , '$.AttributeValues',  
				 ISNULL((SELECT stuff( (SELECT ','+ZPPAM.AttributeValue FROM #TempMedia ZPPAM WHERE (ZPPAM.PimAttributeValueId = PPCP.PimAttributeValueId AND PPCP.LocaleId = ZPAX.LocaleId )
						 FOR XML PATH(''),Type).value('.', 'varchar(max)'), 1, 1, '')
				 
						 ),'') ) ,'$.SelectValues',Json_Query('[]'))   
						 AS 'AttributeEntity', 
						 PPCP.LocaleId
				 FROM #TempMedia PPCP 
				 INNER JOIN ZnodePimAttributeJSON ZPAX ON (ZPAX.PimAttributeId = PPCP.PimAttributeId AND ZPAX.LocaleId = @DefaultLocaleId)
				 WHERE ZPAX.LocaleId = @DefaultLocaleId AND PPCP.LocaleId <> @DefaultLocaleId 
				 AND Exists (SELECT TOP 1 1 FROM @LocaleId X WHERE X.Id =  PPCP.LocaleId )  
				 AND NOT EXISTS(SELECT * FROM ##AttributeValueLocale AVL WHERE PPCP.PimProductId = AVL.PimProductId AND PPCP.AttributeCode = AVL.AttributeCode AND ZPAX.LocaleId = AVL.LocaleId )
				 AND NOT EXISTS(SELECT * FROM ZnodePimConfigureProductAttribute UOP WHERE ZPAX.PimAttributeId = UOP.PimAttributeId AND PPCP.PimProductId = UOP.PimProductId )
		END
		 -------------configurable attribute 		 
		INSERT INTO ##AttributeValueLocale ( PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId )
		SELECT DISTINCT UOP.PimProductId,c.AttributeCode,'' AttributeValue ,--'<Attributes><AttributeEntity>'+
		JSON_MODIFY (Isnull(JSON_MODIFY (c.AttributeJson,'$.AttributeValues',''),'')  ,'$.SelectValues',
			Isnull((SELECT DISTINCT 
							Isnull(JSON_VALUE(AA.DefaultValueJson, '$.Code'),'') Code 
							,Isnull(JSON_VALUE(AA.DefaultValueJson, '$.LocaleId'),0) LocaleId
							,Isnull(JSON_VALUE(AA.DefaultValueJson, '$.Value'),'') Value
							,Isnull(JSON_VALUE(AA.DefaultValueJson, '$.AttributeDefaultValue'),'') AttributeDefaultValue
							,Isnull(JSON_VALUE(AA.DefaultValueJson, '$.DisplayOrder'),0) DisplayOrder
							,Isnull(JSON_VALUE(AA.DefaultValueJson, '$.IsEditable'),'false') IsEditable
							,Isnull(JSON_VALUE(AA.DefaultValueJson, '$.SwatchText'),'') SwatchText
							,Isnull(JSON_VALUE(AA.DefaultValueJson, '$.Path'),'') Path 
							,ISNULL(ZPA.DisplayOrder,0)  AS VariantDisplayOrder 
							,ISNULL(ZPAVL_SKU.AttributeValue,'')   AS VariantSKU 
							,Isnull(ZPAV12.AttributeValue,'') AS VariantImagePath 
						 FROM ZnodePimAttributeDefaultJSON AA 
						 INNER JOIN #PimProductAttributeDefaultValue ZPADV ON ( ZPADV.PimAttributeDefaultValueId = AA.PimAttributeDefaultValueId )
						 INNER JOIN ZnodePimProductTypeAssociation YUP ON (YUP.PimProductId = ZPADV.PimProductId)
						 INNER JOIN #VariantSKU ZPAVL_SKU On YUP.PimProductId = ZPAVL_SKU.PimProductId
						 LEFT JOIN #TempMedia ZPAV12 ON (ZPAV12.PimProductId= YUP.PimProductId  AND ZPAV12.PimAttributeId = @PimMediaAttributeId ) 
						 LEFT JOIN ZnodePimAttribute ZPA ON (ZPA.PimattributeId = ZPADV.PimAttributeId)
						 WHERE (YUP.PimParentProductId  = UOP.PimProductId AND ZPADV.pimAttributeId = UOP.PimAttributeId )
		FOR JSON auto),'[]')) SelectValuesEntity ,
		c.LocaleId
		FROM ZnodePimConfigureProductAttribute UOP 
		INNER JOIN ZnodePimAttributeJSON c   ON (c.PimAttributeId = UOP.PimAttributeId )
		WHERE Exists (Select TOP 1 1 from @LocaleId X where X.Id = C.LocaleId )  
		AND EXISTS(SELECT * FROM #ZnodePublishCategoryProductForValidation PPCP1 where UOP.PimProductId = PPCP1.PimProductId )

		---Insert product attributewise data for other locale of default locale as local ise attribute data not present
		IF (SELECT COUNT(*) FROM @LocaleId) > 1
		BEGIN
			DECLARE @cur_Id int
			DECLARE cur_LocaleId CURSOR LOCAL FAST_FORWARD
			FOR SELECT Id FROM @LocaleId WHERE Id <> @DefaultLocaleId;

			OPEN cur_LocaleId;
			FETCH NEXT FROM cur_LocaleId INTO  @cur_Id;

			WHILE @@FETCH_STATUS = 0
			BEGIN 
				INSERT INTO ##AttributeValueLocale (PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId)
				SELECT A.PimProductId, A.AttributeCode, A.AttributeValue, A.AttributeEntity, b.Id
				FROM ##AttributeValueLocale a
				CROSS APPLY @LocaleId b 
				WHERE NOT EXISTS(SELECT * FROM ##AttributeValueLocale c WHERE a.PimProductId = c.PimProductId AND b.Id = c.LocaleId AND a.AttributeCode = c.AttributeCode )
				AND a.LocaleId = @DefaultLocaleId AND b.Id = @cur_Id

				FETCH NEXT FROM cur_LocaleId INTO  @cur_Id;
			END;
			CLOSE cur_LocaleId;
			DEALLOCATE cur_LocaleId;
		END
		-------------configurable attribute 
		--select * from #AttributeValueLocale

		--CREATE INDEX IDX_#AttributeValueLocale ON #AttributeValueLocale(PimProductId,AttributeCode,LocaleId)
		--CREATE INDEX IDX_#AttributeValueLocale_Id ON #AttributeValueLocale(ID)
		 	
		--DELETE ZPPAX FROM ZnodePublishProductAttributeJson ZPPAX
		--WHERE exists (SELECT * FROM #AttributeValueLocale AVL WHERE ZPPAX.PimProductId = AVL.PimProductId AND AVL.LocaleId = ZPPAX.LocaleId )
		--AND NOT EXISTS(SELECT * FROM #AttributeValueLocale AVL WHERE ZPPAX.PimProductId = AVL.PimProductId AND AVL.LocaleId = ZPPAX.LocaleId AND ZPPAX.AttributeCode = AVL.AttributeCode )

		--DECLARE @MaxCount INT, @MinRow INT, @MaxRow INT, @Rows numeric(10,2);
		--SELECT @MaxCount = COUNT(*) FROM #AttributeValueLocale;

		--SELECT @Rows = 200000
        
		--SELECT @MaxCount = CEILING(@MaxCount / @Rows);

		--IF OBJECT_ID('tempdb..#Temp_ImportLoop') IS NOT NULL
  --          DROP TABLE #Temp_ImportLoop;
        
		------ To get the min AND max rows for import in loop
		--;WITH cte AS 
		--(
		--	SELECT RowId = 1, 
		--		   MinRow = 1, 
  --                 MaxRow = cast(@Rows as int)
  --          UNION ALL
  --          SELECT RowId + 1, 
  --                 MinRow + cast(@Rows as int), 
  --                 MaxRow + cast(@Rows as int)
  --          FROM cte
  --          WHERE RowId + 1 <= @MaxCount
		--)
  --      SELECT RowId, MinRow, MaxRow
  --      INTO #Temp_ImportLoop
  --      FROM cte
		--OPTION (maxrecursion 0);

		----Cursor for rows wise execution in bulk
		--DECLARE cur_BulkData CURSOR LOCAL FAST_FORWARD
  --      FOR SELECT MinRow, MaxRow FROM #Temp_ImportLoop
		--WHERE EXISTS(SELECT * FROM #AttributeValueLocale);

  --      OPEN cur_BulkData;
  --      FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow;

  --      WHILE @@FETCH_STATUS = 0
  --      BEGIN
	 --        UPDATE ZnodePublishProductAttributeJson SET IsUpdateLocaleWise = 0 WHERE ISNULL(IsUpdateLocaleWise,0) = 1
		--	  ----Update Product Attribute XML
		--	 UPDATE ZPPAX SET ZPPAX.Attributes = AVL.AttributeEntity, ZPPAX.ModifiedBy = @UserId, ZPPAX.ModifiedDate = GETDATE() 
		--	        , ZPPAX.IsUpdateLocaleWise = 0
		--	 FROM ZnodePublishProductAttributeJson ZPPAX 
		--	 INNER JOIN #AttributeValueLocale AVL ON ZPPAX.PimProductId = AVL.PimProductId AND AVL.LocaleId = ZPPAX.LocaleId AND ZPPAX.AttributeCode = AVL.AttributeCode 
		--	 WHERE  AVL.Id BETWEEN @MinRow AND @MaxRow AND AVL.AttributeEntity is not null
		 
		--	 ----Insert Product Attribute XML
		--	 INSERT INTO ZnodePublishProductAttributeJson(PimProductId,LocaleId,AttributeCode,Attributes,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		--	 SELECT AVL.PimProductId, AVL.LocaleId, AVL.AttributeCode, cast(AVL.AttributeEntity as varchar(max)), @UserId CreatedBy, GETDATE() CreatedDate, @UserId ModifiedBy, GETDATE() ModifiedDate
		--	 FROM #AttributeValueLocale AVL
		--	 WHERE NOT EXISTS(SELECT * FROM ZnodePublishProductAttributeJson ZPPAX WHERE AVL.PimProductId = ZPPAX.PimProductId AND  AVL.LocaleId = ZPPAX.LocaleId AND AVL.AttributeCode = ZPPAX.AttributeCode )
		--	 AND  AVL.Id BETWEEN @MinRow AND @MaxRow AND AVL.AttributeEntity is not null
		--	 GROUP BY AVL.PimProductId, AVL.AttributeEntity, AVL.LocaleId, AVL.AttributeCode

		--	 FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow;
  --      END;
		--CLOSE cur_BulkData;
		--DEALLOCATE cur_BulkData;

		--DELETE ZPPAX
		--FROM ZnodePublishProductAttributeJson ZPPAX
		--WHERE LocaleId <> @DefaultLocaleId
		--AND exists( SELECT * FROM ZnodePublishProductAttributeJson ZPPAX1 WHERE ZPPAX.AttributeCode = ZPPAX1.AttributeCode AND ZPPAX.PimProductId = ZPPAX1.PimProductId )
		--AND NOT EXISTS(SELECT * FROM #ProductLocaleWise AVL WHERE AVL.PimProductId = ZPPAX.PimProductId AND  AVL.LocaleId = ZPPAX.LocaleId )
		
		
		--DELETE  ZPPAX
		--FROM ZnodePublishProductAttributeJson ZPPAX
		--WHERE NOT EXISTS(SELECT * FROM #ProductLocaleWise ZLW WHERE ZPPAX.PimProductId = ZLW.PimProductId 
		--	                AND ZPPAX.LocaleId = ZLW.LocaleId )

		--SELECT PimProductId,Attributes Attributes,AttributeCode
		--INTO #ZnodePublishProductAttributeJson
		--FROM ZnodePublishProductAttributeJson 
		--WHERE LocaleId = @DefaultLocaleId

		--INSERT INTO ZnodePublishProductAttributeJson (PimProductId,Attributes,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AttributeCode)
		--SELECT PimProductId,Attributes,b.id,@UserId,GETDATE(),@UserId,GETDATE(),AttributeCode
		--FROM #ZnodePublishProductAttributeJson a
		--CROSS APPLY @LocaleId b 
		--WHERE NOT EXISTS(SELECT * FROM ZnodePublishProductAttributeJson c WHERE a.PimProductId = c.PimProductId AND b.Id = c.LocaleId AND a.AttributeCode = c.AttributeCode )
		--AND b.Id <> @DefaultLocaleId
					  
END TRY
BEGIN CATCH
select ERROR_MESSAGE()
    DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertUpdatePimCatalogProductDetailJson @PublishCatalogId = '+CAST(@PublishCatalogId AS VARCHAR(200))+',@UserId='+CAST(@UserId AS VARCHAR(200));


    EXEC Znode_InsertProcedureErrorLog
        @ProcedureName = 'Znode_InsertUpdatePimCatalogProductDetailJson',
        @ErrorInProcedure = @Error_procedure,
        @ErrorMessage = @ErrorMessage,
        @ErrorLine = @ErrorLine,
        @ErrorCall = @ErrorCall;
            
            
END CATCH;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity
GO

CREATE PROCEDURE [dbo].[Znode_PublishCatalogEntity]  
(  
	@PimCatalogId  INT = 0   
	,@RevisionState VARCHAR(50) = ''   
	,@UserId INT = 0  
	,@NewGUID NVARCHAR(500)   
	,@IsDraftProductsOnly BIT = 1  
)  
AS  
/*  
To publish all catalog product and their details  
Unit Testing :   
Exec [dbo].[Znode_PublishCatalogEntity]  
@PimCatalogId  = 3  
,@RevisionState = 'PRODUCTION'   
,@UserId = 2  
,@NewGUID = '123'  
   
EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,  
@NewGUID ='123'   
  
*/  
BEGIN  
BEGIN TRY   
	SET NOCOUNT ON  

	DECLARE @Status Bit =0 , @PublishCatalogId INT=0  
	IF (@PimCatalogId=0)  
	BEGIN  
	--SET @Status =0  
		SELECT 0 AS ID,@Status AS Status;  
		SET @PublishCatalogId=0  
		SELECT @PublishCatalogId;  
	END  
	ELSE  
	BEGIN  
   
		DECLARE @Type VARCHAR(50) = '', @CMSSEOCode VARCHAR(300);  
		SET @Status = 1   
		DECLARE @IsPreviewEnable INT  
		,@PreviewVersionId INT = 0    
		,@ProductionVersionId INT = 0  
		,@CatalogProfileId VARCHAR(1000)  
   
		IF OBJECT_ID('tempdb..#CatalogAttributeDetails') IS NOT NULL  
		DROP TABLE #CatalogAttributeDetails  
		CREATE TABLE [dbo].[#CatalogAttributeDetails]  
		(  
			[ZnodeCatalogId] [INT] NULL,  
			[AttributeCode] [NVARCHAR](300) NULL,  
			[AttributeTypeName] [VARCHAR](300) NULL,  
			[IsComparable] [bit] NOT NULL,  
			[IsHtmlTags] [bit] NOT NULL,  
			[IsFacets] [bit] NOT NULL,  
			[IsUseInSearch] [bit] NOT NULL,  
			[IsPersonalizable] [bit] NOT NULL,  
			[IsConfigurable] [bit] NOT NULL,  
			[AttributeName] [NVARCHAR](300) NULL,  
			[LocaleId] [INT] NULL,  
			[DisplayOrder] [INT] NULL,  
			[DefaultValueDisplayOrder] [INT] NULL,  
			[AttributeDefaultValue] [NVARCHAR](max) NULL  
		) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY] 
		
		DECLARE @CatalogName VARCHAR(100),@UserName VARCHAR(50)  
		SET @PublishCatalogId = ISNULL((SELECT TOP 1 PublishCatalogId FROM ZnodePublishCatalog ZPC WHERE ZPC.PimCatalogId = @PimCatalogId), 0)  
    
	SELECT TOP 1  @UserName = UserName 
	FROM ZnodeUser 
	WHERE ZnodeUser.UserId = @userId  
  
	SELECT @CatalogName = CatalogName FROM ZnodePimCatalog WHERE PimCatalogId = @PimCatalogId
	
	DELETE FROM ZnodePublishProgressNotifierEntity WHERE JOBName =@CatalogName   

	INSERT INTO ZnodePublishProgressNotifierEntity  
	(VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriENDlyName)  
	VALUES(0,@NewGUID , Isnull(@CatalogName,'') + ' Catalog ', 0 , 0 , 0 , '' , @UserId, @UserName )  
  
	IF EXISTS (SELECT  * FROM ZnodePublishStateApplicationTypeMapping PSA WHERE PSA.IsEnabled =1 AND    
	EXISTS (SELECT TOP 1 1  FROM ZnodePublishState PS WHERE PS.PublishStateId = PSA.PublishStateId ) AND ApplicationType =  'WebstorePreview')  
		SET @IsPreviewEnable = 1   
	ELSE   
		SET @IsPreviewEnable = 0   
  
	--Genrate preview entry   
	DECLARE @SetLocaleId INT , @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleId(), @MaxCount INT =0 , @IncrementalId INT = 1    
	DECLARE @TBL_Locale TABLE (LocaleId INT , RowId INT IDENTITY(1,1))  
    
	IF OBJECT_ID('tempdb..[#Tbl_NewVersionEntity]') IS NOT NULL  
		DROP TABLE tempdb..#Tbl_NewVersionEntity  
	
	CREATE TABLE #Tbl_NewVersionEntity(PublishCatalogId INT , VersionId INT , LocaleId INT , PublishType VARCHAR(50) )  
  
	--IF OBJECT_ID('tempdb..[#Tbl_OldVersionEntity]') IS NOT NULL  
	--	DROP TABLE tempdb..#Tbl_OldVersionEntity  
	
	--CREATE TABLE #Tbl_OldVersionEntity(PublishCatalogId INT , NewVersionId INT ,OldVersionId INT , LocaleId INT , PublishType VARCHAR(50) )  
    
    
	IF @PublishCatalogId > 0   
    BEGIN
		UPDATE ZPC SET CatalogName = ZC.CatalogName,ExternalId = ZC.ExternalId,PimCatalogId= @PimCatalogId,CreatedBy = @UserId,  
		CreatedDate = Getdate(),ModifiedBy = @UserId,ModifiedDate = Getdate()  
		FROM ZnodePublishCatalog ZPC   
		INNER JOIN ZnodePimCatalog ZC ON(ZC.PimCatalogId = ZPC.PimCatalogId)  
		WHERE ZPC.PimCatalogId = @PimCatalogId;  
	END
	ELSE  
	BEGIN  
		INSERT INTO ZnodePublishCatalog (PimCatalogId,CatalogName,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)  
		SELECT PimCatalogId,CatalogName,ExternalId,@UserId,Getdate(),@UserId,Getdate() FROM ZnodePimCatalog AS ZPC   
		WHERE ZPC.PimCatalogId = @PimCatalogId;  
                        
		SET @PublishCatalogId = SCOPE_IDENTITY();  
	END  
  
	--Getting active local for catalog which are associated to store
	INSERT INTO @TBL_Locale (LocaleId) 
	SELECT LocaleId FROM DBO.FN_GetCatalogPortalActiveLocale(@PublishCatalogId)
  
	SET @MaxCount = ISNULL((SELECT MAx(RowId) FROM @TBL_Locale),0)  

	WHILE @IncrementalId <= @MaxCount  
	BEGIN   
		SET @SetLocaleId = (SELECT Top 1 LocaleId FROM @TBL_locale WHERE RowId = @IncrementalId)  

		IF @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  )    
		BEGIN  
			
			INSERT INTO ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId)  
			SELECT @PublishCatalogId,  @PimCatalogId,NULL,0,  
			NULL,0,  
			NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(), null ,@SetLocaleId ,DBO.Fn_GetPublishStateIdForProcessing()   
  
			INSERT INTO #Tbl_NewVersionEntity (PublishCatalogId,VersionId,LocaleId,PublishType)  
			SELECT @PublishCatalogId, @@Identity , @SetLocaleId ,'PREVIEW'  
      
		END  

		IF (@RevisionState like '%Production%' OR @RevisionState = 'None')  
		BEGIN  
			UPDATE B
            SET IsPublishSuccess = 0
            FROM ZnodePublishVersionEntity B
            WHERE EXISTS(SELECT * FROM #Tbl_NewVersionEntity A WHERE A.PublishCatalogId = B.ZnodeCatalogId 
                AND A.PublishType = 'PRODUCTION' AND A.LocaleId = B.LocaleId) 
            AND B.RevisionType = 'PRODUCTION'

			--Genrate production entry   
			INSERT INTO ZnodePublishCatalogLog  
			(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId)  
			SELECT @PublishCatalogId,  @PimCatalogId,NULL,0,  
			NULL,0,  
			NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(), null ,@SetLocaleId ,DBO.Fn_GetPublishStateIdForProcessing()   
     
			INSERT INTO #Tbl_NewVersionEntity (PublishCatalogId,VersionId,LocaleId,PublishType)  
			SELECT @PublishCatalogId, @@Identity , @SetLocaleId ,'PRODUCTION'  
		END   
			SET @IncrementalId = @IncrementalId +1   
	END  
	
	DECLARE  @VersionIdString VARCHAR(2000)= ''    
     
	TRUNCATE TABLE ZnodePublishCatalogErrorLogEntity  

	UPDATE ZnodePublishProgressNotifierEntity SET   
	ProgressMark =5,   
	IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
	IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
	WHERE  JobId = @NewGUID  
   
	--EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = @PublishCatalogId,@UserId = @UserId , @IsRevertPublish = 0 ,  
	--@NewGUID =@NewGUID   
  
	IF @Type = 'ZnodePublishCatalogEntity' OR @Type = ''  
	BEGIN  
   
		INSERT INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing)  
		SELECT Distinct VE.VersionId, ZPC.PublishCatalogId, PC.CatalogName,VE.PublishType, VE.LocaleId, isnull(PC.IsAllowIndexing,0)  
		FROM ZnodePublishCatalog ZPC  
		INNER JOIN  #Tbl_NewVersionEntity VE ON (VE.PublishCatalogId = ZPC.PublishCatalogId)  
		INNER JOIN ZnodePimCatalog PC on ZPC.PimCatalogId = PC.PimCatalogId  
		-- Data inserted INTo flat table ZnodeWebStoreEntity (Replica of MongoDB Collection )    
    
		IF @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  )   
		BEGIN  
			UPDATE B
            SET IsPublishSuccess = 0
            FROM ZnodePublishVersionEntity B
            WHERE EXISTS(SELECT * FROM #Tbl_NewVersionEntity A WHERE A.PublishCatalogId = B.ZnodeCatalogId 
                AND A.PublishType = 'PREVIEW' AND A.LocaleId = B.LocaleId) 
            AND B.RevisionType = 'PREVIEW'

			INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
			SELECT VersionId,PublishCatalogId,PublishType,LocaleId,0 FROM  #Tbl_NewVersionEntity A
			WHERE A.PublishType = 'PREVIEW'  
			AND NOT EXISTS(SELECT * FROM ZnodePublishVersionEntity B WHERE A.PublishCatalogId = B.ZnodeCatalogId 
			AND B.RevisionType = 'PREVIEW' AND A.LocaleId = B.LocaleId )
		END  

		IF (@RevisionState like '%Production%' OR @RevisionState = 'None')  
		BEGIN  
			UPDATE B
            SET IsPublishSuccess = 0
            FROM ZnodePublishVersionEntity B
            WHERE EXISTS(SELECT * FROM #Tbl_NewVersionEntity A WHERE A.PublishCatalogId = B.ZnodeCatalogId 
                AND A.PublishType = 'PRODUCTION' AND A.LocaleId = B.LocaleId) 
            AND B.RevisionType = 'PRODUCTION'

			INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
			SELECT VersionId,PublishCatalogId,PublishType,LocaleId,0 FROM  #Tbl_NewVersionEntity A
			WHERE PublishType = 'PRODUCTION'  
			AND NOT EXISTS(SELECT * FROM ZnodePublishVersionEntity B WHERE A.PublishCatalogId = B.ZnodeCatalogId 
			AND B.RevisionType = 'PRODUCTION' AND A.LocaleId = B.LocaleId )
		END  
  
		INSERT INTO ZnodePublishCatalogErrorLogEntity  
		(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishCatalogEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
	END  
  
	SELECT @VersionIdString = STUFF((SELECT ',' + cast (VersionId as VARCHAR(50))  
	FROM ZnodePublishVersionEntity WHERE ZnodeCatalogId = @PublishCatalogId FOR XML PATH ('')), 1, 1, '')   

	IF @Type = 'ZnodePublishCategoryEntity' OR @Type = ''  
	BEGIN  
		EXEC [Znode_GetPublishCategoryJson]  
		@PublishCatalogId = @PublishCatalogId ,  
		@UserId =@UserId,                 
		@VersionIdString = @VersionIdString,  
		@Status  =@Status Out,  
		@RevisionState = @RevisionState   
   
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishCategoryEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
     
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =30,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
  
		IF @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END   
   
	IF @Type = 'ZnodePublishProductEntity' OR @Type = ''  
	BEGIN  
		-- Process call catalog publish (include category, products with multiple types)  
		DECLARE @PimProductId TransferId   
		EXEC [Znode_PublishLatestAssociatedProduct] @PublishCatalogId = @PublishCatalogId, @PimProductId = @PimProductId  , @UserId = @UserId , @PublishStateId =0   
		EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId= @PublishCatalogId ,@userid =@userid ,@PimProductId = @PimProductId   
		EXEC Znode_GetPublishProductJson   
		@PublishCatalogId =@PublishCatalogId   
		,@PimProductId = @PimProductId   
		,@UserId = @userid  
		,@PimCatalogId = @PimCatalogId   
		,@VersionIdString = @VersionIdString  
		,@Status  =@Status  Out  
		,@RevisionState = @RevisionState   
		,@IsDraftProductsOnly = @IsDraftProductsOnly  
   
    
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishProductEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =50,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
		If @Status  = 1  
		BEGIN  
			UPDATE ZPCE SET ZPCE.ProductIds =   
			'[' +SUBSTRING((SELECT ','+CAST(PublishProductId AS VARCHAR(50))  
			FROM ZnodePublishCategoryProduct ZPCP   
			WHERE ZPCP.PublishCategoryId = ZPCE.ZnodeCategoryId  
			AND ZPCP.PublishCatalogId = ZPCE.ZnodeCatalogId  FOR XML PATH('')), 2, 8000) + ']'   
			FROM ZnodePublishCategoryEntity  ZPCE WHERE ZPCE.ProductIds is null   
		END  
  
  
		If @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END  

	IF @Type = 'ZnodePublishAddOnEntity' OR @Type = ''  
	BEGIN  
		Exec [Znode_GetPublishAssociatedAddonsJson]  
		@PublishCatalogId = @PublishCatalogId ,  
		@PimProductId   = @PimProductId ,  
		@UserId =@UserId,                 
		@VersionIdString = @VersionIdString,  
		@RevisionType='',  
		@Status  =@Status Out  
  
    
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishAddOnEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =52,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
     
		If @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END   
   
	If @Type = 'BundleAssociatedProducts' OR @Type = ''  
	BEGIN  
		Exec [Znode_GetPublishAssociatedProductsJson]  
		@PublishCatalogId = @PublishCatalogId ,  
		@UserId =@UserId,                 
		@VersionIdString = @VersionIdString,  
		@RevisionType = '',  
		@Status  =@Status Out,  
		@ProductType    = 'BundleProduct'  
    
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'BundleAssociatedProducts', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =54,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
     
		If @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END   

	IF @Type = 'GroupedAssociatedProducts' OR @Type = ''  
	BEGIN  
		Exec [Znode_GetPublishAssociatedProductsJson]  
		@PublishCatalogId = @PublishCatalogId ,  
		@UserId =@UserId,                 
		@VersionIdString = @VersionIdString,  
		@RevisionType = '',  
		@Status  =@Status Out,  
		@ProductType    = 'GroupedProduct'  

		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'GroupedAssociatedProducts', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
     
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =56,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  

		IF @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END   

	IF @Type = 'ConfigurableAssociatedProducts' OR @Type = ''  
	BEGIN  
		Exec [Znode_GetPublishAssociatedProductsJson]  
		@PublishCatalogId = @PublishCatalogId ,  
		@UserId =@UserId,                 
		@VersionIdString = @VersionIdString,  
		@RevisionType = '',  
		@Status  =@Status Out,  
		@ProductType= 'ConfigurableProduct'  
  
      
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ConfigurableAssociatedProducts', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =58,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
     
		IF @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END   

	IF @Type = 'CatalogAttributeaDetail' OR @Type = ''  
	BEGIN  
	BEGIN TRY  
		INSERT INTO [dbo].[#CatalogAttributeDetails]([ZnodeCatalogId],[AttributeCode],[AttributeTypeName],[IsComparable],  
		[IsHtmlTags],[IsFacets],[IsUseInSearch],[IsPersonalizable],[IsConfigurable],[AttributeName],  
		[LocaleId],[DisplayOrder],[DefaultValueDisplayOrder],[AttributeDefaultValue] )  
		EXEC Znode_GetPublishProductAttribute @PublishCatalogId   
     
		INSERT INTO ZnodePublishCatalogAttributeEntity  
		(VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition,IsComparable,  
		IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,  
		AttributeName,LocaleId,DisplayOrder,SELECTValues)  
		SELECT Distinct   
		B.VersionId, A.[ZnodeCatalogId],A.[AttributeCode],A.[AttributeTypeName],0 IsPromoRuleCondition,[IsComparable],  
		[IsHtmlTags],[IsFacets],[IsUseInSearch],[IsPersonalizable],[IsConfigurable],  
		[AttributeName],A.[LocaleId],[DisplayOrder] ,  
		(SELECT Isnull(IA.AttributeDefaultValue,'') Value , Isnull(IA.[DefaultValueDisplayOrder],'') DisplayOrder    
		from [dbo].[#CatalogAttributeDetails] IA  WHERE IA.AttributeCode = A.AttributeCode AND IA.LocaleId = A.LocaleId   
		For JSON PATH)  
		FROM [dbo].[#CatalogAttributeDetails] A INNER JOIN #Tbl_NewVersionEntity B on A.LocaleId = B.LocaleId  
   
		SET @Status =1   
    
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'CatalogAttributeaDetail', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =60,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
     
  
	END TRY   
	BEGIN CATCH   
		SET @Status   = 0   
     
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'CatalogAttributeaDetail', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		IF @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END CATCH    
	END   
  
	IF @Type = 'ZnodePublishSEOEntity' OR @Type = ''  
	BEGIN  
		EXEC [Znode_SetPublishSEOEntity]  
		@RevisionState = @RevisionState   
		,@CMSSEOTypeId  = '1,2'   
		,@UserId  = @UserId   
		,@Status  = @Status  OUTPUT   
		,@IsCatalogPublish = 1    
		,@VersionIdString  = @VersionIdString   
		,@IsPreviewEnable  = @IsPreviewEnable   
     
   
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishSEOEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =70,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
  
		If @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
  
	END   
  
	IF EXISTS (SELECT TOP 1 1  FROM ZnodePublishCatalogErrorLogEntity WHERE  ProcessStatus = 'Fail')   
	BEGIN  
    
		SET @Status  =0   
		SELECT 1 AS ID,@Status AS Status;  
		INSERT INTO ZnodePublishCatalogErrorLogEntity  
		(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishPortalEntity', @RevisionState , 'Fail' , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
     
		--EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = @PublishCatalogId,@UserId = @UserId , @IsRevertPublish = 0 ,  
		--@NewGUID =@NewGUID   
  
		UPDATE ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed(),  
		IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0, ModifiedDate = Getdate()  
		WHERE PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()
		
		UPDATE ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed(),  
		IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0  
		, ModifiedDate = Getdate()  
		WHERE PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()
		Return 0   
	END  
  
	SET @Status = 1  
  
    
	SELECT @PublishCatalogId AS id,@Status AS Status;     
END  
END TRY   
BEGIN CATCH   
	SET @Status =0    
	SELECT 1 AS ID,@Status AS Status;     
   
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	@ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity   
	@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))  
	+',@PreviewVersionId = ' + CAST(@PreviewVersionId  AS VARCHAR(20))  
	+',@ProductionVersionId = ' + CAST(@ProductionVersionId  AS VARCHAR(20))  
	+',@RevisionState = ''' + CAST(@RevisionState  AS VARCHAR(50))  
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20)); SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
   
     
	INSERT INTO ZnodePublishCatalogErrorLogEntity  
	(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
	SELECT 'Znode_PublishCatalogEntity', @RevisionState + isnull(@ErrorMessage,'') , 'Fail' , Getdate(),   
	@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
   
	EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = @PublishCatalogId,@UserId = @UserId , @IsRevertPublish = 0 ,  
	@NewGUID =@NewGUID   
  
	UPDATE ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed(),  
	IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0 , ModifiedDate = Getdate()   WHERE  PublishCatalogLogId in   
	(SELECT VersionId FROM #Tbl_NewVersionEntity WHERE PublishType = 'PREVIEW' )  
	UPDATE ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed() ,  
	IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0 , ModifiedDate = Getdate() WHERE  PublishCatalogLogId in  
	(SELECT VersionId FROM #Tbl_NewVersionEntity WHERE PublishType = 'PRODUCTION' )  
                        
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_PublishCatalogEntity',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_SetPublishSEOEntity')
	DROP PROC Znode_SetPublishSEOEntity
GO

CREATE PROCEDURE [dbo].[Znode_SetPublishSEOEntity]
(
   @PortalId  INT = 0 
  ,@LocaleId  INT = 0 
  ,@IsPreviewEnable int = 0 
  ,@PreviewVersionId INT = 0 
  ,@ProductionVersionId INT = 0 
  ,@RevisionState varchar(50) = '' 
  ,@CMSSEOTypeId varchar(500) = '' 
  ,@CMSSEOCode varchar(300) = ''
  ,@UserId int = 0 
  ,@Status int OUTPUT 
  ,@IsCatalogPublish bit = 0 
  ,@VersionIdString varchar(2000) = ''
  ,@IsSingleProductPublish bit = 0 
)
AS
/*
    This Procedure is used to publish the SEO details
  
	EXEC ZnodeSetPublishSEOEntity 1 2,3
	A. 
		1. Preview - Preview
		2. None    - Production   --- 
		3. Production - Preview/Production
	B.
		select * from ZnodePublishStateApplicationTypeMapping
		select * from ZnodePublishState where PublishStateId in (3,4) 
		select * from ZnodePublishPortalLog 
	C.
		Select * from ZnodePublishState where IsDefaultContentState = 1  and IsContentState = 1  --Production 
    
	Unit testing 
	
	Exec [ZnodeSetPublishSEOEntity]
	   @PortalId  = 1 
	  ,@LocaleId  = 0 
	  ,@PreviewVersionId = 0 
	  ,@ProductionVersionId = 0 
	  ,@RevisionState = 'Preview/Production' 
	  ,@CMSSEOTypeId = 0
	  ,@CMSSEOCode = ''
	  ,@UserId = 0 

	 Exec [ZnodeSetPublishSEOEntity]
   @PortalId  = 1 
  ,@LocaleId  = 0 
  ,@PreviewVersionId = 0 
  ,@ProductionVersionId = 0 
  ,@RevisionState = 'Preview&Production' 
  ,@CMSSEOTypeId = 3
  ,@CMSSEOCode = ''
  ,@UserId = 0 




	
	*/
BEGIN 
BEGIN TRY 
SET NOCOUNT ON
   Begin 
		DECLARE @Tbl_PreviewVersionId    TABLE    (PreviewVersionId int , PortalId int , LocaleId int)
		DECLARE @Tbl_ProductionVersionId TABLE    (ProductionVersionId int  , PortalId int , LocaleId int)
		If (@IsCatalogPublish = 0  AND @IsSingleProductPublish = 0 )
		Begin
			If @PreviewVersionId = 0 
				Begin
   					Insert into @Tbl_PreviewVersionId 
					SELECT distinct VersionId , PortalId, LocaleId from  ZnodePublishWebStoreEntity where (PortalId = @PortalId or @PortalId=0 ) and  (LocaleId = 	@LocaleId OR @LocaleId = 0  ) and PublishState ='PREVIEW'
				end
			Else 
					Insert into @Tbl_PreviewVersionId SELECT distinct VersionId , PortalId, LocaleId from  ZnodePublishWebStoreEntity 
					where VersionId = @PreviewVersionId
			If @ProductionVersionId = 0 
   				Begin
					Insert into @Tbl_ProductionVersionId 
					SELECT distinct VersionId , PortalId , LocaleId from  ZnodePublishWebStoreEntity where (PortalId = @PortalId or @PortalId=0 ) and  (LocaleId = 	@LocaleId OR @LocaleId = 0  ) and PublishState ='PRODUCTION'
				End 
			Else 
				Insert into @Tbl_ProductionVersionId SELECT distinct VersionId , PortalId, LocaleId from  ZnodePublishWebStoreEntity 
				where VersionId = @ProductionVersionId
 		End
		Else if (@IsCatalogPublish= 1  AND @IsSingleProductPublish = 0 )
		Begin
			 IF OBJECT_ID('tempdb..#VesionIds') is not null
				DROP TABLE #VesionIds
  				 
			 SELECT PV.* into #VesionIds FROM ZnodePublishVersionEntity PV Inner join Split(@VersionIdString,',') S ON PV.VersionId = S.Item
		End
		
		DECLARE @SetLocaleId INT , @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleId(), @MaxCount INT =0 , @IncrementalId INT = 1  
		DECLARE @TBL_Locale TABLE (LocaleId INT , RowId INT IDENTITY(1,1))
		CREATE TABLE #TBL_SEO  
		(
			ItemName varchar(50),CMSSEODetailId int ,CMSSEODetailLocaleId int ,CMSSEOTypeId int ,SEOId int ,SEOTypeName varchar(50),SEOTitle nvarchar(Max)
			,SEODescription nvarchar(Max),
			SEOKeywords nvarchar(Max),SEOUrl nvarchar(Max) ,IsRedirect bit ,MetaInformation nvarchar(Max) ,LocaleId int ,
			OldSEOURL nvarchar(Max),CMSContentPagesId int ,PortalId int ,SEOCode varchar(300) ,CanonicalURL varchar(200),RobotTag varchar(50)
		)
		
		BEGIN 
			INSERT INTO @TBL_Locale (LocaleId) SELECT LocaleId FROM ZnodeLocale WHERE IsActive =1 AND (LocaleId  = @LocaleId OR @LocaleId = 0 )
			
			SET @MaxCount = ISNULL((SELECT MAx(RowId) FROM @TBL_Locale),0)
			WHILE @IncrementalId <= @MaxCount
			BEGIN 
				SET @SetLocaleId = (SELECT Top 1 LocaleId FROM @TBL_locale WHERE RowId = @IncrementalId)
				IF @IsSingleProductPublish = 0
				Begin
					;With Cte_GetCMSSEODetails AS 
					(
							select CT.Name ItemName,CD.CMSSEODetailId, CDL.CMSSEODetailLocaleId ,  CD.CMSSEOTypeId ,
									 CD.SEOId ,CDL.SEOTitle,CDL.SEODescription,
									 CDL.SEOKeywords,Lower(CD.SEOUrl) SEOUrl,CD.IsRedirect,CD.MetaInformation,
									 CDL.LocaleId,
									 NULL OldSEOURL, 
									 NULL CMSContentPagesId,CD.PortalId, CD.seoCode,CDL.CanonicalURL,CDL.RobotTag
									 from ZnodeCMSSEODetail CD 
									 INNER JOIN ZnodeCMSSEOType CT ON CD.CMSSEOTypeId = CT.CMSSEOTypeId 
									 INNER JOIN ZnodeCMSSEODetailLocale CDL ON CD.CMSSEODetailId = CDL.CMSSEODetailId 
									 WHERE (CDL.LocaleId = @SetLocaleId OR CDL.LocaleId = @DefaultLocaleId)  
									 AND (CD.PortalId = @PortalId  OR @PortalId  = 0 ) 
									 AND (Isnull(CD.SEOCode ,'') = @CMSSEOCode OR @CMSSEOCode = '' )
									 AND (Exists  (SELECT TOP 1 1 FROM dbo.Split(@CMSSEOTypeId ,',') SP WHERE SP.Item = CD.CMSSEOTypeId ) )
									union all
									select CT.Name ItemName,CD.CMSSEODetailId, CDL.CMSSEODetailLocaleId ,  CD.CMSSEOTypeId ,
										 CD.SEOId ,CDL.SEOTitle,CDL.SEODescription,
										 CDL.SEOKeywords,Lower(CD.SEOUrl) SEOUrl,CD.IsRedirect,CD.MetaInformation,
										 CDL.LocaleId,
										 NULL OldSEOURL, 
										 NULL CMSContentPagesId,ZPB.PortalId, CD.seoCode,CDL.CanonicalURL,CDL.RobotTag
										 from ZnodeCMSSEODetail CD 
										 INNER JOIN ZnodeCMSSEOType CT ON CD.CMSSEOTypeId = CT.CMSSEOTypeId 
										 INNER JOIN ZnodeCMSSEODetailLocale CDL ON CD.CMSSEODetailId = CDL.CMSSEODetailId
										 INNER JOIN ZnodeBrandDetails ZBD ON CD.SeoCode = ZBD.BrandCode
										 INNER JOIN ZnodePortalBrand ZPB ON ZBD.BrandId = ZPB.BrandId
										 WHERE (CDL.LocaleId = @SetLocaleId OR CDL.LocaleId = @DefaultLocaleId)  
										 AND (ZPB.PortalId = @PortalId  OR @PortalId  = 0 ) 
										 AND (Isnull(CD.SEOCode ,'') = @CMSSEOCode OR @CMSSEOCode = '' )
										 AND (Exists  (SELECT TOP 1 1 FROM dbo.Split(@CMSSEOTypeId ,',') SP WHERE SP.Item = CD.CMSSEOTypeId ) )
										 AND CT.Name = 'Brand' 
										 AND @IsCatalogPublish = 0
									 Union All 
									 select CT.Name ItemName,CD.CMSSEODetailId, CDL.CMSSEODetailLocaleId ,  CD.CMSSEOTypeId ,
								 CD.SEOId ,CDL.SEOTitle,CDL.SEODescription,
								 CDL.SEOKeywords,Lower(CD.SEOUrl) SEOUrl,CD.IsRedirect,CD.MetaInformation,
								 CDL.LocaleId,
								 NULL OldSEOURL, 
								 NULL CMSContentPagesId,ZPB.PortalId, CD.seoCode,CDL.CanonicalURL,CDL.RobotTag
								 from ZnodeCMSSEODetail CD 
								 INNER JOIN ZnodeCMSSEOType CT ON CD.CMSSEOTypeId = CT.CMSSEOTypeId 
								 INNER JOIN ZnodeCMSSEODetailLocale CDL ON CD.CMSSEODetailId = CDL.CMSSEODetailId 
								 INNER JOIN ZnodeBrandDetails ZBD ON CD.SeoCode = ZBD.BrandCode
								 INNER JOIN ZnodePortalBrand ZPB ON ZBD.BrandId = ZPB.BrandId
								 WHERE (CDL.LocaleId = @SetLocaleId OR CDL.LocaleId = @DefaultLocaleId)  
								 AND (Isnull(CD.SEOCode ,'') = @CMSSEOCode OR @CMSSEOCode = '' )
								 AND (CT.Name = 'Brand' ) 
								 AND @IsCatalogPublish= 1 
					)
					, Cte_GetFirstCMSSEODetails  AS
					(
						SELECT 
							ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
							SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation, LocaleId ,OldSEOURL,CMSContentPagesId,
							PortalId,SEOCode,CanonicalURL,RobotTag	
						FROM Cte_GetCMSSEODetails 
						WHERE LocaleId = @SetLocaleId
					)
					, Cte_GetDefaultFilterData AS
					(
						SELECT 
							ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
							SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,
							PortalId,SEOCode,CanonicalURL,RobotTag	  FROM  Cte_GetFirstCMSSEODetails 
						UNION ALL 
						SELECT 
							ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
							SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,
							PortalId,SEOCode,CanonicalURL,RobotTag	 FROM Cte_GetCMSSEODetails CTEC 
						WHERE LocaleId = @DefaultLocaleId 
						AND NOT EXISTS (SELECT TOP 1 1 FROM Cte_GetFirstCMSSEODetails CTEFD WHERE CTEFD.CMSSEOTypeId = CTEC.CMSSEOTypeId 
						and CTEFD.seoCode = CTEC.seoCode )
					)
	
					INSERT INTO #TBL_SEO (ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
					SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,
					PortalId,SEOCode,CanonicalURL,RobotTag)
					SELECT 
						ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
						SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,@SetLocaleId,OldSEOURL,CMSContentPagesId,
						PortalId,SEOCode,CanonicalURL,RobotTag	
					FROM Cte_GetDefaultFilterData  A 

					End 
					Else If @IsSingleProductPublish = 1  
						INSERT INTO #TBL_SEO (ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
						SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,
						PortalId,SEOCode,CanonicalURL,RobotTag)
							SELECT CT.Name ItemName,CD.CMSSEODetailId, CDL.CMSSEODetailLocaleId ,  CD.CMSSEOTypeId ,
							CD.SEOId ,CDL.SEOTitle,CDL.SEODescription,
							CDL.SEOKeywords,Lower(CD.SEOUrl) SEOUrl,CD.IsRedirect,CD.MetaInformation,
							CDL.LocaleId,
							NULL OldSEOURL, 
							NULL CMSContentPagesId,CD.PortalId, CD.seoCode,CDL.CanonicalURL,CDL.RobotTag
							from ZnodeCMSSEODetail CD 
							INNER JOIN ZnodeCMSSEOType CT ON CD.CMSSEOTypeId = CT.CMSSEOTypeId 
							INNER JOIN ZnodeCMSSEODetailLocale CDL ON CD.CMSSEODetailId = CDL.CMSSEODetailId 
							WHERE (CDL.LocaleId = @LocaleId )  
							AND (CD.PortalId = @PortalId  ) 
							AND (Isnull(CD.SEOCode ,'') = @CMSSEOCode OR @CMSSEOCode = '' )
							AND (Exists  (SELECT TOP 1 1 FROM dbo.Split(@CMSSEOTypeId ,',') SP WHERE SP.Item = CD.CMSSEOTypeId ) )

				SET @IncrementalId = @IncrementalId +1 
			END 
		End 
		End			

	If @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%' OR  @RevisionState like '%Production%')  AND @IsSingleProductPublish = 0
	Begin
	    --Data inserted into flat table ZnodePublishSeoEntity (Replica of MongoDB Collection )  
		Delete from ZnodePublishSeoEntity where PortalId = @PortalId  and VersionId  in (Select PreviewVersionId  from @TBL_PreviewVersionId ) 
		AND (SEOCode = @CMSSEOCode OR @CMSSEOCode = '' )
		AND (Exists  (SELECT TOP 1 1 FROM dbo.Split(@CMSSEOTypeId ,',') SP WHERE SP.Item = CMSSEOTypeId ) )
		AND @IsCatalogPublish= 0   

		If @IsCatalogPublish= 0
		BEGIN
			UPDATE C SET C.ElasticSearchEvent = 2 
			FROM ZnodePublishSeoEntity C
			WHERE NOT EXISTS(SELECT * FROM #TBL_SEO A
				Inner join @TBL_PreviewVersionId B on A.LocaleId = B.LocaleId AND A.LocaleId = B.LocaleId
				WHERE B.PreviewVersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId 
							AND A.PortalId = C.PortalId AND A.SEOCode = C.SEOCode)

			UPDATE C SET C.ItemName = A.ItemName ,
				C.SEOTypeName = A.SEOTypeName,C.SEOTitle = A.SEOTitle,C.SEODescription = A.SEODescription,C.SEOKeywords=A.SEOKeywords,C.SEOUrl = A.SEOUrl,
				C.IsRedirect=A.IsRedirect,C.MetaInformation = A.MetaInformation,C.OldSEOURL = A.OldSEOURL,
				C.CanonicalURL = A.CanonicalURL,C.RobotTag = A.RobotTag, C.ElasticSearchEvent = 1
			FROM #TBL_SEO A 
			Inner join @TBL_PreviewVersionId B on A.LocaleId = B.LocaleId AND A.LocaleId = B.LocaleId 
			INNER JOIN ZnodePublishSeoEntity C ON B.PreviewVersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId 
						AND A.PortalId = C.PortalId AND A.SEOCode = C.SEOCode

			Insert Into ZnodePublishSeoEntity 
			(
				VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
				SEOTypeName,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL
				,CMSContentPagesId,	PortalId,SEOCode,CanonicalURL,RobotTag, ElasticSearchEvent
			)
			SELECT B.PreviewVersionId , Getdate(), ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
				ItemName,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,A.LocaleId,OldSEOURL,Isnull(CMSContentPagesId,0),
				A.PortalId,SEOCode,CanonicalURL,RobotTag, 1 AS ElasticSearchEvent
			FROM #TBL_SEO A Inner join @TBL_PreviewVersionId B on A.LocaleId = B.LocaleId AND A.LocaleId = B.LocaleId
			WHERE NOT EXISTS(SELECT * FROM ZnodePublishSeoEntity C WHERE B.PreviewVersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId AND A.PortalId = C.PortalId)

		END

		If @IsCatalogPublish= 1
		BEGIN
			UPDATE C SET C.ElasticSearchEvent = 2 
			FROM ZnodePublishSeoEntity C
			WHERE NOT EXISTS(SELECT * FROM #TBL_SEO A
				Inner join #VesionIds B on A.LocaleId = B.LocaleId AND B.RevisionType = 'PREVIEW'
				WHERE B.VersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId 
							AND A.PortalId = C.PortalId AND A.SEOCode = C.SEOCode)

			UPDATE C SET C.ItemName = A.ItemName ,
				C.SEOTypeName = A.SEOTypeName, C.SEOTitle = A.SEOTitle,C.SEODescription = A.SEODescription,C.SEOKeywords=A.SEOKeywords,C.SEOUrl = A.SEOUrl,
				C.IsRedirect=A.IsRedirect,C.MetaInformation = A.MetaInformation,C.OldSEOURL = A.OldSEOURL,
				C.CanonicalURL = A.CanonicalURL,C.RobotTag = A.RobotTag, C.ElasticSearchEvent = 1
			FROM #TBL_SEO A 
			Inner join #VesionIds B on A.LocaleId = B.LocaleId AND B.RevisionType = 'PREVIEW' 
			INNER JOIN ZnodePublishSeoEntity C ON B.VersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId 
						AND A.PortalId = C.PortalId AND A.SEOCode = C.SEOCode

			Insert Into ZnodePublishSeoEntity 
			(
				VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
				SEOTypeName,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL
				,CMSContentPagesId,	PortalId,SEOCode,CanonicalURL,RobotTag, ElasticSearchEvent	
			)
			SELECT B.VersionId , Getdate(), ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
				ItemName,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,A.LocaleId,OldSEOURL,Isnull(CMSContentPagesId,0),
				A.PortalId,SEOCode,CanonicalURL,RobotTag, 1 AS ElasticSearchEvent
			FROM #TBL_SEO A Inner join #VesionIds B on A.LocaleId = B.LocaleId AND B.RevisionType = 'PREVIEW'
			WHERE NOT EXISTS(SELECT * FROM ZnodePublishSeoEntity C WHERE B.VersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId AND A.PortalId = C.PortalId)

		END
	End

	-------------------------- End Preview 
	If (@RevisionState like '%Production%' OR @RevisionState = 'None') and @IsSingleProductPublish = 0
	Begin
		-- Only production version id will process 
		Delete from ZnodePublishSeoEntity where PortalId = @PortalId  and VersionId in (Select ProductionVersionId from  @TBL_ProductionVersionId ) 
		AND (SEOCode = @CMSSEOCode OR @CMSSEOCode = '' )
		AND (Exists  (SELECT TOP 1 1 FROM dbo.Split(@CMSSEOTypeId ,',') SP WHERE SP.Item = CMSSEOTypeId ) )
		AND @IsCatalogPublish= 0   

		If @IsCatalogPublish= 0 		
		BEGIN
			UPDATE C SET C.ElasticSearchEvent = 2 
			FROM ZnodePublishSeoEntity C
			WHERE NOT EXISTS(SELECT * FROM #TBL_SEO A
				INNER JOIN @TBL_ProductionVersionId B on A.PortalId = B.PortalId and A.LocaleId = B.LocaleId 
				WHERE B.ProductionVersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId 
							AND A.PortalId = C.PortalId AND A.SEOCode = C.SEOCode)

			UPDATE C SET ItemName = A.ItemName ,
				SEOTypeName = A.SEOTypeName,SEOTitle = A.SEOTitle,SEODescription = A.SEODescription,SEOKeywords=A.SEOKeywords,SEOUrl = A.SEOUrl,
				IsRedirect=A.IsRedirect,MetaInformation = A.MetaInformation,OldSEOURL = A.OldSEOURL,
				CanonicalURL = A.CanonicalURL,RobotTag = A.RobotTag, C.ElasticSearchEvent = 1
			FROM #TBL_SEO A 
			INNER JOIN @TBL_ProductionVersionId B on A.PortalId = B.PortalId and A.LocaleId = B.LocaleId 
			INNER JOIN ZnodePublishSeoEntity C ON B.ProductionVersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId 
						AND A.PortalId = C.PortalId AND A.SEOCode = C.SEOCode

			Insert Into ZnodePublishSeoEntity 
			(
				VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
				SEOTypeName,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL
				,CMSContentPagesId,	PortalId,SEOCode,CanonicalURL,RobotTag, ElasticSearchEvent
			)
			SELECT B.ProductionVersionId , Getdate(), ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
				ItemName,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,A.LocaleId,OldSEOURL,Isnull(CMSContentPagesId,0),
				A.PortalId,SEOCode,CanonicalURL,RobotTag, 1 AS ElasticSearchEvent
			FROM #TBL_SEO A Inner join @TBL_ProductionVersionId B on A.PortalId = B.PortalId and A.LocaleId = B.LocaleId
			WHERE NOT EXISTS(SELECT * FROM ZnodePublishSeoEntity C WHERE B.ProductionVersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId AND A.PortalId = C.PortalId)
		END
	   If @IsCatalogPublish= 1 		
	   BEGIN
			UPDATE C SET C.ElasticSearchEvent = 2 FROM ZnodePublishSeoEntity C
			WHERE NOT EXISTS(SELECT * FROM #TBL_SEO A
				INNER JOIN @TBL_ProductionVersionId B on A.PortalId = B.PortalId and A.LocaleId = B.LocaleId 
				WHERE B.ProductionVersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId 
							AND A.PortalId = C.PortalId AND A.SEOCode = C.SEOCode)

			UPDATE C SET C.ItemName = A.ItemName ,
				C.SEOTypeName = A.SEOTypeName,C.SEOTitle = A.SEOTitle,C.SEODescription = A.SEODescription,C.SEOKeywords=A.SEOKeywords,C.SEOUrl = A.SEOUrl,
				C.IsRedirect = A.IsRedirect,C.MetaInformation = A.MetaInformation, C.OldSEOURL = A.OldSEOURL,
				C.CanonicalURL = A.CanonicalURL, C.RobotTag = A.RobotTag, C.ElasticSearchEvent = 1
			FROM #TBL_SEO A 
			INNER JOIN #VesionIds B on A.LocaleId = B.LocaleId AND B.RevisionType = 'PRODUCTION'
			INNER JOIN ZnodePublishSeoEntity C ON B.VersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId 
						AND A.PortalId = C.PortalId AND A.SEOCode = C.SEOCode

			Insert Into ZnodePublishSeoEntity 
			(
				VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
				SEOTypeName,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL
				,CMSContentPagesId,	PortalId,SEOCode,CanonicalURL,RobotTag	,ElasticSearchEvent
			)
			SELECT B.VersionId , Getdate(), ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
				ItemName,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,A.LocaleId,OldSEOURL,Isnull(CMSContentPagesId,0),
				A.PortalId,SEOCode,CanonicalURL,RobotTag, 1 AS ElasticSearchEvent
			FROM #TBL_SEO A Inner join #VesionIds B on A.LocaleId = B.LocaleId AND B.RevisionType = 'PRODUCTION'
			WHERE NOT EXISTS(SELECT * FROM ZnodePublishSeoEntity C WHERE B.VersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId AND A.PortalId = C.PortalId)
		END
	
	End

	--Single Product Publish 
	If @IsSingleProductPublish =1  
	Begin
			Delete from ZnodePublishSeoEntity where PortalId = @PortalId  and VersionId in (Select Item from Split(@VersionIdString,',')) 
			AND (SEOCode = @CMSSEOCode OR @CMSSEOCode = '' )
			AND (Exists  (SELECT TOP 1 1 FROM dbo.Split(@CMSSEOTypeId ,',') SP WHERE SP.Item = CMSSEOTypeId ) )

			UPDATE C SET ItemName = A.ItemName ,
				SEOTypeName = A.SEOTypeName,SEOTitle = A.SEOTitle,SEODescription = A.SEODescription,SEOKeywords=A.SEOKeywords,SEOUrl = A.SEOUrl,
				IsRedirect=A.IsRedirect,MetaInformation = A.MetaInformation,OldSEOURL = A.OldSEOURL,
				CanonicalURL = A.CanonicalURL,RobotTag = A.RobotTag
			FROM #TBL_SEO A 
			INNER JOIN ZnodePublishSeoEntity C ON A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId 
						AND A.PortalId = C.PortalId AND A.SEOCode = C.SEOCode
		
			Insert Into ZnodePublishSeoEntity 
			(
				VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
				SEOTypeName,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL
				,CMSContentPagesId,	PortalId,SEOCode,CanonicalURL,RobotTag	
			)
			SELECT (Select Item from Split(@VersionIdString,',')), Getdate(), ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
				ItemName,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,@LocaleId,OldSEOURL,Isnull(CMSContentPagesId,0),
				A.PortalId,SEOCode,CanonicalURL,RobotTag
			FROM #TBL_SEO A 
			WHERE NOT EXISTS(SELECT * FROM ZnodePublishSeoEntity C WHERE A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId AND A.PortalId = C.PortalId)
		
	end 

	If (@RevisionState = 'Preview'  )
		Update B SET PublishStateId = (select dbo.Fn_GetPublishStateIdForPreview()) , ISPublish = 1 
		from #TBL_SEO  A inner join ZnodeCMSSEODetail B  ON A.CMSSEODetailId  = B.CMSSEODetailId
	else If (@RevisionState = 'Production'  Or @RevisionState = 'None' )
		Update B SET PublishStateId = (select dbo.Fn_GetPublishStateIdForPublish()) , ISPublish = 1 
		from #TBL_SEO  A inner join ZnodeCMSSEODetail B  ON A.CMSSEODetailId  = B.CMSSEODetailId

	SET @Status =1 
END TRY 
BEGIN CATCH 
	SET @Status =0  
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
	@ErrorCall NVARCHAR(MAX)= 'EXEC ZnodeSetPublishSEOEntity 
	@PortalId = '+CAST(@PortalId AS VARCHAR	(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))
	+',@PreviewVersionId = ' + CAST(@PreviewVersionId  AS varchar(20))
	+',@ProductionVersionId = ' + CAST(@ProductionVersionId  AS varchar(20))
	+',@RevisionState = ''' + CAST(@RevisionState  AS varchar(50))
	+''',@CMSSEOTypeId= ' + CAST(@CMSSEOTypeId  AS varchar(20))
	+',@UserId = ' + CAST(@UserId AS varchar(20))
	+',@CMSSEOCode  = ''' + CAST(@CMSSEOCode  AS varchar(20)) + '''';
	        			 
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'ZnodeSetPublishSEOEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;

END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportAddonAssociation')
	DROP PROC Znode_ImportAddonAssociation
GO

CREATE PROCEDURE [dbo].[Znode_ImportAddonAssociation](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();

		IF OBJECT_ID('TEMPDB..#InsertProductAddonAssociation') IS NOT NULL
			DROP TABLE #InsertProductAddonAssociation

		IF OBJECT_ID('TEMPDB..#SKU') IS NOT NULL
			DROP TABLE #SKU

		IF OBJECT_ID('TEMPDB..#InsertZnodePimAddOnProduct') IS NOT NULL
			DROP TABLE #InsertZnodePimAddOnProduct

		CREATE TABLE #InsertZnodePimAddOnProduct ( PimAddOnProductId int,PimAddonGroupId int,PimProductId int)

		CREATE TABLE #InsertProductAddonAssociation
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, SKU varchar(300),AddonGroupName varchar(300),AddOnSKU varchar(300),DisplayOrder int, IsDefault varchar(10), GUID nvarchar(400)
		
		);

		CREATE TABLE #SKU 
		( 
			SKU nvarchar(300), PimProductId int
		);

		----Get All SKU Data From DB
		INSERT INTO #SKU (SKU, PimProductId)
		SELECT ZPAVL.AttributeValue, ZPAV.PimProductId
		FROM ZnodePimAttributeValue AS ZPAV
		INNER JOIN ZnodePimAttributeValueLocale AS ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		INNER JOIN ZnodePimAttribute ZPA ON ZPAV.PimAttributeId = ZPA.PimAttributeId
		WHERE ZPA.AttributeCode = 'SKU';

		SET @SSQL = 'Select RowNumber,SKU,AddonGroupName,AddOnSKU,DisplayOrder,IsDefault,GUID FROM '+@TableName;
		INSERT INTO #InsertProductAddonAssociation( RowNumber,SKU,AddonGroupName,AddOnSKU,DisplayOrder,IsDefault,GUID )
		EXEC sys.sp_sqlexec @SSQL;

		SELECT SKU,AddonGroupName,AddOnSKU 
		INTO #DuplicateProductAddonAssociation 
		FROM #InsertProductAddonAssociation 
		Group BY SKU,AddonGroupName,AddOnSKU  having count(*) > 1

		----Checking AddonGroupName present in DB
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '99', 'AddonGroupName', AddonGroupName, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM #InsertProductAddonAssociation AS ii
		WHERE NOT EXISTS ( SELECT * FROM ZnodePimAddonGroupLocale i where i.AddonGroupName = ii.AddonGroupName );

		----Checking SKU present in DB
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '98', 'SKU', SKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM #InsertProductAddonAssociation AS ii
		WHERE NOT EXISTS( SELECT * FROM #SKU SKU WHERE ii.SKU = SKU.SKU)

		----Checking AddOnSKU present in DB
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '98', 'AddOnSKU', AddOnSKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM #InsertProductAddonAssociation AS ii
		WHERE NOT EXISTS( SELECT * FROM #SKU SKU WHERE ii.AddOnSKU = SKU.SKU)
		
		----Duplicate Record (SKU \ AddOnSKU \ AddonGroupName)
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '53', 'SKU \ AddOnSKU \ AddonGroupName ', SKU+' \ '+AddOnSKU+' \ '+AddonGroupName, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM #InsertProductAddonAssociation AS ii
		WHERE EXISTS ( select * FROM #DuplicateProductAddonAssociation i WHERE i.SKU = ii.SKU and i.AddOnSKU = ii.AddOnSKU and i.AddonGroupName = ii.AddonGroupName );

		----Checking is default value data validation
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'IsDefault', IsDefault, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertProductAddonAssociation AS ii  
		WHERE ISNULL(ii.IsDefault,0) not in ('True','1','Yes','FALSE','0','No','')
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '115', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM #InsertProductAddonAssociation AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL ) AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '64', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM #InsertProductAddonAssociation AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 999

		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ SKU - ' + isnull(SKU,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN #InsertProductAddonAssociation IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		-- Delete Invalid Data after functional validatin  
		DELETE FROM #InsertProductAddonAssociation
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertProductAddonAssociation
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount
		,	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))  
		WHERE ImportProcessLogId = @ImportProcessLogId;


		UPDATE PAPD
		SET PAPD.ModifiedBy =@UserId  ,PAPD.ModifiedDate = GETDATE(),
		PAPD.IsDefault = case when IPAA.IsDefault in ('True','1','Yes') then 1 else 0 end,
		PAPD.DisplayOrder = CASE WHEN IPAA.DisplayOrder IS NOT NULL THEN IPAA.DisplayOrder ELSE PAPD.DisplayOrder END
		FROM #InsertProductAddonAssociation IPAA
		INNER JOIN #SKU SKU ON SKU.SKU = IPAA.SKU
		INNER JOIN #SKU SKU1 ON SKU1.SKU = IPAA.AddOnSKU
		INNER JOIN ZnodePimAddonGroupLocale ZPAGL on ZPAGL.AddonGroupName = IPAA.AddonGroupName
		INNER JOIN ZnodePimAddOnProduct PAP ON (PAP.PimProductId = SKU.PimProductId AND PAP.PimAddonGroupId = ZPAGL.PimAddonGroupId)
		INNER JOIN ZnodePimAddOnProductDetail PAPD ON (PAPD.PimAddOnProductId =PAP.PimAddOnProductId AND SKU1.PimProductId = PAPD.PimChildProductId )

		-----Inserting records in ZnodePimAddOnProduct
		INSERT INTO ZnodePimAddOnProduct(PimAddonGroupId,PimProductId,DisplayOrder,RequiredType,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		OUTPUT inserted.PimAddOnProductId, inserted.PimAddonGroupId,inserted.PimProductId into #InsertZnodePimAddOnProduct (PimAddOnProductId,PimAddonGroupId,PimProductId)
		SELECT DISTINCT ZPAGL.PimAddonGroupId,SKU.PimProductId, 999 as DisplayOrder,
		'Required' RequiredType,@UserId as CreatedBy,@GetDate,@UserId as ModifiedBy,@GetDate
		FROM #InsertProductAddonAssociation IPAA
		INNER JOIN #SKU SKU ON SKU.SKU = IPAA.SKU
		INNER JOIN ZnodePimAddonGroupLocale ZPAGL on ZPAGL.AddonGroupName = IPAA.AddonGroupName
		WHERE NOT EXISTS(SELECT * FROM ZnodePimAddOnProduct ZPAP where ZPAP.PimAddonGroupId = ZPAGL.PimAddonGroupId and ZPAP.PimProductId = SKU.PimProductId )

		-----Inserting records in ZnodePimAddOnProductDetail
		INSERT INTO ZnodePimAddOnProductDetail(PimAddOnProductId,PimChildProductId,IsDefault,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT DISTINCT ZPAP.PimAddOnProductId, SKU.PimProductId as PimChildProductId, CASE WHEN isnull(IPAA.IsDefault,0) IN ('True','1','Yes') THEN 1 ELSE 0 END, ISNULL(IPAA.DisplayOrder,999),@UserId ,@GetDate,@UserId,@GetDate 
		FROM #InsertProductAddonAssociation IPAA
		INNER JOIN #SKU SKU1 ON SKU1.SKU = IPAA.SKU
		INNER JOIN #SKU SKU ON SKU.SKU = IPAA.AddOnSKU
		INNER JOIN ZnodePimAddonGroupLocale ZPAGL on IPAA.AddonGroupName = ZPAGL.AddonGroupName
		INNER JOIN ZnodePimAddOnProduct ZPAP on SKU1.PimProductId = ZPAP.PimProductId and ZPAP.PimAddonGroupId = ZPAGL.PimAddonGroupId
		WHERE NOT EXISTS(SELECT * FROM ZnodePimAddOnProductDetail ZPAPD WHERE ZPAPD.PimAddOnProductId = ZPAP.PimAddOnProductId and ZPAPD.PimChildProductId = SKU.PimProductId )

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;

	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAddonAssociation @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportAddonAssociation',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		
	END CATCH;
END;

GO

Update znodemessage set MessageName='Input must be available as Department Name saved against the Account.'
where MessageName='Input should be available as Department Name with any existing Account.'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportHighlight')
	DROP PROC Znode_ImportHighlight
GO

CREATE PROCEDURE [dbo].[Znode_ImportHighlight](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		-- Retrive RoundOff Value from global setting 
		DECLARE @InsertPimAtrribute TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY,
			RowNumber int, HighlightCode varchar(300), HighlightName varchar(1000),DisplayPopup varchar(300),Hyperlink varchar(1000),HighlightType varchar(300),IsActive varchar(100),DisplayOrder int,HighlightImage varchar(500),HighlightImagePath varchar(500), Description varchar(max), ShortDescription varchar(max), ImageAltTag varchar(400), GUID nvarchar(400)
		
		);
		DECLARE @InsertedPimAttributeIds TABLE (PimAttributeId int ,PimAttributeDefaultValueId int,AttributeDefaultValueCode nvarchar(300))
		
		SET @SSQL = 'Select RowNumber,HighlightCode, HighlightName,DisplayPopup,Hyperlink,HighlightType,IsActive,DisplayOrder,HighlightImage,HighlightImagePath,Description,ShortDescription,ImageAltTag ,GUID FROM '+@TableName;
		INSERT INTO @InsertPimAtrribute( RowNumber,HighlightCode, HighlightName,DisplayPopup,Hyperlink,HighlightType,IsActive,DisplayOrder,HighlightImage,HighlightImagePath,Description,ShortDescription,ImageAltTag ,GUID)
		EXEC sys.sp_sqlexec @SSQL;


		--@MessageDisplay will use to display validate message for input inventory value  
		DECLARE @HighlightAttributeDefaultCode TABLE
		( 
		   AttributeDefaultCode nvarchar(300)
		);
		INSERT INTO @HighlightAttributeDefaultCode
			   SELECT AttributeDefaultValueCode
			   FROM ZnodePimAttributeDefaultValue ZPADV
			   inner join ZnodePimAttribute ZPA on ZPADV.PimAttributeId = ZPA.PimAttributeId
			   where ZPA.AttributeCode = 'Highlights' 

		-- Start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '118', 'HighlightCode', HighlightCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.HighlightCode not in 
			   (
				   SELECT AttributeDefaultCode FROM @HighlightAttributeDefaultCode 
			   );
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'DisplayPopup', DisplayPopup, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.DisplayPopup not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '103', 'HighlightType', HighlightType, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.HighlightType NOT in 
			   (
				   SELECT HT.Name  FROM ZnodeHighlightType  HT
			   );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '17', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL ) AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '64', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 999

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '102', 'HighlightCode', HighlightCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.HighlightCode,''))) like '% %' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '53', 'HighlightCode', HighlightCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.HighlightCode in 
			   (
				   select HighlightCode  FROM @InsertPimAtrribute  Group BY HighlightCode  having count(*) > 1 
			   );

		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ Highlight - ' + ISNULL(HighlightCode,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN @InsertPimAtrribute IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL


		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertPimAtrribute
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertPimAtrribute
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;
		

		DECLARE @MediaId INT
		SET @MediaId = (SELECT TOP 1 MediaId from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.HighlightImage = ZM.FileName and IPA.HighlightImagePath = ZM.Path)

		if (isnull(@MediaId,0)=0)
			SET @MediaId = (SELECT max(MediaId) from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.HighlightImage = ZM.FileName)

		DECLARE @InsertedZnodeHighlight TABLE(HighlightId INT,HighlightCode VARCHAR(600)) 

			UPDATE ZH SET ZH.DisplayPopup = IPA.DisplayPopup, ZH.Hyperlink = IPA.Hyperlink, ZH.IsActive = case when IPA.IsActive in ('True','1','Yes') then 1 else 0 end,
			       ZH.DisplayOrder = IPA.DisplayOrder , ZH.ModifiedBy = @UserId, ZH.ModifiedDate = @GetDate 
			FROM @InsertPimAtrribute IPA 
			INNER JOIN ZnodeHighlightType ZHT on IPA.HighlightType = ZHT.Name
			INNER JOIN ZnodeHighlight ZH ON IPA.HighlightCode = ZH.HighlightCode and ZHT.HighlightTypeId = ZH.HighlightTypeId

			UPDATE ZHL SET ZHL.Name = IPA.HighlightName, ZHL.Description = IPA.Description, ZHL.ShortDescription = IPA.ShortDescription, ZHL.ImageAltTag = IPA.ImageAltTag
			       , ZHL.ModifiedBy = @UserId, ZHL.ModifiedDate = @GetDate 
			FROM @InsertPimAtrribute IPA 
			INNER JOIN ZnodeHighlightType ZHT on IPA.HighlightType = ZHT.Name
			INNER JOIN ZnodeHighlight ZH ON IPA.HighlightCode = ZH.HighlightCode and ZHT.HighlightTypeId = ZH.HighlightTypeId
			INNER JOIN ZnodeHighlightLocale ZHL  ON ZH.HighlightId = ZHL.HighlightId 

			INSERT INTO ZnodeHighlight (MediaId,HighlightCode,DisplayPopup,Hyperlink,HighlightTypeId,IsActive,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			OUTPUT Inserted.HighlightId,Inserted.HighlightCode INTO @InsertedZnodeHighlight
			SELECT DISTINCT @MediaId,IPA.HighlightCode, IPA.DisplayPopup , IPA.Hyperlink, ZHT.HighlightTypeId,
				   case when IPA.IsActive in ('True','1','Yes') then 1 else 0 end, Case when Isnull(IPA.DisplayOrder,0) = 0 then  999 else IPA.DisplayOrder end  , @UserId , @GetDate ,@UserId , @GetDate 
			FROM @InsertPimAtrribute IPA 
			INNER JOIN ZnodeHighlightType ZHT on IPA.HighlightType = ZHT.Name
			WHERE NOT EXISTS(select * from ZnodeHighlight ZH where ZH.HighlightCode = IPA.HighlightCode and ZH.HighlightTypeId = ZHT.HighlightTypeId)

			INSERT INTO ZnodeHighlightLocale(LocaleId,HighlightId,ImageAltTag,Name,Description,ShortDescription,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT DISTINCT @LocaleId, IZH.HighlightId, IPA.ImageAltTag, IPA.HighlightName, IPA.Description, IPA.ShortDescription, @UserId , @GetDate ,@UserId , @GetDate
			FROM @InsertPimAtrribute IPA 
			INNER JOIN @InsertedZnodeHighlight IZH on IPA.HighlightCode = IZH.HighlightCode 


		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportHighlight @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportHighlight',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		
		
	END CATCH;
END;

GO

Insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 118,'Text','Input must be available as a Value Code saved against Highlights Attribute that has not been used to create any other Highlight.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 118) 

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportAttributeDefaultValue')
	DROP PROC Znode_ImportAttributeDefaultValue
GO

CREATE PROCEDURE [dbo].[Znode_ImportAttributeDefaultValue](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200))
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		-- Retrive RoundOff Value from global setting 
		DECLARE @InsertPimAtrribute TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY,
			-- RowNumber int, AttributeName varchar(300), AttributeCode varchar(300), AttributeType varchar(300), DisplayOrder int, GUID nvarchar(400)
			RowNumber int, AttributeCode varchar(300),AttributeDefaultValueCode varchar(300),AttributeDefaultValue varchar(1000),IsEditable varchar(10),DisplayOrder int, IsDefault varchar(10), SwatchText varchar(1000),SwatchImage varchar(500), SwatchImagePath varchar(500), GUID nvarchar(400)
		
		);
		DECLARE @InsertedPimAttributeIds TABLE (PimAttributeId int ,PimAttributeDefaultValueId int,AttributeDefaultValueCode nvarchar(300))
		
		SET @SSQL = 'Select RowNumber,AttributeCode,AttributeDefaultValueCode,AttributeDefaultValue,IsEditable,DisplayOrder,IsDefault,SwatchText,SwatchImage, SwatchImagePath ,GUID FROM '+@TableName;
		INSERT INTO @InsertPimAtrribute( RowNumber,AttributeCode,AttributeDefaultValueCode,AttributeDefaultValue,IsEditable,DisplayOrder,IsDefault,SwatchText,SwatchImage, SwatchImagePath ,GUID)
		EXEC sys.sp_sqlexec @SSQL;

		--@MessageDisplay will use to display validate message for input inventory value  
		DECLARE @AttributeCode TABLE
		( 
		   AttributeCode nvarchar(300)
		);
		INSERT INTO @AttributeCode
			   SELECT AttributeCode
			   FROM ZnodePimAttribute 

		-- Start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '117', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.AttributeCode not in 
			   (
				   SELECT AttributeCode FROM @AttributeCode
			   );

		WITH CTE_AttributeDefaultValueCode AS(
		SELECT AttributeDefaultValueCode , AttributeCode, RowNumber ,ROW_NUMBER ()OVER (PARTITION BY AttributeDefaultValueCode , AttributeCode ORDER BY AttributeDefaultValueCode , AttributeCode )  Row_Id
		FROM @InsertPimAtrribute Z
		
		
		)
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '53', 'AttributeDefaultValueCode', AttributeDefaultValueCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE EXISTS
			  ( SELECT TOP 1 1 FROM CTE_AttributeDefaultValueCode Z WHERE Z.RowNumber=ii.RowNumber AND Z.Row_Id >1
			   )
			  

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '102', 'AttributeDefaultValueCode', AttributeDefaultValueCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.AttributeDefaultValueCode,''))) like '%[^0-9A-Za-z]%'

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '102', 'AttributeDefaultValueCode', AttributeDefaultValueCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.AttributeDefaultValueCode,''))) like '% %' -----space not allowed

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsEditable', IsEditable, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.IsEditable not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsDefault', IsDefault, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.IsDefault not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '17', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL ) AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '64', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 99999

		UPDATE ZIL
			SET ZIL.ColumnName =   ZIL.ColumnName + ' [ AttributeDefaultValueCode - ' + ISNULL(AttributeDefaultValueCode,'') + ' ] '
			FROM ZnodeImportLog ZIL 
			INNER JOIN @InsertPimAtrribute IPA ON (ZIL.RowNumber = IPA.RowNumber)
			WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL


		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertPimAtrribute
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertPimAtrribute
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount
		,	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;

		DECLARE @MediaId INT
		SET @MediaId = (SELECT TOP 1 MediaId from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.SwatchImage = ZM.FileName and IPA.SwatchImagePath = ZM.Path)

		if (isnull(@MediaId,0)=0)
			SET @MediaId = (SELECT max(MediaId) from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.SwatchImage = ZM.FileName)

        update ZPADV set ZPADV.IsEditable = case when IPA.IsEditable in ('True','1','Yes') then 1 else 0 end,ZPADV.DisplayOrder = Case when Isnull(IPA.DisplayOrder,0) <> 0 then  IPA.DisplayOrder else ZPADV.DisplayOrder end ,
		                 ZPADV.IsDefault = case when IPA.IsDefault in ('True','1','Yes') then 1 else 0 end ,ZPADV.SwatchText = IPA.SwatchText ,
		                 ZPADV.MediaId = case when isnull(@MediaId,0)= 0 then ZPADV.MediaId else @MediaId end, ZPADV.ModifiedBy = @UserId, ZPADV.ModifiedDate = @GetDate 
		from @InsertPimAtrribute IPA 
		INNER JOIN ZnodePimAttribute ZPA ON IPA.AttributeCode = ZPA.AttributeCode 
		inner join ZnodePimAttributeDefaultValue ZPADV on ZPA.PimAttributeId = ZPADV.PimAttributeId and IPA.AttributeDefaultValueCode = ZPADV.AttributeDefaultValueCode

		update ZPADVL set ZPADVL.AttributeDefaultValue = IPA.AttributeDefaultValue, ZPADVL.ModifiedBy = @UserId, ZPADVL.ModifiedDate = @GetDate 
		from @InsertPimAtrribute IPA 
		INNER JOIN ZnodePimAttribute ZPA ON IPA.AttributeCode = ZPA.AttributeCode 
		inner join ZnodePimAttributeDefaultValue ZPADV on ZPA.PimAttributeId = ZPADV.PimAttributeId and IPA.AttributeDefaultValueCode = ZPADV.AttributeDefaultValueCode
		inner join ZnodePimAttributeDefaultValueLocale ZPADVL ON ( ZPADVL.PimAttributeDefaultValueId = ZPADV.PimAttributeDefaultValueId)

		--- Insert data into base table ZnodePimatrribute with their validation 

		INSERT INTO ZnodePimAttributeDefaultValue (PimAttributeId,AttributeDefaultValueCode,IsEditable,DisplayOrder,IsDefault,SwatchText,MediaId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)		
		OUTPUT Inserted.PimAttributeId,Inserted.PimAttributeDefaultValueId,Inserted.AttributeDefaultValueCode INTO @InsertedPimAttributeIds  		
		SELECT ZPA.PimAttributeId,IPA.AttributeDefaultValueCode, case when IPA.IsEditable in ('True','1','Yes') then 1 else 0 end , Case when Isnull(IPA.DisplayOrder,0) = 0 then  99999 else IPA.DisplayOrder end  , 
		       case when IPA.IsDefault in ('True','1','Yes') then 1 else 0 end , IPA.SwatchText, @MediaId,@UserId , @GetDate ,@UserId , @GetDate 
		from @InsertPimAtrribute IPA 
		INNER JOIN ZnodePimAttribute ZPA ON IPA.AttributeCode = ZPA.AttributeCode  
		where not exists(select * from ZnodePimAttributeDefaultValue ZPADV where ZPA.PimAttributeId = ZPADV.PimAttributeId and IPA.AttributeDefaultValueCode = ZPADV.AttributeDefaultValueCode)
		
		INSERT INTO ZnodePimAttributeDefaultValueLocale(LocaleId,PimAttributeDefaultValueId,AttributeDefaultValue,Description,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		Select @LocaleId ,IPAS.PimAttributeDefaultValueId, IPA.AttributeDefaultValue, '', @UserId , @GetDate ,@UserId , @GetDate   
		FROM @InsertedPimAttributeIds IPAS 
		INNER JOIN ZnodePimAttribute ZPA ON IPAS.PimAttributeId = ZPA.PimAttributeId  
		INNER JOIN @InsertPimAtrribute IPA ON ZPA.AttributeCode= IPA.AttributeCode and IPAS.AttributeDefaultValueCode = IPA.AttributeDefaultValueCode

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
	
		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAttributeDefaultValue @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200));

		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportAttributeDefaultValue',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		

	END CATCH;
END;

GO

Insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 117,'Text','Input must be available as a Code saved against any existing Attribute.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 117) 

GO

Update znodemessage set MessageName='Account Code must be included to import/update a Role Name.'
where MessageName= 'Include Account Code first to add a Role Name.'

GO

Update znodemessage set MessageName='Input value must not exceed the maximum character limit of 300.'
where MessageName= 'Input must not exceed the maximum character limit of 300.'

GO

Update znodemessage set MessageName='Input value must not exceed the maximum character limit of 200.'
where MessageName= 'Input must not exceed the maximum character limit of 200.'
GO
Insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 115,'Text','Input must be an integer value between 1 and 999.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 115) 

GO

Update znodemessage set MessageName='Input must be available as a Code saved against any existing Catalog.'
where MessageName= 'Input must be associated with any existing Catalog.'

GO

Update znodemessage set MessageName='Input value must be in alphanumeric format without spaces.'
where MessageName= 'Input must include a value in alphanumeric format.'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportAccount')
	DROP PROC Znode_ImportAccount
GO

CREATE PROCEDURE [dbo].[Znode_ImportAccount](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200),@PortalId int 
	  ,@CsvColumnString nvarchar(max) )
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import SEO Details
	
	-- Unit Testing : 
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max),@IsAllowGlobalLevelUserCreation nvarchar(10)

		DECLARE @GetDate datetime= dbo.Fn_GetDate();
	
		-- Three type of import required three table varible for product , category and brand
		
		select A.CountryCode,B.StateName,B.StateId,B.StateCode
        into #ZnodeCountryState
		from ZnodePortalCountry A
		inner JOin ZnodeState B on B.CountryCode=A.CountryCode
		Where B.CountryCode in ('US','CA')
		
		CREATE TABLE #InsertAccount 
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int,ParentAccountCode nvarchar(max),AccountName nvarchar(max), AccountCode nvarchar(max),ExternalID nvarchar(max),
			CatalogCode nvarchar(max),AddressName nvarchar(max),FirstName varchar(max),LastName varchar(max),CompanyName varchar(max),
			Address1 varchar(max),Address2 varchar(max),CountryName varchar(max),StateName varchar(max),CityName varchar(max),
			PostalCode varchar(max),PhoneNumber varchar(max),IsDefaultBilling varchar(10),IsDefaultShipping varchar(10),GUID VARCHAR(100)
		);
	
		SET @SSQL = ' INSERT INTO #InsertAccount ( RowNumber, ParentAccountCode,AccountName ,AccountCode,ExternalID,CatalogCode,AddressName,FirstName,LastName,CompanyName
						,Address1,Address2,CountryName,StateName,CityName,PostalCode,PhoneNumber,IsDefaultBilling,IsDefaultShipping,GUID )
		SELECT RowNumber, ParentAccountCode,AccountName ,AccountCode,ExternalID,CatalogCode,AddressName,FirstName,LastName,CompanyName
						,Address1,Address2,CountryName,StateName,CityName,PostalCode,PhoneNumber,IsDefaultBilling,IsDefaultShipping,GUID FROM '+ @TableName;

		EXEC sys.sp_sqlexec @SSQL;

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '78', 'ParentAccountCode', ParentAccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE len(ISnull(ii.AccountCode, '')) >100 and ISnull(ltrim(rtrim(ii.ParentAccountCode)), '') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '86', 'ParentAccountCode', ParentAccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.ParentAccountCode)), '') <> ''
		and not exists(select * from znodePortalAccount ZPA inner join ZnodeAccount ZA ON ZPA.AccountId = ZA.AccountId where ii.ParentAccountCode = ZA.AccountCode and ZPA.PortalId = @PortalId)
		and not exists(select * from #InsertAccount IA where ISnull(ltrim(rtrim(ii.ParentAccountCode)), '') = ISnull(ltrim(rtrim(IA.AccountCode)), '') and ii.RowNumber > IA.RowNumber)
	
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '87', 'ParentAccountCode', ParentAccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.ParentAccountCode)), '') <> ''
		and exists(select * from ZnodeAccount ZA where ii.ParentAccountCode = ZA.AccountCode and ZA.ParentAccountId is not null)
		--and not exists(select * from #InsertAccount IA where ISnull(ltrim(rtrim(ii.ParentAccountCode)), '') = ISnull(ltrim(rtrim(IA.AccountCode)), '') and ii.RowNumber > IA.RowNumber)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '89', 'ParentAccountCode', ParentAccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.ParentAccountCode)), '') <> ''
		and exists(select * from ZnodeAccount ZA where ii.AccountCode = ZA.AccountCode and ZA.ParentAccountId is not null)
		and exists(select * from ZnodeAccount ZA 
				inner join ZnodeAccount ZA1 on ZA.ParentAccountId = ZA1.accountId 
				 where ii.ParentAccountCode <> ZA1.AccountCode)
		and not exists(select * from #InsertAccount IA where ISnull(ltrim(rtrim(ii.ParentAccountCode)), '') = ISnull(ltrim(rtrim(IA.AccountCode)), '')
		and ii.RowNumber > IA.RowNumber )
		

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'AccountCode', AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.AccountCode)), '') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '78', 'AccountCode', AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE len(ISnull(ii.AccountCode, '')) >100 and ISnull(ltrim(rtrim(ii.AccountCode)), '') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '79', 'AccountCode', AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ii.AccountCode like '%[^a-zA-Z0-9]%' and ISnull(ltrim(rtrim(ii.AccountCode)), '') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'AccountName', AccountName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.AccountName)), '') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '78', 'AccountName', AccountName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE len(ISnull(ii.AccountName, '')) >100 and ISnull(ltrim(rtrim(ii.AccountName)), '') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '52', 'AccountName', AccountName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE isnull(replace(ii.AccountName,' ',''),'') like '%[^a-Z0-9]%' and ISnull(ltrim(rtrim(ii.AccountName)), '') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'StateName', StateName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.StateName)), '') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '78', 'StateName', StateName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE len(ISnull(ltrim(rtrim(ii.StateName)), '')) >100 and ISnull(ltrim(rtrim(ii.StateName)), '') <> ''

		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--SELECT '83', 'StateName', StateName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		--FROM #InsertAccount AS ii
		--WHERE not exists(select * from ZnodeState ZS where ZS.StateName = ISnull(ltrim(rtrim(ii.StateName)), '')) and ISnull(ltrim(rtrim(ii.StateName)), '') <> ''

		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '116', 'StateName', StateName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE not exists(select * from ZnodeState ZS where ZS.StateName = ISnull(ltrim(rtrim(ii.StateName)), '')
		and  exists (select * from #ZnodeCountryState Y where Y.CountryCode=zs.CountryCode and ii.StateName=y.StateName))
		and ISnull(ltrim(rtrim(ii.StateName)), '') <> '' and ii.CountryName in ('United States','Canada')

        INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '83', 'CountryName', CountryName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE not exists(select * from ZnodeCountry ZC where ZC.CountryName = ISnull(ltrim(rtrim(ii.CountryName)), '') ) AND ISnull(ltrim(rtrim(ii.CountryName)), '') <> ''
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'CountryName', CountryName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.CountryName)), '') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '90', 'CountryName', CountryName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.CountryName)), '') <> ''
		and not exists(select * from ZnodePortalCountry ZPC inner join ZnodeCountry ZC ON ZPC.CountryCode = ZC.CountryCode
		    where PortalId = @PortalId and ltrim(rtrim(ii.CountryName)) = ltrim(rtrim(ZC.CountryName)))

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'CityName', CityName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.CityName)), '') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '78', 'CityName', CityName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE len(ISnull(ltrim(rtrim(ii.CityName)), '')) >100 and ISnull(ltrim(rtrim(ii.CityName)), '') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'PostalCode', PostalCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.PostalCode)), '') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '78', 'PostalCode', PostalCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE len(ISnull(ltrim(rtrim(ii.PostalCode)), '')) >100 and ISnull(ltrim(rtrim(ii.PostalCode)), '') <> ''
				
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'PhoneNumber', PhoneNumber, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.PhoneNumber)), '') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '78', 'PhoneNumber', PhoneNumber, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE len(ISnull(ltrim(rtrim(ii.PhoneNumber)), '')) >100 and ISnull(ltrim(rtrim(ii.PhoneNumber)), '') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'IsDefaultBilling', IsDefaultBilling, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.IsDefaultBilling)), '') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'IsDefaultBilling', IsDefaultBilling, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertAccount AS ii  
		WHERE ISnull(ltrim(rtrim(ii.IsDefaultBilling)),'') not in ('True','1','FALSE','0') and ISnull(ltrim(rtrim(ii.IsDefaultBilling)), '') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '91', 'IsDefaultBilling', IsDefaultBilling, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertAccount AS ii  
		WHERE exists(select * from ZnodeAccount ZA where ii.AccountCode = ZA.AccountCode)  
		and ISnull(ltrim(rtrim(ii.IsDefaultBilling)), '') <> '' and ISnull(ltrim(rtrim(ii.IsDefaultBilling)),'') in ('FALSE','0')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'IsDefaultShipping', IsDefaultShipping, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.IsDefaultShipping)), '') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'IsDefaultShipping', IsDefaultShipping, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertAccount AS ii  
		WHERE ISnull(ltrim(rtrim(ii.IsDefaultShipping)),'') not in ('True','1','FALSE','0') and ISnull(ltrim(rtrim(ii.IsDefaultShipping)), '') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '91', 'IsDefaultShipping', IsDefaultShipping, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertAccount AS ii  
		WHERE exists(select * from ZnodeAccount ZA where ii.AccountCode = ZA.AccountCode)  
		and ISnull(ltrim(rtrim(ii.IsDefaultShipping)), '') <> '' and ISnull(ltrim(rtrim(ii.IsDefaultShipping)),'') in ('FALSE','0')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'AddressName', AddressName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.AddressName)), '') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '81', 'AddressName', AddressName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE len(ISnull(ii.AddressName, '')) >200 and ISnull(ltrim(rtrim(ii.AddressName)), '') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'Address1', Address1, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.Address1)), '') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '81', 'Address1', Address1, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE len(ISnull(ii.Address1, '')) >200 and ISnull(ltrim(rtrim(ii.Address1)), '') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '82', 'CompanyName', CompanyName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE len(ISnull(ii.CompanyName, '')) >300 and ISnull(ltrim(rtrim(ii.CompanyName)), '') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'LastName', LastName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.LastName)), '') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '82', 'LastName', LastName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE len(ISnull(ltrim(rtrim(ii.LastName)), '')) >300 and ISnull(ltrim(rtrim(ii.LastName)), '') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'FirstName', FirstName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.FirstName)), '') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '82', 'FirstName', FirstName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE len(ISnull(ii.FirstName, '')) >300 and ISnull(ltrim(rtrim(ii.FirstName)), '') <> ''
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '80', 'CatalogCode', CatalogCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE not exists(select * from ZnodePimCatalog ZS where ZS.CatalogCode = ISnull(ltrim(rtrim(ii.CatalogCode)), '') )
		and ISnull(ltrim(rtrim(ii.CatalogCode)), '') <> ''
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'CatalogCode', CatalogCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.CatalogCode)), '') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '82', 'ExternalID', ExternalID, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE len(ISnull(ii.ExternalID, '')) >300 and ISnull(ltrim(rtrim(ii.ExternalID)), '') <> ''


		-- -- error log when atleast db have 
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '85', 'IsDefaultBilling/IsDefaultShipping', IsDefaultBilling +'/'+ IsDefaultShipping, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount IC where not exists (
		SELECT TOP 1 1  from ZnodeAccount ZAA where IC.AccountCode = ZAA.AccountCode )
		and (IC.IsDefaultBilling not in ('1', 'true') or (IsDefaultShipping not in ('1', 'true')))  
		
		UPDATE ZIL
		SET ZIL.ColumnName =   ZIL.ColumnName + ' [ AccountCode - ' + ISNULL(AccountCode,'') + ' ] '
		FROM ZnodeImportLog ZIL 
		INNER JOIN #InsertAccount IPA ON (ZIL.RowNumber = IPA.RowNumber)
		WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		
		DELETE FROM #InsertAccount
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber IS NOT NULL 
		);

		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertAccount
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- End
		CREATE TABLE #InsertedAccount (AccountId int, Accountcode nvarchar(100)) 
		
		INSERT INTO ZnodeAccount(AccountCode,ParentAccountId,Name,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		OUTPUT INSERTED.AccountId, INSERTED.Accountcode INTO  #InsertedAccount (AccountId, Accountcode) 
		select IC.AccountCode, null as ParentAccountId, AccountName, IC.ExternalID, @UserId, @GetDate, @UserId, @GetDate
		from #InsertAccount IC
		where not exists(select * from ZnodeAccount ZA1 where ZA1.AccountCode = IC.AccountCode)
		and ISnull(ltrim(rtrim(IC.ParentAccountCode)), '') = '' 

		INSERT INTO ZnodePortalAccount(PortalId,AccountId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT @PortalId, IA.AccountId,  @UserId, @GetDate, @UserId, @GetDate
		FROM #InsertedAccount IA 
		WHERE not exists(select * from ZnodePortalAccount ZPA where IA.AccountId = ZPA.AccountId )

		----Import Child Account where Parent account details having in same CSV ****Start
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '86', 'ParentAccountCode', ParentAccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.ParentAccountCode)), '') <> ''
		and not exists(select * from znodePortalAccount ZPA inner join ZnodeAccount ZA ON ZPA.AccountId = ZA.AccountId where ii.ParentAccountCode = ZA.AccountCode and ZPA.PortalId = @PortalId)
		and not exists(select * from #InsertAccount IA where ISnull(ltrim(rtrim(ii.ParentAccountCode)), '') = ISnull(ltrim(rtrim(IA.AccountCode)), '') and ii.RowNumber > IA.RowNumber)
	
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '87', 'ParentAccountCode', ParentAccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.ParentAccountCode)), '') <> ''
		and exists(select * from ZnodeAccount ZA where ii.ParentAccountCode = ZA.AccountCode and ZA.ParentAccountId is not null)

		UPDATE ZIL
		SET ZIL.ColumnName =   ZIL.ColumnName + ' [ AccountCode - ' + ISNULL(AccountCode,'') + ' ] '
		FROM ZnodeImportLog ZIL 
		INNER JOIN #InsertAccount IPA ON (ZIL.RowNumber = IPA.RowNumber)
		WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		DELETE FROM #InsertAccount
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber IS NOT NULL 
		);

		INSERT INTO ZnodeAccount(AccountCode,ParentAccountId,Name,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		OUTPUT INSERTED.AccountId, INSERTED.Accountcode INTO  #InsertedAccount (AccountId, Accountcode) 
		select IC.AccountCode, za.AccountId as ParentAccountId, AccountName, IC.ExternalID, @UserId, @GetDate, @UserId, @GetDate
		from #InsertAccount IC
		left join ZnodeAccount za on IC.ParentAccountCode = za.AccountCode
		where not exists(select * from ZnodeAccount ZA1 where ZA1.AccountCode = IC.AccountCode)
		and ISnull(ltrim(rtrim(IC.ParentAccountCode)), '') <> ''

		INSERT INTO ZnodePortalAccount(PortalId,AccountId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT @PortalId, IA.AccountId,  @UserId, @GetDate, @UserId, @GetDate
		FROM #InsertedAccount IA 
		WHERE not exists(select * from ZnodePortalAccount ZPA where IA.AccountId = ZPA.AccountId )
		--------
		update ZA set ZA.ParentAccountId =  ZA1.AccountId
		from ZnodeAccount ZA
		inner join #InsertAccount IA ON ZA.AccountCode = IA.AccountCode
		inner join ZnodeAccount ZA1 ON ZA1.AccountCode = IA.ParentAccountCode 
		where exists(select * from #InsertedAccount IC where IA.AccountCode = IC.AccountCode)
		and ZA.ParentAccountId is null

		----updating AccountName for respective account
		update ZA set Name = IC.AccountName, AccountCode = IC.AccountCode
		OUTPUT INSERTED.AccountId, INSERTED.Accountcode INTO  #InsertedAccount (AccountId, Accountcode)
		from ZnodeAccount ZA
		inner join #InsertAccount IC ON ZA.AccountCode = IC.AccountCode

		----updating publishcatalogin to respective account
		update ZA set PublishCatalogId = ZPC1.PublishCatalogId, AccountCode = IC.AccountCode
		OUTPUT INSERTED.AccountId, INSERTED.Accountcode INTO  #InsertedAccount (AccountId, Accountcode) 
		from ZnodeAccount ZA
		inner join #InsertAccount IC ON ZA.AccountCode = IC.AccountCode
		inner join ZnodePimCatalog ZPC ON IC.CatalogCode = ZPC.CatalogCode
		inner join ZnodePublishCatalog ZPC1 ON ZPC.PimCatalogId = ZPC1.PimCatalogId
		where not exists(select * from ZnodePortalCatalog ZPCa where ZPCa.PublishCatalogId = ZPC1.PublishCatalogId and ZPCa.PortalId = @PortalId)

		----------update ZnodeAddress
		DECLARE @AddressColumnString VARCHAR(1000), @WhereConditionString VARCHAR(1000), @UpdateColumnString VARCHAR(1000)

		SELECT @AddressColumnString = COALESCE(@AddressColumnString + ',', '')+a.ColumnName --COALESCE(@CsvColumnString + ' and ', '') +'ZA.'+ColumnName+' =  IC.'+ColumnName
		FROM ZnodeImportUpdatableColumns a
		INNER JOIN INFORMATION_SCHEMA.COLUMNS b on a.ColumnName = b.COLUMN_NAME  
		INNER JOIN dbo.Split(@CsvColumnString,',')C on b.COLUMN_NAME = c.Item
		WHERE b.TABLE_NAME = 'ZnodeAddress' 
		AND EXISTS(SELECT * FROM ZnodeImportHead IH where a.ImportHeadId = IH.ImportHeadId and IH.Name= 'Account')

		SELECT @UpdateColumnString = COALESCE(@UpdateColumnString + ' , ', '') +'ZA.'+a.COLUMN_NAME+' =  IC.'+a.COLUMN_NAME  
		FROM INFORMATION_SCHEMA.COLUMNS a
		INNER JOIN dbo.Split(@CsvColumnString,',')b on a.COLUMN_NAME = b.Item
		WHERE NOT EXISTS (SELECT * FROM dbo.Split(@AddressColumnString,',') c WHERE a.COLUMN_NAME = c.Item )
		AND a.TABLE_NAME = 'ZnodeAddress'

		SELECT @WhereConditionString = COALESCE(@WhereConditionString + ' AND ', '') +'ZA.'+item+' =  IC.'+item from dbo.split(@AddressColumnString,',')
	
				
		CREATE TABLE #InsertedAccountAddress (AddressId  int, AccountCode varchar(100)) 

		SET @SSQL = '
			UPDATE ZA set ModifiedBy = '+CONVERT(VARCHAR(10), @UserId)+', ModifiedDate = getdate() '+CASE WHEN ISNULL(@UpdateColumnString,'') = '' THEN '' ELSE ','+@UpdateColumnString END+' 
			FROM ZnodeAddress ZA
			INNER JOIN #InsertAccount IC ON '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END

		EXEC (@SSQL)

		SET @SSQL = '
		Insert into ZnodeAddress (FirstName,LastName,DisplayName,Address1,Address2,Address3,CountryName,
								StateName,CityName,PostalCode,PhoneNumber,
								IsDefaultBilling,IsDefaultShipping,IsActive,ExternalId,CompanyName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)		
		OUTPUT INSERTED.AddressId, INSERTED.Address3 INTO  #InsertedAccountAddress (AddressId, AccountCode) 			 
		SELECT IC.FirstName,IC.LastName,IC.AddressName,IC.Address1,IC.Address2,IC.AccountCode,ZC.CountryCode,
		ZS.StateCode,IC.CityName,IC.PostalCode,IC.PhoneNumber,
		isnull(IC.IsDefaultBilling,0),isnull(IC.IsDefaultShipping,0),1,IC.ExternalId,IC.CompanyName, '+CONVERT(VARCHAR(10), @UserId)+' , getdate() , '+CONVERT(VARCHAR(10), @UserId)+' ,getdate()
		FROM  #InsertAccount IC
		inner join ZnodeState ZS on IC.StateName = ZS.StateName
		inner join ZnodeCountry ZC ON IC.CountryName = ZC.CountryName and ZS.CountryCode = ZC.CountryCode
		WHERE NOT EXISTS(SELECT * FROM ZnodeAddress ZA WHERE '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END +')'

		EXEC (@SSQL)

		update ZAA set AddressId = UA.AddressId
		FROM #InsertedAccountAddress UA
		INNER JOIN #InsertedAccount IA ON UA.AccountCode = IA.AccountCode
		inner join ZnodeAccount ZA ON IA.AccountCode = ZA.AccountCode
		inner join ZnodeAccountAddress ZAA ON ZA.AccountId = ZAA.AccountId
		
		INSERT INTO ZnodeAccountAddress ( AccountId, AddressId, CreatedBy, CreatedDate,	ModifiedBy,	ModifiedDate )
		SELECT distinct IA.AccountId, AddressId ,  @UserId , @GetDate, @UserId , @GetDate 
		FROM #InsertedAccountAddress UA
		INNER JOIN #InsertedAccount IA ON UA.AccountCode = IA.AccountCode
		WHERE NOT EXISTS ( SELECT * FROM ZnodeAccountAddress AA WHERE AA.AccountId = IA.AccountId )

		update ZnodeAddress set Address3 = null
		where exists(select * from #InsertedAccountAddress IAA where IAA.AddressId = ZnodeAddress.AddressId )
		and Address3 is null
		
		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
		 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAccount @TableName = '+CAST(@TableName AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@PortalId='+CAST(@PortalId AS VARCHAR(10))+',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max));

		 ---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;
              			
        EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportAccount',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportAttributes')
	DROP PROC Znode_ImportAttributes
GO

CREATE PROCEDURE [dbo].[Znode_ImportAttributes](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		-- Retrive RoundOff Value from global setting 
		DECLARE @InsertPimAtrribute TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, AttributeName varchar(300), AttributeCode varchar(300), AttributeType varchar(300), DisplayOrder int, GUID nvarchar(400)
		
		);
		DECLARE @InsertedPimAttributeIds TABLE (PimAttributeId int ,AttributeTypeId int,AttributeCode nvarchar(300))
		
		SET @SSQL = 'Select RowNumber,AttributeName,AttributeCode,AttributeType,DisplayOrder ,GUID FROM '+@TableName;
		INSERT INTO @InsertPimAtrribute( RowNumber,AttributeName,AttributeCode,AttributeType,DisplayOrder ,GUID)
		EXEC sys.sp_sqlexec @SSQL;


		--@MessageDisplay will use to display validate message for input inventory value  
		DECLARE @AttributeCode TABLE
		( 
		   AttributeCode nvarchar(300)
		);
		INSERT INTO @AttributeCode
			   SELECT AttributeCode
			   FROM ZnodePimAttribute 

		-- Start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '10', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.AttributeCode in 
			   (
				   SELECT AttributeCode FROM @AttributeCode  where AttributeCode is not null 
			   );
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '53', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.AttributeCode in 
			   (
				   select AttributeCode  FROM @InsertPimAtrribute  Group BY AttributeCode  having count(*) > 1 
			   );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '103', 'AttributeType', AttributeType, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.AttributeType NOT in 
			   (
				   SELECT AttributeTypeName  FROM ZnodeAttributeType  where IsPimAttributeType = 1 
			   );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '50', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.AttributeCode,''))) like '%[^0-9A-Za-z]%'

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '50', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE Isnumeric(ltrim(rtrim(isnull(ii.AttributeCode,'')))) =1

	    INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '119', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.AttributeCode,''))) NOT LIKE '[^0-9]%'

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '102', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.AttributeCode,''))) like '% %' -----space not allowed

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '17', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '64', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 999


		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ Attribute - ' + ISNULL(AttributeCode,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN @InsertPimAtrribute IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertPimAtrribute
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertPimAtrribute
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- End


		--- Insert data into base table ZnodePimatrribute with their validation 

		INSERT INTO ZnodePimAttribute (AttributeTypeId,AttributeCode,IsRequired,IsLocalizable,IsFilterable,IsSystemDefined
			,IsConfigurable,IsPersonalizable,IsShowOnGrid,DisplayOrder,HelpDescription,IsCategory,IsHidden,IsSwatch,
			CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		
		OUTPUT Inserted.PimAttributeId,Inserted.AttributeTypeId,Inserted.AttributeCode INTO @InsertedPimAttributeIds  
		
		SELECT ZAT.AttributeTypeId,AttributeCode, 0 IsRequired , 1 IsLocalizable,1 IsFilterable, 0 IsSystemDefined, 0 IsConfigurable,
		0 IsPersonalizable,  0 IsShowOnGrid , Case when Isnull(DisplayOrder,0) = 0 then  999 else DisplayOrder end  , '' HelpDescription ,0  IsCategory , 0 IsHidden , 0 IsSwatch,
		@UserId , @GetDate ,@UserId , @GetDate from @InsertPimAtrribute IPA INNER JOIN ZnodeAttributeType ZAT 
		ON IPA.AttributeType = ZAT.AttributeTypeName  
		
		
		INSERT INTO ZnodePimAttributeLocale (LocaleId,PimAttributeId,AttributeName,Description,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		Select @LocaleId ,IPAS.PimAttributeId, IPA.AttributeName, '', @UserId , @GetDate ,@UserId , @GetDate   
		 FROM @InsertedPimAttributeIds IPAS INNER JOIN @InsertPimAtrribute IPA ON IPAS.AttributeCode= IPA.AttributeCode 
		
		INSERT INTO ZnodePimAttributeValidation
		(PimAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT IPA.PimAttributeId,ZAIV.InputValidationId,NULL,null , @UserId , @GetDate ,@UserId , @GetDate  
		FROM @InsertedPimAttributeIds IPA INNER JOIN ZnodeAttributeInputValidation ZAIV ON IPA.AttributeTypeId = ZAIV.AttributeTypeId


		insert into ZnodePimFrontendProperties (PimAttributeId,IsComparable,IsUseInSearch,IsHtmlTags,IsFacets,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		Select PimAttributeId, 0 IsComparable, 0 IsUseInSearch,0 IsHtmlTags,0 IsFacets, @UserId CreatedBy,@GetDate CreatedDate, @UserId ModifiedBy, @GetDate ModifiedDate
		from  @InsertedPimAttributeIds
		--      SET @Status = 1;

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAttributes @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportAttributes',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;

	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCustomer')
	DROP PROC Znode_ImportCustomer
GO

CREATE PROCEDURE [dbo].[Znode_ImportCustomer]
(
	  @TableName NVARCHAR(100), 
	  @Status BIT OUT, 
	  @UserId INT, 
	  @ImportProcessLogId INT, 
	  @NewGUId NVARCHAR(200), 
	  @LocaleId INT= 0,
	  @PortalId INT ,
	  @CsvColumnString NVARCHAR(max)
)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Customer Details
	
	-- Unit Testing : 
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(max),@AspNetZnodeUserId NVARCHAR(256),@ASPNetUsersId NVARCHAR(256),
		@PasswordHash NVARCHAR(max),@SecurityStamp NVARCHAR(max),@RoleId NVARCHAR(256),@IsAllowGlobalLevelUserCreation NVARCHAR(10)
		Declare @ProfileId  INT
		DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		 
		SET @SecurityStamp = '0wVYOZNK4g4kKz9wNs-UHw2'
		SET @PasswordHash = 'APy4Tm1KbRG6oy7h3r85UDh/lCW4JeOi2O2Mfsb3OjkpWTp1YfucMAvvcmUqNaSOlA==';
		SELECT  @RoleId  = Id FROM AspNetRoles WHERE   NAME = 'Customer'  

		SELECT @IsAllowGlobalLevelUserCreation = FeatureValues FROM ZnodeGlobalsetting WHERE FeatureName = 'AllowGlobalLevelUserCreation'

		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
		-- Retrive RoundOff Value FROM global setting 

		-- Three type of import required three table varible for product , category and brand
		CREATE TABLE #InsertCustomer 
		( 
			RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, UserName NVARCHAR(512) ,FirstName	NVARCHAR(200),
			LastName NVARCHAR(200), BudgetAmount	NUMERIC,Email	NVARCHAR(100),PhoneNumber	NVARCHAR(100),
		    EmailOptIn	varchar(100)	,ReferralStatus	NVARCHAR(40),IsActive	varchar(100)	,ExternalId	NVARCHAR(max),CreatedDate DATETIME,
			ProfileName varchar(200),AccountCode NVARCHAR(100),DepartmentName varchar(300),RoleName NVARCHAR(256), GUID NVARCHAR(400)
			,PerOrderLimit INT,	PerOrderAnnualLimit NVARCHAR(100),BillingAccountNumber NVARCHAR(100),EnableUserShippingAddressSuggestion  NVARCHAR(100),
			EnablePowerBIReportOnWebStore BIT,Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),
			Custom4 NVARCHAR(max),Custom5 NVARCHAR(max), SMSOptIn varchar(100)
		);

		SET @SSQL = 'INSERT INTO #InsertCustomer( RowNumber,' + @CsvColumnString + ',GUID)
		             SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+ @TableName;
		
		EXEC sys.sp_sqlexec @SSQL;
				
		SELECT TOP 1 @ProfileId   =  ProfileId FROM ZnodePortalprofile WHERE Portalid = @Portalid and IsDefaultRegistedProfile=1
		IF( Isnull(@ProfileId ,0) = 0 ) 
		Begin
		
		
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '62', 'Default Portal Profile', '', @NewGUId, 1 , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
							
				UPDATE ZnodeImportProcessLog
				SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
				WHERE ImportProcessLogId = @ImportProcessLogId;
			

				SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog 
				WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
				SELECT @SuccessRecordCount = 0

				UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
				TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
				WHERE ImportProcessLogId = @ImportProcessLogId;

				DELETE FROM #InsertCustomer 
				SET @Status = 0;

				COMMIT TRAN A;
				Return 0 
		End

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '104', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName not like '%_@_%_.__%' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '35', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName like '%;%'
				
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '30', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ltrim(rtrim(ii.UserName)) IN 
		(SELECT ltrim(rtrim(UserName))  FROM #InsertCustomer GROUP BY ltrim(rtrim(UserName))  having count(*) > 1 )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '104', 'Email', Email, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.Email not like '%_@_%_.__%' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'IsActive',  IsActive , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '77', 'AccountCode', ii.AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer ii 
		WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !='' 
		AND NOT EXISTS(SELECT * FROM ZnodeAccount za INNER JOIN ZnodePortalAccount zpa on za.AccountId = zpa.AccountId
			WHERE  ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za.AccountCode and zpa.PortalId = @PortalId )
		AND EXISTS(SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount za1 WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za1.AccountCode );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '73', 'AccountCode', AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !=''   and ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') not IN 
		(
			SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount   
		);

		

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '88', 'AccountCode', AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !='' and  exists
		(
			SELECT top 1 1 FROM  AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	 
		INNER JOIN ZnodeAccount ZA on  ZU.AccountId = ZA.AccountId
		WHERE ANZU.UserName = ii.UserName and  ZA.AccountCode != ii.AccountCode
		);

		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--SELECT '92', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		--FROM #InsertCustomer AS ii
		--WHERE ISNULL(LTRIM(RTRIM(ii.RoleName)),'') <> '' and  ISNULL(LTRIM(RTRIM(ii.RoleName)),'') IN ('User','Manager','Administrator')
		--AND EXISTS(SELECT * FROM ZnodeUser a INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId and b.Id <> a.AspNetUserId))
		--		INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
		--		--INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)						
		--		INNER JOIN AspNetUserRoles u on u.UserId = b.Id
		--		INNER JOIN AspNetRoles ZD on u.RoleId = zd.Id
				-- (ii.UserName = c.UserName) and ISNULL(LTRIM(RTRIM(ii.RoleName)),'') <> ZD.Name )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '75', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') ='' and ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '74', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE --ltrim(rtrim(ii.RoleName)) not IN ('User','Manager','Administrator') and ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and
			ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and not exists (SELECT top 1 1 FROM  AspNetRoles ANR WHERE name IN ('User','Manager','Administrator') and  ANR.name =ii.RoleName)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '76', 'DepartmentName', DepartmentName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') <> ''
		AND NOT EXISTS(SELECT * FROM  ZnodeAccount ZA INNER JOIN ZnodeDepartment ZD on ZA.AccountId = ZD.AccountId
			WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = ltrim(rtrim(za.AccountCode))
			and ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') = ltrim(rtrim(ZD.DepartmentName)))

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'EmailOptIn',  EmailOptIn , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.EmailOptIn NOT IN ('True','1','Yes','FALSE','0','No','');

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'SMSOptIn',  SMSOptIn , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.SMSOptIn NOT IN ('True','1','Yes','FALSE','0','No','');

		UPDATE ZIL
		SET ZIL.ColumnName =   ZIL.ColumnName + ' [ UserName - ' + ISNULL(UserName,'') + ' ] '
		FROM ZnodeImportLog ZIL 
		INNER JOIN #InsertCustomer IPA ON (ZIL.RowNumber = IPA.RowNumber)
		WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		--Note : Content page import is not required 
		
		-- END Function Validation 	
		-----------------------------------------------
		--- Delete Invalid Data after functional validatin  

		DELETE FROM #InsertCustomer
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
			--AND GUID = @NewGUID
		);


		-- Update Record count IN log 
        
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		SELECT @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertCustomer
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- END

		-- Insert Product Data 
				
				
				DECLARE @InsertedAspNetZnodeUser TABLE (AspNetZnodeUserId NVARCHAR(256) ,UserName NVARCHAR(512),PortalId INT )
				DECLARE @InsertedASPNetUsers TABLE (Id NVARCHAR(256) ,UserName NVARCHAR(512))
				DECLARE @InsertZnodeUser TABLE (UserId INT,AspNetUserId NVARCHAR(256),CreatedDate DATETIME )

				UPDATE ANU SET 
				ANU.PhoneNumber	= IC.PhoneNumber, 
					ANU.LockoutEndDateUtc = case when IC.IsActive IN('0','No','False') then @GetDate when IC.IsActive IN('1','Yes','True') then null else ANU.LockoutEndDateUtc END
				FROM AspNetZnodeUser ANZU 
				INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
				WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
				----Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

				UPDATE ZU SET 
				ZU.FirstName	= IC.FirstName,
				ZU.LastName		= IC.LastName,
				--ZU.MiddleName	= IC.MiddleName,
				ZU.BudgetAmount = IC.BudgetAmount,
				ZU.Email		= IC.Email,
				ZU.PhoneNumber	= IC.PhoneNumber,
				ZU.EmailOptIn	= (CASE IC.EmailOptIn WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.EmailOptIn,0) As BIT) END),
				ZU.IsActive		= (CASE IC.IsActive WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.IsActive,0) As BIT) END),
				ZU.Custom1 = IC.Custom1,
				ZU.Custom2 = IC.Custom2,
				ZU.Custom3 = IC.Custom3,
				ZU.Custom4 = IC.Custom4,
				ZU.Custom5 = IC.Custom5,
				ZU.SMSOptIn	= (CASE IC.SMSOptIn WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 WHEN ISNULL(IC.SMSOptIn,'') THEN ZU.SMSOptIn ELSE CAST(ISNULL(IC.SMSOptIn,0) As BIT) END)
				--ZU.ExternalId = ExternalId
				FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
				WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
				--WHERE Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

				INSERT INTO AspNetZnodeUser (AspNetZnodeUserId, UserName, PortalId)		
				OUTPUT INSERTED.AspNetZnodeUserId, INSERTED.UserName, INSERTED.PortalId	INTO  @InsertedAspNetZnodeUser 			 
				SELECT NEWID(),IC.UserName, @PortalId FROM #InsertCustomer IC 
				WHERE NOT EXISTS (SELECT TOP 1 1  FROM AspNetZnodeUser ANZ 
					WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZ.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END 
					AND ANZ.UserName = IC.UserName)

				INSERT INTO ASPNetUsers (Id,Email,EmailConfirmed,PasswordHash,SecurityStamp,PhoneNumber,PhoneNumberConfirmed,TwoFactorEnabled,
				LockoutEndDateUtc,LockOutEnabled,AccessFailedCount,PasswordChangedDate,UserName)
				OUTPUT inserted.Id, inserted.UserName INTO @InsertedASPNetUsers
				SELECT NewId(), Email,0 ,@PasswordHash,@SecurityStamp,PhoneNumber,0,0,case when A.IsActive IN ('0','False','No') then @GetDate else null END LockoutEndDateUtc,1 LockoutEnabled,
				0,@GetDate,AspNetZnodeUserId FROM #InsertCustomer A INNER JOIN @InsertedAspNetZnodeUser  B 
				ON A.UserName = B.UserName
			
				INSERT INTO  ZnodeUser(AspNetUserId,FirstName,LastName,CustomerPaymentGUID,Email,PhoneNumber,EmailOptIn,
				IsActive,ExternalId, CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,UserName,Custom1,Custom2,Custom3,Custom4,Custom5,SMSOptIn)
				OUTPUT Inserted.UserId, Inserted.AspNetUserId,Inserted.CreatedDate INTO @InsertZnodeUser
				SELECT IANU.Id AspNetUserId ,IC.FirstName,IC.LastName,null CustomerPaymentGUID,IC.Email
				,IC.PhoneNumber,
				(CASE IC.EmailOptIn WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.EmailOptIn,0) As BIT) END),
				(CASE IC.IsActive WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.IsActive,0) As BIT) END),
				IC.ExternalId, @UserId,
				CASE WHEN IC.CreatedDate IS NULL OR IC.CreatedDate = '' THEN  @Getdate ELSE IC.CreatedDate END,
				@UserId,@Getdate,IC.UserName,IC.Custom1,IC.Custom2,IC.Custom3,IC.Custom4,IC.Custom5,
					(CASE IC.SMSOptIn WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.SMSOptIn,0) As BIT) END)
				FROM #InsertCustomer IC INNER JOIN 
				@InsertedAspNetZnodeUser IANZU ON IC.UserName = IANZU.UserName  INNER JOIN 
				@InsertedASPNetUsers IANU ON IANZU.AspNetZnodeUserId = IANU.UserName 
	  	     
				INSERT INTO AspNetUserRoles (UserId,RoleId)  SELECT AspNetUserId, @RoleID FROM @InsertZnodeUser 
				INSERT INTO ZnodeUserPortal (UserId,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
				SELECT UserId, @PortalId , @UserId, IZU.CreatedDate,@UserId,@Getdate 
				FROM @InsertZnodeUser IZU

				INSERT INTO ZnodeAccountUserPermission(UserId,AccountPermissionAccessId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT UserId, 4 , @UserId, @Getdate,@UserId,@Getdate 
				FROM @InsertZnodeUser IZU
		
				------------INSERT INTO ZnodeUserGlobalAttributeValue
	
				IF OBJECT_ID('tempdb..#globaldata') IS NOT NULL 
					DROP TABLE #globaldata
				
				SELECT ZU.userid,PerOrderLimit,
					PerOrderAnnualLimit,
					BillingAccountNumber,
					EnableUserShippingAddressSuggestion,
					EnablePowerBIReportOnWebStore 
				INTO #globaldata
				FROM znodeuser ZU INNER JOIN  #InsertCustomer IC on IC.Email =ZU.EMAIL
				WHERE ZU.userid IN (SELECT userid FROM @InsertZnodeUser)
				GROUP BY ZU.userid,PerOrderLimit,
									PerOrderAnnualLimit,
									BillingAccountNumber,
									EnableUserShippingAddressSuggestion,
									EnablePowerBIReportOnWebStore 

				IF OBJECT_ID('tempdb..#globaldata1') IS NOT NULL DROP TABLE #globaldata1
				SELECT * INTO #globaldata1 FROM (SELECT userid, Cast(PerOrderLimit as varchar(100)) PerOrderLimit,
				 Cast(PerOrderAnnualLimit as varchar(100)) PerOrderAnnualLimit,
				 Cast(BillingAccountNumber as varchar(100)) BillingAccountNumber,
				 Cast(case when cast(EnableUserShippingAddressSuggestion as varchar(10))= '1' or cast(EnableUserShippingAddressSuggestion as varchar(10)) ='YES' or  cast(EnableUserShippingAddressSuggestion as varchar(10)) ='True' then 'True' else 'False'  END  as varchar(100)) EnableUserShippingAddressSuggestion,
				 Cast(case when cast(EnablePowerBIReportOnWebStore as varchar(10))= '1'  or cast(EnablePowerBIReportOnWebStore as varchar(10)) ='YES' or  cast(EnablePowerBIReportOnWebStore as varchar(10)) ='True' then 'True' else 'False' END  as varchar(100)) EnablePowerBIReportOnWebStore FROM #globaldata) ab
				UNPIVOT  
				   (avalue FOR acode IN   
					  (PerOrderLimit,
				PerOrderAnnualLimit,
				BillingAccountNumber,
				EnableUserShippingAddressSuggestion,
				EnablePowerBIReportOnWebStore)  
				)AS unpvt;  

				INSERT INTO ZnodeUserGlobalAttributeValue (UserId,	GlobalAttributeId,	GlobalAttributeDefaultValueId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
				SELECT g.Userid,ZGA.GlobalAttributeId,null,null,@UserId,@Getdate,@UserId,@Getdate
					FROM #globaldata1 g INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.acode
					WHERE NOT EXISTS (SELECT top 1 1 FROM ZnodeUserGlobalAttributeValue ZGAV WHERE ZGAV.Userid =g.Userid and ZGA.GlobalAttributeId=ZGAV.GlobalAttributeId)

				INSERT INTO ZnodeUserGlobalAttributeValuelocale(UserGlobalAttributeValueId,	LocaleId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate,	GlobalAttributeDefaultValueId,	MediaId,	MediaPath)
				SELECT UserGlobalAttributeValueId, @LocaleId,avalue ,@UserId,@Getdate,@UserId,@Getdate,null,null,null
					FROM ZnodeUserGlobalAttributeValue ZUGAV INNER JOIN #globaldata1 g on ZUGAV.userid =g.userid
						INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.acode and ZGA.GlobalAttributeId = ZUGAV.GlobalAttributeId
						WHERE NOT EXISTS (SELECT Top 1 1 FROM ZnodeUserGlobalAttributeValuelocale z WHERE z.UserGlobalAttributeValueId = ZUGAV.UserGlobalAttributeValueId)

				---------------------------------------------------------------------------------

				declare @Profile table (ProfileId INT)

				INSERT INTO ZnodeProfile (ProfileName,ShowOnPartnerSignup,Weighting,TaxExempt,DefaultExternalAccountNo,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ParentProfileId)
				OUTPUT inserted.ProfileId INTO @Profile(ProfileId)
				SELECT Distinct ProfileName, 0, null,0, replace(ltrim(rtrim(ProfileName)),' ','') as DefaultExternalAccountNo, @UserId,@Getdate, @UserId,@Getdate, null as ParentProfileId				
				FROM #InsertCustomer IC
				WHERE NOT EXISTS(SELECT * FROM ZnodeProfile ZP WHERE IC.ProfileName = ZP.ProfileName )
				AND ISNULL(ic.ProfileName,'') <> ''

				INSERT INTO ZnodePortalProfile (PortalId,	ProfileId,	IsDefaultAnonymousProfile,	IsDefaultRegistedProfile,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
				SELECT @PortalId, ProfileId, 0 AS IsDefaultAnonymousProfile, 0 AS IsDefaultRegistedProfile, @UserId,@Getdate, @UserId,@Getdate
				FROM @Profile

				UPDATE ZnodeUserProfile 
				SET ProfileId = COALESCE(ZP.ProfileId,@ProfileId)
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeUserProfile u ON u.UserId = a.UserId
				LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
				--WHERE IC.ProfileName <> ''
				
				INSERT INTO ZnodeUserProfile (ProfileId,UserId,IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT COALESCE(ZP.ProfileId,@ProfileId)  , a.UserId, 1 , @UserId,a.CreatedDate,@UserId,@Getdate 
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeUserProfile u WHERE u.UserId = a.UserId )
				AND EXISTS(SELECT * FROM @InsertZnodeUser IZU WHERE A.UserId = IZU.UserId)

				---to update accountid agaist user
				UPDATE ZU SET ZU.AccountId = ZA.AccountId 
				FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	 
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName
				INNER JOIN ZnodeAccount ZA ON ZA.AccountCode = IC.AccountCode 
				--INNER JOIN @InsertZnodeUser IZU on IZU.UserId =ZU.UserId
				WHERE Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0) and isnull(IC.AccountCode,'') <> ''
				
				update ZDU set ZDU.DepartmentId = ZD.DepartmentId, ModifiedBy = @UserId, ModifiedDate = @Getdate
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
				INNER JOIN ZnodeDepartmentUser ZDU on ZDU.UserId = a.UserId
				WHERE isnull(IC.DepartmentName,'') <> ''

				INSERT INTO ZnodeDepartmentUser(UserId,DepartmentId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT a.UserId, ZD.DepartmentId, @UserId,a.CreatedDate,@UserId,@Getdate 
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeDepartmentUser u WHERE u.UserId = a.UserId)
				AND isnull(IC.DepartmentName,'') <> ''
		
				update u set u.RoleId = ZD.Id
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
				INNER JOIN AspNetUserRoles u on u.UserId = b.Id
				WHERE isnull(IC.RoleName,'') <> ''
				
				INSERT INTO AspNetUserRoles(UserId,RoleId)
				SELECT b.Id as ASPNetUserId, ZD.Id as RoleId
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM AspNetUserRoles u WHERE u.UserId = b.Id)
				AND EXISTS(SELECT * FROM @InsertZnodeUser IZU WHERE A.UserId = IZU.UserId)
				AND isnull(IC.RoleName,'') <> ''


		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
		 DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCustomer @TableName = '+CAST(@TableName AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@PortalId='+CAST(@PortalId AS VARCHAR(10))+',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max));
              	
		 ---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

        EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportCustomer',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportVoucher')
	DROP PROC Znode_ImportVoucher
GO

CREATE PROCEDURE [dbo].[Znode_ImportVoucher](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN Voucher;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		-- Retrive RoundOff Value from global setting 

		DECLARE @InsertVoucherData TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY,RowNumber int, StoreCode varchar(400),VoucherName varchar(600), VoucherNumber varchar(600),
			VoucherAmount varchar(600),UserName varchar(600), ExpirationDate Datetime,IsActive varchar(100),RemainingAmount varchar(600),
			RestrictVoucherToACustomer varchar(100), StartDate datetime, GUID nvarchar(400)
		);
		
		SET @SSQL = 'Select RowNumber,StoreCode, VoucherName,VoucherNumber,VoucherAmount,UserName,ExpirationDate,
						IsActive,RemainingAmount,RestrictVoucherToACustomer,StartDate,GUID FROM '+@TableName;
		INSERT INTO @InsertVoucherData( RowNumber,StoreCode, VoucherName,VoucherNumber,VoucherAmount,UserName,ExpirationDate,
										IsActive,RemainingAmount,RestrictVoucherToACustomer,StartDate,GUID)
		EXEC sys.sp_sqlexec @SSQL;

		select ANZU.UserName, ANU.Id, ZU.UserId
		into #TempUserData
		from AspNetZnodeUser ANZU 
		inner join AspNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName
		inner join ZnodeUser ZU ON ANU.Id = ZU.AspNetUserId

		select ZUP.PortalId, ZUP.UserId, ZP.StoreCode
		into #TempUserPortal
		from ZnodeUserPortal ZUP 
		INNER JOIN ZnodePortal ZP ON ZUP.PortalId = ZP.PortalId

		update @InsertVoucherData set VoucherNumber = [dbo].[Fn_RandomString](10)
		where isnull(ltrim(rtrim(VoucherNumber)),'') = ''

		-- Start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '70', 'StoreCode', StoreCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE ii.StoreCode not in 
			   (
				   SELECT StoreCode FROM ZnodePortal 
			   );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '65', 'ExpirationDate', ExpirationDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE (ii.ExpirationDate < ii.StartDate OR ii.ExpirationDate < @GetDate)

		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--	   SELECT '65', 'ExpirationDate', ExpirationDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		--	   FROM @InsertVoucherData AS ii
		--	   WHERE ii.ExpirationDate < @GetDate

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '8', 'StartDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE isnull(ii.StartDate,'') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '8', 'ExpirationDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE isnull(ii.ExpirationDate,'') = ''
		
		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--	   SELECT '67', 'UserName', UserName, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		--	   FROM @InsertVoucherData AS ii
		--	   WHERE isnull(ii.UserName,'') <> '' and not exists ( SELECT VoucherNumber FROM #TempUserData U where ii.UserName = U.UserName);
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '67', 'UserName', UserName, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii			 
			   WHERE isnull(ii.UserName,'') <> '' 
			   and not exists ( SELECT * FROM #TempUserData U where ii.UserName = U.UserName 
			   and not exists(select * from #TempUserPortal UP where U.UserId = UP.UserId and ii.StoreCode = UP.StoreCode))
			 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '71', 'VoucherNumber', VoucherNumber, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE len(ltrim(rtrim(ii.VoucherNumber))) <> 10 
	
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No','')
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '5', 'ExpirationDate', ExpirationDate, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			WHERE isdate(ii.ExpirationDate) = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '5', 'StartDate', StartDate, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			WHERE isdate(ii.StartDate) = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '69', 'RemainingAmount', RemainingAmount, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			WHERE ii.VoucherAmount <> ii.RemainingAmount

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'RestrictVoucherToACustomer', RestrictVoucherToACustomer, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			WHERE ii.RestrictVoucherToACustomer not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT distinct '2', 'VoucherAmount', VoucherAmount, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			CROSS APPLY ZnodeCulture b
			WHERE  VoucherAmount like '%[a-z]%' or VoucherAmount like '%'+b.Symbol+'%'
			and b.Symbol is not null 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT distinct '2', 'RemainingAmount', RemainingAmount, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii
			CROSS APPLY ZnodeCulture b
			WHERE  RemainingAmount like '%[a-z]%' or RemainingAmount like '%'+b.Symbol+'%'
			and b.Symbol is not null 


		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ VoucherName - ' + ISNULL(VoucherName,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN @InsertVoucherData IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertVoucherData
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertVoucherData
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;
	
		UPDATE ZGC set ExpirationDate = ICD.ExpirationDate, UserId = ZU.UserId, ModifiedBy = @UserId, ModifiedDate = @GetDate, IsActive = ICD.IsActive,
				RemainingAmount = ICD.RemainingAmount, RestrictToCustomerAccount = ICD.RestrictVoucherToACustomer, Name = ICD.VoucherName, StartDate = ICD.StartDate
		from ZnodeGiftCard ZGC
		inner join @InsertVoucherData ICD ON ICD.VoucherNumber = ZGC.CardNumber
		inner join ZnodePortal ZP ON ICD.StoreCode = ZP.StoreCode and ZGC.PortalId = ZP.PortalId
		left join #TempUserData ZU ON ICD.UserName = ZU.UserName

		insert into ZnodeGiftCard(PortalId,Name,CardNumber,Amount,UserId,ExpirationDate,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsActive,RemainingAmount,RestrictToCustomerAccount,StartDate)
		select ZP.PortalId, ICD.VoucherName, ICD.VoucherNumber, ICD.VoucherAmount, ZU.UserId, ICD.ExpirationDate, @UserId, @Getdate, @UserId, @Getdate, ICD.IsActive, ICD.RemainingAmount, ICD.RestrictVoucherToACustomer, ICD.StartDate
		From @InsertVoucherData ICD 
		inner join ZnodePortal ZP ON ICD.StoreCode = ZP.StoreCode 
		left join #TempUserData ZU ON ICD.UserName = ZU.UserName
		where not exists(select * from ZnodeGiftCard ZGC where ICD.VoucherNumber = ZGC.CardNumber )

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN Voucher;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN Voucher

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		 DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportVoucher @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));

		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportVoucher',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

INSERT INTO ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 116,'Text','Input must include any State that is associated with the selected Country.',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeMessage WHERE MessageCode = 116)  
GO
UPDATE ZnodeMessage set MessageName = 'Input must include any Country that is associated with the Store.'
WHERE MessageName = 'Country should belong to the selected Store.'
GO
UPDATE znodemessage set MessageName='Input value must be in alphanumeric format without spaces.'
WHERE MessageName='Input must include a value in alphanumeric format.'
GO
INSERT INTO ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 119,'Text','Input value is required in alphanumeric format without spaces and must start with an alphabet.',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeMessage WHERE MessageCode = 119)

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeletePublishCatalogEntity')
	DROP PROC Znode_DeletePublishCatalogEntity
GO

CREATE PROCEDURE [dbo].[Znode_DeletePublishCatalogEntity]
(
    @PublishCatalogId  INT = 0 
   ,@UserId int = 0
   ,@IsRevertPublish bit = 0 
   ,@NewGUID nvarchar(500) 

)
AS
/*
	To Remove all publish catalog details from related entities
	Unit Testing : 
	Declare @Status bit 
	Exec [dbo].[ZnodePublishPortalEntity]
     @PortalId  = 1 
	,@LocaleId  = 0 
	,@RevisionState = 'PRODUCTION' 
	,@UserId = 2
	,@Status = @Status 
	--Select @Status 
*/
BEGIN
SET NOCOUNT ON
BEGIN TRY 
Begin Transaction 
--SET NOCOUNT ON
		Declare @Status Bit =0, @IsPreviewEnable  int,  @Batch INT;
		IF object_id('tempdb..[#Tbl_VersionEntity]') IS NOT NULL
			drop table tempdb..#Tbl_VersionEntity
		
		Create Table #Tbl_VersionEntity(PublishCatalogId int , VersionId int , LocaleId int , PublishType varchar(50))
		Insert into #Tbl_VersionEntity (PublishCatalogId , VersionId , LocaleId , PublishType )
			select ZnodeCatalogId , VersionId , LocaleId , RevisionType  from ZnodePublishVersionEntity   where ZnodeCatalogId = @PublishCatalogId 
			and  IsPublishSuccess =0  

		IF object_id('tempdb..[#Tbl_VersionEntityforCatalog]') IS NOT NULL
			drop table tempdb..#Tbl_VersionEntityforCatalog
		
		Create Table #Tbl_VersionEntityforCatalog(PublishCatalogId int , VersionId int , LocaleId int , PublishType varchar(50))
		Insert into #Tbl_VersionEntityforCatalog(PublishCatalogId , VersionId , LocaleId , PublishType )
		select ZnodeCatalogId , VersionId , LocaleId , RevisionType  from ZnodePublishVersionEntity   where ZnodeCatalogId = @PublishCatalogId 
		and  IsPublishSuccess = 0  

		IF object_id('tempdb..[#Tbl_OldVersionEntityforCatalog]') IS NOT NULL
			drop table tempdb..#Tbl_OldVersionEntityforCatalog
		
		Create Table #Tbl_OldVersionEntityforCatalog(PublishCatalogId int , VersionId int , LocaleId int , PublishType varchar(50),IsPublishSuccess bit )
		Insert into #Tbl_OldVersionEntityforCatalog(PublishCatalogId , VersionId , LocaleId , PublishType ,IsPublishSuccess)
		select ZnodeCatalogId , VersionId , LocaleId, RevisionType  ,IsPublishSuccess from ZnodePublishVersionEntity   where ZnodeCatalogId = @PublishCatalogId 
		and  IsPublishSuccess = 1  

		IF object_id('tempdb..[#Tbl_OldVersionEntityforDeletion]') IS NOT NULL
		drop table tempdb..#Tbl_OldVersionEntityforDeletion

		Create Table #Tbl_OldVersionEntityforDeletion(PublishCatalogId int , VersionId int , LocaleId int , PublishType varchar(50),IsPublishSuccess bit )
		Insert into #Tbl_OldVersionEntityforDeletion(PublishCatalogId , VersionId , LocaleId , PublishType ,IsPublishSuccess)
		select ZnodeCatalogId , VersionId , LocaleId, RevisionType  ,IsPublishSuccess from ZnodePublishVersionEntity   where ZnodeCatalogId = @PublishCatalogId 
		and  IsPublishSuccess = 1  and RevisionType  in 
		(Select distinct PublishType from #Tbl_VersionEntity where ZnodeCatalogId = #Tbl_VersionEntity.PublishCatalogId  )

		If @IsRevertPublish = 0 AND @PublishCatalogId > 0 AND Exists (Select Top 1 1 from #Tbl_VersionEntity ) 
		Begin 
			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =90, 
			IsCompleted  = 1,
			IsFailed =0
			where  JobId = @NewGUID

			Delete  From ZnodePublishCatalogEntity Where  VersionId NOT IN  (Select VersionId from #Tbl_VersionEntity) AND ZnodeCatalogId = @PublishCatalogId  
				AND VersionId IN  (SELECT VersionId from #Tbl_OldVersionEntityforDeletion) 
			SET @Batch= 1;
			WHILE @Batch > 0
			BEGIN 
				Delete  TOP (10000) From ZnodePublishProductEntity Where ElasticSearchEvent = 2
				SET @Batch= @@ROWCOUNT;
				-- CHECKPOINT;    -- if simple
				-- BACKUP LOG ... -- if full
			END

			Delete  From ZnodePublishAddOnEntity Where  ElasticSearchEvent = 2 

			
			Delete  From ZnodePublishCategoryEntity Where ElasticSearchEvent = 2

			Delete  From ZnodePublishBundleProductEntity Where ElasticSearchEvent = 2

			Delete  From ZnodePublishGroupProductEntity Where ElasticSearchEvent = 2

			Delete  From ZnodePublishConfigurableProductEntity Where ElasticSearchEvent = 2

			Delete  From ZnodePublishSEOEntity Where CMSSEOTypeId in (1,2,4) 
			and ElasticSearchEvent = 2

			--Delete  From ZnodePublishVersionEntity Where  VersionId NOT IN (Select VersionId from #Tbl_VersionEntity) AND ZnodeCatalogId = @PublishCatalogId 
			--AND VersionId IN  (SELECT VersionId from #Tbl_OldVersionEntityforDeletion) 

			Update ZnodePublishVersionEntity  SET IsPublishSuccess= 1 where IsPublishSuccess = 0
			and ZnodeCatalogId  = @PublishCatalogId   

						
			Update a SET IsCatalogPublished =1,  PublishStateId = DBO.Fn_GetPublishStateIdForPublish(), ModifiedDate = Getdate()  
			from ZnodePublishCatalogLog a
			where  PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()
			and PublishCatalogLogId = (select max(PublishCatalogLogId) from ZnodePublishCatalogLog b where a.PimCatalogId = b.PimCatalogId and a.LocaleId = b.LocaleId and b.PublishStateId = DBO.Fn_GetPublishStateIdForProcessing())

			Update a SET IsCatalogPublished =1,  PublishStateId = DBO.Fn_GetPublishStateIdForPreview(), ModifiedDate = Getdate()  
			from ZnodePublishCatalogLog a
			where  PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()
			and PublishCatalogLogId = (select min(PublishCatalogLogId) from ZnodePublishCatalogLog b where a.PimCatalogId = b.PimCatalogId and a.LocaleId = b.LocaleId and b.PublishStateId = DBO.Fn_GetPublishStateIdForProcessing())


			Insert into ZnodePublishPreviewLogEntity
			(VersionId,PublishStartTime,IsDisposed,SourcePublishState,EntityId,EntityType,LogMessage,LogCreatedDate,PreviousVersionId,LocaleId,LocaleDisplayValue)
				Select A.VersionId,NULL,NULL,A.PublishType,@PublishCatalogId,'catalog','catalog has been published successfully' , Getdate(),  
				(select TOP 1 VersionId   from #Tbl_OldVersionEntityforCatalog where LocaleId = A.LocaleId AND PublishType = A.PublishType
				AND  PublishCatalogId = A.PublishCatalogId and  IsPublishSuccess =1 ),
				A.LocaleId,B.Name
				from #Tbl_VersionEntity  A  Inner join ZnodeLocale B on A.LocaleId = B.LocaleId 

			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =100, 
			IsCompleted  = 1,
			IsFailed =0
			where  JobId = @NewGUID

			--UPDATE ZnodePimProduct SET IsProductPublish = 1,PublishStateId =  DBO.Fn_GetPublishStateIdForPublish()  
			--WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishProduct ZPP WHERE ZPP.PimProductId = ZnodePimProduct.PimProductId AND ZPP.PublishCatalogId = @PublishCatalogId)

			--UPDATE ZnodePublishCatalogLog 
			--SET IsProductPublished = 1 
			--,PublishProductId = (SELECT  COUNT(DISTINCT PublishProductId) FROM ZnodePublishCategoryProduct ZPP WHERE ZPP.PublishCatalogId = ZnodePublishCatalogLog.PublishCatalogId AND ZPP.PublishCategoryId IS NOT NULL) 
			--WHERE EXISTS (SELECT TOP 1 1 FROM #Tbl_VersionEntity TY  WHERE  TY.VersionId =ZnodePublishCatalogLog.PublishCatalogLogId )  

		End
		Else If @IsRevertPublish = 1 AND @PublishCatalogId > 0 
		Begin 
			
			Delete  From ZnodePublishCatalogEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
			SET @Batch= 1;
			WHILE @Batch > 0
			BEGIN 
				Delete  TOP (10000) From ZnodePublishProductEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
				SET @Batch= @@ROWCOUNT;
				-- CHECKPOINT;    -- if simple
				-- BACKUP LOG ... -- if full
			END
			Delete  From ZnodePublishAddOnEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
			Delete  From ZnodePublishCategoryEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
			Delete  From ZnodePublishBundleProductEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
			Delete  From ZnodePublishGroupProductEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
			Delete  From ZnodePublishConfigurableProductEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
			Delete  From ZnodePublishSEOEntity Where CMSSEOTypeId in (1,2,4) and  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) 
			--AND PortalId in 
			--	(Select ZPC.PortalId  from ZnodePublishVersionEntity  ZPVE inner join ZnodePortalCatalog  
			--		ZPC ON ZPVE.ZnodeCatalogId = ZPC.PublishCatalogId where  (ZPC.PublishCatalogId = @PublishCatalogId ))

			Delete  From ZnodePublishVersionEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 

			INSERT INTO ZnodePublishCatalogErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'Elastic-index genration get failed : ', '' , 'Fail' , Getdate(), 
			@UserId , '' 
			
			Update ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed() ,
			IsCatalogPublished = 0  , ModifiedDate = Getdate()
			where PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()

			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =100, 
			IsCompleted  = 1,
			IsFailed =1
			where  JobId = @NewGUID

		END 
		Else If @IsRevertPublish = 1 AND Isnull(@PublishCatalogId,0) = 0 
		Begin 
			INSERT INTO ZnodePublishCatalogErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'Publish failed, Check connection failure ', '' , 'Fail' , Getdate(), @UserId , '' 
			
			Update ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed() ,
			IsCatalogPublished =0, IsCategoryPublished = 0 ,IsProductPublished = 0 , ModifiedDate = Getdate()
			where PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()
						
			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =80, 
			IsCompleted  = 0,
			IsFailed =1
			where  JobId = @NewGUID

		end

		SET @Status = 1
		Commit Transaction 
		SELECT @PublishCatalogId AS id,@Status AS Status;   
END TRY 
BEGIN CATCH 
	SET @Status =0  
	 SELECT 1 AS ID,@Status AS Status;   
	 Rollback transaction
	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeletePublishCatalogEntity 
		@PublishCatalogId = '+CAST(@PublishCatalogId  AS VARCHAR	(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@IsRevertPublish='+CAST(@IsRevertPublish AS VARCHAR(10))
		+',@UserId = ' + CAST(@UserId AS varchar(20));	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
	
	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_DeletePublishCatalogEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishAssociatedAddonsJson')
	DROP PROC Znode_GetPublishAssociatedAddonsJson
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishAssociatedAddonsJson]
(
	@PublishCatalogId NVARCHAR(MAX) = 0,
	@PimProductId    TransferId Readonly,
	@VersionId        INT           = 0,
	@UserId           INT,														 
	@PimCategoryHierarchyId int = 0, 
	@LocaleId       TransferId READONLY,
	@PublishStateId INT = 0, 
	@VersionIdString  VARCHAR(2000)= '',
	@Status		   Bit  OutPut,
	@RevisionType Varchar(50)
)
AS 
   
/*
    Summary : If PimcatalogId is provided get all products with Addons and provide above mentioned data
       If PimProductId is provided get all Addons if associated with given product id and provide above mentioned data
    			Input: @PublishCatalogId or @PimProductId
    		    output should be in XML format
       sample xml5
    Begin transaction  
	 declare  @PimProductId TransferId 
	 Declare @Status bit 
	 INSERT INTO @PimProductId  values (768)

			Exec [_Znode_GetPublishAssociatedAddonsJson]
				@PublishCatalogId = 5 ,
				--@PimProductId   = @PimProductId,
				@UserId =2,														 
				@VersionIdString = '',--'1662,1664,1663,1665',
				@Status	 =@Status Out,
				@RevisionType= 'Production'
				rollback transaction
				--SELECT * from ZnodePublishVersionEntity 
   
	*/

BEGIN
    BEGIN TRY
    SET NOCOUNT ON 
		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
        DECLARE @LocaleIdIn INT, @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId()
		, @Counter INT= 1
		, @MaxRowId INT= 0;

	UPDATE ZnodePublishAddonEntity SET ElasticSearchEvent = 0
    -- DECLARE @PimAddOnGroupId VARCHAR(MAX);

		CREATE TABLE #TBL_PublisshIds  (PublishProductId INT , PimProductId INT , PublishCatalogId INT)
		DECLARE @TBL_LocaleId TABLE (RowId    INT IDENTITY(1, 1),LocaleId INT);
		IF OBJECT_ID('tempdb..#VesionIds') is not null
		DROP TABLE #VesionIds
		Create Table #VesionIds(ZnodeCatalogId int , VersionId int , LocaleId int , RevisionType varchar(50) )

  		If @VersionIdString <> ''
		BEGIN
			Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)	
			SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType
			FROM ZnodePublishVersionEntity PV Inner join Split(@VersionIdString,',') S ON PV.VersionId = S.Item
		END
		Else 
		Begin
			If  (@RevisionType like '%Preview%'  OR @RevisionType like '%Production%')
			BEGIN
				Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)	
				SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV  where PV.IsPublishSuccess =1 
				AND PV.RevisionType ='Preview'
			END
			If  (@RevisionType like '%Production%' OR @RevisionType = 'None')
			BEGIN
				Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)	
				SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV  where PV.IsPublishSuccess =1 
				AND PV.RevisionType ='Production'
			END					
		End 

		IF (@PublishCatalogId IS NULL OR @PublishCatalogId = 0)
		BEGIN 
			INSERT INTO #TBL_PublisshIds 
			EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId,@userid,@PimProductId,1
		END 
		IF ISnull(@PimCategoryHierarchyId,0) <> 0 
		BEGIN 
			INSERT INTO #TBL_PublisshIds 
			EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId,@userid,@PimProductId,1,@PimCategoryHierarchyId 
		END 

		CREATE TABLE #TBL_PublishCatalogId (PublishCatalogId INT,PublishProductId INT,PimProductId  INT , VersionId INT ,LocaleId INT  );

		IF  ISnull(@PimCategoryHierarchyId,0) <> 0 
		BEGIN 
			INSERT INTO #TBL_PublishCatalogId 
			SELECT ZPP.PublishCatalogId , ZPP.PublishProductId,PimProductId, MAX(ZPCP.PublishCatalogLogId)  ,LocaleId 
			FROM ZnodePublishProduct ZPP 
			INNER JOIN ZnodePublishCatalogLog ZPCP ON (ZPCP.PublishCatalogId  = ZPP.PublishCatalogId)
			WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId   ) 
			AND ZPCP.Publishstateid = @PublishStateId
			GROUP BY ZPP.PublishCatalogId,ZPP.PublishProductId,PimProductId,LocaleId 
		END 
		ELSE 
		Begin
			INSERT INTO #TBL_PublishCatalogId  
			SELECT ZPP.PublishCatalogId , ZPP.PublishProductId,PimProductId,0  VersionId  ,0 LocaleId 
			FROM ZnodePublishProduct ZPP  
			WHERE EXISTS  (SELECT TOP 1 1 FROM #VesionIds ZPCP WHERE (ZPCP.ZnodeCatalogId  = ZPP.PublishCatalogId)) AND
			(EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId  
			AND  @PublishCatalogId = '0' )  OR (ZPP.PublishCatalogId =  @PublishCatalogId ))
		END
        DECLARE @TBL_AddonGroupLocale TABLE( PimAddonGroupId INT, DisplayType NVARCHAR(400),AddonGroupName NVARCHAR(MAX),LocaleId INT );
        INSERT INTO @TBL_LocaleId(LocaleId)
        SELECT LocaleId FROM ZnodeLocale MT  WHERE IsActive = 1 AND (EXISTS (SELECT TOP 1 1  FROM @LocaleId RT WHERE RT.Id = MT.LocaleId )
			OR NOT EXISTS (SELECT TOP 1 1 FROM @LocaleId ));
        SET @MaxRowId = ISNULL(( SELECT MAX(RowId) FROM @TBL_LocaleId ), 0);
    
        WHILE (@Counter <= @MaxRowId)
        BEGIN
            SET @LocaleIdIn =( SELECT LocaleId FROM @TBL_LocaleId WHERE RowId = @Counter );
            INSERT INTO @TBL_AddonGroupLocale (PimAddonGroupId, DisplayType, AddonGroupName)
            EXEC Znode_GetAddOnGroupLocale '', @LocaleIdIn;
	   		UPDATE @TBL_AddonGroupLocale SET LocaleId = @LocaleIdIn WHERE LocaleId IS NULL 
            SET @Counter = @Counter + 1;
        END;
		
		IF OBJECT_ID('tempdb..#AddonProductPublishedXML') is not null
		drop table #AddonProductPublishedXML
						
		SELECT  ZPPP.PublishProductId,ZPPP.PublishCatalogId,V.LocaleId,v.VersionId,
		ZPPP.[PublishProductId]  ZnodeProductId,
		ZPPP.[PublishCatalogId] ZnodeCatalogId,
		ZPP.PublishProductId  AssociatedZnodeProductId,
		ZPAOP.DisplayOrder DisplayOrder,
		ZPOPD.DisplayOrder AssociatedProductDisplayOrder,
		RequiredType ,
		DisplayType, 
		ISNULL((select ''+AddonGroupName for xml path('')),'') GroupName,
		ISnull(IsDefault,0) IsDefault
		INTO #AddonProductPublishedXML
		FROM [ZnodePimAddOnProductDetail] AS ZPOPD
		INNER JOIN [ZnodePimAddOnProduct] AS ZPAOP ON ZPOPD.[PimAddOnProductId] = ZPAOP.[PimAddOnProductId]
		INNER JOIN #TBL_PublishCatalogId ZPPP ON (ZPPP.PimProductId = ZPAOP.PimProductId )
		INNER JOIN #TBL_PublishCatalogId ZPP ON(ZPP.PimProductId = ZPOPD.[PimChildProductId] AND ZPP.PublishCatalogId = ZPPP.PublishCatalogId  )
		INNER JOIN #VesionIds V ON ZPPP.PublishCatalogId  = V.ZnodeCataLogId
		INNER JOIN @TBL_AddonGroupLocale TBAG ON (TBAG.PimAddonGroupId   = ZPAOP.PimAddonGroupId AND TBAG.LocaleId = V.LocaleId )
	
		If (isnull(@PublishCatalogId ,'') = '' and @VersionIdString = '') OR 
			(isnull(@PublishCatalogId ,'') = 0 and @VersionIdString = '')
		Begin 
			UPDATE ZnodePublishAddonEntity 
			SET ElasticSearchEvent = 2
			WHERE PublishAddonEntityId  IN (
											SELECT PublishAddonEntityId
											FROM ZnodePublishAddonEntity BP
											INNER JOIN #AddonProductPublishedXML A ON BP.ZnodeProductId =A.PublishProductId
												AND BP.ZnodeCatalogId = A.PublishCatalogId AND BP.VersionId = A.VersionId
											) 

			----Delete addon entries having parent data removed
			UPDATE ZPAE 
			SET ElasticSearchEvent = 2
			FROM ZnodePublishAddonEntity ZPAE
			WHERE NOT EXISTS (SELECT * from [ZnodePimAddOnProduct] ZPAOP 
					INNER JOIN ZnodePublishProduct ZPPP ON (ZPPP.PimProductId = ZPAOP.PimProductId )
					WHERE ZPAE.ZnodeProductId = ZPPP.PublishProductId AND ZPAE.ZnodeCatalogId = ZPPP.PublishCatalogId)

		End 

		----Delete addon entries having parent data present but all addon removed
		SELECT zppp1.PublishCatalogId,ZPPP1.PublishProductId,ZPPP.PublishProductId as AssociatedZnodeProductId  
		INTO #TempAddon
		FROM [ZnodePimAddOnProductDetail] AS ZPOPD
		INNER JOIN [ZnodePimAddOnProduct] AS ZPAOP ON ZPOPD.[PimAddOnProductId] = ZPAOP.[PimAddOnProductId]
		INNER JOIN ZnodePublishProduct ZPPP1 ON (ZPPP1.PimProductId = ZPAOP.PimProductId )
		INNER JOIN ZnodePublishProduct ZPPP ON (ZPPP.PimProductId = ZPOPD.PimChildProductId )

		UPDATE ZPAE 
		SET ElasticSearchEvent = 2
		FROM ZnodePublishAddonEntity ZPAE
		WHERE EXISTS (SELECT * from #TempAddon ZPPP
				WHERE ZPAE.ZnodeProductId = ZPPP.PublishProductId AND ZPAE.ZnodeCatalogId = ZPPP.PublishCatalogId)
		AND not EXISTS (SELECT * from #TempAddon ZPPP1
				WHERE ZPAE.AssociatedZnodeProductId = ZPPP1.AssociatedZnodeProductId AND ZPAE.ZnodeProductId = ZPPP1.PublishProductId  AND ZPAE.ZnodeCatalogId = ZPPP1.PublishCatalogId)

				
		UPDATE PCE SET PCE.AssociatedProductDisplayOrder = Isnull(CE.AssociatedProductDisplayOrder,0),
			PCE.GroupName = CE.GroupName,PCE.DisplayType = CE.DisplayType,
			PCE.DisplayOrder = CE.DisplayOrder,
			PCE.IsRequired = 1 ,PCE.RequiredType = CE.RequiredType,PCE.IsDefault = CE.IsDefault,
			PCE.ElasticSearchEvent = 2
		FROM #AddonProductPublishedXML CE
		INNER JOIN ZnodePublishAddonEntity PCE ON CE.VersionId = PCE.VersionId
		AND PCE.LocaleId = CE.LocaleId AND PCE.ZnodeCatalogId = CE.PublishCatalogId AND CE.ZnodeProductId = PCE.ZnodeProductId
		AND PCE.AssociatedZnodeProductId = CE.AssociatedZnodeProductId AND PCE.ElasticSearchEvent <> 2

		Insert into  ZnodePublishAddonEntity
		(VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,
			LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault,ElasticSearchEvent)
		Select 
			VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,Isnull(AssociatedProductDisplayOrder,0),
			LocaleId,GroupName,DisplayType,DisplayOrder,1 IsRequired,RequiredType,IsDefault, 1 AS ElasticSearchEvent
		from #AddonProductPublishedXML CE
		WHERE NOT EXISTS(SELECT * FROM ZnodePublishAddonEntity PCE WHERE CE.VersionId = PCE.VersionId
		AND PCE.LocaleId = CE.LocaleId AND PCE.ZnodeCatalogId = CE.PublishCatalogId AND CE.ZnodeProductId = PCE.ZnodeProductId
		AND PCE.AssociatedZnodeProductId = CE.AssociatedZnodeProductId AND PCE.ElasticSearchEvent <> 2)
		
		SET @Status = 1;
            
    END TRY
    BEGIN CATCH
		SELECT ERROR_MESSAGE(),ERROR_PROCEDURE()
            
        SET @Status = 0;
        DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishAssociatedAddonsJson @PublishCatalogId = '+@PublishCatalogId+',@VersionId='+CAST(@VersionId AS VARCHAR(50))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
        SELECT 0 AS ID,
            CAST(0 AS BIT) AS Status;
        EXEC Znode_InsertProcedureErrorLog
            @ProcedureName = 'Znode_GetPublishAssociatedAddonsJson',
            @ErrorInProcedure = @Error_procedure,
            @ErrorMessage = @ErrorMessage,
            @ErrorLine = @ErrorLine,
            @ErrorCall = @ErrorCall;
    END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdatePimCatalogProductDetailJson')
	DROP PROC Znode_InsertUpdatePimCatalogProductDetailJson
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdatePimCatalogProductDetailJson] 
(
	@PublishCatalogId INT = 0, 
	@LocaleId TransferId READONLY, 
	@UserId INT = 0,
	@IsDraftProductsOnly BIT = 1
)
AS 

--declare @LocaleId TransferId
--INSERT INTO @LocaleId
--SELECT 1
--exec [Znode_InsertUpdatePimCatalogProductDetailJson_New] @PublishCatalogId=8,@LocaleId=@LocaleId,@UserId=2,@IsDraftProductsOnly=1
--select * from ZnodePublishCatalog
--declare @LocaleId TransferId
--INSERT INTO @LocaleId
--SELECT 1
----union 
----SELECT 4
----union 
----SELECT 2
--exec [Znode_POC_InsertUpdatePimCatalogProductDetail] @PublishCatalogId=3,@LocaleId=@LocaleId,@UserId=2
BEGIN 
BEGIN TRY 

  SET NOCOUNT ON 
	   IF OBJECT_ID('tempdb..##AttributeValueLocale') IS NOT NULL
		DROP TABLE ##AttributeValueLocale

       DECLARE @LocaleId_In INT = 0 , @DefaultLocaleId INT = dbo.FN_GETDefaultLocaleId()
			   ,@Date DATETIME = dbo.fn_GetDate(),@IsActiveAttributeId int , @SKUAttributeId int
	   DECLARE @PimMediaAttributeId INT = dbo.Fn_GetProductImageAttributeId()		   

	   select @IsActiveAttributeId = PimAttributeId from ZnodePimAttribute where AttributeCode = 'IsActive'
	   select @SKUAttributeId = PimAttributeId from ZnodePimAttribute where AttributeCode = 'SKU'

	   CREATE TABLE #PimDefaultValueLocale  (PimAttributeDefaultJsonId INT  PRIMARY KEY ,PimAttributeDefaultValueId INT ,LocaleId INT, DefaultValueJson	nvarchar(max) )

	   CREATE TABLE ##AttributeValueLocale  (Id int Identity,  PimProductId INT, AttributeCode Varchar(300), AttributeValue varchar(max), AttributeEntity varchar(max), LocaleId int )
	   
	   --Creating indexes on temp table
	   CREATE INDEX Idx_#AttributeValueLocale_1 ON ##AttributeValueLocale(PimProductId,AttributeCode,LocaleId)
	   CREATE INDEX Idx_#AttributeValueLocale_2 ON [dbo].[##AttributeValueLocale] ([AttributeCode])
	   INCLUDE ([PimProductId],[AttributeValue],[LocaleId])

	   CREATE TABLE #ZnodePublishCategoryProduct
	   (
			PublishProductId INT,  PimAttributeId INT, PublishCatalogId INT, PimCategoryHierarchyId INT,PublishCategoryId INT, 
			PimAttributeValueId INT, CatalogName NVARCHAR(600),PimProductId INT,AttributeCode VARCHAR(600)
		)
		
		--CREATE INDEX #ZnodePublishCategoryProduct_2 ON #ZnodePublishCategoryProduct(PimAttributeId)
		--CREATE INDEX #ZnodePublishCategoryProduct_3 ON #ZnodePublishCategoryProduct(PimProductId,AttributeCode)
	   --SELECT PimProductId, PimAttributeId, PimAttributeValueId, ModifiedDate INTO ZnodePimAttributeValue FROM ZnodePimAttributeValue
	   --CREATE INDEX ZnodePimAttributeValue_PimAttributeValueId ON ZnodePimAttributeValue(PimAttributeValueId)
	   CREATE TABLE #ModifiedProducts1 (PublishProductId INT, PimCategoryHierarchyId INT,PimProductId INT)

	    --Fetching product SKU record which are active
	    Select ZPAV.PimProductId , ZPAVL.AttributeValue ,ZPAVL.LocaleId
		INTO  #VariantSKU 
		From ZnodePimAttributeValue ZPAV 
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON (ZPAV.PimAttributevalueid = ZPAVL.PimAttributeValueId )  
		Where ZPAV.PimAttributeId = @SKUAttributeId
		and exists(Select ZPAV.PimProductId From ZnodePimAttributeValue ZPAV1 INNER JOIN ZnodePimAttributeValueLocale ZPAVL1
				ON (ZPAV1.PimAttributevalueid = ZPAVL1.PimAttributeValueId AND ZPAVL1.AttributeValue = 'True')
				 Where ZPAV1.PimAttributeId = @IsActiveAttributeId and ZPAV.PimProductId = ZPAV1.PimProductId)
		AND EXISTS(SELECT * FROM @LocaleId L WHERE ZPAVL.LocaleId = L.Id)

		CREATE INDEX Idx_#VariantSKU ON #VariantSKU(PimProductId) INCLUDE(AttributeValue)

		--Getting last successful publish datetime
	    DECLARE @PublishModifiedDate Datetime
		SET @PublishModifiedDate =
		(SELECT TOP 1 ModifiedDate 
		FROM ZnodePublishCatalogLog 
		WHERE PublishCatalogId = @PublishCatalogId AND PublishStateId = (SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE StateName = 'Publish')
		ORDER BY ModifiedDate DESC)

		--SELECT ZPP1.PimProductId , ZPCPD.PublishProductId, ZPCPD.PublishCatalogId,PCL.ModifiedDate
		--INTO #ProductAttributeXML
		--FROM ZnodePublishProduct ZPP1
		--INNER JOIN ZnodePublishCatalogProductDetail ZPCPD ON ZPP1.PublishProductId = ZPCPD.PublishProductId AND ZPCPD.PublishCatalogId = ZPP1.PublishCatalogId 
		--CROSS APPLY #ZnodePublishCatalogLog PCL 
		--WHERE ZPCPD.PublishCatalogId =  @PublishCatalogId 

		--Getting publish product data with different category hierarchy
		SELECT ZPCC.PublishProductId , ZPCC.PublishCatalogId, ZPPC.PimCategoryHierarchyId, ZPPC.PublishCategoryId
		INTO #PublishCategoryProductData
		FROM ZnodePublishCategoryProduct ZPCC
		INNER JOIN ZnodePublishCategory ZPPC ON (ISNULL(ZPPC.PimCategoryHierarchyId,0) = ISNULL(ZPCC.PimCategoryHierarchyId,0) AND ZPPC.PublishCategoryId = ZPCC.PublishCategoryId)
		WHERE ZPCC.PublishCatalogId = @PublishCatalogId

		IF @IsDraftProductsOnly = 1
		BEGIN
			--All product of catalog updaing to draft as new locale is active
			IF (SELECT COUNT(*) FROM @LocaleId) <> (SELECT COUNT(DISTINCT LocaleId) FROM ZnodePublishProductEntity WHERE ZnodeCatalogId = @PublishCatalogId)
			BEGIN
				DECLARE @PublishStateIdForDraftState INT = dbo.Fn_GetPublishStateIdForDraftState()
				UPDATE ZPP SET PublishStateId = @PublishStateIdForDraftState
				FROM ZnodePimProduct ZPP
				WHERE EXISTS(SELECT * FROM ZnodePublishProduct ZPP1 WHERE ZPP.PimProductId = ZPP1.PimProductId AND ZPP1.PublishCatalogId = @PublishCatalogId)

			END

			---------- Products Attribute modified
			SELECT DISTINCT ZPP.PublishProductId,ZPP.PublishCatalogId, ZPP.PimProductId--,  ZPCC.PimCategoryHierarchyId 
			INTO #ModifiedProducts
			FROM ZnodePublishProduct  ZPP
			INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
			WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
			AND EXISTS(SELECT * FROM ZnodePimAttributeValue ZPAV
				INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = ZPAV.PimAttributeId)  WHERE (ZPAV.PimProductId = ZPP.PimProductId )
				AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId AND ZPFGM.PimAttributeId = ZPAV.PimAttributeId))
				AND ZPAV.ModifiedDate > @PublishModifiedDate)

			----------Attributes modified so considering all products associated to those attributes
			INSERT INTO #ModifiedProducts
			SELECT DISTINCT ZPP.PublishProductId,ZPP.PublishCatalogId, ZPP.PimProductId--,  ZPCC.PimCategoryHierarchyId 
			FROM ZnodePublishProduct  ZPP
			INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
			WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
			AND EXISTS(SELECT * FROM ZnodePimAttributeValue ZPAV
				INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = ZPAV.PimAttributeId)  WHERE (ZPAV.PimProductId = ZPP.PimProductId )
				AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId AND ZPFGM.PimAttributeId = ZPAV.PimAttributeId))
				AND ZPA.ModifiedDate > @PublishModifiedDate)
			
			-------- Products not published  
			INSERT INTO #ModifiedProducts
			SELECT ZPP.PublishProductId,ZPP.PublishCatalogId,ZPP.PimProductId
			FROM ZnodePublishProduct  ZPP
			INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
			WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
			AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId ))--AND ZPFGM.PimAttributeId = ZPAV.PimAttributeId))
			AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 INNER JOIN ZnodePublishState ZPS ON ZPP1.PublishStateId = ZPS.PublishStateId
						WHERE StateName <> 'Publish' AND ZPP.PimProductId = ZPP1.PimProductId )	
			AND NOT EXISTS(SELECT * FROM #ModifiedProducts X WHERE ZPP.PublishProductId = X.PublishProductId)
			
			-------- Products associated to catalog or category or modified catalog category products
			INSERT INTO #ModifiedProducts		
			SELECT ZPP.PublishProductId,ZPP.PublishCatalogId,ZPP.PimProductId
			FROM ZnodePublishProduct  ZPP
			INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
			INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZPP.PublishCatalogId)
			WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
			AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId ))--AND ZPFGM.PimAttributeId = ZPAV.PimAttributeId))
			AND EXISTS(SELECT * FROM ZnodePimCategoryProduct ZPCC1 WHERE  ZPP.PimProductId = ZPCC1.PimProductId  
				AND ZPCC1.ModifiedDate>@PublishModifiedDate)
			AND NOT EXISTS(SELECT * FROM #ModifiedProducts X WHERE ZPP.PublishProductId = X.PublishProductId)

			---------- Link Product modified
			INSERT INTO #ModifiedProducts	
			SELECT ZPP.PublishProductId,ZPP.PublishCatalogId,ZPP.PimProductId
			FROM ZnodePublishProduct  ZPP
			INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
			WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
			AND EXISTS(SELECT * FROM ZnodePimLinkProductDetail ZPAV WHERE (ZPAV.PimParentProductId = ZPP.PimProductId ) 
				AND  ZPAV.ModifiedDate> @PublishModifiedDate )
			AND NOT EXISTS(SELECT * FROM #ModifiedProducts X WHERE ZPP.PublishProductId = X.PublishProductId)

							
			------Associated child Products (varients, Group) not published	
			INSERT INTO #ModifiedProducts	
			SELECT ZPP.PublishProductId,ZPP.PublishCatalogId,ZPP.PimProductId
			FROM ZnodePublishProduct  ZPP
			INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
			WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
			AND EXISTS(SELECT * FROM ZnodePimProductTypeAssociation ZPAV WHERE (ZPAV.PimProductId = ZPP.PimProductId ) 
				AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 INNER JOIN ZnodePublishState ZPS ON ZPP1.PublishStateId = ZPS.PublishStateId
						WHERE StateName <> 'Publish' AND ZPAV.PimProductId = ZPP1.PimProductId ))
			AND NOT EXISTS(SELECT * FROM #ModifiedProducts X WHERE ZPP.PublishProductId = X.PublishProductId)
			
			--------Link child Products (Bundle) not published 	
			INSERT INTO #ModifiedProducts
			SELECT ZPP.PublishProductId,ZPP.PublishCatalogId,ZPP.PimProductId
			FROM ZnodePublishProduct  ZPP
			INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
			WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
			AND EXISTS(SELECT * FROM ZnodePimLinkProductDetail ZPAV WHERE (ZPAV.PimProductId = ZPP.PimProductId )
				AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 INNER JOIN ZnodePublishState ZPS ON ZPP1.PublishStateId = ZPS.PublishStateId
						WHERE StateName <> 'Publish' AND ZPAV.PimProductId = ZPP1.PimProductId ))
			AND NOT EXISTS(SELECT * FROM #ModifiedProducts X WHERE ZPP.PublishProductId = X.PublishProductId)

			----Getting products of newly added category hierarchy 
			INSERT INTO #ModifiedProducts		
			SELECT ZPP.PublishProductId,ZPP.PublishCatalogId,ZPP.PimProductId
			FROM ZnodePublishProduct  ZPP
			INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
			INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZPP.PublishCatalogId)
			WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
			AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId ))--AND ZPFGM.PimAttributeId = ZPAV.PimAttributeId))
			AND EXISTS(SELECT * FROM ZnodePimCategoryProduct ZPCC1  
					INNER JOIN ZnodePimCategoryHierarchy ZPCH ON ZPCC1.PimCategoryId = ZPCH.PimCategoryId AND ZPC.PimCatalogId = ZPCH.PimCatalogId  
					WHERE ZPP.PimProductId = ZPCC1.PimProductId 
					AND ZPCH.ModifiedDate > @PublishModifiedDate)
			AND NOT EXISTS(SELECT * FROM #ModifiedProducts X WHERE ZPP.PublishProductId = X.PublishProductId)
			
			SELECT ZnodeProductId, ZnodeCatalogId
			INTO #TempPublishProductEntity
			FROM ZnodePublishProductEntity
			WHERE ZnodeCatalogId = @PublishCatalogId

			IF EXISTS(SELECT * FROM #TempPublishProductEntity)
			BEGIN
				CREATE INDEX Id_#TempPublishProductEntity ON #TempPublishProductEntity(ZnodeProductId,ZnodeCatalogId)
				--Getting product data which are associated with catalog and not present in product entity table
				INSERT INTO #ModifiedProducts		
				SELECT ZPP.PublishProductId,ZPP.PublishCatalogId,ZPP.PimProductId
				FROM ZnodePublishProduct ZPP
				INNER JOIN ZnodePublishCatalogProductDetail ZPCPD ON ZPP.PublishProductId = ZPCPD.PublishProductId AND ZPP.PublishCatalogId = ZPCPD.PublishCatalogId
				WHERE NOT EXISTS(SELECT * FROM #TempPublishProductEntity b where b.ZnodeProductId= ZPCPD.PublishProductId AND B.ZnodeCatalogId = ZPCPD.PublishCatalogId )
				AND NOT EXISTS(SELECT * FROM #ModifiedProducts X WHERE ZPP.PublishProductId = X.PublishProductId)
			END

			--Fetching pimcategoryhierarchyid for published product
			INSERT INTO #ModifiedProducts1(PublishProductId, PimCategoryHierarchyId,PimProductId)
			SELECT DISTINCT ZPP.PublishProductId, ZPCC.PimCategoryHierarchyId,ZPP.PimProductId
			FROM #ModifiedProducts ZPP
			LEFT JOIN #PublishCategoryProductData ZPCC  ON (ZPP.PublishProductId = ZPCC.PublishProductId AND ZPCC.PublishCatalogId = ZPP.PublishCatalogId )
			
			---------------------Category associated to catalog or category or modified catalog
			SELECT ZPCH.PimCategoryId, ZPC1.PublishCategoryId, ZPCH.PimCategoryHierarchyId
			INTO #ModifiedCategory1
			FROM ZnodePimCategoryHierarchy ZPCH 
			INNER JOIN ZnodePublishCategory ZPC1 ON ZPCH.PimCategoryId = ZPC1.PimCategoryId 
			WHERE ZPC1.PublishCatalogId =  @PublishCatalogId 
			AND EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogProductDetail BTM  
			WHERE BTM.PublishCatalogId = ZPC1.PublishCatalogId AND (BTM.ModifiedDate < ZPCH.ModifiedDate )   )
			AND NOT EXISTS(SELECT * FROM #ModifiedProducts1 MP WHERE  ISNULL(ZPCH.PimCategoryHierarchyId,0) = ISNULL(MP.PimCategoryHierarchyId,0))

			--INSERT INTO #ModifiedProducts1(PublishProductId, PimCategoryHierarchyId,PimProductId)	
			--SELECT BTM.PublishProductId, BTM.PimCategoryHierarchyId, ZPP.PimProductId
			--FROM ZnodePublishCatalogProductDetail BTM  
			--INNER JOIN ZnodePublishProduct ZPP ON BTM.PublishProductId = ZPP.PublishProductId AND BTM.PublishCatalogId = ZPP.PublishCatalogId
			--WHERE BTM.PublishCatalogId = @PublishCatalogId AND ISNULL(BTM.IsNotPublish,0) = 1
			
			IF EXISTS(SELECT TOP 1 1 FROM #ModifiedCategory1 )
			BEGIN
				-------- Category associated to catalog or category or modified catalog
				INSERT INTO #ModifiedProducts1		
				SELECT ZPP.PublishProductId,  ZPCC.PimCategoryHierarchyId,ZPP.PimProductId 
				FROM ZnodePublishProduct  ZPP
				INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
				INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZPP.PublishCatalogId)
				INNER JOIN ZnodePimCategoryProduct ZPCC1 ON  ZPP.PimProductId = ZPCC1.PimProductId 
				INNER JOIN ZnodePimCategoryHierarchy ZPCH ON ZPCC1.PimCategoryId = ZPCH.PimCategoryId AND ZPC.PimCatalogId = ZPCH.PimCatalogId 
				LEFT JOIN #PublishCategoryProductData ZPCC  ON (ZPP.PublishProductId = ZPCC.PublishProductId AND ZPCC.PublishCatalogId = ZPP.PublishCatalogId)
				WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
				AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId ))
				AND EXISTS (SELECT TOP 1 1 FROM #ModifiedCategory1 BTM WHERE BTM.PimCategoryHierarchyId = ZPCH.PimCategoryHierarchyId  )
				AND NOT EXISTS(SELECT * FROM #ModifiedProducts1 X WHERE ZPP.PublishProductId = X.PublishProductId)
				------------------
			END
			
			--CREATE INDEX #ModifiedProducts1_PublishProductId ON #ModifiedProducts1(PublishProductId,PimCategoryHierarchyId)	
			--Getting all products of catalog for publish which are modified after last publish
			INSERT INTO #ZnodePublishCategoryProduct (PublishProductId,  PimAttributeId, PublishCatalogId , PimCategoryHierarchyId , PublishCategoryId,
					   PimAttributeValueId, CatalogName ,PimProductId ,AttributeCode)
			SELECT ZPP.PublishProductId,  ZPAV.PimAttributeId, ZPP.PublishCatalogId , ZPCC.PimCategoryHierarchyId , ZPCC.PublishCategoryId
					,ZPAV.PimAttributeValueId, ZPC.CatalogName--,CASE WHEN ZPCC.PublishProductId IS NULL THEN 1 ELSE  dense_rank()Over(ORDER BY ZPCC.PimCategoryHierarchyId,ZPCC.PublishProductId) END  ProductIndex 	
					,ZPP.PimProductId ,ZPA.AttributeCode				
			FROM ZnodePublishProduct  ZPP
			INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
			INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimProductId = ZPP.PimProductId )
			INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = ZPAV.PimAttributeId)
			INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZPP.PublishCatalogId)
			LEFT JOIN #PublishCategoryProductData ZPCC  ON (ZPP.PublishProductId = ZPCC.PublishProductId AND ZPCC.PublishCatalogId = ZPP.PublishCatalogId)
			WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
			AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId AND ZPFGM.PimAttributeId = ZPAV.PimAttributeId))
			AND EXISTS (SELECT * FROM #ModifiedProducts1 MP WHERE ZPP.PublishProductId = MP.PublishProductId  ) 

		END
		ELSE 
		BEGIN	
			--Getting all products of catalog for publish first time 
			INSERT INTO #ZnodePublishCategoryProduct(PublishProductId,  PimAttributeId, PublishCatalogId , PimCategoryHierarchyId , PublishCategoryId,
				   PimAttributeValueId, CatalogName ,PimProductId ,AttributeCode)
			SELECT ZPP.PublishProductId,  ZPAV.PimAttributeId, ZPP.PublishCatalogId , ZPCC.PimCategoryHierarchyId , ZPCC.PublishCategoryId,
				   ZPAV.PimAttributeValueId, ZPC.CatalogName ,ZPP.PimProductId ,ZPA.AttributeCode				
			FROM ZnodePublishProduct  ZPP
			INNER JOIN ZnodePimProduct ZPPI ON (ZPPI.PimProductId = ZPP.PimProductId)
			INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimProductId = ZPP.PimProductId )
			INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = ZPAV.PimAttributeId)
			INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZPP.PublishCatalogId)
			LEFT JOIN #PublishCategoryProductData ZPCC  ON (ZPP.PublishProductId = ZPCC.PublishProductId AND ZPCC.PublishCatalogId = ZPP.PublishCatalogId)
			WHERE ZPP.PublishCatalogId =  @PublishCatalogId 
			AND EXISTS(SELECT * FROM ZnodePimFamilyGroupMapper ZPFGM WHERE (ZPFGM.PimAttributeFamilyId = ZPPI.PimAttributeFamilyId AND ZPFGM.PimAttributeId = ZPAV.PimAttributeId))
			--AND EXISTS(SELECT * FROM ZnodePimCategoryProduct ZPCP Inner Join ZnodePimCategoryHierarchy ZPCH ON ZPCP.PimCategoryId = ZPCH.PimCategoryId
			--WHERE ZPCP.PimProductId = ZPP.PimProductId AND ZPCH.PimCatalogId = ZPC.PimCatalogId)
		
			--Fetching pimcategoryhierarchyid
			INSERT INTO #ModifiedProducts1(PublishProductId, PimCategoryHierarchyId,PimProductId)
			SELECT DISTINCT PublishProductId, PimCategoryHierarchyId,PimProductId
			FROM #ZnodePublishCategoryProduct ZPCC 
			
		END
		
		CREATE INDEX #ModifiedProducts1_PimProductId ON #ModifiedProducts1(PimProductId)

		SELECT ZPAV.PimProductId, ZPP.PublishProductId, ZPAV.LocaleId
		into #ProductLocaleWise
		FROM #VariantSKU ZPAV
		INNER JOIN ZnodePublishProduct ZPP on ZPAV.PimProductId = ZPP.PimProductId
		WHERE EXISTS(SELECT * FROM @LocaleId L WHERE ZPAV.LocaleId = L.Id)
		AND ZPP.PublishCatalogId = @PublishCatalogId

		IF (SELECT COUNT(*) FROM @LocaleId) > 1
		BEGIN
			INSERT INTO #ProductLocaleWise(PimProductId,PublishProductId,LocaleId)
			SELECT a.PimProductId,a.PublishProductId,b.Id
			FROM #ProductLocaleWise a
			CROSS APPLY @LocaleId b 
			WHERE LocaleId = @DefaultLocaleId
			AND b.Id <> @DefaultLocaleId
			AND NOT EXISTS(select * from #ProductLocaleWise c where a.PimProductId = c.PimProductId and c.LocaleId = b.Id)
		END

		------------
		Select Distinct PimProductId,PublishProductId, PublishCatalogId ,PublishCategoryId,CatalogName,PimCategoryHierarchyId
	    into #ZnodePublishCategoryProductForValidation from #ZnodePublishCategoryProduct

		
		CREATE INDEX #ZnodePublishCategoryProductForValidation_PimProductId ON #ZnodePublishCategoryProductForValidation(PimProductId)

		CREATE INDEX IDX_#ZnodePublishCategoryProduct_1 ON #ZnodePublishCategoryProduct(PimProductId)
		
		CREATE INDEX IDX_#ZnodePublishCategoryProduct_3 ON #ZnodePublishCategoryProduct(PublishCategoryId)

		--
		

		------Getting All Link Product Details
		SELECT ZPLPD.PimParentProductId, ZPLPD.PimProductId, ZPLPD.PimAttributeId, ZPAV.AttributeValue as SKU
		INTO #LinkProduct
		FROM ZnodePimLinkProductDetail ZPLPD 
		INNER JOIN #VariantSKU ZPAV ON (ZPAV.PimProductId = ZPLPD.PimProductId)
		WHERE EXISTS(SELECT * FROM #ModifiedProducts1 X WHERE X.PimProductId = ZPLPD.PimParentProductId)
		
		CREATE INDEX #LinkProduct_1 ON #LinkProduct(PimParentProductId,PimAttributeId)
		
		----Getting products link product value entity
	     INSERT INTO ##AttributeValueLocale ( PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId )
	     SELECT ZPLP.PimParentProductId ,ZPAX.AttributeCode, '' AttributeValue , 
		 JSON_MODIFY( JSON_Modify(ZPAX.AttributeJson , '$.AttributeValues' , 
		 ISNULL(SUBSTRING ( (SELECT ','+cast( LP.SKU as varchar(600))
							FROM #LinkProduct LP
							WHERE LP.PimParentProductId = ZPLP.PimParentProductId 
							AND LP.PimAttributeId = ZPLP.PimAttributeId FOR XML PATH('')),2,8000),'') ),'$.SelectValues',Json_Query('[]'))   

							, ZPAX.LocaleId
		 FROM ZnodePimLinkProductDetail ZPLP
		 INNER JOIN ZnodePimAttributeJSON ZPAX ON (ZPAX.PimAttributeId = ZPLP.PimAttributeId )
		 WHERE EXISTS(SELECT * FROM #ZnodePublishCategoryProductForValidation PPCP  WHERE (ZPLP.PimParentProductId = PPCP.PimProductId ))
		 AND EXISTS(SELECT * FROM @LocaleId L WHERE ZPAX.LocaleId = L.Id)
		 GROUP BY ZPLP.PimParentProductId ,ZPAX.AttributeCode , ZPAX.AttributeJSON,ZPAX.LocaleId,ZPAX.AttributeCode,ZPLP.PimAttributeId
		
		----Getting product attribute value entity 
		SELECT PPCP.PimProductId , ZPA.AttributeCode,
		ISNULL(ZPAVL.AttributeValue,'') AttributeValue,
		ZPAVL.LocaleId,ZPA.PimAttributeId---,ZPAX.AttributeJSON
		into #ZnodePimAttributeValueLocale
		FROM ZnodePimAttributeValue PPCP
		INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = PPCP.PimAttributeId)
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON (PPCP.PimAttributeValueId =ZPAVL.PimAttributeValueId)
		WHERE EXISTS(SELECT * FROM #ZnodePublishCategoryProductForValidation PPCP1  WHERE PPCP1.PimProductId = PPCP.PimProductId)
		AND NOT EXISTS(select * from ZnodePimConfigureProductAttribute UOP where PPCP.PimProductId = UOP.PimProductId AND PPCP.PimAttributeId = UOP.PimAttributeId)

		create index #ZnodePimAttributeValueLocale_1 on #ZnodePimAttributeValueLocale(PimProductId,AttributeCode,LocaleId)
		create index #ZnodePimAttributeValueLocale_2 on #ZnodePimAttributeValueLocale(PimAttributeId)
		
		SELECT ZPAVL.PimProductId , ZPAVL.AttributeCode,ZPAVL.AttributeValue ,
				JSON_MODIFY(
				JSON_MODIFY (Json_Query( ZPAX.AttributeJSON  ) , '$.AttributeValues' ,  ISNULL(ZPAVL.AttributeValue,'') )    
				,'$.SelectValues',Json_Query('[]'))   
				AS 'AttributeEntity'
				, 
				ZPAVL.LocaleId
		INTO #TempValueLocale
		FROM #ZnodePimAttributeValueLocale ZPAVL  
		INNER JOIN ZnodePimAttributeJSON ZPAX ON (ZPAX.PimAttributeId = ZPAVL.PimAttributeId and ZPAX.LocaleId = ZPAVL.LocaleId)
		WHERE EXISTS(Select Id from @LocaleId x where ZPAVL.LocaleId = x.Id) 
		AND NOT EXISTS(select * from ##AttributeValueLocale AVL where ZPAVL.PimProductId = AVL.PimProductId and ZPAVL.AttributeCode = AVL.AttributeCode and ZPAVL.LocaleId = AVL.LocaleId )
		
		
		----Creating products attribute wise json of attribute value entity
		INSERT INTO ##AttributeValueLocale ( PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId )
		SELECT PimProductId,AttributeCode,AttributeValue,AttributeEntity,LocaleId
		FROM #TempValueLocale

		 IF (SELECT COUNT(*) from @LocaleId) > 1
		 BEGIN
				----Getting product attribute value entity getting for other locale with default attribute json
				  INSERT INTO ##AttributeValueLocale ( PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId )
				  SELECT ZPAVL.PimProductId , ZPAVL.AttributeCode,ZPAVL.AttributeValue ,
							JSON_MODIFY(
							JSON_MODIFY (Json_Query( ZPAX.AttributeJSON  ) , '$.AttributeValues' ,  ISNULL(ZPAVL.AttributeValue,'') )    
							,'$.SelectValues',Json_Query('[]'))   
							AS 'AttributeEntity', 
						 ZPAVL.LocaleId
				  FROM #ZnodePimAttributeValueLocale ZPAVL 
				  INNER JOIN ZnodePimAttributeJSON ZPAX ON (ZPAX.PimAttributeId = ZPAVL.PimAttributeId AND ZPAX.LocaleId = @DefaultLocaleId)
				  WHERE ZPAX.LocaleId = @DefaultLocaleId AND ZPAVL.LocaleId <> @DefaultLocaleId 
				  AND EXISTS(SELECT * FROM @LocaleId L WHERE ZPAVL.LocaleId = L.Id) 
				  AND NOT EXISTS(SELECT * FROM ##AttributeValueLocale AVL where ZPAVL.PimProductId = AVL.PimProductId and ZPAVL.AttributeCode = AVL.AttributeCode and ZPAVL.LocaleId = AVL.LocaleId )
		END
			
		IF OBJECT_ID('TEMPDB..#ZnodePublishCatalogProductDetail') IS NOT NULL
			DROP TABLE #ZnodePublishCatalogProductDetail

		IF OBJECT_ID('TEMPDB..#ZnodePublishCatalogProductDetail1') IS NOT NULL
			DROP TABLE #ZnodePublishCatalogProductDetail1

		IF OBJECT_ID('TEMPDB..#TBL_ProductRequiredAttribute') IS NOT NULL
			DROP TABLE #TBL_ProductRequiredAttribute
		  
		CREATE TABLE #TBL_ProductRequiredAttribute (PimProductId INT,SKU VARCHAR(600),ProductName VARCHAR(600), IsActive VARCHAR(10), LocaleId INT)

		--Getting disctinct products locale wise
		INSERT INTO #TBL_ProductRequiredAttribute(PimProductId, LocaleId)
		SELECT DISTINCT PimProductId, LocaleId FROM ##AttributeValueLocale

		--Updating SKU
		UPDATE #TBL_ProductRequiredAttribute 
		SET SKU = b.AttributeValue
		FROM #TBL_ProductRequiredAttribute a
		INNER JOIN ##AttributeValueLocale b ON a.PimproductId = b.PimProductId AND a.LocaleId = b.LocaleId
		WHERE b.AttributeCode = 'SKU'

		--Updating ProductName
		UPDATE #TBL_ProductRequiredAttribute 
		SET ProductName = b.AttributeValue
		FROM #TBL_ProductRequiredAttribute a
		INNER JOIN ##AttributeValueLocale b ON a.PimproductId = b.PimProductId AND a.LocaleId = b.LocaleId
		WHERE b.AttributeCode = 'ProductName'

		--Updating IsActive
		UPDATE #TBL_ProductRequiredAttribute 
		SET IsActive = b.AttributeValue
		FROM #TBL_ProductRequiredAttribute a
		INNER JOIN ##AttributeValueLocale b ON a.PimproductId = b.PimProductId AND a.LocaleId = b.LocaleId
		WHERE b.AttributeCode = 'IsActive'

		  --CREATE INDEX IDX_#TBL_ProductRequiredAttribute_PimProductId ON #TBL_ProductRequiredAttribute(PimProductId)	  
		  SELECT ZPI.PublishProductId, ZPI.PublishCatalogId ,TYU.PublishCategoryId,ZPI.CatalogName,ISNULL(ZPI.PimCategoryHierarchyId,0) PimCategoryHierarchyId
					,TPAR.SKU,TPAR.ProductName,TPAR.IsActive,TYU.PublishCategoryName CategoryName,ISNULL(TYU.LocaleId,TPAR.LocaleId) as LocaleId
		   INTO #ZnodePublishCatalogProductDetail
		   FROM #ZnodePublishCategoryProduct ZPI
		   INNER JOIN #TBL_ProductRequiredAttribute TPAR ON (TPAR.PimProductId = ZPI.PimProductId )
		   LEFT JOIN ZnodePublishCategoryDetail TYU ON (TYU.PublishCategoryId = ZPI.PublishCategoryId AND TPAR.LocaleId = TYU.LocaleId )
		   GROUP BY PublishProductId, PublishCatalogId ,TYU.PublishCategoryId,CatalogName,PimCategoryHierarchyId
					,SKU,ProductName,TPAR.IsActive,PublishCategoryName, TYU.LocaleId, TPAR.LocaleId
  
			CREATE INDEX IDX_#ZnodePublishCatalogProductDetail ON #ZnodePublishCatalogProductDetail(PublishProductId,PublishCatalogId,PimCategoryHierarchyId,LocaleId)

			--Creating product index
			SELECT PublishProductId,PublishCatalogId,PimCategoryHierarchyId,SKU,ProductName,CategoryName, CatalogName, LocaleId ,IsActive
			      ,CASE WHEN PublishProductId IS NULL THEN 1 ELSE Row_Number()Over(Partition by PublishCatalogId,PublishProductId,LocaleId ORDER BY PublishProductId,PimCategoryHierarchyId,LocaleId) END  ProductIndex
			INTO #ZnodePublishCatalogProductDetail1
			FROM #ZnodePublishCatalogProductDetail Temp
			WHERE EXISTS(SELECT * FROM #ProductLocaleWise PL WHERE Temp.PublishProductId = PL.PublishProductId)
			  
			--Getting locale wise product which are not present for other locale (other than default locale)  
			INSERT INTO #ZnodePublishCatalogProductDetail1 (PublishProductId,PublishCatalogId,PimCategoryHierarchyId,SKU,ProductName,CategoryName, CatalogName, LocaleId ,IsActive,ProductIndex)
			SELECT PublishProductId,PublishCatalogId,PimCategoryHierarchyId,SKU,ProductName,CategoryName, CatalogName, b.Id ,IsActive,ProductIndex
			FROM #ZnodePublishCatalogProductDetail1 a
			CROSS APPLY @LocaleId b 
			WHERE NOT EXISTS(SELECT * FROM #ZnodePublishCatalogProductDetail1 c WHERE a.PublishProductId = c.PublishProductId AND b.Id = c.LocaleId  )
			AND a.LocaleId = @DefaultLocaleId 
			AND a.PublishCatalogId = @PublishCatalogId

			----Deleting product data which are not present
			--DELETE ZPCPD 
			--FROM ZnodePublishCatalogProductDetail ZPCPD
			--WHERE NOT EXISTS(SELECT * FROM #ProductLocaleWise ZPCPD1 WHERE ZPCPD.PublishProductId = ZPCPD1.PublishProductId 
			--                 AND ZPCPD.LocaleId = ZPCPD1.LocaleId )  
			--AND ZPCPD.PublishCatalogId = @PublishCatalogId
			
			--Deleting product data which are not present in category hierarchy
			DELETE ZPCPD 
			FROM ZnodePublishCatalogProductDetail ZPCPD
			WHERE EXISTS(SELECT * FROM #ZnodePublishCatalogProductDetail ZPCPD1 WHERE 
						ZPCPD.PublishProductId = ZPCPD1.PublishProductId 
			            AND ZPCPD.LocaleId = ZPCPD1.LocaleId 
						AND ISNULL(ZPCPD1.PimCategoryHierarchyId,0)  <> 0 ) AND ZPCPD.PimCategoryHierarchyId =0
			AND ZPCPD.PublishCatalogId = @PublishCatalogId
			
			create index #ZnodePublishCatalogProductDetail1_1 on #ZnodePublishCatalogProductDetail1(SKU,LocaleId)
			create index #ZnodePublishCatalogProductDetail1_2 on #ZnodePublishCatalogProductDetail1(PublishProductId,PublishCatalogId,PimCategoryHierarchyId,LocaleId)
			----Update data ZnodePublishCatalogProductDetail 
			UPDATE TARGET
			SET  TARGET.ProductIndex	=SOURCE.ProductIndex
				,TARGET.SKU = SOURCE.SKU
				,TARGET.ModifiedBy		= @UserId	
				,TARGET.ModifiedDate	= @Date
			FROM ZnodePublishCatalogProductDetail TARGET
			INNER JOIN #ZnodePublishCatalogProductDetail1 SOURCE
			ON (
		        SOURCE.PublishProductId = TARGET.PublishProductId
				AND SOURCE.PublishCatalogId = TARGET.PublishCatalogId 
				AND ISNULL(SOURCE.PimCategoryHierarchyId,0) = ISNULL(TARGET.PimCategoryHierarchyId,0)
				AND SOURCE.LocaleId = TARGET.LocaleId --@LocaleId_In
				)
			WHERE TARGET.PublishCatalogId = @PublishCatalogId

			----Update data ZnodePublishCatalogProductDetail 
			UPDATE TARGET
			SET  
				TARGET.ProductName		=SOURCE.ProductName
				,TARGET.CatalogName		=SOURCE.CatalogName
				,TARGET.IsActive		=case when SOURCE.IsActive in ('0','false') then 0 else 1 end 
				,TARGET.ModifiedBy		= @UserId	
				,TARGET.ModifiedDate	= @Date
			FROM ZnodePublishCatalogProductDetail TARGET
			INNER JOIN #ZnodePublishCatalogProductDetail1 SOURCE
			ON (
		        TARGET.SKU = SOURCE.SKU
				AND SOURCE.LocaleId = TARGET.LocaleId --@LocaleId_In
				)
			WHERE TARGET.PublishCatalogId = @PublishCatalogId

			
		----Update data ZnodePublishCatalogProductDetail 
		UPDATE TARGET
		SET  
			TARGET.CategoryName	=SOURCE.CategoryName
			,TARGET.ModifiedBy		= @UserId	
			,TARGET.ModifiedDate	= @Date
		FROM ZnodePublishCatalogProductDetail TARGET
		INNER JOIN #ZnodePublishCatalogProductDetail1 SOURCE
		ON (
		    TARGET.SKU = SOURCE.SKU
			AND SOURCE.LocaleId = TARGET.LocaleId 
			AND ISNULL(SOURCE.PimCategoryHierarchyId,0) = ISNULL(TARGET.PimCategoryHierarchyId,0)
			)
		WHERE ISNULL(TARGET.PimCategoryHierarchyId,0) <> 0
		AND TARGET.PublishCatalogId = @PublishCatalogId

		----Insert data ZnodePublishCatalogProductDetail 
		INSERT INTO ZnodePublishCatalogProductDetail
			( PublishProductId,PublishCatalogId,PimCategoryHierarchyId,SKU,ProductName,CategoryName, CatalogName,
				LocaleId ,IsActive,ProductIndex,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
		SELECT SOURCE.PublishProductId ,SOURCE.PublishCatalogId ,SOURCE.PimCategoryHierarchyId ,SOURCE.SKU ,SOURCE.ProductName
		,SOURCE.CategoryName ,SOURCE.CatalogName ,SOURCE.LocaleId ,SOURCE.IsActive ,SOURCE.ProductIndex ,@UserId ,@Date ,@UserId ,@Date
		FROM #ZnodePublishCatalogProductDetail1 SOURCE
		WHERE NOT EXISTS(SELECT * FROM ZnodePublishCatalogProductDetail TARGET WHERE SOURCE.PublishProductId = TARGET.PublishProductId
						AND SOURCE.PublishCatalogId = TARGET.PublishCatalogId 
						AND SOURCE.PimCategoryHierarchyId = TARGET.PimCategoryHierarchyId 
						AND TARGET.LocaleId = SOURCE.LocaleId )
		AND SOURCE.PublishCatalogId = @PublishCatalogId
				
		----Inserting product data for other locale		  
		INSERT INTO ZnodePublishCatalogProductDetail (PublishProductId,PublishCatalogId,PimCategoryHierarchyId,SKU,ProductName,CategoryName, CatalogName,
				LocaleId ,IsActive,ProductIndex,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT PublishProductId,PublishCatalogId,PimCategoryHierarchyId,SKU,ProductName,CategoryName, CatalogName,
				b.Id ,IsActive,ProductIndex,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		FROM ZnodePublishCatalogProductDetail a
		CROSS APPLY @LocaleId b 
		WHERE NOT EXISTS(SELECT * FROM ZnodePublishCatalogProductDetail c WHERE a.PublishProductId = c.PublishProductId AND b.Id = c.LocaleId  )
		AND a.LocaleId = @DefaultLocaleId
		AND a.PublishCatalogId = @PublishCatalogId
		
		DELETE ZPCPD FROM ZnodePublishCatalogProductDetail ZPCPD
		INNER JOIN ZnodePublishProduct ZPD ON ZPCPD.PublishProductId = ZPD.PublishProductId AND ZPCPD.PublishCatalogId = ZPD.PublishCatalogId
		INNER JOIN ZnodePublishCatalog ZPC ON ZPCPD.PublishCatalogId = ZPC.PublishCatalogId
		WHERE NOT EXISTS(SELECT * FROM ZnodePimCategoryProduct ZPCC 
			    INNER JOIN ZnodePimCategoryHierarchy ZPCH ON ZPCC.PimCategoryId = ZPCH.PimCategoryId WHERE ZPD.PimProductId = ZPCC.PimProductId AND ZPC.PimCatalogId = ZPCH.PimCatalogId AND ZPCPD.PimCategoryHierarchyId = ZPCH.PimCategoryHierarchyId)
		AND ZPCPD.PimCategoryHierarchyId <> 0
		AND ZPCPD.PublishCatalogId = @PublishCatalogId
		
		----Updating the SKU into table ZnodePublishCatalogProductDetail
		UPDATE ZnodePublishCatalogProductDetail 
		SET SKU = b.AttributeValue
		FROM ZnodePublishCatalogProductDetail a
		INNER JOIN ZnodePublishProduct ZPP ON a.PublishProductId = ZPP.PublishProductId
		INNER JOIN ##AttributeValueLocale b ON ZPP.PimproductId = b.PimProductId AND a.LocaleId = b.LocaleId
		WHERE b.AttributeCode = 'SKU'
		AND a.PublishCatalogId = @PublishCatalogId

		----Updating the ProductName into table ZnodePublishCatalogProductDetail
		UPDATE ZnodePublishCatalogProductDetail 
		SET ProductName = b.AttributeValue
		FROM ZnodePublishCatalogProductDetail a
		INNER JOIN ZnodePublishProduct ZPP ON a.PublishProductId = ZPP.PublishProductId
		INNER JOIN ##AttributeValueLocale b ON ZPP.PimproductId = b.PimProductId AND a.LocaleId = b.LocaleId
		WHERE b.AttributeCode = 'ProductName'
		AND a.PublishCatalogId = @PublishCatalogId

		----Updating the IsActive into table ZnodePublishCatalogProductDetail
		UPDATE ZnodePublishCatalogProductDetail 
		SET IsActive = b.AttributeValue
		FROM ZnodePublishCatalogProductDetail a
		INNER JOIN ZnodePublishProduct ZPP ON a.PublishProductId = ZPP.PublishProductId
		INNER JOIN ##AttributeValueLocale b ON ZPP.PimproductId = b.PimProductId AND a.LocaleId = b.LocaleId
		WHERE b.AttributeCode = 'IsActive'
		AND a.PublishCatalogId = @PublishCatalogId
		
		---- To clean Older Hierarchies associations.
		DELETE ZPCPD
		FROM ZnodePublishCatalogProductDetail ZPCPD
		WHERE NOT EXISTS (select top 1 1 from ZnodePimCategoryHierarchy ZPCH where (ZPCPD.PimCategoryHierarchyId = ZPCH.PimCategoryHierarchyId))
		AND ISNULL(ZPCPD.PimCategoryHierarchyId,0) <>0
		
		SELECT a.PimProductId,  a.PimAttributeId, a.PimAttributeValueId, b.PimAttributeDefaultValueId, b.LocaleId
		INTO #PimProductAttributeDefaultValue
		FROM ZnodePimAttributeValue a 
		INNER JOIN ZnodePimProductAttributeDefaultValue b ON a.PimAttributeValueId = b.PimAttributeValueId 
		WHERE EXISTS(SELECT * FROM #ZnodePublishCategoryProductForValidation X WHERE X.PimProductId = a.PimProductId)
		
		CREATE INDEX Idx_#PimProductAttributeDefaultValue ON #PimProductAttributeDefaultValue (PimProductId,PimAttributeId)
		--CREATE INDEX Idx_#PimProductAttributeDefaultValue_1 ON #PimProductAttributeDefaultValue (PimAttributeDefaultValueId,LocaleId)

		SELECT  AA.DefaultValueJson , ZPADV.PimAttributeValueId, AA.LocaleId 
		INTO #PimAttributeDefaultXML
		FROM ZnodePimAttributeDefaultJSON AA 
		INNER JOIN #PimProductAttributeDefaultValue ZPADV ON ( ZPADV.PimAttributeDefaultValueId = AA.PimAttributeDefaultValueId AND AA.LocaleId = ZPADV.LocaleId)
		
		--create index #PimAttributeDefaultXML on #PimAttributeDefaultXML(PimAttributeValueId,LocaleId)
		--To get the data localwise
		IF (SELECT COUNT(*) FROM @LocaleId)>1
		BEGIN
			INSERT INTO #PimAttributeDefaultXML (DefaultValueJson, PimAttributeValueId, LocaleId)
			SELECT A.DefaultValueJson , A.PimAttributeValueId,b.id 
			FROM #PimAttributeDefaultXML A CROSS APPLY  @LocaleId b  
			WHERE NOT EXISTS ( SELECT * FROM #PimAttributeDefaultXML c WHERE a.PimAttributeValueId  = c.PimAttributeValueId AND c.LocaleId = b.Id )
			AND b.Id <> @DefaultLocaleId
		END
		
		------Getting child facets for merging   
		SELECT DISTINCT ZPPADV.PimAttributeDefaultValueId, ZPAV_Parent.PimAttributeValueId, ZPPADV.LocaleId
		INTO #PimChildProductFacets
		FROM ZnodePimAttributeValue ZPAV_Parent
		INNER JOIN ZnodePimProductTypeAssociation ZPPTA ON ZPAV_Parent.PimProductId = ZPPTA.PimParentProductId
		INNER JOIN #PimProductAttributeDefaultValue ZPPADV ON ZPPTA.PimProductId = ZPPADV.PimProductId AND ZPAV_Parent.PimAttributeId = ZPPADV.PimAttributeId
		WHERE EXISTS(SELECT * FROM ZnodePimFrontendProperties ZPFP WHERE ZPAV_Parent.PimAttributeId = ZPFP.PimAttributeId AND ZPFP.IsFacets = 1)
		AND EXISTS(SELECT * FROM #ZnodePublishCategoryProduct ZPPC WHERE ZPAV_Parent.PimProductId = ZPPC.PimProductId )
		AND NOT EXISTS(SELECT * FROM #PimProductAttributeDefaultValue ZPPADV1 WHERE ZPAV_Parent.PimAttributeValueId = ZPPADV1.PimAttributeValueId 
		                AND ZPPADV1.PimAttributeDefaultValueId = ZPPADV.PimAttributeDefaultValueId )

		----Merging childs facet attribute Default value XML for parent
		INSERT INTO #PimAttributeDefaultXML (DefaultValueJson, PimAttributeValueId, LocaleId)
		SELECT ZPADX.DefaultValueJson, ZPPADV.PimAttributeValueId, ZPPADV.LocaleId
		FROM #PimChildProductFacets ZPPADV		  
		INNER JOIN ZnodePimAttributeDefaultJSON ZPADX ON ( ZPPADV.PimAttributeDefaultValueId = ZPADX.PimAttributeDefaultValueId AND ZPPADV.LocaleId = ZPADX.LocaleId)
		
		CREATE INDEX Idx_#PimDefaultValueLocale ON #PimDefaultValueLocale(PimAttributeDefaultJsonId,LocaleId)

		CREATE INDEX Idx_#PimAttributeDefaultXML ON #PimAttributeDefaultXML(PimAttributeValueId,LocaleId)
		INCLUDE (DefaultValueJson)

		CREATE INDEX #ZnodePublishCategoryProduct_2 ON #ZnodePublishCategoryProduct(PimProductId,PimAttributeId)
		--CREATE INDEX #ZnodePublishCategoryProduct_3 ON #ZnodePublishCategoryProduct(PimProductId,AttributeCode)
		
		SELECT PPCP.PimProductId, PPCP.AttributeCode,PPCP.PimAttributeValueId, PPCP.PimAttributeId,ZPAX.AttributeJson,ZPAX.LocaleId
		INTO #ZnodeProductattributeDefaultData
		FROM #ZnodePublishCategoryProduct PPCP
		INNER JOIN ZnodePimAttributeJSON ZPAX ON (ZPAX.PimAttributeId = PPCP.PimAttributeId)
		WHERE EXISTS(SELECT * FROM #PimProductAttributeDefaultValue a  WHERE PPCP.PimProductId = a.PimProductId AND PPCP.PimAttributeId = a.PimAttributeId )
		AND EXISTS(SELECT * FROM @LocaleId L WHERE ZPAX.LocaleId = L.Id)
		AND NOT EXISTS(SELECT * FROM ZnodePimConfigureProductAttribute UOP WHERE PPCP.PimProductId = UOP.PimProductId AND PPCP.PimAttributeId = UOP.PimAttributeId )
		--AND NOT EXISTS(SELECT * FROM ##AttributeValueLocale AVL WHERE PPCP.PimProductId = AVL.PimProductId AND PPCP.AttributeCode = AVL.AttributeCode AND ZPAX.LocaleId = AVL.LocaleId )
		 
	
		--CREATE INDEX IDX_#ZnodeProductattributeDefaultData_1 ON #ZnodeProductattributeDefaultData(PimProductId,PimAttributeId)
		CREATE INDEX IDX_#ZnodeProductattributeDefaultData_2 ON #ZnodeProductattributeDefaultData(PimProductId,AttributeCode,LocaleId)
		CREATE INDEX IDX_#ZnodeProductattributeDefaultData_3 ON #ZnodeProductattributeDefaultData(PimAttributeValueId,LocaleId)
		
		SELECT PPCP.PimProductId, PPCP.AttributeCode,'' AttributeValue,
		JSON_MODIFY (JSON_MODIFY (PPCP.AttributeJson,'$.AttributeValues',''), '$.SelectValues',
			
				ISNULL((SELECT 
							ISNULL(JSON_VALUE(DefaultValueJson, '$.Code'),'') Code 
							,ISNULL(JSON_VALUE(DefaultValueJson, '$.LocaleId'),0) LocaleId
							,ISNULL(JSON_VALUE(DefaultValueJson, '$.Value'),'') Value
							,ISNULL(JSON_VALUE(DefaultValueJson, '$.AttributeDefaultValue'),'') AttributeDefaultValue
							,ISNULL(JSON_VALUE(DefaultValueJson, '$.DisplayOrder'),0) DisplayOrder
							,ISNULL(JSON_VALUE(DefaultValueJson, '$.IsEditable'),'false') IsEditable
							,ISNULL(JSON_VALUE(DefaultValueJson, '$.SwatchText'),'') SwatchText
							,ISNULL(JSON_VALUE(DefaultValueJson, '$.Path'),'') Path
					FROM #PimAttributeDefaultXML aa
					WHERE (aa.PimAttributeValueId = PPCP.PimAttributeValueId AND AA.LocaleId = PPCP.LocaleId ) For JSON Auto 
				),'[]') 
				) 
			 AttributeEntity 
		 , PPCP.LocaleId
		 INTO #DefaultData
		 FROM #ZnodeProductattributeDefaultData PPCP 
		 WHERE NOT EXISTS(SELECT * FROM ##AttributeValueLocale AVL WHERE PPCP.PimProductId = AVL.PimProductId AND PPCP.AttributeCode = AVL.AttributeCode AND PPCP.LocaleId = AVL.LocaleId )
		
		----Getting default attribute value entity
		INSERT INTO ##AttributeValueLocale		
		SELECT PimProductId,AttributeCode,'' AttributeValue,AttributeEntity,LocaleId
		FROM #DefaultData
		
		 
		--Getting text attribute value entity		
		SELECT PPCP.PimProductId , ZPA.AttributeCode,ISNULL(ZPAVL.AttributeValue,'') AttributeValue,ZPAVL.LocaleId,ZPA.PimAttributeId
		INTO #TempTxtArea
		FROM ZnodePimAttributeValue PPCP
		INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = PPCP.PimAttributeId)
		INNER JOIN ZnodePimProductAttributeTextAreaValue ZPAVL ON (PPCP.PimAttributeValueId =ZPAVL.PimAttributeValueId)
		WHERE EXISTS (Select * from @LocaleId x where ZPAVL.LocaleId = x.Id) AND
		EXISTS(SELECT * FROM #ZnodePublishCategoryProductForValidation PPCP1  WHERE PPCP1.PimProductId = PPCP.PimProductId)
		
		CREATE INDEX Idx_#TempTxtArea_1 ON #TempTxtArea(PimAttributeId,LocaleId)
		CREATE INDEX Idx_#TempTxtArea_2 ON #TempTxtArea(PimProductId,AttributeCode,LocaleId)

		--Getting tex area attribute value entity		
		SELECT ZPAVL.PimProductId , ZPAVL.AttributeCode,'' AttributeValue ,
			JSON_MODIFY (JSON_MODIFY (Json_Query( ZPAX.AttributeJSON  ) , '$.AttributeValues' ,  ISNULL(ZPAVL.AttributeValue,'') ) ,'$.SelectValues',Json_Query('[]'))
		    AS 'AttributeEntity', 
		 ZPAVL.LocaleId
		INTO #TempTxtAreaEntity
		FROM #TempTxtArea ZPAVL 
		INNER JOIN ZnodePimAttributeJSON ZPAX ON (ZPAX.PimAttributeId = ZPAVL.PimAttributeId AND ZPAVL.LocaleId = ZPAX.LocaleId)

		IF (SELECT COUNT(*) FROM @LocaleId) > 1
		BEGIN
			----Getting product attribute value entity getting for other locale with text area attribute json
			INSERT INTO #TempTxtAreaEntity(PimProductId,AttributeCode,AttributeValue,AttributeEntity,LocaleId)
			SELECT ZPAVL.PimProductId , ZPAVL.AttributeCode,'' AttributeValue ,
				JSON_MODIFY (JSON_MODIFY (Json_Query( ZPAX.AttributeJSON  ) , '$.AttributeValues' ,  ISNULL(ZPAVL.AttributeValue,'') ) ,'$.SelectValues',Json_Query('[]'))
				AS 'AttributeEntity', 
			 ZPAVL.LocaleId
			FROM #TempTxtArea ZPAVL 
			INNER JOIN ZnodePimAttributeJSON ZPAX ON (ZPAX.PimAttributeId = ZPAVL.PimAttributeId AND ZPAX.LocaleId = @DefaultLocaleId)
			WHERE Exists (SELECT TOP 1 1 FROM @LocaleId X WHERE X.Id =  ZPAVL.LocaleId )
			AND ZPAX.LocaleId = @DefaultLocaleId AND ZPAVL.LocaleId <> @DefaultLocaleId
			AND NOT EXISTS(SELECT * FROM #TempTxtAreaEntity ZPAVL1 WHERE ZPAVL.PimProductId = ZPAVL1.PimProductId AND ZPAVL.AttributeCode = ZPAVL1.AttributeCode AND ZPAVL.LocaleId = ZPAVL1.LocaleId)
		END
		
		INSERT INTO ##AttributeValueLocale ( PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId )
		Select PimProductId , AttributeCode,'' AttributeValue ,AttributeEntity, LocaleId 
		FROM #TempTxtAreaEntity

		 ----Getting custom field value entity
		 INSERT INTO ##AttributeValueLocale ( PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId )
 		 SELECT ZPCFX.PimProductId , ZPCFX.CustomCode, '' AttributeValue ,
			JSON_MODIFY (Json_Query( ZPCFX.CustomeFiledJson) ,'$.SelectValues',Json_Query('[]')) AttributeEntity, 
			ZPCFX.LocaleId
		 FROM ZnodePimCustomeFieldJSON ZPCFX 
		 WHERE EXISTS (Select * from @LocaleId x where ZPCFX.LocaleId = x.Id) 
		 AND EXISTS(SELECT * FROM #ZnodePublishCategoryProduct PPCP WHERE (PPCP.PimProductId = ZPCFX.PimProductId ))
		 AND NOT EXISTS(SELECT * FROM ##AttributeValueLocale AVL WHERE ZPCFX.PimProductId = AVL.PimProductId AND ZPCFX.CustomCode = AVL.AttributeCode AND ZPCFX.LocaleId = AVL.LocaleId )
		 GROUP BY ZPCFX.PimProductId , ZPCFX.CustomCode, ZPCFX.CustomeFiledJson , ZPCFX.LocaleId
		 
		 --Getting Media attribute value entity		
		SELECT PPCP.PimProductId , ZPA.AttributeCode,ISNULL(ZPAVL.MediaPath,'') AttributeValue,ZPAVL.LocaleId,ZPA.PimAttributeId,PPCP.PimAttributeValueId
		INTO #TempMedia
		FROM ZnodePimAttributeValue PPCP
		INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = PPCP.PimAttributeId)
		INNER JOIN ZnodePimProductAttributeMedia ZPAVL ON (PPCP.PimAttributeValueId =ZPAVL.PimAttributeValueId)
		WHERE EXISTS (SELECT * FROM @LocaleId x where ZPAVL.LocaleId = x.Id) AND
		EXISTS(SELECT * FROM #ZnodePublishCategoryProductForValidation PPCP1  WHERE PPCP1.PimProductId = PPCP.PimProductId)
		
		CREATE INDEX #TempMedia_1 ON #TempMedia(PimAttributeValueId,LocaleId)
		CREATE INDEX #TempMedia_2 ON #TempMedia(PimAttributeId)
		CREATE INDEX #TempMedia_3 ON #TempMedia(PimProductId,AttributeCode,LocaleId)

		 ----Getting image attribute value entity
		 INSERT INTO ##AttributeValueLocale ( PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId )
		 SELECT PPCP.PimProductId, PPCP.AttributeCode,'' AttributeValue,
		 JSON_MODIFY (JSON_MODIFY (Json_Query( ZPAX.AttributeJSON  ) , '$.AttributeValues',  
		 ISNULL((SELECT stuff( (SELECT ','+ZPPAM.AttributeValue FROM #TempMedia ZPPAM WHERE (ZPPAM.PimAttributeValueId = PPCP.PimAttributeValueId AND PPCP.LocaleId = ZPAX.LocaleId )
				 FOR XML PATH(''),Type).value('.', 'varchar(max)'), 1, 1, '')
				 
				 ),'') ) ,'$.SelectValues',Json_Query('[]'))   
				 AS 'AttributeEntity', 
				 ZPAX.LocaleId
		 FROM #TempMedia PPCP 
		 INNER JOIN ZnodePimAttributeJSON ZPAX ON (ZPAX.PimAttributeId = PPCP.PimAttributeId AND ZPAX.LocaleId = PPCP.LocaleId)
		 WHERE Exists (SELECT TOP 1 1 FROM @LocaleId X WHERE X.Id =  ZPAX.LocaleId )  
		 AND NOT EXISTS(SELECT * FROM ##AttributeValueLocale AVL WHERE PPCP.PimProductId = AVL.PimProductId AND PPCP.AttributeCode = AVL.AttributeCode AND ZPAX.LocaleId = PPCP.LocaleId )
		 AND NOT EXISTS(SELECT * FROM ZnodePimConfigureProductAttribute UOP WHERE ZPAX.PimAttributeId = UOP.PimAttributeId AND PPCP.PimProductId = UOP.PimProductId )
	
		 IF (SELECT COUNT(*) FROM @LocaleId) > 1
		 BEGIN
				----Getting product attribute value entity getting for other locale with default attribute json
				INSERT INTO ##AttributeValueLocale ( PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId )
				 SELECT PPCP.PimProductId, PPCP.AttributeCode,'' AttributeValue,
				 JSON_MODIFY (JSON_MODIFY (Json_Query( ZPAX.AttributeJSON  ) , '$.AttributeValues',  
				 ISNULL((SELECT stuff( (SELECT ','+ZPPAM.AttributeValue FROM #TempMedia ZPPAM WHERE (ZPPAM.PimAttributeValueId = PPCP.PimAttributeValueId AND PPCP.LocaleId = ZPAX.LocaleId )
						 FOR XML PATH(''),Type).value('.', 'varchar(max)'), 1, 1, '')
				 
						 ),'') ) ,'$.SelectValues',Json_Query('[]'))   
						 AS 'AttributeEntity', 
						 PPCP.LocaleId
				 FROM #TempMedia PPCP 
				 INNER JOIN ZnodePimAttributeJSON ZPAX ON (ZPAX.PimAttributeId = PPCP.PimAttributeId AND ZPAX.LocaleId = @DefaultLocaleId)
				 WHERE ZPAX.LocaleId = @DefaultLocaleId AND PPCP.LocaleId <> @DefaultLocaleId 
				 AND Exists (SELECT TOP 1 1 FROM @LocaleId X WHERE X.Id =  PPCP.LocaleId )  
				 AND NOT EXISTS(SELECT * FROM ##AttributeValueLocale AVL WHERE PPCP.PimProductId = AVL.PimProductId AND PPCP.AttributeCode = AVL.AttributeCode AND ZPAX.LocaleId = AVL.LocaleId )
				 AND NOT EXISTS(SELECT * FROM ZnodePimConfigureProductAttribute UOP WHERE ZPAX.PimAttributeId = UOP.PimAttributeId AND PPCP.PimProductId = UOP.PimProductId )
		END
		 -------------configurable attribute 		 
		INSERT INTO ##AttributeValueLocale ( PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId )
		SELECT DISTINCT UOP.PimProductId,c.AttributeCode,'' AttributeValue ,--'<Attributes><AttributeEntity>'+
		JSON_MODIFY (Isnull(JSON_MODIFY (c.AttributeJson,'$.AttributeValues',''),'')  ,'$.SelectValues',
			Isnull((SELECT DISTINCT 
							Isnull(JSON_VALUE(AA.DefaultValueJson, '$.Code'),'') Code 
							,Isnull(JSON_VALUE(AA.DefaultValueJson, '$.LocaleId'),0) LocaleId
							,Isnull(JSON_VALUE(AA.DefaultValueJson, '$.Value'),'') Value
							,Isnull(JSON_VALUE(AA.DefaultValueJson, '$.AttributeDefaultValue'),'') AttributeDefaultValue
							,Isnull(JSON_VALUE(AA.DefaultValueJson, '$.DisplayOrder'),0) DisplayOrder
							,Isnull(JSON_VALUE(AA.DefaultValueJson, '$.IsEditable'),'false') IsEditable
							,Isnull(JSON_VALUE(AA.DefaultValueJson, '$.SwatchText'),'') SwatchText
							,Isnull(JSON_VALUE(AA.DefaultValueJson, '$.Path'),'') Path 
							,ISNULL(ZPA.DisplayOrder,0)  AS VariantDisplayOrder 
							,ISNULL(ZPAVL_SKU.AttributeValue,'')   AS VariantSKU 
							,Isnull(ZPAV12.AttributeValue,'') AS VariantImagePath 
						 FROM ZnodePimAttributeDefaultJSON AA 
						 INNER JOIN #PimProductAttributeDefaultValue ZPADV ON ( ZPADV.PimAttributeDefaultValueId = AA.PimAttributeDefaultValueId )
						 INNER JOIN ZnodePimProductTypeAssociation YUP ON (YUP.PimProductId = ZPADV.PimProductId)
						 INNER JOIN #VariantSKU ZPAVL_SKU On YUP.PimProductId = ZPAVL_SKU.PimProductId
						 LEFT JOIN #TempMedia ZPAV12 ON (ZPAV12.PimProductId= YUP.PimProductId  AND ZPAV12.PimAttributeId = @PimMediaAttributeId ) 
						 LEFT JOIN ZnodePimAttribute ZPA ON (ZPA.PimattributeId = ZPADV.PimAttributeId)
						 WHERE (YUP.PimParentProductId  = UOP.PimProductId AND ZPADV.pimAttributeId = UOP.PimAttributeId )
		FOR JSON auto),'[]')) SelectValuesEntity ,
		c.LocaleId
		FROM ZnodePimConfigureProductAttribute UOP 
		INNER JOIN ZnodePimAttributeJSON c   ON (c.PimAttributeId = UOP.PimAttributeId )
		WHERE Exists (Select TOP 1 1 from @LocaleId X where X.Id = C.LocaleId )  
		AND EXISTS(SELECT * FROM #ZnodePublishCategoryProductForValidation PPCP1 where UOP.PimProductId = PPCP1.PimProductId )

		---Insert product attributewise data for other locale of default locale as local ise attribute data not present
		IF (SELECT COUNT(*) FROM @LocaleId) > 1
		BEGIN
			DECLARE @cur_Id int
			DECLARE cur_LocaleId CURSOR LOCAL FAST_FORWARD
			FOR SELECT Id FROM @LocaleId WHERE Id <> @DefaultLocaleId;

			OPEN cur_LocaleId;
			FETCH NEXT FROM cur_LocaleId INTO  @cur_Id;

			WHILE @@FETCH_STATUS = 0
			BEGIN 
				INSERT INTO ##AttributeValueLocale (PimProductId, AttributeCode, AttributeValue, AttributeEntity, LocaleId)
				SELECT A.PimProductId, A.AttributeCode, A.AttributeValue, A.AttributeEntity, b.Id
				FROM ##AttributeValueLocale a
				CROSS APPLY @LocaleId b 
				WHERE NOT EXISTS(SELECT * FROM ##AttributeValueLocale c WHERE a.PimProductId = c.PimProductId AND b.Id = c.LocaleId AND a.AttributeCode = c.AttributeCode )
				AND a.LocaleId = @DefaultLocaleId AND b.Id = @cur_Id

				FETCH NEXT FROM cur_LocaleId INTO  @cur_Id;
			END;
			CLOSE cur_LocaleId;
			DEALLOCATE cur_LocaleId;
		END
		-------------configurable attribute 
		--select * from #AttributeValueLocale

		--CREATE INDEX IDX_#AttributeValueLocale ON #AttributeValueLocale(PimProductId,AttributeCode,LocaleId)
		--CREATE INDEX IDX_#AttributeValueLocale_Id ON #AttributeValueLocale(ID)
		 	
		--DELETE ZPPAX FROM ZnodePublishProductAttributeJson ZPPAX
		--WHERE exists (SELECT * FROM #AttributeValueLocale AVL WHERE ZPPAX.PimProductId = AVL.PimProductId AND AVL.LocaleId = ZPPAX.LocaleId )
		--AND NOT EXISTS(SELECT * FROM #AttributeValueLocale AVL WHERE ZPPAX.PimProductId = AVL.PimProductId AND AVL.LocaleId = ZPPAX.LocaleId AND ZPPAX.AttributeCode = AVL.AttributeCode )

		--DECLARE @MaxCount INT, @MinRow INT, @MaxRow INT, @Rows numeric(10,2);
		--SELECT @MaxCount = COUNT(*) FROM #AttributeValueLocale;

		--SELECT @Rows = 200000
        
		--SELECT @MaxCount = CEILING(@MaxCount / @Rows);

		--IF OBJECT_ID('tempdb..#Temp_ImportLoop') IS NOT NULL
  --          DROP TABLE #Temp_ImportLoop;
        
		------ To get the min AND max rows for import in loop
		--;WITH cte AS 
		--(
		--	SELECT RowId = 1, 
		--		   MinRow = 1, 
  --                 MaxRow = cast(@Rows as int)
  --          UNION ALL
  --          SELECT RowId + 1, 
  --                 MinRow + cast(@Rows as int), 
  --                 MaxRow + cast(@Rows as int)
  --          FROM cte
  --          WHERE RowId + 1 <= @MaxCount
		--)
  --      SELECT RowId, MinRow, MaxRow
  --      INTO #Temp_ImportLoop
  --      FROM cte
		--OPTION (maxrecursion 0);

		----Cursor for rows wise execution in bulk
		--DECLARE cur_BulkData CURSOR LOCAL FAST_FORWARD
  --      FOR SELECT MinRow, MaxRow FROM #Temp_ImportLoop
		--WHERE EXISTS(SELECT * FROM #AttributeValueLocale);

  --      OPEN cur_BulkData;
  --      FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow;

  --      WHILE @@FETCH_STATUS = 0
  --      BEGIN
	 --        UPDATE ZnodePublishProductAttributeJson SET IsUpdateLocaleWise = 0 WHERE ISNULL(IsUpdateLocaleWise,0) = 1
		--	  ----Update Product Attribute XML
		--	 UPDATE ZPPAX SET ZPPAX.Attributes = AVL.AttributeEntity, ZPPAX.ModifiedBy = @UserId, ZPPAX.ModifiedDate = GETDATE() 
		--	        , ZPPAX.IsUpdateLocaleWise = 0
		--	 FROM ZnodePublishProductAttributeJson ZPPAX 
		--	 INNER JOIN #AttributeValueLocale AVL ON ZPPAX.PimProductId = AVL.PimProductId AND AVL.LocaleId = ZPPAX.LocaleId AND ZPPAX.AttributeCode = AVL.AttributeCode 
		--	 WHERE  AVL.Id BETWEEN @MinRow AND @MaxRow AND AVL.AttributeEntity is not null
		 
		--	 ----Insert Product Attribute XML
		--	 INSERT INTO ZnodePublishProductAttributeJson(PimProductId,LocaleId,AttributeCode,Attributes,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		--	 SELECT AVL.PimProductId, AVL.LocaleId, AVL.AttributeCode, cast(AVL.AttributeEntity as varchar(max)), @UserId CreatedBy, GETDATE() CreatedDate, @UserId ModifiedBy, GETDATE() ModifiedDate
		--	 FROM #AttributeValueLocale AVL
		--	 WHERE NOT EXISTS(SELECT * FROM ZnodePublishProductAttributeJson ZPPAX WHERE AVL.PimProductId = ZPPAX.PimProductId AND  AVL.LocaleId = ZPPAX.LocaleId AND AVL.AttributeCode = ZPPAX.AttributeCode )
		--	 AND  AVL.Id BETWEEN @MinRow AND @MaxRow AND AVL.AttributeEntity is not null
		--	 GROUP BY AVL.PimProductId, AVL.AttributeEntity, AVL.LocaleId, AVL.AttributeCode

		--	 FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow;
  --      END;
		--CLOSE cur_BulkData;
		--DEALLOCATE cur_BulkData;

		--DELETE ZPPAX
		--FROM ZnodePublishProductAttributeJson ZPPAX
		--WHERE LocaleId <> @DefaultLocaleId
		--AND exists( SELECT * FROM ZnodePublishProductAttributeJson ZPPAX1 WHERE ZPPAX.AttributeCode = ZPPAX1.AttributeCode AND ZPPAX.PimProductId = ZPPAX1.PimProductId )
		--AND NOT EXISTS(SELECT * FROM #ProductLocaleWise AVL WHERE AVL.PimProductId = ZPPAX.PimProductId AND  AVL.LocaleId = ZPPAX.LocaleId )
		
		
		--DELETE  ZPPAX
		--FROM ZnodePublishProductAttributeJson ZPPAX
		--WHERE NOT EXISTS(SELECT * FROM #ProductLocaleWise ZLW WHERE ZPPAX.PimProductId = ZLW.PimProductId 
		--	                AND ZPPAX.LocaleId = ZLW.LocaleId )

		--SELECT PimProductId,Attributes Attributes,AttributeCode
		--INTO #ZnodePublishProductAttributeJson
		--FROM ZnodePublishProductAttributeJson 
		--WHERE LocaleId = @DefaultLocaleId

		--INSERT INTO ZnodePublishProductAttributeJson (PimProductId,Attributes,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AttributeCode)
		--SELECT PimProductId,Attributes,b.id,@UserId,GETDATE(),@UserId,GETDATE(),AttributeCode
		--FROM #ZnodePublishProductAttributeJson a
		--CROSS APPLY @LocaleId b 
		--WHERE NOT EXISTS(SELECT * FROM ZnodePublishProductAttributeJson c WHERE a.PimProductId = c.PimProductId AND b.Id = c.LocaleId AND a.AttributeCode = c.AttributeCode )
		--AND b.Id <> @DefaultLocaleId
					  
END TRY
BEGIN CATCH
select ERROR_MESSAGE()
    DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertUpdatePimCatalogProductDetailJson @PublishCatalogId = '+CAST(@PublishCatalogId AS VARCHAR(200))+',@UserId='+CAST(@UserId AS VARCHAR(200));


    EXEC Znode_InsertProcedureErrorLog
        @ProcedureName = 'Znode_InsertUpdatePimCatalogProductDetailJson',
        @ErrorInProcedure = @Error_procedure,
        @ErrorMessage = @ErrorMessage,
        @ErrorLine = @ErrorLine,
        @ErrorCall = @ErrorCall;
            
            
END CATCH;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportAttributeDefaultValue')
	DROP PROC Znode_ImportAttributeDefaultValue
GO

CREATE PROCEDURE [dbo].[Znode_ImportAttributeDefaultValue](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200))
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		-- Retrive RoundOff Value from global setting 
		DECLARE @InsertPimAtrribute TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY,
			-- RowNumber int, AttributeName varchar(300), AttributeCode varchar(300), AttributeType varchar(300), DisplayOrder int, GUID nvarchar(400)
			RowNumber int, AttributeCode varchar(300),AttributeDefaultValueCode varchar(300),AttributeDefaultValue varchar(1000),IsEditable varchar(10),DisplayOrder int, IsDefault varchar(10), SwatchText varchar(1000),SwatchImage varchar(500), SwatchImagePath varchar(500), GUID nvarchar(400)
		
		);
		DECLARE @InsertedPimAttributeIds TABLE (PimAttributeId int ,PimAttributeDefaultValueId int,AttributeDefaultValueCode nvarchar(300))
		
		SET @SSQL = 'Select RowNumber,AttributeCode,AttributeDefaultValueCode,AttributeDefaultValue,IsEditable,DisplayOrder,IsDefault,SwatchText,SwatchImage, SwatchImagePath ,GUID FROM '+@TableName;
		INSERT INTO @InsertPimAtrribute( RowNumber,AttributeCode,AttributeDefaultValueCode,AttributeDefaultValue,IsEditable,DisplayOrder,IsDefault,SwatchText,SwatchImage, SwatchImagePath ,GUID)
		EXEC sys.sp_sqlexec @SSQL;

		--@MessageDisplay will use to display validate message for input inventory value  
		DECLARE @AttributeCode TABLE
		( 
		   AttributeCode nvarchar(300)
		);
		INSERT INTO @AttributeCode
			   SELECT AttributeCode
			   FROM ZnodePimAttribute 

		-- Start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '117', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.AttributeCode not in 
			   (
				   SELECT AttributeCode FROM @AttributeCode
			   );

		WITH CTE_AttributeDefaultValueCode AS(
		SELECT AttributeDefaultValueCode , AttributeCode, RowNumber ,ROW_NUMBER ()OVER (PARTITION BY AttributeDefaultValueCode , AttributeCode ORDER BY AttributeDefaultValueCode , AttributeCode )  Row_Id
		FROM @InsertPimAtrribute Z
		
		
		)
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '53', 'AttributeDefaultValueCode', AttributeDefaultValueCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE EXISTS
			  ( SELECT TOP 1 1 FROM CTE_AttributeDefaultValueCode Z WHERE Z.RowNumber=ii.RowNumber AND Z.Row_Id >1
			   )
			  

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '102', 'AttributeDefaultValueCode', AttributeDefaultValueCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.AttributeDefaultValueCode,''))) like '%[^0-9A-Za-z]%'

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '102', 'AttributeDefaultValueCode', AttributeDefaultValueCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.AttributeDefaultValueCode,''))) like '% %' -----space not allowed

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsEditable', IsEditable, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.IsEditable not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsDefault', IsDefault, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.IsDefault not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '16', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL ) AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '64', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 99999

		UPDATE ZIL
			SET ZIL.ColumnName =   ZIL.ColumnName + ' [ AttributeDefaultValueCode - ' + ISNULL(AttributeDefaultValueCode,'') + ' ] '
			FROM ZnodeImportLog ZIL 
			INNER JOIN @InsertPimAtrribute IPA ON (ZIL.RowNumber = IPA.RowNumber)
			WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL


		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertPimAtrribute
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertPimAtrribute
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount
		,	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;

		DECLARE @MediaId INT
		SET @MediaId = (SELECT TOP 1 MediaId from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.SwatchImage = ZM.FileName and IPA.SwatchImagePath = ZM.Path)

		if (isnull(@MediaId,0)=0)
			SET @MediaId = (SELECT max(MediaId) from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.SwatchImage = ZM.FileName)

        update ZPADV set ZPADV.IsEditable = case when IPA.IsEditable in ('True','1','Yes') then 1 else 0 end,ZPADV.DisplayOrder = Case when Isnull(IPA.DisplayOrder,0) <> 0 then  IPA.DisplayOrder else ZPADV.DisplayOrder end ,
		                 ZPADV.IsDefault = case when IPA.IsDefault in ('True','1','Yes') then 1 else 0 end ,ZPADV.SwatchText = IPA.SwatchText ,
		                 ZPADV.MediaId = case when isnull(@MediaId,0)= 0 then ZPADV.MediaId else @MediaId end, ZPADV.ModifiedBy = @UserId, ZPADV.ModifiedDate = @GetDate 
		from @InsertPimAtrribute IPA 
		INNER JOIN ZnodePimAttribute ZPA ON IPA.AttributeCode = ZPA.AttributeCode 
		inner join ZnodePimAttributeDefaultValue ZPADV on ZPA.PimAttributeId = ZPADV.PimAttributeId and IPA.AttributeDefaultValueCode = ZPADV.AttributeDefaultValueCode

		update ZPADVL set ZPADVL.AttributeDefaultValue = IPA.AttributeDefaultValue, ZPADVL.ModifiedBy = @UserId, ZPADVL.ModifiedDate = @GetDate 
		from @InsertPimAtrribute IPA 
		INNER JOIN ZnodePimAttribute ZPA ON IPA.AttributeCode = ZPA.AttributeCode 
		inner join ZnodePimAttributeDefaultValue ZPADV on ZPA.PimAttributeId = ZPADV.PimAttributeId and IPA.AttributeDefaultValueCode = ZPADV.AttributeDefaultValueCode
		inner join ZnodePimAttributeDefaultValueLocale ZPADVL ON ( ZPADVL.PimAttributeDefaultValueId = ZPADV.PimAttributeDefaultValueId)

		--- Insert data into base table ZnodePimatrribute with their validation 

		INSERT INTO ZnodePimAttributeDefaultValue (PimAttributeId,AttributeDefaultValueCode,IsEditable,DisplayOrder,IsDefault,SwatchText,MediaId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)		
		OUTPUT Inserted.PimAttributeId,Inserted.PimAttributeDefaultValueId,Inserted.AttributeDefaultValueCode INTO @InsertedPimAttributeIds  		
		SELECT ZPA.PimAttributeId,IPA.AttributeDefaultValueCode, case when IPA.IsEditable in ('True','1','Yes') then 1 else 0 end , Case when Isnull(IPA.DisplayOrder,0) = 0 then  99999 else IPA.DisplayOrder end  , 
		       case when IPA.IsDefault in ('True','1','Yes') then 1 else 0 end , IPA.SwatchText, @MediaId,@UserId , @GetDate ,@UserId , @GetDate 
		from @InsertPimAtrribute IPA 
		INNER JOIN ZnodePimAttribute ZPA ON IPA.AttributeCode = ZPA.AttributeCode  
		where not exists(select * from ZnodePimAttributeDefaultValue ZPADV where ZPA.PimAttributeId = ZPADV.PimAttributeId and IPA.AttributeDefaultValueCode = ZPADV.AttributeDefaultValueCode)
		
		INSERT INTO ZnodePimAttributeDefaultValueLocale(LocaleId,PimAttributeDefaultValueId,AttributeDefaultValue,Description,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		Select @LocaleId ,IPAS.PimAttributeDefaultValueId, IPA.AttributeDefaultValue, '', @UserId , @GetDate ,@UserId , @GetDate   
		FROM @InsertedPimAttributeIds IPAS 
		INNER JOIN ZnodePimAttribute ZPA ON IPAS.PimAttributeId = ZPA.PimAttributeId  
		INNER JOIN @InsertPimAtrribute IPA ON ZPA.AttributeCode= IPA.AttributeCode and IPAS.AttributeDefaultValueCode = IPA.AttributeDefaultValueCode

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
	
		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAttributeDefaultValue @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200));

		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportAttributeDefaultValue',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		

	END CATCH;
END;


GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishAssociatedAddonsJson')
	DROP PROC Znode_GetPublishAssociatedAddonsJson
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishAssociatedAddonsJson]
(
	@PublishCatalogId NVARCHAR(MAX) = 0,
	@PimProductId    TransferId Readonly,
	@VersionId        INT           = 0,
	@UserId           INT,														 
	@PimCategoryHierarchyId int = 0, 
	@LocaleId       TransferId READONLY,
	@PublishStateId INT = 0, 
	@VersionIdString  VARCHAR(2000)= '',
	@Status		   Bit  OutPut,
	@RevisionType Varchar(50)
)
AS 
   
/*
    Summary : If PimcatalogId is provided get all products with Addons and provide above mentioned data
       If PimProductId is provided get all Addons if associated with given product id and provide above mentioned data
    			Input: @PublishCatalogId or @PimProductId
    		    output should be in XML format
       sample xml5
    Begin transaction  
	 declare  @PimProductId TransferId 
	 Declare @Status bit 
	 INSERT INTO @PimProductId  values (768)

			Exec [_Znode_GetPublishAssociatedAddonsJson]
				@PublishCatalogId = 5 ,
				--@PimProductId   = @PimProductId,
				@UserId =2,														 
				@VersionIdString = '',--'1662,1664,1663,1665',
				@Status	 =@Status Out,
				@RevisionType= 'Production'
				rollback transaction
				--SELECT * from ZnodePublishVersionEntity 
   
	*/

BEGIN
    BEGIN TRY
    SET NOCOUNT ON 
		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
        DECLARE @LocaleIdIn INT, @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId()
		, @Counter INT= 1
		, @MaxRowId INT= 0;

	UPDATE ZnodePublishAddonEntity SET ElasticSearchEvent = 0
    -- DECLARE @PimAddOnGroupId VARCHAR(MAX);

		CREATE TABLE #TBL_PublisshIds  (PublishProductId INT , PimProductId INT , PublishCatalogId INT)
		DECLARE @TBL_LocaleId TABLE (RowId    INT IDENTITY(1, 1),LocaleId INT);
		IF OBJECT_ID('tempdb..#VesionIds') is not null
		DROP TABLE #VesionIds
		Create Table #VesionIds(ZnodeCatalogId int , VersionId int , LocaleId int , RevisionType varchar(50) )

  		If @VersionIdString <> ''
		BEGIN
			Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)	
			SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType
			FROM ZnodePublishVersionEntity PV Inner join Split(@VersionIdString,',') S ON PV.VersionId = S.Item
		END
		Else 
		Begin
			If  (@RevisionType like '%Preview%'  OR @RevisionType like '%Production%')
			BEGIN
				Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)	
				SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV  where PV.IsPublishSuccess =1 
				AND PV.RevisionType ='Preview'
			END
			If  (@RevisionType like '%Production%' OR @RevisionType = 'None')
			BEGIN
				Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)	
				SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV  where PV.IsPublishSuccess =1 
				AND PV.RevisionType ='Production'
			END					
		End 

		IF (@PublishCatalogId IS NULL OR @PublishCatalogId = 0)
		BEGIN 
			INSERT INTO #TBL_PublisshIds 
			EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId,@userid,@PimProductId,1
		END 
		IF ISnull(@PimCategoryHierarchyId,0) <> 0 
		BEGIN 
			INSERT INTO #TBL_PublisshIds 
			EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId,@userid,@PimProductId,1,@PimCategoryHierarchyId 
		END 

		CREATE TABLE #TBL_PublishCatalogId (PublishCatalogId INT,PublishProductId INT,PimProductId  INT , VersionId INT ,LocaleId INT  );

		IF  ISnull(@PimCategoryHierarchyId,0) <> 0 
		BEGIN 
			INSERT INTO #TBL_PublishCatalogId 
			SELECT ZPP.PublishCatalogId , ZPP.PublishProductId,PimProductId, MAX(ZPCP.PublishCatalogLogId)  ,LocaleId 
			FROM ZnodePublishProduct ZPP 
			INNER JOIN ZnodePublishCatalogLog ZPCP ON (ZPCP.PublishCatalogId  = ZPP.PublishCatalogId)
			WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId   ) 
			AND ZPCP.Publishstateid = @PublishStateId
			GROUP BY ZPP.PublishCatalogId,ZPP.PublishProductId,PimProductId,LocaleId 
		END 
		ELSE 
		Begin
			INSERT INTO #TBL_PublishCatalogId  
			SELECT ZPP.PublishCatalogId , ZPP.PublishProductId,PimProductId,0  VersionId  ,0 LocaleId 
			FROM ZnodePublishProduct ZPP  
			WHERE EXISTS  (SELECT TOP 1 1 FROM #VesionIds ZPCP WHERE (ZPCP.ZnodeCatalogId  = ZPP.PublishCatalogId)) AND
			(EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId  
			AND  @PublishCatalogId = '0' )  OR (ZPP.PublishCatalogId =  @PublishCatalogId ))
		END
        DECLARE @TBL_AddonGroupLocale TABLE( PimAddonGroupId INT, DisplayType NVARCHAR(400),AddonGroupName NVARCHAR(MAX),LocaleId INT );
        INSERT INTO @TBL_LocaleId(LocaleId)
        SELECT LocaleId FROM ZnodeLocale MT  WHERE IsActive = 1 AND (EXISTS (SELECT TOP 1 1  FROM @LocaleId RT WHERE RT.Id = MT.LocaleId )
			OR NOT EXISTS (SELECT TOP 1 1 FROM @LocaleId ));
        SET @MaxRowId = ISNULL(( SELECT MAX(RowId) FROM @TBL_LocaleId ), 0);
    
        WHILE (@Counter <= @MaxRowId)
        BEGIN
            SET @LocaleIdIn =( SELECT LocaleId FROM @TBL_LocaleId WHERE RowId = @Counter );
            INSERT INTO @TBL_AddonGroupLocale (PimAddonGroupId, DisplayType, AddonGroupName)
            EXEC Znode_GetAddOnGroupLocale '', @LocaleIdIn;
	   		UPDATE @TBL_AddonGroupLocale SET LocaleId = @LocaleIdIn WHERE LocaleId IS NULL 
            SET @Counter = @Counter + 1;
        END;
		
		IF OBJECT_ID('tempdb..#AddonProductPublishedXML') is not null
		drop table #AddonProductPublishedXML
						
		SELECT  ZPPP.PublishProductId,ZPPP.PublishCatalogId,V.LocaleId,v.VersionId,
		ZPPP.[PublishProductId]  ZnodeProductId,
		ZPPP.[PublishCatalogId] ZnodeCatalogId,
		ZPP.PublishProductId  AssociatedZnodeProductId,
		ZPAOP.DisplayOrder DisplayOrder,
		ZPOPD.DisplayOrder AssociatedProductDisplayOrder,
		RequiredType ,
		DisplayType, 
		ISNULL((select ''+AddonGroupName for xml path('')),'') GroupName,
		ISnull(IsDefault,0) IsDefault
		INTO #AddonProductPublishedXML
		FROM [ZnodePimAddOnProductDetail] AS ZPOPD
		INNER JOIN [ZnodePimAddOnProduct] AS ZPAOP ON ZPOPD.[PimAddOnProductId] = ZPAOP.[PimAddOnProductId]
		INNER JOIN #TBL_PublishCatalogId ZPPP ON (ZPPP.PimProductId = ZPAOP.PimProductId )
		INNER JOIN #TBL_PublishCatalogId ZPP ON(ZPP.PimProductId = ZPOPD.[PimChildProductId] AND ZPP.PublishCatalogId = ZPPP.PublishCatalogId  )
		INNER JOIN #VesionIds V ON ZPPP.PublishCatalogId  = V.ZnodeCataLogId
		INNER JOIN @TBL_AddonGroupLocale TBAG ON (TBAG.PimAddonGroupId   = ZPAOP.PimAddonGroupId AND TBAG.LocaleId = V.LocaleId )
	
		If (isnull(@PublishCatalogId ,'') = '' and @VersionIdString = '') OR 
			(isnull(@PublishCatalogId ,'') = 0 and @VersionIdString = '')
		Begin 
			UPDATE ZnodePublishAddonEntity 
			SET ElasticSearchEvent = 2
			WHERE PublishAddonEntityId  IN (
											SELECT PublishAddonEntityId
											FROM ZnodePublishAddonEntity BP
											INNER JOIN #AddonProductPublishedXML A ON BP.ZnodeProductId =A.PublishProductId
												AND BP.ZnodeCatalogId = A.PublishCatalogId AND BP.VersionId = A.VersionId
											) 

			----Delete addon entries having parent data removed
			UPDATE ZPAE 
			SET ElasticSearchEvent = 2
			FROM ZnodePublishAddonEntity ZPAE
			WHERE NOT EXISTS (SELECT * from [ZnodePimAddOnProduct] ZPAOP 
					INNER JOIN ZnodePublishProduct ZPPP ON (ZPPP.PimProductId = ZPAOP.PimProductId )
					WHERE ZPAE.ZnodeProductId = ZPPP.PublishProductId AND ZPAE.ZnodeCatalogId = ZPPP.PublishCatalogId)

		End 

		----Delete addon entries having parent data present but all addon removed
		SELECT zppp1.PublishCatalogId,ZPPP1.PublishProductId,ZPPP.PublishProductId as AssociatedZnodeProductId  
		INTO #TempAddonProduct
		FROM [ZnodePimAddOnProductDetail] AS ZPOPD
		INNER JOIN [ZnodePimAddOnProduct] AS ZPAOP ON ZPOPD.[PimAddOnProductId] = ZPAOP.[PimAddOnProductId]
		INNER JOIN ZnodePublishProduct ZPPP1 ON (ZPPP1.PimProductId = ZPAOP.PimProductId )
		INNER JOIN ZnodePublishProduct ZPPP ON (ZPPP.PimProductId = ZPOPD.PimChildProductId )

		UPDATE ZPAE 
		SET ElasticSearchEvent = 2
		FROM ZnodePublishAddonEntity ZPAE
		WHERE not EXISTS (SELECT * from #TempAddonProduct ZPPP
				WHERE ZPAE.ZnodeProductId = ZPPP.PublishProductId AND ZPAE.ZnodeCatalogId = ZPPP.PublishCatalogId)

		UPDATE ZPAE 
		SET ElasticSearchEvent = 2
		FROM ZnodePublishAddonEntity ZPAE
		WHERE EXISTS (SELECT * from #TempAddonProduct ZPPP
				WHERE ZPAE.ZnodeProductId = ZPPP.PublishProductId AND ZPAE.ZnodeCatalogId = ZPPP.PublishCatalogId)
		AND not EXISTS (SELECT * from #TempAddonProduct ZPPP1
				WHERE ZPAE.AssociatedZnodeProductId = ZPPP1.AssociatedZnodeProductId AND ZPAE.ZnodeProductId = ZPPP1.PublishProductId  AND ZPAE.ZnodeCatalogId = ZPPP1.PublishCatalogId)

				
		UPDATE PCE SET PCE.AssociatedProductDisplayOrder = Isnull(CE.AssociatedProductDisplayOrder,0),
			PCE.GroupName = CE.GroupName,PCE.DisplayType = CE.DisplayType,
			PCE.DisplayOrder = CE.DisplayOrder,
			PCE.IsRequired = 1 ,PCE.RequiredType = CE.RequiredType,PCE.IsDefault = CE.IsDefault,
			PCE.ElasticSearchEvent = 2
		FROM #AddonProductPublishedXML CE
		INNER JOIN ZnodePublishAddonEntity PCE ON CE.VersionId = PCE.VersionId
		AND PCE.LocaleId = CE.LocaleId AND PCE.ZnodeCatalogId = CE.PublishCatalogId AND CE.ZnodeProductId = PCE.ZnodeProductId
		AND PCE.AssociatedZnodeProductId = CE.AssociatedZnodeProductId AND PCE.ElasticSearchEvent <> 2

		Insert into  ZnodePublishAddonEntity
		(VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,
			LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault,ElasticSearchEvent)
		Select 
			VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,Isnull(AssociatedProductDisplayOrder,0),
			LocaleId,GroupName,DisplayType,DisplayOrder,1 IsRequired,RequiredType,IsDefault, 1 AS ElasticSearchEvent
		from #AddonProductPublishedXML CE
		WHERE NOT EXISTS(SELECT * FROM ZnodePublishAddonEntity PCE WHERE CE.VersionId = PCE.VersionId
		AND PCE.LocaleId = CE.LocaleId AND PCE.ZnodeCatalogId = CE.PublishCatalogId AND CE.ZnodeProductId = PCE.ZnodeProductId
		AND PCE.AssociatedZnodeProductId = CE.AssociatedZnodeProductId AND PCE.ElasticSearchEvent <> 2)
		
		SET @Status = 1;
            
    END TRY
    BEGIN CATCH
		SELECT ERROR_MESSAGE(),ERROR_PROCEDURE()
            
        SET @Status = 0;
        DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishAssociatedAddonsJson @PublishCatalogId = '+@PublishCatalogId+',@VersionId='+CAST(@VersionId AS VARCHAR(50))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
        SELECT 0 AS ID,
            CAST(0 AS BIT) AS Status;
        EXEC Znode_InsertProcedureErrorLog
            @ProcedureName = 'Znode_GetPublishAssociatedAddonsJson',
            @ErrorInProcedure = @Error_procedure,
            @ErrorMessage = @ErrorMessage,
            @ErrorLine = @ErrorLine,
            @ErrorCall = @ErrorCall;
    END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ChangeStatusForIndexCreation')
	DROP PROC Znode_ChangeStatusForIndexCreation
GO

CREATE PROCEDURE Znode_ChangeStatusForIndexCreation
AS
BEGIN
    SET NOCOUNT ON;
    UPDATE  ZnodePublishProductEntity SET ElasticSearchEvent = 1
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishAssociatedProductsJson')
	DROP PROC Znode_GetPublishAssociatedProductsJson
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishAssociatedProductsJson]    
(       
     @PublishCatalogId VARCHAR(MAX) = '',    
     @PimProductId     TransferId Readonly,    
     @ProductType      VARCHAR(300) = 'BundleProduct',    
     @VersionId        INT          = 0,    
     @UserId           INT,    
     @PimCategoryHierarchyId int = 0,    
     @PublishStateId INT = 0  ,    
     @VersionIdString  VARCHAR(2000)= '',    
     @Status  BIT  Output,    
     @RevisionType Varchar(50) = ''    
)    
AS    
  /*    
    Summary : If PimcatalogId is provided then get all  Bundles / Group / Configurable product and  provide above mentioned data    
              If PimProductId is provided then get all Bundles / Group / Configurable if associated with given product id and provide above mentioned data    
       Input: @PublishCatalogId or @PimProductId    
       Output should be in XML format    
             Required o/p    
       <BundleProductEntity>    
       <ZnodeProductId></ZnodeProductId>    
       <ZnodeCatalogId></ZnodeCatalogId>    
       <AsscociadedZnodeProductIds></AsscociadedZnodeProductIds>    
       </BundleProductEntity>    
    Unit Testing     
    BundleProduct    
 DECLARE     
    EXEC [dbo].[Znode_GetPublishAssociatedProducts] @PublishCatalogId = 1  , @ProductType = 'BundleProduct' ,@userId = 2     
    EXEC [dbo].[Znode_GetPublishAssociatedProducts] @PublishCatalogId =2 , @ProductType = 'ConfigurableProduct',@userId = 2 ,@PimCategoryHierarchyId = 7     
    Group Product    
    EXEC [dbo].[Znode_GetPublishAssociatedProducts]  @PublishCatalogId ='2',@PimProductIdh =''  , @PimProducttType = 'GroupedProduct'    
    EXEC [dbo].[Znode_GetPublishAssociatedProducts]  @PublishCatalogId ='',@PimProductId ='200066'  , @PimProducttType = 'GroupedProduct'    
    EXEC [dbo].[Znode_GetPublishAssociatedProducts] @PimProductId ='200066'  , @PimProducttType = 'GroupedProduct'    
   */    
BEGIN    
BEGIN TRAN GetPublishAssociatedProducts;    
BEGIN TRY    
SET NOCOUNT ON;    
      
    IF OBJECT_ID('tempdb..#VesionIds') is not null    
    DROP TABLE #VesionIds    
    Create Table #VesionIds(ZnodeCatalogId int , VersionId int , LocaleId int , RevisionType varchar(50) )    
    
      If @VersionIdString <> ''       
    Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)     
    SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV Inner join Split(@VersionIdString,',') S ON PV.VersionId = S.Item    
    Else     
    Begin    
     If  (@RevisionType like '%Preview%'  OR @RevisionType like '%Production%' )    
      Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)     
      SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV  where PV.IsPublishSuccess =1     
      AND PV.RevisionType ='Preview'    
    
     If  (@RevisionType like '%Production%' OR @RevisionType = 'None')    
      Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)     
      SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV  where PV.IsPublishSuccess =1     
      AND PV.RevisionType ='Production'    
     end     
    
   IF OBJECT_ID('tempdb..#TBL_PublishCatalogId') is not null    
    DROP TABLE #TBL_PublishCatalogId    
       
   CREATE TABLE #TBL_PublishCatalogId (PublishCatalogId INT,PublishProductId INT,PimProductId  INT , VersionId INT,LocaleId INT  );    
   DECLARE  @PimAttributeId INT = [dbo].[Fn_GetProductTypeAttributeId]()    
     ,@PimAttributeDefaultValueId INT = (SELECT TOP 1 PimAttributeDefaultValueId FROM ZnodePimAttributeDefaultValue WHERE AttributeDefaultValueCode = @ProductType)    
     ,@DefaultLocaleId INT = dbo.fn_getDefaultlocaleId()     
   DECLARE @GetDate DATETIME =dbo.Fn_GetDate()    
        
   IF OBJECT_ID('tempdb..#TBL_PublisshIds') is not null    
   DROP TABLE #TBL_PublisshIds    
   Create TABLE #TBL_PublisshIds (PublishProductId INT , PimProductId INT , PublishCatalogId INT)    
    
   DECLARE  @PimProductId_New TransferId    
          
    IF  @PublishCatalogId IS NULL  OR @PublishCatalogId = 0     
    BEGIN     
    INSERT INTO #TBL_PublisshIds     
    Select ZPP.PublishProductId ,ZPP.PimProductId , ZPP.PublishCatalogId from ZnodePublishProduct ZPP Inner join @PimProductId  PPI on ZPP.PimProductId = PPI.ID    
      --EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId,@userid,@PimProductId,1    
          
      INSERT INTO @PimProductId_New    
      SELECT DISTINCT PimProductId FROM #TBL_PublisshIds    
    
     -- SELECT  @PimProductId     
    END     
        
    IF  ISnull(@PimCategoryHierarchyId,0) <> 0     
    BEGIN     
        
      INSERT INTO #TBL_PublisshIds     
      EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId,@userid,@PimProductId,1,@PimCategoryHierarchyId    
          
      --SET @PimProductId = SUBSTRING((SELECT DISTINCT ','+CAST(PimProductId AS VARCHAr(50)) FROM #TBL_PublisshIds FOR XML PATH ('')),2,8000 )    
    
      INSERT INTO @PimProductId_New    
      SELECT PimProductId FROM #TBL_PublisshIds    
    
          
    END     
    
    IF  ISnull(@PimCategoryHierarchyId,0) <> 0     
    BEGIN     
     INSERT INTO #TBL_PublishCatalogId     
     SELECT ZPP.PublishCatalogId , ZPP.PublishProductId,ZPP.PimProductId,MAX(ZPCP.PublishCatalogLogId) ,ZPCP.LocaleID      
     FROM ZnodePublishProduct ZPP     
     INNER JOIN ZnodePimAttributeValue ZPV ON (ZPV.PimProductId = ZPP.PimProductId )    
     INNER JOIN ZnodePimProductAttributeDefaultValue ZPAVL ON (ZPAVL.PimAttributeValueId = ZPV.PimAttributeValueId)    
     LEFT JOIN  ZnodePublishCatalogLog ZPCP ON (ZPCP.PublishCatalogId  = ZPP.PublishCatalogId)    
     WHERE (EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId   )     
     AND  (ZPP.PublishCatalogId =  @PublishCatalogId ))    
     AND ZPV.PimAttributeId  = @PimAttributeId    
     AND ZPAVL.PimAttributeDefaultValueId= @PimAttributeDefaultValueId    
     AND ZPAVL.LocaleId = @DefaultLocaleId    
     AND ISNULL(ZPCP.LocaleId,0) <> 0     
     AND ZPCP.PublishStateId= @PublishStateId    
     AND EXISTS(SELECT * FROM ZnodeLocale ZL where ZL.IsActive = 1  and ZPCP.LocaleId = ZL.LocaleId )    
     GROUP BY ZPP.PublishCatalogId , ZPP.PublishProductId,ZPP.PimProductId,ZPCP.LocaleID     
         
    END    
    ELSE     
    BEGIN     
        
    IF NOT EXISTS (SELECT TOP 1 1 FROM @PimProductId ) AND @PublishCatalogId <> 0    
    BEGIN    
      INSERT INTO #TBL_PublishCatalogId     
      SELECT distinct ZPP.PublishCatalogId , ZPP.PublishProductId,ZPP.PimProductId,  ZPCP.VersionId PublishCatalogLogId ,ZPCP.LocaleID     
      FROM ZnodePublishProduct ZPP     
      INNER JOIN ZnodePimAttributeValue ZPV ON (ZPV.PimProductId = ZPP.PimProductId )    
      INNER JOIN ZnodePimProductAttributeDefaultValue ZPAVL ON (ZPAVL.PimAttributeValueId = ZPV.PimAttributeValueId)    
      INNER JOIN  #VesionIds  ZPCP ON (ZPCP.ZnodeCatalogId  = ZPP.PublishCatalogId AND ISNULL(ZPCP.LocaleId,0) <> 0 )            
      WHERE     
      --(EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId  AND  @PublishCatalogId = '' )     
      --OR     
      (ZPP.PublishCatalogId =  @PublishCatalogId )    
      AND ZPV.PimAttributeId  = @PimAttributeId    
      AND ZPAVL.PimAttributeDefaultValueId= @PimAttributeDefaultValueId    
      AND ZPAVL.LocaleId = @DefaultLocaleId    
      AND EXISTS(SELECT * FROM ZnodeLocale ZL where ZL.IsActive = 1  and ZPCP.LocaleId = ZL.LocaleId )    
    END    
    ELSE    
    BEGIN    
      INSERT INTO #TBL_PublishCatalogId     
          
      SELECT distinct ZPP.PublishCatalogId , ZPP.PublishProductId,ZPP.PimProductId,  ZPCP.VersionId PublishCatalogLogId ,ZPCP.LocaleID     
      FROM ZnodePublishProduct ZPP     
      INNER JOIN ZnodePimAttributeValue ZPV ON (ZPV.PimProductId = ZPP.PimProductId )    
      INNER JOIN ZnodePimProductAttributeDefaultValue ZPAVL ON (ZPAVL.PimAttributeValueId = ZPV.PimAttributeValueId)    
      LEFT JOIN  #VesionIds ZPCP ON (ZPCP.ZnodeCatalogId  = ZPP.PublishCatalogId AND ISNULL(ZPCP.LocaleId,0) <> 0 )            
      WHERE (EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId  AND ZPP.PublishCatalogId = SP.PublishCatalogId) )    
      AND ZPV.PimAttributeId  = @PimAttributeId    
      AND ZPAVL.PimAttributeDefaultValueId= @PimAttributeDefaultValueId    
      AND ZPAVL.LocaleId = @DefaultLocaleId    
      AND EXISTS(SELECT * FROM ZnodeLocale ZL where ZL.IsActive = 1  and ZPCP.LocaleId = ZL.LocaleId )    
      --GROUP BY ZPP.PublishCatalogId , ZPP.PublishProductId,ZPP.PimProductId,ZPCP.LocaleID,    
    
    END     
         
    END    
        
             DECLARE @TBL_ProductTypeXML TABLE    
             (PublishProductId INT,    
			  PublishCatalogId INT,    
              ReturnXML        XML,    
              VersionId        INT    
             );    
             DECLARE @TBL_PimProductId TABLE    
             ([PimProductId]   INT,    
              PublishCatalogId INT,    
			  PublishProductId INT    
             );    
                
             DECLARE @TBL_PimAssociatedEntity TABLE    
             (    
				ZnodeProductId INT,    
				ZnodeCatalogId INT,    
				AsscociadedZnodeProductIds VARCHAR(MAX),    
				ConfigurableProductEntity NVARCHAR(MAX),    
				LocaleId INT,    
				DisplayOrder INT,    
				VersionId INT    
             );    
    
    If @ProductType = 'BundleProduct' AND Exists (Select TOP 1 1 from #TBL_PublishCatalogId)    
    Begin    
               IF OBJECT_ID('tempdb..#BundleProductPublishedXML') is not null    
					drop table #BundleProductPublishedXML    
    
		 IF (isnull(@PublishCatalogId ,'') = '' or isnull(@PublishCatalogId,0) = 0) and @VersionIdString = ''    
		 Begin     
			  UPDATE ZnodePublishBundleProductEntity SET ElasticSearchEvent = 2 
			  where not exists(select * from ZnodePublishProduct where ZnodePublishBundleProductEntity.ZnodeProductId = ZnodePublishProduct.PublishProductId)    
          
			  UPDATE ZnodePublishBundleProductEntity SET ElasticSearchEvent = 2 
			  where Exists ( Select TOP 1 1 from     
			  #TBL_PublishCatalogId A where ZnodePublishBundleProductEntity.ZnodeCatalogId =A.PublishCatalogId AND     
			  ZnodePublishBundleProductEntity.ZnodeProductId  = A.PublishProductId )    
			  AND Exists (SELECT TOP 1 1 FRoM #VesionIds     
			  Where ZnodePublishBundleProductEntity.VersionId =  #VesionIds.VersionId)    
		END     
    
		 UPDATE ZPBP SET AssociatedProductDisplayOrder = ISNULL(ZPTA.DisplayOrder,0),AssociatedProductBundleQuantity = ISNULL(ZPTA.BundleQuantity,1)
		 FROM #TBL_PublishCatalogId TBP    
		 INNER JOIN ZnodePimProductTypeAssociation ZPTA ON(ZPTA.PimParentProductId = TBP.PimProductId)    
		 INNER JOIN ZnodePublishProduct TBPU ON (TBPU.PimProductId = ZPTA.PimProductId AND TBPU.PublishCatalogId = TBP.PublishCatalogId )
		 INNER JOIN ZnodePublishBundleProductEntity ZPBP on  TBP.VersionId = ZPBP.VersionId AND TBP.PublishProductId = ZPBP.ZnodeProductId
			AND TBP.PublishCatalogId = ZPBP.ZnodeCatalogId AND TBPU.PublishProductId = ZPBP.AssociatedZnodeProductId
		 WHERE ZPBP.ElasticSearchEvent <> 2 


		 INSERT INTO ZnodePublishBundleProductEntity     
		 (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,AssociatedProductBundleQuantity)    
		 SELECT TBP.VersionId, TBP.PublishProductId, TBP.PublishCatalogId ,    
		 TBPU.PublishProductId AssociatedZnodeProductId,ISNULL(ZPTA.DisplayOrder,0)  AssociatedProductDisplayOrder,ISNULL(ZPTA.BundleQuantity,1)  AS AssociatedProductBundleQuantity  
		 FROM #TBL_PublishCatalogId TBP    
		 INNER JOIN ZnodePimProductTypeAssociation ZPTA ON(ZPTA.PimParentProductId = TBP.PimProductId)    
		 INNER JOIN ZnodePublishProduct TBPU ON (TBPU.PimProductId = ZPTA.PimProductId AND TBPU.PublishCatalogId = TBP.PublishCatalogId )
		 WHERE NOT EXISTS(SELECT * FROM ZnodePublishBundleProductEntity ZPBP WHERE  TBP.VersionId = ZPBP.VersionId AND TBP.PublishProductId = ZPBP.ZnodeProductId
			AND TBP.PublishCatalogId = ZPBP.ZnodeCatalogId AND TBPU.PublishProductId = ZPBP.AssociatedZnodeProductId AND ZPBP.ElasticSearchEvent <> 2 )
   End     
   
   If @ProductType = 'GroupedProduct' AND Exists (Select TOP 1 1 from #TBL_PublishCatalogId)    
   Begin    
		 IF (isnull(@PublishCatalogId ,'') = '' or isnull(@PublishCatalogId,0) = 0) and @VersionIdString = ''    
		 Begin     
			  UPDATE ZnodePublishGroupProductEntity SET ElasticSearchEvent = 2     
			  WHERE NOT EXISTS(SELECT * FROM ZnodePublishProduct WHERE ZnodePublishGroupProductEntity.ZnodeProductId = ZnodePublishProduct.PublishProductId)    
            
			  UPDATE ZnodePublishGroupProductEntity SET ElasticSearchEvent = 2  
			  where Exists ( Select TOP 1 1 from     
				  #TBL_PublishCatalogId A where ZnodePublishGroupProductEntity.ZnodeCatalogId =A.PublishCatalogId AND     
				  ZnodePublishGroupProductEntity.ZnodeProductId  = A.PublishProductId )    
				  AND Exists (SELECT TOP 1 1 FRoM #VesionIds     
			   Where ZnodePublishGroupProductEntity.VersionId =  #VesionIds.VersionId)    
		 end     
    
	  UPDATE ZPGP SET AssociatedProductDisplayOrder = ISNULL(ZPTA.DisplayOrder,0)
	  FROM #TBL_PublishCatalogId TBP    
      INNER JOIN ZnodePimProductTypeAssociation ZPTA ON(ZPTA.PimParentProductId = TBP.PimProductId)    
      INNER JOIN ZnodePublishProduct TBPU ON (TBPU.PimProductId = ZPTA.PimProductId AND TBPU.PublishCatalogId = TBP.PublishCatalogId )    
	  INNER JOIN ZnodePublishGroupProductEntity ZPGP ON ZPGP.VersionId = TBP.VersionId AND ZPGP.ZnodeProductId = TBP.PublishProductId 
		AND ZPGP.ZnodeCatalogId = TBP.PublishCatalogId AND ZPGP.AssociatedZnodeProductId = TBPU.PublishProductId AND ZPGP.ElasticSearchEvent <> 2  

      INSERT INTO ZnodePublishGroupProductEntity(VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder)    
      SELECT TBP.VersionId, TBP.PublishProductId ,TBP.PublishCatalogId ,TBPU.PublishProductId ,ISNULL(ZPTA.DisplayOrder,0)    
      FROM #TBL_PublishCatalogId TBP    
      INNER JOIN ZnodePimProductTypeAssociation ZPTA ON(ZPTA.PimParentProductId = TBP.PimProductId)    
      INNER JOIN ZnodePublishProduct TBPU ON (TBPU.PimProductId = ZPTA.PimProductId AND TBPU.PublishCatalogId = TBP.PublishCatalogId )    
	  WHERE NOT EXISTS(SELECT * FROM ZnodePublishGroupProductEntity ZPGP WHERE ZPGP.VersionId = TBP.VersionId AND ZPGP.ZnodeProductId = TBP.PublishProductId 
		AND ZPGP.ZnodeCatalogId = TBP.PublishCatalogId AND ZPGP.AssociatedZnodeProductId = TBPU.PublishProductId AND ZPGP.ElasticSearchEvent <> 2  )
   End     
            
			
   If @ProductType = 'ConfigurableProduct' AND Exists (Select TOP 1 1 from #TBL_PublishCatalogId)    
   Begin    
		 If (isnull(@PublishCatalogId ,'') = '' or isnull(@PublishCatalogId,0) = 0) and @VersionIdString = ''    
		 Begin    
			  UPDATE ZnodePublishConfigurableProductEntity SET ElasticSearchEvent = 2       
			  where not exists(select * from ZnodePublishProduct where ZnodePublishConfigurableProductEntity.ZnodeProductId = ZnodePublishProduct.PublishProductId)    
        
			  UPDATE ZnodePublishConfigurableProductEntity SET ElasticSearchEvent = 2  
			  where Exists ( Select TOP 1 1 from     
			  #TBL_PublishCatalogId A where ZnodePublishConfigurableProductEntity.ZnodeCatalogId =A.PublishCatalogId AND     
			  ZnodePublishConfigurableProductEntity.ZnodeProductId  = A.PublishProductId )     
			  AND Exists (SELECT TOP 1 1 FRoM #VesionIds     
			   Where ZnodePublishConfigurableProductEntity.VersionId =  #VesionIds.VersionId)    
		 end     
    
		SELECT DISTINCT TBP.VersionId, TBP.PublishProductId ,    
			  TBP.PublishCatalogId ,    
			  Isnull(TBPU.PublishProductId,0) AssociatedZnodeProductId,     
			  ISNULL(ZPTA.DisplayOrder,0) DisplayOrder,'[]' SelectValues,          
			  '[' + Isnull(SUBSTRING((SELECT Distinct ','+ +'"'+CAST(ZPA.AttributeCode AS VARCHAR(50)) +'"'     
			  FROM ZnodePimConfigureProductAttribute ZPCPA     
			  LEFT JOIN ZnodePimAttribute ZPA ON Zpa.PimAttributeId = ZPCPA.PimAttributeId 
			  WHERE ZPTA.PimParentProductId = ZPCPA.PimProductId
			  FOR XML PATH ('') ),2,2000),Null) +']' as ConfigurableAttributeCodes    
			  , ZPTA.IsDefault  
		  INTO #TempConfigurableProductEntity 
		 FROM #TBL_PublishCatalogId TBP    
		 INNER JOIN ZnodePimProductTypeAssociation ZPTA ON(ZPTA.PimParentProductId = TBP.PimProductId)    
		 INNER JOIN ZnodePublishProduct TBPU ON (TBPU.PimProductId = ZPTA.PimProductId AND TBPU.PublishCatalogId = TBP.PublishCatalogId )    
    
		 UPDATE ZPCP SET ZPCP.AssociatedProductDisplayOrder = AssociatedProductDisplayOrder,
			ConfigurableAttributeCodes = TBP.ConfigurableAttributeCodes,IsDefault = TBP.IsDefault
		 FROM #TempConfigurableProductEntity TBP    
		 INNER JOIN ZnodePublishConfigurableProductEntity ZPCP ON ZPCP.VersionId = TBP.VersionId 
			AND ZPCP.ZnodeProductId = TBP.PublishProductId AND ZPCP.ZnodeCatalogId = TBP.PublishCatalogId AND ZPCP.AssociatedZnodeProductId = TBP.AssociatedZnodeProductId
		 WHERE ElasticSearchEvent <> 2

		  Insert into ZnodePublishConfigurableProductEntity 
		  (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,    
		  SelectValues,ConfigurableAttributeCodes, IsDefault)    
		  SELECT DISTINCT TBP.VersionId, TBP.PublishProductId ,    
			  TBP.PublishCatalogId , TBP.AssociatedZnodeProductId,TBP.DisplayOrder ,TBP.SelectValues,          
			  TBP.ConfigurableAttributeCodes, TBP.IsDefault  
		 FROM #TempConfigurableProductEntity TBP    
		 WHERE NOT EXISTS(SELECT * FROM ZnodePublishConfigurableProductEntity ZPCP WHERE ZPCP.VersionId = TBP.VersionId 
			AND ZPCP.ZnodeProductId = TBP.PublishProductId AND ZPCP.ZnodeCatalogId = TBP.PublishCatalogId AND ZPCP.AssociatedZnodeProductId = TBP.AssociatedZnodeProductId)
		 AND ElasticSearchEvent <> 2

      IF OBJECT_ID('tempdb..#TBL_PublishCatalogId') is not null    
       drop table #TBL_PublishCatalogId    
    
      IF OBJECT_ID('tempdb..#ConfigurableProductPublishedXML') is not null    
       drop table #ConfigurableProductPublishedXML    
    
End     
COMMIT TRAN GetPublishAssociatedProducts;    
SET @Status = 1;    
END TRY    
	BEGIN CATCH    
	SELECT ERROR_MESSAGE()    
	SET @Status = 0;    
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishAssociatedProductsJson @PublishCatalogId = '+@PublishCatalogId+',@ProductType= '+@ProductType+',@VersionId='+CAST(@VersionId AS VARCHAR(50))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));    
                      
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                        
	ROLLBACK TRANSACTION GetPublishAssociatedProducts;    
	EXEC Znode_InsertProcedureErrorLog    
	@ProcedureName = 'Znode_GetPublishAssociatedProductsJson',    
	@ErrorInProcedure = @Error_procedure,    
	@ErrorMessage = @ErrorMessage,    
	@ErrorLine = @ErrorLine,    
	@ErrorCall = @ErrorCall;    
END CATCH;    
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishAssociatedProductsJson')
	DROP PROC Znode_GetPublishAssociatedProductsJson
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishAssociatedProductsJson]    
(       
     @PublishCatalogId VARCHAR(MAX) = '',    
     @PimProductId     TransferId Readonly,    
     @ProductType      VARCHAR(300) = 'BundleProduct',    
     @VersionId        INT          = 0,    
     @UserId           INT,    
     @PimCategoryHierarchyId int = 0,    
     @PublishStateId INT = 0  ,    
     @VersionIdString  VARCHAR(2000)= '',    
     @Status  BIT  Output,    
     @RevisionType Varchar(50) = ''    
)    
AS    
  /*    
    Summary : If PimcatalogId is provided then get all  Bundles / Group / Configurable product and  provide above mentioned data    
              If PimProductId is provided then get all Bundles / Group / Configurable if associated with given product id and provide above mentioned data    
       Input: @PublishCatalogId or @PimProductId    
       Output should be in XML format    
             Required o/p    
       <BundleProductEntity>    
       <ZnodeProductId></ZnodeProductId>    
       <ZnodeCatalogId></ZnodeCatalogId>    
       <AsscociadedZnodeProductIds></AsscociadedZnodeProductIds>    
       </BundleProductEntity>    
    Unit Testing     
    BundleProduct    
 DECLARE     
    EXEC [dbo].[Znode_GetPublishAssociatedProducts] @PublishCatalogId = 1  , @ProductType = 'BundleProduct' ,@userId = 2     
    EXEC [dbo].[Znode_GetPublishAssociatedProducts] @PublishCatalogId =2 , @ProductType = 'ConfigurableProduct',@userId = 2 ,@PimCategoryHierarchyId = 7     
    Group Product    
    EXEC [dbo].[Znode_GetPublishAssociatedProducts]  @PublishCatalogId ='2',@PimProductIdh =''  , @PimProducttType = 'GroupedProduct'    
    EXEC [dbo].[Znode_GetPublishAssociatedProducts]  @PublishCatalogId ='',@PimProductId ='200066'  , @PimProducttType = 'GroupedProduct'    
    EXEC [dbo].[Znode_GetPublishAssociatedProducts] @PimProductId ='200066'  , @PimProducttType = 'GroupedProduct'    
   */    
BEGIN    
BEGIN TRAN GetPublishAssociatedProducts;    
BEGIN TRY    
SET NOCOUNT ON;    
      
    IF OBJECT_ID('tempdb..#VesionIds') is not null    
    DROP TABLE #VesionIds    
    Create Table #VesionIds(ZnodeCatalogId int , VersionId int , LocaleId int , RevisionType varchar(50) )    
    
      If @VersionIdString <> ''       
    Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)     
    SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV Inner join Split(@VersionIdString,',') S ON PV.VersionId = S.Item    
    Else     
    Begin    
     If  (@RevisionType like '%Preview%'  OR @RevisionType like '%Production%' )    
      Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)     
      SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV  where PV.IsPublishSuccess =1     
      AND PV.RevisionType ='Preview'    
    
     If  (@RevisionType like '%Production%' OR @RevisionType = 'None')    
      Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)     
      SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV  where PV.IsPublishSuccess =1     
      AND PV.RevisionType ='Production'    
     end     
    
   IF OBJECT_ID('tempdb..#TBL_PublishCatalogId') is not null    
    DROP TABLE #TBL_PublishCatalogId    
       
   CREATE TABLE #TBL_PublishCatalogId (PublishCatalogId INT,PublishProductId INT,PimProductId  INT , VersionId INT,LocaleId INT  );    
   DECLARE  @PimAttributeId INT = [dbo].[Fn_GetProductTypeAttributeId]()    
     ,@PimAttributeDefaultValueId INT = (SELECT TOP 1 PimAttributeDefaultValueId FROM ZnodePimAttributeDefaultValue WHERE AttributeDefaultValueCode = @ProductType)    
     ,@DefaultLocaleId INT = dbo.fn_getDefaultlocaleId()     
   DECLARE @GetDate DATETIME =dbo.Fn_GetDate()    
        
   IF OBJECT_ID('tempdb..#TBL_PublisshIds') is not null    
   DROP TABLE #TBL_PublisshIds    
   Create TABLE #TBL_PublisshIds (PublishProductId INT , PimProductId INT , PublishCatalogId INT)    
    
   DECLARE  @PimProductId_New TransferId    
          
    IF  @PublishCatalogId IS NULL  OR @PublishCatalogId = 0     
    BEGIN     
    INSERT INTO #TBL_PublisshIds     
    Select ZPP.PublishProductId ,ZPP.PimProductId , ZPP.PublishCatalogId from ZnodePublishProduct ZPP Inner join @PimProductId  PPI on ZPP.PimProductId = PPI.ID    
      --EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId,@userid,@PimProductId,1    
          
      INSERT INTO @PimProductId_New    
      SELECT DISTINCT PimProductId FROM #TBL_PublisshIds    
    
     -- SELECT  @PimProductId     
    END     
        
    IF  ISnull(@PimCategoryHierarchyId,0) <> 0     
    BEGIN     
        
      INSERT INTO #TBL_PublisshIds     
      EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId,@userid,@PimProductId,1,@PimCategoryHierarchyId    
          
      --SET @PimProductId = SUBSTRING((SELECT DISTINCT ','+CAST(PimProductId AS VARCHAr(50)) FROM #TBL_PublisshIds FOR XML PATH ('')),2,8000 )    
    
      INSERT INTO @PimProductId_New    
      SELECT PimProductId FROM #TBL_PublisshIds    
    
          
    END     
    
    IF  ISnull(@PimCategoryHierarchyId,0) <> 0     
    BEGIN     
     INSERT INTO #TBL_PublishCatalogId     
     SELECT ZPP.PublishCatalogId , ZPP.PublishProductId,ZPP.PimProductId,MAX(ZPCP.PublishCatalogLogId) ,ZPCP.LocaleID      
     FROM ZnodePublishProduct ZPP     
     INNER JOIN ZnodePimAttributeValue ZPV ON (ZPV.PimProductId = ZPP.PimProductId )    
     INNER JOIN ZnodePimProductAttributeDefaultValue ZPAVL ON (ZPAVL.PimAttributeValueId = ZPV.PimAttributeValueId)    
     LEFT JOIN  ZnodePublishCatalogLog ZPCP ON (ZPCP.PublishCatalogId  = ZPP.PublishCatalogId)    
     WHERE (EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId   )     
     AND  (ZPP.PublishCatalogId =  @PublishCatalogId ))    
     AND ZPV.PimAttributeId  = @PimAttributeId    
     AND ZPAVL.PimAttributeDefaultValueId= @PimAttributeDefaultValueId    
     AND ZPAVL.LocaleId = @DefaultLocaleId    
     AND ISNULL(ZPCP.LocaleId,0) <> 0     
     AND ZPCP.PublishStateId= @PublishStateId    
     AND EXISTS(SELECT * FROM ZnodeLocale ZL where ZL.IsActive = 1  and ZPCP.LocaleId = ZL.LocaleId )    
     GROUP BY ZPP.PublishCatalogId , ZPP.PublishProductId,ZPP.PimProductId,ZPCP.LocaleID     
         
    END    
    ELSE     
    BEGIN     
        
    IF NOT EXISTS (SELECT TOP 1 1 FROM @PimProductId ) AND @PublishCatalogId <> 0    
    BEGIN    
      INSERT INTO #TBL_PublishCatalogId     
      SELECT distinct ZPP.PublishCatalogId , ZPP.PublishProductId,ZPP.PimProductId,  ZPCP.VersionId PublishCatalogLogId ,ZPCP.LocaleID     
      FROM ZnodePublishProduct ZPP     
      INNER JOIN ZnodePimAttributeValue ZPV ON (ZPV.PimProductId = ZPP.PimProductId )    
      INNER JOIN ZnodePimProductAttributeDefaultValue ZPAVL ON (ZPAVL.PimAttributeValueId = ZPV.PimAttributeValueId)    
      INNER JOIN  #VesionIds  ZPCP ON (ZPCP.ZnodeCatalogId  = ZPP.PublishCatalogId AND ISNULL(ZPCP.LocaleId,0) <> 0 )            
      WHERE     
      --(EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId  AND  @PublishCatalogId = '' )     
      --OR     
      (ZPP.PublishCatalogId =  @PublishCatalogId )    
      AND ZPV.PimAttributeId  = @PimAttributeId    
      AND ZPAVL.PimAttributeDefaultValueId= @PimAttributeDefaultValueId    
      AND ZPAVL.LocaleId = @DefaultLocaleId    
      AND EXISTS(SELECT * FROM ZnodeLocale ZL where ZL.IsActive = 1  and ZPCP.LocaleId = ZL.LocaleId )    
    END    
    ELSE    
    BEGIN    
      INSERT INTO #TBL_PublishCatalogId     
          
      SELECT distinct ZPP.PublishCatalogId , ZPP.PublishProductId,ZPP.PimProductId,  ZPCP.VersionId PublishCatalogLogId ,ZPCP.LocaleID     
      FROM ZnodePublishProduct ZPP     
      INNER JOIN ZnodePimAttributeValue ZPV ON (ZPV.PimProductId = ZPP.PimProductId )    
      INNER JOIN ZnodePimProductAttributeDefaultValue ZPAVL ON (ZPAVL.PimAttributeValueId = ZPV.PimAttributeValueId)    
      LEFT JOIN  #VesionIds ZPCP ON (ZPCP.ZnodeCatalogId  = ZPP.PublishCatalogId AND ISNULL(ZPCP.LocaleId,0) <> 0 )            
      WHERE (EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId  AND ZPP.PublishCatalogId = SP.PublishCatalogId) )    
      AND ZPV.PimAttributeId  = @PimAttributeId    
      AND ZPAVL.PimAttributeDefaultValueId= @PimAttributeDefaultValueId    
      AND ZPAVL.LocaleId = @DefaultLocaleId    
      AND EXISTS(SELECT * FROM ZnodeLocale ZL where ZL.IsActive = 1  and ZPCP.LocaleId = ZL.LocaleId )    
      --GROUP BY ZPP.PublishCatalogId , ZPP.PublishProductId,ZPP.PimProductId,ZPCP.LocaleID,    
    
    END     
         
    END    
        
             DECLARE @TBL_ProductTypeXML TABLE    
             (PublishProductId INT,    
			  PublishCatalogId INT,    
              ReturnXML        XML,    
              VersionId        INT    
             );    
             DECLARE @TBL_PimProductId TABLE    
             ([PimProductId]   INT,    
              PublishCatalogId INT,    
			  PublishProductId INT    
             );    
                
             DECLARE @TBL_PimAssociatedEntity TABLE    
             (    
				ZnodeProductId INT,    
				ZnodeCatalogId INT,    
				AsscociadedZnodeProductIds VARCHAR(MAX),    
				ConfigurableProductEntity NVARCHAR(MAX),    
				LocaleId INT,    
				DisplayOrder INT,    
				VersionId INT    
             );    
    
    If @ProductType = 'BundleProduct' AND Exists (Select TOP 1 1 from #TBL_PublishCatalogId)    
    Begin    
               IF OBJECT_ID('tempdb..#BundleProductPublishedXML') is not null    
					drop table #BundleProductPublishedXML    
    
		 IF (isnull(@PublishCatalogId ,'') = '' or isnull(@PublishCatalogId,0) = 0) and @VersionIdString = ''    
		 Begin     
			  UPDATE ZnodePublishBundleProductEntity SET ElasticSearchEvent = 2 
			  where not exists(select * from ZnodePublishProduct where ZnodePublishBundleProductEntity.ZnodeProductId = ZnodePublishProduct.PublishProductId)    
          
			  UPDATE ZnodePublishBundleProductEntity SET ElasticSearchEvent = 2 
			  where Exists ( Select TOP 1 1 from     
			  #TBL_PublishCatalogId A where ZnodePublishBundleProductEntity.ZnodeCatalogId =A.PublishCatalogId AND     
			  ZnodePublishBundleProductEntity.ZnodeProductId  = A.PublishProductId )    
			  AND Exists (SELECT TOP 1 1 FRoM #VesionIds     
			  Where ZnodePublishBundleProductEntity.VersionId =  #VesionIds.VersionId)    
		END     
    
		 UPDATE ZPBP SET AssociatedProductDisplayOrder = ISNULL(ZPTA.DisplayOrder,0),AssociatedProductBundleQuantity = ISNULL(ZPTA.BundleQuantity,1)
		 FROM #TBL_PublishCatalogId TBP    
		 INNER JOIN ZnodePimProductTypeAssociation ZPTA ON(ZPTA.PimParentProductId = TBP.PimProductId)    
		 INNER JOIN ZnodePublishProduct TBPU ON (TBPU.PimProductId = ZPTA.PimProductId AND TBPU.PublishCatalogId = TBP.PublishCatalogId )
		 INNER JOIN ZnodePublishBundleProductEntity ZPBP on  TBP.VersionId = ZPBP.VersionId AND TBP.PublishProductId = ZPBP.ZnodeProductId
			AND TBP.PublishCatalogId = ZPBP.ZnodeCatalogId AND TBPU.PublishProductId = ZPBP.AssociatedZnodeProductId
		 WHERE ZPBP.ElasticSearchEvent <> 2 


		 INSERT INTO ZnodePublishBundleProductEntity     
		 (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,AssociatedProductBundleQuantity)    
		 SELECT TBP.VersionId, TBP.PublishProductId, TBP.PublishCatalogId ,    
		 TBPU.PublishProductId AssociatedZnodeProductId,ISNULL(ZPTA.DisplayOrder,0)  AssociatedProductDisplayOrder,ISNULL(ZPTA.BundleQuantity,1)  AS AssociatedProductBundleQuantity  
		 FROM #TBL_PublishCatalogId TBP    
		 INNER JOIN ZnodePimProductTypeAssociation ZPTA ON(ZPTA.PimParentProductId = TBP.PimProductId)    
		 INNER JOIN ZnodePublishProduct TBPU ON (TBPU.PimProductId = ZPTA.PimProductId AND TBPU.PublishCatalogId = TBP.PublishCatalogId )
		 WHERE NOT EXISTS(SELECT * FROM ZnodePublishBundleProductEntity ZPBP WHERE  TBP.VersionId = ZPBP.VersionId AND TBP.PublishProductId = ZPBP.ZnodeProductId
			AND TBP.PublishCatalogId = ZPBP.ZnodeCatalogId AND TBPU.PublishProductId = ZPBP.AssociatedZnodeProductId AND ZPBP.ElasticSearchEvent <> 2 )
   End     
   
   If @ProductType = 'GroupedProduct' AND Exists (Select TOP 1 1 from #TBL_PublishCatalogId)    
   Begin    
		 IF (isnull(@PublishCatalogId ,'') = '' or isnull(@PublishCatalogId,0) = 0) and @VersionIdString = ''    
		 Begin     
			  UPDATE ZnodePublishGroupProductEntity SET ElasticSearchEvent = 2     
			  WHERE NOT EXISTS(SELECT * FROM ZnodePublishProduct WHERE ZnodePublishGroupProductEntity.ZnodeProductId = ZnodePublishProduct.PublishProductId)    
            
			  UPDATE ZnodePublishGroupProductEntity SET ElasticSearchEvent = 2  
			  where Exists ( Select TOP 1 1 from     
				  #TBL_PublishCatalogId A where ZnodePublishGroupProductEntity.ZnodeCatalogId =A.PublishCatalogId AND     
				  ZnodePublishGroupProductEntity.ZnodeProductId  = A.PublishProductId )    
				  AND Exists (SELECT TOP 1 1 FRoM #VesionIds     
			   Where ZnodePublishGroupProductEntity.VersionId =  #VesionIds.VersionId)    
		 end     
    
	  UPDATE ZPGP SET AssociatedProductDisplayOrder = ISNULL(ZPTA.DisplayOrder,0),ElasticSearchEvent = 1
	  FROM #TBL_PublishCatalogId TBP    
      INNER JOIN ZnodePimProductTypeAssociation ZPTA ON(ZPTA.PimParentProductId = TBP.PimProductId)    
      INNER JOIN ZnodePublishProduct TBPU ON (TBPU.PimProductId = ZPTA.PimProductId AND TBPU.PublishCatalogId = TBP.PublishCatalogId )    
	  INNER JOIN ZnodePublishGroupProductEntity ZPGP ON ZPGP.VersionId = TBP.VersionId AND ZPGP.ZnodeProductId = TBP.PublishProductId 
		AND ZPGP.ZnodeCatalogId = TBP.PublishCatalogId AND ZPGP.AssociatedZnodeProductId = TBPU.PublishProductId  

      INSERT INTO ZnodePublishGroupProductEntity(VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,ElasticSearchEvent)    
      SELECT TBP.VersionId, TBP.PublishProductId ,TBP.PublishCatalogId ,TBPU.PublishProductId ,ISNULL(ZPTA.DisplayOrder,0) ,1 as ElasticSearchEvent   
      FROM #TBL_PublishCatalogId TBP    
      INNER JOIN ZnodePimProductTypeAssociation ZPTA ON(ZPTA.PimParentProductId = TBP.PimProductId)    
      INNER JOIN ZnodePublishProduct TBPU ON (TBPU.PimProductId = ZPTA.PimProductId AND TBPU.PublishCatalogId = TBP.PublishCatalogId )    
	  WHERE NOT EXISTS(SELECT * FROM ZnodePublishGroupProductEntity ZPGP WHERE ZPGP.VersionId = TBP.VersionId AND ZPGP.ZnodeProductId = TBP.PublishProductId 
		AND ZPGP.ZnodeCatalogId = TBP.PublishCatalogId AND ZPGP.AssociatedZnodeProductId = TBPU.PublishProductId )

   End     
            
			
   If @ProductType = 'ConfigurableProduct' AND Exists (Select TOP 1 1 from #TBL_PublishCatalogId)    
   Begin    
		 If (isnull(@PublishCatalogId ,'') = '' or isnull(@PublishCatalogId,0) = 0) and @VersionIdString = ''    
		 Begin    
			  UPDATE ZnodePublishConfigurableProductEntity SET ElasticSearchEvent = 2       
			  where not exists(select * from ZnodePublishProduct where ZnodePublishConfigurableProductEntity.ZnodeProductId = ZnodePublishProduct.PublishProductId)    
        
			  UPDATE ZnodePublishConfigurableProductEntity SET ElasticSearchEvent = 2  
			  where Exists ( Select TOP 1 1 from     
			  #TBL_PublishCatalogId A where ZnodePublishConfigurableProductEntity.ZnodeCatalogId =A.PublishCatalogId AND     
			  ZnodePublishConfigurableProductEntity.ZnodeProductId  = A.PublishProductId )     
			  AND Exists (SELECT TOP 1 1 FRoM #VesionIds     
			   Where ZnodePublishConfigurableProductEntity.VersionId =  #VesionIds.VersionId)    
		 end     
    
		SELECT DISTINCT TBP.VersionId, TBP.PublishProductId ,    
			  TBP.PublishCatalogId ,    
			  Isnull(TBPU.PublishProductId,0) AssociatedZnodeProductId,     
			  ISNULL(ZPTA.DisplayOrder,0) DisplayOrder,'[]' SelectValues,          
			  '[' + Isnull(SUBSTRING((SELECT Distinct ','+ +'"'+CAST(ZPA.AttributeCode AS VARCHAR(50)) +'"'     
			  FROM ZnodePimConfigureProductAttribute ZPCPA     
			  LEFT JOIN ZnodePimAttribute ZPA ON Zpa.PimAttributeId = ZPCPA.PimAttributeId 
			  WHERE ZPTA.PimParentProductId = ZPCPA.PimProductId
			  FOR XML PATH ('') ),2,2000),Null) +']' as ConfigurableAttributeCodes    
			  , ZPTA.IsDefault  
		  INTO #TempConfigurableProductEntity 
		 FROM #TBL_PublishCatalogId TBP    
		 INNER JOIN ZnodePimProductTypeAssociation ZPTA ON(ZPTA.PimParentProductId = TBP.PimProductId)    
		 INNER JOIN ZnodePublishProduct TBPU ON (TBPU.PimProductId = ZPTA.PimProductId AND TBPU.PublishCatalogId = TBP.PublishCatalogId )    
    
		 UPDATE ZPCP SET ZPCP.AssociatedProductDisplayOrder = AssociatedProductDisplayOrder,
			ConfigurableAttributeCodes = TBP.ConfigurableAttributeCodes,IsDefault = TBP.IsDefault,ZPCP.ElasticSearchEvent =1
		 FROM #TempConfigurableProductEntity TBP    
		 INNER JOIN ZnodePublishConfigurableProductEntity ZPCP ON ZPCP.VersionId = TBP.VersionId 
			AND ZPCP.ZnodeProductId = TBP.PublishProductId AND ZPCP.ZnodeCatalogId = TBP.PublishCatalogId AND ZPCP.AssociatedZnodeProductId = TBP.AssociatedZnodeProductId

		  Insert into ZnodePublishConfigurableProductEntity 
		  (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,    
		  SelectValues,ConfigurableAttributeCodes, IsDefault,ElasticSearchEvent )    
		  SELECT DISTINCT TBP.VersionId, TBP.PublishProductId ,    
			  TBP.PublishCatalogId , TBP.AssociatedZnodeProductId,TBP.DisplayOrder ,TBP.SelectValues,          
			  TBP.ConfigurableAttributeCodes, TBP.IsDefault  ,1 as ElasticSearchEvent
		 FROM #TempConfigurableProductEntity TBP    
		 WHERE NOT EXISTS(SELECT * FROM ZnodePublishConfigurableProductEntity ZPCP WHERE ZPCP.VersionId = TBP.VersionId 
			AND ZPCP.ZnodeProductId = TBP.PublishProductId AND ZPCP.ZnodeCatalogId = TBP.PublishCatalogId AND ZPCP.AssociatedZnodeProductId = TBP.AssociatedZnodeProductId and isnull(ZPCP.ElasticSearchEvent,0) <> 2)
		 

		 Update ZPC SET ZPC.ElasticSearchEvent =2 from ZnodePublishConfigurableProductEntity  ZPC  Where Exists 
		 (Select TOP 1 1 From #TempConfigurableProductEntity X Where ZPC.ZnodeProductId = X.PublishProductId and ZPC.ZnodeCatalogId = X.PublishCatalogId)
		 AND NOT Exists 
		(Select TOP 1 1 From #TempConfigurableProductEntity XP Where ZPC.ZnodeProductId = XP.PublishProductId and ZPC.ZnodeCatalogId = XP.PublishCatalogId
		 and XP.AssociatedZnodeProductId = ZPC.AssociatedZnodeProductId)


      IF OBJECT_ID('tempdb..#TBL_PublishCatalogId') is not null    
       drop table #TBL_PublishCatalogId    
    
      IF OBJECT_ID('tempdb..#ConfigurableProductPublishedXML') is not null    
       drop table #ConfigurableProductPublishedXML    
    
End     
COMMIT TRAN GetPublishAssociatedProducts;    
SET @Status = 1;    
END TRY    
	BEGIN CATCH    
	SELECT ERROR_MESSAGE()    
	SET @Status = 0;    
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishAssociatedProductsJson @PublishCatalogId = '+@PublishCatalogId+',@ProductType= '+@ProductType+',@VersionId='+CAST(@VersionId AS VARCHAR(50))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));    
                      
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                        
	ROLLBACK TRANSACTION GetPublishAssociatedProducts;    
	EXEC Znode_InsertProcedureErrorLog    
	@ProcedureName = 'Znode_GetPublishAssociatedProductsJson',    
	@ErrorInProcedure = @Error_procedure,    
	@ErrorMessage = @ErrorMessage,    
	@ErrorLine = @ErrorLine,    
	@ErrorCall = @ErrorCall;    
END CATCH;    
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishCategoryJson')
	DROP PROC Znode_GetPublishCategoryJson
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishCategoryJson]
(   
	@PublishCatalogId INT,
	@UserId           INT,
	@Status           BIT = 0 OUT,
	@IsDebug          BIT = 0,
	@VersionIdString  VARCHAR(2000)= '',
	@LocaleId         TransferID READONLY,
	@RevisionState    VARCHAR(50) = ''
)
AS 
/*
Summary:Publish category with their respective products and details 
The result is fetched in xml form   
Unit Testing   
Begin transaction 
SELECT * FROM ZnodePIMAttribute 
SELECT * FROM ZnodePublishCatalog 
SELECT * FROM ZnodePublishCategory WHERE publishCAtegoryID = 167 


EXEC [Znode_GetPublishCategory] @PublishCatalogId = 3,@VersionId = 0 ,@UserId =2 ,@IsDebug = 1 
     


Rollback Transaction 
*/
BEGIN
BEGIN TRAN GetPublishCategory;
BEGIN TRY
SET NOCOUNT ON;
	DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
	DECLARE @LocaleIdIn INT= 0, @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId(), @Counter INT= 1, @MaxId INT= 0, @CategoryIdCount INT;
	DECLARE @IsActive BIT= [dbo].[Fn_GetIsActiveTrue]();
	DECLARE @AttributeIds VARCHAR(MAX)= '', @PimCategoryIds VARCHAR(MAX)= '', @DeletedPublishCategoryIds VARCHAR(MAX)= '', @DeletedPublishProductIds VARCHAR(MAX);
	--get the pim catalog id 
	DECLARE @PimCatalogId INT=(SELECT PimCatalogId FROM ZnodePublishcatalog WHERE PublishCatalogId = @PublishCatalogId); 

	DECLARE @TBL_AttributeIds TABLE
	(
		PimAttributeId       INT,
		ParentPimAttributeId INT,
		AttributeTypeId      INT,
		AttributeCode        VARCHAR(600),
		IsRequired           BIT,
		IsLocalizable        BIT,
		IsFilterable         BIT,
		IsSystemDefined      BIT,
		IsConfigurable       BIT,
		IsPersonalizable     BIT,
		DisplayOrder         INT,
		HelpDescription      VARCHAR(MAX),
		IsCategory           BIT,
		IsHidden             BIT,
		CreatedDate          DATETIME,
		ModifiedDate         DATETIME,
		AttributeName        NVARCHAR(MAX),
		AttributeTypeName    VARCHAR(300)
	);
	DECLARE @TBL_AttributeDefault TABLE
	(
		PimAttributeId            INT,
		AttributeDefaultValueCode VARCHAR(100),
		IsEditable                BIT,
		AttributeDefaultValue     NVARCHAR(MAX)
		,DisplayOrder   INT
	);
	DECLARE @TBL_AttributeValue TABLE
	(
		PimCategoryAttributeValueId INT,
		PimCategoryId               INT,
		CategoryValue               NVARCHAR(MAX),
		AttributeCode               VARCHAR(300),
		PimAttributeId              INT
	);
	DECLARE @TBL_LocaleIds TABLE
	(
		RowId     INT IDENTITY(1, 1),
		LocaleId  INT,
		IsDefault BIT
	);
	DECLARE @TBL_PimCategoryIds TABLE
	(
		PimCategoryId       INT,
		PimParentCategoryId INT,
		DisplayOrder        INT,
		ActivationDate      DATETIME,
		ExpirationDate      DATETIME,
		CategoryName        NVARCHAR(MAX),
		ProfileId           VARCHAR(MAX),
		IsActive            BIT,
		PimCategoryHierarchyId INT,
		ParentPimCategoryHierarchyId INT ,
		CategoryCode  NVARCHAR(MAX)             
	);


	DECLARE @TBL_PublishPimCategoryIds TABLE
	(
		PublishCategoryId       INT,
		PimCategoryId           INT,
		PublishProductId        varchar(max),
		PublishParentCategoryId INT ,
		PimCategoryHierarchyId INT ,parentPimCategoryHierarchyId INT,
		RowIndex INT
	);
	DECLARE @TBL_DeletedPublishCategoryIds TABLE
	(
		PublishCategoryId INT,
		PublishProductId  INT
	);
	DECLARE @TBL_CategoryXml TABLE
	(
		PublishCategoryId INT,
		CategoryXml       XML,
		LocaleId          INT
	);
	INSERT INTO @TBL_LocaleIds
	(
		LocaleId,
		IsDefault
	)
	-- here collect all locale ids
	SELECT LocaleId,IsDefault FROM ZnodeLocale MT WHERE IsActive = @IsActive
	AND (EXISTS (SELECT TOP 1 1  FROM @LocaleId RT WHERE RT.Id = MT.LocaleId )
	OR NOT EXISTS (SELECT TOP 1 1 FROM @LocaleId ));

	IF OBJECT_ID('tempdb..#VesionIds') is not null
		DROP TABLE #VesionIds
  				 
	SELECT PV.* INTO #VesionIds FROM ZnodePublishVersionEntity PV Inner join Split(@VersionIdString,',') S ON PV.VersionId = S.Item
		

	if object_id('tempdb..#CategoryData')is not null
		DROP TABLE #CategoryData

	------------for CategoryCode update
	SELECT ZPCAL.CategoryValue as CategoryCode,MAX(ZPC.PublishCategoryId) as PublishCategoryId ,ZPCA.PimCategoryId, ZPoC.PortalId
	INTO #CategoryData
	FROM ZnodePimCategoryAttributeValue ZPCA
	INNER JOIN ZnodePimCategoryAttributeValueLocale ZPCAL on ZPCA.PimCategoryAttributeValueId = ZPCAL.PimCategoryAttributeValueId
	INNER JOIN ZnodePimAttribute ZPA ON ZPCA.PimAttributeId = ZPA.PimAttributeId
	INNER JOIN ZnodePublishCategory ZPC on ZPCA.PimCategoryId = ZPC.PimCategoryId
	INNER JOIN ZnodePortalCatalog ZPoC on ZPC.PublishCatalogId = ZPoC.PublishCatalogId
	WHERE ZPA.AttributeCode = 'CategoryCode' AND ZPC.PublishCatalogId = @PublishCatalogId
	AND EXISTS(SELECT * FROM ZnodeCMSWidgetCategory ZCWC WHERE ZPC.PublishCategoryId = ZCWC.PublishCategoryId )
	GROUP BY ZPCAL.CategoryValue, ZPCA.PimCategoryId, ZPoC.PortalId

	UPDATE ZCWC SET ZCWC.CategoryCode = CD.CategoryCode
	FROM ZnodeCMSWidgetCategory ZCWC
	INNER JOIN #CategoryData CD ON ZCWC.PublishCategoryId = CD.PublishCategoryId and ZCWC.CMSMappingId = CD.PortalId
	WHERE ZCWC.TypeOFMapping = 'PortalMapping'
	----------

	INSERT INTO @TBL_PimCategoryIds(PimCategoryId,PimParentCategoryId,DisplayOrder,ActivationDate,ExpirationDate,IsActive,PimCategoryHierarchyId,ParentPimCategoryHierarchyId)
	SELECT DISTINCT ZPCH.PimCategoryId,ZPCH2.PimCategoryId  PimParentCategoryId,ZPCH.DisplayOrder,ZPCH.ActivationDate,ZPCH.ExpirationDate,ZPCH.IsActive ,ZPCH.PimCategoryHierarchyId,ZPCH.ParentPimCategoryHierarchyId
	FROM ZnodePimCategoryHierarchy AS ZPCH 
	LEFT JOIN ZnodePimCategoryHierarchy AS ZPCH2 ON (ZPCH2.PimCategoryHierarchyId = ZPCH. ParentPimCategoryHierarchyId ) 
	WHERE ZPCH.PimCatalogId = @PimCatalogId; 
	
	-- here is find the deleted publish category id on basis of publish catalog
	INSERT INTO @TBL_DeletedPublishCategoryIds(PublishCategoryId,PublishProductId)
	SELECT ZPC.PublishCategoryId,ZPCP.PublishProductId 
	FROM ZnodePublishCategoryProduct ZPCP
	INNER JOIN ZnodePublishCategory AS ZPC ON(ZPCP.PublishCategoryId = ZPC.PublishCategoryId AND ZPCP.PublishCatalogId = ZPC.PublishCatalogId)                                                  
	INNER JOIN ZnodePublishProduct ZPP ON(zpp.PublishProductId = zpcp.PublishProductId AND zpp.PublishCatalogId = zpcp.PublishCatalogId)
	INNER JOIN ZnodePublishCatalog ZPCC ON(ZPCC.PublishCatalogId = ZPCP.PublishCatalogId)
	WHERE ZPC.PublishCatalogId = @PublishCataLogId 
	AND NOT EXISTS(SELECT TOP 1 1 FROM ZnodePimCategoryHierarchy AS TBPC WHERE TBPC.PimCategoryId = ZPC.PimCategoryId AND TBPC.PimCategoryHierarchyId = ZPC.PimCategoryHierarchyId
	AND TBPC.PimCatalogId = ZPCC.PimCatalogId);

	-- here is find the deleted publish category id on basis of publish catalog
	SET @DeletedPublishCategoryIds = ISNULL(SUBSTRING((SELECT ','+CAST(PublishCategoryId AS VARCHAR(50)) FROM @TBL_DeletedPublishCategoryIds AS ZPC
				GROUP BY ZPC.PublishCategoryId FOR XML PATH('') ), 2, 4000), '');
	-- here is find the deleted publish category id on basis of publish catalog
	SET @DeletedPublishProductIds = '';
	
	EXEC Znode_DeletePublishCatalog @PublishCatalogIds = @PublishCatalogId,@PublishCategoryIds = @DeletedPublishCategoryIds,@PublishProductIds = @DeletedPublishProductIds; 
		
	MERGE INTO ZnodePublishCategory TARGET USING  @TBL_PimCategoryIds SOURCE ON
	(
		TARGET.PimCategoryId = SOURCE.PimCategoryId 
		AND TARGET.PublishCatalogId = @PublishCataLogId 
		AND TARGET.PimCategoryHierarchyId = SOURCE.PimCategoryHierarchyId
	)
	WHEN MATCHED THEN UPDATE SET TARGET.PimParentCategoryId = SOURCE.PimParentCategoryId,TARGET.CreatedBy = @UserId,TARGET.CreatedDate = @GetDate,
	TARGET.ModifiedBy = @UserId,TARGET.ModifiedDate = @GetDate,PimCategoryHierarchyId = SOURCE.PimCategoryHierarchyId,ParentPimCategoryHierarchyId=SOURCE.ParentPimCategoryHierarchyId
	WHEN NOT MATCHED THEN INSERT(PimCategoryId,PublishCatalogId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PimCategoryHierarchyId,ParentPimCategoryHierarchyId) 
	VALUES(SOURCE.PimCategoryId,@PublishCatalogId,@UserId,@GetDate,@UserId,@GetDate,SOURCE.PimCategoryHierarchyId,SOURCE.ParentPimCategoryHierarchyId)
	OUTPUT INSERTED.PublishCategoryId,INSERTED.PimCategoryId,INSERTED.PimCategoryHierarchyId,INSERTED.parentPimCategoryHierarchyId INTO @TBL_PublishPimCategoryIds(PublishCategoryId,PimCategoryId,PimCategoryHierarchyId,parentPimCategoryHierarchyId);
     
	-- here update the publish parent category id
	UPDATE ZPC SET [PimParentCategoryId] =TBPC.[PimCategoryId] 
	FROM ZnodePublishCategory ZPC
	INNER JOIN ZnodePublishCategory TBPC ON(ZPC.parentPimCategoryHierarchyId = TBPC.PimCategoryHierarchyId  ) 
	WHERE ZPC.PublishCatalogId =@PublishCatalogId
	AND ZPC.ParentPimCategoryHierarchyId IS NOT NULL
	AND TBPC.PublishCatalogId =@PublishCatalogId;

	UPDATE a
	SET  a.PublishParentCategoryId = b.PublishCategoryId
	FROM ZnodePublishCategory a 
	INNER JOIN ZnodePublishCategory b   ON (a.parentpimCategoryHierarchyId = b.pimCategoryHierarchyId)
	WHERE a.parentpimCategoryHierarchyId IS NOT NULL 
	AND a.PublishCatalogId =@PublishCatalogId
	AND b.PublishCatalogId =@PublishCatalogId

	UPDATE a set a.PublishParentCategoryId = NULL
	FROM ZnodePublishCategory a 
	WHERE a.parentpimCategoryHierarchyId IS NULL AND PimParentCategoryId IS NULL
	AND a.PublishCatalogId = @PublishCatalogId AND a.PublishParentCategoryId IS NOT NULL

	SET @MaxId =(SELECT MAX(RowId)FROM @TBL_LocaleIds);
	DECLARE @TransferID TRANSFERID 
	INSERT INTO @TransferID 
	SELECT DISTINCT  PimCategoryId
	FROM @TBL_PublishPimCategoryIds 

	SET @PimCategoryIds = SUBSTRING((SELECT ','+CAST(PimCategoryId AS VARCHAR(50)) FROM @TBL_PublishPimCategoryIds FOR XML PATH('')), 2, 4000);
		
	WHILE @Counter <= @MaxId -- Loop on Locale id 
	BEGIN
		SET @LocaleIdIn =(SELECT LocaleId FROM @TBL_LocaleIds WHERE RowId = @Counter);
                   
		SET @AttributeIds = SUBSTRING((SELECT ','+CAST(ZPCAV.PimAttributeId AS VARCHAR(50)) FROM ZnodePimCategoryAttributeValue ZPCAV 
				WHERE EXISTS(SELECT TOP 1 1 FROM @TBL_PimCategoryIds TBPC WHERE TBPC.PimCategoryId = ZPCAV.PimCategoryId) GROUP BY ZPCAV.PimAttributeId FOR XML PATH('')), 2, 4000);
                
		SET @CategoryIdCount =(SELECT COUNT(1) FROM @TBL_PimCategoryIds);

		INSERT INTO @TBL_AttributeIds (PimAttributeId,ParentPimAttributeId,AttributeTypeId,AttributeCode,IsRequired,IsLocalizable,IsFilterable,IsSystemDefined,
		IsConfigurable,IsPersonalizable,DisplayOrder,HelpDescription,IsCategory,IsHidden,CreatedDate,ModifiedDate,AttributeName,AttributeTypeName)
		EXEC [Znode_GetPimAttributesDetails] @AttributeIds,@LocaleIdIn;

		INSERT INTO @TBL_AttributeDefault (PimAttributeId,AttributeDefaultValueCode,IsEditable,AttributeDefaultValue,DisplayOrder)
		EXEC [dbo].[Znode_GetAttributeDefaultValueLocale] @AttributeIds,@LocaleIdIn;

		INSERT INTO @TBL_AttributeValue (PimCategoryAttributeValueId,PimCategoryId,CategoryValue,AttributeCode,PimAttributeId)
		EXEC [dbo].[Znode_GetCategoryAttributeValueId] @TransferID,@AttributeIds,@LocaleIdIn;


		;WITH Cte_UpdateDefaultAttributeValue AS 
		(
			SELECT TBAV.PimCategoryId,TBAV.PimAttributeId,SUBSTRING((SELECT ','+AttributeDefaultValue FROM @TBL_AttributeDefault TBD WHERE TBAV.PimAttributeId = TBD.PimAttributeId
			AND EXISTS(SELECT TOP 1 1 FROM Split(TBAV.CategoryValue, ',') SP WHERE SP.Item = TBD.AttributeDefaultValueCode)FOR XML PATH('')), 2, 4000) DefaultCategoryAttributeValue
			FROM @TBL_AttributeValue TBAV WHERE EXISTS(SELECT TOP 1 1 FROM @TBL_AttributeDefault TBAD WHERE TBAD.PimAttributeId = TBAV.PimAttributeId)
		)	 
		-- update the default value with locale 
		UPDATE TBAV SET CategoryValue = CTUDFAV.DefaultCategoryAttributeValue FROM @TBL_AttributeValue TBAV 
		INNER JOIN Cte_UpdateDefaultAttributeValue CTUDFAV ON(CTUDFAV.PimCategoryId = TBAV.PimCategoryId AND CTUDFAV.PimAttributeId = TBAV.PimAttributeId)
		WHERE CategoryValue IS NULL ;
					 
		-- here is update the media path  
		;WITH Cte_productMedia AS 
		(
			SELECT TBA.PimCategoryId,TBA.PimAttributeId,
			Isnull(
			(STUFF((SELECT ','+zm.PATH FROM ZnodeMedia ZM WHERE EXISTS
			(SELECT TOP 1 1 FROM dbo.split(TBA.CategoryValue, ',') SP
			WHERE SP.Item = CAST(Zm.MediaId AS VARCHAR(50)))FOR XML PATH(''),Type).value('.', 'varchar(max)'), 1, 1,'')) ,'no-image.png')
			CategoryValue
			FROM @TBL_AttributeValue TBA WHERE EXISTS(SELECT TOP 1 1 FROM [dbo].[Fn_GetProductMediaAttributeId]() FNMA WHERE FNMA.PImAttributeId = TBA.PimATtributeId)
		)
		UPDATE TBAV SET CategoryValue = CTCM.CategoryValue 
		FROM @TBL_AttributeValue TBAV 
		INNER JOIN Cte_productMedia CTCM ON(CTCM.PimCategoryId = TBAV.PimCategoryId
		AND CTCM.PimAttributeId = TBAV.PimAttributeId);
					 					
		;WITH Cte_PublishProductIds AS 
		(
			SELECT TBPC.PublishcategoryId,SUBSTRING((SELECT ','+CAST(PublishProductId AS VARCHAR(50))
			FROM ZnodePublishCategoryProduct ZPCP 
			WHERE ZPCP.PublishCategoryId = TBPC.publishCategoryId
			AND ZPCP.PimCategoryHierarchyId = TBPC.PimCategoryHierarchyId
			AND ZPCP.PublishCatalogId = @PublishCatalogId FOR XML PATH('')), 2, 8000) PublishProductId ,PimCategoryHierarchyId
			FROM @TBL_PublishPimCategoryIds TBPC
		)
		UPDATE TBPPC SET PublishProductId = CTPP.PublishProductId FROM @TBL_PublishPimCategoryIds TBPPC INNER JOIN Cte_PublishProductIds CTPP ON(TBPPC.PublishCategoryId = CTPP.PublishCategoryId 
		AND TBPPC.PimCategoryHierarchyId = CTPP.PimCategoryHierarchyId);

		;WITH Cte_CategoryProfile AS 
		(
			SELECT PimCategoryId,ZPCC.PimCategoryHierarchyId,
			SUBSTRING(( SELECT ','+CAST(ProfileId AS VARCHAR(50)) 
			FROM ZnodeProfile ZPC 
			INNER JOIN ZnodePimCategoryHierarchy ZPRCC ON(ZPRCC.PimCategoryHierarchyId = ZPCC.PimCategoryHierarchyId
			AND ZPRCC.PimCatalogId = ZPC.PimCatalogId) 
			WHERE ZPC.PimCatalogId = ZPCC.PimCatalogId FOR XML PATH('')), 2, 4000) ProfileIds
			FROM ZnodePimCategoryHierarchy ZPCC 
			WHERE EXISTS(SELECT TOP 1 1 FROM @TBL_PimCategoryIds TBPC 
			WHERE TBPC.PimCategoryId = ZPCC.PimCategoryId AND ZPCC.PimCatalogId = @PimCatalogId 
			AND ZPCC.PimCategoryHierarchyId = TBPC.PimCategoryHierarchyId)
		)                          
		UPDATE TBPC SET TBPC.ProfileId = CTCP.ProfileIds FROM @TBL_PimCategoryIds TBPC 
		LEFT JOIN Cte_CategoryProfile CTCP ON(CTCP.PimCategoryId = TBPC.PimCategoryId AND CTCP.PimCategoryHierarchyId = TBPC.PimCategoryHierarchyId );
                         
				     
		UPDATE TBPC SET TBPC.CategoryName = TBAV.CategoryValue FROM @TBL_PimCategoryIds TBPC INNER JOIN @TBL_AttributeValue TBAV ON(TBAV.PimCategoryId = TBPC.PimCategoryId
		AND EXISTS(SELECT TOP 1 1 FROM [dbo].[Fn_GetCategoryNameAttribute]() FNGCNA WHERE FNGCNA.PimAttributeId = TBAV.PimAttributeId));


		UPDATE TBPC SET TBPC.CategoryCode = TBAV.CategoryValue FROM @TBL_PimCategoryIds TBPC INNER JOIN @TBL_AttributeValue TBAV ON(TBAV.PimCategoryId = TBPC.PimCategoryId
		AND EXISTS(SELECT TOP 1 1 FROM dbo.Fn_GetCategoryCodeAttribute() FNGCNA WHERE FNGCNA.PimAttributeId = TBAV.PimAttributeId))

		-- here update the publish category details 
		;WITH Cte_UpdateCategoryDetails AS 
		(
			SELECT TBC.PimCategoryId,PublishCategoryId,CategoryName, TBPPC.PimCategoryHierarchyId,CategoryCode
			FROM @TBL_PimCategoryIds TBC
			INNER JOIN @TBL_PublishPimCategoryIds TBPPC ON(TBC.PimCategoryId = TBPPC.PimCategoryId AND TBC.PimCategoryHierarchyId = TBPPC.PimCategoryHierarchyId)
		)						
		MERGE INTO ZnodePublishCategoryDetail TARGET USING Cte_UpdateCategoryDetails SOURCE ON(TARGET.PublishCategoryId = SOURCE.PublishCategoryId
		AND TARGET.LocaleId = @LocaleIdIn)
		WHEN MATCHED THEN UPDATE SET PublishCategoryId = SOURCE.PublishcategoryId,PublishCategoryName = SOURCE.CategoryName,LocaleId = @LocaleIdIn,ModifiedBy = @userId,ModifiedDate = @GetDate,CategoryCode=SOURCE.CategoryCode
		WHEN NOT MATCHED THEN INSERT(PublishCategoryId,PublishCategoryName,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CategoryCode) VALUES
		(SOURCE.PublishCategoryId,SOURCE.CategoryName,@LocaleIdIn,@userId,@GetDate,@userId,@GetDate,SOURCE.CategoryCode);

		IF OBJECT_ID('tempdb..#Index') is not null
		BEGIN 
			DROP TABLE #Index
		END 

		CREATE TABLE #Index (RowIndex int ,PimCategoryId int , PimCategoryHierarchyId  int,ParentPimCategoryHierarchyId int )		
		INSERT INTO  #Index ( RowIndex ,PimCategoryId , PimCategoryHierarchyId,ParentPimCategoryHierarchyId)
		SELECT CAST(Row_number() OVER (Partition By TBL.PimCategoryId Order by ISNULL(TBL.PimCategoryId,0) desc) AS VARCHAR(100))
		,ZPC.PimCategoryId, ZPC.PimCategoryHierarchyId, ZPC.ParentPimCategoryHierarchyId
		FROM @TBL_PublishPimCategoryIds TBL
		INNER JOIN ZnodePublishCategory ZPC ON (TBL.PimCategoryId = ZPC.PimCategoryId AND TBL.PimCategoryHierarchyId = ZPC.PimCategoryHierarchyId)
		WHERE ZPC.PublishCatalogId = @PublishCatalogId

		UPDATE TBP SET  TBP.[RowIndex]=  IDX.RowIndex 
		FROM @TBL_PublishPimCategoryIds TBP INNER JOIN #Index IDX ON (IDX.PimCategoryId = TBP.PimCategoryId AND IDX.PimCategoryHierarchyId = TBP.PimCategoryHierarchyId)  
					
		IF OBJECT_ID('Tempdb..#CategoryEntity') IS NOT NULL
			DROP TABLE #CategoryEntity
						
					
		SELECT ISNULL(TYU.VersionId,'') VersionId,TBPC.PublishCategoryId ZnodeCategoryId,
		ISNULL(CategoryName, '') Name,ISNULL(CategoryCode,'') CategoryCode,
		ZPC.PublishCatalogId, ZPC.CatalogName ,
		Isnull('[' + THR.PublishParentCategoryId + ']',NULL) TempZnodeParentCategoryIds,
		ISNULL('[' + TBPC.PublishProductId + ']', NULL)  TempProductIds,
		@LocaleIdIn LocaleId,TBC.IsActive,ISNULL(DisplayOrder, '0') DisplayOrder,
		ISNULL(
		(
			SELECT TBA.AttributeCode,TBA.AttributeName,ISNULL(IsUseInSearch, 0) IsUseInSearch,
			ISNULL(IsHtmlTags, 0) IsHtmlTags,ISNULL(IsComparable, 0) IsComparable,
			TBAV.CategoryValue AttributeValues,TBA.AttributeTypeName 
			FROM @TBL_AttributeValue TBAV
			INNER JOIN @TBL_AttributeIds TBA ON(TBAV.PimAttributeId = TBA.PimAttributeId) 
			LEFT JOIN ZnodePimFrontendProperties ZPFP ON(ZPFP.PimAttributeId = TBA.PimAttributeId)
			WHERE TBC.PimCategoryId = TBAV.PimCategoryId  
			FOR JSON PATH) 
		, '[]')  as Attributes,
		ActivationDate,ExpirationDate,ISNULL(TBPC.RowIndex,1) CategoryIndex
		--,ProfileId TempProfileIds
		INTO #CategoryEntity
		FROM @TBL_PublishPimCategoryIds TBPC 
		INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId= @PublishCatalogId)
		LEFT JOIN #VesionIds TYU ON (TYU.ZnodeCatalogId = @PublishCatalogId AND TYU.LocaleId = @LocaleIdIn)
		INNER JOIN ZnodePublishCAtegory THR ON (THR.PimCategoryHierarchyId = TBPC.PimCategoryHierarchyId AND THR.PimCategoryId = TBPC.PimCategoryId AND THR.PublishCatalogId= @PublishCatalogId )
		INNER JOIN @TBL_PimCategoryIds TBC ON(TBC.PimCategoryId = TBPC.PimCategoryId AND TBC.PimCategoryHierarchyId = TBPC.PimCategoryHierarchyId) 
					
		UPDATE PCE SET PCE.ElasticSearchEvent = 2 FROM ZnodePublishCategoryEntity PCE
		WHERE NOT EXISTS(SELECT * FROM #CategoryEntity CE WHERE CE.VersionId = PCE.VersionId AND PCE.ZnodeCategoryId = CE.ZnodeCategoryId
		AND PCE.LocaleId = CE.LocaleId AND PCE.ZnodeCatalogId = CE.PublishCatalogId )
		AND PCE.LocaleId = @LocaleIdIn
		AND PCE.ZnodeCatalogId = @PublishCatalogId

		UPDATE PCE SET PCE.Name = CE.Name, PCE.ZnodeParentCategoryIds = CE.TempZnodeParentCategoryIds, PCE.ProductIds = CE.TempProductIds,
			PCE.IsActive = CE.IsActive,PCE.DisplayOrder = CE.DisplayOrder,PCE.Attributes = CE.Attributes,
			PCE.ActivationDate = CE.ActivationDate,PCE.ExpirationDate = CE.ExpirationDate,PCE.CategoryIndex = CE.CategoryIndex, PCE.ElasticSearchEvent = 1
		FROM ZnodePublishCategoryEntity PCE
		INNER JOIN #CategoryEntity CE ON CE.VersionId = PCE.VersionId AND PCE.ZnodeCategoryId = CE.ZnodeCategoryId
		AND PCE.LocaleId = CE.LocaleId AND PCE.ZnodeCatalogId = CE.PublishCatalogId
		AND PCE.LocaleId = @LocaleIdIn

		INSERT INTO ZnodePublishCategoryEntity
		(
			VersionId,ZnodeCategoryId,
			Name,CategoryCode,
			ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds,
			ProductIds,LocaleId,IsActive,DisplayOrder,
			Attributes,
			ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent
		)
		SELECT VersionId,ZnodeCategoryId,
		Name,CategoryCode,
		PublishCatalogId,CatalogName,TempZnodeParentCategoryIds,
		TempProductIds,LocaleId,IsActive,DisplayOrder,
		Attributes,
		ActivationDate,ExpirationDate,CategoryIndex, 1 as ElasticSearchEvent
		FROM #CategoryEntity CE
		WHERE NOT EXISTS(SELECT * FROM ZnodePublishCategoryEntity PCE WHERE CE.VersionId = PCE.VersionId AND PCE.ZnodeCategoryId = CE.ZnodeCategoryId
		AND PCE.LocaleId = CE.LocaleId AND PCE.ZnodeCatalogId = CE.PublishCatalogId )
		AND CE.LocaleId = @LocaleIdIn
					
		DELETE FROM @TBL_AttributeIds;
		DELETE FROM @TBL_AttributeDefault;
		DELETE FROM @TBL_AttributeValue;
		SET @Counter = @Counter + 1;
	END;
	
	UPDATE ZnodePublishCatalogLog 
	SET PublishCategoryId = (SELECT COunt(DISTINCT PimCategoryId ) 
	FROM @TBL_PublishPimCategoryIds WHERE PublishCatalogId =@PublishCatalogId), 
	IsCategoryPublished = 1 
	WHERE PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()

	------------for CategoryPublishId update
	SELECT ZPCAL.CategoryValue as CategoryCode,MAX(ZPC.PublishCategoryId) as PublishCategoryId ,ZPCA.PimCategoryId,ZPoC.PortalId
	INTO #CategoryData1
	FROM ZnodePimCategoryAttributeValue ZPCA
	INNER JOIN ZnodePimCategoryAttributeValueLocale ZPCAL on ZPCA.PimCategoryAttributeValueId = ZPCAL.PimCategoryAttributeValueId
	INNER JOIN ZnodePimAttribute ZPA ON ZPCA.PimAttributeId = ZPA.PimAttributeId
	INNER JOIN ZnodePublishCategory ZPC on ZPCA.PimCategoryId = ZPC.PimCategoryId
	INNER JOIN ZnodePortalCatalog ZPoC on ZPC.PublishCatalogId = ZPoC.PublishCatalogId
	WHERE ZPA.AttributeCode = 'CategoryCode' AND ZPC.PublishCatalogId = @PublishCatalogId
	GROUP BY ZPCAL.CategoryValue, ZPCA.PimCategoryId, ZPoC.PortalId

	UPDATE ZCWC SET ZCWC.PublishCategoryId = CD.PublishCategoryId
	FROM ZnodeCMSWidgetCategory ZCWC
	INNER JOIN #CategoryData1 CD ON ZCWC.CategoryCode = CD.CategoryCode and ZCWC.CMSMappingId = CD.PortalId
	WHERE ZCWC.TypeOFMapping = 'PortalMapping'

	IF (@RevisionState = 'PREVIEW')
		UPDATE ZnodePimCategory SET PublishStateId = Dbo.Fn_GetPublishStateIdForPreview() WHERE pimCategoryId IN (SELECT PimCategoryId FROM @TBL_PublishPimCategoryIds)
	Else 
		UPDATE ZnodePimCategory SET PublishStateId = Dbo.Fn_GetPublishStateIdForPublish() WHERE pimCategoryId IN (SELECT PimCategoryId FROM @TBL_PublishPimCategoryIds)

COMMIT TRAN GetPublishCategory;
SET @Status =1 
END TRY
BEGIN CATCH
	SELECT ERROR_MESSAGE();
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishCategory @PublishCatalogId = '+CAST(@PublishCatalogId AS VARCHAR(50))+',@UserId ='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(50));
	SET @Status = 0;
	ROLLBACK TRAN GetPublishCategory;
	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_GetPublishCategoryJson',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishProductJson')
	DROP PROC Znode_GetPublishProductJson
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishProductJson]  
(  
	@PublishCatalogId INT = 0   
	,@PimProductId     TransferId Readonly  
	,@UserId     INT = 0   
	,@PimCatalogId     INT = 0   
	,@VersionIdString  VARCHAR(2000)= ''  
	,@Status     Bit  OutPut  
	,@RevisionState   Varchar(50) = ''  
	,@IsDraftProductsOnly BIT = 1  
)  
WITH RECOMPILE 
AS  
/*  
DECLARE @rrte transferId   
INSERT INTO @rrte  
SELECT 1  
  
EXEC [_POC_Znode_GetPublishProductbulk] @PublishCatalogId=9,@UserId= 2 ,@localeIDs = @rrte,@PublishStateId = 3   
  
*/  
BEGIN  
BEGIN Try   
	SET NOCOUNT ON;  
	SET @Status = 0    
	Declare  @RevisionType VARCHAR(50) = ''   
	Declare @VersionId int = 0   
	DECLARE @PortalId INT = (SELECT TOP 1 POrtalId FROM ZnodePortalCatalog WHERE PublishCatalogId = @PublishCatalogId)  
	DECLARE @PriceListId INT = (SELECT TOP 1 PriceListId FROM ZnodePriceListPortal WHERE PortalId = @PortalId )  
	DECLARE @DomainUrl varchar(max) = (SELECT TOp 1 URL FROM ZnodeMediaConfiguration WHERE IsActive =1)  
	DECLARE @MaxSmallWidth INT  = (SELECT TOP 1  MAX(MaxSmallWidth) FROM ZnodeGlobalMediaDisplaySetting)  
	DECLARE @PimMediaAttributeId INT = dbo.Fn_GetProductImageAttributeId()  
  
	DECLARE @TBL_LocaleId  TABLE (RowId INT IDENTITY(1,1) PRIMARY KEY  , LocaleId INT , VersionId int,RevisionType varchar(50)  )  
	DECLARE @LocaleIds transferId   

	INSERT INTO @TBL_LocaleId (LocaleId,VersionId,RevisionType)  
	SELECT PV.LocaleId , PV.VersionId , PV.RevisionType  
	FROM ZnodePublishVersionEntity PV INNER JOIN Split(@VersionIdString,',') S ON PV.VersionId = S.Item  

	 --Getting active local for catalog which are associated to store
	INSERT INTO @LocaleIds (Id) 
	SELECT LocaleId FROM DBO.FN_GetCatalogPortalActiveLocale(@PublishCatalogId)
   
	DECLARE --@ProductNamePimAttributeId INT = dbo.Fn_GetProductNameAttributeId(),  
	@DefaultLocaleId INT= Dbo.Fn_GetDefaultLocaleId(),@LocaleId INT = 0   
	--,@SkuPimAttributeId  INT =  dbo.Fn_GetProductSKUAttributeId() , @IsActivePimAttributeId INT =  dbo.Fn_GetProductIsActiveAttributeId()  
	DECLARE @GetDate DATETIME =dbo.Fn_GetDate()  
  
	DECLARE @DefaultPortal int, @IsAllowIndexing int  
	SELECT @DefaultPortal = ZPC.PortalId, @IsAllowIndexing = 1 FROM ZnodePimCatalog ZPC INNER JOIN ZnodePublishCatalog ZPC1 ON ZPC.PimCatalogId = ZPC1.PimCatalogId WHERE ZPC1.PublishCatalogId =  @PublishCatalogId AND isnull(ZPC.IsAllowIndexing,0) = 1   
     
	-----DELETE unwanted publish data  
	DELETE ZPC FROM ZnodePublishCategoryProduct ZPC  
	WHERE NOT EXISTS(SELECT * FROM ZnodePublishCategory ZC WHERE ZPC.PublishCategoryId = ZC.PublishCategoryId )  
  
	DELETE ZPP FROM ZnodePublishCategoryProduct ZPP  
	WHERE NOT EXISTS(SELECT * FROM ZnodePublishProduct ZP WHERE ZPP.PublishProductId = ZP.PublishProductId )  
  
	DELETE ZPP FROM ZnodePublishCatalogProductDetail ZPP  
	WHERE NOT EXISTS(SELECT * FROM ZnodePublishProduct ZP WHERE ZPP.PublishProductId = ZP.PublishProductId )  
  
	DELETE ZPCP FROM ZnodePublishCatalogProductDetail ZPCP  
	INNER JOIN ZnodePublishProduct b on ZPCP.PublishProductId = b.PublishProductId   
	WHERE NOT EXISTS(SELECT * FROM ZnodePimCategoryProduct a  
	INNER JOIN ZnodePimCategoryHierarchy ZPCH on ZPCH.PimCategoryID = a.PimCategoryId   
	WHERE b.PimProductId = A.PimProductId AND ZPCP.PimCategoryHierarchyId = ZPCH.PimCategoryHierarchyId)  
	AND isnull(ZPCP.PimCategoryHierarchyId,0) <> 0 AND b.PublishCatalogId = @PublishCatalogId  
	---------  
  
	DECLARE @Counter INT =1 ,@maxCountId INT = (SELECT max(RowId) FROM @TBL_LocaleId )   
  
	CREATE TABLE #ZnodePrice (RetailPrice numeric(28,13),SalesPrice numeric(28,13),CurrencyCode varchar(100), CultureCode varchar(100), CurrencySuffix varchar(100), PublishProductId int)  
   
	CREATE TABLE #ProductSKU (SEOUrl nvarchar(max), SEODescription  nvarchar(max),SEOKeywords  nvarchar(max),SEOTitle  nvarchar(max), PublishProductId int)  
  
	CREATE TABLE #ProductImages (PublishProductId int, ImageSmallPath  varchar(max))  
  
	EXEC Znode_InsertUpdateAttributeDefaultValueJson 1   
	EXEC Znode_InsertUpdateCustomeFieldJson 1   
	EXEC Znode_InsertUpdatePimAttributeJson 1   
  
	---To draft all catalog products AND associated products for full catalog publish  
	IF @IsDraftProductsOnly = 0  
	BEGIN  
		EXEC Znode_CatalogProductDraftForPublish @PublishCatalogId=@PublishCatalogId   
	END  

	UPDATE ZnodePublishProductEntity SET ElasticSearchEvent = 0

	EXEC [Znode_InsertUpdatePimCatalogProductDetailJson] @PublishCatalogId=@PublishCatalogId,@LocaleId=@LocaleIds ,@UserId=@UserId ,@IsDraftProductsOnly = @IsDraftProductsOnly 


	IF (@IsAllowIndexing=1)  
	BEGIN   
		INSERT INTO #ZnodePrice  
		SELECT RetailPrice,SalesPrice,ZC.CurrencyCode,ZCC.CultureCode ,ZCC.Symbol CurrencySuffix,TYU.PublishProductId  
		FROM ZnodePrice ZP   
		INNER JOIN ZnodePriceList ZPL ON (ZPL.PriceListId = ZP.PriceListId)  
		INNER JOIN ZnodeCurrency ZC oN (ZC.CurrencyId = ZPL.CurrencyId )  
		INNER JOIN ZnodeCulture ZCC ON (ZCC.CultureId = ZPL.CultureId)  
		INNER JOIN ZnodePublishProductDetail TY ON (TY.SKU = ZP.SKU )   
		INNER JOIN ZnodePublishProduct TYU ON (TYU.PublishProductId = TY.PublishProductId)   
		WHERE ZP.PriceListId = @PriceListId   
		AND TY.LocaleId = @DefaultLocaleId  
		AND TYU.PublishCatalogId = @PublishCatalogId  
		AND EXISTS (SELECT TOP 1 1 FROM ZnodePriceListPortal ZPLP   
		INNER JOIN ZnodePimCatalog ZPC on ZPC.PortalId=ZPLP.PortalId WHERE ZPLP.PriceListId=ZP.PriceListId )  
		AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 WHERE TYU.PimProductId = ZPP1.PimProductId )  
		--+ CAST(@DefaultPortal AS VARCHAr(100)) + '/'  
		INSERT INTO #ProductImages  
		SELECT  TYU.PublishProductId , @DomainUrl +'Catalog/'  + CAST(@MaxSmallWidth AS VARCHAR(100)) + '/' + RT.MediaPath AS ImageSmallPath     
		FROM ZnodePimAttributeValue ZPAV   
		INNER JOIN ZnodePublishProduct TYU ON (TYU.PimProductId  = ZPAV.PimProductId)  
		INNER JOIN ZnodePimProductAttributeMedia  RT ON ( RT.PimAttributeValueId = ZPAV.PimAttributeValueId )  
		WHERE  TYU.PublishCatalogId = @PublishCatalogId  
		AND RT.LocaleId = @DefaultLocaleId  
		AND ZPAV.PimAttributeId = (SELECT TOp 1 PimAttributeId FROM ZnodePimAttribute WHERE AttributeCode = 'ProductImage')  
		AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 WHERE TYU.PimProductId = ZPP1.PimProductId )  
   
		INSERT INTO #ProductSKU   
		SELECT ZCSD.SEOUrl , ZCDL.SEODescription,ZCDL.SEOKeywords ,ZCDL.SEOTitle, TYU.PublishProductId  
		FROM ZnodeCMSSEODetail ZCSD   
		INNER JOIN ZnodeCMSSEODetailLocale ZCDL ON (ZCDL.CMSSEODetailId = ZCSD.CMSSEODetailId)  
		INNER JOIN ZnodePublishProductDetail TY ON (TY.SKU = ZCSD.SEOCode AND ZCDL.LocaleId = TY.LocaleId)   
		INNER JOIN ZnodePublishProduct TYU ON (TYU.PublishProductId = TY.PublishProductId)  
		WHERE CMSSEOTypeId = (SELECT TOP 1 CMSSEOTypeId FROM ZnodeCMSSEOType WHERE Name = 'Product')   
		AND ZCDL.LocaleId = @DefaultLocaleId  
		AND TYU.PublishCatalogId = @PublishCatalogId  
		--AND ZCSD.PublishStateId = @PublishStateId  
		AND ZCSD.PortalId = @DefaultPortal  
		AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 WHERE TYU.PimProductId = ZPP1.PimProductId )  
  
	END  
   
	CREATE NONCLUSTERED INDEX Idx_#ProductSKU_PublishProductId ON [dbo].[#ProductSKU] ([PublishProductId])  
	CREATE NONCLUSTERED INDEX Idx_#ProductImages_PublishProductId ON [dbo].#ProductImages ([PublishProductId])  
	CREATE NONCLUSTERED INDEX Idx_#ZnodePrice_PublishProductId ON [dbo].#ZnodePrice ([PublishProductId])  
	
	SELECT DISTINCT PublishProductId, x.LocaleId 
	INTO #PublishProducts 
	FROM ZnodePublishProduct ZPP
	INNER JOIN ##AttributeValueLocale x ON X.PimProductId = ZPP.PimProductId
	WHERE ZPP.PublishCatalogId = @PublishCatalogId

	CREATE INDEX #PublishProducts_PublishProductId on #PublishProducts(PublishProductId,LocaleId)
	--Creating products complete attribute json
	SELECT ZPP.Pimproductid, 
			ZPCPD.PimCatalogProductDetailId,ZPCPD.PublishProductId
			,ZPCPD.PublishCatalogId,ZPCPD.PimCategoryHierarchyId
			,ZPCPD.SKU,ZPCPD.ProductName,ZPCPD.CategoryName,ZPCPD.CatalogName
			,ZPCPD.LocaleId,ZPCPD.IsActive,ZPCPD.ProfileIds,ZPCPD.ProductIndex, 
		'[' +  
		(SELECT STUFF((SELECT ','+ AttributeEntity FROM ##AttributeValueLocale a   
		WHERE a.pimproductid = ZPP.pimproductid AND a.LocaleId = ZPCPD.LocaleId   
		FOR XML Path (''),Type).value('.', 'varchar(max)') ,1,1,'')  )   
		+ ']' AS ProductXML  
	INTO #ProductAttributeXML  
	FROM [ZnodePublishCatalogProductDetail] ZPCPD   
	INNER JOIN ZnodePublishProduct ZPP ON ZPCPD.PublishProductId = ZPP.PublishProductId AND ZPCPD.PublishCatalogId = ZPP.PublishCatalogId --WHERE TY.PimProductId = ZPP.PimProductId  AND TY.LocaleId = ZPCPD.LocaleId   
	WHERE ZPCPD.PublishCatalogId = @PublishCatalogId  
	AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId AND ZPCPD.LocaleId = X.LocaleId )
	GROUP BY ZPP.Pimproductid,ZPCPD.PimCatalogProductDetailId,ZPCPD.PublishProductId
			,ZPCPD.PublishCatalogId,ZPCPD.PimCategoryHierarchyId
			,ZPCPD.SKU,ZPCPD.ProductName,ZPCPD.CategoryName,ZPCPD.CatalogName
			,ZPCPD.LocaleId,ZPCPD.IsActive,ZPCPD.ProfileIds,ZPCPD.ProductIndex

	CREATE NONCLUSTERED INDEX Idx_#ProductAttributeXML_PimProductId_LocaleId  
	ON [dbo].#ProductAttributeXML (PimProductId,LocaleId)  
	
	IF (SELECT COUNT(*) FROM @LocaleIds) > 1
	BEGIN
		--INSERT INTO #ProductAttributeXML(Pimproductid,LocaleId,PublishProductId,ProductXML)
		SELECT ZPP.Pimproductid, 
			ZPCPD.PimCatalogProductDetailId,ZPCPD.PublishProductId
			,ZPCPD.PublishCatalogId,ZPCPD.PimCategoryHierarchyId
			,ZPCPD.SKU,ZPCPD.ProductName,ZPCPD.CategoryName,ZPCPD.CatalogName
			,ZPCPD.LocaleId,ZPCPD.IsActive,ZPCPD.ProfileIds,ZPCPD.ProductIndex,
			'[' +  
			(SELECT STUFF((SELECT ','+ AttributeEntity FROM ##AttributeValueLocale a   
			WHERE a.pimproductid = ZPP.pimproductid AND a.LocaleId = @DefaultLocaleId   
			FOR XML Path (''),Type).value('.', 'varchar(max)') ,1,1,'')  )   
			+ ']' AS ProductXML  
		INTO #ProductAttributeXML_LocaleWise
		FROM [ZnodePublishCatalogProductDetail] ZPCPD   
		INNER JOIN ZnodePublishProduct ZPP ON ZPCPD.PublishProductId = ZPP.PublishProductId AND ZPCPD.PublishCatalogId = ZPP.PublishCatalogId --WHERE TY.PimProductId = ZPP.PimProductId  AND TY.LocaleId = ZPCPD.LocaleId   
		WHERE ZPCPD.PublishCatalogId = @PublishCatalogId  
		AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId)
		AND NOT EXISTS(SELECT * FROM #ProductAttributeXML X WHERE ZPCPD.PublishProductId = X.PublishProductId AND X.LocaleId = ZPCPD.LocaleId )
		AND ZPCPD.LocaleId <> @DefaultLocaleId
		GROUP BY ZPP.Pimproductid, 
			ZPCPD.PimCatalogProductDetailId,ZPCPD.PublishProductId
			,ZPCPD.PublishCatalogId,ZPCPD.PimCategoryHierarchyId
			,ZPCPD.SKU,ZPCPD.ProductName,ZPCPD.CategoryName,ZPCPD.CatalogName
			,ZPCPD.LocaleId,ZPCPD.IsActive,ZPCPD.ProfileIds,ZPCPD.ProductIndex

		CREATE NONCLUSTERED INDEX Idx_#ProductAttributeXML_LocaleWise_PimProductId_LocaleId  
		ON [dbo].#ProductAttributeXML (PimProductId,LocaleId) 
	END
	


	DECLARE @MaxCount INT, @MinRow INT, @MaxRow INT, @Rows numeric(10,2);  
	SELECT @MaxCount = COUNT(*) FROM [ZnodePublishCatalogProductDetail] ZPCPD WHERE PublishCatalogId = @PublishCatalogId  
	AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId)
  
	SELECT @Rows = 50000  
          
	SELECT @MaxCount = CEILING(@MaxCount / @Rows);  
  
	SELECT PimCatalogProductDetailId, PublishProductId,Row_Number() over(Order by PublishProductId) ID into #ZnodePublishCatalogProductDetail 
	FROM [ZnodePublishCatalogProductDetail] ZPCPD WHERE PublishCatalogId = @PublishCatalogId  
	AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId)
  
	UPDATE ZPPAX SET ZPPAX.ElasticSearchEvent = 2
	FROM ZnodePublishProductEntity ZPPAX
	WHERE NOT EXISTS(SELECT * from [ZnodePublishCatalogProductDetail] ZLW WHERE ZPPAX.ZnodeProductId = ZLW.PublishProductId 
						AND ZPPAX.LocaleId = ZLW.LocaleId AND ZPPAX.ZnodeCatalogId = ZLW.PublishCatalogId )
	AND ZPPAX.ZnodeCatalogId = @PublishCatalogId 

	--Delete products from category from publish tables which are removed from one category and added into other category
	--UPDATE ZPPE SET ZPPE.ElasticSearchEvent = 2 FROM ZnodePublishProductEntity ZPPE
	--WHERE NOT EXISTS(SELECT * FROM ZnodePublishCategoryProduct ZPCP WHERE ZPPE.ZnodeCategoryIds = ZPCP.PublishCategoryId AND ZPPE.ZnodeProductId = ZPCP.PublishProductId
	--AND ZPPE.ZnodeCatalogId = ZPCP.PublishCatalogId)
	--AND ZPPE.ZnodeCatalogId = @PublishCatalogId
	--AND Not Exists (Select TOP 1 1 From ZnodePublishConfigurableProductEntity X Where X.AssociatedZnodeProductId = ZPPE.ZnodeProductId )
	--AND Isnull(ZPPE.ZnodeCategoryIds ,'') = '0'
	
	UPDATE ZPPE SET ZPPE.ElasticSearchEvent = 2 FROM ZnodePublishProductEntity ZPPE
	WHERE NOT EXISTS(SELECT * FROM ZnodePublishCategoryProduct ZPCP WHERE ZPPE.ZnodeCategoryIds = ZPCP.PublishCategoryId AND ZPPE.ZnodeProductId = ZPCP.PublishProductId
	AND ZPPE.ZnodeCatalogId = ZPCP.PublishCatalogId)
	AND ZPPE.ZnodeCatalogId = @PublishCatalogId
	AND Isnull(ZPPE.ZnodeCategoryIds ,'') <> ''


 --   --Delete data which are not present in catalog publish
	--Declare @Batch Bigint
	--SET @Batch = 1;
	--WHILE @Batch > 0
	--BEGIN 
	--	--BEGIN TRAN DelProd
	--		DELETE top (5000)  ZPPAX
	--		from ZnodePublishProductEntity ZPPAX
	--		WHERE NOT EXISTS(SELECT * from [ZnodePublishCatalogProductDetail] ZLW WHERE ZPPAX.ZnodeProductId = ZLW.PublishProductId 
	--							AND ZPPAX.LocaleId = ZLW.LocaleId AND ZPPAX.ZnodeCatalogId = ZLW.PublishCatalogId )
	--		AND ZPPAX.ZnodeCatalogId = @PublishCatalogId  
	--	--COMMIT TRAN DelProd
	--	SET @Batch = @@ROWCOUNT;
	--END
	
	SELECT ZPCP.PublishCategoryId,ZPCP.PublishProductId,ZPCP.PublishCatalogId,ZPCP.PimCategoryHierarchyId,ZPC.PimCategoryId,ZPCCF.PimProductId ,ZPCCF.DisplayOrder
	INTO #TempPublishCategoryProduct
	FROM ZnodePublishCategoryProduct ZPCP 
	INNER JOIN ZnodePublishProduct ZPP ON ZPCP.PublishProductId = ZPP.PublishProductId AND ZPCP.PublishCatalogId = ZPP.PublishCatalogId
	INNER JOIN ZnodePublishCategory ZPC ON (ZPCP.PublishCatalogId = ZPC.PublishCatalogId AND   ZPC.PublishCategoryId = ZPCP.PublishCategoryId AND ZPCP.PimCategoryHierarchyId = ZPC.PimCategoryHierarchyId)
	INNER JOIN ZnodePimCategoryProduct ZPCCF ON (ZPCCF.PimCategoryId = ZPC.PimCategoryId  AND ZPCCF.PimProductId = ZPP.PimProductId )
	WHERE EXISTS(SELECT * FROM [ZnodePublishCatalogProductDetail] ZPCPD WHERE (ZPCP.PublishProductId = ZPCPD.PublishProductId AND ZPCP.PublishCatalogId = ZPCPD.PublishCatalogId AND ZPCP.PimCategoryHierarchyId = ZPCPD.PimCategoryHierarchyId))		
	AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCP.PublishProductId = X.PublishProductId)
	AND ZPCP.PublishCatalogId = @PublishCatalogId 

	CREATE NONCLUSTERED INDEX Id_#TempPublishCategoryProduct_1 ON #TempPublishCategoryProduct(PublishProductId,PublishCatalogId,PimCategoryHierarchyId)

	IF OBJECT_ID('tempdb..#Temp_ImportLoop') IS NOT NULL  
		DROP TABLE #Temp_ImportLoop;  
          
	---- To get the min AND max rows for import in loop  
	;WITH cte AS   
	(  
		SELECT RowId = 1,   
		MinRow = 1,   
		MaxRow = cast(@Rows as int)  
		UNION ALL  
		SELECT RowId + 1,   
		MinRow + cast(@Rows as int),   
		MaxRow + cast(@Rows as int)  
		FROM cte  
		WHERE RowId + 1 <= @MaxCount  
	)  
	SELECT RowId, MinRow, MaxRow  
	INTO #Temp_ImportLoop  
	FROM cte  
	OPTION (maxrecursion 0);  

	DECLARE cur_BulkData CURSOR LOCAL FAST_FORWARD  
	FOR SELECT MinRow, MaxRow, B.LocaleId , B.RevisionType  ,b.VersionId
	FROM #Temp_ImportLoop L  
	CROSS APPLY @TBL_LocaleId B;  
  
	OPEN cur_BulkData;  
	FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow,@LocaleId, @RevisionType ,@VersionId 
	WHILE @@FETCH_STATUS = 0  
	BEGIN  
		IF OBJECT_ID('TEMPDB..#ProductEntity') IS NOT NULL
				DROP TABLE #ProductEntity

		IF OBJECT_ID('TEMPDB..#ProductEntity_LocaleWise') IS NOT NULL
			DROP TABLE #ProductEntity_LocaleWise
			
		SELECT   
			CAST(@VersionId AS VARCHAR(50)) VersionId --1   
			,CAST(ZPCPD.ProductIndex AS VARCHAr(100)) + CAST(ISNULL(ZPCP.PublishCategoryId,'')  AS VARCHAR(50))  + CAST(Isnull(ZPCPD.PublishCatalogId ,'')  AS VARCHAR(50)) + CAST( Isnull(ZPCPD.LocaleId,'') AS VARCHAR(50)) IndexId  --2  
			,CAST(ZPCPD.PublishProductId AS VARCHAR(50)) PublishProductId,CAST(ZPCPD.PublishCatalogId  AS VARCHAR(50)) PublishCatalogId  --3   
			,CAST(ISNULL(ZPCPD.SKU ,'') AS NVARCHAR(2000)) SKU,CAST( Isnull(ZPCPD.LocaleId,'') AS VARCHAR(50)) LocaleId -- 4   
			,CAST(isnull(ZPCPD.ProductName,'') AS NVARCHAR(2000) )  ProductName ,CAST(ISNULL(ZPCP.PublishCategoryId,'')  AS VARCHAR(50)) PublishCategoryId  -- 5   
			--'{"Attributes":[' + PAX.ProductXML + ']'  
			,CAST(ISNULL(ZPCPD.IsActive ,'0') AS VARCHAR(50)) IsActive ,ZPCPD.ProductXML,'[]' Brands,CAST(isnull(ZPCPD.CategoryName,'') AS NVARCHAR(2000)) CategoryName  --6  
			,CAST(Isnull(ZPCPD.CatalogName,'')  AS NVARCHAR(2000)) CatalogName,CAST(ISNULL(ZPCP.DisplayOrder,'') AS VARCHAR(50)) DisplayOrder  -- 7   
			,@RevisionType RevisionType, 0 AssociatedProductDisplayOrder,-- pending  -- 8   
			ZPCPD.ProductIndex,  -- 9  
			Case When @IsAllowIndexing = 1 then  ISNULL(CAST(TBZP.SalesPrice  AS VARCHAr(500)),'') else '' end SalesPrice ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(CAST(TBZP.RetailPrice  AS VARCHAr(500)),'') else '' end RetailPrice ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CultureCode ,'') else '' end CultureCode ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CurrencySuffix ,'') else '' end CurrencySuffix ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CurrencyCode ,'') else '' end CurrencyCode ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEODescription,'') else '' end SEODescriptionForIndex,  
			Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEOKeywords,'') else '' end SEOKeywords,  
			Case When @IsAllowIndexing = 1 then  ISNULL(SEOTitle,'') else '' end SEOTitle,  
			Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEOUrl ,'') else '' end SEOUrl,  
			Case When @IsAllowIndexing = 1 then  ISNULL(TBPI.ImageSmallPath,'') else '' end ImageSmallPath,  
			CAST(ISNULL(LOWER(ZPCPD.SKU) ,'') AS NVARCHAR(2000)) Lower_SKU--, z.Id    		
		INTO #ProductEntity
		FROM #ProductAttributeXML ZPCPD  
		INNER JOIN ZnodePublishCatalog ZPCV ON (ZPCV.PublishCatalogId = ZPCPD.PublishCatalogId)  
		--INNER JOIN #ProductAttributeXML PAX ON PAX.PublishProductId = ZPCPD.PublishProductId  AND PAX.LocaleId = ZPCPD.LocaleId   
		LEFT JOIN  #ZnodePrice TBZP ON (TBZP.PublishProductId = ZPCPD.PublishProductId)  
		LEFT JOIN  #ProductSKU TBPS ON (TBPS.PublishProductId = ZPCPD.PublishProductId)  
		LEFT JOIN  #ProductImages TBPI ON (TBPI.PublishProductId = ZPCPD.PublishProductId)  
		LEFT JOIN #TempPublishCategoryProduct ZPCP  ON (ZPCP.PublishProductId = ZPCPD.PublishProductId AND ZPCP.PublishCatalogId = ZPCPD.PublishCatalogId AND ZPCP.PimCategoryHierarchyId = ZPCPD.PimCategoryHierarchyId)
		WHERE ZPCPD.LocaleId = @LocaleId  
		AND EXISTS(SELECT * FROM #ZnodePublishCatalogProductDetail z WHERE ZPCPD.PimCatalogProductDetailId = z.PimCatalogProductDetailId AND z.Id BETWEEN @MinRow AND @MaxRow)
		AND ZPCPD.PublishCatalogId = @PublishCatalogId  
		AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId)

		CREATE INDEX Idx_#ProductEntity ON #ProductEntity (PublishProductId,PublishCatalogId,LocaleId,PublishCategoryId)

		UPDATE A SET a.SKU = b.SKU,A.SKULower = Lower_SKU,A.Name = B.ProductName, A.Brands = B.Brands, A.CategoryName = B.CategoryName, A.CatalogName = B.CatalogName,
			A.DisplayOrder = B.DisplayOrder, A.AssociatedProductDisplayOrder = B.AssociatedProductDisplayOrder,
			A.SalesPrice = B.SalesPrice, A.RetailPrice = B.RetailPrice, A.SeoDescription=B.SEODescriptionForIndex,
			A.SeoKeywords = B.SEOKeywords, A.SeoTitle = B.SEOTitle, A.SeoUrl = B.SEOUrl, A.ImageSmallPath = B.ImageSmallPath,
			A.ProductIndex = B.ProductIndex, A.IsActive = B.IsActive, A.IndexId = B.IndexId, A.Attributes = B.ProductXML,
			A.ElasticSearchEvent = 1
		FROM ZnodePublishProductEntity A
		INNER JOIN #ProductEntity B ON A.ZnodeProductId = B.PublishProductId AND A.ZnodeCatalogId = B.PublishCatalogId AND A.LocaleId = B.LocaleId 
			AND ISNULL(A.ZnodeCategoryIds,0) = ISNULL(B.PublishCategoryId,0) AND A.VersionId = B.VersionId AND A.ElasticSearchEvent <> 2

		INSERT INTO ZnodePublishProductEntity (  
			VersionId, --1  
			IndexId, --2   
			ZnodeProductId,ZnodeCatalogId, --3  
			SKU,LocaleId, --4   
			Name,ZnodeCategoryIds, --5  
			IsActive,Attributes,Brands,CategoryName, --6   
			CatalogName,DisplayOrder, --7   
			RevisionType,AssociatedProductDisplayOrder, --8  
			ProductIndex,--9  
			SalesPrice,RetailPrice,CultureCode,CurrencySuffix,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent)  
		SELECT VersionId, --1  
			IndexId, --2   
			PublishProductId,PublishCatalogId, --3  
			SKU,LocaleId, --4   
			ProductName,PublishCategoryId, --5  
			IsActive,ProductXML,Brands,CategoryName, --6   
			CatalogName,DisplayOrder, --7   
			RevisionType,AssociatedProductDisplayOrder, --8  
			ProductIndex,--9  
			SalesPrice,RetailPrice,CultureCode,CurrencySuffix,CurrencyCode,SEODescriptionForIndex,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,Lower_SKU,1 AS ElasticSearchEvent
		FROM #ProductEntity B
		WHERE NOT EXISTS(SELECT * FROM ZnodePublishProductEntity A WHERE A.ZnodeProductId = B.PublishProductId AND A.ZnodeCatalogId = B.PublishCatalogId AND A.LocaleId = B.LocaleId 
			AND ISNULL(A.ZnodeCategoryIds,0) = ISNULL(B.PublishCategoryId,0) AND A.VersionId = B.VersionId AND A.ElasticSearchEvent <> 2)
			--select * from #ProductEntity where PublishProductId = 191 
		IF @LocaleId <> @DefaultLocaleId
		BEGIN
			SELECT 
				CAST(@VersionId AS VARCHAR(50)) VersionId --1 
				,CAST(ZPCPD.ProductIndex AS VARCHAr(100)) + CAST(ISNULL(ZPCP.PublishCategoryId,'')  AS VARCHAR(50))  + CAST(Isnull(ZPCPD.PublishCatalogId ,'')  AS VARCHAR(50)) + CAST( Isnull(ZPCPD.LocaleId,'') AS VARCHAR(50)) IndexId  --2
				,CAST(ZPCPD.PublishProductId AS VARCHAR(50)) PublishProductId,CAST(ZPCPD.PublishCatalogId  AS VARCHAR(50)) PublishCatalogId  --3 
				,CAST(ISNULL(ZPCPD.SKU ,'') AS NVARCHAR(2000)) SKU,CAST( Isnull(ZPCPD.LocaleId,'') AS VARCHAR(50)) LocaleId -- 4 
				,CAST(isnull(ZPCPD.ProductName,'') AS NVARCHAR(2000) )  ProductName ,CAST(ISNULL(ZPCP.PublishCategoryId,'')  AS VARCHAR(50)) PublishCategoryId  -- 5 
				,CAST(ISNULL(ZPCPD.IsActive ,'0') AS VARCHAR(50)) IsActive ,ZPCPD.ProductXML,'[]' Brands,CAST(isnull(ZPCPD.CategoryName,'') AS NVARCHAR(2000)) CategoryName  --6
				,CAST(Isnull(ZPCPD.CatalogName,'')  AS NVARCHAR(2000)) CatalogName,CAST(ISNULL(ZPCP.DisplayOrder,'') AS VARCHAR(50)) DisplayOrder  -- 7 
				,@RevisionType as RevisionType, 0 AssociatedProductDisplayOrder,-- pending  -- 8 
				ZPCPD.ProductIndex,  -- 9
				Case When @IsAllowIndexing = 1 then  ISNULL(CAST(TBZP.SalesPrice  AS VARCHAr(500)),'') else '' end SalesPrice , 
				Case When @IsAllowIndexing = 1 then  ISNULL(CAST(TBZP.RetailPrice  AS VARCHAr(500)),'') else '' end RetailPrice , 
				Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CultureCode ,'') else '' end CultureCode , 
				Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CurrencySuffix ,'') else '' end CurrencySuffix , 
				Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CurrencyCode ,'') else '' end CurrencyCode , 
				Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEODescription,'') else '' end SEODescriptionForIndex,
				Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEOKeywords,'') else '' end SEOKeywords,
				Case When @IsAllowIndexing = 1 then  ISNULL(SEOTitle,'') else '' end SEOTitle,
				Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEOUrl ,'') else '' end SEOUrl,
				Case When @IsAllowIndexing = 1 then  ISNULL(TBPI.ImageSmallPath,'') else '' end ImageSmallPath,
				CAST(ISNULL(LOWER(ZPCPD.SKU) ,'') AS NVARCHAR(2000)) Lower_SKU
			INTO #ProductEntity_LocaleWise
			FROM #ProductAttributeXML_LocaleWise ZPCPD
			INNER JOIN ZnodePublishCatalog ZPCV ON (ZPCV.PublishCatalogId = ZPCPD.PublishCatalogId)
			--INNER JOIN #ProductAttributeXML_LocaleWise PAX ON PAX.PublishProductId = ZPCPD.PublishProductId  AND PAX.LocaleId = ZPCPD.LocaleId 
			LEFT JOIN  #ZnodePrice TBZP ON (TBZP.PublishProductId = ZPCPD.PublishProductId)
			LEFT JOIN  #ProductSKU TBPS ON (TBPS.PublishProductId = ZPCPD.PublishProductId)
			LEFT JOIN  #ProductImages TBPI ON (TBPI.PublishProductId = ZPCPD.PublishProductId)
			LEFT JOIN #TempPublishCategoryProduct ZPCP  ON (ZPCP.PublishProductId = ZPCPD.PublishProductId AND ZPCP.PublishCatalogId = ZPCPD.PublishCatalogId AND ZPCP.PimCategoryHierarchyId = ZPCPD.PimCategoryHierarchyId)
			WHERE ZPCPD.LocaleId = @LocaleId 
			AND EXISTS(SELECT * FROM #ZnodePublishCatalogProductDetail z WHERE ZPCPD.PimCatalogProductDetailId = z.PimCatalogProductDetailId AND z.Id BETWEEN @MinRow AND @MaxRow)
			AND ZPCPD.PublishCatalogId = @PublishCatalogId

			CREATE INDEX Idx_#ProductEntity_LocaleWise ON #ProductEntity (PublishProductId,PublishCatalogId,LocaleId,PublishCategoryId)

			UPDATE A SET a.SKU = b.SKU,A.SKULower = Lower_SKU,A.Name = B.ProductName, A.Brands = B.Brands, A.CategoryName = B.CategoryName, A.CatalogName = B.CatalogName,
				A.DisplayOrder = B.DisplayOrder, A.AssociatedProductDisplayOrder = B.AssociatedProductDisplayOrder,
				A.SalesPrice = B.SalesPrice, A.RetailPrice = B.RetailPrice, A.SeoDescription=B.SEODescriptionForIndex,
				A.SeoKeywords = B.SEOKeywords, A.SeoTitle = B.SEOTitle, A.SeoUrl = B.SEOUrl, A.ImageSmallPath = B.ImageSmallPath,
				A.ProductIndex = B.ProductIndex, A.IsActive = B.IsActive, A.IndexId = B.IndexId, A.Attributes = B.ProductXML,
				A.ElasticSearchEvent = 1
			FROM ZnodePublishProductEntity A
			INNER JOIN #ProductEntity_LocaleWise B ON A.ZnodeProductId = B.PublishProductId AND A.ZnodeCatalogId = B.PublishCatalogId AND A.LocaleId = B.LocaleId 
				AND ISNULL(A.ZnodeCategoryIds,0) = ISNULL(B.PublishCategoryId,0) AND A.VersionId = B.VersionId AND A.ElasticSearchEvent <> 2

			INSERT INTO ZnodePublishProductEntity (
			VersionId, --1
			IndexId, --2 
			ZnodeProductId,ZnodeCatalogId, --3
			SKU,LocaleId, --4 
			Name,ZnodeCategoryIds, --5
			IsActive,Attributes,Brands,CategoryName, --6 
			CatalogName,DisplayOrder, --7 
			RevisionType,AssociatedProductDisplayOrder, --8
			ProductIndex,--9
			SalesPrice,RetailPrice,CultureCode,CurrencySuffix,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent)
			SELECT VersionId --1 
				,IndexId  --2
				,PublishProductId,PublishCatalogId  --3 
				,SKU,LocaleId -- 4 
				,ProductName ,PublishCategoryId  -- 5 
				,IsActive ,ProductXML,Brands,CategoryName  --6
				,CatalogName,DisplayOrder  -- 7 
				,RevisionType, AssociatedProductDisplayOrder,-- pending  -- 8 
				ProductIndex,  -- 9
				SalesPrice , 
				RetailPrice , 
				CultureCode , 
				CurrencySuffix , 
				CurrencyCode , 
				SEODescriptionForIndex,
				SEOKeywords,
				SEOTitle,
				SEOUrl,
				ImageSmallPath,
				Lower_SKU,1 as ElasticSearchEvent
			FROM #ProductEntity_LocaleWise B
			WHERE NOT EXISTS(SELECT * FROM ZnodePublishProductEntity A WHERE A.ZnodeProductId = B.PublishProductId AND A.ZnodeCatalogId = B.PublishCatalogId AND A.LocaleId = B.LocaleId 
				AND ISNULL(A.ZnodeCategoryIds,0) = ISNULL(B.PublishCategoryId,0) AND A.VersionId = B.VersionId AND A.ElasticSearchEvent <> 2)
		
			--select * from #ProductEntity_LocaleWise where PublishProductId = 191 

		END

		SET @VersionId = 0  

		IF OBJECT_ID('tempdb..#ProductEntity') is not null
			DROP TABLE #ProductEntity

		IF OBJECT_ID('TEMPDB..#TempProductEntity_LocaleWise') IS NOT NULL
			DROP TABLE #TempProductEntity_LocaleWise

	FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow,@LocaleId, @RevisionType ,@VersionId 
	END;  
	CLOSE cur_BulkData;  
	DEALLOCATE cur_BulkData;  
  
  
	IF @RevisionState = 'PREVIEW'   
		UPDATE ZnodePimProduct SET IsProductPublish = 1,PublishStateId =  DBO.Fn_GetPublishStateIdForPreview()    
		WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishProduct ZPP WHERE ZPP.PimProductId = ZnodePimProduct.PimProductId   
		AND ZPP.PublishCatalogId = @PublishCatalogId)  
	Else  
		UPDATE ZnodePimProduct SET IsProductPublish = 1,PublishStateId =  DBO.Fn_GetPublishStateIdForPublish()    
		WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishProduct ZPP WHERE ZPP.PimProductId = ZnodePimProduct.PimProductId   
		AND ZPP.PublishCatalogId = @PublishCatalogId) 
		

	UPDATE ZnodePublishCatalogLog   
	SET IsProductPublished = 1   
	,PublishProductId = (SELECT  COUNT(DISTINCT PublishProductId) FROM ZnodePublishCategoryProduct ZPP   
		WHERE ZPP.PublishCatalogId = ZnodePublishCatalogLog.PublishCatalogId AND ZPP.PublishCategoryId IS NOT NULL)   
	WHERE ZnodePublishCatalogLog.PublishCatalogId = @PublishCatalogId  
	and PublishStateId = (SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE PublishStateCode = 'Processing' ) 
    
	--UPDATE ZnodePublishCatalogLog   
	--SET IsProductPublished = 1   
	--,PublishProductId = (SELECT  COUNT(DISTINCT PublishProductId) FROM ZnodePublishCatalogProductDetail ZPP   
	--	WHERE ZPP.PublishCatalogId = ZnodePublishCatalogLog.PublishCatalogId AND ZPP.PimCategoryHierarchyId <> 0)   
	--WHERE ZnodePublishCatalogLog.PublishCatalogId = @PublishCatalogId  
	--AND PublishStateId = (SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE PublishStateCode = 'Processing' )  

	SET @Status = 1   

	IF OBJECT_ID('tempdb..##AttributeValueLocale') IS NOT NULL  
		DROP TABLE ##AttributeValueLocale; 

END TRY   
BEGIN CATCH   
	SELECT ERROR_MESSAGE()
	 SET @Status =0    
	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	  @ErrorLine VARCHAR(100)= ERROR_LINE(),  
	  @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishProductJson   
		 @PublishCatalogId = '+CAST(@PublishCatalogId AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))  
	  +',@PimCatalogId = ' + CAST(@PimCatalogId AS varchar(20))  
	  +',@VersionIdString= ' + CAST(@VersionIdString AS varchar(20))  
       
	 EXEC Znode_InsertProcedureErrorLog  
	  @ProcedureName = 'Znode_GetPublishProductJson',  
	  @ErrorInProcedure = @Error_procedure,  
	  @ErrorMessage = @ErrorMessage,  
	  @ErrorLine = @ErrorLine,  
	  @ErrorCall = @ErrorCall;  
END CATCH  
  
END  

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportInsertUpdatePimProduct')
	DROP PROC Znode_ImportInsertUpdatePimProduct
GO


CREATE PROCEDURE [dbo].[Znode_ImportInsertUpdatePimProduct]
(
    @PimProductDetail  PIMPRODUCTDETAIL READONLY,
    @UserId            INT       ,
    @status            BIT    OUT,
    @IsNotReturnOutput BIT    = 0,
	@CopyPimProductId  INT	  = 0 )
AS
   /*
     Summary : To Insert / Update single Product with multiple attribute values 
     Update Logic: 
*/
     BEGIN
         BEGIN TRAN A;
         BEGIN TRY
			 DECLARE @PimProductId INT;
			 DECLARE @TBL_PimProductId TABLE(PimAttributeValueId INT,ZnodePimAttributeValueLocaleId INT );
			 DECLARE @TBL_CopyPimProductId TABLE(PimAttributeValueId INT,OldPimAttributeValueId INT);
			 DECLARE @PimDefaultFamily INT= dbo.Fn_GetDefaultPimProductFamilyId()
			 DECLARE @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId();
			 DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
			 DECLARE @TBL_DefaultAttributeId TABLE (PimAttributeId INT PRIMARY KEY , AttributeCode VARCHAR(600))
			 DECLARE @TBL_MediaAttributeId TABLE (PimAttributeId INT PRIMARY KEY, AttributeCode VARCHAR(600))
			 DECLARE @TBL_TextAreaAttributeId TABLE (PimAttributeId INT PRIMARY KEY , AttributeCode VARCHAR(600))
			 DECLARE @TBL_MediaAttributeValue TABLE (PimAttributeValueId INT ,LocaleId INT ,AttributeValue VARCHAr(300),MediaId INT)
			 DECLARE @TBL_DefaultAttributeValue TABLE (PimAttributeValueId INT , LocaleId INT , AttributeValue INT)
			 DECLARE @ZnodePimAttributeValue TABLE (PimAttributeValueId  INT, PimAttributeFamilyId INT,PimAttributeId INT);

			 DECLARE @AssociatedProduct VARCHAR(4000);
			 DECLARE @ConfigureAttributeId VARCHAR(4000);
			 DECLARE @ConfigureFamilyId VARCHAR(4000);
			 DECLARE @PimAttributeFamilyId INT;
			 DECLARE @LocaleId INT 

			 DECLARE @pimSkuAttributeId VARCHAR(50) = [dbo].[Fn_GetProductSKUAttributeId] ()
			 DECLARE @pimProductNameAttributeId VARCHAR(50) =[dbo].Fn_GetProductNameAttributeId ()
			 DECLARE @PimIsDownlodableAttributeId VARCHAR(50) = [dbo].[Fn_GetIsDownloadableAttributeId]()
			 Declare @SKU nvarchar(300),@ProductName nvarchar(300)
			 Select * into #PimProductDetail from @PimProductDetail
			
			--DECLARE @PimAttributeFamily VARCHAR(50) =  [dbo].[Fn_GetAttributeFamilyId]()
			--Update #PimProductDetail SET AttributeValue = 
			--(SELECT FamilyCode from ZnodePimAttributeFamily where PimAttributeFamilyId = @PimAttributeFamilyId)
			--where PimAttributeId = @PimAttributeFamily

			--DECLARE @PimAttributeIsPublish VARCHAR(50) =  [dbo].[Fn_GetAttributeIsPublish]()
			 
			--insert into #PimProductDetail ([PimAttributeId],[PimAttributeFamilyId],[ProductAttributeCode],[ProductAttributeDefaultValueId],
			--[PimAttributeValueId],	[LocaleId],[PimProductId],[AttributeValue],[AssociatedProducts],[ConfigureAttributeIds],[ConfigureFamilyIds]) 
			 
			--SELECT TOP 1 @PimAttributeIsPublish,[PimAttributeFamilyId],'PublishStatus' ProductAttributeCode,NULL ProductAttributeDefaultValueId,
			--NULL PimAttributeValueId,	[LocaleId],[PimProductId],
			--CASE when isnull([PimProductId] ,0) > 1 then 'Draft' else 'Not Publish' END AttributeValue,
			--[AssociatedProducts],[ConfigureAttributeIds],[ConfigureFamilyIds]
			--from @PimProductDetail  


			INSERT INTO @TBL_DefaultAttributeId (PimAttributeId,AttributeCode)
			 SELECT PimAttributeId,AttributeCode FROM  [dbo].[Fn_GetDefaultAttributeId] ()
			 
			 INSERT INTO @TBL_MediaAttributeId (PimAttributeId,AttributeCode)
			 SELECT PimAttributeId,AttributeCode FROM [dbo].[Fn_GetProductMediaAttributeId]()

			 INSERT INTO @TBL_TextAreaAttributeId (PimAttributeId ,AttributeCode)
			 SELECT PimAttributeId, AttributeCode   FROM [dbo].[Fn_GetTextAreaAttributeId]()

			 
			 SELECT TOP 1 @PimAttributeFamilyId = PimAttributeFamilyId
                FROM #PimProductDetail;
             
			 

			 
			 
			 SELECT TOP 1 @LocaleId = LocaleId
                FROM #PimProductDetail;

             -- Retrive input productId from #PimProductDetail table ( having multiple attribute values with common productId) 

             SELECT TOP 1 @PimProductId = PimProductId
             FROM #PimProductDetail;
			
			DECLARE @PublishStateIdForDraft INT =  [dbo].[Fn_GetPublishStateIdForDraftState]()
			  DECLARE @PublishStateIdForNotPublished INT = [dbo].[Fn_GetPublishStateIdForForNotPublishedState]()

			

             IF ISNULL(@PimProductId, 0) = 0
                 BEGIN
                     INSERT INTO ZnodePimProduct
                     (PimAttributeFamilyId,
                      CreatedBy,
                      CreatedDate,
                      ModifiedBy,
                      ModifiedDate ,PublishStateId
                     )
                            SELECT @PimAttributeFamilyId,
                                   @UserId,
                                   @GetDate,
                                   @UserId,
                                   @GetDate,@PublishStateIdForNotPublished ;
                     SET @PimProductId = SCOPE_IDENTITY();
					 If EXISTS (select TOP 1 1 from #PimProductDetail where PimAttributeId = @PimIsDownlodableAttributeId and AttributeValue = 'true'  )
					 Begin
						
						Select TOP 1 @SKU  =  AttributeValue from  #PimProductDetail where PimAttributeId =  @pimSkuAttributeId
						Select TOP 1 @ProductName  = AttributeValue from  #PimProductDetail where PimAttributeId =  @pimProductNameAttributeId
						insert into ZnodePimDownloadableProduct(SKU,ProductName,  CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
						Select @SKU, @ProductName, @UserId , @GetDate, @UserId , @GetDate 
					 End
		

                 END;
             ELSE 
                 BEGIN
                     UPDATE ZNodePimProduct
                       SET
                           PimAttributeFamilyId = @PimAttributeFamilyId,
						   PublishStateId = @PublishStateIdForDraft,
                           ModifiedBy = @UserId,
                           ModifiedDate = @GetDate
                     WHERE PimProductId = @PimProductId;

					Update ZnodePimProduct SET PublishStateId = 2, IsProductPublish = 0 , ModifiedDate = GETDATE()  where PimProductId in
					(select PimProductId  From ZnodePimProductTypeAssociation where PimParentProductId=@PimProductId )
            									
					 INSERT INTO @TBL_PimProductId(PimAttributeValueId)
					 SELECT ZPAV.PimAttributeValueId
                     FROM ZnodePimAttributeValue ZPAV
					 INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = ZPAV.PimAttributeId AND ( @localeID = @DefaultLocaleId OR ZPA.IsLocalizable = 1 OR EXISTS (SELECT TOP 1 1 FROM [dbo].[Fn_GetProductMediaAttributeId]() FN WHERE FN.PimAttributeId = ZPAV.PimAttributeId)))
					 INNER JOIN ZnodePimFamilyGroupMapper ZPFGMI  ON (ZPFGMI.PimAttributeId = ZPAV.PimAttributeId AND ZPFGMI.PimAttributeFamilyId = @PimAttributeFamilyId)
					 WHERE ZPAV.PimProductId = @PimProductId
					 AND NOT EXISTS
                            (
                                SELECT TOP 1 1
                                FROM #PimProductDetail TBPDI
                                WHERE TBPDI.PimAttributeId = ZPAV.PimAttributeId
                                      AND TBPDI.PimProductId = ZPAV.PimProductId
							 )
                     
				    --  SELECT * FROM @TBL_PimProductId

			
                     DELETE FROM ZnodePimAttributeValueLocale
                     WHERE EXISTS
                     (
                         SELECT TOP 1 1
                         FROM @TBL_PimProductId TBPD
                         WHERE TBPD.PimAttributeValueId = ZnodePimAttributeValueLocale.PimAttributeValueId 
								
                     ) AND LocaleId = @LocaleId;
					 DELETE  ZnodePimProductAttributeDefaultValue 
					  WHERE EXISTS
                     (
                         SELECT TOP 1 1
                         FROM @TBL_PimProductId TBPD
                         WHERE TBPD.PimAttributeValueId = ZnodePimProductAttributeDefaultValue.PimAttributeValueId 
								
                     ) AND LocaleId = @LocaleId;
					


					 DELETE FROM ZnodePimProductAttributeMedia 
					  WHERE EXISTS
                     (
                         SELECT TOP 1 1
                         FROM @TBL_PimProductId TBPD
                         WHERE TBPD.PimAttributeValueId = ZnodePimProductAttributeMedia.PimAttributeValueId 
								
                     ) 
					 AND LocaleId = @LocaleId;

					-- SELECT * FROM @TBL_PimProductId
					

					 DELETE FROM ZnodePimProductAttributeTextAreaValue
					   WHERE EXISTS
                     (
                         SELECT TOP 1 1
                         FROM @TBL_PimProductId TBPD
                         WHERE TBPD.PimAttributeValueId = ZnodePimProductAttributeTextAreaValue.PimAttributeValueId 
								
                     ) AND LocaleId = @LocaleId ;

					 
                     DELETE FROM ZnodePimAttributeValue
                     WHERE EXISTS
                     (
                         SELECT TOP 1 1
                         FROM @TBL_PimProductId TBPD
                         WHERE TBPD.PimAttributeValueId = ZnodePimAttributeValue.PimAttributeValueId
                     )
					 AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimAttributeValueLocale ZPVD WHERE ZPVD.PimAttributeValueId = ZnodePimAttributeValue.PimAttributeValueId )
					 AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimProductAttributeTextAreaValue ZPVD WHERE ZPVD.PimAttributeValueId = ZnodePimAttributeValue.PimAttributeValueId )
					 AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimProductAttributeDefaultValue ZPVD WHERE ZPVD.PimAttributeValueId = ZnodePimAttributeValue.PimAttributeValueId )
					 AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimProductAttributeMedia ZPVD WHERE ZPVD.PimAttributeValueId = ZnodePimAttributeValue.PimAttributeValueId );
					
				
					
					If EXISTS (select TOP 1 1 from #PimProductDetail where PimAttributeId = @PimIsDownlodableAttributeId and AttributeValue = 'true'  )
					 Begin
						Select TOP 1 @SKU  =  AttributeValue from  #PimProductDetail where PimAttributeId =  @pimSkuAttributeId
						Select TOP 1 @ProductName  = AttributeValue from  #PimProductDetail where PimAttributeId =  @pimProductNameAttributeId

						insert into ZnodePimDownloadableProduct(SKU,ProductName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
						Select TOP 1 PD.AttributeValue, @ProductName,@UserId , @GetDate, @UserId , @GetDate from  #PimProductDetail PD where  PD.PimAttributeId = @pimSkuAttributeId 
						AND not exists (select top 1 1 from  ZnodePimDownloadableProduct where  ZnodePimDownloadableProduct.SKU  =  PD.AttributeValue)
						IF NOT Exists (	select top 1 1 from  ZnodePimDownloadableProduct where  ZnodePimDownloadableProduct.SKU  = @SKU)
							insert into ZnodePimDownloadableProduct(SKU,ProductName,  CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
							Select @SKU, @ProductName, @UserId , @GetDate, @UserId , @GetDate 

					 End
                 END;
		
		 

		    MERGE INTO ZnodePimAttributeValue TARGET
              USING #PimProductDetail SOURCE
              ON(
				TARGET.PimProductId = @PimProductId
                AND TARGET.PimAttributeId = SOURCE.PimAttributeId)
                --AND ISNULL(TARGET.PimAttributeFamilyId, 0) = ISNULL(SOURCE.PimAttributeFamilyId, 0))
                 WHEN MATCHED
                 THEN UPDATE SET
                                 TARGET.PimAttributeFamilyId = CASE
                                                                   WHEN Source.PimAttributeFamilyId = 0
                                                                   THEN NULL
                                                                   ELSE Source.PimAttributeFamilyId
                                                               END,
                                 --TARGET.PimAttributeDefaultValueId = CASE
                                 --                                        WHEN SOURCE.ProductAttributeDefaultValueId = 0
                                 --                                        THEN NULL
                                 --                                        ELSE SOURCE.ProductAttributeDefaultValueId
                                 --                                    END, 
                                 -- ,TARGET.AttributeValue					= SOURCE.AttributeValue
                                 TARGET.CreatedBy = @UserId,
                                 TARGET.CreatedDate = @GetDate,
                                 TARGET.ModifiedBy = @UserId,
                                 TARGET.ModifiedDate = @GetDate
                 WHEN NOT MATCHED
                 THEN INSERT(PimAttributeFamilyId,
                             PimProductId,
                             PimAttributeId,
                             PimAttributeDefaultValueId,
                             --,AttributeValue
                             CreatedBy,
                             CreatedDate,
                             ModifiedBy,
                             ModifiedDate) VALUES
             (CASE
                  WHEN Source.PimAttributeFamilyId = 0
                  THEN @PimDefaultFamily
                  ELSE Source.PimAttributeFamilyId
              END,
              @PimProductId,
              SOURCE.PimAttributeId,
              CASE
                  WHEN SOURCE.ProductAttributeDefaultValueId = 0
                  THEN NULL
                  ELSE SOURCE.ProductAttributeDefaultValueId
              END, 
              --,SOURCE.AttributeValue
              @UserId,
              @GetDate,
              @UserId,
              @GetDate
             )
             --WHEN NOT MATCHED BY SOURCE AND TARGET.PimProductId = @PimProductId
             --                               AND Target.PimAttributeFamilyId IS NOT NULL
             --THEN DELETE
             OUTPUT INSERTED.PimAttributeValueId,
                    INSERTED.PimAttributeFamilyId,
                    INSERTED.PimAttributeId
                    INTO @ZnodePimAttributeValue;
        		
		DECLARE @MediaData Table (MediaId INT , PimProductId INT , PimAttributeId INT ,PimAttributeFamilyId INT,LocaleId INT  )
	    
		INSERT INTO @MediaData (MediaId,PimProductId,PimAttributeId ,PimAttributeFamilyId, LocaleId)
		SELECT sp.item, a.PimProductId, a.PimAttributeId ,PimAttributeFamilyId,a.LocaleId
		FROM #PimProductDetail a
		CROSS APPLY dbo.split(a.AttributeValue,',' ) SP
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_MediaAttributeId c WHERE c.PimAttributeId = a.PimAttributeId ) 
				
				 
		INSERT INTO @TBL_MediaAttributeValue (PimAttributeValueId,LocaleId , AttributeValue,MediaId)
		SELECT a.PimAttributeValueId,
                        b.LocaleId,
                         zm.Path AttributeValue
						 ,ZM.MediaId
        FROM @ZnodePimAttributeValue AS a
        INNER JOIN  @MediaData AS b ON(a.PimAttributeId = b.PimAttributeId
                                                AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0))
				INNER JOIN ZnodeMedia ZM ON ( b.MediaId = ZM.MediaId )
		
		DELETE FROM ZnodePimProductAttributeMedia 
		WHERE EXISTS 
		 (SELECT TOP 1 1 FROM @TBL_MediaAttributeValue TBLM WHERE ZnodePimProductAttributeMedia.PimAttributeValueId = TBLM.PimAttributeValueId 
		 AND TBLM.MediaId <> ZnodePimProductAttributeMedia.MediaId  AND ZnodePimProductAttributeMedia.Localeid = @LocaleId)



		MERGE INTO ZnodePimProductAttributeMedia TARGET 
		USING @TBL_MediaAttributeValue SOURCE 
		ON (        TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
		        AND TARGET.MediaPAth = SOURCE.AttributeValue
                  AND TARGET.LocaleId = SOURCE.LocaleId)
		WHEN MATCHED THEN 
		UPDATE SET
                                 TARGET.MediaPath = SOURCE.AttributeValue,
						   TARGET.MediaId   = SOURCE.MediaId,
                                 TARGET.CreatedBy = @UserId,
                                 TARGET.CreatedDate = @GetDate,
                                 TARGET.ModifiedBy = @UserId,
                                 TARGET.ModifiedDate = @GetDate
                 WHEN NOT MATCHED
                 THEN 
		    INSERT(PimAttributeValueId,
                             LocaleId,
                             MediaPath,
							 MediaId ,
                             CreatedBy,
                             CreatedDate,
                             ModifiedBy,
                             ModifiedDate) 
			VALUES
             (SOURCE.PimAttributeValueId,
              SOURCE.LocaleId,
              SOURCE.AttributeValue,
			  SOURCE.MediaId,
              @UserId,
              @GetDate,
              @UserId,
              @GetDate
             );
		 --WHEN NOT MATCHED BY SOURCE AND EXISTS 
		 --(SELECT TOP 1 1 FROM @TBL_MediaAttributeValue TBLM WHERE TARGET.PimAttributeValueId = TBLM.PimAttributeValueId AND TBLM.MediaId = TARGET.MediaId  AND TARGET.Localeid = @LocaleId)
		 --  THEN 
		 --DELETE  ;


	   ;With Cte_TextAreaAttributeValue AS 
		 (
		SELECT a.PimAttributeValueId,
                        b.LocaleId,
                        AttributeValue
        FROM @ZnodePimAttributeValue AS a
        INNER JOIN #PimProductDetail AS b ON(a.PimAttributeId = b.PimAttributeId
                                                AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0))
		INNER JOIN @TBL_TextAreaAttributeId c ON ( c.PimAttributeId  = b.PimAttributeId )
		
		)
		
		MERGE INTO ZnodePimProductAttributeTextAreaValue TARGET 
		USING Cte_TextAreaAttributeValue SOURCE 
		ON (TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                AND TARGET.LocaleId = SOURCE.LocaleId)
		WHEN MATCHED THEN 
		UPDATE SET
                                 TARGET.AttributeValue = SOURCE.AttributeValue,
                                 TARGET.CreatedBy = @UserId,
                                 TARGET.CreatedDate = @GetDate,
                                 TARGET.ModifiedBy = @UserId,
                                 TARGET.ModifiedDate = @GetDate
                 WHEN NOT MATCHED
                 THEN 
		    INSERT(PimAttributeValueId,
                             LocaleId,
                             AttributeValue,
                             CreatedBy,
                             CreatedDate,
                             ModifiedBy,
                             ModifiedDate) 
			VALUES
             (SOURCE.PimAttributeValueId,
              SOURCE.LocaleId,
              SOURCE.AttributeValue,
              @UserId,
              @GetDate,
              @UserId,
              @GetDate
             );
		-- SELECT a.PimAttributeValueId,
  --                      b.LocaleId,
  --                      d.PimAttributeDefaultValueId  AttributeValue,b.PimAttributeId
  --      FROM @ZnodePimAttributeValue AS a
  --        INNER JOIN #PimProductDetail AS b ON(a.PimAttributeId = b.PimAttributeId
  --                                              AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0))
		--INNER JOIN @TBL_DefaultAttributeId c ON ( c.PimAttributeId  = b.PimAttributeId )
		--INNER JOIN ZnodePimAttributeDefaultValue d ON (EXISTS (SELECT TOP 1 1 FROM dbo.split(b.AttributeValue,',') SP WHERE d.PimAttributeId = b.PimAttributeId AND SP.Item = d.AttributeDefaultValueCode))
	



        INSERT INTO @TBL_DefaultAttributeValue (PimAttributeValueId,LocaleId,AttributeValue)  
		SELECT a.PimAttributeValueId,
                        b.LocaleId,
                        d.PimAttributeDefaultValueId  AttributeValue
        FROM @ZnodePimAttributeValue AS a
          INNER JOIN #PimProductDetail AS b ON(a.PimAttributeId = b.PimAttributeId
                                                AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0))
		INNER JOIN @TBL_DefaultAttributeId c ON ( c.PimAttributeId  = b.PimAttributeId )
		INNER JOIN ZnodePimAttributeDefaultValue d ON (EXISTS (SELECT TOP 1 1 FROM dbo.split(b.AttributeValue,',') SP WHERE d.PimAttributeId = b.PimAttributeId AND SP.Item = d.AttributeDefaultValueCode))
	
	     -- SELECT * FROM @TBL_DefaultAttributeValue

		--  SELECT * FROM Cte_DefaultAttributeValue
		DELETE FROM ZnodePimProductAttributeDefaultValue 
		WHERE  EXISTS (SELECT TOP 1 1 FROM @TBL_DefaultAttributeValue TBLAV WHERE TBLAV.PimAttributeValueId = ZnodePimProductAttributeDefaultValue.PimAttributeValueId 
												AND TBLAV.AttributeValue   <> ZnodePimProductAttributeDefaultValue.PimAttributeDefaultValueId 
												 AND ZnodePimProductAttributeDefaultValue.LocaleId = @LocaleId )

		MERGE INTO ZnodePimProductAttributeDefaultValue TARGET 
		USING @TBL_DefaultAttributeValue SOURCE 
		ON (TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
              AND TARGET.PimAttributeDefaultValueId =  SOURCE.AttributeValue
			    AND TARGET.LocaleId = SOURCE.LocaleId)
		WHEN MATCHED THEN 
		UPDATE SET
                                 TARGET.PimAttributeDefaultValueId = SOURCE.AttributeValue,
                                 TARGET.CreatedBy = @UserId,
                                 TARGET.CreatedDate = @GetDate,
                                 TARGET.ModifiedBy = @UserId,
                                 TARGET.ModifiedDate = @GetDate
                 WHEN NOT MATCHED
                 THEN 
		    INSERT(PimAttributeValueId,
                             LocaleId,
                             PimAttributeDefaultValueId,
                             CreatedBy,
                             CreatedDate,
                             ModifiedBy,
                             ModifiedDate) 
			VALUES
             (SOURCE.PimAttributeValueId,
              SOURCE.LocaleId,
              SOURCE.AttributeValue,
              @UserId,
              @GetDate,
              @UserId,
              @GetDate
             );
			 --WHEN NOT MATCHED BY SOURCE  AND EXISTS (SELECT TOP 1 1 FROM @TBL_DefaultAttributeValue TBLAV WHERE TBLAV.PimAttributeValueId = TARGET.PimAttributeValueId 
				--								AND TBLAV.AttributeValue   = TARGET.PimAttributeDefaultValueId  AND TARGET.LocaleId = @LocaleId )
			 --THEN 
			 --DELETE 
			 --;
		
   
			 
		   MERGE INTO ZnodePimAttributeValueLocale TARGET
             USING
             (
                 SELECT a.PimAttributeValueId,
                        b.LocaleId,
                        AttributeValue
                 FROM @ZnodePimAttributeValue AS a
                      INNER JOIN #PimProductDetail AS b ON(a.PimAttributeId = b.PimAttributeId
                                                             AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0))
                 WHERE NOT EXISTS (SELECT TOP 1 1 FROM @TBL_DefaultAttributeId TBLDA WHERE TBLDA.PimAttributeId = b.PimAttributeId  )
			     AND NOT EXISTS (SELECT TOP 1 1 FROM @TBL_MediaAttributeId TBLMA WHERE TBLMA.PimAttributeId = b.PimAttributeId  )
				 AND NOT EXISTS (SELECT TOP 1 1 FROM @TBL_TextAreaAttributeId TBLTA WHERE TBLTA.PimAttributeId = b.PimAttributeId  )
			 ) SOURCE
             ON(TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                AND TARGET.LocaleId = SOURCE.LocaleId)
                 WHEN MATCHED
                 THEN UPDATE SET
                                 TARGET.AttributeValue = SOURCE.AttributeValue,
                                 TARGET.CreatedBy = @UserId,
                                 TARGET.CreatedDate = @GetDate,
                                 TARGET.ModifiedBy = @UserId,
                                 TARGET.ModifiedDate = @GetDate
                 WHEN NOT MATCHED
                 THEN INSERT(PimAttributeValueId,
                             LocaleId,
                             AttributeValue,
                             CreatedBy,
                             CreatedDate,
                             ModifiedBy,
                             ModifiedDate) VALUES
             (SOURCE.PimAttributeValueId,
              SOURCE.LocaleId,
              SOURCE.AttributeValue,
              @UserId,
              @GetDate,
              @UserId,
              @GetDate
             );
             SET @AssociatedProduct =
             (
                 SELECT MAX(AssociatedProducts)
                 FROM #PimProductDetail AS a
             );
             INSERT INTO ZnodePimProductTypeAssociation
             (PimParentProductId,
              PimProductId,
              DisplayOrder,
              CreatedBy,
              CreatedDate,
              ModifiedBy,
              ModifiedDate
             )
                    SELECT @PimProductId,
                           Item,
                           ID AS RowId,
                           @UserId,
                           @GetDate,
                           @UserId,
                           @GetDate
                    FROM dbo.Split(@AssociatedProduct, ',') AS b
                         INNER JOIN ZNodePimProduct AS q ON(q.PimProductId = b.Item)
						 WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimProductTypeAssociation PPT
						 WHERE PPT.PimParentProductId = @PimProductId AND PPT.PimProductId = b.Item)


             SET @ConfigureAttributeId =
             (
                 SELECT MAX(ConfigureAttributeIds)
                 FROM #PimProductDetail AS a
             );
             SET @ConfigureFamilyId =
             (
                 SELECT MAX(ConfigureFamilyIds)
                 FROM #PimProductDetail AS a
             );
             INSERT INTO [ZnodePimConfigureProductAttribute]
             (PimProductId,
              PimFamilyId,
              PimAttributeId,
              CreatedBy,
              CreatedDate,
              ModifiedBy,
              ModifiedDate
             )
                    SELECT @PimProductId,
                           @ConfigureFamilyId,
                           q.PimAttributeId,
                           @UserId,
                           @GetDate,
                           @UserId,
                           @GetDate
                    FROM dbo.Split(@ConfigureAttributeId, ',') AS b
                         INNER JOIN ZnodePimAttribute AS q ON(q.PimAttributeId = b.Item)
					WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimConfigureProductAttribute RTR  WHERE  RTR.PimProductId = @PimProductId AND RTR.PimAttributeId = q.PimAttributeId);



             IF @IsNotReturnOutput = 0
                 SELECT @PimProductId AS Id,
                        CAST(1 AS BIT) AS Status;
             SET @status = 1;

			 IF @CopyPimProductId > 0 
			 BEGIN 
			   INSERT INTO ZnodePimAttributeValueLocale  (PimAttributeValueId,LocaleId,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			   SELECT ZPAVI.PimAttributeValueId,ZPAVL.LocaleId,ZPAVL.AttributeValue,@UserId,@GetDate,@UserId,@GetDate
			   FROM ZnodePimAttributeValueLocale ZPAVL 
			   INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId )
			   INNER JOIN ZnodePimAttributeValue ZPAVI ON (ZPAVI.PimAttributeId = ZPAV.PimAttributeId AND ZPAVI.PimProductId = @PimProductId )
			   WHERE ZPAVL.LocaleId <> dbo.Fn_GetDefaultLocaleId()
			   AND ZPAV.PimProductId = @CopyPimProductId

			    INSERT INTO ZnodePimProductAttributeDefaultValue  (PimAttributeValueId,LocaleId,PimAttributeDefaultValueId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			   SELECT ZPAVI.PimAttributeValueId,ZPAVL.LocaleId,ZPAVL.PimAttributeDefaultValueId,@UserId,@GetDate,@UserId,@GetDate
			   FROM ZnodePimProductAttributeDefaultValue ZPAVL 
			   INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId )
			   INNER JOIN ZnodePimAttributeValue ZPAVI ON (ZPAVI.PimAttributeId = ZPAV.PimAttributeId AND ZPAVI.PimProductId = @PimProductId )
			   WHERE ZPAVL.LocaleId <> dbo.Fn_GetDefaultLocaleId()
			   AND ZPAV.PimProductId = @CopyPimProductId


			   INSERT INTO ZnodePimProductAttributeTextAreaValue  (PimAttributeValueId,LocaleId,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			   SELECT ZPAVI.PimAttributeValueId,ZPAVL.LocaleId,ZPAVL.AttributeValue,@UserId,@GetDate,@UserId,@GetDate
			   FROM ZnodePimProductAttributeTextAreaValue ZPAVL 
			   INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId )
			   INNER JOIN ZnodePimAttributeValue ZPAVI ON (ZPAVI.PimAttributeId = ZPAV.PimAttributeId AND ZPAVI.PimProductId = @PimProductId )
			   WHERE ZPAVL.LocaleId <> dbo.Fn_GetDefaultLocaleId()
			   AND ZPAV.PimProductId = @CopyPimProductId
			   			   
			   INSERT INTO ZnodePimProductAttributeMedia  (PimAttributeValueId,LocaleId,MediaPath,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			   SELECT ZPAVI.PimAttributeValueId,ZPAVL.LocaleId,ZPAVL.MediaPath,@UserId,@GetDate,@UserId,@GetDate
			   FROM ZnodePimProductAttributeMedia ZPAVL 
			   INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId )
			   INNER JOIN ZnodePimAttributeValue ZPAVI ON (ZPAVI.PimAttributeId = ZPAV.PimAttributeId AND ZPAVI.PimProductId = @PimProductId )
			   WHERE ZPAVL.LocaleId <> dbo.Fn_GetDefaultLocaleId()
			   AND ZPAV.PimProductId = @CopyPimProductId
			   
			 END 

             COMMIT TRAN A;
         END TRY
         BEGIN CATCH
             SELECT ERROR_MESSAGE()
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
			 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportInsertUpdatePimProduct @UserId = '+CAST(@UserId AS VARCHAR(50))+',@IsNotReturnOutput='+CAST(@IsNotReturnOutput AS VARCHAR(50))+',@CopyPimProductId='+CAST(@CopyPimProductId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
			ROLLBACK TRAN A;
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_ImportInsertUpdatePimProduct',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportValidateNumber')
	DROP PROC Znode_ImportValidateNumber
GO

CREATE PROCEDURE [dbo].[Znode_ImportValidateNumber]
(   @TableName        VARCHAR(200),
    @SourceColumnName NVARCHAR(600),
    @CreateDateString NVARCHAR(300),
    @ValidationName   VARCHAR(100),
    @ControlName      VARCHAR(300),
    @ValidationValue  VARCHAR(300),
    @NewGUID          NVARCHAR(200),
    @ImportHeadId     INT      = 0,
    @ImportProcessLogId int )
AS
/*
Summary: --First Validate numeric datatype then it check its functional validation such as Number ( MaxNo/ MinNo )  and Yes/No (-ve / Decimal Value )
             Number
             --------------------------------
              Control  Validation Rule
             --------------------------------
             1 Yes/No	AllowNegative
             2 Yes/No	AllowDecimals
             3 Number	MinNumber
             4 Number	MaxNumber

Unit Testing:
EXEC Znode_ImportValidateNumber
*/
     BEGIN
         BEGIN TRY 
            SET NOCOUNT ON
             DECLARE @SQLQuery NVARCHAR(MAX), @ImportHeadName NVARCHAR(100);
             SET @ImportHeadName = DBO.Fn_GetDefaultImportHead(@ImportHeadId);
             DECLARE @RoundOffValue INT,@IsNumeric bit = 0 ; 

             -- Retrive RoundOff Value from global setting 

			 IF @SourceColumnName in ('Quantity', 'ReOrderLevel','TierStartQuantity')
                 SELECT @RoundOffValue = dbo.[Fn_GetInventoryRoundOffValue]();
             ELSE
				 SELECT @RoundOffValue = dbo.[Fn_GetPriceRoundOffValue]();
             
		  -- IF Exists (Select TOP 1 1 from ZnodeImportLog where ImportProcessLogId= @ImportProcessLogId AND ErrorDescription = '2' AND ColumnName = @SourceColumnName)
		  -- BEGIN
			 --SET @IsNumeric  =1 
		  -- END

		   IF @IsNumeric  =0 
		   BEGIN
			  SET @SQLQuery = @TableName+' WHERE  Isnumeric('+@SourceColumnName+') = 0 and Isnull('+@SourceColumnName+','''') <> ''''
			  AND NOT EXISTS (Select TOP 1 1 from ZnodeImportLog where ImportProcessLogId= ' +  Convert(Varchar(100), @ImportProcessLogId  ) + ' AND ErrorDescription = ''2'' 
			  AND ColumnName = ''' + @SourceColumnName + ''') ';
             
			  EXEC Znode_ImportGenerateErrorLog
				  @ImportHeadName = @ImportHeadName,
				  @QueryCriteria = @SQLQuery,
				  @SourceColumnName = @SourceColumnName,
				  @CreateDateString = @CreateDateString,
				  @ErrorCode = '2'
		   END

		   IF @IsNumeric  = 0   
		   BEGIN
			  IF Exists (Select TOP 1 1 from ZnodeImportLog where ImportProcessLogId= @ImportProcessLogId AND ErrorDescription = '2' AND ColumnName = @SourceColumnName )
			  BEGIN
				SET @IsNumeric  =1 
			  END
		   END
             
		   IF @ControlName = 'Number'  AND @ValidationName IN('MaxNumber', 'MinNumber') AND ISNULL(@ValidationValue, '') <> '' AND ISNULL(@ValidationValue, '') > 0 AND @IsNumeric  = 0  
                 BEGIN
                     SET @SQLQuery = @TableName+'  WHERE Convert(money, '+@SourceColumnName+')'+CASE
                                                                                                    WHEN @ValidationName = 'MaxNumber'
                                                                                                    THEN '>'+@ValidationValue
                                                                                                    ELSE '<'+@ValidationValue
                                                                                                END+' AND Isnull('+@SourceColumnName+','''') <> ''''';
                     IF @ValidationName = 'MaxNumber'
                         EXEC Znode_ImportGenerateErrorLog
                              @ImportHeadName = @ImportHeadName,
                              @QueryCriteria = @SQLQuery,
                              @SourceColumnName = @SourceColumnName,
                              @CreateDateString = @CreateDateString,
                              @ErrorCode = '16',
                              @ValidationValue = @ValidationValue;
                     ELSE
					EXEC Znode_ImportGenerateErrorLog
						@ImportHeadName = @ImportHeadName,
						@QueryCriteria = @SQLQuery,
						@SourceColumnName = @SourceColumnName,
						@CreateDateString = @CreateDateString,
						@ErrorCode = '16',
						@ValidationValue = @ValidationValue;
		 
                     --Remove wrong data from table 
                     --SET @SQLQuery = 'DELETE FROM '+@TableName+'    WHERE Convert(money,'+@SourceColumnName+')'+CASE
                     --                                                                                               WHEN @ValidationName = 'MaxNumber'
                     --                                                                                               THEN '>'+@ValidationValue
                     --                                                                                               ELSE '<'+@ValidationValue
                     --                                                                                           END+' AND Isnull('+@SourceColumnName+','''') <> ''''';
                     --EXEC sys.sp_sqlexec
                     --     @SQLQuery;
                     -- END
                 END;
             -- 1
             IF @ControlName = 'Yes/No' AND @ValidationName IN('AllowNegative') AND @ValidationValue = 'false' AND @IsNumeric  = 0 
                 BEGIN
                     BEGIN
                         SET @SQLQuery = @TableName+' WHERE  Convert( Money,'+@SourceColumnName+' ) < 0  AND Isnull('+@SourceColumnName+', '''') <> ''''';
                         EXEC Znode_ImportGenerateErrorLog
                              @ImportHeadName = @ImportHeadName,
                              @QueryCriteria = @SQLQuery,
                              @SourceColumnName = @SourceColumnName,
                              @CreateDateString = @CreateDateString,
                              @ErrorCode = '4',
                              @ValidationValue = '' ;
			
                         --Remove wrong data from table 
                         --SET @SQLQuery = 'DELETE FROM '+@TableName+'    WHERE Convert( Money,'+@SourceColumnName+' ) < 0  AND Isnull('+@SourceColumnName+', '''') <> ''''';
                         --EXEC sys.sp_sqlexec  @SQLQuery;
                     END;
                 END;
             IF @ControlName = 'Number' AND @SourceColumnName <> 'RowNumber' AND @ImportHeadName in ( 'Inventory' ,'Pricing') AND @IsNumeric  = 0 
                 BEGIN
                     ---Validate roundoff value after decimal place should be between value which is define in global settings
                     SET @SQLQuery = @TableName+'  WHERE ( CASE WHEN '+@SourceColumnName+' LIKE ''%.%'' THEN LEN(SUBSTRING('+@SourceColumnName+' , CHARINDEX(''.'' , '+@SourceColumnName+')+1 , 4000)) ELSE 0 END > ( '+CONVERT(VARCHAR(100), @RoundOffValue)+') )'+'  AND Isnull('+@SourceColumnName+', '''') <> ''''';
                     EXEC Znode_ImportGenerateErrorLog
                          @ImportHeadName = @ImportHeadName,
                          @QueryCriteria = @SQLQuery,
                          @SourceColumnName = @SourceColumnName,
                          @CreateDateString = @CreateDateString,
                          @ErrorCode = '111',
                          @ValidationValue = '0.999999';
			
                     --Remove wrong data from table 
                     --SET @SQLQuery = 'DELETE FROM '+@TableName+'  WHERE ( CASE WHEN '+@SourceColumnName+' LIKE ''%.%'' THEN LEN(SUBSTRING('+@SourceColumnName+' , CHARINDEX(''.'' , '+@SourceColumnName+')+1 , 4000)) ELSE 0 END > ( '+CONVERT(VARCHAR(100), @RoundOffValue)+') )'+'  AND Isnull('+@SourceColumnName+', '''') <> ''''';
                     --EXEC sys.sp_sqlexec  @SQLQuery;
                 END;
         END TRY
         BEGIN CATCH
             DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			 @ErrorCall NVARCHAR(MAX)= 'EXECZnode_ImportValidateNumber @TableName = '+@TableName+',@SourceColumnName='+@SourceColumnName+',@CreateDateString='+@CreateDateString+',@ValidationName='+@ValidationName+',@ControlName = '+@ControlName+',@ValidationValue='+@ValidationValue+',@NewGUID='+@NewGUID+',@ImportHeadId='+CAST(@ImportHeadId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_ImportValidateNumber',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

Update znodemessage set MessageName='Input must include positive numeric value greater than 0'
where MessageName='Input must be a positive numeric value'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportAddonAssociation')
	DROP PROC Znode_ImportAddonAssociation
GO

CREATE PROCEDURE [dbo].[Znode_ImportAddonAssociation](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();

		IF OBJECT_ID('TEMPDB..#InsertProductAddonAssociation') IS NOT NULL
			DROP TABLE #InsertProductAddonAssociation

		IF OBJECT_ID('TEMPDB..#SKU') IS NOT NULL
			DROP TABLE #SKU

		IF OBJECT_ID('TEMPDB..#InsertZnodePimAddOnProduct') IS NOT NULL
			DROP TABLE #InsertZnodePimAddOnProduct

		CREATE TABLE #InsertZnodePimAddOnProduct ( PimAddOnProductId int,PimAddonGroupId int,PimProductId int)

		CREATE TABLE #InsertProductAddonAssociation
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, SKU varchar(300),AddonGroupName varchar(300),AddOnSKU varchar(300),DisplayOrder int, IsDefault varchar(10), GUID nvarchar(400)
		
		);

		CREATE TABLE #SKU 
		( 
			SKU nvarchar(300), PimProductId int
		);

		----Get All SKU Data From DB
		INSERT INTO #SKU (SKU, PimProductId)
		SELECT ZPAVL.AttributeValue, ZPAV.PimProductId
		FROM ZnodePimAttributeValue AS ZPAV
		INNER JOIN ZnodePimAttributeValueLocale AS ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		INNER JOIN ZnodePimAttribute ZPA ON ZPAV.PimAttributeId = ZPA.PimAttributeId
		WHERE ZPA.AttributeCode = 'SKU';

		SET @SSQL = 'Select RowNumber,SKU,AddonGroupName,AddOnSKU,DisplayOrder,IsDefault,GUID FROM '+@TableName;
		INSERT INTO #InsertProductAddonAssociation( RowNumber,SKU,AddonGroupName,AddOnSKU,DisplayOrder,IsDefault,GUID )
		EXEC sys.sp_sqlexec @SSQL;

		SELECT SKU,AddonGroupName,AddOnSKU 
		INTO #DuplicateProductAddonAssociation 
		FROM #InsertProductAddonAssociation 
		Group BY SKU,AddonGroupName,AddOnSKU  having count(*) > 1

		----Checking AddonGroupName present in DB
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '99', 'AddonGroupName', AddonGroupName, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM #InsertProductAddonAssociation AS ii
		WHERE NOT EXISTS ( SELECT * FROM ZnodePimAddonGroupLocale i where i.AddonGroupName = ii.AddonGroupName );

		----Checking SKU present in DB
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '98', 'SKU', SKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM #InsertProductAddonAssociation AS ii
		WHERE NOT EXISTS( SELECT * FROM #SKU SKU WHERE ii.SKU = SKU.SKU)

		----Checking AddOnSKU present in DB
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '98', 'AddOnSKU', AddOnSKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM #InsertProductAddonAssociation AS ii
		WHERE NOT EXISTS( SELECT * FROM #SKU SKU WHERE ii.AddOnSKU = SKU.SKU)
		
		----Duplicate Record (SKU \ AddOnSKU \ AddonGroupName)
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '53', 'SKU \ AddOnSKU \ AddonGroupName ', SKU+' \ '+AddOnSKU+' \ '+AddonGroupName, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM #InsertProductAddonAssociation AS ii
		WHERE EXISTS ( select * FROM #DuplicateProductAddonAssociation i WHERE i.SKU = ii.SKU and i.AddOnSKU = ii.AddOnSKU and i.AddonGroupName = ii.AddonGroupName );

		----Checking is default value data validation
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'IsDefault', IsDefault, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertProductAddonAssociation AS ii  
		WHERE ISNULL(ii.IsDefault,0) not in ('True','1','Yes','FALSE','0','No','')
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '115', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM #InsertProductAddonAssociation AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL ) AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '115', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM #InsertProductAddonAssociation AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 999

		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ SKU - ' + isnull(SKU,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN #InsertProductAddonAssociation IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		-- Delete Invalid Data after functional validatin  
		DELETE FROM #InsertProductAddonAssociation
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertProductAddonAssociation
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount
		,	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))  
		WHERE ImportProcessLogId = @ImportProcessLogId;


		UPDATE PAPD
		SET PAPD.ModifiedBy =@UserId  ,PAPD.ModifiedDate = GETDATE(),
		PAPD.IsDefault = case when IPAA.IsDefault in ('True','1','Yes') then 1 else 0 end,
		PAPD.DisplayOrder = CASE WHEN IPAA.DisplayOrder IS NOT NULL THEN IPAA.DisplayOrder ELSE PAPD.DisplayOrder END
		FROM #InsertProductAddonAssociation IPAA
		INNER JOIN #SKU SKU ON SKU.SKU = IPAA.SKU
		INNER JOIN #SKU SKU1 ON SKU1.SKU = IPAA.AddOnSKU
		INNER JOIN ZnodePimAddonGroupLocale ZPAGL on ZPAGL.AddonGroupName = IPAA.AddonGroupName
		INNER JOIN ZnodePimAddOnProduct PAP ON (PAP.PimProductId = SKU.PimProductId AND PAP.PimAddonGroupId = ZPAGL.PimAddonGroupId)
		INNER JOIN ZnodePimAddOnProductDetail PAPD ON (PAPD.PimAddOnProductId =PAP.PimAddOnProductId AND SKU1.PimProductId = PAPD.PimChildProductId )

		-----Inserting records in ZnodePimAddOnProduct
		INSERT INTO ZnodePimAddOnProduct(PimAddonGroupId,PimProductId,DisplayOrder,RequiredType,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		OUTPUT inserted.PimAddOnProductId, inserted.PimAddonGroupId,inserted.PimProductId into #InsertZnodePimAddOnProduct (PimAddOnProductId,PimAddonGroupId,PimProductId)
		SELECT DISTINCT ZPAGL.PimAddonGroupId,SKU.PimProductId, 999 as DisplayOrder,
		'Required' RequiredType,@UserId as CreatedBy,@GetDate,@UserId as ModifiedBy,@GetDate
		FROM #InsertProductAddonAssociation IPAA
		INNER JOIN #SKU SKU ON SKU.SKU = IPAA.SKU
		INNER JOIN ZnodePimAddonGroupLocale ZPAGL on ZPAGL.AddonGroupName = IPAA.AddonGroupName
		WHERE NOT EXISTS(SELECT * FROM ZnodePimAddOnProduct ZPAP where ZPAP.PimAddonGroupId = ZPAGL.PimAddonGroupId and ZPAP.PimProductId = SKU.PimProductId )

		-----Inserting records in ZnodePimAddOnProductDetail
		INSERT INTO ZnodePimAddOnProductDetail(PimAddOnProductId,PimChildProductId,IsDefault,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT DISTINCT ZPAP.PimAddOnProductId, SKU.PimProductId as PimChildProductId, CASE WHEN isnull(IPAA.IsDefault,0) IN ('True','1','Yes') THEN 1 ELSE 0 END, ISNULL(IPAA.DisplayOrder,999),@UserId ,@GetDate,@UserId,@GetDate 
		FROM #InsertProductAddonAssociation IPAA
		INNER JOIN #SKU SKU1 ON SKU1.SKU = IPAA.SKU
		INNER JOIN #SKU SKU ON SKU.SKU = IPAA.AddOnSKU
		INNER JOIN ZnodePimAddonGroupLocale ZPAGL on IPAA.AddonGroupName = ZPAGL.AddonGroupName
		INNER JOIN ZnodePimAddOnProduct ZPAP on SKU1.PimProductId = ZPAP.PimProductId and ZPAP.PimAddonGroupId = ZPAGL.PimAddonGroupId
		WHERE NOT EXISTS(SELECT * FROM ZnodePimAddOnProductDetail ZPAPD WHERE ZPAPD.PimAddOnProductId = ZPAP.PimAddOnProductId and ZPAPD.PimChildProductId = SKU.PimProductId )

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;

	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAddonAssociation @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportAddonAssociation',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportAttributeDefaultValue')
	DROP PROC Znode_ImportAttributeDefaultValue
GO

CREATE PROCEDURE [dbo].[Znode_ImportAttributeDefaultValue](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200))
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		-- Retrive RoundOff Value from global setting 
		DECLARE @InsertPimAtrribute TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY,
			-- RowNumber int, AttributeName varchar(300), AttributeCode varchar(300), AttributeType varchar(300), DisplayOrder int, GUID nvarchar(400)
			RowNumber int, AttributeCode varchar(300),AttributeDefaultValueCode varchar(300),AttributeDefaultValue varchar(1000),IsEditable varchar(10),DisplayOrder int, IsDefault varchar(10), SwatchText varchar(1000),SwatchImage varchar(500), SwatchImagePath varchar(500), GUID nvarchar(400)
		
		);
		DECLARE @InsertedPimAttributeIds TABLE (PimAttributeId int ,PimAttributeDefaultValueId int,AttributeDefaultValueCode nvarchar(300))
		
		SET @SSQL = 'Select RowNumber,AttributeCode,AttributeDefaultValueCode,AttributeDefaultValue,IsEditable,DisplayOrder,IsDefault,SwatchText,SwatchImage, SwatchImagePath ,GUID FROM '+@TableName;
		INSERT INTO @InsertPimAtrribute( RowNumber,AttributeCode,AttributeDefaultValueCode,AttributeDefaultValue,IsEditable,DisplayOrder,IsDefault,SwatchText,SwatchImage, SwatchImagePath ,GUID)
		EXEC sys.sp_sqlexec @SSQL;

		--@MessageDisplay will use to display validate message for input inventory value  
		DECLARE @AttributeCode TABLE
		( 
		   AttributeCode nvarchar(300)
		);
		INSERT INTO @AttributeCode
			   SELECT AttributeCode
			   FROM ZnodePimAttribute 

		-- Start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '117', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.AttributeCode not in 
			   (
				   SELECT AttributeCode FROM @AttributeCode
			   );

		WITH CTE_AttributeDefaultValueCode AS(
		SELECT AttributeDefaultValueCode , AttributeCode, RowNumber ,ROW_NUMBER ()OVER (PARTITION BY AttributeDefaultValueCode , AttributeCode ORDER BY AttributeDefaultValueCode , AttributeCode )  Row_Id
		FROM @InsertPimAtrribute Z
		
		
		)
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '53', 'AttributeDefaultValueCode', AttributeDefaultValueCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE EXISTS
			  ( SELECT TOP 1 1 FROM CTE_AttributeDefaultValueCode Z WHERE Z.RowNumber=ii.RowNumber AND Z.Row_Id >1
			   )
			  

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '102', 'AttributeDefaultValueCode', AttributeDefaultValueCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.AttributeDefaultValueCode,''))) like '%[^0-9A-Za-z]%'

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '102', 'AttributeDefaultValueCode', AttributeDefaultValueCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.AttributeDefaultValueCode,''))) like '% %' -----space not allowed

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsEditable', IsEditable, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.IsEditable not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsDefault', IsDefault, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.IsDefault not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '16', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL ) AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '16', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 99999

		UPDATE ZIL
			SET ZIL.ColumnName =   ZIL.ColumnName + ' [ AttributeDefaultValueCode - ' + ISNULL(AttributeDefaultValueCode,'') + ' ] '
			FROM ZnodeImportLog ZIL 
			INNER JOIN @InsertPimAtrribute IPA ON (ZIL.RowNumber = IPA.RowNumber)
			WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL


		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertPimAtrribute
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertPimAtrribute
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount
		,	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;

		DECLARE @MediaId INT
		SET @MediaId = (SELECT TOP 1 MediaId from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.SwatchImage = ZM.FileName and IPA.SwatchImagePath = ZM.Path)

		if (isnull(@MediaId,0)=0)
			SET @MediaId = (SELECT max(MediaId) from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.SwatchImage = ZM.FileName)

        update ZPADV set ZPADV.IsEditable = case when IPA.IsEditable in ('True','1','Yes') then 1 else 0 end,ZPADV.DisplayOrder = Case when Isnull(IPA.DisplayOrder,0) <> 0 then  IPA.DisplayOrder else ZPADV.DisplayOrder end ,
		                 ZPADV.IsDefault = case when IPA.IsDefault in ('True','1','Yes') then 1 else 0 end ,ZPADV.SwatchText = IPA.SwatchText ,
		                 ZPADV.MediaId = case when isnull(@MediaId,0)= 0 then ZPADV.MediaId else @MediaId end, ZPADV.ModifiedBy = @UserId, ZPADV.ModifiedDate = @GetDate 
		from @InsertPimAtrribute IPA 
		INNER JOIN ZnodePimAttribute ZPA ON IPA.AttributeCode = ZPA.AttributeCode 
		inner join ZnodePimAttributeDefaultValue ZPADV on ZPA.PimAttributeId = ZPADV.PimAttributeId and IPA.AttributeDefaultValueCode = ZPADV.AttributeDefaultValueCode

		update ZPADVL set ZPADVL.AttributeDefaultValue = IPA.AttributeDefaultValue, ZPADVL.ModifiedBy = @UserId, ZPADVL.ModifiedDate = @GetDate 
		from @InsertPimAtrribute IPA 
		INNER JOIN ZnodePimAttribute ZPA ON IPA.AttributeCode = ZPA.AttributeCode 
		inner join ZnodePimAttributeDefaultValue ZPADV on ZPA.PimAttributeId = ZPADV.PimAttributeId and IPA.AttributeDefaultValueCode = ZPADV.AttributeDefaultValueCode
		inner join ZnodePimAttributeDefaultValueLocale ZPADVL ON ( ZPADVL.PimAttributeDefaultValueId = ZPADV.PimAttributeDefaultValueId)

		--- Insert data into base table ZnodePimatrribute with their validation 

		INSERT INTO ZnodePimAttributeDefaultValue (PimAttributeId,AttributeDefaultValueCode,IsEditable,DisplayOrder,IsDefault,SwatchText,MediaId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)		
		OUTPUT Inserted.PimAttributeId,Inserted.PimAttributeDefaultValueId,Inserted.AttributeDefaultValueCode INTO @InsertedPimAttributeIds  		
		SELECT ZPA.PimAttributeId,IPA.AttributeDefaultValueCode, case when IPA.IsEditable in ('True','1','Yes') then 1 else 0 end , Case when Isnull(IPA.DisplayOrder,0) = 0 then  99999 else IPA.DisplayOrder end  , 
		       case when IPA.IsDefault in ('True','1','Yes') then 1 else 0 end , IPA.SwatchText, @MediaId,@UserId , @GetDate ,@UserId , @GetDate 
		from @InsertPimAtrribute IPA 
		INNER JOIN ZnodePimAttribute ZPA ON IPA.AttributeCode = ZPA.AttributeCode  
		where not exists(select * from ZnodePimAttributeDefaultValue ZPADV where ZPA.PimAttributeId = ZPADV.PimAttributeId and IPA.AttributeDefaultValueCode = ZPADV.AttributeDefaultValueCode)
		
		INSERT INTO ZnodePimAttributeDefaultValueLocale(LocaleId,PimAttributeDefaultValueId,AttributeDefaultValue,Description,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		Select @LocaleId ,IPAS.PimAttributeDefaultValueId, IPA.AttributeDefaultValue, '', @UserId , @GetDate ,@UserId , @GetDate   
		FROM @InsertedPimAttributeIds IPAS 
		INNER JOIN ZnodePimAttribute ZPA ON IPAS.PimAttributeId = ZPA.PimAttributeId  
		INNER JOIN @InsertPimAtrribute IPA ON ZPA.AttributeCode= IPA.AttributeCode and IPAS.AttributeDefaultValueCode = IPA.AttributeDefaultValueCode

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
	
		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAttributeDefaultValue @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200));

		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportAttributeDefaultValue',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		

	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportAttributes')
	DROP PROC Znode_ImportAttributes
GO

CREATE PROCEDURE [dbo].[Znode_ImportAttributes](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		-- Retrive RoundOff Value from global setting 
		DECLARE @InsertPimAtrribute TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, AttributeName varchar(300), AttributeCode varchar(300), AttributeType varchar(300), DisplayOrder int, GUID nvarchar(400)
		
		);
		DECLARE @InsertedPimAttributeIds TABLE (PimAttributeId int ,AttributeTypeId int,AttributeCode nvarchar(300))
		
		SET @SSQL = 'Select RowNumber,AttributeName,AttributeCode,AttributeType,DisplayOrder ,GUID FROM '+@TableName;
		INSERT INTO @InsertPimAtrribute( RowNumber,AttributeName,AttributeCode,AttributeType,DisplayOrder ,GUID)
		EXEC sys.sp_sqlexec @SSQL;


		--@MessageDisplay will use to display validate message for input inventory value  
		DECLARE @AttributeCode TABLE
		( 
		   AttributeCode nvarchar(300)
		);
		INSERT INTO @AttributeCode
			   SELECT AttributeCode
			   FROM ZnodePimAttribute 

		-- Start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '10', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.AttributeCode in 
			   (
				   SELECT AttributeCode FROM @AttributeCode  where AttributeCode is not null 
			   );
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '53', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.AttributeCode in 
			   (
				   select AttributeCode  FROM @InsertPimAtrribute  Group BY AttributeCode  having count(*) > 1 
			   );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '103', 'AttributeType', AttributeType, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.AttributeType NOT in 
			   (
				   SELECT AttributeTypeName  FROM ZnodeAttributeType  where IsPimAttributeType = 1 
			   );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '50', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.AttributeCode,''))) like '%[^0-9A-Za-z]%'

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '50', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE Isnumeric(ltrim(rtrim(isnull(ii.AttributeCode,'')))) =1

	    INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '119', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.AttributeCode,''))) NOT LIKE '[^0-9]%'

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '102', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.AttributeCode,''))) like '% %' -----space not allowed

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '17', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '16', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 99999


		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ Attribute - ' + ISNULL(AttributeCode,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN @InsertPimAtrribute IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertPimAtrribute
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertPimAtrribute
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- End


		--- Insert data into base table ZnodePimatrribute with their validation 

		INSERT INTO ZnodePimAttribute (AttributeTypeId,AttributeCode,IsRequired,IsLocalizable,IsFilterable,IsSystemDefined
			,IsConfigurable,IsPersonalizable,IsShowOnGrid,DisplayOrder,HelpDescription,IsCategory,IsHidden,IsSwatch,
			CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		
		OUTPUT Inserted.PimAttributeId,Inserted.AttributeTypeId,Inserted.AttributeCode INTO @InsertedPimAttributeIds  
		
		SELECT ZAT.AttributeTypeId,AttributeCode, 0 IsRequired , 1 IsLocalizable,1 IsFilterable, 0 IsSystemDefined, 0 IsConfigurable,
		0 IsPersonalizable,  0 IsShowOnGrid , Case when Isnull(DisplayOrder,0) = 0 then  999 else DisplayOrder end  , '' HelpDescription ,0  IsCategory , 0 IsHidden , 0 IsSwatch,
		@UserId , @GetDate ,@UserId , @GetDate from @InsertPimAtrribute IPA INNER JOIN ZnodeAttributeType ZAT 
		ON IPA.AttributeType = ZAT.AttributeTypeName  
		
		
		INSERT INTO ZnodePimAttributeLocale (LocaleId,PimAttributeId,AttributeName,Description,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		Select @LocaleId ,IPAS.PimAttributeId, IPA.AttributeName, '', @UserId , @GetDate ,@UserId , @GetDate   
		 FROM @InsertedPimAttributeIds IPAS INNER JOIN @InsertPimAtrribute IPA ON IPAS.AttributeCode= IPA.AttributeCode 
		
		INSERT INTO ZnodePimAttributeValidation
		(PimAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT IPA.PimAttributeId,ZAIV.InputValidationId,NULL,null , @UserId , @GetDate ,@UserId , @GetDate  
		FROM @InsertedPimAttributeIds IPA INNER JOIN ZnodeAttributeInputValidation ZAIV ON IPA.AttributeTypeId = ZAIV.AttributeTypeId


		insert into ZnodePimFrontendProperties (PimAttributeId,IsComparable,IsUseInSearch,IsHtmlTags,IsFacets,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		Select PimAttributeId, 0 IsComparable, 0 IsUseInSearch,0 IsHtmlTags,0 IsFacets, @UserId CreatedBy,@GetDate CreatedDate, @UserId ModifiedBy, @GetDate ModifiedDate
		from  @InsertedPimAttributeIds
		--      SET @Status = 1;

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAttributes @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportAttributes',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;

	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCatalogCategory')
	DROP PROC Znode_ImportCatalogCategory
GO

CREATE PROCEDURE [dbo].[Znode_ImportCatalogCategory](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Catalog Category Product association
	
	-- Unit Testing : 
	--BEGIN TRANSACTION;
	--update ZnodeGlobalSetting set FeatureValues = '5' WHERE FeatureName = 'InventoryRoundOff' 
	--    DECLARE @status INT;
	--    EXEC [Znode_ImportInventory] @InventoryXML = '<ArrayOfImportInventoryModel>
	-- <ImportInventoryModel>
	--   <SKU>S1002</SKU>
	--   <Quantity>999998.33</Quantity>
	--   <ReOrderLevel>10</ReOrderLevel>
	--   <RowNumber>1</RowNumber>
	--   <ListCode>TestInventory</ListCode>
	--   <ListName>TestInventory</ListName>
	-- </ImportInventoryModel>
	--</ArrayOfImportInventoryModel>' , @status = @status OUT , @UserId = 2;
	--    SELECT @status;
	--    ROLLBACK TRANSACTION;
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate();
		-- Retrive RoundOff Value from global setting 
		DECLARE @InsertCatalogCategory TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, SKU varchar(300), CategoryCode varchar(200), DisplayOrder int, IsActive varchar(10), GUID nvarchar(400)
			--,Index Ind_SKU1 (SKU),Index Ind_CategoryName (CategoryName)
		);

		DECLARE @CategoryAttributId int;

		SET @CategoryAttributId =
		(
			SELECT TOP 1 PimAttributeId
			FROM ZnodePimAttribute AS ZPA
			WHERE ZPA.AttributeCode = 'CategoryCode' AND 
				  ZPA.IsCategory = 1
		);

		DECLARE @InventoryListId int;

		SET @SSQL = 'Select RowNumber,trim(SKU),CategoryCode,DisplayOrder ,IsActive,GUID FROM '+@TableName;
		INSERT INTO @InsertCatalogCategory( RowNumber, SKU, CategoryCode, DisplayOrder, IsActive, GUID )
		EXEC sys.sp_sqlexec @SSQL;

		----Removing Duplicate data
		;with cte as
		(
			select SKU, CategoryCode,max(RowNumber) as RowNumber from @InsertCatalogCategory
			group by SKU, CategoryCode
		)
		delete a from @InsertCatalogCategory a
		where  not exists (select * from CTE b where a.RowNumber = b.RowNumber )

		--@MessageDisplay will use to display validate message for input inventory value  
		DECLARE @SKU TABLE
		( 
		   SKU nvarchar(300), PimProductId INT--, Index Ins_SKU (SKU)
		);
		INSERT INTO @SKU
			   SELECT b.AttributeValue, a.PimProductId
			   FROM ZnodePimAttributeValue AS a
					INNER JOIN
					ZnodePimAttributeValueLocale AS b
					ON a.PimAttributeId = dbo.Fn_GetProductSKUAttributeId() AND 
					   a.PimAttributeValueId = b.PimAttributeValueId;

		Declare @PimCategoryAttributeId int 
		set @PimCategoryAttributeId = (select top 1 PimAttributeId from ZnodePimAttribute where AttributeCode = 'CategoryCode')

		DECLARE @CategoryCode TABLE
		( 
			CategoryCode nvarchar(300), PimCategoryId int --index ind_101 (CategoryName)
		);
		INSERT INTO @CategoryCode
			   SELECT ZPCAL.CategoryValue, ZPCA.PimCategoryId
			   FROM ZnodePimCategoryAttributeValue AS ZPCA
					INNER JOIN
					ZnodePimCategoryAttributeValueLocale AS ZPCAL
					ON ZPCA.PimAttributeId = @PimCategoryAttributeId AND 
					ZPCA.PimCategoryAttributeValueId = ZPCAL.PimCategoryAttributeValueId;
					
		-- start Functional Validation 
		
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '98', 'SKU', SKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertCatalogCategory AS ii
			   WHERE ii.SKU NOT in 
			   (
				   SELECT SKU FROM @SKU  where SKU IS NOT NULL 
			   );
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '105', 'CategoryCode', CategoryCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertCatalogCategory AS ii
			   WHERE ii.CategoryCode NOT IN 
			   (
				   SELECT CategoryCode FROM @CategoryCode  where CategoryCode IS NOT NULL 
			   );
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '17', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM @InsertCatalogCategory AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '115', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM @InsertCatalogCategory AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 999

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		  SELECT '68', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		  FROM @InsertCatalogCategory AS ii  
		  WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No')

		  
		
		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ CategoryCode - ' + ISNULL(CategoryCode,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN @InsertCatalogCategory IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL


		-- End Function Validation 	
		-----------------------------------------------
		--- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertCatalogCategory
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber IS NOT NULL 
			--AND GUID = @NewGUID
		);

	
		
			  Declare @ZnodePimCategoryProduct TABLE (PimProductId int , PimCategoryId int , Status bit , DisplayOrder int) 
			  	
			  insert into @ZnodePimCategoryProduct (PimProductId , PimCategoryId , Status , DisplayOrder )
			  SELECT SKU.PimProductId, (Select top 1 PimCategoryId from @CategoryCode where ICC.CategoryCode = CategoryCode )  PimCategoryId
				 , CASE WHEN IsActive in ('True','1','Yes') Then 1 ELSE 0 END , DisplayOrder FROM @InsertCatalogCategory AS ICC INNER JOIN	 @SKU AS SKU ON ICC.SKU = SKU.SKU 
			
			  INSERT into ZnodePimCategoryProduct ( PimProductId, PimCategoryId, Status, DisplayOrder, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate) 
			  Select TABL.PimProductId, TABL.PimCategoryId, TABL.Status, TABL.DisplayOrder,@UserId, @GetDate, @UserId, @GetDate   from @ZnodePimCategoryProduct TABL    
			  Where NOT EXISTS (Select top 1 1 from ZnodePimCategoryProduct ZPCP where ZPCP.PimProductId = TABL.PimProductId and  ZPCP.PimCategoryId = TABL.PimCategoryId)

		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertCatalogCategory
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		
		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
 
		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCatalogCategory @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportCatalogCategory',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		
		
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportHighlight')
	DROP PROC Znode_ImportHighlight
GO

CREATE PROCEDURE [dbo].[Znode_ImportHighlight](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		-- Retrive RoundOff Value from global setting 
		DECLARE @InsertPimAtrribute TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY,
			RowNumber int, HighlightCode varchar(300), HighlightName varchar(1000),DisplayPopup varchar(300),Hyperlink varchar(1000),HighlightType varchar(300),IsActive varchar(100),DisplayOrder int,HighlightImage varchar(500),HighlightImagePath varchar(500), Description varchar(max), ShortDescription varchar(max), ImageAltTag varchar(400), GUID nvarchar(400)
		
		);
		DECLARE @InsertedPimAttributeIds TABLE (PimAttributeId int ,PimAttributeDefaultValueId int,AttributeDefaultValueCode nvarchar(300))
		
		SET @SSQL = 'Select RowNumber,HighlightCode, HighlightName,DisplayPopup,Hyperlink,HighlightType,IsActive,DisplayOrder,HighlightImage,HighlightImagePath,Description,ShortDescription,ImageAltTag ,GUID FROM '+@TableName;
		INSERT INTO @InsertPimAtrribute( RowNumber,HighlightCode, HighlightName,DisplayPopup,Hyperlink,HighlightType,IsActive,DisplayOrder,HighlightImage,HighlightImagePath,Description,ShortDescription,ImageAltTag ,GUID)
		EXEC sys.sp_sqlexec @SSQL;


		--@MessageDisplay will use to display validate message for input inventory value  
		DECLARE @HighlightAttributeDefaultCode TABLE
		( 
		   AttributeDefaultCode nvarchar(300)
		);
		INSERT INTO @HighlightAttributeDefaultCode
			   SELECT AttributeDefaultValueCode
			   FROM ZnodePimAttributeDefaultValue ZPADV
			   inner join ZnodePimAttribute ZPA on ZPADV.PimAttributeId = ZPA.PimAttributeId
			   where ZPA.AttributeCode = 'Highlights' 

		-- Start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '118', 'HighlightCode', HighlightCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.HighlightCode not in 
			   (
				   SELECT AttributeDefaultCode FROM @HighlightAttributeDefaultCode 
			   );
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'DisplayPopup', DisplayPopup, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.DisplayPopup not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '103', 'HighlightType', HighlightType, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.HighlightType NOT in 
			   (
				   SELECT HT.Name  FROM ZnodeHighlightType  HT
			   );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '17', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL ) AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '115', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 999

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '102', 'HighlightCode', HighlightCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.HighlightCode,''))) like '% %' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '53', 'HighlightCode', HighlightCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.HighlightCode in 
			   (
				   select HighlightCode  FROM @InsertPimAtrribute  Group BY HighlightCode  having count(*) > 1 
			   );

		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ Highlight - ' + ISNULL(HighlightCode,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN @InsertPimAtrribute IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL


		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertPimAtrribute
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertPimAtrribute
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;
		

		DECLARE @MediaId INT
		SET @MediaId = (SELECT TOP 1 MediaId from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.HighlightImage = ZM.FileName and IPA.HighlightImagePath = ZM.Path)

		if (isnull(@MediaId,0)=0)
			SET @MediaId = (SELECT max(MediaId) from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.HighlightImage = ZM.FileName)

		DECLARE @InsertedZnodeHighlight TABLE(HighlightId INT,HighlightCode VARCHAR(600)) 

			UPDATE ZH SET ZH.DisplayPopup = IPA.DisplayPopup, ZH.Hyperlink = IPA.Hyperlink, ZH.IsActive = case when IPA.IsActive in ('True','1','Yes') then 1 else 0 end,
			       ZH.DisplayOrder = IPA.DisplayOrder , ZH.ModifiedBy = @UserId, ZH.ModifiedDate = @GetDate 
			FROM @InsertPimAtrribute IPA 
			INNER JOIN ZnodeHighlightType ZHT on IPA.HighlightType = ZHT.Name
			INNER JOIN ZnodeHighlight ZH ON IPA.HighlightCode = ZH.HighlightCode and ZHT.HighlightTypeId = ZH.HighlightTypeId

			UPDATE ZHL SET ZHL.Name = IPA.HighlightName, ZHL.Description = IPA.Description, ZHL.ShortDescription = IPA.ShortDescription, ZHL.ImageAltTag = IPA.ImageAltTag
			       , ZHL.ModifiedBy = @UserId, ZHL.ModifiedDate = @GetDate 
			FROM @InsertPimAtrribute IPA 
			INNER JOIN ZnodeHighlightType ZHT on IPA.HighlightType = ZHT.Name
			INNER JOIN ZnodeHighlight ZH ON IPA.HighlightCode = ZH.HighlightCode and ZHT.HighlightTypeId = ZH.HighlightTypeId
			INNER JOIN ZnodeHighlightLocale ZHL  ON ZH.HighlightId = ZHL.HighlightId 

			INSERT INTO ZnodeHighlight (MediaId,HighlightCode,DisplayPopup,Hyperlink,HighlightTypeId,IsActive,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			OUTPUT Inserted.HighlightId,Inserted.HighlightCode INTO @InsertedZnodeHighlight
			SELECT DISTINCT @MediaId,IPA.HighlightCode, IPA.DisplayPopup , IPA.Hyperlink, ZHT.HighlightTypeId,
				   case when IPA.IsActive in ('True','1','Yes') then 1 else 0 end, Case when Isnull(IPA.DisplayOrder,0) = 0 then  999 else IPA.DisplayOrder end  , @UserId , @GetDate ,@UserId , @GetDate 
			FROM @InsertPimAtrribute IPA 
			INNER JOIN ZnodeHighlightType ZHT on IPA.HighlightType = ZHT.Name
			WHERE NOT EXISTS(select * from ZnodeHighlight ZH where ZH.HighlightCode = IPA.HighlightCode and ZH.HighlightTypeId = ZHT.HighlightTypeId)

			INSERT INTO ZnodeHighlightLocale(LocaleId,HighlightId,ImageAltTag,Name,Description,ShortDescription,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT DISTINCT @LocaleId, IZH.HighlightId, IPA.ImageAltTag, IPA.HighlightName, IPA.Description, IPA.ShortDescription, @UserId , @GetDate ,@UserId , @GetDate
			FROM @InsertPimAtrribute IPA 
			INNER JOIN @InsertedZnodeHighlight IZH on IPA.HighlightCode = IZH.HighlightCode 


		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportHighlight @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportHighlight',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		
		
	END CATCH;
END;

GO

update ZnodeMessage
set MessageName ='Input must be available as Code saved against any existing Account.'
where MessageName = 'Input should be available as Account Code with any existing Account.'

update ZnodeMessage
set MessageName ='Account and Customer should belong to the same Store therefore input must be available as Code saved against any existing Account of the respective Store.'
where MessageName = 'Account and Customer should belong to the same Store therefore input should be available as Account Code with any existing Account of the respective Store.'

update ZnodeMessage
set MessageName ='Input value is required in alphanumeric format without spaces'
where MessageName = 'Input value must be in alphanumeric format without spaces.'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportVoucher')
	DROP PROC Znode_ImportVoucher
GO

CREATE PROCEDURE [dbo].[Znode_ImportVoucher](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN Voucher;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		-- Retrive RoundOff Value from global setting 

		DECLARE @InsertVoucherData TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY,RowNumber int, StoreCode varchar(400),VoucherName varchar(600), VoucherNumber varchar(600),
			VoucherAmount varchar(600),UserName varchar(600), ExpirationDate Datetime,IsActive varchar(100),RemainingAmount varchar(600),
			RestrictVoucherToACustomer varchar(100), StartDate datetime, GUID nvarchar(400)
		);
		
		SET @SSQL = 'Select RowNumber,StoreCode, VoucherName,VoucherNumber,VoucherAmount,UserName,ExpirationDate,
						IsActive,RemainingAmount,RestrictVoucherToACustomer,StartDate,GUID FROM '+@TableName;
		INSERT INTO @InsertVoucherData( RowNumber,StoreCode, VoucherName,VoucherNumber,VoucherAmount,UserName,ExpirationDate,
										IsActive,RemainingAmount,RestrictVoucherToACustomer,StartDate,GUID)
		EXEC sys.sp_sqlexec @SSQL;

		select ANZU.UserName, ANU.Id, ZU.UserId
		into #TempUserData
		from AspNetZnodeUser ANZU 
		inner join AspNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName
		inner join ZnodeUser ZU ON ANU.Id = ZU.AspNetUserId

		select ZUP.PortalId, ZUP.UserId, ZP.StoreCode
		into #TempUserPortal
		from ZnodeUserPortal ZUP 
		INNER JOIN ZnodePortal ZP ON ZUP.PortalId = ZP.PortalId

		update @InsertVoucherData set VoucherNumber = [dbo].[Fn_RandomString](10)
		where isnull(ltrim(rtrim(VoucherNumber)),'') = ''

		-- Start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '120', 'StoreCode', StoreCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE ii.StoreCode not in 
			   (
				   SELECT StoreCode FROM ZnodePortal 
			   );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '65', 'ExpirationDate', ExpirationDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE (ii.ExpirationDate < ii.StartDate OR ii.ExpirationDate < @GetDate)

		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--	   SELECT '65', 'ExpirationDate', ExpirationDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		--	   FROM @InsertVoucherData AS ii
		--	   WHERE ii.ExpirationDate < @GetDate

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '8', 'StartDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE isnull(ii.StartDate,'') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '8', 'ExpirationDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE isnull(ii.ExpirationDate,'') = ''
		
		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--	   SELECT '67', 'UserName', UserName, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		--	   FROM @InsertVoucherData AS ii
		--	   WHERE isnull(ii.UserName,'') <> '' and not exists ( SELECT VoucherNumber FROM #TempUserData U where ii.UserName = U.UserName);
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '67', 'UserName', UserName, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii			 
			   WHERE isnull(ii.UserName,'') <> '' 
			   and not exists ( SELECT * FROM #TempUserData U where ii.UserName = U.UserName 
			   and not exists(select * from #TempUserPortal UP where U.UserId = UP.UserId and ii.StoreCode = UP.StoreCode))
			 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '71', 'VoucherNumber', VoucherNumber, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE len(ltrim(rtrim(ii.VoucherNumber))) <> 10 
	
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No','')
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '5', 'ExpirationDate', ExpirationDate, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			WHERE isdate(ii.ExpirationDate) = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '5', 'StartDate', StartDate, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			WHERE isdate(ii.StartDate) = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '69', 'RemainingAmount', RemainingAmount, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			WHERE ii.VoucherAmount <> ii.RemainingAmount

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'RestrictVoucherToACustomer', RestrictVoucherToACustomer, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			WHERE ii.RestrictVoucherToACustomer not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT distinct '2', 'VoucherAmount', VoucherAmount, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			CROSS APPLY ZnodeCulture b
			WHERE  VoucherAmount like '%[a-z]%' or VoucherAmount like '%'+b.Symbol+'%'
			and b.Symbol is not null 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT distinct '2', 'RemainingAmount', RemainingAmount, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii
			CROSS APPLY ZnodeCulture b
			WHERE  RemainingAmount like '%[a-z]%' or RemainingAmount like '%'+b.Symbol+'%'
			and b.Symbol is not null 


		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ VoucherName - ' + ISNULL(VoucherName,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN @InsertVoucherData IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertVoucherData
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertVoucherData
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;
	
		UPDATE ZGC set ExpirationDate = ICD.ExpirationDate, UserId = ZU.UserId, ModifiedBy = @UserId, ModifiedDate = @GetDate, IsActive = ICD.IsActive,
				RemainingAmount = ICD.RemainingAmount, RestrictToCustomerAccount = ICD.RestrictVoucherToACustomer, Name = ICD.VoucherName, StartDate = ICD.StartDate
				
		from ZnodeGiftCard ZGC
		inner join @InsertVoucherData ICD ON ICD.VoucherNumber = ZGC.CardNumber
		inner join ZnodePortal ZP ON ICD.StoreCode = ZP.StoreCode and ZGC.PortalId = ZP.PortalId
		left join #TempUserData ZU ON ICD.UserName = ZU.UserName

		insert into ZnodeGiftCard(PortalId,Name,CardNumber,Amount,UserId,ExpirationDate,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsActive,RemainingAmount,RestrictToCustomerAccount,StartDate)
		select ZP.PortalId, ICD.VoucherName, ICD.VoucherNumber, ICD.VoucherAmount,ZU.UserId, ICD.ExpirationDate, @UserId, @Getdate, @UserId, @Getdate, ICD.IsActive, ICD.RemainingAmount, ICD.RestrictVoucherToACustomer, ICD.StartDate
		From @InsertVoucherData ICD 
		inner join ZnodePortal ZP ON ICD.StoreCode = ZP.StoreCode 
		left join #TempUserData ZU ON ICD.UserName = ZU.UserName
		where not exists(select * from ZnodeGiftCard ZGC where ICD.VoucherNumber = ZGC.CardNumber )

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN Voucher;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN Voucher

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		 DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportVoucher @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));

		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportVoucher',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

INSERT INTO ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 120,'Text','Input must be available as a value in any existing Store.',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeMessage WHERE MessageCode = 120)


GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_SetPublishSEOEntity')
	DROP PROC Znode_SetPublishSEOEntity
GO

CREATE PROCEDURE [dbo].[Znode_SetPublishSEOEntity]
(
   @PortalId  INT = 0 
  ,@LocaleId  INT = 0 
  ,@IsPreviewEnable int = 0 
  ,@PreviewVersionId INT = 0 
  ,@ProductionVersionId INT = 0 
  ,@RevisionState varchar(50) = '' 
  ,@CMSSEOTypeId varchar(500) = '' 
  ,@CMSSEOCode varchar(300) = ''
  ,@UserId int = 0 
  ,@Status int OUTPUT 
  ,@IsCatalogPublish bit = 0 
  ,@VersionIdString varchar(2000) = ''
  ,@IsSingleProductPublish bit = 0 
)
AS
/*
    This Procedure is used to publish the SEO details
  
	EXEC ZnodeSetPublishSEOEntity 1 2,3
	A. 
		1. Preview - Preview
		2. None    - Production   --- 
		3. Production - Preview/Production
	B.
		select * from ZnodePublishStateApplicationTypeMapping
		select * from ZnodePublishState where PublishStateId in (3,4) 
		select * from ZnodePublishPortalLog 
	C.
		Select * from ZnodePublishState where IsDefaultContentState = 1  and IsContentState = 1  --Production 
    
	Unit testing 
	
	Exec [ZnodeSetPublishSEOEntity]
	   @PortalId  = 1 
	  ,@LocaleId  = 0 
	  ,@PreviewVersionId = 0 
	  ,@ProductionVersionId = 0 
	  ,@RevisionState = 'Preview/Production' 
	  ,@CMSSEOTypeId = 0
	  ,@CMSSEOCode = ''
	  ,@UserId = 0 

	 Exec [ZnodeSetPublishSEOEntity]
   @PortalId  = 1 
  ,@LocaleId  = 0 
  ,@PreviewVersionId = 0 
  ,@ProductionVersionId = 0 
  ,@RevisionState = 'Preview&Production' 
  ,@CMSSEOTypeId = 3
  ,@CMSSEOCode = ''
  ,@UserId = 0 




	
	*/
BEGIN 
BEGIN TRY 
SET NOCOUNT ON
   Begin 
		DECLARE @Tbl_PreviewVersionId    TABLE    (PreviewVersionId int , PortalId int , LocaleId int)
		DECLARE @Tbl_ProductionVersionId TABLE    (ProductionVersionId int  , PortalId int , LocaleId int)
		If (@IsCatalogPublish = 0  AND @IsSingleProductPublish = 0 )
		Begin
			If @PreviewVersionId = 0 
				Begin
   					Insert into @Tbl_PreviewVersionId 
					SELECT distinct VersionId , PortalId, LocaleId from  ZnodePublishWebStoreEntity where (PortalId = @PortalId or @PortalId=0 ) and  (LocaleId = 	@LocaleId OR @LocaleId = 0  ) and PublishState ='PREVIEW'
				end
			Else 
					Insert into @Tbl_PreviewVersionId SELECT distinct VersionId , PortalId, LocaleId from  ZnodePublishWebStoreEntity 
					where VersionId = @PreviewVersionId
			If @ProductionVersionId = 0 
   				Begin
					Insert into @Tbl_ProductionVersionId 
					SELECT distinct VersionId , PortalId , LocaleId from  ZnodePublishWebStoreEntity where (PortalId = @PortalId or @PortalId=0 ) and  (LocaleId = 	@LocaleId OR @LocaleId = 0  ) and PublishState ='PRODUCTION'
				End 
			Else 
				Insert into @Tbl_ProductionVersionId SELECT distinct VersionId , PortalId, LocaleId from  ZnodePublishWebStoreEntity 
				where VersionId = @ProductionVersionId
 		End
		Else if (@IsCatalogPublish= 1  AND @IsSingleProductPublish = 0 )
		Begin
			 IF OBJECT_ID('tempdb..#VesionIds') is not null
				DROP TABLE #VesionIds
  				 
			 SELECT PV.* into #VesionIds FROM ZnodePublishVersionEntity PV Inner join Split(@VersionIdString,',') S ON PV.VersionId = S.Item
		End
		
		DECLARE @SetLocaleId INT , @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleId(), @MaxCount INT =0 , @IncrementalId INT = 1  
		DECLARE @TBL_Locale TABLE (LocaleId INT , RowId INT IDENTITY(1,1))
		CREATE TABLE #TBL_SEO  
		(
			ItemName varchar(50),CMSSEODetailId int ,CMSSEODetailLocaleId int ,CMSSEOTypeId int ,SEOId int ,SEOTypeName varchar(50),SEOTitle nvarchar(Max)
			,SEODescription nvarchar(Max),
			SEOKeywords nvarchar(Max),SEOUrl nvarchar(Max) ,IsRedirect bit ,MetaInformation nvarchar(Max) ,LocaleId int ,
			OldSEOURL nvarchar(Max),CMSContentPagesId int ,PortalId int ,SEOCode varchar(300) ,CanonicalURL varchar(200),RobotTag varchar(50)
		)
		
		BEGIN 
			INSERT INTO @TBL_Locale (LocaleId) SELECT LocaleId FROM ZnodeLocale WHERE IsActive =1 AND (LocaleId  = @LocaleId OR @LocaleId = 0 )
			
			SET @MaxCount = ISNULL((SELECT MAx(RowId) FROM @TBL_Locale),0)
			WHILE @IncrementalId <= @MaxCount
			BEGIN 
				SET @SetLocaleId = (SELECT Top 1 LocaleId FROM @TBL_locale WHERE RowId = @IncrementalId)
				IF @IsSingleProductPublish = 0
				Begin
					;With Cte_GetCMSSEODetails AS 
					(
							select CT.Name ItemName,CD.CMSSEODetailId, CDL.CMSSEODetailLocaleId ,  CD.CMSSEOTypeId ,
									 CD.SEOId ,CDL.SEOTitle,CDL.SEODescription,
									 CDL.SEOKeywords,Lower(CD.SEOUrl) SEOUrl,CD.IsRedirect,CD.MetaInformation,
									 CDL.LocaleId,
									 NULL OldSEOURL, 
									 NULL CMSContentPagesId,CD.PortalId, CD.seoCode,CDL.CanonicalURL,CDL.RobotTag
									 from ZnodeCMSSEODetail CD 
									 INNER JOIN ZnodeCMSSEOType CT ON CD.CMSSEOTypeId = CT.CMSSEOTypeId 
									 INNER JOIN ZnodeCMSSEODetailLocale CDL ON CD.CMSSEODetailId = CDL.CMSSEODetailId 
									 WHERE (CDL.LocaleId = @SetLocaleId OR CDL.LocaleId = @DefaultLocaleId)  
									 AND (CD.PortalId = @PortalId  OR @PortalId  = 0 ) 
									 AND (Isnull(CD.SEOCode ,'') = @CMSSEOCode OR @CMSSEOCode = '' )
									 AND (Exists  (SELECT TOP 1 1 FROM dbo.Split(@CMSSEOTypeId ,',') SP WHERE SP.Item = CD.CMSSEOTypeId ) )
									union all
									select CT.Name ItemName,CD.CMSSEODetailId, CDL.CMSSEODetailLocaleId ,  CD.CMSSEOTypeId ,
										 CD.SEOId ,CDL.SEOTitle,CDL.SEODescription,
										 CDL.SEOKeywords,Lower(CD.SEOUrl) SEOUrl,CD.IsRedirect,CD.MetaInformation,
										 CDL.LocaleId,
										 NULL OldSEOURL, 
										 NULL CMSContentPagesId,ZPB.PortalId, CD.seoCode,CDL.CanonicalURL,CDL.RobotTag
										 from ZnodeCMSSEODetail CD 
										 INNER JOIN ZnodeCMSSEOType CT ON CD.CMSSEOTypeId = CT.CMSSEOTypeId 
										 INNER JOIN ZnodeCMSSEODetailLocale CDL ON CD.CMSSEODetailId = CDL.CMSSEODetailId
										 INNER JOIN ZnodeBrandDetails ZBD ON CD.SeoCode = ZBD.BrandCode
										 INNER JOIN ZnodePortalBrand ZPB ON ZBD.BrandId = ZPB.BrandId
										 WHERE (CDL.LocaleId = @SetLocaleId OR CDL.LocaleId = @DefaultLocaleId)  
										 AND (ZPB.PortalId = @PortalId  OR @PortalId  = 0 ) 
										 AND (Isnull(CD.SEOCode ,'') = @CMSSEOCode OR @CMSSEOCode = '' )
										 AND (Exists  (SELECT TOP 1 1 FROM dbo.Split(@CMSSEOTypeId ,',') SP WHERE SP.Item = CD.CMSSEOTypeId ) )
										 AND CT.Name = 'Brand' 
										 AND @IsCatalogPublish = 0
									 Union All 
									 select CT.Name ItemName,CD.CMSSEODetailId, CDL.CMSSEODetailLocaleId ,  CD.CMSSEOTypeId ,
								 CD.SEOId ,CDL.SEOTitle,CDL.SEODescription,
								 CDL.SEOKeywords,Lower(CD.SEOUrl) SEOUrl,CD.IsRedirect,CD.MetaInformation,
								 CDL.LocaleId,
								 NULL OldSEOURL, 
								 NULL CMSContentPagesId,ZPB.PortalId, CD.seoCode,CDL.CanonicalURL,CDL.RobotTag
								 from ZnodeCMSSEODetail CD 
								 INNER JOIN ZnodeCMSSEOType CT ON CD.CMSSEOTypeId = CT.CMSSEOTypeId 
								 INNER JOIN ZnodeCMSSEODetailLocale CDL ON CD.CMSSEODetailId = CDL.CMSSEODetailId 
								 INNER JOIN ZnodeBrandDetails ZBD ON CD.SeoCode = ZBD.BrandCode
								 INNER JOIN ZnodePortalBrand ZPB ON ZBD.BrandId = ZPB.BrandId
								 WHERE (CDL.LocaleId = @SetLocaleId OR CDL.LocaleId = @DefaultLocaleId)  
								 AND (Isnull(CD.SEOCode ,'') = @CMSSEOCode OR @CMSSEOCode = '' )
								 AND (CT.Name = 'Brand' ) 
								 AND @IsCatalogPublish= 1 
					)
					, Cte_GetFirstCMSSEODetails  AS
					(
						SELECT 
							ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
							SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation, LocaleId ,OldSEOURL,CMSContentPagesId,
							PortalId,SEOCode,CanonicalURL,RobotTag	
						FROM Cte_GetCMSSEODetails 
						WHERE LocaleId = @SetLocaleId
					)
					, Cte_GetDefaultFilterData AS
					(
						SELECT 
							ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
							SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,
							PortalId,SEOCode,CanonicalURL,RobotTag	  FROM  Cte_GetFirstCMSSEODetails 
						UNION ALL 
						SELECT 
							ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
							SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,
							PortalId,SEOCode,CanonicalURL,RobotTag	 FROM Cte_GetCMSSEODetails CTEC 
						WHERE LocaleId = @DefaultLocaleId 
						AND NOT EXISTS (SELECT TOP 1 1 FROM Cte_GetFirstCMSSEODetails CTEFD WHERE CTEFD.CMSSEOTypeId = CTEC.CMSSEOTypeId 
						and CTEFD.seoCode = CTEC.seoCode )
					)
	
					INSERT INTO #TBL_SEO (ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
					SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,
					PortalId,SEOCode,CanonicalURL,RobotTag)
					SELECT 
						ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
						SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,@SetLocaleId,OldSEOURL,CMSContentPagesId,
						PortalId,SEOCode,CanonicalURL,RobotTag	
					FROM Cte_GetDefaultFilterData  A 

					End 
					Else If @IsSingleProductPublish = 1  
						INSERT INTO #TBL_SEO (ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
						SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,
						PortalId,SEOCode,CanonicalURL,RobotTag)
							SELECT CT.Name ItemName,CD.CMSSEODetailId, CDL.CMSSEODetailLocaleId ,  CD.CMSSEOTypeId ,
							CD.SEOId ,CDL.SEOTitle,CDL.SEODescription,
							CDL.SEOKeywords,Lower(CD.SEOUrl) SEOUrl,CD.IsRedirect,CD.MetaInformation,
							CDL.LocaleId,
							NULL OldSEOURL, 
							NULL CMSContentPagesId,CD.PortalId, CD.seoCode,CDL.CanonicalURL,CDL.RobotTag
							from ZnodeCMSSEODetail CD 
							INNER JOIN ZnodeCMSSEOType CT ON CD.CMSSEOTypeId = CT.CMSSEOTypeId 
							INNER JOIN ZnodeCMSSEODetailLocale CDL ON CD.CMSSEODetailId = CDL.CMSSEODetailId 
							WHERE (CDL.LocaleId = @LocaleId )  
							AND (CD.PortalId = @PortalId  ) 
							AND (Isnull(CD.SEOCode ,'') = @CMSSEOCode OR @CMSSEOCode = '' )
							AND (Exists  (SELECT TOP 1 1 FROM dbo.Split(@CMSSEOTypeId ,',') SP WHERE SP.Item = CD.CMSSEOTypeId ) )

				SET @IncrementalId = @IncrementalId +1 
			END 
		End 
		End			

	If @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%' OR  @RevisionState like '%Production%')  AND @IsSingleProductPublish = 0
	Begin
	    --Data inserted into flat table ZnodePublishSeoEntity (Replica of MongoDB Collection )  
		Delete from ZnodePublishSeoEntity where PortalId = @PortalId  and VersionId  in (Select PreviewVersionId  from @TBL_PreviewVersionId ) 
		AND (SEOCode = @CMSSEOCode OR @CMSSEOCode = '' )
		AND (Exists  (SELECT TOP 1 1 FROM dbo.Split(@CMSSEOTypeId ,',') SP WHERE SP.Item = CMSSEOTypeId ) )
		AND @IsCatalogPublish= 0   

		If @IsCatalogPublish= 0
		BEGIN
			UPDATE C SET C.ElasticSearchEvent = 2 
			FROM ZnodePublishSeoEntity C
			WHERE NOT EXISTS(SELECT * FROM #TBL_SEO A
				Inner join @TBL_PreviewVersionId B on A.LocaleId = B.LocaleId AND A.LocaleId = B.LocaleId
				WHERE B.PreviewVersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId 
							AND A.PortalId = C.PortalId AND A.SEOCode = C.SEOCode)

			UPDATE C SET C.ItemName = A.ItemName ,
				C.SEOTypeName = A.ItemName,C.SEOTitle = A.SEOTitle,C.SEODescription = A.SEODescription,C.SEOKeywords=A.SEOKeywords,C.SEOUrl = A.SEOUrl,
				C.IsRedirect=A.IsRedirect,C.MetaInformation = A.MetaInformation,C.OldSEOURL = A.OldSEOURL,
				C.CanonicalURL = A.CanonicalURL,C.RobotTag = A.RobotTag, C.ElasticSearchEvent = 1
			FROM #TBL_SEO A 
			Inner join @TBL_PreviewVersionId B on A.LocaleId = B.LocaleId AND A.LocaleId = B.LocaleId 
			INNER JOIN ZnodePublishSeoEntity C ON B.PreviewVersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId 
						AND A.PortalId = C.PortalId AND A.SEOCode = C.SEOCode

			Insert Into ZnodePublishSeoEntity 
			(
				VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
				SEOTypeName,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL
				,CMSContentPagesId,	PortalId,SEOCode,CanonicalURL,RobotTag, ElasticSearchEvent
			)
			SELECT B.PreviewVersionId , Getdate(), ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
				ItemName,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,A.LocaleId,OldSEOURL,Isnull(CMSContentPagesId,0),
				A.PortalId,SEOCode,CanonicalURL,RobotTag, 1 AS ElasticSearchEvent
			FROM #TBL_SEO A Inner join @TBL_PreviewVersionId B on A.LocaleId = B.LocaleId AND A.LocaleId = B.LocaleId
			WHERE NOT EXISTS(SELECT * FROM ZnodePublishSeoEntity C WHERE B.PreviewVersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId AND A.PortalId = C.PortalId)

		END

		If @IsCatalogPublish= 1
		BEGIN
			UPDATE C SET C.ElasticSearchEvent = 2 
			FROM ZnodePublishSeoEntity C
			WHERE NOT EXISTS(SELECT * FROM #TBL_SEO A
				Inner join #VesionIds B on A.LocaleId = B.LocaleId AND B.RevisionType = 'PREVIEW'
				WHERE B.VersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId 
							AND A.PortalId = C.PortalId AND A.SEOCode = C.SEOCode)

			UPDATE C SET C.ItemName = A.ItemName ,
				C.SEOTypeName = A.ItemName, C.SEOTitle = A.SEOTitle,C.SEODescription = A.SEODescription,C.SEOKeywords=A.SEOKeywords,C.SEOUrl = A.SEOUrl,
				C.IsRedirect=A.IsRedirect,C.MetaInformation = A.MetaInformation,C.OldSEOURL = A.OldSEOURL,
				C.CanonicalURL = A.CanonicalURL,C.RobotTag = A.RobotTag, C.ElasticSearchEvent = 1
			FROM #TBL_SEO A 
			Inner join #VesionIds B on A.LocaleId = B.LocaleId AND B.RevisionType = 'PREVIEW' 
			INNER JOIN ZnodePublishSeoEntity C ON B.VersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId 
						AND A.PortalId = C.PortalId AND A.SEOCode = C.SEOCode

			Insert Into ZnodePublishSeoEntity 
			(
				VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
				SEOTypeName,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL
				,CMSContentPagesId,	PortalId,SEOCode,CanonicalURL,RobotTag, ElasticSearchEvent	
			)
			SELECT B.VersionId , Getdate(), ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
				ItemName,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,A.LocaleId,OldSEOURL,Isnull(CMSContentPagesId,0),
				A.PortalId,SEOCode,CanonicalURL,RobotTag, 1 AS ElasticSearchEvent
			FROM #TBL_SEO A Inner join #VesionIds B on A.LocaleId = B.LocaleId AND B.RevisionType = 'PREVIEW'
			WHERE NOT EXISTS(SELECT * FROM ZnodePublishSeoEntity C WHERE B.VersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId AND A.PortalId = C.PortalId)

		END
	End

	-------------------------- End Preview 
	If (@RevisionState like '%Production%' OR @RevisionState = 'None') and @IsSingleProductPublish = 0
	Begin
		-- Only production version id will process 
		Delete from ZnodePublishSeoEntity where PortalId = @PortalId  and VersionId in (Select ProductionVersionId from  @TBL_ProductionVersionId ) 
		AND (SEOCode = @CMSSEOCode OR @CMSSEOCode = '' )
		AND (Exists  (SELECT TOP 1 1 FROM dbo.Split(@CMSSEOTypeId ,',') SP WHERE SP.Item = CMSSEOTypeId ) )
		AND @IsCatalogPublish= 0   

		If @IsCatalogPublish= 0 		
		BEGIN
			UPDATE C SET C.ElasticSearchEvent = 2 
			FROM ZnodePublishSeoEntity C
			WHERE NOT EXISTS(SELECT * FROM #TBL_SEO A
				INNER JOIN @TBL_ProductionVersionId B on A.PortalId = B.PortalId and A.LocaleId = B.LocaleId 
				WHERE B.ProductionVersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId 
							AND A.PortalId = C.PortalId AND A.SEOCode = C.SEOCode)

			UPDATE C SET ItemName = A.ItemName ,
				SEOTypeName = A.ItemName,SEOTitle = A.SEOTitle,SEODescription = A.SEODescription,SEOKeywords=A.SEOKeywords,SEOUrl = A.SEOUrl,
				IsRedirect=A.IsRedirect,MetaInformation = A.MetaInformation,OldSEOURL = A.OldSEOURL,
				CanonicalURL = A.CanonicalURL,RobotTag = A.RobotTag, C.ElasticSearchEvent = 1
			FROM #TBL_SEO A 
			INNER JOIN @TBL_ProductionVersionId B on A.PortalId = B.PortalId and A.LocaleId = B.LocaleId 
			INNER JOIN ZnodePublishSeoEntity C ON B.ProductionVersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId 
						AND A.PortalId = C.PortalId AND A.SEOCode = C.SEOCode

			Insert Into ZnodePublishSeoEntity 
			(
				VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
				SEOTypeName,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL
				,CMSContentPagesId,	PortalId,SEOCode,CanonicalURL,RobotTag, ElasticSearchEvent
			)
			SELECT B.ProductionVersionId , Getdate(), ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
				ItemName,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,A.LocaleId,OldSEOURL,Isnull(CMSContentPagesId,0),
				A.PortalId,SEOCode,CanonicalURL,RobotTag, 1 AS ElasticSearchEvent
			FROM #TBL_SEO A Inner join @TBL_ProductionVersionId B on A.PortalId = B.PortalId and A.LocaleId = B.LocaleId
			WHERE NOT EXISTS(SELECT * FROM ZnodePublishSeoEntity C WHERE B.ProductionVersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId AND A.PortalId = C.PortalId)
		END
	   If @IsCatalogPublish= 1 		
	   BEGIN
			UPDATE C SET C.ElasticSearchEvent = 2 FROM ZnodePublishSeoEntity C
			WHERE NOT EXISTS(SELECT * FROM #TBL_SEO A
				INNER JOIN @TBL_ProductionVersionId B on A.PortalId = B.PortalId and A.LocaleId = B.LocaleId 
				WHERE B.ProductionVersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId 
							AND A.PortalId = C.PortalId AND A.SEOCode = C.SEOCode)

			UPDATE C SET C.ItemName = A.ItemName ,
				C.SEOTypeName = A.SEOTypeName,C.SEOTitle = A.SEOTitle,C.SEODescription = A.SEODescription,C.SEOKeywords=A.SEOKeywords,C.SEOUrl = A.SEOUrl,
				C.IsRedirect = A.IsRedirect,C.MetaInformation = A.MetaInformation, C.OldSEOURL = A.OldSEOURL,
				C.CanonicalURL = A.CanonicalURL, C.RobotTag = A.RobotTag, C.ElasticSearchEvent = 1
			FROM #TBL_SEO A 
			INNER JOIN #VesionIds B on A.LocaleId = B.LocaleId AND B.RevisionType = 'PRODUCTION'
			INNER JOIN ZnodePublishSeoEntity C ON B.VersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId 
						AND A.PortalId = C.PortalId AND A.SEOCode = C.SEOCode

			Insert Into ZnodePublishSeoEntity 
			(
				VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
				SEOTypeName,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL
				,CMSContentPagesId,	PortalId,SEOCode,CanonicalURL,RobotTag	,ElasticSearchEvent
			)
			SELECT B.VersionId , Getdate(), ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
				ItemName,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,A.LocaleId,OldSEOURL,Isnull(CMSContentPagesId,0),
				A.PortalId,SEOCode,CanonicalURL,RobotTag, 1 AS ElasticSearchEvent
			FROM #TBL_SEO A Inner join #VesionIds B on A.LocaleId = B.LocaleId AND B.RevisionType = 'PRODUCTION'
			WHERE NOT EXISTS(SELECT * FROM ZnodePublishSeoEntity C WHERE B.VersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId AND A.PortalId = C.PortalId)
		END
	
	End

	--Single Product Publish 
	If @IsSingleProductPublish =1  
	Begin
			Delete from ZnodePublishSeoEntity where PortalId = @PortalId  and VersionId in (Select Item from Split(@VersionIdString,',')) 
			AND (SEOCode = @CMSSEOCode OR @CMSSEOCode = '' )
			AND (Exists  (SELECT TOP 1 1 FROM dbo.Split(@CMSSEOTypeId ,',') SP WHERE SP.Item = CMSSEOTypeId ) )

			UPDATE C SET ItemName = A.ItemName ,
				SEOTypeName = A.SEOTypeName,SEOTitle = A.SEOTitle,SEODescription = A.SEODescription,SEOKeywords=A.SEOKeywords,SEOUrl = A.SEOUrl,
				IsRedirect=A.IsRedirect,MetaInformation = A.MetaInformation,OldSEOURL = A.OldSEOURL,
				CanonicalURL = A.CanonicalURL,RobotTag = A.RobotTag
			FROM #TBL_SEO A 
			INNER JOIN ZnodePublishSeoEntity C ON A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId 
						AND A.PortalId = C.PortalId AND A.SEOCode = C.SEOCode
		
			Insert Into ZnodePublishSeoEntity 
			(
				VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
				SEOTypeName,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL
				,CMSContentPagesId,	PortalId,SEOCode,CanonicalURL,RobotTag	
			)
			SELECT (Select Item from Split(@VersionIdString,',')), Getdate(), ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
				ItemName,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,@LocaleId,OldSEOURL,Isnull(CMSContentPagesId,0),
				A.PortalId,SEOCode,CanonicalURL,RobotTag
			FROM #TBL_SEO A 
			WHERE NOT EXISTS(SELECT * FROM ZnodePublishSeoEntity C WHERE A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId AND A.PortalId = C.PortalId)
		
	end 

	If (@RevisionState = 'Preview'  )
		Update B SET PublishStateId = (select dbo.Fn_GetPublishStateIdForPreview()) , ISPublish = 1 
		from #TBL_SEO  A inner join ZnodeCMSSEODetail B  ON A.CMSSEODetailId  = B.CMSSEODetailId
	else If (@RevisionState = 'Production'  Or @RevisionState = 'None' )
		Update B SET PublishStateId = (select dbo.Fn_GetPublishStateIdForPublish()) , ISPublish = 1 
		from #TBL_SEO  A inner join ZnodeCMSSEODetail B  ON A.CMSSEODetailId  = B.CMSSEODetailId

	SET @Status =1 
END TRY 
BEGIN CATCH 
	SET @Status =0  
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
	@ErrorCall NVARCHAR(MAX)= 'EXEC ZnodeSetPublishSEOEntity 
	@PortalId = '+CAST(@PortalId AS VARCHAR	(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))
	+',@PreviewVersionId = ' + CAST(@PreviewVersionId  AS varchar(20))
	+',@ProductionVersionId = ' + CAST(@ProductionVersionId  AS varchar(20))
	+',@RevisionState = ''' + CAST(@RevisionState  AS varchar(50))
	+''',@CMSSEOTypeId= ' + CAST(@CMSSEOTypeId  AS varchar(20))
	+',@UserId = ' + CAST(@UserId AS varchar(20))
	+',@CMSSEOCode  = ''' + CAST(@CMSSEOCode  AS varchar(20)) + '''';
	        			 
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'ZnodeSetPublishSEOEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;

END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishAssociatedAddonsJson')
	DROP PROC Znode_GetPublishAssociatedAddonsJson
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishAssociatedAddonsJson]
(
	@PublishCatalogId NVARCHAR(MAX) = 0,
	@PimProductId    TransferId Readonly,
	@VersionId        INT           = 0,
	@UserId           INT,														 
	@PimCategoryHierarchyId int = 0, 
	@LocaleId       TransferId READONLY,
	@PublishStateId INT = 0, 
	@VersionIdString  VARCHAR(2000)= '',
	@Status		   Bit  OutPut,
	@RevisionType Varchar(50)
)
AS 
   
/*
    Summary : If PimcatalogId is provided get all products with Addons and provide above mentioned data
       If PimProductId is provided get all Addons if associated with given product id and provide above mentioned data
    			Input: @PublishCatalogId or @PimProductId
    		    output should be in XML format
       sample xml5
    Begin transaction  
	 declare  @PimProductId TransferId 
	 Declare @Status bit 
	 INSERT INTO @PimProductId  values (768)

			Exec [_Znode_GetPublishAssociatedAddonsJson]
				@PublishCatalogId = 5 ,
				--@PimProductId   = @PimProductId,
				@UserId =2,														 
				@VersionIdString = '',--'1662,1664,1663,1665',
				@Status	 =@Status Out,
				@RevisionType= 'Production'
				rollback transaction
				--SELECT * from ZnodePublishVersionEntity 
   
	*/

BEGIN
    BEGIN TRY
    SET NOCOUNT ON 
		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
        DECLARE @LocaleIdIn INT, @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId()
		, @Counter INT= 1
		, @MaxRowId INT= 0;

	UPDATE ZnodePublishAddonEntity SET ElasticSearchEvent = 0
    -- DECLARE @PimAddOnGroupId VARCHAR(MAX);

		CREATE TABLE #TBL_PublisshIds  (PublishProductId INT , PimProductId INT , PublishCatalogId INT)
		DECLARE @TBL_LocaleId TABLE (RowId    INT IDENTITY(1, 1),LocaleId INT);
		IF OBJECT_ID('tempdb..#VesionIds') is not null
		DROP TABLE #VesionIds
		Create Table #VesionIds(ZnodeCatalogId int , VersionId int , LocaleId int , RevisionType varchar(50) )

  		If @VersionIdString <> ''
		BEGIN
			Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)	
			SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType
			FROM ZnodePublishVersionEntity PV Inner join Split(@VersionIdString,',') S ON PV.VersionId = S.Item
		END
		Else 
		Begin
			If  (@RevisionType like '%Preview%'  OR @RevisionType like '%Production%')
			BEGIN
				Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)	
				SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV  where PV.IsPublishSuccess =1 
				AND PV.RevisionType ='Preview'
			END
			If  (@RevisionType like '%Production%' OR @RevisionType = 'None')
			BEGIN
				Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)	
				SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV  where PV.IsPublishSuccess =1 
				AND PV.RevisionType ='Production'
			END					
		End 

		IF (@PublishCatalogId IS NULL OR @PublishCatalogId = 0)
		BEGIN 
			INSERT INTO #TBL_PublisshIds 
			EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId,@userid,@PimProductId,1
		END 
		IF ISnull(@PimCategoryHierarchyId,0) <> 0 
		BEGIN 
			INSERT INTO #TBL_PublisshIds 
			EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId,@userid,@PimProductId,1,@PimCategoryHierarchyId 
		END 

		CREATE TABLE #TBL_PublishCatalogId (PublishCatalogId INT,PublishProductId INT,PimProductId  INT , VersionId INT ,LocaleId INT  );

		IF  ISnull(@PimCategoryHierarchyId,0) <> 0 
		BEGIN 
			INSERT INTO #TBL_PublishCatalogId 
			SELECT ZPP.PublishCatalogId , ZPP.PublishProductId,PimProductId, MAX(ZPCP.PublishCatalogLogId)  ,LocaleId 
			FROM ZnodePublishProduct ZPP 
			INNER JOIN ZnodePublishCatalogLog ZPCP ON (ZPCP.PublishCatalogId  = ZPP.PublishCatalogId)
			WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId   ) 
			AND ZPCP.Publishstateid = @PublishStateId
			GROUP BY ZPP.PublishCatalogId,ZPP.PublishProductId,PimProductId,LocaleId 
		END 
		ELSE 
		Begin
			INSERT INTO #TBL_PublishCatalogId  
			SELECT ZPP.PublishCatalogId , ZPP.PublishProductId,PimProductId,0  VersionId  ,0 LocaleId 
			FROM ZnodePublishProduct ZPP  
			WHERE EXISTS  (SELECT TOP 1 1 FROM #VesionIds ZPCP WHERE (ZPCP.ZnodeCatalogId  = ZPP.PublishCatalogId)) AND
			(EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId  
			AND  @PublishCatalogId = '0' )  OR (ZPP.PublishCatalogId =  @PublishCatalogId ))
		END
        DECLARE @TBL_AddonGroupLocale TABLE( PimAddonGroupId INT, DisplayType NVARCHAR(400),AddonGroupName NVARCHAR(MAX),LocaleId INT );
        INSERT INTO @TBL_LocaleId(LocaleId)
        SELECT LocaleId FROM ZnodeLocale MT  WHERE IsActive = 1 AND (EXISTS (SELECT TOP 1 1  FROM @LocaleId RT WHERE RT.Id = MT.LocaleId )
			OR NOT EXISTS (SELECT TOP 1 1 FROM @LocaleId ));
        SET @MaxRowId = ISNULL(( SELECT MAX(RowId) FROM @TBL_LocaleId ), 0);
    
        WHILE (@Counter <= @MaxRowId)
        BEGIN
            SET @LocaleIdIn =( SELECT LocaleId FROM @TBL_LocaleId WHERE RowId = @Counter );
            INSERT INTO @TBL_AddonGroupLocale (PimAddonGroupId, DisplayType, AddonGroupName)
            EXEC Znode_GetAddOnGroupLocale '', @LocaleIdIn;
	   		UPDATE @TBL_AddonGroupLocale SET LocaleId = @LocaleIdIn WHERE LocaleId IS NULL 
            SET @Counter = @Counter + 1;
        END;
		
		IF OBJECT_ID('tempdb..#AddonProductPublishedXML') is not null
		drop table #AddonProductPublishedXML
						
		SELECT  ZPPP.PublishProductId,ZPPP.PublishCatalogId,V.LocaleId,v.VersionId,
		ZPPP.[PublishProductId]  ZnodeProductId,
		ZPPP.[PublishCatalogId] ZnodeCatalogId,
		ZPP.PublishProductId  AssociatedZnodeProductId,
		ZPAOP.DisplayOrder DisplayOrder,
		ZPOPD.DisplayOrder AssociatedProductDisplayOrder,
		RequiredType ,
		DisplayType, 
		ISNULL((select ''+AddonGroupName for xml path('')),'') GroupName,
		ISnull(IsDefault,0) IsDefault
		INTO #AddonProductPublishedXML
		FROM [ZnodePimAddOnProductDetail] AS ZPOPD
		INNER JOIN [ZnodePimAddOnProduct] AS ZPAOP ON ZPOPD.[PimAddOnProductId] = ZPAOP.[PimAddOnProductId]
		INNER JOIN #TBL_PublishCatalogId ZPPP ON (ZPPP.PimProductId = ZPAOP.PimProductId )
		INNER JOIN #TBL_PublishCatalogId ZPP ON(ZPP.PimProductId = ZPOPD.[PimChildProductId] AND ZPP.PublishCatalogId = ZPPP.PublishCatalogId  )
		INNER JOIN #VesionIds V ON ZPPP.PublishCatalogId  = V.ZnodeCataLogId
		INNER JOIN @TBL_AddonGroupLocale TBAG ON (TBAG.PimAddonGroupId   = ZPAOP.PimAddonGroupId AND TBAG.LocaleId = V.LocaleId )
	
		If (isnull(@PublishCatalogId ,'') = '' and @VersionIdString = '') OR 
			(isnull(@PublishCatalogId ,'') = 0 and @VersionIdString = '')
		Begin 
			UPDATE ZnodePublishAddonEntity 
			SET ElasticSearchEvent = 2
			WHERE PublishAddonEntityId  IN (
											SELECT PublishAddonEntityId
											FROM ZnodePublishAddonEntity BP
											INNER JOIN #AddonProductPublishedXML A ON BP.ZnodeProductId =A.PublishProductId
												AND BP.ZnodeCatalogId = A.PublishCatalogId AND BP.VersionId = A.VersionId
											) 
			AND EXISTS(SELECT * FROM #VesionIds V WHERE V.VersionId = ZnodePublishAddonEntity.VersionId) 

			----Delete addon entries having parent data removed
			UPDATE ZPAE 
			SET ElasticSearchEvent = 2
			FROM ZnodePublishAddonEntity ZPAE
			WHERE NOT EXISTS (SELECT * from [ZnodePimAddOnProduct] ZPAOP 
					INNER JOIN ZnodePublishProduct ZPPP ON (ZPPP.PimProductId = ZPAOP.PimProductId )
					WHERE ZPAE.ZnodeProductId = ZPPP.PublishProductId AND ZPAE.ZnodeCatalogId = ZPPP.PublishCatalogId)
			AND EXISTS(SELECT * FROM #VesionIds V WHERE V.VersionId = ZPAE.VersionId)
		End 

		----Delete addon entries having parent data present but all addon removed
		SELECT zppp1.PublishCatalogId,ZPPP1.PublishProductId,ZPPP.PublishProductId as AssociatedZnodeProductId  
		INTO #TempAddonProduct
		FROM [ZnodePimAddOnProductDetail] AS ZPOPD
		INNER JOIN [ZnodePimAddOnProduct] AS ZPAOP ON ZPOPD.[PimAddOnProductId] = ZPAOP.[PimAddOnProductId]
		INNER JOIN ZnodePublishProduct ZPPP1 ON (ZPPP1.PimProductId = ZPAOP.PimProductId )
		INNER JOIN ZnodePublishProduct ZPPP ON (ZPPP.PimProductId = ZPOPD.PimChildProductId )

		UPDATE ZPAE 
		SET ElasticSearchEvent = 2
		FROM ZnodePublishAddonEntity ZPAE
		WHERE not EXISTS (SELECT * from #TempAddonProduct ZPPP
				WHERE ZPAE.ZnodeProductId = ZPPP.PublishProductId AND ZPAE.ZnodeCatalogId = ZPPP.PublishCatalogId)
		AND EXISTS(SELECT * FROM #VesionIds V WHERE V.VersionId = ZPAE.VersionId)

		UPDATE ZPAE 
		SET ElasticSearchEvent = 2
		FROM ZnodePublishAddonEntity ZPAE
		WHERE EXISTS (SELECT * from #TempAddonProduct ZPPP
				WHERE ZPAE.ZnodeProductId = ZPPP.PublishProductId AND ZPAE.ZnodeCatalogId = ZPPP.PublishCatalogId)
		AND not EXISTS (SELECT * from #TempAddonProduct ZPPP1
				WHERE ZPAE.AssociatedZnodeProductId = ZPPP1.AssociatedZnodeProductId AND ZPAE.ZnodeProductId = ZPPP1.PublishProductId  AND ZPAE.ZnodeCatalogId = ZPPP1.PublishCatalogId)
		AND EXISTS(SELECT * FROM #VesionIds V WHERE V.VersionId = ZPAE.VersionId)
				
		UPDATE PCE SET PCE.AssociatedProductDisplayOrder = Isnull(CE.AssociatedProductDisplayOrder,0),
			PCE.GroupName = CE.GroupName,PCE.DisplayType = CE.DisplayType,
			PCE.DisplayOrder = CE.DisplayOrder,
			PCE.IsRequired = 1 ,PCE.RequiredType = CE.RequiredType,PCE.IsDefault = CE.IsDefault,
			PCE.ElasticSearchEvent = 2
		FROM #AddonProductPublishedXML CE
		INNER JOIN ZnodePublishAddonEntity PCE ON CE.VersionId = PCE.VersionId
		AND PCE.LocaleId = CE.LocaleId AND PCE.ZnodeCatalogId = CE.PublishCatalogId AND CE.ZnodeProductId = PCE.ZnodeProductId
		AND PCE.AssociatedZnodeProductId = CE.AssociatedZnodeProductId AND PCE.ElasticSearchEvent <> 2
		AND EXISTS(SELECT * FROM #VesionIds V WHERE V.VersionId = PCE.VersionId)

		Insert into  ZnodePublishAddonEntity
		(VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,
			LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault,ElasticSearchEvent)
		Select 
			VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,Isnull(AssociatedProductDisplayOrder,0),
			LocaleId,GroupName,DisplayType,DisplayOrder,1 IsRequired,RequiredType,IsDefault, 1 AS ElasticSearchEvent
		from #AddonProductPublishedXML CE
		WHERE NOT EXISTS(SELECT * FROM ZnodePublishAddonEntity PCE WHERE CE.VersionId = PCE.VersionId
		AND PCE.LocaleId = CE.LocaleId AND PCE.ZnodeCatalogId = CE.PublishCatalogId AND CE.ZnodeProductId = PCE.ZnodeProductId
		AND PCE.AssociatedZnodeProductId = CE.AssociatedZnodeProductId AND PCE.ElasticSearchEvent <> 2)
		
		SET @Status = 1;
            
    END TRY
    BEGIN CATCH
		SELECT ERROR_MESSAGE(),ERROR_PROCEDURE()
            
        SET @Status = 0;
        DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishAssociatedAddonsJson @PublishCatalogId = '+@PublishCatalogId+',@VersionId='+CAST(@VersionId AS VARCHAR(50))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
        SELECT 0 AS ID,
            CAST(0 AS BIT) AS Status;
        EXEC Znode_InsertProcedureErrorLog
            @ProcedureName = 'Znode_GetPublishAssociatedAddonsJson',
            @ErrorInProcedure = @Error_procedure,
            @ErrorMessage = @ErrorMessage,
            @ErrorLine = @ErrorLine,
            @ErrorCall = @ErrorCall;
    END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishAssociatedProductsJson')
	DROP PROC Znode_GetPublishAssociatedProductsJson
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishAssociatedProductsJson]    
(       
     @PublishCatalogId VARCHAR(MAX) = '',    
     @PimProductId     TransferId Readonly,    
     @ProductType      VARCHAR(300) = 'BundleProduct',    
     @VersionId        INT          = 0,    
     @UserId           INT,    
     @PimCategoryHierarchyId int = 0,    
     @PublishStateId INT = 0  ,    
     @VersionIdString  VARCHAR(2000)= '',    
     @Status  BIT  Output,    
     @RevisionType Varchar(50) = ''    
)    
AS    
  /*    
    Summary : If PimcatalogId is provided then get all  Bundles / Group / Configurable product and  provide above mentioned data    
              If PimProductId is provided then get all Bundles / Group / Configurable if associated with given product id and provide above mentioned data    
       Input: @PublishCatalogId or @PimProductId    
       Output should be in XML format    
             Required o/p    
       <BundleProductEntity>    
       <ZnodeProductId></ZnodeProductId>    
       <ZnodeCatalogId></ZnodeCatalogId>    
       <AsscociadedZnodeProductIds></AsscociadedZnodeProductIds>    
       </BundleProductEntity>    
    Unit Testing     
    BundleProduct    
 DECLARE     
    EXEC [dbo].[Znode_GetPublishAssociatedProducts] @PublishCatalogId = 1  , @ProductType = 'BundleProduct' ,@userId = 2     
    EXEC [dbo].[Znode_GetPublishAssociatedProducts] @PublishCatalogId =2 , @ProductType = 'ConfigurableProduct',@userId = 2 ,@PimCategoryHierarchyId = 7     
    Group Product    
    EXEC [dbo].[Znode_GetPublishAssociatedProducts]  @PublishCatalogId ='2',@PimProductIdh =''  , @PimProducttType = 'GroupedProduct'    
    EXEC [dbo].[Znode_GetPublishAssociatedProducts]  @PublishCatalogId ='',@PimProductId ='200066'  , @PimProducttType = 'GroupedProduct'    
    EXEC [dbo].[Znode_GetPublishAssociatedProducts] @PimProductId ='200066'  , @PimProducttType = 'GroupedProduct'    
   */    
BEGIN    
BEGIN TRAN GetPublishAssociatedProducts;    
BEGIN TRY    
SET NOCOUNT ON;    
      
    IF OBJECT_ID('tempdb..#VesionIds') is not null    
    DROP TABLE #VesionIds    
    Create Table #VesionIds(ZnodeCatalogId int , VersionId int , LocaleId int , RevisionType varchar(50) )    
    
      If @VersionIdString <> ''       
    Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)     
    SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV Inner join Split(@VersionIdString,',') S ON PV.VersionId = S.Item    
    Else     
    Begin    
     If  (@RevisionType like '%Preview%'  OR @RevisionType like '%Production%' )    
      Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)     
      SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV  where PV.IsPublishSuccess =1     
      AND PV.RevisionType ='Preview'    
    
     If  (@RevisionType like '%Production%' OR @RevisionType = 'None')    
      Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)     
      SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV  where PV.IsPublishSuccess =1     
      AND PV.RevisionType ='Production'    
     end     
    
   IF OBJECT_ID('tempdb..#TBL_PublishCatalogId') is not null    
    DROP TABLE #TBL_PublishCatalogId    
       
   CREATE TABLE #TBL_PublishCatalogId (PublishCatalogId INT,PublishProductId INT,PimProductId  INT , VersionId INT,LocaleId INT  );    
   DECLARE  @PimAttributeId INT = [dbo].[Fn_GetProductTypeAttributeId]()    
     ,@PimAttributeDefaultValueId INT = (SELECT TOP 1 PimAttributeDefaultValueId FROM ZnodePimAttributeDefaultValue WHERE AttributeDefaultValueCode = @ProductType)    
     ,@DefaultLocaleId INT = dbo.fn_getDefaultlocaleId()     
   DECLARE @GetDate DATETIME =dbo.Fn_GetDate()    
        
   IF OBJECT_ID('tempdb..#TBL_PublisshIds') is not null    
   DROP TABLE #TBL_PublisshIds    
   Create TABLE #TBL_PublisshIds (PublishProductId INT , PimProductId INT , PublishCatalogId INT)    
    
   DECLARE  @PimProductId_New TransferId    
          
    IF  @PublishCatalogId IS NULL  OR @PublishCatalogId = 0     
    BEGIN     
    INSERT INTO #TBL_PublisshIds     
    Select ZPP.PublishProductId ,ZPP.PimProductId , ZPP.PublishCatalogId from ZnodePublishProduct ZPP Inner join @PimProductId  PPI on ZPP.PimProductId = PPI.ID    
      --EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId,@userid,@PimProductId,1    
          
      INSERT INTO @PimProductId_New    
      SELECT DISTINCT PimProductId FROM #TBL_PublisshIds    
    
     -- SELECT  @PimProductId     
    END     
        
    IF  ISnull(@PimCategoryHierarchyId,0) <> 0     
    BEGIN     
        
      INSERT INTO #TBL_PublisshIds     
      EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId,@userid,@PimProductId,1,@PimCategoryHierarchyId    
          
      --SET @PimProductId = SUBSTRING((SELECT DISTINCT ','+CAST(PimProductId AS VARCHAr(50)) FROM #TBL_PublisshIds FOR XML PATH ('')),2,8000 )    
    
      INSERT INTO @PimProductId_New    
      SELECT PimProductId FROM #TBL_PublisshIds    
    
          
    END     
    
    IF  ISnull(@PimCategoryHierarchyId,0) <> 0     
    BEGIN     
     INSERT INTO #TBL_PublishCatalogId     
     SELECT ZPP.PublishCatalogId , ZPP.PublishProductId,ZPP.PimProductId,MAX(ZPCP.PublishCatalogLogId) ,ZPCP.LocaleID      
     FROM ZnodePublishProduct ZPP     
     INNER JOIN ZnodePimAttributeValue ZPV ON (ZPV.PimProductId = ZPP.PimProductId )    
     INNER JOIN ZnodePimProductAttributeDefaultValue ZPAVL ON (ZPAVL.PimAttributeValueId = ZPV.PimAttributeValueId)    
     LEFT JOIN  ZnodePublishCatalogLog ZPCP ON (ZPCP.PublishCatalogId  = ZPP.PublishCatalogId)    
     WHERE (EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId   )     
     AND  (ZPP.PublishCatalogId =  @PublishCatalogId ))    
     AND ZPV.PimAttributeId  = @PimAttributeId    
     AND ZPAVL.PimAttributeDefaultValueId= @PimAttributeDefaultValueId    
     AND ZPAVL.LocaleId = @DefaultLocaleId    
     AND ISNULL(ZPCP.LocaleId,0) <> 0     
     AND ZPCP.PublishStateId= @PublishStateId    
     AND EXISTS(SELECT * FROM ZnodeLocale ZL where ZL.IsActive = 1  and ZPCP.LocaleId = ZL.LocaleId )    
     GROUP BY ZPP.PublishCatalogId , ZPP.PublishProductId,ZPP.PimProductId,ZPCP.LocaleID     
         
    END    
    ELSE     
    BEGIN     
        
    IF NOT EXISTS (SELECT TOP 1 1 FROM @PimProductId ) AND @PublishCatalogId <> 0    
    BEGIN    
      INSERT INTO #TBL_PublishCatalogId     
      SELECT distinct ZPP.PublishCatalogId , ZPP.PublishProductId,ZPP.PimProductId,  ZPCP.VersionId PublishCatalogLogId ,ZPCP.LocaleID     
      FROM ZnodePublishProduct ZPP     
      INNER JOIN ZnodePimAttributeValue ZPV ON (ZPV.PimProductId = ZPP.PimProductId )    
      INNER JOIN ZnodePimProductAttributeDefaultValue ZPAVL ON (ZPAVL.PimAttributeValueId = ZPV.PimAttributeValueId)    
      INNER JOIN  #VesionIds  ZPCP ON (ZPCP.ZnodeCatalogId  = ZPP.PublishCatalogId AND ISNULL(ZPCP.LocaleId,0) <> 0 )            
      WHERE     
      --(EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId  AND  @PublishCatalogId = '' )     
      --OR     
      (ZPP.PublishCatalogId =  @PublishCatalogId )    
      AND ZPV.PimAttributeId  = @PimAttributeId    
      AND ZPAVL.PimAttributeDefaultValueId= @PimAttributeDefaultValueId    
      AND ZPAVL.LocaleId = @DefaultLocaleId    
      AND EXISTS(SELECT * FROM ZnodeLocale ZL where ZL.IsActive = 1  and ZPCP.LocaleId = ZL.LocaleId )    
    END    
    ELSE    
    BEGIN    
      INSERT INTO #TBL_PublishCatalogId     
          
      SELECT distinct ZPP.PublishCatalogId , ZPP.PublishProductId,ZPP.PimProductId,  ZPCP.VersionId PublishCatalogLogId ,ZPCP.LocaleID     
      FROM ZnodePublishProduct ZPP     
      INNER JOIN ZnodePimAttributeValue ZPV ON (ZPV.PimProductId = ZPP.PimProductId )    
      INNER JOIN ZnodePimProductAttributeDefaultValue ZPAVL ON (ZPAVL.PimAttributeValueId = ZPV.PimAttributeValueId)    
      LEFT JOIN  #VesionIds ZPCP ON (ZPCP.ZnodeCatalogId  = ZPP.PublishCatalogId AND ISNULL(ZPCP.LocaleId,0) <> 0 )            
      WHERE (EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId  AND ZPP.PublishCatalogId = SP.PublishCatalogId) )    
      AND ZPV.PimAttributeId  = @PimAttributeId    
      AND ZPAVL.PimAttributeDefaultValueId= @PimAttributeDefaultValueId    
      AND ZPAVL.LocaleId = @DefaultLocaleId    
      AND EXISTS(SELECT * FROM ZnodeLocale ZL where ZL.IsActive = 1  and ZPCP.LocaleId = ZL.LocaleId )    
      --GROUP BY ZPP.PublishCatalogId , ZPP.PublishProductId,ZPP.PimProductId,ZPCP.LocaleID,    
    
    END     
         
    END    
        
             DECLARE @TBL_ProductTypeXML TABLE    
             (PublishProductId INT,    
			  PublishCatalogId INT,    
              ReturnXML        XML,    
              VersionId        INT    
             );    
             DECLARE @TBL_PimProductId TABLE    
             ([PimProductId]   INT,    
              PublishCatalogId INT,    
			  PublishProductId INT    
             );    
                
             DECLARE @TBL_PimAssociatedEntity TABLE    
             (    
				ZnodeProductId INT,    
				ZnodeCatalogId INT,    
				AsscociadedZnodeProductIds VARCHAR(MAX),    
				ConfigurableProductEntity NVARCHAR(MAX),    
				LocaleId INT,    
				DisplayOrder INT,    
				VersionId INT    
             );    
    
    If @ProductType = 'BundleProduct' AND Exists (Select TOP 1 1 from #TBL_PublishCatalogId)    
    Begin    
               IF OBJECT_ID('tempdb..#BundleProductPublishedXML') is not null    
					drop table #BundleProductPublishedXML    
    
		 IF (isnull(@PublishCatalogId ,'') = '' or isnull(@PublishCatalogId,0) = 0) and @VersionIdString = ''    
		 Begin     
			  UPDATE ZnodePublishBundleProductEntity SET ElasticSearchEvent = 2 
			  where not exists(select * from ZnodePublishProduct where ZnodePublishBundleProductEntity.ZnodeProductId = ZnodePublishProduct.PublishProductId)    
			  AND EXISTS(SELECT * FROM #VesionIds V WHERE V.VersionId = ZnodePublishBundleProductEntity.VersionId)

			  UPDATE ZnodePublishBundleProductEntity SET ElasticSearchEvent = 2 
			  where Exists ( Select TOP 1 1 from     
			  #TBL_PublishCatalogId A where ZnodePublishBundleProductEntity.ZnodeCatalogId =A.PublishCatalogId AND     
			  ZnodePublishBundleProductEntity.ZnodeProductId  = A.PublishProductId )    
			  AND Exists (SELECT TOP 1 1 FRoM #VesionIds     
			  Where ZnodePublishBundleProductEntity.VersionId =  #VesionIds.VersionId)    
		END     
    
		 UPDATE ZPBP SET AssociatedProductDisplayOrder = ISNULL(ZPTA.DisplayOrder,0),AssociatedProductBundleQuantity = ISNULL(ZPTA.BundleQuantity,1)
		 FROM #TBL_PublishCatalogId TBP    
		 INNER JOIN ZnodePimProductTypeAssociation ZPTA ON(ZPTA.PimParentProductId = TBP.PimProductId)    
		 INNER JOIN ZnodePublishProduct TBPU ON (TBPU.PimProductId = ZPTA.PimProductId AND TBPU.PublishCatalogId = TBP.PublishCatalogId )
		 INNER JOIN ZnodePublishBundleProductEntity ZPBP on  TBP.VersionId = ZPBP.VersionId AND TBP.PublishProductId = ZPBP.ZnodeProductId
			AND TBP.PublishCatalogId = ZPBP.ZnodeCatalogId AND TBPU.PublishProductId = ZPBP.AssociatedZnodeProductId
		 WHERE ZPBP.ElasticSearchEvent <> 2 
		 AND EXISTS(SELECT * FROM #VesionIds V WHERE V.VersionId = ZPBP.VersionId)


		 INSERT INTO ZnodePublishBundleProductEntity     
		 (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,AssociatedProductBundleQuantity)    
		 SELECT TBP.VersionId, TBP.PublishProductId, TBP.PublishCatalogId ,    
		 TBPU.PublishProductId AssociatedZnodeProductId,ISNULL(ZPTA.DisplayOrder,0)  AssociatedProductDisplayOrder,ISNULL(ZPTA.BundleQuantity,1)  AS AssociatedProductBundleQuantity  
		 FROM #TBL_PublishCatalogId TBP    
		 INNER JOIN ZnodePimProductTypeAssociation ZPTA ON(ZPTA.PimParentProductId = TBP.PimProductId)    
		 INNER JOIN ZnodePublishProduct TBPU ON (TBPU.PimProductId = ZPTA.PimProductId AND TBPU.PublishCatalogId = TBP.PublishCatalogId )
		 WHERE NOT EXISTS(SELECT * FROM ZnodePublishBundleProductEntity ZPBP WHERE  TBP.VersionId = ZPBP.VersionId AND TBP.PublishProductId = ZPBP.ZnodeProductId
			AND TBP.PublishCatalogId = ZPBP.ZnodeCatalogId AND TBPU.PublishProductId = ZPBP.AssociatedZnodeProductId AND ZPBP.ElasticSearchEvent <> 2 )
		
   End     
   
   If @ProductType = 'GroupedProduct' AND Exists (Select TOP 1 1 from #TBL_PublishCatalogId)    
   Begin    
		 IF (isnull(@PublishCatalogId ,'') = '' or isnull(@PublishCatalogId,0) = 0) and @VersionIdString = ''    
		 Begin     
			  UPDATE ZnodePublishGroupProductEntity SET ElasticSearchEvent = 2     
			  WHERE NOT EXISTS(SELECT * FROM ZnodePublishProduct WHERE ZnodePublishGroupProductEntity.ZnodeProductId = ZnodePublishProduct.PublishProductId)    
              AND EXISTS(SELECT * FROM #VesionIds V WHERE V.VersionId = ZnodePublishGroupProductEntity.VersionId)

			  UPDATE ZnodePublishGroupProductEntity SET ElasticSearchEvent = 2  
			  where Exists ( Select TOP 1 1 from     
				  #TBL_PublishCatalogId A where ZnodePublishGroupProductEntity.ZnodeCatalogId =A.PublishCatalogId AND     
				  ZnodePublishGroupProductEntity.ZnodeProductId  = A.PublishProductId )    
				  AND Exists (SELECT TOP 1 1 FRoM #VesionIds     
			   Where ZnodePublishGroupProductEntity.VersionId =  #VesionIds.VersionId)    
		 end     
    
	  UPDATE ZPGP SET AssociatedProductDisplayOrder = ISNULL(ZPTA.DisplayOrder,0),ElasticSearchEvent = 1
	  FROM #TBL_PublishCatalogId TBP    
      INNER JOIN ZnodePimProductTypeAssociation ZPTA ON(ZPTA.PimParentProductId = TBP.PimProductId)    
      INNER JOIN ZnodePublishProduct TBPU ON (TBPU.PimProductId = ZPTA.PimProductId AND TBPU.PublishCatalogId = TBP.PublishCatalogId )    
	  INNER JOIN ZnodePublishGroupProductEntity ZPGP ON ZPGP.VersionId = TBP.VersionId AND ZPGP.ZnodeProductId = TBP.PublishProductId 
		AND ZPGP.ZnodeCatalogId = TBP.PublishCatalogId AND ZPGP.AssociatedZnodeProductId = TBPU.PublishProductId AND ZPGP.ElasticSearchEvent <> 2  
	  AND EXISTS(SELECT * FROM #VesionIds V WHERE V.VersionId = ZPGP.VersionId)

      INSERT INTO ZnodePublishGroupProductEntity(VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder)    
      SELECT TBP.VersionId, TBP.PublishProductId ,TBP.PublishCatalogId ,TBPU.PublishProductId ,ISNULL(ZPTA.DisplayOrder,0)    
      FROM #TBL_PublishCatalogId TBP    
      INNER JOIN ZnodePimProductTypeAssociation ZPTA ON(ZPTA.PimParentProductId = TBP.PimProductId)    
      INNER JOIN ZnodePublishProduct TBPU ON (TBPU.PimProductId = ZPTA.PimProductId AND TBPU.PublishCatalogId = TBP.PublishCatalogId )    
	  WHERE NOT EXISTS(SELECT * FROM ZnodePublishGroupProductEntity ZPGP WHERE ZPGP.VersionId = TBP.VersionId AND ZPGP.ZnodeProductId = TBP.PublishProductId 
		AND ZPGP.ZnodeCatalogId = TBP.PublishCatalogId AND ZPGP.AssociatedZnodeProductId = TBPU.PublishProductId AND ZPGP.ElasticSearchEvent <> 2  )
   End     
            
			
   If @ProductType = 'ConfigurableProduct' AND Exists (Select TOP 1 1 from #TBL_PublishCatalogId)    
   Begin    
		 If (isnull(@PublishCatalogId ,'') = '' or isnull(@PublishCatalogId,0) = 0) and @VersionIdString = ''    
		 Begin    
			  UPDATE ZnodePublishConfigurableProductEntity SET ElasticSearchEvent = 2       
			  where not exists(select * from ZnodePublishProduct where ZnodePublishConfigurableProductEntity.ZnodeProductId = ZnodePublishProduct.PublishProductId)    
              AND EXISTS(SELECT * FROM #VesionIds V WHERE V.VersionId = ZnodePublishConfigurableProductEntity.VersionId)

			  UPDATE ZnodePublishConfigurableProductEntity SET ElasticSearchEvent = 2  
			  where Exists ( Select TOP 1 1 from     
			  #TBL_PublishCatalogId A where ZnodePublishConfigurableProductEntity.ZnodeCatalogId =A.PublishCatalogId AND     
			  ZnodePublishConfigurableProductEntity.ZnodeProductId  = A.PublishProductId )     
			  AND Exists (SELECT TOP 1 1 FRoM #VesionIds     
			   Where ZnodePublishConfigurableProductEntity.VersionId =  #VesionIds.VersionId)    
		 end     
    
		SELECT DISTINCT TBP.VersionId, TBP.PublishProductId ,    
			  TBP.PublishCatalogId ,    
			  Isnull(TBPU.PublishProductId,0) AssociatedZnodeProductId,     
			  ISNULL(ZPTA.DisplayOrder,0) DisplayOrder,'[]' SelectValues,          
			  '[' + Isnull(SUBSTRING((SELECT Distinct ','+ +'"'+CAST(ZPA.AttributeCode AS VARCHAR(50)) +'"'     
			  FROM ZnodePimConfigureProductAttribute ZPCPA     
			  LEFT JOIN ZnodePimAttribute ZPA ON Zpa.PimAttributeId = ZPCPA.PimAttributeId 
			  WHERE ZPTA.PimParentProductId = ZPCPA.PimProductId
			  FOR XML PATH ('') ),2,2000),Null) +']' as ConfigurableAttributeCodes    
			  , ZPTA.IsDefault  
		  INTO #TempConfigurableProductEntity 
		 FROM #TBL_PublishCatalogId TBP    
		 INNER JOIN ZnodePimProductTypeAssociation ZPTA ON(ZPTA.PimParentProductId = TBP.PimProductId)    
		 INNER JOIN ZnodePublishProduct TBPU ON (TBPU.PimProductId = ZPTA.PimProductId AND TBPU.PublishCatalogId = TBP.PublishCatalogId )    
    
		 UPDATE ZPCP SET ZPCP.AssociatedProductDisplayOrder = AssociatedProductDisplayOrder,
			ConfigurableAttributeCodes = TBP.ConfigurableAttributeCodes,IsDefault = TBP.IsDefault,ZPCP.ElasticSearchEvent =1
		 FROM #TempConfigurableProductEntity TBP    
		 INNER JOIN ZnodePublishConfigurableProductEntity ZPCP ON ZPCP.VersionId = TBP.VersionId 
			AND ZPCP.ZnodeProductId = TBP.PublishProductId AND ZPCP.ZnodeCatalogId = TBP.PublishCatalogId AND ZPCP.AssociatedZnodeProductId = TBP.AssociatedZnodeProductId
		 AND EXISTS(SELECT * FROM #VesionIds V WHERE V.VersionId = ZPCP.VersionId)

		  Insert into ZnodePublishConfigurableProductEntity 
		  (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,    
		  SelectValues,ConfigurableAttributeCodes, IsDefault,ElasticSearchEvent )    
		  SELECT DISTINCT TBP.VersionId, TBP.PublishProductId ,    
			  TBP.PublishCatalogId , TBP.AssociatedZnodeProductId,TBP.DisplayOrder ,TBP.SelectValues,          
			  TBP.ConfigurableAttributeCodes, TBP.IsDefault  ,1 as ElasticSearchEvent
		 FROM #TempConfigurableProductEntity TBP    
		 WHERE NOT EXISTS(SELECT * FROM ZnodePublishConfigurableProductEntity ZPCP WHERE ZPCP.VersionId = TBP.VersionId 
			AND ZPCP.ZnodeProductId = TBP.PublishProductId AND ZPCP.ZnodeCatalogId = TBP.PublishCatalogId AND ZPCP.AssociatedZnodeProductId = TBP.AssociatedZnodeProductId and isnull(ZPCP.ElasticSearchEvent,0) <> 2)
		 

		 Update ZPC SET ZPC.ElasticSearchEvent =2 from ZnodePublishConfigurableProductEntity  ZPC  Where Exists 
		 (Select TOP 1 1 From #TempConfigurableProductEntity X Where ZPC.ZnodeProductId = X.PublishProductId and ZPC.ZnodeCatalogId = X.PublishCatalogId)
		 AND NOT Exists 
		(Select TOP 1 1 From #TempConfigurableProductEntity XP Where ZPC.ZnodeProductId = XP.PublishProductId and ZPC.ZnodeCatalogId = XP.PublishCatalogId
		 and XP.AssociatedZnodeProductId = ZPC.AssociatedZnodeProductId)
		 AND EXISTS(SELECT * FROM #VesionIds V WHERE V.VersionId = ZPC.VersionId)


      IF OBJECT_ID('tempdb..#TBL_PublishCatalogId') is not null    
       drop table #TBL_PublishCatalogId    
    
      IF OBJECT_ID('tempdb..#ConfigurableProductPublishedXML') is not null    
       drop table #ConfigurableProductPublishedXML    
    
End     
COMMIT TRAN GetPublishAssociatedProducts;    
SET @Status = 1;    
END TRY    
	BEGIN CATCH    
	SELECT ERROR_MESSAGE()    
	SET @Status = 0;    
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishAssociatedProductsJson @PublishCatalogId = '+@PublishCatalogId+',@ProductType= '+@ProductType+',@VersionId='+CAST(@VersionId AS VARCHAR(50))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));    
                      
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                        
	ROLLBACK TRANSACTION GetPublishAssociatedProducts;    
	EXEC Znode_InsertProcedureErrorLog    
	@ProcedureName = 'Znode_GetPublishAssociatedProductsJson',    
	@ErrorInProcedure = @Error_procedure,    
	@ErrorMessage = @ErrorMessage,    
	@ErrorLine = @ErrorLine,    
	@ErrorCall = @ErrorCall;    
END CATCH;    
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishCategoryJson')
	DROP PROC Znode_GetPublishCategoryJson
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishCategoryJson]
(   
	@PublishCatalogId INT,
	@UserId           INT,
	@Status           BIT = 0 OUT,
	@IsDebug          BIT = 0,
	@VersionIdString  VARCHAR(2000)= '',
	@LocaleId         TransferID READONLY,
	@RevisionState    VARCHAR(50) = ''
)
AS 
/*
Summary:Publish category with their respective products and details 
The result is fetched in xml form   
Unit Testing   
Begin transaction 
SELECT * FROM ZnodePIMAttribute 
SELECT * FROM ZnodePublishCatalog 
SELECT * FROM ZnodePublishCategory WHERE publishCAtegoryID = 167 


EXEC [Znode_GetPublishCategory] @PublishCatalogId = 3,@VersionId = 0 ,@UserId =2 ,@IsDebug = 1 
     


Rollback Transaction 
*/
BEGIN
BEGIN TRAN GetPublishCategory;
BEGIN TRY
SET NOCOUNT ON;
	DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
	DECLARE @LocaleIdIn INT= 0, @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId(), @Counter INT= 1, @MaxId INT= 0, @CategoryIdCount INT;
	DECLARE @IsActive BIT= [dbo].[Fn_GetIsActiveTrue]();
	DECLARE @AttributeIds VARCHAR(MAX)= '', @PimCategoryIds VARCHAR(MAX)= '', @DeletedPublishCategoryIds VARCHAR(MAX)= '', @DeletedPublishProductIds VARCHAR(MAX);
	--get the pim catalog id 
	DECLARE @PimCatalogId INT=(SELECT PimCatalogId FROM ZnodePublishcatalog WHERE PublishCatalogId = @PublishCatalogId); 

	DECLARE @TBL_AttributeIds TABLE
	(
		PimAttributeId       INT,
		ParentPimAttributeId INT,
		AttributeTypeId      INT,
		AttributeCode        VARCHAR(600),
		IsRequired           BIT,
		IsLocalizable        BIT,
		IsFilterable         BIT,
		IsSystemDefined      BIT,
		IsConfigurable       BIT,
		IsPersonalizable     BIT,
		DisplayOrder         INT,
		HelpDescription      VARCHAR(MAX),
		IsCategory           BIT,
		IsHidden             BIT,
		CreatedDate          DATETIME,
		ModifiedDate         DATETIME,
		AttributeName        NVARCHAR(MAX),
		AttributeTypeName    VARCHAR(300)
	);
	DECLARE @TBL_AttributeDefault TABLE
	(
		PimAttributeId            INT,
		AttributeDefaultValueCode VARCHAR(100),
		IsEditable                BIT,
		AttributeDefaultValue     NVARCHAR(MAX)
		,DisplayOrder   INT
	);
	DECLARE @TBL_AttributeValue TABLE
	(
		PimCategoryAttributeValueId INT,
		PimCategoryId               INT,
		CategoryValue               NVARCHAR(MAX),
		AttributeCode               VARCHAR(300),
		PimAttributeId              INT
	);
	DECLARE @TBL_LocaleIds TABLE
	(
		RowId     INT IDENTITY(1, 1),
		LocaleId  INT,
		IsDefault BIT
	);
	DECLARE @TBL_PimCategoryIds TABLE
	(
		PimCategoryId       INT,
		PimParentCategoryId INT,
		DisplayOrder        INT,
		ActivationDate      DATETIME,
		ExpirationDate      DATETIME,
		CategoryName        NVARCHAR(MAX),
		ProfileId           VARCHAR(MAX),
		IsActive            BIT,
		PimCategoryHierarchyId INT,
		ParentPimCategoryHierarchyId INT ,
		CategoryCode  NVARCHAR(MAX)             
	);


	DECLARE @TBL_PublishPimCategoryIds TABLE
	(
		PublishCategoryId       INT,
		PimCategoryId           INT,
		PublishProductId        varchar(max),
		PublishParentCategoryId INT ,
		PimCategoryHierarchyId INT ,parentPimCategoryHierarchyId INT,
		RowIndex INT
	);
	DECLARE @TBL_DeletedPublishCategoryIds TABLE
	(
		PublishCategoryId INT,
		PublishProductId  INT
	);
	DECLARE @TBL_CategoryXml TABLE
	(
		PublishCategoryId INT,
		CategoryXml       XML,
		LocaleId          INT
	);
	INSERT INTO @TBL_LocaleIds
	(
		LocaleId,
		IsDefault
	)
	-- here collect all locale ids
	SELECT LocaleId,IsDefault FROM ZnodeLocale MT WHERE IsActive = @IsActive
	AND (EXISTS (SELECT TOP 1 1  FROM @LocaleId RT WHERE RT.Id = MT.LocaleId )
	OR NOT EXISTS (SELECT TOP 1 1 FROM @LocaleId ));

	IF OBJECT_ID('tempdb..#VesionIds') is not null
		DROP TABLE #VesionIds
  				 
	SELECT PV.* INTO #VesionIds FROM ZnodePublishVersionEntity PV Inner join Split(@VersionIdString,',') S ON PV.VersionId = S.Item
		

	if object_id('tempdb..#CategoryData')is not null
		DROP TABLE #CategoryData

	------------for CategoryCode update
	SELECT ZPCAL.CategoryValue as CategoryCode,MAX(ZPC.PublishCategoryId) as PublishCategoryId ,ZPCA.PimCategoryId, ZPoC.PortalId
	INTO #CategoryData
	FROM ZnodePimCategoryAttributeValue ZPCA
	INNER JOIN ZnodePimCategoryAttributeValueLocale ZPCAL on ZPCA.PimCategoryAttributeValueId = ZPCAL.PimCategoryAttributeValueId
	INNER JOIN ZnodePimAttribute ZPA ON ZPCA.PimAttributeId = ZPA.PimAttributeId
	INNER JOIN ZnodePublishCategory ZPC on ZPCA.PimCategoryId = ZPC.PimCategoryId
	INNER JOIN ZnodePortalCatalog ZPoC on ZPC.PublishCatalogId = ZPoC.PublishCatalogId
	WHERE ZPA.AttributeCode = 'CategoryCode' AND ZPC.PublishCatalogId = @PublishCatalogId
	AND EXISTS(SELECT * FROM ZnodeCMSWidgetCategory ZCWC WHERE ZPC.PublishCategoryId = ZCWC.PublishCategoryId )
	GROUP BY ZPCAL.CategoryValue, ZPCA.PimCategoryId, ZPoC.PortalId

	UPDATE ZCWC SET ZCWC.CategoryCode = CD.CategoryCode
	FROM ZnodeCMSWidgetCategory ZCWC
	INNER JOIN #CategoryData CD ON ZCWC.PublishCategoryId = CD.PublishCategoryId and ZCWC.CMSMappingId = CD.PortalId
	WHERE ZCWC.TypeOFMapping = 'PortalMapping'
	----------

	INSERT INTO @TBL_PimCategoryIds(PimCategoryId,PimParentCategoryId,DisplayOrder,ActivationDate,ExpirationDate,IsActive,PimCategoryHierarchyId,ParentPimCategoryHierarchyId)
	SELECT DISTINCT ZPCH.PimCategoryId,ZPCH2.PimCategoryId  PimParentCategoryId,ZPCH.DisplayOrder,ZPCH.ActivationDate,ZPCH.ExpirationDate,ZPCH.IsActive ,ZPCH.PimCategoryHierarchyId,ZPCH.ParentPimCategoryHierarchyId
	FROM ZnodePimCategoryHierarchy AS ZPCH 
	LEFT JOIN ZnodePimCategoryHierarchy AS ZPCH2 ON (ZPCH2.PimCategoryHierarchyId = ZPCH. ParentPimCategoryHierarchyId ) 
	WHERE ZPCH.PimCatalogId = @PimCatalogId; 
	
	-- here is find the deleted publish category id on basis of publish catalog
	INSERT INTO @TBL_DeletedPublishCategoryIds(PublishCategoryId,PublishProductId)
	SELECT ZPC.PublishCategoryId,ZPCP.PublishProductId 
	FROM ZnodePublishCategoryProduct ZPCP
	INNER JOIN ZnodePublishCategory AS ZPC ON(ZPCP.PublishCategoryId = ZPC.PublishCategoryId AND ZPCP.PublishCatalogId = ZPC.PublishCatalogId)                                                  
	INNER JOIN ZnodePublishProduct ZPP ON(zpp.PublishProductId = zpcp.PublishProductId AND zpp.PublishCatalogId = zpcp.PublishCatalogId)
	INNER JOIN ZnodePublishCatalog ZPCC ON(ZPCC.PublishCatalogId = ZPCP.PublishCatalogId)
	WHERE ZPC.PublishCatalogId = @PublishCataLogId 
	AND NOT EXISTS(SELECT TOP 1 1 FROM ZnodePimCategoryHierarchy AS TBPC WHERE TBPC.PimCategoryId = ZPC.PimCategoryId AND TBPC.PimCategoryHierarchyId = ZPC.PimCategoryHierarchyId
	AND TBPC.PimCatalogId = ZPCC.PimCatalogId);

	-- here is find the deleted publish category id on basis of publish catalog
	SET @DeletedPublishCategoryIds = ISNULL(SUBSTRING((SELECT ','+CAST(PublishCategoryId AS VARCHAR(50)) FROM @TBL_DeletedPublishCategoryIds AS ZPC
				GROUP BY ZPC.PublishCategoryId FOR XML PATH('') ), 2, 4000), '');
	-- here is find the deleted publish category id on basis of publish catalog
	SET @DeletedPublishProductIds = '';
	
	EXEC Znode_DeletePublishCatalog @PublishCatalogIds = @PublishCatalogId,@PublishCategoryIds = @DeletedPublishCategoryIds,@PublishProductIds = @DeletedPublishProductIds; 
		
	MERGE INTO ZnodePublishCategory TARGET USING  @TBL_PimCategoryIds SOURCE ON
	(
		TARGET.PimCategoryId = SOURCE.PimCategoryId 
		AND TARGET.PublishCatalogId = @PublishCataLogId 
		AND TARGET.PimCategoryHierarchyId = SOURCE.PimCategoryHierarchyId
	)
	WHEN MATCHED THEN UPDATE SET TARGET.PimParentCategoryId = SOURCE.PimParentCategoryId,TARGET.CreatedBy = @UserId,TARGET.CreatedDate = @GetDate,
	TARGET.ModifiedBy = @UserId,TARGET.ModifiedDate = @GetDate,PimCategoryHierarchyId = SOURCE.PimCategoryHierarchyId,ParentPimCategoryHierarchyId=SOURCE.ParentPimCategoryHierarchyId
	WHEN NOT MATCHED THEN INSERT(PimCategoryId,PublishCatalogId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PimCategoryHierarchyId,ParentPimCategoryHierarchyId) 
	VALUES(SOURCE.PimCategoryId,@PublishCatalogId,@UserId,@GetDate,@UserId,@GetDate,SOURCE.PimCategoryHierarchyId,SOURCE.ParentPimCategoryHierarchyId)
	OUTPUT INSERTED.PublishCategoryId,INSERTED.PimCategoryId,INSERTED.PimCategoryHierarchyId,INSERTED.parentPimCategoryHierarchyId INTO @TBL_PublishPimCategoryIds(PublishCategoryId,PimCategoryId,PimCategoryHierarchyId,parentPimCategoryHierarchyId);
     
	-- here update the publish parent category id
	UPDATE ZPC SET [PimParentCategoryId] =TBPC.[PimCategoryId] 
	FROM ZnodePublishCategory ZPC
	INNER JOIN ZnodePublishCategory TBPC ON(ZPC.parentPimCategoryHierarchyId = TBPC.PimCategoryHierarchyId  ) 
	WHERE ZPC.PublishCatalogId =@PublishCatalogId
	AND ZPC.ParentPimCategoryHierarchyId IS NOT NULL
	AND TBPC.PublishCatalogId =@PublishCatalogId;

	UPDATE a
	SET  a.PublishParentCategoryId = b.PublishCategoryId
	FROM ZnodePublishCategory a 
	INNER JOIN ZnodePublishCategory b   ON (a.parentpimCategoryHierarchyId = b.pimCategoryHierarchyId)
	WHERE a.parentpimCategoryHierarchyId IS NOT NULL 
	AND a.PublishCatalogId =@PublishCatalogId
	AND b.PublishCatalogId =@PublishCatalogId

	UPDATE a set a.PublishParentCategoryId = NULL
	FROM ZnodePublishCategory a 
	WHERE a.parentpimCategoryHierarchyId IS NULL AND PimParentCategoryId IS NULL
	AND a.PublishCatalogId = @PublishCatalogId AND a.PublishParentCategoryId IS NOT NULL

	SET @MaxId =(SELECT MAX(RowId)FROM @TBL_LocaleIds);
	DECLARE @TransferID TRANSFERID 
	INSERT INTO @TransferID 
	SELECT DISTINCT  PimCategoryId
	FROM @TBL_PublishPimCategoryIds 

	SET @PimCategoryIds = SUBSTRING((SELECT ','+CAST(PimCategoryId AS VARCHAR(50)) FROM @TBL_PublishPimCategoryIds FOR XML PATH('')), 2, 4000);
		
	WHILE @Counter <= @MaxId -- Loop on Locale id 
	BEGIN
		SET @LocaleIdIn =(SELECT LocaleId FROM @TBL_LocaleIds WHERE RowId = @Counter);
                   
		SET @AttributeIds = SUBSTRING((SELECT ','+CAST(ZPCAV.PimAttributeId AS VARCHAR(50)) FROM ZnodePimCategoryAttributeValue ZPCAV 
				WHERE EXISTS(SELECT TOP 1 1 FROM @TBL_PimCategoryIds TBPC WHERE TBPC.PimCategoryId = ZPCAV.PimCategoryId) GROUP BY ZPCAV.PimAttributeId FOR XML PATH('')), 2, 4000);
                
		SET @CategoryIdCount =(SELECT COUNT(1) FROM @TBL_PimCategoryIds);

		INSERT INTO @TBL_AttributeIds (PimAttributeId,ParentPimAttributeId,AttributeTypeId,AttributeCode,IsRequired,IsLocalizable,IsFilterable,IsSystemDefined,
		IsConfigurable,IsPersonalizable,DisplayOrder,HelpDescription,IsCategory,IsHidden,CreatedDate,ModifiedDate,AttributeName,AttributeTypeName)
		EXEC [Znode_GetPimAttributesDetails] @AttributeIds,@LocaleIdIn;

		INSERT INTO @TBL_AttributeDefault (PimAttributeId,AttributeDefaultValueCode,IsEditable,AttributeDefaultValue,DisplayOrder)
		EXEC [dbo].[Znode_GetAttributeDefaultValueLocale] @AttributeIds,@LocaleIdIn;

		INSERT INTO @TBL_AttributeValue (PimCategoryAttributeValueId,PimCategoryId,CategoryValue,AttributeCode,PimAttributeId)
		EXEC [dbo].[Znode_GetCategoryAttributeValueId] @TransferID,@AttributeIds,@LocaleIdIn;


		;WITH Cte_UpdateDefaultAttributeValue AS 
		(
			SELECT TBAV.PimCategoryId,TBAV.PimAttributeId,SUBSTRING((SELECT ','+AttributeDefaultValue FROM @TBL_AttributeDefault TBD WHERE TBAV.PimAttributeId = TBD.PimAttributeId
			AND EXISTS(SELECT TOP 1 1 FROM Split(TBAV.CategoryValue, ',') SP WHERE SP.Item = TBD.AttributeDefaultValueCode)FOR XML PATH('')), 2, 4000) DefaultCategoryAttributeValue
			FROM @TBL_AttributeValue TBAV WHERE EXISTS(SELECT TOP 1 1 FROM @TBL_AttributeDefault TBAD WHERE TBAD.PimAttributeId = TBAV.PimAttributeId)
		)	 
		-- update the default value with locale 
		UPDATE TBAV SET CategoryValue = CTUDFAV.DefaultCategoryAttributeValue FROM @TBL_AttributeValue TBAV 
		INNER JOIN Cte_UpdateDefaultAttributeValue CTUDFAV ON(CTUDFAV.PimCategoryId = TBAV.PimCategoryId AND CTUDFAV.PimAttributeId = TBAV.PimAttributeId)
		WHERE CategoryValue IS NULL ;
					 
		-- here is update the media path  
		;WITH Cte_productMedia AS 
		(
			SELECT TBA.PimCategoryId,TBA.PimAttributeId,
			Isnull(
			(STUFF((SELECT ','+zm.PATH FROM ZnodeMedia ZM WHERE EXISTS
			(SELECT TOP 1 1 FROM dbo.split(TBA.CategoryValue, ',') SP
			WHERE SP.Item = CAST(Zm.MediaId AS VARCHAR(50)))FOR XML PATH(''),Type).value('.', 'varchar(max)'), 1, 1,'')) ,'no-image.png')
			CategoryValue
			FROM @TBL_AttributeValue TBA WHERE EXISTS(SELECT TOP 1 1 FROM [dbo].[Fn_GetProductMediaAttributeId]() FNMA WHERE FNMA.PImAttributeId = TBA.PimATtributeId)
		)
		UPDATE TBAV SET CategoryValue = CTCM.CategoryValue 
		FROM @TBL_AttributeValue TBAV 
		INNER JOIN Cte_productMedia CTCM ON(CTCM.PimCategoryId = TBAV.PimCategoryId
		AND CTCM.PimAttributeId = TBAV.PimAttributeId);
					 					
		;WITH Cte_PublishProductIds AS 
		(
			SELECT TBPC.PublishcategoryId,SUBSTRING((SELECT ','+CAST(PublishProductId AS VARCHAR(50))
			FROM ZnodePublishCategoryProduct ZPCP 
			WHERE ZPCP.PublishCategoryId = TBPC.publishCategoryId
			AND ZPCP.PimCategoryHierarchyId = TBPC.PimCategoryHierarchyId
			AND ZPCP.PublishCatalogId = @PublishCatalogId FOR XML PATH('')), 2, 8000) PublishProductId ,PimCategoryHierarchyId
			FROM @TBL_PublishPimCategoryIds TBPC
		)
		UPDATE TBPPC SET PublishProductId = CTPP.PublishProductId FROM @TBL_PublishPimCategoryIds TBPPC INNER JOIN Cte_PublishProductIds CTPP ON(TBPPC.PublishCategoryId = CTPP.PublishCategoryId 
		AND TBPPC.PimCategoryHierarchyId = CTPP.PimCategoryHierarchyId);

		;WITH Cte_CategoryProfile AS 
		(
			SELECT PimCategoryId,ZPCC.PimCategoryHierarchyId,
			SUBSTRING(( SELECT ','+CAST(ProfileId AS VARCHAR(50)) 
			FROM ZnodeProfile ZPC 
			INNER JOIN ZnodePimCategoryHierarchy ZPRCC ON(ZPRCC.PimCategoryHierarchyId = ZPCC.PimCategoryHierarchyId
			AND ZPRCC.PimCatalogId = ZPC.PimCatalogId) 
			WHERE ZPC.PimCatalogId = ZPCC.PimCatalogId FOR XML PATH('')), 2, 4000) ProfileIds
			FROM ZnodePimCategoryHierarchy ZPCC 
			WHERE EXISTS(SELECT TOP 1 1 FROM @TBL_PimCategoryIds TBPC 
			WHERE TBPC.PimCategoryId = ZPCC.PimCategoryId AND ZPCC.PimCatalogId = @PimCatalogId 
			AND ZPCC.PimCategoryHierarchyId = TBPC.PimCategoryHierarchyId)
		)                          
		UPDATE TBPC SET TBPC.ProfileId = CTCP.ProfileIds FROM @TBL_PimCategoryIds TBPC 
		LEFT JOIN Cte_CategoryProfile CTCP ON(CTCP.PimCategoryId = TBPC.PimCategoryId AND CTCP.PimCategoryHierarchyId = TBPC.PimCategoryHierarchyId );
                         
				     
		UPDATE TBPC SET TBPC.CategoryName = TBAV.CategoryValue FROM @TBL_PimCategoryIds TBPC INNER JOIN @TBL_AttributeValue TBAV ON(TBAV.PimCategoryId = TBPC.PimCategoryId
		AND EXISTS(SELECT TOP 1 1 FROM [dbo].[Fn_GetCategoryNameAttribute]() FNGCNA WHERE FNGCNA.PimAttributeId = TBAV.PimAttributeId));


		UPDATE TBPC SET TBPC.CategoryCode = TBAV.CategoryValue FROM @TBL_PimCategoryIds TBPC INNER JOIN @TBL_AttributeValue TBAV ON(TBAV.PimCategoryId = TBPC.PimCategoryId
		AND EXISTS(SELECT TOP 1 1 FROM dbo.Fn_GetCategoryCodeAttribute() FNGCNA WHERE FNGCNA.PimAttributeId = TBAV.PimAttributeId))

		-- here update the publish category details 
		;WITH Cte_UpdateCategoryDetails AS 
		(
			SELECT TBC.PimCategoryId,PublishCategoryId,CategoryName, TBPPC.PimCategoryHierarchyId,CategoryCode
			FROM @TBL_PimCategoryIds TBC
			INNER JOIN @TBL_PublishPimCategoryIds TBPPC ON(TBC.PimCategoryId = TBPPC.PimCategoryId AND TBC.PimCategoryHierarchyId = TBPPC.PimCategoryHierarchyId)
		)						
		MERGE INTO ZnodePublishCategoryDetail TARGET USING Cte_UpdateCategoryDetails SOURCE ON(TARGET.PublishCategoryId = SOURCE.PublishCategoryId
		AND TARGET.LocaleId = @LocaleIdIn)
		WHEN MATCHED THEN UPDATE SET PublishCategoryId = SOURCE.PublishcategoryId,PublishCategoryName = SOURCE.CategoryName,LocaleId = @LocaleIdIn,ModifiedBy = @userId,ModifiedDate = @GetDate,CategoryCode=SOURCE.CategoryCode
		WHEN NOT MATCHED THEN INSERT(PublishCategoryId,PublishCategoryName,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CategoryCode) VALUES
		(SOURCE.PublishCategoryId,SOURCE.CategoryName,@LocaleIdIn,@userId,@GetDate,@userId,@GetDate,SOURCE.CategoryCode);

		IF OBJECT_ID('tempdb..#Index') is not null
		BEGIN 
			DROP TABLE #Index
		END 

		CREATE TABLE #Index (RowIndex int ,PimCategoryId int , PimCategoryHierarchyId  int,ParentPimCategoryHierarchyId int )		
		INSERT INTO  #Index ( RowIndex ,PimCategoryId , PimCategoryHierarchyId,ParentPimCategoryHierarchyId)
		SELECT CAST(Row_number() OVER (Partition By TBL.PimCategoryId Order by ISNULL(TBL.PimCategoryId,0) desc) AS VARCHAR(100))
		,ZPC.PimCategoryId, ZPC.PimCategoryHierarchyId, ZPC.ParentPimCategoryHierarchyId
		FROM @TBL_PublishPimCategoryIds TBL
		INNER JOIN ZnodePublishCategory ZPC ON (TBL.PimCategoryId = ZPC.PimCategoryId AND TBL.PimCategoryHierarchyId = ZPC.PimCategoryHierarchyId)
		WHERE ZPC.PublishCatalogId = @PublishCatalogId

		UPDATE TBP SET  TBP.[RowIndex]=  IDX.RowIndex 
		FROM @TBL_PublishPimCategoryIds TBP INNER JOIN #Index IDX ON (IDX.PimCategoryId = TBP.PimCategoryId AND IDX.PimCategoryHierarchyId = TBP.PimCategoryHierarchyId)  
					
		IF OBJECT_ID('Tempdb..#CategoryEntity') IS NOT NULL
			DROP TABLE #CategoryEntity
						
					
		SELECT ISNULL(TYU.VersionId,'') VersionId,TBPC.PublishCategoryId ZnodeCategoryId,
		ISNULL(CategoryName, '') Name,ISNULL(CategoryCode,'') CategoryCode,
		ZPC.PublishCatalogId, ZPC.CatalogName ,
		Isnull('[' + THR.PublishParentCategoryId + ']',NULL) TempZnodeParentCategoryIds,
		ISNULL('[' + TBPC.PublishProductId + ']', NULL)  TempProductIds,
		@LocaleIdIn LocaleId,TBC.IsActive,ISNULL(DisplayOrder, '0') DisplayOrder,
		ISNULL(
		(
			SELECT TBA.AttributeCode,TBA.AttributeName,ISNULL(IsUseInSearch, 0) IsUseInSearch,
			ISNULL(IsHtmlTags, 0) IsHtmlTags,ISNULL(IsComparable, 0) IsComparable,
			TBAV.CategoryValue AttributeValues,TBA.AttributeTypeName 
			FROM @TBL_AttributeValue TBAV
			INNER JOIN @TBL_AttributeIds TBA ON(TBAV.PimAttributeId = TBA.PimAttributeId) 
			LEFT JOIN ZnodePimFrontendProperties ZPFP ON(ZPFP.PimAttributeId = TBA.PimAttributeId)
			WHERE TBC.PimCategoryId = TBAV.PimCategoryId  
			FOR JSON PATH) 
		, '[]')  as Attributes,
		ActivationDate,ExpirationDate,ISNULL(TBPC.RowIndex,1) CategoryIndex
		--,ProfileId TempProfileIds
		INTO #CategoryEntity
		FROM @TBL_PublishPimCategoryIds TBPC 
		INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId= @PublishCatalogId)
		LEFT JOIN #VesionIds TYU ON (TYU.ZnodeCatalogId = @PublishCatalogId AND TYU.LocaleId = @LocaleIdIn)
		INNER JOIN ZnodePublishCAtegory THR ON (THR.PimCategoryHierarchyId = TBPC.PimCategoryHierarchyId AND THR.PimCategoryId = TBPC.PimCategoryId AND THR.PublishCatalogId= @PublishCatalogId )
		INNER JOIN @TBL_PimCategoryIds TBC ON(TBC.PimCategoryId = TBPC.PimCategoryId AND TBC.PimCategoryHierarchyId = TBPC.PimCategoryHierarchyId) 
					
		UPDATE PCE SET PCE.ElasticSearchEvent = 2 FROM ZnodePublishCategoryEntity PCE
		WHERE NOT EXISTS(SELECT * FROM #CategoryEntity CE WHERE CE.VersionId = PCE.VersionId AND PCE.ZnodeCategoryId = CE.ZnodeCategoryId
		AND PCE.LocaleId = CE.LocaleId AND PCE.ZnodeCatalogId = CE.PublishCatalogId )
		AND PCE.LocaleId = @LocaleIdIn
		AND PCE.ZnodeCatalogId = @PublishCatalogId
		AND EXISTS(SELECT * FROM #VesionIds V WHERE PCE.VersionId = V.VersionId)

		UPDATE PCE SET PCE.Name = CE.Name, PCE.ZnodeParentCategoryIds = CE.TempZnodeParentCategoryIds, PCE.ProductIds = CE.TempProductIds,
			PCE.IsActive = CE.IsActive,PCE.DisplayOrder = CE.DisplayOrder,PCE.Attributes = CE.Attributes,
			PCE.ActivationDate = CE.ActivationDate,PCE.ExpirationDate = CE.ExpirationDate,PCE.CategoryIndex = CE.CategoryIndex, PCE.ElasticSearchEvent = 1
		FROM ZnodePublishCategoryEntity PCE
		INNER JOIN #CategoryEntity CE ON CE.VersionId = PCE.VersionId AND PCE.ZnodeCategoryId = CE.ZnodeCategoryId
		AND PCE.LocaleId = CE.LocaleId AND PCE.ZnodeCatalogId = CE.PublishCatalogId
		AND PCE.LocaleId = @LocaleIdIn
		AND EXISTS(SELECT * FROM #VesionIds V WHERE PCE.VersionId = V.VersionId)

		INSERT INTO ZnodePublishCategoryEntity
		(
			VersionId,ZnodeCategoryId,
			Name,CategoryCode,
			ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds,
			ProductIds,LocaleId,IsActive,DisplayOrder,
			Attributes,
			ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent
		)
		SELECT VersionId,ZnodeCategoryId,
		Name,CategoryCode,
		PublishCatalogId,CatalogName,TempZnodeParentCategoryIds,
		TempProductIds,LocaleId,IsActive,DisplayOrder,
		Attributes,
		ActivationDate,ExpirationDate,CategoryIndex, 1 as ElasticSearchEvent
		FROM #CategoryEntity CE
		WHERE NOT EXISTS(SELECT * FROM ZnodePublishCategoryEntity PCE WHERE CE.VersionId = PCE.VersionId AND PCE.ZnodeCategoryId = CE.ZnodeCategoryId
		AND PCE.LocaleId = CE.LocaleId AND PCE.ZnodeCatalogId = CE.PublishCatalogId )
		AND CE.LocaleId = @LocaleIdIn
					
		DELETE FROM @TBL_AttributeIds;
		DELETE FROM @TBL_AttributeDefault;
		DELETE FROM @TBL_AttributeValue;
		SET @Counter = @Counter + 1;
	END;
	
	UPDATE ZnodePublishCatalogLog 
	SET PublishCategoryId = (SELECT COunt(DISTINCT PimCategoryId ) 
	FROM @TBL_PublishPimCategoryIds WHERE PublishCatalogId =@PublishCatalogId), 
	IsCategoryPublished = 1 
	WHERE PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()

	------------for CategoryPublishId update
	SELECT ZPCAL.CategoryValue as CategoryCode,MAX(ZPC.PublishCategoryId) as PublishCategoryId ,ZPCA.PimCategoryId,ZPoC.PortalId
	INTO #CategoryData1
	FROM ZnodePimCategoryAttributeValue ZPCA
	INNER JOIN ZnodePimCategoryAttributeValueLocale ZPCAL on ZPCA.PimCategoryAttributeValueId = ZPCAL.PimCategoryAttributeValueId
	INNER JOIN ZnodePimAttribute ZPA ON ZPCA.PimAttributeId = ZPA.PimAttributeId
	INNER JOIN ZnodePublishCategory ZPC on ZPCA.PimCategoryId = ZPC.PimCategoryId
	INNER JOIN ZnodePortalCatalog ZPoC on ZPC.PublishCatalogId = ZPoC.PublishCatalogId
	WHERE ZPA.AttributeCode = 'CategoryCode' AND ZPC.PublishCatalogId = @PublishCatalogId
	GROUP BY ZPCAL.CategoryValue, ZPCA.PimCategoryId, ZPoC.PortalId

	UPDATE ZCWC SET ZCWC.PublishCategoryId = CD.PublishCategoryId
	FROM ZnodeCMSWidgetCategory ZCWC
	INNER JOIN #CategoryData1 CD ON ZCWC.CategoryCode = CD.CategoryCode and ZCWC.CMSMappingId = CD.PortalId
	WHERE ZCWC.TypeOFMapping = 'PortalMapping'

	IF (@RevisionState = 'PREVIEW')
		UPDATE ZnodePimCategory SET PublishStateId = Dbo.Fn_GetPublishStateIdForPreview() WHERE pimCategoryId IN (SELECT PimCategoryId FROM @TBL_PublishPimCategoryIds)
	Else 
		UPDATE ZnodePimCategory SET PublishStateId = Dbo.Fn_GetPublishStateIdForPublish() WHERE pimCategoryId IN (SELECT PimCategoryId FROM @TBL_PublishPimCategoryIds)

COMMIT TRAN GetPublishCategory;
SET @Status =1 
END TRY
BEGIN CATCH
	SELECT ERROR_MESSAGE();
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishCategory @PublishCatalogId = '+CAST(@PublishCatalogId AS VARCHAR(50))+',@UserId ='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(50));
	SET @Status = 0;
	ROLLBACK TRAN GetPublishCategory;
	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_GetPublishCategoryJson',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishProductJson')
	DROP PROC Znode_GetPublishProductJson
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishProductJson]  
(  
	@PublishCatalogId INT = 0   
	,@PimProductId     TransferId Readonly  
	,@UserId     INT = 0   
	,@PimCatalogId     INT = 0   
	,@VersionIdString  VARCHAR(2000)= ''  
	,@Status     Bit  OutPut  
	,@RevisionState   Varchar(50) = ''  
	,@IsDraftProductsOnly BIT = 1  
)  
WITH RECOMPILE 
AS  
/*  
DECLARE @rrte transferId   
INSERT INTO @rrte  
SELECT 1  
  
EXEC [_POC_Znode_GetPublishProductbulk] @PublishCatalogId=9,@UserId= 2 ,@localeIDs = @rrte,@PublishStateId = 3   
  
*/  
BEGIN  
BEGIN Try   
	SET NOCOUNT ON;  
	SET @Status = 0    
	Declare  @RevisionType VARCHAR(50) = ''   
	Declare @VersionId int = 0   
	DECLARE @PortalId INT = (SELECT TOP 1 POrtalId FROM ZnodePortalCatalog WHERE PublishCatalogId = @PublishCatalogId)  
	DECLARE @PriceListId INT = (SELECT TOP 1 PriceListId FROM ZnodePriceListPortal WHERE PortalId = @PortalId )  
	DECLARE @DomainUrl varchar(max) = (SELECT TOp 1 URL FROM ZnodeMediaConfiguration WHERE IsActive =1)  
	DECLARE @MaxSmallWidth INT  = (SELECT TOP 1  MAX(MaxSmallWidth) FROM ZnodeGlobalMediaDisplaySetting)  
	DECLARE @PimMediaAttributeId INT = dbo.Fn_GetProductImageAttributeId()  
  
	DECLARE @TBL_LocaleId  TABLE (RowId INT IDENTITY(1,1) PRIMARY KEY  , LocaleId INT , VersionId int,RevisionType varchar(50)  )  
	DECLARE @LocaleIds transferId   

	INSERT INTO @TBL_LocaleId (LocaleId,VersionId,RevisionType)  
	SELECT PV.LocaleId , PV.VersionId , PV.RevisionType  
	FROM ZnodePublishVersionEntity PV INNER JOIN Split(@VersionIdString,',') S ON PV.VersionId = S.Item  

	 --Getting active local for catalog which are associated to store
	INSERT INTO @LocaleIds (Id) 
	SELECT LocaleId FROM DBO.FN_GetCatalogPortalActiveLocale(@PublishCatalogId)
   
	DECLARE --@ProductNamePimAttributeId INT = dbo.Fn_GetProductNameAttributeId(),  
	@DefaultLocaleId INT= Dbo.Fn_GetDefaultLocaleId(),@LocaleId INT = 0   
	--,@SkuPimAttributeId  INT =  dbo.Fn_GetProductSKUAttributeId() , @IsActivePimAttributeId INT =  dbo.Fn_GetProductIsActiveAttributeId()  
	DECLARE @GetDate DATETIME =dbo.Fn_GetDate()  
  
	DECLARE @DefaultPortal int, @IsAllowIndexing int  
	SELECT @DefaultPortal = ZPC.PortalId, @IsAllowIndexing = 1 FROM ZnodePimCatalog ZPC INNER JOIN ZnodePublishCatalog ZPC1 ON ZPC.PimCatalogId = ZPC1.PimCatalogId WHERE ZPC1.PublishCatalogId =  @PublishCatalogId AND isnull(ZPC.IsAllowIndexing,0) = 1   
     
	-----DELETE unwanted publish data  
	DELETE ZPC FROM ZnodePublishCategoryProduct ZPC  
	WHERE NOT EXISTS(SELECT * FROM ZnodePublishCategory ZC WHERE ZPC.PublishCategoryId = ZC.PublishCategoryId )  
  
	DELETE ZPP FROM ZnodePublishCategoryProduct ZPP  
	WHERE NOT EXISTS(SELECT * FROM ZnodePublishProduct ZP WHERE ZPP.PublishProductId = ZP.PublishProductId )  
  
	DELETE ZPP FROM ZnodePublishCatalogProductDetail ZPP  
	WHERE NOT EXISTS(SELECT * FROM ZnodePublishProduct ZP WHERE ZPP.PublishProductId = ZP.PublishProductId )  
  
	DELETE ZPCP FROM ZnodePublishCatalogProductDetail ZPCP  
	INNER JOIN ZnodePublishProduct b on ZPCP.PublishProductId = b.PublishProductId   
	WHERE NOT EXISTS(SELECT * FROM ZnodePimCategoryProduct a  
	INNER JOIN ZnodePimCategoryHierarchy ZPCH on ZPCH.PimCategoryID = a.PimCategoryId   
	WHERE b.PimProductId = A.PimProductId AND ZPCP.PimCategoryHierarchyId = ZPCH.PimCategoryHierarchyId)  
	AND isnull(ZPCP.PimCategoryHierarchyId,0) <> 0 AND b.PublishCatalogId = @PublishCatalogId  
	---------  
  
	DECLARE @Counter INT =1 ,@maxCountId INT = (SELECT max(RowId) FROM @TBL_LocaleId )   
  
	CREATE TABLE #ZnodePrice (RetailPrice numeric(28,13),SalesPrice numeric(28,13),CurrencyCode varchar(100), CultureCode varchar(100), CurrencySuffix varchar(100), PublishProductId int)  
   
	CREATE TABLE #ProductSKU (SEOUrl nvarchar(max), SEODescription  nvarchar(max),SEOKeywords  nvarchar(max),SEOTitle  nvarchar(max), PublishProductId int)  
  
	CREATE TABLE #ProductImages (PublishProductId int, ImageSmallPath  varchar(max))  
  
	EXEC Znode_InsertUpdateAttributeDefaultValueJson 1   
	EXEC Znode_InsertUpdateCustomeFieldJson 1   
	EXEC Znode_InsertUpdatePimAttributeJson 1   
  
	---To draft all catalog products AND associated products for full catalog publish  
	IF @IsDraftProductsOnly = 0  
	BEGIN  
		EXEC Znode_CatalogProductDraftForPublish @PublishCatalogId=@PublishCatalogId   
	END  

	UPDATE ZnodePublishProductEntity SET ElasticSearchEvent = 0

	EXEC [Znode_InsertUpdatePimCatalogProductDetailJson] @PublishCatalogId=@PublishCatalogId,@LocaleId=@LocaleIds ,@UserId=@UserId ,@IsDraftProductsOnly = @IsDraftProductsOnly 


	IF (@IsAllowIndexing=1)  
	BEGIN   
		INSERT INTO #ZnodePrice  
		SELECT RetailPrice,SalesPrice,ZC.CurrencyCode,ZCC.CultureCode ,ZCC.Symbol CurrencySuffix,TYU.PublishProductId  
		FROM ZnodePrice ZP   
		INNER JOIN ZnodePriceList ZPL ON (ZPL.PriceListId = ZP.PriceListId)  
		INNER JOIN ZnodeCurrency ZC oN (ZC.CurrencyId = ZPL.CurrencyId )  
		INNER JOIN ZnodeCulture ZCC ON (ZCC.CultureId = ZPL.CultureId)  
		INNER JOIN ZnodePublishProductDetail TY ON (TY.SKU = ZP.SKU )   
		INNER JOIN ZnodePublishProduct TYU ON (TYU.PublishProductId = TY.PublishProductId)   
		WHERE ZP.PriceListId = @PriceListId   
		AND TY.LocaleId = @DefaultLocaleId  
		AND TYU.PublishCatalogId = @PublishCatalogId  
		AND EXISTS (SELECT TOP 1 1 FROM ZnodePriceListPortal ZPLP   
		INNER JOIN ZnodePimCatalog ZPC on ZPC.PortalId=ZPLP.PortalId WHERE ZPLP.PriceListId=ZP.PriceListId )  
		AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 WHERE TYU.PimProductId = ZPP1.PimProductId )  
		--+ CAST(@DefaultPortal AS VARCHAr(100)) + '/'  
		INSERT INTO #ProductImages  
		SELECT  TYU.PublishProductId , @DomainUrl +'Catalog/'  + CAST(@MaxSmallWidth AS VARCHAR(100)) + '/' + RT.MediaPath AS ImageSmallPath     
		FROM ZnodePimAttributeValue ZPAV   
		INNER JOIN ZnodePublishProduct TYU ON (TYU.PimProductId  = ZPAV.PimProductId)  
		INNER JOIN ZnodePimProductAttributeMedia  RT ON ( RT.PimAttributeValueId = ZPAV.PimAttributeValueId )  
		WHERE  TYU.PublishCatalogId = @PublishCatalogId  
		AND RT.LocaleId = @DefaultLocaleId  
		AND ZPAV.PimAttributeId = (SELECT TOp 1 PimAttributeId FROM ZnodePimAttribute WHERE AttributeCode = 'ProductImage')  
		AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 WHERE TYU.PimProductId = ZPP1.PimProductId )  
   
		INSERT INTO #ProductSKU   
		SELECT ZCSD.SEOUrl , ZCDL.SEODescription,ZCDL.SEOKeywords ,ZCDL.SEOTitle, TYU.PublishProductId  
		FROM ZnodeCMSSEODetail ZCSD   
		INNER JOIN ZnodeCMSSEODetailLocale ZCDL ON (ZCDL.CMSSEODetailId = ZCSD.CMSSEODetailId)  
		INNER JOIN ZnodePublishProductDetail TY ON (TY.SKU = ZCSD.SEOCode AND ZCDL.LocaleId = TY.LocaleId)   
		INNER JOIN ZnodePublishProduct TYU ON (TYU.PublishProductId = TY.PublishProductId)  
		WHERE CMSSEOTypeId = (SELECT TOP 1 CMSSEOTypeId FROM ZnodeCMSSEOType WHERE Name = 'Product')   
		AND ZCDL.LocaleId = @DefaultLocaleId  
		AND TYU.PublishCatalogId = @PublishCatalogId  
		--AND ZCSD.PublishStateId = @PublishStateId  
		AND ZCSD.PortalId = @DefaultPortal  
		AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 WHERE TYU.PimProductId = ZPP1.PimProductId )  
  
	END  
   
	CREATE NONCLUSTERED INDEX Idx_#ProductSKU_PublishProductId ON [dbo].[#ProductSKU] ([PublishProductId])  
	CREATE NONCLUSTERED INDEX Idx_#ProductImages_PublishProductId ON [dbo].#ProductImages ([PublishProductId])  
	CREATE NONCLUSTERED INDEX Idx_#ZnodePrice_PublishProductId ON [dbo].#ZnodePrice ([PublishProductId])  
	
	SELECT DISTINCT PublishProductId, x.LocaleId 
	INTO #PublishProducts 
	FROM ZnodePublishProduct ZPP
	INNER JOIN ##AttributeValueLocale x ON X.PimProductId = ZPP.PimProductId
	WHERE ZPP.PublishCatalogId = @PublishCatalogId

	CREATE INDEX #PublishProducts_PublishProductId on #PublishProducts(PublishProductId,LocaleId)
	--Creating products complete attribute json
	SELECT ZPP.Pimproductid, 
			ZPCPD.PimCatalogProductDetailId,ZPCPD.PublishProductId
			,ZPCPD.PublishCatalogId,ZPCPD.PimCategoryHierarchyId
			,ZPCPD.SKU,ZPCPD.ProductName,ZPCPD.CategoryName,ZPCPD.CatalogName
			,ZPCPD.LocaleId,ZPCPD.IsActive,ZPCPD.ProfileIds,ZPCPD.ProductIndex, 
		'[' +  
		(SELECT STUFF((SELECT ','+ AttributeEntity FROM ##AttributeValueLocale a   
		WHERE a.pimproductid = ZPP.pimproductid AND a.LocaleId = ZPCPD.LocaleId   
		FOR XML Path (''),Type).value('.', 'varchar(max)') ,1,1,'')  )   
		+ ']' AS ProductXML  
	INTO #ProductAttributeXML  
	FROM [ZnodePublishCatalogProductDetail] ZPCPD   
	INNER JOIN ZnodePublishProduct ZPP ON ZPCPD.PublishProductId = ZPP.PublishProductId AND ZPCPD.PublishCatalogId = ZPP.PublishCatalogId --WHERE TY.PimProductId = ZPP.PimProductId  AND TY.LocaleId = ZPCPD.LocaleId   
	WHERE ZPCPD.PublishCatalogId = @PublishCatalogId  
	AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId AND ZPCPD.LocaleId = X.LocaleId )
	GROUP BY ZPP.Pimproductid,ZPCPD.PimCatalogProductDetailId,ZPCPD.PublishProductId
			,ZPCPD.PublishCatalogId,ZPCPD.PimCategoryHierarchyId
			,ZPCPD.SKU,ZPCPD.ProductName,ZPCPD.CategoryName,ZPCPD.CatalogName
			,ZPCPD.LocaleId,ZPCPD.IsActive,ZPCPD.ProfileIds,ZPCPD.ProductIndex

	CREATE NONCLUSTERED INDEX Idx_#ProductAttributeXML_PimProductId_LocaleId  
	ON [dbo].#ProductAttributeXML (PimProductId,LocaleId)  
	
	IF (SELECT COUNT(*) FROM @LocaleIds) > 1
	BEGIN
		--INSERT INTO #ProductAttributeXML(Pimproductid,LocaleId,PublishProductId,ProductXML)
		SELECT ZPP.Pimproductid, 
			ZPCPD.PimCatalogProductDetailId,ZPCPD.PublishProductId
			,ZPCPD.PublishCatalogId,ZPCPD.PimCategoryHierarchyId
			,ZPCPD.SKU,ZPCPD.ProductName,ZPCPD.CategoryName,ZPCPD.CatalogName
			,ZPCPD.LocaleId,ZPCPD.IsActive,ZPCPD.ProfileIds,ZPCPD.ProductIndex,
			'[' +  
			(SELECT STUFF((SELECT ','+ AttributeEntity FROM ##AttributeValueLocale a   
			WHERE a.pimproductid = ZPP.pimproductid AND a.LocaleId = @DefaultLocaleId   
			FOR XML Path (''),Type).value('.', 'varchar(max)') ,1,1,'')  )   
			+ ']' AS ProductXML  
		INTO #ProductAttributeXML_LocaleWise
		FROM [ZnodePublishCatalogProductDetail] ZPCPD   
		INNER JOIN ZnodePublishProduct ZPP ON ZPCPD.PublishProductId = ZPP.PublishProductId AND ZPCPD.PublishCatalogId = ZPP.PublishCatalogId --WHERE TY.PimProductId = ZPP.PimProductId  AND TY.LocaleId = ZPCPD.LocaleId   
		WHERE ZPCPD.PublishCatalogId = @PublishCatalogId  
		AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId)
		AND NOT EXISTS(SELECT * FROM #ProductAttributeXML X WHERE ZPCPD.PublishProductId = X.PublishProductId AND X.LocaleId = ZPCPD.LocaleId )
		AND ZPCPD.LocaleId <> @DefaultLocaleId
		GROUP BY ZPP.Pimproductid, 
			ZPCPD.PimCatalogProductDetailId,ZPCPD.PublishProductId
			,ZPCPD.PublishCatalogId,ZPCPD.PimCategoryHierarchyId
			,ZPCPD.SKU,ZPCPD.ProductName,ZPCPD.CategoryName,ZPCPD.CatalogName
			,ZPCPD.LocaleId,ZPCPD.IsActive,ZPCPD.ProfileIds,ZPCPD.ProductIndex

		CREATE NONCLUSTERED INDEX Idx_#ProductAttributeXML_LocaleWise_PimProductId_LocaleId  
		ON [dbo].#ProductAttributeXML (PimProductId,LocaleId) 
	END
	


	DECLARE @MaxCount INT, @MinRow INT, @MaxRow INT, @Rows numeric(10,2);  
	SELECT @MaxCount = COUNT(*) FROM [ZnodePublishCatalogProductDetail] ZPCPD WHERE PublishCatalogId = @PublishCatalogId  
	AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId)
  
	SELECT @Rows = 50000  
          
	SELECT @MaxCount = CEILING(@MaxCount / @Rows);  
  
	SELECT PimCatalogProductDetailId, PublishProductId,Row_Number() over(Order by PublishProductId) ID into #ZnodePublishCatalogProductDetail 
	FROM [ZnodePublishCatalogProductDetail] ZPCPD WHERE PublishCatalogId = @PublishCatalogId  
	AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId)
  
	UPDATE ZPPAX SET ZPPAX.ElasticSearchEvent = 2
	FROM ZnodePublishProductEntity ZPPAX
	WHERE NOT EXISTS(SELECT * from [ZnodePublishCatalogProductDetail] ZLW WHERE ZPPAX.ZnodeProductId = ZLW.PublishProductId 
						AND ZPPAX.LocaleId = ZLW.LocaleId AND ZPPAX.ZnodeCatalogId = ZLW.PublishCatalogId )
	AND ZPPAX.ZnodeCatalogId = @PublishCatalogId 
	AND EXISTS(SELECT * FROM @TBL_LocaleId V WHERE ZPPAX.VersionId = V.VersionId)

	--Delete products from category from publish tables which are removed from one category and added into other category
	--UPDATE ZPPE SET ZPPE.ElasticSearchEvent = 2 FROM ZnodePublishProductEntity ZPPE
	--WHERE NOT EXISTS(SELECT * FROM ZnodePublishCategoryProduct ZPCP WHERE ZPPE.ZnodeCategoryIds = ZPCP.PublishCategoryId AND ZPPE.ZnodeProductId = ZPCP.PublishProductId
	--AND ZPPE.ZnodeCatalogId = ZPCP.PublishCatalogId)
	--AND ZPPE.ZnodeCatalogId = @PublishCatalogId
	--AND Not Exists (Select TOP 1 1 From ZnodePublishConfigurableProductEntity X Where X.AssociatedZnodeProductId = ZPPE.ZnodeProductId )
	--AND Isnull(ZPPE.ZnodeCategoryIds ,'') = '0'
	
	UPDATE ZPPE SET ZPPE.ElasticSearchEvent = 2 FROM ZnodePublishProductEntity ZPPE
	WHERE NOT EXISTS(SELECT * FROM ZnodePublishCategoryProduct ZPCP WHERE ZPPE.ZnodeCategoryIds = ZPCP.PublishCategoryId AND ZPPE.ZnodeProductId = ZPCP.PublishProductId
	AND ZPPE.ZnodeCatalogId = ZPCP.PublishCatalogId)
	AND ZPPE.ZnodeCatalogId = @PublishCatalogId
	AND Isnull(ZPPE.ZnodeCategoryIds ,'') <> ''
	AND EXISTS(SELECT * FROM @TBL_LocaleId V WHERE ZPPE.VersionId = V.VersionId)


 --   --Delete data which are not present in catalog publish
	--Declare @Batch Bigint
	--SET @Batch = 1;
	--WHILE @Batch > 0
	--BEGIN 
	--	--BEGIN TRAN DelProd
	--		DELETE top (5000)  ZPPAX
	--		from ZnodePublishProductEntity ZPPAX
	--		WHERE NOT EXISTS(SELECT * from [ZnodePublishCatalogProductDetail] ZLW WHERE ZPPAX.ZnodeProductId = ZLW.PublishProductId 
	--							AND ZPPAX.LocaleId = ZLW.LocaleId AND ZPPAX.ZnodeCatalogId = ZLW.PublishCatalogId )
	--		AND ZPPAX.ZnodeCatalogId = @PublishCatalogId  
	--	--COMMIT TRAN DelProd
	--	SET @Batch = @@ROWCOUNT;
	--END
	
	SELECT ZPCP.PublishCategoryId,ZPCP.PublishProductId,ZPCP.PublishCatalogId,ZPCP.PimCategoryHierarchyId,ZPC.PimCategoryId,ZPCCF.PimProductId ,ZPCCF.DisplayOrder
	INTO #TempPublishCategoryProduct
	FROM ZnodePublishCategoryProduct ZPCP 
	INNER JOIN ZnodePublishProduct ZPP ON ZPCP.PublishProductId = ZPP.PublishProductId AND ZPCP.PublishCatalogId = ZPP.PublishCatalogId
	INNER JOIN ZnodePublishCategory ZPC ON (ZPCP.PublishCatalogId = ZPC.PublishCatalogId AND   ZPC.PublishCategoryId = ZPCP.PublishCategoryId AND ZPCP.PimCategoryHierarchyId = ZPC.PimCategoryHierarchyId)
	INNER JOIN ZnodePimCategoryProduct ZPCCF ON (ZPCCF.PimCategoryId = ZPC.PimCategoryId  AND ZPCCF.PimProductId = ZPP.PimProductId )
	WHERE EXISTS(SELECT * FROM [ZnodePublishCatalogProductDetail] ZPCPD WHERE (ZPCP.PublishProductId = ZPCPD.PublishProductId AND ZPCP.PublishCatalogId = ZPCPD.PublishCatalogId AND ZPCP.PimCategoryHierarchyId = ZPCPD.PimCategoryHierarchyId))		
	AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCP.PublishProductId = X.PublishProductId)
	AND ZPCP.PublishCatalogId = @PublishCatalogId 

	CREATE NONCLUSTERED INDEX Id_#TempPublishCategoryProduct_1 ON #TempPublishCategoryProduct(PublishProductId,PublishCatalogId,PimCategoryHierarchyId)

	IF OBJECT_ID('tempdb..#Temp_ImportLoop') IS NOT NULL  
		DROP TABLE #Temp_ImportLoop;  
          
	---- To get the min AND max rows for import in loop  
	;WITH cte AS   
	(  
		SELECT RowId = 1,   
		MinRow = 1,   
		MaxRow = cast(@Rows as int)  
		UNION ALL  
		SELECT RowId + 1,   
		MinRow + cast(@Rows as int),   
		MaxRow + cast(@Rows as int)  
		FROM cte  
		WHERE RowId + 1 <= @MaxCount  
	)  
	SELECT RowId, MinRow, MaxRow  
	INTO #Temp_ImportLoop  
	FROM cte  
	OPTION (maxrecursion 0);  

	DECLARE cur_BulkData CURSOR LOCAL FAST_FORWARD  
	FOR SELECT MinRow, MaxRow, B.LocaleId , B.RevisionType  ,b.VersionId
	FROM #Temp_ImportLoop L  
	CROSS APPLY @TBL_LocaleId B;  
  
	OPEN cur_BulkData;  
	FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow,@LocaleId, @RevisionType ,@VersionId 
	WHILE @@FETCH_STATUS = 0  
	BEGIN  
		IF OBJECT_ID('TEMPDB..#ProductEntity') IS NOT NULL
				DROP TABLE #ProductEntity

		IF OBJECT_ID('TEMPDB..#ProductEntity_LocaleWise') IS NOT NULL
			DROP TABLE #ProductEntity_LocaleWise
			
		SELECT   
			CAST(@VersionId AS VARCHAR(50)) VersionId --1   
			,CAST(ZPCPD.ProductIndex AS VARCHAr(100)) + CAST(ISNULL(ZPCP.PublishCategoryId,'')  AS VARCHAR(50))  + CAST(Isnull(ZPCPD.PublishCatalogId ,'')  AS VARCHAR(50)) + CAST( Isnull(ZPCPD.LocaleId,'') AS VARCHAR(50)) IndexId  --2  
			,CAST(ZPCPD.PublishProductId AS VARCHAR(50)) PublishProductId,CAST(ZPCPD.PublishCatalogId  AS VARCHAR(50)) PublishCatalogId  --3   
			,CAST(ISNULL(ZPCPD.SKU ,'') AS NVARCHAR(2000)) SKU,CAST( Isnull(ZPCPD.LocaleId,'') AS VARCHAR(50)) LocaleId -- 4   
			,CAST(isnull(ZPCPD.ProductName,'') AS NVARCHAR(2000) )  ProductName ,CAST(ISNULL(ZPCP.PublishCategoryId,'')  AS VARCHAR(50)) PublishCategoryId  -- 5   
			--'{"Attributes":[' + PAX.ProductXML + ']'  
			,CAST(ISNULL(ZPCPD.IsActive ,'0') AS VARCHAR(50)) IsActive ,ZPCPD.ProductXML,'[]' Brands,CAST(isnull(ZPCPD.CategoryName,'') AS NVARCHAR(2000)) CategoryName  --6  
			,CAST(Isnull(ZPCPD.CatalogName,'')  AS NVARCHAR(2000)) CatalogName,CAST(ISNULL(ZPCP.DisplayOrder,'') AS VARCHAR(50)) DisplayOrder  -- 7   
			,@RevisionType RevisionType, 0 AssociatedProductDisplayOrder,-- pending  -- 8   
			ZPCPD.ProductIndex,  -- 9  
			Case When @IsAllowIndexing = 1 then  ISNULL(CAST(TBZP.SalesPrice  AS VARCHAr(500)),'') else '' end SalesPrice ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(CAST(TBZP.RetailPrice  AS VARCHAr(500)),'') else '' end RetailPrice ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CultureCode ,'') else '' end CultureCode ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CurrencySuffix ,'') else '' end CurrencySuffix ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CurrencyCode ,'') else '' end CurrencyCode ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEODescription,'') else '' end SEODescriptionForIndex,  
			Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEOKeywords,'') else '' end SEOKeywords,  
			Case When @IsAllowIndexing = 1 then  ISNULL(SEOTitle,'') else '' end SEOTitle,  
			Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEOUrl ,'') else '' end SEOUrl,  
			Case When @IsAllowIndexing = 1 then  ISNULL(TBPI.ImageSmallPath,'') else '' end ImageSmallPath,  
			CAST(ISNULL(LOWER(ZPCPD.SKU) ,'') AS NVARCHAR(2000)) Lower_SKU--, z.Id    		
		INTO #ProductEntity
		FROM #ProductAttributeXML ZPCPD  
		INNER JOIN ZnodePublishCatalog ZPCV ON (ZPCV.PublishCatalogId = ZPCPD.PublishCatalogId)  
		--INNER JOIN #ProductAttributeXML PAX ON PAX.PublishProductId = ZPCPD.PublishProductId  AND PAX.LocaleId = ZPCPD.LocaleId   
		LEFT JOIN  #ZnodePrice TBZP ON (TBZP.PublishProductId = ZPCPD.PublishProductId)  
		LEFT JOIN  #ProductSKU TBPS ON (TBPS.PublishProductId = ZPCPD.PublishProductId)  
		LEFT JOIN  #ProductImages TBPI ON (TBPI.PublishProductId = ZPCPD.PublishProductId)  
		LEFT JOIN #TempPublishCategoryProduct ZPCP  ON (ZPCP.PublishProductId = ZPCPD.PublishProductId AND ZPCP.PublishCatalogId = ZPCPD.PublishCatalogId AND ZPCP.PimCategoryHierarchyId = ZPCPD.PimCategoryHierarchyId)
		WHERE ZPCPD.LocaleId = @LocaleId  
		AND EXISTS(SELECT * FROM #ZnodePublishCatalogProductDetail z WHERE ZPCPD.PimCatalogProductDetailId = z.PimCatalogProductDetailId AND z.Id BETWEEN @MinRow AND @MaxRow)
		AND ZPCPD.PublishCatalogId = @PublishCatalogId  
		AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId)

		CREATE INDEX Idx_#ProductEntity ON #ProductEntity (PublishProductId,PublishCatalogId,LocaleId,PublishCategoryId)

		UPDATE A SET a.SKU = b.SKU,A.SKULower = Lower_SKU,A.Name = B.ProductName, A.Brands = B.Brands, A.CategoryName = B.CategoryName, A.CatalogName = B.CatalogName,
			A.DisplayOrder = B.DisplayOrder, A.AssociatedProductDisplayOrder = B.AssociatedProductDisplayOrder,
			A.SalesPrice = B.SalesPrice, A.RetailPrice = B.RetailPrice, A.SeoDescription=B.SEODescriptionForIndex,
			A.SeoKeywords = B.SEOKeywords, A.SeoTitle = B.SEOTitle, A.SeoUrl = B.SEOUrl, A.ImageSmallPath = B.ImageSmallPath,
			A.ProductIndex = B.ProductIndex, A.IsActive = B.IsActive, A.IndexId = B.IndexId, A.Attributes = B.ProductXML,
			A.ElasticSearchEvent = 1
		FROM ZnodePublishProductEntity A
		INNER JOIN #ProductEntity B ON A.ZnodeProductId = B.PublishProductId AND A.ZnodeCatalogId = B.PublishCatalogId AND A.LocaleId = B.LocaleId 
			AND ISNULL(A.ZnodeCategoryIds,0) = ISNULL(B.PublishCategoryId,0) AND A.VersionId = B.VersionId AND A.ElasticSearchEvent <> 2
		AND EXISTS(SELECT * FROM @TBL_LocaleId V WHERE A.VersionId = V.VersionId)

		INSERT INTO ZnodePublishProductEntity (  
			VersionId, --1  
			IndexId, --2   
			ZnodeProductId,ZnodeCatalogId, --3  
			SKU,LocaleId, --4   
			Name,ZnodeCategoryIds, --5  
			IsActive,Attributes,Brands,CategoryName, --6   
			CatalogName,DisplayOrder, --7   
			RevisionType,AssociatedProductDisplayOrder, --8  
			ProductIndex,--9  
			SalesPrice,RetailPrice,CultureCode,CurrencySuffix,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent)  
		SELECT VersionId, --1  
			IndexId, --2   
			PublishProductId,PublishCatalogId, --3  
			SKU,LocaleId, --4   
			ProductName,PublishCategoryId, --5  
			IsActive,ProductXML,Brands,CategoryName, --6   
			CatalogName,DisplayOrder, --7   
			RevisionType,AssociatedProductDisplayOrder, --8  
			ProductIndex,--9  
			SalesPrice,RetailPrice,CultureCode,CurrencySuffix,CurrencyCode,SEODescriptionForIndex,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,Lower_SKU,1 AS ElasticSearchEvent
		FROM #ProductEntity B
		WHERE NOT EXISTS(SELECT * FROM ZnodePublishProductEntity A WHERE A.ZnodeProductId = B.PublishProductId AND A.ZnodeCatalogId = B.PublishCatalogId AND A.LocaleId = B.LocaleId 
			AND ISNULL(A.ZnodeCategoryIds,0) = ISNULL(B.PublishCategoryId,0) AND A.VersionId = B.VersionId AND A.ElasticSearchEvent <> 2)
			--select * from #ProductEntity where PublishProductId = 191 
		IF @LocaleId <> @DefaultLocaleId
		BEGIN
			SELECT 
				CAST(@VersionId AS VARCHAR(50)) VersionId --1 
				,CAST(ZPCPD.ProductIndex AS VARCHAr(100)) + CAST(ISNULL(ZPCP.PublishCategoryId,'')  AS VARCHAR(50))  + CAST(Isnull(ZPCPD.PublishCatalogId ,'')  AS VARCHAR(50)) + CAST( Isnull(ZPCPD.LocaleId,'') AS VARCHAR(50)) IndexId  --2
				,CAST(ZPCPD.PublishProductId AS VARCHAR(50)) PublishProductId,CAST(ZPCPD.PublishCatalogId  AS VARCHAR(50)) PublishCatalogId  --3 
				,CAST(ISNULL(ZPCPD.SKU ,'') AS NVARCHAR(2000)) SKU,CAST( Isnull(ZPCPD.LocaleId,'') AS VARCHAR(50)) LocaleId -- 4 
				,CAST(isnull(ZPCPD.ProductName,'') AS NVARCHAR(2000) )  ProductName ,CAST(ISNULL(ZPCP.PublishCategoryId,'')  AS VARCHAR(50)) PublishCategoryId  -- 5 
				,CAST(ISNULL(ZPCPD.IsActive ,'0') AS VARCHAR(50)) IsActive ,ZPCPD.ProductXML,'[]' Brands,CAST(isnull(ZPCPD.CategoryName,'') AS NVARCHAR(2000)) CategoryName  --6
				,CAST(Isnull(ZPCPD.CatalogName,'')  AS NVARCHAR(2000)) CatalogName,CAST(ISNULL(ZPCP.DisplayOrder,'') AS VARCHAR(50)) DisplayOrder  -- 7 
				,@RevisionType as RevisionType, 0 AssociatedProductDisplayOrder,-- pending  -- 8 
				ZPCPD.ProductIndex,  -- 9
				Case When @IsAllowIndexing = 1 then  ISNULL(CAST(TBZP.SalesPrice  AS VARCHAr(500)),'') else '' end SalesPrice , 
				Case When @IsAllowIndexing = 1 then  ISNULL(CAST(TBZP.RetailPrice  AS VARCHAr(500)),'') else '' end RetailPrice , 
				Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CultureCode ,'') else '' end CultureCode , 
				Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CurrencySuffix ,'') else '' end CurrencySuffix , 
				Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CurrencyCode ,'') else '' end CurrencyCode , 
				Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEODescription,'') else '' end SEODescriptionForIndex,
				Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEOKeywords,'') else '' end SEOKeywords,
				Case When @IsAllowIndexing = 1 then  ISNULL(SEOTitle,'') else '' end SEOTitle,
				Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEOUrl ,'') else '' end SEOUrl,
				Case When @IsAllowIndexing = 1 then  ISNULL(TBPI.ImageSmallPath,'') else '' end ImageSmallPath,
				CAST(ISNULL(LOWER(ZPCPD.SKU) ,'') AS NVARCHAR(2000)) Lower_SKU
			INTO #ProductEntity_LocaleWise
			FROM #ProductAttributeXML_LocaleWise ZPCPD
			INNER JOIN ZnodePublishCatalog ZPCV ON (ZPCV.PublishCatalogId = ZPCPD.PublishCatalogId)
			--INNER JOIN #ProductAttributeXML_LocaleWise PAX ON PAX.PublishProductId = ZPCPD.PublishProductId  AND PAX.LocaleId = ZPCPD.LocaleId 
			LEFT JOIN  #ZnodePrice TBZP ON (TBZP.PublishProductId = ZPCPD.PublishProductId)
			LEFT JOIN  #ProductSKU TBPS ON (TBPS.PublishProductId = ZPCPD.PublishProductId)
			LEFT JOIN  #ProductImages TBPI ON (TBPI.PublishProductId = ZPCPD.PublishProductId)
			LEFT JOIN #TempPublishCategoryProduct ZPCP  ON (ZPCP.PublishProductId = ZPCPD.PublishProductId AND ZPCP.PublishCatalogId = ZPCPD.PublishCatalogId AND ZPCP.PimCategoryHierarchyId = ZPCPD.PimCategoryHierarchyId)
			WHERE ZPCPD.LocaleId = @LocaleId 
			AND EXISTS(SELECT * FROM #ZnodePublishCatalogProductDetail z WHERE ZPCPD.PimCatalogProductDetailId = z.PimCatalogProductDetailId AND z.Id BETWEEN @MinRow AND @MaxRow)
			AND ZPCPD.PublishCatalogId = @PublishCatalogId

			CREATE INDEX Idx_#ProductEntity_LocaleWise ON #ProductEntity (PublishProductId,PublishCatalogId,LocaleId,PublishCategoryId)

			UPDATE A SET a.SKU = b.SKU,A.SKULower = Lower_SKU,A.Name = B.ProductName, A.Brands = B.Brands, A.CategoryName = B.CategoryName, A.CatalogName = B.CatalogName,
				A.DisplayOrder = B.DisplayOrder, A.AssociatedProductDisplayOrder = B.AssociatedProductDisplayOrder,
				A.SalesPrice = B.SalesPrice, A.RetailPrice = B.RetailPrice, A.SeoDescription=B.SEODescriptionForIndex,
				A.SeoKeywords = B.SEOKeywords, A.SeoTitle = B.SEOTitle, A.SeoUrl = B.SEOUrl, A.ImageSmallPath = B.ImageSmallPath,
				A.ProductIndex = B.ProductIndex, A.IsActive = B.IsActive, A.IndexId = B.IndexId, A.Attributes = B.ProductXML,
				A.ElasticSearchEvent = 1
			FROM ZnodePublishProductEntity A
			INNER JOIN #ProductEntity_LocaleWise B ON A.ZnodeProductId = B.PublishProductId AND A.ZnodeCatalogId = B.PublishCatalogId AND A.LocaleId = B.LocaleId 
				AND ISNULL(A.ZnodeCategoryIds,0) = ISNULL(B.PublishCategoryId,0) AND A.VersionId = B.VersionId AND A.ElasticSearchEvent <> 2
			AND EXISTS(SELECT * FROM @TBL_LocaleId V WHERE A.VersionId = V.VersionId)

			INSERT INTO ZnodePublishProductEntity (
			VersionId, --1
			IndexId, --2 
			ZnodeProductId,ZnodeCatalogId, --3
			SKU,LocaleId, --4 
			Name,ZnodeCategoryIds, --5
			IsActive,Attributes,Brands,CategoryName, --6 
			CatalogName,DisplayOrder, --7 
			RevisionType,AssociatedProductDisplayOrder, --8
			ProductIndex,--9
			SalesPrice,RetailPrice,CultureCode,CurrencySuffix,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent)
			SELECT VersionId --1 
				,IndexId  --2
				,PublishProductId,PublishCatalogId  --3 
				,SKU,LocaleId -- 4 
				,ProductName ,PublishCategoryId  -- 5 
				,IsActive ,ProductXML,Brands,CategoryName  --6
				,CatalogName,DisplayOrder  -- 7 
				,RevisionType, AssociatedProductDisplayOrder,-- pending  -- 8 
				ProductIndex,  -- 9
				SalesPrice , 
				RetailPrice , 
				CultureCode , 
				CurrencySuffix , 
				CurrencyCode , 
				SEODescriptionForIndex,
				SEOKeywords,
				SEOTitle,
				SEOUrl,
				ImageSmallPath,
				Lower_SKU,1 as ElasticSearchEvent
			FROM #ProductEntity_LocaleWise B
			WHERE NOT EXISTS(SELECT * FROM ZnodePublishProductEntity A WHERE A.ZnodeProductId = B.PublishProductId AND A.ZnodeCatalogId = B.PublishCatalogId AND A.LocaleId = B.LocaleId 
				AND ISNULL(A.ZnodeCategoryIds,0) = ISNULL(B.PublishCategoryId,0) AND A.VersionId = B.VersionId AND A.ElasticSearchEvent <> 2)
		
			--select * from #ProductEntity_LocaleWise where PublishProductId = 191 

		END

		SET @VersionId = 0  

		IF OBJECT_ID('tempdb..#ProductEntity') is not null
			DROP TABLE #ProductEntity

		IF OBJECT_ID('TEMPDB..#TempProductEntity_LocaleWise') IS NOT NULL
			DROP TABLE #TempProductEntity_LocaleWise

	FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow,@LocaleId, @RevisionType ,@VersionId 
	END;  
	CLOSE cur_BulkData;  
	DEALLOCATE cur_BulkData;  
  
  
	IF @RevisionState = 'PREVIEW'   
		UPDATE ZnodePimProduct SET IsProductPublish = 1,PublishStateId =  DBO.Fn_GetPublishStateIdForPreview()    
		WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishProduct ZPP WHERE ZPP.PimProductId = ZnodePimProduct.PimProductId   
		AND ZPP.PublishCatalogId = @PublishCatalogId)  
	Else  
		UPDATE ZnodePimProduct SET IsProductPublish = 1,PublishStateId =  DBO.Fn_GetPublishStateIdForPublish()    
		WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishProduct ZPP WHERE ZPP.PimProductId = ZnodePimProduct.PimProductId   
		AND ZPP.PublishCatalogId = @PublishCatalogId) 
		

	UPDATE ZnodePublishCatalogLog   
	SET IsProductPublished = 1   
	,PublishProductId = (SELECT  COUNT(DISTINCT PublishProductId) FROM ZnodePublishCategoryProduct ZPP   
		WHERE ZPP.PublishCatalogId = ZnodePublishCatalogLog.PublishCatalogId AND ZPP.PublishCategoryId IS NOT NULL)   
	WHERE ZnodePublishCatalogLog.PublishCatalogId = @PublishCatalogId  
	and PublishStateId = (SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE PublishStateCode = 'Processing' ) 
    
	--UPDATE ZnodePublishCatalogLog   
	--SET IsProductPublished = 1   
	--,PublishProductId = (SELECT  COUNT(DISTINCT PublishProductId) FROM ZnodePublishCatalogProductDetail ZPP   
	--	WHERE ZPP.PublishCatalogId = ZnodePublishCatalogLog.PublishCatalogId AND ZPP.PimCategoryHierarchyId <> 0)   
	--WHERE ZnodePublishCatalogLog.PublishCatalogId = @PublishCatalogId  
	--AND PublishStateId = (SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE PublishStateCode = 'Processing' )  

	SET @Status = 1   

	IF OBJECT_ID('tempdb..##AttributeValueLocale') IS NOT NULL  
		DROP TABLE ##AttributeValueLocale; 

END TRY   
BEGIN CATCH   
	SELECT ERROR_MESSAGE()
	 SET @Status =0    
	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	  @ErrorLine VARCHAR(100)= ERROR_LINE(),  
	  @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishProductJson   
		 @PublishCatalogId = '+CAST(@PublishCatalogId AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))  
	  +',@PimCatalogId = ' + CAST(@PimCatalogId AS varchar(20))  
	  +',@VersionIdString= ' + CAST(@VersionIdString AS varchar(20))  
       
	 EXEC Znode_InsertProcedureErrorLog  
	  @ProcedureName = 'Znode_GetPublishProductJson',  
	  @ErrorInProcedure = @Error_procedure,  
	  @ErrorMessage = @ErrorMessage,  
	  @ErrorLine = @ErrorLine,  
	  @ErrorCall = @ErrorCall;  
END CATCH  
  
END  

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity
GO

CREATE PROCEDURE [dbo].[Znode_PublishCatalogEntity]  
(  
	@PimCatalogId  INT = 0   
	,@RevisionState VARCHAR(50) = ''   
	,@UserId INT = 0  
	,@NewGUID NVARCHAR(500)   
	,@IsDraftProductsOnly BIT = 1  
)  
AS  
/*  
To publish all catalog product and their details  
Unit Testing :   
Exec [dbo].[Znode_PublishCatalogEntity]  
@PimCatalogId  = 3  
,@RevisionState = 'PRODUCTION'   
,@UserId = 2  
,@NewGUID = '123'  
   
EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,  
@NewGUID ='123'   
  
*/  
BEGIN  
BEGIN TRY   
	SET NOCOUNT ON  

	DECLARE @Status Bit =0 , @PublishCatalogId INT=0  
	IF (@PimCatalogId=0)  
	BEGIN  
	--SET @Status =0  
		SELECT 0 AS ID,@Status AS Status;  
		SET @PublishCatalogId=0  
		SELECT @PublishCatalogId;  
	END  
	ELSE  
	BEGIN  
   
		DECLARE @Type VARCHAR(50) = '', @CMSSEOCode VARCHAR(300);  
		SET @Status = 1   
		DECLARE @IsPreviewEnable INT  
		,@PreviewVersionId INT = 0    
		,@ProductionVersionId INT = 0  
		,@CatalogProfileId VARCHAR(1000)  
   
		IF OBJECT_ID('tempdb..#CatalogAttributeDetails') IS NOT NULL  
		DROP TABLE #CatalogAttributeDetails  
		CREATE TABLE [dbo].[#CatalogAttributeDetails]  
		(  
			[ZnodeCatalogId] [INT] NULL,  
			[AttributeCode] [NVARCHAR](300) NULL,  
			[AttributeTypeName] [VARCHAR](300) NULL,  
			[IsComparable] [bit] NOT NULL,  
			[IsHtmlTags] [bit] NOT NULL,  
			[IsFacets] [bit] NOT NULL,  
			[IsUseInSearch] [bit] NOT NULL,  
			[IsPersonalizable] [bit] NOT NULL,  
			[IsConfigurable] [bit] NOT NULL,  
			[AttributeName] [NVARCHAR](300) NULL,  
			[LocaleId] [INT] NULL,  
			[DisplayOrder] [INT] NULL,  
			[DefaultValueDisplayOrder] [INT] NULL,  
			[AttributeDefaultValue] [NVARCHAR](max) NULL  
		) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY] 
		
		DECLARE @CatalogName VARCHAR(100),@UserName VARCHAR(50)  
		SET @PublishCatalogId = ISNULL((SELECT TOP 1 PublishCatalogId FROM ZnodePublishCatalog ZPC WHERE ZPC.PimCatalogId = @PimCatalogId), 0)  
    
	SELECT TOP 1  @UserName = UserName 
	FROM ZnodeUser 
	WHERE ZnodeUser.UserId = @userId  
  
	SELECT @CatalogName = CatalogName FROM ZnodePimCatalog WHERE PimCatalogId = @PimCatalogId
	
	DELETE FROM ZnodePublishProgressNotifierEntity WHERE JOBName =@CatalogName   

	INSERT INTO ZnodePublishProgressNotifierEntity  
	(VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriENDlyName)  
	VALUES(0,@NewGUID , Isnull(@CatalogName,'') + ' Catalog ', 0 , 0 , 0 , '' , @UserId, @UserName )  
  
	IF EXISTS (SELECT  * FROM ZnodePublishStateApplicationTypeMapping PSA WHERE PSA.IsEnabled =1 AND    
	EXISTS (SELECT TOP 1 1  FROM ZnodePublishState PS WHERE PS.PublishStateId = PSA.PublishStateId ) AND ApplicationType =  'WebstorePreview')  
		SET @IsPreviewEnable = 1   
	ELSE   
		SET @IsPreviewEnable = 0   
  
	--Genrate preview entry   
	DECLARE @SetLocaleId INT , @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleId(), @MaxCount INT =0 , @IncrementalId INT = 1    
	DECLARE @TBL_Locale TABLE (LocaleId INT , RowId INT IDENTITY(1,1))  
    
	IF OBJECT_ID('tempdb..[#Tbl_NewVersionEntity]') IS NOT NULL  
		DROP TABLE tempdb..#Tbl_NewVersionEntity  
	
	CREATE TABLE #Tbl_NewVersionEntity(PublishCatalogId INT , VersionId INT , LocaleId INT , PublishType VARCHAR(50) )  
  
	--IF OBJECT_ID('tempdb..[#Tbl_OldVersionEntity]') IS NOT NULL  
	--	DROP TABLE tempdb..#Tbl_OldVersionEntity  
	
	--CREATE TABLE #Tbl_OldVersionEntity(PublishCatalogId INT , NewVersionId INT ,OldVersionId INT , LocaleId INT , PublishType VARCHAR(50) )  
    
    
	IF @PublishCatalogId > 0   
    BEGIN
		UPDATE ZPC SET CatalogName = ZC.CatalogName,ExternalId = ZC.ExternalId,PimCatalogId= @PimCatalogId,CreatedBy = @UserId,  
		CreatedDate = Getdate(),ModifiedBy = @UserId,ModifiedDate = Getdate()  
		FROM ZnodePublishCatalog ZPC   
		INNER JOIN ZnodePimCatalog ZC ON(ZC.PimCatalogId = ZPC.PimCatalogId)  
		WHERE ZPC.PimCatalogId = @PimCatalogId;  
	END
	ELSE  
	BEGIN  
		INSERT INTO ZnodePublishCatalog (PimCatalogId,CatalogName,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)  
		SELECT PimCatalogId,CatalogName,ExternalId,@UserId,Getdate(),@UserId,Getdate() FROM ZnodePimCatalog AS ZPC   
		WHERE ZPC.PimCatalogId = @PimCatalogId;  
                        
		SET @PublishCatalogId = SCOPE_IDENTITY();  
	END  
  
	--Getting active local for catalog which are associated to store
	INSERT INTO @TBL_Locale (LocaleId) 
	SELECT LocaleId FROM DBO.FN_GetCatalogPortalActiveLocale(@PublishCatalogId)
  
	SET @MaxCount = ISNULL((SELECT MAx(RowId) FROM @TBL_Locale),0)  

	WHILE @IncrementalId <= @MaxCount  
	BEGIN   
		SET @SetLocaleId = (SELECT Top 1 LocaleId FROM @TBL_locale WHERE RowId = @IncrementalId)  

		IF @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  )    
		BEGIN  
			
			INSERT INTO ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId)  
			SELECT @PublishCatalogId,  @PimCatalogId,NULL,0,  
			NULL,0,  
			NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(), null ,@SetLocaleId ,DBO.Fn_GetPublishStateIdForProcessing()   
  
			INSERT INTO #Tbl_NewVersionEntity (PublishCatalogId,VersionId,LocaleId,PublishType)  
			SELECT @PublishCatalogId, @@Identity , @SetLocaleId ,'PREVIEW'  
      
		END  

		IF (@RevisionState like '%Production%' OR @RevisionState = 'None')  
		BEGIN  
			UPDATE B
            SET IsPublishSuccess = 0
            FROM ZnodePublishVersionEntity B
            WHERE EXISTS(SELECT * FROM #Tbl_NewVersionEntity A WHERE A.PublishCatalogId = B.ZnodeCatalogId 
                AND A.PublishType = 'PRODUCTION' AND A.LocaleId = B.LocaleId) 
            AND B.RevisionType = 'PRODUCTION'

			--Genrate production entry   
			INSERT INTO ZnodePublishCatalogLog  
			(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId)  
			SELECT @PublishCatalogId,  @PimCatalogId,NULL,0,  
			NULL,0,  
			NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(), null ,@SetLocaleId ,DBO.Fn_GetPublishStateIdForProcessing()   
     
			INSERT INTO #Tbl_NewVersionEntity (PublishCatalogId,VersionId,LocaleId,PublishType)  
			SELECT @PublishCatalogId, @@Identity , @SetLocaleId ,'PRODUCTION'  
		END   
			SET @IncrementalId = @IncrementalId +1   
	END  
	
	DECLARE  @VersionIdString VARCHAR(2000)= ''    
     
	TRUNCATE TABLE ZnodePublishCatalogErrorLogEntity  

	UPDATE ZnodePublishProgressNotifierEntity SET   
	ProgressMark =5,   
	IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
	IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
	WHERE  JobId = @NewGUID  
   
	--EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = @PublishCatalogId,@UserId = @UserId , @IsRevertPublish = 0 ,  
	--@NewGUID =@NewGUID   
  
	IF @Type = 'ZnodePublishCatalogEntity' OR @Type = ''  
	BEGIN  
   
		INSERT INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing)  
		SELECT Distinct VE.VersionId, ZPC.PublishCatalogId, PC.CatalogName,VE.PublishType, VE.LocaleId, isnull(PC.IsAllowIndexing,0)  
		FROM ZnodePublishCatalog ZPC  
		INNER JOIN  #Tbl_NewVersionEntity VE ON (VE.PublishCatalogId = ZPC.PublishCatalogId)  
		INNER JOIN ZnodePimCatalog PC on ZPC.PimCatalogId = PC.PimCatalogId  
		-- Data inserted INTo flat table ZnodeWebStoreEntity (Replica of MongoDB Collection )    
    
		IF @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  )   
		BEGIN  
			UPDATE B
            SET IsPublishSuccess = 0
            FROM ZnodePublishVersionEntity B
            WHERE EXISTS(SELECT * FROM #Tbl_NewVersionEntity A WHERE A.PublishCatalogId = B.ZnodeCatalogId 
                AND A.PublishType = 'PREVIEW' AND A.LocaleId = B.LocaleId) 
            AND B.RevisionType = 'PREVIEW'

			INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
			SELECT VersionId,PublishCatalogId,PublishType,LocaleId,0 FROM  #Tbl_NewVersionEntity A
			WHERE A.PublishType = 'PREVIEW'  
			AND NOT EXISTS(SELECT * FROM ZnodePublishVersionEntity B WHERE A.PublishCatalogId = B.ZnodeCatalogId 
			AND B.RevisionType = 'PREVIEW' AND A.LocaleId = B.LocaleId )
		END  

		IF (@RevisionState like '%Production%' OR @RevisionState = 'None')  
		BEGIN  
			UPDATE B
            SET IsPublishSuccess = 0
            FROM ZnodePublishVersionEntity B
            WHERE EXISTS(SELECT * FROM #Tbl_NewVersionEntity A WHERE A.PublishCatalogId = B.ZnodeCatalogId 
                AND A.PublishType = 'PRODUCTION' AND A.LocaleId = B.LocaleId) 
            AND B.RevisionType = 'PRODUCTION'

			INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
			SELECT VersionId,PublishCatalogId,PublishType,LocaleId,0 FROM  #Tbl_NewVersionEntity A
			WHERE PublishType = 'PRODUCTION'  
			AND NOT EXISTS(SELECT * FROM ZnodePublishVersionEntity B WHERE A.PublishCatalogId = B.ZnodeCatalogId 
			AND B.RevisionType = 'PRODUCTION' AND A.LocaleId = B.LocaleId )
		END  
  
		INSERT INTO ZnodePublishCatalogErrorLogEntity  
		(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishCatalogEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
	END  
  
    IF @RevisionState = 'Preview'
	BEGIN
		SELECT @VersionIdString = STUFF((SELECT ',' + cast (VersionId as VARCHAR(50))  
		FROM ZnodePublishVersionEntity WHERE RevisionType = 'Preview' AND ZnodeCatalogId = @PublishCatalogId FOR XML PATH ('')), 1, 1, '')   
	END
	ELSE
	BEGIN
		SELECT @VersionIdString = STUFF((SELECT ',' + cast (VersionId as VARCHAR(50))  
		FROM ZnodePublishVersionEntity WHERE ZnodeCatalogId = @PublishCatalogId FOR XML PATH ('')), 1, 1, '') 
	END


	IF @Type = 'ZnodePublishCategoryEntity' OR @Type = ''  
	BEGIN  
		EXEC [Znode_GetPublishCategoryJson]  
		@PublishCatalogId = @PublishCatalogId ,  
		@UserId =@UserId,                 
		@VersionIdString = @VersionIdString,  
		@Status  =@Status Out,  
		@RevisionState = @RevisionState   
   
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishCategoryEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
     
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =30,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
  
		IF @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END   
   
	IF @Type = 'ZnodePublishProductEntity' OR @Type = ''  
	BEGIN  
		-- Process call catalog publish (include category, products with multiple types)  
		DECLARE @PimProductId TransferId   
		EXEC [Znode_PublishLatestAssociatedProduct] @PublishCatalogId = @PublishCatalogId, @PimProductId = @PimProductId  , @UserId = @UserId , @PublishStateId =0   
		EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId= @PublishCatalogId ,@userid =@userid ,@PimProductId = @PimProductId   
		EXEC Znode_GetPublishProductJson   
		@PublishCatalogId =@PublishCatalogId   
		,@PimProductId = @PimProductId   
		,@UserId = @userid  
		,@PimCatalogId = @PimCatalogId   
		,@VersionIdString = @VersionIdString  
		,@Status  =@Status  Out  
		,@RevisionState = @RevisionState   
		,@IsDraftProductsOnly = @IsDraftProductsOnly  
   
    
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishProductEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =50,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
		If @Status  = 1  
		BEGIN  
			UPDATE ZPCE SET ZPCE.ProductIds =   
			'[' +SUBSTRING((SELECT ','+CAST(PublishProductId AS VARCHAR(50))  
			FROM ZnodePublishCategoryProduct ZPCP   
			WHERE ZPCP.PublishCategoryId = ZPCE.ZnodeCategoryId  
			AND ZPCP.PublishCatalogId = ZPCE.ZnodeCatalogId  FOR XML PATH('')), 2, 8000) + ']'   
			FROM ZnodePublishCategoryEntity  ZPCE WHERE ZPCE.ProductIds is null   
		END  
  
  
		If @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END  

	IF @Type = 'ZnodePublishAddOnEntity' OR @Type = ''  
	BEGIN  
		Exec [Znode_GetPublishAssociatedAddonsJson]  
		@PublishCatalogId = @PublishCatalogId ,  
		@PimProductId   = @PimProductId ,  
		@UserId =@UserId,                 
		@VersionIdString = @VersionIdString,  
		@RevisionType='',  
		@Status  =@Status Out  
  
    
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishAddOnEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =52,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
     
		If @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END   
   
	If @Type = 'BundleAssociatedProducts' OR @Type = ''  
	BEGIN  
		Exec [Znode_GetPublishAssociatedProductsJson]  
		@PublishCatalogId = @PublishCatalogId ,  
		@UserId =@UserId,                 
		@VersionIdString = @VersionIdString,  
		@RevisionType = '',  
		@Status  =@Status Out,  
		@ProductType    = 'BundleProduct'  
    
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'BundleAssociatedProducts', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =54,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
     
		If @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END   

	IF @Type = 'GroupedAssociatedProducts' OR @Type = ''  
	BEGIN  
		Exec [Znode_GetPublishAssociatedProductsJson]  
		@PublishCatalogId = @PublishCatalogId ,  
		@UserId =@UserId,                 
		@VersionIdString = @VersionIdString,  
		@RevisionType = '',  
		@Status  =@Status Out,  
		@ProductType    = 'GroupedProduct'  

		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'GroupedAssociatedProducts', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
     
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =56,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  

		IF @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END   

	IF @Type = 'ConfigurableAssociatedProducts' OR @Type = ''  
	BEGIN  
		Exec [Znode_GetPublishAssociatedProductsJson]  
		@PublishCatalogId = @PublishCatalogId ,  
		@UserId =@UserId,                 
		@VersionIdString = @VersionIdString,  
		@RevisionType = '',  
		@Status  =@Status Out,  
		@ProductType= 'ConfigurableProduct'  
  
      
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ConfigurableAssociatedProducts', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =58,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
     
		IF @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END   

	IF @Type = 'CatalogAttributeaDetail' OR @Type = ''  
	BEGIN  
	BEGIN TRY  
		INSERT INTO [dbo].[#CatalogAttributeDetails]([ZnodeCatalogId],[AttributeCode],[AttributeTypeName],[IsComparable],  
		[IsHtmlTags],[IsFacets],[IsUseInSearch],[IsPersonalizable],[IsConfigurable],[AttributeName],  
		[LocaleId],[DisplayOrder],[DefaultValueDisplayOrder],[AttributeDefaultValue] )  
		EXEC Znode_GetPublishProductAttribute @PublishCatalogId   
     
		INSERT INTO ZnodePublishCatalogAttributeEntity  
		(VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition,IsComparable,  
		IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,  
		AttributeName,LocaleId,DisplayOrder,SELECTValues)  
		SELECT Distinct   
		B.VersionId, A.[ZnodeCatalogId],A.[AttributeCode],A.[AttributeTypeName],0 IsPromoRuleCondition,[IsComparable],  
		[IsHtmlTags],[IsFacets],[IsUseInSearch],[IsPersonalizable],[IsConfigurable],  
		[AttributeName],A.[LocaleId],[DisplayOrder] ,  
		(SELECT Isnull(IA.AttributeDefaultValue,'') Value , Isnull(IA.[DefaultValueDisplayOrder],'') DisplayOrder    
		from [dbo].[#CatalogAttributeDetails] IA  WHERE IA.AttributeCode = A.AttributeCode AND IA.LocaleId = A.LocaleId   
		For JSON PATH)  
		FROM [dbo].[#CatalogAttributeDetails] A INNER JOIN #Tbl_NewVersionEntity B on A.LocaleId = B.LocaleId  
   
		SET @Status =1   
    
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'CatalogAttributeaDetail', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =60,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
     
  
	END TRY   
	BEGIN CATCH   
		SET @Status   = 0   
     
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'CatalogAttributeaDetail', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		IF @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END CATCH    
	END   
  
	IF @Type = 'ZnodePublishSEOEntity' OR @Type = ''  
	BEGIN  
		EXEC [Znode_SetPublishSEOEntity]  
		@RevisionState = @RevisionState   
		,@CMSSEOTypeId  = '1,2'   
		,@UserId  = @UserId   
		,@Status  = @Status  OUTPUT   
		,@IsCatalogPublish = 1    
		,@VersionIdString  = @VersionIdString   
		,@IsPreviewEnable  = @IsPreviewEnable   
     
   
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishSEOEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =70,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
  
		If @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
  
	END   
  
	IF EXISTS (SELECT TOP 1 1  FROM ZnodePublishCatalogErrorLogEntity WHERE  ProcessStatus = 'Fail')   
	BEGIN  
    
		SET @Status  =0   
		SELECT 1 AS ID,@Status AS Status;  
		INSERT INTO ZnodePublishCatalogErrorLogEntity  
		(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishPortalEntity', @RevisionState , 'Fail' , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
     
		--EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = @PublishCatalogId,@UserId = @UserId , @IsRevertPublish = 0 ,  
		--@NewGUID =@NewGUID   
  
		UPDATE ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed(),  
		IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0, ModifiedDate = Getdate()  
		WHERE PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()
		
		UPDATE ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed(),  
		IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0  
		, ModifiedDate = Getdate()  
		WHERE PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()
		Return 0   
	END  
  
	SET @Status = 1  
  
    
	SELECT @PublishCatalogId AS id,@Status AS Status;     
END  
END TRY   
BEGIN CATCH   
	SET @Status =0    
	SELECT 1 AS ID,@Status AS Status;     
   
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	@ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity   
	@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))  
	+',@PreviewVersionId = ' + CAST(@PreviewVersionId  AS VARCHAR(20))  
	+',@ProductionVersionId = ' + CAST(@ProductionVersionId  AS VARCHAR(20))  
	+',@RevisionState = ''' + CAST(@RevisionState  AS VARCHAR(50))  
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20)); SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
   
     
	INSERT INTO ZnodePublishCatalogErrorLogEntity  
	(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
	SELECT 'Znode_PublishCatalogEntity', @RevisionState + isnull(@ErrorMessage,'') , 'Fail' , Getdate(),   
	@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
   
	EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = @PublishCatalogId,@UserId = @UserId , @IsRevertPublish = 0 ,  
	@NewGUID =@NewGUID   
  
	UPDATE ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed(),  
	IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0 , ModifiedDate = Getdate()   WHERE  PublishCatalogLogId in   
	(SELECT VersionId FROM #Tbl_NewVersionEntity WHERE PublishType = 'PREVIEW' )  
	UPDATE ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed() ,  
	IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0 , ModifiedDate = Getdate() WHERE  PublishCatalogLogId in  
	(SELECT VersionId FROM #Tbl_NewVersionEntity WHERE PublishType = 'PRODUCTION' )  
                        
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_PublishCatalogEntity',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_SetPublishSEOEntity')
	DROP PROC Znode_SetPublishSEOEntity
GO

CREATE PROCEDURE [dbo].[Znode_SetPublishSEOEntity]
(
   @PortalId  INT = 0 
  ,@LocaleId  INT = 0 
  ,@IsPreviewEnable int = 0 
  ,@PreviewVersionId INT = 0 
  ,@ProductionVersionId INT = 0 
  ,@RevisionState varchar(50) = '' 
  ,@CMSSEOTypeId varchar(500) = '' 
  ,@CMSSEOCode varchar(300) = ''
  ,@UserId int = 0 
  ,@Status int OUTPUT 
  ,@IsCatalogPublish bit = 0 
  ,@VersionIdString varchar(2000) = ''
  ,@IsSingleProductPublish bit = 0 
)
AS
/*
    This Procedure is used to publish the SEO details
  
	EXEC ZnodeSetPublishSEOEntity 1 2,3
	A. 
		1. Preview - Preview
		2. None    - Production   --- 
		3. Production - Preview/Production
	B.
		select * from ZnodePublishStateApplicationTypeMapping
		select * from ZnodePublishState where PublishStateId in (3,4) 
		select * from ZnodePublishPortalLog 
	C.
		Select * from ZnodePublishState where IsDefaultContentState = 1  and IsContentState = 1  --Production 
    
	Unit testing 
	
	Exec [ZnodeSetPublishSEOEntity]
	   @PortalId  = 1 
	  ,@LocaleId  = 0 
	  ,@PreviewVersionId = 0 
	  ,@ProductionVersionId = 0 
	  ,@RevisionState = 'Preview/Production' 
	  ,@CMSSEOTypeId = 0
	  ,@CMSSEOCode = ''
	  ,@UserId = 0 

	 Exec [ZnodeSetPublishSEOEntity]
   @PortalId  = 1 
  ,@LocaleId  = 0 
  ,@PreviewVersionId = 0 
  ,@ProductionVersionId = 0 
  ,@RevisionState = 'Preview&Production' 
  ,@CMSSEOTypeId = 3
  ,@CMSSEOCode = ''
  ,@UserId = 0 




	
	*/
BEGIN 
BEGIN TRY 
SET NOCOUNT ON
   Begin 
		DECLARE @Tbl_PreviewVersionId    TABLE    (PreviewVersionId int , PortalId int , LocaleId int)
		DECLARE @Tbl_ProductionVersionId TABLE    (ProductionVersionId int  , PortalId int , LocaleId int)
		If (@IsCatalogPublish = 0  AND @IsSingleProductPublish = 0 )
		Begin
			If @PreviewVersionId = 0 
				Begin
   					Insert into @Tbl_PreviewVersionId 
					SELECT distinct VersionId , PortalId, LocaleId from  ZnodePublishWebStoreEntity where (PortalId = @PortalId or @PortalId=0 ) and  (LocaleId = 	@LocaleId OR @LocaleId = 0  ) and PublishState ='PREVIEW'
				end
			Else 
					Insert into @Tbl_PreviewVersionId SELECT distinct VersionId , PortalId, LocaleId from  ZnodePublishWebStoreEntity 
					where VersionId = @PreviewVersionId
			If @ProductionVersionId = 0 
   				Begin
					Insert into @Tbl_ProductionVersionId 
					SELECT distinct VersionId , PortalId , LocaleId from  ZnodePublishWebStoreEntity where (PortalId = @PortalId or @PortalId=0 ) and  (LocaleId = 	@LocaleId OR @LocaleId = 0  ) and PublishState ='PRODUCTION'
				End 
			Else 
				Insert into @Tbl_ProductionVersionId SELECT distinct VersionId , PortalId, LocaleId from  ZnodePublishWebStoreEntity 
				where VersionId = @ProductionVersionId
 		End
		--Else if (@IsCatalogPublish= 1  AND @IsSingleProductPublish = 0 )
		--Begin
		--	 IF OBJECT_ID('tempdb..#VesionIds') is not null
		--		DROP TABLE #VesionIds
  				 
		--	 SELECT PV.* into #VesionIds FROM ZnodePublishVersionEntity PV Inner join Split(@VersionIdString,',') S ON PV.VersionId = S.Item
		--End

		IF OBJECT_ID('tempdb..#VesionIds') is not null
				DROP TABLE #VesionIds
  				 
			 SELECT PV.* into #VesionIds FROM ZnodePublishVersionEntity PV Inner join Split(@VersionIdString,',') S ON PV.VersionId = S.Item
		
		DECLARE @SetLocaleId INT , @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleId(), @MaxCount INT =0 , @IncrementalId INT = 1  
		DECLARE @TBL_Locale TABLE (LocaleId INT , RowId INT IDENTITY(1,1))
		CREATE TABLE #TBL_SEO  
		(
			ItemName varchar(50),CMSSEODetailId int ,CMSSEODetailLocaleId int ,CMSSEOTypeId int ,SEOId int ,SEOTypeName varchar(50),SEOTitle nvarchar(Max)
			,SEODescription nvarchar(Max),
			SEOKeywords nvarchar(Max),SEOUrl nvarchar(Max) ,IsRedirect bit ,MetaInformation nvarchar(Max) ,LocaleId int ,
			OldSEOURL nvarchar(Max),CMSContentPagesId int ,PortalId int ,SEOCode varchar(300) ,CanonicalURL varchar(200),RobotTag varchar(50)
		)
		
		BEGIN 
			INSERT INTO @TBL_Locale (LocaleId) SELECT LocaleId FROM ZnodeLocale WHERE IsActive =1 AND (LocaleId  = @LocaleId OR @LocaleId = 0 )
			
			SET @MaxCount = ISNULL((SELECT MAx(RowId) FROM @TBL_Locale),0)
			WHILE @IncrementalId <= @MaxCount
			BEGIN 
				SET @SetLocaleId = (SELECT Top 1 LocaleId FROM @TBL_locale WHERE RowId = @IncrementalId)
				IF @IsSingleProductPublish = 0
				Begin
					;With Cte_GetCMSSEODetails AS 
					(
							select CT.Name ItemName,CD.CMSSEODetailId, CDL.CMSSEODetailLocaleId ,  CD.CMSSEOTypeId ,
									 CD.SEOId ,CDL.SEOTitle,CDL.SEODescription,
									 CDL.SEOKeywords,Lower(CD.SEOUrl) SEOUrl,CD.IsRedirect,CD.MetaInformation,
									 CDL.LocaleId,
									 NULL OldSEOURL, 
									 NULL CMSContentPagesId,CD.PortalId, CD.seoCode,CDL.CanonicalURL,CDL.RobotTag
									 from ZnodeCMSSEODetail CD 
									 INNER JOIN ZnodeCMSSEOType CT ON CD.CMSSEOTypeId = CT.CMSSEOTypeId 
									 INNER JOIN ZnodeCMSSEODetailLocale CDL ON CD.CMSSEODetailId = CDL.CMSSEODetailId 
									 WHERE (CDL.LocaleId = @SetLocaleId OR CDL.LocaleId = @DefaultLocaleId)  
									 AND (CD.PortalId = @PortalId  OR @PortalId  = 0 ) 
									 AND (Isnull(CD.SEOCode ,'') = @CMSSEOCode OR @CMSSEOCode = '' )
									 AND (Exists  (SELECT TOP 1 1 FROM dbo.Split(@CMSSEOTypeId ,',') SP WHERE SP.Item = CD.CMSSEOTypeId ) )
									union all
									select CT.Name ItemName,CD.CMSSEODetailId, CDL.CMSSEODetailLocaleId ,  CD.CMSSEOTypeId ,
										 CD.SEOId ,CDL.SEOTitle,CDL.SEODescription,
										 CDL.SEOKeywords,Lower(CD.SEOUrl) SEOUrl,CD.IsRedirect,CD.MetaInformation,
										 CDL.LocaleId,
										 NULL OldSEOURL, 
										 NULL CMSContentPagesId,ZPB.PortalId, CD.seoCode,CDL.CanonicalURL,CDL.RobotTag
										 from ZnodeCMSSEODetail CD 
										 INNER JOIN ZnodeCMSSEOType CT ON CD.CMSSEOTypeId = CT.CMSSEOTypeId 
										 INNER JOIN ZnodeCMSSEODetailLocale CDL ON CD.CMSSEODetailId = CDL.CMSSEODetailId
										 INNER JOIN ZnodeBrandDetails ZBD ON CD.SeoCode = ZBD.BrandCode
										 INNER JOIN ZnodePortalBrand ZPB ON ZBD.BrandId = ZPB.BrandId
										 WHERE (CDL.LocaleId = @SetLocaleId OR CDL.LocaleId = @DefaultLocaleId)  
										 AND (ZPB.PortalId = @PortalId  OR @PortalId  = 0 ) 
										 AND (Isnull(CD.SEOCode ,'') = @CMSSEOCode OR @CMSSEOCode = '' )
										 AND (Exists  (SELECT TOP 1 1 FROM dbo.Split(@CMSSEOTypeId ,',') SP WHERE SP.Item = CD.CMSSEOTypeId ) )
										 AND CT.Name = 'Brand' 
										 AND @IsCatalogPublish = 0
									 Union All 
									 select CT.Name ItemName,CD.CMSSEODetailId, CDL.CMSSEODetailLocaleId ,  CD.CMSSEOTypeId ,
								 CD.SEOId ,CDL.SEOTitle,CDL.SEODescription,
								 CDL.SEOKeywords,Lower(CD.SEOUrl) SEOUrl,CD.IsRedirect,CD.MetaInformation,
								 CDL.LocaleId,
								 NULL OldSEOURL, 
								 NULL CMSContentPagesId,ZPB.PortalId, CD.seoCode,CDL.CanonicalURL,CDL.RobotTag
								 from ZnodeCMSSEODetail CD 
								 INNER JOIN ZnodeCMSSEOType CT ON CD.CMSSEOTypeId = CT.CMSSEOTypeId 
								 INNER JOIN ZnodeCMSSEODetailLocale CDL ON CD.CMSSEODetailId = CDL.CMSSEODetailId 
								 INNER JOIN ZnodeBrandDetails ZBD ON CD.SeoCode = ZBD.BrandCode
								 INNER JOIN ZnodePortalBrand ZPB ON ZBD.BrandId = ZPB.BrandId
								 WHERE (CDL.LocaleId = @SetLocaleId OR CDL.LocaleId = @DefaultLocaleId)  
								 AND (Isnull(CD.SEOCode ,'') = @CMSSEOCode OR @CMSSEOCode = '' )
								 AND (CT.Name = 'Brand' ) 
								 AND @IsCatalogPublish= 1 
					)
					, Cte_GetFirstCMSSEODetails  AS
					(
						SELECT 
							ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
							SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation, LocaleId ,OldSEOURL,CMSContentPagesId,
							PortalId,SEOCode,CanonicalURL,RobotTag	
						FROM Cte_GetCMSSEODetails 
						WHERE LocaleId = @SetLocaleId
					)
					, Cte_GetDefaultFilterData AS
					(
						SELECT 
							ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
							SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,
							PortalId,SEOCode,CanonicalURL,RobotTag	  FROM  Cte_GetFirstCMSSEODetails 
						UNION ALL 
						SELECT 
							ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
							SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,
							PortalId,SEOCode,CanonicalURL,RobotTag	 FROM Cte_GetCMSSEODetails CTEC 
						WHERE LocaleId = @DefaultLocaleId 
						AND NOT EXISTS (SELECT TOP 1 1 FROM Cte_GetFirstCMSSEODetails CTEFD WHERE CTEFD.CMSSEOTypeId = CTEC.CMSSEOTypeId 
						and CTEFD.seoCode = CTEC.seoCode )
					)
	
					INSERT INTO #TBL_SEO (ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
					SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,
					PortalId,SEOCode,CanonicalURL,RobotTag)
					SELECT 
						ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
						SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,@SetLocaleId,OldSEOURL,CMSContentPagesId,
						PortalId,SEOCode,CanonicalURL,RobotTag	
					FROM Cte_GetDefaultFilterData  A 

					End 
					Else If @IsSingleProductPublish = 1  
						INSERT INTO #TBL_SEO (ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
						SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,
						PortalId,SEOCode,CanonicalURL,RobotTag)
							SELECT CT.Name ItemName,CD.CMSSEODetailId, CDL.CMSSEODetailLocaleId ,  CD.CMSSEOTypeId ,
							CD.SEOId ,CDL.SEOTitle,CDL.SEODescription,
							CDL.SEOKeywords,Lower(CD.SEOUrl) SEOUrl,CD.IsRedirect,CD.MetaInformation,
							CDL.LocaleId,
							NULL OldSEOURL, 
							NULL CMSContentPagesId,CD.PortalId, CD.seoCode,CDL.CanonicalURL,CDL.RobotTag
							from ZnodeCMSSEODetail CD 
							INNER JOIN ZnodeCMSSEOType CT ON CD.CMSSEOTypeId = CT.CMSSEOTypeId 
							INNER JOIN ZnodeCMSSEODetailLocale CDL ON CD.CMSSEODetailId = CDL.CMSSEODetailId 
							WHERE (CDL.LocaleId = @LocaleId )  
							AND (CD.PortalId = @PortalId  ) 
							AND (Isnull(CD.SEOCode ,'') = @CMSSEOCode OR @CMSSEOCode = '' )
							AND (Exists  (SELECT TOP 1 1 FROM dbo.Split(@CMSSEOTypeId ,',') SP WHERE SP.Item = CD.CMSSEOTypeId ) )

				SET @IncrementalId = @IncrementalId +1 
			END 
		End 
		End			

	If @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%' OR  @RevisionState like '%Production%')  AND @IsSingleProductPublish = 0
	Begin
	    --Data inserted into flat table ZnodePublishSeoEntity (Replica of MongoDB Collection )  
		Delete from ZnodePublishSeoEntity where PortalId = @PortalId  and VersionId  in (Select PreviewVersionId  from @TBL_PreviewVersionId ) 
		AND (SEOCode = @CMSSEOCode OR @CMSSEOCode = '' )
		AND (Exists  (SELECT TOP 1 1 FROM dbo.Split(@CMSSEOTypeId ,',') SP WHERE SP.Item = CMSSEOTypeId ) )
		AND @IsCatalogPublish= 0   
		

		If @IsCatalogPublish= 0
		BEGIN
			UPDATE C SET C.ElasticSearchEvent = 2 
			FROM ZnodePublishSeoEntity C
			WHERE NOT EXISTS(SELECT * FROM #TBL_SEO A
				Inner join @TBL_PreviewVersionId B on A.LocaleId = B.LocaleId AND A.LocaleId = B.LocaleId
				WHERE B.PreviewVersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId 
							AND A.PortalId = C.PortalId AND A.SEOCode = C.SEOCode)
			AND c.VersionId in (Select Item from Split(@VersionIdString,','))

			UPDATE C SET C.ItemName = A.ItemName ,
				C.SEOTypeName = A.ItemName,C.SEOTitle = A.SEOTitle,C.SEODescription = A.SEODescription,C.SEOKeywords=A.SEOKeywords,C.SEOUrl = A.SEOUrl,
				C.IsRedirect=A.IsRedirect,C.MetaInformation = A.MetaInformation,C.OldSEOURL = A.OldSEOURL,
				C.CanonicalURL = A.CanonicalURL,C.RobotTag = A.RobotTag, C.ElasticSearchEvent = 1
			FROM #TBL_SEO A 
			Inner join @TBL_PreviewVersionId B on A.LocaleId = B.LocaleId AND A.LocaleId = B.LocaleId 
			INNER JOIN ZnodePublishSeoEntity C ON B.PreviewVersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId 
						AND A.PortalId = C.PortalId AND A.SEOCode = C.SEOCode
			AND c.VersionId in (Select Item from Split(@VersionIdString,','))

			Insert Into ZnodePublishSeoEntity 
			(
				VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
				SEOTypeName,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL
				,CMSContentPagesId,	PortalId,SEOCode,CanonicalURL,RobotTag, ElasticSearchEvent
			)
			SELECT B.PreviewVersionId , Getdate(), ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
				ItemName,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,A.LocaleId,OldSEOURL,Isnull(CMSContentPagesId,0),
				A.PortalId,SEOCode,CanonicalURL,RobotTag, 1 AS ElasticSearchEvent
			FROM #TBL_SEO A Inner join @TBL_PreviewVersionId B on A.LocaleId = B.LocaleId AND A.LocaleId = B.LocaleId
			WHERE NOT EXISTS(SELECT * FROM ZnodePublishSeoEntity C WHERE B.PreviewVersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId AND A.PortalId = C.PortalId)

		END

		If @IsCatalogPublish= 1
		BEGIN
			UPDATE C SET C.ElasticSearchEvent = 2 
			FROM ZnodePublishSeoEntity C
			WHERE NOT EXISTS(SELECT * FROM #TBL_SEO A
				Inner join #VesionIds B on A.LocaleId = B.LocaleId AND B.RevisionType = 'PREVIEW'
				WHERE B.VersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId 
							AND A.PortalId = C.PortalId AND A.SEOCode = C.SEOCode)
			AND c.VersionId in (Select Item from Split(@VersionIdString,','))

			UPDATE C SET C.ItemName = A.ItemName ,
				C.SEOTypeName = A.ItemName, C.SEOTitle = A.SEOTitle,C.SEODescription = A.SEODescription,C.SEOKeywords=A.SEOKeywords,C.SEOUrl = A.SEOUrl,
				C.IsRedirect=A.IsRedirect,C.MetaInformation = A.MetaInformation,C.OldSEOURL = A.OldSEOURL,
				C.CanonicalURL = A.CanonicalURL,C.RobotTag = A.RobotTag, C.ElasticSearchEvent = 1
			FROM #TBL_SEO A 
			Inner join #VesionIds B on A.LocaleId = B.LocaleId AND B.RevisionType = 'PREVIEW' 
			INNER JOIN ZnodePublishSeoEntity C ON B.VersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId 
						AND A.PortalId = C.PortalId AND A.SEOCode = C.SEOCode
			AND c.VersionId in (Select Item from Split(@VersionIdString,','))

			Insert Into ZnodePublishSeoEntity 
			(
				VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
				SEOTypeName,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL
				,CMSContentPagesId,	PortalId,SEOCode,CanonicalURL,RobotTag, ElasticSearchEvent	
			)
			SELECT B.VersionId , Getdate(), ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
				ItemName,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,A.LocaleId,OldSEOURL,Isnull(CMSContentPagesId,0),
				A.PortalId,SEOCode,CanonicalURL,RobotTag, 1 AS ElasticSearchEvent
			FROM #TBL_SEO A Inner join #VesionIds B on A.LocaleId = B.LocaleId AND B.RevisionType = 'PREVIEW'
			WHERE NOT EXISTS(SELECT * FROM ZnodePublishSeoEntity C WHERE B.VersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId AND A.PortalId = C.PortalId)

		END
	End

	-------------------------- End Preview 
	If (@RevisionState like '%Production%' OR @RevisionState = 'None') and @IsSingleProductPublish = 0
	Begin
		-- Only production version id will process 
		Delete from ZnodePublishSeoEntity where PortalId = @PortalId  and VersionId in (Select ProductionVersionId from  @TBL_ProductionVersionId ) 
		AND (SEOCode = @CMSSEOCode OR @CMSSEOCode = '' )
		AND (Exists  (SELECT TOP 1 1 FROM dbo.Split(@CMSSEOTypeId ,',') SP WHERE SP.Item = CMSSEOTypeId ) )
		AND @IsCatalogPublish= 0  
		AND EXISTS(SELECT * FROM #VesionIds V WHERE V.VersionId = ZnodePublishSeoEntity.VersionId)

		If @IsCatalogPublish= 0 		
		BEGIN
			UPDATE C SET C.ElasticSearchEvent = 2 
			FROM ZnodePublishSeoEntity C
			WHERE NOT EXISTS(SELECT * FROM #TBL_SEO A
				INNER JOIN @TBL_ProductionVersionId B on A.PortalId = B.PortalId and A.LocaleId = B.LocaleId 
				WHERE B.ProductionVersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId 
							AND A.PortalId = C.PortalId AND A.SEOCode = C.SEOCode)
			AND c.VersionId in (Select Item from Split(@VersionIdString,','))

			UPDATE C SET ItemName = A.ItemName ,
				SEOTypeName = A.ItemName,SEOTitle = A.SEOTitle,SEODescription = A.SEODescription,SEOKeywords=A.SEOKeywords,SEOUrl = A.SEOUrl,
				IsRedirect=A.IsRedirect,MetaInformation = A.MetaInformation,OldSEOURL = A.OldSEOURL,
				CanonicalURL = A.CanonicalURL,RobotTag = A.RobotTag, C.ElasticSearchEvent = 1
			FROM #TBL_SEO A 
			INNER JOIN @TBL_ProductionVersionId B on A.PortalId = B.PortalId and A.LocaleId = B.LocaleId 
			INNER JOIN ZnodePublishSeoEntity C ON B.ProductionVersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId 
						AND A.PortalId = C.PortalId AND A.SEOCode = C.SEOCode
			AND c.VersionId in (Select Item from Split(@VersionIdString,','))

			Insert Into ZnodePublishSeoEntity 
			(
				VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
				SEOTypeName,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL
				,CMSContentPagesId,	PortalId,SEOCode,CanonicalURL,RobotTag, ElasticSearchEvent
			)
			SELECT B.ProductionVersionId , Getdate(), ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
				ItemName,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,A.LocaleId,OldSEOURL,Isnull(CMSContentPagesId,0),
				A.PortalId,SEOCode,CanonicalURL,RobotTag, 1 AS ElasticSearchEvent
			FROM #TBL_SEO A Inner join @TBL_ProductionVersionId B on A.PortalId = B.PortalId and A.LocaleId = B.LocaleId
			WHERE NOT EXISTS(SELECT * FROM ZnodePublishSeoEntity C WHERE B.ProductionVersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId AND A.PortalId = C.PortalId)
		END
	   If @IsCatalogPublish= 1 		
	   BEGIN
			UPDATE C SET C.ElasticSearchEvent = 2 FROM ZnodePublishSeoEntity C
			WHERE NOT EXISTS(SELECT * FROM #TBL_SEO A
				INNER JOIN @TBL_ProductionVersionId B on A.PortalId = B.PortalId and A.LocaleId = B.LocaleId 
				WHERE B.ProductionVersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId 
							AND A.PortalId = C.PortalId AND A.SEOCode = C.SEOCode)
			AND c.VersionId in (Select Item from Split(@VersionIdString,','))

			UPDATE C SET C.ItemName = A.ItemName ,
				C.SEOTypeName = A.ItemName,C.SEOTitle = A.SEOTitle,C.SEODescription = A.SEODescription,C.SEOKeywords=A.SEOKeywords,C.SEOUrl = A.SEOUrl,
				C.IsRedirect = A.IsRedirect,C.MetaInformation = A.MetaInformation, C.OldSEOURL = A.OldSEOURL,
				C.CanonicalURL = A.CanonicalURL, C.RobotTag = A.RobotTag, C.ElasticSearchEvent = 1
			FROM #TBL_SEO A 
			INNER JOIN #VesionIds B on A.LocaleId = B.LocaleId AND B.RevisionType = 'PRODUCTION'
			INNER JOIN ZnodePublishSeoEntity C ON B.VersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId 
						AND A.PortalId = C.PortalId AND A.SEOCode = C.SEOCode
			AND c.VersionId in (Select Item from Split(@VersionIdString,','))

			Insert Into ZnodePublishSeoEntity 
			(
				VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
				SEOTypeName,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL
				,CMSContentPagesId,	PortalId,SEOCode,CanonicalURL,RobotTag	,ElasticSearchEvent
			)
			SELECT B.VersionId , Getdate(), ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
				ItemName,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,A.LocaleId,OldSEOURL,Isnull(CMSContentPagesId,0),
				A.PortalId,SEOCode,CanonicalURL,RobotTag, 1 AS ElasticSearchEvent
			FROM #TBL_SEO A Inner join #VesionIds B on A.LocaleId = B.LocaleId AND B.RevisionType = 'PRODUCTION'
			WHERE NOT EXISTS(SELECT * FROM ZnodePublishSeoEntity C WHERE B.VersionId = C.VersionId AND A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId AND A.PortalId = C.PortalId)
		END
	
	End

	--Single Product Publish 
	If @IsSingleProductPublish =1  
	Begin
			Delete from ZnodePublishSeoEntity where PortalId = @PortalId  and VersionId in (Select Item from Split(@VersionIdString,',')) 
			AND (SEOCode = @CMSSEOCode OR @CMSSEOCode = '' )
			AND (Exists  (SELECT TOP 1 1 FROM dbo.Split(@CMSSEOTypeId ,',') SP WHERE SP.Item = CMSSEOTypeId ) )
			AND EXISTS(SELECT * FROM #VesionIds V WHERE V.VersionId = ZnodePublishSeoEntity.VersionId)

			UPDATE C SET ItemName = A.ItemName ,
				SEOTypeName = A.ItemName,SEOTitle = A.SEOTitle,SEODescription = A.SEODescription,SEOKeywords=A.SEOKeywords,SEOUrl = A.SEOUrl,
				IsRedirect=A.IsRedirect,MetaInformation = A.MetaInformation,OldSEOURL = A.OldSEOURL,
				CanonicalURL = A.CanonicalURL,RobotTag = A.RobotTag
			FROM #TBL_SEO A 
			INNER JOIN ZnodePublishSeoEntity C ON A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId 
						AND A.PortalId = C.PortalId AND A.SEOCode = C.SEOCode
			AND EXISTS(SELECT * FROM #VesionIds V WHERE V.VersionId = C.VersionId)
		
			Insert Into ZnodePublishSeoEntity 
			(
				VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
				SEOTypeName,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL
				,CMSContentPagesId,	PortalId,SEOCode,CanonicalURL,RobotTag	
			)
			SELECT (Select Item from Split(@VersionIdString,',')), Getdate(), ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,
				ItemName,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,@LocaleId,OldSEOURL,Isnull(CMSContentPagesId,0),
				A.PortalId,SEOCode,CanonicalURL,RobotTag
			FROM #TBL_SEO A 
			WHERE NOT EXISTS(SELECT * FROM ZnodePublishSeoEntity C WHERE A.CMSSEODetailId = C.CMSSEODetailId AND A.LocaleId = C.LocaleId AND A.PortalId = C.PortalId)
		
	end 

	If (@RevisionState = 'Preview'  )
		Update B SET PublishStateId = (select dbo.Fn_GetPublishStateIdForPreview()) , ISPublish = 1 
		from #TBL_SEO  A inner join ZnodeCMSSEODetail B  ON A.CMSSEODetailId  = B.CMSSEODetailId
	else If (@RevisionState = 'Production'  Or @RevisionState = 'None' )
		Update B SET PublishStateId = (select dbo.Fn_GetPublishStateIdForPublish()) , ISPublish = 1 
		from #TBL_SEO  A inner join ZnodeCMSSEODetail B  ON A.CMSSEODetailId  = B.CMSSEODetailId

	SET @Status =1 
END TRY 
BEGIN CATCH 
	SET @Status =0  
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
	@ErrorCall NVARCHAR(MAX)= 'EXEC ZnodeSetPublishSEOEntity 
	@PortalId = '+CAST(@PortalId AS VARCHAR	(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))
	+',@PreviewVersionId = ' + CAST(@PreviewVersionId  AS varchar(20))
	+',@ProductionVersionId = ' + CAST(@ProductionVersionId  AS varchar(20))
	+',@RevisionState = ''' + CAST(@RevisionState  AS varchar(50))
	+''',@CMSSEOTypeId= ' + CAST(@CMSSEOTypeId  AS varchar(20))
	+',@UserId = ' + CAST(@UserId AS varchar(20))
	+',@CMSSEOCode  = ''' + CAST(@CMSSEOCode  AS varchar(20)) + '''';
	        			 
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'ZnodeSetPublishSEOEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;

END CATCH
END

GO

INSERT INTO ZnodeActions ( AreaName, ControllerName, ActionName, IsGlobalAccess, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate) 
SELECT
NULL, 'SearchConfiguration', 'IsSynonymCodeExists', 0,2,Getdate(), 2, Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'SearchConfiguration' AND ActionName = 'IsSynonymCodeExists')

INSERT INTO ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate)
SELECT
(SELECT top 1 MenuId FROM ZnodeMenu WHERE MenuName='Site Search' AND ControllerName = 'SearchReport'),
(SELECT top 1 ActionId FROM ZnodeActions WHERE ControllerName='SearchConfiguration' AND  ActionName='IsSynonymCodeExists'),
1,2,Getdate(), 2, Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId =
(SELECT top 1 MenuId FROM ZnodeMenu WHERE MenuName='Site Search'AND ControllerName = 'SearchReport') AND ActionId =
(SELECT top 1 ActionId FROM ZnodeActions WHERE ControllerName='SearchConfiguration' AND  ActionName='IsSynonymCodeExists'))

INSERT INTO ZnodeActionMenu (MenuId, ActionId, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate) 
SELECT
(SELECT top 1 MenuId FROM ZnodeMenu WHERE MenuName='Site Search'AND ControllerName = 'SearchReport'),
(SELECT top 1 ActionId FROM ZnodeActions WHERE ControllerName='SearchConfiguration' AND  ActionName='IsSynonymCodeExists'),
2,Getdate(), 2, Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActionMenu WHERE MenuId =
(SELECT top 1 MenuId FROM ZnodeMenu WHERE MenuName='Site Search') AND ActionId =
(SELECT top 1 ActionId FROM ZnodeActions WHERE ControllerName='SearchConfiguration' AND  ActionName='IsSynonymCodeExists'))

GO

update ZnodeMenuActionsPermission set MenuId=(select Top 1 MenuId from ZnodeMenu where MenuName='Orders') where ActionId=(select Top 1 ActionId from ZnodeActions where ActionName='FailedOrderTransactionList' AND ControllerName='Customer');
update ZnodeActionMenu set MenuId= (select Top 1 MenuId from ZnodeMenu where MenuName='Orders') where ActionId=(select Top 1 ActionId from ZnodeActions where ActionName='FailedOrderTransactionList' AND ControllerName='Customer');
update ZnodeActions set ControllerName='Order' where ActionName='FailedOrderTransactionList' AND ControllerName='Customer';

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'AccountId' AND Object_ID = Object_ID(N'dbo.ZnodeOmsOrderDetails'))
BEGIN
	ALTER TABLE ZnodeOmsOrderDetails ADD [AccountId] INT NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'AccountId' AND Object_ID = Object_ID(N'dbo.ZnodeOmsQuote'))
BEGIN
	ALTER TABLE ZnodeOmsQuote ADD [AccountId] INT NULL;
END

GO

Update ZnodeApplicationSetting
Set Setting ='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>UserId</name><headertext>Checkbox</headertext><width>40</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield>UserId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>FullName</name><headertext>Full Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Full Name</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>UserName</name><headertext>Username</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>User Name</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>Email</name><headertext>Email ID</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Email Id</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>RoleName</name><headertext>Role Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Phone Number</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>DepartmentName</name><headertext>Department</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Phone Number</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>Manage</name><headertext>Pending Order History</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>View</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>View</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/Account/AccountQuoteList</manageactionurl><manageparamfield>UserId,AccountId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>grid-action</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>Manage</name><headertext>Order History</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>View</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>View</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/Account/AccountUserOrderList</manageactionurl><manageparamfield>UserId,AccountId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>grid-action</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>9</id><name>Manage</name><headertext>Action</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>Manage|Disable</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Manage|Disable</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/Customer/CustomerEdit|/User/CustomerEnableDisableAccount</manageactionurl><manageparamfield>UserId|UserId,IsLock|UserId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>grid-action</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>10</id><name>LastName</name><headertext>Last Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Last Name</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>11</id><name>IsLock</name><headertext>Is Lock</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Is Lock</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>12</id><name>AccountId</name><headertext>User ID</headertext><width>40</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Is Lock</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName='ZnodeAccountsCustomer'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetOmsAccountOrderList')
	DROP PROC Znode_GetOmsAccountOrderList
GO

CREATE PROCEDURE [dbo].[Znode_GetOmsAccountOrderList]  
(
	@WhereClause NVARCHAR(MAX),  
	@Rows        INT           = 100,  
	@PageNo      INT           = 1,  
	@Order_BY    VARCHAR(100)  = '',  
	@RowsCount   INT OUT,  
	@AccountId   INT
)
AS
 /*  
  Summary :- This procedure is used to get the Quote list of account and Users   
    Fn_GetRecurciveAccounts is used to fetch AccountId and Its recursive ParentId   
    The result id fetched on the basis of AccountId of the User  
     Unit Testing    
     EXEC Znode_GetOmsAccountOrderList '' ,@RowsCount = 0 ,@AccountId = 1  
   
*/  
BEGIN  
    BEGIN TRY  
	SET NOCOUNT ON;  
    DECLARE @SQL NVARCHAR(MAX);  
  
    DECLARE @TBL_QuoteDetails TABLE (OmsOrderId INT,UserName NVARCHAR(300),OrderAmount NUMERIC(28, 6),[Status] VARCHAR(300),CreatedDate DATETIME,OmsPaymentStateId INT,OmsPaymentState NVARCHAR(MAX),  
            PaymentTypeId INT,PaymentType VARCHAR(50),OrderNumber VARCHAR(200),IsInRMA BIT ,RowId INT,CountNo INT,CurrencyCode VARCHAR(100),PaymentDisplayName Nvarchar(1200),CultureCode VARCHAR(100)
			,PortalId INT, UserId INT);
              
    SET @Order_BY = REPLACE(@Order_BY,'OmsOrderId','CTEQD.OmsOrderId')  
    SET @SQL = '  

	IF OBJECT_ID(''tempdb..#GetAccounts'') IS NOT NULL
    DROP TABLE #GetAccounts

	SELECT * INTO #GetAccounts FROM [dbo].[Fn_GetRecurciveAccounts]('+CAST(@AccountId AS VARCHAR(100))+')
  
   ;With Cte_GetQuoteDetail AS   
   (  
  
   SELECT Zu.UserId ,ZOO.OmsOrderId,APZU.UserName UserName ,Total  OrderTotal , ZOOS.OrderStateName OrderState  
    ,ZOOD.OrderDate ,ZOPS.OmsPaymentStateId,ZOPS.Name PaymentStatus  ,ZOOD.PaymentTypeId , ZPT.Name PaymentType,ZOO.OrderNumber,ZOOD.CurrencyCode  
    ,CASE WHEN ARJT.PaymentDisplayName IS NULL THEN ZPS.PaymentDisplayName ELSE  ARJT.PaymentDisplayName END PaymentDisplayName ,ZOOD.CultureCode 
	,ZOOD.PortalId
   FROM ZnodeOmsOrder ZOO  
   INNER JOIN ZnodeOmsOrderDetails ZOOD ON (ZOOD.OmsOrderId = ZOO.OmsOrderId AND ZOOD.IsActive = 1 )  
   LEFT JOIN ZnodePaymentSetting ZPS ON (ZPS.PaymentSettingId = ZOOD.PaymentSettingId)  
   INNER JOIN ZnodeUser ZU ON (ZU.UserId = ZOOD.UserId)  
   LEFT JOIN ZnodeOmsPaymentState ZOPS ON (ZOPS.OmsPaymentStateId = ZOOD.OmsPaymentStateId )  
   LEFT JOIN ZnodeOmsOrderState ZOOS ON (ZOOS.OmsOrderStateId = ZOOD.OmsOrderStateId )  
   LEFT JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZOOD.PaymentTypeId)  
   LEFT JOIN AspNetUsers ASNU ON (ASNU.Id =ZU.AspNetUserId  )  
   LEFT JOIN AspNetZnodeUser  APZU ON (APZU.AspNetZnodeUserId = ASNU.UserName AND (APZU.PortalId = ZOOD.PortalId OR APZU.PortalId IS NULL  ))  
   LEFT JOIN ZnodePortalPaymentSetting ARJT ON (ARJT.PortalId = ZOOD.PortalId AND ARJT.PaymentSettingId = ZOOD.PaymentSettingId )  
   WHERE EXISTS (SELECT TOP 1 1 FROM #GetAccounts FNRA WHERE FNRA.AccountId= ZU.AccountId AND ZOOD.AccountId IS NULL)   
     OR EXISTS (SELECT TOP 1 1 FROM #GetAccounts FNRA WHERE FNRA.AccountId= ZOOD.AccountId AND ZOOD.AccountId IS NOT NULL)
   )  
   ,Cte_GetRMAdetails AS  
   (  
     SELECT OmsOrderId   
  FROM ZnodeOmsOrderDetails ZOOD   
  INNER JOIN ZnodeOmsOrderLIneItems ZOODLI ON (ZOODLI.OmsOrderDetailsId = ZOOD.OmsOrderDetailsId )  
  INNER JOIN ZnodeRmaRequestItem ZRRI ON (ZRRI.OmsOrderLineItemsId = ZOODLI.OmsOrderLineItemsId )  
     
   )  
   , Cte_GetQuote AS   
   (  
    SELECT CTEQD.*,CASE WHEN CTERD.OmsOrderid IS NULL THEN 0 ELSE 1 END IsInRMA   ,'+dbo.Fn_GetPagingRowId(@Order_BY,'CTEQD.OmsOrderId DESC')+',Count(*)Over() CountNo   
    FROM Cte_GetQuoteDetail CTEQD   
    LEFT JOIN Cte_GetRMAdetails CTERD ON (CTERD.OmsOrderId = CTEQD.OmsOrderid )  
       WHERE 1=1   
    '+dbo.Fn_GetFilterWhereClause(@WhereClause)+'  
   )  
  
   SELECT OmsOrderId,UserName , OrderTotal QuoteAmount, OrderState Status ,OrderDate,OmsPaymentStateId  ,PaymentStatus,PaymentTypeId,PaymentType,OrderNumber,IsInRMA,RowId,CountNo,CurrencyCode,PaymentDisplayName,CultureCode
		,PortalId, UserId
   FROM Cte_GetQuote   
   WHERE '+dbo.Fn_GetRowsForPagination(@PageNo, @Rows, ' RowId ');  
            
	PRINT @SQL  
    INSERT INTO @TBL_QuoteDetails   
		EXEC (@SQL);  
		SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM @TBL_QuoteDetails ), 0);  
  
		SELECT OmsOrderId,UserName,OrderAmount,[Status] AS 'OrderState',CreatedDate AS 'OrderDate',OmsPaymentStateId,OmsPaymentState AS 'PaymentStatus',PaymentTypeId,PaymentType,OrderNumber,IsInRMA,CurrencyCode,PaymentDisplayName,CultureCode
		,PortalId, UserId
		FROM @TBL_QuoteDetails;
    END TRY  
    BEGIN CATCH  
		DECLARE @Status BIT ;  
		SET @Status = 0;  
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetOmsAccountOrderList @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@AccountId = '+CAST(@AccountId AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));  
                    
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
      
		EXEC Znode_InsertProcedureErrorLog  
		@ProcedureName = 'Znode_GetOmsAccountOrderList',  
		@ErrorInProcedure = @Error_procedure,  
		@ErrorMessage = @ErrorMessage,  
		@ErrorLine = @ErrorLine,  
		@ErrorCall = @ErrorCall;  
	END CATCH;  
END;


GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateOmsOrder')
	DROP PROC Znode_InsertUpdateOmsOrder
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateOmsOrder]
(
	@OrderXML XML,
	@UserId INT
)
AS
BEGIN
SET NOCOUNT ON;
BEGIN TRY

	DECLARE @GetDate DATETIME = GETDATE()
	DECLARE @OMSOrder TABLE(OmsOrderId INT,OrderNumber VARCHAR(200))
	DECLARE @OMSOrderDetail TABLE(OmsOrderId INT,OmsOrderDetailsId INT)
	DECLARE @OmsOrderLineItems TABLE(RowId INT IDENTITY(1,1),OmsOrderDetailsId INT,OmsOrderLineItemsId INT, Sku VARCHAR(600), ParentOmsOrderLineItemsId INT, GroupId NVARCHAR(MAX),OrderLineItemRelationshipTypeId INT,ParentSku VARCHAR(600), GroupIdentifier INT)
	DECLARE @OmsParentOrderLineItems TABLE(RowId INT IDENTITY(1,1),OmsOrderDetailsId INT,OmsOrderLineItemsId INT, Sku VARCHAR(600), ParentOmsOrderLineItemsId INT, GroupId NVARCHAR(MAX), OrderLineItemRelationshipTypeId INT, GroupIdentifier INT)

	DECLARE @OrderLineItemRelationshipTypeIdAddon int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'AddOns'
	);

	DECLARE @OrderLineItemRelationshipTypeIdSimple int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Simple'
	);

	DECLARE @OrderLineItemRelationshipTypeIdBundles int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Bundles'
	);

	DECLARE @OrderLineItemRelationshipTypeIdGroup int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Group'
	);

	DECLARE @OrderLineItemRelationshipTypeIdConfig int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Configurable'
	);


	CREATE TABLE #TempOrderData
	(
		RowId INT IDENTITY(1,1),OrderNumber VARCHAR(200), PublishStateId INT,OmsOrderId INT,OmsOrderStateId INT,
		DiscountAmount NUMERIC(28,6),SalesTax NUMERIC(28,6),TaxRate NUMERIC(28,6),IsOldOrder BIT,VAT NUMERIC(28,6),GST NUMERIC(28,6),
		PST NUMERIC(28,6),HST NUMERIC(28,6),Total NUMERIC(28,6),BillingAddressId INT,ShippingAddressId INT,ShippingId INT,
		PortalId INT,ShippingNumber NVARCHAR(max),TrackingNumber NVARCHAR(1000),CouponCode NVARCHAR(1000),
		PromoDescription NVARCHAR(max),ReferralUserId int,PurchaseOrderNumber NVARCHAR(1000),OmsPaymentStateId int,
		WebServiceDownloadDate datetime,PaymentSettingId int,PaymentTransactionToken NVARCHAR(600),ShipDate datetime,ReturnDate datetime,
		AddressId int,PoDocument NVARCHAR(600),IsActive bit,ExternalId NVARCHAR(1000),PaymentTypeId INT,CreatedBy INT,CreatedDate datetime,ModifiedBy INT,
		ModifiedDate datetime,CreditCardNumber VARCHAR(4),IsShippingCostEdited bit,IsTaxCostEdited bit,ShippingDifference NUMERIC(28,6),
		EstimateShippingCost NUMERIC(28,6),TransactionId NVARCHAR(800),Custom1 NVARCHAR(MAX),Custom2 NVARCHAR(MAX),Custom3 NVARCHAR(MAX),
		Custom4 NVARCHAR(MAX),Custom5 NVARCHAR(MAX),FirstName NVARCHAR(200),LastName NVARCHAR(200),CardType VARCHAR(50),CreditCardExpMonth INT,
		CreditCardExpYear INT,TotalAdditionalCost NUMERIC(28,6),PaymentDisplayName NVARCHAR(2000),PaymentExternalId NVARCHAR(2000),
		CultureCode VARCHAR(200),DisplayName NVARCHAR(2000),InHandDate datetime,IpAddress VARCHAR(100),JobName NVARCHAR(200),
		ShippingConstraintCode NVARCHAR(100),ShippingDiscount NUMERIC(28,6),ShippingHandlingCharges NUMERIC(28,6),ReturnCharges NUMERIC(28,6),
		IsCalculateTaxAfterDiscount bit,Email VARCHAR(50),PhoneNumber VARCHAR(50),OrderTotalWithoutVoucher NUMERIC(28,6),ImportDuty NUMERIC(28,6),
		TaxCost NUMERIC(28,6),ShippingCost NUMERIC(28,6), SubTotal NUMERIC(28,6),CurrencyCode VARCHAR(100),OverDueAmount NUMERIC(28,6), ShippingTypeId INT,
		AccountNumber NVARCHAR(4000),ShippingMethod NVARCHAR(4000),PaymentCode NVARCHAR(400) ,PaymentStatusId Int, RemainingOrderAmount NUMERIC(28,6),AvataxIsSellerImporterOfRecord bit,
		AccountId INT
	)

	CREATE TABLE #TempOrderBillingAddress
	(
		AddressId INT,BillingFirstName VARCHAR(300),BillingLastName VARCHAR(300),BillingCountry VARCHAR(3000),BillingStateCode VARCHAR(300),
		BillingPostalCode VARCHAR(50),BillingPhoneNumber VARCHAR(50),BillingEmailId VARCHAR(50),BillingStreet1 VARCHAR(300),BillingStreet2 VARCHAR(300),
		BillingCity VARCHAR(3000),BillingCompanyName NVARCHAR(1200)
	)
	
	CREATE TABLE #TempParentLineItemDetails
	(
		RowId INT IDENTITY(1,1),OrderLineItemRelationshipTypeId INT,OmsOrderDetailsId INT,OmsOrderShipmentId INT,RmaReasonForReturnId INT,Sku NVARCHAR(600),ProductName NVARCHAR(1000),
		Description NVARCHAR(max),Quantity NUMERIC(28,6),Price NUMERIC(28,6),Weight NUMERIC(28,6),DownloadLink NVARCHAR(max),DiscountAmount NUMERIC(28,6),
		ShipSeparately bit,ShipDate datetime,ReturnDate datetime,ShippingCost NUMERIC(28,6),PromoDescription NVARCHAR(max),TransactionNumber NVARCHAR(max),
		PaymentStatusId int,TrackingNumber NVARCHAR(max),IsAutoGeneratedTracking bit,OrderLineItemStateId int,IsRecurringBilling bit,RecurringBillingPeriod NVARCHAR(100),
		RecurringBillingCycles int,RecurringBillingFrequency NVARCHAR(100),RecurringBillingAmount NUMERIC(28,6),AppliedPromo NVARCHAR(max),CouponsApplied NVARCHAR(100),
		ExternalId NVARCHAR(1000),IsActive bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,AutoAddonSKU NVARCHAR(max),IsShippingReturn bit,
		PartialRefundAmount NUMERIC(28,6),Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),Custom4 NVARCHAR(max),Custom5 NVARCHAR(max),
		GroupId NVARCHAR(max),BundleQuantity int, TaxRuleId INT,TaxTransactionNumber NVARCHAR(1200),Comments NVARCHAR(MAX),SalesTax NUMERIC(28,6),VAT NUMERIC(28,6),
		GST NUMERIC(28,6),PST NUMERIC(28,6),HST NUMERIC(28,6),ImportDuty NUMERIC(28,6), GroupIdentifier INT
	)

	CREATE TABLE #TempChildLineItemDetails
	(
		RowId INT IDENTITY(1,1),OrderLineItemRelationshipTypeId INT,OmsOrderDetailsId INT,OmsOrderShipmentId INT,RmaReasonForReturnId INT,Sku NVARCHAR(600),ProductName NVARCHAR(1000),
		Description NVARCHAR(max),Quantity NUMERIC(28,6),Price NUMERIC(28,6),Weight NUMERIC(28,6),DownloadLink NVARCHAR(max),DiscountAmount NUMERIC(28,6),
		ShipSeparately bit,ShipDate datetime,ReturnDate datetime,ShippingCost NUMERIC(28,6),PromoDescription NVARCHAR(max),TransactionNumber NVARCHAR(max),
		PaymentStatusId int,TrackingNumber NVARCHAR(max),IsAutoGeneratedTracking bit,OrderLineItemStateId int,IsRecurringBilling bit,RecurringBillingPeriod NVARCHAR(100),
		RecurringBillingCycles int,RecurringBillingFrequency NVARCHAR(100),RecurringBillingAmount NUMERIC(28,6),AppliedPromo NVARCHAR(max),CouponsApplied NVARCHAR(100),
		ExternalId NVARCHAR(1000),IsActive bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,AutoAddonSKU NVARCHAR(max),IsShippingReturn bit,
		PartialRefundAmount NUMERIC(28,6),Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),Custom4 NVARCHAR(max),Custom5 NVARCHAR(max),
		GroupId NVARCHAR(max),BundleQuantity int, TaxRuleId INT,TaxTransactionNumber NVARCHAR(1200),Comments NVARCHAR(MAX),SalesTax NUMERIC(28,6),VAT NUMERIC(28,6),
		GST NUMERIC(28,6),PST NUMERIC(28,6),HST NUMERIC(28,6),ImportDuty NUMERIC(28,6), ParentSku NVARCHAR(600), GroupIdentifier INT
	)

	CREATE TABLE #TempOrderAttribute
	(
		AttributeCode NVARCHAR(1000),AttributeValue NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,
		ModifiedDate DATETIME,AttributeValueCode NVARCHAR(1000), Sku VARCHAR(600), GroupId NVARCHAR(max), GroupIdentifier INT
	)

	CREATE TABLE #OmsPersonalizeItem
	(
		PersonalizeCode NVARCHAR(400),PersonalizeValue NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,
		ModifiedDate DATETIME,DesignId NVARCHAR(4000),ThumbnailURL NVARCHAR(MAX), Sku VARCHAR(600), GroupId NVARCHAR(max),
		GroupIdentifier INT
	)

	CREATE TABLE #OmsOrderDiscount
	(
		OmsDiscountTypeId INT,DiscountCode VARCHAR(300),DiscountAmount NUMERIC(28,6),Description NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,
		ModifiedBy INT,ModifiedDate DATETIME,PerQuantityDiscount NUMERIC(28,6),DiscountMultiplier NUMERIC(28,6),ParentOmsOrderLineItemsId INT,
		DiscountLevelTypeId INT,PromotionName NVARCHAR(1200),PromotionTypeId INT,DiscountAppliedSequence INT,PromotionMessage NVARCHAR(MAX),Sku VARCHAR(600),
		GroupId NVARCHAR(max)
	)

	--------Getting Order details
	INSERT INTO #TempOrderData
	(
		OrderNumber, PublishStateId ,OmsOrderId ,OmsOrderStateId ,DiscountAmount ,SalesTax ,TaxRate ,IsOldOrder ,
		VAT ,GST ,PST ,HST ,Total ,BillingAddressId ,ShippingAddressId ,ShippingId ,PortalId,
		ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
		,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive
		,ExternalId,PaymentTypeId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
		,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName
		,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
		,DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
		,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty,TaxCost,ShippingCost, SubTotal,
		CurrencyCode,OverDueAmount, ShippingTypeId, AccountNumber, ShippingMethod, PaymentCode, PaymentStatusId,RemainingOrderAmount,AvataxIsSellerImporterOfRecord
		,AccountId
	)
	SELECT
		CASE WHEN Tbl.Col.value( 'OrderNumber[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderNumber[1]', 'NVARCHAR(Max)' ) END  AS OrderNumber,
		CASE WHEN Tbl.Col.value( 'PublishStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PublishStateId[1]', 'NVARCHAR(Max)' ) END AS PublishStateId,
		CASE WHEN Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderId,
		CASE WHEN Tbl.Col.value( 'OmsOrderStateId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderStateId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderStateId,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE  Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
		CASE WHEN Tbl.Col.value( 'TaxRate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TaxRate[1]', 'NVARCHAR(Max)' ) END AS TaxRate,
		CASE WHEN Tbl.Col.value('IsOldOrder[1]', 'NVARCHAR(2000)') = '' THEN NULL ELSE Tbl.Col.value('IsOldOrder[1]', 'NVARCHAR(2000)') END AS IsOldOrder,
		CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE  Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
		CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
		CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END  AS PST,
		CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END AS HST,
		CASE WHEN Tbl.Col.value( 'Total[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Total[1]', 'NVARCHAR(Max)' ) END AS Total,
		CASE WHEN Tbl.Col.value( 'BillingAddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'BillingAddressId[1]', 'NVARCHAR(Max)' ) END AS BillingAddressId,
		CASE WHEN Tbl.Col.value( 'ShippingAddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingAddressId[1]', 'NVARCHAR(Max)' ) END AS ShippingAddressId,
		CASE WHEN (Tbl.Col.value( 'ShippingId[1]', 'NVARCHAR(Max)' )) = '' THEN NULL ELSE (Tbl.Col.value( 'ShippingId[1]', 'NVARCHAR(Max)' )) END  AS ShippingId,
		CASE WHEN Tbl.Col.value( 'PortalId[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'PortalId[1]', 'NVARCHAR(Max)' ) END AS PortalId,
		Tbl.Col.value( 'ShippingNumber[1]', 'NVARCHAR(Max)' ) AS ShippingNumber,
		Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
		Tbl.Col.value( 'CouponCode[1]', 'NVARCHAR(Max)' ) AS CouponCode,
		Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
		CASE WHEN Tbl.Col.value( 'ReferralUserId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReferralUserId[1]', 'NVARCHAR(Max)' ) END  AS ReferralUserId,
		Tbl.Col.value( 'PurchaseOrderNumber[1]', 'NVARCHAR(Max)' ) AS PurchaseOrderNumber,
		CASE WHEN Tbl.Col.value( 'OmsPaymentStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsPaymentStateId[1]', 'NVARCHAR(Max)' ) END AS OmsPaymentStateId,
		Tbl.Col.value( 'WebServiceDownloadDate[1]', 'NVARCHAR(Max)' ) AS WebServiceDownloadDate,
		CASE WHEN Tbl.Col.value( 'PaymentSettingId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentSettingId[1]', 'NVARCHAR(Max)' ) END AS PaymentSettingId,
		Tbl.Col.value( 'PaymentTransactionToken[1]', 'NVARCHAR(Max)' ) AS PaymentTransactionToken,
		CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE @GetDate END AS ShipDate,
		CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
		CASE WHEN Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) END AS AddressId,
		Tbl.Col.value( 'PoDocument[1]', 'NVARCHAR(Max)' ) AS PoDocument,
		CASE WHEN Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) END  AS IsActive,
		Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
		CASE WHEN Tbl.Col.value( 'PaymentTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentTypeId[1]', 'NVARCHAR(Max)' ) END  AS PaymentTypeId,
		@UserId AS CreatedBy,
		@GetDate AS CreatedDate,
		@UserId AS ModifiedBy,
		@GetDate AS ModifiedDate,
		Tbl.Col.value( 'CreditCardNumber[1]', 'NVARCHAR(Max)' ) AS CreditCardNumber,
		CASE WHEN Tbl.Col.value( 'IsShippingCostEdited[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsShippingCostEdited[1]', 'NVARCHAR(Max)' ) END AS IsShippingCostEdited,
		CASE WHEN Tbl.Col.value( 'IsTaxCostEdited[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsTaxCostEdited[1]', 'NVARCHAR(Max)' ) END AS IsTaxCostEdited,
		Tbl.Col.value( 'ShippingDifference[1]', 'NVARCHAR(Max)' ) AS ShippingDifference,
		CASE WHEN Tbl.Col.value( 'EstimateShippingCost[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'EstimateShippingCost[1]', 'NVARCHAR(Max)' ) END AS EstimateShippingCost,
		Tbl.Col.value( 'TransactionId[1]', 'NVARCHAR(Max)' ) AS TransactionId,
		Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
		Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
		Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
		Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
		Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
		Tbl.Col.value( 'FirstName[1]', 'NVARCHAR(Max)' ) AS FirstName,
		Tbl.Col.value( 'LastName[1]', 'NVARCHAR(Max)' ) AS LastName,
		Tbl.Col.value( 'CardType[1]', 'NVARCHAR(Max)' ) AS CardType,
		Tbl.Col.value( 'CreditCardExpMonth[1]', 'NVARCHAR(Max)' ) AS CreditCardExpMonth,
		Tbl.Col.value( 'CreditCardExpYear[1]', 'NVARCHAR(Max)' ) AS CreditCardExpYear,
		CASE WHEN Tbl.Col.value( 'TotalAdditionalCost[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TotalAdditionalCost[1]', 'NVARCHAR(Max)' ) END AS TotalAdditionalCost,
		Tbl.Col.value( 'PaymentDisplayName[1]', 'NVARCHAR(Max)' ) AS PaymentDisplayName,
		Tbl.Col.value( 'PaymentExternalId[1]', 'NVARCHAR(Max)' ) AS PaymentExternalId,
		Tbl.Col.value( 'CultureCode[1]', 'NVARCHAR(Max)' ) AS CultureCode,
		Tbl.Col.value( 'DisplayName[1]', 'NVARCHAR(Max)' ) AS DisplayName,
		Tbl.Col.value( 'InHandDate[1]', 'NVARCHAR(Max)' ) AS InHandDate,
		Tbl.Col.value( 'IpAddress[1]', 'NVARCHAR(Max)' ) AS IpAddress,
		Tbl.Col.value( 'JobName[1]', 'NVARCHAR(Max)' ) AS JobName,
		Tbl.Col.value( 'ShippingConstraintCode[1]', 'NVARCHAR(Max)' ) AS ShippingConstraintCode,
		Tbl.Col.value( 'ShippingDiscount[1]', 'NVARCHAR(Max)' ) AS ShippingDiscount,
		Tbl.Col.value( 'ShippingHandlingCharges[1]', 'NVARCHAR(Max)' ) AS ShippingHandlingCharges,
		CASE WHEN Tbl.Col.value( 'ReturnCharges[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'ReturnCharges[1]', 'NVARCHAR(Max)' ) END AS ReturnCharges,
		CASE WHEN Tbl.Col.value( 'IsCalculateTaxAfterDiscount[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsCalculateTaxAfterDiscount[1]', 'NVARCHAR(Max)' ) END AS IsCalculateTaxAfterDiscount,
		Tbl.Col.value( 'Email[1]', 'NVARCHAR(Max)' ) AS Email,
		Tbl.Col.value( 'PhoneNumber[1]', 'NVARCHAR(Max)' ) AS PhoneNumber,
		CASE WHEN Tbl.Col.value( 'OrderTotalWithoutVoucher[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OrderTotalWithoutVoucher[1]', 'NVARCHAR(Max)' )  END AS OrderTotalWithoutVoucher,
		CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )='' THEN '' ELSE Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
		CASE WHEN Tbl.Col.value( 'TaxCost[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'TaxCost[1]', 'NVARCHAR(Max)' ) END  AS TaxCost,
		CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
		CASE WHEN Tbl.Col.value( 'SubTotal[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'SubTotal[1]', 'NVARCHAR(Max)' ) END AS SubTotal,
		Tbl.Col.value( 'CurrencyCode[1]', 'NVARCHAR(Max)' ) AS CurrencyCode,
		CASE WHEN Tbl.Col.value( 'OverDueAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OverDueAmount[1]', 'NVARCHAR(Max)' ) END AS OverDueAmount,
		CASE WHEN Tbl.Col.value( 'ShippingTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingTypeId[1]', 'NVARCHAR(Max)' ) END AS ShippingTypeId,
		Tbl.Col.value( 'AccountNumber[1]', 'NVARCHAR(Max)' ) AS AccountNumber,
		Tbl.Col.value( 'ShippingMethod[1]', 'NVARCHAR(Max)' ) AS ShippingMethod,
		Tbl.Col.value( 'PaymentCode[1]', 'NVARCHAR(Max)' ) AS PaymentCode,
		CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId,
		CASE WHEN Tbl.Col.value( 'RemainingOrderAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'RemainingOrderAmount[1]', 'NVARCHAR(Max)' ) END AS RemainingOrderAmount,
		CASE WHEN Tbl.Col.value( 'AvataxIsSellerImporterOfRecord[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'AvataxIsSellerImporterOfRecord[1]', 'NVARCHAR(Max)' ) END AS AvataxIsSellerImporterOfRecord,
		Tbl.Col.value( 'AccountId[1]', 'NVARCHAR(Max)' ) AS AccountId
	FROM @OrderXML.nodes( '//PlaceOrderModel' ) AS Tbl(Col);


	--Getting billing address info
	INSERT INTO #TempOrderBillingAddress
	(
		AddressId,BillingFirstName,BillingLastName,BillingCompanyName,BillingStreet1,BillingStreet2,
		BillingCity,BillingStateCode,BillingPostalCode,BillingCountry,BillingPhoneNumber,BillingEmailId
	)
	SELECT
		Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) AS AddressId,
		Tbl.Col.value( 'FirstName[1]', 'NVARCHAR(Max)' ) AS FirstName,
		Tbl.Col.value( 'LastName[1]', 'NVARCHAR(Max)' ) AS LastName,
		Tbl.Col.value( 'CompanyName[1]', 'NVARCHAR(Max)' ) AS CompanyName,
		Tbl.Col.value( 'Street1[1]', 'NVARCHAR(Max)' ) AS Street1 ,
		Tbl.Col.value( 'Street2[1]', 'NVARCHAR(Max)' ) AS Street2,
		Tbl.Col.value( 'City[1]', 'NVARCHAR(Max)' ) AS City,
		Tbl.Col.value( 'StateCode[1]', 'NVARCHAR(Max)' ) AS StateCode,
		Tbl.Col.value( 'PostalCode[1]', 'NVARCHAR(Max)' ) AS PostalCode,
		Tbl.Col.value( 'Country[1]', 'NVARCHAR(Max)' ) AS Country,
		Tbl.Col.value( 'PhoneNumber[1]', 'NVARCHAR(Max)' ) AS PhoneNumber,
		Tbl.Col.value( 'EmailId[1]', 'NVARCHAR(Max)' ) AS EmailId
	FROM @OrderXML.nodes( '//PlaceOrderModel/BillingAddressModel' ) AS Tbl(Col);
	----Parent line item details insert
	INSERT INTO #TempParentLineItemDetails
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description,Quantity,
		Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber,
		PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles,
		RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy,
		ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity,
		TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty, GroupIdentifier
	)
	SELECT
		CASE WHEN Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemRelationshipTypeId,
		CASE WHEN Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) END  AS OmsOrderDetailsId,
		CASE WHEN Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderShipmentId,
		CASE WHEN Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) END AS RmaReasonForReturnId,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(2000)' ) AS ProductName,
		Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
		Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(Max)' ) AS Quantity,
		CASE WHEN Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) END AS Price,
		Tbl.Col.value( 'Weight[1]', 'NVARCHAR(Max)' ) AS Weight,
		Tbl.Col.value( 'DownloadLink[1]', 'NVARCHAR(Max)' ) AS DownloadLink,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		Tbl.Col.value( 'ShipSeparately[1]', 'NVARCHAR(Max)' ) AS ShipSeparately,
		CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE @GetDate END AS ShipDate,
		CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
		CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
		Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
		Tbl.Col.value( 'TransactionNumber[1]', 'NVARCHAR(Max)' ) AS TransactionNumber,
		CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId,
		Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
		CASE WHEN Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) END AS IsAutoGeneratedTracking,
		CASE WHEN Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemStateId,
		CASE WHEN Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) END AS IsRecurringBilling,
		Tbl.Col.value( 'RecurringBillingPeriod[1]', 'NVARCHAR(Max)' ) AS RecurringBillingPeriod,
		Tbl.Col.value( 'RecurringBillingCycles[1]', 'NVARCHAR(Max)' ) AS RecurringBillingCycles,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingFrequency,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingAmount,
		Tbl.Col.value( 'AppliedPromo[1]', 'NVARCHAR(Max)' ) AS AppliedPromo,
		Tbl.Col.value( 'CouponsApplied[1]', 'NVARCHAR(Max)' ) AS CouponsApplied,
		Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
		CASE WHEN Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) END AS IsActive,
		@UserId AS CreatedBy,
		@GetDate AS CreatedDate,
		@UserId AS ModifiedBy,
		@GetDate AS ModifiedDate,
		Tbl.Col.value( 'AutoAddonSKU[1]', 'NVARCHAR(Max)' ) AutoAddonSKU,
		CASE WHEN Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) END IsShippingReturn,
		CASE WHEN Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) END PartialRefundAmount,
		Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
		Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
		Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
		Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
		Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
		CASE WHEN Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) = ''  THEN NULL ELSE Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) END AS BundleQuantity,
		CASE WHEN Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) END AS TaxRuleId,
		Tbl.Col.value( 'TaxTransactionNumber[1]', 'NVARCHAR(Max)' ) AS TaxTransactionNumber,
		Tbl.Col.value( 'Comments[1]', 'NVARCHAR(Max)' ) AS Comments,
		CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
		CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
		CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
		CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END AS PST,
		CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END  AS HST,
		CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(Max)' ) AS GroupIdentifier
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel' ) AS Tbl(Col);

	----Child line item details insert
	INSERT INTO #TempChildLineItemDetails
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description,Quantity,
		Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber,
		PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles,
		RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy,
		ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity,
		TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty, ParentSku, GroupIdentifier
	)
	SELECT
		CASE WHEN Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemRelationshipTypeId,
		CASE WHEN Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderDetailsId,
		CASE WHEN Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderShipmentId,
		CASE WHEN Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) END AS RmaReasonForReturnId,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(2000)' ) AS ProductName,
		Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
		Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(Max)' ) AS Quantity,
		CASE WHEN Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) END AS Price,
		Tbl.Col.value( 'Weight[1]', 'NVARCHAR(Max)' ) AS Weight,
		Tbl.Col.value( 'DownloadLink[1]', 'NVARCHAR(Max)' ) AS DownloadLink,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		Tbl.Col.value( 'ShipSeparately[1]', 'NVARCHAR(Max)' ) AS ShipSeparately,
		CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE @GetDate END AS ShipDate,
		CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
		CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
		Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
		Tbl.Col.value( 'TransactionNumber[1]', 'NVARCHAR(Max)' ) AS TransactionNumber,
		CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId,
		Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
		CASE WHEN Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) END AS IsAutoGeneratedTracking,
		CASE WHEN Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemStateId,
		CASE WHEN Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) END AS IsRecurringBilling,
		Tbl.Col.value( 'RecurringBillingPeriod[1]', 'NVARCHAR(Max)' ) AS RecurringBillingPeriod,
		Tbl.Col.value( 'RecurringBillingCycles[1]', 'NVARCHAR(Max)' ) AS RecurringBillingCycles,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingFrequency,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingAmount,
		Tbl.Col.value( 'AppliedPromo[1]', 'NVARCHAR(Max)' ) AS AppliedPromo,
		Tbl.Col.value( 'CouponsApplied[1]', 'NVARCHAR(Max)' ) AS CouponsApplied,
		Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
		Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) AS IsActive,
		@UserId AS CreatedBy,
		@GetDate AS CreatedDate,
		@UserId AS ModifiedBy,
		@GetDate AS ModifiedDate,
		Tbl.Col.value( 'AutoAddonSKU[1]', 'NVARCHAR(Max)' ) AutoAddonSKU,
		CASE WHEN Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) END AS IsShippingReturn,
		CASE WHEN Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) END AS  PartialRefundAmount,
		Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
		Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
		Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
		Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
		Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
		CASE WHEN Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) END AS BundleQuantity,
		CASE WHEN Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) END AS TaxRuleId,
		Tbl.Col.value( 'TaxTransactionNumber[1]', 'NVARCHAR(Max)' ) AS TaxTransactionNumber,
		Tbl.Col.value( 'Comments[1]', 'NVARCHAR(Max)' ) AS Comments,
		CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
		CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
		CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
		CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END AS PST,
		CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END AS HST,
		CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE  Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
		Tbl.Col.value( 'ParentProductSKU[1]', 'NVARCHAR(Max)' ) AS ParentSku,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(Max)' ) AS GroupIdentifier
	FROM @OrderXML.nodes('//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/OrderLineItem/PlaceOrderlineItemCollection') AS Tbl(Col);

	--Updating parent for simple products
	UPDATE #TempChildLineItemDetails SET ParentSku = Sku WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdSimple
	AND OrderLineItemRelationshipTypeId IS NOT NULL

BEGIN TRAN OrderInsert

	--Inserting order number which are unique and getting in xml from code side
	INSERT INTO ZnodeOmsOrder(IsQuoteOrder,OrderNumber,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PublishStateId,IsOldOrder)
	OUTPUT INSERTED.OmsOrderId, INSERTED.OrderNumber INTO @OMSOrder
	SELECT 0 AS IsQuoteOrder, OrderNumber,OrderNumber AS ExternalId,@UserId,@GetDate,@UserId,@GetDate,PublishStateId, CAST(0 AS BIT)
	FROM #TempOrderData
	WHERE ISNULL(OmsOrderId,0) = 0

	--If order is new then creating new order details
	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		INSERT INTO ZnodeOmsOrderDetails
		(
			OmsOrderId,PortalId,UserId,OrderDate,OmsOrderStateId,ShippingId,PaymentTypeId,BillingFirstName,BillingLastName
			,BillingCompanyName,BillingStreet1,BillingStreet2,BillingCity,BillingStateCode,BillingPostalCode,BillingCountry
			,BillingPhoneNumber,BillingEmailId,TaxCost,ShippingCost,SubTotal,DiscountAmount,CurrencyCode,OverDueAmount,Total
			,ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive
			,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
			,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
			,DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
			,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty,RemainingOrderAmount,AccountId
		)
		OUTPUT INSERTED.OmsOrderId, INSERTED.OmsOrderDetailsId INTO @OMSOrderDetail
		SELECT OO.OmsOrderId, OD.PortalId,@UserId,@GetDate,OD.OmsOrderStateId,OD.ShippingId,OD.PaymentTypeId,OBA.BillingFirstName,OBA.BillingLastName,OBA.BillingCompanyName,
			OBA.BillingStreet1,OBA.BillingStreet2,OBA.BillingCity,OBA.BillingStateCode,OBA.BillingPostalCode,OBA.BillingCountry,OBA.BillingPhoneNumber,OBA.BillingEmailId,OD.TaxCost,
			OD.ShippingCost,OD.SubTotal, OD.DiscountAmount,OD.CurrencyCode,OD.OverDueAmount,OD.Total
			,OD.ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,OD.BillingAddressId,PoDocument,CAST(1 AS BIT) AS IsActive
			,OD.ExternalId,OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
			,ShippingDifference,EstimateShippingCost,TransactionId,OD.Custom1,OD.Custom2,OD.Custom3,OD.Custom4,OD.Custom5,OD.FirstName,OD.LastName
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
			,OD.DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
			,IsCalculateTaxAfterDiscount,Email,OD.PhoneNumber,OrderTotalWithoutVoucher,ImportDuty,OD.RemainingOrderAmount,OD.AccountId
		FROM #TempOrderData OD
		INNER JOIN @OMSOrder OO ON OD.OrderNumber = OO.OrderNumber
		LEFT JOIN #TempOrderBillingAddress OBA ON OD.BillingAddressId = OBA.AddressId

	END
	--If order managed then creating new order details and disable old order details
	ELSE
	BEGIN
		Declare @OldOmsOrderDetailsId INT
		SET @OldOmsOrderDetailsId = (SELECT TOP 1 OOD.OmsOrderDetailsId FROM ZnodeOmsOrderDetails OOD  WITH (NOLOCK) 
									 WHERE EXISTS(SELECT * FROM  #TempOrderData OD WHERE OOD.OmsOrderId = OD.OmsOrderId) AND OOD.IsActive = 1)

		INSERT INTO ZnodeOmsOrderDetails
		(
			OmsOrderId,PortalId,UserId,OrderDate,OmsOrderStateId,ShippingId,PaymentTypeId,BillingFirstName,BillingLastName --1
			,BillingCompanyName,BillingStreet1,BillingStreet2,BillingCity,BillingStateCode,BillingPostalCode,BillingCountry --2
			,BillingPhoneNumber,BillingEmailId,TaxCost,ShippingCost,SubTotal,DiscountAmount,CurrencyCode,OverDueAmount,Total --3
			,ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId --4
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive --5
			,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited --6
			,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName --7
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName, --8
			PaymentExternalId,CultureCode, --9
			DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges --10
			,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty,RemainingOrderAmount --11 
		)
		OUTPUT INSERTED.OmsOrderId, INSERTED.OmsOrderDetailsId INTO @OMSOrderDetail
		SELECT OO.OmsOrderId, OD.PortalId,@UserId,@GetDate,OD.OmsOrderStateId,OD.ShippingId,OD.PaymentTypeId,OBA.BillingFirstName,OBA.BillingLastName,--1
			OBA.BillingCompanyName,OBA.BillingStreet1,OBA.BillingStreet2,OBA.BillingCity,OBA.BillingStateCode,OBA.BillingPostalCode,OBA.BillingCountry, --2
			OBA.BillingPhoneNumber,OBA.BillingEmailId,OD.TaxCost,OD.ShippingCost,OD.SubTotal, OD.DiscountAmount,OD.CurrencyCode,OD.OverDueAmount,OD.Total, --3
			OD.ShippingNumber,OD.TrackingNumber,OD.CouponCode,OD.PromoDescription,OD.ReferralUserId,OD.PurchaseOrderNumber,OD.OmsPaymentStateId, --4
			OD.WebServiceDownloadDate,OD.PaymentSettingId,OD.PaymentTransactionToken,OD.ShipDate,OD.ReturnDate,OD.BillingAddressId,OD.PoDocument,CAST(1 AS BIT) AS IsActive --5
			,OD.ExternalId,OD.CreatedBy,OOD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.CreditCardNumber,OD.IsShippingCostEdited,OD.IsTaxCostEdited, --6
			OD.ShippingDifference,OD.EstimateShippingCost,OD.TransactionId,OD.Custom1,OD.Custom2,OD.Custom3,OD.Custom4,OD.Custom5,OD.FirstName,OD.LastName, --7
			OD.CardType,OD.CreditCardExpMonth,OD.CreditCardExpYear,OD.TotalAdditionalCost,CASE WHEN OD.PaymentSettingId = OOD.PaymentSettingId THEN OOD.PaymentDisplayName ELSE OD.PaymentDisplayName END AS PaymentDisplayName, --8
			CASE WHEN OD.PaymentSettingId = OOD.PaymentSettingId THEN OOD.PaymentExternalId ELSE OD.PaymentExternalId END AS PaymentExternalId,OD.CultureCode, --9 
			OD.DisplayName,OD.InHandDate,OD.IpAddress,OD.JobName,OD.ShippingConstraintCode,OD.ShippingDiscount,OD.ShippingHandlingCharges,OD.ReturnCharges, --10
			OD.IsCalculateTaxAfterDiscount,OD.Email,OD.PhoneNumber,OD.OrderTotalWithoutVoucher,OD.ImportDuty,OD.RemainingOrderAmount --11
		FROM #TempOrderData OD
		INNER JOIN ZnodeOmsOrder OO WITH (NOLOCK) ON OD.OrderNumber = OO.OrderNumber
		INNER JOIN ZnodeOmsOrderDetails OOD  WITH (NOLOCK) ON OO.OmsOrderId = OOD.OmsOrderId AND OOD.IsActive = 1
		LEFT JOIN #TempOrderBillingAddress OBA ON OD.BillingAddressId = OBA.AddressId
	
		DECLARE @OmsOrderStateIdCancelled int =  (select top 1 OmsOrderStateId FROM ZnodeOmsOrderState WHERE OrderStateName = 'CANCELED')

		UPDATE ZnodeOmsOrderDetails SET IsActive = 0 , OmsOrderStateId = @OmsOrderStateIdCancelled
		WHERE OmsOrderDetailsId = @OldOmsOrderDetailsId

		UPDATE ZnodeOmsOrderLineItems SET IsActive = 0
		WHERE OmsOrderDetailsId = @OldOmsOrderDetailsId
	END

	----Geting new OmsOrderDetailsId always
	Declare @OmsOrderDetailsId INT
	SET @OmsOrderDetailsId = ( SELECT TOP 1 OmsOrderDetailsId FROM @OMSOrderDetail )

	--Insert Order notes only for new order details
	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		INSERT INTO ZnodeOmsNotes(OmsOrderDetailsId,Notes,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
		SELECT @OmsOrderDetailsId,Tbl.Col.value( 'AdditionalInstructions[1]', 'NVARCHAR(Max)' ) AS Notes,
			@UserId,@GetDate,@UserId,@GetDate
		FROM @OrderXML.nodes( '//PlaceOrderModel' ) AS Tbl(Col)
		WHERE Tbl.Col.value( 'AdditionalInstructions[1]', 'NVARCHAR(Max)' ) <> '';
	END

	----Inserting parent line item data
	INSERT INTO ZnodeOmsOrderLineItems
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description --1
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber --2
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles --3
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy --4
		,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, GroupIdentifier --5
	)
	OUTPUT INSERTED.OmsOrderDetailsId, INSERTED.OmsOrderLineItemsId, INSERTED.Sku,INSERTED.ParentOmsOrderLineItemsId, INSERTED.GroupId, INSERTED.OrderLineItemRelationshipTypeId,INSERTED.GroupIdentifier INTO @OmsParentOrderLineItems
	SELECT OrderLineItemRelationshipTypeId,@OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description--1
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber --2
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles --3
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,ISNULL(IsActive,1) AS IsActive,CreatedBy,CreatedDate,ModifiedBy --4
		,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, GroupIdentifier --5
	FROM #TempParentLineItemDetails PLID

	----Inserting child line item data
	INSERT INTO ZnodeOmsOrderLineItems
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description --1
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber --2
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles --3
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy --4
		,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, --5
		ParentSku, GroupIdentifier --6
	)
	OUTPUT INSERTED.OmsOrderDetailsId, INSERTED.OmsOrderLineItemsId, INSERTED.Sku,INSERTED.ParentOmsOrderLineItemsId, INSERTED.GroupId, INSERTED.OrderLineItemRelationshipTypeId, INSERTED.ParentSku, INSERTED.GroupIdentifier INTO @OmsOrderLineItems
	SELECT PLID.OrderLineItemRelationshipTypeId,@OmsOrderDetailsId,PLID.OmsOrderShipmentId,PLID.RmaReasonForReturnId,PLID.Sku,PLID.ProductName,PLID.Description, --1
		PLID.Quantity,PLID.Price,PLID.Weight,PLID.DownloadLink,PLID.DiscountAmount,PLID.ShipSeparately,PLID.ShipDate,PLID.ReturnDate,PLID.ShippingCost,PLID.PromoDescription,PLID.TransactionNumber, --2
		PLID.PaymentStatusId,PLID.TrackingNumber,PLID.IsAutoGeneratedTracking,PLID.OrderLineItemStateId,PLID.IsRecurringBilling,PLID.RecurringBillingPeriod,PLID.RecurringBillingCycles,--3
		PLID.RecurringBillingFrequency,PLID.RecurringBillingAmount,PLID.AppliedPromo,PLID.CouponsApplied,PLID.ExternalId,isnull(PLID.IsActive,1) AS IsActive,PLID.CreatedBy,PLID.CreatedDate,PLID.ModifiedBy, --4
		PLID.ModifiedDate,PLID.AutoAddonSKU,PLID.IsShippingReturn,PLID.PartialRefundAmount,PLID.Custom1,PLID.Custom2,PLID.Custom3,PLID.Custom4,PLID.Custom5,PLID.GroupId,PLID.BundleQuantity, --5
		case when PLID.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdSimple then PLID.Sku else PLID.ParentSku end AS ParentSku, GroupIdentifier --6
	FROM #TempChildLineItemDetails PLID

	--Updating ParentOmsOrderLineItemsId for child line items for simple, group and configurable products
	UPDATE A SET A.ParentOmsOrderLineItemsId = (SELECT TOP 1 OmsOrderLineItemsId FROM @OmsParentOrderLineItems d WHERE d.GroupIdentifier = a.GroupIdentifier AND A.ParentSku = D.Sku  and ISNULL(a.GroupId,'-') = ISNULL(d.GroupId,'-'))
	FROM @OmsOrderLineItems a
	WHERE a.OrderLineItemRelationshipTypeId NOT IN ( @OrderLineItemRelationshipTypeIdAddon, @OrderLineItemRelationshipTypeIdGroup)  
	AND a.ParentOmsOrderLineItemsId IS NULL 
	
	--Updating ParentOmsOrderLineItemsId for child line items for group products
	IF EXISTS(SELECT * FROM @OmsOrderLineItems WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdGroup)
	BEGIN
		---Getting child lineitems for group product
		;WITH Cte_GroupProductChild AS
		(
			SELECT GroupIdentifier,Sku, ParentSku, OmsOrderLineItemsId, ParentOmsOrderLineItemsId,Dense_Rank()Over(Partition By GroupIdentifier ORDER BY OmsOrderLineItemsId) AS RowId1 
			FROM @OmsOrderLineItems
			WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdGroup
		)
		---Getting parent lineitems for group product
		,Cte_GroupProductParent AS 
		(
			SELECT GroupIdentifier,Sku, OmsOrderLineItemsId, Dense_Rank()Over(Partition By GroupIdentifier ORDER BY OmsOrderLineItemsId) AS RowId1 
			FROM @OmsParentOrderLineItems a
			WHERE OrderLineItemRelationshipTypeId IS NULL
			AND EXISTS(SELECT * FROM @OmsOrderLineItems b WHERE a.GroupIdentifier = b.GroupIdentifier AND a.Sku = b.ParentSku)
		)
		--Updating ParentOmsOrderLineItemsId on child for group products
		UPDATE a SET a.ParentOmsOrderLineItemsId = b.OmsOrderLineItemsId
		FROM Cte_GroupProductChild a
		INNER JOIN Cte_GroupProductParent B ON A.GroupIdentifier = B.GroupIdentifier AND a.RowId1 = b.RowId1 AND b.Sku = a.ParentSku 
	END

	---Updating ParentOmsOrderLineItemsId for addons if present
	IF EXISTS(SELECT * FROM @OmsOrderLineItems WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
	BEGIN
		--Updating ParentOmsOrderLineItemsId for addon with Simple products , group products and configurable products
		UPDATE b SET b.ParentOmsOrderLineItemsId = c.OmsOrderLineItemsId
		FROM @OmsOrderLineItems c
		INNER JOIN @OmsOrderLineItems b on b.ParentSku = c.Sku AND c.GroupIdentifier = b.GroupIdentifier
		WHERE c.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon and c.OrderLineItemRelationshipTypeId is not null
		and b.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
		AND b.ParentOmsOrderLineItemsId IS NULL
		
		--Updating ParentOmsOrderLineItemsId for addon with bundle products
		UPDATE c SET c.ParentOmsOrderLineItemsId = b.OmsOrderLineItemsId
		FROM @OmsOrderLineItems c
		INNER JOIN @OmsParentOrderLineItems b on B.sku = C.parentsku AND c.GroupIdentifier= b.GroupIdentifier
		WHERE B.OrderLineItemRelationshipTypeId is null 
		AND c.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
		AND C.ParentOmsOrderLineItemsId IS NULL
	 END
	 ---Updating ParentOmsOrderLineItemsId in main table
	 UPDATE a SET a.ParentOmsOrderLineItemsId = b.ParentOmsOrderLineItemsId
	 FROM  ZnodeOmsOrderLineItems a
	 INNER JOIN @OmsOrderLineItems b on a.OmsOrderLineItemsId = b.OmsOrderLineItemsId

	----Shipping details Start
	DECLARE @ShippingTypeId INT
	IF EXISTS(SELECT * FROM #TempOrderData WHERE ShippingTypeId IS NULL)
	BEGIN
		SET @ShippingTypeId = (SELECT TOP 1 ShippingTypeId FROM ZnodeShipping WHERE EXISTS(SELECT * FROM #TempOrderData WHERE ZnodeShipping.ShippingId = #TempOrderData.ShippingId))
	END
	ELSE
	BEGIN
		SET @ShippingTypeId = (SELECT TOP 1 ShippingTypeId FROM #TempOrderData)
	END
	IF EXISTS(SELECT * FROM ZnodeShippingTypes WITH (NOLOCK)  WHERE ShippingTypeId = @ShippingTypeId AND ClassName = 'ZnodeCustomerShipping')
	BEGIN
		INSERT INTO ZnodeOmsCustomerShipping(OmsOrderDetailsId,UserId,ShippingTypeId,AccountNumber,ShippingMethod,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT TOP 1 @OmsOrderDetailsId,@UserId,@ShippingTypeId,AccountNumber,ShippingMethod,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		FROM #TempOrderData
	END
	----Shipping details end

	----Order tax details start
	----Inserting order tax data
	IF (SELECT TOP 1 TaxCost FROM #TempOrderData) > 0
	BEGIN
		INSERT INTO ZnodeOmsTaxOrderDetails(OmsOrderDetailsId,SalesTax,VAT,GST,PST,HST,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportDuty)
		SELECT @OmsOrderDetailsId,OD.SalesTax,OD.VAT,OD.GST,OD.PST,OD.HST,OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.ImportDuty
		FROM #TempOrderData OD
	END

	----Inserting order tax data for parent line item
	INSERT INTO ZnodeOmsTaxOrderLineDetails
	(
		OmsOrderLineItemsId,TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty,
		CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
	)
	SELECT POLI.OmsOrderLineItemsId,CLID.TaxRuleId,CLID.TaxTransactionNumber,CLID.Comments,CLID.SalesTax,CLID.VAT,CLID.GST,CLID.PST,CLID.HST,CLID.ImportDuty,
	CLID.CreatedBy,CLID.CreatedDate,CLID.ModifiedBy,CLID.ModifiedDate
	FROM #TempParentLineItemDetails CLID
	INNER JOIN @OmsParentOrderLineItems POLI ON CLID.Sku = POLI.Sku AND ISNULL(CLID.GroupId,'') = ISNULL(POLI.GroupId,'') AND CLID.GroupIdentifier = POLI.GroupIdentifier
	WHERE POLI.ParentOmsOrderLineItemsId IS NULL
	AND (ISNULL(CLID.SalesTax,0)+ISNULL(CLID.VAT,0)+ISNULL(CLID.GST,0)+ISNULL(CLID.PST,0)+ISNULL(CLID.HST,0)) > 0

	----Inserting order tax data for child line item
	INSERT INTO ZnodeOmsTaxOrderLineDetails
	(
		OmsOrderLineItemsId,TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty,
		CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
	)
	SELECT POLI.OmsOrderLineItemsId,CLID.TaxRuleId,CLID.TaxTransactionNumber,CLID.Comments,CLID.SalesTax,CLID.VAT,CLID.GST,CLID.PST,CLID.HST,CLID.ImportDuty,
		CLID.CreatedBy,CLID.CreatedDate,CLID.ModifiedBy,CLID.ModifiedDate
	FROM #TempChildLineItemDetails CLID
	INNER JOIN @OmsOrderLineItems POLI ON CLID.Sku = POLI.Sku AND ISNULL(CLID.GroupId,'') = ISNULL(POLI.GroupId,'') AND CLID.GroupIdentifier = POLI.GroupIdentifier
	WHERE POLI.ParentOmsOrderLineItemsId IS NOT NULL
	AND (ISNULL(CLID.SalesTax,0)+ISNULL(CLID.VAT,0)+ISNULL(CLID.GST,0)+ISNULL(CLID.PST,0)+ISNULL(CLID.HST,0)) > 0
	----Order tax details end

	----Order attribte details start
	----Fetching order attributes FROM xml
	INSERT INTO #TempOrderAttribute(AttributeCode ,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AttributeValueCode,Sku,GroupId, GroupIdentifier )
	SELECT
		Tbl.Col.value( 'AttributeCode[1]', 'NVARCHAR(Max)' ) AS AttributeCode,
		Tbl.Col.value( 'AttributeValue[1]', 'NVARCHAR(Max)' ) AS AttributeValue,
		@UserId,@GetDate,@UserId,@GetDate,
		Tbl.Col.value( 'AttributeValueCode[1]', 'NVARCHAR(2000)' ) AS AttributeValueCode,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(2000)' ) AS GroupIdentifier
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/OrderLineItem/PlaceOrderlineItemCollection/OrderAttribute/PlaceOrderAttributeModel' ) AS Tbl(Col);

	----Inserting order attributes data
	INSERT INTO ZnodeOmsOrderAttribute(OmsOrderLineItemsId,AttributeCode,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AttributeValueCode)
	SELECT POLI.OmsOrderLineItemsId, OA.AttributeCode,OA.AttributeValue,OA.CreatedBy,OA.CreatedDate,OA.ModifiedBy,OA.CreatedDate,OA.AttributeValueCode
	FROM #TempOrderAttribute OA
	INNER JOIN @OmsOrderLineItems POLI ON OA.Sku = POLI.Sku AND ISNULL(OA.GroupId,'') = ISNULL(POLI.GroupId,'') AND OA.GroupIdentifier = POLI.GroupIdentifier
	----Order attribte details end

	----Personalise details start
	----Fetching personalize order data
	INSERT INTO #OmsPersonalizeItem(PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL,Sku,GroupId, GroupIdentifier)
	SELECT
		Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode,
		Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue,
		@UserId,@GetDate,@UserId,@GetDate,
		Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(2000)' ) AS DesignId,
		Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(2000)' ) AS ThumbnailURL,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(2000)' ) AS GroupIdentifier
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/PersonaliseDetails/PlaceOrderPersonaliseModel' ) AS Tbl(Col);

	--Inserting personalize order data
	INSERT INTO ZnodeOmsPersonalizeItem(OmsOrderLineItemsId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL)
	SELECT OmsOrderLineItemsId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL
	FROM #OmsPersonalizeItem OPI
	INNER JOIN @OmsParentOrderLineItems POLI ON OPI.Sku = POLI.Sku AND ISNULL(OPI.GroupId,'') = ISNULL(POLI.GroupId,'') AND OPI.GroupIdentifier = POLI.GroupIdentifier
	WHERE POLI.ParentOmsOrderLineItemsId IS NULL
	----Personalise details end

	----discount details start
	----Fetching order discount data
	INSERT INTO #OmsOrderDiscount
	(
		OmsDiscountTypeId ,DiscountCode,DiscountAmount ,Description ,CreatedBy ,CreatedDate ,
		ModifiedBy ,ModifiedDate ,PerQuantityDiscount,DiscountMultiplier ,DiscountLevelTypeId ,
		PromotionName ,PromotionTypeId ,DiscountAppliedSequence,PromotionMessage ,Sku,GroupId 
	)
	SELECT
	CASE WHEN Tbl.Col.value( 'OmsDiscountTypeId[1]', 'NVARCHAR(2000)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OmsDiscountTypeId[1]', 'NVARCHAR(2000)' ) END AS OmsDiscountTypeId,
		Tbl.Col.value( 'DiscountCode[1]', 'NVARCHAR(Max)' ) AS DiscountCode,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
		@UserId,@GetDate,@UserId,@GetDate,
		CASE WHEN Tbl.Col.value( 'PerQuantityDiscount[1]', 'NVARCHAR(2000)' )='' THEN NULL ELSE Tbl.Col.value( 'PerQuantityDiscount[1]', 'NVARCHAR(2000)' ) END AS PerQuantityDiscount,
		CASE WHEN Tbl.Col.value( 'DiscountMultiplier[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountMultiplier[1]', 'NVARCHAR(2000)' ) END AS DiscountMultiplier,
		CASE WHEN Tbl.Col.value( 'DiscountLevelTypeId[1]', 'NVARCHAR(2000)' )= '' THEN NULL ELSE Tbl.Col.value( 'DiscountLevelTypeId[1]', 'NVARCHAR(2000)' ) END AS DiscountLevelTypeId,
		Tbl.Col.value( 'PromotionName[1]', 'NVARCHAR(2000)' ) AS PromotionName,
		CASE WHEN Tbl.Col.value( 'PromotionTypeId[1]', 'NVARCHAR(2000)' )= '' THEN NULL ELSE Tbl.Col.value( 'PromotionTypeId[1]', 'NVARCHAR(2000)' ) END AS PromotionTypeId,
		Tbl.Col.value( 'DiscountAppliedSequence[1]', 'NVARCHAR(2000)' ) AS DiscountAppliedSequence,
		Tbl.Col.value( 'PromotionMessage[1]', 'NVARCHAR(2000)' ) AS PromotionMessage,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId
	FROM @OrderXML.nodes('//PlaceOrderModel/OrderDiscounts/PlaceOrderDiscountModel') AS Tbl(Col)

	----Inserting order discount data
	--Inserting product level discount for simple and group products
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,POLI.OmsOrderLineItemsId,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
		OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,POLI.ParentOmsOrderLineItemsId,
		OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	INNER JOIN @OmsOrderLineItems POLI ON OD.Sku = POLI.Sku AND ISNULL(OD.GroupId,'') = ISNULL(POLI.GroupId,'') 
	WHERE isnull(OD.Sku,'') <> '' AND POLI.OrderLineItemRelationshipTypeId IN (@OrderLineItemRelationshipTypeIdSimple , @OrderLineItemRelationshipTypeIdGroup)
	
	--Inserting product level discount for config and bundle products
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,POLI.ParentOmsOrderLineItemsId,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
	OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,NULL,
	OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	INNER JOIN @OmsOrderLineItems POLI ON OD.Sku = POLI.ParentSku AND ISNULL(OD.GroupId,'') = ISNULL(POLI.GroupId,'')
	WHERE isnull(OD.Sku,'') <> '' AND POLI.OrderLineItemRelationshipTypeId IN (@OrderLineItemRelationshipTypeIdBundles , @OrderLineItemRelationshipTypeIdConfig)
	
	--Inserting order level discount 
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,NULL,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
	OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,NULL,
	OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	WHERE isnull(OD.Sku,'') = ''
	----discount details end

	----Additional Cost details start
	IF OBJECT_ID('TEMPDB..#TempAdditionalCost') IS NOT NULL
	DROP TABLE #TempAdditionalCost
	--fetching additional cost details
	SELECT Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl1.Col.value( 'KeyName[1]', 'NVARCHAR(2000)' ) AS KeyName,
		CASE WHEN Tbl1.Col.value( 'KeyValue[1]', 'NVARCHAR(2000)' )='' THEN NULL ELSE Tbl1.Col.value( 'KeyValue[1]', 'NVARCHAR(2000)' ) END AS KeyValue,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId
	INTO #TempAdditionalCost
	FROM @OrderXML.nodes('//PlaceOrderModel/LineItems/PlaceOrderLineItemModel') AS Tbl(Col)
	CROSS APPLY Tbl.Col.nodes( '*:AdditionalCostList/AdditionalCost' ) AS Tbl1(Col);

	--Inserting additional cost details
	IF EXISTS(SELECT * FROM #TempAdditionalCost)
	BEGIN
		INSERT INTO ZnodeOmsOrderLineItemsAdditionalCost(OmsOrderLineItemsId,KeyName,KeyValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT OLI.OmsOrderLineItemsId, AC.KeyName, AC.KeyValue, @UserId, @GetDate, @UserId, @GetDate
		FROM #TempAdditionalCost AC
		INNER JOIN @OmsOrderLineItems OLI ON AC.Sku = OLI.Sku AND ISNULL(AC.GroupId,'') = ISNULL(OLI.GroupId,'') 
		WHERE OLI.ParentOmsOrderLineItemsId IS NULL
		AND ISNULL(AC.KeyName,'') <> ''
	END
	----Additional Cost details end
	
	DECLARE @OmsOrderId INT
	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		SET @OmsOrderId = (SELECT TOP 1 OmsOrderId FROM @OMSOrder)
	END
	ELSE
	BEGIN 
		SET @OmsOrderId = (SELECT TOP 1 OmsOrderId FROM #TempOrderData)
	END
	----RMA details start
	IF (SELECT TOP 1 OmsOrderId FROM #TempOrderData) > 0
	BEGIN
		DECLARE @OldOmsOrderDetailID INT
		SET @OmsOrderID = (SELECT TOP 1 OmsOrderId FROM #TempOrderData)
		SET @OldOmsOrderDetailID = (SELECT TOP 1 OmsOrderDetailsId FROM ZnodeOmsOrderDetails WHERE OmsOrderId = @OmsOrderID AND OmsOrderDetailsId <> @OmsOrderDetailsId ORDER BY OmsOrderDetailsId DESC)

		UPDATE ZnodeRmaReturnDetails
		SET OmsOrderDetailsId = @OmsOrderDetailsId
		WHERE OmsOrderId = @OmsOrderID

		SELECT OOLI.OmsOrderLineItemsId AS OldOmsOrderLineItemsId, OOLI.OmsOrderDetailsId, OOLI.Sku, LI.OmsOrderLineItemsId AS NewOmsOrderLineItemsId
		INTO #OldOrderLineItems
		FROM ZnodeOmsOrderLineItems OOLI WITH (NOLOCK)
		INNER JOIN @OmsOrderLineItems LI ON LI.Sku = OOLI.Sku
		WHERE OOLI.OmsOrderDetailsId = @OldOmsOrderDetailID --AND OOLI.ParentOmsOrderLineItemsId IS NULL
 
		UPDATE RRLI SET RRLI.OmsOrderLineItemsId = OldLI.NewOmsOrderLineItemsId
		FROM ZnodeRmaReturnLineItems RRLI
		INNER JOIN #OldOrderLineItems OldLI ON RRLI.OmsOrderLineItemsId = OldOmsOrderLineItemsId
	
		UPDATE ZnodeOmsOrder set IsOldOrder = 0
		where OmsOrderId = @OmsOrderID
	END
	----RMA details end
	
	---Inserting OrderTaxDetails
	IF(NOT EXISTS(SELECT 1 from ZnodeOmsTaxRule where OmsOrderId= @OmsOrderId))
	BEGIN
		DECLARE @TaxRate Numeric(28,6), @TaxRuleId INT, @AvataxIsSellerImporterOfRecord bit
		SET @TaxRate = (SELECT TOP 1 TaxRate FROM #TempOrderData)
		SET @TaxRuleId = (SELECT TOP 1 TaxRuleId FROM #TempChildLineItemDetails)
		SET @AvataxIsSellerImporterOfRecord = (SELECT TOP 1 AvataxIsSellerImporterOfRecord FROM #TempOrderData)

		 EXEC [Znode_InsertOrderTaxDetails] @OmsOrderId = @OmsOrderId, @TaxRuleId = @TaxRuleId, @TaxRate = @TaxRate, @AvataxIsSellerImporterOfRecord = @AvataxIsSellerImporterOfRecord, @Status = 0
	END

	COMMIT TRAN OrderInsert

	SELECT TOP 1 OmsOrderId,@OmsOrderDetailsId AS OmsOrderDetailsId, cast(1 AS bit)  AS Status, '' AS ErrorMessage
	FROM @OMSOrderDetail

END TRY
BEGIN CATCH
	ROLLBACK TRAN OrderInsert
	SELECT TOP 1 0 AS OmsOrderId,0 AS OmsOrderDetailsId, cast(0 AS bit)  AS Status, ERROR_MESSAGE() AS ErrorMessage

	INSERT INTO ZnodeOmsFailedOrderPayments(PaymentCode,PaymentDisplayName,TransactionToken,TotalAmount,UserName,UserId,Email,PaymentSettingId,OrderNumber,OrderDate,PaymentStatusId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
	SELECT TOP 1 PaymentCode,PaymentDisplayName, isnull(PaymentTransactionToken,''),Total,a.FirstName+' '+a.LastName,@UserId,a.Email,a.PaymentSettingId,a.OrderNumber,@GetDate,PaymentStatusId,@UserId,@GetDate,@UserId,@GetDate
	FROM #TempOrderData A
	
	DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertUpdateOmsOrder @OrderXML ='+CAST(@OrderXML AS VARCHAR(MAX))+' , @UserId = '+CAST(@UserId AS VARCHAR(50));

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName    = 'Znode_InsertUpdateOmsOrder',
	@ErrorInProcedure = @ERROR_PROCEDURE,
	@ErrorMessage     = @ErrorMessage,
	@ErrorLine        = @ErrorLine,
	@ErrorCall        = @ErrorCall;
	--If error throw in SP the deleting records FROM order tables if data inserted
	EXEC Znode_DeleteOrderById @OrderDetailId=@OmsOrderDetailsId,@Status=0
END CATCH

END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetOmsQuoteList')
	DROP PROC Znode_GetOmsQuoteList
GO

CREATE PROCEDURE [dbo].[Znode_GetOmsQuoteList]    
(     
  @WhereClause NVARCHAR(MAX),    
  @Rows        INT            = 100,    
  @PageNo      INT            = 1  ,    
  @Order_BY    VARCHAR(1000)  = '' ,    
  @RowsCount   INT OUT             ,    
  @AccountId   INT,    
  @UserId      INT            = 0,     
  @IsPendingPayment BIT = 0  ,     
  @IsParentPendingOrder  BIT = 1,
  @SalesRepUserId int = 0    
 )    
AS     
   /*    
  Summary :- This procedure is used to get the Quote list of account and Users    
    Fn_GetRecurciveAccounts is used to fetch AccountId and Its recursive ParentId      
    @InnerWhereClause contains AccountId fetched from the Function Fn_GetRecurciveAccounts     
    OrderDetails are fetched from the tables filtered by AccountId Present in @InnerWhereClause    
    OrderDetails are fetched in Descending order of OmsQuoteId    
     Unit Testing     
     
     EXEC Znode_GetOmsQuoteList '' ,@RowsCount = 50 ,@AccountId = 1,@UserId = 0      
    
*/    
     BEGIN    
         BEGIN TRY    
			SET NOCOUNT ON;    
			DECLARE @SQL VARCHAR(MAX)= '', @InnerWhereClause VARCHAR(MAX)= '', @ProcessType  varchar(50)='Quote',@QuoteFilter NVARCHAr(max)='';    
			
			----Verifying that the @SalesRepUserId is having 'Sales Rep' role
			IF NOT EXISTS
			(
				SELECT * FROM ZnodeUser ZU
				INNER JOIN AspNetZnodeUser ANZU ON ZU.UserName = ANZU.UserName
				INNER JOIN AspNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName
				INNER JOIN AspNetUserRoles ANUR ON ANU.Id = ANUR.UserId
				Where Exists(select * from AspNetRoles ANR Where Name = 'Sales Rep' AND ANUR.RoleId = ANR.Id) 
				AND ZU.UserId = @SalesRepUserId
			)   
			Begin
				SET @SalesRepUserId = 0
			End

            DECLARE @TBL_QuoteDetails TABLE (OmsQuoteId INT,UserName NVARCHAR(300),AccountName NVARCHAR(400),QuoteOrderTotal NUMERIC(28, 6),[OrderStatus] VARCHAR(300),    
            CreatedDate DATETIME,StoreName NVARCHAR(Max),CurrencyCode VARCHAR(100),CultureCode VARCHAR(100),PublishState nvarchar(600),RowId INT,CountNo INT,CreatedByName NVARCHAr(max) ,ModifiedByName NVARCHAR(max),IsConvertedToOrder bit,OrderType varchar(50), UserId INT, AccountCode nvarchar(100));    
           
             IF @UserId <> 0  AND @IsParentPendingOrder   = 1           
                 BEGIN    
                     SET @InnerWhereClause = ' AND '''+CAST(@UserId AS VARCHAR(max))+''' = ZU.UserId ';    
                    -- SET @AccountId = (SELECT TOP 1 AccountID FROM ZnodeUser WHERE UserId = @UserId);    
                 END    
             ELSE IF @IsParentPendingOrder   = 0     
                BEGIN    
				SET @InnerWhereClause = ' AND  EXISTS (SELECT TOP 1 1 FROM [dbo].[Fn_GetRecurciveUserId] ('+CAST(@UserId AS VARCHAR(50))+','''+@ProcessType+''') SP WHERE (SP.UserId = ZU.UserId OR SP.UserId IS NULL)  )';   
   
				SET @QuoteFilter =' AND EXISTS (SELECT TOP 1 1 FROM ZnodeOMSQuoteApproval WR WHERE WR.OmsQuoteId = ZOQ.OmsQuoteId AND ( Wr.ApproverUserId ='+CAST(@UserId AS VARCHAR(50))+' OR Wr.UserId = '+CAST(@UserId AS VARCHAR(50))+'  ) ) ';        
				END    
    ELSE     
    BEGIN     
      SET @InnerWhereClause = ''    
    END       
          
    IF @IsPendingPayment =1     
    BEGIN     
       
     SET @InnerWhereClause = @InnerWhereClause+' AND NOT EXISTS ( SELECT TOP 1 1 FROM ZnodeUserGlobalAttributeValue a     
    INNER JOIN ZnodeUserGlobalAttributeValueLocale b  on (b.UserGlobalAttributeValueId = a.UserGlobalAttributeValueId)    
    INNER JOIN ZnodeGlobalAttribute c ON (c.GlobalAttributeid = a.GlobalAttributeId )    
    WHERE c.AttributeCOde = ''BillingAccountNumber'' AND a.UserId =  ZU.UserId AND b.AttributeValue = '''' ) AND ZOQ.IsPendingPayment =  1    '    
         
    END     
    ELSE     
    BEGIN    
       SET @InnerWhereClause = @InnerWhereClause+' AND ZOQ.IsPendingPayment = 0   '    
    END     
    
    SET @InnerWhereClause = @InnerWhereClause + CASE WHEN @AccountId > 0 THEN 
		' AND CASE WHEN ISNULL(ZOQ.AccountId,0)<>0 THEN ZOQ.AccountId ELSE ZA.AccountId END ='+CAST(@AccountId AS VARCHAR(200)) ELSE '' END     
    
    SET @SQL = '       
		;With Cte_GetQuoteDetail AS     
		(    
			SELECT distinct Zu.UserId ,ZOQ.OmsQuoteId,ZU.FirstName + CASE WHEN ZU.LastName IS NULL THEN '''' ELSE '' ''+Zu.LastName END UserName , QuoteOrderTotal , ZOOS.Description [OrderStatus]    
			,ZOQ.CreatedDate,ZA.Name AccountName,ZP.PortalId,Zp.StoreName , ZCC.CurrencyCode AS CurrencyCode, ZC.CultureCode AS CultureCode ,ZVGD.UserName CreatedByName , ZVGDI.UserName ModifiedByName,    
			case When ZOQ.IsConvertedToOrder IS NULL THEN 0 ELSE ZOQ.IsConvertedToOrder END IsConvertedToOrder,ISNULL(DT.QuoteTypeCode,'''') QuoteTypeCode,ZODPS.DisplayName as PublishState,
			'+case when cast(@IsParentPendingOrder as varchar(10)) = 0  then +'Case  When TYUI.ApproverUserId ='+CAST(@UserId AS VARCHAR(50))  + ' then ''Approval Requested'' 
			else ''Pending For Approval'' END' else '''''' end +' OrderType, ZA.AccountCode    
			FROM ZnodeOmsQuote ZOQ    
			INNER JOIN ZnodeUser ZU ON (ZU.UserId = ZOQ.UserId)    
			LEFT JOIN ZnodePublishState ZODPS ON (ZODPS.PublishStateId = ZOQ.PublishStateId)  
			LEFT JOIN ZnodeUserPortal ZUP ON ZU.UserId = ZUP.UserId    
			inner JOIN ZnodePortal ZP ON ZP.PortalId = Zoq.PortalId    
			'+CASE WHEN @IsParentPendingOrder = 0  THEN ' LEFT JOIN ZnodeOMSQuoteApproval TYUI ON (TYUI.OmsQuoteId = ZOQ.OmsQuoteId AND TYUI.ApproverUserId ='+CAST(@UserId AS VARCHAR(50))+' ) ' ELSE '' END +'    
			LEFT JOIN ZnodePortalUnit ZPU ON (ZPU.PortalId = Zp.PortalId)    
			LEFT JOIN ZnodeCulture ZC ON (ZPU.CultureId = ZC.CultureId)    --- Changed join condition from CurrencyId to CultureId    
			LEFT JOIN ZnodeCurrency ZCC ON (ZC.CurrencyId = ZCC.CurrencyId)    --- Joined ZnodeCulture and ZnodeCurrency   
			LEFT JOIN ZnodeOmsOrderState ZOOS ON (ZOOS.OmsOrderStateId = '+CASE WHEN @IsParentPendingOrder = 0 AND EXISTS (SELECT TOP 1 1 FROM ZnodeOMSQuoteApproval OQ WHERE OQ.ApproverUserId = @UserId) THEN 'TYUI.OmsOrderStateId ' ELSE 'ZOQ.OmsOrderStateId' END  +' )     
			LEFT JOIN ZnodeAccount ZA ON (ZA.AccountId = (CASE WHEN ISNULL(ZOQ.AccountId,0)<>0 THEN ZOQ.AccountId ELSE ZU.AccountId END))    
			LEFT JOIN [dbo].[View_GetUserDetails]  ZVGD ON (ZVGD.UserId = ZOQ.CreatedBy )    
			LEFT JOIN [dbo].[View_GetUserDetails]  ZVGDI ON (ZVGDI.UserId = ZOQ.ModifiedBy)    
			INNER JOIN ZnodeOmsQuoteType DT ON (DT.OmsQuoteTypeId = ZOQ.OmsQuoteTypeId)    
			WHERE DT.OmsQuoteTypeId <> (select top 1 OmsQuoteTypeId from ZnodeOmsQuoteType where QuoteTypeCode = ''QUOTE'')'+' '+@InnerWhereClause+@QuoteFilter+'    
			and (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and ZOQ.UserId = SalRep.CustomerUserid) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
			UNION 
			SELECT Zu.UserId ,ZOQ.OmsQuoteId,ZU.FirstName + CASE WHEN ZU.LastName IS NULL THEN '''' ELSE '' ''+Zu.LastName END UserName , QuoteOrderTotal , ZOOS.Description [OrderStatus]    
			,ZOQ.CreatedDate,ZA.Name AccountName,ZP.PortalId,Zp.StoreName , ZCC.CurrencyCode AS CurrencyCode, ZC.CultureCode AS CultureCode ,ZVGD.UserName CreatedByName , ZVGDI.UserName ModifiedByName,    
			case When ZOQ.IsConvertedToOrder IS NULL THEN 0 ELSE ZOQ.IsConvertedToOrder END IsConvertedToOrder,ISNULL(DT.QuoteTypeCode,'''') QuoteTypeCode,ZODPS.DisplayName as PublishState,
			'+case when cast(@IsParentPendingOrder as varchar(10)) = 0  then +'Case  When TYUI.ApproverUserId ='+CAST(@UserId AS VARCHAR(50))  + ' then ''Approval Requested'' 
			else ''Pending For Approval'' END' else '''''' end +' OrderType, ZA.AccountCode    
			FROM ZnodeOmsQuote ZOQ    
			INNER JOIN ZnodeUser ZU ON (ZU.UserId = ZOQ.UserId)    
			LEFT JOIN ZnodePublishState ZODPS ON (ZODPS.PublishStateId = ZOQ.PublishStateId)  
			LEFT JOIN ZnodeUserPortal ZUP ON ZU.UserId = ZUP.UserId    
			inner JOIN ZnodePortal ZP ON ZP.PortalId = Zoq.PortalId    
			'+CASE WHEN @IsParentPendingOrder = 0  THEN ' LEFT JOIN ZnodeOMSQuoteApproval TYUI ON (TYUI.OmsQuoteId = ZOQ.OmsQuoteId AND TYUI.ApproverUserId ='+CAST(@UserId AS VARCHAR(50))+' ) ' ELSE '' END +'    
			LEFT JOIN ZnodePortalUnit ZPU ON (ZPU.PortalId = Zp.PortalId)    
			LEFT JOIN ZnodeCulture ZC ON (ZPU.CultureId = ZC.CultureId)    --- Changed join condition from CurrencyId to CultureId    
			LEFT JOIN ZnodeCurrency ZCC ON (ZC.CurrencyId = ZCC.CurrencyId)    --- Joined ZnodeCulture and ZnodeCurrency   
			LEFT JOIN ZnodeOmsOrderState ZOOS ON (ZOOS.OmsOrderStateId = '+CASE WHEN @IsParentPendingOrder = 0 AND EXISTS (SELECT TOP 1 1 FROM ZnodeOMSQuoteApproval OQ WHERE OQ.ApproverUserId = @UserId) THEN 'TYUI.OmsOrderStateId ' ELSE 'ZOQ.OmsOrderStateId' END  +' )     
			LEFT JOIN ZnodeAccount ZA ON (ZA.AccountId = (CASE WHEN ISNULL(ZOQ.AccountId,0)<>0 THEN ZOQ.AccountId ELSE ZU.AccountId END))    
			LEFT JOIN [dbo].[View_GetUserDetails]  ZVGD ON (ZVGD.UserId = ZOQ.CreatedBy )    
			LEFT JOIN [dbo].[View_GetUserDetails]  ZVGDI ON (ZVGDI.UserId = ZOQ.ModifiedBy)    
			INNER JOIN ZnodeOmsQuoteType DT ON (DT.OmsQuoteTypeId = ZOQ.OmsQuoteTypeId)    
			WHERE  DT.OmsQuoteTypeId <> (select top 1 OmsQuoteTypeId from ZnodeOmsQuoteType where QuoteTypeCode = ''QUOTE'')'+
			'AND DT.OmsQuoteTypeId = (select top 1 OmsQuoteTypeId from ZnodeOmsQuoteType where QuoteTypeCode = ''OAB'')'+' '+@InnerWhereClause+'    
			and (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and ZOQ.UserId = SalRep.CustomerUserid) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
		)    
		, Cte_GetQuote AS     
		(    
			SELECT distinct OmsQuoteId,UserName ,AccountName , QuoteOrderTotal QuoteAmount, [OrderStatus]  ,CreatedDate ,StoreName,CurrencyCode, CultureCode,PublishState,CreatedByName , ModifiedByName ,IsConvertedToOrder,OrderType,'+dbo.Fn_GetPagingRowId(@Order_BY,'CreatedDate DESC 
			,OmsQuoteId DESC')+',Count(*)Over() CountNo ,UserId, AccountCode      
			FROM Cte_GetQuoteDetail    
			WHERE 1=1     
			'+dbo.Fn_GetFilterWhereClause(@WhereClause)+'    
		)    
		SELECT distinct OmsQuoteId,UserName ,AccountName ,  QuoteAmount, [OrderStatus]  ,CreatedDate ,StoreName,CurrencyCode, CultureCode,PublishState,RowId,CountNo,CreatedByName , ModifiedByName,IsConvertedToOrder,OrderType, UserId , AccountCode   
		FROM Cte_GetQuote     
		'+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows) 
	
      print @SQL
        INSERT INTO @TBL_QuoteDetails (OmsQuoteId, UserName, AccountName, QuoteOrderTotal ,OrderStatus, CreatedDate, StoreName,CurrencyCode, CultureCode,PublishState, RowId ,CountNo,CreatedByName , ModifiedByName,IsConvertedToOrder,OrderType, UserId, AccountCode)          
        EXEC (@SQL);   	
        SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM @TBL_QuoteDetails), 0);    

        SELECT  OmsQuoteId,UserName,AccountName,QuoteOrderTotal,[OrderStatus],CreatedDate,StoreName,CurrencyCode, CultureCode,PublishState,CreatedByName , ModifiedByName,IsConvertedToOrder  ,OrderType , UserId, AccountCode 
        FROM @TBL_QuoteDetails 
		ORDER BY  RowId
		      
         END TRY    
         BEGIN CATCH    
		DECLARE @Status BIT ;    
		SET @Status = 0;    
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetOmsQuoteList @WhereClause = '+CAST(@WhereClause AS VARCHAR(max)  
		)+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@AccountId='+CAST(@AccountId AS VARCHAR(50))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@PortalId='+''  
		+',@Status='+CAST(@Status AS VARCHAR(10));    
                      
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                        
        
		EXEC Znode_InsertProcedureErrorLog    
		@ProcedureName = 'Znode_GetOmsQuoteList',    
		@ErrorInProcedure = @Error_procedure,    
		@ErrorMessage = @ErrorMessage,    
		@ErrorLine = @ErrorLine,    
		@ErrorCall = @ErrorCall;    
    END CATCH;    
END

GO

update ZnodeMenuActionsPermission set MenuId=(select Top 1 MenuId from ZnodeMenu where MenuName='Orders')
where ActionId=(select Top 1 ActionId from ZnodeActions where ActionName='FailedOrderTransactionList');

update ZnodeActionMenu set MenuId= (select Top 1 MenuId from ZnodeMenu where MenuName='Orders') 
where ActionId=(select Top 1 ActionId from ZnodeActions where ActionName='FailedOrderTransactionList');

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCustomerAddress')
	DROP PROC Znode_ImportCustomerAddress
GO

CREATE PROCEDURE [dbo].[Znode_ImportCustomerAddress](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @LocaleId int= 0,@PortalId int ,@CsvColumnString nvarchar(max), @IsAccountAddress bit = 0 )
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import SEO Details
	
	-- Unit Testing : 
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(max),@IsAllowGlobalLevelUserCreation NVARCHAR(10)

		DECLARE @GETDATE DATETIME= dbo.Fn_GETDATE();
		-- Retrive Value FROM global setting 
		SELECT @IsAllowGlobalLevelUserCreation = FeatureValues FROM ZnodeGlobalsetting WHERE FeatureName = 'AllowGlobalLevelUserCreation'
		-- Three type of import required three table varible for product , category AND brand

		CREATE TABLE #InsertCustomerAddress 
		( 
			RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT,UserName NVARCHAR(512),FirstName VARCHAR(300),
			LastName VARCHAR(300),DisplayName NVARCHAR(1200),Address1 VARCHAR(300),Address2 VARCHAR(300),
			CountryName VARCHAR(3000),StateName VARCHAR(3000),CityName VARCHAR(3000),PostalCode VARCHAR(50),
			PhoneNumber VARCHAR(50),IsDefaultBilling BIT,IsDefaultShipping BIT	,IsActive BIT,ExternalId NVARCHAR(2000),
			CompanyName NVARCHAR(2000), GUID NVARCHAR(400)
		);
	
		SET @SSQL = ' INSERT INTO #InsertCustomerAddress ( RowNumber, ' + @CsvColumnString + ' ,GUID )
		SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+ @TableName;
		EXEC sys.sp_sqlexec @SSQL;

		-- start Functional Validation 
		----------------------------------------------
		IF (@IsAccountAddress = 0)
		BEGIN
			IF @IsAllowGlobalLevelUserCreation = 'true'
					INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
						   SELECT '106', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
						   FROM #InsertCustomerAddress AS ii
						   WHERE ii.UserName NOT IN 
						   (
							   SELECT UserName FROM AspNetZnodeUser   WHERE PortalId = @PortalId
						   );
			ELSE 
					INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
						   SELECT '106', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
						   FROM #InsertCustomerAddress AS ii
						   WHERE ii.UserName NOT IN 
						   (
							   SELECT UserName FROM AspNetZnodeUser   
						   );

					INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
							SELECT '8', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
							FROM #InsertCustomerAddress AS ii
							WHERE ISNULL(ltrim(rtrim(ii.UserName)), '') = ''

		 END

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '8', 'StateName', StateName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
		FROM #InsertCustomerAddress AS ii
		WHERE NOT EXISTS(SELECT * FROM ZnodeState ZS INNER JOIN ZnodeCountry ZC ON ZS.CountryCode = ZC.CountryCode
			where ii.CountryName = ZC.CountryName AND ZS.StateName = ISNULL(ltrim(rtrim(ii.StateName)), ''))

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '8', 'CountryName', CountryName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
		FROM #InsertCustomerAddress AS ii
		WHERE NOT EXISTS(SELECT * FROM ZnodeCountry ZC WHERE ZC.CountryName = ISNULL(ltrim(rtrim(ii.CountryName)), '') )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '90', 'CountryName', CountryName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
		FROM #InsertCustomerAddress AS ii
		WHERE ISNULL(ltrim(rtrim(ii.CountryName)), '') <> ''
		AND NOT EXISTS(SELECT * FROM ZnodePortalCountry ZPC INNER JOIN ZnodeCountry ZC ON ZPC.CountryCode = ZC.CountryCode
		    WHERE PortalId = @PortalId AND ltrim(rtrim(ii.CountryName)) = ltrim(rtrim(ZC.CountryName)))

		 -- error log when atleast db have 
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '63', 'IsDefaultBilling/IsDefaultShipping', IsDefaultBilling, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
		FROM #InsertCustomerAddress IC WHERE  exists (
		SELECT TOP 1 1  FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
		INNER JOIN ZnodeUserAddress ZUA ON ZUA.UserId = ZU.UserId
		INNER JOIN ZnodeAddress ZA ON ZUA.AddressId = ZA.AddressId
		where ANZU.UserName = IC.UserName AND ZA.IsDefaultBilling =IC.IsDefaultBilling 
		AND ZA.IsDefaultShipping =IC.IsDefaultShipping )

		--Note : Content page import is not required 
		
		-- End Function Validation 	
		-----------------------------------------------
		UPDATE ZIL
		SET ZIL.ColumnName =   ZIL.ColumnName + ' [ UserName - ' + ISNULL(UserName,'') + ' ] '
		FROM ZnodeImportLog ZIL 
		INNER JOIN #InsertCustomerAddress IPA ON (ZIL.RowNumber = IPA.RowNumber)
		WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL


		DELETE FROM #InsertCustomerAddress
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber IS NOT NULL 
			--AND GUID = @NewGUID
		);

		UPDATE ZA SET ZA.IsDefaultBilling = 0
		FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
		INNER JOIN ZnodeUserAddress ZUA ON ZUA.UserId = ZU.UserId
		INNER JOIN ZnodeAddress ZA ON ZUA.AddressId = ZA.AddressId
		INNER JOIN #InsertCustomerAddress IC ON ANZU.UserName = IC.UserName --and IC.IsDefaultBilling <> ZA.IsDefaultBilling 
		where IC.IsDefaultBilling = 1 

		UPDATE ZA SET ZA.IsDefaultShipping = 0
		FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
		INNER JOIN ZnodeUserAddress ZUA ON ZUA.UserId = ZU.UserId
		INNER JOIN ZnodeAddress ZA ON ZUA.AddressId = ZA.AddressId
		INNER JOIN #InsertCustomerAddress IC ON ANZU.UserName = IC.UserName
		where IC.IsDefaultShipping = 1 

		--DELETE FROM ZnodeImportLog  WHERE ImportProcessLogId = @ImportProcessLogId AND  ErrorDescription = '63'
		-- UPDATE Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		SELECT @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertCustomerAddress
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- End
		
		DELETE FROM #InsertCustomerAddress 
		WHERE NOT EXISTS
			(SELECT TOP 1 1 FROM 
				(
					SELECT ROW_NUMBER() OVER(PARTITION BY UserName	
					,FirstName	,LastName	,DisplayName	,Address1	,Address2	
					,CountryName	,StateName	,CityName	,PostalCode	
					,PhoneNumber	,IsDefaultBilling,IsDefaultShipping,ExternalId	,CompanyName ORDER BY RowId desc) 
					AS rw_nmbr,RowId  FROM #InsertCustomerAddress 
				) abc WHERE rw_nmbr =1 AND abc.RowId = #InsertCustomerAddress.RowId
			)

		----------UPDATE ZnodeAddress
		DECLARE @AddressColumnString VARCHAR(1000), @WhereConditionString VARCHAR(1000), @UpdateColumnString VARCHAR(1000)

		SELECT @AddressColumnString = COALESCE(@AddressColumnString + ',', '')+a.ColumnName --COALESCE(@CsvColumnString + ' AND ', '') +'ZA.'+ColumnName+' =  IC.'+ColumnName
		FROM ZnodeImportUpdatableColumns a
		INNER JOIN INFORMATION_SCHEMA.COLUMNS b ON a.ColumnName = b.COLUMN_NAME  
		INNER JOIN dbo.Split(@CsvColumnString,',')C ON b.COLUMN_NAME = c.Item
		WHERE b.TABLE_NAME = 'ZnodeAddress' 
		AND EXISTS(SELECT * FROM ZnodeImportHead IH WHERE a.ImportHeadId = IH.ImportHeadId AND IH.Name in ('CustomerAddress','ShippingAddress'))

		SELECT @UpdateColumnString = COALESCE(@UpdateColumnString + ' , ', '') +'ZA.'+a.COLUMN_NAME+' =  IC.'+a.COLUMN_NAME  
		FROM INFORMATION_SCHEMA.COLUMNS a
		INNER JOIN dbo.Split(@CsvColumnString,',')b ON a.COLUMN_NAME = b.Item
		WHERE NOT EXISTS (SELECT * FROM dbo.Split(@AddressColumnString,',') c WHERE a.COLUMN_NAME = c.Item )
		AND a.TABLE_NAME = 'ZnodeAddress'

		SELECT @WhereConditionString = COALESCE(@WhereConditionString + ' AND ', '') +'ZA.'+item+' =  IC.'+item FROM dbo.split(@AddressColumnString,',')
		SET @WhereConditionString = Replace(@WhereConditionString , 'ZA.Address2 =  IC.Address2', 'ISNULL(ZA.Address2 ,'''')=  ISNULL(IC.Address2 ,'''')') 
		
		UPDATE a SET a.StateName =c.StateCode  
		FROM #InsertCustomerAddress a 
		INNER JOIN ZnodeCountry b ON a.CountryName = b.CountryName 
		INNER JOIN ZnodeState c ON b.CountryCode = c.CountryCode AND C.StateName = a.StateName
		
		UPDATE a SET a.CountryName= b.CountryCode FROM  #InsertCustomerAddress a INNER JOIN ZnodeCountry b ON a.CountryName = b.CountryName 
		
		CREATE TABLE #InsertedUserAddress (AddressId  NVARCHAR(256), UserId NVARCHAR(max)) 

		IF ( @IsAccountAddress = 1 )
		BEGIN
			UPDATE ZnodeAddress SET IsDefaultBilling = 0,  IsDefaultShipping = 0
			FROM AspNetZnodeUser ANZU 
			INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
			INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
			INNER JOIN ZnodeUserAddress ZUA ON ZUA.UserId = ZU.UserId
			INNER JOIN ZnodeAddress ZA ON ZUA.AddressId = ZA.AddressId
			INNER JOIN #InsertCustomerAddress IC ON ANZU.UserName = IC.UserName AND ZA.IsDefaultBilling =IC.IsDefaultBilling 
													AND ZA.IsDefaultShipping =IC.IsDefaultShipping

					SET @SSQL = '
						UPDATE ZA set ModifiedBy = '+CONVERT(VARCHAR(10), @UserId)+', ModifiedDate = getdate() '+CASE WHEN ISNULL(@UpdateColumnString,'') = '' THEN '' ELSE ','+@UpdateColumnString END+' 
						FROM ZnodeAddress ZA
						INNER JOIN #InsertCustomerAddress IC ON '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END

			EXEC (@SSQL)

					SET @SSQL = '
					Insert into ZnodeAddress (FirstName,LastName,DisplayName,Address1,Address2,Address3,CountryName,
											StateName,CityName,PostalCode,PhoneNumber,
											IsDefaultBilling,IsDefaultShipping,IsActive,ExternalId,CompanyName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsShipping,IsBilling)		
					OUTPUT INSERTED.AddressId INTO  #InsertedUserAddress (AddressId) 			 
					SELECT IC.FirstName,IC.LastName,IC.DisplayName,IC.Address1,IC.Address2,null,IC.CountryName ,
					IC.StateName,
					,IC.CityName,IC.PostalCode,IC.PhoneNumber,
					isnull(IC.IsDefaultBilling,0),isnull(IC.IsDefaultShipping,0),isnull(IC.IsActive,0),IC.ExternalId,IC.CompanyName, '+CONVERT(VARCHAR(10), @UserId)+' , getdate() , '+CONVERT(VARCHAR(10), @UserId)+' ,getdate(), 1, 1
					FROM  #InsertCustomerAddress IC
					WHERE NOT EXISTS(SELECT * FROM ZnodeAddress ZA WHERE '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END +')'

			EXEC (@SSQL)

			DECLARE @AccountId INT
			SELECT @AccountId = AccountId FROM ZnodeUser WHERE UserId = @UserId
			INSERT INTO ZnodeAccountAddress ( AccountId, AddressId, CreatedBy, CreatedDate,	ModifiedBy,	ModifiedDate )
			SELECT @AccountId, Addressid ,  @UserId , @GETDATE, @UserId , @GETDATE FROM #InsertedUserAddress UA
			WHERE NOT EXISTS ( SELECT * FROM ZnodeAccountAddress AA WHERE AccountId = @AccountId AND AA.Addressid = UA.Addressid )
		END
		ELSE
		BEGIN
		
			UPDATE ZnodeAddress SET IsDefaultBilling = 0,  IsDefaultShipping = 0
			FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
			INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
			INNER JOIN ZnodeUserAddress ZUA ON ZUA.UserId = ZU.UserId
			INNER JOIN ZnodeAddress ZA ON ZUA.AddressId = ZA.AddressId
			INNER JOIN #InsertCustomerAddress IC ON ANZU.UserName = IC.UserName AND ZA.IsDefaultBilling =IC.IsDefaultBilling 
			AND ZA.IsDefaultShipping =IC.IsDefaultShipping
					
					SET @SSQL = '
						UPDATE ZA set ModifiedBy = '+CONVERT(VARCHAR(10), @UserId)+', ModifiedDate = getdate() '+CASE WHEN ISNULL(@UpdateColumnString,'') = '' THEN '' ELSE ','+@UpdateColumnString END+' 
						FROM ZnodeAddress ZA 
						INNER JOIN #InsertCustomerAddress IC ON '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END
						
					Print @SSQL
					EXEC (@SSQL)
									
					SET @SSQL = '
					Insert into ZnodeAddress (FirstName,LastName,DisplayName,Address1,Address2,Address3,CountryName,
												StateName,CityName,PostalCode,PhoneNumber,
												IsDefaultBilling,IsDefaultShipping,IsActive,ExternalId,CompanyName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsShipping,IsBilling)		
					OUTPUT INSERTED.AddressId, INSERTED.Address3 INTO  #InsertedUserAddress (AddressId, UserId ) 			 
					SELECT IC.FirstName,IC.LastName,IC.DisplayName,IC.Address1,IC.Address2,convert(nvarchar(100),ZU.UserId),IC.CountryName ,
					IC.StateName 
					,IC.CityName,IC.PostalCode,IC.PhoneNumber,
					isnull(IC.IsDefaultBilling,0),isnull(IC.IsDefaultShipping,0),isnull(IC.IsActive,0),IC.ExternalId,IC.CompanyName, '+CONVERT(VARCHAR(10), @UserId)+' , getdate() , '+CONVERT(VARCHAR(10), @UserId)+' ,getdate(),1,1
					FROM AspNetZnodeUser ANZU 
					INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
					INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
					INNER JOIN #InsertCustomerAddress IC ON ANZU.UserName = IC.UserName 
					WHERE NOT EXISTS(SELECT * FROM ZnodeAddress ZA WHERE '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END +')'
					print @SSQL
					EXEC (@SSQL)

			INSERT INTO ZnodeUserAddress(UserId,AddressId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT CAST( UserId AS INT ) , Addressid , @UserId , @GETDATE, @UserId , @GETDATE FROM  #InsertedUserAddress
		END
				
		UPDATE ZA SET ZA.CountryName = ZC.CountryCode
		FROM ZnodeAddress ZA
		INNER JOIN ZnodeCountry ZC ON ltrim(rtrim(ZA.CountryName)) = ltrim(rtrim(ZC.CountryName))

		UPDATE ZA SET ZA.Address3 = null 
		FROM ZnodeAddress ZA INNER JOIN #InsertedUserAddress IUA ON ZA.AddressId = IUA.AddressId 

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCustomerAddress @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@LocaleId='+CAST(@LocaleId AS VARCHAR(max)) +',@PortalId='+CAST(@PortalId AS VARCHAR(max)) +',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max)) +',@IsAccountAddress='+CAST(@IsAccountAddress AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GETDATE
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId

		--Updating total AND fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportCustomerAddress',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		
	END CATCH;
END;


GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'ZnodeReport_DashboardQuotes')
	DROP PROC ZnodeReport_DashboardQuotes
GO

CREATE PROCEDURE [dbo].[ZnodeReport_DashboardQuotes]              
(             
	@PortalId  bigint  = null,        
	@AccountId bigint  = null,    
	@SalesRepUserId int = 0                
)              
AS               
/*              
     Summary:- This procedure is used to get the order details               
    Unit Testing:              
     EXEC [ZnodeReport_DashboardTopCategory]              
*/              
BEGIN              
BEGIN TRY              
SET NOCOUNT ON;              
	
	DECLARE @TopItem TABLE (ItemName nvarchar(100),CustomerName varchar(302),ItemId nvarchar(10), Total numeric(28,6) , Date datetime,Symbol NVARCHAR(10))               
     
	DECLARE @RoundOffValue INT= dbo.Fn_GetDefaultValue('PriceRoundOff')      
        
	----Verifying that the @SalesRepUserId is having 'Sales Rep' role
	IF NOT EXISTS
	(
		SELECT * FROM ZnodeUser ZU
		INNER JOIN AspNetZnodeUser ANZU ON ZU.UserName = ANZU.UserName
		INNER JOIN AspNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName
		INNER JOIN AspNetUserRoles ANUR ON ANU.Id = ANUR.UserId
		Where Exists(select * from AspNetRoles ANR Where Name = 'Sales Rep' AND ANUR.RoleId = ANR.Id) 
		AND ZU.UserId = @SalesRepUserId
	)   
	Begin
		SET @SalesRepUserId = 0
	End              
  
	DECLARE @TBL_CultureCurrency TaBLE (Symbol Varchar(100),CurrencyCode varchar(100))              
	INSERT INTO @TBL_CultureCurrency (Symbol,CurrencyCode)              
	SELECT Symbol,CultureCode FROM  ZnodeCulture ZC               
	DECLARE @PortalCurrencySymbol nvarchar(20)          
	DECLARE @DefaultCurrencySymbol nvarchar(20)            
            
	SET @PortalCurrencySymbol = [dbo].[Fn_GetPortalCurrencySymbol](CAST(@PortalID AS INTEGER) )          
	SET @DefaultCurrencySymbol = [dbo].[Fn_GetDefaultCurrencySymbol]()           
          
	IF @PortalCurrencySymbol IS NULL           
	UPDATE @TBL_CultureCurrency SET Symbol  =@DefaultCurrencySymbol WHERE  Symbol IS NULL          
	ELSE           
	UPDATE @TBL_CultureCurrency SET Symbol  =@PortalCurrencySymbol WHERE  Symbol IS NULL          
     
	CREATE TABLE #User(UserId INT, FirstName varchar(100), MiddleName varchar(100), LastName varchar(100), Email varchar(50), PhoneNumber varchar(50))

	IF @AccountId = -1
		INSERT INTO #User(UserId, FirstName, MiddleName, LastName, Email , PhoneNumber )
		SELECT ZU.UserId, ZU.FirstName, ZU.MiddleName, ZU.LastName, ZU.Email , ZU.PhoneNumber                    
		FROM ZnodeUser ZU           
		WHERE EXISTS(SELECT * FROM ZnodeOmsQuote ZOQ where ZU.UserId = ZOQ.UserID )        
		and ISNULL(ZU.AccountId,0) = 0      
	Else
		INSERT INTO #User(UserId, FirstName, MiddleName, LastName, Email , PhoneNumber )
		SELECT ZU.UserId, ZU.FirstName, ZU.MiddleName, ZU.LastName, ZU.Email , ZU.PhoneNumber          
		FROM ZnodeUser ZU           
		WHERE EXISTS(SELECT * FROM ZnodeOmsQuote ZOQ where ZU.UserId = ZOQ.UserID )        
		and (ZU.AccountId = @AccountId or isnull(@AccountId,0) = 0 ) 
          
	Update ZOQ set OmsOrderStateId = (select top 1 OmsOrderStateId from ZnodeOMSOrderState where OrderStateName = 'EXPIRED')          
	from ZnodeOmsQuote ZOQ          
	Inner Join ZnodeOmsQuoteType ZOQT ON ZOQ.OmsQuoteTypeId = ZOQT.OmsQuoteTypeId          
	INNER JOIN #User U ON ZOQ.UserId = U.UserId           
	INNER JOIN ZnodePortal ZP ON ZOQ.PortalID = ZP.PortalID          
	INNER JOIN ZnodeOMSOrderState ZOOS ON ZOOS.OmsOrderStateId = ZOQ.OmsOrderStateId          
	where  (ZOQ.PortalID = @PortalId OR @PortalId = 0 OR @PortalId is null)          
	and cast(ZOQ.QuoteExpirationDate as date) < cast(GETDATE() as date)          
	and ZOQ.OmsOrderStateId <> (select top 1 OmsOrderStateId from ZnodeOMSOrderState where OrderStateName = 'EXPIRED')          
          
	insert into @TopItem(ItemId, ItemName,CustomerName,Date,Total,Symbol)          
	Select ZOQ.OmsQuoteId,ZOQ.QuoteNumber as QuoteNumber,isnull(U.FirstName,'')+case when U.MiddleName is not null then ' ' else '' end+ isnull(U.MiddleName,'')+' '+isnull(U.LastName,'') as CustomerName,          
	ZOQ.CreatedDate as QuoteDate,round(ZOQ.QuoteOrderTotal,@RoundOffValue) as TotalAmount        
	,COALESCE (ZC.Symbol,[dbo].[Fn_GetPortalCurrencySymbol](CAST(@PortalId AS INTEGER)),[dbo].[Fn_GetDefaultCurrencySymbol]()) Symbol              
	from ZnodeOmsQuote ZOQ          
	Inner Join ZnodeOmsQuoteType ZOQT ON ZOQ.OmsQuoteTypeId = ZOQT.OmsQuoteTypeId          
	INNER JOIN #User U ON ZOQ.UserId = U.UserId           
	INNER JOIN ZnodePortal ZP ON ZOQ.PortalID = ZP.PortalID          
	INNER JOIN ZnodeOMSOrderState ZOOS ON ZOOS.OmsOrderStateId = ZOQ.OmsOrderStateId          
	LEFT JOIN @TBL_CultureCurrency ZC ON (ZC.CurrencyCode = ZOQ.CultureCode )           
	where  (ZOQ.PortalID = @PortalId OR @PortalId = 0 OR @PortalId is null)          
	and (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = @SalesRepUserId and U.UserId = SalRep.CustomerUserid) or @SalesRepUserId = 0)              
	and ZOQT.QuoteTypeCode = 'QUOTE'
	
	SELECT TOP 5 ItemId, ItemName,CustomerName,Date,Total,Symbol FROM @TopItem Order by  Convert(datetime,Date )  desc                
   
END TRY              
              
BEGIN CATCH              
	DECLARE @Status BIT ;              
		SET @Status = 0;              
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),              
	@ErrorCall NVARCHAR(MAX)= 'EXEC ZnodeReport_DashboardQuotes @PortalId = '+CAST(@PortalId AS VARCHAR(50));             
                                
				SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                                  
                  
				EXEC Znode_InsertProcedureErrorLog              
	@ProcedureName = 'ZnodeReport_DashboardQuotes',              
	@ErrorInProcedure = @Error_procedure,              
	@ErrorMessage = @ErrorMessage,              
	@ErrorLine = @ErrorLine,              
	@ErrorCall = @ErrorCall;              
END CATCH              
              
END;


GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishProductJson')
	DROP PROC Znode_GetPublishProductJson
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishProductJson]  
(  
	@PublishCatalogId INT = 0   
	,@PimProductId     TransferId Readonly  
	,@UserId     INT = 0   
	,@PimCatalogId     INT = 0   
	,@VersionIdString  VARCHAR(2000)= ''  
	,@Status     Bit  OutPut  
	,@RevisionState   Varchar(50) = ''  
	,@IsDraftProductsOnly BIT = 1  
)  
WITH RECOMPILE 
AS  
/*  
DECLARE @rrte transferId   
INSERT INTO @rrte  
SELECT 1  
  
EXEC [_POC_Znode_GetPublishProductbulk] @PublishCatalogId=9,@UserId= 2 ,@localeIDs = @rrte,@PublishStateId = 3   
  
*/  
BEGIN  
BEGIN Try   
	SET NOCOUNT ON;  
	SET @Status = 0    
	Declare  @RevisionType VARCHAR(50) = ''   
	Declare @VersionId int = 0   
	DECLARE @PortalId INT = (SELECT TOP 1 POrtalId FROM ZnodePortalCatalog WHERE PublishCatalogId = @PublishCatalogId)  
	DECLARE @PriceListId INT = (SELECT TOP 1 PriceListId FROM ZnodePriceListPortal WHERE PortalId = @PortalId )  
	DECLARE @DomainUrl varchar(max) = (SELECT TOp 1 URL FROM ZnodeMediaConfiguration WHERE IsActive =1)  
	DECLARE @MaxSmallWidth INT  = (SELECT TOP 1  MAX(MaxSmallWidth) FROM ZnodeGlobalMediaDisplaySetting)  
	DECLARE @PimMediaAttributeId INT = dbo.Fn_GetProductImageAttributeId()  
  
	DECLARE @TBL_LocaleId  TABLE (RowId INT IDENTITY(1,1) PRIMARY KEY  , LocaleId INT , VersionId int,RevisionType varchar(50)  )  
	DECLARE @LocaleIds transferId   

	INSERT INTO @TBL_LocaleId (LocaleId,VersionId,RevisionType)  
	SELECT PV.LocaleId , PV.VersionId , PV.RevisionType  
	FROM ZnodePublishVersionEntity PV INNER JOIN Split(@VersionIdString,',') S ON PV.VersionId = S.Item  

	 --Getting active local for catalog which are associated to store
	INSERT INTO @LocaleIds (Id) 
	SELECT LocaleId FROM DBO.FN_GetCatalogPortalActiveLocale(@PublishCatalogId)
   
	DECLARE --@ProductNamePimAttributeId INT = dbo.Fn_GetProductNameAttributeId(),  
	@DefaultLocaleId INT= Dbo.Fn_GetDefaultLocaleId(),@LocaleId INT = 0   
	--,@SkuPimAttributeId  INT =  dbo.Fn_GetProductSKUAttributeId() , @IsActivePimAttributeId INT =  dbo.Fn_GetProductIsActiveAttributeId()  
	DECLARE @GetDate DATETIME =dbo.Fn_GetDate()  
  
	DECLARE @DefaultPortal int, @IsAllowIndexing int  
	SELECT @DefaultPortal = ZPC.PortalId, @IsAllowIndexing = 1 FROM ZnodePimCatalog ZPC INNER JOIN ZnodePublishCatalog ZPC1 ON ZPC.PimCatalogId = ZPC1.PimCatalogId WHERE ZPC1.PublishCatalogId =  @PublishCatalogId AND isnull(ZPC.IsAllowIndexing,0) = 1   
     
	-----DELETE unwanted publish data  
	DELETE ZPC FROM ZnodePublishCategoryProduct ZPC  
	WHERE NOT EXISTS(SELECT * FROM ZnodePublishCategory ZC WHERE ZPC.PublishCategoryId = ZC.PublishCategoryId )  
  
	DELETE ZPP FROM ZnodePublishCategoryProduct ZPP  
	WHERE NOT EXISTS(SELECT * FROM ZnodePublishProduct ZP WHERE ZPP.PublishProductId = ZP.PublishProductId )  
  
	DELETE ZPP FROM ZnodePublishCatalogProductDetail ZPP  
	WHERE NOT EXISTS(SELECT * FROM ZnodePublishProduct ZP WHERE ZPP.PublishProductId = ZP.PublishProductId )  
  
	DELETE ZPCP FROM ZnodePublishCatalogProductDetail ZPCP  
	INNER JOIN ZnodePublishProduct b on ZPCP.PublishProductId = b.PublishProductId   
	WHERE NOT EXISTS(SELECT * FROM ZnodePimCategoryProduct a  
	INNER JOIN ZnodePimCategoryHierarchy ZPCH on ZPCH.PimCategoryID = a.PimCategoryId   
	WHERE b.PimProductId = A.PimProductId AND ZPCP.PimCategoryHierarchyId = ZPCH.PimCategoryHierarchyId)  
	AND isnull(ZPCP.PimCategoryHierarchyId,0) <> 0 AND b.PublishCatalogId = @PublishCatalogId  
	---------  
  
	DECLARE @Counter INT =1 ,@maxCountId INT = (SELECT max(RowId) FROM @TBL_LocaleId )   
  
	CREATE TABLE #ZnodePrice (RetailPrice numeric(28,13),SalesPrice numeric(28,13),CurrencyCode varchar(100), CultureCode varchar(100), CurrencySuffix varchar(100), PublishProductId int)  
   
	CREATE TABLE #ProductSKU (SEOUrl nvarchar(max), SEODescription  nvarchar(max),SEOKeywords  nvarchar(max),SEOTitle  nvarchar(max), PublishProductId int)  
  
	CREATE TABLE #ProductImages (PublishProductId int, ImageSmallPath  varchar(max))  
  
	EXEC Znode_InsertUpdateAttributeDefaultValueJson 1   
	EXEC Znode_InsertUpdateCustomeFieldJson 1   
	EXEC Znode_InsertUpdatePimAttributeJson 1   
  
	---To draft all catalog products AND associated products for full catalog publish  
	IF @IsDraftProductsOnly = 0  
	BEGIN  
		EXEC Znode_CatalogProductDraftForPublish @PublishCatalogId=@PublishCatalogId   
	END  

	UPDATE ZnodePublishProductEntity SET ElasticSearchEvent = 0

	EXEC [Znode_InsertUpdatePimCatalogProductDetailJson] @PublishCatalogId=@PublishCatalogId,@LocaleId=@LocaleIds ,@UserId=@UserId ,@IsDraftProductsOnly = @IsDraftProductsOnly 


	IF (@IsAllowIndexing=1)  
	BEGIN   
		INSERT INTO #ZnodePrice  
		SELECT RetailPrice,SalesPrice,ZC.CurrencyCode,ZCC.CultureCode ,ZCC.Symbol CurrencySuffix,TYU.PublishProductId  
		FROM ZnodePrice ZP   
		INNER JOIN ZnodePriceList ZPL ON (ZPL.PriceListId = ZP.PriceListId)  
		INNER JOIN ZnodeCurrency ZC oN (ZC.CurrencyId = ZPL.CurrencyId )  
		INNER JOIN ZnodeCulture ZCC ON (ZCC.CultureId = ZPL.CultureId)  
		INNER JOIN ZnodePublishProductDetail TY ON (TY.SKU = ZP.SKU )   
		INNER JOIN ZnodePublishProduct TYU ON (TYU.PublishProductId = TY.PublishProductId)   
		WHERE ZP.PriceListId = @PriceListId   
		AND TY.LocaleId = @DefaultLocaleId  
		AND TYU.PublishCatalogId = @PublishCatalogId  
		AND EXISTS (SELECT TOP 1 1 FROM ZnodePriceListPortal ZPLP   
		INNER JOIN ZnodePimCatalog ZPC on ZPC.PortalId=ZPLP.PortalId WHERE ZPLP.PriceListId=ZP.PriceListId )  
		AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 WHERE TYU.PimProductId = ZPP1.PimProductId )  
		--+ CAST(@DefaultPortal AS VARCHAr(100)) + '/'  
		INSERT INTO #ProductImages  
		SELECT  TYU.PublishProductId , @DomainUrl +'Catalog/'  + CAST(@MaxSmallWidth AS VARCHAR(100)) + '/' + RT.MediaPath AS ImageSmallPath     
		FROM ZnodePimAttributeValue ZPAV   
		INNER JOIN ZnodePublishProduct TYU ON (TYU.PimProductId  = ZPAV.PimProductId)  
		INNER JOIN ZnodePimProductAttributeMedia  RT ON ( RT.PimAttributeValueId = ZPAV.PimAttributeValueId )  
		WHERE  TYU.PublishCatalogId = @PublishCatalogId  
		AND RT.LocaleId = @DefaultLocaleId  
		AND ZPAV.PimAttributeId = (SELECT TOp 1 PimAttributeId FROM ZnodePimAttribute WHERE AttributeCode = 'ProductImage')  
		AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 WHERE TYU.PimProductId = ZPP1.PimProductId )  
   
		INSERT INTO #ProductSKU   
		SELECT ZCSD.SEOUrl , ZCDL.SEODescription,ZCDL.SEOKeywords ,ZCDL.SEOTitle, TYU.PublishProductId  
		FROM ZnodeCMSSEODetail ZCSD   
		INNER JOIN ZnodeCMSSEODetailLocale ZCDL ON (ZCDL.CMSSEODetailId = ZCSD.CMSSEODetailId)  
		INNER JOIN ZnodePublishProductDetail TY ON (TY.SKU = ZCSD.SEOCode AND ZCDL.LocaleId = TY.LocaleId)   
		INNER JOIN ZnodePublishProduct TYU ON (TYU.PublishProductId = TY.PublishProductId)  
		WHERE CMSSEOTypeId = (SELECT TOP 1 CMSSEOTypeId FROM ZnodeCMSSEOType WHERE Name = 'Product')   
		AND ZCDL.LocaleId = @DefaultLocaleId  
		AND TYU.PublishCatalogId = @PublishCatalogId  
		--AND ZCSD.PublishStateId = @PublishStateId  
		AND ZCSD.PortalId = @DefaultPortal  
		AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 WHERE TYU.PimProductId = ZPP1.PimProductId )  
  
	END  
   
	CREATE NONCLUSTERED INDEX Idx_#ProductSKU_PublishProductId ON [dbo].[#ProductSKU] ([PublishProductId])  
	CREATE NONCLUSTERED INDEX Idx_#ProductImages_PublishProductId ON [dbo].#ProductImages ([PublishProductId])  
	CREATE NONCLUSTERED INDEX Idx_#ZnodePrice_PublishProductId ON [dbo].#ZnodePrice ([PublishProductId])  
	
	SELECT DISTINCT PublishProductId, x.LocaleId 
	INTO #PublishProducts 
	FROM ZnodePublishProduct ZPP
	INNER JOIN ##AttributeValueLocale x ON X.PimProductId = ZPP.PimProductId
	WHERE ZPP.PublishCatalogId = @PublishCatalogId

	CREATE INDEX #PublishProducts_PublishProductId on #PublishProducts(PublishProductId,LocaleId)
	--Creating products complete attribute json
	SELECT ZPP.Pimproductid, 
			ZPCPD.PimCatalogProductDetailId,ZPCPD.PublishProductId
			,ZPCPD.PublishCatalogId,ZPCPD.PimCategoryHierarchyId
			,ZPCPD.SKU,ZPCPD.ProductName,ZPCPD.CategoryName,ZPCPD.CatalogName
			,ZPCPD.LocaleId,ZPCPD.IsActive,ZPCPD.ProfileIds,ZPCPD.ProductIndex, 
		'[' +  
		(SELECT STUFF((SELECT ','+ AttributeEntity FROM ##AttributeValueLocale a   
		WHERE a.pimproductid = ZPP.pimproductid AND a.LocaleId = ZPCPD.LocaleId   
		FOR XML Path (''),Type).value('.', 'varchar(max)') ,1,1,'')  )   
		+ ']' AS ProductXML  
	INTO #ProductAttributeXML  
	FROM [ZnodePublishCatalogProductDetail] ZPCPD   
	INNER JOIN ZnodePublishProduct ZPP ON ZPCPD.PublishProductId = ZPP.PublishProductId AND ZPCPD.PublishCatalogId = ZPP.PublishCatalogId --WHERE TY.PimProductId = ZPP.PimProductId  AND TY.LocaleId = ZPCPD.LocaleId   
	WHERE ZPCPD.PublishCatalogId = @PublishCatalogId  
	AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId AND ZPCPD.LocaleId = X.LocaleId )
	GROUP BY ZPP.Pimproductid,ZPCPD.PimCatalogProductDetailId,ZPCPD.PublishProductId
			,ZPCPD.PublishCatalogId,ZPCPD.PimCategoryHierarchyId
			,ZPCPD.SKU,ZPCPD.ProductName,ZPCPD.CategoryName,ZPCPD.CatalogName
			,ZPCPD.LocaleId,ZPCPD.IsActive,ZPCPD.ProfileIds,ZPCPD.ProductIndex

	CREATE NONCLUSTERED INDEX Idx_#ProductAttributeXML_PimProductId_LocaleId  
	ON [dbo].#ProductAttributeXML (PimProductId,LocaleId)  
	
	IF (SELECT COUNT(*) FROM @LocaleIds) > 1
	BEGIN
		--INSERT INTO #ProductAttributeXML(Pimproductid,LocaleId,PublishProductId,ProductXML)
		SELECT ZPP.Pimproductid, 
			ZPCPD.PimCatalogProductDetailId,ZPCPD.PublishProductId
			,ZPCPD.PublishCatalogId,ZPCPD.PimCategoryHierarchyId
			,ZPCPD.SKU,ZPCPD.ProductName,ZPCPD.CategoryName,ZPCPD.CatalogName
			,ZPCPD.LocaleId,ZPCPD.IsActive,ZPCPD.ProfileIds,ZPCPD.ProductIndex,
			'[' +  
			(SELECT STUFF((SELECT ','+ AttributeEntity FROM ##AttributeValueLocale a   
			WHERE a.pimproductid = ZPP.pimproductid AND a.LocaleId = @DefaultLocaleId   
			FOR XML Path (''),Type).value('.', 'varchar(max)') ,1,1,'')  )   
			+ ']' AS ProductXML  
		INTO #ProductAttributeXML_LocaleWise
		FROM [ZnodePublishCatalogProductDetail] ZPCPD   
		INNER JOIN ZnodePublishProduct ZPP ON ZPCPD.PublishProductId = ZPP.PublishProductId AND ZPCPD.PublishCatalogId = ZPP.PublishCatalogId --WHERE TY.PimProductId = ZPP.PimProductId  AND TY.LocaleId = ZPCPD.LocaleId   
		WHERE ZPCPD.PublishCatalogId = @PublishCatalogId  
		AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId)
		AND NOT EXISTS(SELECT * FROM #ProductAttributeXML X WHERE ZPCPD.PublishProductId = X.PublishProductId AND X.LocaleId = ZPCPD.LocaleId )
		AND ZPCPD.LocaleId <> @DefaultLocaleId
		GROUP BY ZPP.Pimproductid, 
			ZPCPD.PimCatalogProductDetailId,ZPCPD.PublishProductId
			,ZPCPD.PublishCatalogId,ZPCPD.PimCategoryHierarchyId
			,ZPCPD.SKU,ZPCPD.ProductName,ZPCPD.CategoryName,ZPCPD.CatalogName
			,ZPCPD.LocaleId,ZPCPD.IsActive,ZPCPD.ProfileIds,ZPCPD.ProductIndex

		CREATE NONCLUSTERED INDEX Idx_#ProductAttributeXML_LocaleWise_PimProductId_LocaleId  
		ON [dbo].#ProductAttributeXML (PimProductId,LocaleId) 
	END
	


	DECLARE @MaxCount INT, @MinRow INT, @MaxRow INT, @Rows numeric(10,2);  
	SELECT @MaxCount = COUNT(*) FROM [ZnodePublishCatalogProductDetail] ZPCPD WHERE PublishCatalogId = @PublishCatalogId  
	AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId)
  
	SELECT @Rows = 50000  
          
	SELECT @MaxCount = CEILING(@MaxCount / @Rows);  
  
	SELECT PimCatalogProductDetailId, PublishProductId,Row_Number() over(Order by PublishProductId) ID into #ZnodePublishCatalogProductDetail 
	FROM [ZnodePublishCatalogProductDetail] ZPCPD WHERE PublishCatalogId = @PublishCatalogId  
	AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId)
  
	UPDATE ZPPAX SET ZPPAX.ElasticSearchEvent = 2
	FROM ZnodePublishProductEntity ZPPAX
	WHERE NOT EXISTS(SELECT * from [ZnodePublishCatalogProductDetail] ZLW WHERE ZPPAX.ZnodeProductId = ZLW.PublishProductId 
						AND ZPPAX.LocaleId = ZLW.LocaleId AND ZPPAX.ZnodeCatalogId = ZLW.PublishCatalogId )
	AND ZPPAX.ZnodeCatalogId = @PublishCatalogId 
	AND EXISTS(SELECT * FROM @TBL_LocaleId V WHERE ZPPAX.VersionId = V.VersionId)

	--Delete products from category from publish tables which are removed from one category and added into other category
	--UPDATE ZPPE SET ZPPE.ElasticSearchEvent = 2 FROM ZnodePublishProductEntity ZPPE
	--WHERE NOT EXISTS(SELECT * FROM ZnodePublishCategoryProduct ZPCP WHERE ZPPE.ZnodeCategoryIds = ZPCP.PublishCategoryId AND ZPPE.ZnodeProductId = ZPCP.PublishProductId
	--AND ZPPE.ZnodeCatalogId = ZPCP.PublishCatalogId)
	--AND ZPPE.ZnodeCatalogId = @PublishCatalogId
	--AND Not Exists (Select TOP 1 1 From ZnodePublishConfigurableProductEntity X Where X.AssociatedZnodeProductId = ZPPE.ZnodeProductId )
	--AND Isnull(ZPPE.ZnodeCategoryIds ,'') = '0'
	
	UPDATE ZPPE SET ZPPE.ElasticSearchEvent = 2 FROM ZnodePublishProductEntity ZPPE
	WHERE NOT EXISTS(SELECT * FROM ZnodePublishCategoryProduct ZPCP WHERE ZPPE.ZnodeCategoryIds = ZPCP.PublishCategoryId AND ZPPE.ZnodeProductId = ZPCP.PublishProductId
	AND ZPPE.ZnodeCatalogId = ZPCP.PublishCatalogId)
	AND ZPPE.ZnodeCatalogId = @PublishCatalogId
	AND Isnull(ZPPE.ZnodeCategoryIds ,'') <> ''
	AND EXISTS(SELECT * FROM @TBL_LocaleId V WHERE ZPPE.VersionId = V.VersionId)


 --   --Delete data which are not present in catalog publish
	--Declare @Batch Bigint
	--SET @Batch = 1;
	--WHILE @Batch > 0
	--BEGIN 
	--	--BEGIN TRAN DelProd
	--		DELETE top (5000)  ZPPAX
	--		from ZnodePublishProductEntity ZPPAX
	--		WHERE NOT EXISTS(SELECT * from [ZnodePublishCatalogProductDetail] ZLW WHERE ZPPAX.ZnodeProductId = ZLW.PublishProductId 
	--							AND ZPPAX.LocaleId = ZLW.LocaleId AND ZPPAX.ZnodeCatalogId = ZLW.PublishCatalogId )
	--		AND ZPPAX.ZnodeCatalogId = @PublishCatalogId  
	--	--COMMIT TRAN DelProd
	--	SET @Batch = @@ROWCOUNT;
	--END
	
	SELECT ZPCP.PublishCategoryId,ZPCP.PublishProductId,ZPCP.PublishCatalogId,ZPCP.PimCategoryHierarchyId,ZPC.PimCategoryId,ZPCCF.PimProductId ,ZPCCF.DisplayOrder
	INTO #TempPublishCategoryProduct
	FROM ZnodePublishCategoryProduct ZPCP 
	INNER JOIN ZnodePublishProduct ZPP ON ZPCP.PublishProductId = ZPP.PublishProductId AND ZPCP.PublishCatalogId = ZPP.PublishCatalogId
	INNER JOIN ZnodePublishCategory ZPC ON (ZPCP.PublishCatalogId = ZPC.PublishCatalogId AND   ZPC.PublishCategoryId = ZPCP.PublishCategoryId AND ZPCP.PimCategoryHierarchyId = ZPC.PimCategoryHierarchyId)
	INNER JOIN ZnodePimCategoryProduct ZPCCF ON (ZPCCF.PimCategoryId = ZPC.PimCategoryId  AND ZPCCF.PimProductId = ZPP.PimProductId )
	WHERE EXISTS(SELECT * FROM [ZnodePublishCatalogProductDetail] ZPCPD WHERE (ZPCP.PublishProductId = ZPCPD.PublishProductId AND ZPCP.PublishCatalogId = ZPCPD.PublishCatalogId AND ZPCP.PimCategoryHierarchyId = ZPCPD.PimCategoryHierarchyId))		
	AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCP.PublishProductId = X.PublishProductId)
	AND ZPCP.PublishCatalogId = @PublishCatalogId 

	CREATE NONCLUSTERED INDEX Id_#TempPublishCategoryProduct_1 ON #TempPublishCategoryProduct(PublishProductId,PublishCatalogId,PimCategoryHierarchyId)

	IF OBJECT_ID('tempdb..#Temp_ImportLoop') IS NOT NULL  
		DROP TABLE #Temp_ImportLoop;  
          
	---- To get the min AND max rows for import in loop  
	;WITH cte AS   
	(  
		SELECT RowId = 1,   
		MinRow = 1,   
		MaxRow = cast(@Rows as int)  
		UNION ALL  
		SELECT RowId + 1,   
		MinRow + cast(@Rows as int),   
		MaxRow + cast(@Rows as int)  
		FROM cte  
		WHERE RowId + 1 <= @MaxCount  
	)  
	SELECT RowId, MinRow, MaxRow  
	INTO #Temp_ImportLoop  
	FROM cte  
	OPTION (maxrecursion 0);  

	DECLARE cur_BulkData CURSOR LOCAL FAST_FORWARD  
	FOR SELECT MinRow, MaxRow, B.LocaleId , B.RevisionType  ,b.VersionId
	FROM #Temp_ImportLoop L  
	CROSS APPLY @TBL_LocaleId B;  
  
	OPEN cur_BulkData;  
	FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow,@LocaleId, @RevisionType ,@VersionId 
	WHILE @@FETCH_STATUS = 0  
	BEGIN  
		IF OBJECT_ID('TEMPDB..#ProductEntity') IS NOT NULL
				DROP TABLE #ProductEntity

		IF OBJECT_ID('TEMPDB..#ProductEntity_LocaleWise') IS NOT NULL
			DROP TABLE #ProductEntity_LocaleWise
			
		SELECT   
			CAST(@VersionId AS VARCHAR(50)) VersionId --1   
			,CAST(ZPCPD.ProductIndex AS VARCHAr(100)) + CAST(ISNULL(ZPCP.PublishCategoryId,'')  AS VARCHAR(50))  + CAST(Isnull(ZPCPD.PublishCatalogId ,'')  AS VARCHAR(50)) + CAST( Isnull(ZPCPD.LocaleId,'') AS VARCHAR(50)) IndexId  --2  
			,CAST(ZPCPD.PublishProductId AS VARCHAR(50)) PublishProductId,CAST(ZPCPD.PublishCatalogId  AS VARCHAR(50)) PublishCatalogId  --3   
			,CAST(ISNULL(ZPCPD.SKU ,'') AS VARCHAR(300)) SKU,CAST( Isnull(ZPCPD.LocaleId,'') AS VARCHAR(50)) LocaleId -- 4   
			,CAST(isnull(ZPCPD.ProductName,'') AS VARCHAR(300) )  ProductName ,CAST(ISNULL(ZPCP.PublishCategoryId,'')  AS VARCHAR(50)) PublishCategoryId  -- 5   
			--'{"Attributes":[' + PAX.ProductXML + ']'  
			,CAST(ISNULL(ZPCPD.IsActive ,'0') AS VARCHAR(50)) IsActive ,ZPCPD.ProductXML,'[]' Brands,CAST(isnull(ZPCPD.CategoryName,'') AS VARCHAR(300)) CategoryName  --6  
			,CAST(Isnull(ZPCPD.CatalogName,'')  AS VARCHAR(300)) CatalogName,CAST(ISNULL(ZPCP.DisplayOrder,'') AS VARCHAR(50)) DisplayOrder  -- 7   
			,@RevisionType RevisionType, 0 AssociatedProductDisplayOrder,-- pending  -- 8   
			ZPCPD.ProductIndex,  -- 9  
			Case When @IsAllowIndexing = 1 then  ISNULL(CAST(TBZP.SalesPrice  AS VARCHAr(500)),'') else '' end SalesPrice ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(CAST(TBZP.RetailPrice  AS VARCHAr(500)),'') else '' end RetailPrice ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CultureCode ,'') else '' end CultureCode ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CurrencySuffix ,'') else '' end CurrencySuffix ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CurrencyCode ,'') else '' end CurrencyCode ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEODescription,'') else '' end SEODescriptionForIndex,  
			Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEOKeywords,'') else '' end SEOKeywords,  
			Case When @IsAllowIndexing = 1 then  ISNULL(SEOTitle,'') else '' end SEOTitle,  
			Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEOUrl ,'') else '' end SEOUrl,  
			Case When @IsAllowIndexing = 1 then  ISNULL(TBPI.ImageSmallPath,'') else '' end ImageSmallPath,  
			CAST(ISNULL(LOWER(ZPCPD.SKU) ,'') AS NVARCHAR(2000)) Lower_SKU--, z.Id    		
		INTO #ProductEntity
		FROM #ProductAttributeXML ZPCPD  
		INNER JOIN ZnodePublishCatalog ZPCV ON (ZPCV.PublishCatalogId = ZPCPD.PublishCatalogId)  
		--INNER JOIN #ProductAttributeXML PAX ON PAX.PublishProductId = ZPCPD.PublishProductId  AND PAX.LocaleId = ZPCPD.LocaleId   
		LEFT JOIN  #ZnodePrice TBZP ON (TBZP.PublishProductId = ZPCPD.PublishProductId)  
		LEFT JOIN  #ProductSKU TBPS ON (TBPS.PublishProductId = ZPCPD.PublishProductId)  
		LEFT JOIN  #ProductImages TBPI ON (TBPI.PublishProductId = ZPCPD.PublishProductId)  
		LEFT JOIN #TempPublishCategoryProduct ZPCP  ON (ZPCP.PublishProductId = ZPCPD.PublishProductId AND ZPCP.PublishCatalogId = ZPCPD.PublishCatalogId AND ZPCP.PimCategoryHierarchyId = ZPCPD.PimCategoryHierarchyId)
		WHERE ZPCPD.LocaleId = @LocaleId  
		AND EXISTS(SELECT * FROM #ZnodePublishCatalogProductDetail z WHERE ZPCPD.PimCatalogProductDetailId = z.PimCatalogProductDetailId AND z.Id BETWEEN @MinRow AND @MaxRow)
		AND ZPCPD.PublishCatalogId = @PublishCatalogId  
		AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId)

		CREATE INDEX Idx_#ProductEntity ON #ProductEntity (PublishProductId,PublishCatalogId,LocaleId,PublishCategoryId)

		UPDATE A SET a.SKU = b.SKU,A.SKULower = Lower_SKU,A.Name = B.ProductName, A.Brands = B.Brands, A.CategoryName = B.CategoryName, A.CatalogName = B.CatalogName,
			A.DisplayOrder = B.DisplayOrder, A.AssociatedProductDisplayOrder = B.AssociatedProductDisplayOrder,
			A.SalesPrice = B.SalesPrice, A.RetailPrice = B.RetailPrice, A.SeoDescription=B.SEODescriptionForIndex,
			A.SeoKeywords = B.SEOKeywords, A.SeoTitle = B.SEOTitle, A.SeoUrl = B.SEOUrl, A.ImageSmallPath = B.ImageSmallPath,
			A.ProductIndex = B.ProductIndex, A.IsActive = B.IsActive, A.IndexId = B.IndexId, A.Attributes = B.ProductXML,
			A.ElasticSearchEvent = 1
		FROM ZnodePublishProductEntity A
		INNER JOIN #ProductEntity B ON A.ZnodeProductId = B.PublishProductId AND A.ZnodeCatalogId = B.PublishCatalogId AND A.LocaleId = B.LocaleId 
			AND ISNULL(A.ZnodeCategoryIds,0) = ISNULL(B.PublishCategoryId,0) AND A.VersionId = B.VersionId AND A.ElasticSearchEvent <> 2
		AND EXISTS(SELECT * FROM @TBL_LocaleId V WHERE A.VersionId = V.VersionId)

		INSERT INTO ZnodePublishProductEntity (  
			VersionId, --1  
			IndexId, --2   
			ZnodeProductId,ZnodeCatalogId, --3  
			SKU,LocaleId, --4   
			Name,ZnodeCategoryIds, --5  
			IsActive,Attributes,Brands,CategoryName, --6   
			CatalogName,DisplayOrder, --7   
			RevisionType,AssociatedProductDisplayOrder, --8  
			ProductIndex,--9  
			SalesPrice,RetailPrice,CultureCode,CurrencySuffix,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent)  
		SELECT VersionId, --1  
			IndexId, --2   
			PublishProductId,PublishCatalogId, --3  
			SKU,LocaleId, --4   
			ProductName,PublishCategoryId, --5  
			IsActive,ProductXML,Brands,CategoryName, --6   
			CatalogName,DisplayOrder, --7   
			RevisionType,AssociatedProductDisplayOrder, --8  
			ProductIndex,--9  
			SalesPrice,RetailPrice,CultureCode,CurrencySuffix,CurrencyCode,SEODescriptionForIndex,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,Lower_SKU,1 AS ElasticSearchEvent
		FROM #ProductEntity B
		WHERE NOT EXISTS(SELECT * FROM ZnodePublishProductEntity A WHERE A.ZnodeProductId = B.PublishProductId AND A.ZnodeCatalogId = B.PublishCatalogId AND A.LocaleId = B.LocaleId 
			AND ISNULL(A.ZnodeCategoryIds,0) = ISNULL(B.PublishCategoryId,0) AND A.VersionId = B.VersionId AND A.ElasticSearchEvent <> 2)
			--select * from #ProductEntity where PublishProductId = 191 
		IF @LocaleId <> @DefaultLocaleId
		BEGIN
			SELECT 
				CAST(@VersionId AS VARCHAR(50)) VersionId --1 
				,CAST(ZPCPD.ProductIndex AS VARCHAr(100)) + CAST(ISNULL(ZPCP.PublishCategoryId,'')  AS VARCHAR(50))  + CAST(Isnull(ZPCPD.PublishCatalogId ,'')  AS VARCHAR(50)) + CAST( Isnull(ZPCPD.LocaleId,'') AS VARCHAR(50)) IndexId  --2
				,CAST(ZPCPD.PublishProductId AS VARCHAR(50)) PublishProductId,CAST(ZPCPD.PublishCatalogId  AS VARCHAR(50)) PublishCatalogId  --3 
				,CAST(ISNULL(ZPCPD.SKU ,'') AS NVARCHAR(2000)) SKU,CAST( Isnull(ZPCPD.LocaleId,'') AS VARCHAR(50)) LocaleId -- 4 
				,CAST(isnull(ZPCPD.ProductName,'') AS NVARCHAR(2000) )  ProductName ,CAST(ISNULL(ZPCP.PublishCategoryId,'')  AS VARCHAR(50)) PublishCategoryId  -- 5 
				,CAST(ISNULL(ZPCPD.IsActive ,'0') AS VARCHAR(50)) IsActive ,ZPCPD.ProductXML,'[]' Brands,CAST(isnull(ZPCPD.CategoryName,'') AS NVARCHAR(2000)) CategoryName  --6
				,CAST(Isnull(ZPCPD.CatalogName,'')  AS NVARCHAR(2000)) CatalogName,CAST(ISNULL(ZPCP.DisplayOrder,'') AS VARCHAR(50)) DisplayOrder  -- 7 
				,@RevisionType as RevisionType, 0 AssociatedProductDisplayOrder,-- pending  -- 8 
				ZPCPD.ProductIndex,  -- 9
				Case When @IsAllowIndexing = 1 then  ISNULL(CAST(TBZP.SalesPrice  AS VARCHAr(500)),'') else '' end SalesPrice , 
				Case When @IsAllowIndexing = 1 then  ISNULL(CAST(TBZP.RetailPrice  AS VARCHAr(500)),'') else '' end RetailPrice , 
				Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CultureCode ,'') else '' end CultureCode , 
				Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CurrencySuffix ,'') else '' end CurrencySuffix , 
				Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CurrencyCode ,'') else '' end CurrencyCode , 
				Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEODescription,'') else '' end SEODescriptionForIndex,
				Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEOKeywords,'') else '' end SEOKeywords,
				Case When @IsAllowIndexing = 1 then  ISNULL(SEOTitle,'') else '' end SEOTitle,
				Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEOUrl ,'') else '' end SEOUrl,
				Case When @IsAllowIndexing = 1 then  ISNULL(TBPI.ImageSmallPath,'') else '' end ImageSmallPath,
				CAST(ISNULL(LOWER(ZPCPD.SKU) ,'') AS NVARCHAR(2000)) Lower_SKU
			INTO #ProductEntity_LocaleWise
			FROM #ProductAttributeXML_LocaleWise ZPCPD
			INNER JOIN ZnodePublishCatalog ZPCV ON (ZPCV.PublishCatalogId = ZPCPD.PublishCatalogId)
			--INNER JOIN #ProductAttributeXML_LocaleWise PAX ON PAX.PublishProductId = ZPCPD.PublishProductId  AND PAX.LocaleId = ZPCPD.LocaleId 
			LEFT JOIN  #ZnodePrice TBZP ON (TBZP.PublishProductId = ZPCPD.PublishProductId)
			LEFT JOIN  #ProductSKU TBPS ON (TBPS.PublishProductId = ZPCPD.PublishProductId)
			LEFT JOIN  #ProductImages TBPI ON (TBPI.PublishProductId = ZPCPD.PublishProductId)
			LEFT JOIN #TempPublishCategoryProduct ZPCP  ON (ZPCP.PublishProductId = ZPCPD.PublishProductId AND ZPCP.PublishCatalogId = ZPCPD.PublishCatalogId AND ZPCP.PimCategoryHierarchyId = ZPCPD.PimCategoryHierarchyId)
			WHERE ZPCPD.LocaleId = @LocaleId 
			AND EXISTS(SELECT * FROM #ZnodePublishCatalogProductDetail z WHERE ZPCPD.PimCatalogProductDetailId = z.PimCatalogProductDetailId AND z.Id BETWEEN @MinRow AND @MaxRow)
			AND ZPCPD.PublishCatalogId = @PublishCatalogId

			CREATE INDEX Idx_#ProductEntity_LocaleWise ON #ProductEntity (PublishProductId,PublishCatalogId,LocaleId,PublishCategoryId)

			UPDATE A SET a.SKU = b.SKU,A.SKULower = Lower_SKU,A.Name = B.ProductName, A.Brands = B.Brands, A.CategoryName = B.CategoryName, A.CatalogName = B.CatalogName,
				A.DisplayOrder = B.DisplayOrder, A.AssociatedProductDisplayOrder = B.AssociatedProductDisplayOrder,
				A.SalesPrice = B.SalesPrice, A.RetailPrice = B.RetailPrice, A.SeoDescription=B.SEODescriptionForIndex,
				A.SeoKeywords = B.SEOKeywords, A.SeoTitle = B.SEOTitle, A.SeoUrl = B.SEOUrl, A.ImageSmallPath = B.ImageSmallPath,
				A.ProductIndex = B.ProductIndex, A.IsActive = B.IsActive, A.IndexId = B.IndexId, A.Attributes = B.ProductXML,
				A.ElasticSearchEvent = 1
			FROM ZnodePublishProductEntity A
			INNER JOIN #ProductEntity_LocaleWise B ON A.ZnodeProductId = B.PublishProductId AND A.ZnodeCatalogId = B.PublishCatalogId AND A.LocaleId = B.LocaleId 
				AND ISNULL(A.ZnodeCategoryIds,0) = ISNULL(B.PublishCategoryId,0) AND A.VersionId = B.VersionId AND A.ElasticSearchEvent <> 2
			AND EXISTS(SELECT * FROM @TBL_LocaleId V WHERE A.VersionId = V.VersionId)

			INSERT INTO ZnodePublishProductEntity (
			VersionId, --1
			IndexId, --2 
			ZnodeProductId,ZnodeCatalogId, --3
			SKU,LocaleId, --4 
			Name,ZnodeCategoryIds, --5
			IsActive,Attributes,Brands,CategoryName, --6 
			CatalogName,DisplayOrder, --7 
			RevisionType,AssociatedProductDisplayOrder, --8
			ProductIndex,--9
			SalesPrice,RetailPrice,CultureCode,CurrencySuffix,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent)
			SELECT VersionId --1 
				,IndexId  --2
				,PublishProductId,PublishCatalogId  --3 
				,SKU,LocaleId -- 4 
				,ProductName ,PublishCategoryId  -- 5 
				,IsActive ,ProductXML,Brands,CategoryName  --6
				,CatalogName,DisplayOrder  -- 7 
				,RevisionType, AssociatedProductDisplayOrder,-- pending  -- 8 
				ProductIndex,  -- 9
				SalesPrice , 
				RetailPrice , 
				CultureCode , 
				CurrencySuffix , 
				CurrencyCode , 
				SEODescriptionForIndex,
				SEOKeywords,
				SEOTitle,
				SEOUrl,
				ImageSmallPath,
				Lower_SKU,1 as ElasticSearchEvent
			FROM #ProductEntity_LocaleWise B
			WHERE NOT EXISTS(SELECT * FROM ZnodePublishProductEntity A WHERE A.ZnodeProductId = B.PublishProductId AND A.ZnodeCatalogId = B.PublishCatalogId AND A.LocaleId = B.LocaleId 
				AND ISNULL(A.ZnodeCategoryIds,0) = ISNULL(B.PublishCategoryId,0) AND A.VersionId = B.VersionId AND A.ElasticSearchEvent <> 2)
		
			--select * from #ProductEntity_LocaleWise where PublishProductId = 191 

		END

		SET @VersionId = 0  

		IF OBJECT_ID('tempdb..#ProductEntity') is not null
			DROP TABLE #ProductEntity

		IF OBJECT_ID('TEMPDB..#TempProductEntity_LocaleWise') IS NOT NULL
			DROP TABLE #TempProductEntity_LocaleWise

	FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow,@LocaleId, @RevisionType ,@VersionId 
	END;  
	CLOSE cur_BulkData;  
	DEALLOCATE cur_BulkData;  
  
  
	IF @RevisionState = 'PREVIEW'   
		UPDATE ZnodePimProduct SET IsProductPublish = 1,PublishStateId =  DBO.Fn_GetPublishStateIdForPreview()    
		WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishProduct ZPP WHERE ZPP.PimProductId = ZnodePimProduct.PimProductId   
		AND ZPP.PublishCatalogId = @PublishCatalogId)  
	Else  
		UPDATE ZnodePimProduct SET IsProductPublish = 1,PublishStateId =  DBO.Fn_GetPublishStateIdForPublish()    
		WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishProduct ZPP WHERE ZPP.PimProductId = ZnodePimProduct.PimProductId   
		AND ZPP.PublishCatalogId = @PublishCatalogId) 
		

	UPDATE ZnodePublishCatalogLog   
	SET IsProductPublished = 1   
	,PublishProductId = (SELECT  COUNT(DISTINCT PublishProductId) FROM ZnodePublishCategoryProduct ZPP   
		WHERE ZPP.PublishCatalogId = ZnodePublishCatalogLog.PublishCatalogId AND ZPP.PublishCategoryId IS NOT NULL)   
	WHERE ZnodePublishCatalogLog.PublishCatalogId = @PublishCatalogId  
	and PublishStateId = (SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE PublishStateCode = 'Processing' ) 
    
	--UPDATE ZnodePublishCatalogLog   
	--SET IsProductPublished = 1   
	--,PublishProductId = (SELECT  COUNT(DISTINCT PublishProductId) FROM ZnodePublishCatalogProductDetail ZPP   
	--	WHERE ZPP.PublishCatalogId = ZnodePublishCatalogLog.PublishCatalogId AND ZPP.PimCategoryHierarchyId <> 0)   
	--WHERE ZnodePublishCatalogLog.PublishCatalogId = @PublishCatalogId  
	--AND PublishStateId = (SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE PublishStateCode = 'Processing' )  

	SET @Status = 1   

	IF OBJECT_ID('tempdb..##AttributeValueLocale') IS NOT NULL  
		DROP TABLE ##AttributeValueLocale; 

END TRY   
BEGIN CATCH   
	SELECT ERROR_MESSAGE()
	 SET @Status =0    
	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	  @ErrorLine VARCHAR(100)= ERROR_LINE(),  
	  @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishProductJson   
		 @PublishCatalogId = '+CAST(@PublishCatalogId AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))  
	  +',@PimCatalogId = ' + CAST(@PimCatalogId AS varchar(20))  
	  +',@VersionIdString= ' + CAST(@VersionIdString AS varchar(20))  
       
	 EXEC Znode_InsertProcedureErrorLog  
	  @ProcedureName = 'Znode_GetPublishProductJson',  
	  @ErrorInProcedure = @Error_procedure,  
	  @ErrorMessage = @ErrorMessage,  
	  @ErrorLine = @ErrorLine,  
	  @ErrorCall = @ErrorCall;  
END CATCH  
  
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCustomer')
	DROP PROC Znode_ImportCustomer
GO

CREATE PROCEDURE [dbo].[Znode_ImportCustomer]
(
	  @TableName NVARCHAR(100), 
	  @Status BIT OUT, 
	  @UserId INT, 
	  @ImportProcessLogId INT, 
	  @NewGUId NVARCHAR(200), 
	  @LocaleId INT= 0,
	  @PortalId INT ,
	  @CsvColumnString NVARCHAR(max)
)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Customer Details
	
	-- Unit Testing : 
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(max),@AspNetZnodeUserId NVARCHAR(256),@ASPNetUsersId NVARCHAR(256),
		@PasswordHash NVARCHAR(max),@SecurityStamp NVARCHAR(max),@RoleId NVARCHAR(256),@IsAllowGlobalLevelUserCreation NVARCHAR(10)
		Declare @ProfileId  INT
		DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		 
		SET @SecurityStamp = '0wVYOZNK4g4kKz9wNs-UHw2'
		SET @PasswordHash = 'APy4Tm1KbRG6oy7h3r85UDh/lCW4JeOi2O2Mfsb3OjkpWTp1YfucMAvvcmUqNaSOlA==';
		SELECT  @RoleId  = Id FROM AspNetRoles WHERE   NAME = 'Customer'  

		SELECT @IsAllowGlobalLevelUserCreation = FeatureValues FROM ZnodeGlobalsetting WHERE FeatureName = 'AllowGlobalLevelUserCreation'

		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
		-- Retrive RoundOff Value FROM global setting 

		-- Three type of import required three table varible for product , category and brand
		CREATE TABLE #InsertCustomer 
		( 
			RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, UserName NVARCHAR(512) ,FirstName	NVARCHAR(200),
			LastName NVARCHAR(200), BudgetAmount	NUMERIC,Email	NVARCHAR(100),PhoneNumber	NVARCHAR(100),
		    EmailOptIn	varchar(100)	,ReferralStatus	NVARCHAR(40),IsActive	varchar(100)	,ExternalId	NVARCHAR(max),CreatedDate DATETIME,
			ProfileName varchar(200),AccountCode NVARCHAR(100),DepartmentName varchar(300),RoleName NVARCHAR(256), GUID NVARCHAR(400)
			,PerOrderLimit INT,	PerOrderAnnualLimit NVARCHAR(100),BillingAccountNumber NVARCHAR(100),EnableUserShippingAddressSuggestion  NVARCHAR(100),
			EnablePowerBIReportOnWebStore BIT,Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),
			Custom4 NVARCHAR(max),Custom5 NVARCHAR(max), SMSOptIn varchar(100)
		);

		SET @SSQL = 'INSERT INTO #InsertCustomer( RowNumber,' + @CsvColumnString + ',GUID)
		             SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+ @TableName;
		
		EXEC sys.sp_sqlexec @SSQL;
				
		SELECT TOP 1 @ProfileId   =  ProfileId FROM ZnodePortalprofile WHERE Portalid = @Portalid and IsDefaultRegistedProfile=1
		IF( Isnull(@ProfileId ,0) = 0 ) 
		Begin
		
		
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '62', 'Default Portal Profile', '', @NewGUId, 1 , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
							
				UPDATE ZnodeImportProcessLog
				SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
				WHERE ImportProcessLogId = @ImportProcessLogId;
			

				SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog 
				WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
				SELECT @SuccessRecordCount = 0

				UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
				TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
				WHERE ImportProcessLogId = @ImportProcessLogId;

				DELETE FROM #InsertCustomer 
				SET @Status = 0;

				COMMIT TRAN A;
				Return 0 
		End

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '104', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName not like '%_@_%_.__%' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '35', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName like '%;%'
				
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '30', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ltrim(rtrim(ii.UserName)) IN 
		(SELECT ltrim(rtrim(UserName))  FROM #InsertCustomer GROUP BY ltrim(rtrim(UserName))  having count(*) > 1 )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '104', 'Email', Email, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.Email not like '%_@_%_.__%' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'IsActive',  IsActive , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '77', 'AccountCode', ii.AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer ii 
		WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !='' 
		AND NOT EXISTS(SELECT * FROM ZnodeAccount za INNER JOIN ZnodePortalAccount zpa on za.AccountId = zpa.AccountId
			WHERE  ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za.AccountCode and zpa.PortalId = @PortalId )
		AND EXISTS(SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount za1 WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za1.AccountCode );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '73', 'AccountCode', AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !=''   and ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') not IN 
		(
			SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount   
		);

		

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '88', 'AccountCode', AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !='' and  exists
		(
			SELECT top 1 1 FROM  AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	 
		INNER JOIN ZnodeAccount ZA on  ZU.AccountId = ZA.AccountId
		WHERE ANZU.UserName = ii.UserName and  ZA.AccountCode != ii.AccountCode
		);

		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--SELECT '92', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		--FROM #InsertCustomer AS ii
		--WHERE ISNULL(LTRIM(RTRIM(ii.RoleName)),'') <> '' and  ISNULL(LTRIM(RTRIM(ii.RoleName)),'') IN ('User','Manager','Administrator')
		--AND EXISTS(SELECT * FROM ZnodeUser a INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId and b.Id <> a.AspNetUserId))
		--		INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
		--		--INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)						
		--		INNER JOIN AspNetUserRoles u on u.UserId = b.Id
		--		INNER JOIN AspNetRoles ZD on u.RoleId = zd.Id
				-- (ii.UserName = c.UserName) and ISNULL(LTRIM(RTRIM(ii.RoleName)),'') <> ZD.Name )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '75', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') ='' and ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '74', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE --ltrim(rtrim(ii.RoleName)) not IN ('User','Manager','Administrator') and ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and
			ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and not exists (SELECT top 1 1 FROM  AspNetRoles ANR WHERE name IN ('User','Manager','Administrator') and  ANR.name =ii.RoleName)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '76', 'DepartmentName', DepartmentName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') <> ''
		AND NOT EXISTS(SELECT * FROM  ZnodeAccount ZA INNER JOIN ZnodeDepartment ZD on ZA.AccountId = ZD.AccountId
			WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = ltrim(rtrim(za.AccountCode))
			and ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') = ltrim(rtrim(ZD.DepartmentName)))

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'EmailOptIn',  EmailOptIn , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.EmailOptIn NOT IN ('True','1','Yes','FALSE','0','No','');

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'SMSOptIn',  SMSOptIn , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.SMSOptIn NOT IN ('True','1','Yes','FALSE','0','No','');

		UPDATE ZIL
		SET ZIL.ColumnName =   ZIL.ColumnName + ' [ UserName - ' + ISNULL(UserName,'') + ' ] '
		FROM ZnodeImportLog ZIL 
		INNER JOIN #InsertCustomer IPA ON (ZIL.RowNumber = IPA.RowNumber)
		WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		--Note : Content page import is not required 
		
		-- END Function Validation 	
		-----------------------------------------------
		--- Delete Invalid Data after functional validatin  

		DELETE FROM #InsertCustomer
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
			--AND GUID = @NewGUID
		);


		-- Update Record count IN log 
        
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		SELECT @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertCustomer
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- END

		-- Insert Product Data 
				
				
				DECLARE @InsertedAspNetZnodeUser TABLE (AspNetZnodeUserId NVARCHAR(256) ,UserName NVARCHAR(512),PortalId INT )
				DECLARE @InsertedASPNetUsers TABLE (Id NVARCHAR(256) ,UserName NVARCHAR(512))
				DECLARE @InsertZnodeUser TABLE (UserId INT,AspNetUserId NVARCHAR(256),CreatedDate DATETIME )

				UPDATE ANU SET 
				ANU.PhoneNumber	= IC.PhoneNumber, 
					ANU.LockoutEndDateUtc = case when IC.IsActive IN('0','No','False') then @GetDate when IC.IsActive IN('1','Yes','True') then null else ANU.LockoutEndDateUtc END
				FROM AspNetZnodeUser ANZU 
				INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
				WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
				----Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

				UPDATE ZU SET 
				ZU.FirstName	= IC.FirstName,
				ZU.LastName		= IC.LastName,
				--ZU.MiddleName	= IC.MiddleName,
				ZU.BudgetAmount = IC.BudgetAmount,
				ZU.Email		= IC.Email,
				ZU.PhoneNumber	= IC.PhoneNumber,
				ZU.EmailOptIn	= (CASE ISNULL(IC.EmailOptIn,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.EmailOptIn,0) As BIT) END),
				ZU.IsActive		= (CASE ISNULL(IC.IsActive,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.IsActive,0) As BIT) END),
				ZU.Custom1 = IC.Custom1,
				ZU.Custom2 = IC.Custom2,
				ZU.Custom3 = IC.Custom3,
				ZU.Custom4 = IC.Custom4,
				ZU.Custom5 = IC.Custom5,
				ZU.SMSOptIn	= (CASE ISNULL(IC.SMSOptIn,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 WHEN '' THEN ZU.SMSOptIn ELSE CAST(ISNULL(IC.SMSOptIn,0) As BIT) END)
				--ZU.ExternalId = ExternalId
				FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
				WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
				--WHERE Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

				INSERT INTO AspNetZnodeUser (AspNetZnodeUserId, UserName, PortalId)		
				OUTPUT INSERTED.AspNetZnodeUserId, INSERTED.UserName, INSERTED.PortalId	INTO  @InsertedAspNetZnodeUser 			 
				SELECT NEWID(),IC.UserName, @PortalId FROM #InsertCustomer IC 
				WHERE NOT EXISTS (SELECT TOP 1 1  FROM AspNetZnodeUser ANZ 
					WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZ.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END 
					AND ANZ.UserName = IC.UserName)

				INSERT INTO ASPNetUsers (Id,Email,EmailConfirmed,PasswordHash,SecurityStamp,PhoneNumber,PhoneNumberConfirmed,TwoFactorEnabled,
				LockoutEndDateUtc,LockOutEnabled,AccessFailedCount,PasswordChangedDate,UserName)
				OUTPUT inserted.Id, inserted.UserName INTO @InsertedASPNetUsers
				SELECT NewId(), Email,0 ,@PasswordHash,@SecurityStamp,PhoneNumber,0,0,case when A.IsActive IN ('0','False','No') then @GetDate else null END LockoutEndDateUtc,1 LockoutEnabled,
				0,@GetDate,AspNetZnodeUserId FROM #InsertCustomer A INNER JOIN @InsertedAspNetZnodeUser  B 
				ON A.UserName = B.UserName
			
				INSERT INTO  ZnodeUser(AspNetUserId,FirstName,LastName,CustomerPaymentGUID,Email,PhoneNumber,EmailOptIn,
				IsActive,ExternalId, CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,UserName,Custom1,Custom2,Custom3,Custom4,Custom5,SMSOptIn)
				OUTPUT Inserted.UserId, Inserted.AspNetUserId,Inserted.CreatedDate INTO @InsertZnodeUser
				SELECT IANU.Id AspNetUserId ,IC.FirstName,IC.LastName,null CustomerPaymentGUID,IC.Email
				,IC.PhoneNumber,
				(CASE ISNULL(IC.EmailOptIn,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.EmailOptIn,0) As BIT) END),
				(CASE ISNULL(IC.IsActive,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.IsActive,0) As BIT) END),
				IC.ExternalId, @UserId,
				CASE WHEN IC.CreatedDate IS NULL OR IC.CreatedDate = '' THEN  @Getdate ELSE IC.CreatedDate END,
				@UserId,@Getdate,IC.UserName,IC.Custom1,IC.Custom2,IC.Custom3,IC.Custom4,IC.Custom5,
					(CASE ISNULL(IC.SMSOptIn,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.SMSOptIn,0) As BIT) END)
				FROM #InsertCustomer IC INNER JOIN 
				@InsertedAspNetZnodeUser IANZU ON IC.UserName = IANZU.UserName  INNER JOIN 
				@InsertedASPNetUsers IANU ON IANZU.AspNetZnodeUserId = IANU.UserName 
	  	     
				INSERT INTO AspNetUserRoles (UserId,RoleId)  SELECT AspNetUserId, @RoleID FROM @InsertZnodeUser 
				INSERT INTO ZnodeUserPortal (UserId,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
				SELECT UserId, @PortalId , @UserId, IZU.CreatedDate,@UserId,@Getdate 
				FROM @InsertZnodeUser IZU

				INSERT INTO ZnodeAccountUserPermission(UserId,AccountPermissionAccessId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT UserId, 4 , @UserId, @Getdate,@UserId,@Getdate 
				FROM @InsertZnodeUser IZU
		
				------------INSERT INTO ZnodeUserGlobalAttributeValue
	
				IF OBJECT_ID('tempdb..#globaldata') IS NOT NULL 
					DROP TABLE #globaldata
				
				SELECT ZU.userid,PerOrderLimit,
					PerOrderAnnualLimit,
					BillingAccountNumber,
					EnableUserShippingAddressSuggestion,
					EnablePowerBIReportOnWebStore 
				INTO #globaldata
				FROM znodeuser ZU INNER JOIN  #InsertCustomer IC on IC.Email =ZU.EMAIL
				WHERE ZU.userid IN (SELECT userid FROM @InsertZnodeUser)
				GROUP BY ZU.userid,PerOrderLimit,
									PerOrderAnnualLimit,
									BillingAccountNumber,
									EnableUserShippingAddressSuggestion,
									EnablePowerBIReportOnWebStore 

				IF OBJECT_ID('tempdb..#globaldata1') IS NOT NULL DROP TABLE #globaldata1
				SELECT * INTO #globaldata1 FROM (SELECT userid, Cast(PerOrderLimit as varchar(100)) PerOrderLimit,
				 Cast(PerOrderAnnualLimit as varchar(100)) PerOrderAnnualLimit,
				 Cast(BillingAccountNumber as varchar(100)) BillingAccountNumber,
				 Cast(case when cast(EnableUserShippingAddressSuggestion as varchar(10))= '1' or cast(EnableUserShippingAddressSuggestion as varchar(10)) ='YES' or  cast(EnableUserShippingAddressSuggestion as varchar(10)) ='True' then 'True' else 'False'  END  as varchar(100)) EnableUserShippingAddressSuggestion,
				 Cast(case when cast(EnablePowerBIReportOnWebStore as varchar(10))= '1'  or cast(EnablePowerBIReportOnWebStore as varchar(10)) ='YES' or  cast(EnablePowerBIReportOnWebStore as varchar(10)) ='True' then 'True' else 'False' END  as varchar(100)) EnablePowerBIReportOnWebStore FROM #globaldata) ab
				UNPIVOT  
				   (avalue FOR acode IN   
					  (PerOrderLimit,
				PerOrderAnnualLimit,
				BillingAccountNumber,
				EnableUserShippingAddressSuggestion,
				EnablePowerBIReportOnWebStore)  
				)AS unpvt;  

				INSERT INTO ZnodeUserGlobalAttributeValue (UserId,	GlobalAttributeId,	GlobalAttributeDefaultValueId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
				SELECT g.Userid,ZGA.GlobalAttributeId,null,null,@UserId,@Getdate,@UserId,@Getdate
					FROM #globaldata1 g INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.acode
					WHERE NOT EXISTS (SELECT top 1 1 FROM ZnodeUserGlobalAttributeValue ZGAV WHERE ZGAV.Userid =g.Userid and ZGA.GlobalAttributeId=ZGAV.GlobalAttributeId)

				INSERT INTO ZnodeUserGlobalAttributeValuelocale(UserGlobalAttributeValueId,	LocaleId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate,	GlobalAttributeDefaultValueId,	MediaId,	MediaPath)
				SELECT UserGlobalAttributeValueId, @LocaleId,avalue ,@UserId,@Getdate,@UserId,@Getdate,null,null,null
					FROM ZnodeUserGlobalAttributeValue ZUGAV INNER JOIN #globaldata1 g on ZUGAV.userid =g.userid
						INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.acode and ZGA.GlobalAttributeId = ZUGAV.GlobalAttributeId
						WHERE NOT EXISTS (SELECT Top 1 1 FROM ZnodeUserGlobalAttributeValuelocale z WHERE z.UserGlobalAttributeValueId = ZUGAV.UserGlobalAttributeValueId)

				---------------------------------------------------------------------------------

				declare @Profile table (ProfileId INT)

				INSERT INTO ZnodeProfile (ProfileName,ShowOnPartnerSignup,Weighting,TaxExempt,DefaultExternalAccountNo,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ParentProfileId)
				OUTPUT inserted.ProfileId INTO @Profile(ProfileId)
				SELECT Distinct ProfileName, 0, null,0, replace(ltrim(rtrim(ProfileName)),' ','') as DefaultExternalAccountNo, @UserId,@Getdate, @UserId,@Getdate, null as ParentProfileId				
				FROM #InsertCustomer IC
				WHERE NOT EXISTS(SELECT * FROM ZnodeProfile ZP WHERE IC.ProfileName = ZP.ProfileName )
				AND ISNULL(ic.ProfileName,'') <> ''

				INSERT INTO ZnodePortalProfile (PortalId,	ProfileId,	IsDefaultAnonymousProfile,	IsDefaultRegistedProfile,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
				SELECT @PortalId, ProfileId, 0 AS IsDefaultAnonymousProfile, 0 AS IsDefaultRegistedProfile, @UserId,@Getdate, @UserId,@Getdate
				FROM @Profile

				UPDATE ZnodeUserProfile 
				SET ProfileId = COALESCE(ZP.ProfileId,@ProfileId)
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeUserProfile u ON u.UserId = a.UserId
				LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
				--WHERE IC.ProfileName <> ''
				
				INSERT INTO ZnodeUserProfile (ProfileId,UserId,IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT COALESCE(ZP.ProfileId,@ProfileId)  , a.UserId, 1 , @UserId,a.CreatedDate,@UserId,@Getdate 
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeUserProfile u WHERE u.UserId = a.UserId )
				AND EXISTS(SELECT * FROM @InsertZnodeUser IZU WHERE A.UserId = IZU.UserId)

				---to update accountid agaist user
				UPDATE ZU SET ZU.AccountId = ZA.AccountId 
				FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	 
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName
				INNER JOIN ZnodeAccount ZA ON ZA.AccountCode = IC.AccountCode 
				--INNER JOIN @InsertZnodeUser IZU on IZU.UserId =ZU.UserId
				WHERE Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0) and isnull(IC.AccountCode,'') <> ''
				
				update ZDU set ZDU.DepartmentId = ZD.DepartmentId, ModifiedBy = @UserId, ModifiedDate = @Getdate
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
				INNER JOIN ZnodeDepartmentUser ZDU on ZDU.UserId = a.UserId
				WHERE isnull(IC.DepartmentName,'') <> ''

				INSERT INTO ZnodeDepartmentUser(UserId,DepartmentId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT a.UserId, ZD.DepartmentId, @UserId,a.CreatedDate,@UserId,@Getdate 
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeDepartmentUser u WHERE u.UserId = a.UserId)
				AND isnull(IC.DepartmentName,'') <> ''
		
				update u set u.RoleId = ZD.Id
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
				INNER JOIN AspNetUserRoles u on u.UserId = b.Id
				WHERE isnull(IC.RoleName,'') <> ''
				
				INSERT INTO AspNetUserRoles(UserId,RoleId)
				SELECT b.Id as ASPNetUserId, ZD.Id as RoleId
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM AspNetUserRoles u WHERE u.UserId = b.Id)
				AND EXISTS(SELECT * FROM @InsertZnodeUser IZU WHERE A.UserId = IZU.UserId)
				AND isnull(IC.RoleName,'') <> ''


		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
		 DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCustomer @TableName = '+CAST(@TableName AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@PortalId='+CAST(@PortalId AS VARCHAR(10))+',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max));
              	
		 ---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

        EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportCustomer',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

UPDATE ZnodeImportAttributeValidation
SET SequenceNumber=9
WHERE ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Customer')
	AND AttributeCode='IsActive' AND SequenceNumber=8

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishProductJson')
	DROP PROC Znode_GetPublishProductJson
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishProductJson]  
(  
	@PublishCatalogId INT = 0   
	,@PimProductId     TransferId Readonly  
	,@UserId     INT = 0   
	,@PimCatalogId     INT = 0   
	,@VersionIdString  VARCHAR(2000)= ''  
	,@Status     Bit  OutPut  
	,@RevisionState   Varchar(50) = ''  
	,@IsDraftProductsOnly BIT = 1  
)  
WITH RECOMPILE 
AS  
/*  
DECLARE @rrte transferId   
INSERT INTO @rrte  
SELECT 1  
  
EXEC [_POC_Znode_GetPublishProductbulk] @PublishCatalogId=9,@UserId= 2 ,@localeIDs = @rrte,@PublishStateId = 3   
  
*/  
BEGIN  
BEGIN Try   
	SET NOCOUNT ON;  
	SET @Status = 0    
	Declare  @RevisionType VARCHAR(50) = ''   
	Declare @VersionId int = 0   
	DECLARE @PortalId INT = (SELECT TOP 1 POrtalId FROM ZnodePortalCatalog WHERE PublishCatalogId = @PublishCatalogId)  
	DECLARE @PriceListId INT = (SELECT TOP 1 PriceListId FROM ZnodePriceListPortal WHERE PortalId = @PortalId )  
	DECLARE @DomainUrl varchar(max) = (SELECT TOp 1 URL FROM ZnodeMediaConfiguration WHERE IsActive =1)  
	DECLARE @MaxSmallWidth INT  = (SELECT TOP 1  MAX(MaxSmallWidth) FROM ZnodeGlobalMediaDisplaySetting)  
	DECLARE @PimMediaAttributeId INT = dbo.Fn_GetProductImageAttributeId()  
  
	DECLARE @TBL_LocaleId  TABLE (RowId INT IDENTITY(1,1) PRIMARY KEY  , LocaleId INT , VersionId int,RevisionType varchar(50)  )  
	DECLARE @LocaleIds transferId   

	INSERT INTO @TBL_LocaleId (LocaleId,VersionId,RevisionType)  
	SELECT PV.LocaleId , PV.VersionId , PV.RevisionType  
	FROM ZnodePublishVersionEntity PV INNER JOIN Split(@VersionIdString,',') S ON PV.VersionId = S.Item  

	 --Getting active local for catalog which are associated to store
	INSERT INTO @LocaleIds (Id) 
	SELECT LocaleId FROM DBO.FN_GetCatalogPortalActiveLocale(@PublishCatalogId)
   
	DECLARE --@ProductNamePimAttributeId INT = dbo.Fn_GetProductNameAttributeId(),  
	@DefaultLocaleId INT= Dbo.Fn_GetDefaultLocaleId(),@LocaleId INT = 0   
	--,@SkuPimAttributeId  INT =  dbo.Fn_GetProductSKUAttributeId() , @IsActivePimAttributeId INT =  dbo.Fn_GetProductIsActiveAttributeId()  
	DECLARE @GetDate DATETIME =dbo.Fn_GetDate()  
  
	DECLARE @DefaultPortal int, @IsAllowIndexing int  
	SELECT @DefaultPortal = ZPC.PortalId, @IsAllowIndexing = 1 FROM ZnodePimCatalog ZPC INNER JOIN ZnodePublishCatalog ZPC1 ON ZPC.PimCatalogId = ZPC1.PimCatalogId WHERE ZPC1.PublishCatalogId =  @PublishCatalogId AND isnull(ZPC.IsAllowIndexing,0) = 1   
     
	-----DELETE unwanted publish data  
	DELETE ZPC FROM ZnodePublishCategoryProduct ZPC  
	WHERE NOT EXISTS(SELECT * FROM ZnodePublishCategory ZC WHERE ZPC.PublishCategoryId = ZC.PublishCategoryId )  
  
	DELETE ZPP FROM ZnodePublishCategoryProduct ZPP  
	WHERE NOT EXISTS(SELECT * FROM ZnodePublishProduct ZP WHERE ZPP.PublishProductId = ZP.PublishProductId )  
  
	DELETE ZPP FROM ZnodePublishCatalogProductDetail ZPP  
	WHERE NOT EXISTS(SELECT * FROM ZnodePublishProduct ZP WHERE ZPP.PublishProductId = ZP.PublishProductId )  
  
	DELETE ZPCP FROM ZnodePublishCatalogProductDetail ZPCP  
	INNER JOIN ZnodePublishProduct b on ZPCP.PublishProductId = b.PublishProductId   
	WHERE NOT EXISTS(SELECT * FROM ZnodePimCategoryProduct a  
	INNER JOIN ZnodePimCategoryHierarchy ZPCH on ZPCH.PimCategoryID = a.PimCategoryId   
	WHERE b.PimProductId = A.PimProductId AND ZPCP.PimCategoryHierarchyId = ZPCH.PimCategoryHierarchyId)  
	AND isnull(ZPCP.PimCategoryHierarchyId,0) <> 0 AND b.PublishCatalogId = @PublishCatalogId  
	---------  
  
	DECLARE @Counter INT =1 ,@maxCountId INT = (SELECT max(RowId) FROM @TBL_LocaleId )   
  
	CREATE TABLE #ZnodePrice (RetailPrice numeric(28,13),SalesPrice numeric(28,13),CurrencyCode varchar(100), CultureCode varchar(100), CurrencySuffix varchar(100), PublishProductId int)  
   
	CREATE TABLE #ProductSKU (SEOUrl nvarchar(max), SEODescription  nvarchar(max),SEOKeywords  nvarchar(max),SEOTitle  nvarchar(max), PublishProductId int)  
  
	CREATE TABLE #ProductImages (PublishProductId int, ImageSmallPath  varchar(max))  
  
	EXEC Znode_InsertUpdateAttributeDefaultValueJson 1   
	EXEC Znode_InsertUpdateCustomeFieldJson 1   
	EXEC Znode_InsertUpdatePimAttributeJson 1   
  
	---To draft all catalog products AND associated products for full catalog publish  
	IF @IsDraftProductsOnly = 0  
	BEGIN  
		EXEC Znode_CatalogProductDraftForPublish @PublishCatalogId=@PublishCatalogId   
	END  

	UPDATE ZnodePublishProductEntity SET ElasticSearchEvent = 0

	EXEC [Znode_InsertUpdatePimCatalogProductDetailJson] @PublishCatalogId=@PublishCatalogId,@LocaleId=@LocaleIds ,@UserId=@UserId ,@IsDraftProductsOnly = @IsDraftProductsOnly 


	IF (@IsAllowIndexing=1)  
	BEGIN   
		INSERT INTO #ZnodePrice  
		SELECT RetailPrice,SalesPrice,ZC.CurrencyCode,ZCC.CultureCode ,ZCC.Symbol CurrencySuffix,TYU.PublishProductId  
		FROM ZnodePrice ZP   
		INNER JOIN ZnodePriceList ZPL ON (ZPL.PriceListId = ZP.PriceListId)  
		INNER JOIN ZnodeCurrency ZC oN (ZC.CurrencyId = ZPL.CurrencyId )  
		INNER JOIN ZnodeCulture ZCC ON (ZCC.CultureId = ZPL.CultureId)  
		INNER JOIN ZnodePublishProductDetail TY ON (TY.SKU = ZP.SKU )   
		INNER JOIN ZnodePublishProduct TYU ON (TYU.PublishProductId = TY.PublishProductId)   
		WHERE ZP.PriceListId = @PriceListId   
		AND TY.LocaleId = @DefaultLocaleId  
		AND TYU.PublishCatalogId = @PublishCatalogId  
		AND EXISTS (SELECT TOP 1 1 FROM ZnodePriceListPortal ZPLP   
		INNER JOIN ZnodePimCatalog ZPC on ZPC.PortalId=ZPLP.PortalId WHERE ZPLP.PriceListId=ZP.PriceListId )  
		AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 WHERE TYU.PimProductId = ZPP1.PimProductId )  
		--+ CAST(@DefaultPortal AS VARCHAr(100)) + '/'  
		INSERT INTO #ProductImages  
		SELECT  TYU.PublishProductId , @DomainUrl +'Catalog/'  + CAST(@MaxSmallWidth AS VARCHAR(100)) + '/' + RT.MediaPath AS ImageSmallPath     
		FROM ZnodePimAttributeValue ZPAV   
		INNER JOIN ZnodePublishProduct TYU ON (TYU.PimProductId  = ZPAV.PimProductId)  
		INNER JOIN ZnodePimProductAttributeMedia  RT ON ( RT.PimAttributeValueId = ZPAV.PimAttributeValueId )  
		WHERE  TYU.PublishCatalogId = @PublishCatalogId  
		AND RT.LocaleId = @DefaultLocaleId  
		AND ZPAV.PimAttributeId = (SELECT TOp 1 PimAttributeId FROM ZnodePimAttribute WHERE AttributeCode = 'ProductImage')  
		AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 WHERE TYU.PimProductId = ZPP1.PimProductId )  
   
		INSERT INTO #ProductSKU   
		SELECT ZCSD.SEOUrl , ZCDL.SEODescription,ZCDL.SEOKeywords ,ZCDL.SEOTitle, TYU.PublishProductId  
		FROM ZnodeCMSSEODetail ZCSD   
		INNER JOIN ZnodeCMSSEODetailLocale ZCDL ON (ZCDL.CMSSEODetailId = ZCSD.CMSSEODetailId)  
		INNER JOIN ZnodePublishProductDetail TY ON (TY.SKU = ZCSD.SEOCode AND ZCDL.LocaleId = TY.LocaleId)   
		INNER JOIN ZnodePublishProduct TYU ON (TYU.PublishProductId = TY.PublishProductId)  
		WHERE CMSSEOTypeId = (SELECT TOP 1 CMSSEOTypeId FROM ZnodeCMSSEOType WHERE Name = 'Product')   
		AND ZCDL.LocaleId = @DefaultLocaleId  
		AND TYU.PublishCatalogId = @PublishCatalogId  
		--AND ZCSD.PublishStateId = @PublishStateId  
		AND ZCSD.PortalId = @DefaultPortal  
		AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 WHERE TYU.PimProductId = ZPP1.PimProductId )  
  
	END  
   
	CREATE NONCLUSTERED INDEX Idx_#ProductSKU_PublishProductId ON [dbo].[#ProductSKU] ([PublishProductId])  
	CREATE NONCLUSTERED INDEX Idx_#ProductImages_PublishProductId ON [dbo].#ProductImages ([PublishProductId])  
	CREATE NONCLUSTERED INDEX Idx_#ZnodePrice_PublishProductId ON [dbo].#ZnodePrice ([PublishProductId])  
	
	SELECT DISTINCT PublishProductId, x.LocaleId 
	INTO #PublishProducts 
	FROM ZnodePublishProduct ZPP
	INNER JOIN ##AttributeValueLocale x ON X.PimProductId = ZPP.PimProductId
	WHERE ZPP.PublishCatalogId = @PublishCatalogId

	CREATE INDEX #PublishProducts_PublishProductId on #PublishProducts(PublishProductId,LocaleId)
	--Creating products complete attribute json
	SELECT ZPP.Pimproductid, 
			ZPCPD.PimCatalogProductDetailId,ZPCPD.PublishProductId
			,ZPCPD.PublishCatalogId,ZPCPD.PimCategoryHierarchyId
			,ZPCPD.SKU,ZPCPD.ProductName,ZPCPD.CategoryName,ZPCPD.CatalogName
			,ZPCPD.LocaleId,ZPCPD.IsActive,ZPCPD.ProfileIds,ZPCPD.ProductIndex, 
		'[' +  
		(SELECT STUFF((SELECT ','+ AttributeEntity FROM ##AttributeValueLocale a   
		WHERE a.pimproductid = ZPP.pimproductid AND a.LocaleId = ZPCPD.LocaleId   
		FOR XML Path (''),Type).value('.', 'varchar(max)') ,1,1,'')  )   
		+ ']' AS ProductXML  
	INTO #ProductAttributeXML  
	FROM [ZnodePublishCatalogProductDetail] ZPCPD   
	INNER JOIN ZnodePublishProduct ZPP ON ZPCPD.PublishProductId = ZPP.PublishProductId AND ZPCPD.PublishCatalogId = ZPP.PublishCatalogId --WHERE TY.PimProductId = ZPP.PimProductId  AND TY.LocaleId = ZPCPD.LocaleId   
	WHERE ZPCPD.PublishCatalogId = @PublishCatalogId  
	AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId AND ZPCPD.LocaleId = X.LocaleId )
	GROUP BY ZPP.Pimproductid,ZPCPD.PimCatalogProductDetailId,ZPCPD.PublishProductId
			,ZPCPD.PublishCatalogId,ZPCPD.PimCategoryHierarchyId
			,ZPCPD.SKU,ZPCPD.ProductName,ZPCPD.CategoryName,ZPCPD.CatalogName
			,ZPCPD.LocaleId,ZPCPD.IsActive,ZPCPD.ProfileIds,ZPCPD.ProductIndex

	CREATE NONCLUSTERED INDEX Idx_#ProductAttributeXML_PimProductId_LocaleId  
	ON [dbo].#ProductAttributeXML (PimProductId,LocaleId)  
	
	IF (SELECT COUNT(*) FROM @LocaleIds) > 1
	BEGIN
		--INSERT INTO #ProductAttributeXML(Pimproductid,LocaleId,PublishProductId,ProductXML)
		SELECT ZPP.Pimproductid, 
			ZPCPD.PimCatalogProductDetailId,ZPCPD.PublishProductId
			,ZPCPD.PublishCatalogId,ZPCPD.PimCategoryHierarchyId
			,ZPCPD.SKU,ZPCPD.ProductName,ZPCPD.CategoryName,ZPCPD.CatalogName
			,ZPCPD.LocaleId,ZPCPD.IsActive,ZPCPD.ProfileIds,ZPCPD.ProductIndex,
			'[' +  
			(SELECT STUFF((SELECT ','+ AttributeEntity FROM ##AttributeValueLocale a   
			WHERE a.pimproductid = ZPP.pimproductid AND a.LocaleId = @DefaultLocaleId   
			FOR XML Path (''),Type).value('.', 'varchar(max)') ,1,1,'')  )   
			+ ']' AS ProductXML  
		INTO #ProductAttributeXML_LocaleWise
		FROM [ZnodePublishCatalogProductDetail] ZPCPD   
		INNER JOIN ZnodePublishProduct ZPP ON ZPCPD.PublishProductId = ZPP.PublishProductId AND ZPCPD.PublishCatalogId = ZPP.PublishCatalogId --WHERE TY.PimProductId = ZPP.PimProductId  AND TY.LocaleId = ZPCPD.LocaleId   
		WHERE ZPCPD.PublishCatalogId = @PublishCatalogId  
		AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId)
		AND NOT EXISTS(SELECT * FROM #ProductAttributeXML X WHERE ZPCPD.PublishProductId = X.PublishProductId AND X.LocaleId = ZPCPD.LocaleId )
		AND ZPCPD.LocaleId <> @DefaultLocaleId
		GROUP BY ZPP.Pimproductid, 
			ZPCPD.PimCatalogProductDetailId,ZPCPD.PublishProductId
			,ZPCPD.PublishCatalogId,ZPCPD.PimCategoryHierarchyId
			,ZPCPD.SKU,ZPCPD.ProductName,ZPCPD.CategoryName,ZPCPD.CatalogName
			,ZPCPD.LocaleId,ZPCPD.IsActive,ZPCPD.ProfileIds,ZPCPD.ProductIndex

		CREATE NONCLUSTERED INDEX Idx_#ProductAttributeXML_LocaleWise_PimProductId_LocaleId  
		ON [dbo].#ProductAttributeXML (PimProductId,LocaleId) 
	END
	


	DECLARE @MaxCount INT, @MinRow INT, @MaxRow INT, @Rows numeric(10,2);  
	SELECT @MaxCount = COUNT(*) FROM [ZnodePublishCatalogProductDetail] ZPCPD WHERE PublishCatalogId = @PublishCatalogId  
	AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId)
  
	SELECT @Rows = 50000  
          
	SELECT @MaxCount = CEILING(@MaxCount / @Rows);  
  
	SELECT PimCatalogProductDetailId, PublishProductId,Row_Number() over(Order by PublishProductId) ID into #ZnodePublishCatalogProductDetail 
	FROM [ZnodePublishCatalogProductDetail] ZPCPD WHERE PublishCatalogId = @PublishCatalogId  
	AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId)
  
	UPDATE ZPPAX SET ZPPAX.ElasticSearchEvent = 2
	FROM ZnodePublishProductEntity ZPPAX
	WHERE NOT EXISTS(SELECT * from [ZnodePublishCatalogProductDetail] ZLW WHERE ZPPAX.ZnodeProductId = ZLW.PublishProductId 
						AND ZPPAX.LocaleId = ZLW.LocaleId AND ZPPAX.ZnodeCatalogId = ZLW.PublishCatalogId )
	AND ZPPAX.ZnodeCatalogId = @PublishCatalogId 
	AND EXISTS(SELECT * FROM @TBL_LocaleId V WHERE ZPPAX.VersionId = V.VersionId)

	--Delete products from category from publish tables which are removed from one category and added into other category
	--UPDATE ZPPE SET ZPPE.ElasticSearchEvent = 2 FROM ZnodePublishProductEntity ZPPE
	--WHERE NOT EXISTS(SELECT * FROM ZnodePublishCategoryProduct ZPCP WHERE ZPPE.ZnodeCategoryIds = ZPCP.PublishCategoryId AND ZPPE.ZnodeProductId = ZPCP.PublishProductId
	--AND ZPPE.ZnodeCatalogId = ZPCP.PublishCatalogId)
	--AND ZPPE.ZnodeCatalogId = @PublishCatalogId
	--AND Not Exists (Select TOP 1 1 From ZnodePublishConfigurableProductEntity X Where X.AssociatedZnodeProductId = ZPPE.ZnodeProductId )
	--AND Isnull(ZPPE.ZnodeCategoryIds ,'') = '0'
	
	UPDATE ZPPE SET ZPPE.ElasticSearchEvent = 2 FROM ZnodePublishProductEntity ZPPE
	WHERE NOT EXISTS(SELECT * FROM ZnodePublishCategoryProduct ZPCP WHERE ZPPE.ZnodeCategoryIds = ZPCP.PublishCategoryId AND ZPPE.ZnodeProductId = ZPCP.PublishProductId
	AND ZPPE.ZnodeCatalogId = ZPCP.PublishCatalogId)
	AND ZPPE.ZnodeCatalogId = @PublishCatalogId
	AND Isnull(ZPPE.ZnodeCategoryIds ,'') <> ''
	AND EXISTS(SELECT * FROM @TBL_LocaleId V WHERE ZPPE.VersionId = V.VersionId)


 --   --Delete data which are not present in catalog publish
	--Declare @Batch Bigint
	--SET @Batch = 1;
	--WHILE @Batch > 0
	--BEGIN 
	--	--BEGIN TRAN DelProd
	--		DELETE top (5000)  ZPPAX
	--		from ZnodePublishProductEntity ZPPAX
	--		WHERE NOT EXISTS(SELECT * from [ZnodePublishCatalogProductDetail] ZLW WHERE ZPPAX.ZnodeProductId = ZLW.PublishProductId 
	--							AND ZPPAX.LocaleId = ZLW.LocaleId AND ZPPAX.ZnodeCatalogId = ZLW.PublishCatalogId )
	--		AND ZPPAX.ZnodeCatalogId = @PublishCatalogId  
	--	--COMMIT TRAN DelProd
	--	SET @Batch = @@ROWCOUNT;
	--END
	
	SELECT ZPCP.PublishCategoryId,ZPCP.PublishProductId,ZPCP.PublishCatalogId,ZPCP.PimCategoryHierarchyId,ZPC.PimCategoryId,ZPCCF.PimProductId ,ZPCCF.DisplayOrder
	INTO #TempPublishCategoryProduct
	FROM ZnodePublishCategoryProduct ZPCP 
	INNER JOIN ZnodePublishProduct ZPP ON ZPCP.PublishProductId = ZPP.PublishProductId AND ZPCP.PublishCatalogId = ZPP.PublishCatalogId
	INNER JOIN ZnodePublishCategory ZPC ON (ZPCP.PublishCatalogId = ZPC.PublishCatalogId AND   ZPC.PublishCategoryId = ZPCP.PublishCategoryId AND ZPCP.PimCategoryHierarchyId = ZPC.PimCategoryHierarchyId)
	INNER JOIN ZnodePimCategoryProduct ZPCCF ON (ZPCCF.PimCategoryId = ZPC.PimCategoryId  AND ZPCCF.PimProductId = ZPP.PimProductId )
	WHERE EXISTS(SELECT * FROM [ZnodePublishCatalogProductDetail] ZPCPD WHERE (ZPCP.PublishProductId = ZPCPD.PublishProductId AND ZPCP.PublishCatalogId = ZPCPD.PublishCatalogId AND ZPCP.PimCategoryHierarchyId = ZPCPD.PimCategoryHierarchyId))		
	AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCP.PublishProductId = X.PublishProductId)
	AND ZPCP.PublishCatalogId = @PublishCatalogId 

	CREATE NONCLUSTERED INDEX Id_#TempPublishCategoryProduct_1 ON #TempPublishCategoryProduct(PublishProductId,PublishCatalogId,PimCategoryHierarchyId)

	IF OBJECT_ID('tempdb..#Temp_ImportLoop') IS NOT NULL  
		DROP TABLE #Temp_ImportLoop;  
          
	---- To get the min AND max rows for import in loop  
	;WITH cte AS   
	(  
		SELECT RowId = 1,   
		MinRow = 1,   
		MaxRow = cast(@Rows as int)  
		UNION ALL  
		SELECT RowId + 1,   
		MinRow + cast(@Rows as int),   
		MaxRow + cast(@Rows as int)  
		FROM cte  
		WHERE RowId + 1 <= @MaxCount  
	)  
	SELECT RowId, MinRow, MaxRow  
	INTO #Temp_ImportLoop  
	FROM cte  
	OPTION (maxrecursion 0);  

	DECLARE cur_BulkData CURSOR LOCAL FAST_FORWARD  
	FOR SELECT MinRow, MaxRow, B.LocaleId , B.RevisionType  ,b.VersionId
	FROM #Temp_ImportLoop L  
	CROSS APPLY @TBL_LocaleId B;  
  
	OPEN cur_BulkData;  
	FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow,@LocaleId, @RevisionType ,@VersionId 
	WHILE @@FETCH_STATUS = 0  
	BEGIN  
		IF OBJECT_ID('TEMPDB..#ProductEntity') IS NOT NULL
				DROP TABLE #ProductEntity

		IF OBJECT_ID('TEMPDB..#ProductEntity_LocaleWise') IS NOT NULL
			DROP TABLE #ProductEntity_LocaleWise
			
		SELECT   
			CAST(@VersionId AS VARCHAR(50)) VersionId --1   
			,CAST(ZPCPD.ProductIndex AS VARCHAr(100)) + CAST(ISNULL(ZPCP.PublishCategoryId,'')  AS VARCHAR(50))  + CAST(Isnull(ZPCPD.PublishCatalogId ,'')  AS VARCHAR(50)) + CAST( Isnull(ZPCPD.LocaleId,'') AS VARCHAR(50)) IndexId  --2  
			,CAST(ZPCPD.PublishProductId AS VARCHAR(50)) PublishProductId,CAST(ZPCPD.PublishCatalogId  AS VARCHAR(50)) PublishCatalogId  --3   
			,CAST(ISNULL(ZPCPD.SKU ,'') AS VARCHAR(300)) SKU,CAST( Isnull(ZPCPD.LocaleId,'') AS VARCHAR(50)) LocaleId -- 4   
			,CAST(isnull(ZPCPD.ProductName,'') AS VARCHAR(300) )  ProductName ,CAST(ISNULL(ZPCP.PublishCategoryId,'')  AS VARCHAR(50)) PublishCategoryId  -- 5   
			--'{"Attributes":[' + PAX.ProductXML + ']'  
			,CAST(ISNULL(ZPCPD.IsActive ,'0') AS VARCHAR(50)) IsActive ,ZPCPD.ProductXML,'[]' Brands,CAST(isnull(ZPCPD.CategoryName,'') AS VARCHAR(300)) CategoryName  --6  
			,CAST(Isnull(ZPCPD.CatalogName,'')  AS VARCHAR(300)) CatalogName,CAST(ISNULL(ZPCP.DisplayOrder,'') AS VARCHAR(50)) DisplayOrder  -- 7   
			,@RevisionType RevisionType, 0 AssociatedProductDisplayOrder,-- pending  -- 8   
			ZPCPD.ProductIndex,  -- 9  
			Case When @IsAllowIndexing = 1 then  ISNULL(CAST(TBZP.SalesPrice  AS VARCHAr(500)),'') else '' end SalesPrice ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(CAST(TBZP.RetailPrice  AS VARCHAr(500)),'') else '' end RetailPrice ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CultureCode ,'') else '' end CultureCode ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CurrencySuffix ,'') else '' end CurrencySuffix ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CurrencyCode ,'') else '' end CurrencyCode ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEODescription,'') else '' end SEODescriptionForIndex,  
			Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEOKeywords,'') else '' end SEOKeywords,  
			Case When @IsAllowIndexing = 1 then  ISNULL(SEOTitle,'') else '' end SEOTitle,  
			Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEOUrl ,'') else '' end SEOUrl,  
			Case When @IsAllowIndexing = 1 then  ISNULL(TBPI.ImageSmallPath,'') else '' end ImageSmallPath,  
			CAST(ISNULL(LOWER(ZPCPD.SKU) ,'') AS NVARCHAR(2000)) Lower_SKU--, z.Id    		
		INTO #ProductEntity
		FROM #ProductAttributeXML ZPCPD  
		INNER JOIN ZnodePublishCatalog ZPCV ON (ZPCV.PublishCatalogId = ZPCPD.PublishCatalogId)  
		--INNER JOIN #ProductAttributeXML PAX ON PAX.PublishProductId = ZPCPD.PublishProductId  AND PAX.LocaleId = ZPCPD.LocaleId   
		LEFT JOIN  #ZnodePrice TBZP ON (TBZP.PublishProductId = ZPCPD.PublishProductId)  
		LEFT JOIN  #ProductSKU TBPS ON (TBPS.PublishProductId = ZPCPD.PublishProductId)  
		LEFT JOIN  #ProductImages TBPI ON (TBPI.PublishProductId = ZPCPD.PublishProductId)  
		LEFT JOIN #TempPublishCategoryProduct ZPCP  ON (ZPCP.PublishProductId = ZPCPD.PublishProductId AND ZPCP.PublishCatalogId = ZPCPD.PublishCatalogId AND ZPCP.PimCategoryHierarchyId = ZPCPD.PimCategoryHierarchyId)
		WHERE ZPCPD.LocaleId = @LocaleId  
		AND EXISTS(SELECT * FROM #ZnodePublishCatalogProductDetail z WHERE ZPCPD.PimCatalogProductDetailId = z.PimCatalogProductDetailId AND z.Id BETWEEN @MinRow AND @MaxRow)
		AND ZPCPD.PublishCatalogId = @PublishCatalogId  
		AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId)

		CREATE INDEX Idx_#ProductEntity ON #ProductEntity (PublishProductId,PublishCatalogId,LocaleId,PublishCategoryId,VersionId)
		INCLUDE (SKU,Lower_SKU,ProductName,Brands,CategoryName,CatalogName,DisplayOrder,AssociatedProductDisplayOrder,SalesPrice,
				RetailPrice,SEODescriptionForIndex,SEOKeywords,SEOTitle,SEOUrl,ImageSmallPath,ProductIndex,IsActive,IndexId,ProductXML)

		UPDATE A SET a.SKU = b.SKU,A.SKULower = Lower_SKU,A.Name = B.ProductName, A.Brands = B.Brands, A.CategoryName = B.CategoryName, A.CatalogName = B.CatalogName,
			A.DisplayOrder = B.DisplayOrder, A.AssociatedProductDisplayOrder = B.AssociatedProductDisplayOrder,
			A.SalesPrice = B.SalesPrice, A.RetailPrice = B.RetailPrice, A.SeoDescription=B.SEODescriptionForIndex,
			A.SeoKeywords = B.SEOKeywords, A.SeoTitle = B.SEOTitle, A.SeoUrl = B.SEOUrl, A.ImageSmallPath = B.ImageSmallPath,
			A.ProductIndex = B.ProductIndex, A.IsActive = B.IsActive, A.IndexId = B.IndexId, A.Attributes = B.ProductXML,
			A.ElasticSearchEvent = 1
		FROM ZnodePublishProductEntity A
		INNER JOIN #ProductEntity B ON A.ZnodeProductId = B.PublishProductId AND A.ZnodeCatalogId = B.PublishCatalogId AND A.LocaleId = B.LocaleId 
			AND ISNULL(A.ZnodeCategoryIds,0) = ISNULL(B.PublishCategoryId,0) AND A.VersionId = B.VersionId AND A.ElasticSearchEvent <> 2
		AND EXISTS(SELECT * FROM @TBL_LocaleId V WHERE A.VersionId = V.VersionId)

		INSERT INTO ZnodePublishProductEntity (  
			VersionId, --1  
			IndexId, --2   
			ZnodeProductId,ZnodeCatalogId, --3  
			SKU,LocaleId, --4   
			Name,ZnodeCategoryIds, --5  
			IsActive,Attributes,Brands,CategoryName, --6   
			CatalogName,DisplayOrder, --7   
			RevisionType,AssociatedProductDisplayOrder, --8  
			ProductIndex,--9  
			SalesPrice,RetailPrice,CultureCode,CurrencySuffix,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent)  
		SELECT VersionId, --1  
			IndexId, --2   
			PublishProductId,PublishCatalogId, --3  
			SKU,LocaleId, --4   
			ProductName,PublishCategoryId, --5  
			IsActive,ProductXML,Brands,CategoryName, --6   
			CatalogName,DisplayOrder, --7   
			RevisionType,AssociatedProductDisplayOrder, --8  
			ProductIndex,--9  
			SalesPrice,RetailPrice,CultureCode,CurrencySuffix,CurrencyCode,SEODescriptionForIndex,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,Lower_SKU,1 AS ElasticSearchEvent
		FROM #ProductEntity B
		WHERE NOT EXISTS(SELECT * FROM ZnodePublishProductEntity A WHERE A.ZnodeProductId = B.PublishProductId AND A.ZnodeCatalogId = B.PublishCatalogId AND A.LocaleId = B.LocaleId 
			AND ISNULL(A.ZnodeCategoryIds,0) = ISNULL(B.PublishCategoryId,0) AND A.VersionId = B.VersionId AND A.ElasticSearchEvent <> 2)

		IF @LocaleId <> @DefaultLocaleId AND (SELECT COUNT(*) FROM @LocaleIds) > 1
		BEGIN
			SELECT 
				CAST(@VersionId AS VARCHAR(50)) VersionId --1 
				,CAST(ZPCPD.ProductIndex AS VARCHAr(100)) + CAST(ISNULL(ZPCP.PublishCategoryId,'')  AS VARCHAR(50))  + CAST(Isnull(ZPCPD.PublishCatalogId ,'')  AS VARCHAR(50)) + CAST( Isnull(ZPCPD.LocaleId,'') AS VARCHAR(50)) IndexId  --2
				,CAST(ZPCPD.PublishProductId AS VARCHAR(50)) PublishProductId,CAST(ZPCPD.PublishCatalogId  AS VARCHAR(50)) PublishCatalogId  --3 
				,CAST(ISNULL(ZPCPD.SKU ,'') AS NVARCHAR(2000)) SKU,CAST( Isnull(ZPCPD.LocaleId,'') AS VARCHAR(50)) LocaleId -- 4 
				,CAST(isnull(ZPCPD.ProductName,'') AS NVARCHAR(2000) )  ProductName ,CAST(ISNULL(ZPCP.PublishCategoryId,'')  AS VARCHAR(50)) PublishCategoryId  -- 5 
				,CAST(ISNULL(ZPCPD.IsActive ,'0') AS VARCHAR(50)) IsActive ,ZPCPD.ProductXML,'[]' Brands,CAST(isnull(ZPCPD.CategoryName,'') AS NVARCHAR(2000)) CategoryName  --6
				,CAST(Isnull(ZPCPD.CatalogName,'')  AS NVARCHAR(2000)) CatalogName,CAST(ISNULL(ZPCP.DisplayOrder,'') AS VARCHAR(50)) DisplayOrder  -- 7 
				,@RevisionType as RevisionType, 0 AssociatedProductDisplayOrder,-- pending  -- 8 
				ZPCPD.ProductIndex,  -- 9
				Case When @IsAllowIndexing = 1 then  ISNULL(CAST(TBZP.SalesPrice  AS VARCHAr(500)),'') else '' end SalesPrice , 
				Case When @IsAllowIndexing = 1 then  ISNULL(CAST(TBZP.RetailPrice  AS VARCHAr(500)),'') else '' end RetailPrice , 
				Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CultureCode ,'') else '' end CultureCode , 
				Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CurrencySuffix ,'') else '' end CurrencySuffix , 
				Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CurrencyCode ,'') else '' end CurrencyCode , 
				Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEODescription,'') else '' end SEODescriptionForIndex,
				Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEOKeywords,'') else '' end SEOKeywords,
				Case When @IsAllowIndexing = 1 then  ISNULL(SEOTitle,'') else '' end SEOTitle,
				Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEOUrl ,'') else '' end SEOUrl,
				Case When @IsAllowIndexing = 1 then  ISNULL(TBPI.ImageSmallPath,'') else '' end ImageSmallPath,
				CAST(ISNULL(LOWER(ZPCPD.SKU) ,'') AS NVARCHAR(2000)) Lower_SKU
			INTO #ProductEntity_LocaleWise
			FROM #ProductAttributeXML_LocaleWise ZPCPD
			INNER JOIN ZnodePublishCatalog ZPCV ON (ZPCV.PublishCatalogId = ZPCPD.PublishCatalogId)
			--INNER JOIN #ProductAttributeXML_LocaleWise PAX ON PAX.PublishProductId = ZPCPD.PublishProductId  AND PAX.LocaleId = ZPCPD.LocaleId 
			LEFT JOIN  #ZnodePrice TBZP ON (TBZP.PublishProductId = ZPCPD.PublishProductId)
			LEFT JOIN  #ProductSKU TBPS ON (TBPS.PublishProductId = ZPCPD.PublishProductId)
			LEFT JOIN  #ProductImages TBPI ON (TBPI.PublishProductId = ZPCPD.PublishProductId)
			LEFT JOIN #TempPublishCategoryProduct ZPCP  ON (ZPCP.PublishProductId = ZPCPD.PublishProductId AND ZPCP.PublishCatalogId = ZPCPD.PublishCatalogId AND ZPCP.PimCategoryHierarchyId = ZPCPD.PimCategoryHierarchyId)
			WHERE ZPCPD.LocaleId = @LocaleId 
			AND EXISTS(SELECT * FROM #ZnodePublishCatalogProductDetail z WHERE ZPCPD.PimCatalogProductDetailId = z.PimCatalogProductDetailId AND z.Id BETWEEN @MinRow AND @MaxRow)
			AND ZPCPD.PublishCatalogId = @PublishCatalogId

			CREATE INDEX Idx_#ProductEntity_LocaleWise ON #ProductEntity_LocaleWise (PublishProductId,PublishCatalogId,LocaleId,PublishCategoryId,VersionId)
			INCLUDE (SKU,Lower_SKU,ProductName,Brands,CategoryName,CatalogName,DisplayOrder,AssociatedProductDisplayOrder,SalesPrice,
				RetailPrice,SEODescriptionForIndex,SEOKeywords,SEOTitle,SEOUrl,ImageSmallPath,ProductIndex,IsActive,IndexId,ProductXML)

			UPDATE A SET a.SKU = b.SKU,A.SKULower = Lower_SKU,A.Name = B.ProductName, A.Brands = B.Brands, A.CategoryName = B.CategoryName, A.CatalogName = B.CatalogName,
				A.DisplayOrder = B.DisplayOrder, A.AssociatedProductDisplayOrder = B.AssociatedProductDisplayOrder,
				A.SalesPrice = B.SalesPrice, A.RetailPrice = B.RetailPrice, A.SeoDescription=B.SEODescriptionForIndex,
				A.SeoKeywords = B.SEOKeywords, A.SeoTitle = B.SEOTitle, A.SeoUrl = B.SEOUrl, A.ImageSmallPath = B.ImageSmallPath,
				A.ProductIndex = B.ProductIndex, A.IsActive = B.IsActive, A.IndexId = B.IndexId, A.Attributes = B.ProductXML,
				A.ElasticSearchEvent = 1
			FROM ZnodePublishProductEntity A
			INNER JOIN #ProductEntity_LocaleWise B ON A.ZnodeProductId = B.PublishProductId AND A.ZnodeCatalogId = B.PublishCatalogId AND A.LocaleId = B.LocaleId 
				AND ISNULL(A.ZnodeCategoryIds,0) = ISNULL(B.PublishCategoryId,0) AND A.VersionId = B.VersionId AND A.ElasticSearchEvent <> 2
			AND EXISTS(SELECT * FROM @TBL_LocaleId V WHERE A.VersionId = V.VersionId)

			INSERT INTO ZnodePublishProductEntity (
			VersionId, --1
			IndexId, --2 
			ZnodeProductId,ZnodeCatalogId, --3
			SKU,LocaleId, --4 
			Name,ZnodeCategoryIds, --5
			IsActive,Attributes,Brands,CategoryName, --6 
			CatalogName,DisplayOrder, --7 
			RevisionType,AssociatedProductDisplayOrder, --8
			ProductIndex,--9
			SalesPrice,RetailPrice,CultureCode,CurrencySuffix,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent)
			SELECT VersionId --1 
				,IndexId  --2
				,PublishProductId,PublishCatalogId  --3 
				,SKU,LocaleId -- 4 
				,ProductName ,PublishCategoryId  -- 5 
				,IsActive ,ProductXML,Brands,CategoryName  --6
				,CatalogName,DisplayOrder  -- 7 
				,RevisionType, AssociatedProductDisplayOrder,-- pending  -- 8 
				ProductIndex,  -- 9
				SalesPrice , 
				RetailPrice , 
				CultureCode , 
				CurrencySuffix , 
				CurrencyCode , 
				SEODescriptionForIndex,
				SEOKeywords,
				SEOTitle,
				SEOUrl,
				ImageSmallPath,
				Lower_SKU,1 as ElasticSearchEvent
			FROM #ProductEntity_LocaleWise B
			WHERE NOT EXISTS(SELECT * FROM ZnodePublishProductEntity A WHERE A.ZnodeProductId = B.PublishProductId AND A.ZnodeCatalogId = B.PublishCatalogId AND A.LocaleId = B.LocaleId 
				AND ISNULL(A.ZnodeCategoryIds,0) = ISNULL(B.PublishCategoryId,0) AND A.VersionId = B.VersionId AND A.ElasticSearchEvent <> 2)
		
			--select * from #ProductEntity_LocaleWise where PublishProductId = 191 

		END

		SET @VersionId = 0  

		IF OBJECT_ID('tempdb..#ProductEntity') is not null
			DROP TABLE #ProductEntity

		IF OBJECT_ID('TEMPDB..#TempProductEntity_LocaleWise') IS NOT NULL
			DROP TABLE #TempProductEntity_LocaleWise

	FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow,@LocaleId, @RevisionType ,@VersionId 
	END;  
	CLOSE cur_BulkData;  
	DEALLOCATE cur_BulkData;  
  
  
	IF @RevisionState = 'PREVIEW'   
	begin
		UPDATE ZnodePimProduct SET IsProductPublish = 1,PublishStateId =  DBO.Fn_GetPublishStateIdForPreview()    
		WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishProduct ZPP WHERE ZPP.PimProductId = ZnodePimProduct.PimProductId   
		AND ZPP.PublishCatalogId = @PublishCatalogId) 
	end
	Else  
	begin
		UPDATE ZnodePimProduct SET IsProductPublish = 1,PublishStateId =  DBO.Fn_GetPublishStateIdForPublish()    
		WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishProduct ZPP WHERE ZPP.PimProductId = ZnodePimProduct.PimProductId   
		AND ZPP.PublishCatalogId = @PublishCatalogId) 
	end
		

	UPDATE ZnodePublishCatalogLog   
	SET IsProductPublished = 1   
	,PublishProductId = (SELECT  COUNT(DISTINCT PublishProductId) FROM ZnodePublishCategoryProduct ZPP   
		WHERE ZPP.PublishCatalogId = ZnodePublishCatalogLog.PublishCatalogId AND ZPP.PublishCategoryId IS NOT NULL)   
	WHERE ZnodePublishCatalogLog.PublishCatalogId = @PublishCatalogId  
	and PublishStateId = (SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE PublishStateCode = 'Processing' ) 
    
	--UPDATE ZnodePublishCatalogLog   
	--SET IsProductPublished = 1   
	--,PublishProductId = (SELECT  COUNT(DISTINCT PublishProductId) FROM ZnodePublishCatalogProductDetail ZPP   
	--	WHERE ZPP.PublishCatalogId = ZnodePublishCatalogLog.PublishCatalogId AND ZPP.PimCategoryHierarchyId <> 0)   
	--WHERE ZnodePublishCatalogLog.PublishCatalogId = @PublishCatalogId  
	--AND PublishStateId = (SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE PublishStateCode = 'Processing' )  

	SET @Status = 1   

	IF OBJECT_ID('tempdb..##AttributeValueLocale') IS NOT NULL  
		DROP TABLE ##AttributeValueLocale; 

END TRY   
BEGIN CATCH   
	SELECT ERROR_MESSAGE()
	 SET @Status =0    
	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	  @ErrorLine VARCHAR(100)= ERROR_LINE(),  
	  @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishProductJson   
		 @PublishCatalogId = '+CAST(@PublishCatalogId AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))  
	  +',@PimCatalogId = ' + CAST(@PimCatalogId AS varchar(20))  
	  +',@VersionIdString= ' + CAST(@VersionIdString AS varchar(20))  
       
	 EXEC Znode_InsertProcedureErrorLog  
	  @ProcedureName = 'Znode_GetPublishProductJson',  
	  @ErrorInProcedure = @Error_procedure,  
	  @ErrorMessage = @ErrorMessage,  
	  @ErrorLine = @ErrorLine,  
	  @ErrorCall = @ErrorCall;  
END CATCH  
  
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetOmsQuoteList')
	DROP PROC Znode_GetOmsQuoteList
GO

CREATE PROCEDURE [dbo].[Znode_GetOmsQuoteList]    
(     
  @WhereClause NVARCHAR(MAX),    
  @Rows        INT            = 100,    
  @PageNo      INT            = 1  ,    
  @Order_BY    VARCHAR(1000)  = '' ,    
  @RowsCount   INT OUT             ,    
  @AccountId   INT,    
  @UserId      INT            = 0,     
  @IsPendingPayment BIT = 0  ,     
  @IsParentPendingOrder  BIT = 1,
  @SalesRepUserId int = 0    
 )    
AS     
   /*    
  Summary :- This procedure is used to get the Quote list of account and Users    
    Fn_GetRecurciveAccounts is used to fetch AccountId and Its recursive ParentId      
    @InnerWhereClause contains AccountId fetched from the Function Fn_GetRecurciveAccounts     
    OrderDetails are fetched from the tables filtered by AccountId Present in @InnerWhereClause    
    OrderDetails are fetched in Descending order of OmsQuoteId    
     Unit Testing     
     
     EXEC Znode_GetOmsQuoteList '' ,@RowsCount = 50 ,@AccountId = 1,@UserId = 0      
    
*/    
     BEGIN    
         BEGIN TRY    
			SET NOCOUNT ON;    
			DECLARE @SQL VARCHAR(MAX)= '', @InnerWhereClause VARCHAR(MAX)= '', @ProcessType  varchar(50)='Quote',@QuoteFilter NVARCHAr(max)='';    
			
			----Verifying that the @SalesRepUserId is having 'Sales Rep' role
			IF NOT EXISTS
			(
				SELECT * FROM ZnodeUser ZU
				INNER JOIN AspNetZnodeUser ANZU ON ZU.UserName = ANZU.UserName
				INNER JOIN AspNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName
				INNER JOIN AspNetUserRoles ANUR ON ANU.Id = ANUR.UserId
				Where Exists(select * from AspNetRoles ANR Where Name = 'Sales Rep' AND ANUR.RoleId = ANR.Id) 
				AND ZU.UserId = @SalesRepUserId
			)   
			Begin
				SET @SalesRepUserId = 0
			End

            DECLARE @TBL_QuoteDetails TABLE (OmsQuoteId INT,UserName NVARCHAR(300),AccountName NVARCHAR(400),QuoteOrderTotal NUMERIC(28, 6),[OrderStatus] VARCHAR(300),    
            CreatedDate DATETIME,StoreName NVARCHAR(Max),CurrencyCode VARCHAR(100),CultureCode VARCHAR(100),PublishState nvarchar(600),RowId INT,CountNo INT,CreatedByName NVARCHAr(max) ,ModifiedByName NVARCHAR(max),IsConvertedToOrder bit,OrderType varchar(50), UserId INT, AccountCode nvarchar(100));    
           
             IF @UserId <> 0  AND @IsParentPendingOrder   = 1           
                 BEGIN    
                     SET @InnerWhereClause = ' AND '''+CAST(@UserId AS VARCHAR(max))+''' = ZU.UserId ';    
                    -- SET @AccountId = (SELECT TOP 1 AccountID FROM ZnodeUser WHERE UserId = @UserId);    
                 END    
             ELSE IF @IsParentPendingOrder   = 0     
                BEGIN    
				SET @InnerWhereClause = ' AND  EXISTS (SELECT TOP 1 1 FROM [dbo].[Fn_GetRecurciveUserId] ('+CAST(@UserId AS VARCHAR(50))+','''+@ProcessType+''') SP WHERE (SP.UserId = ZU.UserId OR SP.UserId IS NULL)  )';   
   
				SET @QuoteFilter =' AND EXISTS (SELECT TOP 1 1 FROM ZnodeOMSQuoteApproval WR WHERE WR.OmsQuoteId = ZOQ.OmsQuoteId AND ( Wr.ApproverUserId ='+CAST(@UserId AS VARCHAR(50))+' OR Wr.UserId = '+CAST(@UserId AS VARCHAR(50))+'  ) ) ';        
				END    
    ELSE     
    BEGIN     
      SET @InnerWhereClause = ''    
    END       
          
    IF @IsPendingPayment =1     
    BEGIN     
       
     SET @InnerWhereClause = @InnerWhereClause+' AND NOT EXISTS ( SELECT TOP 1 1 FROM ZnodeUserGlobalAttributeValue a     
    INNER JOIN ZnodeUserGlobalAttributeValueLocale b  on (b.UserGlobalAttributeValueId = a.UserGlobalAttributeValueId)    
    INNER JOIN ZnodeGlobalAttribute c ON (c.GlobalAttributeid = a.GlobalAttributeId )    
    WHERE c.AttributeCOde = ''BillingAccountNumber'' AND a.UserId =  ZU.UserId AND b.AttributeValue = '''' ) AND ZOQ.IsPendingPayment =  1    '    
         
    END     
    ELSE     
    BEGIN    
       SET @InnerWhereClause = @InnerWhereClause+' AND ZOQ.IsPendingPayment = 0   '    
    END     
    
    SET @InnerWhereClause = @InnerWhereClause + CASE WHEN @AccountId > 0 THEN 
		' AND CASE WHEN ISNULL(ZOQ.AccountId,0)<>0 THEN ZOQ.AccountId ELSE ZA.AccountId END ='+CAST(@AccountId AS VARCHAR(200)) ELSE '' END     
    
    SET @SQL = '       
		;With Cte_GetQuoteDetail AS     
		(    
			SELECT distinct Zu.UserId ,ZOQ.OmsQuoteId,ZU.FirstName + CASE WHEN ZU.LastName IS NULL THEN '''' ELSE '' ''+Zu.LastName END UserName , QuoteOrderTotal , ZOOS.Description [OrderStatus]    
			,ZOQ.CreatedDate,ZA.Name AccountName,ZP.PortalId,Zp.StoreName , ZCC.CurrencyCode AS CurrencyCode, ZC.CultureCode AS CultureCode ,ZVGD.UserName CreatedByName , ZVGDI.UserName ModifiedByName,    
			case When ZOQ.IsConvertedToOrder IS NULL THEN 0 ELSE ZOQ.IsConvertedToOrder END IsConvertedToOrder,ISNULL(DT.QuoteTypeCode,'''') QuoteTypeCode,ZODPS.DisplayName as PublishState,
			'+case when cast(@IsParentPendingOrder as varchar(10)) = 0  then +'Case  When TYUI.ApproverUserId ='+CAST(@UserId AS VARCHAR(50))  + ' then ''Approval Requested'' 
			else ''Pending For Approval'' END' else '''''' end +' OrderType, ZA.AccountCode    
			FROM ZnodeOmsQuote ZOQ    
			INNER JOIN ZnodeUser ZU ON (ZU.UserId = ZOQ.UserId)    
			LEFT JOIN ZnodePublishState ZODPS ON (ZODPS.PublishStateId = ZOQ.PublishStateId)  
			LEFT JOIN ZnodeUserPortal ZUP ON ZU.UserId = ZUP.UserId    
			inner JOIN ZnodePortal ZP ON ZP.PortalId = Zoq.PortalId    
			'+CASE WHEN @IsParentPendingOrder = 0  THEN ' LEFT JOIN ZnodeOMSQuoteApproval TYUI ON (TYUI.OmsQuoteId = ZOQ.OmsQuoteId AND TYUI.ApproverUserId ='+CAST(@UserId AS VARCHAR(50))+' ) ' ELSE '' END +'    
			LEFT JOIN ZnodePortalUnit ZPU ON (ZPU.PortalId = Zp.PortalId)    
			LEFT JOIN ZnodeCulture ZC ON (ZPU.CultureId = ZC.CultureId)    --- Changed join condition from CurrencyId to CultureId    
			LEFT JOIN ZnodeCurrency ZCC ON (ZC.CurrencyId = ZCC.CurrencyId)    --- Joined ZnodeCulture and ZnodeCurrency   
			LEFT JOIN ZnodeOmsOrderState ZOOS ON (ZOOS.OmsOrderStateId = ZOQ.OmsOrderStateId)     
			LEFT JOIN ZnodeAccount ZA ON (ZA.AccountId = (CASE WHEN ISNULL(ZOQ.AccountId,0)<>0 THEN ZOQ.AccountId ELSE ZU.AccountId END))    
			LEFT JOIN [dbo].[View_GetUserDetails]  ZVGD ON (ZVGD.UserId = ZOQ.CreatedBy )    
			LEFT JOIN [dbo].[View_GetUserDetails]  ZVGDI ON (ZVGDI.UserId = ZOQ.ModifiedBy)    
			INNER JOIN ZnodeOmsQuoteType DT ON (DT.OmsQuoteTypeId = ZOQ.OmsQuoteTypeId)    
			WHERE DT.OmsQuoteTypeId <> (select top 1 OmsQuoteTypeId from ZnodeOmsQuoteType where QuoteTypeCode = ''QUOTE'')'+' '+@InnerWhereClause+@QuoteFilter+'    
			and (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and ZOQ.UserId = SalRep.CustomerUserid) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
			UNION 
			SELECT Zu.UserId ,ZOQ.OmsQuoteId,ZU.FirstName + CASE WHEN ZU.LastName IS NULL THEN '''' ELSE '' ''+Zu.LastName END UserName , QuoteOrderTotal , ZOOS.Description [OrderStatus]    
			,ZOQ.CreatedDate,ZA.Name AccountName,ZP.PortalId,Zp.StoreName , ZCC.CurrencyCode AS CurrencyCode, ZC.CultureCode AS CultureCode ,ZVGD.UserName CreatedByName , ZVGDI.UserName ModifiedByName,    
			case When ZOQ.IsConvertedToOrder IS NULL THEN 0 ELSE ZOQ.IsConvertedToOrder END IsConvertedToOrder,ISNULL(DT.QuoteTypeCode,'''') QuoteTypeCode,ZODPS.DisplayName as PublishState,
			'+case when cast(@IsParentPendingOrder as varchar(10)) = 0  then +'Case  When TYUI.ApproverUserId ='+CAST(@UserId AS VARCHAR(50))  + ' then ''Approval Requested'' 
			else ''Pending For Approval'' END' else '''''' end +' OrderType, ZA.AccountCode    
			FROM ZnodeOmsQuote ZOQ    
			INNER JOIN ZnodeUser ZU ON (ZU.UserId = ZOQ.UserId)    
			LEFT JOIN ZnodePublishState ZODPS ON (ZODPS.PublishStateId = ZOQ.PublishStateId)  
			LEFT JOIN ZnodeUserPortal ZUP ON ZU.UserId = ZUP.UserId    
			inner JOIN ZnodePortal ZP ON ZP.PortalId = Zoq.PortalId    
			'+CASE WHEN @IsParentPendingOrder = 0  THEN ' LEFT JOIN ZnodeOMSQuoteApproval TYUI ON (TYUI.OmsQuoteId = ZOQ.OmsQuoteId AND TYUI.ApproverUserId ='+CAST(@UserId AS VARCHAR(50))+' ) ' ELSE '' END +'    
			LEFT JOIN ZnodePortalUnit ZPU ON (ZPU.PortalId = Zp.PortalId)    
			LEFT JOIN ZnodeCulture ZC ON (ZPU.CultureId = ZC.CultureId)    --- Changed join condition from CurrencyId to CultureId    
			LEFT JOIN ZnodeCurrency ZCC ON (ZC.CurrencyId = ZCC.CurrencyId)    --- Joined ZnodeCulture and ZnodeCurrency   
			LEFT JOIN ZnodeOmsOrderState ZOOS ON (ZOOS.OmsOrderStateId = ZOQ.OmsOrderStateId)     
			LEFT JOIN ZnodeAccount ZA ON (ZA.AccountId = (CASE WHEN ISNULL(ZOQ.AccountId,0)<>0 THEN ZOQ.AccountId ELSE ZU.AccountId END))    
			LEFT JOIN [dbo].[View_GetUserDetails]  ZVGD ON (ZVGD.UserId = ZOQ.CreatedBy )    
			LEFT JOIN [dbo].[View_GetUserDetails]  ZVGDI ON (ZVGDI.UserId = ZOQ.ModifiedBy)    
			INNER JOIN ZnodeOmsQuoteType DT ON (DT.OmsQuoteTypeId = ZOQ.OmsQuoteTypeId)    
			WHERE  DT.OmsQuoteTypeId <> (select top 1 OmsQuoteTypeId from ZnodeOmsQuoteType where QuoteTypeCode = ''QUOTE'')'+
			'AND DT.OmsQuoteTypeId = (select top 1 OmsQuoteTypeId from ZnodeOmsQuoteType where QuoteTypeCode = ''OAB'')'+' '+@InnerWhereClause+'    
			and (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and ZOQ.UserId = SalRep.CustomerUserid) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
		)    
		, Cte_GetQuote AS     
		(    
			SELECT distinct OmsQuoteId,UserName ,AccountName , QuoteOrderTotal QuoteAmount, [OrderStatus]  ,CreatedDate ,StoreName,CurrencyCode, CultureCode,PublishState,CreatedByName , ModifiedByName ,IsConvertedToOrder,OrderType,'+dbo.Fn_GetPagingRowId(@Order_BY,'CreatedDate DESC 
			,OmsQuoteId DESC')+',Count(*)Over() CountNo ,UserId, AccountCode      
			FROM Cte_GetQuoteDetail    
			WHERE 1=1     
			'+dbo.Fn_GetFilterWhereClause(@WhereClause)+'    
		)    
		SELECT distinct OmsQuoteId,UserName ,AccountName ,  QuoteAmount, [OrderStatus]  ,CreatedDate ,StoreName,CurrencyCode, CultureCode,PublishState,RowId,CountNo,CreatedByName , ModifiedByName,IsConvertedToOrder,OrderType, UserId , AccountCode   
		FROM Cte_GetQuote     
		'+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows) 
	
      print @SQL
        INSERT INTO @TBL_QuoteDetails (OmsQuoteId, UserName, AccountName, QuoteOrderTotal ,OrderStatus, CreatedDate, StoreName,CurrencyCode, CultureCode,PublishState, RowId ,CountNo,CreatedByName , ModifiedByName,IsConvertedToOrder,OrderType, UserId, AccountCode)          
        EXEC (@SQL);   	
        SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM @TBL_QuoteDetails), 0);    

        SELECT  OmsQuoteId,UserName,AccountName,QuoteOrderTotal,[OrderStatus],CreatedDate,StoreName,CurrencyCode, CultureCode,PublishState,CreatedByName , ModifiedByName,IsConvertedToOrder  ,OrderType , UserId, AccountCode 
        FROM @TBL_QuoteDetails 
		ORDER BY  RowId
		      
         END TRY    
         BEGIN CATCH    
		DECLARE @Status BIT ;    
		SET @Status = 0;    
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetOmsQuoteList @WhereClause = '+CAST(@WhereClause AS VARCHAR(max)  
		)+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@AccountId='+CAST(@AccountId AS VARCHAR(50))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@PortalId='+''  
		+',@Status='+CAST(@Status AS VARCHAR(10));    
                      
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                        
        
		EXEC Znode_InsertProcedureErrorLog    
		@ProcedureName = 'Znode_GetOmsQuoteList',    
		@ErrorInProcedure = @Error_procedure,    
		@ErrorMessage = @ErrorMessage,    
		@ErrorLine = @ErrorLine,    
		@ErrorCall = @ErrorCall;    
    END CATCH;    
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCustomer')
	DROP PROC Znode_ImportCustomer
GO

CREATE PROCEDURE [dbo].[Znode_ImportCustomer]
(
	  @TableName NVARCHAR(100), 
	  @Status BIT OUT, 
	  @UserId INT, 
	  @ImportProcessLogId INT, 
	  @NewGUId NVARCHAR(200), 
	  @LocaleId INT= 0,
	  @PortalId INT ,
	  @CsvColumnString NVARCHAR(max)
)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Customer Details
	
	-- Unit Testing : 
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(max),@AspNetZnodeUserId NVARCHAR(256),@ASPNetUsersId NVARCHAR(256),
		@PasswordHash NVARCHAR(max),@SecurityStamp NVARCHAR(max),@RoleId NVARCHAR(256),@IsAllowGlobalLevelUserCreation NVARCHAR(10)
		Declare @ProfileId  INT
		DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		 
		SET @SecurityStamp = '0wVYOZNK4g4kKz9wNs-UHw2'
		SET @PasswordHash = 'APy4Tm1KbRG6oy7h3r85UDh/lCW4JeOi2O2Mfsb3OjkpWTp1YfucMAvvcmUqNaSOlA==';
		SELECT  @RoleId  = Id FROM AspNetRoles WHERE   NAME = 'Customer'  

		SELECT @IsAllowGlobalLevelUserCreation = FeatureValues FROM ZnodeGlobalsetting WHERE FeatureName = 'AllowGlobalLevelUserCreation'

		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
		-- Retrive RoundOff Value FROM global setting 

		-- Three type of import required three table varible for product , category and brand
		CREATE TABLE #InsertCustomer 
		( 
			RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, UserName NVARCHAR(512) ,FirstName	NVARCHAR(200),
			LastName NVARCHAR(200), BudgetAmount	NUMERIC,Email	NVARCHAR(100),PhoneNumber	NVARCHAR(100),
		    EmailOptIn	varchar(100)	,ReferralStatus	NVARCHAR(40),IsActive	varchar(100)	,ExternalId	NVARCHAR(max),CreatedDate DATETIME,
			ProfileName varchar(200),AccountCode NVARCHAR(100),DepartmentName varchar(300),RoleName NVARCHAR(256), GUID NVARCHAR(400)
			,PerOrderLimit INT,	PerOrderAnnualLimit NVARCHAR(100),BillingAccountNumber NVARCHAR(100),EnableUserShippingAddressSuggestion  NVARCHAR(100),
			EnablePowerBIReportOnWebStore BIT,Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),
			Custom4 NVARCHAR(max),Custom5 NVARCHAR(max), SMSOptIn varchar(100)
		);

		SET @SSQL = 'INSERT INTO #InsertCustomer( RowNumber,' + @CsvColumnString + ',GUID)
		             SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+ @TableName;
		
		EXEC sys.sp_sqlexec @SSQL;
				
		SELECT TOP 1 @ProfileId   =  ProfileId FROM ZnodePortalprofile WHERE Portalid = @Portalid and IsDefaultRegistedProfile=1
		IF( Isnull(@ProfileId ,0) = 0 ) 
		Begin
		
		
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '62', 'Default Portal Profile', '', @NewGUId, 1 , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
							
				UPDATE ZnodeImportProcessLog
				SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
				WHERE ImportProcessLogId = @ImportProcessLogId;
			

				SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog 
				WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
				SELECT @SuccessRecordCount = 0

				UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
				TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
				WHERE ImportProcessLogId = @ImportProcessLogId;

				DELETE FROM #InsertCustomer 
				SET @Status = 0;

				COMMIT TRAN A;
				Return 0 
		End

		If @IsAllowGlobalLevelUserCreation = 'false'  
	BEGIN
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '10', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM #InsertCustomer AS ii  
	WHERE ltrim(rtrim(ii.UserName)) in   
	(  
	SELECT UserName FROM AspNetZnodeUser   where PortalId = @PortalId  
	);  
	END
	Else   
	BEGIN
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '10', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM #InsertCustomer AS ii  
	WHERE ltrim(rtrim(ii.UserName)) in   
	(  
	SELECT UserName FROM AspNetZnodeUser     
	);  
	END

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '104', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName not like '%_@_%_.__%' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '35', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName like '%;%'
				
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '30', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ltrim(rtrim(ii.UserName)) IN 
		(SELECT ltrim(rtrim(UserName))  FROM #InsertCustomer GROUP BY ltrim(rtrim(UserName))  having count(*) > 1 )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '104', 'Email', Email, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.Email not like '%_@_%_.__%' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'IsActive',  IsActive , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '77', 'AccountCode', ii.AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer ii 
		WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !='' 
		AND NOT EXISTS(SELECT * FROM ZnodeAccount za INNER JOIN ZnodePortalAccount zpa on za.AccountId = zpa.AccountId
			WHERE  ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za.AccountCode and zpa.PortalId = @PortalId )
		AND EXISTS(SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount za1 WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za1.AccountCode );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '73', 'AccountCode', AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !=''   and ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') not IN 
		(
			SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount   
		);

		

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '88', 'AccountCode', AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !='' and  exists
		(
			SELECT top 1 1 FROM  AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	 
		INNER JOIN ZnodeAccount ZA on  ZU.AccountId = ZA.AccountId
		WHERE ANZU.UserName = ii.UserName and  ZA.AccountCode != ii.AccountCode
		);

		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--SELECT '92', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		--FROM #InsertCustomer AS ii
		--WHERE ISNULL(LTRIM(RTRIM(ii.RoleName)),'') <> '' and  ISNULL(LTRIM(RTRIM(ii.RoleName)),'') IN ('User','Manager','Administrator')
		--AND EXISTS(SELECT * FROM ZnodeUser a INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId and b.Id <> a.AspNetUserId))
		--		INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
		--		--INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)						
		--		INNER JOIN AspNetUserRoles u on u.UserId = b.Id
		--		INNER JOIN AspNetRoles ZD on u.RoleId = zd.Id
				-- (ii.UserName = c.UserName) and ISNULL(LTRIM(RTRIM(ii.RoleName)),'') <> ZD.Name )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '75', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') ='' and ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '74', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE --ltrim(rtrim(ii.RoleName)) not IN ('User','Manager','Administrator') and ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and
			ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and not exists (SELECT top 1 1 FROM  AspNetRoles ANR WHERE name IN ('User','Manager','Administrator') and  ANR.name =ii.RoleName)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '76', 'DepartmentName', DepartmentName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') <> ''
		AND NOT EXISTS(SELECT * FROM  ZnodeAccount ZA INNER JOIN ZnodeDepartment ZD on ZA.AccountId = ZD.AccountId
			WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = ltrim(rtrim(za.AccountCode))
			and ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') = ltrim(rtrim(ZD.DepartmentName)))

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'EmailOptIn',  EmailOptIn , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.EmailOptIn NOT IN ('True','1','Yes','FALSE','0','No','');

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'SMSOptIn',  SMSOptIn , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.SMSOptIn NOT IN ('True','1','Yes','FALSE','0','No','');

		UPDATE ZIL
		SET ZIL.ColumnName =   ZIL.ColumnName + ' [ UserName - ' + ISNULL(UserName,'') + ' ] '
		FROM ZnodeImportLog ZIL 
		INNER JOIN #InsertCustomer IPA ON (ZIL.RowNumber = IPA.RowNumber)
		WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		--Note : Content page import is not required 
		
		-- END Function Validation 	
		-----------------------------------------------
		--- Delete Invalid Data after functional validatin  

		DELETE FROM #InsertCustomer
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
			--AND GUID = @NewGUID
		);


		-- Update Record count IN log 
        
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		SELECT @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertCustomer
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- END

		-- Insert Product Data 
				
				
				DECLARE @InsertedAspNetZnodeUser TABLE (AspNetZnodeUserId NVARCHAR(256) ,UserName NVARCHAR(512),PortalId INT )
				DECLARE @InsertedASPNetUsers TABLE (Id NVARCHAR(256) ,UserName NVARCHAR(512))
				DECLARE @InsertZnodeUser TABLE (UserId INT,AspNetUserId NVARCHAR(256),CreatedDate DATETIME )

				UPDATE ANU SET 
				ANU.PhoneNumber	= IC.PhoneNumber, 
					ANU.LockoutEndDateUtc = case when IC.IsActive IN('0','No','False') then @GetDate when IC.IsActive IN('1','Yes','True') then null else ANU.LockoutEndDateUtc END
				FROM AspNetZnodeUser ANZU 
				INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
				WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
				----Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

				UPDATE ZU SET 
				ZU.FirstName	= IC.FirstName,
				ZU.LastName		= IC.LastName,
				--ZU.MiddleName	= IC.MiddleName,
				ZU.BudgetAmount = IC.BudgetAmount,
				ZU.Email		= IC.Email,
				ZU.PhoneNumber	= IC.PhoneNumber,
				ZU.EmailOptIn	= (CASE ISNULL(IC.EmailOptIn,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.EmailOptIn,0) As BIT) END),
				ZU.IsActive		= (CASE ISNULL(IC.IsActive,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.IsActive,0) As BIT) END),
				ZU.Custom1 = IC.Custom1,
				ZU.Custom2 = IC.Custom2,
				ZU.Custom3 = IC.Custom3,
				ZU.Custom4 = IC.Custom4,
				ZU.Custom5 = IC.Custom5,
				ZU.SMSOptIn	= (CASE ISNULL(IC.SMSOptIn,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 WHEN '' THEN ZU.SMSOptIn ELSE CAST(ISNULL(IC.SMSOptIn,0) As BIT) END)
				--ZU.ExternalId = ExternalId
				FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
				WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
				--WHERE Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

				INSERT INTO AspNetZnodeUser (AspNetZnodeUserId, UserName, PortalId)		
				OUTPUT INSERTED.AspNetZnodeUserId, INSERTED.UserName, INSERTED.PortalId	INTO  @InsertedAspNetZnodeUser 			 
				SELECT NEWID(),IC.UserName, @PortalId FROM #InsertCustomer IC 
				WHERE NOT EXISTS (SELECT TOP 1 1  FROM AspNetZnodeUser ANZ 
					WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZ.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END 
					AND ANZ.UserName = IC.UserName)

				INSERT INTO ASPNetUsers (Id,Email,EmailConfirmed,PasswordHash,SecurityStamp,PhoneNumber,PhoneNumberConfirmed,TwoFactorEnabled,
				LockoutEndDateUtc,LockOutEnabled,AccessFailedCount,PasswordChangedDate,UserName)
				OUTPUT inserted.Id, inserted.UserName INTO @InsertedASPNetUsers
				SELECT NewId(), Email,0 ,@PasswordHash,@SecurityStamp,PhoneNumber,0,0,case when A.IsActive IN ('0','False','No') then @GetDate else null END LockoutEndDateUtc,1 LockoutEnabled,
				0,@GetDate,AspNetZnodeUserId FROM #InsertCustomer A INNER JOIN @InsertedAspNetZnodeUser  B 
				ON A.UserName = B.UserName
			
				INSERT INTO  ZnodeUser(AspNetUserId,FirstName,LastName,CustomerPaymentGUID,Email,PhoneNumber,EmailOptIn,
				IsActive,ExternalId, CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,UserName,Custom1,Custom2,Custom3,Custom4,Custom5,SMSOptIn)
				OUTPUT Inserted.UserId, Inserted.AspNetUserId,Inserted.CreatedDate INTO @InsertZnodeUser
				SELECT IANU.Id AspNetUserId ,IC.FirstName,IC.LastName,null CustomerPaymentGUID,IC.Email
				,IC.PhoneNumber,
				(CASE ISNULL(IC.EmailOptIn,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.EmailOptIn,0) As BIT) END),
				(CASE ISNULL(IC.IsActive,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.IsActive,0) As BIT) END),
				IC.ExternalId, @UserId,
				CASE WHEN IC.CreatedDate IS NULL OR IC.CreatedDate = '' THEN  @Getdate ELSE IC.CreatedDate END,
				@UserId,@Getdate,IC.UserName,IC.Custom1,IC.Custom2,IC.Custom3,IC.Custom4,IC.Custom5,
					(CASE ISNULL(IC.SMSOptIn,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.SMSOptIn,0) As BIT) END)
				FROM #InsertCustomer IC INNER JOIN 
				@InsertedAspNetZnodeUser IANZU ON IC.UserName = IANZU.UserName  INNER JOIN 
				@InsertedASPNetUsers IANU ON IANZU.AspNetZnodeUserId = IANU.UserName 
	  	     
				INSERT INTO AspNetUserRoles (UserId,RoleId)  SELECT AspNetUserId, @RoleID FROM @InsertZnodeUser 
				INSERT INTO ZnodeUserPortal (UserId,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
				SELECT UserId, @PortalId , @UserId, IZU.CreatedDate,@UserId,@Getdate 
				FROM @InsertZnodeUser IZU

				INSERT INTO ZnodeAccountUserPermission(UserId,AccountPermissionAccessId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT UserId, 4 , @UserId, @Getdate,@UserId,@Getdate 
				FROM @InsertZnodeUser IZU
		
				------------INSERT INTO ZnodeUserGlobalAttributeValue
	
				IF OBJECT_ID('tempdb..#globaldata') IS NOT NULL 
					DROP TABLE #globaldata
				
				SELECT ZU.userid,PerOrderLimit,
					PerOrderAnnualLimit,
					BillingAccountNumber,
					EnableUserShippingAddressSuggestion,
					EnablePowerBIReportOnWebStore 
				INTO #globaldata
				FROM znodeuser ZU INNER JOIN  #InsertCustomer IC on IC.Email =ZU.EMAIL
				WHERE ZU.userid IN (SELECT userid FROM @InsertZnodeUser)
				GROUP BY ZU.userid,PerOrderLimit,
									PerOrderAnnualLimit,
									BillingAccountNumber,
									EnableUserShippingAddressSuggestion,
									EnablePowerBIReportOnWebStore 

				IF OBJECT_ID('tempdb..#globaldata1') IS NOT NULL DROP TABLE #globaldata1
				SELECT * INTO #globaldata1 FROM (SELECT userid, Cast(PerOrderLimit as varchar(100)) PerOrderLimit,
				 Cast(PerOrderAnnualLimit as varchar(100)) PerOrderAnnualLimit,
				 Cast(BillingAccountNumber as varchar(100)) BillingAccountNumber,
				 Cast(case when cast(EnableUserShippingAddressSuggestion as varchar(10))= '1' or cast(EnableUserShippingAddressSuggestion as varchar(10)) ='YES' or  cast(EnableUserShippingAddressSuggestion as varchar(10)) ='True' then 'True' else 'False'  END  as varchar(100)) EnableUserShippingAddressSuggestion,
				 Cast(case when cast(EnablePowerBIReportOnWebStore as varchar(10))= '1'  or cast(EnablePowerBIReportOnWebStore as varchar(10)) ='YES' or  cast(EnablePowerBIReportOnWebStore as varchar(10)) ='True' then 'True' else 'False' END  as varchar(100)) EnablePowerBIReportOnWebStore FROM #globaldata) ab
				UNPIVOT  
				   (avalue FOR acode IN   
					  (PerOrderLimit,
				PerOrderAnnualLimit,
				BillingAccountNumber,
				EnableUserShippingAddressSuggestion,
				EnablePowerBIReportOnWebStore)  
				)AS unpvt;  

				INSERT INTO ZnodeUserGlobalAttributeValue (UserId,	GlobalAttributeId,	GlobalAttributeDefaultValueId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
				SELECT g.Userid,ZGA.GlobalAttributeId,null,null,@UserId,@Getdate,@UserId,@Getdate
					FROM #globaldata1 g INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.acode
					WHERE NOT EXISTS (SELECT top 1 1 FROM ZnodeUserGlobalAttributeValue ZGAV WHERE ZGAV.Userid =g.Userid and ZGA.GlobalAttributeId=ZGAV.GlobalAttributeId)

				INSERT INTO ZnodeUserGlobalAttributeValuelocale(UserGlobalAttributeValueId,	LocaleId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate,	GlobalAttributeDefaultValueId,	MediaId,	MediaPath)
				SELECT UserGlobalAttributeValueId, @LocaleId,avalue ,@UserId,@Getdate,@UserId,@Getdate,null,null,null
					FROM ZnodeUserGlobalAttributeValue ZUGAV INNER JOIN #globaldata1 g on ZUGAV.userid =g.userid
						INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.acode and ZGA.GlobalAttributeId = ZUGAV.GlobalAttributeId
						WHERE NOT EXISTS (SELECT Top 1 1 FROM ZnodeUserGlobalAttributeValuelocale z WHERE z.UserGlobalAttributeValueId = ZUGAV.UserGlobalAttributeValueId)

				---------------------------------------------------------------------------------

				declare @Profile table (ProfileId INT)

				INSERT INTO ZnodeProfile (ProfileName,ShowOnPartnerSignup,Weighting,TaxExempt,DefaultExternalAccountNo,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ParentProfileId)
				OUTPUT inserted.ProfileId INTO @Profile(ProfileId)
				SELECT Distinct ProfileName, 0, null,0, replace(ltrim(rtrim(ProfileName)),' ','') as DefaultExternalAccountNo, @UserId,@Getdate, @UserId,@Getdate, null as ParentProfileId				
				FROM #InsertCustomer IC
				WHERE NOT EXISTS(SELECT * FROM ZnodeProfile ZP WHERE IC.ProfileName = ZP.ProfileName )
				AND ISNULL(ic.ProfileName,'') <> ''

				INSERT INTO ZnodePortalProfile (PortalId,	ProfileId,	IsDefaultAnonymousProfile,	IsDefaultRegistedProfile,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
				SELECT @PortalId, ProfileId, 0 AS IsDefaultAnonymousProfile, 0 AS IsDefaultRegistedProfile, @UserId,@Getdate, @UserId,@Getdate
				FROM @Profile

				UPDATE ZnodeUserProfile 
				SET ProfileId = COALESCE(ZP.ProfileId,@ProfileId)
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeUserProfile u ON u.UserId = a.UserId
				LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
				--WHERE IC.ProfileName <> ''
				
				INSERT INTO ZnodeUserProfile (ProfileId,UserId,IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT COALESCE(ZP.ProfileId,@ProfileId)  , a.UserId, 1 , @UserId,a.CreatedDate,@UserId,@Getdate 
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeUserProfile u WHERE u.UserId = a.UserId )
				AND EXISTS(SELECT * FROM @InsertZnodeUser IZU WHERE A.UserId = IZU.UserId)

				---to update accountid agaist user
				UPDATE ZU SET ZU.AccountId = ZA.AccountId 
				FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	 
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName
				INNER JOIN ZnodeAccount ZA ON ZA.AccountCode = IC.AccountCode 
				--INNER JOIN @InsertZnodeUser IZU on IZU.UserId =ZU.UserId
				WHERE Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0) and isnull(IC.AccountCode,'') <> ''
				
				update ZDU set ZDU.DepartmentId = ZD.DepartmentId, ModifiedBy = @UserId, ModifiedDate = @Getdate
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
				INNER JOIN ZnodeDepartmentUser ZDU on ZDU.UserId = a.UserId
				WHERE isnull(IC.DepartmentName,'') <> ''

				INSERT INTO ZnodeDepartmentUser(UserId,DepartmentId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT a.UserId, ZD.DepartmentId, @UserId,a.CreatedDate,@UserId,@Getdate 
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeDepartmentUser u WHERE u.UserId = a.UserId)
				AND isnull(IC.DepartmentName,'') <> ''
		
				update u set u.RoleId = ZD.Id
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
				INNER JOIN AspNetUserRoles u on u.UserId = b.Id
				WHERE isnull(IC.RoleName,'') <> ''
				
				INSERT INTO AspNetUserRoles(UserId,RoleId)
				SELECT b.Id as ASPNetUserId, ZD.Id as RoleId
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM AspNetUserRoles u WHERE u.UserId = b.Id)
				AND EXISTS(SELECT * FROM @InsertZnodeUser IZU WHERE A.UserId = IZU.UserId)
				AND isnull(IC.RoleName,'') <> ''


		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
		 DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCustomer @TableName = '+CAST(@TableName AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@PortalId='+CAST(@PortalId AS VARCHAR(10))+',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max));
              	
		 ---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

        EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportCustomer',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetShoppingfeedProductFeedList')
	DROP PROC Znode_GetShoppingfeedProductFeedList
GO

CREATE PROCEDURE [dbo].[Znode_GetShoppingfeedProductFeedList]  
(
	@PortalId   VARCHAR(2000) = NULL,   
	@LocaleId   INT,  
	@FeedType   NVARCHAR(MAX) = NULL   
)
AS  
/*  
Summary: This Procedure is used to get effective keyword feeding of Product list  
 SELECT * FROM ZnodePublishProductDetail  
 SELECT * FROM ZnodePublishProduct WHERE PublishCatalogId = 3  
 SELECT * FROM ZnodePortalCatalog   
 Unit Testing:  
 EXEC [Znode_GetShoppingfeedProductFeedList] @PortalId='0',@ProductIds = '116,117,118'  
 ,@LocaleId=1,@FeedType='Bing'   
  
*/  
BEGIN  
BEGIN TRY  
SET NOCOUNT ON;        
           
		IF OBJECT_ID('tempdb..#TBL_DomainName') IS NOT NULL
		DROP TABLE #TBL_DomainName

		IF OBJECT_ID('tempdb..#TBL_SEODetails') IS NOT NULL
		DROP TABLE #TBL_SEODetails

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_PortalIds') IS NOT NULL
		DROP TABLE #TBL_PortalIds

		DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
		CREATE TABLE #TBL_DomainName 
		(PortalId   INT,
		DomainName NVARCHAR(300),
		RowId      INT
		);  	
         
		CREATE TABLE #TBL_SEODetails   
		(loc                   NVARCHAR(MAX),  
		lastmod               DATETIME,  
		[g:condition]         VARCHAR(1000),  
		[description]         NVARCHAR(MAX),  
		[g:id]                INT,  
		link                  VARCHAR(1000),  
		[g:identifier_exists] VARCHAR(2000),  
		DomainName            NVARCHAR(3000),  
		PortalId              INT , 
		SEOCode             NVARCHAR(4000), 
		CanonicalURL        VARCHAR(2000), 
		RobotTag            VARCHAR(500)
		);  
		
		DECLARE @DefaultLocaleId INT=dbo.Fn_GetDefaultLocaleId()  ;
		CREATE TABLE #TBL_PortalIds (PortalId INT);  
		
		INSERT INTO #TBL_PortalIds  

		SELECT Zp.PortalId   
		FROM Znodeportal AS ZP   
		INNER JOIN ZnodePortalCatalog AS ZPC ON(ZPC.PortalId = Zp.PortalId)  
		INNER JOIN ZnodePublishCatalog AS ZPPC ON(ZPPC.PublishCatalogId = ZPC.PublishCatalogId)   
		INNER JOIN ZNodePublishProduct AS ZPP ON(ZPP.PublishCatalogId = ZPPC.PublishCatalogId)  
		INNER JOIN ZnodePublishProductDetail AS PPD ON (PPD.PublishProductId = ZPP.PublishProductId)  
		WHERE
		
		EXISTS(SELECT TOP 1 1 FROM DBO.Split(@PortalId, ',') AS Sp  
		WHERE(CAST(sp.Item AS INT)) = Zp.PortalId  OR @PortalId = '0')  
		AND EXISTS (SELECT TOP 1 1 FROM ZnodeDomain ZD WHERE ZP.PortalId = ZD.PortalId  
		AND IsActive = 1 AND ApplicationType = 'Webstore' AND IsDefault = 1)  
		GROUP BY Zp.PortalId;   
		
		INSERT INTO #TBL_DomainName   
		SELECT  PortalId,DomainName,ROW_NUMBER() OVER(PARTITION BY PortalId ORDER BY DomainName)   
		FROM ZnodeDomain AS ZD   
		WHERE EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZD.PortalId)  
		AND IsActive = 1 AND ApplicationType = 'Webstore' AND IsDefault = 1 
 
			SELECT DISTINCT ZCSD.CMSSEODetailId,ZCSD.SEOURL AS loc,ZCSD.ModifiedDate AS lastmod,'new' AS [g:condition],ZCSDL.SEODescription AS [description],ZPCC.PublishProductId AS [g:id],  
            ZCSD.SEOUrl AS link,'false' AS [g:identifier_exists],TBDN.DomainName,ZPC.PortalId,ISNULL(ZCSDL.LocaleId, @DefaultLocaleId) AS LocaleId , ZCSD.SEOCode , ZCSDL.CanonicalURL, ZCSDL.RobotTag 
			INTO #Cte_SeoDetailsWithLocale
			FROM ZNodePublishProduct AS ZPCC   
			INNER JOIN ZnodePortalCatalog AS ZPC ON(ZPC.PublishCatalogId = ZPCC.PublishCatalogId)  
			LEFT JOIN ZnodePublishProductDetail AS PPD ON (PPD.PublishProductId = ZPCC.PublishProductId)  
			LEFT JOIN ZnodeCMSSEODetail AS ZCSD ON(PPD.SKU = ZCSD.SEOCode and ZCSD.PortalId = ZPC.PortalId)  
			LEFT JOIN ZnodeCMSSEOType AS ZCST ON(ZCST.CMSSEOTypeId = ZCSD.CMSSEOTypeId AND ZCST.Name = 'Product')  
			LEFT JOIN ZnodeCMSSEODetailLocale AS ZCSDL ON(ZCSDL.CMSSEODetailId = ZCSD.CMSSEODetailId AND ZCSDL.LocaleId IN(@LocaleId, @DefaultLocaleId))  
			LEFT JOIN #TBL_DomainName AS TBDN ON(TBDN.RowId = 1 AND TBDN.PortalId = zpc.PortalId)   
			WHERE EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZPC.PortalId)  
				
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag  
			INTO #Cte_SeoDetailsWithFirstLocale
			FROM #Cte_SeoDetailsWithLocale   
			WHERE LocaleId = @LocaleId  
    
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode , CanonicalURL, RobotTag 
			INTO #Cte_SeoDetailsWithDefaultLocale
			FROM #Cte_SeoDetailsWithFirstLocale  
			
			INSERT INTO #Cte_SeoDetailsWithDefaultLocale 
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag  
			FROM #Cte_SeoDetailsWithLocale AS CTSDWL  
			WHERE LocaleId = @DefaultLocaleId   
			AND NOT EXISTS(SELECT TOP 1 1 FROM #Cte_SeoDetailsWithFirstLocale AS CTSDWDL WHERE CTSDWDL.CMSSEODetailId = CTSDWL.CMSSEODetailId)  
          
			INSERT INTO #TBL_SEODetails  
			SELECT DISTINCT loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId ,SEOCode, CanonicalURL, RobotTag  
			FROM #Cte_SeoDetailsWithDefaultLocale;  
			
			SELECT TBSD.loc,TBSD.lastmod,TBSD.[g:condition],TBSD.[description],TBSD.[g:id],TBSD.link,TBSD.[g:identifier_exists],TBSD.DomainName,TBSD.PortalId,  
			CASE WHEN SUM(ZI.Quantity) > 0 THEN 'In Stock' ELSE CASE WHEN @FeedType = 'Shoppingfeed' THEN 'Out Of Stock' ELSE 'Not In Stock' END  
			END AS [g:availability],
			ZPPD.SKU ,TBSD.SEOCode, TBSD.CanonicalURL, TBSD.RobotTag, ZPP.PublishProductId,ZPPD.ProductName
			INTO #TBL_CompleteDetailes  
			FROM ZnodePublishProduct AS ZPP   
			LEFT JOIN #TBL_SEODetails AS TBSD ON(ZPP.PublishProductId = TBSD.[g:id] )  
			LEFT JOIN ZnodePublishProductDetail AS ZPPD ON(ZPPD.PublishProductId = ZPP.PublishProductId AND ZPPD.LocaleId = @LocaleId)  
			LEFT JOIN ZnodePortalWarehouse AS ZPW ON(ZPW.PortalId = TBSD.PortalId)  
			LEFT JOIN ZnodePortalAlternateWarehouse AS ZAPW ON(ZAPW.PortalWarehouseId = ZPW.PortalWarehouseId)  
			LEFT JOIN ZnodeInventory AS ZI ON(ZI.SKU = ZPPD.SKU AND (ZI.WarehouseId = ZPW.WarehouseId OR ZI.WarehouseId = ZAPW.WarehouseId))  			
			GROUP BY loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,TBSD.PortalId,ZPPD.SKU,ZPPD.LocaleId, TBSD.SEOCode, TBSD.CanonicalURL, TBSD.RobotTag, ZPP.PublishProductId,ZPPD.ProductName;    
			
			DECLARE @MediaConfiguration NVARCHAR(2000)=((SELECT TOP 1 ISNULL(CASE WHEN CDNURL = '' THEN NULL ELSE CDNURL END,URL) FROM ZnodeMediaConfiguration WHERE IsActive = 1));    
  
			CREATE INDEX Idx_#TBL_CompleteDetailes ON #TBL_CompleteDetailes(PortalId,SKU)
	
	
			SELECT zp.PortalId,round(ZPS.RetailPrice,2) as RetailPrice,Zps.SKU,tbcd.SEOCode,ROW_NUMBER() OVER(PARTITION BY Zps.SKU,zp.PortalId ORDER BY ZPS.RetailPrice) AS RowId  
			INTO #Cte_PortalList
			FROM ZnodePriceList AS ZPL   
			LEFT JOIN ZnodePriceListPortal AS ZPLP ON ZPL.PriceListId = ZPLP.PriceListId  
			LEFT JOIN ZnodeCulture AS zc ON ZPL.CultureId = zc.CultureId
			LEFT JOIN ZnodePortal AS zp ON ZPLP.PortalId = zp.PortalId  
			LEFT JOIN ZnodePrice AS Zps ON(Zps.PriceListId = ZPL.PriceListId)   
			LEFT JOIN #TBL_CompleteDetailes AS TBCD ON(TBCD.PortalId = Zp.PortalId AND TBCD.SKU = Zps.Sku)   
			WHERE CAST(@GetDate AS DATE) BETWEEN ZPL.ActivationDate AND ZPL.ExpirationDate   
			AND EXISTS( SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZPLP.PortalId)   
			GROUP BY zp.PortalId,ZPS.RetailPrice,Zps.SKU ,TBCD.SEOCode  
			
			SELECT D.PublishProductId,C.AttributeDefaultValueCode AS Brand
			INTO #BrandDetails
			FROM ZnodePimAttributeValue A
			INNER JOIN ZnodePimProductAttributeDefaultValue B ON B.PimAttributeValueId=A.PimAttributeValueId
			INNER JOIN ZnodePimAttributeDefaultValue C ON C.PimAttributeDefaultValueId=A.PimAttributeDefaultValueId	
			INNER JOIN Znodepublishproduct D ON  A.PimProductId = D.PimProductId 
			WHERE EXISTS(SELECT * FROM ZnodePimAttribute D WHERE D.PimAttributeId=A.PimAttributeId AND D.AttributeCode='Brand' )
			AND EXISTS(SELECT * FROM #TBL_CompleteDetailes E Where E.PublishProductId = D.PublishProductId)		
			
			SELECT A.CategoryName , A.ZnodeProductId AS PublishProductId, ROW_NUMBER() OVER(PARTITION BY A.ZnodeProductId ORDER BY A.ZnodeProductId) AS RowId
			INTO #ProductCategories
			FROM ZnodePublishProductEntity A 
			WHERE EXISTS(SELECT * FROM #TBL_CompleteDetailes B WHERE A.ZnodeProductId = B.PublishProductId)
			AND ISNULL(A.CategoryName,'') <> ''

			DELETE FROM #ProductCategories WHERE RowId <> 1
 
			SELECT SKU,SUM(cast(Quantity as numeric(28,0)))AS Inventory 
			into #InventotyDetails 
			FROM ZnodeInventory A 
			WHERE EXISTS(SELECT * FROM #TBL_CompleteDetailes B where A.SKU=B.SKU)
			GROUP BY SKU  

			SELECT F.PublishProductId,[Path] AS ImagePath
			INTO #ProductImage
			FROM ZnodePimAttributeValue a
			INNER JOIN ZnodePimProductAttributeMedia b on a.PimAttributeValueId = b.PimAttributeValueId
			INNER JOIN ZnodeMedia d on b.MediaId = d.MediaId
			INNER JOIN Znodepublishproduct F ON  A.PimProductId = F.PimProductId 
			WHERE EXISTS(SELECT * FROM ZnodePimAttribute C WHERE C.PimAttributeId=A.PimAttributeId AND C.AttributeCode='PRODUCTIMAGE' )
			AND EXISTS(SELECT * FROM #TBL_CompleteDetailes E Where E.PublishProductId = F.PublishProductId)		

						 
			SELECT 
			CAST(DomainName AS nvarchar(MAX) ) as DomainName,
			CAST(ProductName AS nvarchar(50) ) AS Title,
			--lastmod,
			--[g:condition],
			CAST([description] AS nvarchar(MAX) ) AS [Description],
			CAST([g:id] AS nvarchar(50) ) AS ProductID,
			CAST([g:availability] AS nvarchar(50) ) as [Availability],
			--[g:identifier_exists],	
			--TBCD.PortalId,
			Cast(CAST(CTPL.RetailPrice AS numeric(28,3))as nvarchar(100)) AS Price,
			@MediaConfiguration AS MediaConfiguration,
			--TBCD.SEOCode,
			--TBCD.CanonicalURL,
			--TBCD.RobotTag,
			CAST(PC.CategoryName AS nvarchar (50)) AS Category,
			CAST(ID.Inventory AS nvarchar(50) ) AS Inventory,
			CAST(BD.Brand AS nvarchar(50) ) AS Brand,
			CAST(ID.SKU AS nvarchar(50) ) AS ID,
			CAST(link AS nvarchar(MAX) ) AS Link,
			CAST(PM.IMAGEPATH AS nvarchar(MAX) ) AS Image_Link
			FROM #TBL_CompleteDetailes AS TBCD   
			LEFT JOIN #Cte_PortalList AS CTPL ON(CTPL.PortalId = TBCD.PortalId AND CTPL.SKU = TBCD.SKU AND CTPL.RowID = 1)  
			LEFT JOIN #ProductCategories PC ON TBCD.PublishProductId = PC.PublishProductId
			LEFT JOIN #InventotyDetails ID ON TBCD.SKU = ID.SKU 
			LEFT JOIN #BrandDetails BD on TBCD.PublishProductId=BD.PublishProductId
			LEFT JOIN #ProductImage PM on TBCD.PublishProductId=PM.PublishProductId
			WHERE  EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = TBCD.PortalId)

		IF OBJECT_ID('tempdb..#TBL_DomainName') IS NOT NULL
		DROP TABLE #TBL_DomainName

		IF OBJECT_ID('tempdb..#TBL_SEODetails') IS NOT NULL
		DROP TABLE #TBL_SEODetails

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_PortalIds') IS NOT NULL
		DROP TABLE #TBL_PortalIds
		
END TRY  
BEGIN CATCH  
	DECLARE @Status BIT ;  
	SET @Status = 0;  
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetShoppingfeedProductFeedList @PortalId = '+@PortalId+',@LocaleId='+CAST(@LocaleId AS VARCHAR(50))+',@FeedType='+CAST(@FeedType AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));  
                 
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
     
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_GetShoppingfeedProductFeedList',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
   
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCustomer')
	DROP PROC Znode_ImportCustomer
GO

CREATE PROCEDURE [dbo].[Znode_ImportCustomer]
(
	  @TableName NVARCHAR(100), 
	  @Status BIT OUT, 
	  @UserId INT, 
	  @ImportProcessLogId INT, 
	  @NewGUId NVARCHAR(200), 
	  @LocaleId INT= 0,
	  @PortalId INT ,
	  @CsvColumnString NVARCHAR(max)
)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Customer Details
	
	-- Unit Testing : 
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(max),@AspNetZnodeUserId NVARCHAR(256),@ASPNetUsersId NVARCHAR(256),
		@PasswordHash NVARCHAR(max),@SecurityStamp NVARCHAR(max),@RoleId NVARCHAR(256),@IsAllowGlobalLevelUserCreation NVARCHAR(10)
		Declare @ProfileId  INT
		DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		 
		SET @SecurityStamp = '0wVYOZNK4g4kKz9wNs-UHw2'
		SET @PasswordHash = 'APy4Tm1KbRG6oy7h3r85UDh/lCW4JeOi2O2Mfsb3OjkpWTp1YfucMAvvcmUqNaSOlA==';

		SELECT  @RoleId  = Id FROM AspNetRoles WHERE   NAME = 'User'  

		SELECT @IsAllowGlobalLevelUserCreation = FeatureValues FROM ZnodeGlobalsetting WHERE FeatureName = 'AllowGlobalLevelUserCreation'

		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
		-- Retrive RoundOff Value FROM global setting 
		Delete from ZnodeImportLog where ErrorDescription = '42' and ColumnName like '%AccountCode%' and  ImportProcessLogId= @ImportProcessLogId
		
		
		
		-- Three type of import required three table varible for product , category and brand
		CREATE TABLE #InsertCustomer 
		( 
			RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, UserName NVARCHAR(512) ,FirstName	NVARCHAR(200),
			LastName NVARCHAR(200), BudgetAmount	NUMERIC,Email	NVARCHAR(100),PhoneNumber	NVARCHAR(100),
		    EmailOptIn	varchar(100)	,ReferralStatus	NVARCHAR(40),IsActive	varchar(100)	,ExternalId	NVARCHAR(max),CreatedDate DATETIME,
			ProfileName varchar(200),AccountCode NVARCHAR(100),DepartmentName varchar(300),RoleName NVARCHAR(256), GUID NVARCHAR(400)
			,PerOrderLimit INT,	PerOrderAnnualLimit NVARCHAR(100),BillingAccountNumber NVARCHAR(100),EnableUserShippingAddressSuggestion  NVARCHAR(100),
			EnablePowerBIReportOnWebStore BIT,Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),
			Custom4 NVARCHAR(max),Custom5 NVARCHAR(max), SMSOptIn varchar(100)
		);

		SET @SSQL = 'INSERT INTO #InsertCustomer( RowNumber,' + @CsvColumnString + ',GUID)
		             SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+ @TableName;
		
		EXEC sys.sp_sqlexec @SSQL;

	    --If Account Code Exists then it will update as it is and if not exists then it will show error.
		UPDATE IC set AccountCode = ZA.AccountCode 
		FROM ZnodeUser a
		inner join ZnodeAccount ZA on (ZA.AccountId = a.AccountId)
		INNER JOIN #InsertCustomer IC on (IC.UserName = a.UserName)
		WHERE ISNULL(IC.AccountCode,'') = '' AND ISNULL(IC.RoleName,'') <> ''


		
		SELECT TOP 1 @ProfileId   =  ProfileId FROM ZnodePortalprofile WHERE Portalid = @Portalid and IsDefaultRegistedProfile=1
		IF( Isnull(@ProfileId ,0) = 0 ) 
		Begin
		
		
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '62', 'Default Portal Profile', '', @NewGUId, 1 , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
							
				UPDATE ZnodeImportProcessLog
				SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
				WHERE ImportProcessLogId = @ImportProcessLogId;
			

				SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog 
				WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
				SELECT @SuccessRecordCount = 0

				UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
				TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
				WHERE ImportProcessLogId = @ImportProcessLogId;

				DELETE FROM #InsertCustomer 
				SET @Status = 0;

				COMMIT TRAN A;
				Return 0 
		End

			If @IsAllowGlobalLevelUserCreation = 'false'  
		BEGIN
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '10', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ltrim(rtrim(ii.UserName)) in   
		(  
		SELECT UserName FROM AspNetZnodeUser   where PortalId = @PortalId  
		);  
		END
		Else   
		BEGIN
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '10', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ltrim(rtrim(ii.UserName)) in   
		(  
		SELECT UserName FROM AspNetZnodeUser     
		);  
		END


		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '104', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName not like '%_@_%_.__%' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '35', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName like '%;%'
				
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '30', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ltrim(rtrim(ii.UserName)) IN 
		(SELECT ltrim(rtrim(UserName))  FROM #InsertCustomer GROUP BY ltrim(rtrim(UserName))  having count(*) > 1 )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '104', 'Email', Email, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.Email not like '%_@_%_.__%' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'IsActive',  IsActive , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '77', 'AccountCode', ii.AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer ii 
		WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !='' 
		AND NOT EXISTS(SELECT * FROM ZnodeAccount za INNER JOIN ZnodePortalAccount zpa on za.AccountId = zpa.AccountId
			WHERE  ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za.AccountCode and zpa.PortalId = @PortalId )
		AND EXISTS(SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount za1 WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za1.AccountCode );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '73', 'AccountCode', AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !=''   and ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') not IN 
		(
			SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount   
		);


		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '75', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') ='' and ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '74', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE --ltrim(rtrim(ii.RoleName)) not IN ('User','Manager','Administrator') and ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and
			ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and not exists (SELECT top 1 1 FROM  AspNetRoles ANR WHERE name IN ('User','Manager','Administrator') and  ANR.name =ii.RoleName)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '76', 'DepartmentName', DepartmentName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') <> ''
		AND NOT EXISTS(SELECT * FROM  ZnodeAccount ZA INNER JOIN ZnodeDepartment ZD on ZA.AccountId = ZD.AccountId
			WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = ltrim(rtrim(za.AccountCode))
			and ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') = ltrim(rtrim(ZD.DepartmentName)))

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'EmailOptIn',  EmailOptIn , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.EmailOptIn NOT IN ('True','1','Yes','FALSE','0','No','');

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'SMSOptIn',  SMSOptIn , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.SMSOptIn NOT IN ('True','1','Yes','FALSE','0','No','');

		UPDATE ZIL
		SET ZIL.ColumnName =   ZIL.ColumnName + ' [ UserName - ' + ISNULL(UserName,'') + ' ] '
		FROM ZnodeImportLog ZIL 
		INNER JOIN #InsertCustomer IPA ON (ZIL.RowNumber = IPA.RowNumber)
		WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		--Note : Content page import is not required 
		
		-- END Function Validation 	
		-----------------------------------------------
		--- Delete Invalid Data after functional validatin  

		DELETE FROM #InsertCustomer
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
			--AND GUID = @NewGUID
		);


		-- Update Record count IN log 
        
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		SELECT @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertCustomer
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- END

		-- Insert Product Data 
				
				
				DECLARE @InsertedAspNetZnodeUser TABLE (AspNetZnodeUserId NVARCHAR(256) ,UserName NVARCHAR(512),PortalId INT )
				DECLARE @InsertedASPNetUsers TABLE (Id NVARCHAR(256) ,UserName NVARCHAR(512))
				DECLARE @InsertZnodeUser TABLE (UserId INT,AspNetUserId NVARCHAR(256),CreatedDate DATETIME )

				UPDATE ANU SET 
				ANU.PhoneNumber	= IC.PhoneNumber, 
					ANU.LockoutEndDateUtc = case when IC.IsActive IN('0','No','False') then @GetDate when IC.IsActive IN('1','Yes','True') then null else ANU.LockoutEndDateUtc END
				FROM AspNetZnodeUser ANZU 
				INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
				WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
				----Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

				UPDATE ZU SET 
				ZU.FirstName	= IC.FirstName,
				ZU.LastName		= IC.LastName,
				--ZU.MiddleName	= IC.MiddleName,
				ZU.BudgetAmount = IC.BudgetAmount,
				ZU.Email		= IC.Email,
				ZU.PhoneNumber	= IC.PhoneNumber,
				ZU.EmailOptIn	= (CASE IC.EmailOptIn WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.EmailOptIn,0) As BIT) END),
				ZU.IsActive		= (CASE IC.IsActive WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.IsActive,0) As BIT) END),
				ZU.Custom1 = IC.Custom1,
				ZU.Custom2 = IC.Custom2,
				ZU.Custom3 = IC.Custom3,
				ZU.Custom4 = IC.Custom4,
				ZU.Custom5 = IC.Custom5,
				ZU.SMSOptIn	= (CASE IC.SMSOptIn WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 WHEN ISNULL(IC.SMSOptIn,'') THEN ZU.SMSOptIn ELSE CAST(ISNULL(IC.SMSOptIn,0) As BIT) END)
				--ZU.ExternalId = ExternalId
				FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
				WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
				--WHERE Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

				INSERT INTO AspNetZnodeUser (AspNetZnodeUserId, UserName, PortalId)		
				OUTPUT INSERTED.AspNetZnodeUserId, INSERTED.UserName, INSERTED.PortalId	INTO  @InsertedAspNetZnodeUser 			 
				SELECT NEWID(),IC.UserName, @PortalId FROM #InsertCustomer IC 
				WHERE NOT EXISTS (SELECT TOP 1 1  FROM AspNetZnodeUser ANZ 
					WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZ.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END 
					AND ANZ.UserName = IC.UserName)

				INSERT INTO ASPNetUsers (Id,Email,EmailConfirmed,PasswordHash,SecurityStamp,PhoneNumber,PhoneNumberConfirmed,TwoFactorEnabled,
				LockoutEndDateUtc,LockOutEnabled,AccessFailedCount,PasswordChangedDate,UserName)
				OUTPUT inserted.Id, inserted.UserName INTO @InsertedASPNetUsers
				SELECT NewId(), Email,0 ,@PasswordHash,@SecurityStamp,PhoneNumber,0,0,case when A.IsActive IN ('0','False','No') then @GetDate else null END LockoutEndDateUtc,1 LockoutEnabled,
				0,@GetDate,AspNetZnodeUserId FROM #InsertCustomer A INNER JOIN @InsertedAspNetZnodeUser  B 
				ON A.UserName = B.UserName
			
				INSERT INTO  ZnodeUser(AspNetUserId,FirstName,LastName,CustomerPaymentGUID,Email,PhoneNumber,EmailOptIn,
				IsActive,ExternalId, CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,UserName,Custom1,Custom2,Custom3,Custom4,Custom5,SMSOptIn)
				OUTPUT Inserted.UserId, Inserted.AspNetUserId,Inserted.CreatedDate INTO @InsertZnodeUser
				SELECT IANU.Id AspNetUserId ,IC.FirstName,IC.LastName,null CustomerPaymentGUID,IC.Email
				,IC.PhoneNumber,
				(CASE IC.EmailOptIn WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.EmailOptIn,0) As BIT) END),
				(CASE IC.IsActive WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.IsActive,0) As BIT) END),
				IC.ExternalId, @UserId,
				CASE WHEN IC.CreatedDate IS NULL OR IC.CreatedDate = '' THEN  @Getdate ELSE IC.CreatedDate END,
				@UserId,@Getdate,IC.UserName,IC.Custom1,IC.Custom2,IC.Custom3,IC.Custom4,IC.Custom5,
					(CASE IC.SMSOptIn WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.SMSOptIn,0) As BIT) END)
				FROM #InsertCustomer IC INNER JOIN 
				@InsertedAspNetZnodeUser IANZU ON IC.UserName = IANZU.UserName  INNER JOIN 
				@InsertedASPNetUsers IANU ON IANZU.AspNetZnodeUserId = IANU.UserName 
	  	     
				INSERT INTO AspNetUserRoles (UserId,RoleId)  SELECT AspNetUserId, @RoleID FROM @InsertZnodeUser 
				INSERT INTO ZnodeUserPortal (UserId,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
				SELECT UserId, @PortalId , @UserId, IZU.CreatedDate,@UserId,@Getdate 
				FROM @InsertZnodeUser IZU

				INSERT INTO ZnodeAccountUserPermission(UserId,AccountPermissionAccessId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT UserId, 4 , @UserId, @Getdate,@UserId,@Getdate 
				FROM @InsertZnodeUser IZU
		
				------------INSERT INTO ZnodeUserGlobalAttributeValue
	
				IF OBJECT_ID('tempdb..#globaldata') IS NOT NULL 
					DROP TABLE #globaldata
				
				SELECT ZU.userid,PerOrderLimit,
					PerOrderAnnualLimit,
					BillingAccountNumber,
					EnableUserShippingAddressSuggestion,
					EnablePowerBIReportOnWebStore 
				INTO #globaldata
				FROM znodeuser ZU INNER JOIN  #InsertCustomer IC on IC.Email =ZU.EMAIL
				WHERE ZU.userid IN (SELECT userid FROM @InsertZnodeUser)
				GROUP BY ZU.userid,PerOrderLimit,
									PerOrderAnnualLimit,
									BillingAccountNumber,
									EnableUserShippingAddressSuggestion,
									EnablePowerBIReportOnWebStore 

				IF OBJECT_ID('tempdb..#globaldata1') IS NOT NULL DROP TABLE #globaldata1
				SELECT * INTO #globaldata1 FROM (SELECT userid, Cast(PerOrderLimit as varchar(100)) PerOrderLimit,
				 Cast(PerOrderAnnualLimit as varchar(100)) PerOrderAnnualLimit,
				 Cast(BillingAccountNumber as varchar(100)) BillingAccountNumber,
				 Cast(case when cast(EnableUserShippingAddressSuggestion as varchar(10))= '1' or cast(EnableUserShippingAddressSuggestion as varchar(10)) ='YES' or  cast(EnableUserShippingAddressSuggestion as varchar(10)) ='True' then 'True' else 'False'  END  as varchar(100)) EnableUserShippingAddressSuggestion,
				 Cast(case when cast(EnablePowerBIReportOnWebStore as varchar(10))= '1'  or cast(EnablePowerBIReportOnWebStore as varchar(10)) ='YES' or  cast(EnablePowerBIReportOnWebStore as varchar(10)) ='True' then 'True' else 'False' END  as varchar(100)) EnablePowerBIReportOnWebStore FROM #globaldata) ab
				UNPIVOT  
				   (avalue FOR acode IN   
					  (PerOrderLimit,
				PerOrderAnnualLimit,
				BillingAccountNumber,
				EnableUserShippingAddressSuggestion,
				EnablePowerBIReportOnWebStore)  
				)AS unpvt;  

				INSERT INTO ZnodeUserGlobalAttributeValue (UserId,	GlobalAttributeId,	GlobalAttributeDefaultValueId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
				SELECT g.Userid,ZGA.GlobalAttributeId,null,null,@UserId,@Getdate,@UserId,@Getdate
					FROM #globaldata1 g INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.acode
					WHERE NOT EXISTS (SELECT top 1 1 FROM ZnodeUserGlobalAttributeValue ZGAV WHERE ZGAV.Userid =g.Userid and ZGA.GlobalAttributeId=ZGAV.GlobalAttributeId)

				INSERT INTO ZnodeUserGlobalAttributeValuelocale(UserGlobalAttributeValueId,	LocaleId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate,	GlobalAttributeDefaultValueId,	MediaId,	MediaPath)
				SELECT UserGlobalAttributeValueId, @LocaleId,avalue ,@UserId,@Getdate,@UserId,@Getdate,null,null,null
					FROM ZnodeUserGlobalAttributeValue ZUGAV INNER JOIN #globaldata1 g on ZUGAV.userid =g.userid
						INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.acode and ZGA.GlobalAttributeId = ZUGAV.GlobalAttributeId
						WHERE NOT EXISTS (SELECT Top 1 1 FROM ZnodeUserGlobalAttributeValuelocale z WHERE z.UserGlobalAttributeValueId = ZUGAV.UserGlobalAttributeValueId)

				---------------------------------------------------------------------------------

				declare @Profile table (ProfileId INT)

				INSERT INTO ZnodeProfile (ProfileName,ShowOnPartnerSignup,Weighting,TaxExempt,DefaultExternalAccountNo,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ParentProfileId)
				OUTPUT inserted.ProfileId INTO @Profile(ProfileId)
				SELECT Distinct ProfileName, 0, null,0, replace(ltrim(rtrim(ProfileName)),' ','') as DefaultExternalAccountNo, @UserId,@Getdate, @UserId,@Getdate, null as ParentProfileId				
				FROM #InsertCustomer IC
				WHERE NOT EXISTS(SELECT * FROM ZnodeProfile ZP WHERE IC.ProfileName = ZP.ProfileName )
				AND ISNULL(ic.ProfileName,'') <> ''

				INSERT INTO ZnodePortalProfile (PortalId,	ProfileId,	IsDefaultAnonymousProfile,	IsDefaultRegistedProfile,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
				SELECT @PortalId, ProfileId, 0 AS IsDefaultAnonymousProfile, 0 AS IsDefaultRegistedProfile, @UserId,@Getdate, @UserId,@Getdate
				FROM @Profile

				UPDATE ZnodeUserProfile 
				SET ProfileId = COALESCE(ZP.ProfileId,@ProfileId)
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeUserProfile u ON u.UserId = a.UserId
				LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
				--WHERE IC.ProfileName <> ''
				
				INSERT INTO ZnodeUserProfile (ProfileId,UserId,IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT COALESCE(ZP.ProfileId,@ProfileId)  , a.UserId, 1 , @UserId,a.CreatedDate,@UserId,@Getdate 
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeUserProfile u WHERE u.UserId = a.UserId )
				AND EXISTS(SELECT * FROM @InsertZnodeUser IZU WHERE A.UserId = IZU.UserId)

				---to update accountid agaist user
				UPDATE ZU SET ZU.AccountId = ZA.AccountId 
				FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	 
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName
				INNER JOIN ZnodeAccount ZA ON ZA.AccountCode = IC.AccountCode 
				--INNER JOIN @InsertZnodeUser IZU on IZU.UserId =ZU.UserId
				WHERE Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0) and isnull(IC.AccountCode,'') <> '' 
				--EXISTS (SELECT * FROM #InsertCustomer IC WHERE IC.AccountCode = ZA.AccountCode AND ISNULL(IC.AccountCode,'') = '' AND ISNULL(IC.RoleName,'') <> '' )

				
				update ZDU set ZDU.DepartmentId = ZD.DepartmentId, ModifiedBy = @UserId, ModifiedDate = @Getdate
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
				INNER JOIN ZnodeDepartmentUser ZDU on ZDU.UserId = a.UserId
				WHERE isnull(IC.DepartmentName,'') <> ''


				INSERT INTO ZnodeDepartmentUser(UserId,DepartmentId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT a.UserId, ZD.DepartmentId, @UserId,a.CreatedDate,@UserId,@Getdate 
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeDepartmentUser u WHERE u.UserId = a.UserId)
				AND isnull(IC.DepartmentName,'') <> ''
		
				update u set u.RoleId = ZD.Id
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
				INNER JOIN AspNetUserRoles u on u.UserId = b.Id
				WHERE isnull(IC.RoleName,'') <> '' 

				--when RoleName and AccountCode is null in update file then If a value was available previously, then it should be removed (along with Department and Role Name) 
				--after the update process is complete.
				DELETE UR FROM AspNetUserRoles UR 
				INNER JOIN ZnodeUser ZC	ON  ZC.AspNetUserId = UR.UserId
				WHERE EXISTS (SELECT * FROM #InsertCustomer IC WHERE IC.UserName = ZC.UserName AND (ISNULL(IC.RoleName,'') = '' AND ISNULL(IC.AccountCode,'') = ''))


				UPDATE ZnodeUser SET AccountId = NULL 
				WHERE EXISTS (SELECT * FROM #InsertCustomer IC WHERE IC.UserName = ZnodeUser.UserName AND ISNULL(IC.AccountCode,'') = '' AND ISNULL(IC.RoleName,'') = '' )		

		
				INSERT INTO AspNetUserRoles(UserId,RoleId)
				SELECT b.Id as ASPNetUserId, case when ZD.Id is null then @RoleId else ZD.Id end  as RoleId
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				LEFT JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM AspNetUserRoles u WHERE u.UserId = b.Id)
				AND ISNULL(IC.AccountCode,'') <> ''
			
				--If no value was available previously then no value should be saved after the update process is complete.
				--If a value was available previously, then it should be removed after the update process is complete.
				DELETE DU FROM ZnodeDepartmentUser DU
				INNER JOIN ZnodeUser ZU ON DU.UserId = ZU.UserId
				INNER JOIN ZnodeDepartment ZC ON  ZC.DepartmentId = DU.DepartmentId
				WHERE EXISTS (SELECT * FROM #INSERTCUSTOMER IC WHERE IC.UserName = ZU.UserName AND (ISNULL(IC.DepartmentName,'') = '' OR ISNULL(IC.ACCOUNTCODE,'') = ''))


		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
		 DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCustomer @TableName = '+CAST(@TableName AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@PortalId='+CAST(@PortalId AS VARCHAR(10))+',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max));
              	
		 ---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

        EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportCustomer',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
END;



GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportValidatePimProductData')
	DROP PROC Znode_ImportValidatePimProductData
GO

CREATE PROCEDURE [dbo].[Znode_ImportValidatePimProductData]
(   @ImportHeadName     VARCHAR(200),
    @TableName          VARCHAR(200),
    @NewGUID            NVARCHAR(200),
    @TemplateId         INT,
    @UserId             INT,
    @LocaleId           INT           = 1,
    @IsCategory         INT           = 0,
    @DefaultFamilyId    INT           = 0,
    @ImportProcessLogId INT,
    @PriceListId        INT,
	@CountryCode VARCHAR(100) = '',
	@PimCatalogId         INT    = 0 ,
	@PortalId int = 0,
	@IsAccountAddress bit = 0 )
AS
     SET NOCOUNT ON;

/*
    Summary :   Import PimProduct / Price / Inventory / Category / Category Associated Data 
    Process :   Admin site will upload excel / csv file in database and create global temporary table
				Procedure Znode_ImportValidatePimProductData will validate data with attribute validation rule
				If datatype validation issue found in input daata will logged into table "ZnodeImportLog"
				If Data is correct and record count in table ZnodeImportLog will be 0 then process for import data into Base tables
				To import data call procedure "Znode_ImportPimProductData"
    		  
				SourceColumnName: CSV file column headers
				TargetColumnName: Attributecode from ZnodePimAttribute Table (Consider those Attributecodes configured with default family only)
*/

     BEGIN
         BEGIN TRY
             SET NOCOUNT ON;
             --BEGIN TRAN TRN_ImportValidProductData;
             DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
             DECLARE @SQLQuery NVARCHAR(MAX), @AttributeTypeName NVARCHAR(100), @AttributeCode NVARCHAR(300), @AttributeId INT, @IsRequired BIT, @SourceColumnName NVARCHAR(600), @ControlName VARCHAR(300), @ValidationName VARCHAR(100), @SubValidationName VARCHAR(300), @ValidationValue VARCHAR(300), @RegExp VARCHAR(300), @CreateDateString NVARCHAR(300), @DefaultLocaleId INT, @ImportHeadId INT, @CheckedSourceColumn NVARCHAR(600)= '', @Status BIT= 0,
			    @CsvColumnString nvarchar(max),
				@FailedRecordCount BIGINT,
				@SuccessRecordCount BIGINT
            --To get the total record count for update purpose in catch block
            SET @SQLQuery = 'SELECT '+CAST(@ImportProcessLogId AS VARCHAR(10))+',COUNT(*) FROM '+@TableName
			INSERT INTO Znode_ImportCsvRowCount
			EXEC (@SQLQuery) 

             DECLARE @FamilyAttributeDetail TABLE
             (PimAttributeId       INT,
              AttributeTypeName    VARCHAR(300),
              AttributeCode        VARCHAR(300),
              SourceColumnName     NVARCHAR(600),
              IsRequired           BIT,
              PimAttributeFamilyId INT
             );
             DECLARE @AttributeDetail TABLE
             (PimAttributeId    INT,
              AttributeTypeName VARCHAR(300),
              AttributeCode     VARCHAR(300),
              SourceColumnName  NVARCHAR(600),
              IsRequired        BIT,
              ControlName       VARCHAR(300),
              ValidationName    VARCHAR(100),
              SubValidationName VARCHAR(300),
              ValidationValue   VARCHAR(300),
              RegExp            VARCHAR(300)
             );

			CREATE TABLE #DefaultAttributeCode
			(AttributeTypeName          VARCHAR(300),
			PimAttributeDefaultValueId INT,
			PimAttributeId             INT,
			AttributeDefaultValueCode  VARCHAR(100)
			);

			IF( @ImportHeadName = 'B2BCustomer' )
			BEGIN
				EXEC ZnodeB2BCustomerMapping @ImportHeadName = @ImportHeadName, @TableName = @TableName
			END
		
             DECLARE @GlobalTempTableColumns TABLE(ColumnName NVARCHAR);
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM INFORMATION_SCHEMA.TABLES
                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#InvalidDefaultData'
             )
                 CREATE TABLE #InvalidDefaultData
                 (RowNumber  INT,
                  Value      NVARCHAR(MAX),
                  ColumnName NVARCHAR(600)
                 );
             ELSE
             DROP TABLE #InvalidDefaultData;
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM INFORMATION_SCHEMA.TABLES
                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#GlobalTempTableColumns'
             )
                 BEGIN

                     SET @SQLQuery = 'SELECT Column_Name, '''+@ImportHeadName+''' AS ImportHeadName  from tempdb.INFORMATION_SCHEMA.COLUMNS	where table_name = object_name(object_id('''+@TableName+'''),
					(select database_id from sys.databases where name = ''tempdb''))';
                     CREATE TABLE #GlobalTempTableColumns
                     (ColumnName   NVARCHAR(MAX),
                      TypeOfImport NVARCHAR(100)
                     );
                     INSERT INTO #GlobalTempTableColumns
                     (ColumnName,
                      TypeOfImport
                     )
                     EXEC sys.sp_sqlexec
                          @SQLQuery;
                 END;

             IF EXISTS
             (
                 SELECT TOP 1 1
                 FROM #GlobalTempTableColumns
                 WHERE ColumnName IN('PimCategoryId', 'PimProductId', 'RowNumber')
             )
                 BEGIN
                     INSERT INTO ZnodeImportLog
                     (ErrorDescription,
                      ColumnName,
                      Data,
                      GUID,
                      CreatedBy,
                      CreatedDate,
                      ModifiedBy,
                      ModifiedDate,
                      ImportProcessLogId
                     )
                     VALUES
                     (43,
                      '',
                      '',
                      @newGUID,
                      @UserId,
                      @GetDate,
                      @UserId,
                      @GetDate,
                      @ImportProcessLogId
                     );
                 END;
             SET @DefaultLocaleId = dbo.Fn_GetDefaultLocaleId();

             IF NOT EXISTS
             (
                 SELECT TOP 1 1  FROM ZnodeImportLog
                 WHERE Guid = @NewGUID
                       AND ErrorDescription IN(43, 42)
                 AND ImportProcessLogId = @ImportProcessLogId
             )
                 BEGIN
                     IF @ImportHeadName = 'Product'
                      BEGIN
						  IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
							  SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimProductId int null ';
						  ELSE 
							 SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimProductId int null Primary KEY CLUSTERED(RowNumber)';
						 
						  EXEC sys.sp_sqlexec @SQLQuery;
			         END;
                     ELSE
                     IF @ImportHeadName = 'Category'
                         BEGIN
							  IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimCategoryId int null ';
							  ElSE
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimCategoryId int null Primary KEY CLUSTERED(RowNumber) ';
						  
							  EXEC sys.sp_sqlexec @SQLQuery;
                         END;
                     ELSE
                         BEGIN
							IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1) ';
							Else 
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1) Primary KEY CLUSTERED(RowNumber)';
							
							EXEC sys.sp_sqlexec @SQLQuery;
                         END;;
                 END;

             SET @CreateDateString = CONVERT(VARCHAR(100), @UserId)+','''+CONVERT(VARCHAR(100), @GetDate)+''','+CONVERT(VARCHAR(100), @UserId)+','''+CONVERT(VARCHAR(100), @GetDate)+''', '+CONVERT(VARCHAR(100), @ImportProcessLogId);

             SELECT TOP 1 @ImportHeadId = ImportHeadId FROM ZnodeImportTemplate WHERE ImportTemplateId = @TemplateId;
             IF @DefaultFamilyId = 0
                AND @ImportHeadName IN('Product', 'Category')
                 BEGIN 
                     --Get all default attribute values in attribute 
                     INSERT INTO @FamilyAttributeDetail
                     (PimAttributeId,
                      AttributeTypeName,
                      AttributeCode,
                      SourceColumnName,
                      IsRequired,
                      PimAttributeFamilyId
                     )
                     --Call Process to insert data of defeult family with source column name and target column name 
                     EXEC Znode_ImportGetTemplateDetails
                          @TemplateId = @TemplateId,
                          @IsValidationRules = 0,
                          @IsIncludeRespectiveFamily = 1,
                          @IsCategory = @IsCategory,
                          @DefaultFamilyId = @DefaultFamilyId;

					---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;
             ELSE
             IF @ImportHeadName IN('Product', 'Category')
                 BEGIN
				 
                     --Get all default attribute values in attribute 
                     INSERT INTO @FamilyAttributeDetail
                     (PimAttributeId,
                      AttributeTypeName,
                      AttributeCode,
                      SourceColumnName,
                      IsRequired,
                      PimAttributeFamilyId
                     )
                     --Call Process to insert data of defeult family with source column name and target column name 
                     EXEC Znode_ImportGetTemplateDetails
                          @TemplateId = @TemplateId,
                          @IsValidationRules = 0,
                          @IsIncludeRespectiveFamily = 1,
                          @IsCategory = @IsCategory,
                          @DefaultFamilyId = @DefaultFamilyId;

					---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;      
             -- Check attributes are manditory and not provided with source table
		   	 
			if @TABLENAME	like '%tempdb..%'
				SET @SQLQuery = 'SELECT 42 AS ErrorDescription , SourceColumnName , '''' , '''+@NewGUID+''','+@CreateDateString+' from ZnodeImportTemplateMapping where ImportTemplateId = '+CONVERT(VARCHAR(100), @TemplateId)+' and ltrim(rtrim(SourceColumnName)) <> '''' AND ltrim(rtrim(SourceColumnName)) not in ( select isnull(Name ,'''') from tempdb.sys.columns where object_id = object_id('''+@TABLENAME+'''));';
			else 
				SET @SQLQuery = 'SELECT 42 AS ErrorDescription , SourceColumnName , '''' , '''+@NewGUID+''','+@CreateDateString+' from ZnodeImportTemplateMapping where ImportTemplateId = '+CONVERT(VARCHAR(100), @TemplateId)+' and ltrim(rtrim(SourceColumnName)) <> '''' AND ltrim(rtrim(SourceColumnName)) not in ( select isnull(Name ,'''') from sys.columns where object_id = object_id('''+@TABLENAME+'''));';
		 
			Declare @Tbl_CsvDynamicColulmns TABLE (ColumnName nvarchar(300), SequenceNumber int, DataType nvarchar(50),IsRequired bit )

			INSERT INTO @Tbl_CsvDynamicColulmns(ColumnName , SequenceNumber , DataType ,IsRequired)
			SELECT DISTINCT ZITM.SourceColumnName ,ZIAV.SequenceNumber, ZIAV.AttributeTypeName, ZIAV.IsRequired
			FROM ZnodeImportAttributeValidation ZIAV LEFT OUTER JOIN 
			ZnodeImportTemplate  ZIT ON ZIT.ImportHeadId =  ZIAV.ImportHeadId AND ZIT.ImportTemplateId  = @TemplateId
			LEFT OUTER JOIN ZnodeImportTemplateMapping  ZITM ON ZITM.ImportTemplateId = ZIT.ImportTemplateId  
			and ZIAV.AttributeCode = ZITM.TargetColumnName
			AND ZITM.ImportTemplateId  = @TemplateId
			WHERE ZIAV.ImportHeadId = @ImportHeadId
			AND ISNULL(ZITM.SourceColumnName,'') <> ''--ORDER BY ZIAV.SequenceNumber


		    SELECT @CsvColumnString = SUBSTRING ((Select ',' +  ISNULL(ColumnName ,'NULL') from @Tbl_CsvDynamicColulmns ORDER BY SequenceNumber FOR XML PATH ('')),2,4000) 


     		INSERT INTO ZnodeImportLog(ErrorDescription, ColumnName, Data, GUID,CreatedBy, CreatedDate,  ModifiedBy,ModifiedDate,ImportProcessLogId
             )
             EXEC sys.sp_sqlexec  @SQLQuery;
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM ZnodeImportLog
                 WHERE Guid = @NewGUID
                       AND ErrorDescription IN(43, 42)
                 AND ImportProcessLogId = @ImportProcessLogId
             )
                 BEGIN
                     --Get all default attribute values in attribute 
                     IF @ImportHeadName IN('Product', 'Category')
                         BEGIN
                             -- Check attributes are manditory and not provided with source table
                             INSERT INTO ZnodeImportLog
                             (ErrorDescription,
                              ColumnName,
                              Data,
                              GUID,
                              CreatedBy,
                              CreatedDate,
                              ModifiedBy,
                              ModifiedDate,
                              ImportProcessLogId
                             )
                                    SELECT '14' AS ErrorDescription,
                                           AttributeCode,
                                           '',
                                           @NewGUID,
                                           @UserId,
                                           @GetDate,
                                           @UserId,
                                           @GetDate,
                                           @ImportProcessLogId
                                    FROM @FamilyAttributeDetail
                                    WHERE ISNULL(SourceColumnName, '') = ''
                                          AND IsRequired = 1;  

                             -- Read all attribute details with their datatype
                             INSERT INTO @AttributeDetail
                             (PimAttributeId,
                              AttributeTypeName,
                              AttributeCode,
                              SourceColumnName,
                              IsRequired,
                              ControlName,
                              ValidationName,
                              SubValidationName,
                              ValidationValue,
                              RegExp
                             )
                             EXEC Znode_ImportGetTemplateDetails
                                  @TemplateId=@TemplateId,
								  @DefaultFamilyId=@DefaultFamilyId;

							---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
							Delete FAD from @AttributeDetail FAD
							where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
							and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
										   inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode) 

                             DELETE FROM @AttributeDetail
                             WHERE AttributeTypeName = 'Image'
                                   AND ValidationName <> 'IsAllowMultiUpload';
							DELETE FROM @AttributeDetail
                             WHERE AttributeTypeName = 'File'
                                   AND ValidationName <> 'IsAllowMultiUpload';

                                     INSERT INTO #DefaultAttributeCode
                                     (AttributeTypeName,
                                      PimAttributeDefaultValueId,
                                      PimAttributeId,
                                      AttributeDefaultValueCode
                                     )
                                     --Call Process to insert default data value 
                                     EXEC Znode_ImportGetPimAttributeDefaultValue;

                                     DELETE FROM #DefaultAttributeCode
                                     WHERE AttributeTypeName = 'Yes/No';

                         END;
                     ELSE
                         BEGIN
					
					
                             --Read all attribute details with their datatype
                             INSERT INTO @AttributeDetail
                             (AttributeTypeName,
                              AttributeCode,
                              SourceColumnName,
                              IsRequired,
                              ControlName,
                              ValidationName,
                              SubValidationName,
                              ValidationValue,
                              RegExp
                             )
                             EXEC [Znode_ImportGetOtherTemplateDetails]
                                  @TemplateId = @TemplateId,
                                  @ImportHeadId = @ImportHeadId;

							IF @ImportHeadName IN('B2BCustomer')
							BEGIN

								INSERT INTO @AttributeDetail
								 (PimAttributeId,
								 AttributeTypeName,
								  AttributeCode,
								  SourceColumnName,
								  IsRequired,
								  ControlName,
								  ValidationName,
								  SubValidationName,
								  ValidationValue,
								  RegExp
								 )
								 EXEC [Znode_ImportGetGlobalTemplateDetails]
									  @TemplateId = @TemplateId,
									  @ImportHeadId = @ImportHeadId;

								
								INSERT INTO #DefaultAttributeCode
								(AttributeTypeName,
								PimAttributeDefaultValueId,
								PimAttributeId,
								AttributeDefaultValueCode
								)
								--Call Process to insert default data value 
								EXEC Znode_ImportGetGlobalAttributeDefaultValue;

								DELETE FROM #DefaultAttributeCode
								WHERE AttributeTypeName = 'Yes/No';

							END
						
                             --Check attributes are not mapped with any family of Pim Product
                             INSERT INTO ZnodeImportLog
                             (ErrorDescription,
                              ColumnName,
                              Data,
                              GUID,
                              CreatedBy,
                              CreatedDate,
                              ModifiedBy,
                              ModifiedDate,
                              ImportProcessLogId
                             )
                                    SELECT DISTINCT
                                           '14' AS ErrorDescription,
                                           AttributeCode,
                                           '',
                                           @NewGUID,
                                           @UserId,
                                           @GetDate,
                                           @UserId,
                                           @GetDate,
                                           @ImportProcessLogId
                                    FROM @AttributeDetail
                                    WHERE ISNULL(SourceColumnName, '') = ''   AND IsRequired = 1;  ;

                         END;
						
                     --	Check attributes are not mapped with (Default / Other) family of Pim Product
                     --	INSERT INTO ZnodeImportLog ( ErrorDescription , ColumnName , Data , GUID , CreatedBy , CreatedDate , ModifiedBy , ModifiedDate , ImportProcessLogId)
                     --	SELECT '1' AS ErrorDescription , SourceColumnName , '' , @NewGUID , @UserId , @GetDate , @UserId , @GetDate , @ImportProcessLogId
                     --	FROM @AttributeDetail WHERE PimAttributeId NOT IN ( SELECT zpfgm.PimAttributeId FROM dbo.ZnodePimFamilyGroupMapper AS zpfgm);
                     --	Verify data in global temporary table (column wise)
					
                     DECLARE Cr_Attribute CURSOR LOCAL FAST_FORWARD
                     FOR SELECT PimAttributeId,
                                AttributeTypeName,
                                AttributeCode,
                                IsRequired,
                                SourceColumnName,
                                ControlName,
                                ValidationName,
                                SubValidationName,
                                ValidationValue,
                                RegExp
                         FROM @AttributeDetail
                         WHERE ISNULL(SourceColumnName, '') <> '';
                     OPEN Cr_Attribute;
                     FETCH NEXT FROM Cr_Attribute INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @ControlName, @ValidationName, @SubValidationName, @ValidationValue, @RegExp;
                     WHILE @@FETCH_STATUS = 0
                         BEGIN
				             IF @AttributeTypeName = 'Number'
                                 BEGIN
							      EXEC Znode_ImportValidateNumber
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @ImportHeadId = @ImportHeadId,
                                          @ImportProcessLogId = @ImportProcessLogId;
                                 END;
							 -- Check invalid date
							
                             IF @AttributeTypeName = 'Date'
                                 BEGIN
                                     EXEC Znode_ImportValidateDate
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @ImportHeadId = @ImportHeadId,
                                          @ImportProcessLogId = @ImportProcessLogId;
                                 END;
							 -- Check Manditory Data
		 					 IF @IsRequired = 1 AND @CheckedSourceColumn <> @SourceColumnName
								BEGIN
									SET @CheckedSourceColumn = @SourceColumnName;
									EXEC Znode_ImportValidateManditoryData
									@TableName = @TableName,
									@SourceColumnName = @SourceColumnName,
									@CreateDateString = @CreateDateString,
									@ValidationName = @ValidationName,
									@ControlName = @ControlName,
									@ValidationValue = @ValidationValue,
									@NewGUID = @NewGUID,
									@ImportHeadId = @ImportHeadId;
								END;
							 --END 
							
                             IF @AttributeTypeName = 'Text'
                                 BEGIN
								 
						              EXEC Znode_ImportValidateManditoryText
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @LocaleId = @LocaleId,
                                          @DefaultLocaleId = @DefaultLocaleId,
                                          @AttributeId = @AttributeId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @ImportHeadId = @ImportHeadId;
                                 END;
                             IF @AttributeTypeName in ( 'Image','File')
                                 BEGIN
                                     EXEC Znode_ImportValidateImageData
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @LocaleId = @LocaleId,
                                          @DefaultLocaleId = @DefaultLocaleId,
                                          @AttributeId = @AttributeId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @ImportHeadId = @ImportHeadId;
                                 END;

					

                             --Check Default data value is valid 
                             IF @ImportHeadName IN('Product', 'Category','B2BCustomer')
                                 BEGIN
                                     IF @AttributeId IN
                                     (
                                         SELECT PimAttributeId
                                         FROM #DefaultAttributeCode
                                     )
                                         BEGIN
							
                                            IF  @AttributeTypeName = 'Multi Select'
											 BEGIN
										 		 ---Verify Image file is exists in media table or not 
												 SET @SQLQuery = ' INSERT INTO #InvalidDefaultData (RowNumber, Value, ColumnName) 
												 SELECT ROWNUMBER , (Select TOP 1 Item from dbo.split(' + @SourceColumnName + ','','')  SP WHERE NOT EXISTS 
												 (Select ToP 1 1 FROM #DefaultAttributeCode DAC WHERE 
												  DAC.AttributeTypeName <> ''Yes/No'' AND DAC.AttributeDefaultValueCode IS NOT NULL AND DAC.PimAttributeId = 
												 ' + CONVERT(VARCHAR(100), @AttributeId) + ' AND ltrim(rtrim(SP.Item) ) = DAC.AttributeDefaultValueCode
												 )), ''' + @SourceColumnName + ''' as [ColumnName]  FROM ' + @TableName
												 + ' Where ISnull(' + @SourceColumnName +  ','''') <> '''''
												EXEC sys.sp_sqlexec @SQLQuery;
											  END
											  ELSE IF @AttributeTypeName = 'Simple Select'
											  BEGIN
						
												---Verify Image file is exists in media table or not 
												 SET @SQLQuery = ' INSERT INTO #InvalidDefaultData (RowNumber, Value, ColumnName) 
												 SELECT ROWNUMBER , ' + @SourceColumnName + ' , ''' + @SourceColumnName + ''' as [ColumnName]  FROM ' + @TableName
												 + ' SP Where ISnull(' + @SourceColumnName +  ','''') <> '''' AND 
												  NOT EXISTS 
												 (Select TOP 1 1 FROM #DefaultAttributeCode DAC WHERE 
												  DAC.AttributeTypeName <> ''Yes/No'' AND DAC.AttributeDefaultValueCode IS NOT NULL AND DAC.PimAttributeId = 
												 ' + CONVERT(VARCHAR(100), @AttributeId) + ' AND ltrim(rtrim(SP.' + @SourceColumnName + ') ) = DAC.AttributeDefaultValueCode ) '
							
												EXEC sys.sp_sqlexec @SQLQuery;
											  END   
												-- Check Invalid Image 
												 SET @SQLQuery = 'SELECT ''9 '' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], 
												 Value AS  AttributeValue,RowNumber ,'''+@NewGUID+''',  '+@CreateDateString+' FROM #InvalidDefaultData Where Value IS NOT NULL'
												 INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, RowNumber, GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
												 EXEC sys.sp_sqlexec @SQLQuery;
												 Delete from #InvalidDefaultData

       
                                         END;
                                 END;
							
                             FETCH NEXT FROM Cr_Attribute INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @ControlName, @ValidationName, @SubValidationName, @ValidationValue, @RegExp;
                         END;
                     CLOSE Cr_Attribute;
                     DEALLOCATE Cr_Attribute;
                     --SELECT top 1 1 FROM @FamilyAttributeDetail where  iSNULL(SourceColumnName,'') = ''  and IsRequired = 1
                 END;
             
			 
			  
------------------------------------------------------------------------------------------
		 Declare @SQLQueryNew NVARCHAR(4000)
		 Declare @SourceColumnNameProduct nvarchar(4000) 
         IF @ImportHeadName IN('Product','Pricing','ProductAssociation','Inventory')
		 BEGIN
		 	 
		 SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'SKU'
		 AND ImportTemplateId = @TemplateId


			SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  SKU - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;			
		END
		ELSE IF @ImportHeadName IN('ProductAttribute')
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'AttributeCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  Attribute - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'ZipCode'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'ZIP'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  ZIPCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'Category'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'CategoryCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  CategoryCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'CategoryAssociation'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'CategoryName'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  CategoryName - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;

		END
		ELSE IF @ImportHeadName IN ('Customer','CustomerAddress')
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'UserName'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  UserName - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'SEODetails'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'Code'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  Code - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'Highlight'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'HighlightCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  HighlightCode - '' + ' + ' cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'AddonAssociation'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'SKU'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  SKU - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'AttributeDefaultValue'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'AttributeDefaultValueCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  AttributeDefaultValueCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
	-------------------------------------------------------------------------------------------------------------
	
	--------------------------------------------------------------------------------------------------------------------
			 
  		SET @SQLQuery = 'Delete FROM  '+@TableName+' Where Rownumber IN (Select Rownumber FROM ZnodeImportLog  WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND Rownumber IS NOT NULL)';
        EXEC sys.sp_sqlexec  @SQLQuery;
			 			
   
             IF @ImportHeadName IN('Product', 'Category')
                 BEGIN
                     IF NOT EXISTS
                     (
                         SELECT TOP 1 1
                         FROM @FamilyAttributeDetail
                         WHERE ISNULL(SourceColumnName, '') = ''
                               AND IsRequired = 1
                     ) AND NOT EXISTS
					 (
						 SELECT TOP 1 1
						 FROM ZnodeImportLog
						 WHERE Guid = @NewGUID
							   AND ErrorDescription IN(43, 42)
						 AND ImportProcessLogId = @ImportProcessLogId
					 )
                         BEGIN
                             IF @IsCategory = 0
                                 BEGIN

                                     EXEC Znode_ImportPimProductData
                                          @TableName = @TableName,
                                          @NewGUID = @NewGUID,
                                          @TemplateId = @TemplateId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @UserId = @UserId,
                                          @LocaleId = @LocaleId,
                                          @DefaultFamilyId = @DefaultFamilyId;

                                 END;
                             ELSE
                                 BEGIN
                                     EXEC Znode_ImportPimCategoryData
                                          @TableName = @TableName,
                                          @NewGUID = @NewGUID,
                                          @TemplateId = @TemplateId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @UserId = @UserId,
                                          @LocaleId = @LocaleId,
                                          @DefaultFamilyId = @DefaultFamilyId;
                                 END;
                         END
						 ELSE
							BEGIN
								-- Update Record count in log 
								
							
								--SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
								--EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount out
								--UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
								--WHERE ImportProcessLogId = @ImportProcessLogId;

								SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
								SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
								EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount out
								UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
								WHERE ImportProcessLogId = @ImportProcessLogId;
							END

                 END;
				IF NOT EXISTS
					 (
						 SELECT TOP 1 1
						 FROM ZnodeImportLog
						 WHERE Guid = @NewGUID
							   AND ErrorDescription IN(43, 42)
						 AND ImportProcessLogId = @ImportProcessLogId
					 )
             BEGIN
                 IF @ImportHeadName = 'Pricing'
                     BEGIN
                         EXEC [Znode_ImportPriceList]
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
                              @PriceListId = @PriceListId;
                     END;

                 IF @ImportHeadName = 'Inventory'
                     BEGIN
				
                         EXEC Znode_ImportInventory_Ver1
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID;
                     END;
                 IF @ImportHeadName = 'ZipCode'
                     BEGIN
						 EXEC Znode_ImportZipCode
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
							  @CountryCode = @CountryCode;
                     END;
					 IF @ImportHeadName = 'CategoryAssociation'
                     BEGIN
						 EXEC Znode_ImportCatalogCategory
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
							  @PimCatalogId = @PimCatalogId;
                     END;
					 IF @ImportHeadName = 'ProductAssociation'
                     BEGIN
						 EXEC Znode_ImportAssociateProducts
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID
                     END;
			
					 IF @ImportHeadName = 'SEODetails' AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportSEODetails
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
							  @LocaleId = @LocaleId,
							  @PortalId =@PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
							  @CsvColumnString = @CsvColumnString 

				
                     END;
				
					 IF @ImportHeadName = 'ProductAttribute' 
                     BEGIN
						 EXEC Znode_ImportAttributes
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
							  @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID
				
                     END;

					 IF @ImportHeadName = 'Customer' AND @PortalId > 0 
                     BEGIN
					
						 EXEC Znode_ImportCustomer
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = @PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
				
                     END;
					 
					 IF @ImportHeadName = 'UserApprovers' AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportUserApproval
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = @PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
				
                     END;

					 IF @ImportHeadName = 'B2BCustomer' AND @PortalId > 0 
                     BEGIN

							 EXEC Znode_ImportB2BCustomer
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = @PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
				
                     END;

					 IF @ImportHeadName = 'CustomerAddress' --AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportCustomerAddress
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = 7, -- not implemented from forntend 
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString,
							  @IsAccountAddress = @IsAccountAddress
				
                     END;
					 IF @ImportHeadName = 'ShippingAddress' --AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportCustomerAddress
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = 7, -- not implemented from forntend 
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString,
							  @IsAccountAddress = @IsAccountAddress
				
                     END;
					 IF @ImportHeadName = 'StoreLocator' --AND @PortalId > 0 
                     BEGIN
					 	 EXEC Znode_ImportStoreLocatorAddress
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
                     END;

					IF @ImportHeadName = 'Highlight'
					BEGIN
					EXEC Znode_ImportHighlight 
					@TableName = @TableName, 
					@Status = @Status, 
					@UserId = @UserId, 
					@ImportProcessLogId = @ImportProcessLogId, 
					@NewGUID = @NewGUID 
					END;

					IF @ImportHeadName = 'AddonAssociation'
					BEGIN
					EXEC Znode_ImportAddonAssociation 
					@TableName = @TableName, 
					@Status = @Status, 
					@UserId = @UserId, 
					@ImportProcessLogId = @ImportProcessLogId, 
					@NewGUID = @NewGUID,
					@PimCatalogId = @PimCatalogId
					END;

					IF @ImportHeadName = 'AttributeDefaultValue'
					BEGIN
					EXEC Znode_ImportAttributeDefaultValue 
					@TableName = @TableName, 
					@Status = @Status, 
					@UserId = @UserId, 
					@ImportProcessLogId = @ImportProcessLogId, 
					@NewGUID = @NewGUID
					
					END;

					IF @ImportHeadName = 'Voucher'
					BEGIN
						EXEC Znode_ImportVoucher 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID
					
					END;

					IF @ImportHeadName = 'Account'
					BEGIN
						
						EXEC Znode_ImportAccount 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID,
						@CsvColumnString = @CsvColumnString,
						@PortalId = @PortalId
					
					END;

					IF @ImportHeadName = 'Synonyms'
					BEGIN
						EXEC Znode_ImportSynonyms 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID
					END
				 
             END
			 ELSE 
				 BEGIN
					-- Update Record count in log 	
					SET @SQLQuery = ' Select @FailedRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
					EXEC	sp_executesql @SQLQuery , N'@FailedRecordCount BIGINT out' , @FailedRecordCount =@FailedRecordCount out
					SELECT @SuccessRecordCount = 0
									
					UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
					WHERE ImportProcessLogId = @ImportProcessLogId;

				 END

             EXEC Znode_ImportReadErrorLog
                  @ImportProcessLogId = @ImportProcessLogId,
                  @NewGUID = @NewGUID;
             DROP TABLE #GlobalTempTableColumns;

             -- Finally call product insert process if error not found in error log table 
             IF EXISTS
             (
                 SELECT TOP 1 1
                 FROM ZnodeImportLog
                 WHERE ImportProcessLogId = @ImportProcessLogId
                       AND Guid = @NewGUID
             )
                 BEGIN
                    --Updating the import process status
					UPDATE ZnodeImportProcessLog
					SET Status = CASE WHEN ISNULL(FailedRecordcount,0) > 0 AND ISNULL(SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
										WHEN ISNULL(FailedRecordcount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
										WHEN ISNULL(FailedRecordcount,0) > 0 AND ISNULL(FailedRecordcount,0) = ISNULL(TotalProcessedRecords,0) THEN dbo.Fn_GetImportStatus( 3 )
									END, 
						ProcessCompletedDate = getdate()
					WHERE ImportProcessLogId = @ImportProcessLogId;
                 END;
				 SET @SQLQuery = 'IF Object_id(''+@TableName+'') IS NOT NULL  DROP TABLE ' + @TableName
                 EXEC sys.sp_sqlexec @SQLQuery;

				 print 'end';
         END TRY
         BEGIN CATCH
			DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE()
			DECLARE @TempCount TABLE (Id INT)

			Declare @SQL Varchar(max) = 'Select Count(*) As Id From '+@TableName
			INSERT INTO @TempCount
			EXEC (@SQL)

             SELECT ERROR_MESSAGE(),
                    ERROR_LINE(),
                    ERROR_PROCEDURE();
             EXEC Znode_ImportReadErrorLog
                  @ImportProcessLogId = @ImportProcessLogId,
                  @NewGUID = @NewGUID; 
             
			 ---Import process updating fail due to database error
			UPDATE ZnodeImportProcessLog
			SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
			WHERE ImportProcessLogId = @ImportProcessLogId;

			---Loging error for Import process due to database error
		    INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		    SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

			--Updating total and fail record count
		    UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		    TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		    WHERE ImportProcessLogId = @ImportProcessLogId;

			SET @SQLQuery = 'Drop Table ' + @TableName
            EXEC sys.sp_sqlexec @SQLQuery;
             --ROLLBACK TRAN TRN_ImportValidProductData;
         END CATCH;
     END;

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'ZnodeParentCategoryIds' AND Object_ID = Object_ID(N'dbo.ZnodePublishProductEntity'))
BEGIN
	ALTER TABLE ZnodePublishProductEntity ADD [ZnodeParentCategoryIds] VARCHAR (1000)  NULL;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCategoryHierarchyParentIds')
	DROP PROC Znode_PublishCategoryHierarchyParentIds
GO

CREATE Procedure [dbo].[Znode_PublishCategoryHierarchyParentIds]
(@PimCatalogId int )
AS 
Begin
BEGIN TRY
		IF OBJECT_ID('tempdb..#PublishCategoryHierarchy') <> 0
			DROP TABLE #PublishCategoryHierarchy
		IF OBJECT_ID('tempdb..#ZnodePublishCategory') <> 0
			DROP TABLE #ZnodePublishCategory
		IF OBJECT_ID('tempdb..#PublishCategoryHierarchy') <> 0
			DROP TABLE #PublishCategoryHierarchy

		Create Table #PublishCategoryHierarchy (ZnodeCategoryId int ,ZnodeParentCategoryId Varchar(2000))
		Declare @TotalCategorycount int , @iCount int  =1,
		@PimCategoryId int ,@PublishCategoryId  int ,@PublishCatalogId INT

		SELECT @PublishCatalogId = PublishCatalogId FROM ZnodePublishCatalog AS ZPC WHERE ZPC.PimCatalogId = @PimCatalogId
		
		Select *, dense_Rank() Over (Order By PublishCategoryID) id  into #ZnodePublishCategory  from ZnodePublishCategory where PublishCatalogId =@PublishCatalogId
		Select @TotalCategorycount  = Max(id)  from #ZnodePublishCategory 
	
		while @iCount <=  @TotalCategorycount  
		Begin
			IF OBJECT_ID('tempdb..#ZnodePublishCategoryResult') <>0
			DROP TABLE #ZnodePublishCategoryResult
			--Select *From ZnodePimCategoryHierarchy
			Select @PimCategoryId = PimCategoryId , @PublishCategoryId = PublishCategoryId from #ZnodePublishCategory where id = @iCount
			;WITH CTE_ZnodePimCategoryHierarchy as 
			(
				SELECT PimCategoryHierarchyId,ParentPimCategoryHierarchyId,PimCategoryId,PimCatalogId
				FROM ZnodePimCategoryHierarchy 
				WHERE PimCatalogId=@PimCatalogId		)
			,Hierarchy AS
			(
			-- Anchor
			SELECT  A.PimCategoryHierarchyId,A.ParentPimCategoryHierarchyId,A.PimCategoryId,A.PimCatalogId 
			FROM CTE_ZnodePimCategoryHierarchy A
			WHERE A.ParentPimCategoryHierarchyId IS Not NULL AND  
			A.PimCategoryId =@PimCategoryId AND
			A.PimCatalogId=@PimCatalogId
			UNION ALL
			-- Recursive query
			SELECT  E.PimCategoryHierarchyId,E.ParentPimCategoryHierarchyId,E.PimCategoryId,E.PimCatalogId
			FROM CTE_ZnodePimCategoryHierarchy E
			JOIN Hierarchy H ON H.ParentPimCategoryHierarchyId = E.PimCategoryHierarchyId
			--WHERE  Exists(Select * From #SplitedCategoryHierarchy X Where E.PimCategoryId = X.PimCategoryId)
		)
		 Select @PublishCategoryId PublishCategoryId , B.PublishCategoryId PublishParentCategoryId into #ZnodePublishCategoryResult from Hierarchy A Inner join #ZnodePublishCategory  B on A.PimCategoryId = B.PimCategoryId
		 where B.PimCategoryId is not null 
		 if exists (Select TOP 1 1 from #ZnodePublishCategoryResult)
		 Begin
			insert into #PublishCategoryHierarchy  
			 Select A.PublishCategoryId, 
			 ISNULL(SUBSTRING((SELECT ','+CAST(PublishParentCategoryId AS VARCHAR(1000)) FROM #ZnodePublishCategoryResult AS ZPC 
			 where  A.PublishCategoryId =ZPC.PublishCategoryId
												  GROUP BY ZPC.PublishParentCategoryId FOR XML PATH('') ), 2, 4000), '') PublishParentCategoryId
												  from #ZnodePublishCategoryResult A  where  A.PublishCategoryId is not null 
												  Group by A.PublishCategoryId
		 End
		SET @iCount  = @iCount + 1 
		END
		--SELECT B.ZnodeCategoryIds, B.ZnodeParentCategoryIds, A.ZnodeParentCategoryId FROM #PublishCategoryHierarchy A INNER JOIN ZnodePublishProductEntity B ON 
		--A.ZnodeCategoryId = B.ZnodeCategoryIds WHERE B.ZnodeCatalogId =@PimCatalogId
		Update B Set B.ZnodeParentCategoryIds = A.ZnodeParentCategoryId from #PublishCategoryHierarchy A Inner join 
		ZnodePublishProductEntity B On A.ZnodeCategoryId = B.ZnodeCategoryIds 
		where B.ZnodeCatalogId = @PublishCatalogId

		UPDATE ZnodePublishProductEntity SET ZnodeParentCategoryIds = ZnodeCategoryIds WHERE ZnodeCatalogId = @PublishCatalogId
		AND  ZnodeParentCategoryIds IS NULL
		
END TRY   
BEGIN CATCH   
	
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	@ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCategoryHierarchyParentIds   
	@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))                   
   
                        
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_PublishCategoryHierarchyParentIds',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH

End

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity
GO

CREATE PROCEDURE [dbo].[Znode_PublishCatalogEntity]  
(  
	@PimCatalogId  INT = 0   
	,@RevisionState VARCHAR(50) = ''   
	,@UserId INT = 0  
	,@NewGUID NVARCHAR(500)   
	,@IsDraftProductsOnly BIT = 1  
)  
AS  
/*  
To publish all catalog product and their details  
Unit Testing :   
Exec [dbo].[Znode_PublishCatalogEntity]  
@PimCatalogId  = 3  
,@RevisionState = 'PRODUCTION'   
,@UserId = 2  
,@NewGUID = '123'  
   
EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,  
@NewGUID ='123'   
  
*/  
BEGIN  
BEGIN TRY   
	SET NOCOUNT ON  

	DECLARE @Status Bit =0 , @PublishCatalogId INT=0  
	IF (@PimCatalogId=0)  
	BEGIN  
	--SET @Status =0  
		SELECT 0 AS ID,@Status AS Status;  
		SET @PublishCatalogId=0  
		SELECT @PublishCatalogId;  
	END  
	ELSE  
	BEGIN  
   
		DECLARE @Type VARCHAR(50) = '', @CMSSEOCode VARCHAR(300);  
		SET @Status = 1   
		DECLARE @IsPreviewEnable INT  
		,@PreviewVersionId INT = 0    
		,@ProductionVersionId INT = 0  
		,@CatalogProfileId VARCHAR(1000)  
   
		IF OBJECT_ID('tempdb..#CatalogAttributeDetails') IS NOT NULL  
		DROP TABLE #CatalogAttributeDetails  
		CREATE TABLE [dbo].[#CatalogAttributeDetails]  
		(  
			[ZnodeCatalogId] [INT] NULL,  
			[AttributeCode] [NVARCHAR](300) NULL,  
			[AttributeTypeName] [VARCHAR](300) NULL,  
			[IsComparable] [bit] NOT NULL,  
			[IsHtmlTags] [bit] NOT NULL,  
			[IsFacets] [bit] NOT NULL,  
			[IsUseInSearch] [bit] NOT NULL,  
			[IsPersonalizable] [bit] NOT NULL,  
			[IsConfigurable] [bit] NOT NULL,  
			[AttributeName] [NVARCHAR](300) NULL,  
			[LocaleId] [INT] NULL,  
			[DisplayOrder] [INT] NULL,  
			[DefaultValueDisplayOrder] [INT] NULL,  
			[AttributeDefaultValue] [NVARCHAR](max) NULL  
		) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY] 
		
		DECLARE @CatalogName VARCHAR(100),@UserName VARCHAR(50)  
		SET @PublishCatalogId = ISNULL((SELECT TOP 1 PublishCatalogId FROM ZnodePublishCatalog ZPC WHERE ZPC.PimCatalogId = @PimCatalogId), 0)  
    
	SELECT TOP 1  @UserName = UserName 
	FROM ZnodeUser 
	WHERE ZnodeUser.UserId = @userId  
  
	SELECT @CatalogName = CatalogName FROM ZnodePimCatalog WHERE PimCatalogId = @PimCatalogId
	
	DELETE FROM ZnodePublishProgressNotifierEntity WHERE JOBName =@CatalogName   

	INSERT INTO ZnodePublishProgressNotifierEntity  
	(VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriENDlyName)  
	VALUES(0,@NewGUID , Isnull(@CatalogName,'') + ' Catalog ', 0 , 0 , 0 , '' , @UserId, @UserName )  
  
	IF EXISTS (SELECT  * FROM ZnodePublishStateApplicationTypeMapping PSA WHERE PSA.IsEnabled =1 AND    
	EXISTS (SELECT TOP 1 1  FROM ZnodePublishState PS WHERE PS.PublishStateId = PSA.PublishStateId ) AND ApplicationType =  'WebstorePreview')  
		SET @IsPreviewEnable = 1   
	ELSE   
		SET @IsPreviewEnable = 0   
  
	--Genrate preview entry   
	DECLARE @SetLocaleId INT , @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleId(), @MaxCount INT =0 , @IncrementalId INT = 1    
	DECLARE @TBL_Locale TABLE (LocaleId INT , RowId INT IDENTITY(1,1))  
    
	IF OBJECT_ID('tempdb..[#Tbl_NewVersionEntity]') IS NOT NULL  
		DROP TABLE tempdb..#Tbl_NewVersionEntity  
	
	CREATE TABLE #Tbl_NewVersionEntity(PublishCatalogId INT , VersionId INT , LocaleId INT , PublishType VARCHAR(50) )  
  
	--IF OBJECT_ID('tempdb..[#Tbl_OldVersionEntity]') IS NOT NULL  
	--	DROP TABLE tempdb..#Tbl_OldVersionEntity  
	
	--CREATE TABLE #Tbl_OldVersionEntity(PublishCatalogId INT , NewVersionId INT ,OldVersionId INT , LocaleId INT , PublishType VARCHAR(50) )  
    
    
	IF @PublishCatalogId > 0   
    BEGIN
		UPDATE ZPC SET CatalogName = ZC.CatalogName,ExternalId = ZC.ExternalId,PimCatalogId= @PimCatalogId,CreatedBy = @UserId,  
		CreatedDate = Getdate(),ModifiedBy = @UserId,ModifiedDate = Getdate()  
		FROM ZnodePublishCatalog ZPC   
		INNER JOIN ZnodePimCatalog ZC ON(ZC.PimCatalogId = ZPC.PimCatalogId)  
		WHERE ZPC.PimCatalogId = @PimCatalogId;  
	END
	ELSE  
	BEGIN  
		INSERT INTO ZnodePublishCatalog (PimCatalogId,CatalogName,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)  
		SELECT PimCatalogId,CatalogName,ExternalId,@UserId,Getdate(),@UserId,Getdate() FROM ZnodePimCatalog AS ZPC   
		WHERE ZPC.PimCatalogId = @PimCatalogId;  
                        
		SET @PublishCatalogId = SCOPE_IDENTITY();  
	END  
  
	--Getting active local for catalog which are associated to store
	INSERT INTO @TBL_Locale (LocaleId) 
	SELECT LocaleId FROM DBO.FN_GetCatalogPortalActiveLocale(@PublishCatalogId)
  
	SET @MaxCount = ISNULL((SELECT MAx(RowId) FROM @TBL_Locale),0)  

	WHILE @IncrementalId <= @MaxCount  
	BEGIN   
		SET @SetLocaleId = (SELECT Top 1 LocaleId FROM @TBL_locale WHERE RowId = @IncrementalId)  

		IF @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  )    
		BEGIN  
			
			INSERT INTO ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId)  
			SELECT @PublishCatalogId,  @PimCatalogId,NULL,0,  
			NULL,0,  
			NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(), null ,@SetLocaleId ,DBO.Fn_GetPublishStateIdForProcessing()   
  
			INSERT INTO #Tbl_NewVersionEntity (PublishCatalogId,VersionId,LocaleId,PublishType)  
			SELECT @PublishCatalogId, @@Identity , @SetLocaleId ,'PREVIEW'  
      
		END  

		IF (@RevisionState like '%Production%' OR @RevisionState = 'None')  
		BEGIN  
			UPDATE B
            SET IsPublishSuccess = 0
            FROM ZnodePublishVersionEntity B
            WHERE EXISTS(SELECT * FROM #Tbl_NewVersionEntity A WHERE A.PublishCatalogId = B.ZnodeCatalogId 
                AND A.PublishType = 'PRODUCTION' AND A.LocaleId = B.LocaleId) 
            AND B.RevisionType = 'PRODUCTION'

			--Genrate production entry   
			INSERT INTO ZnodePublishCatalogLog  
			(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId)  
			SELECT @PublishCatalogId,  @PimCatalogId,NULL,0,  
			NULL,0,  
			NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(), null ,@SetLocaleId ,DBO.Fn_GetPublishStateIdForProcessing()   
     
			INSERT INTO #Tbl_NewVersionEntity (PublishCatalogId,VersionId,LocaleId,PublishType)  
			SELECT @PublishCatalogId, @@Identity , @SetLocaleId ,'PRODUCTION'  
		END   
			SET @IncrementalId = @IncrementalId +1   
	END  
	
	DECLARE  @VersionIdString VARCHAR(2000)= ''    
     
	TRUNCATE TABLE ZnodePublishCatalogErrorLogEntity  

	UPDATE ZnodePublishProgressNotifierEntity SET   
	ProgressMark =5,   
	IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
	IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
	WHERE  JobId = @NewGUID  
   
	--EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = @PublishCatalogId,@UserId = @UserId , @IsRevertPublish = 0 ,  
	--@NewGUID =@NewGUID   
  
	IF @Type = 'ZnodePublishCatalogEntity' OR @Type = ''  
	BEGIN  
   
		INSERT INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing)  
		SELECT Distinct VE.VersionId, ZPC.PublishCatalogId, PC.CatalogName,VE.PublishType, VE.LocaleId, isnull(PC.IsAllowIndexing,0)  
		FROM ZnodePublishCatalog ZPC  
		INNER JOIN  #Tbl_NewVersionEntity VE ON (VE.PublishCatalogId = ZPC.PublishCatalogId)  
		INNER JOIN ZnodePimCatalog PC on ZPC.PimCatalogId = PC.PimCatalogId  
		-- Data inserted INTo flat table ZnodeWebStoreEntity (Replica of MongoDB Collection )    
    
		IF @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  )   
		BEGIN  
			UPDATE B
            SET IsPublishSuccess = 0
            FROM ZnodePublishVersionEntity B
            WHERE EXISTS(SELECT * FROM #Tbl_NewVersionEntity A WHERE A.PublishCatalogId = B.ZnodeCatalogId 
                AND A.PublishType = 'PREVIEW' AND A.LocaleId = B.LocaleId) 
            AND B.RevisionType = 'PREVIEW'

			INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
			SELECT VersionId,PublishCatalogId,PublishType,LocaleId,0 FROM  #Tbl_NewVersionEntity A
			WHERE A.PublishType = 'PREVIEW'  
			AND NOT EXISTS(SELECT * FROM ZnodePublishVersionEntity B WHERE A.PublishCatalogId = B.ZnodeCatalogId 
			AND B.RevisionType = 'PREVIEW' AND A.LocaleId = B.LocaleId )
		END  

		IF (@RevisionState like '%Production%' OR @RevisionState = 'None')  
		BEGIN  
			UPDATE B
            SET IsPublishSuccess = 0
            FROM ZnodePublishVersionEntity B
            WHERE EXISTS(SELECT * FROM #Tbl_NewVersionEntity A WHERE A.PublishCatalogId = B.ZnodeCatalogId 
                AND A.PublishType = 'PRODUCTION' AND A.LocaleId = B.LocaleId) 
            AND B.RevisionType = 'PRODUCTION'

			INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
			SELECT VersionId,PublishCatalogId,PublishType,LocaleId,0 FROM  #Tbl_NewVersionEntity A
			WHERE PublishType = 'PRODUCTION'  
			AND NOT EXISTS(SELECT * FROM ZnodePublishVersionEntity B WHERE A.PublishCatalogId = B.ZnodeCatalogId 
			AND B.RevisionType = 'PRODUCTION' AND A.LocaleId = B.LocaleId )
		END  
  
		INSERT INTO ZnodePublishCatalogErrorLogEntity  
		(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishCatalogEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
	END  
  
    IF @RevisionState = 'Preview'
	BEGIN
		SELECT @VersionIdString = STUFF((SELECT ',' + cast (VersionId as VARCHAR(50))  
		FROM ZnodePublishVersionEntity WHERE RevisionType = 'Preview' AND ZnodeCatalogId = @PublishCatalogId FOR XML PATH ('')), 1, 1, '')   
	END
	ELSE
	BEGIN
		SELECT @VersionIdString = STUFF((SELECT ',' + cast (VersionId as VARCHAR(50))  
		FROM ZnodePublishVersionEntity WHERE ZnodeCatalogId = @PublishCatalogId FOR XML PATH ('')), 1, 1, '') 
	END


	IF @Type = 'ZnodePublishCategoryEntity' OR @Type = ''  
	BEGIN  
		EXEC [Znode_GetPublishCategoryJson]  
		@PublishCatalogId = @PublishCatalogId ,  
		@UserId =@UserId,                 
		@VersionIdString = @VersionIdString,  
		@Status  =@Status Out,  
		@RevisionState = @RevisionState   
   
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishCategoryEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
     
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =30,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
  
		IF @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END   
   
	IF @Type = 'ZnodePublishProductEntity' OR @Type = ''  
	BEGIN  
		-- Process call catalog publish (include category, products with multiple types)  
		DECLARE @PimProductId TransferId   
		EXEC [Znode_PublishLatestAssociatedProduct] @PublishCatalogId = @PublishCatalogId, @PimProductId = @PimProductId  , @UserId = @UserId , @PublishStateId =0   
		EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId= @PublishCatalogId ,@userid =@userid ,@PimProductId = @PimProductId   
		EXEC Znode_GetPublishProductJson   
		@PublishCatalogId =@PublishCatalogId   
		,@PimProductId = @PimProductId   
		,@UserId = @userid  
		,@PimCatalogId = @PimCatalogId   
		,@VersionIdString = @VersionIdString  
		,@Status  =@Status  Out  
		,@RevisionState = @RevisionState   
		,@IsDraftProductsOnly = @IsDraftProductsOnly  
   
		EXECUTE [Znode_PublishCategoryHierarchyParentIds] @PimCatalogId = @PimCatalogId
    
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishProductEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =50,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
		If @Status  = 1  
		BEGIN  
			UPDATE ZPCE SET ZPCE.ProductIds =   
			'[' +SUBSTRING((SELECT ','+CAST(PublishProductId AS VARCHAR(50))  
			FROM ZnodePublishCategoryProduct ZPCP   
			WHERE ZPCP.PublishCategoryId = ZPCE.ZnodeCategoryId  
			AND ZPCP.PublishCatalogId = ZPCE.ZnodeCatalogId  FOR XML PATH('')), 2, 8000) + ']'   
			FROM ZnodePublishCategoryEntity  ZPCE WHERE ZPCE.ProductIds is null   
		END  
  
  
		If @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END  

	IF @Type = 'ZnodePublishAddOnEntity' OR @Type = ''  
	BEGIN  
		Exec [Znode_GetPublishAssociatedAddonsJson]  
		@PublishCatalogId = @PublishCatalogId ,  
		@PimProductId   = @PimProductId ,  
		@UserId =@UserId,                 
		@VersionIdString = @VersionIdString,  
		@RevisionType='',  
		@Status  =@Status Out  
  
    
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishAddOnEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =52,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
     
		If @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END   
   
	If @Type = 'BundleAssociatedProducts' OR @Type = ''  
	BEGIN  
		Exec [Znode_GetPublishAssociatedProductsJson]  
		@PublishCatalogId = @PublishCatalogId ,  
		@UserId =@UserId,                 
		@VersionIdString = @VersionIdString,  
		@RevisionType = '',  
		@Status  =@Status Out,  
		@ProductType    = 'BundleProduct'  
    
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'BundleAssociatedProducts', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =54,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
     
		If @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END   

	IF @Type = 'GroupedAssociatedProducts' OR @Type = ''  
	BEGIN  
		Exec [Znode_GetPublishAssociatedProductsJson]  
		@PublishCatalogId = @PublishCatalogId ,  
		@UserId =@UserId,                 
		@VersionIdString = @VersionIdString,  
		@RevisionType = '',  
		@Status  =@Status Out,  
		@ProductType    = 'GroupedProduct'  

		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'GroupedAssociatedProducts', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
     
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =56,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  

		IF @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END   

	IF @Type = 'ConfigurableAssociatedProducts' OR @Type = ''  
	BEGIN  
		Exec [Znode_GetPublishAssociatedProductsJson]  
		@PublishCatalogId = @PublishCatalogId ,  
		@UserId =@UserId,                 
		@VersionIdString = @VersionIdString,  
		@RevisionType = '',  
		@Status  =@Status Out,  
		@ProductType= 'ConfigurableProduct'  
  
      
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ConfigurableAssociatedProducts', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =58,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
     
		IF @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END   

	IF @Type = 'CatalogAttributeaDetail' OR @Type = ''  
	BEGIN  
	BEGIN TRY  
		INSERT INTO [dbo].[#CatalogAttributeDetails]([ZnodeCatalogId],[AttributeCode],[AttributeTypeName],[IsComparable],  
		[IsHtmlTags],[IsFacets],[IsUseInSearch],[IsPersonalizable],[IsConfigurable],[AttributeName],  
		[LocaleId],[DisplayOrder],[DefaultValueDisplayOrder],[AttributeDefaultValue] )  
		EXEC Znode_GetPublishProductAttribute @PublishCatalogId   
     
		INSERT INTO ZnodePublishCatalogAttributeEntity  
		(VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition,IsComparable,  
		IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,  
		AttributeName,LocaleId,DisplayOrder,SELECTValues)  
		SELECT Distinct   
		B.VersionId, A.[ZnodeCatalogId],A.[AttributeCode],A.[AttributeTypeName],0 IsPromoRuleCondition,[IsComparable],  
		[IsHtmlTags],[IsFacets],[IsUseInSearch],[IsPersonalizable],[IsConfigurable],  
		[AttributeName],A.[LocaleId],[DisplayOrder] ,  
		(SELECT Isnull(IA.AttributeDefaultValue,'') Value , Isnull(IA.[DefaultValueDisplayOrder],'') DisplayOrder    
		from [dbo].[#CatalogAttributeDetails] IA  WHERE IA.AttributeCode = A.AttributeCode AND IA.LocaleId = A.LocaleId   
		For JSON PATH)  
		FROM [dbo].[#CatalogAttributeDetails] A INNER JOIN #Tbl_NewVersionEntity B on A.LocaleId = B.LocaleId  
   
		SET @Status =1   
    
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'CatalogAttributeaDetail', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =60,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
     
  
	END TRY   
	BEGIN CATCH   
		SET @Status   = 0   
     
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'CatalogAttributeaDetail', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		IF @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END CATCH    
	END   
  
	IF @Type = 'ZnodePublishSEOEntity' OR @Type = ''  
	BEGIN  
		EXEC [Znode_SetPublishSEOEntity]  
		@RevisionState = @RevisionState   
		,@CMSSEOTypeId  = '1,2'   
		,@UserId  = @UserId   
		,@Status  = @Status  OUTPUT   
		,@IsCatalogPublish = 1    
		,@VersionIdString  = @VersionIdString   
		,@IsPreviewEnable  = @IsPreviewEnable   
     
   
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishSEOEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =70,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
  
		If @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
  
	END   
  
	IF EXISTS (SELECT TOP 1 1  FROM ZnodePublishCatalogErrorLogEntity WHERE  ProcessStatus = 'Fail')   
	BEGIN  
    
		SET @Status  =0   
		SELECT 1 AS ID,@Status AS Status;  
		INSERT INTO ZnodePublishCatalogErrorLogEntity  
		(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishPortalEntity', @RevisionState , 'Fail' , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
     
		--EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = @PublishCatalogId,@UserId = @UserId , @IsRevertPublish = 0 ,  
		--@NewGUID =@NewGUID   
  
		UPDATE ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed(),  
		IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0, ModifiedDate = Getdate()  
		WHERE PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()
		
		UPDATE ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed(),  
		IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0  
		, ModifiedDate = Getdate()  
		WHERE PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()
		Return 0   
	END  
  
	SET @Status = 1  
  
    
	SELECT @PublishCatalogId AS id,@Status AS Status;     
END  
END TRY   
BEGIN CATCH   
	SET @Status =0    
	SELECT 1 AS ID,@Status AS Status;     
   
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	@ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity   
	@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))  
	+',@PreviewVersionId = ' + CAST(@PreviewVersionId  AS VARCHAR(20))  
	+',@ProductionVersionId = ' + CAST(@ProductionVersionId  AS VARCHAR(20))  
	+',@RevisionState = ''' + CAST(@RevisionState  AS VARCHAR(50))  
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20)); SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
   
     
	INSERT INTO ZnodePublishCatalogErrorLogEntity  
	(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
	SELECT 'Znode_PublishCatalogEntity', @RevisionState + isnull(@ErrorMessage,'') , 'Fail' , Getdate(),   
	@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
   
	EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = @PublishCatalogId,@UserId = @UserId , @IsRevertPublish = 0 ,  
	@NewGUID =@NewGUID   
  
	UPDATE ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed(),  
	IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0 , ModifiedDate = Getdate()   WHERE  PublishCatalogLogId in   
	(SELECT VersionId FROM #Tbl_NewVersionEntity WHERE PublishType = 'PREVIEW' )  
	UPDATE ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed() ,  
	IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0 , ModifiedDate = Getdate() WHERE  PublishCatalogLogId in  
	(SELECT VersionId FROM #Tbl_NewVersionEntity WHERE PublishType = 'PRODUCTION' )  
                        
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_PublishCatalogEntity',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
END

GO

insert into ZnodePortalFeature(PortalFeatureName,	CreatedBy,	CreatedDate	,ModifiedBy,	ModifiedDate)
select 'Enable_Product_Inheritance',	2,	getdate(),	2	,getdate()
where not exists(select * from ZnodePortalFeature where PortalFeatureName = 'Enable_Product_Inheritance')

GO

INSERT INTO Znodeproductfeedtype (ProductFeedTypeCode,ProductFeedTypeName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 'Shoppingfeed','XML Product Feed',2,GETDATE(),2,GETDATE()  
where not exists(select * from Znodeproductfeedtype where ProductFeedTypeCode ='Shoppingfeed')

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCatalogCategoryHierarchyAssociation')
	DROP PROC Znode_ImportCatalogCategoryHierarchyAssociation
GO

CREATE PROCEDURE [dbo].[Znode_ImportCatalogCategoryHierarchyAssociation]
(
	@TableName NVARCHAR(100), 
	@Status BIT OUT, 
	@UserId INT, 
	@ImportProcessLogId INT, 
	@NewGUId NVARCHAR(200),
	@PimCatalogId INT
)
AS
BEGIN 
BEGIN TRAN A;
BEGIN TRY
SET NOCOUNT ON;

	DECLARE @GetDate datetime= dbo.Fn_GetDate()
	DECLARE @SSQL VARCHAR(1000)

	IF OBJECT_ID('tempdb..#Category') IS NOT NULL
		DROP TABLE #Category;

	Declare @FeatureValue VARCHAR(500)
	--If the CatalogCategoryHierarchyAssociationAutoCreate value is true, 1 or Yes then input parent code hierarchy will be generate thogh the import
	--If the CatalogCategoryHierarchyAssociationAutoCreate value is false, 0 or No then input parent code hierarchy is not present in the database then it will give an error log
	SELECT TOP 1 @FeatureValue = FeatureValues FROM ZnodeGlobalSetting WHERE FeatureName = 'CatalogCategoryHierarchyAssociationAutoCreate'

	--Getting existing categories
	SELECT A.PimCategoryId,B.CategoryValue CategoryCode 
	INTO #Category 
	FROM ZnodePimCategoryAttributeValue A 
	INNER JOIN ZnodePimCategoryAttributeValueLocale B ON A.PimCategoryAttributeValueId = b.PimCategoryAttributeValueId 
	WHERE EXISTS(SELECT TOP 1 1 FROM ZnodePimAttribute X WHERE X.IsCategory =1 and X.AttributeCode = 'CategoryCode' and A.PimAttributeId = X.PimAttributeId )

	IF OBJECT_ID('tempdb..#HierarchyImportData') IS NOT NULL
		DROP TABLE #HierarchyImportData;

	CREATE TABLE #HierarchyImportData (RowNumber INT,ParentCode NVARCHAR(MAX),CategoryCode NVARCHAR(MAX), DisplayOrder VARCHAR(10),Action VARCHAR(100),GUID VARCHAR(100));

	SET @SSQL = 'Select RowNumber,ParentCode, CategoryCode, DisplayOrder, Action ,GUID FROM '+@TableName;
	INSERT INTO #HierarchyImportData( RowNumber,ParentCode, CategoryCode, DisplayOrder,Action ,GUID)
	EXEC sys.sp_sqlexec @SSQL;

	IF OBJECT_ID('tempdb..#SplitedCategoryHierarchy') IS NOT NULL
		DROP TABLE #SplitedCategoryHierarchy

	--Created table for category hierarchy split
	CREATE TABLE #SplitedCategoryHierarchy (PimCategoryHierarchyId INT, ParentPimCategoryHierarchyId INT
	,PimCatalogId INT, PimCategoryId INT,RowNumber INT ,PimCategoryCode VARCHAR(300),RowId INT,Action varchar(100),DisplayOrder VARCHAR(10), ParentCategoryId INT)

	DECLARE @RecordCount INT=(SELECT COUNT(1) FROM #HierarchyImportData) , @Cnt INT = 1 ,@FirstCategoryId  INT 
	WHILE @Cnt <= @RecordCount  
	BEGIN
		SET @FirstCategoryId = 0 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '122', 'ParentCode / CategoryCode', '', @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNULL(ParentCode,'') = '' AND ISNULL(CategoryCode,'') = '' AND ii.RowNumber  = @Cnt 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'CategoryCode', CategoryCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNULL(CategoryCode,'') = '' AND ii.RowNumber  = @Cnt 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '102', 'CategoryCode', CategoryCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ltrim(rtrim(isnull(ii.CategoryCode,''))) like '% %' AND ii.RowNumber  = @Cnt 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '115', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ii.DisplayOrder > 999 AND ISNULL(ii.DisplayOrder,'') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '115', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNUMERIC(ii.DisplayOrder)=0 AND ISNULL(ii.DisplayOrder,'') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '125', 'Action', Action, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE isnull(Action,'') NOT IN ('ADD','DELETE')
		
		IF OBJECT_ID('tempdb..#ExistingHierarchy') IS NOT NULL
			DROP TABLE #ExistingHierarchy;
	
		TRUNCATE TABLE #SplitedCategoryHierarchy

		--Splitting category hierarchy and inserted into temp table #SplitedCategoryHierarchy
		INSERT INTO #SplitedCategoryHierarchy (PimCatalogId , PimCategoryCode ,RowNumber,RowId,Action,DisplayOrder)
		SELECT @PimCatalogId, LTRIM(RTRIM(B.item)) as PimCategoyHierarchyCode , Id, RowNumber, Action, CASE WHEN ISNULL(DisplayOrder,'') = '' THEN 0 ELSE DisplayOrder END
		FROM #HierarchyImportData A 
		CROSS APPLY  dbo.split(isnull(A.ParentCode,'')+CASE WHEN isnull(A.ParentCode,'') = '' THEN '' ELSE '/' END+A.CategoryCode,'/') B 
		Where A.RowNumber  = @Cnt  

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '127', 'ParentCode / CategoryCode', PimCategoryCode, @NewGUId, RowId, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #SplitedCategoryHierarchy AS ii
		WHERE NOT EXISTS(SELECT * FROM #Category C WHERE ii.PimCategoryCode = c.CategoryCode)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '123', 'ParentCode / CategoryCode', PimCategoryCode, @NewGUId, RowId, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #SplitedCategoryHierarchy AS ii
		GROUP BY PimCategoryCode ,RowId
		HAVING COUNT(*) > 1

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '124', 'ParentCode', ParentCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNULL(replace(ii.ParentCode,' ',''),'') like '%//%'
		
		--Deleting the records which was invalid and added into error log
		DELETE FROM #SplitedCategoryHierarchy WHERE RowId IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )
		DELETE FROM #HierarchyImportData WHERE RowNumber IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )

		IF OBJECT_ID('tempdb..#CategoryCodeCheck') IS NOT NULL
			DROP TABLE #CategoryCodeCheck;

		IF EXISTS(SELECT * FROM #SplitedCategoryHierarchy)
		BEGIN
			Update A SET A.PimCategoryId = D.PimCategoryId FROM #SplitedCategoryHierarchy A INNER JOIN #Category D ON A.PimCategoryCode = D.CategoryCode

			Select TOP 1 @FirstCategoryId = X.PimCategoryId FROM #SplitedCategoryHierarchy X
	
			--Getting existing category hierarchy
			;WITH CTE_ZnodePimCategoryHierarchy as 
			(
				SELECT PimCategoryHierarchyId,ParentPimCategoryHierarchyId,PimCategoryId,PimCatalogId
				FROM ZnodePimCategoryHierarchy 
				WHERE PimCatalogId = @PimCatalogId 
			)
			,Hierarchy AS
			(
				-- Anchor
				SELECT  A.PimCategoryHierarchyId,A.ParentPimCategoryHierarchyId,A.PimCategoryId,A.PimCatalogId --, dense_rank() over(order by a.ParentPimCategoryHierarchyId) as RowNumber
				FROM CTE_ZnodePimCategoryHierarchy A
				WHERE A.ParentPimCategoryHierarchyId IS NULL AND  
				A.PimCategoryId =@FirstCategoryId 	AND A.PimCatalogId = @PimCatalogId
				UNION ALL
				-- Recursive query
				SELECT  E.PimCategoryHierarchyId,E.ParentPimCategoryHierarchyId,E.PimCategoryId,E.PimCatalogId--, ROW_NUMBER() over(order by E.ParentPimCategoryHierarchyId,E.PimCategoryHierarchyId) as RowNumber
				FROM CTE_ZnodePimCategoryHierarchy E
				JOIN Hierarchy H ON E.ParentPimCategoryHierarchyId = H.PimCategoryHierarchyId
				WHERE  Exists(Select * FROM #SplitedCategoryHierarchy X WHERE E.PimCategoryId = X.PimCategoryId)
			)
			SELECT * INTO #ExistingHierarchy FROM Hierarchy --Where RowNumber  = @Cnt  --
			--order by PimCategoryHierarchyId

			--Adding required columns into temp table
			Alter table #ExistingHierarchy Add Id INT Identity(1,1), RowNumber INT, ParentCategoryId INT

			--Updating the row number for parent category
			UPDATE #ExistingHierarchy SET RowNumber = 1 WHERE ParentPimCategoryHierarchyId IS NULL

			DECLARE @RecordCount1 INT=(SELECT COUNT(1) FROM #ExistingHierarchy) , @Cnt1 INT = 1 --,@FirstCategoryId1  INT 
			DECLARE @ParentPimCategoryHierarchyId1 INT , @RowNumber INT

			--Updating the row number according to category hierarhcy level
			WHILE @Cnt1 <= @RecordCount1  
			BEGIN
				
				SELECT @ParentPimCategoryHierarchyId1 = PimCategoryHierarchyId FROM #ExistingHierarchy WHERE Id = @Cnt1
				SET @RowNumber = (SELECT TOP 1 RowNumber FROM #ExistingHierarchy WHERE PimCategoryHierarchyId = @ParentPimCategoryHierarchyId1) 

				UPDATE #ExistingHierarchy SET RowNumber = @RowNumber + 1
				WHERE ParentPimCategoryHierarchyId = @ParentPimCategoryHierarchyId1
				
				SET @ParentPimCategoryHierarchyId1 = 0
				SET @RowNumber = 0
				SET @Cnt1 = @Cnt1+1
			END

			--Updating the parent category on existing category hierarchy
			UPDATE b SET ParentCategoryId = a.PimCategoryId
			from #ExistingHierarchy a
			inner join #ExistingHierarchy b on b.ParentPimCategoryHierarchyId = a.PimCategoryHierarchyId
			
			--Updating the parent category on input record
			UPDATE  A SET A.ParentCategoryId = B.PimCategoryId
			FROM #SplitedCategoryHierarchy A  
			INNER JOIN #SplitedCategoryHierarchy B ON B.RowNumber = A.RowNumber-1
						
			--Existing Hierarchy has been updated on the input categories
			Update B SET B.PimCategoryHierarchyId= A.PimCategoryHierarchyId, 
			B.ParentPimCategoryHierarchyId = A.ParentPimCategoryHierarchyId
			FROM #ExistingHierarchy  A INNER JOIN #SplitedCategoryHierarchy B ON ISNULL(A.PimCategoryId,0) = ISNULL(B.PimCategoryId,0) AND ISNULL(A.ParentCategoryId,0) = ISNULL(B.ParentCategoryId,0) and A.RowNumber = B.RowNumber 

			--Removing hierarchy ids of categoris if its parent dont have any hierarchy for input	
			UPDATE CH SET PimCategoryHierarchyId = NULL ,ParentPimCategoryHierarchyId = NULL
			FROM #SplitedCategoryHierarchy CH
			WHERE CH.PimCategoryHierarchyId IS NOT NULL AND EXISTS(SELECT * FROM #SplitedCategoryHierarchy CH1 WHERE CH1.PimCategoryHierarchyId IS NULL AND CH.RowNumber-1 = CH1.RowNumber)

			--Removing hierarchy ids of categories if its parent doesent present in the input hierarchy
			UPDATE A SET PimCategoryHierarchyId = NULL ,ParentPimCategoryHierarchyId = NULL 
			FROM #SplitedCategoryHierarchy A 
			WHERE NOT EXISTS(SELECT * FROM #SplitedCategoryHierarchy X WHERE X.PimCategoryHierarchyId = A.ParentPimCategoryHierarchyId)
			AND A.ParentPimCategoryHierarchyId IS NOT NULL 
			
			IF isnull(@FeatureValue,'') IN ('False','0','No','')
			BEGIN
				--If root level category is not present
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '126', 'ParentCode', ParentCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #HierarchyImportData h
				WHERE RowNumber IN (
					SELECT RowId FROM #SplitedCategoryHierarchy a
					WHERE NOT EXISTS(SELECT * FROM #HierarchyImportData b WHERE A.PimCategoryCode = b.CategoryCode AND a.RowId = b.RowNumber)
					AND A.ParentCategoryId IS NULL AND A.PimCategoryHierarchyId IS NULL)
				
				--If child level category is not present
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '126', 'ParentCode', ParentCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #HierarchyImportData H
				WHERE RowNumber IN (
					SELECT RowId FROM #SplitedCategoryHierarchy a
					WHERE NOT EXISTS(SELECT * FROM #HierarchyImportData b WHERE A.PimCategoryCode = b.CategoryCode AND a.RowId = b.RowNumber)
					AND A.ParentCategoryId IS NOT NULL AND A.ParentPimCategoryHierarchyId IS NULL)
				AND NOT EXISTS(SELECT * FROM ZnodeImportLog X WHERE H.RowNumber = X.RowNumber)
				
				--Deleting the records which was invalid and added into error log
				DELETE FROM #SplitedCategoryHierarchy WHERE RowId IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )
				DELETE FROM #HierarchyImportData WHERE RowNumber IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )
			END

			--Adding new hierarchy into ZnodePimCategoryHierarchy if input having Add action
			IF EXISTS(SELECT * FROM #SplitedCategoryHierarchy WHERE Action = 'Add')
			BEGIN
				
				DROP TABLE IF EXISTS #InsertedPimCategoryHierarchy

				CREATE TABLE #InsertedPimCategoryHierarchy (PimCategoryHierarchyId INT, PimCategoryId INT);

				--Inserting new category hierarchy if not present
				INSERT INTO ZnodePimCategoryHierarchy (PimCatalogId,ParentPimCategoryHierarchyId,PimCategoryId,DisplayOrder,IsActive,
					ActivationDate,ExpirationDate,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PimParentCategoryId)
				OUTPUT inserted.PimCategoryHierarchyId,inserted.PimCategoryId
				INTO #InsertedPimCategoryHierarchy (PimCategoryHierarchyId, PimCategoryId)
				Select PimCatalogId,ParentPimCategoryHierarchyId,PimCategoryId,DisplayOrder,1,NULL,NULL,2,GETDATE(),2,GETDATE(),NULL
				FROM #SplitedCategoryHierarchy WHERE PimCategoryHierarchyId is null 

				-- Newly created Hierarchy has been updated into input category hierarchy
				UPDATE A 
				SET A.PimCategoryHierarchyId=B.PimCategoryHierarchyId
				FROM #SplitedCategoryHierarchy A INNER JOIN #InsertedPimCategoryHierarchy B
					ON A.PimCategoryId=B.PimCategoryId
				WHERE A.PimCategoryHierarchyId IS NULL

				-- Updating new parent hierarchy has been updated into input category hierarchy
				UPDATE A SET A.ParentPimCategoryHierarchyId =(Select PimCategoryHierarchyId FROM #SplitedCategoryHierarchy X WHERE X.RowNumber = A.RowNumber -1 )
				FROM #SplitedCategoryHierarchy A 
		
				-- Updating new parent hierarchy has been updated newly added input category hierarchy into table ZnodePimCategoryHierarchy
				UPDATE ZnodePimCategoryHierarchy SET ParentPimCategoryHierarchyId = A.ParentPimCategoryHierarchyId
				FROM #SplitedCategoryHierarchy A WHERE ZnodePimCategoryHierarchy.PimCategoryHierarchyId = A.PimCategoryHierarchyId
				AND EXISTS(SELECT * FROM #InsertedPimCategoryHierarchy B WHERE A.PimCategoryHierarchyId = B.PimCategoryHierarchyId)
			END
			ELSE
			BEGIN
				--Delete the category hierarchy and its child category 
				DECLARE @PimCategoryHierarchyId INT
				SET @PimCategoryHierarchyId = (SELECT TOP 1 PimCategoryHierarchyId FROM #SplitedCategoryHierarchy ORDER BY RowNumber DESC)
				EXECUTE [Znode_DeletePimCategoryHierarchy] @PimCategoryHierarchyId = @PimCategoryHierarchyId, @PimCatalogId = @PimCatalogId, @Status = 0
			END
		END

		SET @Cnt = @Cnt + 1 
	END

	DECLARE @FailedRecordCount BIGINT
	DECLARE @SuccessRecordCount BIGINT

	SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
	SELECT @SuccessRecordCount = COUNT(DISTINCT RowNumber) FROM #HierarchyImportData

	--Updating the import process status
	UPDATE ZnodeImportProcessLog
	SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
						WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
						WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
					END, 
		ProcessCompletedDate = getdate()
	WHERE ImportProcessLogId = @ImportProcessLogId;

	UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
	WHERE ImportProcessLogId = @ImportProcessLogId;

COMMIT TRAN A;
END TRY
BEGIN CATCH
ROLLBACK TRAN A;

	SET @Status = 0;
	SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

	DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCatalogCategoryHierarchyAssociation @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(200));


	---Import process updating fail due to database error
	UPDATE ZnodeImportProcessLog
	SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
	WHERE ImportProcessLogId = @ImportProcessLogId;

	---Loging error for Import process due to database error
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

	--Updating total and fail record count
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
	TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
	WHERE ImportProcessLogId = @ImportProcessLogId;

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_ImportCatalogCategoryHierarchyAssociation',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
		
		
END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportData')
	DROP PROC Znode_ImportData
GO



CREATE PROCEDURE [dbo].[Znode_ImportData](
	  @TableName varchar(200), @NewGUID nvarchar(max), @TemplateId nvarchar(200), @UserId int, @LocaleId int= 1, @DefaultFamilyId int= 0, @IsDebug bit= 0, @PriceListId int= 0,@CountryCode Nvarchar(100) = '',@PortalId int = 0 ,
	  @IsDoNotCreateJob bit = 0 , @IsDoNotStartJob bit = 0, @StepName nvarchar(50) = 'Import' , @StartStepName nvarchar(50) = 'Import' ,
	  @step_id int  = 1 ,@Nextstep_id  int = 1 , @ERPTaskSchedulerId int = 0, @IsAccountAddress bit = 0,@IsAutoPublish Bit = 0  ,@ImportProcessLogId  int = 0,@PimCatalogId INT = 0  )
AS
/*
    Summary :  Import Process call respective import method from @TemplateId 
    Process :  
	EXEC Znode_ImportValidatePimProductData @TableName = 'tempdb..[##SEODetails_61bbcb4c-5b83-49a0-8bb6-48eaf07f9ce0]',@NewGUID = '61bbcb4c-5b83-49a0-8bb6-48eaf07f9ce0' ,@TemplateId = 9,@UserId = 2,@PortalId = 0,@LocaleId = 1,@IsCategory= 1 ,@DefaultFamilyId = 0 ,@ImportHeadName = 'SEODetails', @ImportProcessLogId = 11, @PriceListId = 0, @CountryCode = ''
*/
BEGIN
BEGIN TRY 
	 DECLARE @ImportHeadName nvarchar(100), @SPScript nvarchar(max), @DatabaseName nvarchar(100), @ServerName nvarchar(100), @SPScript1 nvarchar(max),@UserName nvarchar(100);
	 DECLARE @GetDate datetime= dbo.Fn_GetDate();
	 DECLARE @SPName nvarchar(100)
	
	 SELECT TOP 1 @ImportHeadName = Name
	 FROM ZnodeImportTemplate AS zit
		 INNER JOIN
		 ZnodeImportHead AS zih
		 ON zit.ImportHeadId = zih.ImportHeadId
	 WHERE zit.ImportTemplateId = @TemplateId;
	 SET @DatabaseName = DB_NAME();
	 SET @ServerName = @@serverName;/*We can use for the customization*/
	 SET @UserName = SYSTEM_USER;
	 
	 If (@ImportHeadName = 'ProductUpdate')
	 Begin
		SET @SPName = 'Znode_ImportPartialValidatePimProductData'
		SET @Nextstep_id = 1 
	 End
	 ELSE
	 Begin
		SET @SPName = 'Znode_ImportValidatePimProductData'
		SET @Nextstep_id = 3 
	 End

	--Generate new process for current import 
	If @ImportProcessLogId   = 0 
	Begin
		If @ERPTaskSchedulerId = 0 
			INSERT INTO ZnodeImportProcessLog( ImportTemplateId, Status, ProcessStartedDate, ProcessCompletedDate, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate )
			   SELECT @TemplateId, dbo.Fn_GetImportStatus( 0 ), @GetDate, NULL, @UserId, @GetDate, @UserId, @GetDate;
		else 
			INSERT INTO ZnodeImportProcessLog( ImportTemplateId, Status, ProcessStartedDate, ProcessCompletedDate, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate ,ERPTaskSchedulerId)
			   SELECT @TemplateId, dbo.Fn_GetImportStatus( 0 ), @GetDate, NULL, @UserId, @GetDate, @UserId, @GetDate , @ERPTaskSchedulerId;
		SET @ImportProcessLogId = @@IDENTITY;
	
	End
	
	SET @SPScript1 = N' EXEC ' + @SPName + ' @TableName = '''+@TableName+''',@NewGUID = '''+@NewGUID+''' ,@TemplateId = '
					+CONVERT(varchar(100), @TemplateId)+',@UserId = '+CONVERT(varchar(100), @UserId)
					+',@PortalId = '+CONVERT(varchar(100), @PortalId)+
					+',@IsAccountAddress = '+CONVERT(varchar(100), @IsAccountAddress)
					+',@LocaleId = '+CONVERT(varchar(100), @LocaleId)+',@IsCategory= '+CASE
					WHEN @ImportHeadName IN( 'Pricing', 'Product', 'Inventory' ) THEN '0'
					ELSE '1'
					END+' ,@DefaultFamilyId = '+CONVERT(varchar(100), @DefaultFamilyId)+' ,@ImportHeadName = '''+@ImportHeadName+''', @ImportProcessLogId = '
					+CONVERT(varchar(100), @ImportProcessLogId)+', @PriceListId = '+CONVERT(varchar(100), @PriceListId)
					+', @PimCatalogId = '+CONVERT(varchar(100), @PimCatalogId)+ ', @CountryCode = ''' + @CountryCode  + '''';

	    
	  IF @IsAutoPublish = 1 
	  BEGIN 
			SET @SPScript1 = @SPScript1 + N' 
		   
			DECLARE @PimProductId Transferid 

			INSERT INTO  @PimProductId 
			SELECT DISTINCT  c.PimProductId 
			FROM ZnodeImportSuccessLog a 
			INNER JOIN ZnodePimAttributeValueLocale  b ON (b.AttributeValue = a.ImportedSku)
			INNER JOIN ZnodePimAttributeValue c ON (c.PimAttributeValueId = b.PimAttributeValueId)
			INNER JOIN ZnodePimAttribute d ON (d.PimAttributeId = c.PimAttributeId)
			WHERE d.AttributeCode = ''SKU''
			AND a.ImportedGuId = '''+@NewGUID+'''
			
			Exec [Znode_PublishSingleProductEntity] @PimProductId = @PimProductId  , @UserId = 2 ,  @RevisionType = ''PRODUCTION''  
			,@IsAutoPublish = 1,@ImportGUID = '''+@NewGUID+'''

			UPDATE ZnodeImportSuccessLog 
			SET    IsProductPublish =  1 
			WHERE ImportedGuId = '''+@NewGUID+'''

		'

		print @SPScript1
	  END 

	IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
	BEGIN
	      EXEC sys.sp_sqlexec @SPScript1;
	END;
	ELSE
	BEGIN 
		
		IF @IsDebug = 1
		          BEGIN
		              EXEC sys.sp_sqlexec
		                   @SPScript1;
		              RETURN 0;
		          END;
		--DECLARE @jobId binary(16)
		--SELECT @jobId = job_id FROM msdb.dbo.sysjobs WHERE (name = N'Name of Your Job')
		--IF (@jobId IS NOT NULL)
		--BEGIN
		--EXEC msdb.dbo.sp_delete_job @jobId
		--END
		--Add a job

		SET @SPScript1 = N' EXEC '+ @SPName + ' @TableName = '''''+@TableName+''''',@NewGUID = '''''+@NewGUID+''''' ,@TemplateId = '+CONVERT(varchar(100), @TemplateId)+',@UserId = '+CONVERT(varchar(100), @UserId)+',@PortalId = '+CONVERT(varchar(100), @PortalId)+',@LocaleId = '+CONVERT(varchar(100), @LocaleId)+',@IsCategory= '+CASE
																																																																										   WHEN @ImportHeadName IN( 'Pricing', 'Product', 'Inventory' ) THEN '0'
																																																																										   ELSE '1'
																																																																										   END
					+' ,@DefaultFamilyId = '+CONVERT(varchar(100), @DefaultFamilyId)+' ,@ImportHeadName = '''''+@ImportHeadName+''''', @ImportProcessLogId = '+CONVERT(varchar(100), @ImportProcessLogId)+', @PriceListId = '+CONVERT(varchar(100), @PriceListId)+',@IsAccountAddress = '+CONVERT(varchar(100), @IsAccountAddress)+', @PimCatalogId = '+CONVERT(varchar(100), @PimCatalogId)
																																																																										   + ', @CountryCode = ''''' + @CountryCode  +'''''';


		
		 IF @IsAutoPublish = 1 
	  BEGIN 
		SET @SPScript1 = @SPScript1 + N' 
		   
			DECLARE @PimProductId Transferid 

			INSERT INTO  @PimProductId 
			SELECT DISTINCT  b.PimProductId 
			FROM ZnodeImportSuccessLog a 
			INNER JOIN View_loadManageProductInternal b ON (b.AttributeValue = a.ImportedSku)
			WHERE b.AttributeCode = ''''SKU''''
			AND a.ImportedGuId = '''''+@NewGUID+'''''
			
			
			Exec [Znode_PublishSingleProductEntity] @PimProductId = @PimProductId  , @UserId = 2 ,  @RevisionType = ''''PRODUCTION''''  
			,@IsAutoPublish = 1,@ImportGUID = '''''+@NewGUID+'''''

						
			UPDATE ZnodeImportSuccessLog 
			SET    IsProductPublish =  1 
			WHERE ImportedGuId = '''''+@NewGUID+'''''
			 '
	  END 

		DECLARE @jobId binary(16);
		
		SET @NewGUID = 'Import_'+REPLACE(@NewGUID, '''', '');
		

		IF @IsDoNotCreateJob =0 
		Begin
			SET @SPScript = N'EXEC msdb.dbo.sp_add_job
				  @job_name = '''+@NewGUID+''' ,
				  @enabled = 1,
				  @notify_level_eventlog = 2,
				  @notify_level_email = 2,
				  @notify_level_netsend = 2,
				  @notify_level_page = 2,
				  @delete_level = 3,
				  @category_name = N''[Uncategorized (Local)]'',
				  @owner_login_name = N'''+ @UserName +'''';
			--@job_id = '' + Convert(NVARCHAR(MAX),@jobId ) + '' OUTPUT; '

			EXEC sys.sp_sqlexec @SPScript;

			SET @SPScript = N' EXEC msdb.dbo.sp_add_jobserver
				  @job_name = '''+@NewGUID+'''';

			EXEC sys.sp_sqlexec @SPScript;
		END

		SET @SPScript = N' EXEC msdb.dbo.sp_add_jobstep
              @job_name = '''+ @NewGUID +''',
              @step_name = N'''+ @StepName +''',
			  @step_id =  ' + Convert(nvarchar(10),@step_id ) +  ',
			  @cmdexec_success_code = 0,
              @on_success_action = ' + Convert(nvarchar(10),@Nextstep_id ) +  ',
              @on_fail_action = '    + Convert(nvarchar(10),@Nextstep_id ) +  ',
			  @retry_attempts = 0,
              @retry_interval = 0,
              @os_run_priority = 0,
              @subsystem = N''TSQL'',
              @command = N'''+ @SPScript1 +''',
              @database_name = '''+@DatabaseName+''',
              @flags = 0 ';
		PRINT  @SPScript
		EXEC sys.sp_sqlexec @SPScript;

		DECLARE @ReturnCode tinyint= 0; -- 0 (success) or 1 (failure)
		IF @IsDoNotStartJob = 0 
		Begin
			SET @SPScript = N'EXEC @ReturnCode = msdb.dbo.sp_start_job 
				  @job_name = '''+ @NewGUID +''',
				  @server_name = '''+ @ServerName +''',
				  @step_name = N''' + @StartStepName +'''';

			EXEC sys.SP_EXECUTESQL @SPScript, N'@ReturnCode TINYINT OUT', @ReturnCode = @ReturnCode OUT;
		END 
		--      select 3  , @SPScript
		
		--RETURN (@ReturnCode)
		IF @ReturnCode = 1
		BEGIN
			UPDATE ZnodeImportProcessLog
			  SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
			WHERE ImportProcessLogId = @ImportProcessLogId
		END;

		--EXEC msdb.dbo.sp_delete_job @job_id=N'4470113c-a592-41d8-951e-45d9982071da', @delete_unused_schedule=1
	END;
	END TRY 
	BEGIN CATCH 
		DECLARE @Status BIT ;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportData @TableName = '''+ISNULL(@TableName,'''''')+''',@NewGUID='''+ISNULL(CAST(@NewGUID AS
		VARCHAR(50)),'''''')+''',@TemplateId='''+ISNULL(CAST(@TemplateId AS VARCHAR(50)),'''''')+''',@CountryCode='''+ISNULL(@CountryCode,'''''')+''',
		@UserId='+ISNULL(CAST(@UserId AS VARCHAR(50)),'''')+',@DefaultFamilyId='+ISNULL(CAST(@DefaultFamilyId AS VARCHAR(50)),'''')+',@PriceListId='+ISNULL(CAST(@PriceListId AS VARCHAR(50)),'''')+',@PortalId='+ISNULL(CAST(@PortalId AS VARCHAR(50)),'''')
            
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportData',
		@ErrorInProcedure = 'Znode_ImportData',
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH 
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportValidatePimProductData')
	DROP PROC Znode_ImportValidatePimProductData
GO

CREATE PROCEDURE [dbo].[Znode_ImportValidatePimProductData]
(   @ImportHeadName     VARCHAR(200),
    @TableName          VARCHAR(200),
    @NewGUID            NVARCHAR(200),
    @TemplateId         INT,
    @UserId             INT,
    @LocaleId           INT           = 1,
    @IsCategory         INT           = 0,
    @DefaultFamilyId    INT           = 0,
    @ImportProcessLogId INT,
    @PriceListId        INT,
	@CountryCode VARCHAR(100) = '',
	@PimCatalogId         INT    = 0 ,
	@PortalId int = 0,
	@IsAccountAddress bit = 0 )
AS
     SET NOCOUNT ON;

/*
    Summary :   Import PimProduct / Price / Inventory / Category / Category Associated Data 
    Process :   Admin site will upload excel / csv file in database and create global temporary table
				Procedure Znode_ImportValidatePimProductData will validate data with attribute validation rule
				If datatype validation issue found in input daata will logged into table "ZnodeImportLog"
				If Data is correct and record count in table ZnodeImportLog will be 0 then process for import data into Base tables
				To import data call procedure "Znode_ImportPimProductData"
    		  
				SourceColumnName: CSV file column headers
				TargetColumnName: Attributecode from ZnodePimAttribute Table (Consider those Attributecodes configured with default family only)
*/

     BEGIN
         BEGIN TRY
             SET NOCOUNT ON;
             --BEGIN TRAN TRN_ImportValidProductData;
             DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
             DECLARE @SQLQuery NVARCHAR(MAX), @AttributeTypeName NVARCHAR(100), @AttributeCode NVARCHAR(300), @AttributeId INT, @IsRequired BIT, @SourceColumnName NVARCHAR(600), @ControlName VARCHAR(300), @ValidationName VARCHAR(100), @SubValidationName VARCHAR(300), @ValidationValue VARCHAR(300), @RegExp VARCHAR(300), @CreateDateString NVARCHAR(300), @DefaultLocaleId INT, @ImportHeadId INT, @CheckedSourceColumn NVARCHAR(600)= '', @Status BIT= 0,
			    @CsvColumnString nvarchar(max),
				@FailedRecordCount BIGINT,
				@SuccessRecordCount BIGINT
            --To get the total record count for update purpose in catch block
            SET @SQLQuery = 'SELECT '+CAST(@ImportProcessLogId AS VARCHAR(10))+',COUNT(*) FROM '+@TableName
			INSERT INTO Znode_ImportCsvRowCount
			EXEC (@SQLQuery) 

             DECLARE @FamilyAttributeDetail TABLE
             (PimAttributeId       INT,
              AttributeTypeName    VARCHAR(300),
              AttributeCode        VARCHAR(300),
              SourceColumnName     NVARCHAR(600),
              IsRequired           BIT,
              PimAttributeFamilyId INT
             );
             DECLARE @AttributeDetail TABLE
             (PimAttributeId    INT,
              AttributeTypeName VARCHAR(300),
              AttributeCode     VARCHAR(300),
              SourceColumnName  NVARCHAR(600),
              IsRequired        BIT,
              ControlName       VARCHAR(300),
              ValidationName    VARCHAR(100),
              SubValidationName VARCHAR(300),
              ValidationValue   VARCHAR(300),
              RegExp            VARCHAR(300)
             );

			CREATE TABLE #DefaultAttributeCode
			(AttributeTypeName          VARCHAR(300),
			PimAttributeDefaultValueId INT,
			PimAttributeId             INT,
			AttributeDefaultValueCode  VARCHAR(100)
			);

			IF( @ImportHeadName = 'B2BCustomer' )
			BEGIN
				EXEC ZnodeB2BCustomerMapping @ImportHeadName = @ImportHeadName, @TableName = @TableName
			END
		
             DECLARE @GlobalTempTableColumns TABLE(ColumnName NVARCHAR);
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM INFORMATION_SCHEMA.TABLES
                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#InvalidDefaultData'
             )
                 CREATE TABLE #InvalidDefaultData
                 (RowNumber  INT,
                  Value      NVARCHAR(MAX),
                  ColumnName NVARCHAR(600)
                 );
             ELSE
             DROP TABLE #InvalidDefaultData;
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM INFORMATION_SCHEMA.TABLES
                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#GlobalTempTableColumns'
             )
                 BEGIN

                     SET @SQLQuery = 'SELECT Column_Name, '''+@ImportHeadName+''' AS ImportHeadName  from tempdb.INFORMATION_SCHEMA.COLUMNS	where table_name = object_name(object_id('''+@TableName+'''),
					(select database_id from sys.databases where name = ''tempdb''))';
                     CREATE TABLE #GlobalTempTableColumns
                     (ColumnName   NVARCHAR(MAX),
                      TypeOfImport NVARCHAR(100)
                     );
                     INSERT INTO #GlobalTempTableColumns
                     (ColumnName,
                      TypeOfImport
                     )
                     EXEC sys.sp_sqlexec
                          @SQLQuery;
                 END;

             IF EXISTS
             (
                 SELECT TOP 1 1
                 FROM #GlobalTempTableColumns
                 WHERE ColumnName IN('PimCategoryId', 'PimProductId', 'RowNumber')
             )
                 BEGIN
                     INSERT INTO ZnodeImportLog
                     (ErrorDescription,
                      ColumnName,
                      Data,
                      GUID,
                      CreatedBy,
                      CreatedDate,
                      ModifiedBy,
                      ModifiedDate,
                      ImportProcessLogId
                     )
                     VALUES
                     (43,
                      '',
                      '',
                      @newGUID,
                      @UserId,
                      @GetDate,
                      @UserId,
                      @GetDate,
                      @ImportProcessLogId
                     );
                 END;
             SET @DefaultLocaleId = dbo.Fn_GetDefaultLocaleId();

             IF NOT EXISTS
             (
                 SELECT TOP 1 1  FROM ZnodeImportLog
                 WHERE Guid = @NewGUID
                       AND ErrorDescription IN(43, 42)
                 AND ImportProcessLogId = @ImportProcessLogId
             )
                 BEGIN
                     IF @ImportHeadName = 'Product'
                      BEGIN
						  IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
							  SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimProductId int null ';
						  ELSE 
							 SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimProductId int null Primary KEY CLUSTERED(RowNumber)';
						 
						  EXEC sys.sp_sqlexec @SQLQuery;
			         END;
                     ELSE
                     IF @ImportHeadName = 'Category'
                         BEGIN
							  IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimCategoryId int null ';
							  ElSE
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimCategoryId int null Primary KEY CLUSTERED(RowNumber) ';
						  
							  EXEC sys.sp_sqlexec @SQLQuery;
                         END;
                     ELSE
                         BEGIN
							IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1) ';
							Else 
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1) Primary KEY CLUSTERED(RowNumber)';
							
							EXEC sys.sp_sqlexec @SQLQuery;
                         END;;
                 END;

             SET @CreateDateString = CONVERT(VARCHAR(100), @UserId)+','''+CONVERT(VARCHAR(100), @GetDate)+''','+CONVERT(VARCHAR(100), @UserId)+','''+CONVERT(VARCHAR(100), @GetDate)+''', '+CONVERT(VARCHAR(100), @ImportProcessLogId);

             SELECT TOP 1 @ImportHeadId = ImportHeadId FROM ZnodeImportTemplate WHERE ImportTemplateId = @TemplateId;
             IF @DefaultFamilyId = 0
                AND @ImportHeadName IN('Product', 'Category')
                 BEGIN 
                     --Get all default attribute values in attribute 
                     INSERT INTO @FamilyAttributeDetail
                     (PimAttributeId,
                      AttributeTypeName,
                      AttributeCode,
                      SourceColumnName,
                      IsRequired,
                      PimAttributeFamilyId
                     )
                     --Call Process to insert data of defeult family with source column name and target column name 
                     EXEC Znode_ImportGetTemplateDetails
                          @TemplateId = @TemplateId,
                          @IsValidationRules = 0,
                          @IsIncludeRespectiveFamily = 1,
                          @IsCategory = @IsCategory,
                          @DefaultFamilyId = @DefaultFamilyId;

					---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;
             ELSE
             IF @ImportHeadName IN('Product', 'Category')
                 BEGIN
				 
                     --Get all default attribute values in attribute 
                     INSERT INTO @FamilyAttributeDetail
                     (PimAttributeId,
                      AttributeTypeName,
                      AttributeCode,
                      SourceColumnName,
                      IsRequired,
                      PimAttributeFamilyId
                     )
                     --Call Process to insert data of defeult family with source column name and target column name 
                     EXEC Znode_ImportGetTemplateDetails
                          @TemplateId = @TemplateId,
                          @IsValidationRules = 0,
                          @IsIncludeRespectiveFamily = 1,
                          @IsCategory = @IsCategory,
                          @DefaultFamilyId = @DefaultFamilyId;

					---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;      
             -- Check attributes are manditory and not provided with source table
		   	 
			if @TABLENAME	like '%tempdb..%'
				SET @SQLQuery = 'SELECT 42 AS ErrorDescription , SourceColumnName , '''' , '''+@NewGUID+''','+@CreateDateString+' from ZnodeImportTemplateMapping where ImportTemplateId = '+CONVERT(VARCHAR(100), @TemplateId)+' and ltrim(rtrim(SourceColumnName)) <> '''' AND ltrim(rtrim(SourceColumnName)) not in ( select isnull(Name ,'''') from tempdb.sys.columns where object_id = object_id('''+@TABLENAME+'''));';
			else 
				SET @SQLQuery = 'SELECT 42 AS ErrorDescription , SourceColumnName , '''' , '''+@NewGUID+''','+@CreateDateString+' from ZnodeImportTemplateMapping where ImportTemplateId = '+CONVERT(VARCHAR(100), @TemplateId)+' and ltrim(rtrim(SourceColumnName)) <> '''' AND ltrim(rtrim(SourceColumnName)) not in ( select isnull(Name ,'''') from sys.columns where object_id = object_id('''+@TABLENAME+'''));';
		 
			Declare @Tbl_CsvDynamicColulmns TABLE (ColumnName nvarchar(300), SequenceNumber int, DataType nvarchar(50),IsRequired bit )

			INSERT INTO @Tbl_CsvDynamicColulmns(ColumnName , SequenceNumber , DataType ,IsRequired)
			SELECT DISTINCT ZITM.SourceColumnName ,ZIAV.SequenceNumber, ZIAV.AttributeTypeName, ZIAV.IsRequired
			FROM ZnodeImportAttributeValidation ZIAV LEFT OUTER JOIN 
			ZnodeImportTemplate  ZIT ON ZIT.ImportHeadId =  ZIAV.ImportHeadId AND ZIT.ImportTemplateId  = @TemplateId
			LEFT OUTER JOIN ZnodeImportTemplateMapping  ZITM ON ZITM.ImportTemplateId = ZIT.ImportTemplateId  
			and ZIAV.AttributeCode = ZITM.TargetColumnName
			AND ZITM.ImportTemplateId  = @TemplateId
			WHERE ZIAV.ImportHeadId = @ImportHeadId
			AND ISNULL(ZITM.SourceColumnName,'') <> ''--ORDER BY ZIAV.SequenceNumber


		    SELECT @CsvColumnString = SUBSTRING ((Select ',' +  ISNULL(ColumnName ,'NULL') from @Tbl_CsvDynamicColulmns ORDER BY SequenceNumber FOR XML PATH ('')),2,4000) 


     		INSERT INTO ZnodeImportLog(ErrorDescription, ColumnName, Data, GUID,CreatedBy, CreatedDate,  ModifiedBy,ModifiedDate,ImportProcessLogId
             )
             EXEC sys.sp_sqlexec  @SQLQuery;
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM ZnodeImportLog
                 WHERE Guid = @NewGUID
                       AND ErrorDescription IN(43, 42)
                 AND ImportProcessLogId = @ImportProcessLogId
             )
                 BEGIN
                     --Get all default attribute values in attribute 
                     IF @ImportHeadName IN('Product', 'Category')
                         BEGIN
                             -- Check attributes are manditory and not provided with source table
                             INSERT INTO ZnodeImportLog
                             (ErrorDescription,
                              ColumnName,
                              Data,
                              GUID,
                              CreatedBy,
                              CreatedDate,
                              ModifiedBy,
                              ModifiedDate,
                              ImportProcessLogId
                             )
                                    SELECT '14' AS ErrorDescription,
                                           AttributeCode,
                                           '',
                                           @NewGUID,
                                           @UserId,
                                           @GetDate,
                                           @UserId,
                                           @GetDate,
                                           @ImportProcessLogId
                                    FROM @FamilyAttributeDetail
                                    WHERE ISNULL(SourceColumnName, '') = ''
                                          AND IsRequired = 1;  

                             -- Read all attribute details with their datatype
                             INSERT INTO @AttributeDetail
                             (PimAttributeId,
                              AttributeTypeName,
                              AttributeCode,
                              SourceColumnName,
                              IsRequired,
                              ControlName,
                              ValidationName,
                              SubValidationName,
                              ValidationValue,
                              RegExp
                             )
                             EXEC Znode_ImportGetTemplateDetails
                                  @TemplateId=@TemplateId,
								  @DefaultFamilyId=@DefaultFamilyId;

							---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
							Delete FAD from @AttributeDetail FAD
							where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
							and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
										   inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode) 

                             DELETE FROM @AttributeDetail
                             WHERE AttributeTypeName = 'Image'
                                   AND ValidationName <> 'IsAllowMultiUpload';
							DELETE FROM @AttributeDetail
                             WHERE AttributeTypeName = 'File'
                                   AND ValidationName <> 'IsAllowMultiUpload';

                                     INSERT INTO #DefaultAttributeCode
                                     (AttributeTypeName,
                                      PimAttributeDefaultValueId,
                                      PimAttributeId,
                                      AttributeDefaultValueCode
                                     )
                                     --Call Process to insert default data value 
                                     EXEC Znode_ImportGetPimAttributeDefaultValue;

                                     DELETE FROM #DefaultAttributeCode
                                     WHERE AttributeTypeName = 'Yes/No';

                         END;
                     ELSE
                         BEGIN
					
					
                             --Read all attribute details with their datatype
                             INSERT INTO @AttributeDetail
                             (AttributeTypeName,
                              AttributeCode,
                              SourceColumnName,
                              IsRequired,
                              ControlName,
                              ValidationName,
                              SubValidationName,
                              ValidationValue,
                              RegExp
                             )
                             EXEC [Znode_ImportGetOtherTemplateDetails]
                                  @TemplateId = @TemplateId,
                                  @ImportHeadId = @ImportHeadId;

							IF @ImportHeadName IN('B2BCustomer')
							BEGIN

								INSERT INTO @AttributeDetail
								 (PimAttributeId,
								 AttributeTypeName,
								  AttributeCode,
								  SourceColumnName,
								  IsRequired,
								  ControlName,
								  ValidationName,
								  SubValidationName,
								  ValidationValue,
								  RegExp
								 )
								 EXEC [Znode_ImportGetGlobalTemplateDetails]
									  @TemplateId = @TemplateId,
									  @ImportHeadId = @ImportHeadId;

								
								INSERT INTO #DefaultAttributeCode
								(AttributeTypeName,
								PimAttributeDefaultValueId,
								PimAttributeId,
								AttributeDefaultValueCode
								)
								--Call Process to insert default data value 
								EXEC Znode_ImportGetGlobalAttributeDefaultValue;

								DELETE FROM #DefaultAttributeCode
								WHERE AttributeTypeName = 'Yes/No';

							END
						
                             --Check attributes are not mapped with any family of Pim Product
                             INSERT INTO ZnodeImportLog
                             (ErrorDescription,
                              ColumnName,
                              Data,
                              GUID,
                              CreatedBy,
                              CreatedDate,
                              ModifiedBy,
                              ModifiedDate,
                              ImportProcessLogId
                             )
                                    SELECT DISTINCT
                                           '14' AS ErrorDescription,
                                           AttributeCode,
                                           '',
                                           @NewGUID,
                                           @UserId,
                                           @GetDate,
                                           @UserId,
                                           @GetDate,
                                           @ImportProcessLogId
                                    FROM @AttributeDetail
                                    WHERE ISNULL(SourceColumnName, '') = ''   AND IsRequired = 1;  ;

                         END;
						
                     --	Check attributes are not mapped with (Default / Other) family of Pim Product
                     --	INSERT INTO ZnodeImportLog ( ErrorDescription , ColumnName , Data , GUID , CreatedBy , CreatedDate , ModifiedBy , ModifiedDate , ImportProcessLogId)
                     --	SELECT '1' AS ErrorDescription , SourceColumnName , '' , @NewGUID , @UserId , @GetDate , @UserId , @GetDate , @ImportProcessLogId
                     --	FROM @AttributeDetail WHERE PimAttributeId NOT IN ( SELECT zpfgm.PimAttributeId FROM dbo.ZnodePimFamilyGroupMapper AS zpfgm);
                     --	Verify data in global temporary table (column wise)
					
                     DECLARE Cr_Attribute CURSOR LOCAL FAST_FORWARD
                     FOR SELECT PimAttributeId,
                                AttributeTypeName,
                                AttributeCode,
                                IsRequired,
                                SourceColumnName,
                                ControlName,
                                ValidationName,
                                SubValidationName,
                                ValidationValue,
                                RegExp
                         FROM @AttributeDetail
                         WHERE ISNULL(SourceColumnName, '') <> '';
                     OPEN Cr_Attribute;
                     FETCH NEXT FROM Cr_Attribute INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @ControlName, @ValidationName, @SubValidationName, @ValidationValue, @RegExp;
                     WHILE @@FETCH_STATUS = 0
                         BEGIN
				             IF @AttributeTypeName = 'Number'
                                 BEGIN
							      EXEC Znode_ImportValidateNumber
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @ImportHeadId = @ImportHeadId,
                                          @ImportProcessLogId = @ImportProcessLogId;
                                 END;
							 -- Check invalid date
							
                             IF @AttributeTypeName = 'Date'
                                 BEGIN
                                     EXEC Znode_ImportValidateDate
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @ImportHeadId = @ImportHeadId,
                                          @ImportProcessLogId = @ImportProcessLogId;
                                 END;
							 -- Check Manditory Data
		 					 IF @IsRequired = 1 AND @CheckedSourceColumn <> @SourceColumnName
								BEGIN
									SET @CheckedSourceColumn = @SourceColumnName;
									EXEC Znode_ImportValidateManditoryData
									@TableName = @TableName,
									@SourceColumnName = @SourceColumnName,
									@CreateDateString = @CreateDateString,
									@ValidationName = @ValidationName,
									@ControlName = @ControlName,
									@ValidationValue = @ValidationValue,
									@NewGUID = @NewGUID,
									@ImportHeadId = @ImportHeadId;
								END;
							 --END 
							
                             IF @AttributeTypeName = 'Text'
                                 BEGIN
								 
						              EXEC Znode_ImportValidateManditoryText
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @LocaleId = @LocaleId,
                                          @DefaultLocaleId = @DefaultLocaleId,
                                          @AttributeId = @AttributeId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @ImportHeadId = @ImportHeadId;
                                 END;
                             IF @AttributeTypeName in ( 'Image','File')
                                 BEGIN
                                     EXEC Znode_ImportValidateImageData
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @LocaleId = @LocaleId,
                                          @DefaultLocaleId = @DefaultLocaleId,
                                          @AttributeId = @AttributeId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @ImportHeadId = @ImportHeadId;
                                 END;

					

                             --Check Default data value is valid 
                             IF @ImportHeadName IN('Product', 'Category','B2BCustomer')
                                 BEGIN
                                     IF @AttributeId IN
                                     (
                                         SELECT PimAttributeId
                                         FROM #DefaultAttributeCode
                                     )
                                         BEGIN
							
                                            IF  @AttributeTypeName = 'Multi Select'
											 BEGIN
										 		 ---Verify Image file is exists in media table or not 
												 SET @SQLQuery = ' INSERT INTO #InvalidDefaultData (RowNumber, Value, ColumnName) 
												 SELECT ROWNUMBER , (Select TOP 1 Item from dbo.split(' + @SourceColumnName + ','','')  SP WHERE NOT EXISTS 
												 (Select ToP 1 1 FROM #DefaultAttributeCode DAC WHERE 
												  DAC.AttributeTypeName <> ''Yes/No'' AND DAC.AttributeDefaultValueCode IS NOT NULL AND DAC.PimAttributeId = 
												 ' + CONVERT(VARCHAR(100), @AttributeId) + ' AND ltrim(rtrim(SP.Item) ) = DAC.AttributeDefaultValueCode
												 )), ''' + @SourceColumnName + ''' as [ColumnName]  FROM ' + @TableName
												 + ' Where ISnull(' + @SourceColumnName +  ','''') <> '''''
												EXEC sys.sp_sqlexec @SQLQuery;
											  END
											  ELSE IF @AttributeTypeName = 'Simple Select'
											  BEGIN
						
												---Verify Image file is exists in media table or not 
												 SET @SQLQuery = ' INSERT INTO #InvalidDefaultData (RowNumber, Value, ColumnName) 
												 SELECT ROWNUMBER , ' + @SourceColumnName + ' , ''' + @SourceColumnName + ''' as [ColumnName]  FROM ' + @TableName
												 + ' SP Where ISnull(' + @SourceColumnName +  ','''') <> '''' AND 
												  NOT EXISTS 
												 (Select TOP 1 1 FROM #DefaultAttributeCode DAC WHERE 
												  DAC.AttributeTypeName <> ''Yes/No'' AND DAC.AttributeDefaultValueCode IS NOT NULL AND DAC.PimAttributeId = 
												 ' + CONVERT(VARCHAR(100), @AttributeId) + ' AND ltrim(rtrim(SP.' + @SourceColumnName + ') ) = DAC.AttributeDefaultValueCode ) '
							
												EXEC sys.sp_sqlexec @SQLQuery;
											  END   
												-- Check Invalid Image 
												 SET @SQLQuery = 'SELECT ''9 '' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], 
												 Value AS  AttributeValue,RowNumber ,'''+@NewGUID+''',  '+@CreateDateString+' FROM #InvalidDefaultData Where Value IS NOT NULL'
												 INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, RowNumber, GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
												 EXEC sys.sp_sqlexec @SQLQuery;
												 Delete from #InvalidDefaultData

       
                                         END;
                                 END;
							
                             FETCH NEXT FROM Cr_Attribute INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @ControlName, @ValidationName, @SubValidationName, @ValidationValue, @RegExp;
                         END;
                     CLOSE Cr_Attribute;
                     DEALLOCATE Cr_Attribute;
                     --SELECT top 1 1 FROM @FamilyAttributeDetail where  iSNULL(SourceColumnName,'') = ''  and IsRequired = 1
                 END;
             
			 
			  
------------------------------------------------------------------------------------------
		 Declare @SQLQueryNew NVARCHAR(4000)
		 Declare @SourceColumnNameProduct nvarchar(4000) 
         IF @ImportHeadName IN('Product','Pricing','ProductAssociation','Inventory')
		 BEGIN
		 	 
		 SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'SKU'
		 AND ImportTemplateId = @TemplateId


			SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  SKU - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;			
		END
		ELSE IF @ImportHeadName IN('ProductAttribute')
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'AttributeCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  Attribute - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'ZipCode'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'ZIP'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  ZIPCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'Category'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'CategoryCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  CategoryCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'CategoryAssociation'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'CategoryName'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  CategoryName - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;

		END
		ELSE IF @ImportHeadName IN ('Customer','CustomerAddress')
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'UserName'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  UserName - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'SEODetails'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'Code'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  Code - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'Highlight'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'HighlightCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  HighlightCode - '' + ' + ' cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'AddonAssociation'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'SKU'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  SKU - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'AttributeDefaultValue'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'AttributeDefaultValueCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  AttributeDefaultValueCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
	-------------------------------------------------------------------------------------------------------------
	
	--------------------------------------------------------------------------------------------------------------------
			 
  		SET @SQLQuery = 'Delete FROM  '+@TableName+' Where Rownumber IN (Select Rownumber FROM ZnodeImportLog  WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND Rownumber IS NOT NULL)';
        EXEC sys.sp_sqlexec  @SQLQuery;
			 			
   
             IF @ImportHeadName IN('Product', 'Category')
                 BEGIN
                     IF NOT EXISTS
                     (
                         SELECT TOP 1 1
                         FROM @FamilyAttributeDetail
                         WHERE ISNULL(SourceColumnName, '') = ''
                               AND IsRequired = 1
                     ) AND NOT EXISTS
					 (
						 SELECT TOP 1 1
						 FROM ZnodeImportLog
						 WHERE Guid = @NewGUID
							   AND ErrorDescription IN(43, 42)
						 AND ImportProcessLogId = @ImportProcessLogId
					 )
                         BEGIN
                             IF @IsCategory = 0
                                 BEGIN

                                     EXEC Znode_ImportPimProductData
                                          @TableName = @TableName,
                                          @NewGUID = @NewGUID,
                                          @TemplateId = @TemplateId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @UserId = @UserId,
                                          @LocaleId = @LocaleId,
                                          @DefaultFamilyId = @DefaultFamilyId;

                                 END;
                             ELSE
                                 BEGIN
                                     EXEC Znode_ImportPimCategoryData
                                          @TableName = @TableName,
                                          @NewGUID = @NewGUID,
                                          @TemplateId = @TemplateId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @UserId = @UserId,
                                          @LocaleId = @LocaleId,
                                          @DefaultFamilyId = @DefaultFamilyId;
                                 END;
                         END
						 ELSE
							BEGIN
								-- Update Record count in log 
								
							
								--SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
								--EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount out
								--UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
								--WHERE ImportProcessLogId = @ImportProcessLogId;

								SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
								SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
								EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount out
								UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
								WHERE ImportProcessLogId = @ImportProcessLogId;
							END

                 END;
				IF NOT EXISTS
					 (
						 SELECT TOP 1 1
						 FROM ZnodeImportLog
						 WHERE Guid = @NewGUID
							   AND ErrorDescription IN(43, 42)
						 AND ImportProcessLogId = @ImportProcessLogId
					 )
             BEGIN
                 IF @ImportHeadName = 'Pricing'
                     BEGIN
                         EXEC [Znode_ImportPriceList]
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
                              @PriceListId = @PriceListId;
                     END;

                 IF @ImportHeadName = 'Inventory'
                     BEGIN
				
                         EXEC Znode_ImportInventory_Ver1
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID;
                     END;
                 IF @ImportHeadName = 'ZipCode'
                     BEGIN
						 EXEC Znode_ImportZipCode
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
							  @CountryCode = @CountryCode;
                     END;
					 IF @ImportHeadName = 'CategoryAssociation'
                     BEGIN
						 EXEC Znode_ImportCatalogCategory
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
							  @PimCatalogId = @PimCatalogId;
                     END;
					 IF @ImportHeadName = 'ProductAssociation'
                     BEGIN
						 EXEC Znode_ImportAssociateProducts
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID
                     END;
			
					 IF @ImportHeadName = 'SEODetails' AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportSEODetails
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
							  @LocaleId = @LocaleId,
							  @PortalId =@PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
							  @CsvColumnString = @CsvColumnString 

				
                     END;
				
					 IF @ImportHeadName = 'ProductAttribute' 
                     BEGIN
						 EXEC Znode_ImportAttributes
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
							  @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID
				
                     END;

					 IF @ImportHeadName = 'Customer' AND @PortalId > 0 
                     BEGIN
					
						 EXEC Znode_ImportCustomer
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = @PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
				
                     END;
					 
					 IF @ImportHeadName = 'UserApprovers' AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportUserApproval
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = @PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
				
                     END;

					 IF @ImportHeadName = 'B2BCustomer' AND @PortalId > 0 
                     BEGIN

							 EXEC Znode_ImportB2BCustomer
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = @PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
				
                     END;

					 IF @ImportHeadName = 'CustomerAddress' --AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportCustomerAddress
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = 7, -- not implemented from forntend 
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString,
							  @IsAccountAddress = @IsAccountAddress
				
                     END;
					 IF @ImportHeadName = 'ShippingAddress' --AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportCustomerAddress
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = 7, -- not implemented from forntend 
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString,
							  @IsAccountAddress = @IsAccountAddress
				
                     END;
					 IF @ImportHeadName = 'StoreLocator' --AND @PortalId > 0 
                     BEGIN
					 	 EXEC Znode_ImportStoreLocatorAddress
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
                     END;

					IF @ImportHeadName = 'Highlight'
					BEGIN
					EXEC Znode_ImportHighlight 
					@TableName = @TableName, 
					@Status = @Status, 
					@UserId = @UserId, 
					@ImportProcessLogId = @ImportProcessLogId, 
					@NewGUID = @NewGUID 
					END;

					IF @ImportHeadName = 'AddonAssociation'
					BEGIN
					EXEC Znode_ImportAddonAssociation 
					@TableName = @TableName, 
					@Status = @Status, 
					@UserId = @UserId, 
					@ImportProcessLogId = @ImportProcessLogId, 
					@NewGUID = @NewGUID,
					@PimCatalogId = @PimCatalogId
					END;

					IF @ImportHeadName = 'AttributeDefaultValue'
					BEGIN
					EXEC Znode_ImportAttributeDefaultValue 
					@TableName = @TableName, 
					@Status = @Status, 
					@UserId = @UserId, 
					@ImportProcessLogId = @ImportProcessLogId, 
					@NewGUID = @NewGUID
					
					END;

					IF @ImportHeadName = 'Voucher'
					BEGIN
						EXEC Znode_ImportVoucher 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID
					
					END;

					IF @ImportHeadName = 'Account'
					BEGIN
						
						EXEC Znode_ImportAccount 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID,
						@CsvColumnString = @CsvColumnString,
						@PortalId = @PortalId
					
					END;

					IF @ImportHeadName = 'Synonyms'
					BEGIN
						EXEC Znode_ImportSynonyms 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID
					END

					IF @ImportHeadName = 'CatalogCategoryAssociation'
					BEGIN
						EXEC Znode_ImportCatalogCategoryHierarchyAssociation 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID,
						@PimCatalogId = @PimCatalogId
					END
				 
             END
			 ELSE 
				 BEGIN
					-- Update Record count in log 	
					SET @SQLQuery = ' Select @FailedRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
					EXEC	sp_executesql @SQLQuery , N'@FailedRecordCount BIGINT out' , @FailedRecordCount =@FailedRecordCount out
					SELECT @SuccessRecordCount = 0
									
					UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
					WHERE ImportProcessLogId = @ImportProcessLogId;

				 END

             EXEC Znode_ImportReadErrorLog
                  @ImportProcessLogId = @ImportProcessLogId,
                  @NewGUID = @NewGUID;
             DROP TABLE #GlobalTempTableColumns;

             -- Finally call product insert process if error not found in error log table 
             IF EXISTS
             (
                 SELECT TOP 1 1
                 FROM ZnodeImportLog
                 WHERE ImportProcessLogId = @ImportProcessLogId
                       AND Guid = @NewGUID
             )
                 BEGIN
                    --Updating the import process status
					UPDATE ZnodeImportProcessLog
					SET Status = CASE WHEN ISNULL(FailedRecordcount,0) > 0 AND ISNULL(SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
										WHEN ISNULL(FailedRecordcount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
										WHEN ISNULL(FailedRecordcount,0) > 0 AND ISNULL(FailedRecordcount,0) = ISNULL(TotalProcessedRecords,0) THEN dbo.Fn_GetImportStatus( 3 )
									END, 
						ProcessCompletedDate = getdate()
					WHERE ImportProcessLogId = @ImportProcessLogId;
                 END;
				 SET @SQLQuery = 'IF Object_id(''+@TableName+'') IS NOT NULL  DROP TABLE ' + @TableName
                 EXEC sys.sp_sqlexec @SQLQuery;

				 print 'end';
         END TRY
         BEGIN CATCH
			DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE()
			DECLARE @TempCount TABLE (Id INT)

			Declare @SQL Varchar(max) = 'Select Count(*) As Id From '+@TableName
			INSERT INTO @TempCount
			EXEC (@SQL)

             SELECT ERROR_MESSAGE(),
                    ERROR_LINE(),
                    ERROR_PROCEDURE();
             EXEC Znode_ImportReadErrorLog
                  @ImportProcessLogId = @ImportProcessLogId,
                  @NewGUID = @NewGUID; 
             
			 ---Import process updating fail due to database error
			UPDATE ZnodeImportProcessLog
			SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
			WHERE ImportProcessLogId = @ImportProcessLogId;

			---Loging error for Import process due to database error
		    INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		    SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

			--Updating total and fail record count
		    UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		    TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		    WHERE ImportProcessLogId = @ImportProcessLogId;

			SET @SQLQuery = 'Drop Table ' + @TableName
            EXEC sys.sp_sqlexec @SQLQuery;
             --ROLLBACK TRAN TRN_ImportValidProductData;
         END CATCH;
     END;

GO

INSERT INTO ZnodeGlobalSetting(FeatureName,FeatureValues,FeatureSubValues,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 'CatalogCategoryHierarchyAssociationAutoCreate','False',NULL,2, GETDATE(),2 , GETDATE()
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeGlobalSetting WHERE FeatureName = 'CatalogCategoryHierarchyAssociationAutoCreate')

GO

insert into ZnodeImportHead(Name,	IsUsedInImport,	IsUsedInDynamicReport,	IsActive,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate,	IsCsvUploader)
select 'CatalogCategoryAssociation',1,1,1,2,getdate(),2,getdate(),null
where not exists(select * from ZnodeImportHead where Name = 'CatalogCategoryAssociation')

insert into ZnodeImportTemplate(ImportHeadId,TemplateName,TemplateVersion,PimAttributeFamilyId,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select (select top 1 ImportHeadId from ZnodeImportHead where name = 'CatalogCategoryAssociation'),'CatalogCategoryAssociationTemplate',null,null,1,2,getdate(),2,getdate()
where not exists(select * from ZnodeImportTemplate where ImportHeadId = (select top 1 ImportHeadId from ZnodeImportHead where name = 'CatalogCategoryAssociation')
	and TemplateName = 'CatalogCategoryAssociationTemplate' )


INSERT ZnodeImportTemplateMapping(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'CatalogCategoryAssociationTemplate'),
'ParentCode' SourceColumnName,'ParentCode' TargetColumnName,0 DisplayOrder,1 IsActive, 0 IsAllowNull,2 CreatedBy,GETDATE() CreatedDate,2 ModifiedBy,GETDATE() ModifiedDate
WHERE NOT EXISTS(SELECT * FROM ZnodeImportTemplateMapping WHERE ImportTemplateId=(select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'CatalogCategoryAssociationTemplate') 
	AND SourceColumnName ='ParentCode')

INSERT ZnodeImportTemplateMapping(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'CatalogCategoryAssociationTemplate'),
'CategoryCode' SourceColumnName,'CategoryCode' TargetColumnName,0 DisplayOrder,1 IsActive, 0 IsAllowNull,2 CreatedBy,GETDATE() CreatedDate,2 ModifiedBy,GETDATE() ModifiedDate
WHERE NOT EXISTS(SELECT * FROM ZnodeImportTemplateMapping WHERE ImportTemplateId=(select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'CatalogCategoryAssociationTemplate') 
	AND SourceColumnName ='CategoryCode')

INSERT ZnodeImportTemplateMapping(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'CatalogCategoryAssociationTemplate'),
'DisplayOrder' SourceColumnName,'DisplayOrder' TargetColumnName,0 DisplayOrder,1 IsActive, 0 IsAllowNull,2 CreatedBy,GETDATE() CreatedDate,2 ModifiedBy,GETDATE() ModifiedDate
WHERE NOT EXISTS(SELECT * FROM ZnodeImportTemplateMapping WHERE ImportTemplateId=(select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'CatalogCategoryAssociationTemplate') 
	AND SourceColumnName ='DisplayOrder')

INSERT ZnodeImportTemplateMapping(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'CatalogCategoryAssociationTemplate'),
'Action' SourceColumnName,'Action' TargetColumnName,0 DisplayOrder,1 IsActive, 0 IsAllowNull,2 CreatedBy,GETDATE() CreatedDate,2 ModifiedBy,GETDATE() ModifiedDate
WHERE NOT EXISTS(SELECT * FROM ZnodeImportTemplateMapping WHERE ImportTemplateId=(select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'CatalogCategoryAssociationTemplate') 
	AND SourceColumnName ='Action')



insert into ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
select 'Text','ParentCode',(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'CatalogCategoryAssociation'),0,'Text','RegularExpression',
null,'','',null,2,getdate(),2,getdate(),1
where not exists(select * from ZnodeImportAttributeValidation where AttributeTypeName ='Text' and AttributeCode = 'ParentCode' 
      and ControlName = 'Text' and ImportHeadId=(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'CatalogCategoryAssociation')
	  and ValidationName = 'RegularExpression')

insert into ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
select 'Text','CategoryCode',(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'CatalogCategoryAssociation'),0,'Text','RegularExpression',
null,'','',null,2,getdate(),2,getdate(),2
where not exists(select * from ZnodeImportAttributeValidation where AttributeTypeName ='Text' and AttributeCode = 'CategoryCode' 
      and ControlName = 'Text' and ImportHeadId=(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'CatalogCategoryAssociation')
	  and ValidationName = 'RegularExpression')

insert into ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
select 'Number','DisplayOrder',(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'CatalogCategoryAssociation'),0,'Yes/No','AllowNegative',
null,'false','',null,2,getdate(),2,getdate(),3
where not exists(select * from ZnodeImportAttributeValidation where AttributeTypeName ='Number' and AttributeCode = 'DisplayOrder' 
      and ControlName = 'Yes/No' and ImportHeadId=(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'CatalogCategoryAssociation')
	  and ValidationName = 'AllowNegative')

insert into ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
select 'Number','DisplayOrder',(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'CatalogCategoryAssociation'),0,'Yes/No','AllowDecimals',
null,'false','',null,2,getdate(),2,getdate(),3
where not exists(select * from ZnodeImportAttributeValidation where AttributeTypeName ='Number' and AttributeCode = 'DisplayOrder' 
      and ControlName = 'Yes/No' and ImportHeadId=(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'CatalogCategoryAssociation')
	  and ValidationName = 'AllowDecimals')

insert into ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
select 'Number','DisplayOrder',(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'CatalogCategoryAssociation'),0,'Number','MinNumber',
null,'0','',null,2,getdate(),2,getdate(),3
where not exists(select * from ZnodeImportAttributeValidation where AttributeTypeName ='Number' and AttributeCode = 'DisplayOrder' 
      and ControlName = 'Number' and ImportHeadId=(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'CatalogCategoryAssociation')
	  and ValidationName = 'MinNumber')

insert into ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
select 'Number','DisplayOrder',(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'CatalogCategoryAssociation'),0,'Number','MaxNumber',
null,'999999','',null,2,getdate(),2,getdate(),3
where not exists(select * from ZnodeImportAttributeValidation where AttributeTypeName ='Number' and AttributeCode = 'DisplayOrder' 
      and ControlName = 'Number' and ImportHeadId=(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'CatalogCategoryAssociation')
	  and ValidationName = 'MaxNumber')

insert into ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
select 'Text','Action',(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'CatalogCategoryAssociation'),0,'Text','RegularExpression',
null,'','',null,2,getdate(),2,getdate(),4
where not exists(select * from ZnodeImportAttributeValidation where AttributeTypeName ='Text' and AttributeCode = 'Action' 
      and ControlName = 'Text' and ImportHeadId=(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'CatalogCategoryAssociation')
	  and ValidationName = 'RegularExpression')
GO

insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 122,'Text','Invalid input, to associate/disassociate parent category, the input must only be added to the Category Code and Parent Code should be empty.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 122)

insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 123,'Text','Invalid input, the same category cannot be added as the parent as well as the child category.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 123)

insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 124,'Text','Invalid input, multiple separators without category code is not allowed.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 124)

insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 125,'Text','Input value must either be Add or Delete.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 125)
GO
insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 126,'Text','Invalid input, parent category association is required.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 126)
GO
insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 127,'Text','Input must be available as a Category Code saved against any existing Category.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 127)

GO

IF EXISTS (SELECT *  FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'FK_ZnodeProductFeed_ZnodeProductFeedPriority1')
	AND parent_object_id = OBJECT_ID(N'dbo.ZnodeProductFeed'))
BEGIN
	ALTER TABLE [dbo].[ZnodeProductFeed] DROP CONSTRAINT [FK_ZnodeProductFeed_ZnodeProductFeedPriority1]
END

GO

IF EXISTS (SELECT *  FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'FK_ZnodeProductFeed_ZnodeProductFeedTimeStamp')
	AND parent_object_id = OBJECT_ID(N'dbo.ZnodeProductFeed'))
BEGIN
	ALTER TABLE [dbo].[ZnodeProductFeed] DROP CONSTRAINT [FK_ZnodeProductFeed_ZnodeProductFeedTimeStamp]
END

GO

IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodeProductFeed' AND COLUMN_NAME = 'ProductFeedTimeStampId')
BEGIN
    ALTER TABLE ZnodeProductFeed DROP COLUMN ProductFeedTimeStampId
END

GO

IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodeProductFeed' AND COLUMN_NAME = 'ProductFeedPriorityId')
BEGIN
    ALTER TABLE ZnodeProductFeed DROP COLUMN ProductFeedPriorityId
END

GO

IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodeProductFeed' AND COLUMN_NAME = 'Stores')
BEGIN
    ALTER TABLE ZnodeProductFeed DROP COLUMN Stores
END

GO

IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodeProductFeed' AND COLUMN_NAME = 'Date')
BEGIN
    ALTER TABLE ZnodeProductFeed DROP COLUMN [Date]
END
	
GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'PortalId' AND Object_ID = Object_ID(N'dbo.ZnodeProductFeed'))
BEGIN
	ALTER TABLE ZnodeProductFeed ADD [PortalId] INT NOT NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'FileCount' AND Object_ID = Object_ID(N'dbo.ZnodeProductFeed'))
BEGIN
	ALTER TABLE ZnodeProductFeed ADD [FileCount] INT NOT NULL;
END

GO

IF NOT EXISTS (SELECT *  FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'FK_ZnodeProductFeed_ZnodePortal')
	AND parent_object_id = OBJECT_ID(N'dbo.ZnodeProductFeed'))
BEGIN
	ALTER TABLE [dbo].[ZnodeProductFeed] ADD CONSTRAINT [FK_ZnodeProductFeed_ZnodePortal] FOREIGN KEY ([PortalId]) REFERENCES [dbo].[ZnodePortal] ([PortalId])
END

GO

IF EXISTS(SELECT * FROM SYS.TABLES WHERE NAME = 'ZnodeProductFeedPriority')
BEGIN
	DROP TABLE ZnodeProductFeedPriority;
END

GO

IF EXISTS(SELECT * FROM SYS.TABLES WHERE NAME = 'ZnodeProductFeedTimeStamp')
BEGIN
	DROP TABLE ZnodeProductFeedTimeStamp;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeletePortalByPortalId')
	DROP PROC Znode_DeletePortalByPortalId
GO

CREATE PROCEDURE [dbo].[Znode_DeletePortalByPortalId]
(
	 @PortalId	varchar(2000) = '' ,
	 @StoreCode varchar(2000) = '',
	 @Status	bit OUT
)
AS
	/*
	 Summary : This Procedure Is Used to delete the all records of portal if order is not place against portal  
	 --Unit Testing   
	 BEGIN TRANSACTION 
	 DECLARE @Status    BIT = 0
	 EXEC Znode_DeletePortalByPortalId @PortalId = '1,7,8', @Status   = @Status   OUT
	 SELECT @Status   
	 ROLLBACK TRANSACTION

	*/
BEGIN
	BEGIN TRAN DeletePortalByPortalId;
	BEGIN TRY
		SET NOCOUNT ON;

		--SET @PortalId = (SELECT PortalId FROM ZnodePortal ZP  )

		DECLARE @TBL_PortalIds TABLE
		( 
								 PortalId int
		);
		DECLARE @TBL_Promotion TABLE
		( 
								 PromotionId int
		);
		DECLARE @TBL_DeletedUsers TABLE (AspNetUserId NVARCHAR(1000))

		DECLARE @TBL_DeletedZnodeUsers TABLE (UserId NVARCHAR(1000))

		DECLARE @DeletedIds varchar(max)= '';
		-- inserting PortalIds which are not present in Order and Quote

		
		INSERT INTO @TBL_PortalIds 
		SELECT PortalId FROM ZnodePortal ZP
		WHERE CASE WHEN @StoreCode = '' THEN CAST(PortalId AS NVARCHAR(2000)) ELSE StoreCode END IN (

		SELECT Item FROM dbo.Split( CASE WHEN @StoreCode = '' THEN @PortalId ELSE @StoreCode END, ',' ) AS SP ) 
		AND NOT EXISTS ( SELECT TOP 1 1 FROM ZnodeOmsOrderDetails AS ZOD WHERE ZOD.PortalId = ZP.PortalId) 
	
		DELETE FROM dbo.ZnodeRobotsTxt WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeRobotsTxt.PortalId)

		DELETE FROM dbo.ZnodePortalPixelTracking WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalPixelTracking.PortalId)

		DELETE ZOH
		FROM ZnodeOmsQuotePersonalizeItem ZOH
		INNER JOIN ZnodeOmsQuoteLineItem ZOM ON ZOH.OmsQuoteLineItemId = ZOM.OmsQuoteLineItemId
		WHERE EXISTS (SELECT TOP 1 1 FROM  ZnodeOmsQuote ZOQ  
										WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZOQ.PortalId) AND ZOQ.OmsQuoteId = ZOM.OmsQuoteId )

		DELETE ZOH
		FROM ZnodeOmsHistory ZOH
		INNER JOIN ZnodeOmsNotes ZOM ON ZOH.OmsNotesId = ZOM.OmsNotesId
		WHERE EXISTS (SELECT TOP 1 1 FROM  ZnodeOmsQuote ZOQ  
										WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZOQ.PortalId) AND ZOQ.OmsQuoteId = ZOM.OmsQuoteId )

		DELETE FROM ZnodeOmsQuoteLineItem WHERE EXISTS (SELECT TOP 1 1 FROM  ZnodeOmsQuote ZOQ  
										WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZOQ.PortalId) AND ZOQ.OmsQuoteId = ZnodeOmsQuoteLineItem.OmsQuoteId )

		DELETE FROM ZnodeOmsNotes WHERE EXISTS (SELECT TOP 1 1 FROM  ZnodeOmsQuote ZOQ  
																	WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZOQ.PortalId) AND ZOQ.OmsQuoteId = ZnodeOmsNotes.OmsQuoteId )

		DELETE FROM ZnodeOmsQuote WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeOmsQuote.PortalId);

	     DELETE FROM  ZnodeCustomPortalDetail  WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCustomPortalDetail.PortalId);
	     DELETE FROM  ZnodeSupplier WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeSupplier.PortalId)

	     DELETE FROM  ZnodeOmsTemplateLineItem  WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP INNER JOIN ZnodeOmsTemplate ZOT ON 
	     TBP.PortalId = ZOT.PortalId AND ZOT.OmsTemplateId = ZnodeOmsTemplateLineItem.OmsTemplateId);

	     DELETE FROM ZnodeOmsTemplate WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeOmsTemplate.PortalId);
	     DELETE FROM  ZnodeOmsUsersReferralUrl WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeOmsUsersReferralUrl.PortalId)

		DELETE FROM ZnodePortalShipping WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalShipping.PortalId);
		DELETE FROM ZnodePortalTaxClass WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalTaxClass.PortalId);
		DELETE FROM ZnodePortalPaymentSetting WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalPaymentSetting.PortalId);
		DELETE FROM ZnodeCMSPortalMessageKeyTag WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSPortalMessageKeyTag.PortalId);
		DELETE FROM ZnodePortalProfile WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalProfile.PortalId);
		DELETE FROM ZnodePortalFeatureMapper WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalFeatureMapper.PortalId);
		DELETE FROM ZnodePortalShippingDetails WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalShippingDetails.PortalId);
		DELETE FROM ZnodePortalUnit WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalUnit.PortalId);
		DELETE FROM ZnodeDomain WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeDomain.PortalId);
		DELETE FROM ZnodePortalSmtpSetting WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalSmtpSetting.PortalId);
		DELETE FROM ZnodeActivityLog WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeActivityLog.PortalId);
		DELETE FROM ZnodePortalCatalog WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalCatalog.PortalId );
		DELETE FROM ZnodeCMSPortalMessage  WHERE EXISTS  ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSPortalMessage.PortalId );
		DELETE FROM ZnodeGoogleTagManager WHERE  EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeGoogleTagManager.PortalId);
		DELETE FROM ZnodeTaxRuleTypes WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeTaxRuleTypes.PortalId);
		DELETE FROM ZnodeCMSContentPagesProfile WHERE EXISTS (SELECT TOP 1 1 FROM  ZnodeCMSContentPages ZCCP  
																	WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZCCP.PortalId) AND ZCCP.CMSContentPagesId = ZnodeCMSContentPagesProfile.CMSContentPagesId )
		DELETE FROM ZnodeCMSContentPageGroupMapping WHERE EXISTS (SELECT TOP 1 1 FROM  ZnodeCMSContentPages ZCCP  
																	WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZCCP.PortalId) AND ZCCP.CMSContentPagesId = ZnodeCMSContentPageGroupMapping.CMSContentPagesId )
	     DELETE FROM ZnodeCMSContentPagesLocale WHERE EXISTS (SELECT TOP 1 1 FROM  ZnodeCMSContentPages ZCCP  
																	WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZCCP.PortalId) AND ZCCP.CMSContentPagesId = ZnodeCMSContentPagesLocale.CMSContentPagesId )
		DELETE FROM ZnodeFormWidgetEmailConfiguration WHERE EXISTS (SELECT TOP 1 1 FROM  ZnodeCMSContentPages ZCCP  
																	WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZCCP.PortalId) AND ZCCP.CMSContentPagesId = ZnodeFormWidgetEmailConfiguration.CMSContentPagesId )
		DELETE FROM ZnodeCMSContentPages WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSContentPages.PortalId);
		
		 DELETE FROM ZnodeCaseRequestHistory WHERE EXISTS (SELECT TOP 1 1 FROM  ZnodeCaseRequest ZCR  
			WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZCR.PortalId) AND ZCR.CaseRequestId = ZnodeCaseRequestHistory.CaseRequestId )

		 DELETE FROM ZnodeNote WHERE EXISTS (SELECT TOP 1 1 FROM  ZnodeCaseRequest ZCR  
			WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZCR.PortalId) AND ZCR.CaseRequestId = ZnodeNote.CaseRequestId )
		
		DELETE FROM ZnodeCaseRequest WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCaseRequest.PortalId);
		DELETE FROM ZnodePortalLocale WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalLocale.PortalId);
		DELETE FROM ZnodeShippingPortal WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeShippingPortal.PortalId);
		
		DELETE FROM ZnodeSalesRepCustomerUserPortal WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeSalesRepCustomerUserPortal.CustomerPortalId);

		delete from ZnodeSalesRepCustomerUserPortal 
		where exists(select * FROM ZnodeUserPortal WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeUserPortal.PortalId) and ZnodeSalesRepCustomerUserPortal.UserPortalId = ZnodeUserPortal.UserPortalId);
		
		DELETE FROM ZnodeUserPortal WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeUserPortal.PortalId);
		DELETE FROM AspNetZnodeUser OUTPUT DELETED.AspNetZnodeUserId   INTO @TBL_DeletedUsers WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = AspNetZnodeUser.PortalId )
		
	  

		DELETE FROM ZnodePortalAlternateWarehouse WHERE EXISTS ( SELECT TOP 1 1 FROM ZnodePortalWareHouse AS ZPWH WHERE EXISTS (
				SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZPWH.PortalId ) AND  ZPWH.PortalWarehouseId = ZnodePortalAlternateWarehouse.PortalWarehouseId);
		DELETE FROM ZnodePortalWareHouse WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalWareHouse.PortalId);
		DELETE ZnodePriceListPortal WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePriceListPortal.PortalId );
		
		DELETE FROM ZnodeEmailTemplateMapper WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeEmailTemplateMapper.PortalId);
		DELETE FROM ZnodeGiftCard WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeGiftCard.PortalId );
		DELETE FROM ZnodeCMSPortalProductPage WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSPortalProductPage.PortalId);

		DELETE FROM ZnodeCMSPortalSEOSetting WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSPortalSEOSetting.PortalId);

		DELETE FROM ZnodeCMSPortalTheme WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSPortalTheme.PortalId);

		DELETE FROM ZnodeCMSSEODetailLocale WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP INNER JOIN ZnodeCMSSEODetail AS zcsd ON TBP.PortalId = zcsd.PortalId WHERE zcsd.CMSSEODetailId = ZnodeCMSSEODetailLocale.CMSSEODetailId);

		DELETE FROM ZnodeCMSSEODetail WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSSEODetail.PortalId);
		DELETE FROM ZnodePortalAccount WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalAccount.PortalId);

		DELETE FROM ZnodePortalAddress WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalAddress.PortalId);

		DELETE FROM ZnodeOmsCookieMapping WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeOmsCookieMapping.PortalId);

		DELETE FROM ZnodePortalCountry WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalCountry.PortalId);

		DELETE FROM ZnodeCMSUrlRedirect WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSUrlRedirect.PortalId);

		DELETE FROM ZnodePortalCustomCss WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalCustomCss.PortalId);
		   
		/* Remove Search index */
		--DELETE FROM ZnodeSearchIndexServerStatus WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP INNER JOIN ZnodePortalIndex AS zpi ON TBP.PortalId = zpi.PortalId
		--		 INNER JOIN ZnodeSearchIndexMonitor AS zsim ON zpi.PortalIndexId = zsim.PortalIndexId WHERE zsim.SearchIndexMonitorId = ZnodeSearchIndexServerStatus.SearchIndexMonitorId);
		--DELETE FROM ZnodeSearchIndexMonitor WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP INNER JOIN ZnodePortalIndex AS zpi ON TBP.PortalId = zpi.PortalId WHERE zpi.PortalIndexId = ZnodeSearchIndexMonitor.PortalIndexId );
		--DELETE FROM ZnodePortalIndex WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalIndex.PortalId);
		/* Remove Search index */
		DELETE FROM ZnodePromotion WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePromotion.PortalId);
		DELETE FROM ZnodeTaxPortaL  WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeTaxPortaL.PortalId);

		INSERT INTO @TBL_Promotion( PromotionId ) SELECT PromotionId FROM ZnodePromotion WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePromotion.PortalId);
		DELETE FROM ZnodePromotionProduct WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_Promotion AS TBP WHERE TBP.PromotionId = ZnodePromotionProduct.PromotionId);

		DELETE FROM ZnodePromotionCategory WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_Promotion AS TBP WHERE TBP.PromotionId = ZnodePromotionCategory.PromotionId);
		DELETE FROM ZnodePromotionCatalogs WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_Promotion AS TBP WHERE TBP.PromotionId = ZnodePromotionCatalogs.PromotionId);
		DELETE FROM ZnodePromotion WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_Promotion AS TBP WHERE TBP.PromotionId = ZnodePromotion.PromotionId);

		
		DELETE FROM ZnodeBlogNewsLocale where exists (select top 1 1 from ZnodeBlogNews ZBN
													where EXISTS (SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZBN.PortalId) AND ZBN.BlogNewsId = ZnodeBlogNewsLocale.BlogNewsId )



		DELETE FROM ZnodeBlogNewsCommentLocale where exists (select top 1 1 from ZnodeBlogNewsComment ZBC
													where exists (select top 1 1 from ZnodeBlogNews ZBN
														where exists (select top 1 1 from @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZBN.PortalId) AND ZBN.BlogNewsId = ZBC.BlogNewsId ) and ZBC.BlogNewsCommentId = ZnodeBlogNewsCommentLocale.BlogNewsCommentId)
													



		DELETE FROM ZnodeBlogNewsComment WHERE EXISTS (SELECT TOP 1 1 FROM ZnodeBlogNews ZBN
													WHERE EXISTS (select top 1 1 from @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZBN.PortalId) AND ZBN.BlogNewsId = ZnodeBlogNewsComment.BlogNewsId )



		DELETE FROM ZnodeBlogNews WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeBlogNews.PortalId)

		DELETE ZFBGAVL
		FROM ZnodeFormBuilderGlobalAttributeValueLocale ZFBGAVL
		INNER JOIN ZnodeFormBuilderGlobalAttributeValue ZFBGAV ON ZFBGAVL.FormBuilderGlobalAttributeValueId = ZFBGAV.FormBuilderGlobalAttributeValueId
		WHERE EXISTS (SELECT TOP 1 1 FROM ZnodeFormBuilderSubmit ZFBS
														WHERE EXISTS (select top 1 1 from @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZFBS.PortalId) AND ZFBS.FormBuilderSubmitId = ZFBGAV.FormBuilderSubmitId )


		DELETE FROM ZnodeFormBuilderGlobalAttributeValue WHERE EXISTS (SELECT TOP 1 1 FROM ZnodeFormBuilderSubmit ZFBS
														WHERE EXISTS (select top 1 1 from @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZFBS.PortalId) AND ZFBS.FormBuilderSubmitId = ZnodeFormBuilderGlobalAttributeValue.FormBuilderSubmitId )

	DELETE FROM ZnodeFormBuilderSubmit WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeFormBuilderSubmit.PortalId)

		DELETE FROM ZnodeCaseRequestHistory WHERE EXISTS (SELECT TOP 1 1 FROM  ZnodeCaseRequest ZCR  
	WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZCR.PortalId) AND ZCR.CaseRequestId = ZnodeCaseRequestHistory.CaseRequestId )

		DELETE FROM ZnodeNote WHERE EXISTS (SELECT TOP 1 1 FROM  ZnodeCaseRequest ZCR  
	WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZCR.PortalId) AND ZCR.CaseRequestId = ZnodeNote.CaseRequestId )

	DECLARE @DeleteUserId VARCHAR(MAX)
	  SET @DeleteUserId = SUBSTRING((SELECT TOP 100 ','+CAST(UserId AS VARCHAR(2000)) FROM ZnodeUser WHERE EXISTS 
					(SELECT TOP 1 1 FROM AspNetUsers ANU WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_DeletedUsers TBDU WHERE ANU.UserName = TBDU.AspNetUserId) AND ZnodeUser.AspNetUserId = ANU.Id) 
					FOR XML PATH('')), 2, 4000);
		
		DELETE FROM ZnodePortalRecommendationSetting  
		WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalRecommendationSetting.PortalId);

		DELETE FROM ZnodePortalPageSetting  
		WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalPageSetting.PortalId);

		DELETE FROM ZnodePortalSortSetting  
		WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalSortSetting.PortalId);

	    EXEC Znode_DeleteUserDetails @UserId = @DeleteUserId, @Status = 0,  @IsCallInternal = 1 

		DELETE FROM ZnodeProductFeed  
		WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeProductFeed.PortalId);

		DELETE FROM ZnodePortal WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortal.PortalId);
		
			IF (SELECT Count(1) FROM @TBL_PortalIds) = (SELECT Count(1) FROM dbo.Split( CASE WHEN @StoreCode = '' THEN @PortalId ELSE @StoreCode END, ',' ) )	 	
			BEGIN 		
			SELECT 1 AS ID, CAST(1 AS bit) AS Status;
			SET @Status = 1;
			END
		 
		ELSE 
			BEGIN 
			SELECT 0 AS ID, CAST(0 AS bit) AS Status;
			SET @Status = 0;
			END 
		
		

		COMMIT TRAN DeletePortalByPortalId;
	END TRY
	BEGIN CATCH
	
		 
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
			 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeletePortalByPortalId @PortalId = '+ISNULL(@PortalId,'''''')+',@StoreCode = '+ISNULL(@StoreCode,'''''')+',@Status='+ISNULL(CAST(@Status AS VARCHAR(10)),'''');
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		     ROLLBACK TRAN DeletePortalByPortalId;
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_DeletePortalByPortalId',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeletePortalByStoreCode')
	DROP PROC Znode_DeletePortalByStoreCode
GO

CREATE  PROCEDURE [dbo].[Znode_DeletePortalByStoreCode]
(
	 @PortalId	varchar(2000)
	,@Status	bit OUT)
AS
	/*
	 Summary : This Procedure Is Used to delete the all records of portal if order is not place against portal  
	 --Unit Testing   
	 BEGIN TRANSACTION 
	 DECLARE @Status    BIT = 0
	 EXEC Znode_DeletePortalByPortalId @PortalId = 36, @Status   = @Status   OUT
	 SELECT @Status   
	 ROLLBACK TRANSACTION
	*/
BEGIN
	BEGIN TRAN DeletePortalByPortalId;
	BEGIN TRY
		SET NOCOUNT ON;
		DECLARE @TBL_PortalIds TABLE
		( 
								 PortalId int
		);
		DECLARE @TBL_Promotion TABLE
		( 
								 PromotionId int
		);
		DECLARE @TBL_DeletedUsers TABLE (AspNetUserId NVARCHAR(1000))

		DECLARE @DeletedIds varchar(max)= '';
		-- inserting PortalIds which are not present in Order and Quote

		INSERT INTO @TBL_PortalIds 
		SELECT Item FROM dbo.Split( @PortalId, ',' ) AS SP 
		WHERE NOT EXISTS ( SELECT TOP 1 1 FROM ZnodeOmsOrderDetails AS ZOD WHERE ZOD.PortalId = Sp.Item) 
		AND  NOT EXISTS (SELECT TOP 1 1 FROM ZnodeOmsQuote AS ZOQ WHERE ZOQ.PortalId = Sp.Item );


	     DELETE FROM  ZnodeCustomPortalDetail  WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCustomPortalDetail.PortalId);
	     DELETE FROM  ZnodeSupplier WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeSupplier.PortalId)

	     DELETE FROM  ZnodeOmsTemplateLineItem  WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP INNER JOIN ZnodeOmsTemplate ZOT ON 
	     TBP.PortalId = ZOT.PortalId AND ZOT.OmsTemplateId = ZnodeOmsTemplateLineItem.OmsTemplateId);

	     DELETE FROM ZnodeOmsTemplate WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeOmsTemplate.PortalId);
	     DELETE FROM  ZnodeOmsUsersReferralUrl WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeOmsUsersReferralUrl.PortalId)

		DELETE FROM ZnodePortalShipping WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalShipping.PortalId);
		DELETE FROM ZnodePortalTaxClass WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalTaxClass.PortalId);
		DELETE FROM ZnodePortalPaymentSetting WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalPaymentSetting.PortalId);
		DELETE FROM ZnodeCMSPortalMessageKeyTag WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSPortalMessageKeyTag.PortalId);
		DELETE FROM ZnodePortalProfile WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalProfile.PortalId);
		DELETE FROM ZnodePortalFeatureMapper WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalFeatureMapper.PortalId);
		DELETE FROM ZnodePortalShippingDetails WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalShippingDetails.PortalId);
		DELETE FROM ZnodePortalUnit WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalUnit.PortalId);
		DELETE FROM ZnodeDomain WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeDomain.PortalId);
		DELETE FROM ZnodePortalSmtpSetting WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalSmtpSetting.PortalId);
		DELETE FROM ZnodeActivityLog WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeActivityLog.PortalId);
		DELETE FROM ZnodePortalCatalog WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalCatalog.PortalId );
		DELETE FROM ZnodeCMSPortalMessage  WHERE EXISTS  ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSPortalMessage.PortalId );
		--DELETE FROM ZnodeTaxRule WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeTaxRule.PortalId);
		DELETE FROM ZnodeGoogleTagManager WHERE  EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeGoogleTagManager.PortalId);
		DELETE FROM ZnodeTaxRuleTypes WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeTaxRuleTypes.PortalId);
		DELETE FROM ZnodeCMSContentPagesProfile WHERE EXISTS (SELECT TOP 1 1 FROM  ZnodeCMSContentPages ZCCP  
																	WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZCCP.PortalId) AND ZCCP.CMSContentPagesId = ZnodeCMSContentPagesProfile.CMSContentPagesId )
		DELETE FROM ZnodeCMSContentPageGroupMapping WHERE EXISTS (SELECT TOP 1 1 FROM  ZnodeCMSContentPages ZCCP  
																	WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZCCP.PortalId) AND ZCCP.CMSContentPagesId = ZnodeCMSContentPageGroupMapping.CMSContentPagesId )
	     DELETE FROM ZnodeCMSContentPagesLocale WHERE EXISTS (SELECT TOP 1 1 FROM  ZnodeCMSContentPages ZCCP  
																	WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZCCP.PortalId) AND ZCCP.CMSContentPagesId = ZnodeCMSContentPagesLocale.CMSContentPagesId )
		DELETE FROM ZnodeCMSContentPages WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSContentPages.PortalId);
		DELETE FROM ZnodeCaseRequest WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCaseRequest.PortalId);
		DELETE FROM ZnodePortalLocale WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalLocale.PortalId);
		DELETE FROM ZnodeShippingPortal WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeShippingPortal.PortalId);
		
		DELETE FROM ZnodeSalesRepCustomerUserPortal WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeSalesRepCustomerUserPortal.CustomerPortalId);

		delete from ZnodeSalesRepCustomerUserPortal 
		where exists(select * FROM ZnodeUserPortal WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeUserPortal.PortalId) and ZnodeSalesRepCustomerUserPortal.UserPortalId = ZnodeUserPortal.UserPortalId);
		
		DELETE FROM ZnodeUserPortal WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeUserPortal.PortalId);
		DELETE FROM AspNetZnodeUser OUTPUT DELETED.AspNetZnodeUserId   INTO @TBL_DeletedUsers WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = AspNetZnodeUser.PortalId )
		
		DELETE FROM ZnodePortalAlternateWarehouse WHERE EXISTS ( SELECT TOP 1 1 FROM ZnodePortalWareHouse AS ZPWH WHERE EXISTS (
				SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZPWH.PortalId ) AND  ZPWH.PortalWarehouseId = ZnodePortalAlternateWarehouse.PortalWarehouseId);
		DELETE FROM ZnodePortalWareHouse WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalWareHouse.PortalId);
		DELETE ZnodePriceListPortal WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePriceListPortal.PortalId );
		
		DELETE FROM ZnodeEmailTemplateMapper WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeEmailTemplateMapper.PortalId);
		DELETE FROM ZnodeGiftCard WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeGiftCard.PortalId );
		DELETE FROM ZnodeCMSPortalProductPage WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSPortalProductPage.PortalId);

		DELETE FROM ZnodeCMSPortalSEOSetting WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSPortalSEOSetting.PortalId);

		DELETE FROM ZnodeCMSPortalTheme WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSPortalTheme.PortalId);

		DELETE FROM ZnodeCMSSEODetailLocale WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP INNER JOIN ZnodeCMSSEODetail AS zcsd ON TBP.PortalId = zcsd.PortalId WHERE zcsd.CMSSEODetailId = ZnodeCMSSEODetailLocale.CMSSEODetailId);

		DELETE FROM ZnodeCMSSEODetail WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSSEODetail.PortalId);
		DELETE FROM ZnodePortalAccount WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalAccount.PortalId);

		DELETE FROM ZnodePortalAddress WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalAddress.PortalId);

		DELETE FROM ZnodeOmsCookieMapping WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeOmsCookieMapping.PortalId);

		DELETE FROM ZnodePortalCountry WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalCountry.PortalId);

		DELETE FROM ZnodeCMSUrlRedirect WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSUrlRedirect.PortalId);

		DELETE FROM ZnodePortalCustomCss WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalCustomCss.PortalId);
		   
		/* Remove Search index */
		--DELETE FROM ZnodeSearchIndexServerStatus WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP INNER JOIN ZnodePortalIndex AS zpi ON TBP.PortalId = zpi.PortalId
		--		 INNER JOIN ZnodeSearchIndexMonitor AS zsim ON zpi.PortalIndexId = zsim.PortalIndexId WHERE zsim.SearchIndexMonitorId = ZnodeSearchIndexServerStatus.SearchIndexMonitorId);
		--DELETE FROM ZnodeSearchIndexMonitor WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP INNER JOIN ZnodePortalIndex AS zpi ON TBP.PortalId = zpi.PortalId WHERE zpi.PortalIndexId = ZnodeSearchIndexMonitor.PortalIndexId );
		--DELETE FROM ZnodePortalIndex WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalIndex.PortalId);
		/* Remove Search index */
		DELETE FROM ZnodePromotion WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePromotion.PortalId);
		DELETE FROM ZnodeTaxPortaL  WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeTaxPortaL.PortalId);

		INSERT INTO @TBL_Promotion( PromotionId ) SELECT PromotionId FROM ZnodePromotion WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePromotion.PortalId);
		DELETE FROM ZnodePromotionProduct WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_Promotion AS TBP WHERE TBP.PromotionId = ZnodePromotionProduct.PromotionId);

		DELETE FROM ZnodePromotionCategory WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_Promotion AS TBP WHERE TBP.PromotionId = ZnodePromotionCategory.PromotionId);
		DELETE FROM ZnodePromotionCatalogs WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_Promotion AS TBP WHERE TBP.PromotionId = ZnodePromotionCatalogs.PromotionId);
		DELETE FROM ZnodePromotion WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_Promotion AS TBP WHERE TBP.PromotionId = ZnodePromotion.PromotionId);

		
		DELETE FROM ZnodeBlogNewsLocale where exists (select top 1 1 from ZnodeBlogNews ZBN
													where EXISTS (SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZBN.PortalId) AND ZBN.BlogNewsId = ZnodeBlogNewsLocale.BlogNewsId )



		DELETE FROM ZnodeBlogNewsCommentLocale where exists (select top 1 1 from ZnodeBlogNewsComment ZBC
													where exists (select top 1 1 from ZnodeBlogNews ZBN
														where exists (select top 1 1 from @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZBN.PortalId) AND ZBN.BlogNewsId = ZBC.BlogNewsId ) and ZBC.BlogNewsCommentId = ZnodeBlogNewsCommentLocale.BlogNewsCommentId)
													



		DELETE FROM ZnodeBlogNewsComment WHERE EXISTS (SELECT TOP 1 1 FROM ZnodeBlogNews ZBN
													WHERE EXISTS (select top 1 1 from @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZBN.PortalId) AND ZBN.BlogNewsId = ZnodeBlogNewsComment.BlogNewsId )



		DELETE FROM ZnodeBlogNews WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeBlogNews.PortalId)
		DELETE FROM ZnodePortalRecommendationSetting  
		WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalRecommendationSetting.PortalId);

		DELETE FROM ZnodePortalPageSetting  
		WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalPageSetting.PortalId);

		DELETE FROM ZnodePortalSortSetting  
		WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalSortSetting.PortalId);

		DELETE FROM ZnodeProductFeed  WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeProductFeed.PortalId);

		DELETE FROM ZnodePortal WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortal.PortalId);

		IF (SELECT Count(1) FROM @TBL_PortalIds) = (SELECT Count(1) FROM dbo.Split( @PortalId, ',' ) )
		BEGIN 
		SELECT 1 AS ID, CAST(1 AS bit) AS Status;
		SET @Status = 1;
		END 
		ELSE 
		BEGIN 
		SELECT 0 AS ID, CAST(0 AS bit) AS Status;
		SET @Status = 0;

		END 
		COMMIT TRAN DeletePortalByPortalId;
	END TRY
	BEGIN CATCH
		 
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeletePortalByPortalId @PortalId = '+@PortalId+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		     ROLLBACK TRAN DeletePortalByPortalId;
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_DeletePortalByPortalId',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetProductFeedDetailsList')
	DROP PROC Znode_GetProductFeedDetailsList
GO


CREATE PROCEDURE [dbo].[Znode_GetProductFeedDetailsList]
(
	@WhereClause NVARCHAR(MAX),
    @Rows        INT           = 100,
    @PageNo      INT           = 1,
    @Order_BY    VARCHAR(100)  = '',
    @RowsCount   INT OUT
)
AS 
/*
	 Summary :- This Procedure is used to get the publish status of the catalog 
	 Unit Testig 
	 EXEC  Znode_GetProductFeedDetailsList '',100,1,'',0

*/
   BEGIN 
		BEGIN TRY 
		SET NOCOUNT ON 

		 DECLARE @SQL  NVARCHAR(max) 
		 DECLARE @TBL_ProductFeed TABLE (ProductFeedId int, ProductFeedTypeName VARCHAR(300),FileName VARCHAR(300),RowId INT, CountId INT, CreatedDate DATETIME, ModifiedDate DATETIME, StoreName NVARCHAR(100))
	 
		 SET @SQL = '
		;With Cte_ProductFeed AS (
		SELECT ZPCL.ProductFeedId, 
		ZPFT.ProductFeedTypeName ProductFeedTypeName, ZPCL.FileName FileName,
		ZPCL.CreatedDate,ZPCL.ModifiedDate,ZP.StoreName
		FROM
		ZnodeProductFeed ZPCL
		INNER JOIN ZnodeProductFeedType ZPFT ON ZPFT.ProductFeedTypeId = ZPCL.ProductFeedTypeId
		Inner join ZnodePortal ZP on ZP.PortalId = ZPCL.PortalId
		)
	 
	     ,Cte_PublishFeedStatus 
		 AS (
		 SELECT ProductFeedId,ProductFeedTypeName,FileName,CreatedDate,ModifiedDate,StoreName,
		 '+[dbo].[Fn_GetPagingRowId](@Order_BY,'ProductFeedId DESC')+' , Count(*)Over() CountId FROM Cte_ProductFeed
         WHERE 1=1 '+[dbo].[Fn_GetFilterWhereClause](@WhereClause)+' )
	 
		 SELECT ProductFeedId,ProductFeedTypeName,FileName,RowId,CountId,CreatedDate,ModifiedDate,StoreName
		 FROM Cte_PublishFeedStatus 
		 '+[dbo].[Fn_GetPaginationWhereClause](@PageNo,@Rows)+' '
	
		 INSERT INTO @TBL_ProductFeed 
		 EXEC (@SQL)

		 SELECT  ProductFeedId,ProductFeedTypeName, FileName,CreatedDate,ModifiedDate,StoreName
		 FROM @TBL_ProductFeed

		 SET @RowsCount = ISNULL((SELECT TOP 1 COUNTID FROM @TBL_ProductFeed),0)
	 
		 END TRY 
		 BEGIN CATCH 
			DECLARE @Status BIT ;
			SET @Status = 0;
			DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetProductFeedDetailsList @WhereClause = '+@WhereClause+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
			SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
			EXEC Znode_InsertProcedureErrorLog
					@ProcedureName = 'Znode_GetProductFeedDetailsList',
					@ErrorInProcedure = @Error_procedure,
					@ErrorMessage = @ErrorMessage,
					@ErrorLine = @ErrorLine,
					@ErrorCall = @ErrorCall;
		 END CATCH 
   END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PurgeData')
	DROP PROC Znode_PurgeData
GO

CREATE PROCEDURE [dbo].[Znode_PurgeData] 
(
 
  @DeleteAllProduct    							BIT = 0 -- This flag 1 will delete all product except ids in @ExceptProductId  table 
 ,@DeleteAllCategory							BIT = 0 -- This flag 1 will delete all category except ids in @ExceptCategoryId  table 
 ,@DeleteAllCatalog								BIT = 0 -- This flag 1 will delete all catalog except ids in @ExceptCatalogId  table 
 ,@DeleteAllSaveCart							Bit = 0	-- This flag 1 will delete all save carts of users.  
 ,@DeleteAllOrder								BIT = 0	-- This flag 1 will delete all orders. 
 ,@DeleteAllAccount								BIT = 0 -- This flag 1 will delete all Account. 
 ,@DeleteAllUser								BIT = 0 -- This flag 1 will delete all user. 
 ,@DeleteAllStore 								BIT = 0 -- This flag 1 will delete all store. 
 ,@DeleteAllGlobalAttribute  					BIT = 0 -- This flag 1 will delete all Global Attribute. 
 ,@DeleteAllProductCategoryAttribute			BIT = 0 -- This flag 1 will delete all Pim Attribute. 
 ,@DeleteAllMedia								BIT = 0 -- This flag 1 will delete all media. 
 ,@DeleteAllWarehouse							BIT = 0 -- This flag 1 will delete all warhouse. 
 ,@DeleteAllPricelist							BIT = 0 -- This flag 1 will delete all price list. 
 ,@DeleteAllProfile								BIT = 0 -- This flag 1 will delete all Profiles. 
 ,@DeleteAllSiteSearchData						BIT = 0	-- This flag 1 will delete all data related to search. 
 ,@DeleteAllCMSData								BIT = 0 -- This flag 1 will delete all CMS data. 
 ,@DeleteAllBrand								BIT = 0 -- This flag 1 will delete all brand. 
 ,@DeleteAllVendor								BIT = 0 -- This flag 1 will delete all vendor. 
 ,@DeleteAllCmsSeoDetails						BIT = 0 -- This flag 1 will delete all Seo details .   
 ,@ResetDomainData								BIT = 0 -- This flag 1 will delete and rest all domain. 
 ,@ExceptProductId								TransferId Readonly
 ,@ExceptCategoryId								TransferId Readonly
 ,@ExceptCatalogId								TransferId Readonly
 ,@ExceptAccountId								TransferId Readonly
 ,@ExceptUserId 								TransferId Readonly
 ,@ExceptStoreId 								TransferId Readonly 
 ,@ExceptGlobalAttributeId 						TransferId Readonly
 ,@ExceptProductCategoryAttributeId 		    TransferId Readonly
 ,@ExceptMediaId								TransferId Readonly
 ,@ExceptWarehouseId							TransferId ReadOnly 
 ,@ExceptPricelistId							TransferId ReadOnly 
 ,@ExceptProfileId								TransferId ReadOnly
 ,@ExceptSeoType								VARCHAR(2000) = ''
 ,@ResetIdentity								BIT = 0    -- Reset identity 
 ,@DeleteAllData								BIT = 0 	
 ,@DeleteAllShippingMethods						BIT = 0 
 ,@DeleteAllPaymentMethods						BIT = 0 
 ,@DeleteAllTaxes								BIT = 0 
 ,@DeleteAllPublishedData BIT = 0
)
AS 
BEGIN 
SET NOCOUNT ON 
 	 BEGIN TRY
	    DECLARE @StatusOut Table (Id INT ,Message NVARCHAR(max), Status BIT )
		DECLARE @DeletedIds TransferId 
		DECLARE @PortalId INT , @CMSThemeId INT , @CMSThemeCSSId INT,@PublishCatalogId INT
		,@PimCatalogId INT  

		----Delete all published data
		IF @DeleteAllPublishedData = 1 OR @DeleteAllData =1 
		BEGIN	

			EXECUTE [Znode_DeleteAllPublishedData] @UserId = 2

		END

		DELETE FROM @DeletedIds DELETE FROM @StatusOut 
		IF  Object_Id('elmah_error')	 <> 0 
		BEGIN 
			 TRUNCATE TABLE elmah_error
			 DELETE FROM ZnodeImportLog
			 DELETE FROM ZnodeImportProcesslog
			 DELETE FROM ZnodeActivityLog	
             DELETE FROM ZnodePasswordLog	
             DELETE FROM ZnodeProceduresErrorLog
		END 
	
		DECLARE @DeleteId  NVARCHAR(max)= '', @StoreData NVARCHAR(max),@RunTime INT =1 
		DELETE FROM @DeletedIds DELETE FROM @StatusOut 
		IF  @DeleteAllVendor = 1   OR @DeleteAllData =1 
			BEGIN 
			 	INSERT INTO @DeletedIds 
				SELECT PimVendorId 
				FROM ZnodePimVendor ZP 
							
				INSERT INTO @StatusOut(id ,Status) 
				EXEC [dbo].[Znode_DeleteVendor] @PimVendorIds = @DeletedIds ,@Status = 0  
			    
				DELETE FROM ZnodePimProductAttributeDefaultValue WHERE PimAttributeValueId IN (
				SELECT PimAttributeValueId  
				FROM ZnodePimAttributeValue WHERE PimAttributeId = (SELECT PimAttributeId FROM ZnodePimAttribute WHERE AttributeCode= 'Vendor') )
				
				DELETE FROM ZnodePimAttributeValue WHERE PimAttributeId = (SELECT PimAttributeId FROM ZnodePimAttribute WHERE AttributeCode= 'Vendor') 

				DELETE FROM ZnodePimAttributeDefaultValueLocale  WHERE PimAttributeDefaultValueId IN (
				SELECT PimAttributeDefaultValueId FROM ZnodePimAttributeDefaultValue WHERE AttributeDefaultValueCode IN (SELECT VendorCode FROM ZnodePimVendor ))
				
				DELETE FROM  ZnodePimAttributeDefaultValue WHERE AttributeDefaultValueCode IN (SELECT VendorCode FROM ZnodePimVendor )

			    PRINT '<-- Vendor Data Deleted Sucessfully-->'
				
			END
			DELETE FROM @DeletedIds DELETE FROM @StatusOut 
			IF  @DeleteAllBrand = 1  OR @DeleteAllData =1 
			BEGIN 
			   INSERT INTO @DeletedIds 
			   SELECT BrandId
			   FROM ZnodeBrandDetails a
			   INSERT INTO @StatusOut (Id ,Status) 
			   EXEC [dbo].[Znode_DeleteBrand] @BrandIds = @DeletedIds, @Status = 0   
			 IF  EXISTS (SELECT TOP 1 1  FROM @StatusOut WHERE Status = 1 )
				BEGIN 
		     	PRINT '<-- Brand Data Deleted Sucessfully-->'
			   END
			   ELSE 
				BEGIN 
				PRINT '<-- Brand Data Not Deleted Properly -->' 
				END  
		    END 
				
		DELETE FROM @DeletedIds DELETE FROM @StatusOut 
		IF  @DeleteAllProduct = 1  OR @DeleteAllData =1 
		BEGIN 
		   	 INSERT INTO @DeletedIds 
		     SELECT PimProductId 
			 FROM ZnodePimProduct ZPP 
			 WHERE NOT EXISTS (SELECT TOP 1 1 FROM @ExceptProductId WHERE id = ZPP.PimProductId) 
			  INSERT INTO @StatusOut (Id ,Status) 
			  EXEC [dbo].[Znode_DeletePimProducts] @PimProductIds=@DeletedIds , @Status = 0   
			
			SELECT PimAddonGroupId,PimProductId,PimAddOnProductId  
			INTO #Temp_Addon 
			FROM ZnodePimAddOnProduct ZPP
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM @ExceptProductId WHERE id = ZPP.PimProductId)

			DELETE FROM ZnodePimAddOnProductDetail WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Addon t 
							 WHERE t.PimAddOnProductId  = ZnodePimAddOnProductDetail.PimAddOnProductId )
			
			DELETE FROM  ZnodePimAddOnProduct  WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Addon t 
							 WHERE t.PimAddOnProductId  = ZnodePimAddOnProduct.PimAddOnProductId )
			
			DELETE FROM ZnodePimAddonGroupLocale WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Addon t 
							 WHERE t.PimAddonGroupId  = ZnodePimAddonGroupLocale.PimAddonGroupId )
			DELETE FROM ZnodePimAddonGroupProduct 	WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Addon t 
							 WHERE t.PimAddonGroupId  = ZnodePimAddonGroupProduct.PimAddonGroupId )
			DELETE FROM ZnodePimAddonGroup 	WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Addon t 
							 WHERE t.PimAddonGroupId  = ZnodePimAddonGroup.PimAddonGroupId )
			IF  EXISTS (SELECT TOP 1 1  FROM @StatusOut WHERE Status = 1 )
				BEGIN 
		     	PRINT '<-- Product Data Deleted Sucessfully-->'
			    END
			    ELSE 
				BEGIN 
				PRINT '<-- Product Data Not Deleted Properly -->' 
				END  
			  
	    END 
		DELETE FROM @DeletedIds DELETE FROM @StatusOut 
		IF  @DeleteAllCategory = 1 	  OR @DeleteAllData =1 
		BEGIN   
		   		INSERT INTO @DeletedIds 
				SELECT  PimCategoryId 
				FROM ZnodePimCategory ZPC
				WHERE NOT EXISTS  (SELECT TOP 1 1 FROM @ExceptCategoryId WHERE id =ZPC.PimCategoryId )
				--Remove extra products from catalog
				--INSERT INTO @StatusOut (Id ,Status) 

				EXEC Znode_DeletePimCategory @PimCategoryId = @DeletedIds, @Status = 1;
			
				IF  EXISTS (SELECT TOP 1 1  FROM @StatusOut WHERE Status = 1 )
				BEGIN 
		     	PRINT '<-- Category Data Deleted Sucessfully-->'
			    END
			    ELSE 
				BEGIN 
				PRINT '<-- Category Data Not Deleted Properly -->' 
				END     
		  END
		  DELETE FROM @DeletedIds DELETE FROM @StatusOut 
		  IF  @DeleteAllCatalog = 1 	OR @DeleteAllData =1 
		   BEGIN
		   	 INSERT INTO @DeletedIds 
		   	 SELECT PimCatalogId 
			 FROM ZnodePimCatalog ZP 
			 WHERE NOT EXISTS (SELECT TOP 1 1  FROM @ExceptCatalogId WHERE id = ZP.PimCatalogId)
		   	 INSERT INTO @StatusOut (Id ,Message,Status) 
			 EXEC [dbo].[Znode_DeletePimCatalog] @PimCatalogId = @DeletedIds ,@IsForceFullyDelete = 1  
		      

			 IF  EXISTS (SELECT TOP 1 1  FROM @StatusOut WHERE Status = 1 )
				BEGIN 
		     	PRINT '<-- Catalog Data Deleted Sucessfully-->'
			    END
			    ELSE 
				BEGIN 
				PRINT '<-- Catalog Data Not Deleted Properly -->' 
				END  
           END
		   DELETE FROM @DeletedIds DELETE FROM @StatusOut 
		   IF  @DeleteAllOrder = 1 	OR @DeleteAllData =1 
		   BEGIN

				--Delete return data against order
				DELETE FROM ZnodeRmaRequestItem
				DELETE FROM ZnodeRmaRequest
				DELETE FROM ZnodeRmaReturnNotes
				DELETE FROM ZnodeRmaReturnEmailHistory
				DELETE FROM ZnodeRmaReturnHistory
				DELETE FROM ZnodeRmaReturnPaymentRefund
				DELETE FROM ZnodeRmaReturnPaymentDetails
				DELETE FROM ZnodeRmaReturnLineItems
				DELETE FROM ZnodeRmaReturnDetails

				 INSERT INTO @DeletedIds 
		   		 SELECT OmsOrderID 
				 FROM ZnodeOmsOrder  ZP 
				 INSERT INTO @StatusOut (Id ,Status) 
			     EXEC [dbo].[Znode_DeleteOrderById] @OmsOrderIds = @DeletedIds , @status = 0  
		    
		        IF  EXISTS (SELECT TOP 1 1  FROM @StatusOut WHERE Status = 1 )
				BEGIN 
		     	PRINT '<-- Order Data Deleted Sucessfully-->'
			    END
			    ELSE 
				BEGIN 
				PRINT '<-- Order Data Not Deleted Properly -->' 
				END  
		  END
		
		   DELETE FROM @DeletedIds DELETE FROM @StatusOut
		   IF  @DeleteAllSaveCart = 1  OR @DeleteAllData =1 
		   BEGIN
		      DELETE FROM ZnodeOmsPersonalizeCartItem
			  DELETE FROM ZnodeOmsSavedCartLineItem 
			  DELETE FROM ZnodeOmsSavedCart
			  DELETE FROM ZnodeOmsCookieMapping
			  DELETE FROM ZnodeOmsQuotePersonalizeItem 
			  DELETE FROM ZnodeOmsQuoteLineItem
			  DELETE FROM ZnodeOmsQuote
			  DELETE FROM ZnodeOmsTemplateLineItem 
			  DELETE FROM ZnodeOmsTemplate
			 
		      PRINT '<-- Save Cart & Quote Data Deleted Sucessfully -->'
			  
		   END
		   DELETE FROM @DeletedIds DELETE FROM @StatusOut 
		   IF  @DeleteAllUser = 1 OR @DeleteAllData =1 
		   BEGIN  
		  
			   INSERT INTO @DeletedIds 
			   SELECT UserId
			   FROM ZnodeUser ZU 
			   WHERE NOT EXISTS (SELECT TOP 1  1 FROM @ExceptUserId RT WHERE RT.Id = ZU.UserId) 
			 --  INSERT INTO @StatusOut (Id ,Status) 
			   EXEC Znode_DeleteUserDetails @UserIds =@DeletedIds ,@Status = 0 , @IsForceFullyDelete =1 

			DELETE FROM AspNetUsers  WHERE NOT EXISTS (SELECT TOP 1 1 FROM AspNetZnodeUser rt WHERE rt.AspNetZnodeUserId = AspNetUsers.UserName )

		     	PRINT '<-- User Data Deleted Sucessfully-->'
			  
		   END
	    DELETE FROM @DeletedIds DELETE FROM @StatusOut 
		IF  @DeleteAllAccount = 1 	OR @DeleteAllData =1 
		  BEGIN    
				 INSERT INTO @DeletedIds 
				  SELECT AccountId
			      FROM ZnodeAccount ZU 
			      WHERE NOT EXISTS (SELECT TOP 1  1 FROM @ExceptAccountId RT WHERE RT.Id = ZU.AccountiD) 
			    -- INSERT INTO @StatusOut (Id ,Status) 
				  EXEC Znode_DeleteAccount @AccountIds =  @DeletedIds,@Status= 0,@IsForceFullyDelete =1  
				 
		     	PRINT '<-- Accouts Data Deleted Sucessfully-->'
			    
		  END
		 DELETE FROM @DeletedIds DELETE FROM @StatusOut 
		 IF  @DeleteAllGlobalAttribute = 1 	 OR @DeleteAllData =1 
		   BEGIN 
		   	INSERT INTO @DeletedIds 
			SELECT GlobalAttributeId 
			FROM ZnodeGlobalAttribute ZP 
			WHERE NOT EXISTS (SELECT TOP 1 1  FROM @ExceptGlobalAttributeId a WHERE a.Id = ZP.GlobalAttributeId)
			AND ISNULL(ZP.IsSystemDefined,0) <> 1
			--INSERT INTO @StatusOut (Id ,Status) 	   
			EXEC [dbo].[Znode_DeleteGlobalAttribute] @GlobalAttributeIds= @DeletedIds,@Status =0 , 	@IsForceFullyDelete= 1    
			
			DELETE FROM ZnodeGlobalFamilyGroupMapper WHERE GlobalAttributeGroupId IN  (SELECT GlobalAttributeGroupId  FROM ZnodeGlobalAttributeGroup WHERE IsSystemDefined <> 1 )
			DELETE FROM ZnodeGlobalAttributeGroupLocale	WHERE GlobalAttributeGroupId IN  (SELECT GlobalAttributeGroupId  FROM ZnodeGlobalAttributeGroup WHERE IsSystemDefined <> 1 )
			DELETE FROM ZnodeGlobalAttributeGroupMapper WHERE GlobalAttributeGroupId IN  (SELECT GlobalAttributeGroupId  FROM ZnodeGlobalAttributeGroup WHERE IsSystemDefined <> 1)
			DELETE FROM ZnodeGlobalGroupEntityMapper WHERE GlobalAttributeGroupId IN  (SELECT GlobalAttributeGroupId  FROM ZnodeGlobalAttributeGroup WHERE IsSystemDefined <> 1)
			DELETE FROM ZnodeFormBuilderAttributeMapper	WHERE GlobalAttributeGroupId IN  (SELECT GlobalAttributeGroupId  FROM ZnodeGlobalAttributeGroup WHERE IsSystemDefined <> 1)
			DELETE FROM ZnodeGlobalAttributeGroup	WHERE GlobalAttributeGroupId IN  (SELECT GlobalAttributeGroupId  FROM ZnodeGlobalAttributeGroup WHERE IsSystemDefined <> 1)  

			   IF  EXISTS (SELECT TOP 1 1  FROM @StatusOut WHERE Status = 1 )
				BEGIN 
		     	PRINT '<-- Global Attribute Data Deleted Sucessfully-->'
			    END
			    ELSE 
				BEGIN 
				PRINT '<-- Global Attribute Not Deleted Properly -->' 
				END 	   
		   END  
		   DELETE FROM @DeletedIds DELETE FROM @StatusOut 
		   IF  @DeleteAllProductCategoryAttribute = 1  OR @DeleteAllData =1 
		   BEGIN 
			   	INSERT INTO @DeletedIds 
				SELECT PimAttributeId
				FROM ZnodePimAttribute ZP 
				WHERE NOT EXISTS (SELECT TOP 1 1  FROM @ExceptProductCategoryAttributeId WHERE id = ZP.PimAttributeId )
				AND ZP.IsSystemDefined <> 1 
				INSERT INTO @StatusOut (Id ,Status) 			
				EXEC Znode_DeletePimAttributeWithReference @PimAttributeIds = @DeletedIds  , @Status = 1  
			  
			    DELETE FROM ZnodePimAttributeGroupLocale 
					WHERE PimAttributeGroupId IN (SELECT PimAttributeGroupId FROM ZnodePimAttributeGroup WHERE IsSystemDefined <> 1  )
				DELETE FROM ZnodePimAttributeGroupMapper wHERE PimAttributeGroupId IN (SELECT PimAttributeGroupId FROM ZnodePimAttributeGroup WHERE IsSystemDefined <> 1  )
				DELETE FROM ZnodePimFamilyGroupMapper 
					WHERE PimAttributeGroupId IN (SELECT PimAttributeGroupId FROM ZnodePimAttributeGroup WHERE IsSystemDefined <> 1  )
				DELETE FROM ZnodePimAttributeGroup WHERE IsSystemDefined <> 1  
			
				DELETE FROM ZnodePimFamilyLocale WHERE  PimAttributeFamilyId IN (SELECT PimAttributeFamilyId FROM ZnodePimAttributeFamily WHERE IsSystemDefined <> 1  )
				UPDATE ZP SET PimAttributeFamilyId = dbo.Fn_GetDefaultPimProductFamilyId() FROM ZnodePimProduct  ZP  WHERE  PimAttributeFamilyId IN (SELECT PimAttributeFamilyId FROM ZnodePimAttributeFamily WHERE IsSystemDefined <> 1  )
				UPDATE ZP SET PimAttributeFamilyId = dbo.Fn_GetDefaultPimProductFamilyId() FROM ZnodePimCategory  ZP  WHERE  PimAttributeFamilyId IN (SELECT PimAttributeFamilyId FROM ZnodePimAttributeFamily WHERE IsSystemDefined <> 1  )
				UPDATE ZP SET PimAttributeFamilyId = dbo.Fn_GetDefaultPimProductFamilyId() FROM ZnodePimCategoryAttributeValue  ZP  WHERE  PimAttributeFamilyId IN (SELECT PimAttributeFamilyId FROM ZnodePimAttributeFamily WHERE IsSystemDefined <> 1  )
				UPDATE ZP SET PimAttributeFamilyId = dbo.Fn_GetDefaultPimProductFamilyId() FROM ZnodePimAttributeValue  ZP  WHERE  PimAttributeFamilyId IN (SELECT PimAttributeFamilyId FROM ZnodePimAttributeFamily WHERE IsSystemDefined <> 1  )

				DELETE FROM ZnodeImportTemplateMapping WHERE ImportTemplateId IN (SELECT ImportTemplateId FROM ZnodeImportTemplate WHERE PimAttributeFamilyId IN (SELECT PimAttributeFamilyId FROM ZnodePimAttributeFamily WHERE IsSystemDefined <> 1  ))
				DELETE FROM ZnodeImportTemplate WHERE PimAttributeFamilyId IN (SELECT PimAttributeFamilyId FROM ZnodePimAttributeFamily WHERE IsSystemDefined <> 1  )
				DELETE FROM ZnodePimFamilyGroupMapper 
					WHERE PimAttributeFamilyId IN (SELECT PimAttributeFamilyId FROM ZnodePimAttributeFamily WHERE IsSystemDefined <> 1  )

				DELETE  FROM ZnodePimAttributeFamily WHERE IsSystemDefined <> 1 
				UPDATE ZP SET PimAttributeFamilyId = dbo.Fn_GetDefaultPimProductFamilyId() FROM ZnodePimAttributeValue  ZP  WHERE  PimAttributeFamilyId IN (SELECT PimAttributeFamilyId FROM ZnodePimAttributeFamily WHERE IsSystemDefined <> 1  ) 
			   	IF  EXISTS (SELECT TOP 1 1  FROM @StatusOut WHERE Status = 1 )
				BEGIN 
		     	PRINT '<-- PIM Attribute Data Deleted Sucessfully-->'
			    END
			    ELSE 
				BEGIN 
				PRINT '<-- PIM Attribute Not Deleted Properly -->' 
				END 
		   END
		   DELETE FROM @DeletedIds 
		   DELETE FROM @StatusOut 
		   IF  @DeleteAllMedia = 1  OR @DeleteAllData =1 
		   BEGIN 
		  		INSERT INTO @DeletedIds 
		   		SELECT  MediaId   
				FROM ZnodeMedia ZP 
				WHERE NOT EXISTS (SELECT TOP 1 1  FROM @ExceptMediaId WHERE id = ZP.Mediaid )
				--INSERT INTO @StatusOut (Id ,Message,Status)
				EXEC Znode_DeleteMedia @MediaIds = @DeletedIds  , @Status = 1  ,@IsCallInternal =1 
				DELETE FROM ZnodeMediaCategory WHERE MediaPathId IN (SELECT MediaPathId FROM ZnodeMediaPath WHERE PathCode<>'Root')
				DELETE FROM ZnodeMediaPathLocale WHERE MediaPathId IN (SELECT MediaPathId FROM ZnodeMediaPath WHERE PathCode<>'Root')
				DELETE FROM ZnodeMediaPath WHERE PathCode<>'Root'
				IF  EXISTS (SELECT TOP 1 1  FROM @StatusOut WHERE Status = 1 )
				BEGIN 
		     	PRINT '<-- Media Data Deleted Sucessfully-->'
			    END
			    ELSE 
				BEGIN 
				PRINT '<-- Media Not Deleted Properly -->' 
				END
				
		   END 
		   DELETE FROM @DeletedIds DELETE FROM @StatusOut 
		
		   IF  @DeleteAllWarehouse = 1 OR @DeleteAllData =1 
		   BEGIN 
		   	
		   		SET @DeleteId =  SUBSTRING((
				SELECT  ',' + CONVERT(NVARCHAR(500), WarehouseId)  
				FROM ZnodeWarehouse ZP 
				WHERE NOT EXISTS (SELECT TOP 1 1  FROM @ExceptWarehouseId WHERE id = ZP.WarehouseId )
				FOR XML PATH ('')
				),2,4000) 
				INSERT INTO @StatusOut (Id ,Status)
			    EXEC Znode_DeleteWarehouse @WarehouseId = @DeleteId  , @Status = 1 
		
				IF  EXISTS (SELECT TOP 1 1  FROM @StatusOut WHERE Status = 1 )
				BEGIN 
		     	PRINT '<-- Warehouse Data Deleted Sucessfully-->'
			    END
			    ELSE 
				BEGIN 
				PRINT '<-- Warehouse Not Deleted Properly -->' 
				END
		    END 
			DELETE FROM @DeletedIds DELETE FROM @StatusOut 
		
			IF  @DeleteAllPricelist = 1   OR @DeleteAllData =1 
		    BEGIN 
				SET @DeleteId =  SUBSTRING((
				SELECT ',' + CONVERT(NVARCHAR(500), PriceListId)  
				FROM ZnodePriceList ZP 
				WHERE NOT EXISTS (SELECT TOP 1 1  FROM @ExceptPricelistId WHERE id = ZP.PriceListId )
				FOR XML PATH ('')
				),2,4000) 
			  
				INSERT INTO @StatusOut (Id ,Status)  
				EXEC Znode_DeletePriceList @PriceListId = @DeleteId  , @Status = 1 
		      
			   IF  EXISTS (SELECT TOP 1 1  FROM @StatusOut WHERE Status = 1 )
				BEGIN 
		     	PRINT '<-- Price List Data Deleted Sucessfully-->'
			    END
			    ELSE 
				BEGIN 
				PRINT '<-- Price List Not Deleted Properly -->' 
				END
		    END
		
			DELETE FROM @DeletedIds DELETE FROM @StatusOut 
			IF  @DeleteAllProfile = 1  OR @DeleteAllData =1 
			 BEGIN 
				SET @DeleteId =  SUBSTRING((
				SELECT ',' + CONVERT(NVARCHAR(500), ProfileId)  
				FROM ZnodeProfile ZP 
				WHERE NOT EXISTS (SELECT TOP 1 1  FROM @ExceptProfileId WHERE id = ZP.ProfileId )
				FOR XML PATH ('')
				),2,4000) 
		   	 	--INSERT INTO @StatusOut (Id ,Status)
				EXEC  Znode_DeleteProfile  @ProfileId=@DeleteId, @Status = 0 ,	@IsForceFullyDelete =1 
				
				IF  EXISTS (SELECT TOP 1 1  FROM @StatusOut WHERE Status = 1 )
				BEGIN 
		     	PRINT '<-- Profile Data Deleted Sucessfully-->'
			    END
			    ELSE 
				BEGIN 
				PRINT '<-- Profile Not Deleted Properly -->' 
				END
		    END
			DELETE FROM @DeletedIds DELETE FROM @StatusOut 
			IF  @DeleteAllSiteSearchData  = 1  OR @DeleteAllData =1 
			BEGIN 
			
					DELETE FROM ZnodeSearchIndexServerStatus
					DELETE FROM ZnodeSearchIndexMonitor
					DELETE FROM ZnodeCatalogIndex
					DELETE FROM ZnodePublishCatalogSearchProfile
					DELETE FROM ZnodeCatalogIndex
					DELETE FROM ZnodeCMSCustomerReview 
					DELETE FROM ZnodePublishPortalLog
					DELETE FROM ZnodeListViewFilter
					DELETE FROM ZnodeListView
			
					PRINT '<-- Site Search Data Deleted Sucessfully-->'
			 END
			 DELETE FROM @DeletedIds DELETE FROM @StatusOut 
			 IF  @DeleteAllCMSData = 1 	OR @DeleteAllData =1 
			 BEGIN 
				IF EXISTS (SELECT TOP 1 1  FROM SYS.Tables WHERE name = '_ZnodeCMSPortalTheme' )
				BEGIN
				 DROP TABLE _ZnodeCMSPortalTheme 
				END 
				SELECT * 
				INTO _ZnodeCMSPortalTheme
				FROM ZnodeCMSPortalTheme
				DELETE FROM ZnodeCMSContentPagesProfile 
				DELETE FROM ZnodeFormWidgetEmailConfiguration
				DELETE FROM ZnodeCMSWidgetTitleConfigurationLocale
				DELETE FROM ZnodeCMSWidgetTitleConfiguration
				DELETE FROM ZnodeCMSTextWidgetConfiguration
				DELETE FROM ZnodeCMSFormWidgetConfiguration
				DELETE FROM ZnodeCMSPortalProductPage
				DELETE FROM ZnodeCMSContentPageGroupMapping
				DELETE FROM ZnodeCMSContentPageGroupLocale
				DELETE FROM ZnodeCMSContentPageGroup
				DELETE FROM ZnodeCMSContentPagesLocale
				DELETE FROM ZnodeCMSContentPages
				DELETE FROM ZnodeCMSContentPagesProfile
				DELETE FROM ZnodeCMSPortalTheme  
			    DELETE FROM ZnodeCMSThemeCSS 
				DELETE FROM ZnodeCMSTheme  
				DELETE FROM ZnodeEmailTemplateMapper
				DELETE FROM ZnodeEmailTemplateLocale
				DELETE FROM ZnodeEmailTemplateAreas
				DELETE FROM ZnodeEmailTemplate
			    DELETE FROM ZnodeCMSWidgetSliderBanner
				DELETE FROM ZnodeCMSSliderBannerLocale
				DELETE FROM ZnodeCMSSliderBanner
				DELETE FROM ZnodeCMSSlider
				DELETE FROM ZnodeCmsPortalMessage
				DELETE FROM ZnodeCMSPortalMessageKeyTag
				DELETE FROM ZnodeCMSMessage 
				DELETE FROM ZnodeCMSMessageKey 
				DELETE FROM ZnodeCMSTemplate
				DELETE FROM ZnodeFormBuilderGlobalAttributeValueLocale 
				DELETE FROM ZnodeFormBuilderGlobalAttributeValue
				DELETE FROM ZnodeFormBuilderAttributeMapper 
				DELETE FROM ZnodeFormBuilderSubmit 
				DELETE FROM ZnodeFormBuilder

				IF NOT EXISTS (SELECT TOP 1 1  FROM ZnodeCMSTheme)
				BEGIN 
			   INSERT INTO ZnodeCMSTheme(Name
			,CreatedBy
			,CreatedDate
			,ModIFiedBy
			,ModIFiedDate
			,IsParentTheme
			,ParentThemeId)
			SELECT 'Default',2,GETDATE(),2,GETDATE(),1,NULL
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSTheme WHERE Name = 'Default')

			SET @CMSThemeId = CASE WHEN @CMSThemeId	 IS NULL THEN (SELECT TOP 1 CMSThemeId FROM ZnodeCMSTheme WHERE Name = 'Default'   )  ELSE  @CMSThemeId END 
			INSERT INTO ZnodeCMSThemeCSS  (CMSThemeId
			,CSSName
			,CreatedBy
			,CreatedDate
			,ModIFiedBy
			,ModIFiedDate)
			SELECT @CMSThemeId,'DefaultCSS',2,GETDATE(),2,GETDATE()
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSThemeCSS WHERE CSSName = 'DefaultCSS')
	  	
			SET @CMSThemeCSSId = CASE WHEN @CMSThemeCSSId IS NULL THEN (SELECT TOP 1 CMSThemeCSSId FROM ZnodeCMSThemeCSS 
			WHERE CSSName = 'DefaultCSS'
			) ELSE 	@CMSThemeCSSId END 

			 INSERT INTO ZnodeCMSPortalTheme (PortalId
					,CMSThemeId
					,CMSThemeCSSId
					,MediaId
					,FavIconId
					,WebsiteTitle
					,CreatedBy
					,CreatedDate
					,ModifiedBy
					,ModifiedDate)
			 SELECT DISTINCT PortalId
					,@CMSThemeId
					,@CMSThemeCSSId
					,MediaId
					,FavIconId
					,WebsiteTitle
					,2
					,GETDATE()
					,2
					,GETDATE() 
			 FROM _ZnodeCMSPortalTheme	TYU 
			 WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodeCMSPortalTheme TY  WHERE TY.PortalId = TYU.PortalId AND TY.CMSThemeId = @CMSThemeId AND TY.CMSThemeCSSId = @CMSThemeCSSId)
			 
			 END 

			 PRINT '<-- CMS Data Deleted Sucessfully-->'	  			   
			 IF  NOT EXISTS (SELECT TOP 1 1  FROM ZnodeCMSContentPageGroup )
			 BEGIN 
			    DECLARE @GroupId INT =0 
				INSERT INTO ZnodeCMSContentPageGroup (ParentCMSContentPageGroupId ,Code,CreatedBy,CreatedDate,ModIFiedBy,ModIFiedDate)
				SELECT NULL,'Root',2,GETDATE(),2,GETDATE()
			    SET @GroupId = SCOPE_IDENTITY()
				INSERT INTO ZnodeCMSContentPageGroupLocale(CMSContentPageGroupId,Name,LocaleId,CreatedBy,CreatedDate,ModIFiedBy,ModIFiedDate)
			    SELECT @GroupId,'Root',1,2,GETDATE(),2,GETDATE()
			 END
			 END 
	 		 DELETE FROM @DeletedIds DELETE FROM @StatusOut 
			 IF  @DeleteAllCmsSeoDetails =1 OR @DeleteAllData =1 
			 BEGIN 
			 
			   DELETE FROM ZnodeCMSSEODetailLocale 
			   WHERE CMSSEODetailId IN (SELECT CMSSEODetailId FROM ZnodeCMSSEODetail a 
			   INNER JOIN ZnodeCMSSEOType b ON (b.CMSSEOTypeId = a.CMSSEOTypeId)
			   WHERE NOT EXISTS (SELECT TOP 1 1 FROM dbo.split(@ExceptSeoType,',') t WHERE t.Item = b.Name))
			  
			   DELETE FROM ZnodeCMSSEODetail 
			   WHERE CMSSEODetailId IN (SELECT CMSSEODetailId FROM ZnodeCMSSEODetail a 
			   INNER JOIN ZnodeCMSSEOType b ON (b.CMSSEOTypeId = a.CMSSEOTypeId)
			   WHERE NOT EXISTS (SELECT TOP 1 1 FROM dbo.split(@ExceptSeoType,',') t WHERE t.Item = b.Name))
			   PRINT '<-- SEO Data Deleted Sucessfully-->'
			END 
			
		DELETE FROM @DeletedIds DELETE FROM @StatusOut 
		IF  @DeleteAllStore = 1   OR @DeleteAllData =1 
		   BEGIN 
		   DECLARE @TBL_PortalIds TABLE	 ( PortalId int	);
		   DECLARE @TBL_Promotion TABLE ( PromotionId int	);
		  	IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = '_ZnodeDomain')
			BEGIN
				   CREATE TABLE  _ZnodeDomain (PortalId INT  ,DomainName NVARCHAR(max),IsActive BIT ,ApplicationType NVARCHAR(max),CreatedBy INT
		   ,CreatedDate DATETIME ,ModifiedBy INT ,ModIFiedDate DATETIME )
			END 


		   INSERT INTO _ZnodeDomain ( PortalId,DomainName ,IsActive  ,ApplicationType ,CreatedBy,CreatedDate ,ModIFiedBy ,ModIFiedDate) 
		   SELECT PortalId,DomainName ,IsActive  ,ApplicationType ,CreatedBy,CreatedDate ,ModIFiedBy ,ModIFiedDate
		   FROM ZnodeDomain 
		   DECLARE @TBL_DeletedUsers TABLE (AspNetUserId NVARCHAR(1000))

		       SET @DeleteId = Substring((select  ',' + convert(nvarchar(500), PromotionId)  
					FROM ZnodePromotion  SP
					WHERE NOT EXISTS (SELECT TOP 1 1  FROM @ExceptStoreId WHERE id = SP.PortalId )
					for XML Path ('')),2,4000) 
			   
			   

		-- inserting PortalIds which are not present in Order and Quote
		   INSERT INTO @TBL_PortalIds 
		   SELECT PortalId FROM ZnodePortal AS SP
		   WHERE NOT EXISTS (SELECT TOP 1 1  FROM @ExceptStoreId WHERE id = SP.PortalId );

		  	INSERT INTO @StatusOut (Id ,Status)
				EXEC Znode_DeletePromotion  @PromotionId = @DeleteId ,@Status = 1;

		
				IF  EXISTS (SELECT TOP 1 1  FROM @StatusOut WHERE Status = 1 )
				BEGIN 
		     	PRINT '<-- Store Promotion Data Deleted Sucessfully-->'
			    END
			    ELSE 
				BEGIN 
				PRINT '<-- Store Promotion Data Not Deleted Properly -->' 
				END	

-------------------------------------------------

			   DELETE FROM ZnodeGiftCardHistory	
                 WHERE EXISTS( SELECT *  FROM ZnodeGiftCard B	
                               WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS a	
                                                              WHERE a.PortalId = B.PortalId	) AND ZnodeGiftCardHistory.GiftCardId = B.GiftCardId );
	
	
                    DELETE FROM ZnodeRmaRequestItem	
                    WHERE EXISTS( SELECT *  FROM ZnodeGiftCard B WHERE EXISTS ( SELECT TOP 1 1	FROM @TBL_PortalIds AS a  WHERE a.PortalId = B.PortalId	
                              ) AND ZnodeRmaRequestItem.GiftCardId = B.GiftCardId );
	
	
                DELETE FROM ZnodeGiftCardLocale
                    WHERE EXISTS( SELECT *  FROM ZnodeGiftCard B	
                                            WHERE EXISTS ( SELECT TOP 1 1	FROM @TBL_PortalIds AS a	
                                             WHERE a.PortalId = B.PortalId	  ) AND ZnodeGiftCardLocale.GiftCardId = B.GiftCardId );
	
                    	
                    DELETE FROM ZnodeGiftCard	
                    WHERE EXISTS ( SELECT TOP 1 1	
                        FROM @TBL_PortalIds AS a	
                        WHERE a.PortalId = ZnodeGiftCard.PortalId	 );
		
                    DELETE FROM ZnodePortalLoginProvider	
                    WHERE EXISTS ( SELECT TOP 1 1	  FROM @TBL_PortalIds AS a	 WHERE a.PortalId = ZnodePortalLoginProvider.PortalId  );

--------------------------------------------------------------------------------------------------------

		 DELETE FROM  ZnodeBrandPortal  WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeBrandPortal.PortalId);
	    DELETE FROM  ZnodeCustomPortalDetail  WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCustomPortalDetail.PortalId);
		
		 DELETE FROM  ZnodeSupplier WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeSupplier.PortalId)

	     DELETE FROM  ZnodeOmsTemplateLineItem  WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP INNER JOIN ZnodeOmsTemplate ZOT ON 
	     TBP.PortalId = ZOT.PortalId AND ZOT.OmsTemplateId = ZnodeOmsTemplateLineItem.OmsTemplateId);

	     DELETE FROM ZnodeOmsTemplate WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeOmsTemplate.PortalId);
	     DELETE FROM  ZnodeOmsUsersReferralUrl WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeOmsUsersReferralUrl.PortalId)

		DELETE FROM ZnodePortalShipping WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalShipping.PortalId);
		DELETE FROM ZnodePortalTaxClass WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalTaxClass.PortalId);
		DELETE FROM ZnodePortalPaymentSetting WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalPaymentSetting.PortalId);
		DELETE FROM ZnodeCMSPortalMessageKeyTag WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSPortalMessageKeyTag.PortalId);
		DELETE FROM ZnodePriceListProfile WHERE PortalProfileID IN (SELECT PortalProfileID FROM ZnodePortalProfile WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalProfile.PortalId))
		DELETE FROM ZnodePortalProfile WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalProfile.PortalId);
		DELETE FROM ZnodePortalFeatureMapper WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalFeatureMapper.PortalId);
		DELETE FROM ZnodePortalShippingDetails WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalShippingDetails.PortalId);
		DELETE FROM ZnodePortalUnit WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalUnit.PortalId);
		DELETE FROM ZnodeDomain WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeDomain.PortalId);
		
		DELETE FROM ZnodePortalSearchProfile   WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalSearchProfile.PortalId);
		DELETE FROM dbo.ZnodePortalPixelTracking WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalPixelTracking.PortalId); 
		DELETE FROM ZnodeRobotsTxt WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeRobotsTxt.PortalId);
		DELETE FROM ZnodePortalSmtpSetting WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalSmtpSetting.PortalId);
		DELETE FROM ZnodeActivityLog WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeActivityLog.PortalId);
		DELETE FROM ZnodePortalCatalog WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalCatalog.PortalId );
		DELETE FROM ZnodeCMSPortalMessage  WHERE EXISTS  ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSPortalMessage.PortalId );
		DELETE FROM ZnodeGoogleTagManager WHERE  EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeGoogleTagManager.PortalId);
		DELETE FROM ZnodeTaxRuleTypes WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeTaxRuleTypes.PortalId);
		DELETE FROM ZnodeCMSContentPagesProfile WHERE EXISTS (SELECT TOP 1 1 FROM  ZnodeCMSContentPages ZCCP  
											WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZCCP.PortalId) AND ZCCP.CMSContentPagesId = ZnodeCMSContentPagesProfile.CMSContentPagesId )
		DELETE FROM ZnodeCMSContentPageGroupMapping WHERE EXISTS (SELECT TOP 1 1 FROM  ZnodeCMSContentPages ZCCP  
																	WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZCCP.PortalId) AND ZCCP.CMSContentPagesId = ZnodeCMSContentPageGroupMapping.CMSContentPagesId )
	     DELETE FROM ZnodeCMSContentPagesLocale WHERE EXISTS (SELECT TOP 1 1 FROM  ZnodeCMSContentPages ZCCP  
																	WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZCCP.PortalId) AND ZCCP.CMSContentPagesId = ZnodeCMSContentPagesLocale.CMSContentPagesId )
		
		DELETE FROM ZnodeBlogNewsCommentLocale WHERE EXISTS (SELECT TOP 1 1 FROM ZnodeBlogNewsComment ZBC
													WHERE EXISTS (SELECT TOP 1 1 FROM ZnodeBlogNews ZBN
														WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZBN.PortalId) AND ZBN.BlogNewsId = ZBC.BlogNewsId ) and ZBC.BlogNewsCommentId = ZnodeBlogNewsCommentLocale.BlogNewsCommentId)
		DELETE FROM ZnodeBlogNewsComment WHERE EXISTS (SELECT TOP 1 1 FROM ZnodeBlogNews ZBN
													WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZBN.PortalId) AND ZBN.BlogNewsId = ZnodeBlogNewsComment.BlogNewsId )
		 
		DELETE FROM ZnodeBlogNewsContent WHERE EXISTS (SELECT TOP 1 1 FROM ZnodeBlogNews ZBN
													WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZBN.PortalId) AND ZBN.BlogNewsId = ZnodeBlogNewsContent.BlogNewsId )
		DELETE FROM ZnodeBlogNewsLocale WHERE EXISTS (SELECT TOP 1 1 FROM ZnodeBlogNews ZBN
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZBN.PortalId) AND ZBN.BlogNewsId = ZnodeBlogNewsLocale.BlogNewsId )
													
		DELETE FROM ZnodeBlogNews WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeBlogNews.PortalId)
		DELETE FROM  ZnodeFormWidgetEmailConfiguration 	WHERE CMSContentPagesId IN (SELECT CMSContentPagesId FROM ZnodeCMSContentPages WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSContentPages.PortalId))
		DELETE FROM ZnodeCMSContentPages WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSContentPages.PortalId);
		DELETE FROM ZnodeCaseRequestHistory WHERE CaseRequestId IN (SELECT CaseRequestId   FROM ZnodeCaseRequest WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCaseRequest.PortalId))
		DELETE FROM ZnodeCaseRequest WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCaseRequest.PortalId);
		DELETE FROM ZnodePortalLocale WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalLocale.PortalId);
		DELETE FROM ZnodeShippingPortal WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeShippingPortal.PortalId);
		
		--Delete return data against order
		DELETE FROM ZnodeRmaRequestItem
		DELETE FROM ZnodeRmaRequest
		DELETE FROM ZnodeRmaReturnNotes
		DELETE FROM ZnodeRmaReturnEmailHistory
		DELETE FROM ZnodeRmaReturnHistory
		DELETE FROM ZnodeRmaReturnPaymentRefund
		DELETE FROM ZnodeRmaReturnPaymentDetails
		DELETE FROM ZnodeRmaReturnLineItems
		DELETE FROM ZnodeRmaReturnDetails
		--Delete orders against store
		DELETE FROM   @DeletedIds
		INSERT INTO @DeletedIds 
		SELECT distinct OmsOrderID 
		FROM ZnodeOmsOrderDetails  ZP 
		WHERE NOT EXISTS(SELECT * FROM @ExceptStoreId A WHERE ZP.PortalId = A.Id)
		--INSERT INTO @StatusOut (Id ,Status) 
		EXEC [dbo].[Znode_DeleteOrderById] @OmsOrderIds = @DeletedIds , @status = 0  

		DELETE FROM   @DeletedIds
		INSERT INTO @DeletedIds 
		SELECT DISTINCT UserId 
		FROM ZnodeUserPortal 
		WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeUserPortal.PortalId);

		--INSERT INTO @StatusOut (Id ,Status) 
		EXEC [dbo].Znode_DeleteUserDetails @UserIds = @DeletedIds , @status = 0,@IsForceFullyDelete =1 ,@IsCallInternal=1 
		
		DELETE FROM AspNetZnodeUser OUTPUT DELETED.AspNetZnodeUserId   INTO @TBL_DeletedUsers WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = AspNetZnodeUser.PortalId )
		
		DELETE FROM ZnodePortalAlternateWarehouse WHERE EXISTS ( SELECT TOP 1 1 FROM ZnodePortalWareHouse AS ZPWH WHERE EXISTS (
				SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZPWH.PortalId ) AND  ZPWH.PortalWarehouseId = ZnodePortalAlternateWarehouse.PortalWarehouseId);
		DELETE FROM ZnodePortalWareHouse WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalWareHouse.PortalId);
		DELETE ZnodePriceListPortal WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePriceListPortal.PortalId );
		
		DELETE FROM ZnodeEmailTemplateMapper WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeEmailTemplateMapper.PortalId);
		DELETE FROM ZnodeGIFtCard WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeGIFtCard.PortalId );
		DELETE FROM ZnodeCMSPortalProductPage WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSPortalProductPage.PortalId);

		DELETE FROM ZnodeCMSPortalSEOSetting WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSPortalSEOSetting.PortalId);

		DELETE FROM ZnodeCMSPortalTheme WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSPortalTheme.PortalId);

		DELETE FROM ZnodeCMSSEODetailLocale WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP INNER JOIN ZnodeCMSSEODetail AS zcsd ON TBP.PortalId = zcsd.PortalId WHERE zcsd.CMSSEODetailId = ZnodeCMSSEODetailLocale.CMSSEODetailId);
		 
		DELETE FROM ZnodeCMSSEODetail WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSSEODetail.PortalId);
		DELETE FROM ZnodePortalAccount WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalAccount.PortalId);
		DELETE FROM ZnodePortalAddress WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalAddress.PortalId);
		DELETE FROM ZnodePortalCountry WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalCountry.PortalId);
		DELETE FROM ZnodeCMSUrlRedirect WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeCMSUrlRedirect.PortalId);
		DELETE FROM ZnodeTaxPortaL  WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeTaxPortaL.PortalId);
	   	INSERT INTO @TBL_Promotion( PromotionId ) SELECT PromotionId FROM ZnodePromotion WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePromotion.PortalId);
		DELETE FROM ZnodePromotionProduct WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_Promotion AS TBP WHERE TBP.PromotionId = ZnodePromotionProduct.PromotionId);
		DELETE FROM dbo.ZnodePromotionCoupon  WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_Promotion AS TBP WHERE TBP.PromotionId = ZnodePromotionCoupon.PromotionId);
		DELETE FROM ZnodePromotionCategory WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_Promotion AS TBP WHERE TBP.PromotionId = ZnodePromotionCategory.PromotionId);
		DELETE FROM ZnodePromotionCatalogs WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_Promotion AS TBP WHERE TBP.PromotionId = ZnodePromotionCatalogs.PromotionId);
		DELETE FROM ZnodePromotion WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_Promotion AS TBP WHERE TBP.PromotionId = ZnodePromotion.PromotionId);
		DELETE FROM ZnodeBlogNewsLocale WHERE exists (select top 1 1 from ZnodeBlogNews ZBN
													WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZBN.PortalId) AND ZBN.BlogNewsId = ZnodeBlogNewsLocale.BlogNewsId )
		
        DELETE a FROM ZnodeFormBuilderGlobalAttributeValueLocale	a 
			INNER JOIN ZnodeFormBuilderGlobalAttributeValue aa ON (a.FormBuilderGlobalAttributeValueId = aa.FormBuilderGlobalAttributeValueId)INNER JOIN ZnodeFormBuilderSubmit b ON (b.FormBuilderSubmitId =aa.FormBuilderSubmitId)
			 WHERE EXISTS ( SELECT TOP 1 1
									   FROM @TBL_PortalIds AS TBDL
									   WHERE TBDL.PortalId = b.PortalId      
									 ); 
		DELETE a FROM ZnodeFormBuilderGlobalAttributeValue a INNER JOIN ZnodeFormBuilderSubmit b ON (b.FormBuilderSubmitId =a.FormBuilderSubmitId)
		 WHERE EXISTS ( SELECT TOP 1 1
								   FROM @TBL_PortalIds AS TBDL
								   WHERE TBDL.PortalId = b.PortalId      
								 ); 
		DELETE FROM ZnodeFormBuilderSubmit 
		WHERE EXISTS ( SELECT TOP 1 1
								   FROM @TBL_PortalIds AS TBDL
								   WHERE TBDL.PortalId = ZnodeFormBuilderSubmit.PortalId      
								 );   
		DELETE FROM   @DeletedIds
		INSERT INTO @DeletedIds 
		SELECT DISTINCT a.OmsOrderId 
		FROM ZnodeOmsOrder A 
		INNER JOIN ZnodeOMsOrderDetails b  ON (b.OmsOrderId = a.OmsOrderId )
		WHERE   EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = b.PortalId)

		INSERT INTO @StatusOut (Id ,Status) 
		EXEC [dbo].[Znode_DeleteOrderById] @OmsOrderIds = @DeletedIds , @status = 0 

		DELETE FROM @DeletedIds DELETE FROM @StatusOut 									  
		
		DELETE FROM dbo.ZnodeSearchSynonyms	 WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalCatalog Tt WHERE Tt.PublishCatalogId = ZnodeSearchSynonyms.PublishCatalogId )
		DELETE FROM ZnodePublishedXml 
		DELETE FROM ZnodePublishCatalogLog	 WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalCatalog Tt WHERE Tt.PublishCatalogId = ZnodePublishCatalogLog.PublishCatalogId )
		DELETE FROM ZnodePublishCatalogSearchProfile WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalCatalog Tt WHERE Tt.PublishCatalogId = ZnodePublishCatalogSearchProfile.PublishCatalogId )
		DELETE FROM ZnodePublishCategoryProduct   WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalCatalog Tt WHERE Tt.PublishCatalogId = ZnodePublishCategoryProduct.PublishCatalogId )
		DELETE FROM ZnodePublishCategoryDetail 	WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePublishCategoryProduct Tt WHERE Tt.PublishCategoryId = ZnodePublishCategoryDetail.PublishCategoryId )
		DELETE FROM ZnodePublishProductDetail WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePublishCategoryProduct Tt WHERE Tt.PublishCategoryId = ZnodePublishProductDetail.PublishProductId )
		
		DELETE FROM ZnodeCMSWidgetCategory WHERE PublishCategoryId IN (SELECT PublishCategoryId FROM ZnodePublishCategory   WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalCatalog Tt WHERE Tt.PublishCatalogId = ZnodePublishCategory.PublishCatalogId ))

		DELETE FROM ZnodePublishCategory   WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalCatalog Tt WHERE Tt.PublishCatalogId = ZnodePublishCategory.PublishCatalogId )
		DELETE FROM dbo.ZnodeCMSWidgetProduct	WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePublishCategoryProduct Tt WHERE Tt.PublishProductId = ZnodeCMSWidgetProduct.PublishProductId )
		DELETE FROM dbo.ZnodeSearchGlobalProductBoost	WHERE PublishProductId IN (SELECT PublishProductId FROM ZnodePublishProduct	 WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalCatalog Tt WHERE Tt.PublishCatalogId = ZnodePublishProduct.PublishCatalogId ))
		DELETE FROM ZnodeCMSCustomerReview 
			WHERE PublishProductId IN (SELECT PublishProductId FROM ZnodePublishProduct	 WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalCatalog Tt WHERE Tt.PublishCatalogId = ZnodePublishProduct.PublishCatalogId ))
		DELETE FROM ZnodePublishProduct	 WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalCatalog Tt WHERE Tt.PublishCatalogId = ZnodePublishProduct.PublishCatalogId )
		DELETE FROM dbo.ZnodeSearchIndexServerStatus WHERE SearchIndexMonitorId IN (SELECT SearchIndexMonitorId FROM dbo.ZnodeSearchIndexMonitor WHERE CatalogIndexId IN (SELECT CatalogIndexId FROM ZnodeCatalogIndex	 WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalCatalog Tt WHERE Tt.PublishCatalogId = ZnodeCatalogIndex.PublishCatalogId )))
		DELETE FROM dbo.ZnodeSearchIndexMonitor WHERE CatalogIndexId IN (SELECT CatalogIndexId FROM ZnodeCatalogIndex	 WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalCatalog Tt WHERE Tt.PublishCatalogId = ZnodeCatalogIndex.PublishCatalogId ))
		DELETE FROM  ZnodeCatalogIndex   WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalCatalog Tt WHERE Tt.PublishCatalogId = ZnodeCatalogIndex.PublishCatalogId )
		DELETE FROM ZnodeSearchDocumentMapping WHERE PublishCatalogId IN (SELECT PublishCatalogId FROM ZnodePublishCatalog	  WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalCatalog Tt WHERE Tt.PublishCatalogId = ZnodePublishCatalog.PublishCatalogId ))
		
		DELETE FROM ZnodeSearchKeywordsRedirect 
		WHERE EXISTS(SELECT * FROM ZnodePublishCatalog	WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalCatalog Tt WHERE Tt.PublishCatalogId = ZnodePublishCatalog.PublishCatalogId ) AND ZnodeSearchKeywordsRedirect.PublishCatalogId = ZnodePublishCatalog.PublishCatalogId)

		DELETE FROM ZnodePublishCatalog	  WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalCatalog Tt WHERE Tt.PublishCatalogId = ZnodePublishCatalog.PublishCatalogId )
		DELETE FROM ZnodeOmsPersonalizeCartItem WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsSavedCartLineItem WHERE OmsSavedCartId IN (SELECT OmsSavedCartId FROM ZnodeOmsSavedCart WHERE OmsCookieMappingId IN (SELECT OmsCookieMappingId FROM ZnodeOmsCookieMapping WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeOmsCookieMapping.PortalId) ) 	 )) 
		DELETE FROM ZnodeOmsSavedCartLineItem WHERE OmsSavedCartId IN (SELECT OmsSavedCartId FROM ZnodeOmsSavedCart WHERE OmsCookieMappingId IN (SELECT OmsCookieMappingId FROM ZnodeOmsCookieMapping WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeOmsCookieMapping.PortalId) ) 	 )
		DELETE FROM ZnodeOmsSavedCart WHERE OmsCookieMappingId IN (SELECT OmsCookieMappingId FROM ZnodeOmsCookieMapping WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeOmsCookieMapping.PortalId) ) 
		DELETE FROM ZnodeOmsCookieMapping WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeOmsCookieMapping.PortalId); 
		DELETE FROM ZnodeDomain WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeDomain.PortalId);
		
		DELETE FROM ZnodeSalesRepCustomerUserPortal WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeSalesRepCustomerUserPortal.CustomerPortalId);

		delete from ZnodeSalesRepCustomerUserPortal 
		where exists(select * FROM ZnodeUserPortal WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeUserPortal.PortalId) and ZnodeSalesRepCustomerUserPortal.UserPortalId = ZnodeUserPortal.UserPortalId);
		

		DELETE FROM ZnodePortalRecommendationSetting  
		WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalRecommendationSetting.PortalId);
		
		DELETE FROM ZnodePortalPageSetting  
		WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalPageSetting.PortalId);

		DELETE FROM ZnodePortalBrand
		WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalBrand.PortalId);
	
		DELETE FROM ZnodePortalSortSetting
		WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalSortSetting.PortalId);

		DELETE FROM ZnodeImpersonificationLog
		WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeImpersonificationLog.PortalId);

		DELETE FROM ZnodePortalCustomCss
		WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortalCustomCss.PortalId);

		DELETE FROM ZnodeSearchActivity
		WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeSearchActivity.PortalId);
		
		DELETE FROM ZnodeProductFeed  WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodeProductFeed.PortalId);
		
		DELETE FROM ZnodePortal WHERE EXISTS ( SELECT TOP 1 1 FROM @TBL_PortalIds AS TBP WHERE TBP.PortalId = ZnodePortal.PortalId);

		PRINT '<-- Store Data Deleted Sucessfully-->'
	   
	   IF  NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortal) 
	   BEGIN 
	        SET @CMSThemeId = NULL 
			SET @CMSThemeCSSId = NULL  
			
	        SET IDENTITY_INSERT [dbo].[ZnodePortal] ON 
			INSERT [dbo].[ZnodePortal] ([PortalId], [CompanyName], [StoreName], [LogoPath], [UseSSL], [AdminEmail], [SalesEmail], [CustomerServiceEmail], [SalesPhoneNumber], [CustomerServicePhoneNumber], [ImageNotAvailablePath], [ShowSwatchInCategory], [ShowAlternateImageInCategory], [ExternalID], [MobileLogoPath], [DefaultOrderStateID], [DefaultReviewStatus], [SplashCategoryID], [SplashImageFile], [MobileTheme], [CopyContentBasedOnPortalId], [CreatedBy], [CreatedDate], [ModIFiedBy], [ModIFiedDate], [InStockMsg], [OutOfStockMsg], [BackOrderMsg], [OrderAmount], [Email], [StoreCode]) 
			VALUES (1, N'DemoStore', N'DemoStore', NULL, 0, N'test@znode.com', N'test@znode.com', N'test@znode.com', N'123456789', N'123456789', N'', 0, 0, NULL, NULL, 50, N'N', NULL, NULL, NULL, NULL, 2, CAST(N'2018-04-23T01:05:48.620' AS DateTime), 2, CAST(N'2018-04-23T01:05:48.620' AS DateTime), N'Demo', N'Demo', N'Demo', NULL, NULL, 'DemoStore')
			SET IDENTITY_INSERT [dbo].[ZnodePortal] OFF
			SET @PortalId  = 1
			INSERT INTO ZnodePimCatalog (CatalogName,IsActive,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT 'DefaultCatalog' , 1 ,NULL,2 ,GETDATE(),2,GETDATE() 
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimCatalog r WHERE r.CatalogName = 'DefaultCatalog' )
			SET @PimCatalogId = CASE WHEN @PimCatalogId IS nULL THEN (SELECT TOP 1 PimCatalogId FROM ZnodePimCatalog WHERE	CatalogName = 'DefaultCatalog'  ) ELSE  @PimCatalogId END 	
			INSERT INTO ZnodePublishCatalog (PimCatalogId
			,CatalogName
			,ExternalId
			,CreatedBy
			,CreatedDate
			,ModIFiedBy
			,ModIFiedDate
			,Token)
			SELECT @PimCatalogId,'DefaultCatalog' , '',2,GETDATE(),2,GETDAte(),''
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalog WHERE CatalogName = 'DefaultCatalog')
			SET  @PublishCatalogId = CASE WHEN  @PublishCatalogId IS nULL THEN (SELECT TOP 1 PublishCatalogId  FROM ZnodePublishCatalog WHERE CatalogName = 'DefaultCatalog'   )  ELSE @PublishCatalogId END 
			INSERT INTO ZnodeCMSTheme(Name
			,CreatedBy
			,CreatedDate
			,ModIFiedBy
			,ModIFiedDate
			,IsParentTheme
			,ParentThemeId)
			SELECT 'Default',2,GETDATE(),2,GETDATE(),1,NULL
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSTheme WHERE Name = 'Default')
			SET  @CMSThemeId = CASE WHEN @CMSThemeId IS nULL THEN (SELECT TOP 1 CMSThemeId FROM ZnodeCMSTheme WHERE Name = 'Default'   )  ELSE @CMSThemeId END  
		
			INSERT INTO ZnodeCMSThemeCSS  (CMSThemeId
			,CSSName
			,CreatedBy
			,CreatedDate
			,ModIFiedBy
			,ModIFiedDate)
			SELECT @CMSThemeId,'DefaultCSS',2,GETDATE(),2,GETDATE()
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSThemeCSS WHERE CSSName = 'DefaultCSS')
			SET  @CMSThemeCSSId = CASE WHEN @CMSThemeCSSId IS nULL THEN (SELECT TOP 1 CMSThemeCSSId FROM ZnodeCMSThemeCSS WHERE CSSName = 'DefaultCSS'  )  ELSE @CMSThemeCSSId END  
		
			INSERT INTO ZnodeCMSPortalTheme (PortalId
			,CMSThemeId
			,CMSThemeCSSId
			,MediaId
			,FavIconId
			,WebsiteTitle
			,CreatedBy
			,CreatedDate
			,ModIFiedBy
			,ModIFiedDate	)    
			SELECT  @PortalId,@CMSThemeId,@CMSThemeCSSId,NULL,NULL,NULL,2,GETDATE(),2,GETDATE()
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSPortalTheme WHERE PortalId  = @PortalId  )
			INSERT INTO ZnodePortalCatalog (PortalId
			,PublishCatalogId
			,CreatedBy
			,CreatedDate
			,ModIFiedBy
			,ModIFiedDate)
			SELECT @PortalId,@PublishCatalogId,2,GETDATE(),2,GETDATE()
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalCatalog WHERE PortalId  = @PortalId )
			
			INSERT INTO ZnodeDomain (PortalId,DomainName ,IsActive,ApplicationType,CreatedBy ,CreatedDate ,ModIFiedBy ,ModIFiedDate)
			SELECT DISTINCT 1,DomainName ,IsActive,ApplicationType,CreatedBy ,GETDATE()CreatedDate ,ModIFiedBy ,GETDATE()ModIFiedDate 
			FROM _ZnodeDomain  TR
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeDomain TY WHERE TR.PortalId = TY.PortalId AND TR.DomainName = TY.DomainName) 
			GROUP BY DomainName ,IsActive,ApplicationType,CreatedBy,ModifiedBy

			INSERT INTO ZnodePortalUnit (PortalId,CurrencyId,WeightUnit,DimensionUnit,CurrencySuffix,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT @PortalId,(SELECT TOP 1 CurrencyId FROM ZnodeCulture WHERE CultureCode = 'en-US' ) 
			,'Lbs','IN','USD',2,GETDATE(),2,GETDATE()
			WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePortalUnit  WHERE PortalId = @PortalId AND CurrencyId = (SELECT TOP 1 CurrencyId FROM ZnodeCulture WHERE CultureCode = 'en-US')  )

	   END 
	   
		
		   END  
			 DELETE FROM @DeletedIds DELETE FROM @StatusOut 
			 IF  @ResetDomainData = 1  OR @DeleteAllData =1     
			 BEGIN 
			  DECLARE @OneportalId INT = (SELECT TOP 1 PortalId  FROM ZnodePortal)
			  DELETE FROM ZnodeDomain 
			  INSERT INTO znodedomain(PortalId,DomainName,	IsActive,	ApiKey,	ApplicationType,	CreatedBy,	CreatedDate	,ModIFiedBy	,ModIFiedDate)
			  SELECT @OneportalId, 'localhost:6766',1, '115915F1-7E6B-4386-A623-9779F27D9A5E','Admin',2,GETDATE(),2,GETDATE()
			  WHERE NOT EXISTS(SELECT * FROM znodedomain WHERE DomainName = 'localhost:6766'  and PortalId = (SELECT TOP 1 PortalId FROM ZnodePortal ))
			  
			  INSERT INTO znodedomain(PortalId,DomainName,	IsActive,	ApiKey,	ApplicationType,	CreatedBy,	CreatedDate	,ModIFiedBy	,ModIFiedDate)
			  SELECT @OneportalId, 'localhost:3288',1, 'c58cc0c0-1349-4001-8416-cf1cea7960e8','WebStore',2,GETDATE(),2,GETDATE()
			  WHERE NOT EXISTS(SELECT * FROM znodedomain WHERE DomainName = 'localhost:3288'  and PortalId = (SELECT TOP 1 PortalId FROM ZnodePortal ))
			  
			  INSERT INTO znodedomain(PortalId,DomainName,	IsActive,	ApiKey,	ApplicationType,	CreatedBy,	CreatedDate	,ModIFiedBy	,ModIFiedDate)
			  SELECT @OneportalId, 'localhost:44762',1, '8a8b4931-7d57-42e8-a005-b1c0cce49f1d','Api',2,GETDATE(),2,GETDATE()
			  WHERE NOT EXISTS(SELECT * FROM znodedomain WHERE DomainName = 'localhost:44762' and PortalId = (SELECT TOP 1 PortalId FROM ZnodePortal ) )
			  
			  INSERT INTO znodedomain(PortalId,DomainName,	IsActive,	ApiKey,	ApplicationType,	CreatedBy,	CreatedDate	,ModIFiedBy	,ModIFiedDate)
			  SELECT  @OneportalId  , 'localhost',1, '115915F1-7E6B-4386-A623-9779F27D9A5E','Admin',2,GETDATE(),2,GETDATE()
			  WHERE NOT EXISTS(SELECT * FROM znodedomain WHERE DomainName = 'localhost'  and PortalId = (SELECT TOP 1 PortalId FROM ZnodePortal ))
			 PRINT '<-- Domain reset Sucessfully-->'
			 END 
		DELETE FROM @DeletedIds DELETE FROM @StatusOut 
		IF @DeleteAllShippingMethods = 1 OR @DeleteAllData =1 
		BEGIN 
		
		   	SET @DeleteId = Substring((select  ',' + convert(nvarchar(500), ShippingId)  
					FROM ZnodeShipping for XML Path ('')),2,4000) 
		  -- INSERT INTO @StatusOut (Id ,Status)

		   EXEC Znode_DeleteShipping  @ShippingId = @DeleteId , @Status =0 ,@IsForceFullyDelete =1 
		   
		 PRINT '<-- Shipping Methods are Deleted Sucessfully-->'
			   
		END
		DELETE FROM @DeletedIds DELETE FROM @StatusOut  
		IF @DeleteAllPaymentMethods	 = 1  OR @DeleteAllData =1 
		BEGIN 
			 	 
		INSERT INTO @DeletedIds 
		SELECT DISTINCT a.OmsOrderId 
		FROM ZnodeOmsOrder A 
		INNER JOIN ZnodeOMsOrderDetails b  ON (b.OmsOrderId = a.OmsOrderId )
		WHERE   EXISTS ( SELECT TOP 1 1 FROM ZnodePaymentSetting AS TBP WHERE TBP.PaymentSettingId = b.PaymentSettingId)

		INSERT INTO @StatusOut (Id ,Status) 
		EXEC [dbo].[Znode_DeleteOrderById] @OmsOrderIds = @DeletedIds , @status = 0 
		 
		 DELETE FROM ZnodePortalPaymentSetting 
		 DELETE FROM ZnodeProfilePaymentSetting
		 DELETE FROM ZnodePaymentSetting
		
			  
		 PRINT '<-- Payment Methods are Deleted Sucessfully-->'
			   
		END 
		DELETE FROM @DeletedIds DELETE FROM @StatusOut 
		IF @DeleteAllTaxes	= 1 OR @DeleteAllData =1 		
		BEGIN 
		 
		  	SET @DeleteId = Substring((select  ',' + convert(nvarchar(500), TaxClassId)  
					FROM ZnodeTaxClass for XML Path ('')),2,4000) 
		-- INSERT INTO @StatusOut (Id ,Status) 
		 EXEC [dbo].[Znode_DeleteTaxClass] @TaxClassId =  @DeleteId, @status = 0 , @IsForceFullyDelete =1 
		 DELETE FROM ZnodeTaxRuleTypes   
     	 PRINT '<-- Taxes Data Deleted Sucessfully-->'
		 		 
		END 
		IF  @ResetIdentity =1  OR @DeleteAllData =1 
		 BEGIN
		 DECLARE @table_name varchar(100)= NULL, @showReport bit= 0, @debug bit= 0
	
		IF  OBJECT_ID('tempdb..#reseed_temp1') < 0 
			Drop TABLE #reseed_temp1 
		CREATE TABLE   #reseed_temp1 
		( 
					 tbame varchar(100), mvalue varchar(20) DEFAULT 0
		)

			DECLARE @Tablename varchar(256), @columnname varchar(256), @IndentValue numeric, @query varchar(4000), @query1 nvarchar(4000), @id int;

			DECLARE Cur_Reseed CURSOR LOCAL FAST_FORWARD
			FOR SELECT b.name, c.name
				FROM sys.objects AS a, sys.objects AS b, sys.columns AS c
				WHERE a.type = 'PK' AND 
					  a.parent_object_id = b.object_id AND 
					  b.object_id = c.object_id AND 
					  c.column_id = 1 AND 
					  is_identity <> 0 AND 
					  b.name NOT LIKE '%-%' AND 
					  b.name NOT LIKE '%(%' AND 
					  RTRIM(LTRIM(b.name)) = RTRIM(LTRIM(COALESCE(@table_name, b.name)));

			OPEN Cur_Reseed;

			FETCH NEXT FROM Cur_Reseed INTO @Tablename, @columnname;

			WHILE(@@FETCH_STATUS = 0)

			BEGIN

				 IF  @columnname <> ''

				BEGIN

					SET @query = 'insert into #reseed_temp1  (tbame, mvalue) ( select  '''+@Tablename+''', max( '+@columnname+') from '+@Tablename+')';

					EXECUTE (@query);

					SELECT @Tablename = tbame, @IndentValue = isnull(mvalue,1)
					FROM #reseed_temp1 ;



					DBCC CHECKIDENT(@Tablename, RESEED, @IndentValue);



				END;

				FETCH NEXT FROM Cur_Reseed INTO @Tablename, @columnname;

			END;
			CLOSE Cur_Reseed;
			DEALLOCATE Cur_Reseed;
			DROP TABLE #reseed_temp1
		PRINT '<---Reset Identity Sucessfully-->'
		END   
		--COMMIT TRAN  CleanUpProcess
	 END TRY 
	 BEGIN CATCH 
	 SELECT ERROR_MESSAGE()
	--ROLLBACK TRAN CleanUpProcess
	 END CATCH  
END

GO

Update znodeapplicationsetting
set Setting ='<?xml version="1.0" encoding="utf-16"?> <columns> <column> <id>1</id> <name>ProductFeedId</name> <headertext>Checkbox</headertext> <width>40</width> <datatype>String</datatype> <columntype>Int32</columntype> <allowsorting>false</allowsorting> <allowpaging>true</allowpaging> <format> </format> <isvisible>y</isvisible> <mustshow>y</mustshow> <musthide>n</musthide> <maxlength>0</maxlength> <isallowsearch>n</isallowsearch> <isconditional>n</isconditional> <isallowlink>n</isallowlink> <islinkactionurl> </islinkactionurl> <islinkparamfield> </islinkparamfield> <ischeckbox>y</ischeckbox> <checkboxparamfield> </checkboxparamfield> <iscontrol>n</iscontrol> <controltype> </controltype> <controlparamfield> </controlparamfield> <displaytext> </displaytext> <editactionurl> </editactionurl> <editparamfield> </editparamfield> <deleteactionurl> </deleteactionurl> <deleteparamfield> </deleteparamfield> <viewactionurl> </viewactionurl> <viewparamfield> </viewparamfield> <imageactionurl> </imageactionurl> <imageparamfield> </imageparamfield> <manageactionurl> </manageactionurl> <manageparamfield> </manageparamfield> <copyactionurl> </copyactionurl> <copyparamfield> </copyparamfield> <xaxis>n</xaxis> <yaxis>n</yaxis> <isadvancesearch>y</isadvancesearch> <Class> </Class> <SearchControlType>--Select--</SearchControlType> <SearchControlParameters> </SearchControlParameters> <DbParamField> </DbParamField> <useMode>DataBase</useMode> <IsGraph>n</IsGraph> <allowdetailview>n</allowdetailview> </column> <column> <id>2</id> <name>StoreName</name> <headertext>Store Name</headertext> <width>30</width> <datatype>String</datatype> <columntype>String</columntype> <allowsorting>true</allowsorting> <allowpaging>true</allowpaging> <format> </format> <isvisible>y</isvisible> <mustshow>y</mustshow> <musthide>n</musthide> <maxlength>0</maxlength> <isallowsearch>y</isallowsearch> <isconditional>n</isconditional> <isallowlink>n</isallowlink> <islinkactionurl> </islinkactionurl> <islinkparamfield> </islinkparamfield> <ischeckbox>n</ischeckbox> <checkboxparamfield> </checkboxparamfield> <iscontrol>n</iscontrol> <controltype> </controltype> <controlparamfield> </controlparamfield> <displaytext> </displaytext> <editactionurl> </editactionurl> <editparamfield> </editparamfield> <deleteactionurl> </deleteactionurl> <deleteparamfield> </deleteparamfield> <viewactionurl> </viewactionurl> <viewparamfield> </viewparamfield> <imageactionurl> </imageactionurl> <imageparamfield> </imageparamfield> <manageactionurl> </manageactionurl> <manageparamfield> </manageparamfield> <copyactionurl> </copyactionurl> <copyparamfield> </copyparamfield> <xaxis>n</xaxis> <yaxis>n</yaxis> <isadvancesearch>y</isadvancesearch> <Class> </Class> <SearchControlType>--Select--</SearchControlType> <SearchControlParameters> </SearchControlParameters> <DbParamField> </DbParamField> <useMode>DataBase</useMode> <IsGraph>n</IsGraph> <allowdetailview>n</allowdetailview> </column> <column> <id>3</id> <name>ProductFeedTypeName</name> <headertext>Type Name</headertext> <width>60</width> <datatype>String</datatype> <columntype>String</columntype> <allowsorting>true</allowsorting> <allowpaging>true</allowpaging> <format> </format> <isvisible>y</isvisible> <mustshow>y</mustshow> <musthide>n</musthide> <maxlength>500</maxlength> <isallowsearch>y</isallowsearch> <isconditional>n</isconditional> <isallowlink>n</isallowlink> <islinkactionurl> </islinkactionurl> <islinkparamfield> </islinkparamfield> <ischeckbox>n</ischeckbox> <checkboxparamfield> </checkboxparamfield> <iscontrol>n</iscontrol> <controltype>Text</controltype> <controlparamfield> </controlparamfield> <displaytext> </displaytext> <editactionurl> </editactionurl> <editparamfield> </editparamfield> <deleteactionurl> </deleteactionurl> <deleteparamfield> </deleteparamfield> <viewactionurl> </viewactionurl> <viewparamfield> </viewparamfield> <imageactionurl> </imageactionurl> <imageparamfield> </imageparamfield> <manageactionurl> </manageactionurl> <manageparamfield> </manageparamfield> <copyactionurl> </copyactionurl> <copyparamfield> </copyparamfield> <xaxis>n</xaxis> <yaxis>n</yaxis> <isadvancesearch>y</isadvancesearch> <Class> </Class> <SearchControlType>--Select--</SearchControlType> <SearchControlParameters> </SearchControlParameters> <DbParamField> </DbParamField> <useMode>DataBase</useMode> <IsGraph>n</IsGraph> <allowdetailview>n</allowdetailview> </column> <column> <id>4</id> <name>FileName</name> <headertext>File Name</headertext> <width>60</width> <datatype>String</datatype> <columntype>String</columntype> <allowsorting>true</allowsorting> <allowpaging>true</allowpaging> <format> </format> <isvisible>y</isvisible> <mustshow>y</mustshow> <musthide>n</musthide> <maxlength>500</maxlength> <isallowsearch>y</isallowsearch> <isconditional>n</isconditional> <isallowlink>n</isallowlink> <islinkactionurl> </islinkactionurl> <islinkparamfield> </islinkparamfield> <ischeckbox>n</ischeckbox> <checkboxparamfield> </checkboxparamfield> <iscontrol>n</iscontrol> <controltype>Text</controltype> <controlparamfield> </controlparamfield> <displaytext> </displaytext> <editactionurl> </editactionurl> <editparamfield> </editparamfield> <deleteactionurl> </deleteactionurl> <deleteparamfield> </deleteparamfield> <viewactionurl> </viewactionurl> <viewparamfield> </viewparamfield> <imageactionurl> </imageactionurl> <imageparamfield> </imageparamfield> <manageactionurl> </manageactionurl> <manageparamfield> </manageparamfield> <copyactionurl> </copyactionurl> <copyparamfield> </copyparamfield> <xaxis>n</xaxis> <yaxis>n</yaxis> <isadvancesearch>y</isadvancesearch> <Class> </Class> <SearchControlType>--Select--</SearchControlType> <SearchControlParameters> </SearchControlParameters> <DbParamField> </DbParamField> <useMode>DataBase</useMode> <IsGraph>n</IsGraph> <allowdetailview>n</allowdetailview> </column> <column> <id>5</id> <name>Manage</name> <headertext>Action</headertext> <width>30</width> <datatype>String</datatype> <columntype>String</columntype> <allowsorting>false</allowsorting> <allowpaging>true</allowpaging> <format>Download|Edit|Trigger|Delete</format> <isvisible>y</isvisible> <mustshow>y</mustshow> <musthide>n</musthide> <maxlength>0</maxlength> <isallowsearch>n</isallowsearch> <isconditional>n</isconditional> <isallowlink>n</isallowlink> <islinkactionurl> </islinkactionurl> <islinkparamfield> </islinkparamfield> <ischeckbox>n</ischeckbox> <checkboxparamfield> </checkboxparamfield> <iscontrol>n</iscontrol> <controltype> </controltype> <controlparamfield> </controlparamfield> <displaytext>Generate Feed|Edit|Create Scheduler|Delete</displaytext> <editactionurl> </editactionurl> <editparamfield> </editparamfield> <deleteactionurl> </deleteactionurl> <deleteparamfield> </deleteparamfield> <viewactionurl> </viewactionurl> <viewparamfield> </viewparamfield> <imageactionurl> </imageactionurl> <imageparamfield> </imageparamfield> <manageactionurl>/ProductFeed/GenerateProductFeedLink|/ProductFeed/Edit|/ProductFeed/CreateScheduler|/ProductFeed/Delete</manageactionurl> <manageparamfield>ProductFeedId|ProductFeedId|ConnectorTouchPoints,SchedulerCallFor|ProductFeedId</manageparamfield> <copyactionurl> </copyactionurl> <copyparamfield> </copyparamfield> <xaxis>n</xaxis> <yaxis>n</yaxis> <isadvancesearch>y</isadvancesearch> <Class> </Class> <SearchControlType>--Select--</SearchControlType> <SearchControlParameters> </SearchControlParameters> <DbParamField> </DbParamField> <useMode>DataBase</useMode> <IsGraph>n</IsGraph> <allowdetailview>n</allowdetailview> </column> </columns>'where ItemName='ZnodeProductFeed'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCatalogCategoryHierarchyAssociation')
	DROP PROC Znode_ImportCatalogCategoryHierarchyAssociation
GO

CREATE PROCEDURE [dbo].[Znode_ImportCatalogCategoryHierarchyAssociation]
(
	@TableName NVARCHAR(100), 
	@Status BIT OUT, 
	@UserId INT, 
	@ImportProcessLogId INT, 
	@NewGUId NVARCHAR(200),
	@PimCatalogId INT
)
AS
BEGIN 
BEGIN TRAN A;
BEGIN TRY
SET NOCOUNT ON;

	DECLARE @GetDate datetime= dbo.Fn_GetDate()
	DECLARE @SSQL VARCHAR(1000)

	IF OBJECT_ID('tempdb..#Category') IS NOT NULL
		DROP TABLE #Category;

	Declare @FeatureValue VARCHAR(500)
	--If the CatalogCategoryHierarchyAssociationAutoCreate value is true, 1 or Yes then input parent code hierarchy will be generate thogh the import
	--If the CatalogCategoryHierarchyAssociationAutoCreate value is false, 0 or No then input parent code hierarchy is not present in the database then it will give an error log
	SELECT TOP 1 @FeatureValue = FeatureValues FROM ZnodeGlobalSetting WHERE FeatureName = 'CatalogCategoryHierarchyAssociationAutoCreate'

	--Getting existing categories
	SELECT A.PimCategoryId,B.CategoryValue CategoryCode 
	INTO #Category 
	FROM ZnodePimCategoryAttributeValue A 
	INNER JOIN ZnodePimCategoryAttributeValueLocale B ON A.PimCategoryAttributeValueId = b.PimCategoryAttributeValueId 
	WHERE EXISTS(SELECT TOP 1 1 FROM ZnodePimAttribute X WHERE X.IsCategory =1 and X.AttributeCode = 'CategoryCode' and A.PimAttributeId = X.PimAttributeId )

	IF OBJECT_ID('tempdb..#HierarchyImportData') IS NOT NULL
		DROP TABLE #HierarchyImportData;

	CREATE TABLE #HierarchyImportData (RowNumber INT,ParentCode NVARCHAR(MAX),CategoryCode NVARCHAR(MAX), DisplayOrder VARCHAR(10),Action VARCHAR(100),GUID VARCHAR(100));

	SET @SSQL = 'Select RowNumber,ParentCode, CategoryCode, DisplayOrder, Action ,GUID FROM '+@TableName;
	INSERT INTO #HierarchyImportData( RowNumber,ParentCode, CategoryCode, DisplayOrder,Action ,GUID)
	EXEC sys.sp_sqlexec @SSQL;

	IF OBJECT_ID('tempdb..#SplitedCategoryHierarchy') IS NOT NULL
		DROP TABLE #SplitedCategoryHierarchy

	--Created table for category hierarchy split
	CREATE TABLE #SplitedCategoryHierarchy (PimCategoryHierarchyId INT, ParentPimCategoryHierarchyId INT
	,PimCatalogId INT, PimCategoryId INT,RowNumber INT ,PimCategoryCode VARCHAR(300),RowId INT,Action varchar(100),DisplayOrder VARCHAR(10), ParentCategoryId INT)

	DECLARE @RecordCount INT=(SELECT COUNT(1) FROM #HierarchyImportData) , @Cnt INT = 1 ,@FirstCategoryId  INT 
	WHILE @Cnt <= @RecordCount  
	BEGIN
		SET @FirstCategoryId = 0 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '122', 'ParentCode / CategoryCode', '', @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNULL(ParentCode,'') = '' AND ISNULL(CategoryCode,'') = '' AND ii.RowNumber  = @Cnt 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'CategoryCode', CategoryCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNULL(CategoryCode,'') = '' AND ii.RowNumber  = @Cnt 

		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--SELECT '102', 'CategoryCode', CategoryCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		--FROM #HierarchyImportData AS ii
		--WHERE ltrim(rtrim(isnull(ii.CategoryCode,''))) like '% %' AND ii.RowNumber  = @Cnt 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '115', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ii.DisplayOrder > 999 AND ISNULL(ii.DisplayOrder,'') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '115', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNUMERIC(ii.DisplayOrder)=0 AND ISNULL(ii.DisplayOrder,'') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '125', 'Action', Action, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE isnull(Action,'') NOT IN ('ADD','DELETE')
		
		IF OBJECT_ID('tempdb..#ExistingHierarchy') IS NOT NULL
			DROP TABLE #ExistingHierarchy;
	
		TRUNCATE TABLE #SplitedCategoryHierarchy

		--Splitting category hierarchy and inserted into temp table #SplitedCategoryHierarchy
		INSERT INTO #SplitedCategoryHierarchy (PimCatalogId , PimCategoryCode ,RowNumber,RowId,Action,DisplayOrder)
		SELECT @PimCatalogId, LTRIM(RTRIM(B.item)) as PimCategoyHierarchyCode , Id, RowNumber, Action, CASE WHEN ISNULL(DisplayOrder,'') = '' THEN 0 ELSE DisplayOrder END
		FROM #HierarchyImportData A 
		CROSS APPLY  dbo.split(isnull(A.ParentCode,'')+CASE WHEN isnull(A.ParentCode,'') = '' THEN '' ELSE '/' END+A.CategoryCode,'/') B 
		Where A.RowNumber  = @Cnt  

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '127', 'ParentCode / CategoryCode', PimCategoryCode, @NewGUId, RowId, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #SplitedCategoryHierarchy AS ii
		WHERE NOT EXISTS(SELECT * FROM #Category C WHERE ii.PimCategoryCode = c.CategoryCode)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '123', 'ParentCode / CategoryCode', PimCategoryCode, @NewGUId, RowId, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #SplitedCategoryHierarchy AS ii
		GROUP BY PimCategoryCode ,RowId
		HAVING COUNT(*) > 1

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '124', 'ParentCode', ParentCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNULL(replace(ii.ParentCode,' ',''),'') like '%//%'
		
		--Deleting the records which was invalid and added into error log
		DELETE FROM #SplitedCategoryHierarchy WHERE RowId IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )
		DELETE FROM #HierarchyImportData WHERE RowNumber IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )

		IF OBJECT_ID('tempdb..#CategoryCodeCheck') IS NOT NULL
			DROP TABLE #CategoryCodeCheck;

		IF EXISTS(SELECT * FROM #SplitedCategoryHierarchy)
		BEGIN
			Update A SET A.PimCategoryId = D.PimCategoryId FROM #SplitedCategoryHierarchy A INNER JOIN #Category D ON A.PimCategoryCode = D.CategoryCode

			Select TOP 1 @FirstCategoryId = X.PimCategoryId FROM #SplitedCategoryHierarchy X
	
			--Getting existing category hierarchy
			;WITH CTE_ZnodePimCategoryHierarchy as 
			(
				SELECT PimCategoryHierarchyId,ParentPimCategoryHierarchyId,PimCategoryId,PimCatalogId
				FROM ZnodePimCategoryHierarchy 
				WHERE PimCatalogId = @PimCatalogId 
			)
			,Hierarchy AS
			(
				-- Anchor
				SELECT  A.PimCategoryHierarchyId,A.ParentPimCategoryHierarchyId,A.PimCategoryId,A.PimCatalogId --, dense_rank() over(order by a.ParentPimCategoryHierarchyId) as RowNumber
				FROM CTE_ZnodePimCategoryHierarchy A
				WHERE A.ParentPimCategoryHierarchyId IS NULL AND  
				A.PimCategoryId =@FirstCategoryId 	AND A.PimCatalogId = @PimCatalogId
				UNION ALL
				-- Recursive query
				SELECT  E.PimCategoryHierarchyId,E.ParentPimCategoryHierarchyId,E.PimCategoryId,E.PimCatalogId--, ROW_NUMBER() over(order by E.ParentPimCategoryHierarchyId,E.PimCategoryHierarchyId) as RowNumber
				FROM CTE_ZnodePimCategoryHierarchy E
				JOIN Hierarchy H ON E.ParentPimCategoryHierarchyId = H.PimCategoryHierarchyId
				WHERE  Exists(Select * FROM #SplitedCategoryHierarchy X WHERE E.PimCategoryId = X.PimCategoryId)
			)
			SELECT * INTO #ExistingHierarchy FROM Hierarchy --Where RowNumber  = @Cnt  --
			--order by PimCategoryHierarchyId

			--Adding required columns into temp table
			Alter table #ExistingHierarchy Add Id INT Identity(1,1), RowNumber INT, ParentCategoryId INT

			--Updating the row number for parent category
			UPDATE #ExistingHierarchy SET RowNumber = 1 WHERE ParentPimCategoryHierarchyId IS NULL

			DECLARE @RecordCount1 INT=(SELECT COUNT(1) FROM #ExistingHierarchy) , @Cnt1 INT = 1 --,@FirstCategoryId1  INT 
			DECLARE @ParentPimCategoryHierarchyId1 INT , @RowNumber INT

			--Updating the row number according to category hierarhcy level
			WHILE @Cnt1 <= @RecordCount1  
			BEGIN
				
				SELECT @ParentPimCategoryHierarchyId1 = PimCategoryHierarchyId FROM #ExistingHierarchy WHERE Id = @Cnt1
				SET @RowNumber = (SELECT TOP 1 RowNumber FROM #ExistingHierarchy WHERE PimCategoryHierarchyId = @ParentPimCategoryHierarchyId1) 

				UPDATE #ExistingHierarchy SET RowNumber = @RowNumber + 1
				WHERE ParentPimCategoryHierarchyId = @ParentPimCategoryHierarchyId1
				
				SET @ParentPimCategoryHierarchyId1 = 0
				SET @RowNumber = 0
				SET @Cnt1 = @Cnt1+1
			END

			--Updating the parent category on existing category hierarchy
			UPDATE b SET ParentCategoryId = a.PimCategoryId
			from #ExistingHierarchy a
			inner join #ExistingHierarchy b on b.ParentPimCategoryHierarchyId = a.PimCategoryHierarchyId
			
			--Updating the parent category on input record
			UPDATE  A SET A.ParentCategoryId = B.PimCategoryId
			FROM #SplitedCategoryHierarchy A  
			INNER JOIN #SplitedCategoryHierarchy B ON B.RowNumber = A.RowNumber-1
						
			--Existing Hierarchy has been updated on the input categories
			Update B SET B.PimCategoryHierarchyId= A.PimCategoryHierarchyId, 
			B.ParentPimCategoryHierarchyId = A.ParentPimCategoryHierarchyId
			FROM #ExistingHierarchy  A INNER JOIN #SplitedCategoryHierarchy B ON ISNULL(A.PimCategoryId,0) = ISNULL(B.PimCategoryId,0) AND ISNULL(A.ParentCategoryId,0) = ISNULL(B.ParentCategoryId,0) and A.RowNumber = B.RowNumber 

			--Removing hierarchy ids of categoris if its parent dont have any hierarchy for input	
			UPDATE CH SET PimCategoryHierarchyId = NULL ,ParentPimCategoryHierarchyId = NULL
			FROM #SplitedCategoryHierarchy CH
			WHERE CH.PimCategoryHierarchyId IS NOT NULL AND EXISTS(SELECT * FROM #SplitedCategoryHierarchy CH1 WHERE CH1.PimCategoryHierarchyId IS NULL AND CH.RowNumber-1 = CH1.RowNumber)

			--Removing hierarchy ids of categories if its parent doesent present in the input hierarchy
			UPDATE A SET PimCategoryHierarchyId = NULL ,ParentPimCategoryHierarchyId = NULL 
			FROM #SplitedCategoryHierarchy A 
			WHERE NOT EXISTS(SELECT * FROM #SplitedCategoryHierarchy X WHERE X.PimCategoryHierarchyId = A.ParentPimCategoryHierarchyId)
			AND A.ParentPimCategoryHierarchyId IS NOT NULL 
			
			IF isnull(@FeatureValue,'') IN ('False','0','No','')
			BEGIN
				--If root level category is not present
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '126', 'ParentCode', ParentCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #HierarchyImportData h
				WHERE RowNumber IN (
					SELECT RowId FROM #SplitedCategoryHierarchy a
					WHERE NOT EXISTS(SELECT * FROM #HierarchyImportData b WHERE A.PimCategoryCode = b.CategoryCode AND a.RowId = b.RowNumber)
					AND A.ParentCategoryId IS NULL AND A.PimCategoryHierarchyId IS NULL)
				
				--If child level category is not present
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '126', 'ParentCode', ParentCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #HierarchyImportData H
				WHERE RowNumber IN (
					SELECT RowId FROM #SplitedCategoryHierarchy a
					WHERE NOT EXISTS(SELECT * FROM #HierarchyImportData b WHERE A.PimCategoryCode = b.CategoryCode AND a.RowId = b.RowNumber)
					AND A.ParentCategoryId IS NOT NULL AND A.ParentPimCategoryHierarchyId IS NULL)
				AND NOT EXISTS(SELECT * FROM ZnodeImportLog X WHERE H.RowNumber = X.RowNumber)
				
				--Deleting the records which was invalid and added into error log
				DELETE FROM #SplitedCategoryHierarchy WHERE RowId IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )
				DELETE FROM #HierarchyImportData WHERE RowNumber IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )
			END

			--Adding new hierarchy into ZnodePimCategoryHierarchy if input having Add action
			IF EXISTS(SELECT * FROM #SplitedCategoryHierarchy WHERE Action = 'Add')
			BEGIN
				
				DROP TABLE IF EXISTS #InsertedPimCategoryHierarchy

				CREATE TABLE #InsertedPimCategoryHierarchy (PimCategoryHierarchyId INT, PimCategoryId INT);

				--Inserting new category hierarchy if not present
				INSERT INTO ZnodePimCategoryHierarchy (PimCatalogId,ParentPimCategoryHierarchyId,PimCategoryId,DisplayOrder,IsActive,
					ActivationDate,ExpirationDate,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PimParentCategoryId)
				OUTPUT inserted.PimCategoryHierarchyId,inserted.PimCategoryId
				INTO #InsertedPimCategoryHierarchy (PimCategoryHierarchyId, PimCategoryId)
				Select PimCatalogId,ParentPimCategoryHierarchyId,PimCategoryId,DisplayOrder,1,NULL,NULL,2,GETDATE(),2,GETDATE(),NULL
				FROM #SplitedCategoryHierarchy WHERE PimCategoryHierarchyId is null 

				-- Newly created Hierarchy has been updated into input category hierarchy
				UPDATE A 
				SET A.PimCategoryHierarchyId=B.PimCategoryHierarchyId
				FROM #SplitedCategoryHierarchy A INNER JOIN #InsertedPimCategoryHierarchy B
					ON A.PimCategoryId=B.PimCategoryId
				WHERE A.PimCategoryHierarchyId IS NULL

				-- Updating new parent hierarchy has been updated into input category hierarchy
				UPDATE A SET A.ParentPimCategoryHierarchyId =(Select PimCategoryHierarchyId FROM #SplitedCategoryHierarchy X WHERE X.RowNumber = A.RowNumber -1 )
				FROM #SplitedCategoryHierarchy A 
		
				-- Updating new parent hierarchy has been updated newly added input category hierarchy into table ZnodePimCategoryHierarchy
				UPDATE ZnodePimCategoryHierarchy SET ParentPimCategoryHierarchyId = A.ParentPimCategoryHierarchyId
				FROM #SplitedCategoryHierarchy A WHERE ZnodePimCategoryHierarchy.PimCategoryHierarchyId = A.PimCategoryHierarchyId
				AND EXISTS(SELECT * FROM #InsertedPimCategoryHierarchy B WHERE A.PimCategoryHierarchyId = B.PimCategoryHierarchyId)
			END
			ELSE
			BEGIN
				--Delete the category hierarchy and its child category 
				DECLARE @PimCategoryHierarchyId INT
				SET @PimCategoryHierarchyId = (SELECT TOP 1 PimCategoryHierarchyId FROM #SplitedCategoryHierarchy ORDER BY RowNumber DESC)
				EXECUTE [Znode_DeletePimCategoryHierarchy] @PimCategoryHierarchyId = @PimCategoryHierarchyId, @PimCatalogId = @PimCatalogId, @Status = 0
			END
		END

		SET @Cnt = @Cnt + 1 
	END

	DECLARE @FailedRecordCount BIGINT
	DECLARE @SuccessRecordCount BIGINT

	SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
	SELECT @SuccessRecordCount = COUNT(DISTINCT RowNumber) FROM #HierarchyImportData

	--Updating the import process status
	UPDATE ZnodeImportProcessLog
	SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
						WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
						WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
					END, 
		ProcessCompletedDate = getdate()
	WHERE ImportProcessLogId = @ImportProcessLogId;

	UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
	WHERE ImportProcessLogId = @ImportProcessLogId;

COMMIT TRAN A;
END TRY
BEGIN CATCH
ROLLBACK TRAN A;

	SET @Status = 0;
	SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

	DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCatalogCategoryHierarchyAssociation @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(200));


	---Import process updating fail due to database error
	UPDATE ZnodeImportProcessLog
	SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
	WHERE ImportProcessLogId = @ImportProcessLogId;

	---Loging error for Import process due to database error
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

	--Updating total and fail record count
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
	TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
	WHERE ImportProcessLogId = @ImportProcessLogId;

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_ImportCatalogCategoryHierarchyAssociation',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
		
		
END CATCH;
END;

GO

Update znodeapplicationsetting
set Setting ='<?xml version="1.0" encoding="utf-16"?> <columns> <column> <id>1</id> <name>ProductFeedId</name> <headertext>Checkbox</headertext> <width>40</width> <datatype>String</datatype> <columntype>Int32</columntype> <allowsorting>false</allowsorting> <allowpaging>true</allowpaging> <format> </format> <isvisible>y</isvisible> <mustshow>y</mustshow> <musthide>n</musthide> <maxlength>0</maxlength> <isallowsearch>n</isallowsearch> <isconditional>n</isconditional> <isallowlink>n</isallowlink> <islinkactionurl> </islinkactionurl> <islinkparamfield> </islinkparamfield> <ischeckbox>y</ischeckbox> <checkboxparamfield> </checkboxparamfield> <iscontrol>n</iscontrol> <controltype> </controltype> <controlparamfield> </controlparamfield> <displaytext> </displaytext> <editactionurl> </editactionurl> <editparamfield> </editparamfield> <deleteactionurl> </deleteactionurl> <deleteparamfield> </deleteparamfield> <viewactionurl> </viewactionurl> <viewparamfield> </viewparamfield> <imageactionurl> </imageactionurl> <imageparamfield> </imageparamfield> <manageactionurl> </manageactionurl> <manageparamfield> </manageparamfield> <copyactionurl> </copyactionurl> <copyparamfield> </copyparamfield> <xaxis>n</xaxis> <yaxis>n</yaxis> <isadvancesearch>y</isadvancesearch> <Class> </Class> <SearchControlType>--Select--</SearchControlType> <SearchControlParameters> </SearchControlParameters> <DbParamField> </DbParamField> <useMode>DataBase</useMode> <IsGraph>n</IsGraph> <allowdetailview>n</allowdetailview> </column> <column> <id>2</id> <name>StoreName</name> <headertext>Store Name</headertext> <width>30</width> <datatype>String</datatype> <columntype>String</columntype> <allowsorting>true</allowsorting> <allowpaging>true</allowpaging> <format> </format> <isvisible>y</isvisible> <mustshow>n</mustshow> <musthide>n</musthide> <maxlength>0</maxlength> <isallowsearch>y</isallowsearch> <isconditional>n</isconditional> <isallowlink>n</isallowlink> <islinkactionurl> </islinkactionurl> <islinkparamfield> </islinkparamfield> <ischeckbox>n</ischeckbox> <checkboxparamfield> </checkboxparamfield> <iscontrol>n</iscontrol> <controltype> </controltype> <controlparamfield> </controlparamfield> <displaytext> </displaytext> <editactionurl> </editactionurl> <editparamfield> </editparamfield> <deleteactionurl> </deleteactionurl> <deleteparamfield> </deleteparamfield> <viewactionurl> </viewactionurl> <viewparamfield> </viewparamfield> <imageactionurl> </imageactionurl> <imageparamfield> </imageparamfield> <manageactionurl> </manageactionurl> <manageparamfield> </manageparamfield> <copyactionurl> </copyactionurl> <copyparamfield> </copyparamfield> <xaxis>n</xaxis> <yaxis>n</yaxis> <isadvancesearch>y</isadvancesearch> <Class> </Class> <SearchControlType>--Select--</SearchControlType> <SearchControlParameters> </SearchControlParameters> <DbParamField> </DbParamField> <useMode>DataBase</useMode> <IsGraph>n</IsGraph> <allowdetailview>n</allowdetailview> </column> <column> <id>3</id> <name>ProductFeedTypeName</name> <headertext>Type Name</headertext> <width>60</width> <datatype>String</datatype> <columntype>String</columntype> <allowsorting>true</allowsorting> <allowpaging>true</allowpaging> <format> </format> <isvisible>y</isvisible> <mustshow>y</mustshow> <musthide>n</musthide> <maxlength>500</maxlength> <isallowsearch>y</isallowsearch> <isconditional>n</isconditional> <isallowlink>n</isallowlink> <islinkactionurl> </islinkactionurl> <islinkparamfield> </islinkparamfield> <ischeckbox>n</ischeckbox> <checkboxparamfield> </checkboxparamfield> <iscontrol>n</iscontrol> <controltype>Text</controltype> <controlparamfield> </controlparamfield> <displaytext> </displaytext> <editactionurl> </editactionurl> <editparamfield> </editparamfield> <deleteactionurl> </deleteactionurl> <deleteparamfield> </deleteparamfield> <viewactionurl> </viewactionurl> <viewparamfield> </viewparamfield> <imageactionurl> </imageactionurl> <imageparamfield> </imageparamfield> <manageactionurl> </manageactionurl> <manageparamfield> </manageparamfield> <copyactionurl> </copyactionurl> <copyparamfield> </copyparamfield> <xaxis>n</xaxis> <yaxis>n</yaxis> <isadvancesearch>y</isadvancesearch> <Class> </Class> <SearchControlType>--Select--</SearchControlType> <SearchControlParameters> </SearchControlParameters> <DbParamField> </DbParamField> <useMode>DataBase</useMode> <IsGraph>n</IsGraph> <allowdetailview>n</allowdetailview> </column> <column> <id>4</id> <name>FileName</name> <headertext>File Name</headertext> <width>60</width> <datatype>String</datatype> <columntype>String</columntype> <allowsorting>true</allowsorting> <allowpaging>true</allowpaging> <format> </format> <isvisible>y</isvisible> <mustshow>y</mustshow> <musthide>n</musthide> <maxlength>500</maxlength> <isallowsearch>y</isallowsearch> <isconditional>n</isconditional> <isallowlink>n</isallowlink> <islinkactionurl> </islinkactionurl> <islinkparamfield> </islinkparamfield> <ischeckbox>n</ischeckbox> <checkboxparamfield> </checkboxparamfield> <iscontrol>n</iscontrol> <controltype>Text</controltype> <controlparamfield> </controlparamfield> <displaytext> </displaytext> <editactionurl> </editactionurl> <editparamfield> </editparamfield> <deleteactionurl> </deleteactionurl> <deleteparamfield> </deleteparamfield> <viewactionurl> </viewactionurl> <viewparamfield> </viewparamfield> <imageactionurl> </imageactionurl> <imageparamfield> </imageparamfield> <manageactionurl> </manageactionurl> <manageparamfield> </manageparamfield> <copyactionurl> </copyactionurl> <copyparamfield> </copyparamfield> <xaxis>n</xaxis> <yaxis>n</yaxis> <isadvancesearch>y</isadvancesearch> <Class> </Class> <SearchControlType>--Select--</SearchControlType> <SearchControlParameters> </SearchControlParameters> <DbParamField> </DbParamField> <useMode>DataBase</useMode> <IsGraph>n</IsGraph> <allowdetailview>n</allowdetailview> </column> <column> <id>5</id> <name>Manage</name> <headertext>Action</headertext> <width>30</width> <datatype>String</datatype> <columntype>String</columntype> <allowsorting>false</allowsorting> <allowpaging>true</allowpaging> <format>Download|Edit|Trigger|Delete</format> <isvisible>y</isvisible> <mustshow>y</mustshow> <musthide>n</musthide> <maxlength>0</maxlength> <isallowsearch>n</isallowsearch> <isconditional>n</isconditional> <isallowlink>n</isallowlink> <islinkactionurl> </islinkactionurl> <islinkparamfield> </islinkparamfield> <ischeckbox>n</ischeckbox> <checkboxparamfield> </checkboxparamfield> <iscontrol>n</iscontrol> <controltype> </controltype> <controlparamfield> </controlparamfield> <displaytext>Generate Feed|Edit|Create Scheduler|Delete</displaytext> <editactionurl> </editactionurl> <editparamfield> </editparamfield> <deleteactionurl> </deleteactionurl> <deleteparamfield> </deleteparamfield> <viewactionurl> </viewactionurl> <viewparamfield> </viewparamfield> <imageactionurl> </imageactionurl> <imageparamfield> </imageparamfield> <manageactionurl>/ProductFeed/GenerateProductFeedLink|/ProductFeed/Edit|/ProductFeed/CreateScheduler|/ProductFeed/Delete</manageactionurl> <manageparamfield>ProductFeedId|ProductFeedId|ConnectorTouchPoints,SchedulerCallFor|ProductFeedId</manageparamfield> <copyactionurl> </copyactionurl> <copyparamfield> </copyparamfield> <xaxis>n</xaxis> <yaxis>n</yaxis> <isadvancesearch>y</isadvancesearch> <Class> </Class> <SearchControlType>--Select--</SearchControlType> <SearchControlParameters> </SearchControlParameters> <DbParamField> </DbParamField> <useMode>DataBase</useMode> <IsGraph>n</IsGraph> <allowdetailview>n</allowdetailview> </column> </columns>'where ItemName='ZnodeProductFeed'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCatalogCategoryHierarchyAssociation')
	DROP PROC Znode_ImportCatalogCategoryHierarchyAssociation
GO

CREATE PROCEDURE [dbo].[Znode_ImportCatalogCategoryHierarchyAssociation]
(
	@TableName NVARCHAR(100), 
	@Status BIT OUT, 
	@UserId INT, 
	@ImportProcessLogId INT, 
	@NewGUId NVARCHAR(200),
	@PimCatalogId INT
)
AS
BEGIN 
BEGIN TRAN A;
BEGIN TRY
SET NOCOUNT ON;

	DECLARE @GetDate datetime= dbo.Fn_GetDate()
	DECLARE @SSQL VARCHAR(1000)

	IF OBJECT_ID('tempdb..#Category') IS NOT NULL
		DROP TABLE #Category;

	Declare @FeatureValue VARCHAR(500)
	--If the CatalogCategoryHierarchyAssociationAutoCreate value is true, 1 or Yes then input parent code hierarchy will be generate thogh the import
	--If the CatalogCategoryHierarchyAssociationAutoCreate value is false, 0 or No then input parent code hierarchy is not present in the database then it will give an error log
	SELECT TOP 1 @FeatureValue = FeatureValues FROM ZnodeGlobalSetting WHERE FeatureName = 'CatalogCategoryHierarchyAssociationAutoCreate'

	--Getting existing categories
	SELECT A.PimCategoryId,B.CategoryValue CategoryCode 
	INTO #Category 
	FROM ZnodePimCategoryAttributeValue A 
	INNER JOIN ZnodePimCategoryAttributeValueLocale B ON A.PimCategoryAttributeValueId = b.PimCategoryAttributeValueId 
	WHERE EXISTS(SELECT TOP 1 1 FROM ZnodePimAttribute X WHERE X.IsCategory =1 and X.AttributeCode = 'CategoryCode' and A.PimAttributeId = X.PimAttributeId )

	IF OBJECT_ID('tempdb..#HierarchyImportData') IS NOT NULL
		DROP TABLE #HierarchyImportData;

	CREATE TABLE #HierarchyImportData (RowNumber INT,ParentCode NVARCHAR(MAX),CategoryCode NVARCHAR(MAX), DisplayOrder VARCHAR(10),Action VARCHAR(100),GUID VARCHAR(100));

	SET @SSQL = 'Select RowNumber,ParentCode, CategoryCode, DisplayOrder, Action ,GUID FROM '+@TableName;
	INSERT INTO #HierarchyImportData( RowNumber,ParentCode, CategoryCode, DisplayOrder,Action ,GUID)
	EXEC sys.sp_sqlexec @SSQL;

	IF OBJECT_ID('tempdb..#SplitedCategoryHierarchy') IS NOT NULL
		DROP TABLE #SplitedCategoryHierarchy

	--Created table for category hierarchy split
	CREATE TABLE #SplitedCategoryHierarchy (PimCategoryHierarchyId INT, ParentPimCategoryHierarchyId INT
	,PimCatalogId INT, PimCategoryId INT,RowNumber INT ,PimCategoryCode VARCHAR(300),RowId INT,Action varchar(100),DisplayOrder VARCHAR(10), ParentCategoryId INT)

	DECLARE @RecordCount INT=(SELECT COUNT(1) FROM #HierarchyImportData) , @Cnt INT = 1 ,@FirstCategoryId  INT 
	WHILE @Cnt <= @RecordCount  
	BEGIN
		SET @FirstCategoryId = 0 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '122', 'ParentCode / CategoryCode', '', @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNULL(ParentCode,'') = '' AND ISNULL(CategoryCode,'') = '' AND ii.RowNumber  = @Cnt 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'CategoryCode', CategoryCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNULL(CategoryCode,'') = '' AND ii.RowNumber  = @Cnt 

		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--SELECT '102', 'CategoryCode', CategoryCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		--FROM #HierarchyImportData AS ii
		--WHERE ltrim(rtrim(isnull(ii.CategoryCode,''))) like '% %' AND ii.RowNumber  = @Cnt 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '115', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ii.DisplayOrder > 999 AND ISNULL(ii.DisplayOrder,'') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '115', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNUMERIC(ii.DisplayOrder)=0 AND ISNULL(ii.DisplayOrder,'') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '125', 'Action', Action, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE isnull(Action,'') NOT IN ('ADD','DELETE')
		
		IF OBJECT_ID('tempdb..#ExistingHierarchy') IS NOT NULL
			DROP TABLE #ExistingHierarchy;
	
		TRUNCATE TABLE #SplitedCategoryHierarchy

		--Splitting category hierarchy and inserted into temp table #SplitedCategoryHierarchy
		INSERT INTO #SplitedCategoryHierarchy (PimCatalogId , PimCategoryCode ,RowNumber,RowId,Action,DisplayOrder)
		SELECT @PimCatalogId, LTRIM(RTRIM(B.item)) as PimCategoyHierarchyCode , Id, RowNumber, Action, CASE WHEN ISNULL(DisplayOrder,'') = '' THEN 0 ELSE DisplayOrder END
		FROM #HierarchyImportData A 
		CROSS APPLY  dbo.split(isnull(A.ParentCode,'')+CASE WHEN isnull(A.ParentCode,'') = '' THEN '' ELSE '/' END+A.CategoryCode,'/') B 
		Where A.RowNumber  = @Cnt  

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '127', 'ParentCode / CategoryCode', PimCategoryCode, @NewGUId, RowId, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #SplitedCategoryHierarchy AS ii
		WHERE NOT EXISTS(SELECT * FROM #Category C WHERE ii.PimCategoryCode = c.CategoryCode)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '123', 'ParentCode / CategoryCode', PimCategoryCode, @NewGUId, RowId, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #SplitedCategoryHierarchy AS ii
		GROUP BY PimCategoryCode ,RowId
		HAVING COUNT(*) > 1

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '124', 'ParentCode', ParentCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNULL(replace(ii.ParentCode,' ',''),'') like '%//%'
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '128', 'CategoryCode', CategoryCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNULL(replace(ii.CategoryCode,' ',''),'') like '%[^a-zA-Z0-9]%'

		--Deleting the records which was invalid and added into error log
		DELETE FROM #SplitedCategoryHierarchy WHERE RowId IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )
		DELETE FROM #HierarchyImportData WHERE RowNumber IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )

		IF OBJECT_ID('tempdb..#CategoryCodeCheck') IS NOT NULL
			DROP TABLE #CategoryCodeCheck;

		IF EXISTS(SELECT * FROM #SplitedCategoryHierarchy)
		BEGIN
			Update A SET A.PimCategoryId = D.PimCategoryId FROM #SplitedCategoryHierarchy A INNER JOIN #Category D ON A.PimCategoryCode = D.CategoryCode

			Select TOP 1 @FirstCategoryId = X.PimCategoryId FROM #SplitedCategoryHierarchy X
	
			--Getting existing category hierarchy
			;WITH CTE_ZnodePimCategoryHierarchy as 
			(
				SELECT PimCategoryHierarchyId,ParentPimCategoryHierarchyId,PimCategoryId,PimCatalogId
				FROM ZnodePimCategoryHierarchy 
				WHERE PimCatalogId = @PimCatalogId 
			)
			,Hierarchy AS
			(
				-- Anchor
				SELECT  A.PimCategoryHierarchyId,A.ParentPimCategoryHierarchyId,A.PimCategoryId,A.PimCatalogId --, dense_rank() over(order by a.ParentPimCategoryHierarchyId) as RowNumber
				FROM CTE_ZnodePimCategoryHierarchy A
				WHERE A.ParentPimCategoryHierarchyId IS NULL AND  
				A.PimCategoryId =@FirstCategoryId 	AND A.PimCatalogId = @PimCatalogId
				UNION ALL
				-- Recursive query
				SELECT  E.PimCategoryHierarchyId,E.ParentPimCategoryHierarchyId,E.PimCategoryId,E.PimCatalogId--, ROW_NUMBER() over(order by E.ParentPimCategoryHierarchyId,E.PimCategoryHierarchyId) as RowNumber
				FROM CTE_ZnodePimCategoryHierarchy E
				JOIN Hierarchy H ON E.ParentPimCategoryHierarchyId = H.PimCategoryHierarchyId
				WHERE  Exists(Select * FROM #SplitedCategoryHierarchy X WHERE E.PimCategoryId = X.PimCategoryId)
			)
			SELECT * INTO #ExistingHierarchy FROM Hierarchy --Where RowNumber  = @Cnt  --
			--order by PimCategoryHierarchyId

			--Adding required columns into temp table
			Alter table #ExistingHierarchy Add Id INT Identity(1,1), RowNumber INT, ParentCategoryId INT

			--Updating the row number for parent category
			UPDATE #ExistingHierarchy SET RowNumber = 1 WHERE ParentPimCategoryHierarchyId IS NULL

			DECLARE @RecordCount1 INT=(SELECT COUNT(1) FROM #ExistingHierarchy) , @Cnt1 INT = 1 --,@FirstCategoryId1  INT 
			DECLARE @ParentPimCategoryHierarchyId1 INT , @RowNumber INT

			--Updating the row number according to category hierarhcy level
			WHILE @Cnt1 <= @RecordCount1  
			BEGIN
				
				SELECT @ParentPimCategoryHierarchyId1 = PimCategoryHierarchyId FROM #ExistingHierarchy WHERE Id = @Cnt1
				SET @RowNumber = (SELECT TOP 1 RowNumber FROM #ExistingHierarchy WHERE PimCategoryHierarchyId = @ParentPimCategoryHierarchyId1) 

				UPDATE #ExistingHierarchy SET RowNumber = @RowNumber + 1
				WHERE ParentPimCategoryHierarchyId = @ParentPimCategoryHierarchyId1
				
				SET @ParentPimCategoryHierarchyId1 = 0
				SET @RowNumber = 0
				SET @Cnt1 = @Cnt1+1
			END

			--Updating the parent category on existing category hierarchy
			UPDATE b SET ParentCategoryId = a.PimCategoryId
			from #ExistingHierarchy a
			inner join #ExistingHierarchy b on b.ParentPimCategoryHierarchyId = a.PimCategoryHierarchyId
			
			--Updating the parent category on input record
			UPDATE  A SET A.ParentCategoryId = B.PimCategoryId
			FROM #SplitedCategoryHierarchy A  
			INNER JOIN #SplitedCategoryHierarchy B ON B.RowNumber = A.RowNumber-1
						
			--Existing Hierarchy has been updated on the input categories
			Update B SET B.PimCategoryHierarchyId= A.PimCategoryHierarchyId, 
			B.ParentPimCategoryHierarchyId = A.ParentPimCategoryHierarchyId
			FROM #ExistingHierarchy  A INNER JOIN #SplitedCategoryHierarchy B ON ISNULL(A.PimCategoryId,0) = ISNULL(B.PimCategoryId,0) AND ISNULL(A.ParentCategoryId,0) = ISNULL(B.ParentCategoryId,0) and A.RowNumber = B.RowNumber 

			--Removing hierarchy ids of categoris if its parent dont have any hierarchy for input	
			UPDATE CH SET PimCategoryHierarchyId = NULL ,ParentPimCategoryHierarchyId = NULL
			FROM #SplitedCategoryHierarchy CH
			WHERE CH.PimCategoryHierarchyId IS NOT NULL AND EXISTS(SELECT * FROM #SplitedCategoryHierarchy CH1 WHERE CH1.PimCategoryHierarchyId IS NULL AND CH.RowNumber-1 = CH1.RowNumber)

			--Removing hierarchy ids of categories if its parent doesent present in the input hierarchy
			UPDATE A SET PimCategoryHierarchyId = NULL ,ParentPimCategoryHierarchyId = NULL 
			FROM #SplitedCategoryHierarchy A 
			WHERE NOT EXISTS(SELECT * FROM #SplitedCategoryHierarchy X WHERE X.PimCategoryHierarchyId = A.ParentPimCategoryHierarchyId)
			AND A.ParentPimCategoryHierarchyId IS NOT NULL 
			
			IF isnull(@FeatureValue,'') IN ('False','0','No','')
			BEGIN
				--If root level category is not present
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '126', 'ParentCode', ParentCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #HierarchyImportData h
				WHERE RowNumber IN (
					SELECT RowId FROM #SplitedCategoryHierarchy a
					WHERE NOT EXISTS(SELECT * FROM #HierarchyImportData b WHERE A.PimCategoryCode = b.CategoryCode AND a.RowId = b.RowNumber)
					AND A.ParentCategoryId IS NULL AND A.PimCategoryHierarchyId IS NULL)
				
				--If child level category is not present
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '126', 'ParentCode', ParentCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #HierarchyImportData H
				WHERE RowNumber IN (
					SELECT RowId FROM #SplitedCategoryHierarchy a
					WHERE NOT EXISTS(SELECT * FROM #HierarchyImportData b WHERE A.PimCategoryCode = b.CategoryCode AND a.RowId = b.RowNumber)
					AND A.ParentCategoryId IS NOT NULL AND A.ParentPimCategoryHierarchyId IS NULL)
				AND NOT EXISTS(SELECT * FROM ZnodeImportLog X WHERE H.RowNumber = X.RowNumber)
				
				--Deleting the records which was invalid and added into error log
				DELETE FROM #SplitedCategoryHierarchy WHERE RowId IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )
				DELETE FROM #HierarchyImportData WHERE RowNumber IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )
			END

			--Adding new hierarchy into ZnodePimCategoryHierarchy if input having Add action
			IF EXISTS(SELECT * FROM #SplitedCategoryHierarchy WHERE Action = 'Add')
			BEGIN
				
				DROP TABLE IF EXISTS #InsertedPimCategoryHierarchy

				CREATE TABLE #InsertedPimCategoryHierarchy (PimCategoryHierarchyId INT, PimCategoryId INT);

				--Inserting new category hierarchy if not present
				INSERT INTO ZnodePimCategoryHierarchy (PimCatalogId,ParentPimCategoryHierarchyId,PimCategoryId,DisplayOrder,IsActive,
					ActivationDate,ExpirationDate,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PimParentCategoryId)
				OUTPUT inserted.PimCategoryHierarchyId,inserted.PimCategoryId
				INTO #InsertedPimCategoryHierarchy (PimCategoryHierarchyId, PimCategoryId)
				Select PimCatalogId,ParentPimCategoryHierarchyId,PimCategoryId,DisplayOrder,1,NULL,NULL,2,GETDATE(),2,GETDATE(),NULL
				FROM #SplitedCategoryHierarchy WHERE PimCategoryHierarchyId is null 

				-- Newly created Hierarchy has been updated into input category hierarchy
				UPDATE A 
				SET A.PimCategoryHierarchyId=B.PimCategoryHierarchyId
				FROM #SplitedCategoryHierarchy A INNER JOIN #InsertedPimCategoryHierarchy B
					ON A.PimCategoryId=B.PimCategoryId
				WHERE A.PimCategoryHierarchyId IS NULL

				-- Updating new parent hierarchy has been updated into input category hierarchy
				UPDATE A SET A.ParentPimCategoryHierarchyId =(Select PimCategoryHierarchyId FROM #SplitedCategoryHierarchy X WHERE X.RowNumber = A.RowNumber -1 )
				FROM #SplitedCategoryHierarchy A 
		
				-- Updating new parent hierarchy has been updated newly added input category hierarchy into table ZnodePimCategoryHierarchy
				UPDATE ZnodePimCategoryHierarchy SET ParentPimCategoryHierarchyId = A.ParentPimCategoryHierarchyId
				FROM #SplitedCategoryHierarchy A WHERE ZnodePimCategoryHierarchy.PimCategoryHierarchyId = A.PimCategoryHierarchyId
				AND EXISTS(SELECT * FROM #InsertedPimCategoryHierarchy B WHERE A.PimCategoryHierarchyId = B.PimCategoryHierarchyId)
			END
			ELSE
			BEGIN
				--Delete the category hierarchy and its child category 
				DECLARE @PimCategoryHierarchyId INT
				SET @PimCategoryHierarchyId = (SELECT TOP 1 PimCategoryHierarchyId FROM #SplitedCategoryHierarchy ORDER BY RowNumber DESC)
				EXECUTE [Znode_DeletePimCategoryHierarchy] @PimCategoryHierarchyId = @PimCategoryHierarchyId, @PimCatalogId = @PimCatalogId, @Status = 0
			END
		END

		SET @Cnt = @Cnt + 1 
	END

	DECLARE @FailedRecordCount BIGINT
	DECLARE @SuccessRecordCount BIGINT

	SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
	SELECT @SuccessRecordCount = COUNT(DISTINCT RowNumber) FROM #HierarchyImportData

	--Updating the import process status
	UPDATE ZnodeImportProcessLog
	SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
						WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
						WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
					END, 
		ProcessCompletedDate = getdate()
	WHERE ImportProcessLogId = @ImportProcessLogId;

	UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
	WHERE ImportProcessLogId = @ImportProcessLogId;

COMMIT TRAN A;
END TRY
BEGIN CATCH
ROLLBACK TRAN A;

	SET @Status = 0;
	SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

	DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCatalogCategoryHierarchyAssociation @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(200));


	---Import process updating fail due to database error
	UPDATE ZnodeImportProcessLog
	SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
	WHERE ImportProcessLogId = @ImportProcessLogId;

	---Loging error for Import process due to database error
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

	--Updating total and fail record count
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
	TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
	WHERE ImportProcessLogId = @ImportProcessLogId;

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_ImportCatalogCategoryHierarchyAssociation',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
		
		
END CATCH;
END;

GO

insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 128,'Text','Invalid input, multiple category codes are not allowed in Category Code column.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 128)

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCatalogCategoryHierarchyAssociation')
	DROP PROC Znode_ImportCatalogCategoryHierarchyAssociation
GO

CREATE PROCEDURE [dbo].[Znode_ImportCatalogCategoryHierarchyAssociation]
(
	@TableName NVARCHAR(100), 
	@Status BIT OUT, 
	@UserId INT, 
	@ImportProcessLogId INT, 
	@NewGUId NVARCHAR(200),
	@PimCatalogId INT
)
AS
BEGIN 
BEGIN TRAN A;
BEGIN TRY
SET NOCOUNT ON;

	DECLARE @GetDate datetime= dbo.Fn_GetDate()
	DECLARE @SSQL VARCHAR(1000)

	IF OBJECT_ID('tempdb..#Category') IS NOT NULL
		DROP TABLE #Category;

	Declare @FeatureValue VARCHAR(500)
	--If the CatalogCategoryHierarchyAssociationAutoCreate value is true, 1 or Yes then input parent code hierarchy will be generate thogh the import
	--If the CatalogCategoryHierarchyAssociationAutoCreate value is false, 0 or No then input parent code hierarchy is not present in the database then it will give an error log
	SELECT TOP 1 @FeatureValue = FeatureValues FROM ZnodeGlobalSetting WHERE FeatureName = 'CatalogCategoryHierarchyAssociationAutoCreate'

	--Getting existing categories
	SELECT A.PimCategoryId,B.CategoryValue CategoryCode 
	INTO #Category 
	FROM ZnodePimCategoryAttributeValue A 
	INNER JOIN ZnodePimCategoryAttributeValueLocale B ON A.PimCategoryAttributeValueId = b.PimCategoryAttributeValueId 
	WHERE EXISTS(SELECT TOP 1 1 FROM ZnodePimAttribute X WHERE X.IsCategory =1 and X.AttributeCode = 'CategoryCode' and A.PimAttributeId = X.PimAttributeId )

	IF OBJECT_ID('tempdb..#HierarchyImportData') IS NOT NULL
		DROP TABLE #HierarchyImportData;

	CREATE TABLE #HierarchyImportData (RowNumber INT,ParentCode NVARCHAR(MAX),CategoryCode NVARCHAR(MAX), DisplayOrder VARCHAR(10),Action VARCHAR(100),GUID VARCHAR(100));

	SET @SSQL = 'Select RowNumber,ParentCode, CategoryCode, DisplayOrder, Action ,GUID FROM '+@TableName;
	INSERT INTO #HierarchyImportData( RowNumber,ParentCode, CategoryCode, DisplayOrder,Action ,GUID)
	EXEC sys.sp_sqlexec @SSQL;

	IF OBJECT_ID('tempdb..#SplitedCategoryHierarchy') IS NOT NULL
		DROP TABLE #SplitedCategoryHierarchy

	--Created table for category hierarchy split
	CREATE TABLE #SplitedCategoryHierarchy (PimCategoryHierarchyId INT, ParentPimCategoryHierarchyId INT
	,PimCatalogId INT, PimCategoryId INT,RowNumber INT ,PimCategoryCode VARCHAR(300),RowId INT,Action varchar(100),DisplayOrder VARCHAR(10), ParentCategoryId INT)

	DECLARE @RecordCount INT=(SELECT COUNT(1) FROM #HierarchyImportData) , @Cnt INT = 1 ,@FirstCategoryId  INT 
	WHILE @Cnt <= @RecordCount  
	BEGIN
		SET @FirstCategoryId = 0 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '122', 'ParentCode / CategoryCode', '', @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNULL(ParentCode,'') = '' AND ISNULL(CategoryCode,'') = '' AND ii.RowNumber  = @Cnt 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'CategoryCode', CategoryCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNULL(CategoryCode,'') = '' AND ii.RowNumber  = @Cnt 

		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--SELECT '102', 'CategoryCode', CategoryCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		--FROM #HierarchyImportData AS ii
		--WHERE ltrim(rtrim(isnull(ii.CategoryCode,''))) like '% %' AND ii.RowNumber  = @Cnt 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '115', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ii.DisplayOrder > 999 AND ISNULL(ii.DisplayOrder,'') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '115', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNUMERIC(ii.DisplayOrder)=0 AND ISNULL(ii.DisplayOrder,'') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '125', 'Action', Action, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE isnull(Action,'') NOT IN ('ADD','DELETE')
		
		IF OBJECT_ID('tempdb..#ExistingHierarchy') IS NOT NULL
			DROP TABLE #ExistingHierarchy;
	
		TRUNCATE TABLE #SplitedCategoryHierarchy

		--Splitting category hierarchy and inserted into temp table #SplitedCategoryHierarchy
		INSERT INTO #SplitedCategoryHierarchy (PimCatalogId , PimCategoryCode ,RowNumber,RowId,Action,DisplayOrder)
		SELECT @PimCatalogId, LTRIM(RTRIM(B.item)) as PimCategoyHierarchyCode , Id, RowNumber, Action, CASE WHEN ISNULL(DisplayOrder,'') = '' THEN 0 ELSE DisplayOrder END
		FROM #HierarchyImportData A 
		CROSS APPLY  dbo.split(isnull(A.ParentCode,'')+CASE WHEN isnull(A.ParentCode,'') = '' THEN '' ELSE '/' END+A.CategoryCode,'/') B 
		Where A.RowNumber  = @Cnt  

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '127', 'ParentCode / CategoryCode', PimCategoryCode, @NewGUId, RowId, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #SplitedCategoryHierarchy AS ii
		WHERE NOT EXISTS(SELECT * FROM #Category C WHERE ii.PimCategoryCode = c.CategoryCode)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '123', 'ParentCode / CategoryCode', PimCategoryCode, @NewGUId, RowId, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #SplitedCategoryHierarchy AS ii
		GROUP BY PimCategoryCode ,RowId
		HAVING COUNT(*) > 1

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '124', 'ParentCode', ParentCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNULL(replace(ii.ParentCode,' ',''),'') like '%//%'
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '128', 'CategoryCode', CategoryCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNULL(replace(ii.CategoryCode,' ',''),'') like '%[^a-zA-Z0-9]%'

		--Deleting the records which was invalid and added into error log
		DELETE FROM #SplitedCategoryHierarchy WHERE RowId IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )
		DELETE FROM #HierarchyImportData WHERE RowNumber IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )

		IF OBJECT_ID('tempdb..#CategoryCodeCheck') IS NOT NULL
			DROP TABLE #CategoryCodeCheck;

		IF EXISTS(SELECT * FROM #SplitedCategoryHierarchy)
		BEGIN
			Update A SET A.PimCategoryId = D.PimCategoryId FROM #SplitedCategoryHierarchy A INNER JOIN #Category D ON A.PimCategoryCode = D.CategoryCode

			Select TOP 1 @FirstCategoryId = X.PimCategoryId FROM #SplitedCategoryHierarchy X
	
			--Getting existing category hierarchy
			;WITH CTE_ZnodePimCategoryHierarchy as 
			(
				SELECT PimCategoryHierarchyId,ParentPimCategoryHierarchyId,PimCategoryId,PimCatalogId
				FROM ZnodePimCategoryHierarchy 
				WHERE PimCatalogId = @PimCatalogId 
			)
			,Hierarchy AS
			(
				-- Anchor
				SELECT  A.PimCategoryHierarchyId,A.ParentPimCategoryHierarchyId,A.PimCategoryId,A.PimCatalogId --, dense_rank() over(order by a.ParentPimCategoryHierarchyId) as RowNumber
				FROM CTE_ZnodePimCategoryHierarchy A
				WHERE A.ParentPimCategoryHierarchyId IS NULL AND  
				A.PimCategoryId =@FirstCategoryId 	AND A.PimCatalogId = @PimCatalogId
				UNION ALL
				-- Recursive query
				SELECT  E.PimCategoryHierarchyId,E.ParentPimCategoryHierarchyId,E.PimCategoryId,E.PimCatalogId--, ROW_NUMBER() over(order by E.ParentPimCategoryHierarchyId,E.PimCategoryHierarchyId) as RowNumber
				FROM CTE_ZnodePimCategoryHierarchy E
				JOIN Hierarchy H ON E.ParentPimCategoryHierarchyId = H.PimCategoryHierarchyId
				WHERE  Exists(Select * FROM #SplitedCategoryHierarchy X WHERE E.PimCategoryId = X.PimCategoryId)
			)
			SELECT * INTO #ExistingHierarchy FROM Hierarchy --Where RowNumber  = @Cnt  --
			--order by PimCategoryHierarchyId

			--Adding required columns into temp table
			Alter table #ExistingHierarchy Add Id INT Identity(1,1), RowNumber INT, ParentCategoryId INT

			--Updating the row number for parent category
			UPDATE #ExistingHierarchy SET RowNumber = 1 WHERE ParentPimCategoryHierarchyId IS NULL

			DECLARE @RecordCount1 INT=(SELECT COUNT(1) FROM #ExistingHierarchy) , @Cnt1 INT = 1 --,@FirstCategoryId1  INT 
			DECLARE @ParentPimCategoryHierarchyId1 INT , @RowNumber INT

			--Updating the row number according to category hierarhcy level
			WHILE @Cnt1 <= @RecordCount1  
			BEGIN
				
				SELECT @ParentPimCategoryHierarchyId1 = PimCategoryHierarchyId FROM #ExistingHierarchy WHERE Id = @Cnt1
				SET @RowNumber = (SELECT TOP 1 RowNumber FROM #ExistingHierarchy WHERE PimCategoryHierarchyId = @ParentPimCategoryHierarchyId1) 

				UPDATE #ExistingHierarchy SET RowNumber = @RowNumber + 1
				WHERE ParentPimCategoryHierarchyId = @ParentPimCategoryHierarchyId1
				
				SET @ParentPimCategoryHierarchyId1 = 0
				SET @RowNumber = 0
				SET @Cnt1 = @Cnt1+1
			END

			--Updating the parent category on existing category hierarchy
			UPDATE b SET ParentCategoryId = a.PimCategoryId
			from #ExistingHierarchy a
			inner join #ExistingHierarchy b on b.ParentPimCategoryHierarchyId = a.PimCategoryHierarchyId
			
			--Updating the parent category on input record
			UPDATE  A SET A.ParentCategoryId = B.PimCategoryId
			FROM #SplitedCategoryHierarchy A  
			INNER JOIN #SplitedCategoryHierarchy B ON B.RowNumber = A.RowNumber-1
						
			--Existing Hierarchy has been updated on the input categories
			Update B SET B.PimCategoryHierarchyId= A.PimCategoryHierarchyId, 
			B.ParentPimCategoryHierarchyId = A.ParentPimCategoryHierarchyId
			FROM #ExistingHierarchy  A INNER JOIN #SplitedCategoryHierarchy B ON ISNULL(A.PimCategoryId,0) = ISNULL(B.PimCategoryId,0) AND ISNULL(A.ParentCategoryId,0) = ISNULL(B.ParentCategoryId,0) and A.RowNumber = B.RowNumber 

			--Removing hierarchy ids of categoris if its parent dont have any hierarchy for input	
			UPDATE CH SET PimCategoryHierarchyId = NULL ,ParentPimCategoryHierarchyId = NULL
			FROM #SplitedCategoryHierarchy CH
			WHERE CH.PimCategoryHierarchyId IS NOT NULL AND EXISTS(SELECT * FROM #SplitedCategoryHierarchy CH1 WHERE CH1.PimCategoryHierarchyId IS NULL AND CH.RowNumber-1 = CH1.RowNumber)

			--Removing hierarchy ids of categories if its parent doesent present in the input hierarchy
			UPDATE A SET PimCategoryHierarchyId = NULL ,ParentPimCategoryHierarchyId = NULL 
			FROM #SplitedCategoryHierarchy A 
			WHERE NOT EXISTS(SELECT * FROM #SplitedCategoryHierarchy X WHERE X.PimCategoryHierarchyId = A.ParentPimCategoryHierarchyId)
			AND A.ParentPimCategoryHierarchyId IS NOT NULL 
			
			IF isnull(@FeatureValue,'') IN ('False','0','No','')
			BEGIN
				--If root level category is not present
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '126', 'ParentCode', ParentCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #HierarchyImportData h
				WHERE RowNumber IN (
					SELECT RowId FROM #SplitedCategoryHierarchy a
					WHERE NOT EXISTS(SELECT * FROM #HierarchyImportData b WHERE A.PimCategoryCode = b.CategoryCode AND a.RowId = b.RowNumber)
					AND A.ParentCategoryId IS NULL AND A.PimCategoryHierarchyId IS NULL)
				
				--If child level category is not present
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '126', 'ParentCode', ParentCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #HierarchyImportData H
				WHERE RowNumber IN (
					SELECT RowId FROM #SplitedCategoryHierarchy a
					WHERE NOT EXISTS(SELECT * FROM #HierarchyImportData b WHERE A.PimCategoryCode = b.CategoryCode AND a.RowId = b.RowNumber)
					AND A.ParentCategoryId IS NOT NULL AND A.ParentPimCategoryHierarchyId IS NULL)
				AND NOT EXISTS(SELECT * FROM ZnodeImportLog X WHERE H.RowNumber = X.RowNumber AND X.ImportProcessLogId=@ImportProcessLogId)
				
				--Deleting the records which was invalid and added into error log
				DELETE FROM #SplitedCategoryHierarchy WHERE RowId IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )
				DELETE FROM #HierarchyImportData WHERE RowNumber IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )
			END

			--Adding new hierarchy into ZnodePimCategoryHierarchy if input having Add action
			IF EXISTS(SELECT * FROM #SplitedCategoryHierarchy WHERE Action = 'Add')
			BEGIN
				
				DROP TABLE IF EXISTS #InsertedPimCategoryHierarchy

				CREATE TABLE #InsertedPimCategoryHierarchy (PimCategoryHierarchyId INT, PimCategoryId INT);

				--Inserting new category hierarchy if not present
				INSERT INTO ZnodePimCategoryHierarchy (PimCatalogId,ParentPimCategoryHierarchyId,PimCategoryId,DisplayOrder,IsActive,
					ActivationDate,ExpirationDate,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PimParentCategoryId)
				OUTPUT inserted.PimCategoryHierarchyId,inserted.PimCategoryId
				INTO #InsertedPimCategoryHierarchy (PimCategoryHierarchyId, PimCategoryId)
				Select PimCatalogId,ParentPimCategoryHierarchyId,PimCategoryId,DisplayOrder,1,NULL,NULL,2,GETDATE(),2,GETDATE(),NULL
				FROM #SplitedCategoryHierarchy WHERE PimCategoryHierarchyId is null 

				-- Newly created Hierarchy has been updated into input category hierarchy
				UPDATE A 
				SET A.PimCategoryHierarchyId=B.PimCategoryHierarchyId
				FROM #SplitedCategoryHierarchy A INNER JOIN #InsertedPimCategoryHierarchy B
					ON A.PimCategoryId=B.PimCategoryId
				WHERE A.PimCategoryHierarchyId IS NULL

				-- Updating new parent hierarchy has been updated into input category hierarchy
				UPDATE A SET A.ParentPimCategoryHierarchyId =(Select PimCategoryHierarchyId FROM #SplitedCategoryHierarchy X WHERE X.RowNumber = A.RowNumber -1 )
				FROM #SplitedCategoryHierarchy A 
		
				-- Updating new parent hierarchy has been updated newly added input category hierarchy into table ZnodePimCategoryHierarchy
				UPDATE ZnodePimCategoryHierarchy SET ParentPimCategoryHierarchyId = A.ParentPimCategoryHierarchyId
				FROM #SplitedCategoryHierarchy A WHERE ZnodePimCategoryHierarchy.PimCategoryHierarchyId = A.PimCategoryHierarchyId
				AND EXISTS(SELECT * FROM #InsertedPimCategoryHierarchy B WHERE A.PimCategoryHierarchyId = B.PimCategoryHierarchyId)
			END
			ELSE
			BEGIN
				--Delete the category hierarchy and its child category 
				DECLARE @PimCategoryHierarchyId INT
				SET @PimCategoryHierarchyId = (SELECT TOP 1 PimCategoryHierarchyId FROM #SplitedCategoryHierarchy ORDER BY RowNumber DESC)
				EXECUTE [Znode_DeletePimCategoryHierarchy] @PimCategoryHierarchyId = @PimCategoryHierarchyId, @PimCatalogId = @PimCatalogId, @Status = 0
			END
		END

		SET @Cnt = @Cnt + 1 
	END

	DECLARE @FailedRecordCount BIGINT
	DECLARE @SuccessRecordCount BIGINT

	SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
	SELECT @SuccessRecordCount = COUNT(DISTINCT RowNumber) FROM #HierarchyImportData

	--Updating the import process status
	UPDATE ZnodeImportProcessLog
	SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
						WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
						WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
					END, 
		ProcessCompletedDate = getdate()
	WHERE ImportProcessLogId = @ImportProcessLogId;

	UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
	WHERE ImportProcessLogId = @ImportProcessLogId;

COMMIT TRAN A;
END TRY
BEGIN CATCH
ROLLBACK TRAN A;

	SET @Status = 0;
	SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

	DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCatalogCategoryHierarchyAssociation @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(200));


	---Import process updating fail due to database error
	UPDATE ZnodeImportProcessLog
	SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
	WHERE ImportProcessLogId = @ImportProcessLogId;

	---Loging error for Import process due to database error
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

	--Updating total and fail record count
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
	TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
	WHERE ImportProcessLogId = @ImportProcessLogId;

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_ImportCatalogCategoryHierarchyAssociation',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
		
		
END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPaymentSettingByUserDetails')
	DROP PROC Znode_GetPaymentSettingByUserDetails
GO

CREATE PROCEDURE [dbo].[Znode_GetPaymentSettingByUserDetails]
(
	@PortalId	INT,
	@UserId		INT,
	@RowsCount  INT OUT
)
AS
/*
	Summary: This Procedure is used to get payment details according to associated profile or portal.

	Unit Testing:

	EXEC [Znode_GetPaymentSettingByUserDetails] @PortalId=1, @UserId=1, @RowsCount=0
*/	
BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
		DECLARE @GuestProfileId INT;

		SELECT TOP 1 @GuestProfileId=ProfileId FROM ZnodeProfile WHERE ProfileName = 'Anonymous' AND @UserId = -1;

		IF OBJECT_ID('tempdb..#ZnodePortalPaymentApprovers') IS NOT NULL
			DROP TABLE #ZnodePortalPaymentApprovers
		--Getting the payment portal approver details
		SELECT PaymentSettingId ,ZPPG.PortalPaymentGroupId,ZPA.PortalId 
		INTO #ZnodePortalPaymentApprovers
		FROM ZnodePortalPaymentApprovers ZPPA 
		INNER JOIN [ZnodePortalPaymentGroup] ZPPG ON( ZPPA.PortalPaymentGroupId = ZPPG.PortalPaymentGroupId)
		INNER JOIN [ZnodePortalApproval] ZPA ON (ZPA.PortalApprovalId = ZPPG.PortalApprovalId) 
		WHERE ZPA.EnableApprovalManagement =1 AND ZPA.PortalId = @PortalId AND ZPPG.isActive = 1;
	
		--When any User Profile is associated with the user account
		--OR When User is associated with single Profile.
		--OR When two or more User Profiles are associated with the user account
		IF (EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP 
					INNER JOIN ZnodePortalProfile ZPP ON ZUP.ProfileId=ZPP.ProfileId
					INNER JOIN ZnodeProfilePaymentSetting ZPS ON ZUP.ProfileId=ZPS.ProfileId
					INNER JOIN ZnodePortalPaymentSetting ZPS1 ON ZPP.PortalId=ZPS1.PortalId AND ZPS.PaymentSettingId=ZPS1.PaymentSettingId
					WHERE ZUP.UserId=@UserId AND ZPP.PortalId=@PortalId)

			OR EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP 
					INNER JOIN ZnodePortalProfile ZPP ON ZUP.ProfileId=ZPP.ProfileId
					INNER JOIN ZnodeProfilePaymentSetting ZPS ON ZUP.ProfileId=ZPS.ProfileId
					INNER JOIN ZnodePortalPaymentSetting ZPS1 ON ZPP.PortalId=ZPS1.PortalId AND ZPS.PaymentSettingId=ZPS1.PaymentSettingId
					WHERE ZUP.ProfileId=@GuestProfileId AND ZPP.PortalId=@PortalId)
			)
		BEGIN
			IF EXISTS (	SELECT TOP 1 1 
						FROM ZnodePaymentSetting ZPS
						INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
						LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
						INNER JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId )
						INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
						INNER JOIN ZnodeProfile ZP ON ZP.ProfileId = YOPU.ProfileId
						INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
						WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1 AND
							(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId AND YOPU.ProfileId = ZUP.ProfileId)
							OR EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE @UserId = -1 AND ZUP.ProfileId = @GuestProfileId)))
			BEGIN
				SELECT DISTINCT ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,
					ZPS.IsActive,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,
					ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate,ZPPS.PortalId,ZP1.StoreName, 
					NULL IsAssociated ,NULL As ProfileId,NULL As ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName,
						CASE WHEN @PortalId > 0 AND ZPPS.PaymentDisplayName IS NOT NULL
							THEN ZPPS.PaymentDisplayName ELSE ZPS.PaymentDisplayName END PaymentDisplayName, 
					NULL PaymentExternalId, CAST(CASE WHEN YU.PaymentSettingId IS NOT NULL THEN 1 ELSE 0 END As BIT) AS IsApprovalRequired,
					ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,
					YU.PortalPaymentGroupId,'' AS PublishState
				FROM ZnodePaymentSetting ZPS
				INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				INNER JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId )
				INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
				INNER JOIN ZnodeProfile ZP ON ZP.ProfileId = YOPU.ProfileId
				INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
				LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId) 
				WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1 AND
					(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId AND YOPU.ProfileId = ZUP.ProfileId)
					OR EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE @UserId = -1 AND ZUP.ProfileId = @GuestProfileId));

				SET @RowsCount=@@ROWCOUNT;
			END
			ELSE
			BEGIN
				SELECT DISTINCT ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,
					ZPS.IsActive,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,
					ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate,ZPPS.PortalId,ZP1.StoreName, 
					NULL IsAssociated ,NULL As ProfileId,NULL As ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName,
						CASE WHEN @PortalId > 0 AND ZPPS.PaymentDisplayName IS NOT NULL
							THEN ZPPS.PaymentDisplayName ELSE ZPS.PaymentDisplayName END PaymentDisplayName, 
					NULL PaymentExternalId, CAST(CASE WHEN YU.PaymentSettingId IS NOT NULL THEN 1 ELSE 0 END As BIT) AS IsApprovalRequired,
					ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,
					YU.PortalPaymentGroupId,'' AS PublishState
				FROM ZnodePaymentSetting ZPS
				INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				LEFT JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId )
				INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
				LEFT JOIN ZnodeProfile ZP ON ZP.ProfileId = YOPU.ProfileId
				INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
				LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
				WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1 AND
					(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId)
					OR EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE @UserId = -1 AND ZUP.ProfileId = @GuestProfileId));

				SET @RowsCount=@@ROWCOUNT;
			END
		END
		--When User is associated with Profile but this Profile is not associated with any portal.
		ELSE IF EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE ((ZUP.UserId = @UserId AND ZUP.ProfileId IS NOT NULL) OR (@UserId = -1 AND ZUP.ProfileId = @GuestProfileId))
							AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalProfile WHERE ProfileId=ZUP.ProfileId AND PortalId=@PortalId))
		BEGIN
			SELECT DISTINCT ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,
				ZPS.IsActive,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,
				ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate,ZPPS.PortalId,ZP1.StoreName, 
				NULL IsAssociated, NULL As ProfileId,ZP.ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName,
					CASE WHEN @PortalId > 0 AND ZPPS.PaymentDisplayName IS NOT NULL
						THEN ZPPS.PaymentDisplayName ELSE ZPS.PaymentDisplayName END PaymentDisplayName, 
				NULL PaymentExternalId, CAST(CASE WHEN YU.PaymentSettingId IS NOT NULL THEN 1 ELSE 0 END As BIT) AS IsApprovalRequired,
				ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,
				YU.PortalPaymentGroupId,'' AS PublishState
			FROM ZnodePaymentSetting ZPS
			INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
			LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
			LEFT JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId )
			INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
			LEFT JOIN ZnodeProfile ZP ON ZP.ProfileId = YOPU.ProfileId
			INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
			LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId) 
			WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1 AND
				(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId)
				OR EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE @UserId = -1 AND ZUP.ProfileId = @GuestProfileId));

			SET @RowsCount=@@ROWCOUNT;
		END
		--When User is not associated with any Profile.
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE (ZUP.UserId = @UserId OR (@UserId = -1 AND ZUP.ProfileId = @GuestProfileId)))
		BEGIN
			SELECT DISTINCT ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,
				ZPS.IsActive,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,
				ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate,ZPPS.PortalId,ZP1.StoreName, 
				NULL IsAssociated ,NULL ProfileId, NULL As ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName,
					CASE WHEN @PortalId > 0 AND ZPPS.PaymentDisplayName IS NOT NULL
						THEN ZPPS.PaymentDisplayName ELSE ZPS.PaymentDisplayName END PaymentDisplayName, 
				NULL PaymentExternalId, CAST(CASE WHEN YU.PaymentSettingId IS NOT NULL THEN 1 ELSE 0 END As BIT) AS IsApprovalRequired,
				ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,
				YU.PortalPaymentGroupId,'' AS PublishState
			FROM ZnodePaymentSetting ZPS
			INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
			LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
			LEFT JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId )
			INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
			LEFT JOIN ZnodeProfile ZP ON ZP.ProfileId = YOPU.ProfileId
			INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
			LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId) 
			WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1;

			SET @RowsCount=@@ROWCOUNT;
		END

		ELSE
		BEGIN
			SELECT DISTINCT ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,
				ZPS.IsActive,ZPS.DisplayOrder AS DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,
				ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate,ZPPS.PortalId,ZP1.StoreName, NULL IsAssociated ,NULL AS ProfileId,
				NULL AS ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName,
				CASE WHEN @PortalId > 0 AND ZPPS.PaymentDisplayName IS NOT NULL
					THEN ZPPS.PaymentDisplayName ELSE ZPS.PaymentDisplayName END PaymentDisplayName, 
				NULL PaymentExternalId, CAST(CASE WHEN YU.PaymentSettingId IS NOT NULL THEN 1 ELSE 0 END As BIT) AS IsApprovalRequired,
				ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,
				YU.PortalPaymentGroupId,'' AS PublishState
			FROM ZnodePaymentSetting ZPS
			INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
			LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
			INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
			INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
			LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
			WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1;

			SET @RowsCount=@@ROWCOUNT;
		END
	END TRY
	BEGIN CATCH
		DECLARE @Status BIT;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(),
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPaymentSettingByUserDetails @PortalId='+CAST(@PortalId AS VARCHAR(50))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50));

		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_GetPaymentSettingByUserDetails',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetShippingListByUserDetails')
	DROP PROC Znode_GetShippingListByUserDetails
GO

CREATE PROCEDURE [dbo].[Znode_GetShippingListByUserDetails]
(
	@PortalId	INT,
	@UserId		INT,
	@RowsCount  INT OUT
)
AS
/*
	Summary: This Procedure is used to get shipping details according to associated profile or portal.

	Unit Testing:

	EXEC [Znode_GetShippingListByUserDetails]  @PortalId=1, @UserId=1, @RowsCount=0
*/
BEGIN
	BEGIN TRY
		SET NOCOUNT ON;
		DECLARE @GuestProfileId INT;

		SELECT TOP 1 @GuestProfileId=ProfileId FROM ZnodeProfile WHERE ProfileName = 'Anonymous' AND @UserId = -1;

		--When any User Profile is associated with the user account
		--OR When User is associated with single Profile.
		--OR When two or more User Profiles are associated with the user account
		IF (EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP 
					INNER JOIN ZnodePortalProfile ZPP ON ZUP.ProfileId=ZPP.ProfileId
					INNER JOIN ZnodeProfileShipping ZPS ON ZUP.ProfileId=ZPS.ProfileId
					INNER JOIN ZnodePortalShipping ZPS1 ON ZPP.PortalId=ZPS1.PortalId AND ZPS.ShippingId=ZPS1.ShippingId
					WHERE ZUP.UserId=@UserId AND ZPP.PortalId=@PortalId)

			OR EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP 
					INNER JOIN ZnodePortalProfile ZPP ON ZUP.ProfileId=ZPP.ProfileId
					INNER JOIN ZnodeProfileShipping ZPS ON ZUP.ProfileId=ZPS.ProfileId
					INNER JOIN ZnodePortalShipping ZPS1 ON ZPP.PortalId=ZPS1.PortalId AND ZPS.ShippingId=ZPS1.ShippingId
					WHERE ZUP.ProfileId=@GuestProfileId AND ZPP.PortalId=@PortalId)
			)
		BEGIN
			IF EXISTS (SELECT TOP 1 1
						FROM ZnodeShipping ZS
						INNER JOIN ZnodeShippingTypes ZST ON (ZST.ShippingTypeId = ZS.ShippingTypeId)
						INNER JOIN ZnodeProfileShipping ZPP ON (ZPP.ShippingId = ZS.ShippingId)
						INNER JOIN ZnodePortalShipping ZPS ON (@PortalId=ZPS.PortalId AND ZS.ShippingId = ZPS.ShippingId)
						INNER JOIN ZnodeProfile ZP ON ZP.ProfileId = ZPP.ProfileId
						INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPS.PortalId
						WHERE ZPS.PortalId = @PortalId AND ZS.IsActive=1 AND
							(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId AND ZPP.ProfileId = ZUP.ProfileId)
							OR EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE @UserId = -1 AND ZUP.ProfileId = @GuestProfileId))
						)
			BEGIN
				SELECT DISTINCT NULL As ProfileId, NULL As ProfileName,ZPS.PortalId, ZP1.StoreName,ZS.ShippingId,ZS.ShippingTypeId,ZS.ShippingCode,
					ZS.HandlingCharge,ZS.HandlingChargeBasedOn,ZS.DestinationCountryCode,ZS.StateCode,ZS.CountyFIPS,ZS.Description,
					ZS.IsActive,ISNULL(ZPP.DisplayOrder, ZS.DisplayOrder) DisplayOrder,ZS.ZipCode,ZS.CreatedDate,ZS.ModifiedDate, 
					NULL IsAssociated ,ZST.Name ShippingTypeName , ZPS.PortalShippingId, NULL As ProfileShippingId,ZS.ShippingName,
					ZST.ClassName,ZS.DeliveryTimeframe
				FROM ZnodeShipping ZS
				INNER JOIN ZnodeShippingTypes ZST ON (ZST.ShippingTypeId = ZS.ShippingTypeId)
				INNER JOIN ZnodeProfileShipping ZPP ON (ZPP.ShippingId = ZS.ShippingId)
				INNER JOIN ZnodePortalShipping ZPS ON (@PortalId=ZPS.PortalId AND ZS.ShippingId = ZPS.ShippingId)
				INNER JOIN ZnodeProfile ZP ON ZP.ProfileId = ZPP.ProfileId
				INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPS.PortalId
				WHERE ZPS.PortalId = @PortalId AND ZS.IsActive=1 AND
					(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId AND ZPP.ProfileId = ZUP.ProfileId)
					OR EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE @UserId = -1 AND ZUP.ProfileId = @GuestProfileId));

				SET @RowsCount=@@ROWCOUNT;
			END

			ELSE
			BEGIN
				SELECT DISTINCT NULL As ProfileId, NULL As ProfileName,ZPS.PortalId, ZP1.StoreName,ZS.ShippingId,ZS.ShippingTypeId,ZS.ShippingCode,
					ZS.HandlingCharge,ZS.HandlingChargeBasedOn,ZS.DestinationCountryCode,ZS.StateCode,ZS.CountyFIPS,ZS.Description,
					ZS.IsActive,ISNULL(ZS.DisplayOrder,'') DisplayOrder,ZS.ZipCode,ZS.CreatedDate,ZS.ModifiedDate, 
					NULL IsAssociated ,ZST.Name ShippingTypeName , ZPS.PortalShippingId, NULL As ProfileShippingId,ZS.ShippingName,
					ZST.ClassName,ZS.DeliveryTimeframe
				FROM ZnodeShipping ZS
				INNER JOIN ZnodeShippingTypes ZST ON (ZST.ShippingTypeId = ZS.ShippingTypeId)
				LEFT JOIN ZnodeProfileShipping ZPP ON (ZPP.ShippingId = ZS.ShippingId)
				INNER JOIN ZnodePortalShipping ZPS ON (@PortalId=ZPS.PortalId AND ZS.ShippingId = ZPS.ShippingId)
				LEFT JOIN ZnodeProfile ZP ON ZP.ProfileId = ZPP.ProfileId
				INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPS.PortalId
				WHERE ZPS.PortalId = @PortalId AND ZS.IsActive=1 AND
					(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId)
					OR EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE @UserId = -1 AND ZUP.ProfileId = @GuestProfileId));
				
				SET @RowsCount=@@ROWCOUNT;
			END
		END
		--When User is associated with Profile but this Profile is not associated with any portal.
		ELSE IF EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE ((ZUP.UserId = @UserId AND ZUP.ProfileId IS NOT NULL) OR (@UserId = -1 AND ZUP.ProfileId = @GuestProfileId))
							AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalProfile WHERE ProfileId=ZUP.ProfileId AND PortalId=@PortalId))
		BEGIN
			SELECT DISTINCT NULL As ProfileId, NULL As ProfileName,ZPS.PortalId, ZP1.StoreName,ZS.ShippingId,ZS.ShippingTypeId,ZS.ShippingCode,
				ZS.HandlingCharge,ZS.HandlingChargeBasedOn,ZS.DestinationCountryCode,ZS.StateCode,ZS.CountyFIPS,ZS.Description,
				ZS.IsActive,ISNULL(ZPP.DisplayOrder, ZS.DisplayOrder) DisplayOrder,ZS.ZipCode,ZS.CreatedDate,ZS.ModifiedDate, 
				NULL IsAssociated ,ZST.Name ShippingTypeName , ZPS.PortalShippingId, NULL As ProfileShippingId,ZS.ShippingName,
				ZST.ClassName,ZS.DeliveryTimeframe
			FROM ZnodeShipping ZS
			INNER JOIN ZnodeShippingTypes ZST ON (ZST.ShippingTypeId = ZS.ShippingTypeId)
			LEFT JOIN ZnodeProfileShipping ZPP ON (ZPP.ShippingId = ZS.ShippingId)
			INNER JOIN ZnodePortalShipping ZPS ON (@PortalId=ZPS.PortalId AND ZS.ShippingId = ZPS.ShippingId)
			LEFT JOIN ZnodeProfile ZP ON ZP.ProfileId = ZPP.ProfileId
			INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPS.PortalId
			WHERE ZPS.PortalId = @PortalId AND ZS.IsActive=1 AND
				(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId)
				OR EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE @UserId = -1 AND ZUP.ProfileId = @GuestProfileId));

			SET @RowsCount=@@ROWCOUNT;
		END
		--When User is not associated with any Profile.
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE (ZUP.UserId = @UserId OR (@UserId = -1 AND ZUP.ProfileId = @GuestProfileId)))
		BEGIN
			SELECT DISTINCT NULL As ProfileId, NULL As ProfileName, ZPS.PortalId, ZP1.StoreName,ZS.ShippingId,ZS.ShippingTypeId,ZS.ShippingCode,
				ZS.HandlingCharge,ZS.HandlingChargeBasedOn,ZS.DestinationCountryCode,ZS.StateCode,ZS.CountyFIPS,ZS.Description,
				ZS.IsActive,ISNULL(ZPP.DisplayOrder, ZS.DisplayOrder) DisplayOrder,ZS.ZipCode,ZS.CreatedDate,ZS.ModifiedDate, 
				NULL IsAssociated ,ZST.Name ShippingTypeName , ZPS.PortalShippingId, NULL As ProfileShippingId,ZS.ShippingName,
				ZST.ClassName,ZS.DeliveryTimeframe
			FROM ZnodeShipping ZS
			INNER JOIN ZnodeShippingTypes ZST ON (ZST.ShippingTypeId = ZS.ShippingTypeId)
			LEFT JOIN ZnodeProfileShipping ZPP ON (ZPP.ShippingId = ZS.ShippingId)
			INNER JOIN ZnodePortalShipping ZPS ON (@PortalId=ZPS.PortalId AND ZS.ShippingId = ZPS.ShippingId)
			LEFT JOIN ZnodeProfile ZP ON ZP.ProfileId = ZPP.ProfileId
			INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPS.PortalId
			WHERE ZPS.PortalId = @PortalId AND ZS.IsActive=1;

			SET @RowsCount=@@ROWCOUNT;
		END
		ELSE
		BEGIN
			SELECT DISTINCT NULL ProfileId,NULL ProfileName, ZPS.PortalId, ZP1.StoreName,ZS.ShippingId,ZS.ShippingTypeId,ZS.ShippingCode,
				ZS.HandlingCharge,ZS.HandlingChargeBasedOn,ZS.DestinationCountryCode,ZS.StateCode,ZS.CountyFIPS,ZS.Description,
				ZS.IsActive,ISNULL(ZS.DisplayOrder,'') DisplayOrder,ZS.ZipCode,ZS.CreatedDate,ZS.ModifiedDate, 
				NULL IsAssociated ,ZST.Name ShippingTypeName, ZPS.PortalShippingId, NULL ProfileShippingId,ZS.ShippingName,
				ZST.ClassName,ZS.DeliveryTimeframe
			FROM ZnodeShipping ZS
			INNER JOIN ZnodeShippingTypes ZST ON (ZST.ShippingTypeId = ZS.ShippingTypeId)
			INNER JOIN ZnodePortalShipping ZPS ON (@PortalId=ZPS.PortalId AND ZS.ShippingId = ZPS.ShippingId)
			INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPS.PortalId
			WHERE ZPS.PortalId = @PortalId AND ZS.IsActive=1;

			SET @RowsCount=@@ROWCOUNT;
		END
	END TRY
	BEGIN CATCH
		DECLARE @Status BIT;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(),
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetShippingListByUserDetails @PortalId='+CAST(@PortalId AS VARCHAR(50))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50));

        SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

        EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_GetShippingListByUserDetails',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCustomer')
	DROP PROC Znode_ImportCustomer
GO

CREATE PROCEDURE [dbo].[Znode_ImportCustomer]
(
	  @TableName NVARCHAR(100), 
	  @Status BIT OUT, 
	  @UserId INT, 
	  @ImportProcessLogId INT, 
	  @NewGUId NVARCHAR(200), 
	  @LocaleId INT= 0,
	  @PortalId INT ,
	  @CsvColumnString NVARCHAR(max)
)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Customer Details
	
	-- Unit Testing : 
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(max),@AspNetZnodeUserId NVARCHAR(256),@ASPNetUsersId NVARCHAR(256),
		@PasswordHash NVARCHAR(max),@SecurityStamp NVARCHAR(max),@RoleId NVARCHAR(256),@IsAllowGlobalLevelUserCreation NVARCHAR(10)
		Declare @ProfileId  INT
		DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		 
		SET @SecurityStamp = '0wVYOZNK4g4kKz9wNs-UHw2'
		SET @PasswordHash = 'APy4Tm1KbRG6oy7h3r85UDh/lCW4JeOi2O2Mfsb3OjkpWTp1YfucMAvvcmUqNaSOlA==';

		SELECT  @RoleId  = Id FROM AspNetRoles WHERE   NAME = 'User'  

		SELECT @IsAllowGlobalLevelUserCreation = FeatureValues FROM ZnodeGlobalsetting WHERE FeatureName = 'AllowGlobalLevelUserCreation'

		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
		-- Retrive RoundOff Value FROM global setting 
		Delete from ZnodeImportLog where ErrorDescription = '42' and ColumnName like '%AccountCode%' and  ImportProcessLogId= @ImportProcessLogId
		
		
		
		-- Three type of import required three table varible for product , category and brand
		CREATE TABLE #InsertCustomer 
		( 
			RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, UserName NVARCHAR(512) ,FirstName	NVARCHAR(200),
			LastName NVARCHAR(200), BudgetAmount	NUMERIC,Email	NVARCHAR(100),PhoneNumber	NVARCHAR(100),
		    EmailOptIn	varchar(100)	,ReferralStatus	NVARCHAR(40),IsActive	varchar(100)	,ExternalId	NVARCHAR(max),CreatedDate DATETIME,
			ProfileName varchar(200),AccountCode NVARCHAR(100),DepartmentName varchar(300),RoleName NVARCHAR(256), GUID NVARCHAR(400)
			,PerOrderLimit INT,	PerOrderAnnualLimit NVARCHAR(100),BillingAccountNumber NVARCHAR(100),EnableUserShippingAddressSuggestion  NVARCHAR(100),
			EnablePowerBIReportOnWebStore BIT,Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),
			Custom4 NVARCHAR(max),Custom5 NVARCHAR(max), SMSOptIn varchar(100)
		);

		SET @SSQL = 'INSERT INTO #InsertCustomer( RowNumber,' + @CsvColumnString + ',GUID)
		             SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+ @TableName;
		
		EXEC sys.sp_sqlexec @SSQL;

	    --If Account Code Exists then it will update as it is and if not exists then it will show error.
		UPDATE IC set AccountCode = ZA.AccountCode 
		FROM ZnodeUser a
		inner join ZnodeAccount ZA on (ZA.AccountId = a.AccountId)
		INNER JOIN #InsertCustomer IC on (IC.UserName = a.UserName)
		WHERE ISNULL(IC.AccountCode,'') = '' AND ISNULL(IC.RoleName,'') <> ''

		if @CsvColumnString not like '%AccountCode%'
		begin
			--If Acount Code Exists then it will update as it is and if not exists then it will show error.
			update IC set AccountCode = ZA.AccountCode
			FROM ZnodeUser a
			inner join ZnodeAccount ZA on (ZA.AccountId = a.AccountId)
			INNER JOIN #InsertCustomer IC on (IC.UserName = a.UserName)
			WHERE isnull(IC.AccountCode,'') = '' --and isnull(IC.RoleName,'') <> ''
		end
		
		SELECT TOP 1 @ProfileId   =  ProfileId FROM ZnodePortalprofile WHERE Portalid = @Portalid and IsDefaultRegistedProfile=1
		IF( Isnull(@ProfileId ,0) = 0 ) 
		Begin
		
		
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '62', 'Default Portal Profile', '', @NewGUId, 1 , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
							
				UPDATE ZnodeImportProcessLog
				SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
				WHERE ImportProcessLogId = @ImportProcessLogId;
			

				SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog 
				WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
				SELECT @SuccessRecordCount = 0

				UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
				TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
				WHERE ImportProcessLogId = @ImportProcessLogId;

				DELETE FROM #InsertCustomer 
				SET @Status = 0;

				COMMIT TRAN A;
				Return 0 
		End

		--If @IsAllowGlobalLevelUserCreation = 'false'  
		--BEGIN
		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		--SELECT '10', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		--FROM #InsertCustomer AS ii  
		--WHERE ltrim(rtrim(ii.UserName)) in   
		--(  
		--SELECT UserName FROM AspNetZnodeUser   where PortalId = @PortalId  
		--);  
		--END
		--Else   
		IF @IsAllowGlobalLevelUserCreation = 'true'
		BEGIN
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '10', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM #InsertCustomer AS ii  
			WHERE ltrim(rtrim(ii.UserName)) in   
			(  
			SELECT UserName FROM AspNetZnodeUser     
			);  
		END


		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '104', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName not like '%_@_%_.__%' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '35', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName like '%;%'
				
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '30', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ltrim(rtrim(ii.UserName)) IN 
		(SELECT ltrim(rtrim(UserName))  FROM #InsertCustomer GROUP BY ltrim(rtrim(UserName))  having count(*) > 1 )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '104', 'Email', Email, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.Email not like '%_@_%_.__%' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'IsActive',  IsActive , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '77', 'AccountCode', ii.AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer ii 
		WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !='' 
		AND NOT EXISTS(SELECT * FROM ZnodeAccount za INNER JOIN ZnodePortalAccount zpa on za.AccountId = zpa.AccountId
			WHERE  ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za.AccountCode and zpa.PortalId = @PortalId )
		AND EXISTS(SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount za1 WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za1.AccountCode );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '73', 'AccountCode', AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !=''   and ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') not IN 
		(
			SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount   
		);


		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '75', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') ='' and ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '74', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE --ltrim(rtrim(ii.RoleName)) not IN ('User','Manager','Administrator') and ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and
			ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and not exists (SELECT top 1 1 FROM  AspNetRoles ANR WHERE name IN ('User','Manager','Administrator') and  ANR.name =ii.RoleName)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '76', 'DepartmentName', DepartmentName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') <> ''
		AND NOT EXISTS(SELECT * FROM  ZnodeAccount ZA INNER JOIN ZnodeDepartment ZD on ZA.AccountId = ZD.AccountId
			WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = ltrim(rtrim(za.AccountCode))
			and ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') = ltrim(rtrim(ZD.DepartmentName)))

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'EmailOptIn',  EmailOptIn , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.EmailOptIn NOT IN ('True','1','Yes','FALSE','0','No','');

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'SMSOptIn',  SMSOptIn , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.SMSOptIn NOT IN ('True','1','Yes','FALSE','0','No','');

		UPDATE ZIL
		SET ZIL.ColumnName =   ZIL.ColumnName + ' [ UserName - ' + ISNULL(UserName,'') + ' ] '
		FROM ZnodeImportLog ZIL 
		INNER JOIN #InsertCustomer IPA ON (ZIL.RowNumber = IPA.RowNumber)
		WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		--Note : Content page import is not required 
		
		-- END Function Validation 	
		-----------------------------------------------
		--- Delete Invalid Data after functional validatin  

		DELETE FROM #InsertCustomer
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
			--AND GUID = @NewGUID
		);


		-- Update Record count IN log 
        
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		SELECT @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertCustomer
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- END

		-- Insert Product Data 
				
				
				DECLARE @InsertedAspNetZnodeUser TABLE (AspNetZnodeUserId NVARCHAR(256) ,UserName NVARCHAR(512),PortalId INT )
				DECLARE @InsertedASPNetUsers TABLE (Id NVARCHAR(256) ,UserName NVARCHAR(512))
				DECLARE @InsertZnodeUser TABLE (UserId INT,AspNetUserId NVARCHAR(256),CreatedDate DATETIME )

				UPDATE ANU SET 
				ANU.PhoneNumber	= IC.PhoneNumber, 
					ANU.LockoutEndDateUtc = case when IC.IsActive IN('0','No','False') then @GetDate when IC.IsActive IN('1','Yes','True') then null else ANU.LockoutEndDateUtc END
				FROM AspNetZnodeUser ANZU 
				INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
				WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
				----Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

				UPDATE ZU SET 
				ZU.FirstName	= IC.FirstName,
				ZU.LastName		= IC.LastName,
				--ZU.MiddleName	= IC.MiddleName,
				ZU.BudgetAmount = IC.BudgetAmount,
				ZU.Email		= IC.Email,
				ZU.PhoneNumber	= IC.PhoneNumber,
				ZU.EmailOptIn	= (CASE IC.EmailOptIn WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.EmailOptIn,0) As BIT) END),
				ZU.IsActive		= (CASE IC.IsActive WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.IsActive,0) As BIT) END),
				ZU.Custom1 = IC.Custom1,
				ZU.Custom2 = IC.Custom2,
				ZU.Custom3 = IC.Custom3,
				ZU.Custom4 = IC.Custom4,
				ZU.Custom5 = IC.Custom5,
				ZU.SMSOptIn	= (CASE IC.SMSOptIn WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 WHEN ISNULL(IC.SMSOptIn,'') THEN ZU.SMSOptIn ELSE CAST(ISNULL(IC.SMSOptIn,0) As BIT) END)
				--ZU.ExternalId = ExternalId
				FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
				WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
				--WHERE Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

				INSERT INTO AspNetZnodeUser (AspNetZnodeUserId, UserName, PortalId)		
				OUTPUT INSERTED.AspNetZnodeUserId, INSERTED.UserName, INSERTED.PortalId	INTO  @InsertedAspNetZnodeUser 			 
				SELECT NEWID(),IC.UserName, @PortalId FROM #InsertCustomer IC 
				WHERE NOT EXISTS (SELECT TOP 1 1  FROM AspNetZnodeUser ANZ 
					WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZ.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END 
					AND ANZ.UserName = IC.UserName)

				INSERT INTO ASPNetUsers (Id,Email,EmailConfirmed,PasswordHash,SecurityStamp,PhoneNumber,PhoneNumberConfirmed,TwoFactorEnabled,
				LockoutEndDateUtc,LockOutEnabled,AccessFailedCount,PasswordChangedDate,UserName)
				OUTPUT inserted.Id, inserted.UserName INTO @InsertedASPNetUsers
				SELECT NewId(), Email,0 ,@PasswordHash,@SecurityStamp,PhoneNumber,0,0,case when A.IsActive IN ('0','False','No') then @GetDate else null END LockoutEndDateUtc,1 LockoutEnabled,
				0,@GetDate,AspNetZnodeUserId FROM #InsertCustomer A INNER JOIN @InsertedAspNetZnodeUser  B 
				ON A.UserName = B.UserName
			
				INSERT INTO  ZnodeUser(AspNetUserId,FirstName,LastName,CustomerPaymentGUID,Email,PhoneNumber,EmailOptIn,
				IsActive,ExternalId, CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,UserName,Custom1,Custom2,Custom3,Custom4,Custom5,SMSOptIn)
				OUTPUT Inserted.UserId, Inserted.AspNetUserId,Inserted.CreatedDate INTO @InsertZnodeUser
				SELECT IANU.Id AspNetUserId ,IC.FirstName,IC.LastName,null CustomerPaymentGUID,IC.Email
				,IC.PhoneNumber,
				(CASE IC.EmailOptIn WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.EmailOptIn,0) As BIT) END),
				(CASE IC.IsActive WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.IsActive,0) As BIT) END),
				IC.ExternalId, @UserId,
				CASE WHEN IC.CreatedDate IS NULL OR IC.CreatedDate = '' THEN  @Getdate ELSE IC.CreatedDate END,
				@UserId,@Getdate,IC.UserName,IC.Custom1,IC.Custom2,IC.Custom3,IC.Custom4,IC.Custom5,
					(CASE IC.SMSOptIn WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.SMSOptIn,0) As BIT) END)
				FROM #InsertCustomer IC INNER JOIN 
				@InsertedAspNetZnodeUser IANZU ON IC.UserName = IANZU.UserName  INNER JOIN 
				@InsertedASPNetUsers IANU ON IANZU.AspNetZnodeUserId = IANU.UserName 
	  	     
				INSERT INTO AspNetUserRoles (UserId,RoleId)  SELECT AspNetUserId, @RoleID FROM @InsertZnodeUser 
				INSERT INTO ZnodeUserPortal (UserId,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
				SELECT UserId, @PortalId , @UserId, IZU.CreatedDate,@UserId,@Getdate 
				FROM @InsertZnodeUser IZU

				INSERT INTO ZnodeAccountUserPermission(UserId,AccountPermissionAccessId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT UserId, 4 , @UserId, @Getdate,@UserId,@Getdate 
				FROM @InsertZnodeUser IZU
		
				------------INSERT INTO ZnodeUserGlobalAttributeValue
	
				IF OBJECT_ID('tempdb..#globaldata') IS NOT NULL 
					DROP TABLE #globaldata
				
				SELECT ZU.userid,PerOrderLimit,
					PerOrderAnnualLimit,
					BillingAccountNumber,
					EnableUserShippingAddressSuggestion,
					EnablePowerBIReportOnWebStore 
				INTO #globaldata
				FROM znodeuser ZU INNER JOIN  #InsertCustomer IC on IC.Email =ZU.EMAIL
				WHERE ZU.userid IN (SELECT userid FROM @InsertZnodeUser)
				GROUP BY ZU.userid,PerOrderLimit,
									PerOrderAnnualLimit,
									BillingAccountNumber,
									EnableUserShippingAddressSuggestion,
									EnablePowerBIReportOnWebStore 

				IF OBJECT_ID('tempdb..#globaldata1') IS NOT NULL DROP TABLE #globaldata1
				SELECT * INTO #globaldata1 FROM (SELECT userid, Cast(PerOrderLimit as varchar(100)) PerOrderLimit,
				 Cast(PerOrderAnnualLimit as varchar(100)) PerOrderAnnualLimit,
				 Cast(BillingAccountNumber as varchar(100)) BillingAccountNumber,
				 Cast(case when cast(EnableUserShippingAddressSuggestion as varchar(10))= '1' or cast(EnableUserShippingAddressSuggestion as varchar(10)) ='YES' or  cast(EnableUserShippingAddressSuggestion as varchar(10)) ='True' then 'True' else 'False'  END  as varchar(100)) EnableUserShippingAddressSuggestion,
				 Cast(case when cast(EnablePowerBIReportOnWebStore as varchar(10))= '1'  or cast(EnablePowerBIReportOnWebStore as varchar(10)) ='YES' or  cast(EnablePowerBIReportOnWebStore as varchar(10)) ='True' then 'True' else 'False' END  as varchar(100)) EnablePowerBIReportOnWebStore FROM #globaldata) ab
				UNPIVOT  
				   (avalue FOR acode IN   
					  (PerOrderLimit,
				PerOrderAnnualLimit,
				BillingAccountNumber,
				EnableUserShippingAddressSuggestion,
				EnablePowerBIReportOnWebStore)  
				)AS unpvt;  

				INSERT INTO ZnodeUserGlobalAttributeValue (UserId,	GlobalAttributeId,	GlobalAttributeDefaultValueId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
				SELECT g.Userid,ZGA.GlobalAttributeId,null,null,@UserId,@Getdate,@UserId,@Getdate
					FROM #globaldata1 g INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.acode
					WHERE NOT EXISTS (SELECT top 1 1 FROM ZnodeUserGlobalAttributeValue ZGAV WHERE ZGAV.Userid =g.Userid and ZGA.GlobalAttributeId=ZGAV.GlobalAttributeId)

				INSERT INTO ZnodeUserGlobalAttributeValuelocale(UserGlobalAttributeValueId,	LocaleId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate,	GlobalAttributeDefaultValueId,	MediaId,	MediaPath)
				SELECT UserGlobalAttributeValueId, @LocaleId,avalue ,@UserId,@Getdate,@UserId,@Getdate,null,null,null
					FROM ZnodeUserGlobalAttributeValue ZUGAV INNER JOIN #globaldata1 g on ZUGAV.userid =g.userid
						INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.acode and ZGA.GlobalAttributeId = ZUGAV.GlobalAttributeId
						WHERE NOT EXISTS (SELECT Top 1 1 FROM ZnodeUserGlobalAttributeValuelocale z WHERE z.UserGlobalAttributeValueId = ZUGAV.UserGlobalAttributeValueId)

				---------------------------------------------------------------------------------

				declare @Profile table (ProfileId INT)

				INSERT INTO ZnodeProfile (ProfileName,ShowOnPartnerSignup,Weighting,TaxExempt,DefaultExternalAccountNo,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ParentProfileId)
				OUTPUT inserted.ProfileId INTO @Profile(ProfileId)
				SELECT Distinct ProfileName, 0, null,0, replace(ltrim(rtrim(ProfileName)),' ','') as DefaultExternalAccountNo, @UserId,@Getdate, @UserId,@Getdate, null as ParentProfileId				
				FROM #InsertCustomer IC
				WHERE NOT EXISTS(SELECT * FROM ZnodeProfile ZP WHERE IC.ProfileName = ZP.ProfileName )
				AND ISNULL(ic.ProfileName,'') <> ''

				INSERT INTO ZnodePortalProfile (PortalId,	ProfileId,	IsDefaultAnonymousProfile,	IsDefaultRegistedProfile,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
				SELECT @PortalId, ProfileId, 0 AS IsDefaultAnonymousProfile, 0 AS IsDefaultRegistedProfile, @UserId,@Getdate, @UserId,@Getdate
				FROM @Profile

				UPDATE ZnodeUserProfile 
				SET ProfileId = COALESCE(ZP.ProfileId,@ProfileId)
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeUserProfile u ON u.UserId = a.UserId
				LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
				--WHERE IC.ProfileName <> ''
				
				INSERT INTO ZnodeUserProfile (ProfileId,UserId,IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT COALESCE(ZP.ProfileId,@ProfileId)  , a.UserId, 1 , @UserId,a.CreatedDate,@UserId,@Getdate 
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeUserProfile u WHERE u.UserId = a.UserId )
				AND EXISTS(SELECT * FROM @InsertZnodeUser IZU WHERE A.UserId = IZU.UserId)

				---to update accountid agaist user
				UPDATE ZU SET ZU.AccountId = ZA.AccountId 
				FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	 
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName
				INNER JOIN ZnodeAccount ZA ON ZA.AccountCode = IC.AccountCode 
				--INNER JOIN @InsertZnodeUser IZU on IZU.UserId =ZU.UserId
				WHERE Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0) and isnull(IC.AccountCode,'') <> '' 
				--EXISTS (SELECT * FROM #InsertCustomer IC WHERE IC.AccountCode = ZA.AccountCode AND ISNULL(IC.AccountCode,'') = '' AND ISNULL(IC.RoleName,'') <> '' )

				
				update ZDU set ZDU.DepartmentId = ZD.DepartmentId, ModifiedBy = @UserId, ModifiedDate = @Getdate
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
				INNER JOIN ZnodeDepartmentUser ZDU on ZDU.UserId = a.UserId
				WHERE isnull(IC.DepartmentName,'') <> ''


				INSERT INTO ZnodeDepartmentUser(UserId,DepartmentId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT a.UserId, ZD.DepartmentId, @UserId,a.CreatedDate,@UserId,@Getdate 
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeDepartmentUser u WHERE u.UserId = a.UserId)
				AND isnull(IC.DepartmentName,'') <> ''
		
				update u set u.RoleId = ZD.Id
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
				INNER JOIN AspNetUserRoles u on u.UserId = b.Id
				WHERE isnull(IC.RoleName,'') <> '' 

				--when RoleName and AccountCode is null in update file then If a value was available previously, then it should be removed (along with Department and Role Name) 
				--after the update process is complete.
				DELETE UR FROM AspNetUserRoles UR 
				INNER JOIN ZnodeUser ZC	ON  ZC.AspNetUserId = UR.UserId
				WHERE EXISTS (SELECT * FROM #InsertCustomer IC WHERE IC.UserName = ZC.UserName AND (ISNULL(IC.RoleName,'') = '' AND ISNULL(IC.AccountCode,'') = ''))


				UPDATE ZnodeUser SET AccountId = NULL 
				WHERE EXISTS (SELECT * FROM #InsertCustomer IC WHERE IC.UserName = ZnodeUser.UserName AND ISNULL(IC.AccountCode,'') = '' AND ISNULL(IC.RoleName,'') = '' )		

		
				INSERT INTO AspNetUserRoles(UserId,RoleId)
				SELECT b.Id as ASPNetUserId, case when ZD.Id is null then @RoleId else ZD.Id end  as RoleId
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				LEFT JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM AspNetUserRoles u WHERE u.UserId = b.Id)
				AND ISNULL(IC.AccountCode,'') <> ''
			
				--If no value was available previously then no value should be saved after the update process is complete.
				--If a value was available previously, then it should be removed after the update process is complete.
				DELETE DU FROM ZnodeDepartmentUser DU
				INNER JOIN ZnodeUser ZU ON DU.UserId = ZU.UserId
				INNER JOIN ZnodeDepartment ZC ON  ZC.DepartmentId = DU.DepartmentId
				WHERE EXISTS (SELECT * FROM #INSERTCUSTOMER IC WHERE IC.UserName = ZU.UserName AND (ISNULL(IC.DepartmentName,'') = '' OR ISNULL(IC.ACCOUNTCODE,'') = ''))


		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
		 DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCustomer @TableName = '+CAST(@TableName AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@PortalId='+CAST(@PortalId AS VARCHAR(10))+',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max));
              	
		 ---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

        EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportCustomer',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetShoppingfeedProductFeedList')
	DROP PROC Znode_GetShoppingfeedProductFeedList
GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetXmlProductFeedList')
	DROP PROC Znode_GetXmlProductFeedList
GO

CREATE PROCEDURE [dbo].[Znode_GetXmlProductFeedList]  
(
	@PortalId   VARCHAR(2000) = NULL,   
	@LocaleId   INT,  
	@FeedType   NVARCHAR(MAX) = NULL   
)
AS  
/*  
Summary: This Procedure is used to get effective keyword feeding of Product list  
 SELECT * FROM ZnodePublishProductDetail  
 SELECT * FROM ZnodePublishProduct WHERE PublishCatalogId = 3  
 SELECT * FROM ZnodePortalCatalog   
 Unit Testing:  
 EXEC [Znode_GetXmlProductFeedList] @PortalId='0',@ProductIds = '116,117,118'  
 ,@LocaleId=1,@FeedType='Bing'   
  
*/  
BEGIN  
BEGIN TRY  
SET NOCOUNT ON;        
           
		IF OBJECT_ID('tempdb..#TBL_DomainName') IS NOT NULL
		DROP TABLE #TBL_DomainName

		IF OBJECT_ID('tempdb..#TBL_SEODetails') IS NOT NULL
		DROP TABLE #TBL_SEODetails

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_PortalIds') IS NOT NULL
		DROP TABLE #TBL_PortalIds

		DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
		CREATE TABLE #TBL_DomainName 
		(PortalId   INT,
		DomainName NVARCHAR(300),
		RowId      INT
		);  	
         
		CREATE TABLE #TBL_SEODetails   
		(loc                   NVARCHAR(MAX),  
		lastmod               DATETIME,  
		[g:condition]         VARCHAR(1000),  
		[description]         NVARCHAR(MAX),  
		[g:id]                INT,  
		link                  VARCHAR(1000),  
		[g:identifier_exists] VARCHAR(2000),  
		DomainName            NVARCHAR(3000),  
		PortalId              INT , 
		SEOCode             NVARCHAR(4000), 
		CanonicalURL        VARCHAR(2000), 
		RobotTag            VARCHAR(500)
		);  
		
		DECLARE @DefaultLocaleId INT=dbo.Fn_GetDefaultLocaleId()  ;
		CREATE TABLE #TBL_PortalIds (PortalId INT);  
		
		INSERT INTO #TBL_PortalIds  

		SELECT Zp.PortalId   
		FROM Znodeportal AS ZP   
		INNER JOIN ZnodePortalCatalog AS ZPC ON(ZPC.PortalId = Zp.PortalId)  
		INNER JOIN ZnodePublishCatalog AS ZPPC ON(ZPPC.PublishCatalogId = ZPC.PublishCatalogId)   
		INNER JOIN ZNodePublishProduct AS ZPP ON(ZPP.PublishCatalogId = ZPPC.PublishCatalogId)  
		INNER JOIN ZnodePublishProductDetail AS PPD ON (PPD.PublishProductId = ZPP.PublishProductId)  
		WHERE
		
		EXISTS(SELECT TOP 1 1 FROM DBO.Split(@PortalId, ',') AS Sp  
		WHERE(CAST(sp.Item AS INT)) = Zp.PortalId  OR @PortalId = '0')  
		AND EXISTS (SELECT TOP 1 1 FROM ZnodeDomain ZD WHERE ZP.PortalId = ZD.PortalId  
		AND IsActive = 1 AND ApplicationType = 'Webstore' AND IsDefault = 1)  
		GROUP BY Zp.PortalId;   
		
		INSERT INTO #TBL_DomainName   
		SELECT  PortalId,DomainName,ROW_NUMBER() OVER(PARTITION BY PortalId ORDER BY DomainName)   
		FROM ZnodeDomain AS ZD   
		WHERE EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZD.PortalId)  
		AND IsActive = 1 AND ApplicationType = 'Webstore' AND IsDefault = 1 
 
			SELECT DISTINCT ZCSD.CMSSEODetailId,ZCSD.SEOURL AS loc,ZCSD.ModifiedDate AS lastmod,'new' AS [g:condition],ZCSDL.SEODescription AS [description],ZPCC.PublishProductId AS [g:id],  
            ZCSD.SEOUrl AS link,'false' AS [g:identifier_exists],TBDN.DomainName,ZPC.PortalId,ISNULL(ZCSDL.LocaleId, @DefaultLocaleId) AS LocaleId , ZCSD.SEOCode , ZCSDL.CanonicalURL, ZCSDL.RobotTag 
			INTO #Cte_SeoDetailsWithLocale
			FROM ZNodePublishProduct AS ZPCC   
			INNER JOIN ZnodePortalCatalog AS ZPC ON(ZPC.PublishCatalogId = ZPCC.PublishCatalogId)  
			LEFT JOIN ZnodePublishProductDetail AS PPD ON (PPD.PublishProductId = ZPCC.PublishProductId)  
			LEFT JOIN ZnodeCMSSEODetail AS ZCSD ON(PPD.SKU = ZCSD.SEOCode and ZCSD.PortalId = ZPC.PortalId)  
			LEFT JOIN ZnodeCMSSEOType AS ZCST ON(ZCST.CMSSEOTypeId = ZCSD.CMSSEOTypeId AND ZCST.Name = 'Product')  
			LEFT JOIN ZnodeCMSSEODetailLocale AS ZCSDL ON(ZCSDL.CMSSEODetailId = ZCSD.CMSSEODetailId AND ZCSDL.LocaleId IN(@LocaleId, @DefaultLocaleId))  
			LEFT JOIN #TBL_DomainName AS TBDN ON(TBDN.RowId = 1 AND TBDN.PortalId = zpc.PortalId)   
			WHERE EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZPC.PortalId)  
				
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag  
			INTO #Cte_SeoDetailsWithFirstLocale
			FROM #Cte_SeoDetailsWithLocale   
			WHERE LocaleId = @LocaleId  
    
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode , CanonicalURL, RobotTag 
			INTO #Cte_SeoDetailsWithDefaultLocale
			FROM #Cte_SeoDetailsWithFirstLocale  
			
			INSERT INTO #Cte_SeoDetailsWithDefaultLocale 
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag  
			FROM #Cte_SeoDetailsWithLocale AS CTSDWL  
			WHERE LocaleId = @DefaultLocaleId   
			AND NOT EXISTS(SELECT TOP 1 1 FROM #Cte_SeoDetailsWithFirstLocale AS CTSDWDL WHERE CTSDWDL.CMSSEODetailId = CTSDWL.CMSSEODetailId)  
          
			INSERT INTO #TBL_SEODetails  
			SELECT DISTINCT loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId ,SEOCode, CanonicalURL, RobotTag  
			FROM #Cte_SeoDetailsWithDefaultLocale;  
			
			SELECT TBSD.loc,TBSD.lastmod,TBSD.[g:condition],TBSD.[description],TBSD.[g:id],TBSD.link,TBSD.[g:identifier_exists],TBSD.DomainName,TBSD.PortalId,  
			CASE WHEN SUM(ZI.Quantity) > 0 THEN 'In Stock' ELSE CASE WHEN @FeedType = 'Xml' THEN 'Out Of Stock' ELSE 'Not In Stock' END  
			END AS [g:availability],
			ZPPD.SKU ,TBSD.SEOCode, TBSD.CanonicalURL, TBSD.RobotTag, ZPP.PublishProductId,ZPPD.ProductName
			INTO #TBL_CompleteDetailes  
			FROM ZnodePublishProduct AS ZPP   
			LEFT JOIN #TBL_SEODetails AS TBSD ON(ZPP.PublishProductId = TBSD.[g:id] )  
			LEFT JOIN ZnodePublishProductDetail AS ZPPD ON(ZPPD.PublishProductId = ZPP.PublishProductId AND ZPPD.LocaleId = @LocaleId)  
			LEFT JOIN ZnodePortalWarehouse AS ZPW ON(ZPW.PortalId = TBSD.PortalId)  
			LEFT JOIN ZnodePortalAlternateWarehouse AS ZAPW ON(ZAPW.PortalWarehouseId = ZPW.PortalWarehouseId)  
			LEFT JOIN ZnodeInventory AS ZI ON(ZI.SKU = ZPPD.SKU AND (ZI.WarehouseId = ZPW.WarehouseId OR ZI.WarehouseId = ZAPW.WarehouseId))  			
			GROUP BY loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,TBSD.PortalId,ZPPD.SKU,ZPPD.LocaleId, TBSD.SEOCode, TBSD.CanonicalURL, TBSD.RobotTag, ZPP.PublishProductId,ZPPD.ProductName;    
			
			DECLARE @MediaConfiguration NVARCHAR(2000)=((SELECT TOP 1 ISNULL(CASE WHEN CDNURL = '' THEN NULL ELSE CDNURL END,URL) FROM ZnodeMediaConfiguration WHERE IsActive = 1));    
  
			CREATE INDEX Idx_#TBL_CompleteDetailes ON #TBL_CompleteDetailes(PortalId,SKU)
	
	
			SELECT zp.PortalId,round(ZPS.RetailPrice,2) as RetailPrice,Zps.SKU,tbcd.SEOCode,ROW_NUMBER() OVER(PARTITION BY Zps.SKU,zp.PortalId ORDER BY ZPS.RetailPrice) AS RowId  
			INTO #Cte_PortalList
			FROM ZnodePriceList AS ZPL   
			LEFT JOIN ZnodePriceListPortal AS ZPLP ON ZPL.PriceListId = ZPLP.PriceListId  
			LEFT JOIN ZnodeCulture AS zc ON ZPL.CultureId = zc.CultureId
			LEFT JOIN ZnodePortal AS zp ON ZPLP.PortalId = zp.PortalId  
			LEFT JOIN ZnodePrice AS Zps ON(Zps.PriceListId = ZPL.PriceListId)   
			LEFT JOIN #TBL_CompleteDetailes AS TBCD ON(TBCD.PortalId = Zp.PortalId AND TBCD.SKU = Zps.Sku)   
			WHERE CAST(@GetDate AS DATE) BETWEEN ZPL.ActivationDate AND ZPL.ExpirationDate   
			AND EXISTS( SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZPLP.PortalId)   
			GROUP BY zp.PortalId,ZPS.RetailPrice,Zps.SKU ,TBCD.SEOCode  
			
			SELECT D.PublishProductId,C.AttributeDefaultValueCode AS Brand
			INTO #BrandDetails
			FROM ZnodePimAttributeValue A
			INNER JOIN ZnodePimProductAttributeDefaultValue B ON B.PimAttributeValueId=A.PimAttributeValueId
			INNER JOIN ZnodePimAttributeDefaultValue C ON C.PimAttributeDefaultValueId=A.PimAttributeDefaultValueId	
			INNER JOIN Znodepublishproduct D ON  A.PimProductId = D.PimProductId 
			WHERE EXISTS(SELECT * FROM ZnodePimAttribute D WHERE D.PimAttributeId=A.PimAttributeId AND D.AttributeCode='Brand' )
			AND EXISTS(SELECT * FROM #TBL_CompleteDetailes E Where E.PublishProductId = D.PublishProductId)		
			
			SELECT A.CategoryName , A.ZnodeProductId AS PublishProductId, ROW_NUMBER() OVER(PARTITION BY A.ZnodeProductId ORDER BY A.ZnodeProductId) AS RowId
			INTO #ProductCategories
			FROM ZnodePublishProductEntity A 
			WHERE EXISTS(SELECT * FROM #TBL_CompleteDetailes B WHERE A.ZnodeProductId = B.PublishProductId)
			AND ISNULL(A.CategoryName,'') <> ''

			DELETE FROM #ProductCategories WHERE RowId <> 1
 
			SELECT SKU,SUM(cast(Quantity as numeric(28,0)))AS Inventory 
			into #InventotyDetails 
			FROM ZnodeInventory A 
			WHERE EXISTS(SELECT * FROM #TBL_CompleteDetailes B where A.SKU=B.SKU)
			GROUP BY SKU  

			SELECT F.PublishProductId,[Path] AS ImagePath
			INTO #ProductImage
			FROM ZnodePimAttributeValue a
			INNER JOIN ZnodePimProductAttributeMedia b on a.PimAttributeValueId = b.PimAttributeValueId
			INNER JOIN ZnodeMedia d on b.MediaId = d.MediaId
			INNER JOIN Znodepublishproduct F ON  A.PimProductId = F.PimProductId 
			WHERE EXISTS(SELECT * FROM ZnodePimAttribute C WHERE C.PimAttributeId=A.PimAttributeId AND C.AttributeCode='PRODUCTIMAGE' )
			AND EXISTS(SELECT * FROM #TBL_CompleteDetailes E Where E.PublishProductId = F.PublishProductId)		

						 
			SELECT 
			CAST(DomainName AS nvarchar(MAX) ) as DomainName,
			CAST(ProductName AS nvarchar(50) ) AS Title,
			--lastmod,
			--[g:condition],
			CAST([description] AS nvarchar(MAX) ) AS [Description],
			CAST([g:id] AS nvarchar(50) ) AS ProductID,
			CAST([g:availability] AS nvarchar(50) ) as [Availability],
			--[g:identifier_exists],	
			--TBCD.PortalId,
			Cast(CAST(CTPL.RetailPrice AS numeric(28,3))as nvarchar(100)) AS Price,
			@MediaConfiguration AS MediaConfiguration,
			--TBCD.SEOCode,
			--TBCD.CanonicalURL,
			--TBCD.RobotTag,
			CAST(PC.CategoryName AS nvarchar (50)) AS Category,
			CAST(ID.Inventory AS nvarchar(50) ) AS Inventory,
			CAST(BD.Brand AS nvarchar(50) ) AS Brand,
			CAST(ID.SKU AS nvarchar(50) ) AS ID,
			CAST(link AS nvarchar(MAX) ) AS Link,
			CAST(PM.IMAGEPATH AS nvarchar(MAX) ) AS Image_Link
			FROM #TBL_CompleteDetailes AS TBCD   
			LEFT JOIN #Cte_PortalList AS CTPL ON(CTPL.PortalId = TBCD.PortalId AND CTPL.SKU = TBCD.SKU AND CTPL.RowID = 1)  
			LEFT JOIN #ProductCategories PC ON TBCD.PublishProductId = PC.PublishProductId
			LEFT JOIN #InventotyDetails ID ON TBCD.SKU = ID.SKU 
			LEFT JOIN #BrandDetails BD on TBCD.PublishProductId=BD.PublishProductId
			LEFT JOIN #ProductImage PM on TBCD.PublishProductId=PM.PublishProductId
			WHERE  EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = TBCD.PortalId)

		IF OBJECT_ID('tempdb..#TBL_DomainName') IS NOT NULL
		DROP TABLE #TBL_DomainName

		IF OBJECT_ID('tempdb..#TBL_SEODetails') IS NOT NULL
		DROP TABLE #TBL_SEODetails

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_PortalIds') IS NOT NULL
		DROP TABLE #TBL_PortalIds
		
END TRY  
BEGIN CATCH  
	DECLARE @Status BIT ;  
	SET @Status = 0;  
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetXmlProductFeedList @PortalId = '+@PortalId+',@LocaleId='+CAST(@LocaleId AS VARCHAR(50))+',@FeedType='+CAST(@FeedType AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));  
                 
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
     
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_GetXmlProductFeedList',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
   
END;

GO

INSERT INTO Znodeproductfeedtype (ProductFeedTypeCode,ProductFeedTypeName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 'Xml','XML Product Feed',2,GETDATE(),2,GETDATE()  
where not exists(select * from Znodeproductfeedtype where ProductFeedTypeCode ='Xml')

Delete from Znodeproductfeedtype where ProductFeedTypeCode = 'Shoppingfeed'

GO

update ZnodeGlobalAttribute 
set HelpDescription='Enabling this will make it mandatory for the customers to login, before they perform any activities on the webstore.'
where HelpDescription='Enabling this will make it mandatory for the customers to login, before they perform any activities on the web store.'

update ZnodeGlobalAttribute 
set HelpDescription='Enabling this will make it mandatory for customers to log in to their account, in order to see the Price and Stock information of products on the webstore.'
where HelpDescription='Enabling this will make it mandatory for customers to log in to their account, in order to see the Price and Stock information of products on the web-store.'

update ZnodeGlobalAttribute 
set HelpDescription='When Yes is selected, the stock level of products from default warehouse and total stock level from all the warehouses will get displayed on the product listing page on the webstore. When No is selected, the total stock level from all warehouses will get displayed.'
where HelpDescription='When Yes is selected, the stock level of products from default warehouse and total stock level from all the warehouses will get displayed on the product listing page on the web-store. When No is selected, the total stock level from all warehouses will get displayed.'

update ZnodeGlobalAttribute 
set HelpDescription='When enabled, customers will be able to create Quote Requests from webstore.'
where HelpDescription='When enabled, customers will be able to create Quote Requests from web store.'

update ZnodeGlobalAttribute 
set HelpDescription='When enabled, customers will be able to create return requests for the eligible orders from the webstore.'
where HelpDescription='When enabled, customers will be able to create return requests for the eligible orders from the web store'

GO

Update znodemessage set MessageName='Input value is required in alphanumeric format without spaces.'
where MessageName= 'Input value is required in alphanumeric format without spaces'

GO

Update znodemessage set MessageName='Include Account Code first to add a Role Name.'
where MessageName= 'Account Code must be included to import/update a Role Name.'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishStatus')
	DROP PROC Znode_GetPublishStatus
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishStatus]
(
	@WhereClause NVARCHAR(MAX),
    @Rows        INT           = 100,
    @PageNo      INT           = 1,
    @Order_BY    VARCHAR(100)  = '',
    @RowsCount   INT OUT
)
AS 
/*
	 Summary :- This Procedure is used to get the publish status of the catalog 
	 Unit Testig 
	 EXEC  Znode_GetPublishStatus_TP '',10,1,'',0
*/
   BEGIN 
		BEGIN TRY 
		SET NOCOUNT ON 

		 DECLARE @SQL  NVARCHAR(max) 
		 DECLARE @TBL_CatalogId TABLE (PublishCatalogLogId INT,PublishStatus VARCHAR(300),UserName NVARCHAR(512),PublishCategoryCount INT ,PublishProductCount INT ,CreatedDate DATETIME ,ModifiedDate DATETIME ,RowId INT ,CountId INT)
	 
		 SET @SQL = '

		  DECLARE @TBL_PublishProductId TABLE (PublishProductId int,PublishCatalogId int )
		INSERT INTO @TBL_PublishProductId
		SELECT COUNT( DISTINCT PublishProductId ),PublishCatalogId
		FROM ZnodePublishCategoryProduct a
		WHERE PublishCatalogId IN  (select PublishCatalogId from ZnodePublishCatalog b where a.PublishCatalogId = b.PublishCatalogId)
		AND a.PublishCategoryId  <> 0 and a.PublishCategoryId is not null
		GROUP BY PublishCatalogId 


		 ;With Cte_CatalogLog AS
		 (
		 SELECT PublishCatalogLogId,CASE WHEN IsCatalogPublished IS NULL THEN ''Processing'' WHEN IsCatalogPublished = 0 THEN ''Publish Failed''
         WHEN IsCatalogPublished = 1 THEN  ''Published Successfully'' END   PublishStatus ,APZU.UserName ,ISNULL(ZPCL.PublishCategoryId,0) PublishCategoryCount,
		 ISNULL(ZPCL.PublishProductId,0) PublishProductCount,ZPCL.CreatedDate,ZPCL.ModifiedDate ,PimCatalogId
	     FROM ZnodePublishCatalogLog  ZPCL 
		 LEFT JOIN ZnodeUser ZU ON (ZU.UserId = ZPCL.CreatedBy )
	     LEFT JOIN AspNetUsers APU ON (APU.Id = ZU.AspNetUserId) 
		 LEFT JOIN AspNetZnodeUser APZU ON (APZU.AspNetZnodeUserId = APU.UserName)
		 LEFT JOIN  @TBL_PublishProductId a on (zpcl.PublishCatalogId = a.PublishCatalogId)
		 )
	 
	     ,Cte_PublishStatus 
		 AS (SELECT PublishCatalogLogId, PublishStatus ,UserName , PublishCategoryCount, PublishProductCount,CreatedDate,ModifiedDate ,
		 '+[dbo].[Fn_GetPagingRowId](@Order_BY,'PublishCatalogLogId DESC')+' , Count(*)Over() CountId FROM Cte_CatalogLog
         WHERE 1=1 '+[dbo].[Fn_GetFilterWhereClause](@WhereClause)+' )
	 
		 SELECT PublishCatalogLogId,PublishStatus,UserName,PublishCategoryCount,PublishProductCount,CreatedDate,ModifiedDate,RowId,CountId 
		 FROM Cte_PublishStatus 
		 '+[dbo].[Fn_GetPaginationWhereClause](@PageNo,@Rows)+' '
	
		 PRINT @SQL
		 INSERT INTO @TBL_CatalogId
		 EXEC (@SQL)

		 SELECT  PublishCatalogLogId,PublishStatus,UserName,PublishCategoryCount,PublishProductCount,CreatedDate,ModifiedDate
		 FROM @TBL_CatalogId

		 SET @RowsCount = ISNULL((SELECT TOP 1 COUNTID FROM @TBL_CatalogId),0)
	 
		 END TRY 
		 BEGIN CATCH 
			DECLARE @Status BIT ;
			SET @Status = 0;
			DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishStatus @WhereClause = '+@WhereClause+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
			SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
			EXEC Znode_InsertProcedureErrorLog
					@ProcedureName = 'Znode_GetPublishStatus',
					@ErrorInProcedure = @Error_procedure,
					@ErrorMessage = @ErrorMessage,
					@ErrorLine = @ErrorLine,
					@ErrorCall = @ErrorCall;
		 END CATCH 
   END

GO

UPDATE ZnodeGlobalAttribute 
SET HelpDescription='hello world.. Enabling this will make it mandatory for the customers to login, before performing any activities on the webstore.'
WHERE HelpDescription='hello world.. Enabling this will make it mandatory for the customers to login, before performing any activities on the web store.'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportHighlight')
	DROP PROC Znode_ImportHighlight
GO

CREATE PROCEDURE [dbo].[Znode_ImportHighlight](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		-- Retrive RoundOff Value from global setting 
		DECLARE @InsertPimAtrribute TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY,
			RowNumber int, HighlightCode varchar(300), HighlightName varchar(1000),DisplayPopup varchar(300),Hyperlink varchar(1000),HighlightType varchar(300),IsActive varchar(100),DisplayOrder int,HighlightImage varchar(500),HighlightImagePath varchar(500), Description varchar(max), ShortDescription varchar(max), ImageAltTag varchar(400), GUID nvarchar(400)
		
		);
		DECLARE @InsertedPimAttributeIds TABLE (PimAttributeId int ,PimAttributeDefaultValueId int,AttributeDefaultValueCode nvarchar(300))
		
		SET @SSQL = 'Select RowNumber,HighlightCode, HighlightName,DisplayPopup,Hyperlink,HighlightType,IsActive,DisplayOrder,HighlightImage,HighlightImagePath,Description,ShortDescription,ImageAltTag ,GUID FROM '+@TableName;
		INSERT INTO @InsertPimAtrribute( RowNumber,HighlightCode, HighlightName,DisplayPopup,Hyperlink,HighlightType,IsActive,DisplayOrder,HighlightImage,HighlightImagePath,Description,ShortDescription,ImageAltTag ,GUID)
		EXEC sys.sp_sqlexec @SSQL;


		--@MessageDisplay will use to display validate message for input inventory value  
		DECLARE @HighlightAttributeDefaultCode TABLE
		( 
		   AttributeDefaultCode nvarchar(300)
		);
		INSERT INTO @HighlightAttributeDefaultCode
			   SELECT AttributeDefaultValueCode
			   FROM ZnodePimAttributeDefaultValue ZPADV
			   inner join ZnodePimAttribute ZPA on ZPADV.PimAttributeId = ZPA.PimAttributeId
			   where ZPA.AttributeCode = 'Highlights' 

		-- Start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '118', 'HighlightCode', HighlightCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.HighlightCode not in 
			   (
				   SELECT AttributeDefaultCode FROM @HighlightAttributeDefaultCode 
			   );
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'DisplayPopup', DisplayPopup, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.DisplayPopup not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '103', 'HighlightType', HighlightType, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.HighlightType NOT in 
			   (
				   SELECT HT.Name  FROM ZnodeHighlightType  HT
			   );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '17', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL ) AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '115', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 999

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '79', 'HighlightCode', HighlightCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.HighlightCode,''))) like '% %' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '53', 'HighlightCode', HighlightCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.HighlightCode in 
			   (
				   select HighlightCode  FROM @InsertPimAtrribute  Group BY HighlightCode  having count(*) > 1 
			   );

		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ Highlight - ' + ISNULL(HighlightCode,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN @InsertPimAtrribute IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL


		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertPimAtrribute
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertPimAtrribute
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;
		

		DECLARE @MediaId INT
		SET @MediaId = (SELECT TOP 1 MediaId from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.HighlightImage = ZM.FileName and IPA.HighlightImagePath = ZM.Path)

		if (isnull(@MediaId,0)=0)
			SET @MediaId = (SELECT max(MediaId) from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.HighlightImage = ZM.FileName)

		DECLARE @InsertedZnodeHighlight TABLE(HighlightId INT,HighlightCode VARCHAR(600)) 

			UPDATE ZH SET ZH.DisplayPopup = IPA.DisplayPopup, ZH.Hyperlink = IPA.Hyperlink, ZH.IsActive = case when IPA.IsActive in ('True','1','Yes') then 1 else 0 end,
			       ZH.DisplayOrder = IPA.DisplayOrder , ZH.ModifiedBy = @UserId, ZH.ModifiedDate = @GetDate 
			FROM @InsertPimAtrribute IPA 
			INNER JOIN ZnodeHighlightType ZHT on IPA.HighlightType = ZHT.Name
			INNER JOIN ZnodeHighlight ZH ON IPA.HighlightCode = ZH.HighlightCode and ZHT.HighlightTypeId = ZH.HighlightTypeId

			UPDATE ZHL SET ZHL.Name = IPA.HighlightName, ZHL.Description = IPA.Description, ZHL.ShortDescription = IPA.ShortDescription, ZHL.ImageAltTag = IPA.ImageAltTag
			       , ZHL.ModifiedBy = @UserId, ZHL.ModifiedDate = @GetDate 
			FROM @InsertPimAtrribute IPA 
			INNER JOIN ZnodeHighlightType ZHT on IPA.HighlightType = ZHT.Name
			INNER JOIN ZnodeHighlight ZH ON IPA.HighlightCode = ZH.HighlightCode and ZHT.HighlightTypeId = ZH.HighlightTypeId
			INNER JOIN ZnodeHighlightLocale ZHL  ON ZH.HighlightId = ZHL.HighlightId 

			INSERT INTO ZnodeHighlight (MediaId,HighlightCode,DisplayPopup,Hyperlink,HighlightTypeId,IsActive,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			OUTPUT Inserted.HighlightId,Inserted.HighlightCode INTO @InsertedZnodeHighlight
			SELECT DISTINCT @MediaId,IPA.HighlightCode, IPA.DisplayPopup , IPA.Hyperlink, ZHT.HighlightTypeId,
				   case when IPA.IsActive in ('True','1','Yes') then 1 else 0 end, Case when Isnull(IPA.DisplayOrder,0) = 0 then  999 else IPA.DisplayOrder end  , @UserId , @GetDate ,@UserId , @GetDate 
			FROM @InsertPimAtrribute IPA 
			INNER JOIN ZnodeHighlightType ZHT on IPA.HighlightType = ZHT.Name
			WHERE NOT EXISTS(select * from ZnodeHighlight ZH where ZH.HighlightCode = IPA.HighlightCode and ZH.HighlightTypeId = ZHT.HighlightTypeId)

			INSERT INTO ZnodeHighlightLocale(LocaleId,HighlightId,ImageAltTag,Name,Description,ShortDescription,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT DISTINCT @LocaleId, IZH.HighlightId, IPA.ImageAltTag, IPA.HighlightName, IPA.Description, IPA.ShortDescription, @UserId , @GetDate ,@UserId , @GetDate
			FROM @InsertPimAtrribute IPA 
			INNER JOIN @InsertedZnodeHighlight IZH on IPA.HighlightCode = IZH.HighlightCode 


		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportHighlight @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportHighlight',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		
		
	END CATCH;
END;

GO

UPDATE znodemessage
SET MessageName='Input value is required in alphanumeric format without spaces and must start with an alphabet.'
WHERE MessageName= 'Input value is required in alphanumeric format without spaces.'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportBrands')
	DROP PROC Znode_ImportBrands
GO

CREATE PROCEDURE [dbo].[Znode_ImportBrands](
	  @TableName			NVARCHAR(100), 
	  @Status				BIT OUT, 
	  @UserId				INT, 
	  @ImportProcessLogId	INT, 
	  @NewGUId				NVARCHAR(200),
	  @LocaleId	            INT= 1
	  )
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Made a provision to import Brand details.
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN Brands;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate();
		IF isnull(@LocaleId,0)=0
		BEGIN
			SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		END
		-- Retrive RoundOff Value from global setting 

		DECLARE @InsertBrandData TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY,RowNumber int, BrandCode varchar(400),IsActive varchar(100), BrandDescription varchar(600) default null,
			SEOKeyword varchar(600) default null,SEODescription varchar(600) default null, BrandLogo varchar(400) default null,SEOTitle varchar(400) default null,
			SEOFriendlyPageName varchar(600) default null,URLKey varchar(200) default null, Custom1 varchar(600) default null,Custom2 varchar(600) default null,
			Custom3 varchar(600) default null,Custom4 varchar(600) default null,Custom5 varchar(600) default null, GUID nvarchar(400)
		);	
			
		SET @SSQL = 'Select RowNumber,BrandCode, IsActive,ISNULL(NULLIF(BrandDescription, ''''), null) BrandDescription,ISNULL(NULLIF(SEOKeyword, ''''), null) SEOKeyword,ISNULL(NULLIF(SEODescription, ''''), null) SEODescription,ISNULL(NULLIF(BrandLogo, ''''), null) BrandLogo,
						ISNULL(NULLIF(SEOTitle, ''''), null) SEOTitle,ISNULL(NULLIF(SEOFriendlyPageName, ''''), null) SEOFriendlyPageName ,ISNULL(NULLIF(URLKey, ''''), null) URLKey,ISNULL(NULLIF(Custom1, ''''), null) Custom1,ISNULL(NULLIF(Custom2, ''''), null) Custom2,
						ISNULL(NULLIF(Custom3, ''''), null) Custom3,ISNULL(NULLIF(Custom4, ''''), null) Custom4,ISNULL(NULLIF(Custom5, ''''), null) Custom5,GUID FROM '+@TableName;
		INSERT INTO @InsertBrandData( RowNumber,BrandCode, IsActive,BrandDescription,SEOKeyword,SEODescription,BrandLogo,
										SEOTitle,SEOFriendlyPageName,URLKey,Custom1,Custom2,Custom3,Custom4,Custom5,GUID)				
		EXEC sys.sp_sqlexec @SSQL;
		
		-- Start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '8', 'BrandCode', BrandCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertBrandData AS ii
			   WHERE isnull(BrandCode,'')=''			   
			  

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '121', 'BrandCode', BrandCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertBrandData AS ii
			   WHERE  not exists 
				   (
						select * from ZnodePimAttributeDefaultValue zpadv
						inner join ZnodePimAttribute zpa on zpa.PimAttributeId=zpadv.PimAttributeId
						where AttributeCode='Brand' and AttributeDefaultValueCode=ii.BrandCode
				   );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '8', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertBrandData AS ii  
			WHERE isnull(ii.IsActive,'')=''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertBrandData AS ii  
			WHERE isnull(ii.IsActive,'') not in ('True','1','Yes','FALSE','0','No')
			
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '82', 'SEOKeyword', SEOKeyword, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertBrandData AS ii
			  WHERE len(ltrim(rtrim(ii.SEOKeyword))) > 300 and isnull(ii.SEOKeyword,'')<>''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '82', 'SEODescription', SEODescription, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertBrandData AS ii
			   WHERE len(ltrim(rtrim(ii.SEODescription))) > 300 and isnull(ii.SEODescription,'')<>''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '45', 'BrandLogo', BrandLogo, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertBrandData AS ii			 
			   WHERE reverse(left(reverse(ii.BrandLogo),charindex('.',reverse(ii.BrandLogo)))) 
			   not in (select ValidationName from View_FamilyExtensions where FamilyCode='Image')
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '45', 'BrandLogo', BrandLogo, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertBrandData AS ii			 
			   WHERE isnull(BrandLogo,'')<>'' and not exists (select * from ZnodeMedia where FileName=ii.BrandLogo)

  
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '81', 'SEOTitle', SEOTitle, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertBrandData AS ii
			   WHERE len(ltrim(rtrim(ii.SEOTitle))) > 200 and isnull(ii.SEOTitle,'')<>''		
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '102', 'SEOFriendlyPageName', SEOFriendlyPageName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertBrandData AS ii  
			WHERE (isnull(ii.SEOFriendlyPageName,'') LIKE '%[^a-zA-Z0-9]%' and  isnull(ii.SEOFriendlyPageName,'') NOT LIKE '%[_-]%' )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '81', 'URLKey', URLKey, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertBrandData AS ii  
			WHERE len(ltrim(rtrim(ii.URLKey))) > 200 and isnull(ii.URLKey,'')<>''			


		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ Brand - ' + ISNULL(BrandCode,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN @InsertBrandData IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertBrandData
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertBrandData
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;
		
		--<Begin Data Updation>
		CREATE TABLE #InsertedBrands (BrandId INT,BrandCode nvarchar(100),CMSSEODetailId int ) 
		
		UPDATE zbd set BrandCode=ibd.BrandCode,WebsiteLink=isnull(ibd.URLKey,WebsiteLink),IsActive=isnull(ibd.IsActive,zbd.IsActive),ModifiedBy=@UserId,
					   ModifiedDate=Getdate(),Custom1=isnull(ibd.Custom1,zbd.custom1),Custom2=isnull(ibd.Custom2,zbd.custom2),Custom3=isnull(ibd.Custom3,zbd.custom3),Custom4=isnull(ibd.Custom4,zbd.custom4),
					   Custom5=ISNULL(ibd.Custom5, zbd.Custom5)      
		OUTPUT INSERTED.BrandId ,INSERTED.BrandCode INTO  #InsertedBrands (BrandId, BrandCode)
		from ZnodeBrandDetails zbd
		inner join @InsertBrandData IBD on ibd.BrandCode=zbd.BrandCode
	
	
		UPDATE zbdl set zbdl.BrandId=zbd.BrandId,zbdl.Description=isnull(ibd.BrandDescription,zbdl.Description),SEOFriendlyPageName=isnull(IBD.SEOFriendlyPageName,zbdl.SEOFriendlyPageName),
		LocaleId=@LocaleId,ModifiedBy=@UserId,ModifiedDate=getdate(),BrandName=isnull(ibd.BrandCode,zbdl.BrandName)
		FROM ZnodeBrandDetailLocale zbdl
		inner join ZnodeBrandDetails zbd on zbd.BrandId=zbdl.BrandId
		inner join @InsertBrandData IBD on ibd.BrandCode=zbd.BrandCode
		inner join #InsertedBrands ib on ib.BrandId=zbdl.BrandId

		UPDATE ZCD set SEOId=ib.BrandId,SEOUrl=isnull(ibd.SEOFriendlyPageName,zcd.SEOUrl),ModifiedBy=@UserId,ModifiedDate=getdate(),
					   SEOCode=isnull(ibd.BrandCode,zcd.SEOCode)
		OUTPUT INSERTED.SEOId ,INSERTED.SEOCode, INSERTED.CMSSEODetailId INTO  #InsertedBrands (BrandId, BrandCode,CMSSEODetailId) 
		FROM ZnodeCMSSEODetail ZCD		
		inner join #InsertedBrands ib on ib.BrandId=ZCD.SEOId
		inner join @InsertBrandData IBD on ibd.BrandCode=zcd.SEOCode
		where exists (select null from ZnodeBrandDetailLocale zbdl where zbdl.BrandId=ZCD.SEOId)
		
		--<Delete Records Having Null Value>
		Delete from #InsertedBrands where isnull(CMSSEODetailId,0)=0
		--</Delete Records Having Null Value>
		
		UPDATE zcdl set CMSSEODetailId =isnull(ib.CMSSEODetailId,zcdl.CMSSEODetailId),LocaleId=@LocaleId,SEOTitle=isnull(ibd.SEOTitle,zcdl.SEOTitle),
						SEODescription=isnull(ibd.SEODescription,zcdl.SEODescription),SEOKeywords=isnull(ibd.SEOKeyword,zcdl.SEOKeywords),ModifiedBy=@UserId,ModifiedDate=getdate()
		FROM ZnodeCMSSEODetailLocale zcdl
		inner join #InsertedBrands ib on ib.CMSSEODetailId=zcdl.CMSSEODetailId
		inner join @InsertBrandData IBD on ibd.BrandCode=ib.BrandCode
		--</End Data Updation>
        
		--<Begin Data Insert>
		insert into ZnodeBrandDetails(BrandCode,MediaId,WebsiteLink,DisplayOrder,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Custom1,Custom2,Custom3,
										Custom4,Custom5)
		OUTPUT INSERTED.BrandId ,INSERTED.BrandCode INTO  #InsertedBrands (BrandId, BrandCode) 		
		Select ibd.BrandCode,(select top 1 MediaId from ZnodeMedia where FileName=ibd.BrandLogo order by CreatedDate desc),ibd.URLKey,0,ibd.IsActive,@UserId,GETDATE(),@UserId,Getdate(),ibd.Custom1,ibd.Custom2,ibd.Custom3,ibd.Custom4,ibd.Custom5
		from @InsertBrandData IBD	
		WHERE NOT EXISTS(SELECT * FROM ZnodeBrandDetails ZBD WHERE ZBD.BrandCode = IBD.BrandCode )		

		insert into ZnodeBrandDetailLocale (BrandId,Description,SEOFriendlyPageName,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,BrandName)
		select ac.BrandId,ibdl.BrandDescription,ibdl.SEOFriendlyPageName,@LocaleId,@UserId,getdate(),@UserId,GETDATE(),ibdl.BrandCode 
		from @InsertBrandData IBDL
		INNER JOIN #InsertedBrands ac on ac.BrandCode=ibdl.BrandCode
		WHERE NOT EXISTS(SELECT * FROM ZnodeBrandDetailLocale a 
							INNER JOIN ZnodeBrandDetails b on a.BrandId=b.BrandId AND b.BrandCode=ibdl.BrandCode )		

		insert into ZnodeCMSSEODetail (CMSSEOTypeId,SEOId,SEOUrl,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SEOCode,PublishStateId)
		OUTPUT INSERTED.SEOId ,INSERTED.SEOCode, INSERTED.CMSSEODetailId INTO  #InsertedBrands (BrandId, BrandCode,CMSSEODetailId)
		select (select CMSSEOTypeId  from ZnodeCMSSEOType where Name = 'Brand'),ac.BrandId,ibdl.SEOFriendlyPageName,@UserId,getdate(),@UserId,getdate(),ibdl.BrandCode,'2'
		from @InsertBrandData IBDL
		INNER JOIN #InsertedBrands ac on ac.BrandCode=ibdl.BrandCode
		WHERE NOT EXISTS(SELECT * FROM ZnodeCMSSEODetail a 
							INNER JOIN ZnodeBrandDetails b on b.BrandCode=ibdl.BrandCode 
							AND a.CMSSEOTypeId=(select CMSSEOTypeId  from ZnodeCMSSEOType where Name = 'Brand')  )
		
		--<Delete Records Having Null Value>
		Delete from #InsertedBrands where isnull(CMSSEODetailId,0)=0
		--</Delete Records Having Null Value>

		insert into ZnodeCMSSEODetailLocale (CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		select ac.CMSSEODetailId ,@LocaleId,ibdl.SEOTitle,ibdl.SEODescription,ibdl.SEOKeyword,@UserId,GETDATE(),@UserId,Getdate()
		from @InsertBrandData IBDL
		INNER JOIN #InsertedBrands ac on ac.BrandCode=ibdl.BrandCode
		WHERE NOT EXISTS(SELECT * FROM ZnodeCMSSEODetailLocale a 
							INNER JOIN ZnodeCMSSEODetail b on a.CMSSEODetailId=b.CMSSEODetailId
							INNER JOIN ZnodeBrandDetails c on c.BrandCode=ibdl.BrandCode 
							AND b.CMSSEOTypeId=(select CMSSEOTypeId  from ZnodeCMSSEOType where Name = 'Brand')  )		
        --<End Data Insert>

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN Brands;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN Brands

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		 DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportBrands @TableName = '+CAST(@TableName AS VARCHAR(max)) +',
		 @Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@LocaleId='+CAST(@LocaleId AS VARCHAR(200));

		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportBrands',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportValidatePimProductData')
	DROP PROC Znode_ImportValidatePimProductData
GO

CREATE PROCEDURE [dbo].[Znode_ImportValidatePimProductData]
(   @ImportHeadName     VARCHAR(200),
    @TableName          VARCHAR(200),
    @NewGUID            NVARCHAR(200),
    @TemplateId         INT,
    @UserId             INT,
    @LocaleId           INT           = 1,
    @IsCategory         INT           = 0,
    @DefaultFamilyId    INT           = 0,
    @ImportProcessLogId INT,
    @PriceListId        INT,
	@CountryCode VARCHAR(100) = '',
	@PimCatalogId         INT    = 0 ,
	@PortalId int = 0,
	@IsAccountAddress bit = 0 )
AS
     SET NOCOUNT ON;

/*
    Summary :   Import PimProduct / Price / Inventory / Category / Category Associated Data 
    Process :   Admin site will upload excel / csv file in database and create global temporary table
				Procedure Znode_ImportValidatePimProductData will validate data with attribute validation rule
				If datatype validation issue found in input daata will logged into table "ZnodeImportLog"
				If Data is correct and record count in table ZnodeImportLog will be 0 then process for import data into Base tables
				To import data call procedure "Znode_ImportPimProductData"
    		  
				SourceColumnName: CSV file column headers
				TargetColumnName: Attributecode from ZnodePimAttribute Table (Consider those Attributecodes configured with default family only)
*/

     BEGIN
         BEGIN TRY
             SET NOCOUNT ON;
             --BEGIN TRAN TRN_ImportValidProductData;
             DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
             DECLARE @SQLQuery NVARCHAR(MAX), @AttributeTypeName NVARCHAR(100), @AttributeCode NVARCHAR(300), @AttributeId INT, @IsRequired BIT, @SourceColumnName NVARCHAR(600), @ControlName VARCHAR(300), @ValidationName VARCHAR(100), @SubValidationName VARCHAR(300), @ValidationValue VARCHAR(300), @RegExp VARCHAR(300), @CreateDateString NVARCHAR(300), @DefaultLocaleId INT, @ImportHeadId INT, @CheckedSourceColumn NVARCHAR(600)= '', @Status BIT= 0,
			    @CsvColumnString nvarchar(max),
				@FailedRecordCount BIGINT,
				@SuccessRecordCount BIGINT
            --To get the total record count for update purpose in catch block
            SET @SQLQuery = 'SELECT '+CAST(@ImportProcessLogId AS VARCHAR(10))+',COUNT(*) FROM '+@TableName
			INSERT INTO Znode_ImportCsvRowCount
			EXEC (@SQLQuery) 

             DECLARE @FamilyAttributeDetail TABLE
             (PimAttributeId       INT,
              AttributeTypeName    VARCHAR(300),
              AttributeCode        VARCHAR(300),
              SourceColumnName     NVARCHAR(600),
              IsRequired           BIT,
              PimAttributeFamilyId INT
             );
             DECLARE @AttributeDetail TABLE
             (PimAttributeId    INT,
              AttributeTypeName VARCHAR(300),
              AttributeCode     VARCHAR(300),
              SourceColumnName  NVARCHAR(600),
              IsRequired        BIT,
              ControlName       VARCHAR(300),
              ValidationName    VARCHAR(100),
              SubValidationName VARCHAR(300),
              ValidationValue   VARCHAR(300),
              RegExp            VARCHAR(300)
             );

			CREATE TABLE #DefaultAttributeCode
			(AttributeTypeName          VARCHAR(300),
			PimAttributeDefaultValueId INT,
			PimAttributeId             INT,
			AttributeDefaultValueCode  VARCHAR(100)
			);

			IF( @ImportHeadName = 'B2BCustomer' )
			BEGIN
				EXEC ZnodeB2BCustomerMapping @ImportHeadName = @ImportHeadName, @TableName = @TableName
			END
		
             DECLARE @GlobalTempTableColumns TABLE(ColumnName NVARCHAR);
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM INFORMATION_SCHEMA.TABLES
                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#InvalidDefaultData'
             )
                 CREATE TABLE #InvalidDefaultData
                 (RowNumber  INT,
                  Value      NVARCHAR(MAX),
                  ColumnName NVARCHAR(600)
                 );
             ELSE
             DROP TABLE #InvalidDefaultData;
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM INFORMATION_SCHEMA.TABLES
                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#GlobalTempTableColumns'
             )
                 BEGIN

                     SET @SQLQuery = 'SELECT Column_Name, '''+@ImportHeadName+''' AS ImportHeadName  from tempdb.INFORMATION_SCHEMA.COLUMNS	where table_name = object_name(object_id('''+@TableName+'''),
					(select database_id from sys.databases where name = ''tempdb''))';
                     CREATE TABLE #GlobalTempTableColumns
                     (ColumnName   NVARCHAR(MAX),
                      TypeOfImport NVARCHAR(100)
                     );
                     INSERT INTO #GlobalTempTableColumns
                     (ColumnName,
                      TypeOfImport
                     )
                     EXEC sys.sp_sqlexec
                          @SQLQuery;
                 END;

             IF EXISTS
             (
                 SELECT TOP 1 1
                 FROM #GlobalTempTableColumns
                 WHERE ColumnName IN('PimCategoryId', 'PimProductId', 'RowNumber')
             )
                 BEGIN
                     INSERT INTO ZnodeImportLog
                     (ErrorDescription,
                      ColumnName,
                      Data,
                      GUID,
                      CreatedBy,
                      CreatedDate,
                      ModifiedBy,
                      ModifiedDate,
                      ImportProcessLogId
                     )
                     VALUES
                     (43,
                      '',
                      '',
                      @newGUID,
                      @UserId,
                      @GetDate,
                      @UserId,
                      @GetDate,
                      @ImportProcessLogId
                     );
                 END;
             SET @DefaultLocaleId = dbo.Fn_GetDefaultLocaleId();

             IF NOT EXISTS
             (
                 SELECT TOP 1 1  FROM ZnodeImportLog
                 WHERE Guid = @NewGUID
                       AND ErrorDescription IN(43, 42)
                 AND ImportProcessLogId = @ImportProcessLogId
             )
                 BEGIN
                     IF @ImportHeadName = 'Product'
                      BEGIN
						  IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
							  SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimProductId int null ';
						  ELSE 
							 SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimProductId int null Primary KEY CLUSTERED(RowNumber)';
						 
						  EXEC sys.sp_sqlexec @SQLQuery;
			         END;
                     ELSE
                     IF @ImportHeadName = 'Category'
                         BEGIN
							  IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimCategoryId int null ';
							  ElSE
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimCategoryId int null Primary KEY CLUSTERED(RowNumber) ';
						  
							  EXEC sys.sp_sqlexec @SQLQuery;
                         END;
                     ELSE
                         BEGIN
							IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1) ';
							Else 
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1) Primary KEY CLUSTERED(RowNumber)';
							
							EXEC sys.sp_sqlexec @SQLQuery;
                         END;;
                 END;

             SET @CreateDateString = CONVERT(VARCHAR(100), @UserId)+','''+CONVERT(VARCHAR(100), @GetDate)+''','+CONVERT(VARCHAR(100), @UserId)+','''+CONVERT(VARCHAR(100), @GetDate)+''', '+CONVERT(VARCHAR(100), @ImportProcessLogId);

             SELECT TOP 1 @ImportHeadId = ImportHeadId FROM ZnodeImportTemplate WHERE ImportTemplateId = @TemplateId;
             IF @DefaultFamilyId = 0
                AND @ImportHeadName IN('Product', 'Category')
                 BEGIN 
                     --Get all default attribute values in attribute 
                     INSERT INTO @FamilyAttributeDetail
                     (PimAttributeId,
                      AttributeTypeName,
                      AttributeCode,
                      SourceColumnName,
                      IsRequired,
                      PimAttributeFamilyId
                     )
                     --Call Process to insert data of defeult family with source column name and target column name 
                     EXEC Znode_ImportGetTemplateDetails
                          @TemplateId = @TemplateId,
                          @IsValidationRules = 0,
                          @IsIncludeRespectiveFamily = 1,
                          @IsCategory = @IsCategory,
                          @DefaultFamilyId = @DefaultFamilyId;

					---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;
             ELSE
             IF @ImportHeadName IN('Product', 'Category')
                 BEGIN
				 
                     --Get all default attribute values in attribute 
                     INSERT INTO @FamilyAttributeDetail
                     (PimAttributeId,
                      AttributeTypeName,
                      AttributeCode,
                      SourceColumnName,
                      IsRequired,
                      PimAttributeFamilyId
                     )
                     --Call Process to insert data of defeult family with source column name and target column name 
                     EXEC Znode_ImportGetTemplateDetails
                          @TemplateId = @TemplateId,
                          @IsValidationRules = 0,
                          @IsIncludeRespectiveFamily = 1,
                          @IsCategory = @IsCategory,
                          @DefaultFamilyId = @DefaultFamilyId;

					---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;      
             -- Check attributes are manditory and not provided with source table
		   	 
			if @TABLENAME	like '%tempdb..%'
				SET @SQLQuery = 'SELECT 42 AS ErrorDescription , SourceColumnName , '''' , '''+@NewGUID+''','+@CreateDateString+' from ZnodeImportTemplateMapping where ImportTemplateId = '+CONVERT(VARCHAR(100), @TemplateId)+' and ltrim(rtrim(SourceColumnName)) <> '''' AND ltrim(rtrim(SourceColumnName)) not in ( select isnull(Name ,'''') from tempdb.sys.columns where object_id = object_id('''+@TABLENAME+'''));';
			else 
				SET @SQLQuery = 'SELECT 42 AS ErrorDescription , SourceColumnName , '''' , '''+@NewGUID+''','+@CreateDateString+' from ZnodeImportTemplateMapping where ImportTemplateId = '+CONVERT(VARCHAR(100), @TemplateId)+' and ltrim(rtrim(SourceColumnName)) <> '''' AND ltrim(rtrim(SourceColumnName)) not in ( select isnull(Name ,'''') from sys.columns where object_id = object_id('''+@TABLENAME+'''));';
		 
			Declare @Tbl_CsvDynamicColulmns TABLE (ColumnName nvarchar(300), SequenceNumber int, DataType nvarchar(50),IsRequired bit )

			INSERT INTO @Tbl_CsvDynamicColulmns(ColumnName , SequenceNumber , DataType ,IsRequired)
			SELECT DISTINCT ZITM.SourceColumnName ,ZIAV.SequenceNumber, ZIAV.AttributeTypeName, ZIAV.IsRequired
			FROM ZnodeImportAttributeValidation ZIAV LEFT OUTER JOIN 
			ZnodeImportTemplate  ZIT ON ZIT.ImportHeadId =  ZIAV.ImportHeadId AND ZIT.ImportTemplateId  = @TemplateId
			LEFT OUTER JOIN ZnodeImportTemplateMapping  ZITM ON ZITM.ImportTemplateId = ZIT.ImportTemplateId  
			and ZIAV.AttributeCode = ZITM.TargetColumnName
			AND ZITM.ImportTemplateId  = @TemplateId
			WHERE ZIAV.ImportHeadId = @ImportHeadId
			AND ISNULL(ZITM.SourceColumnName,'') <> ''--ORDER BY ZIAV.SequenceNumber


		    SELECT @CsvColumnString = SUBSTRING ((Select ',' +  ISNULL(ColumnName ,'NULL') from @Tbl_CsvDynamicColulmns ORDER BY SequenceNumber FOR XML PATH ('')),2,4000) 


     		INSERT INTO ZnodeImportLog(ErrorDescription, ColumnName, Data, GUID,CreatedBy, CreatedDate,  ModifiedBy,ModifiedDate,ImportProcessLogId
             )
             EXEC sys.sp_sqlexec  @SQLQuery;
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM ZnodeImportLog
                 WHERE Guid = @NewGUID
                       AND ErrorDescription IN(43, 42)
                 AND ImportProcessLogId = @ImportProcessLogId
             )
                 BEGIN
                     --Get all default attribute values in attribute 
                     IF @ImportHeadName IN('Product', 'Category')
                         BEGIN
                             -- Check attributes are manditory and not provided with source table
                             INSERT INTO ZnodeImportLog
                             (ErrorDescription,
                              ColumnName,
                              Data,
                              GUID,
                              CreatedBy,
                              CreatedDate,
                              ModifiedBy,
                              ModifiedDate,
                              ImportProcessLogId
                             )
                                    SELECT '14' AS ErrorDescription,
                                           AttributeCode,
                                           '',
                                           @NewGUID,
                                           @UserId,
                                           @GetDate,
                                           @UserId,
                                           @GetDate,
                                           @ImportProcessLogId
                                    FROM @FamilyAttributeDetail
                                    WHERE ISNULL(SourceColumnName, '') = ''
                                          AND IsRequired = 1;  

                             -- Read all attribute details with their datatype
                             INSERT INTO @AttributeDetail
                             (PimAttributeId,
                              AttributeTypeName,
                              AttributeCode,
                              SourceColumnName,
                              IsRequired,
                              ControlName,
                              ValidationName,
                              SubValidationName,
                              ValidationValue,
                              RegExp
                             )
                             EXEC Znode_ImportGetTemplateDetails
                                  @TemplateId=@TemplateId,
								  @DefaultFamilyId=@DefaultFamilyId;

							---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
							Delete FAD from @AttributeDetail FAD
							where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
							and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
										   inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode) 

                             DELETE FROM @AttributeDetail
                             WHERE AttributeTypeName = 'Image'
                                   AND ValidationName <> 'IsAllowMultiUpload';
							DELETE FROM @AttributeDetail
                             WHERE AttributeTypeName = 'File'
                                   AND ValidationName <> 'IsAllowMultiUpload';

                                     INSERT INTO #DefaultAttributeCode
                                     (AttributeTypeName,
                                      PimAttributeDefaultValueId,
                                      PimAttributeId,
                                      AttributeDefaultValueCode
                                     )
                                     --Call Process to insert default data value 
                                     EXEC Znode_ImportGetPimAttributeDefaultValue;

                                     DELETE FROM #DefaultAttributeCode
                                     WHERE AttributeTypeName = 'Yes/No';

                         END;
                     ELSE
                         BEGIN
					
					
                             --Read all attribute details with their datatype
                             INSERT INTO @AttributeDetail
                             (AttributeTypeName,
                              AttributeCode,
                              SourceColumnName,
                              IsRequired,
                              ControlName,
                              ValidationName,
                              SubValidationName,
                              ValidationValue,
                              RegExp
                             )
                             EXEC [Znode_ImportGetOtherTemplateDetails]
                                  @TemplateId = @TemplateId,
                                  @ImportHeadId = @ImportHeadId;

							IF @ImportHeadName IN('B2BCustomer')
							BEGIN

								INSERT INTO @AttributeDetail
								 (PimAttributeId,
								 AttributeTypeName,
								  AttributeCode,
								  SourceColumnName,
								  IsRequired,
								  ControlName,
								  ValidationName,
								  SubValidationName,
								  ValidationValue,
								  RegExp
								 )
								 EXEC [Znode_ImportGetGlobalTemplateDetails]
									  @TemplateId = @TemplateId,
									  @ImportHeadId = @ImportHeadId;

								
								INSERT INTO #DefaultAttributeCode
								(AttributeTypeName,
								PimAttributeDefaultValueId,
								PimAttributeId,
								AttributeDefaultValueCode
								)
								--Call Process to insert default data value 
								EXEC Znode_ImportGetGlobalAttributeDefaultValue;

								DELETE FROM #DefaultAttributeCode
								WHERE AttributeTypeName = 'Yes/No';

							END
						
                             --Check attributes are not mapped with any family of Pim Product
                             INSERT INTO ZnodeImportLog
                             (ErrorDescription,
                              ColumnName,
                              Data,
                              GUID,
                              CreatedBy,
                              CreatedDate,
                              ModifiedBy,
                              ModifiedDate,
                              ImportProcessLogId
                             )
                                    SELECT DISTINCT
                                           '14' AS ErrorDescription,
                                           AttributeCode,
                                           '',
                                           @NewGUID,
                                           @UserId,
                                           @GetDate,
                                           @UserId,
                                           @GetDate,
                                           @ImportProcessLogId
                                    FROM @AttributeDetail
                                    WHERE ISNULL(SourceColumnName, '') = ''   AND IsRequired = 1;  ;

                         END;
						
                     --	Check attributes are not mapped with (Default / Other) family of Pim Product
                     --	INSERT INTO ZnodeImportLog ( ErrorDescription , ColumnName , Data , GUID , CreatedBy , CreatedDate , ModifiedBy , ModifiedDate , ImportProcessLogId)
                     --	SELECT '1' AS ErrorDescription , SourceColumnName , '' , @NewGUID , @UserId , @GetDate , @UserId , @GetDate , @ImportProcessLogId
                     --	FROM @AttributeDetail WHERE PimAttributeId NOT IN ( SELECT zpfgm.PimAttributeId FROM dbo.ZnodePimFamilyGroupMapper AS zpfgm);
                     --	Verify data in global temporary table (column wise)
					
                     DECLARE Cr_Attribute CURSOR LOCAL FAST_FORWARD
                     FOR SELECT PimAttributeId,
                                AttributeTypeName,
                                AttributeCode,
                                IsRequired,
                                SourceColumnName,
                                ControlName,
                                ValidationName,
                                SubValidationName,
                                ValidationValue,
                                RegExp
                         FROM @AttributeDetail
                         WHERE ISNULL(SourceColumnName, '') <> '';
                     OPEN Cr_Attribute;
                     FETCH NEXT FROM Cr_Attribute INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @ControlName, @ValidationName, @SubValidationName, @ValidationValue, @RegExp;
                     WHILE @@FETCH_STATUS = 0
                         BEGIN
				             IF @AttributeTypeName = 'Number'
                                 BEGIN
							      EXEC Znode_ImportValidateNumber
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @ImportHeadId = @ImportHeadId,
                                          @ImportProcessLogId = @ImportProcessLogId;
                                 END;
							 -- Check invalid date
							
                             IF @AttributeTypeName = 'Date'
                                 BEGIN
                                     EXEC Znode_ImportValidateDate
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @ImportHeadId = @ImportHeadId,
                                          @ImportProcessLogId = @ImportProcessLogId;
                                 END;
							 -- Check Manditory Data
		 					 IF @IsRequired = 1 AND @CheckedSourceColumn <> @SourceColumnName
								BEGIN
									SET @CheckedSourceColumn = @SourceColumnName;
									EXEC Znode_ImportValidateManditoryData
									@TableName = @TableName,
									@SourceColumnName = @SourceColumnName,
									@CreateDateString = @CreateDateString,
									@ValidationName = @ValidationName,
									@ControlName = @ControlName,
									@ValidationValue = @ValidationValue,
									@NewGUID = @NewGUID,
									@ImportHeadId = @ImportHeadId;
								END;
							 --END 
							
                             IF @AttributeTypeName = 'Text'
                                 BEGIN
								 
						              EXEC Znode_ImportValidateManditoryText
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @LocaleId = @LocaleId,
                                          @DefaultLocaleId = @DefaultLocaleId,
                                          @AttributeId = @AttributeId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @ImportHeadId = @ImportHeadId;
                                 END;
                             IF @AttributeTypeName in ( 'Image','File')
                                 BEGIN
                                     EXEC Znode_ImportValidateImageData
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @LocaleId = @LocaleId,
                                          @DefaultLocaleId = @DefaultLocaleId,
                                          @AttributeId = @AttributeId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @ImportHeadId = @ImportHeadId;
                                 END;

					

                             --Check Default data value is valid 
                             IF @ImportHeadName IN('Product', 'Category','B2BCustomer')
                                 BEGIN
                                     IF @AttributeId IN
                                     (
                                         SELECT PimAttributeId
                                         FROM #DefaultAttributeCode
                                     )
                                         BEGIN
							
                                            IF  @AttributeTypeName = 'Multi Select'
											 BEGIN
										 		 ---Verify Image file is exists in media table or not 
												 SET @SQLQuery = ' INSERT INTO #InvalidDefaultData (RowNumber, Value, ColumnName) 
												 SELECT ROWNUMBER , (Select TOP 1 Item from dbo.split(' + @SourceColumnName + ','','')  SP WHERE NOT EXISTS 
												 (Select ToP 1 1 FROM #DefaultAttributeCode DAC WHERE 
												  DAC.AttributeTypeName <> ''Yes/No'' AND DAC.AttributeDefaultValueCode IS NOT NULL AND DAC.PimAttributeId = 
												 ' + CONVERT(VARCHAR(100), @AttributeId) + ' AND ltrim(rtrim(SP.Item) ) = DAC.AttributeDefaultValueCode
												 )), ''' + @SourceColumnName + ''' as [ColumnName]  FROM ' + @TableName
												 + ' Where ISnull(' + @SourceColumnName +  ','''') <> '''''
												EXEC sys.sp_sqlexec @SQLQuery;
											  END
											  ELSE IF @AttributeTypeName = 'Simple Select'
											  BEGIN
						
												---Verify Image file is exists in media table or not 
												 SET @SQLQuery = ' INSERT INTO #InvalidDefaultData (RowNumber, Value, ColumnName) 
												 SELECT ROWNUMBER , ' + @SourceColumnName + ' , ''' + @SourceColumnName + ''' as [ColumnName]  FROM ' + @TableName
												 + ' SP Where ISnull(' + @SourceColumnName +  ','''') <> '''' AND 
												  NOT EXISTS 
												 (Select TOP 1 1 FROM #DefaultAttributeCode DAC WHERE 
												  DAC.AttributeTypeName <> ''Yes/No'' AND DAC.AttributeDefaultValueCode IS NOT NULL AND DAC.PimAttributeId = 
												 ' + CONVERT(VARCHAR(100), @AttributeId) + ' AND ltrim(rtrim(SP.' + @SourceColumnName + ') ) = DAC.AttributeDefaultValueCode ) '
							
												EXEC sys.sp_sqlexec @SQLQuery;
											  END   
												-- Check Invalid Image 
												 SET @SQLQuery = 'SELECT ''9 '' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], 
												 Value AS  AttributeValue,RowNumber ,'''+@NewGUID+''',  '+@CreateDateString+' FROM #InvalidDefaultData Where Value IS NOT NULL'
												 INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, RowNumber, GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
												 EXEC sys.sp_sqlexec @SQLQuery;
												 Delete from #InvalidDefaultData

       
                                         END;
                                 END;
							
                             FETCH NEXT FROM Cr_Attribute INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @ControlName, @ValidationName, @SubValidationName, @ValidationValue, @RegExp;
                         END;
                     CLOSE Cr_Attribute;
                     DEALLOCATE Cr_Attribute;
                     --SELECT top 1 1 FROM @FamilyAttributeDetail where  iSNULL(SourceColumnName,'') = ''  and IsRequired = 1
                 END;
             
			 
			  
------------------------------------------------------------------------------------------
		 Declare @SQLQueryNew NVARCHAR(4000)
		 Declare @SourceColumnNameProduct nvarchar(4000) 
         IF @ImportHeadName IN('Product','Pricing','ProductAssociation','Inventory')
		 BEGIN
		 	 
		 SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'SKU'
		 AND ImportTemplateId = @TemplateId


			SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  SKU - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;			
		END
		ELSE IF @ImportHeadName IN('ProductAttribute')
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'AttributeCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  Attribute - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'ZipCode'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'ZIP'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  ZIPCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'Category'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'CategoryCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  CategoryCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'CategoryAssociation'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'CategoryName'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  CategoryName - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;

		END
		ELSE IF @ImportHeadName IN ('Customer','CustomerAddress')
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'UserName'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  UserName - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'SEODetails'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'Code'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  Code - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'Highlight'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'HighlightCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  HighlightCode - '' + ' + ' cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'AddonAssociation'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'SKU'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  SKU - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'AttributeDefaultValue'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'AttributeDefaultValueCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  AttributeDefaultValueCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
	-------------------------------------------------------------------------------------------------------------
	
	--------------------------------------------------------------------------------------------------------------------
			 
  		SET @SQLQuery = 'Delete FROM  '+@TableName+' Where Rownumber IN (Select Rownumber FROM ZnodeImportLog  WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND Rownumber IS NOT NULL)';
        EXEC sys.sp_sqlexec  @SQLQuery;
			 			
   
             IF @ImportHeadName IN('Product', 'Category')
                 BEGIN
                     IF NOT EXISTS
                     (
                         SELECT TOP 1 1
                         FROM @FamilyAttributeDetail
                         WHERE ISNULL(SourceColumnName, '') = ''
                               AND IsRequired = 1
                     ) AND NOT EXISTS
					 (
						 SELECT TOP 1 1
						 FROM ZnodeImportLog
						 WHERE Guid = @NewGUID
							   AND ErrorDescription IN(43, 42)
						 AND ImportProcessLogId = @ImportProcessLogId
					 )
                         BEGIN
                             IF @IsCategory = 0
                                 BEGIN

                                     EXEC Znode_ImportPimProductData
                                          @TableName = @TableName,
                                          @NewGUID = @NewGUID,
                                          @TemplateId = @TemplateId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @UserId = @UserId,
                                          @LocaleId = @LocaleId,
                                          @DefaultFamilyId = @DefaultFamilyId;

                                 END;
                             ELSE
                                 BEGIN
                                     EXEC Znode_ImportPimCategoryData
                                          @TableName = @TableName,
                                          @NewGUID = @NewGUID,
                                          @TemplateId = @TemplateId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @UserId = @UserId,
                                          @LocaleId = @LocaleId,
                                          @DefaultFamilyId = @DefaultFamilyId;
                                 END;
                         END
						 ELSE
							BEGIN
								-- Update Record count in log 
								
							
								--SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
								--EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount out
								--UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
								--WHERE ImportProcessLogId = @ImportProcessLogId;

								SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
								SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
								EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount out
								UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
								WHERE ImportProcessLogId = @ImportProcessLogId;
							END

                 END;
				IF NOT EXISTS
					 (
						 SELECT TOP 1 1
						 FROM ZnodeImportLog
						 WHERE Guid = @NewGUID
							   AND ErrorDescription IN(43, 42)
						 AND ImportProcessLogId = @ImportProcessLogId
					 )
             BEGIN
                 IF @ImportHeadName = 'Pricing'
                     BEGIN
                         EXEC [Znode_ImportPriceList]
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
                              @PriceListId = @PriceListId;
                     END;

                 IF @ImportHeadName = 'Inventory'
                     BEGIN
				
                         EXEC Znode_ImportInventory_Ver1
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID;
                     END;
                 IF @ImportHeadName = 'ZipCode'
                     BEGIN
						 EXEC Znode_ImportZipCode
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
							  @CountryCode = @CountryCode;
                     END;
					 IF @ImportHeadName = 'CategoryAssociation'
                     BEGIN
						 EXEC Znode_ImportCatalogCategory
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
							  @PimCatalogId = @PimCatalogId;
                     END;
					 IF @ImportHeadName = 'ProductAssociation'
                     BEGIN
						 EXEC Znode_ImportAssociateProducts
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID
                     END;
			
					 IF @ImportHeadName = 'SEODetails' AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportSEODetails
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
							  @LocaleId = @LocaleId,
							  @PortalId =@PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
							  @CsvColumnString = @CsvColumnString 

				
                     END;
				
					 IF @ImportHeadName = 'ProductAttribute' 
                     BEGIN
						 EXEC Znode_ImportAttributes
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
							  @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID
				
                     END;

					 IF @ImportHeadName = 'Customer' AND @PortalId > 0 
                     BEGIN
					
						 EXEC Znode_ImportCustomer
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = @PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
				
                     END;
					 
					 IF @ImportHeadName = 'UserApprovers' AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportUserApproval
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = @PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
				
                     END;

					 IF @ImportHeadName = 'B2BCustomer' AND @PortalId > 0 
                     BEGIN

							 EXEC Znode_ImportB2BCustomer
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = @PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
				
                     END;

					 IF @ImportHeadName = 'CustomerAddress' --AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportCustomerAddress
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = 7, -- not implemented from forntend 
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString,
							  @IsAccountAddress = @IsAccountAddress
				
                     END;
					 IF @ImportHeadName = 'ShippingAddress' --AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportCustomerAddress
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = 7, -- not implemented from forntend 
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString,
							  @IsAccountAddress = @IsAccountAddress
				
                     END;
					 IF @ImportHeadName = 'StoreLocator' --AND @PortalId > 0 
                     BEGIN
					 	 EXEC Znode_ImportStoreLocatorAddress
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
                     END;

					IF @ImportHeadName = 'Highlight'
					BEGIN
					EXEC Znode_ImportHighlight 
					@TableName = @TableName, 
					@Status = @Status, 
					@UserId = @UserId, 
					@ImportProcessLogId = @ImportProcessLogId, 
					@NewGUID = @NewGUID 
					END;

					IF @ImportHeadName = 'AddonAssociation'
					BEGIN
					EXEC Znode_ImportAddonAssociation 
					@TableName = @TableName, 
					@Status = @Status, 
					@UserId = @UserId, 
					@ImportProcessLogId = @ImportProcessLogId, 
					@NewGUID = @NewGUID,
					@PimCatalogId = @PimCatalogId
					END;

					IF @ImportHeadName = 'AttributeDefaultValue'
					BEGIN
					EXEC Znode_ImportAttributeDefaultValue 
					@TableName = @TableName, 
					@Status = @Status, 
					@UserId = @UserId, 
					@ImportProcessLogId = @ImportProcessLogId, 
					@NewGUID = @NewGUID
					
					END;

					IF @ImportHeadName = 'Voucher'
					BEGIN
						EXEC Znode_ImportVoucher 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID
					
					END;

					IF @ImportHeadName = 'Account'
					BEGIN
						
						EXEC Znode_ImportAccount 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID,
						@CsvColumnString = @CsvColumnString,
						@PortalId = @PortalId
					
					END;

					IF @ImportHeadName = 'Synonyms'
					BEGIN
						EXEC Znode_ImportSynonyms 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID
					END

					IF @ImportHeadName = 'CatalogCategoryAssociation'
					BEGIN
						EXEC Znode_ImportCatalogCategoryHierarchyAssociation 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID,
						@PimCatalogId = @PimCatalogId
					END
				 

                    IF @ImportHeadName = 'Brands'
					BEGIN
						EXEC Znode_ImportBrands 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID,
						@LocaleId	 = @LocaleId
					END;
				 
             END
			 ELSE 
				 BEGIN
					-- Update Record count in log 	
					SET @SQLQuery = ' Select @FailedRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
					EXEC	sp_executesql @SQLQuery , N'@FailedRecordCount BIGINT out' , @FailedRecordCount =@FailedRecordCount out
					SELECT @SuccessRecordCount = 0
									
					UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
					WHERE ImportProcessLogId = @ImportProcessLogId;

				 END

             EXEC Znode_ImportReadErrorLog
                  @ImportProcessLogId = @ImportProcessLogId,
                  @NewGUID = @NewGUID;
             DROP TABLE #GlobalTempTableColumns;

             -- Finally call product insert process if error not found in error log table 
             IF EXISTS
             (
                 SELECT TOP 1 1
                 FROM ZnodeImportLog
                 WHERE ImportProcessLogId = @ImportProcessLogId
                       AND Guid = @NewGUID
             )
                 BEGIN
                    --Updating the import process status
					UPDATE ZnodeImportProcessLog
					SET Status = CASE WHEN ISNULL(FailedRecordcount,0) > 0 AND ISNULL(SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
										WHEN ISNULL(FailedRecordcount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
										WHEN ISNULL(FailedRecordcount,0) > 0 AND ISNULL(FailedRecordcount,0) = ISNULL(TotalProcessedRecords,0) THEN dbo.Fn_GetImportStatus( 3 )
									END, 
						ProcessCompletedDate = getdate()
					WHERE ImportProcessLogId = @ImportProcessLogId;
                 END;
				 SET @SQLQuery = 'IF Object_id(''+@TableName+'') IS NOT NULL  DROP TABLE ' + @TableName
                 EXEC sys.sp_sqlexec @SQLQuery;

				 print 'end';
         END TRY
         BEGIN CATCH
			DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE()
			DECLARE @TempCount TABLE (Id INT)

			Declare @SQL Varchar(max) = 'Select Count(*) As Id From '+@TableName
			INSERT INTO @TempCount
			EXEC (@SQL)

             SELECT ERROR_MESSAGE(),
                    ERROR_LINE(),
                    ERROR_PROCEDURE();
             EXEC Znode_ImportReadErrorLog
                  @ImportProcessLogId = @ImportProcessLogId,
                  @NewGUID = @NewGUID; 
             
			 ---Import process updating fail due to database error
			UPDATE ZnodeImportProcessLog
			SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
			WHERE ImportProcessLogId = @ImportProcessLogId;

			---Loging error for Import process due to database error
		    INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		    SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

			--Updating total and fail record count
		    UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		    TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		    WHERE ImportProcessLogId = @ImportProcessLogId;

			SET @SQLQuery = 'Drop Table ' + @TableName
            EXEC sys.sp_sqlexec @SQLQuery;
             --ROLLBACK TRAN TRN_ImportValidProductData;
         END CATCH;
     END;

GO

insert into ZnodeImportHead(Name,IsUsedInImport,IsUsedInDynamicReport,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsCsvUploader)
select 'Brands',1,1,1,2,getdate(),2,getdate(),null
where not exists(select * from ZnodeImportHead where Name = 'Brands')

insert into ZnodeImportTemplate(ImportHeadId,TemplateName,TemplateVersion,PimAttributeFamilyId,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select (select top 1 ImportHeadId from ZnodeImportHead where name = 'Brands'),'Brands Template',null,null,1,2,getdate(),2,getdate()
where not exists(select * from ZnodeImportTemplate where ImportHeadId = (select top 1 ImportHeadId from ZnodeImportHead where name = 'Brands')
  and TemplateName = 'Brands Template' )

INSERT ZnodeImportTemplateMapping(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select top 1 ImportTemplateId from ZnodeImportTemplate where ImportHeadId=(select ImportHeadId from ZnodeImportHead where name='Brands')),
'BrandCode' SourceColumnName,'BrandCode' TargetColumnName,0 DisplayOrder,0 IsActive, 0 IsAllowNull,2 CreatedBy,GETDATE() CreatedDate,2 ModifiedBy,GETDATE() ModifiedDate
WHERE NOT EXISTS(SELECT * FROM ZnodeImportTemplateMapping WHERE ImportTemplateId=(select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'Brands Template') 
  AND SourceColumnName ='BrandCode')

INSERT ZnodeImportTemplateMapping(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select top 1 ImportTemplateId from ZnodeImportTemplate where ImportHeadId=(select ImportHeadId from ZnodeImportHead where name='Brands')),
'IsActive' SourceColumnName,'IsActive' TargetColumnName,0 DisplayOrder,0 IsActive, 0 IsAllowNull,2 CreatedBy,GETDATE() CreatedDate,2 ModifiedBy,GETDATE() ModifiedDate
WHERE NOT EXISTS(SELECT * FROM ZnodeImportTemplateMapping WHERE ImportTemplateId=(select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'Brands Template') 
  AND SourceColumnName ='IsActive')

INSERT ZnodeImportTemplateMapping(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select top 1 ImportTemplateId from ZnodeImportTemplate where ImportHeadId=(select ImportHeadId from ZnodeImportHead where name='Brands')),
'BrandDescription' SourceColumnName,'BrandDescription' TargetColumnName,0 DisplayOrder,0 IsActive, 0 IsAllowNull,2 CreatedBy,GETDATE() CreatedDate,2 ModifiedBy,GETDATE() ModifiedDate
WHERE NOT EXISTS(SELECT * FROM ZnodeImportTemplateMapping WHERE ImportTemplateId=(select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'Brands Template') 
  AND SourceColumnName ='BrandDescription')

INSERT ZnodeImportTemplateMapping(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select top 1 ImportTemplateId from ZnodeImportTemplate where ImportHeadId=(select ImportHeadId from ZnodeImportHead where name='Brands')),
'SEOKeyword' SourceColumnName,'SEOKeyword' TargetColumnName,0 DisplayOrder,0 IsActive, 0 IsAllowNull,2 CreatedBy,GETDATE() CreatedDate,2 ModifiedBy,GETDATE() ModifiedDate
WHERE NOT EXISTS(SELECT * FROM ZnodeImportTemplateMapping WHERE ImportTemplateId=(select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'Brands Template') 
  AND SourceColumnName ='SEOKeyword')

INSERT ZnodeImportTemplateMapping(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select top 1 ImportTemplateId from ZnodeImportTemplate where ImportHeadId=(select ImportHeadId from ZnodeImportHead where name='Brands')),
'SEODescription' SourceColumnName,'SEODescription' TargetColumnName,0 DisplayOrder,0 IsActive, 0 IsAllowNull,2 CreatedBy,GETDATE() CreatedDate,2 ModifiedBy,GETDATE() ModifiedDate
WHERE NOT EXISTS(SELECT * FROM ZnodeImportTemplateMapping WHERE ImportTemplateId=(select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'Brands Template') 
  AND SourceColumnName ='SEODescription')

INSERT ZnodeImportTemplateMapping(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select top 1 ImportTemplateId from ZnodeImportTemplate where ImportHeadId=(select ImportHeadId from ZnodeImportHead where name='Brands')),
'BrandLogo' SourceColumnName,'BrandLogo' TargetColumnName,0 DisplayOrder,0 IsActive, 0 IsAllowNull,2 CreatedBy,GETDATE() CreatedDate,2 ModifiedBy,GETDATE() ModifiedDate
WHERE NOT EXISTS(SELECT * FROM ZnodeImportTemplateMapping WHERE ImportTemplateId=(select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'Brands Template') 
  AND SourceColumnName ='BrandLogo')

INSERT ZnodeImportTemplateMapping(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select top 1 ImportTemplateId from ZnodeImportTemplate where ImportHeadId=(select ImportHeadId from ZnodeImportHead where name='Brands')),
'SEOTitle' SourceColumnName,'SEOTitle' TargetColumnName,0 DisplayOrder,0 IsActive, 0 IsAllowNull,2 CreatedBy,GETDATE() CreatedDate,2 ModifiedBy,GETDATE() ModifiedDate
WHERE NOT EXISTS(SELECT * FROM ZnodeImportTemplateMapping WHERE ImportTemplateId=(select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'Brands Template') 
  AND SourceColumnName ='SEOTitle')

INSERT ZnodeImportTemplateMapping(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select top 1 ImportTemplateId from ZnodeImportTemplate where ImportHeadId=(select ImportHeadId from ZnodeImportHead where name='Brands')),
'SEOFriendlyPageName' SourceColumnName,'SEOFriendlyPageName' TargetColumnName,0 DisplayOrder,0 IsActive, 0 IsAllowNull,2 CreatedBy,GETDATE() CreatedDate,2 ModifiedBy,GETDATE() ModifiedDate
WHERE NOT EXISTS(SELECT * FROM ZnodeImportTemplateMapping WHERE ImportTemplateId=(select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'Brands Template') 
  AND SourceColumnName ='SEOFriendlyPageName')

INSERT ZnodeImportTemplateMapping(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select top 1 ImportTemplateId from ZnodeImportTemplate where ImportHeadId=(select ImportHeadId from ZnodeImportHead where name='Brands')),
'URLKey' SourceColumnName,'URLKey' TargetColumnName,0 DisplayOrder,0 IsActive, 0 IsAllowNull,2 CreatedBy,GETDATE() CreatedDate,2 ModifiedBy,GETDATE() ModifiedDate
WHERE NOT EXISTS(SELECT * FROM ZnodeImportTemplateMapping WHERE ImportTemplateId=(select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'Brands Template') 
  AND SourceColumnName ='URLKey')

INSERT ZnodeImportTemplateMapping(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select top 1 ImportTemplateId from ZnodeImportTemplate where ImportHeadId=(select ImportHeadId from ZnodeImportHead where name='Brands')),
'Custom1' SourceColumnName,'Custom1' TargetColumnName,0 DisplayOrder,0 IsActive, 0 IsAllowNull,2 CreatedBy,GETDATE() CreatedDate,2 ModifiedBy,GETDATE() ModifiedDate
WHERE NOT EXISTS(SELECT * FROM ZnodeImportTemplateMapping WHERE ImportTemplateId=(select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'Brands Template') 
  AND SourceColumnName ='Custom1')

INSERT ZnodeImportTemplateMapping(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select top 1 ImportTemplateId from ZnodeImportTemplate where ImportHeadId=(select ImportHeadId from ZnodeImportHead where name='Brands')),
'Custom2' SourceColumnName,'Custom2' TargetColumnName,0 DisplayOrder,0 IsActive, 0 IsAllowNull,2 CreatedBy,GETDATE() CreatedDate,2 ModifiedBy,GETDATE() ModifiedDate
WHERE NOT EXISTS(SELECT * FROM ZnodeImportTemplateMapping WHERE ImportTemplateId=(select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'Brands Template') 
  AND SourceColumnName ='Custom2')

INSERT ZnodeImportTemplateMapping(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select top 1 ImportTemplateId from ZnodeImportTemplate where ImportHeadId=(select ImportHeadId from ZnodeImportHead where name='Brands')),
'Custom3' SourceColumnName,'Custom3' TargetColumnName,0 DisplayOrder,0 IsActive, 0 IsAllowNull,2 CreatedBy,GETDATE() CreatedDate,2 ModifiedBy,GETDATE() ModifiedDate
WHERE NOT EXISTS(SELECT * FROM ZnodeImportTemplateMapping WHERE ImportTemplateId=(select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'Brands Template') 
  AND SourceColumnName ='Custom3')

INSERT ZnodeImportTemplateMapping(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select top 1 ImportTemplateId from ZnodeImportTemplate where ImportHeadId=(select ImportHeadId from ZnodeImportHead where name='Brands')),
'Custom4' SourceColumnName,'Custom4' TargetColumnName,0 DisplayOrder,0 IsActive, 0 IsAllowNull,2 CreatedBy,GETDATE() CreatedDate,2 ModifiedBy,GETDATE() ModifiedDate
WHERE NOT EXISTS(SELECT * FROM ZnodeImportTemplateMapping WHERE ImportTemplateId=(select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'Brands Template') 
  AND SourceColumnName ='Custom4')

INSERT ZnodeImportTemplateMapping(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select top 1 ImportTemplateId from ZnodeImportTemplate where ImportHeadId=(select ImportHeadId from ZnodeImportHead where name='Brands')),
'Custom5' SourceColumnName,'Custom5' TargetColumnName,0 DisplayOrder,0 IsActive, 0 IsAllowNull,2 CreatedBy,GETDATE() CreatedDate,2 ModifiedBy,GETDATE() ModifiedDate
WHERE NOT EXISTS(SELECT * FROM ZnodeImportTemplateMapping WHERE ImportTemplateId=(select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'Brands Template') 
  AND SourceColumnName ='Custom5')

GO

insert into ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
select 'Text','BrandCode',(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Brands'),1,'Text','RegularExpression',
null,'','',null,2,getdate(),2,getdate(),1
where not exists(select * from ZnodeImportAttributeValidation where AttributeTypeName ='Text' and AttributeCode = 'BrandCode' 
      and ControlName = 'Text' and ImportHeadId=(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Brands')
      and ValidationName = 'RegularExpression')

insert into ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
select 'Text','IsActive',(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Brands'),1,'Text','RegularExpression',
null,'','',null,2,getdate(),2,getdate(),2
where not exists(select * from ZnodeImportAttributeValidation where AttributeTypeName ='Text' and AttributeCode = 'IsActive' 
      and ControlName = 'Text' and ImportHeadId=(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Brands')
      and ValidationName = 'RegularExpression')

insert into ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
select 'Text','BrandDescription',(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Brands'),0,'Text','RegularExpression',
null,'','',null,2,getdate(),2,getdate(),3
where not exists(select * from ZnodeImportAttributeValidation where AttributeTypeName ='Text' and AttributeCode = 'BrandDescription' 
      and ControlName = 'Text' and ImportHeadId=(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Brands')
      and ValidationName = 'RegularExpression')

insert into ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
select 'Text','SEOKeyword',(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Brands'),0,'Text','RegularExpression',
null,'','',null,2,getdate(),2,getdate(),4
where not exists(select * from ZnodeImportAttributeValidation where AttributeTypeName ='Text' and AttributeCode = 'SEOKeyword' 
      and ControlName = 'Text' and ImportHeadId=(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Brands')
      and ValidationName = 'RegularExpression')

insert into ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
select 'Text','SEODescription',(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Brands'),0,'Text','RegularExpression',
null,'','',null,2,getdate(),2,getdate(),5
where not exists(select * from ZnodeImportAttributeValidation where AttributeTypeName ='Text' and AttributeCode = 'SEODescription' 
      and ControlName = 'Text' and ImportHeadId=(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Brands')
      and ValidationName = 'RegularExpression')

insert into ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
select 'Text','BrandLogo',(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Brands'),0,'Text','RegularExpression',
null,'','',null,2,getdate(),2,getdate(),6
where not exists(select * from ZnodeImportAttributeValidation where AttributeTypeName ='Text' and AttributeCode = 'BrandLogo' 
      and ControlName = 'Text' and ImportHeadId=(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Brands')
      and ValidationName = 'RegularExpression')

insert into ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
select 'Text','SEOTitle',(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Brands'),0,'Text','RegularExpression',
null,'','',null,2,getdate(),2,getdate(),7
where not exists(select * from ZnodeImportAttributeValidation where AttributeTypeName ='Text' and AttributeCode = 'SEOTitle' 
      and ControlName = 'Text' and ImportHeadId=(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Brands')
      and ValidationName = 'RegularExpression')

insert into ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
select 'Text','SEOFriendlyPageName',(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Brands'),0,'Text','RegularExpression',
null,'','',null,2,getdate(),2,getdate(),8
where not exists(select * from ZnodeImportAttributeValidation where AttributeTypeName ='Text' and AttributeCode = 'SEOFriendlyPageName' 
      and ControlName = 'Text' and ImportHeadId=(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Brands')
      and ValidationName = 'RegularExpression')

insert into ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
select 'Text','URLKey',(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Brands'),0,'Text','RegularExpression',
null,'','',null,2,getdate(),2,getdate(),9
where not exists(select * from ZnodeImportAttributeValidation where AttributeTypeName ='Text' and AttributeCode = 'URLKey' 
      and ControlName = 'Text' and ImportHeadId=(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Brands')
      and ValidationName = 'RegularExpression')

insert into ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
select 'Text','Custom1',(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Brands'),0,'Text','RegularExpression',
null,'','',null,2,getdate(),2,getdate(),10
where not exists(select * from ZnodeImportAttributeValidation where AttributeTypeName ='Text' and AttributeCode = 'Custom1' 
      and ControlName = 'Text' and ImportHeadId=(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Brands')
      and ValidationName = 'RegularExpression')

insert into ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
select 'Text','Custom2',(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Brands'),0,'Text','RegularExpression',
null,'','',null,2,getdate(),2,getdate(),11
where not exists(select * from ZnodeImportAttributeValidation where AttributeTypeName ='Text' and AttributeCode = 'Custom2' 
      and ControlName = 'Text' and ImportHeadId=(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Brands')
      and ValidationName = 'RegularExpression')

insert into ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
select 'Text','Custom3',(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Brands'),0,'Text','RegularExpression',
null,'','',null,2,getdate(),2,getdate(),12
where not exists(select * from ZnodeImportAttributeValidation where AttributeTypeName ='Text' and AttributeCode = 'Custom3' 
      and ControlName = 'Text' and ImportHeadId=(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Brands')
      and ValidationName = 'RegularExpression')

insert into ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
select 'Text','Custom4',(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Brands'),0,'Text','RegularExpression',
null,'','',null,2,getdate(),2,getdate(),13
where not exists(select * from ZnodeImportAttributeValidation where AttributeTypeName ='Text' and AttributeCode = 'Custom4' 
      and ControlName = 'Text' and ImportHeadId=(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Brands')
      and ValidationName = 'RegularExpression')

insert into ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
select 'Text','Custom5',(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Brands'),0,'Text','RegularExpression',
null,'','',null,2,getdate(),2,getdate(),14
where not exists(select * from ZnodeImportAttributeValidation where AttributeTypeName ='Text' and AttributeCode = 'Custom5' 
      and ControlName = 'Text' and ImportHeadId=(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Brands')
      and ValidationName = 'RegularExpression')

GO

insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 121,'Text','Input must include any Brand Code that is associated with the system defined Brand product attribute as an attribute value and is not used to create any other Brand.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 121)

GO

UPDATE znodemessage set MessageName='Input value is required in alphanumeric format without spaces.'
WHERE MessageCode=79

GO

update ZnodeApplicationSetting
set Setting='<?xml version="1.0" encoding="utf-16"?> <columns> <column> <id>1</id> <name>NoteID</name> <headertext>Checkbox</headertext> <width>20</width> <datatype>String</datatype> <columntype>String</columntype> <allowsorting>false</allowsorting> <allowpaging>true</allowpaging> <format> </format> <isvisible>y</isvisible> <mustshow>y</mustshow> <musthide>n</musthide> <maxlength>0</maxlength> <isallowsearch>n</isallowsearch> <isconditional>n</isconditional> <isallowlink>n</isallowlink> <islinkactionurl> </islinkactionurl> <islinkparamfield> </islinkparamfield> <ischeckbox>y</ischeckbox> <checkboxparamfield> </checkboxparamfield> <iscontrol>n</iscontrol> <controltype> </controltype> <controlparamfield> </controlparamfield> <displaytext> </displaytext> <editactionurl> </editactionurl> <editparamfield> </editparamfield> <deleteactionurl> </deleteactionurl> <deleteparamfield> </deleteparamfield> <viewactionurl> </viewactionurl> <viewparamfield> </viewparamfield> <imageactionurl> </imageactionurl> <imageparamfield> </imageparamfield> <manageactionurl> </manageactionurl> <manageparamfield> </manageparamfield> <copyactionurl> </copyactionurl> <copyparamfield> </copyparamfield> <xaxis>n</xaxis> <yaxis>n</yaxis> <isadvancesearch>y</isadvancesearch> <Class> </Class> <SearchControlType>--Select--</SearchControlType> <SearchControlParameters> </SearchControlParameters> <DbParamField> </DbParamField> <useMode>DataBase</useMode> <IsGraph>n</IsGraph> <allowdetailview>n</allowdetailview> </column> <column> <id>2</id> <name>NoteID</name> <headertext>Note ID</headertext> <width>20</width> <datatype>Int32</datatype> <columntype>Int32</columntype> <allowsorting>true</allowsorting> <allowpaging>true</allowpaging> <format> </format> <isvisible>y</isvisible> <mustshow>n</mustshow> <musthide>n</musthide> <maxlength>0</maxlength> <isallowsearch>n</isallowsearch> <isconditional>n</isconditional> <isallowlink>n</isallowlink> <islinkactionurl> </islinkactionurl> <islinkparamfield> </islinkparamfield> <ischeckbox>n</ischeckbox> <checkboxparamfield> </checkboxparamfield> <iscontrol>n</iscontrol> <controltype> </controltype> <controlparamfield> </controlparamfield> <displaytext> </displaytext> <editactionurl> </editactionurl> <editparamfield> </editparamfield> <deleteactionurl> </deleteactionurl> <deleteparamfield> </deleteparamfield> <viewactionurl> </viewactionurl> <viewparamfield> </viewparamfield> <imageactionurl> </imageactionurl> <imageparamfield> </imageparamfield> <manageactionurl> </manageactionurl> <manageparamfield> </manageparamfield> <copyactionurl> </copyactionurl> <copyparamfield> </copyparamfield> <xaxis>n</xaxis> <yaxis>n</yaxis> <isadvancesearch>y</isadvancesearch> <Class> </Class> <SearchControlType>--Select--</SearchControlType> <SearchControlParameters> </SearchControlParameters> <DbParamField> </DbParamField> <useMode>DataBase</useMode> <IsGraph>n</IsGraph> <allowdetailview>n</allowdetailview> </column> <column> <id>3</id> <name>UserName</name> <headertext>Username</headertext> <width>30</width> <datatype>String</datatype> <columntype>String</columntype> <allowsorting>false</allowsorting> <allowpaging>false</allowpaging> <format> </format> <isvisible>y</isvisible> <mustshow>y</mustshow> <musthide>n</musthide> <maxlength>0</maxlength> <isallowsearch>n</isallowsearch> <isconditional>n</isconditional> <isallowlink>n</isallowlink> <islinkactionurl> </islinkactionurl> <islinkparamfield> </islinkparamfield> <ischeckbox>n</ischeckbox> <checkboxparamfield> </checkboxparamfield> <iscontrol>n</iscontrol> <controltype> </controltype> <controlparamfield> </controlparamfield> <displaytext> </displaytext> <editactionurl> </editactionurl> <editparamfield> </editparamfield> <deleteactionurl> </deleteactionurl> <deleteparamfield> </deleteparamfield> <viewactionurl> </viewactionurl> <viewparamfield> </viewparamfield> <imageactionurl> </imageactionurl> <imageparamfield> </imageparamfield> <manageactionurl> </manageactionurl> <manageparamfield> </manageparamfield> <copyactionurl> </copyactionurl> <copyparamfield> </copyparamfield> <xaxis>n</xaxis> <yaxis>n</yaxis> <isadvancesearch>y</isadvancesearch> <Class> </Class> <SearchControlType>--Select--</SearchControlType> <SearchControlParameters> </SearchControlParameters> <DbParamField> </DbParamField> <useMode>DataBase</useMode> <IsGraph>n</IsGraph> <allowdetailview>n</allowdetailview> </column> <column> <id>4</id> <name>NoteTitle</name> <headertext>Note Title</headertext> <width>30</width> <datatype>String</datatype> <columntype>String</columntype> <allowsorting>true</allowsorting> <allowpaging>true</allowpaging> <format> </format> <isvisible>y</isvisible> <mustshow>y</mustshow> <musthide>n</musthide> <maxlength>0</maxlength> <isallowsearch>y</isallowsearch> <isconditional>n</isconditional> <isallowlink>n</isallowlink> <islinkactionurl> </islinkactionurl> <islinkparamfield> </islinkparamfield> <ischeckbox>n</ischeckbox> <checkboxparamfield> </checkboxparamfield> <iscontrol>n</iscontrol> <controltype> </controltype> <controlparamfield> </controlparamfield> <displaytext> </displaytext> <editactionurl> </editactionurl> <editparamfield> </editparamfield> <deleteactionurl> </deleteactionurl> <deleteparamfield> </deleteparamfield> <viewactionurl> </viewactionurl> <viewparamfield> </viewparamfield> <imageactionurl> </imageactionurl> <imageparamfield> </imageparamfield> <manageactionurl> </manageactionurl> <manageparamfield> </manageparamfield> <copyactionurl> </copyactionurl> <copyparamfield> </copyparamfield> <xaxis>n</xaxis> <yaxis>n</yaxis> <isadvancesearch>y</isadvancesearch> <Class> </Class> <SearchControlType>--Select--</SearchControlType> <SearchControlParameters> </SearchControlParameters> <DbParamField> </DbParamField> <useMode>DataBase</useMode> <IsGraph>n</IsGraph> <allowdetailview>n</allowdetailview> </column> <column> <id>5</id> <name>NoteBody</name> <headertext>Note Body</headertext> <width>60</width> <datatype>String</datatype> <columntype>String</columntype> <allowsorting>false</allowsorting> <allowpaging>true</allowpaging> <format> </format> <isvisible>y</isvisible> <mustshow>n</mustshow> <musthide>n</musthide> <maxlength>0</maxlength> <isallowsearch>n</isallowsearch> <isconditional>n</isconditional> <isallowlink>n</isallowlink> <islinkactionurl> </islinkactionurl> <islinkparamfield> </islinkparamfield> <ischeckbox>n</ischeckbox> <checkboxparamfield> </checkboxparamfield> <iscontrol>n</iscontrol> <controltype> </controltype> <controlparamfield> </controlparamfield> <displaytext> </displaytext> <editactionurl> </editactionurl> <editparamfield> </editparamfield> <deleteactionurl> </deleteactionurl> <deleteparamfield> </deleteparamfield> <viewactionurl> </viewactionurl> <viewparamfield> </viewparamfield> <imageactionurl> </imageactionurl> <imageparamfield> </imageparamfield> <manageactionurl> </manageactionurl> <manageparamfield> </manageparamfield> <copyactionurl> </copyactionurl> <copyparamfield> </copyparamfield> <xaxis>n</xaxis> <yaxis>n</yaxis> <isadvancesearch>y</isadvancesearch> <Class> </Class> <SearchControlType>--Select--</SearchControlType> <SearchControlParameters> </SearchControlParameters> <DbParamField> </DbParamField> <useMode>DataBase</useMode> <IsGraph>n</IsGraph> <allowdetailview>n</allowdetailview> </column> <column> <id>6</id> <name>NoteDateTime</name> <headertext>Created Date</headertext> <width>0</width> <datatype>DateTime</datatype> <columntype>DateTime</columntype> <allowsorting>false</allowsorting> <allowpaging>false</allowpaging> <format> </format> <isvisible>y</isvisible> <mustshow>n</mustshow> <musthide>n</musthide> <maxlength>0</maxlength> <isallowsearch>y</isallowsearch> <isconditional>n</isconditional> <isallowlink>n</isallowlink> <islinkactionurl> </islinkactionurl> <islinkparamfield> </islinkparamfield> <ischeckbox>n</ischeckbox> <checkboxparamfield> </checkboxparamfield> <iscontrol>n</iscontrol> <controltype> </controltype> <controlparamfield> </controlparamfield> <displaytext> </displaytext> <editactionurl> </editactionurl> <editparamfield> </editparamfield> <deleteactionurl> </deleteactionurl> <deleteparamfield> </deleteparamfield> <viewactionurl> </viewactionurl> <viewparamfield> </viewparamfield> <imageactionurl> </imageactionurl> <imageparamfield> </imageparamfield> <manageactionurl> </manageactionurl> <manageparamfield> </manageparamfield> <copyactionurl> </copyactionurl> <copyparamfield> </copyparamfield> <xaxis>n</xaxis> <yaxis>n</yaxis> <isadvancesearch>y</isadvancesearch> <Class> </Class> <SearchControlType>--Select--</SearchControlType> <SearchControlParameters> </SearchControlParameters> <DbParamField> </DbParamField> <useMode>DataBase</useMode> <IsGraph>n</IsGraph> <allowdetailview>n</allowdetailview> </column> <column> <id>7</id> <name>Manage</name> <headertext>Action</headertext> <width>20</width> <datatype>String</datatype> <columntype>String</columntype> <allowsorting>false</allowsorting> <allowpaging>true</allowpaging> <format>Edit|Delete</format> <isvisible>y</isvisible> <mustshow>y</mustshow> <musthide>n</musthide> <maxlength>0</maxlength> <isallowsearch>n</isallowsearch> <isconditional>n</isconditional> <isallowlink>n</isallowlink> <islinkactionurl> </islinkactionurl> <islinkparamfield> </islinkparamfield> <ischeckbox>n</ischeckbox> <checkboxparamfield> </checkboxparamfield> <iscontrol>n</iscontrol> <controltype> </controltype> <controlparamfield> </controlparamfield> <displaytext>Edit|Delete</displaytext> <editactionurl> </editactionurl> <editparamfield> </editparamfield> <deleteactionurl> </deleteactionurl> <deleteparamfield> </deleteparamfield> <viewactionurl> </viewactionurl> <viewparamfield> </viewparamfield> <imageactionurl> </imageactionurl> <imageparamfield> </imageparamfield> <manageactionurl>/Customer/EditCustomerNote|/Customer/DeleteCustomerNote</manageactionurl> <manageparamfield>noteId|noteId</manageparamfield> <copyactionurl> </copyactionurl> <copyparamfield> </copyparamfield> <xaxis>n</xaxis> <yaxis>n</yaxis> <isadvancesearch>y</isadvancesearch> <Class> </Class> <SearchControlType>--Select--</SearchControlType> <SearchControlParameters> </SearchControlParameters> <DbParamField> </DbParamField> <useMode>DataBase</useMode> <IsGraph>n</IsGraph> <allowdetailview>n</allowdetailview> </column> </columns>'
where ItemName='CustomerNotes'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportAttributeDefaultValue')
	DROP PROC Znode_ImportAttributeDefaultValue
GO

CREATE PROCEDURE [dbo].[Znode_ImportAttributeDefaultValue](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200))
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		-- Retrive RoundOff Value from global setting 
		DECLARE @InsertPimAtrribute TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY,
			-- RowNumber int, AttributeName varchar(300), AttributeCode varchar(300), AttributeType varchar(300), DisplayOrder int, GUID nvarchar(400)
			RowNumber int, AttributeCode varchar(300),AttributeDefaultValueCode varchar(300),AttributeDefaultValue varchar(1000),IsEditable varchar(10),DisplayOrder int, IsDefault varchar(10), SwatchText varchar(1000),SwatchImage varchar(500), SwatchImagePath varchar(500), GUID nvarchar(400)
		
		);
		DECLARE @InsertedPimAttributeIds TABLE (PimAttributeId int ,PimAttributeDefaultValueId int,AttributeDefaultValueCode nvarchar(300))
		
		SET @SSQL = 'Select RowNumber,AttributeCode,AttributeDefaultValueCode,AttributeDefaultValue,IsEditable,DisplayOrder,IsDefault,SwatchText,SwatchImage, SwatchImagePath ,GUID FROM '+@TableName;
		INSERT INTO @InsertPimAtrribute( RowNumber,AttributeCode,AttributeDefaultValueCode,AttributeDefaultValue,IsEditable,DisplayOrder,IsDefault,SwatchText,SwatchImage, SwatchImagePath ,GUID)
		EXEC sys.sp_sqlexec @SSQL;

		--@MessageDisplay will use to display validate message for input inventory value  
		DECLARE @AttributeCode TABLE
		( 
		   AttributeCode nvarchar(300)
		);
		INSERT INTO @AttributeCode
			   SELECT AttributeCode
			   FROM ZnodePimAttribute 

		-- Start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '117', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.AttributeCode not in 
			   (
				   SELECT AttributeCode FROM @AttributeCode
			   );

		WITH CTE_AttributeDefaultValueCode AS(
		SELECT AttributeDefaultValueCode , AttributeCode, RowNumber ,ROW_NUMBER ()OVER (PARTITION BY AttributeDefaultValueCode , AttributeCode ORDER BY AttributeDefaultValueCode , AttributeCode )  Row_Id
		FROM @InsertPimAtrribute Z
		
		
		)
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '53', 'AttributeDefaultValueCode', AttributeDefaultValueCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE EXISTS
			  ( SELECT TOP 1 1 FROM CTE_AttributeDefaultValueCode Z WHERE Z.RowNumber=ii.RowNumber AND Z.Row_Id >1
			   )
			  

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '79', 'AttributeDefaultValueCode', AttributeDefaultValueCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.AttributeDefaultValueCode,''))) like '%[^0-9A-Za-z]%'

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '79', 'AttributeDefaultValueCode', AttributeDefaultValueCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.AttributeDefaultValueCode,''))) like '% %' -----space not allowed

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsEditable', IsEditable, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.IsEditable not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsDefault', IsDefault, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.IsDefault not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '16', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL ) AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '16', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 99999

		UPDATE ZIL
			SET ZIL.ColumnName =   ZIL.ColumnName + ' [ AttributeDefaultValueCode - ' + ISNULL(AttributeDefaultValueCode,'') + ' ] '
			FROM ZnodeImportLog ZIL 
			INNER JOIN @InsertPimAtrribute IPA ON (ZIL.RowNumber = IPA.RowNumber)
			WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL


		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertPimAtrribute
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertPimAtrribute
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount
		,	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;

		DECLARE @MediaId INT
		SET @MediaId = (SELECT TOP 1 MediaId from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.SwatchImage = ZM.FileName and IPA.SwatchImagePath = ZM.Path)

		if (isnull(@MediaId,0)=0)
			SET @MediaId = (SELECT max(MediaId) from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.SwatchImage = ZM.FileName)

        update ZPADV set ZPADV.IsEditable = case when IPA.IsEditable in ('True','1','Yes') then 1 else 0 end,ZPADV.DisplayOrder = Case when Isnull(IPA.DisplayOrder,0) <> 0 then  IPA.DisplayOrder else ZPADV.DisplayOrder end ,
		                 ZPADV.IsDefault = case when IPA.IsDefault in ('True','1','Yes') then 1 else 0 end ,ZPADV.SwatchText = IPA.SwatchText ,
		                 ZPADV.MediaId = case when isnull(@MediaId,0)= 0 then ZPADV.MediaId else @MediaId end, ZPADV.ModifiedBy = @UserId, ZPADV.ModifiedDate = @GetDate 
		from @InsertPimAtrribute IPA 
		INNER JOIN ZnodePimAttribute ZPA ON IPA.AttributeCode = ZPA.AttributeCode 
		inner join ZnodePimAttributeDefaultValue ZPADV on ZPA.PimAttributeId = ZPADV.PimAttributeId and IPA.AttributeDefaultValueCode = ZPADV.AttributeDefaultValueCode

		update ZPADVL set ZPADVL.AttributeDefaultValue = IPA.AttributeDefaultValue, ZPADVL.ModifiedBy = @UserId, ZPADVL.ModifiedDate = @GetDate 
		from @InsertPimAtrribute IPA 
		INNER JOIN ZnodePimAttribute ZPA ON IPA.AttributeCode = ZPA.AttributeCode 
		inner join ZnodePimAttributeDefaultValue ZPADV on ZPA.PimAttributeId = ZPADV.PimAttributeId and IPA.AttributeDefaultValueCode = ZPADV.AttributeDefaultValueCode
		inner join ZnodePimAttributeDefaultValueLocale ZPADVL ON ( ZPADVL.PimAttributeDefaultValueId = ZPADV.PimAttributeDefaultValueId)

		--- Insert data into base table ZnodePimatrribute with their validation 

		INSERT INTO ZnodePimAttributeDefaultValue (PimAttributeId,AttributeDefaultValueCode,IsEditable,DisplayOrder,IsDefault,SwatchText,MediaId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)		
		OUTPUT Inserted.PimAttributeId,Inserted.PimAttributeDefaultValueId,Inserted.AttributeDefaultValueCode INTO @InsertedPimAttributeIds  		
		SELECT ZPA.PimAttributeId,IPA.AttributeDefaultValueCode, case when IPA.IsEditable in ('True','1','Yes') then 1 else 0 end , Case when Isnull(IPA.DisplayOrder,0) = 0 then  99999 else IPA.DisplayOrder end  , 
		       case when IPA.IsDefault in ('True','1','Yes') then 1 else 0 end , IPA.SwatchText, @MediaId,@UserId , @GetDate ,@UserId , @GetDate 
		from @InsertPimAtrribute IPA 
		INNER JOIN ZnodePimAttribute ZPA ON IPA.AttributeCode = ZPA.AttributeCode  
		where not exists(select * from ZnodePimAttributeDefaultValue ZPADV where ZPA.PimAttributeId = ZPADV.PimAttributeId and IPA.AttributeDefaultValueCode = ZPADV.AttributeDefaultValueCode)
		
		INSERT INTO ZnodePimAttributeDefaultValueLocale(LocaleId,PimAttributeDefaultValueId,AttributeDefaultValue,Description,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		Select @LocaleId ,IPAS.PimAttributeDefaultValueId, IPA.AttributeDefaultValue, '', @UserId , @GetDate ,@UserId , @GetDate   
		FROM @InsertedPimAttributeIds IPAS 
		INNER JOIN ZnodePimAttribute ZPA ON IPAS.PimAttributeId = ZPA.PimAttributeId  
		INNER JOIN @InsertPimAtrribute IPA ON ZPA.AttributeCode= IPA.AttributeCode and IPAS.AttributeDefaultValueCode = IPA.AttributeDefaultValueCode

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
	
		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAttributeDefaultValue @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200));

		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportAttributeDefaultValue',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		

	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportVoucher')
	DROP PROC Znode_ImportVoucher
GO

CREATE PROCEDURE [dbo].[Znode_ImportVoucher](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN Voucher;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		-- Retrive RoundOff Value from global setting 

		DECLARE @InsertVoucherData TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY,RowNumber int, StoreCode varchar(400),VoucherName varchar(600), VoucherNumber varchar(600),
			VoucherAmount varchar(600),UserName varchar(600), ExpirationDate Datetime,IsActive varchar(100),RemainingAmount varchar(600),
			RestrictVoucherToACustomer varchar(100), StartDate datetime, GUID nvarchar(400)
		);
		
		SET @SSQL = 'Select RowNumber,StoreCode, VoucherName,VoucherNumber,VoucherAmount,UserName,ExpirationDate,
						IsActive,RemainingAmount,RestrictVoucherToACustomer,StartDate,GUID FROM '+@TableName;
		INSERT INTO @InsertVoucherData( RowNumber,StoreCode, VoucherName,VoucherNumber,VoucherAmount,UserName,ExpirationDate,
										IsActive,RemainingAmount,RestrictVoucherToACustomer,StartDate,GUID)
		EXEC sys.sp_sqlexec @SSQL;

		select ANZU.UserName, ANU.Id, ZU.UserId
		into #TempUserData
		from AspNetZnodeUser ANZU 
		inner join AspNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName
		inner join ZnodeUser ZU ON ANU.Id = ZU.AspNetUserId

		select ZUP.PortalId, ZUP.UserId, ZP.StoreCode
		into #TempUserPortal
		from ZnodeUserPortal ZUP 
		INNER JOIN ZnodePortal ZP ON ZUP.PortalId = ZP.PortalId

		update @InsertVoucherData set VoucherNumber = [dbo].[Fn_RandomString](10)
		where isnull(ltrim(rtrim(VoucherNumber)),'') = ''

		-- Start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '120', 'StoreCode', StoreCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE ii.StoreCode not in 
			   (
				   SELECT StoreCode FROM ZnodePortal 
			   );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '65', 'ExpirationDate', ExpirationDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE (ii.ExpirationDate < ii.StartDate OR ii.ExpirationDate < @GetDate)

		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--	   SELECT '65', 'ExpirationDate', ExpirationDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		--	   FROM @InsertVoucherData AS ii
		--	   WHERE ii.ExpirationDate < @GetDate

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '8', 'StartDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE isnull(ii.StartDate,'') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '8', 'ExpirationDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE isnull(ii.ExpirationDate,'') = ''
		
		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--	   SELECT '67', 'UserName', UserName, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		--	   FROM @InsertVoucherData AS ii
		--	   WHERE isnull(ii.UserName,'') <> '' and not exists ( SELECT VoucherNumber FROM #TempUserData U where ii.UserName = U.UserName);
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '67', 'UserName', UserName, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii			 
			   WHERE isnull(ii.UserName,'') <> '' 
			   and not exists ( SELECT * FROM #TempUserData U   
			   inner join  #TempUserPortal UP on U.UserId = UP.UserId where  ii.UserName = U.UserName and ii.StoreCode = UP.StoreCode)
			 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '71', 'VoucherNumber', VoucherNumber, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE len(ltrim(rtrim(ii.VoucherNumber))) <> 10 
	
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No','')
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '5', 'ExpirationDate', ExpirationDate, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			WHERE isdate(ii.ExpirationDate) = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '5', 'StartDate', StartDate, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			WHERE isdate(ii.StartDate) = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '69', 'RemainingAmount', RemainingAmount, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			WHERE ii.VoucherAmount <> ii.RemainingAmount

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'RestrictVoucherToACustomer', RestrictVoucherToACustomer, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			WHERE ii.RestrictVoucherToACustomer not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT distinct '2', 'VoucherAmount', VoucherAmount, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			CROSS APPLY ZnodeCulture b
			WHERE  VoucherAmount like '%[a-z]%' or VoucherAmount like '%'+b.Symbol+'%'
			and b.Symbol is not null 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT distinct '2', 'RemainingAmount', RemainingAmount, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii
			CROSS APPLY ZnodeCulture b
			WHERE  RemainingAmount like '%[a-z]%' or RemainingAmount like '%'+b.Symbol+'%'
			and b.Symbol is not null 


		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ VoucherName - ' + ISNULL(VoucherName,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN @InsertVoucherData IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertVoucherData
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertVoucherData
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;
	
		UPDATE ZGC set ExpirationDate = ICD.ExpirationDate, UserId = ZU.UserId, ModifiedBy = @UserId, ModifiedDate = @GetDate, IsActive = ICD.IsActive,
				RemainingAmount = ICD.RemainingAmount, RestrictToCustomerAccount = ICD.RestrictVoucherToACustomer, Name = ICD.VoucherName, StartDate = ICD.StartDate
				
		from ZnodeGiftCard ZGC
		inner join @InsertVoucherData ICD ON ICD.VoucherNumber = ZGC.CardNumber
		inner join ZnodePortal ZP ON ICD.StoreCode = ZP.StoreCode and ZGC.PortalId = ZP.PortalId
		left join #TempUserData ZU ON ICD.UserName = ZU.UserName

		insert into ZnodeGiftCard(PortalId,Name,CardNumber,Amount,UserId,ExpirationDate,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsActive,RemainingAmount,RestrictToCustomerAccount,StartDate)
		select ZP.PortalId, ICD.VoucherName, ICD.VoucherNumber, ICD.VoucherAmount,ZU.UserId, ICD.ExpirationDate, @UserId, @Getdate, @UserId, @Getdate, ICD.IsActive, ICD.RemainingAmount, ICD.RestrictVoucherToACustomer, ICD.StartDate
		From @InsertVoucherData ICD 
		inner join ZnodePortal ZP ON ICD.StoreCode = ZP.StoreCode 
		left join #TempUserData ZU ON ICD.UserName = ZU.UserName
		where not exists(select * from ZnodeGiftCard ZGC where ICD.VoucherNumber = ZGC.CardNumber )

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN Voucher;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN Voucher

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		 DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportVoucher @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));

		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportVoucher',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetSearchRuleDetails')
	DROP PROC Znode_GetSearchRuleDetails
GO

CREATE PROCEDURE [dbo].[Znode_GetSearchRuleDetails]
(
	@WhereClause         VARCHAR(MAX)  = '',
    @Rows                INT           = 100,
    @PageNo              INT           = 1,
    @Order_BY            VARCHAR(1000) = '',
    @RowsCount           INT OUT
)
AS
BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
		Declare @TBL_SerchRuleDetail Table (SearchCatalogRuleId Int, RuleName varchar(600), UserName nvarchar(512), CreatedDate Datetime, StartDate Datetime, EndDate Datetime, IsPause Bit,RowId Int, CountId Int)
		Declare @SQL Varchar(max), @Fn_GetFilterWhereClause NVARCHAR(MAX) = ''

		SET @Fn_GetFilterWhereClause=dbo.Fn_GetFilterWhereClause(@WhereClause)	
		SET @Fn_GetFilterWhereClause=REPLACE(@Fn_GetFilterWhereClause,'PublishCatalogId','ZSCR.PublishCatalogId')

		SET @SQL = '
		;With Cte_SerchRuleDetail As'+
		+'('+
			+' SELECT ZSCR.publishcatalogid, ZSCR.SearchCatalogRuleId, ZSCR.RuleName, ANZU.UserName, ZSCR.CreatedDate, ZSCR.StartDate, ZSCR.EndDate, ZSCR.IsPause '+ 
			+' FROM ZnodeSearchCatalogRule ZSCR '+ 
			+' LEFT JOIN ZnodeUser ZU ON ZSCR.CreatedBy = ZU.UserId '+
			+' INNER JOIN AspNetUsers ANU ON ZU.AspNetUserId = ANU.Id '+
			+' INNER JOIN AspNetZnodeUser ANZU ON ANU.UserName = ANZU.AspNetZnodeUserId '+
		 +')'+
		 +',Cte_SerchRuleDetail_OrderBy AS '+
		 +'('
			+' SELECT publishcatalogid,SearchCatalogRuleId, RuleName, UserName, CreatedDate, StartDate, EndDate, IsPause '+
			+' , '+[dbo].[Fn_GetPagingRowId](@Order_BY, ' SearchCatalogRuleId ASC')+
			+' FROM Cte_SerchRuleDetail '+
		+')'+
		 +' SELECT CSRD.SearchCatalogRuleId, CSRD.RuleName, CSRD.UserName, CSRD.CreatedDate, StartDate, EndDate, IsPause, Count(*)Over() As CountId '+
		 +' FROM Cte_SerchRuleDetail_OrderBy CSRD 
		 '+[dbo].[Fn_GetPaginationWhereClause](@PageNo, @Rows)+'
		 '+[dbo].[Fn_GetFilterWhereClause](@WhereClause)+'
		 '+[dbo].[Fn_GetOrderByClause](@Order_BY, 'CSRD.SearchCatalogRuleId ASC')
		
		 print @SQL
		 INSERT INTO @TBL_SerchRuleDetail (SearchCatalogRuleId, RuleName, UserName, CreatedDate, StartDate, EndDate, IsPause, CountId)
		 EXEC (@SQL)

		 SELECT SearchCatalogRuleId, RuleName, UserName, CreatedDate, StartDate, EndDate,IsPause, 
		        CASE WHEN IsPause = 1 THEN 'Yes' ELSE 'No' END AS Paused, 
				CountId
		 FROM @TBL_SerchRuleDetail
		 
		 Declare @SqlCommand  nvarchar(max)
		 set @SqlCommand  = 'SELECT @Cnt= count(*)
		 FROM ZnodeSearchCatalogRule ZSCR 
		 LEFT JOIN ZnodeUser ZU ON ZSCR.CreatedBy = ZU.UserId
		 INNER JOIN AspNetUsers ANU ON ZU.AspNetUserId = ANU.Id
		 INNER JOIN AspNetZnodeUser ANZU ON ANU.UserName = ANZU.AspNetZnodeUserId where 1=1'+@Fn_GetFilterWhereClause+''	    
	     EXECUTE sp_executesql @SqlCommand, N'@Cnt int OUTPUT', @Cnt=@RowsCount OUTPUT
	    
	    
		--ISNULL((SELECT top 1 CountId FROM @TBL_SerchRuleDetail), 0);

	END TRY
         BEGIN CATCH
		
		DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetSearchRuleDetails @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetSearchRuleDetails',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
            
      END CATCH;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeleteMedia')
	DROP PROC Znode_DeleteMedia
GO

CREATE  PROCEDURE [dbo].[Znode_DeleteMedia]
( @MediaId VARCHAR(2000)= '',
  @Status  BIT           = 1 OUT,
  @MediaIds TransferId READONLY ,
  @IsCallInternal BIT = 0 )
AS
/*
   
     Summary : Remove media with their reference data 
			   This Procedure is used to check the media is associated to the product or not 
			   If passed @MediaIds are matched with deleted count then data set return true other wise false 
			   dbo.Split function use to make comma separeted data in table rows 
			   1 ZnodeMediaAttributeValue
			   2 ZnodeMediaCategory
			   3 ZnodeMedia
     Unit Testing 
	 begin tran
     Declare @Status bit 
     EXEC Znode_DeleteMedia 32,@Status= @Status
	 rollback tran
  
*/
BEGIN
         
    BEGIN TRY 

        ----- Declare the variable table for store the comma separeted value in row
          
        --- this is for media path with server 
        DECLARE @TBL_MediaIds TABLE(MediaId INT);
        DECLARE @TBL_DeletedMediaId TABLE
        (
		MediaId   INT,
        MediaPath VARCHAR(3000),
		MediaConfigurationId INT
        );
        DECLARE @TBL_DeletedMediaId_forOther TABLE
        (MediaId   INT,
        MediaPath VARCHAR(3000),
		MediaConfigurationId INT
        );
		-- dbo.Split function use to make comma separeted data in table rows
        INSERT INTO @TBL_MediaIds(MediaId)
            SELECT Item
            FROM dbo.Split(@MediaId, ','  
            ) AS a
			WHERE @MediaId <> '';
			 
		INSERT INTO @TBL_MediaIds
		SELECT	id 
		FROM @MediaIds 

        INSERT INTO @TBL_DeletedMediaId_forOther
            SELECT zm.MediaId,
                    zm.[Path],
					zm.MediaConfigurationId
            FROM ZnodeMedia AS zm
                    INNER JOIN @TBL_MediaIds AS tm ON(tm.MediaId = zm.MediaId);

        /*------------------------------------------------------This code comment after requirment change ---------------------------------------------------------*/

        /*		   WHERE NOT EXISTS (SELECT TOP 1 1  																											   */

        /*         FROM  ZnodePimAttribute a 																													   */

        /*         INNEr JOIN ZnodeAttributeType b ON (a.AttributeTypeId   = b.AttributeTypeId )																   */

        /*         INNER JOIN ZnodePimAttributeValue c ON (c.PimAttributeId = a.PimAttributeId) 																   */

        /*         INNER JOIN ZnodePimAttributeValueLocale d on( d.PimAttributeValueId= c.PimAttributeValueId )												   */

        /*         WHERE EXISTS (SELECT TOP 1 1 FROM dbo.split(d.AttributeValue , ',')  qw WHERE qw.Item = CAST(zm.MediaId AS VARCHAr(1000))	)				   */

        /*         AND b.AttributeTypeName IN ('Image','File','Audio','Video'))	 																			   */

        /*         AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimProductImage zpi  WHERE zpi.MediaId = zm.MediaId)												   */

        /*         AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSPortalTheme zct WHERE zct.MediaId = zm.MediaId)												   */

        /*         -- when its complicated to handle all where conditions within single query 																	   */

        -------------------------------------------------------------------------------------------------------------------------------------------------------------
        INSERT INTO @TBL_DeletedMediaId
            SELECT MediaId,
                    MediaPath,
					MediaConfigurationId 
            FROM @TBL_DeletedMediaId_forOther AS zm;

        /*------------------------------------------------------This code commented after requirment change ---------------------------------------------------------*/

        /*        WHERE NOT EXISTS (SELECT TOP 1 1																												*/

        /*        FROM  ZnodePimAttribute a 																														*/

        /*        INNEr JOIN ZnodeAttributeType b ON (a.AttributeTypeId   = b.AttributeTypeId )																	*/

        /*        INNER JOIN ZnodePimCategoryAttributeValue c ON (c.PimAttributeId = a.PimAttributeId) 															*/

        /*        INNER JOIN ZnodePimCategoryAttributeValueLocale d on( d.PimCategoryAttributeValueId= c.PimCategoryAttributeValueId )							*/

        /*        WHERE EXISTS (SELECT TOP 1 1 FROM dbo.split(d.CategoryValue , ',')  qw WHERE qw.Item = CAST(zm.MediaId AS VARCHAr(1000))	)					*/

        /*        AND b.AttributeTypeName IN ('Image','File','Audio','Video'))																					*/

        /*        AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimGlobalDisplaySetting zpg WHERE zpg.MediaId = zm.MediaId)											*/

        /*        AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSWidgetTitleConfiguration zcwtc WHERE zcwtc.mediaId = zm.MediaId)									*/

        /*        AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSliderBanner zcb WHERE zcb.MediaId = zm.MediaId)													*/

        /*        --- Above conditions check the media are associated with product or portal or theme if associated the n not deleted other wise deleted			*/

        ------------------------------------------------------------------------------------------------------------------------------------------------------------
	-- If multiple MediaIds are passed in csv than it will it insert records matching with ZnodePimProductAttributeMedia
	-- into #temp_delete and than delete records else print errror message.

	SELECT ZM.MediaId ,'Media is associated with PimProductAttributeMedia' AS [MessageDetails]
	into #temp_delete
	FROM  ZnodePimProductAttributeMedia ZM WHERE EXISTS
            (
                SELECT TOP 1 1
                FROM @TBL_DeletedMediaId AS td
                WHERE td.mediaId = ZM.MediaId
            )				
		delete from @TBL_DeletedMediaId where mediaId in (select mediaid from #temp_delete)

BEGIN TRAN DeleteMedia;
        DELETE FROM ZnodeMediaAttributeValue
        WHERE EXISTS
        (
            SELECT TOP 1 1
            FROM ZnodeMediaCategory AS zmc
            WHERE EXISTS
            (
                SELECT TOP 1 1
                FROM @TBL_DeletedMediaId AS td
                WHERE td.mediaId = zmc.MediaId
            )
                AND zmc.MediaCategoryId = ZnodeMediaAttributeValue.MediaCategoryId
        );
        DELETE FROM ZnodeMediaCategory
        WHERE EXISTS
        (
            SELECT TOP 1 1
            FROM @TBL_DeletedMediaId AS td
            WHERE td.mediaId = ZnodeMediaCategory.MediaId
        );
		DELETE FROM ZnodeBlogNewsContent WHERE BlogNewsId IN (SELECT BlogNewsId FROM ZnodeBlogNews
        WHERE EXISTS
        (
            SELECT TOP 1 1
            FROM @TBL_DeletedMediaId AS td
            WHERE td.mediaId = ZnodeBlogNews.MediaId
        ))
		DELETE FROM ZnodeBlogNewsCommentLocale WHERE BlogNewsCommentId IN (SELECT BlogNewsCommentId 
		FROM ZnodeBlogNewsComment WHERE BlogNewsId IN (SELECT BlogNewsId FROM ZnodeBlogNews
        WHERE EXISTS
        (
            SELECT TOP 1 1
            FROM @TBL_DeletedMediaId AS td
            WHERE td.mediaId = ZnodeBlogNews.MediaId
        )))
		DELETE FROM ZnodeBlogNewsComment WHERE BlogNewsId IN (SELECT BlogNewsId FROM ZnodeBlogNews
        WHERE EXISTS
        (
            SELECT TOP 1 1
            FROM @TBL_DeletedMediaId AS td
            WHERE td.mediaId = ZnodeBlogNews.MediaId
        ))
		DELETE FROM ZnodeBlogNewsLocale WHERE BlogNewsId IN (SELECT BlogNewsId FROM ZnodeBlogNews
        WHERE EXISTS
        (
            SELECT TOP 1 1
            FROM @TBL_DeletedMediaId AS td
            WHERE td.mediaId = ZnodeBlogNews.MediaId
        ))
			  
		DELETE FROM ZnodeBlogNews
        WHERE EXISTS
        (
            SELECT TOP 1 1
            FROM @TBL_DeletedMediaId AS td
            WHERE td.mediaId = ZnodeBlogNews.MediaId
        );
        DELETE FROM ZnodeMedia
        WHERE EXISTS
        (
            SELECT TOP 1 1
            FROM @TBL_DeletedMediaId AS td
            WHERE td.mediaId = ZnodeMedia.MediaId
        );

        IF
        (
            SELECT COUNT(1)
            FROM @TBL_MediaIds
        ) =
        (
            SELECT COUNT(1)
            FROM @TBL_DeletedMediaId -- here check if count of both table are same then its return true other wise false 
        )
            BEGIN
				IF @IsCallInternal =1 
				BEGIN 
				SELECT 0 id  , '' MessageDetail, 1 Status 
				END 
                SELECT MediaId Id ,
                    MediaPath MessageDetails  ,
					CAST(1 AS BIT) AS [Status]
                FROM @TBL_DeletedMediaId TBLD
			SET @Status = 1;
            END
        ELSE  
            BEGIN
				IF @IsCallInternal =1 
				BEGIN 
				SELECT 0 id  , '' MessageDetail, 0 Status 
				END
                SELECT MediaId Id ,
                    MediaPath MessageDetails,
                    CAST(0 AS BIT) AS [Status]
                FROM @TBL_DeletedMediaId;
                SET @Status = 0;
            END;

				 
        COMMIT TRAN DeleteMedia;
		select * from #temp_delete
    END TRY
    BEGIN CATCH
		SELECT ERROR_MESSAGE()
        DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
	@ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeleteMedia @MediaId = '+@MediaId+',
	@Status='+CAST(@Status AS VARCHAR(50));
        SELECT 1 AS ID,
            '' AS [MessageDetails],
            CAST(0 AS BIT) AS [Status];
        SET @Status = 0;
        ROLLBACK TRAN DeleteMedia;
        EXEC Znode_InsertProcedureErrorLog
            @ProcedureName = 'Znode_DeleteMedia',
            @ErrorInProcedure = @Error_procedure,
            @ErrorMessage = @ErrorMessage,
            @ErrorLine = @ErrorLine,
            @ErrorCall = @ErrorCall;
    END CATCH;
END;

GO

-- Update the records before adding the constraint on ZnodePimProductAttributeMedia 
UPDATE ZnodePimProductAttributeMedia 
SET MediaId= NULL 
FROM ZnodePimProductAttributeMedia 
WHERE MediaId NOT IN (SELECT MediaId FROM ZnodeMedia) AND MediaId IS NOT NULL 

 
 --Adding constraint on ZnodePimProductAttributeMedia

IF NOT EXISTS(select  * from sys.sysconstraints where object_name(constid) = 'FK_ZnodePimProductAttributeMedia_ZnodePimAttributeValueId')
BEGIN 
ALTER TABLE [dbo].[ZnodePimProductAttributeMedia]  WITH CHECK ADD  CONSTRAINT [FK_ZnodePimProductAttributeMedia_ZnodePimAttributeValueId] FOREIGN KEY([PimAttributeValueId])
REFERENCES [dbo].[ZnodePimAttributeValue] ([PimAttributeValueId])

ALTER TABLE [dbo].[ZnodePimProductAttributeMedia] CHECK CONSTRAINT [FK_ZnodePimProductAttributeMedia_ZnodePimAttributeValueId]
end

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportSEODetails')
	DROP PROC Znode_ImportSEODetails
GO

CREATE PROCEDURE [dbo].[Znode_ImportSEODetails]
(  
   @TableName NVARCHAR(100), 
   @Status BIT OUT, 
   @UserId INT, 
   @ImportProcessLogId INT, 
   @NewGUId NVARCHAR(200), 
   @LocaleId INT= 1,
   @PortalId INT ,
   @CsvColumnString NVARCHAR(max)
)  
AS  
 --------------------------------------------------------------------------------------  
 -- Summary :  Import SEO Details  
   
 -- Unit Testing :   
 --------------------------------------------------------------------------------------  
  
BEGIN  
BEGIN TRAN A;  
BEGIN TRY  
   
	DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(max);  
	DECLARE @GetDate DATETIME= dbo.Fn_GetDate();  
    
    
	DECLARE @CMSSEOTypeProduct INT ,@CMSSEOTypeCategory INT  
  
	SELECT @CMSSEOTypeProduct = CMSSEOTypeId FROM ZnodeCMSSEOType WHERE Name = 'Product'  
	SELECT @CMSSEOTypeCategory = CMSSEOTypeId FROM ZnodeCMSSEOType WHERE Name = 'Category'  
  
  
	-- Three type of import required three table varible for product , category AND brAND  
	DECLARE @InsertSEODetails TABLE  
	(   
		RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, ImportType varchar(20), Code NVARCHAR(300),   
		IsRedirect BIT ,MetaInformation NVARCHAR(max),PortalId INT ,SEOUrl NVARCHAR(max),IsActive varchar(10),  
		SEOTitle NVARCHAR(max),SEODescription NVARCHAR(max),SEOKeywords NVARCHAR(max),   
		RedirectFROM NVARCHAR(max),RedirectTo NVARCHAR(max), EnableRedirection BIT, CanonicalURL VARCHAR(200),   
		RobotTag VARCHAR(50), GUID NVARCHAR(400)  
	);  
  
	DECLARE @InsertSEODetailsOFProducts TABLE  
	(   
		RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, ImportType varchar(20), Code NVARCHAR(300),   
		IsRedirect BIT ,MetaInformation NVARCHAR(max),PortalId INT ,SEOUrl NVARCHAR(max),IsActive varchar(10),  
		SEOTitle NVARCHAR(max),SEODescription NVARCHAR(max),SEOKeywords NVARCHAR(max),  
		RedirectFROM NVARCHAR(max),RedirectTo NVARCHAR(max), EnableRedirection BIT, CanonicalURL VARCHAR(200),  
		RobotTag VARCHAR(50),GUID NVARCHAR(400) 
	);  
  
	DECLARE @InsertSEODetailsOFCategory TABLE  
	(   
		RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, ImportType varchar(20), Code NVARCHAR(300),   
		IsRedirect BIT ,MetaInformation NVARCHAR(max),PortalId INT ,SEOUrl NVARCHAR(max),IsActive varchar(10),  
		SEOTitle NVARCHAR(max),SEODescription NVARCHAR(max),SEOKeywords NVARCHAR(max),  
		RedirectFROM NVARCHAR(max),RedirectTo NVARCHAR(max), EnableRedirection BIT, CanonicalURL VARCHAR(200), 
		RobotTag VARCHAR(50),GUID NVARCHAR(400)
	);  
  
	DECLARE @InsertSEODetailsOFBrAND TABLE  
	(   
		RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, ImportType varchar(20), Code NVARCHAR(300),   
		IsRedirect BIT ,MetaInformation NVARCHAR(max),PortalId INT ,SEOUrl NVARCHAR(max),IsActive varchar(10),  
		SEOTitle NVARCHAR(max),SEODescription NVARCHAR(max),SEOKeywords NVARCHAR(max),   
		RedirectFROM NVARCHAR(max),RedirectTo NVARCHAR(max), EnableRedirection BIT, CanonicalURL VARCHAR(200),  
		RobotTag VARCHAR(50),GUID NVARCHAR(400) 
	);  
  
    
	DECLARE @InsertedZnodeCMSSEODetail TABLE  
	(   
		CMSSEODetailId INT , SEOCode Varchar(4000), CMSSEOTypeId INT  
	);  
    
	--SET @SSQL = 'SELECT RowNumber,ImportType,Code,IsRedirect,MetaInformation,SEOUrl,IsActive,SEOTitle,SEODescription,SEOKeywords,GUID  FROM '+@TableName;  
	SET @SSQL = 'SELECT RowNumber,'+@CsvColumnString+',GUID  FROM '+@TableName;  
  
	INSERT INTO @InsertSEODetails(RowNumber,ImportType,Code,IsRedirect,MetaInformation,SEOUrl,IsActive,SEOTitle,SEODescription,SEOKeywords,RedirectFrom,RedirectTo,EnableRedirection,CanonicalURL,RobotTag,GUID )  
	EXEC sys.sp_sqlexec @SSQL;  
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '30', 'SEOUrl', SEOUrl, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii   
	WHERE ii.SEOURL IN (SELECT ISD.SEOURL FROM @InsertSEODetails ISD Group by ISD.SEOUrl having count(*) > 1 ) 
	    
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '10', 'SEOUrl', SEOUrl, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii   
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEODetail ZCSD WHERE ZCSD.SEOUrl = ii.SEOUrl AND ZCSD.PortalId = @PortalId
	AND ZCSD.SEOCode <> ii.Code  AND EXISTS  
	(SELECT TOP 1 1 FROM ZnodeCMSSEODetailLocale dl WHERE dl.CMSSEODetailId = ZCSD.CMSSEODetailId AND dl.LocaleId = @LocaleId  
	AND dl.SEODescription = ii.SEODescription AND dl.SEOTitle = ii.SEOTitle AND dl.SEOKeywords = ii.SEOKeywords))   
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '53', 'RedirectFrom', RedirectFrom, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii   
	WHERE ii.RedirectFROM IN (SELECT ISD.RedirectFROM FROM @InsertSEODetails ISD Group by ISD.RedirectFROM having count(*) > 1 )   
	AND (ii.RedirectFROM <> '' )

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '35', 'RedirectFrom\RedirectTo', RedirectFROM + '  ' + RedirectTo  , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii   
	WHERE ii.RedirectFROM = ii.RedirectTo  
	AND (ii.RedirectFROM <> '' AND ii.RedirectTo <> '' )
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '79', 'SEOUrl', SEOUrl, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii  
	WHERE LTRIM(RTRIM(ISNULL(ii.SEOUrl,''))) like '% %' -----space not allowed  
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '103', 'ImportType', ImportType, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii  
	WHERE ii.ImportType NOT IN   
	(  
		SELECT NAME FROM ZnodeCMSSEOType WHERE NAME NOT IN ('Content Page','BlogNews','Brand')  
	);  

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '68', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii  
	WHERE ii.IsActive not IN ('True','1','Yes','FALSE','0','No')
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '9', 'RobotTag', RobotTag, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii  
	WHERE ii.RobotTag not IN ( 'INDEX_FOLLOW','NOINDEX_NOFOLLOW','NOINDEX_FOLLOW','INDEX_NOFOLLOW','1','2','3','4') 
	AND ISNULL(ii.RobotTag,'')<>''

	UPDATE ZIL
	SET ZIL.ColumnName =   ZIL.ColumnName + ' [ SEOCode - ' + ISNULL(Code,'') + ' ] '
	FROM ZnodeImportLog ZIL 
	INNER JOIN @InsertSEODetails IPA ON (ZIL.RowNumber = IPA.RowNumber)
	WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

	
	-------------------------------------------------------------------------------------------------------------------------------  
  
	INSERT INTO @InsertSEODetailsOFProducts(  RowNumber , ImportType , Code ,   
	IsRedirect ,MetaInformation ,SEOUrl ,IsActive ,  
	SEOTitle ,SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag, GUID )  
	SELECT RowNumber , ImportType , Code , IsRedirect ,MetaInformation ,SEOUrl , 
	CASE WHEN IsActive IN ('True','1','Yes') 
	Then 1 
	ELSE 0
	END as IsActive, SEOTitle ,SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag, GUID  
	FROM @InsertSEODetails WHERE ImportType = 'Product'  
  
  
	INSERT INTO @InsertSEODetailsOFCategory( RowNumber , ImportType , Code ,   
	IsRedirect ,MetaInformation,SEOUrl ,IsActive ,  
	SEOTitle ,SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag , GUID )  
	SELECT RowNumber , ImportType , Code , IsRedirect ,MetaInformation ,SEOUrl , 
		CASE WHEN IsActive IN ('True','1','Yes') Then 1 ELSE 0 END as IsActive, SEOTitle ,
		SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag, GUID  
	FROM @InsertSEODetails WHERE ImportType = 'Category'  
  
	INSERT INTO @InsertSEODetailsOFBrand( RowNumber , ImportType , Code ,   
	IsRedirect ,MetaInformation ,SEOUrl ,IsActive ,  
	SEOTitle ,SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag , GUID )  
	SELECT RowNumber , ImportType , Code , IsRedirect ,MetaInformation ,SEOUrl ,
		CASE WHEN IsActive IN ('True','1','Yes') Then 1 ELSE 0 END as IsActive, SEOTitle ,
		SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag, GUID  
	FROM @InsertSEODetails WHERE ImportType = 'Brand'  
  
  
	-- start Functional Validation   
	--1. Product  
	--2. Category  
	--3. Content Page  
	--4. BrAND  
	-----------------------------------------------  
  
    
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '103', 'SKU', CODE, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetailsOFProducts AS ii  
	WHERE ii.CODE NOT IN   
	(  
		SELECT ZPAVL.AttributeValue  
		FROM ZnodePimAttributeValue ZPAV   
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId  
		INNER JOIN ZnodePimAttribute ZPA on ZPAV.PimAttributeId = ZPA.PimAttributeId  
		WHERE ZPA.AttributeCode = 'SKU' AND ZPAVL.AttributeValue IS NOT NULL   
	)  AND ImportType = 'Product';  
  

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '103', 'Category', CODE, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetailsOFCategory AS ii  
	WHERE ii.CODE NOT IN   
	(  
		SELECT ZPCAVL.CategoryValue  
		FROM ZnodePimCategoryAttributeValue ZPCAV   
		INNER JOIN ZnodePimCategoryAttributeValueLocale ZPCAVL on ZPCAV.PimCategoryAttributeValueId = ZPCAVL.PimCategoryAttributeValueId  
		INNER JOIN ZnodePimAttribute ZPA on ZPCAV.PimAttributeId = ZPA.PimAttributeId  
		WHERE ZPA.AttributeCode = 'CategoryCode' AND ZPCAVL.CategoryValue IS NOT NULL  
	)  AND ImportType = 'Category';  
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '103', 'Brand', CODE, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetailsOFBrAND AS ii  
	WHERE ii.CODE NOT IN   
	(  
		SELECT BrandCode FROM ZnodeBrandDetails WHERE BrandCode IS NOT NULL  
	)  AND ImportType = 'Brand';  
    
	
	--Note : Content page import is not required   
    
	-- End Function Validation    
	-----------------------------------------------  
	--- Delete Invalid Data after functional validatin    
 
	DELETE FROM @InsertSEODetails  
	WHERE RowNumber IN  
	(  
		SELECT DISTINCT   
		RowNumber  
		FROM ZnodeImportLog  
		WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber is not null   
	);  


	DELETE FROM @InsertSEODetailsOFProducts  
	WHERE RowNumber IN  
	(  
		SELECT DISTINCT   
		RowNumber  
		FROM ZnodeImportLog  
		WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber is not null   
	);  
  
	DELETE FROM @InsertSEODetailsOFCategory  
	WHERE RowNumber IN  
	(  
		SELECT DISTINCT   
		RowNumber  
		FROM ZnodeImportLog  
		WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber is not null   
	);  
  
	DELETE FROM @InsertSEODetailsOFBrAND  
	WHERE RowNumber IN  
	(  
		SELECT DISTINCT   
		RowNumber  
		FROM ZnodeImportLog  
		WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber is not null   
	);  
  
 
	-- Insert Product Data   
	IF EXISTS (SELECT TOP 1 1 FROM @InsertSEODetailsOFProducts)  
	BEGIN  
		UPDATE ZCSD SET ZCSD.IsRedirect = ISD.IsRedirect ,  
			ZCSD.MetaInformation =  ISD.MetaInformation,  
			ZCSD.SEOUrl=  ISD.SEOUrl,  
			ZCSD.IsPublish = 0  
		FROM @InsertSEODetailsOFProducts ISD    
		INNER JOIN ZnodeCMSSEODetail ZCSD ON  ZCSD.CMSSEOTypeId = @CMSSEOTypeProduct AND ZCSD.SEOCode = ISD.Code  
		INNER JOIN ZnodeCMSSEODetailLocale ZCSDL ON ZCSD.CMSSEODetailId = ZCSDL.CMSSEODetailId  
		WHERE  ZCSD.PortalId  =@PortalId;  
     
		UPDATE ZCSDL SET ZCSDL.SEOTitle = ISD.SEOTitle  
			,ZCSDL.SEODescription = ISD.SEODescription  
			,ZCSDL.SEOKeywords= ISD.SEOKeywords
			,ZCSDL.CanonicalURL = ISD.CanonicalURL
			,ZCSDL.RobotTag = ISD.RobotTag  
		FROM @InsertSEODetailsOFProducts ISD    
		INNER JOIN ZnodeCMSSEODetail ZCSD ON  ZCSD.CMSSEOTypeId = @CMSSEOTypeProduct AND ZCSD.SEOCode = ISD.Code  
		INNER JOIN ZnodeCMSSEODetailLocale ZCSDL ON ZCSD.CMSSEODetailId = ZCSDL.CMSSEODetailId  
		WHERE  ZCSD.PortalId = @PortalId AND ZCSDL.LocaleId = @LocaleId;   
  
		----Making product as draft if SEOUrl is changed for part of partial publish
		UPDATE ZPP SET ZPP.PublishStateId = (SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE StateName = 'Draft')
		FROM ZnodePimProduct ZPP
		INNER JOIN ZnodePimAttributeValue ZPAV ON ZPP.PimProductId = ZPAV.PimProductId
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		WHERE EXISTS (SELECT * FROM ZnodePimAttribute zpa WHERE zpa.AttributeCode = 'SKU' AND ZPAV.PimAttributeId = zpa.PimAttributeId)
		AND EXISTS(SELECT * FROM @InsertSEODetailsOFProducts ISD    
			INNER JOIN ZnodeCMSSEODetail ZCSD ON  ZCSD.CMSSEOTypeId = @CMSSEOTypeProduct AND ZCSD.SEOCode = ISD.Code
			WHERE ZPAVL.AttributeValue = ZCSD.SEOCode)
     
		INSERT INTO ZnodeCMSSEODetailLocale (CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CanonicalURL,RobotTag)  
		SELECT DISTINCT CSD.CMSSEODetailId,@LocaleId,ISD.SEOTitle,ISD.SEODescription,ISD.SEOKeywords,@USerId, @GetDate,@USerId, @GetDate, CanonicalURL,RobotTag  
		FROM ZnodeCMSSEODetail CSD  
		INNER JOIN @InsertSEODetailsOFProducts ISD ON CSD.SEOCode = ISD.Code AND CSD.CMSSEOTypeId = @CMSSEOTypeProduct   
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEODetailLocale CSDL WHERE CSDL.LocaleId = @LocaleId AND CSD.CMSSEODetailId = CSDL.CMSSEODetailId )  
		AND CSD.portalId = @PortalId  
  
     
		DELETE FROM @InsertedZnodeCMSSEODetail  

		INSERT INTO ZnodeCMSSEODetail(CMSSEOTypeId,SEOCode,IsRedirect,MetaInformation,PortalId,SEOUrl,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)    
		OUTPUT Inserted.CMSSEODetailId,Inserted.SEOCode,Inserted.CMSSEOTypeId INTO @InsertedZnodeCMSSEODetail    
		SELECT DISTINCT @CMSSEOTypeProduct,ISD.Code , ISD.IsRedirect,ISD.MetaInformation,@PortalId,ISD.SEOUrl,@USerId, @GetDate,@USerId, @GetDate FROM   
		@InsertSEODetailsOFProducts ISD    
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEODetail ZCSD WHERE ZCSD.CMSSEOTypeId = @CMSSEOTypeProduct AND ZCSD.SEOCode = ISD.Code AND  ZCSD.PortalId =@PortalId   );  
    
		INSERT INTO ZnodeCMSSEODetailLocale(CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CanonicalURL,RobotTag)  
		SELECT DISTINCT IZCSD.CMSSEODetailId,@LocaleId,ISD.SEOTitle,ISD.SEODescription,ISD.SEOKeywords,@USerId, @GetDate,@USerId, @GetDate,CanonicalURL,RobotTag   
		FROM @InsertedZnodeCMSSEODetail IZCSD   
		INNER JOIN @InsertSEODetailsOFProducts ISD ON IZCSD.SEOCode = ISD.Code   

		----Making product as draft if SEOUrl is inserted for part of partial publish
		UPDATE ZPP SET ZPP.PublishStateId = (SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE StateName = 'Draft')
		FROM ZnodePimProduct ZPP
		INNER JOIN ZnodePimAttributeValue ZPAV ON ZPP.PimProductId = ZPAV.PimProductId
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		WHERE EXISTS (SELECT * FROM ZnodePimAttribute zpa WHERE zpa.AttributeCode = 'SKU' AND ZPAV.PimAttributeId = zpa.PimAttributeId)
		AND EXISTS(SELECT * FROM @InsertedZnodeCMSSEODetail IZCSD WHERE ZPAVL.AttributeValue = IZCSD.SEOCode)
  
		-----RedirectUrlInsert  
		INSERT INTO ZnodeCMSUrlRedirect ( RedirectFrom,RedirectTo,IsActive,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)  
		SELECT RedirectFrom,RedirectTo,
		EnableRedirection,@PortalId as PortalId ,2 as CreatedBy,@GetDate as CreatedDate,2 as ModifiedBy,@GetDate as ModifiedDate  
		FROM @InsertSEODetailsOFProducts SDP  
		WHERE IsRedirect = 1
		AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSUrlRedirect ZCR 
			WHERE ZCR.RedirectFROM = SDP.RedirectFROM AND ZCR.RedirectTo = SDP.RedirectTo)
			AND (SDP.RedirectFROM <> '' AND SDP.RedirectTo <> '' )
  
	END  
  
	-- Insert Category Data   
	IF EXISTS (SELECT TOP 1 1 FROM @InsertSEODetailsOFCategory)  
	BEGIN  
  
		UPDATE ZCSD SET ZCSD.IsRedirect = ISD.IsRedirect ,  
			ZCSD.MetaInformation =  ISD.MetaInformation,  
			ZCSD.SEOUrl=  ISD.SEOUrl,  
			ZCSD.IsPublish = 0  
		FROM @InsertSEODetailsOFCategory ISD    
		INNER JOIN ZnodeCMSSEODetail ZCSD ON  ZCSD.CMSSEOTypeId = @CMSSEOTypeCategory AND ZCSD.SEOCode = ISD.Code  
		INNER JOIN ZnodeCMSSEODetailLocale ZCSDL ON ZCSD.CMSSEODetailId = ZCSDL.CMSSEODetailId  
		WHERE  ZCSD.PortalId  =@PortalId;  
     
     
		UPDATE ZCSDL SET ZCSDL.SEOTitle = ISD.SEOTitle  
			,ZCSDL.SEODescription = ISD.SEODescription  
			,ZCSDL.SEOKeywords= ISD.SEOKeywords 
			,CanonicalURL = ISD.CanonicalURL
			,RobotTag = ISD.RobotTag
		FROM @InsertSEODetailsOFCategory ISD    
		INNER JOIN ZnodeCMSSEODetail ZCSD ON  ZCSD.CMSSEOTypeId = @CMSSEOTypeCategory AND ZCSD.SEOCode = ISD.Code  
		INNER JOIN ZnodeCMSSEODetailLocale ZCSDL ON ZCSD.CMSSEODetailId = ZCSDL.CMSSEODetailId  
		WHERE  ZCSD.PortalId  =@PortalId AND ZCSDL.LocaleId = @LocaleId;   
  
		INSERT INTO ZnodeCMSSEODetailLocale (CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CanonicalURL,RobotTag)  
		SELECT DISTINCT CSD.CMSSEODetailId,@LocaleId,ISD.SEOTitle,ISD.SEODescription,ISD.SEOKeywords,@USerId, @GetDate,@USerId, @GetDate,CanonicalURL,RobotTag  
		FROM ZnodeCMSSEODetail CSD  
		INNER JOIN @InsertSEODetailsOFProducts ISD ON CSD.SEOCode = ISD.Code AND CSD.CMSSEOTypeId = @CMSSEOTypeCategory   
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEODetailLocale CSDL WHERE CSDL.LocaleId = @LocaleId AND CSD.CMSSEODetailId = CSDL.CMSSEODetailId )  
		AND CSD.portalId = @PortalId  
  
  
		DELETE FROM @InsertedZnodeCMSSEODetail  

		INSERT INTO ZnodeCMSSEODetail(CMSSEOTypeId,SEOCode,IsRedirect,MetaInformation,PortalId,SEOUrl,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)    
		OUTPUT Inserted.CMSSEODetailId,Inserted.SEOCode,Inserted.CMSSEOTypeId INTO @InsertedZnodeCMSSEODetail    
		SELECT DISTINCT @CMSSEOTypeCategory,ISD.Code , ISD.IsRedirect,ISD.MetaInformation,@PortalId,ISD.SEOUrl,@USerId, @GetDate,@USerId, @GetDate   
		FROM @InsertSEODetailsOFCategory ISD    
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEODetail ZCSD WHERE ZCSD.CMSSEOTypeId = @CMSSEOTypeCategory AND ZCSD.SEOCode  = ISD.Code AND ZCSD.PortalId = @PortalId );  
  
		INSERT INTO ZnodeCMSSEODetailLocale(CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CanonicalURL,RobotTag)  
		SELECT DISTINCT IZCSD.CMSSEODetailId,@LocaleId,ISD.SEOTitle,ISD.SEODescription,ISD.SEOKeywords,@USerId, @GetDate,@USerId, @GetDate,CanonicalURL,RobotTag   
		FROM @InsertedZnodeCMSSEODetail IZCSD   
		INNER JOIN @InsertSEODetailsOFCategory ISD ON IZCSD.SEOCode = ISD.Code   
		WHERE IZCSD.CMSSEOTypeId =@CMSSEOTypeCategory    

		-----RedirectUrlInsert  
		INSERT INTO ZnodeCMSUrlRedirect ( RedirectFrom,RedirectTo,IsActive,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)  
		SELECT RedirectFrom,RedirectTo,
		EnableRedirection,@PortalId as PortalId ,2 as CreatedBy,@GetDate as CreatedDate,2 as ModifiedBy,@GetDate as ModifiedDate  
		FROM @InsertSEODetailsOFCategory SDP  
		WHERE IsRedirect = 1 
		AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSUrlRedirect ZCR 
			WHERE ZCR.RedirectFROM = SDP.RedirectFROM AND ZCR.RedirectTo = SDP.RedirectTo)
			AND (SDP.RedirectFROM <> '' AND SDP.RedirectTo <> '' )
	END  

	-- UPDATE Record count IN log 
	DECLARE @FailedRecordCount BIGINT
	DECLARE @SuccessRecordCount BIGINT
	SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
	SELECT @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertSEODetails
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
	WHERE ImportProcessLogId = @ImportProcessLogId;
	


	--Updating the import process status
	UPDATE ZnodeImportProcessLog
	SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
						WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
						WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
					END, 
		ProcessCompletedDate = getdate()
	WHERE ImportProcessLogId = @ImportProcessLogId; 
  
COMMIT TRAN A;  
END TRY  
BEGIN CATCH  
ROLLBACK TRAN A;

	SET @Status = 0;  
	SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE(); 

	DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportSEODetails @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@LocaleId='+CAST(@LocaleId AS VARCHAR(max)) +',@PortalId='+CAST(@PortalId AS VARCHAR(max)) +',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max)) ;

	---Import process updating fail due to database error
	UPDATE ZnodeImportProcessLog
	SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
	WHERE ImportProcessLogId = @ImportProcessLogId;

	---Loging error for Import process due to database error
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

	--Updating total AND fail record count
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
	TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
	WHERE ImportProcessLogId = @ImportProcessLogId;

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_ImportSEODetails',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
    
END CATCH;  
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetSearchRuleDetails')
	DROP PROC Znode_GetSearchRuleDetails
GO

CREATE PROCEDURE [dbo].[Znode_GetSearchRuleDetails]
(
	@WhereClause         VARCHAR(MAX)  = '',
    @Rows                INT           = 100,
    @PageNo              INT           = 1,
    @Order_BY            VARCHAR(1000) = '',
    @RowsCount           INT OUT
)
AS
BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
		Declare @TBL_SerchRuleDetail Table (SearchCatalogRuleId Int, RuleName varchar(600), UserName nvarchar(512), CreatedDate Datetime, StartDate Datetime, EndDate Datetime, IsPause Bit,RowId Int, CountId Int)
		Declare @SQL Varchar(max)

		SET @SQL = '
		;With Cte_SerchRuleDetail As'+
		+'('+
			+' SELECT ZSCR.publishcatalogid, ZSCR.SearchCatalogRuleId, ZSCR.RuleName, ANZU.UserName, ZSCR.CreatedDate, ZSCR.StartDate, ZSCR.EndDate, ZSCR.IsPause '+ 
			+' FROM ZnodeSearchCatalogRule ZSCR '+ 
			+' LEFT JOIN ZnodeUser ZU ON ZSCR.CreatedBy = ZU.UserId '+
			+' INNER JOIN AspNetUsers ANU ON ZU.AspNetUserId = ANU.Id '+
			+' INNER JOIN AspNetZnodeUser ANZU ON ANU.UserName = ANZU.AspNetZnodeUserId WHERE 1=1 '+[dbo].[Fn_GetFilterWhereClause](@WhereClause)
		 +')'+
		 +',Cte_SerchRuleDetail_OrderBy AS '+
		 +'('
			+' SELECT publishcatalogid,SearchCatalogRuleId, RuleName, UserName, CreatedDate, StartDate, EndDate, IsPause '+
			+' , '+[dbo].[Fn_GetPagingRowId](@Order_BY, ' SearchCatalogRuleId ASC')+
			+' FROM Cte_SerchRuleDetail '+
		+')'+
		 +' SELECT CSRD.SearchCatalogRuleId, CSRD.RuleName, CSRD.UserName, CSRD.CreatedDate, StartDate, EndDate, IsPause, Count(*)Over() As CountId '+
		 +' FROM Cte_SerchRuleDetail_OrderBy CSRD 
		 '+[dbo].[Fn_GetPaginationWhereClause](@PageNo, @Rows)+'
		 '+[dbo].[Fn_GetFilterWhereClause](@WhereClause)+'
		 '+[dbo].[Fn_GetOrderByClause](@Order_BY, 'CSRD.SearchCatalogRuleId ASC')
		
		 print @SQL
		 INSERT INTO @TBL_SerchRuleDetail (SearchCatalogRuleId, RuleName, UserName, CreatedDate, StartDate, EndDate, IsPause, CountId)
		 EXEC (@SQL)

		 SELECT SearchCatalogRuleId, RuleName, UserName, CreatedDate, StartDate, EndDate,IsPause, 
		        CASE WHEN IsPause = 1 THEN 'Yes' ELSE 'No' END AS Paused, 
				CountId
		 FROM @TBL_SerchRuleDetail

		 SET @RowsCount = ISNULL((SELECT top 1 CountId FROM @TBL_SerchRuleDetail), 0);
	END TRY
         BEGIN CATCH
		
		DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetSearchRuleDetails @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetSearchRuleDetails',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
            
      END CATCH;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetCategoryFeedList')
	DROP PROC Znode_GetCategoryFeedList
GO

  
CREATE PROCEDURE [dbo].[Znode_GetCategoryFeedList]
( @PortalId         NVARCHAR(MAX) = NULL,
  @LocaleId         INT,
  --will be used for CategoryId
  @CommaSeparatedId NVARCHAR(MAX) = NULL 
)
AS
/*
 Summary:This procedure is used to get effective keyword feeding of category list
 Unit Testing:
 EXEC Znode_GetCategoryFeedList 1 

*/

	BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
		DECLARE @DefaultLocaleId INT= dbo.Fn_GetDefaultValue('Locale');

		DECLARE @TBL_DomainName TABLE
		(PortalId   INT,
		DomainName NVARCHAR(300),
		RowId      INT
		);

		DECLARE @TBL_PortalIds TABLE(PortalId INT);
		DECLARE @TBL_SEODetails TABLE
		(loc                   NVARCHAR(MAX),
		lastmod               DATETIME,
		[g:condition]         VARCHAR(100),
		[description]         NVARCHAR(MAX),
		[g:id]                INT,
		link                  VARCHAR(100),
		[g:identifier_exists] VARCHAR(200),
		DomainName            NVARCHAR(300),
		PortalId              INT,
		SEOCode               NVARCHAR(4000),
		CanonicalURL        VARCHAR(200), 
		RobotTag            VARCHAR(50)
		);

		INSERT INTO @TBL_PortalIds(PortalId)
		SELECT Zp.PortalId
		FROM Znodeportal AS ZP
		INNER JOIN ZnodePortalCatalog AS ZPC ON(ZPC.PortalId = Zp.PortalId)
		INNER JOIN ZnodePublishCatalog AS ZPPC ON(ZPPC.PublishCatalogId = ZPC.PublishCatalogId)
		INNER JOIN ZnodePublishCategory AS ZPP ON(ZPP.PublishCatalogId = ZPPC.PublishCatalogId)
		WHERE EXISTS
			(
			SELECT TOP 1 1
			FROM DBO.Split(@PortalID, ',') AS Sp
			WHERE(CAST(sp.Item AS INT) = ZP.PortalId
			OR @PortalID = '0' )
			)
		GROUP BY Zp.PortalId;
	
		INSERT INTO @TBL_DomainName(PortalId,DomainName,RowId)
		SELECT ZD.PortalId,ZD.DomainName,    
		ROW_NUMBER() OVER(Partition BY ZD.DomainName,ZD.PortalId ORDER BY ZD.DomainName,ZD.PortalId) RowId                               
		FROM ZnodeDomain ZD
		WHERE EXISTS
			(
			SELECT TOP 1 1
			FROM @TBL_PortalIds TBP
			WHERE TBP.PortalId = ZD.PortalId
			)
		AND ApplicationType = 'Webstore'
		AND IsActive =1 
		AND IsDefault = 1;

		If Not Exists (Select TOP 1 1 from @TBL_DomainName)
        Begin
            INSERT INTO @TBL_DomainName(PortalId,DomainName,RowId)
            SELECT ZD.PortalId,ZD.DomainName,    
            ROW_NUMBER() OVER(Partition BY ZD.DomainName,ZD.PortalId ORDER BY ZD.DomainName,ZD.PortalId) RowId                               
            FROM ZnodeDomain ZD
            WHERE EXISTS
                (
                SELECT TOP 1 1
                FROM @TBL_PortalIds TBP
                WHERE TBP.PortalId = ZD.PortalId
                )
            AND ApplicationType = 'Webstore'
            AND IsActive =1 
            AND IsDefault = 0;
        End

		
		;WITH Cte_SeoDetailsWithLocale
		AS (
			SELECT DISTINCT ZCSD.CMSSEODetailId,ZCSD.SEOURL AS loc,ZCSD.ModifiedDate AS lastmod,'new' AS [g:condition],
			ZCSDL.SEODescription AS [description],ZPCC.PublishCategoryId AS [g:id],'' AS link,'false' AS [g:identifier_exists],TBDN.DomainName,ZPC.PortalId,ISNULL(ZCSDL.LocaleId, @DefaultLocaleId) AS LocaleId ,ZCSD.SEOCode, ZCSDL.CanonicalURL, ZCSDL.RobotTag
			FROM ZnodePublishCategory AS ZPCC 
			LEFT JOIN ZnodePublishCatalog AS ZPPC ON(ZPPC.PublishCatalogId = ZPCC.PublishCatalogId)
			LEFT JOIN ZnodePortalCatalog AS ZPC ON(ZPC.PublishCatalogId = ZPPC.PublishCatalogId)
			LEFT JOIN ZnodePublishcategorydetail PCD ON (PCD.PublishCategoryId = ZPCC.PublishCategoryId)
			LEFT JOIN @TBL_DomainName AS TBDN ON(TBDN.RowId = 1 AND TBDN.PortalId = ZPC.PortalId)
			LEFT JOIN ZnodeCMSSEODetail AS ZCSD ON(PCD.CategoryCode = ZCSD.SEOCode AND ZPC.PortalId = ZCSD.PortalId
			AND EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEOType AS ZCST
			WHERE ZCST.CMSSEOTypeId = ZCSD.CMSSEOTypeId  AND ZCST.Name = 'Category')) 
			LEFT  JOIN ZnodeCMSSEODetailLocale AS ZCSDL ON(ZCSDL.CMSSEODetailId = ZCSD.CMSSEODetailId
			AND ZCSDL.LocaleId IN(@LocaleId, @DefaultLocaleId))
			WHERE EXISTS
					(
					SELECT TOP 1 1
					FROM @TBL_PortalIds TBP
					WHERE ZPC.PortalId = TBP.PortalId
					)
			AND EXISTS (SELECT TOP 1 1 FROM  dbo.split(@CommaSeparatedId,',' ) SP WHERE SP.Item = PCD.CategoryCode)
		),

		Cte_SeoDetailsWithFirstLocale
		AS (SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName
		,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag
		FROM Cte_SeoDetailsWithLocale
		WHERE LocaleId = @LocaleId),

		Cte_SeoDetailsWithDefaultLocale
		AS (SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName
		,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag
		FROM Cte_SeoDetailsWithFirstLocale
		UNION ALL
		SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName
		,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag
		FROM Cte_SeoDetailsWithLocale AS CTSDWL
		WHERE LocaleId = @DefaultLocaleId
		AND NOT EXISTS
		(
		SELECT TOP 1 1
		FROM Cte_SeoDetailsWithFirstLocale AS CTSDWDL
		WHERE CTSDWDL.CMSSEODetailId = CTSDWL.CMSSEODetailId
		))

		INSERT INTO @TBL_SEODetails (loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName
		,PortalId,SEOCode, CanonicalURL, RobotTag)
		SELECT loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId,SEOCode, CanonicalURL, RobotTag
		FROM Cte_SeoDetailsWithDefaultLocale;
		

		SELECT DISTINCT loc,lastmod,DomainName,[g:id] AS id,PortalId,b.PublishCategoryName AS Name,SEOCode, CanonicalURL, RobotTag
		FROM @TBL_SEODetails a
		left JOIN ZnodePublishCategoryDetail b ON(b.PublishCategoryId = a.[g:id] AND b.LOcaleId = @LocaleId)
		WHERE DomainName IS NOT NULL
		
		END TRY
		BEGIN CATCH
		DECLARE @Status BIT ;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetCategoryFeedList @PortalId = '+@PortalId+',@LocaleId='+CAST(@LocaleId AS VARCHAR(10))+',@CommaSeparatedId='+@CommaSeparatedId+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		   
		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_GetCategoryFeedList',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetContentFeedList')
	DROP PROC Znode_GetContentFeedList
GO

CREATE PROCEDURE [dbo].[Znode_GetContentFeedList]
( @PortalId NVARCHAR(MAX) = NULL,
  @LocaleId INT)
AS
/*
	Summary : This procedure is used to get effective keyword feeding of content list
	Unit Testing:
	EXEC Znode_GetContentFeedList 4,1
	
*/
     BEGIN
         SET NOCOUNT ON;
		 BEGIN TRY
         DECLARE @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId();
         DECLARE @TBL_DomainName TABLE
         (PortalId   INT,
          DomainName NVARCHAR(300),
          RowId      INT
         );

         DECLARE @TBL_PortalIds TABLE(PortalId INT);
         DECLARE @TBL_SEODetails TABLE
         (loc                   NVARCHAR(MAX),
          lastmod               DATETIME,
          [g:condition]         VARCHAR(100),
          [description]         NVARCHAR(MAX),
          [g:id]                INT,
          link                  VARCHAR(100),
          [g:identifier_exists] VARCHAR(200),
          DomainName            NVARCHAR(300),
          PortalId              INT,
		  SEOCode               NVARCHAR(4000),
		  CanonicalURL          NVARCHAR(200),
		  RobotTag              NVARCHAR(50)
         );

		 if object_id('tempdb..#CMSSEOData') is not null
			drop table #CMSSEOData

		 CREATE TABLE #CMSSEOData 
		 (loc varchar(max),lastmod DateTime,DomainName varchar(200),[image] varchar(1000),Name varchar(500), CMSContentPagesId Int,PortalId Int, SEOCode NVARCHAR(4000)
		 , CanonicalURL NVARCHAR(200), RobotTag NVARCHAR(50))

         INSERT INTO @TBL_PortalIds
                SELECT Zp.PortalId
                FROM Znodeportal AS ZP
                INNER JOIN ZnodeCMSContentPages AS ZPC ON(ZPC.PortalId = Zp.PortalId)
                WHERE EXISTS
                (
                    SELECT TOP 1 1
                    FROM DBO.Split(@PortalID, ',') AS Sp
                    WHERE(CAST(sp.Item AS INT) = ZP.PortalId
                          OR @PortalID = '0' )
                )
                GROUP BY Zp.PortalId;

				
         INSERT INTO @TBL_DomainName
                SELECT ZD.PortalId,ZD.DomainName,                     
                       ROW_NUMBER() OVER(PArtition BY ZD.DomainName,
                                                  ZD.PortalId ORDER BY ZD.DomainName,
                                                  ZD.PortalId) RowId
                FROM ZnodeDomain ZD
                WHERE EXISTS
                (
                    SELECT TOP 1 1
                    FROM @TBL_PortalIds TBP
                    WHERE TBP.PortalId = ZD.PortalId
                )
			AND IsActive =1 
			AND applicationType = 'Webstore'
			AND ZD.IsDefault = 1


			if not exists(select top 1 1 from @TBL_DomainName) 
			INSERT INTO @TBL_DomainName
                SELECT ZD.PortalId,ZD.DomainName,                     
                       ROW_NUMBER() OVER(PArtition BY ZD.DomainName,
                                                  ZD.PortalId ORDER BY ZD.DomainName,
                                                  ZD.PortalId) RowId
                FROM ZnodeDomain ZD
                WHERE EXISTS
                (
                    SELECT TOP 1 1
                    FROM @TBL_PortalIds TBP
                    WHERE TBP.PortalId = ZD.PortalId
                )
			AND IsActive =1 
			AND applicationType = 'Webstore'
			AND ZD.IsDefault = 0

         ;WITH Cte_SeoDetailsWithLocale
              AS (SELECT DISTINCT ZCSD.CMSSEODetailId,  ZCSD.SEOURL AS loc,ZCSD.ModifiedDate AS lastmod,'new' AS [g:condition],ZCSDL.SEODescription AS [description],ZPCC.CMSContentPagesId AS [g:id],'' AS link,'false' AS [g:identifier_exists],TBDN.DomainName,ZPCC.PortalId,ISNULL(ZCSDL.LocaleId, @DefaultLocaleId) AS LocaleId,ZCSD.SEOCode
			      , ZCSDL.CanonicalURL, ZCSDL.RobotTag
                 FROM ZnodeCMSContentPages AS ZPCC 
                 LEFT JOIN ZnodeCMSSEODetail AS ZCSD ON(ZPCC.PageName = ZCSD.SEOCode AND EXISTS ( SELECT TOP 1 1 FROM ZnodeCMSSEOType AS ZCST WHERE ZCST.CMSSEOTypeId = ZCSD.CMSSEOTypeId
                                                   AND ZCST.Name = 'Content Page') AND ZCSD.PortalId = ZPCC.PortalId )
                 LEFT JOIN ZnodeCMSSEODetailLocale AS ZCSDL ON(ZCSDL.CMSSEODetailId = ZCSD.CMSSEODetailId
                                                            AND LocaleId IN(@LocaleId, @DefaultLocaleId))
                 LEFT JOIN @TBL_DomainName AS TBDN ON(TBDN.RowId = 1 AND TBDN.PortalId = ZPCC.PortalId )
                  WHERE  ZPCC.IsActive = 1 AND exists (select top 1 1 from ZnodePublishState ZPS where ZPS.StateName in ( 'Publish','Preview') and ZPCC.PublishStateId= ZPS.PublishStateId)
				  AND EXISTS
                  (
                      SELECT TOP 1 1
                      FROM @TBL_PortalIds TBP
                      WHERE ZPCC.PortalId = TBP.PortalId
                  )
				  AND EXISTS (SELECT TOP 1 1 FROM   @TBL_PortalIds TBPL
                      WHERE ZCSD.PortalId = TBPL.PortalId  
					  )
				  )
				   
				  --select  * from Cte_SeoDetailsWithLocale

             ,Cte_SeoDetailsWithFirstLocale
              AS (SELECT *
                  FROM Cte_SeoDetailsWithLocale
                  WHERE LocaleId = @LocaleId),

              Cte_SeoDetailsWithDefaultLocale
              AS (
              SELECT *
              FROM Cte_SeoDetailsWithFirstLocale
              UNION ALL
              SELECT *
              FROM Cte_SeoDetailsWithLocale AS CTSDWL
              WHERE LocaleId = @DefaultLocaleId
                    AND NOT EXISTS
              (
                  SELECT TOP 1 1
                  FROM Cte_SeoDetailsWithFirstLocale AS CTSDWDL
                  WHERE CTSDWDL.CMSSEODetailId = CTSDWL.CMSSEODetailId
              ))

              INSERT INTO @TBL_SEODetails
                     SELECT loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId,SEOCode,CanonicalURL,RobotTag
                     FROM Cte_SeoDetailsWithDefaultLocale;

         WITH Cte_ContentPages
              AS (SELECT ZCCP.CMSContentPagesId,ZCCPl.PageTitle,ZCCPL.LocaleId,ZCCP.PageName
                  FROM ZnodeCMSContentPages ZCCP
                  INNER JOIN ZnodeCMSContentPagesLocale ZCCPL ON(ZCCPL.CMSContentPagesId = ZCCP.CMSContentPagesId)
                  WHERE ZCCP.IsActive = 1 AND exists (select top 1 1 from ZnodePublishState ZPS where ZPS.PublishStateCode in ( 'Publish','Preview') and ZCCP.PublishStateId= ZPS.PublishStateId)				  
				  AND EXISTS
                  (
                      SELECT TOP 1 1
                      FROM @TBL_SEODetails TBSD
                      WHERE TBSD.[g:id] = ZCCP.CMSContentPagesId
                  )
                        AND LocaleID IN(@LocaleId, @DefaultLocaleId)),

              Cte_ContentPageFirstLocale
              AS (SELECT *
                  FROM Cte_ContentPages CTCP
                  WHERE LocaleId = @LocaleId),

              Cte_ContentPageSecondLocale
              AS (
              SELECT *
              FROM Cte_ContentPageFirstLocale CTPFL
              UNION ALL
              SELECT *
              FROM Cte_ContentPages CTCP
              WHERE LocaleId = @LocaleId
                    AND NOT EXISTS
              (
                  SELECT TOP 1 1
                  FROM Cte_ContentPageFirstLocale CTCPFL
                  WHERE CTCPFL.CMSContentPagesId = CTCP.CMSContentPagesId
              ))
			  INSERT INTO #CMSSEOData(loc,lastmod,DomainName,[image], Name, CMSContentPagesId,PortalId,SEOCode,CanonicalURL,RobotTag)
              SELECT loc,lastmod,DomainName,'' AS [image],PageName Name,[g:id] CMSContentPagesId,PortalId,SEOCode,CanonicalURL,RobotTag
              FROM @TBL_SEODetails TBSD
              LEFT JOIN Cte_ContentPageSecondLocale CTCPSL ON(TBSD.[g:id] = CTCPSL.CMSContentPagesId);

			  ---- CMS SEO Blog News Details
			  INSERT INTO #CMSSEOData(loc,lastmod,DomainName,[image], Name, CMSContentPagesId,PortalId,SEOCode,CanonicalURL,RobotTag)
			  EXEC [Znode_GetBlogFeedList] @PortalId, @LocaleId

			  SELECT loc, REPLACE(CONVERT(VARCHAR(30),lastmod,102),'.','-') AS lastmod,DomainName,[image], Name, CMSContentPagesId,PortalId,CanonicalURL,RobotTag FROM #CMSSEOData

		END TRY
		BEGIN CATCH
		  DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetContentFeedList @PortalId = '+@PortalId+',@LocaleId='+CAST(@LocaleId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetContentFeedList',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
		END CATCH
     END;


GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetProductFeedList')
	DROP PROC Znode_GetProductFeedList
GO

CREATE PROCEDURE [dbo].[Znode_GetProductFeedList]  
		(
		@PortalId   VARCHAR(2000) = NULL,  
		@SKU  SelectColumnList READONLY,  
		@LocaleId   INT,  
		@FeedType   NVARCHAR(MAX) = NULL   
		)
		AS  
/*  
Summary: This Procedure is used to get effective keyword feeding of Product list  
 SELECT * FROM ZnodePublishProductDetail  
 SELECT * FROM ZnodePublishProduct WHERE PublishCatalogId = 3  
 SELECT * FROM ZnodePortalCatalog   
 Unit Testing:  
 EXEC [Znode_GetProductFeedList] @PortalId='0',@ProductIds = '116,117,118'  
 ,@LocaleId=1,@FeedType='Bing'   
  
		*/  
		BEGIN  
		BEGIN TRY  
		SET NOCOUNT ON;        
           
		IF OBJECT_ID('tempdb..#TBL_DomainName') IS NOT NULL
		DROP TABLE #TBL_DomainName

		IF OBJECT_ID('tempdb..#TBL_SEODetails') IS NOT NULL
		DROP TABLE #TBL_SEODetails

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_PortalIds') IS NOT NULL
		DROP TABLE #TBL_PortalIds

		DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
		CREATE TABLE #TBL_DomainName 
		(PortalId   INT,
		DomainName NVARCHAR(300),
		RowId      INT
		);  	
         
		CREATE TABLE #TBL_SEODetails   
		(loc                   NVARCHAR(MAX),  
		lastmod               DATETIME,  
		[g:condition]         VARCHAR(100),  
		[description]         NVARCHAR(MAX),  
		[g:id]                INT,  
		link                  VARCHAR(100),  
		[g:identifier_exists] VARCHAR(200),  
		DomainName            NVARCHAR(300),  
		PortalId              INT , 
		SEOCode             NVARCHAR(4000), 
		CanonicalURL        VARCHAR(200), 
		RobotTag            VARCHAR(50)
		);  
		--CREATE TABLE #TBL_CompleteDetailes   
		--(loc                   NVARCHAR(MAX),  
		--lastmod               DATETIME,  
		--[g:condition]         VARCHAR(100),  
		--[description]         NVARCHAR(MAX),  
		--[g:id]                INT,  
		--link                  VARCHAR(100),  
		--[g:identifier_exists] VARCHAR(200),  
		--DomainName            NVARCHAR(300),  
		--PortalId              INT,  
		--[g:availability]      NVARCHAR(1000),  
		--SKU                   NVARCHAR(1000),  
		--SEOCode               NVARCHAR(4000),
		--CanonicalURL        VARCHAR(200), 
		--RobotTag            VARCHAR(50) 
		--);  
		DECLARE @DefaultLocaleId INT=dbo.Fn_GetDefaultLocaleId()  ;
		CREATE TABLE #TBL_PortalIds (PortalId INT);  
			
		select * into #SKU from @SKU
		create index IDX_#SKU on #SKU(StringColumn)
		
		INSERT INTO #TBL_PortalIds  
		SELECT Zp.PortalId   
		FROM Znodeportal AS ZP   
		INNER JOIN ZnodePortalCatalog AS ZPC ON(ZPC.PortalId = Zp.PortalId)  
		INNER JOIN ZnodePublishCatalog AS ZPPC ON(ZPPC.PublishCatalogId = ZPC.PublishCatalogId)   
		INNER JOIN ZNodePublishProduct AS ZPP ON(ZPP.PublishCatalogId = ZPPC.PublishCatalogId)  
		INNER JOIN ZnodePublishProductDetail AS PPD ON (PPD.PublishProductId = ZPP.PublishProductId)  
		WHERE EXISTS(SELECT TOP 1 1 FROM #SKU AS Sp WHERE sp.StringColumn  = PPD.SKU OR StringColumn = '0')  
		AND EXISTS(SELECT TOP 1 1 FROM DBO.Split(@PortalId, ',') AS Sp  
		WHERE(CAST(sp.Item AS INT)) = Zp.PortalId  OR @PortalId = '0')  
		AND EXISTS (SELECT TOP 1 1 FROM ZnodeDomain ZD WHERE ZP.PortalId = ZD.PortalId  
		AND IsActive = 1 AND ApplicationType = 'Webstore' )  
		GROUP BY Zp.PortalId;   
		
		INSERT INTO #TBL_DomainName   
		SELECT  PortalId,DomainName,ROW_NUMBER() OVER(PARTITION BY PortalId ORDER BY DomainName)   
		FROM ZnodeDomain AS ZD   
		WHERE EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZD.PortalId)  
		AND IsActive = 1 AND ApplicationType = 'Webstore' AND IsDefault = 1 

		if not exists (select top 1 1 from #TBL_DomainName)
		INSERT INTO #TBL_DomainName   
		SELECT  PortalId,DomainName,ROW_NUMBER() OVER(PARTITION BY PortalId ORDER BY DomainName)   
		FROM ZnodeDomain AS ZD   
		WHERE EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZD.PortalId)  
		AND IsActive = 1 AND ApplicationType = 'Webstore' AND IsDefault = 0 
 
		IF EXISTS(SELECT * FROM #SKU)
        BEGIN
		    --INSERT INTO #Cte_SeoDetailsWithLocale(CMSSEODetailId ,loc ,lastmod ,[g:condition] ,[description] ,[g:id] ,link ,[g:identifier_exists] ,DomainName ,PortalId,LocaleId ,SEOCode ,CanonicalURL ,RobotTag)
			SELECT DISTINCT ZCSD.CMSSEODetailId,ZCSD.SEOURL AS loc,ZCSD.ModifiedDate AS lastmod,'new' AS [g:condition],ZCSDL.SEODescription AS [description],ZPCC.PublishProductId AS [g:id],  
            '' AS link,'false' AS [g:identifier_exists],TBDN.DomainName,ZPC.PortalId,ISNULL(ZCSDL.LocaleId, @DefaultLocaleId) AS LocaleId , ZCSD.SEOCode , ZCSDL.CanonicalURL, ZCSDL.RobotTag 
			INTO #Cte_SeoDetailsWithLocale
			FROM ZNodePublishProduct AS ZPCC   
			INNER JOIN ZnodePortalCatalog AS ZPC ON(ZPC.PublishCatalogId = ZPCC.PublishCatalogId)  
			LEFT JOIN ZnodePublishProductDetail AS PPD ON (PPD.PublishProductId = ZPCC.PublishProductId)  
			--INNER JOIN @TBL_PortalIds TBLP ON (TBLP.PortalId = ZPC.PortalId)  
			LEFT JOIN ZnodeCMSSEODetail AS ZCSD ON(PPD.SKU = ZCSD.SEOCode and ZCSD.PortalId = ZPC.PortalId)  
			LEFT JOIN ZnodeCMSSEOType AS ZCST ON(ZCST.CMSSEOTypeId = ZCSD.CMSSEOTypeId AND ZCST.Name = 'Product')  
			LEFT JOIN ZnodeCMSSEODetailLocale AS ZCSDL ON(ZCSDL.CMSSEODetailId = ZCSD.CMSSEODetailId AND ZCSDL.LocaleId IN(@LocaleId, @DefaultLocaleId))  
			LEFT JOIN #TBL_DomainName AS TBDN ON(TBDN.RowId = 1 AND TBDN.PortalId = zpc.PortalId )   
			WHERE EXISTS(SELECT TOP 1 1 FROM #SKU AS Sp  
			WHERE (sp.StringColumn  = PPD.SKU) )--OR StringColumn = '0')  
			AND EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZPC.PortalId)  
				
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag  
			INTO #Cte_SeoDetailsWithFirstLocale
			FROM #Cte_SeoDetailsWithLocale   
			WHERE LocaleId = @LocaleId  
    
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode , CanonicalURL, RobotTag 
			INTO #Cte_SeoDetailsWithDefaultLocale
			FROM #Cte_SeoDetailsWithFirstLocale  
			
			INSERT INTO #Cte_SeoDetailsWithDefaultLocale 
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag  
			FROM #Cte_SeoDetailsWithLocale AS CTSDWL  
			WHERE LocaleId = @DefaultLocaleId   
			AND NOT EXISTS(SELECT TOP 1 1 FROM #Cte_SeoDetailsWithFirstLocale AS CTSDWDL WHERE CTSDWDL.CMSSEODetailId = CTSDWL.CMSSEODetailId)  
          
			INSERT INTO #TBL_SEODetails  
			SELECT DISTINCT loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId ,SEOCode, CanonicalURL, RobotTag  
			FROM #Cte_SeoDetailsWithDefaultLocale;  

			--CREATE INDEX Idx_#TBL_SEODetails ON #TBL_SEODetails([g:id])

			SELECT TBSD.loc,TBSD.lastmod,TBSD.[g:condition],TBSD.[description],TBSD.[g:id],TBSD.link,TBSD.[g:identifier_exists],TBSD.DomainName,TBSD.PortalId,  
			CASE WHEN SUM(ZI.Quantity) > 0 THEN 'In Stock' ELSE CASE WHEN @FeedType = 'Google' THEN 'Out Of Stock' ELSE 'Not In Stock' END  
			END AS [g:availability],
			ZPPD.SKU ,TBSD.SEOCode, TBSD.CanonicalURL, TBSD.RobotTag
			INTO #TBL_CompleteDetailes  
			FROM ZnodePublishProduct AS ZPP   
			LEFT JOIN #TBL_SEODetails AS TBSD ON(ZPP.PublishProductId = TBSD.[g:id] )  
			LEFT JOIN ZnodePublishProductDetail AS ZPPD ON(ZPPD.PublishProductId = ZPP.PublishProductId AND ZPPD.LocaleId = @LocaleId)  
			LEFT JOIN ZnodePortalWarehouse AS ZPW ON(ZPW.PortalId = TBSD.PortalId)  
			LEFT JOIN ZnodePortalAlternateWarehouse AS ZAPW ON(ZAPW.PortalWarehouseId = ZPW.PortalWarehouseId)  
			LEFT JOIN ZnodeInventory AS ZI ON(ZI.SKU = ZPPD.SKU AND (ZI.WarehouseId = ZPW.WarehouseId OR ZI.WarehouseId = ZAPW.WarehouseId))  
			WHERE EXISTS(SELECT TOP 1 1 FROM #SKU AS Sp WHERE (sp.StringColumn  = ZPPD.SKU))-- OR sp.StringColumn = '0')
			AND EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = TBSD.PortalId)	
			GROUP BY loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,TBSD.PortalId,ZPPD.SKU,ZPPD.LocaleId, TBSD.SEOCode, TBSD.CanonicalURL, TBSD.RobotTag;    
			
			DECLARE @MediaConfiguration NVARCHAR(2000)=((SELECT TOP 1 ISNULL(CASE WHEN CDNURL = '' THEN NULL ELSE CDNURL END,URL) FROM ZnodeMediaConfiguration WHERE IsActive = 1));    
  
			CREATE INDEX Idx_#TBL_CompleteDetailes ON #TBL_CompleteDetailes(PortalId,SKU)
	
	
			SELECT zp.PortalId,round(ZPS.RetailPrice,2) as RetailPrice,Zps.SKU,tbcd.SEOCode,ROW_NUMBER() OVER(PARTITION BY Zps.SKU,zp.PortalId ORDER BY ZPS.RetailPrice) AS RowId  
			INTO #Cte_PortalList
			FROM ZnodePriceList AS ZPL   
			LEFT JOIN ZnodePriceListPortal AS ZPLP ON ZPL.PriceListId = ZPLP.PriceListId  
			LEFT JOIN ZnodeCulture AS zc ON ZPL.CultureId = zc.CultureId
			LEFT JOIN ZnodePortal AS zp ON ZPLP.PortalId = zp.PortalId  
			LEFT JOIN ZnodePrice AS Zps ON(Zps.PriceListId = ZPL.PriceListId)   
			LEFT JOIN #TBL_CompleteDetailes AS TBCD ON(TBCD.PortalId = Zp.PortalId AND TBCD.SKU = Zps.Sku)   
			WHERE CAST(@GetDate AS DATE) BETWEEN ZPL.ActivationDate AND ZPL.ExpirationDate   
			AND EXISTS( SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZPLP.PortalId)   
			GROUP BY zp.PortalId,ZPS.RetailPrice,Zps.SKU ,TBCD.SEOCode  
 
			SELECT loc,lastmod,[g:condition],[description],[g:id],link,[g:availability],[g:identifier_exists],DomainName,TBCD.PortalId  
			,CTPL.RetailPrice AS [g:price],@MediaConfiguration AS MediaConfiguration, TBCD.SEOCode, TBCD.CanonicalURL, TBCD.RobotTag 
			FROM #TBL_CompleteDetailes AS TBCD   
			LEFT JOIN #Cte_PortalList AS CTPL ON(CTPL.PortalId = TBCD.PortalId AND CTPL.SKU = TBCD.SKU AND CTPL.RowID = 1)  
			WHERE  EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = TBCD.PortalId )  


		END
     	ELSE
		BEGIN
		    --INSERT INTO #Cte_SeoDetailsWithLocale(CMSSEODetailId ,loc ,lastmod ,[g:condition] ,[description] ,[g:id] ,link ,[g:identifier_exists] ,DomainName ,PortalId,LocaleId ,SEOCode ,CanonicalURL ,RobotTag)
			SELECT DISTINCT ZCSD.CMSSEODetailId,ZCSD.SEOURL AS loc,ZCSD.ModifiedDate AS lastmod,'new' AS [g:condition],ZCSDL.SEODescription AS [description],ZPCC.PublishProductId AS [g:id],  
			'' AS link,'false' AS [g:identifier_exists],TBDN.DomainName,ZPC.PortalId,ISNULL(ZCSDL.LocaleId, @DefaultLocaleId) AS LocaleId , ZCSD.SEOCode , ZCSDL.CanonicalURL, ZCSDL.RobotTag 
			INTO #Cte_SeoDetailsWithLocale1
			FROM ZNodePublishProduct AS ZPCC   
			INNER JOIN ZnodePortalCatalog AS ZPC ON(ZPC.PublishCatalogId = ZPCC.PublishCatalogId)  
			LEFT JOIN ZnodePublishProductDetail AS PPD ON (PPD.PublishProductId = ZPCC.PublishProductId)  
			-- INNER JOIN @TBL_PortalIds TBLP ON (TBLP.PortalId = ZPC.PortalId)  
			LEFT JOIN ZnodeCMSSEODetail AS ZCSD ON(PPD.SKU = ZCSD.SEOCode and ZCSD.PortalId = ZPC.PortalId)  
			LEFT JOIN ZnodeCMSSEOType AS ZCST ON(ZCST.CMSSEOTypeId = ZCSD.CMSSEOTypeId AND ZCST.Name = 'Product')  
			LEFT JOIN ZnodeCMSSEODetailLocale AS ZCSDL ON(ZCSDL.CMSSEODetailId = ZCSD.CMSSEODetailId AND ZCSDL.LocaleId IN(@LocaleId, @DefaultLocaleId))  
			LEFT JOIN #TBL_DomainName AS TBDN ON(TBDN.RowId = 1 AND TBDN.PortalId = zpc.PortalId )   
			WHERE EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZPC.PortalId)
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag  
			INTO #Cte_SeoDetailsWithFirstLocale1
			FROM #Cte_SeoDetailsWithLocale1   
			WHERE LocaleId = @LocaleId  
    
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode , CanonicalURL, RobotTag 
			INTO #Cte_SeoDetailsWithDefaultLocale1
			FROM #Cte_SeoDetailsWithFirstLocale1  
			
			INSERT INTO #Cte_SeoDetailsWithDefaultLocale1 
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag  
			FROM #Cte_SeoDetailsWithLocale1 AS CTSDWL  
			WHERE LocaleId = @DefaultLocaleId   
			AND NOT EXISTS(SELECT TOP 1 1 FROM #Cte_SeoDetailsWithFirstLocale AS CTSDWDL WHERE CTSDWDL.CMSSEODetailId = CTSDWL.CMSSEODetailId)  
          
			INSERT INTO #TBL_SEODetails  
			SELECT DISTINCT loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId ,SEOCode, CanonicalURL, RobotTag  
			FROM #Cte_SeoDetailsWithDefaultLocale1;  
		  
			SELECT TBSD.loc,TBSD.lastmod,TBSD.[g:condition],TBSD.[description],TBSD.[g:id],TBSD.link,TBSD.[g:identifier_exists],TBSD.DomainName,TBSD.PortalId,  
			CASE WHEN SUM(ZI.Quantity) > 0 THEN 'In Stock' ELSE CASE WHEN @FeedType = 'Google' THEN 'Out Of Stock' ELSE 'Not In Stock' END  
			END AS [g:availability],
			ZPPD.SKU ,TBSD.SEOCode, TBSD.CanonicalURL, TBSD.RobotTag  
			INTO #TBL_CompleteDetailes1
			FROM ZnodePublishProduct AS ZPP   
			LEFT JOIN #TBL_SEODetails AS TBSD ON(ZPP.PublishProductId = TBSD.[g:id] )  
			LEFT JOIN ZnodePublishProductDetail AS ZPPD ON(ZPPD.PublishProductId = ZPP.PublishProductId AND ZPPD.LocaleId = @LocaleId )  
			LEFT JOIN ZnodePortalWarehouse AS ZPW ON(ZPW.PortalId = TBSD.PortalId)  
			LEFT JOIN ZnodePortalAlternateWarehouse AS ZAPW ON(ZAPW.PortalWarehouseId = ZPW.PortalWarehouseId)  
			LEFT JOIN ZnodeInventory AS ZI ON(ZI.SKU = ZPPD.SKU AND (ZI.WarehouseId = ZPW.WarehouseId OR ZI.WarehouseId = ZAPW.WarehouseId))  
			WHERE EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = TBSD.PortalId )	
			GROUP BY loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,TBSD.PortalId,ZPPD.SKU,ZPPD.LocaleId, TBSD.SEOCode, TBSD.CanonicalURL, TBSD.RobotTag;    
			

			DECLARE @MediaConfiguration1 NVARCHAR(2000)=((SELECT TOP 1 ISNULL(CASE WHEN CDNURL = '' THEN NULL ELSE CDNURL END,URL) FROM ZnodeMediaConfiguration WHERE IsActive = 1));    
  
			CREATE INDEX Idx_#TBL_CompleteDetailes1 ON #TBL_CompleteDetailes(PortalId,SKU)
	
	
			SELECT zp.PortalId,round(ZPS.RetailPrice,2) as RetailPrice,Zps.SKU,tbcd.SEOCode,ROW_NUMBER() OVER(PARTITION BY Zps.SKU,zp.PortalId ORDER BY ZPS.RetailPrice) AS RowId  
			INTO #Cte_PortalList1
			FROM ZnodePriceList AS ZPL   
			LEFT JOIN ZnodePriceListPortal AS ZPLP ON ZPL.PriceListId = ZPLP.PriceListId  
			LEFT JOIN ZnodeCulture AS zc ON ZPL.CultureId = zc.CultureId
			LEFT JOIN ZnodePortal AS zp ON ZPLP.PortalId = zp.PortalId  
			LEFT JOIN ZnodePrice AS Zps ON(Zps.PriceListId = ZPL.PriceListId)   
			LEFT JOIN #TBL_CompleteDetailes AS TBCD ON(TBCD.PortalId = Zp.PortalId AND TBCD.SKU = Zps.Sku)   
			WHERE CAST(@GetDate AS DATE) BETWEEN ZPL.ActivationDate AND ZPL.ExpirationDate   
			AND EXISTS( SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZPLP.PortalId)   
			GROUP BY zp.PortalId,ZPS.RetailPrice,Zps.SKU ,TBCD.SEOCode  
 
			SELECT loc,lastmod,[g:condition],[description],[g:id],link,[g:availability],[g:identifier_exists],DomainName,TBCD.PortalId  
			,CTPL.RetailPrice AS [g:price],@MediaConfiguration AS MediaConfiguration, TBCD.SEOCode, TBCD.CanonicalURL, TBCD.RobotTag 
			FROM #TBL_CompleteDetailes1 AS TBCD   
			LEFT JOIN #Cte_PortalList1 AS CTPL ON(CTPL.PortalId = TBCD.PortalId AND CTPL.SKU = TBCD.SKU AND CTPL.RowID = 1)  
			WHERE  EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = TBCD.PortalId )  

		END
 
		IF OBJECT_ID('tempdb..#TBL_DomainName') IS NOT NULL
		DROP TABLE #TBL_DomainName

		IF OBJECT_ID('tempdb..#TBL_SEODetails') IS NOT NULL
		DROP TABLE #TBL_SEODetails

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_PortalIds') IS NOT NULL
		DROP TABLE #TBL_PortalIds
		
		END TRY  
		BEGIN CATCH  
			DECLARE @Status BIT ;  
			SET @Status = 0;  
			DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetProductFeedList @PortalId = '+@PortalId+',@LocaleId='+CAST(@LocaleId AS VARCHAR(50))+',@FeedType='+CAST(@FeedType AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));  
                 
			SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
     
			EXEC Znode_InsertProcedureErrorLog  
			@ProcedureName = 'Znode_GetProductFeedList',  
			@ErrorInProcedure = @Error_procedure,  
			@ErrorMessage = @ErrorMessage,  
			@ErrorLine = @ErrorLine,  
			@ErrorCall = @ErrorCall;  
		END CATCH    
		END
		;

GO

UPDATE ZnodeMessage
SET MessageName='Input must not exceed the maximum character limit of 100.'
WHERE  MessageName='Input value must not exceed the maximum character limit of 100.'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetXmlProductFeedList')
	DROP PROC Znode_GetXmlProductFeedList
GO

CREATE PROCEDURE [dbo].[Znode_GetXmlProductFeedList]  
(
	@PortalId   VARCHAR(2000) = NULL,   
	@LocaleId   INT,  
	@FeedType   NVARCHAR(MAX) = NULL   
)
AS  
/*  
Summary: This Procedure is used to get effective keyword feeding of Product list  
 SELECT * FROM ZnodePublishProductDetail  
 SELECT * FROM ZnodePublishProduct WHERE PublishCatalogId = 3  
 SELECT * FROM ZnodePortalCatalog   
 Unit Testing:  
 EXEC [Znode_GetXmlProductFeedList] @PortalId='0',@ProductIds = '116,117,118'  
 ,@LocaleId=1,@FeedType='Bing'   
  
*/  
BEGIN  
BEGIN TRY  
SET NOCOUNT ON;        
           
		IF OBJECT_ID('tempdb..#TBL_DomainName') IS NOT NULL
		DROP TABLE #TBL_DomainName

		IF OBJECT_ID('tempdb..#TBL_SEODetails') IS NOT NULL
		DROP TABLE #TBL_SEODetails

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_PortalIds') IS NOT NULL
		DROP TABLE #TBL_PortalIds

		DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
		CREATE TABLE #TBL_DomainName 
		(PortalId   INT,
		DomainName NVARCHAR(300),
		RowId      INT
		);  	
         
		CREATE TABLE #TBL_SEODetails   
		(loc                   NVARCHAR(MAX),  
		lastmod               DATETIME,  
		[g:condition]         VARCHAR(1000),  
		[description]         NVARCHAR(MAX), 
		[SEOTitle]			  NVARCHAR(MAX),	
		[g:id]                INT,  
		link                  VARCHAR(1000),  
		[g:identifier_exists] VARCHAR(2000),  
		DomainName            NVARCHAR(3000),  
		PortalId              INT , 
		SEOCode             NVARCHAR(4000), 
		CanonicalURL        VARCHAR(2000), 
		RobotTag            VARCHAR(500)
		);  
		
		DECLARE @DefaultLocaleId INT=dbo.Fn_GetDefaultLocaleId()  ;
		CREATE TABLE #TBL_PortalIds (PortalId INT);  
		
		INSERT INTO #TBL_PortalIds  

		SELECT Zp.PortalId   
		FROM Znodeportal AS ZP   
		INNER JOIN ZnodePortalCatalog AS ZPC ON(ZPC.PortalId = Zp.PortalId)  
		INNER JOIN ZnodePublishCatalog AS ZPPC ON(ZPPC.PublishCatalogId = ZPC.PublishCatalogId)   
		INNER JOIN ZNodePublishProduct AS ZPP ON(ZPP.PublishCatalogId = ZPPC.PublishCatalogId)  
		INNER JOIN ZnodePublishProductDetail AS PPD ON (PPD.PublishProductId = ZPP.PublishProductId)  
		INNER JOIN ZnodePublishProductEntity AS ZPPE ON (PPD.SKU  = ZPPE.SKU)
		WHERE
		
		EXISTS(SELECT TOP 1 1 FROM DBO.Split(@PortalId, ',') AS Sp  
		WHERE(CAST(sp.Item AS INT)) = Zp.PortalId  OR @PortalId = '0')  
		AND EXISTS (SELECT TOP 1 1 FROM ZnodeDomain ZD WHERE ZP.PortalId = ZD.PortalId  
		AND IsActive = 1 AND ApplicationType = 'Webstore' AND IsDefault = 1)  
		GROUP BY Zp.PortalId;   
		
		INSERT INTO #TBL_DomainName   
		SELECT  PortalId,DomainName,ROW_NUMBER() OVER(PARTITION BY PortalId ORDER BY DomainName)   
		FROM ZnodeDomain AS ZD   
		WHERE EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZD.PortalId)  
		AND IsActive = 1 AND ApplicationType = 'Webstore' AND IsDefault = 1 
 
			SELECT DISTINCT ZCSD.CMSSEODetailId,ZCSD.SEOURL AS loc,ZCSD.ModifiedDate AS lastmod,'new' AS [g:condition],ZCSDL.SEODescription AS [description],ZCSDL.SEOTitle AS [SEOTitle], ZPCC.PublishProductId AS [g:id],  
            ZCSD.SEOUrl AS link,'false' AS [g:identifier_exists],TBDN.DomainName,ZPC.PortalId,ISNULL(ZCSDL.LocaleId, @DefaultLocaleId) AS LocaleId , ZCSD.SEOCode , ZCSDL.CanonicalURL, ZCSDL.RobotTag 
			INTO #Cte_SeoDetailsWithLocale
			FROM ZNodePublishProduct AS ZPCC   
			INNER JOIN ZnodePortalCatalog AS ZPC ON(ZPC.PublishCatalogId = ZPCC.PublishCatalogId)  
			LEFT JOIN ZnodePublishProductDetail AS PPD ON (PPD.PublishProductId = ZPCC.PublishProductId)  
			LEFT JOIN ZnodeCMSSEODetail AS ZCSD ON(PPD.SKU = ZCSD.SEOCode and ZCSD.PortalId = ZPC.PortalId)  
			LEFT JOIN ZnodeCMSSEOType AS ZCST ON(ZCST.CMSSEOTypeId = ZCSD.CMSSEOTypeId AND ZCST.Name = 'Product')  
			LEFT JOIN ZnodeCMSSEODetailLocale AS ZCSDL ON(ZCSDL.CMSSEODetailId = ZCSD.CMSSEODetailId AND ZCSDL.LocaleId IN(@LocaleId, @DefaultLocaleId))  
			LEFT JOIN #TBL_DomainName AS TBDN ON(TBDN.RowId = 1 AND TBDN.PortalId = zpc.PortalId)   
			WHERE EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZPC.PortalId)  
				
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[SEOTitle],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag  
			INTO #Cte_SeoDetailsWithFirstLocale
			FROM #Cte_SeoDetailsWithLocale   
			WHERE LocaleId = @LocaleId  
    
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[SEOTitle],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode , CanonicalURL, RobotTag 
			INTO #Cte_SeoDetailsWithDefaultLocale
			FROM #Cte_SeoDetailsWithFirstLocale  
			
			INSERT INTO #Cte_SeoDetailsWithDefaultLocale 
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[SEOTitle],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag  
			FROM #Cte_SeoDetailsWithLocale AS CTSDWL  
			WHERE LocaleId = @DefaultLocaleId   
			AND NOT EXISTS(SELECT TOP 1 1 FROM #Cte_SeoDetailsWithFirstLocale AS CTSDWDL WHERE CTSDWDL.CMSSEODetailId = CTSDWL.CMSSEODetailId)  
         
			INSERT INTO #TBL_SEODetails  
			SELECT DISTINCT loc,lastmod,[g:condition],[description],[SEOTitle],[g:id],link,[g:identifier_exists],DomainName,PortalId ,SEOCode, CanonicalURL, RobotTag  
			FROM #Cte_SeoDetailsWithDefaultLocale;  
			
			SELECT TBSD.loc,TBSD.lastmod,TBSD.[g:condition],TBSD.[description],TBSD.[SEOTitle],TBSD.[g:id],TBSD.link,TBSD.[g:identifier_exists],TBSD.DomainName,TBSD.PortalId,  
			CASE WHEN SUM(ZI.Quantity) > 0 THEN 'In Stock' ELSE CASE WHEN @FeedType = 'Xml' THEN 'Out Of Stock' ELSE 'Not In Stock' END  
			END AS [g:availability],
			ZPPD.SKU ,TBSD.SEOCode, TBSD.CanonicalURL, TBSD.RobotTag, ZPP.PublishProductId,ZPPD.ProductName
			INTO #TBL_CompleteDetailes  
			FROM ZnodePublishProduct AS ZPP   
			LEFT JOIN #TBL_SEODetails AS TBSD ON(ZPP.PublishProductId = TBSD.[g:id] )  
			LEFT JOIN ZnodePublishProductDetail AS ZPPD ON(ZPPD.PublishProductId = ZPP.PublishProductId AND ZPPD.LocaleId = @LocaleId)  
			LEFT JOIN ZnodePortalWarehouse AS ZPW ON(ZPW.PortalId = TBSD.PortalId)  
			LEFT JOIN ZnodePortalAlternateWarehouse AS ZAPW ON(ZAPW.PortalWarehouseId = ZPW.PortalWarehouseId)  
			LEFT JOIN ZnodeInventory AS ZI ON(ZI.SKU = ZPPD.SKU AND (ZI.WarehouseId = ZPW.WarehouseId OR ZI.WarehouseId = ZAPW.WarehouseId))  			
			GROUP BY loc,lastmod,[g:condition],[description],[SEOTitle],[g:id],link,[g:identifier_exists],DomainName,TBSD.PortalId,ZPPD.SKU,ZPPD.LocaleId, TBSD.SEOCode, TBSD.CanonicalURL, TBSD.RobotTag, ZPP.PublishProductId,ZPPD.ProductName;    
			
			DECLARE @MediaConfiguration NVARCHAR(2000)=((SELECT TOP 1 ISNULL(CASE WHEN CDNURL = '' THEN NULL ELSE CDNURL END,URL) FROM ZnodeMediaConfiguration WHERE IsActive = 1));    
  
			CREATE INDEX Idx_#TBL_CompleteDetailes ON #TBL_CompleteDetailes(PortalId,SKU)
	
	
			SELECT zp.PortalId,round(isnull(SalesPrice,RetailPrice),2) as Price,Zps.SKU,tbcd.SEOCode,ROW_NUMBER() OVER(PARTITION BY Zps.SKU,zp.PortalId ORDER BY ZPS.RetailPrice) AS RowId  
			INTO #Cte_PortalList
			FROM ZnodePriceList AS ZPL   
			LEFT JOIN ZnodePriceListPortal AS ZPLP ON ZPL.PriceListId = ZPLP.PriceListId  
			LEFT JOIN ZnodeCulture AS zc ON ZPL.CultureId = zc.CultureId
			LEFT JOIN ZnodePortal AS zp ON ZPLP.PortalId = zp.PortalId  
			LEFT JOIN ZnodePrice AS Zps ON(Zps.PriceListId = ZPL.PriceListId)   
			LEFT JOIN #TBL_CompleteDetailes AS TBCD ON(TBCD.PortalId = Zp.PortalId AND TBCD.SKU = Zps.Sku)   
			WHERE CAST(@GetDate AS DATE) BETWEEN ZPL.ActivationDate AND ZPL.ExpirationDate   
			AND EXISTS( SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZPLP.PortalId)   
			GROUP BY zp.PortalId,ZPS.RetailPrice,Zps.SalesPrice,Zps.SKU ,TBCD.SEOCode  
			
			SELECT D.PublishProductId,C.AttributeDefaultValueCode AS Brand
			INTO #BrandDetails
			FROM ZnodePimAttributeValue A
			INNER JOIN ZnodePimProductAttributeDefaultValue B ON B.PimAttributeValueId=A.PimAttributeValueId
			INNER JOIN ZnodePimAttributeDefaultValue C ON C.PimAttributeDefaultValueId=A.PimAttributeDefaultValueId	
			INNER JOIN Znodepublishproduct D ON  A.PimProductId = D.PimProductId 
			WHERE EXISTS(SELECT * FROM ZnodePimAttribute D WHERE D.PimAttributeId=A.PimAttributeId AND D.AttributeCode='Brand' )
			AND EXISTS(SELECT * FROM #TBL_CompleteDetailes E Where E.PublishProductId = D.PublishProductId)		
			
			SELECT A.CategoryName , A.ZnodeProductId AS PublishProductId, ROW_NUMBER() OVER(PARTITION BY A.ZnodeProductId ORDER BY A.ZnodeProductId) AS RowId
			INTO #ProductCategories
			FROM ZnodePublishProductEntity A 
			WHERE EXISTS(SELECT * FROM #TBL_CompleteDetailes B WHERE A.ZnodeProductId = B.PublishProductId)
			AND ISNULL(A.CategoryName,'') <> ''

			DELETE FROM #ProductCategories WHERE RowId <> 1
 
			SELECT SKU,SUM(cast(Quantity as numeric(28,0)))AS Inventory 
			into #InventotyDetails 
			FROM ZnodeInventory A 
			WHERE EXISTS(SELECT * FROM #TBL_CompleteDetailes B where A.SKU=B.SKU)
			GROUP BY SKU  

			SELECT F.PublishProductId,[Path] AS ImagePath
			INTO #ProductImage
			FROM ZnodePimAttributeValue a
			INNER JOIN ZnodePimProductAttributeMedia b on a.PimAttributeValueId = b.PimAttributeValueId
			INNER JOIN ZnodeMedia d on b.MediaId = d.MediaId
			INNER JOIN Znodepublishproduct F ON  A.PimProductId = F.PimProductId 
			WHERE EXISTS(SELECT * FROM ZnodePimAttribute C WHERE C.PimAttributeId=A.PimAttributeId AND C.AttributeCode='PRODUCTIMAGE' )
			AND EXISTS(SELECT * FROM #TBL_CompleteDetailes E Where E.PublishProductId = F.PublishProductId)		

						 
			SELECT 
			DomainName AS DomainName,
			isnull(ProductName,SEOTitle) as [Title],
			--lastmod,
			--[g:condition],
			[description] AS [Description],
			CAST([g:id] AS nvarchar(50) ) AS ProductID,
			[g:availability] AS [Availability],
			--[g:identifier_exists],	
			--TBCD.PortalId,
			Cast(CAST(CTPL.Price AS numeric(28,3))as nvarchar(100)) AS Price,
			@MediaConfiguration AS MediaConfiguration,
			--TBCD.SEOCode,
			--TBCD.CanonicalURL,
			--TBCD.RobotTag,
			PC.CategoryName AS Category,
			CAST(ID.Inventory AS nvarchar(50) ) AS Inventory,
			BD.Brand AS Brand,
			ID.SKU AS ID,
			link AS Link,
			PM.IMAGEPATH AS Image_Link
			FROM #TBL_CompleteDetailes AS TBCD   
			LEFT JOIN #Cte_PortalList AS CTPL ON(CTPL.PortalId = TBCD.PortalId AND CTPL.SKU = TBCD.SKU AND CTPL.RowID = 1)  
			LEFT JOIN #ProductCategories PC ON TBCD.PublishProductId = PC.PublishProductId
			LEFT JOIN #InventotyDetails ID ON TBCD.SKU = ID.SKU 
			LEFT JOIN #BrandDetails BD on TBCD.PublishProductId=BD.PublishProductId
			LEFT JOIN #ProductImage PM on TBCD.PublishProductId=PM.PublishProductId
			WHERE  EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = TBCD.PortalId)

		IF OBJECT_ID('tempdb..#TBL_DomainName') IS NOT NULL
		DROP TABLE #TBL_DomainName

		IF OBJECT_ID('tempdb..#TBL_SEODetails') IS NOT NULL
		DROP TABLE #TBL_SEODetails

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_PortalIds') IS NOT NULL
		DROP TABLE #TBL_PortalIds
		
END TRY  
BEGIN CATCH  
	DECLARE @Status BIT ;  
	SET @Status = 0;  
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetXmlProductFeedList @PortalId = '+@PortalId+',@LocaleId='+CAST(@LocaleId AS VARCHAR(50))+',@FeedType='+CAST(@FeedType AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));  
                 
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
     
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_GetXmlProductFeedList',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
   
END;

GO

INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'GeneralSetting','GetStockNoticeSettings',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'GeneralSetting' and ActionName = 'GetStockNoticeSettings')

INSERT INTO ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
SELECT
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Global Settings' AND ControllerName = 'GeneralSetting')
   ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'GeneralSetting' and ActionName = 'GetStockNoticeSettings') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId =
    (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Global Settings' AND ControllerName = 'GeneralSetting') and ActionId =
    (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'GeneralSetting' and ActionName = 'GetStockNoticeSettings'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
SELECT
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Global Settings' AND ControllerName = 'GeneralSetting'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'GeneralSetting' and ActionName = 'GetStockNoticeSettings')
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId =
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Global Settings' AND ControllerName = 'GeneralSetting') and ActionId =
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'GeneralSetting' and ActionName = 'GetStockNoticeSettings'))

GO

insert into ZnodeApplicationSetting (GroupName,	ItemName,	Setting,	ViewOptions,	FrontPageName,	FrontObjectName,	IsCompressed,	OrderByFields,	ItemNameWithoutCurrency,	CreatedByName,	ModifiedByName,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
select 'Table','ZnodeSavedCart','<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>OmsTemplateId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>TemplateName</name><headertext>Template Name</headertext><width>0</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl>/User/EditTemplate</islinkactionurl><islinkparamfield>omsTemplateId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield>omsTemplateId</controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>Items</name><headertext>Items</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>CreatedDate</name><headertext>Created Date</headertext><width>30</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>ModifiedDate</name><headertext>Modified Date</headertext><width>30</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>Orders|Delete</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>MoveToCart|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/SavedCart/AddProductToCart|/User/DeleteTemplate</manageactionurl><manageparamfield>omsTemplateId|omsTemplateId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>',
'ZnodeSavedCart','ZnodeSavedCart','ZnodeSavedCart',0,null,null,null,null,2,GETDATE(),2,getdate()
where not exists(select * from ZnodeApplicationSetting where GroupName = 'Table' and ItemName = 'ZnodeSavedCart')

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity
GO

CREATE PROCEDURE [dbo].[Znode_PublishCatalogEntity]  
(  
	@PimCatalogId  INT = 0   
	,@RevisionState VARCHAR(50) = ''   
	,@UserId INT = 0  
	,@NewGUID NVARCHAR(500)   
	,@IsDraftProductsOnly BIT = 1  
)  
AS  
/*  
To publish all catalog product and their details  
Unit Testing :   
Exec [dbo].[Znode_PublishCatalogEntity]  
@PimCatalogId  = 3  
,@RevisionState = 'PRODUCTION'   
,@UserId = 2  
,@NewGUID = '123'  
   
EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,  
@NewGUID ='123'   
  
*/  
BEGIN  
BEGIN TRY   
	SET NOCOUNT ON  

	DECLARE @Status Bit =0 , @PublishCatalogId INT=0  
	IF (@PimCatalogId=0)  
	BEGIN  
	--SET @Status =0  
		SELECT 0 AS ID,@Status AS Status;  
		SET @PublishCatalogId=0  
		SELECT @PublishCatalogId;  
	END  
	ELSE  
	BEGIN  
   
		DECLARE @Type VARCHAR(50) = '', @CMSSEOCode VARCHAR(300);  
		SET @Status = 1   
		DECLARE @IsPreviewEnable INT  
		,@PreviewVersionId INT = 0    
		,@ProductionVersionId INT = 0  
		,@CatalogProfileId VARCHAR(1000)  
   
		IF OBJECT_ID('tempdb..#CatalogAttributeDetails') IS NOT NULL  
		DROP TABLE #CatalogAttributeDetails  
		CREATE TABLE [dbo].[#CatalogAttributeDetails]  
		(  
			[ZnodeCatalogId] [INT] NULL,  
			[AttributeCode] [NVARCHAR](300) NULL,  
			[AttributeTypeName] [VARCHAR](300) NULL,  
			[IsComparable] [bit] NOT NULL,  
			[IsHtmlTags] [bit] NOT NULL,  
			[IsFacets] [bit] NOT NULL,  
			[IsUseInSearch] [bit] NOT NULL,  
			[IsPersonalizable] [bit] NOT NULL,  
			[IsConfigurable] [bit] NOT NULL,  
			[AttributeName] [NVARCHAR](300) NULL,  
			[LocaleId] [INT] NULL,  
			[DisplayOrder] [INT] NULL,  
			[DefaultValueDisplayOrder] [INT] NULL,  
			[AttributeDefaultValue] [NVARCHAR](max) NULL  
		) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY] 
		
		DECLARE @CatalogName VARCHAR(100),@UserName VARCHAR(50)  
		SET @PublishCatalogId = ISNULL((SELECT TOP 1 PublishCatalogId FROM ZnodePublishCatalog ZPC WHERE ZPC.PimCatalogId = @PimCatalogId), 0)  
    
	SELECT TOP 1  @UserName = UserName 
	FROM ZnodeUser 
	WHERE ZnodeUser.UserId = @userId  
  
	SELECT @CatalogName = CatalogName FROM ZnodePimCatalog WHERE PimCatalogId = @PimCatalogId
	
	DELETE FROM ZnodePublishProgressNotifierEntity WHERE JOBName =@CatalogName   

	INSERT INTO ZnodePublishProgressNotifierEntity  
	(VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriENDlyName)  
	VALUES(0,@NewGUID , Isnull(@CatalogName,'') + ' Catalog ', 0 , 0 , 0 , '' , @UserId, @UserName )  
  
	IF EXISTS (SELECT  * FROM ZnodePublishStateApplicationTypeMapping PSA WHERE PSA.IsEnabled =1 AND    
	EXISTS (SELECT TOP 1 1  FROM ZnodePublishState PS WHERE PS.PublishStateId = PSA.PublishStateId ) AND ApplicationType =  'WebstorePreview')  
		SET @IsPreviewEnable = 1   
	ELSE   
		SET @IsPreviewEnable = 0   
  
	--Genrate preview entry   
	DECLARE @SetLocaleId INT , @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleId(), @MaxCount INT =0 , @IncrementalId INT = 1    
	DECLARE @TBL_Locale TABLE (LocaleId INT , RowId INT IDENTITY(1,1))  
    
	IF OBJECT_ID('tempdb..[#Tbl_NewVersionEntity]') IS NOT NULL  
		DROP TABLE tempdb..#Tbl_NewVersionEntity  
	
	CREATE TABLE #Tbl_NewVersionEntity(PublishCatalogId INT , VersionId INT , LocaleId INT , PublishType VARCHAR(50) )  
  
	--IF OBJECT_ID('tempdb..[#Tbl_OldVersionEntity]') IS NOT NULL  
	--	DROP TABLE tempdb..#Tbl_OldVersionEntity  
	
	--CREATE TABLE #Tbl_OldVersionEntity(PublishCatalogId INT , NewVersionId INT ,OldVersionId INT , LocaleId INT , PublishType VARCHAR(50) )  
    
    
	IF @PublishCatalogId > 0   
    BEGIN
		UPDATE ZPC SET CatalogName = ZC.CatalogName,ExternalId = ZC.ExternalId,PimCatalogId= @PimCatalogId,CreatedBy = @UserId,  
		CreatedDate = Getdate(),ModifiedBy = @UserId,ModifiedDate = Getdate()  
		FROM ZnodePublishCatalog ZPC   
		INNER JOIN ZnodePimCatalog ZC ON(ZC.PimCatalogId = ZPC.PimCatalogId)  
		WHERE ZPC.PimCatalogId = @PimCatalogId;  
	END
	ELSE  
	BEGIN  
		INSERT INTO ZnodePublishCatalog (PimCatalogId,CatalogName,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)  
		SELECT PimCatalogId,CatalogName,ExternalId,@UserId,Getdate(),@UserId,Getdate() FROM ZnodePimCatalog AS ZPC   
		WHERE ZPC.PimCatalogId = @PimCatalogId;  
                        
		SET @PublishCatalogId = SCOPE_IDENTITY();  
	END  
  
	--Getting active local for catalog which are associated to store
	INSERT INTO @TBL_Locale (LocaleId) 
	SELECT LocaleId FROM DBO.FN_GetCatalogPortalActiveLocale(@PublishCatalogId)
  
	SET @MaxCount = ISNULL((SELECT MAx(RowId) FROM @TBL_Locale),0)  

	WHILE @IncrementalId <= @MaxCount  
	BEGIN   
		SET @SetLocaleId = (SELECT Top 1 LocaleId FROM @TBL_locale WHERE RowId = @IncrementalId)  

		IF @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  )    
		BEGIN  
			
			INSERT INTO ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId)  
			SELECT @PublishCatalogId,  @PimCatalogId,NULL,0,  
			NULL,0,  
			NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(), null ,@SetLocaleId ,DBO.Fn_GetPublishStateIdForProcessing()   
  
			INSERT INTO #Tbl_NewVersionEntity (PublishCatalogId,VersionId,LocaleId,PublishType)  
			SELECT @PublishCatalogId, @@Identity , @SetLocaleId ,'PREVIEW'  
      
		END  

		IF (@RevisionState like '%Production%' OR @RevisionState = 'None')  
		BEGIN  
			UPDATE B
            SET IsPublishSuccess = 0
            FROM ZnodePublishVersionEntity B
            WHERE EXISTS(SELECT * FROM #Tbl_NewVersionEntity A WHERE A.PublishCatalogId = B.ZnodeCatalogId 
                AND A.PublishType = 'PRODUCTION' AND A.LocaleId = B.LocaleId) 
            AND B.RevisionType = 'PRODUCTION'

			--Genrate production entry   
			INSERT INTO ZnodePublishCatalogLog  
			(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId)  
			SELECT @PublishCatalogId,  @PimCatalogId,NULL,0,  
			NULL,0,  
			NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(), null ,@SetLocaleId ,DBO.Fn_GetPublishStateIdForProcessing()   
     
			INSERT INTO #Tbl_NewVersionEntity (PublishCatalogId,VersionId,LocaleId,PublishType)  
			SELECT @PublishCatalogId, @@Identity , @SetLocaleId ,'PRODUCTION'  
		END   
			SET @IncrementalId = @IncrementalId +1   
	END  
	
	DECLARE  @VersionIdString VARCHAR(2000)= ''    
     
	TRUNCATE TABLE ZnodePublishCatalogErrorLogEntity  

	UPDATE ZnodePublishProgressNotifierEntity SET   
	ProgressMark =5,   
	IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
	IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
	WHERE  JobId = @NewGUID  
   
	--EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = @PublishCatalogId,@UserId = @UserId , @IsRevertPublish = 0 ,  
	--@NewGUID =@NewGUID   
  
	IF @Type = 'ZnodePublishCatalogEntity' OR @Type = ''  
	BEGIN  
   
		INSERT INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing)  
		SELECT Distinct VE.VersionId, ZPC.PublishCatalogId, PC.CatalogName,VE.PublishType, VE.LocaleId, isnull(PC.IsAllowIndexing,0)  
		FROM ZnodePublishCatalog ZPC  
		INNER JOIN  #Tbl_NewVersionEntity VE ON (VE.PublishCatalogId = ZPC.PublishCatalogId)  
		INNER JOIN ZnodePimCatalog PC on ZPC.PimCatalogId = PC.PimCatalogId  
		-- Data inserted INTo flat table ZnodeWebStoreEntity (Replica of MongoDB Collection )    
    
		IF @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  )   
		BEGIN  
			UPDATE B
            SET IsPublishSuccess = 0
            FROM ZnodePublishVersionEntity B
            WHERE EXISTS(SELECT * FROM #Tbl_NewVersionEntity A WHERE A.PublishCatalogId = B.ZnodeCatalogId 
                AND A.PublishType = 'PREVIEW' AND A.LocaleId = B.LocaleId) 
            AND B.RevisionType = 'PREVIEW'

			INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
			SELECT VersionId,PublishCatalogId,PublishType,LocaleId,0 FROM  #Tbl_NewVersionEntity A
			WHERE A.PublishType = 'PREVIEW'  
			AND NOT EXISTS(SELECT * FROM ZnodePublishVersionEntity B WHERE A.PublishCatalogId = B.ZnodeCatalogId 
			AND B.RevisionType = 'PREVIEW' AND A.LocaleId = B.LocaleId )
		END  

		IF (@RevisionState like '%Production%' OR @RevisionState = 'None')  
		BEGIN  
			UPDATE B
            SET IsPublishSuccess = 0
            FROM ZnodePublishVersionEntity B
            WHERE EXISTS(SELECT * FROM #Tbl_NewVersionEntity A WHERE A.PublishCatalogId = B.ZnodeCatalogId 
                AND A.PublishType = 'PRODUCTION' AND A.LocaleId = B.LocaleId) 
            AND B.RevisionType = 'PRODUCTION'

			INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
			SELECT VersionId,PublishCatalogId,PublishType,LocaleId,0 FROM  #Tbl_NewVersionEntity A
			WHERE PublishType = 'PRODUCTION'  
			AND NOT EXISTS(SELECT * FROM ZnodePublishVersionEntity B WHERE A.PublishCatalogId = B.ZnodeCatalogId 
			AND B.RevisionType = 'PRODUCTION' AND A.LocaleId = B.LocaleId )
		END  
  
		INSERT INTO ZnodePublishCatalogErrorLogEntity  
		(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishCatalogEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
	END  
  
    IF @RevisionState = 'Preview'
	BEGIN
		SELECT @VersionIdString = STUFF((SELECT ',' + cast (VersionId as VARCHAR(50))  
		FROM ZnodePublishVersionEntity WHERE RevisionType = 'Preview' AND ZnodeCatalogId = @PublishCatalogId FOR XML PATH ('')), 1, 1, '')   
	END
	ELSE
	BEGIN
		SELECT @VersionIdString = STUFF((SELECT ',' + cast (VersionId as VARCHAR(50))  
		FROM ZnodePublishVersionEntity WHERE ZnodeCatalogId = @PublishCatalogId FOR XML PATH ('')), 1, 1, '') 
	END


	IF @Type = 'ZnodePublishCategoryEntity' OR @Type = ''  
	BEGIN  
		EXEC [Znode_GetPublishCategoryJson]  
		@PublishCatalogId = @PublishCatalogId ,  
		@UserId =@UserId,                 
		@VersionIdString = @VersionIdString,  
		@Status  =@Status Out,  
		@RevisionState = @RevisionState   
   
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishCategoryEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
     
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =30,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
  
		IF @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END   
   
	IF @Type = 'ZnodePublishProductEntity' OR @Type = ''  
	BEGIN  
		-- Process call catalog publish (include category, products with multiple types)  
		DECLARE @PimProductId TransferId   
		EXEC [Znode_PublishLatestAssociatedProduct] @PublishCatalogId = @PublishCatalogId, @PimProductId = @PimProductId  , @UserId = @UserId , @PublishStateId =0   
		EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId= @PublishCatalogId ,@userid =@userid ,@PimProductId = @PimProductId   
		EXEC Znode_GetPublishProductJson   
		@PublishCatalogId =@PublishCatalogId   
		,@PimProductId = @PimProductId   
		,@UserId = @userid  
		,@PimCatalogId = @PimCatalogId   
		,@VersionIdString = @VersionIdString  
		,@Status  =@Status  Out  
		,@RevisionState = @RevisionState   
		,@IsDraftProductsOnly = @IsDraftProductsOnly  
   
		EXECUTE [Znode_PublishCategoryHierarchyParentIds] @PimCatalogId = @PimCatalogId
    
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishProductEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =50,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
		If @Status  = 1  
		BEGIN  
			UPDATE ZPCE SET ZPCE.ProductIds =   
			'[' +SUBSTRING((SELECT ','+CAST(PublishProductId AS VARCHAR(50))  
			FROM ZnodePublishCategoryProduct ZPCP   
			WHERE ZPCP.PublishCategoryId = ZPCE.ZnodeCategoryId  
			AND ZPCP.PublishCatalogId = ZPCE.ZnodeCatalogId  FOR XML PATH('')), 2, 8000) + ']'   
			FROM ZnodePublishCategoryEntity  ZPCE WHERE ZPCE.ProductIds is null   
		END  
  
  
		If @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END  

	IF @Type = 'ZnodePublishAddOnEntity' OR @Type = ''  
	BEGIN  
		Exec [Znode_GetPublishAssociatedAddonsJson]  
		@PublishCatalogId = @PublishCatalogId ,  
		@PimProductId   = @PimProductId ,  
		@UserId =@UserId,                 
		@VersionIdString = @VersionIdString,  
		@RevisionType='',  
		@Status  =@Status Out  
  
    
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishAddOnEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =52,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
     
		If @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END   
   
	If @Type = 'BundleAssociatedProducts' OR @Type = ''  
	BEGIN  
		Exec [Znode_GetPublishAssociatedProductsJson]  
		@PublishCatalogId = @PublishCatalogId ,  
		@UserId =@UserId,                 
		@VersionIdString = @VersionIdString,  
		@RevisionType = '',  
		@Status  =@Status Out,  
		@ProductType    = 'BundleProduct'  
    
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'BundleAssociatedProducts', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =54,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
     
		If @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END   

	IF @Type = 'GroupedAssociatedProducts' OR @Type = ''  
	BEGIN  
		Exec [Znode_GetPublishAssociatedProductsJson]  
		@PublishCatalogId = @PublishCatalogId ,  
		@UserId =@UserId,                 
		@VersionIdString = @VersionIdString,  
		@RevisionType = '',  
		@Status  =@Status Out,  
		@ProductType    = 'GroupedProduct'  

		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'GroupedAssociatedProducts', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
     
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =56,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  

		IF @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END   

	IF @Type = 'ConfigurableAssociatedProducts' OR @Type = ''  
	BEGIN  
		Exec [Znode_GetPublishAssociatedProductsJson]  
		@PublishCatalogId = @PublishCatalogId ,  
		@UserId =@UserId,                 
		@VersionIdString = @VersionIdString,  
		@RevisionType = '',  
		@Status  =@Status Out,  
		@ProductType= 'ConfigurableProduct'  
  
      
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ConfigurableAssociatedProducts', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =58,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
     
		IF @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END   

	IF @Type = 'CatalogAttributeaDetail' OR @Type = ''  
	BEGIN  
	BEGIN TRY  
		--INSERT INTO #Tbl_VersionEntity (LocaleId,VersionId,RevisionType)  
		SELECT PV.LocaleId , PV.VersionId , PV.RevisionType  
		into #Tbl_VersionEntity
		FROM ZnodePublishVersionEntity PV INNER JOIN Split(@VersionIdString,',') S ON PV.VersionId = S.Item

		INSERT INTO [dbo].[#CatalogAttributeDetails]([ZnodeCatalogId],[AttributeCode],[AttributeTypeName],[IsComparable],  
		[IsHtmlTags],[IsFacets],[IsUseInSearch],[IsPersonalizable],[IsConfigurable],[AttributeName],  
		[LocaleId],[DisplayOrder],[DefaultValueDisplayOrder],[AttributeDefaultValue] )  
		EXEC Znode_GetPublishProductAttribute @PublishCatalogId   

		SELECT Distinct   
		B.VersionId, A.[ZnodeCatalogId],A.[AttributeCode],A.[AttributeTypeName],0 IsPromoRuleCondition,[IsComparable],  
		[IsHtmlTags],[IsFacets],[IsUseInSearch],[IsPersonalizable],[IsConfigurable],  
		[AttributeName],A.[LocaleId],[DisplayOrder] ,  
		(SELECT Isnull(IA.AttributeDefaultValue,'') Value , Isnull(IA.[DefaultValueDisplayOrder],'') DisplayOrder    
		from [dbo].[#CatalogAttributeDetails] IA  WHERE IA.AttributeCode = A.AttributeCode AND IA.LocaleId = A.LocaleId   
		For JSON PATH) SELECTValues  
		INTO #Temp_PublishCatalogAttribute
		FROM [dbo].[#CatalogAttributeDetails] A INNER JOIN #Tbl_VersionEntity B on A.LocaleId = B.LocaleId

		DELETE X  
		FROM [dbo].ZnodePublishCatalogAttributeEntity X
		WHERE NOT EXISTS(SELECT * FROM #Temp_PublishCatalogAttribute A
			WHERE A.VersionId=X.VersionId AND A.[ZnodeCatalogId]=X.ZnodeCatalogId 
			AND A.[AttributeCode]=X.AttributeCode AND A.LocaleId = X.LocaleId)


		UPDATE X SET    
		X.AttributeTypeName = A.[AttributeTypeName] ,X.IsComparable = A.[IsComparable],  
		X.IsHtmlTags = A.[IsHtmlTags],X.IsFacets = A.[IsFacets], X.IsUseInSearch = A.[IsUseInSearch],
		X.IsPersonalizable = A.[IsPersonalizable],X.IsConfigurable = A.[IsConfigurable],  
		X.AttributeName = A.[AttributeName],X.DisplayOrder = A.[DisplayOrder] , X.SELECTValues = A.SELECTValues
		FROM [dbo].#Temp_PublishCatalogAttribute A   
		INNER JOIN ZnodePublishCatalogAttributeEntity X ON A.VersionId=X.VersionId AND A.[ZnodeCatalogId]=X.ZnodeCatalogId 
		AND A.[AttributeCode]=X.AttributeCode AND A.LocaleId = X.LocaleId

     
		INSERT INTO ZnodePublishCatalogAttributeEntity  
		(VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition,IsComparable,  
		IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,  
		AttributeName,LocaleId,DisplayOrder,SELECTValues)  
		SELECT Distinct   
		a.VersionId, A.[ZnodeCatalogId],A.[AttributeCode],A.[AttributeTypeName],0 IsPromoRuleCondition,[IsComparable],  
		[IsHtmlTags],[IsFacets],[IsUseInSearch],[IsPersonalizable],[IsConfigurable],  
		[AttributeName],A.[LocaleId],[DisplayOrder] ,  a.SELECTValues
		FROM [dbo].#Temp_PublishCatalogAttribute A   
		WHERE NOT EXISTS(SELECT * FROM ZnodePublishCatalogAttributeEntity X WHERE a.VersionId=X.VersionId AND A.[ZnodeCatalogId]=X.ZnodeCatalogId 
		AND A.[AttributeCode]=X.AttributeCode AND A.LocaleId = X.LocaleId)
   
		SET @Status =1   
    
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'CatalogAttributeaDetail', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =60,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
     
  
	END TRY   
	BEGIN CATCH   
		SET @Status   = 0   
     
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'CatalogAttributeaDetail', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		IF @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END CATCH    
	END   
  
	IF @Type = 'ZnodePublishSEOEntity' OR @Type = ''  
	BEGIN  
		EXEC [Znode_SetPublishSEOEntity]  
		@RevisionState = @RevisionState   
		,@CMSSEOTypeId  = '1,2'   
		,@UserId  = @UserId   
		,@Status  = @Status  OUTPUT   
		,@IsCatalogPublish = 1    
		,@VersionIdString  = @VersionIdString   
		,@IsPreviewEnable  = @IsPreviewEnable   
     
   
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishSEOEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =70,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
  
		If @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
  
	END   
  
	IF EXISTS (SELECT TOP 1 1  FROM ZnodePublishCatalogErrorLogEntity WHERE  ProcessStatus = 'Fail')   
	BEGIN  
    
		SET @Status  =0   
		SELECT 1 AS ID,@Status AS Status;  
		INSERT INTO ZnodePublishCatalogErrorLogEntity  
		(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishPortalEntity', @RevisionState , 'Fail' , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
     
		--EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = @PublishCatalogId,@UserId = @UserId , @IsRevertPublish = 0 ,  
		--@NewGUID =@NewGUID   
  
		UPDATE ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed(),  
		IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0, ModifiedDate = Getdate()  
		WHERE PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()
		
		UPDATE ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed(),  
		IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0  
		, ModifiedDate = Getdate()  
		WHERE PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()
		Return 0   
	END  
  
	SET @Status = 1  
  
    
	SELECT @PublishCatalogId AS id,@Status AS Status;     
END  
END TRY   
BEGIN CATCH   
	SET @Status =0    
	SELECT 1 AS ID,@Status AS Status;     
   
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	@ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity   
	@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))  
	+',@PreviewVersionId = ' + CAST(@PreviewVersionId  AS VARCHAR(20))  
	+',@ProductionVersionId = ' + CAST(@ProductionVersionId  AS VARCHAR(20))  
	+',@RevisionState = ''' + CAST(@RevisionState  AS VARCHAR(50))  
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20)); SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
   
     
	INSERT INTO ZnodePublishCatalogErrorLogEntity  
	(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
	SELECT 'Znode_PublishCatalogEntity', @RevisionState + isnull(@ErrorMessage,'') , 'Fail' , Getdate(),   
	@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
   
	EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = @PublishCatalogId,@UserId = @UserId , @IsRevertPublish = 0 ,  
	@NewGUID =@NewGUID   
  
	UPDATE ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed(),  
	IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0 , ModifiedDate = Getdate()   WHERE  PublishCatalogLogId in   
	(SELECT VersionId FROM #Tbl_NewVersionEntity WHERE PublishType = 'PREVIEW' )  
	UPDATE ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed() ,  
	IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0 , ModifiedDate = Getdate() WHERE  PublishCatalogLogId in  
	(SELECT VersionId FROM #Tbl_NewVersionEntity WHERE PublishType = 'PRODUCTION' )  
                        
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_PublishCatalogEntity',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportBrands')
	DROP PROC Znode_ImportBrands
GO

CREATE PROCEDURE [dbo].[Znode_ImportBrands](
	  @TableName			NVARCHAR(100), 
	  @Status				BIT OUT, 
	  @UserId				INT, 
	  @ImportProcessLogId	INT, 
	  @NewGUId				NVARCHAR(200),
	  @LocaleId	            INT= 1
	  )
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Made a provision to import Brand details.
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN Brands;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate();
		IF isnull(@LocaleId,0)=0
		BEGIN
			SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		END
		-- Retrive RoundOff Value from global setting 

		DECLARE @InsertBrandData TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY,RowNumber int, BrandCode varchar(max),IsActive varchar(max), BrandDescription varchar(max) default null,
			SEOKeyword varchar(max) default null,SEODescription varchar(max) default null, BrandLogo varchar(max) default null,SEOTitle varchar(max) default null,
			SEOFriendlyPageName varchar(max) default null,URLKey varchar(max) default null, Custom1 varchar(max) default null,Custom2 varchar(max) default null,
			Custom3 varchar(max) default null,Custom4 varchar(max) default null,Custom5 varchar(max) default null, GUID nvarchar(400)
		);	
			
		SET @SSQL = 'Select RowNumber,BrandCode, IsActive,ISNULL(NULLIF(BrandDescription, ''''), null) BrandDescription,ISNULL(NULLIF(SEOKeyword, ''''), null) SEOKeyword,ISNULL(NULLIF(SEODescription, ''''), null) SEODescription,ISNULL(NULLIF(BrandLogo, ''''), null) BrandLogo,
						ISNULL(NULLIF(SEOTitle, ''''), null) SEOTitle,ISNULL(NULLIF(SEOFriendlyPageName, ''''), null) SEOFriendlyPageName ,ISNULL(NULLIF(URLKey, ''''), null) URLKey,ISNULL(NULLIF(Custom1, ''''), null) Custom1,ISNULL(NULLIF(Custom2, ''''), null) Custom2,
						ISNULL(NULLIF(Custom3, ''''), null) Custom3,ISNULL(NULLIF(Custom4, ''''), null) Custom4,ISNULL(NULLIF(Custom5, ''''), null) Custom5,GUID FROM '+@TableName;
		INSERT INTO @InsertBrandData( RowNumber,BrandCode, IsActive,BrandDescription,SEOKeyword,SEODescription,BrandLogo,
										SEOTitle,SEOFriendlyPageName,URLKey,Custom1,Custom2,Custom3,Custom4,Custom5,GUID)				
		EXEC sys.sp_sqlexec @SSQL;
		
		-- Start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '8', 'BrandCode', BrandCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertBrandData AS ii
			   WHERE isnull(BrandCode,'')=''			   
			  

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '121', 'BrandCode', BrandCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertBrandData AS ii
			   WHERE  not exists 
				   (
						select * from ZnodePimAttributeDefaultValue zpadv
						inner join ZnodePimAttribute zpa on zpa.PimAttributeId=zpadv.PimAttributeId
						where AttributeCode='Brand' and AttributeDefaultValueCode=ii.BrandCode
				   );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '8', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertBrandData AS ii  
			WHERE isnull(ii.IsActive,'')=''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertBrandData AS ii  
			WHERE isnull(ii.IsActive,'') not in ('True','1','Yes','FALSE','0','No')
			
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '82', 'SEOKeyword', SEOKeyword, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertBrandData AS ii
			  WHERE len(ltrim(rtrim(ii.SEOKeyword))) > 300 and isnull(ii.SEOKeyword,'')<>''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '82', 'SEODescription', SEODescription, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertBrandData AS ii
			   WHERE len(ltrim(rtrim(ii.SEODescription))) > 300 and isnull(ii.SEODescription,'')<>''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '45', 'BrandLogo', BrandLogo, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertBrandData AS ii			 
			   WHERE reverse(left(reverse(ii.BrandLogo),charindex('.',reverse(ii.BrandLogo)))) 
			   not in (select ValidationName from View_FamilyExtensions where FamilyCode='Image')
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '45', 'BrandLogo', BrandLogo, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertBrandData AS ii			 
			   WHERE isnull(BrandLogo,'')<>'' and not exists (select * from ZnodeMedia where FileName=ii.BrandLogo)

  
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '81', 'SEOTitle', SEOTitle, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertBrandData AS ii
			   WHERE len(ltrim(rtrim(ii.SEOTitle))) > 200 and isnull(ii.SEOTitle,'')<>''		
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '102', 'SEOFriendlyPageName', SEOFriendlyPageName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertBrandData AS ii  
			WHERE (isnull(ii.SEOFriendlyPageName,'') LIKE '%[^a-zA-Z0-9]%' and  isnull(ii.SEOFriendlyPageName,'') NOT LIKE '%[_-]%' )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '81', 'URLKey', URLKey, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertBrandData AS ii  
			WHERE len(ltrim(rtrim(ii.URLKey))) > 200 and isnull(ii.URLKey,'')<>''			


		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ Brand - ' + ISNULL(BrandCode,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN @InsertBrandData IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertBrandData
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertBrandData
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;
		
		--<Begin Data Updation>
		CREATE TABLE #InsertedBrands (BrandId INT,BrandCode nvarchar(100),CMSSEODetailId int ) 
		
		UPDATE zbd set BrandCode=ibd.BrandCode,WebsiteLink=isnull(ibd.URLKey,WebsiteLink),IsActive=isnull(ibd.IsActive,zbd.IsActive),ModifiedBy=@UserId,
					   ModifiedDate=Getdate(),Custom1=isnull(ibd.Custom1,zbd.custom1),Custom2=isnull(ibd.Custom2,zbd.custom2),Custom3=isnull(ibd.Custom3,zbd.custom3),Custom4=isnull(ibd.Custom4,zbd.custom4),
					   Custom5=ISNULL(ibd.Custom5, zbd.Custom5)      
		OUTPUT INSERTED.BrandId ,INSERTED.BrandCode INTO  #InsertedBrands (BrandId, BrandCode)
		from ZnodeBrandDetails zbd
		inner join @InsertBrandData IBD on ibd.BrandCode=zbd.BrandCode
	
	
		UPDATE zbdl set zbdl.BrandId=zbd.BrandId,zbdl.Description=isnull(ibd.BrandDescription,zbdl.Description),SEOFriendlyPageName=isnull(IBD.SEOFriendlyPageName,zbdl.SEOFriendlyPageName),
		LocaleId=@LocaleId,ModifiedBy=@UserId,ModifiedDate=getdate(),BrandName=isnull(ibd.BrandCode,zbdl.BrandName)
		FROM ZnodeBrandDetailLocale zbdl
		inner join ZnodeBrandDetails zbd on zbd.BrandId=zbdl.BrandId
		inner join @InsertBrandData IBD on ibd.BrandCode=zbd.BrandCode
		inner join #InsertedBrands ib on ib.BrandId=zbdl.BrandId

		UPDATE ZCD set SEOId=ib.BrandId,SEOUrl=isnull(ibd.SEOFriendlyPageName,zcd.SEOUrl),ModifiedBy=@UserId,ModifiedDate=getdate(),
					   SEOCode=isnull(ibd.BrandCode,zcd.SEOCode)
		OUTPUT INSERTED.SEOId ,INSERTED.SEOCode, INSERTED.CMSSEODetailId INTO  #InsertedBrands (BrandId, BrandCode,CMSSEODetailId) 
		FROM ZnodeCMSSEODetail ZCD		
		inner join #InsertedBrands ib on ib.BrandId=ZCD.SEOId
		inner join @InsertBrandData IBD on ibd.BrandCode=zcd.SEOCode
		where exists (select null from ZnodeBrandDetailLocale zbdl where zbdl.BrandId=ZCD.SEOId)
		
		--<Delete Records Having Null Value>
		Delete from #InsertedBrands where isnull(CMSSEODetailId,0)=0
		--</Delete Records Having Null Value>
		
		UPDATE zcdl set CMSSEODetailId =isnull(ib.CMSSEODetailId,zcdl.CMSSEODetailId),LocaleId=@LocaleId,SEOTitle=isnull(ibd.SEOTitle,zcdl.SEOTitle),
						SEODescription=isnull(ibd.SEODescription,zcdl.SEODescription),SEOKeywords=isnull(ibd.SEOKeyword,zcdl.SEOKeywords),ModifiedBy=@UserId,ModifiedDate=getdate()
		FROM ZnodeCMSSEODetailLocale zcdl
		inner join #InsertedBrands ib on ib.CMSSEODetailId=zcdl.CMSSEODetailId
		inner join @InsertBrandData IBD on ibd.BrandCode=ib.BrandCode
		--</End Data Updation>
        
		--<Begin Data Insert>
		insert into ZnodeBrandDetails(BrandCode,MediaId,WebsiteLink,DisplayOrder,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Custom1,Custom2,Custom3,
										Custom4,Custom5)
		OUTPUT INSERTED.BrandId ,INSERTED.BrandCode INTO  #InsertedBrands (BrandId, BrandCode) 		
		Select ibd.BrandCode,(select top 1 MediaId from ZnodeMedia where FileName=ibd.BrandLogo order by CreatedDate desc),ibd.URLKey,0,ibd.IsActive,@UserId,GETDATE(),@UserId,Getdate(),ibd.Custom1,ibd.Custom2,ibd.Custom3,ibd.Custom4,ibd.Custom5
		from @InsertBrandData IBD	
		WHERE NOT EXISTS(SELECT * FROM ZnodeBrandDetails ZBD WHERE ZBD.BrandCode = IBD.BrandCode )		

		insert into ZnodeBrandDetailLocale (BrandId,Description,SEOFriendlyPageName,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,BrandName)
		select ac.BrandId,ibdl.BrandDescription,ibdl.SEOFriendlyPageName,@LocaleId,@UserId,getdate(),@UserId,GETDATE(),ibdl.BrandCode 
		from @InsertBrandData IBDL
		INNER JOIN #InsertedBrands ac on ac.BrandCode=ibdl.BrandCode
		WHERE NOT EXISTS(SELECT * FROM ZnodeBrandDetailLocale a 
							INNER JOIN ZnodeBrandDetails b on a.BrandId=b.BrandId AND b.BrandCode=ibdl.BrandCode )		

		insert into ZnodeCMSSEODetail (CMSSEOTypeId,SEOId,SEOUrl,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SEOCode,PublishStateId)
		OUTPUT INSERTED.SEOId ,INSERTED.SEOCode, INSERTED.CMSSEODetailId INTO  #InsertedBrands (BrandId, BrandCode,CMSSEODetailId)
		select (select CMSSEOTypeId  from ZnodeCMSSEOType where Name = 'Brand'),ac.BrandId,ibdl.SEOFriendlyPageName,@UserId,getdate(),@UserId,getdate(),ibdl.BrandCode,'2'
		from @InsertBrandData IBDL
		INNER JOIN #InsertedBrands ac on ac.BrandCode=ibdl.BrandCode
		WHERE NOT EXISTS(SELECT * FROM ZnodeCMSSEODetail a 
							INNER JOIN ZnodeBrandDetails b on b.BrandCode=ibdl.BrandCode 
							where a.SEOCode=ibdl.BrandCode
							AND a.CMSSEOTypeId=(select CMSSEOTypeId  from ZnodeCMSSEOType where Name = 'Brand')  )
		
		--<Delete Records Having Null Value>
		Delete from #InsertedBrands where isnull(CMSSEODetailId,0)=0
		--</Delete Records Having Null Value>

		insert into ZnodeCMSSEODetailLocale (CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		select ac.CMSSEODetailId ,@LocaleId,ibdl.SEOTitle,ibdl.SEODescription,ibdl.SEOKeyword,@UserId,GETDATE(),@UserId,Getdate()
		from @InsertBrandData IBDL
		INNER JOIN #InsertedBrands ac on ac.BrandCode=ibdl.BrandCode
		WHERE NOT EXISTS(SELECT * FROM ZnodeCMSSEODetailLocale a 
							INNER JOIN ZnodeCMSSEODetail b on a.CMSSEODetailId=b.CMSSEODetailId and b.SEOCode=ibdl.BrandCode
							INNER JOIN ZnodeBrandDetails c on c.BrandCode=ibdl.BrandCode 
							AND b.CMSSEOTypeId=(select CMSSEOTypeId  from ZnodeCMSSEOType where Name = 'Brand')  )		
        --<End Data Insert>

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN Brands;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN Brands

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		 DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportBrands @TableName = '+CAST(@TableName AS VARCHAR(max)) +',
		 @Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@LocaleId='+CAST(@LocaleId AS VARCHAR(200));

		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportBrands',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

Update ZnodeApplicationSetting 
set Setting='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>NoteID</name><headertext>Checkbox</headertext><width>20</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>NoteID</name><headertext>Note Id</headertext><width>20</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>UserName</name><headertext>User Name</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>NoteTitle</name><headertext>Note Title</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>NoteBody</name><headertext>Note Body</headertext><width>60</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>NoteDateTime</name><headertext>Created Date</headertext><width>0</width><datatype>DateTime</datatype><columntype>DateTime</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>Manage</name><headertext>Action</headertext><width>20</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>Edit|Delete</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/Account/EditAccountNote|/Account/DeleteAccountNote</manageactionurl><manageparamfield>noteId|noteId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName='ZnodeNote'

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodeOmsTemplatePersonalizeCartItem')
BEGIN
	CREATE TABLE [dbo].[ZnodeOmsTemplatePersonalizeCartItem]
	(
		[OmsTemplatePersonalizeCartItemId] [int] IDENTITY(1,1) NOT NULL,
		[OmsTemplateLineItemId] [int] NULL,
		[PersonalizeCode] [nchar](600) NULL,
		[PersonalizeValue] [nvarchar](max) NULL,
		[CreatedBy] [int] NULL,
		[CreatedDate] [datetime] NULL,
		[ModifiedBy] [int] NULL,
		[ModifiedDate] [datetime] NULL,
		[DesignId] [nvarchar](2000) NULL,
		[ThumbnailURL] [nvarchar](max) NULL,
		[PersonalizeName] [nvarchar](600) NULL,
		CONSTRAINT [PK_ZnodeOmsTemplatePersonalizeCartItem_OmsTemplatePersonalizeCartItemId] PRIMARY KEY CLUSTERED 
		(
			[OmsTemplatePersonalizeCartItemId] ASC
		),
		CONSTRAINT [FK_ZnodeOmsTemplatePersonalizeCartItem_ZnodeOmsTemplateLineItem] FOREIGN KEY([OmsTemplateLineItemId])
		REFERENCES [dbo].[ZnodeOmsTemplateLineItem] ([OmsTemplateLineItemId])
	) 
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'OmsOrderId' AND Object_ID = Object_ID(N'dbo.ZnodeOmsTemplateLineItem'))
BEGIN
	ALTER TABLE ZnodeOmsTemplateLineItem ADD OmsOrderId INT NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'Custom1' AND Object_ID = Object_ID(N'dbo.ZnodeOmsTemplateLineItem'))
BEGIN
	ALTER TABLE ZnodeOmsTemplateLineItem ADD Custom1 NVARCHAR (MAX)  NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'Custom2' AND Object_ID = Object_ID(N'dbo.ZnodeOmsTemplateLineItem'))
BEGIN
	ALTER TABLE ZnodeOmsTemplateLineItem ADD Custom2 NVARCHAR (MAX)  NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'Custom3' AND Object_ID = Object_ID(N'dbo.ZnodeOmsTemplateLineItem'))
BEGIN
	ALTER TABLE ZnodeOmsTemplateLineItem ADD Custom3 NVARCHAR (MAX)  NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'Custom4' AND Object_ID = Object_ID(N'dbo.ZnodeOmsTemplateLineItem'))
BEGIN
	ALTER TABLE ZnodeOmsTemplateLineItem ADD Custom4 NVARCHAR (MAX)  NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'Custom5' AND Object_ID = Object_ID(N'dbo.ZnodeOmsTemplateLineItem'))
BEGIN
	ALTER TABLE ZnodeOmsTemplateLineItem ADD Custom5 NVARCHAR (MAX)  NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'GroupId' AND Object_ID = Object_ID(N'dbo.ZnodeOmsTemplateLineItem'))
BEGIN
	ALTER TABLE ZnodeOmsTemplateLineItem ADD GroupId NVARCHAR (MAX)  NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'ProductName' AND Object_ID = Object_ID(N'dbo.ZnodeOmsTemplateLineItem'))
BEGIN
	ALTER TABLE ZnodeOmsTemplateLineItem ADD ProductName NVARCHAR (1000) NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'Description' AND Object_ID = Object_ID(N'dbo.ZnodeOmsTemplateLineItem'))
BEGIN
	ALTER TABLE ZnodeOmsTemplateLineItem ADD [Description] NVARCHAR (MAX)  NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'CustomUnitPrice' AND Object_ID = Object_ID(N'dbo.ZnodeOmsTemplateLineItem'))
BEGIN
	ALTER TABLE ZnodeOmsTemplateLineItem ADD [CustomUnitPrice] NUMERIC(28, 6) NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'AutoAddon' AND Object_ID = Object_ID(N'dbo.ZnodeOmsTemplateLineItem'))
BEGIN
	ALTER TABLE ZnodeOmsTemplateLineItem ADD [AutoAddon] NVARCHAR (200)  NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.types WHERE is_table_type = 1 AND name = 'SaveForLaterLineitems')
BEGIN
	CREATE TYPE [dbo].[SaveForLaterLineitems] AS TABLE(
	[RowId] [int] NULL,
	[OmsTemplateLineItemId] [int] NULL,
	[ParentOmsTemplateLineItemId] [int] NULL,
	[OmsTemplateId] [int] NULL,
	[SKU] [nvarchar](600) NULL,
	[Quantity] [numeric](28, 6) NULL,
	[OrderLineItemRelationshipTypeID] [int] NULL,
	[CustomText] [nvarchar](max) NULL,
	[CartAddOnDetails] [nvarchar](max) NULL,
	[Sequence] [int] NULL,
	[AddOnValueIds] [varchar](max) NULL,
	[BundleProductIds] [varchar](max) NULL,
	[ConfigurableProductIds] [varchar](max) NULL,
	[GroupProductIds] [varchar](max) NULL,
	[PersonalisedAttribute] [xml] NULL,
	[AutoAddon] [varchar](max) NULL,
	[OmsOrderId] [int] NULL,
	[ItemDetails] [nvarchar](max) NULL,
	[Custom1] [nvarchar](max) NULL,
	[Custom2] [nvarchar](max) NULL,
	[Custom3] [nvarchar](max) NULL,
	[Custom4] [nvarchar](max) NULL,
	[Custom5] [nvarchar](max) NULL,
	[GroupId] [nvarchar](max) NULL,
	[ProductName] [nvarchar](1000) NULL,
	[Description] [nvarchar](max) NULL,
	[AddOnQuantity] [nvarchar](max) NULL,
	[CustomUnitPrice] [numeric](28, 6) NULL
	)
END
GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateMoveToCartWrapper')
	DROP PROC Znode_InsertUpdateMoveToCartWrapper
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateMoveToCartWrapper]
(
	@OmsTemplateId INT, 
	@UserId INT,
	@PortalId INT,
	@Status INT  = 0 OUT
)
AS 
   /* 
    Summary: THis Procedure is USed to save AND edit the saved cart line item      
    Unit Testing 
	BEGIN tran  
    Exec Znode_InsertUpdateSaveCartLineItem @CartLineItemXML= '<ArrayOfSavedCartLineItemModel>
  <SavedCartLineItemModel>
    <OmsSavedCartLineItemId>0</OmsSavedCartLineItemId>
    <ParentOmsSavedCartLineItemId>0</ParentOmsSavedCartLineItemId>
    <OmsSavedCartId>1259</OmsSavedCartId>
    <SKU>BlueGreenYellow</SKU>
    <Quantity>1.000000</Quantity>
    <OrderLineItemRelationshipTypeId>0</OrderLineItemRelationshipTypeId>
    <Sequence>1</Sequence>
    <AddonProducts>YELLOW</AddonProducts>
    <BundleProducts />
    <ConfigurableProducts>GREEN</ConfigurableProducts>
  </SavedCartLineItemModel>
  <SavedCartLineItemModel>
    <OmsSavedCartLineItemId>0</OmsSavedCartLineItemId>
    <ParentOmsSavedCartLineItemId>0</ParentOmsSavedCartLineItemId>
    <OmsSavedCartId>1259</OmsSavedCartId>
    <SKU>ap1534</SKU>
    <Quantity>1.0</Quantity>
    <OrderLineItemRelationshipTypeId>0</OrderLineItemRelationshipTypeId>
    <Sequence>2</Sequence>
    <AddonProducts >PINK</AddonProducts>
    <BundleProducts />
    <ConfigurableProducts />
    <PersonaliseValuesList>Address~Hello</PersonaliseValuesList>
  </SavedCartLineItemModel>
</ArrayOfSavedCartLineItemModel>' , @UserId=1 ,@Status=0
	rollback tran
*/
BEGIN
BEGIN TRAN InsertUpdateSaveCartLineItem;
BEGIN TRY
SET NOCOUNT ON;
	--Declared the variables
	DECLARE @GetDate datetime= dbo.Fn_GetDate();
	DECLARE @AddOnQuantity numeric(28, 6)= 0;
	DECLARE @IsAddProduct   BIT = 0 
	DECLARE @OmsSavedCartLineItemId INT = 0
	DECLARE @CartLineItemXML XML
    DECLARE @OmsSavedCartId int
	DECLARE @OmsCookieMappingId int

	--Set the OrderLineItemRelationshipTypeId for Addons product
	DECLARE @OrderLineItemRelationshipTypeIdAddon int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'AddOns'  
	);
	--Set the OrderLineItemRelationshipTypeId for simple product
	DECLARE @OrderLineItemRelationshipTypeIdSimple int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Simple'  
	);
	--Set the OrderLineItemRelationshipTypeId for group product
	DECLARE @OrderLineItemRelationshipTypeIdGroup int=
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Group'  
	);
	--Set the OrderLineItemRelationshipTypeId for Configurable product
	DECLARE @OrderLineItemRelationshipTypeIdConfigurable int=
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Configurable'
	);
	--Set the OrderLineItemRelationshipTypeId for Bundles product	
	DECLARE @OrderLineItemRelationshipTypeIdBundle int=
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Bundles'
	);

	IF isNULL(@UserId,0) <> 0  
	BEGIN
		SET @OmsCookieMappingId = (SELECT top 1 OmsCookieMappingId FROM ZnodeOmsCookieMapping WITH (NOLOCK) WHERE isNULL(UserId,0) = @UserID AND isNULL(PortalId,0) = @PortalId)
	END

	IF NOT EXISTS(SELECT top 1 OmsCookieMappingId FROM ZnodeOmsCookieMapping WITH (NOLOCK) WHERE OmsCookieMappingId = @OmsCookieMappingId)
	BEGIN
		INSERT INTO ZnodeOmsCookieMapping (UserId,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT case when @UserId = 0 then NULL else @UserId END ,@PortalId,@UserId,@GetDate,@UserId,@GetDate

		SET @OmsCookieMappingId = @@IDENTITY
	END
	----To get the oms savecartid on basis of @OmsCookieMappingId 
	SET @OmsSavedCartId = (SELECT top 1 OmsSavedCartId FROM ZnodeOmsSavedCart WITH (NOLOCK) WHERE OmsCookieMappingId = @OmsCookieMappingId)
	
	----If omssavecartid not present in ZnodeOmsSavedCart table then inserting new record to generated omssavecartid 
	IF isNULL(@OmsSavedCartId,0) = 0
	BEGIN
		INSERT INTO ZnodeOmsSavedCart(OmsCookieMappingId,SalesTax,RecurringSalesTax,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT @OmsCookieMappingId,NULL,NULL,@UserId,@GetDate,@UserId,@GetDate

		SET @OmsSavedCartId = @@IDENTITY
	END
	

DECLARE @TBL_SavecartLineitems TABLE
	( 
		RowId int IDENTITY(1,1), OmsSavedCartLineItemId int, ParentOmsSavedCartLineItemId int, OmsSavedCartId int, SKU nvarchar(600), Quantity numeric(28, 6), OrderLineItemRelationshipTypeID int, CustomText nvarchar(max), 
		CartAddOnDetails nvarchar(max), Sequence int, AddOnValueIds varchar(max), BundleProductIds varchar(max), ConfigurableProductIds varchar(max), GroupProductIds varchar(max), PersonalisedAttribute XML, 
		AutoAddon varchar(max), OmsOrderId int, ItemDetails nvarchar(max),
		Custom1	nvarchar(max),Custom2 nvarchar(max),Custom3 nvarchar(max),Custom4
		nvarchar(max),Custom5 nvarchar(max),GroupId NVARCHAR(max) ,ProductName Nvarchar(1000) , Description NVARCHAR(max),AddOnQuantity NVARCHAR(max), CustomUnitPrice numeric(28, 6)
	);

	INSERT INTO @TBL_SavecartLineitems(OmsSavedCartLineItemId,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeID,CustomText,CartAddOnDetails,Sequence,AutoAddon,Custom1,Custom2,Custom3,Custom4
			  ,Custom5,GroupId,ProductName,Description,CustomUnitPrice)

	SELECT OmsTemplateLineItemId,@OmsSavedCartId as OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeID,CustomText,CartAddOnDetails,
			Sequence,AutoAddon,Custom1,Custom2,Custom3,Custom4
			,Custom5,GroupId,ProductName,Description,CustomUnitPrice 
	FROM ZnodeOmsTemplateLineItem WHERE OmsTemplateId = @Omstemplateid AND ParentOmsTemplateLineItemId IS NULL

	INSERT INTO @TBL_SavecartLineitems(OmsSavedCartLineItemId,ParentOmsSavedCartLineItemId,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeID,CustomText,CartAddOnDetails,
			Sequence , AutoAddon,
		
			 Custom1	,Custom2 ,Custom3,Custom4
			,Custom5 ,GroupId ,ProductName  , Description ,CustomUnitPrice )
	SELECT a.OmsTemplateLineItemId,a.ParentOmsTemplateLineItemId,@OmsSavedCartId as OmsSavedCartId,a.SKU , a.Quantity , a.OrderLineItemRelationshipTypeID , a.CustomText , a.CartAddOnDetails,
			a.Sequence , a.AutoAddon,
		
			a.Custom1	,a.Custom2 ,a.Custom3,a.Custom4
			,a.Custom5 ,a.GroupId ,a.ProductName  , a.Description ,a.CustomUnitPrice 
	FROM ZnodeOmsTemplateLineItem a
	INNER JOIN @TBL_SavecartLineitems b on a.ParentOmsTemplateLineItemId = b.OmsSavedCartLineItemId
	WHERE OmsTemplateId = @Omstemplateid AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple

	INSERT INTO @TBL_SavecartLineitems(OmsSavedCartLineItemId,ParentOmsSavedCartLineItemId,OmsSavedCartId,SKU , Quantity , OrderLineItemRelationshipTypeID , CustomText , CartAddOnDetails,
			Sequence , AutoAddon,
		
			Custom1	,Custom2 ,Custom3,Custom4
			,Custom5 ,GroupId ,ProductName  , Description ,CustomUnitPrice,BundleProductIds )
	SELECT a.OmsTemplateLineItemId,a.ParentOmsTemplateLineItemId,@OmsSavedCartId as OmsSavedCartId,b.SKU , a.Quantity , a.OrderLineItemRelationshipTypeID , a.CustomText , a.CartAddOnDetails,
			a.Sequence , a.AutoAddon,
		
			a.Custom1	,a.Custom2 ,a.Custom3,a.Custom4
			,a.Custom5 ,a.GroupId ,a.ProductName  , a.Description ,a.CustomUnitPrice, c.Item
	FROM ZnodeOmsTemplateLineItem a
	INNER JOIN @TBL_SavecartLineitems b on a.ParentOmsTemplateLineItemId = b.OmsSavedCartLineItemId
	cross apply dbo.split(a.sku,',')c 
	WHERE OmsTemplateId = @Omstemplateid AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle

	INSERT INTO @TBL_SavecartLineitems(OmsSavedCartLineItemId,ParentOmsSavedCartLineItemId,OmsSavedCartId,SKU , Quantity , OrderLineItemRelationshipTypeID , CustomText , CartAddOnDetails,
			Sequence , AutoAddon,
		
			Custom1	,Custom2 ,Custom3,Custom4
			,Custom5 ,GroupId ,ProductName  , Description ,CustomUnitPrice,ConfigurableProductIds )
	SELECT a.OmsTemplateLineItemId,a.ParentOmsTemplateLineItemId,@OmsSavedCartId as OmsSavedCartId,b.SKU , a.Quantity , a.OrderLineItemRelationshipTypeID , a.CustomText , a.CartAddOnDetails,
			a.Sequence , a.AutoAddon,
		
			a.Custom1	,a.Custom2 ,a.Custom3,a.Custom4
			,a.Custom5 ,a.GroupId ,a.ProductName  , a.Description ,a.CustomUnitPrice, a.SKU
	FROM ZnodeOmsTemplateLineItem a
	INNER JOIN @TBL_SavecartLineitems b on a.ParentOmsTemplateLineItemId = b.OmsSavedCartLineItemId
	WHERE OmsTemplateId = @Omstemplateid AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable

	INSERT INTO @TBL_SavecartLineitems(OmsSavedCartLineItemId,ParentOmsSavedCartLineItemId,OmsSavedCartId,SKU , Quantity , OrderLineItemRelationshipTypeID , CustomText , CartAddOnDetails,
			Sequence , AutoAddon,
		
			Custom1	,Custom2 ,Custom3,Custom4
			,Custom5 ,GroupId ,ProductName  , Description ,CustomUnitPrice,GroupProductIds )
	SELECT a.OmsTemplateLineItemId,a.ParentOmsTemplateLineItemId,@OmsSavedCartId as OmsSavedCartId,b.SKU , a.Quantity , a.OrderLineItemRelationshipTypeID , a.CustomText , a.CartAddOnDetails,
			a.Sequence , a.AutoAddon,
		
			a.Custom1	,a.Custom2 ,a.Custom3,a.Custom4
			,a.Custom5 ,a.GroupId ,a.ProductName  , a.Description ,a.CustomUnitPrice, a.SKU
	FROM ZnodeOmsTemplateLineItem a
	INNER JOIN @TBL_SavecartLineitems b on a.ParentOmsTemplateLineItemId = b.OmsSavedCartLineItemId
	WHERE OmsTemplateId = @Omstemplateid AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup

	update a set a.OrderLineItemRelationshipTypeID = b.OrderLineItemRelationshipTypeID from @TBL_SavecartLineitems a
	inner join @TBL_SavecartLineitems b on a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId
	where a.OrderLineItemRelationshipTypeID is null and a.ParentOmsSavedCartLineItemId is null and b.OrderLineItemRelationshipTypeID is not null


	INSERT INTO @TBL_SavecartLineitems(OmsSavedCartLineItemId,ParentOmsSavedCartLineItemId,OmsSavedCartId,SKU , Quantity , OrderLineItemRelationshipTypeID , CustomText , CartAddOnDetails,
			Sequence , AutoAddon,
		
			Custom1	,Custom2 ,Custom3,Custom4
			,Custom5 ,GroupId ,ProductName  , Description ,CustomUnitPrice,AddOnValueIds ,AddOnQuantity,ConfigurableProductIds,BundleProductIds,GroupProductIds)
	SELECT a.OmsTemplateLineItemId,a.ParentOmsTemplateLineItemId, @OmsSavedCartId as OmsSavedCartId,B.SKU , a.Quantity , a.OrderLineItemRelationshipTypeID , a.CustomText , a.CartAddOnDetails,
			a.Sequence , a.AutoAddon,
		
			a.Custom1	,a.Custom2 ,a.Custom3,a.Custom4
			,a.Custom5 ,a.GroupId ,a.ProductName  , a.Description ,a.CustomUnitPrice, a.SKU,a.Quantity,ConfigurableProductIds,BundleProductIds,GroupProductIds
	FROM ZnodeOmsTemplateLineItem a
	INNER JOIN @TBL_SavecartLineitems b on a.ParentOmsTemplateLineItemId = b.OmsSavedCartLineItemId
	WHERE OmsTemplateId = @Omstemplateid AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND B.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdBundle

	INSERT INTO @TBL_SavecartLineitems(OmsSavedCartLineItemId,ParentOmsSavedCartLineItemId,OmsSavedCartId,SKU , Quantity , OrderLineItemRelationshipTypeID , CustomText , CartAddOnDetails,
			Sequence , AutoAddon,
		
			Custom1	,Custom2 ,Custom3,Custom4
			,Custom5 ,GroupId ,ProductName  , Description ,CustomUnitPrice,AddOnValueIds ,AddOnQuantity,ConfigurableProductIds,BundleProductIds,GroupProductIds)
	SELECT a.OmsTemplateLineItemId,a.ParentOmsTemplateLineItemId, @OmsSavedCartId as OmsSavedCartId,B.SKU , a.Quantity , a.OrderLineItemRelationshipTypeID , a.CustomText , a.CartAddOnDetails,
			a.Sequence , a.AutoAddon,
		
			a.Custom1	,a.Custom2 ,a.Custom3,a.Custom4
			,a.Custom5 ,a.GroupId ,a.ProductName  , a.Description ,a.CustomUnitPrice, a.SKU,a.Quantity,ConfigurableProductIds,BundleProductIds,GroupProductIds
	FROM ZnodeOmsTemplateLineItem a
	INNER JOIN @TBL_SavecartLineitems b on a.ParentOmsTemplateLineItemId = b.ParentOmsSavedCartLineItemId
	WHERE OmsTemplateId = @Omstemplateid AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND B.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle

	--update personalize text
	SELECT  OmsTemplateLineItemId,'<PersonaliseValueModel> <PersonalizeCode>'+isnull(ltrim(rtrim(PersonalizeCode)),'')+'</PersonalizeCode><PersonalizeValue>'+isnull(ltrim(rtrim(PersonalizeValue)),'')
	+'</PersonalizeValue><DesignId>'+isnull(DesignId,'')+'</DesignId><ThumbnailURL>'+isnull(ThumbnailURL,'')+'</ThumbnailURL><PersonalizeName>'
	+isnull(PersonalizeName,'')+'</PersonalizeName><OmsSavedCartLineItemId>0</OmsSavedCartLineItemId></PersonaliseValueModel>' 
	AS PersonalisedAttribute
	INTO #PersonalisedData
	FROM ZnodeOmsTemplatePersonalizeCartItem WHERE OmsTemplateLineItemId IN (
	SELECT OmsTemplateLineItemId FROM ZnodeOmsTemplateLineItem  WHERE OmsTemplateId =@Omstemplateid )


	SELECT  OmsTemplateLineItemId, STUFF((SELECT  ',' + PersonalisedAttribute 
	FROM #PersonalisedData B WHERE A.OmsTemplateLineItemId=B.OmsTemplateLineItemId
	FOR XML PATH ('')
	), 1, 1, '')  AS PersonalisedAttribute
	into #MergePersonalizeData
	FROM #PersonalisedData A
	GROUP BY OmsTemplateLineItemId

	update #MergePersonalizeData set PersonalisedAttribute = replace(replace(PersonalisedAttribute,'&lt;','<'),'&gt;','>') where PersonalisedAttribute is not null

	Update B set PersonalisedAttribute=A.PersonalisedAttribute
	from #MergePersonalizeData A 
	inner join @TBL_SavecartLineitems B on (A.OmsTemplateLineItemId=B.OmsSavedCartLineItemId )

	--Updating personalize xml string in parent product for simple product
	UPDATE A SET PersonalisedAttribute = B.PersonalisedAttribute
	FROM @TBL_SavecartLineitems A
	INNER JOIN @TBL_SavecartLineitems B ON A.OmsSavedCartLineItemId = B.ParentOmsSavedCartLineItemId AND B.OrderLineItemRelationshipTypeID =  @OrderLineItemRelationshipTypeIdSimple

	--Inserting the personalise data into variable table @TBL_Personalise for inserting the personalise data for new products
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId int,SKU Varchar(600) ,PersonalizeCode NVARCHAr(max),PersonalizeValue NVARCHAr(max),DesignId NVARCHAr(max), ThumbnailURL NVARCHAr(max))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.SKU
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(Max)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(Max)' ) AS ThumbnailURL
	FROM @TBL_SavecartLineitems a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col) 
	where a.ParentOmsSavedCartLineItemId is not null

	DELETE FROM @TBL_SavecartLineitems 
	WHERE OmsSavedCartLineItemId in (SELECT ParentOmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE OrderLineItemRelationshipTypeID 
	IN (@OrderLineItemRelationshipTypeIdBundle,@OrderLineItemRelationshipTypeIdConfigurable,@OrderLineItemRelationshipTypeIdGroup,@OrderLineItemRelationshipTypeIdSimple) AND ParentOmsSavedCartLineItemId IS NOT NULL)

	UPDATE @TBL_SavecartLineitems SET OmsSavedCartLineItemId = 0 ,ParentOmsSavedCartLineItemId = 0 where OrderLineItemRelationshipTypeID is null
	UPDATE @TBL_SavecartLineitems SET OmsSavedCartLineItemId = 0 ,ParentOmsSavedCartLineItemId = 0 
	where OrderLineItemRelationshipTypeID NOT IN (@OrderLineItemRelationshipTypeIdBundle,@OrderLineItemRelationshipTypeIdConfigurable,@OrderLineItemRelationshipTypeIdGroup)
	UPDATE @TBL_SavecartLineitems SET OmsSavedCartLineItemId = 0 ,ParentOmsSavedCartLineItemId = 0,OrderLineItemRelationshipTypeID=null,Sequence = null 
	where OrderLineItemRelationshipTypeID in (@OrderLineItemRelationshipTypeIdBundle,@OrderLineItemRelationshipTypeIdConfigurable,@OrderLineItemRelationshipTypeIdGroup)

	delete a from @TBL_SavecartLineitems a where A.AddOnValueIds IS NULL
	and exists(select * from @TBL_SavecartLineitems b where b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon and  isnull(a.ConfigurableProductIds,'') = isnull(b.ConfigurableProductIds,'')
	and isnull(a.BundleProductIds,'') = isnull(b.BundleProductIds,'') and isnull(a.GroupProductIds,'') = isnull(b.GroupProductIds,'') and isnull(a.SKU,'') = isnull(b.SKU,'')
	)

	update @TBL_SavecartLineitems set OrderLineItemRelationshipTypeID = null,Sequence = NULL

	--Save cart execution code for bundle product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' )
	BEGIN 				
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
		BEGIN 
			SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0 )

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0)
			, ModifiedDate = @GetDate, CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SavecartLineitems)
			WHERE ( OmsSavedCartLineItemId = @OmsSavedCartLineItemId  
			OR ParentOmsSavedCartLineItemId =  @OmsSavedCartLineItemId   ) 

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = AddOnQuantity, ModifiedDate = @GetDate,CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SavecartLineitems)
			FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
			INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
			WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
			AND SCLI.BundleProductIds <> ''

			--After update the existing cart with new save cart then deleting those records which are updated
			DELETE	FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0
		END 

		--Getting bundle save cart line item entries into table to pass for bundle prodcut sp
		DECLARE @TBL_bundleProduct TT_SavecartLineitems 
		INSERT INTO @TBL_bundleProduct 
		SELECT *  
		FROM @TBL_SavecartLineitems 
		WHERE ISNULL(BundleProductIds,'') <> '' 
				
		EXEC Znode_InsertUpdateSaveCartLineItemBundle @TBL_bundleProduct,@userId,@OrderLineItemRelationshipTypeIdBundle,@OrderLineItemRelationshipTypeIdAddon
				 
		DELETE FROM  @TBL_SavecartLineitems WHERE ISNULL(BundleProductIds,'') <> '' 
		SET @OmsSavedCartLineItemId = 0 
	END 
	--Save cart execution code for configurable product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' )
	BEGIN 				
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
		BEGIN 

			SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0 )
				 
			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
			, ModifiedDate = @GetDate,CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SavecartLineitems)
			WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = AddOnQuantity, ModifiedDate = @GetDate, CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SavecartLineitems)
			FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
			INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
			WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
			AND SCLI.ConfigurableProductIds <> ''

			--After update the existing cart with new save cart then deleting those records which are updated
			DELETE	FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0
		END 
		--Getting bundle save cart line item entries into table to pass for configurable prodcut sp
		DECLARE @TBL_Configurable TT_SavecartLineitems 
		INSERT INTO @TBL_Configurable 
		SELECT *  
		FROM @TBL_SavecartLineitems 
		WHERE ISNULL(ConfigurableProductIds,'') <> '' 

		EXEC Znode_InsertUpdateSaveCartLineItemConfigurable @TBL_Configurable,@userId,@OrderLineItemRelationshipTypeIdConfigurable,@OrderLineItemRelationshipTypeIdAddon
	  
		DELETE FROM @TBL_SavecartLineitems 
		WHERE ISNULL(ConfigurableProductIds,'') <> ''
		SET @OmsSavedCartLineItemId = 0  
	END 
	--Save cart execution code for group product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' )
	BEGIN 				
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
		BEGIN 
			--Updating the existing save cart for group product
			SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0 )
			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId = @OmsSavedCartLineItemId ), CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SavecartLineitems)
			WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = AddOnQuantity, ModifiedDate = @GetDate, CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SavecartLineitems)
			FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
			INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
			WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
			AND SCLI.GroupProductIds <> ''

			--After update the existing cart with new save cart then deleting those records which are updated
			DELETE	FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0
		END 
		--Getting bundle save cart line item entries into table to pass for group prodcut sp
		DECLARE @TBL_Group TT_SavecartLineitems 
		INSERT INTO @TBL_Group 
		SELECT *  
		FROM @TBL_SavecartLineitems 
		WHERE ISNULL(GroupProductIds,'') <> '' 

		EXEC Znode_InsertUpdateSaveCartLineItemGroup @TBL_Group,@userId,@OrderLineItemRelationshipTypeIdGroup,@OrderLineItemRelationshipTypeIdAddon
		
		--After update the existing cart with new save cart then deleting those records which are updated
		DELETE FROM @TBL_SavecartLineitems WHERE ISNULL(GroupProductIds,'') <> ''
		SET @OmsSavedCartLineItemId = 0  
	END 
	
	--This part is for updating the cart for existing line items for simple product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId <> 0  ) 
	BEGIN 
				 
		SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId <> 0 )
		UPDATE ZnodeOmsSavedCartLineItem 
		SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
		, ModifiedDate = @GetDate , CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SavecartLineitems)
		WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId

		DECLARE @ParentOmsSavedCartLineItemId INT = 0
		SET @ParentOmsSavedCartLineItemId = (select ParentOmsSavedCartLineItemId from ZnodeOmsSavedCartLineItem WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId)

		UPDATE ZnodeOmsSavedCartLineItem 
		SET  CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SavecartLineitems)
		WHERE OmsSavedCartLineItemId = @ParentOmsSavedCartLineItemId

		UPDATE ZnodeOmsSavedCartLineItem 
		SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
		INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = @OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
		WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					
		DELETE	FROM @TBL_SavecartLineitems WHERE OmsSavedCartLineItemId <> 0
	END 
	--Save cart execution code for Simple product
	DECLARE @OmsInsertedData TABLE (OmsSavedCartLineItemId INT )
				
	CREATE TABLE #NewSavecartLineitemDetails 
	(
		GenId INT IDENTITY(1,1),RowId	INT	,OmsSavedCartLineItemId	INT	 ,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	INT
		,SKU	NVARCHAR(MAX) ,Quantity	NUMERIC(28,6)	,OrderLineItemRelationshipTypeID	INT	,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	int	,AutoAddon	varchar(MAX)	,OmsOrderId	INT	,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX)
	)
	
	--Getting new save cart data
	INSERT INTO #NewSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU 
	FROM @TBL_SavecartLineitems a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
		
	--Getting new simple product save cart data
	INSERT INTO #NewSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, @OrderLineItemRelationshipTypeIdSimple, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU 
	FROM @TBL_SavecartLineitems  a 
	WHERE ISNULL(BundleProductIds,'') =  '' 
	AND  ISNULL(GroupProductIds,'') = ''	AND ISNULL(	ConfigurableProductIds,'') = ''
		GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity,  CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
	
	--Getting new Group,Bundle and Configurable products save cart data if addon is present for any line item
	INSERT INTO #NewSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
		,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
		WHEN  GroupProductIds <> '' THEN GroupProductIds 
		WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU 
	FROM @TBL_SavecartLineitems  a 
	WHERE AddOnValueIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU

	CREATE TABLE #OldSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old save cart data if present for same SKU in the new save cart data for simple product	 
	INSERT INTO #OldSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM ZnodeOmsSavedCartLineItem a with (nolock)  
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.SKU,'')   )   
	AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple   

	--Getting the old save cart Parent data 
	INSERT INTO #OldSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
	AND  b.OrderLineItemRelationshipTypeID IS NULL 
		 
	DELETE a FROM #OldSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 
		
	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldSavecartLineitemDetails
		
	--Getting the old save cart addon data for old line items if present
	INSERT INTO #OldSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
	AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

	------Merge Addon for same product
	IF EXISTS(SELECT * FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'') <> '' )
	BEGIN

		INSERT INTO #OldValueForAddon 
		SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
		FROM ZnodeOmsSavedCartLineItem b with (nolock)
		INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
								( SELECT  ', ' + SKU FROM    
									( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
										where a.OmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
										FOR XML PATH('')
								), 1, 2, ''
								) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a where a.ParentOmsSavedCartLineItemId is not null and OrderLineItemRelationshipTypeID<>1

		SELECT distinct a.SKU, STUFF(
									( SELECT  ', ' + x.AddOnValueIds FROM    
									( SELECT DISTINCT b.AddOnValueIds FROM @TBL_SavecartLineitems b
										where a.SKU=b.SKU ) x
										FOR XML PATH('')
									), 1, 2, ''
								) AddOns
		INTO #AddOnAdded
		FROM @TBL_SavecartLineitems a

		IF NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
		BEGIN
			DELETE FROM #OldSavecartLineitemDetails
		END

	END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_SavecartLineitems ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldSavecartLineitemDetails a WHERE	
	ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN 
		
		DELETE FROM #OldSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
	    
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  <> '' )
		BEGIN 
		 
			DECLARE @parenTofAddon  TABLE( ParentOmsSavedCartLineItemId INT  )  
			INSERT INTO  @parenTofAddon 
			SELECT  ParentOmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  

			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ParentOmsSavedCartLineItemId FROM  @parenTofAddon)   
				AND ParentOmsSavedCartLineItemId IS NOT NULL  
				AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldSavecartLineitemDetails m)
			AND ParentOmsSavedCartLineItemId IS  NULL  
		 
		END 
		ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		BEGIN 

			DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple  )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
			OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		    
			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldSavecartLineitemDetails m)
			AND ParentOmsSavedCartLineItemId IS  NULL  

		END
		ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  = '' )
		BEGIN 

			DELETE FROM #OldSavecartLineitemDetails
		END 
	END 

	--Getting the personalise data for old save cart if present
	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)

	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		DELETE FROM #OldSavecartLineitemDetails
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 
		   
			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
			SELECT OmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
			OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		      
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 

			DELETE n FROM #OldSavecartLineitemDetails n WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
			OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
	   
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		BEGIN 
			DELETE FROM #OldSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		END 
	  
	END 
	
	--If already exists cart 
	IF EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails )
	BEGIN

		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU not having personalise value for new cart item
		;WITH cte AS
		(
			SELECT distinct b.*
			FROM @TBL_SavecartLineitems a 
			INNER JOIN #OldSavecartLineitemDetails b on ( a.SKU = b.sku)
			where isnull(cast(a.PersonalisedAttribute AS varchar(max)),'') = '' and a.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		)
		,cte2 AS
		(
			SELECT c.ParentOmsSavedCartLineItemId
			FROM #OldSavecartLineitemDetails a
			INNER JOIN ZnodeOmsSavedCartLineItem c on a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		)
		DELETE a FROM #OldSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU having personalise value for new cart item
		;WITH cte AS
		(
			SELECT distinct b.*, 
				a.PersonalizeCode
				,a.PersonalizeValue
			FROM @TBL_Personalise a 
			INNER JOIN #OldSavecartLineitemDetails b on ( a.SKU = b.sku)
			where a.PersonalizeValue <> ''
		)
		,cte2 AS
		(
			SELECT a.ParentOmsSavedCartLineItemId, b.PersonalizeCode, b.PersonalizeValue
			FROM #OldSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
			WHERE NOT EXISTS(SELECT * FROM cte c where b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and b.PersonalizeCode = c.PersonalizeCode 
						and b.PersonalizeValue = c.PersonalizeValue )
		)
		DELETE a FROM #OldSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,b.ParentOmsSavedCartLineItemId , a.SKU AS SKU
				,a.PersonalizeCode
				,a.PersonalizeValue
				,a.DesignId
				,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldSavecartLineitemDetails b on a.SKU = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM #OldSavecartLineitemDetails b1 
		WHERE NOT EXISTS(SELECT * FROM cte c where (b1.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or b1.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId))
		AND EXISTS(SELECT * FROM cte)

		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
	-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldSavecartLineitemDetails b ON a.SKU = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
			--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewSavecartLineitemDetails  b ON a.SKU = b.SKU
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0 AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		from CTE_OldPersonalizeCodeCount a
		inner join CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		inner join #OldSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		
		--Delete parent entry if child not present
		DELETE a FROM #OldSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

	--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
	--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
	
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.SKU
						,d.PersonalizeCode
				,d.PersonalizeValue
				,d.DesignId
				,d.ThumbnailURL
				FROM @TBL_SavecartLineitems a 
				INNER JOIN #OldSavecartLineitemDetails b on a.SKU = b.SKU
				INNER JOIN @TBL_Personalise d on d.SKU = a.SKU
				INNER JOIN ZnodeOmsPersonalizeCartItem  c  with (nolock)  on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
				WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM cte a1		  
		INNER JOIN #OldSavecartLineitemDetails b1 on a1.sku = b1.SKU
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c where a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and a1.PersonalizeValue = c.PersonalizeValue)

		--Updating the cart if old and new cart data matches 
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5, 
		a.ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewSavecartLineitemDetails ty ON (ty.SKU = b.SKU)

	END 
	
	--Inserting the new save cart data if old and new cart data not match
	IF NOT EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails )
	BEGIN 
	    --Getting the new save cart data and generating row no. for new save cart insert
		SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU  
		INTO #InsertNewSavecartLineitem   
		FROM  #NewSavecartLineitemDetails  
		GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails ,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU   
		ORDER BY RowId, Id   
       	
		--Removing the line item having Quantity <=0	     
		DELETE FROM #InsertNewSavecartLineitem WHERE Quantity <=0  
  
		--Updating the rowid into new save cart line item as new line item is merged into existing save cart item
		;WITH VTTY AS   
		(  
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
			FROM #InsertNewSavecartLineitem m  
			INNER JOIN  #InsertNewSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU   
			WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon   
		)   
		UPDATE m1   
		SET m1.RowId = TYU.RowId  
		FROM #InsertNewSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  
        
		--Deleting the new save cart line item if cart line item is merged
		;WITH VTRET AS   
		(  
			SELECT RowId,id,Min(NewRowId) NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID  
			FROM #InsertNewSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID
			Having  SKU = ParentSKU  AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdSimple
		)   
		DELETE FROM #InsertNewSavecartLineitem WHERE NewRowId IN (SELECT NewRowId FROM VTRET)  

		--Inserting the new cart line item if not merged in existing save cart line item
		INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description)  
		OUTPUT INSERTED.OmsSavedCartLineItemId  INTO @OmsInsertedData 
		SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description   
		FROM  #InsertNewSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU  
		INTO #ParentOmsSavedCartId
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		AND CASE WHEN EXISTS (SELECT TOP 1 1 FROM #InsertNewSavecartLineitem TU WHERE TU.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple)  THEN ISNULL(a.OrderLineItemRelationshipTypeID,0) ELSE 0 END = 0 
		GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #ParentOmsSavedCartId  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
		AND a.ParentOmsSavedCartLineItemId IS nULL   

		SELECT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(Order BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #NewSimpleProduct
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c on b.sku = c.sku and b.OmsSavedCartId=c.OmsSavedCartId and b.Id = 1 
		WHERE ( ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  and c.ParentOmsSavedCartLineItemId is null

		--Updating ParentOmsSavedCartLineItemId for newly added save cart line item
		;WITH table_update AS 
		(
			SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId  ) RowIdNo
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
			AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
			AND a.ParentOmsSavedCartLineItemId IS NULL  
			AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
			AND EXISTS (SELECT TOP 1 1 FROM #NewSimpleProduct TI WHERE TI.SKU = a.SKU)
		)
		UPDATE a SET  
		a.ParentOmsSavedCartLineItemId =(SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewSimpleProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewSimpleProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU   GROUP BY r.ParentSKU, r.SKU  )    IS NOT NULL 
	 
		;WITH Cte_Th AS   
		(             
			SELECT RowId    
			FROM #InsertNewSavecartLineitem a   
			GROUP BY RowId   
			HAVING COUNT(NewRowId) <= 1   
		)   
		UPDATE a SET a.Quantity =  NULL , a.ModifiedDate = @GetDate  
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		AND OrderLineItemRelationshipTypeId IS NOT NULL     

		;WITH Cte_UpdateSequence AS   
		(  
			SELECT OmsSavedCartLineItemId ,Row_Number()Over(Order By OmsSavedCartLineItemId) RowId , Sequence   
			FROM ZnodeOmsSavedCartLineItem with (nolock)  
			WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		)   
		UPDATE Cte_UpdateSequence  
		SET  Sequence = RowId  
	
		------To update saved cart item personalise value FROM given line item	
		--IF EXISTS(SELECT * FROM @TBL_Personalise1 where isnull(PersonalizeValue,'') <> '' and isnull(OmsSavedCartLineItemId,0) <> 0)
		--BEGIN
		--	DELETE FROM ZnodeOmsPersonalizeCartItem 
		--	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise1 yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )

		--	MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		--	USING @TBL_Personalise1 SOURCE
		--	ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
		--	WHEN NOT MATCHED THEN 
		--	INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
		--					,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
		--	VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
		--					,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
		--END		
	
		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN ZnodeOmsSavedCartLineItem b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS NOT NULL 
	
		DELETE FROM ZnodeOmsPersonalizeCartItem 
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
						
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
		ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
		WHEN NOT MATCHED THEN 
		INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
					,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
		VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
					,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
  
		
		 
	END 

	--Declare @OutputTable Table (CartCount numeric(28,6))

	--INSERT INTO @OutputTable
	--EXEC [Znode_GetOmsSavedCartLineItemCount] @OmsCookieMappingId = @OmsCookieMappingId,@UserId=@UserId,@PortalId=@UserId
	

	--SELECT CAST(1 AS bit) AS Status,@OmsSavedCartId AS SavedCartId,@OmsCookieMappingId AS CookieMappingId,CartCount
	--FROM @OutputTable

	SELECT @Status = 1
	SELECT cast( 1 as int )as Id, Cast(@Status as bit) Status;
COMMIT TRAN InsertUpdateSaveCartLineItem;
END TRY
BEGIN CATCH
SELECT @Status = 0
	SELECT ERROR_MESSAGE()	
	DECLARE @Error_procedure varchar(1000)= ERROR_PROCEDURE(), @ErrorMessage nvarchar(max)= ERROR_MESSAGE(), @ErrorLine varchar(100)= ERROR_LINE(), @ErrorCall nvarchar(max)= 'EXEC Znode_InsertUpdateSaveCartLineItem @CartLineItemXML = '+CAST(@CartLineItemXML
	AS varchar(max))+',@UserId = '+CAST(@UserId AS varchar(50))+',@PortalId='+CAST(@PortalId AS varchar(10))+',@OmsCookieMappingId='+CAST(@OmsCookieMappingId AS varchar(10));

	SELECT cast( 0 as int ) Id, Cast(@Status as bit) Status;
	ROLLBACK TRAN InsertUpdateSaveCartLineItem;
	EXEC Znode_InsertProcedureErrorLog @ProcedureName = 'Znode_InsertUpdateSaveCartLineItemQuantityWrapper', @ErrorInProcedure = @Error_procedure, @ErrorMessage = @ErrorMessage, @ErrorLine = @ErrorLine, @ErrorCall = @ErrorCall;
END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveForLaterLineItemBundle')
	DROP PROC Znode_InsertUpdateSaveForLaterLineItemBundle
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveForLaterLineItemBundle]
 (
	 @SaveForLaterLineItemType SaveForLaterLineitems READONLY  
	,@Userid  INT = 0
	,@OrderLineItemRelationshipTypeIdBundle INT
	,@OrderLineItemRelationshipTypeIdAddon INT
 )
AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 
    --Declared the variables
    DECLARE @GetDate datetime= dbo.Fn_GetDate(); 
   
	DECLARE @OmsInsertedData TABLE (OmsTemplateLineItemId INT ) 	
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise TABLE (OmsTemplateLineItemId INT, ParentOmsTemplateLineItemId INT,BundleProductIds VARCHAR(600) ,PersonalizeCode NVARCHAR(MAX),PersonalizeValue NVARCHAR(MAX),DesignId NVARCHAR(MAX), ThumbnailURL NVARCHAR(MAX),PersonalizeName NVARCHAR(max))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsTemplateLineItemId,a.BundleProductIds
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(MAX)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(MAX)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(MAX)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(MAX)' ) AS ThumbnailURL
			,Tbl.Col.value( 'PersonalizeName[1]', 'NVARCHAR(MAX)' ) AS PersonalizeName
	FROM @SaveForLaterLineItemType a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col) 

	CREATE TABLE #NewBundleSaveForLaterLineitemDetails 
	(
		GenId INT IDENTITY(1,1),RowId	INT	,OmsTemplateLineItemId	INT	 ,ParentOmsTemplateLineItemId	INT,OmsTemplateId	INT
		,SKU	NVARCHAR(MAX) ,Quantity	NUMERIC(28,6)	,OrderLineItemRelationshipTypeID	INT	,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	INT	,AutoAddon	VARCHAR(MAX)	,OmsOrderId	INT	,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX),
		CustomUnitPrice NUMERIC(28,6)
	)
	
	--Getting new save cart data(bundle product)
	INSERT INTO #NewBundleSaveForLaterLineitemDetails
	SELECT  Min(RowId )RowId ,OmsTemplateLineItemId, ParentOmsTemplateLineItemId, OmsTemplateId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU ,
		CustomUnitPrice
	FROM @SaveForLaterLineItemType a 
	GROUP BY  OmsTemplateLineItemId, ParentOmsTemplateLineItemId, OmsTemplateId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,CustomUnitPrice
	 
	--Getting new bundle product save cart data
	INSERT INTO #NewBundleSaveForLaterLineitemDetails 
	SELECT   Min(RowId )RowId ,OmsTemplateLineItemId, ParentOmsTemplateLineItemId, OmsTemplateId, BundleProductIds
				,Quantity, @OrderLineItemRelationshipTypeIdBundle, CustomText, CartAddOnDetails, Sequence
				,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU,
				CustomUnitPrice
	FROM @SaveForLaterLineItemType  a 
	WHERE BundleProductIds <> ''
	GROUP BY  OmsTemplateLineItemId, ParentOmsTemplateLineItemId, OmsTemplateId, BundleProductIds
	,Quantity,  CustomText, CartAddOnDetails, Sequence ,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU,CustomUnitPrice
		
	--Getting new Bundle products save cart data if addon is present for any line item
	INSERT INTO #NewBundleSaveForLaterLineitemDetails
	SELECT  Min(RowId )RowId ,OmsTemplateLineItemId, ParentOmsTemplateLineItemId, OmsTemplateId, AddOnValueIds
	,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
	,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
			WHEN  GroupProductIds <> '' THEN GroupProductIds 
			WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU , CustomUnitPrice
	FROM @SaveForLaterLineItemType  a 
	WHERE AddOnValueIds <> ''
	GROUP BY  OmsTemplateLineItemId, ParentOmsTemplateLineItemId, OmsTemplateId, AddOnValueIds
	,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU,CustomUnitPrice

    CREATE TABLE #OldBundleSaveForLaterLineitemDetails (OmsTemplateId INT ,OmsTemplateLineItemId INT,ParentOmsTemplateLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old bundle save cart data if present for same SKU in the new save cart data for bundle product		 
	INSERT INTO #OldBundleSaveForLaterLineitemDetails  
	SELECT  a.OmsTemplateId,a.OmsTemplateLineItemId,a.ParentOmsTemplateLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM ZnodeOmsTemplateLineItem a   
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveForLaterLineItemType  TY WHERE TY.OmsTemplateId = a.OmsTemplateId AND ISNULL(a.SKU,'') = ISNULL(TY.BundleProductIds,'')   )   
    AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle   

	--Getting the old save cart Parent data
	INSERT INTO #OldBundleSaveForLaterLineitemDetails 
	SELECT DISTINCT b.OmsTemplateId,b.OmsTemplateLineItemId,b.ParentOmsTemplateLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsTemplateLineItem b 
	INNER JOIN #OldBundleSaveForLaterLineitemDetails c ON (c.ParentOmsTemplateLineItemId  = b.OmsTemplateLineItemId AND c.OmsTemplateId = b.OmsTemplateId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveForLaterLineItemType  TY WHERE TY.OmsTemplateId = b.OmsTemplateId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
	AND  b.OrderLineItemRelationshipTypeID IS NULL 

	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldBundleSaveForLaterLineitemDetails

	DELETE a FROM #OldBundleSaveForLaterLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldBundleSaveForLaterLineitemDetails b WHERE b.ParentOmsTemplateLineItemId IS NULL AND b.OmsTemplateLineItemId = a.ParentOmsTemplateLineItemId)
	AND a.ParentOmsTemplateLineItemId IS NOT NULL 

	--Getting the old bundle product save cart addon data for old line items if present
	INSERT INTO #OldBundleSaveForLaterLineitemDetails 
	SELECT b.OmsTemplateId,b.OmsTemplateLineItemId,b.ParentOmsTemplateLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsTemplateLineItem b 
	INNER JOIN #OldBundleSaveForLaterLineitemDetails c ON (c.OmsTemplateLineItemId  = b.ParentOmsTemplateLineItemId AND c.OmsTemplateId = b.OmsTemplateId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveForLaterLineItemType  TY WHERE TY.OmsTemplateId = b.OmsTemplateId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
	AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon	

		------Merge Addon for same product
		IF EXISTS(SELECT * FROM @SaveForLaterLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
		BEGIN

			INSERT INTO #OldValueForAddon 
			SELECT b.OmsTemplateId,b.OmsTemplateLineItemId,b.ParentOmsTemplateLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
			FROM ZnodeOmsTemplateLineItem b 
			INNER JOIN #OldValueForAddon c ON (c.OmsTemplateLineItemId  = b.ParentOmsTemplateLineItemId AND c.OmsTemplateId = b.OmsTemplateId)
			WHERE EXISTS (SELECT TOP 1 1 FROM @SaveForLaterLineItemType  TY WHERE TY.OmsTemplateId = b.OmsTemplateId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
			AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
									( SELECT  ', ' + SKU FROM    
										( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
											WHERE a.ParentOmsTemplateLineItemId=b.ParentOmsTemplateLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
											FOR XML PATH('')
									), 1, 2, ''
									) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a WHERE a.ParentOmsTemplateLineItemId is not null and OrderLineItemRelationshipTypeID<>1

		SELECT distinct a.BundleProductIds SKU, STUFF(
										( SELECT  ', ' + x.AddOnValueIds FROM    
										( SELECT DISTINCT b.AddOnValueIds FROM @SaveForLaterLineItemType b
											WHERE a.SKU=b.SKU ) x
											FOR XML PATH('')
										), 1, 2, ''
									) AddOns
		INTO #AddOnAdded
		FROM @SaveForLaterLineItemType a

		IF NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
		BEGIN
			DELETE FROM #OldBundleSaveForLaterLineitemDetails
		END

		END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSaveForLaterLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @SaveForLaterLineItemType ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldBundleSaveForLaterLineitemDetails a WHERE	
	ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
	AND EXISTS (SELECT TOP 1 1 FROM @SaveForLaterLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN 
		
		DELETE FROM #OldBundleSaveForLaterLineitemDetails 
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @SaveForLaterLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
		BEGIN 

			 DECLARE @parenTofAddon INT  = 0 
			 SET @parenTofAddon = (SELECT TOP 1 ParentOmsTemplateLineItemId 
			 FROM #OldBundleSaveForLaterLineitemDetails a
			 WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
			 AND (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsTemplateLineItem  t WHERE t.ParentOmsTemplateLineItemId = a.ParentOmsTemplateLineItemId AND   t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSaveForLaterLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			  )

			 DELETE FROM #OldBundleSaveForLaterLineitemDetails WHERE ParentOmsTemplateLineItemId <> @parenTofAddon  AND ParentOmsTemplateLineItemId IS NOT NULL  

			 DELETE FROM #OldBundleSaveForLaterLineitemDetails WHERE OmsTemplateLineItemId NOT IN (SELECT ISNULL(m.ParentOmsTemplateLineItemId,0) FROM #OldBundleSaveForLaterLineitemDetails m)
			 AND ParentOmsTemplateLineItemId IS  NULL  
		 
			 IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldBundleSaveForLaterLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSaveForLaterLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			  BEGIN 
				DELETE FROM #OldBundleSaveForLaterLineitemDetails
			  END 
			IF (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsTemplateLineItem   WHERE ParentOmsTemplateLineItemId =@parenTofAddon AND   OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSaveForLaterLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			BEGIN 
				DELETE FROM #OldBundleSaveForLaterLineitemDetails
			END 

		 END 
		 ELSE IF (SELECT COUNT (OmsTemplateLineItemId) FROM #OldBundleSaveForLaterLineitemDetails WHERE ParentOmsTemplateLineItemId IS NULL ) >= 1 
		 BEGIN 
		    DECLARE @TBL_deleteParentOmsTemplateLineItemId TABLE (OmsTemplateLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsTemplateLineItemId 
			SELECT ParentOmsTemplateLineItemId
			FROM ZnodeOmsTemplateLineItem a 
			WHERE ParentOmsTemplateLineItemId IN (SELECT OmsTemplateLineItemId FROM #OldBundleSaveForLaterLineitemDetails WHERE ParentOmsTemplateLineItemId IS NULL )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldBundleSaveForLaterLineitemDetails WHERE OmsTemplateLineItemId IN (SELECT OmsTemplateLineItemId FROM @TBL_deleteParentOmsTemplateLineItemId)
			OR ParentOmsTemplateLineItemId IN (SELECT OmsTemplateLineItemId FROM @TBL_deleteParentOmsTemplateLineItemId)
		 END 
		 ELSE IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldBundleSaveForLaterLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSaveForLaterLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  BEGIN 
		    DELETE FROM #OldBundleSaveForLaterLineitemDetails
		  END 
		   ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsTemplateLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldBundleSaveForLaterLineitemDetails ty WHERE ty.OmsTemplateId = wt.OmsTemplateId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle AND wt.ParentOmsTemplateLineItemId= ty.OmsTemplateLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		      AND EXISTS (SELECT TOP 1 1 FROM @SaveForLaterLineItemType WHERE ISNULL(AddOnValueIds,'')  = '' )
		 BEGIN 
		   DELETE FROM #OldBundleSaveForLaterLineitemDetails
		 END 

	END 
	
	--Getting the personalise data for old save cart if present
	DECLARE @TBL_Personaloldvalues TABLE (OmsTemplateLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsTemplateLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsTemplatePersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldBundleSaveForLaterLineitemDetails TY WHERE TY.OmsTemplateLineItemId = a.OmsTemplateLineItemId)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		DELETE FROM #OldBundleSaveForLaterLineitemDetails
	END 
	ELSE 
	BEGIN 
		 IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsTemplateLineItemId ) FROM #OldBundleSaveForLaterLineitemDetails WHERE ParentOmsTemplateLineItemId IS nULL ) > 1 
		 AND (SELECT COUNT (DISTINCT OmsTemplateLineItemId ) FROM #OldBundleSaveForLaterLineitemDetails WHERE ParentOmsTemplateLineItemId IS nULL ) <>
		     (SELECT COUNT (DISTINCT OmsTemplateLineItemId ) FROM ZnodeOmsTemplateLineItem WHERE ParentOmsTemplateLineItemId IS nULL and OmsTemplateLineItemId in (select OmsTemplateLineItemId FROM #OldBundleSaveForLaterLineitemDetails)  )
		 BEGIN 
		   
			   DELETE FROM #OldBundleSaveForLaterLineitemDetails WHERE OmsTemplateLineItemId IN (
			   SELECT OmsTemplateLineItemId FROM #OldBundleSaveForLaterLineitemDetails WHERE OmsTemplateLineItemId NOT IN (SELECT OmsTemplateLineItemId FROM @TBL_Personaloldvalues )
			   AND ParentOmsTemplateLineItemId NOT IN (SELECT OmsTemplateLineItemId FROM @TBL_Personaloldvalues ) ) 
			   OR OmsTemplateLineItemId IN ( SELECT ParentOmsTemplateLineItemId FROM #OldBundleSaveForLaterLineitemDetails WHERE OmsTemplateLineItemId NOT IN (SELECT OmsTemplateLineItemId FROM @TBL_Personaloldvalues )
			   AND ParentOmsTemplateLineItemId NOT IN (SELECT OmsTemplateLineItemId FROM @TBL_Personaloldvalues ))
		 
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsTemplateLineItemId ) FROM #OldBundleSaveForLaterLineitemDetails WHERE ParentOmsTemplateLineItemId IS nULL ) > 1 
		 AND (SELECT COUNT (DISTINCT OmsTemplateLineItemId ) FROM #OldBundleSaveForLaterLineitemDetails WHERE ParentOmsTemplateLineItemId IS nULL ) <>
		     (SELECT COUNT (DISTINCT OmsTemplateLineItemId ) FROM ZnodeOmsTemplateLineItem WHERE ParentOmsTemplateLineItemId IS nULL and OmsTemplateLineItemId in (select OmsTemplateLineItemId FROM #OldBundleSaveForLaterLineitemDetails)  )
		 BEGIN 
		   
			   DELETE n FROM #OldBundleSaveForLaterLineitemDetails n WHERE OmsTemplateLineItemId  IN (SELECT OmsTemplateLineItemId FROM ZnodeOmsTemplatePersonalizeCartItem WHERE n.OmsTemplateLineItemId = ZnodeOmsTemplatePersonalizeCartItem.OmsTemplateLineItemId  )
			   OR ParentOmsTemplateLineItemId  IN (SELECT OmsTemplateLineItemId FROM ZnodeOmsTemplatePersonalizeCartItem   )
		
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		        AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsTemplatePersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldBundleSaveForLaterLineitemDetails YU WHERE YU.OmsTemplateLineItemId = m.OmsTemplateLineItemId )) 
		       AND (SELECT COUNT (DISTINCT OmsTemplateLineItemId ) FROM #OldBundleSaveForLaterLineitemDetails WHERE ParentOmsTemplateLineItemId IS nULL ) = 1
		 BEGIN 
		     DELETE FROM #OldBundleSaveForLaterLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		 END 
		END 

	IF EXISTS (SELECT TOP 1 1 FROM #OldBundleSaveForLaterLineitemDetails )
	BEGIN 
		----DELETE old value FROM table which having personalise data in ZnodeOmsTemplatePersonalizeCartItem but same SKU not having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*
			FROM @SaveForLaterLineItemType a 
			INNER JOIN #OldBundleSaveForLaterLineitemDetails b on ( a.BundleProductIds = b.SKU or a.SKU = b.sku)
			WHERE isnull(cast(a.PersonalisedAttribute AS varchar(max)),'') = ''
		)
		,cte2 AS
		(
			select a.ParentOmsTemplateLineItemId
			FROM #OldBundleSaveForLaterLineitemDetails a
			INNER JOIN ZnodeOmsTemplatePersonalizeCartItem b on b.OmsTemplateLineItemId = a.OmsTemplateLineItemId
		)
		DELETE a FROM #OldBundleSaveForLaterLineitemDetails a
		INNER JOIN cte b on a.OmsTemplateLineItemId = b.OmsTemplateLineItemId
		INNER JOIN cte2 c on (a.OmsTemplateLineItemId = c.ParentOmsTemplateLineItemId or a.ParentOmsTemplateLineItemId = c.ParentOmsTemplateLineItemId)

		----DELETE old value FROM table which having personalise data in ZnodeOmsTemplatePersonalizeCartItem but same SKU having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*, 
				a.PersonalizeCode
				,a.PersonalizeValue
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSaveForLaterLineitemDetails b on ( a.BundleProductIds = b.SKU )
			WHERE isnull(a.PersonalizeValue,'') <> ''
		)
		,cte2 AS
		(
			select a.ParentOmsTemplateLineItemId, b.PersonalizeCode, b.PersonalizeValue
			FROM #OldBundleSaveForLaterLineitemDetails a
			INNER JOIN ZnodeOmsTemplatePersonalizeCartItem b on b.OmsTemplateLineItemId = a.OmsTemplateLineItemId
			WHERE NOT EXISTS(SELECT * FROM cte c WHERE b.OmsTemplateLineItemId = c.OmsTemplateLineItemId and b.PersonalizeCode = c.PersonalizeCode 
								and b.PersonalizeValue = c.PersonalizeValue )
		)
		DELETE a FROM #OldBundleSaveForLaterLineitemDetails a
		INNER JOIN cte b on a.OmsTemplateLineItemId = b.OmsTemplateLineItemId
		INNER JOIN cte2 c on (a.OmsTemplateLineItemId = c.ParentOmsTemplateLineItemId or a.ParentOmsTemplateLineItemId = c.ParentOmsTemplateLineItemId)

		;WITH cte AS
		(
			SELECT b.OmsTemplateLineItemId ,b.ParentOmsTemplateLineItemId , a.BundleProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSaveForLaterLineitemDetails b on a.BundleProductIds = b.SKU
			INNER JOIN ZnodeOmsTemplatePersonalizeCartItem c on b.OmsTemplateLineItemId = c.OmsTemplateLineItemId
			WHERE a.OmsTemplateLineItemId = 0
		)
		DELETE b1
		FROM #OldBundleSaveForLaterLineitemDetails b1 
		WHERE NOT EXISTS(SELECT * FROM cte c WHERE (b1.OmsTemplateLineItemId = c.ParentOmsTemplateLineItemId or b1.ParentOmsTemplateLineItemId = c.ParentOmsTemplateLineItemId))
		AND EXISTS(SELECT * FROM cte)

		-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsTemplateLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSaveForLaterLineitemDetails b ON a.BundleProductIds = b.SKU
			LEFT JOIN ZnodeOmsTemplatePersonalizeCartItem c ON b.OmsTemplateLineItemId = c.OmsTemplateLineItemId 
			--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsTemplateLineItemId,0) = 0
			GROUP BY b.OmsTemplateLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsTemplateLineItemId,0) as OmsTemplateLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewBundleSaveForLaterLineitemDetails b ON a.BundleProductIds = b.SKU
			WHERE isnull(a.OmsTemplateLineItemId,0) = 0
			GROUP BY a.OmsTemplateLineItemId ,b.SKU
		)
		DELETE c
		from CTE_OldPersonalizeCodeCount a
		inner join CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		inner join #OldBundleSaveForLaterLineitemDetails c on b.SKU = c.SKU and a.OmsTemplateLineItemId = c.OmsTemplateLineItemId
	
		--Delete parent entry if child not present
		DELETE a FROM #OldBundleSaveForLaterLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldBundleSaveForLaterLineitemDetails b where a.OmsTemplateLineItemId = b.ParentOmsTemplateLineItemId)
		AND a.ParentOmsTemplateLineItemId IS NULL

		--------If lineitem present in ZnodeOmsTemplatePersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsTemplatePersonalizeCartItem and personalize value is same for same line item then Quantity will added
		;WITH cte AS
		(
			SELECT b.OmsTemplateLineItemId ,a.ParentOmsTemplateLineItemId , a.BundleProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSaveForLaterLineitemDetails b on a.BundleProductIds = b.SKU
			INNER JOIN ZnodeOmsTemplatePersonalizeCartItem c on b.OmsTemplateLineItemId = c.OmsTemplateLineItemId
			WHERE a.OmsTemplateLineItemId = 0
		)
		DELETE c1
		FROM cte a1		  
		INNER JOIN #OldBundleSaveForLaterLineitemDetails b1 on a1.SKU = b1.SKU
		INNER JOIN #OldBundleSaveForLaterLineitemDetails c1 on (b1.ParentOmsTemplateLineItemId = c1.OmsTemplateLineItemId OR b1.OmsTemplateLineItemId = c1.OmsTemplateLineItemId)
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsTemplatePersonalizeCartItem c WHERE a1.OmsTemplateLineItemId = c.OmsTemplateLineItemId and a1.PersonalizeValue = c.PersonalizeValue)

		--Updating the cart if old and new cart data matches	
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5,
		a.ModifiedDate = @GetDate,
		a.CustomUnitPrice = ty.CustomUnitPrice
		FROM ZnodeOmsTemplateLineItem a
		INNER JOIN #OldBundleSaveForLaterLineitemDetails b ON (a.OmsTemplateLineItemId = b.OmsTemplateLineItemId)
		INNER JOIN #NewBundleSaveForLaterLineitemDetails ty ON (ty.SKU = b.SKU)
		WHERE a.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon

		 UPDATE a
		 SET a.Quantity = a.Quantity+s.AddOnQuantity,
		 a.ModifiedDate = @GetDate
		 FROM ZnodeOmsTemplateLineItem a
		 INNER JOIN #OldBundleSaveForLaterLineitemDetails b ON (a.ParentOmsTemplateLineItemId = b.OmsTemplateLineItemId)
		 INNER JOIN @SaveForLaterLineItemType S on a.OmsTemplateId = s.OmsTemplateId and a.SKU = s.AddOnValueIds
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon

		 --UPDATE Ab SET ab.Quantity = a.Quantity   
   --      FROM ZnodeOmsTemplateLineItem a  
   --      INNER JOIN ZnodeOmsTemplateLineItem ab ON (ab.OmsTemplateLineItemId = a.ParentOmsTemplateLineItemId)  
   --      INNER JOIN @SaveForLaterLineItemType b ON (a.OmsTemplateId = b.OmsTemplateId  )   
		 --WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle  

		 UPDATE Ab 
		 SET Ab.Quantity = Ab.Quantity+ty.Quantity,
		 Ab.Custom1 = ty.Custom1,
		 Ab.Custom2 = ty.Custom2,
		 Ab.Custom3 = ty.Custom3,
		 Ab.Custom4 = ty.Custom4,
		 Ab.Custom5 = ty.Custom5,
		 ab.ModifiedDate = @GetDate, 
		 ab.CustomUnitPrice = ty.CustomUnitPrice  
         FROM ZnodeOmsTemplateLineItem a  
         INNER JOIN ZnodeOmsTemplateLineItem ab ON (ab.OmsTemplateLineItemId = a.ParentOmsTemplateLineItemId)  
         INNER JOIN @SaveForLaterLineItemType b ON (a.OmsTemplateId = b.OmsTemplateId  ) 
		 INNER JOIN #NewBundleSaveForLaterLineitemDetails ty ON (ty.SKU = b.SKU)  
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle  
		 AND EXISTS(SELECT * FROM #OldBundleSaveForLaterLineitemDetails ov WHERE a.OmsTemplateLineItemId = ov.OmsTemplateLineItemId)  

	END 
	IF NOT EXISTS (SELECT TOP 1 1 FROM #OldBundleSaveForLaterLineitemDetails )
	BEGIN 
			
		UPDATE #NewBundleSaveForLaterLineitemDetails
		SET ParentSKU = (SELECT TOP 1 SKU FROM #NewBundleSaveForLaterLineitemDetails WHERE OrderLineItemRelationshipTypeID IS NULL )
		WHERE OrderLineItemRelationshipTypeID  = @OrderLineItemRelationshipTypeIdAddon 
		AND EXISTS (SELECT TOP 1 1 FROM #NewBundleSaveForLaterLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle) 
		
		--Getting the new save cart data and generating row no. for new save cart insert
		SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsTemplateLineItemId ,OmsTemplateId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU ,CustomUnitPrice 
		 INTO #InsertNewBundleSaveForLaterLineitem   
		 FROM  #NewBundleSaveForLaterLineitemDetails  
		 GROUP BY ParentOmsTemplateLineItemId ,OmsTemplateId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU ,CustomUnitPrice
		 ORDER BY RowId, Id   
   
		--Removing the line item having Quantity <=0 
		DELETE FROM #InsertNewBundleSaveForLaterLineitem WHERE Quantity <=0  

		;WITH Add_Dup AS
		(
			SELECT  Min(NewRowId)NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID 
			FROM  #InsertNewBundleSaveForLaterLineitem
			GROUP BY SKU ,ParentSKU  ,OrderLineItemRelationshipTypeID
			HAVING OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon	
		)
		DELETE FROM #InsertNewBundleSaveForLaterLineitem
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM Add_Dup WHERE Add_Dup.NewRowId = #InsertNewBundleSaveForLaterLineitem.NewRowId)
		AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		--Updating the rowid INTo new save cart line item AS new line item is merged INTo existing save cart item
		 ;WITH VTTY AS   
		(  
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
			   FROM #InsertNewBundleSaveForLaterLineitem m  
			INNER JOIN  #InsertNewBundleSaveForLaterLineitem TY1 ON TY1.SKU = m.ParentSKU   
			WHERE m.OrderLineItemRelationshipTypeID IN ( @OrderLineItemRelationshipTypeIdAddon , @OrderLineItemRelationshipTypeIdBundle)   
		)   
		UPDATE m1   
		SET m1.RowId = TYU.RowId  
		FROM #InsertNewBundleSaveForLaterLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  
      
		--Deleting the new save cart line item if cart line item is merged
		;WITH VTRET AS   
		(  
			SELECT RowId,id,Min(NewRowId)NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID   
			FROM #InsertNewBundleSaveForLaterLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU  ,OrderLineItemRelationshipTypeID  
			Having  SKU = ParentSKU  AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		)   
		DELETE FROM #InsertNewBundleSaveForLaterLineitem WHERE NewRowId  IN (SELECT NewRowId FROM VTRET)   
     
	   --Inserting the new cart line item if not merged in existing save cart line item
       INSERT INTO  ZnodeOmsTemplateLineItem (ParentOmsTemplateLineItemId ,OmsTemplateId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description,CustomUnitPrice)  
       OUTPUT INSERTED.OmsTemplateLineItemId  INTO @OmsInsertedData 
	   SELECT NULL ,OmsTemplateId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description , CustomUnitPrice 
       FROM  #InsertNewBundleSaveForLaterLineitem  TH  

		SELECT  MAX(a.OmsTemplateLineItemId ) OmsTemplateLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU 
		INTO #Cte_newData 
		FROM ZnodeOmsTemplateLineItem a  
		INNER JOIN #InsertNewBundleSaveForLaterLineitem b ON (a.OmsTemplateId = b.OmsTemplateId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsTemplateLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsTemplateLineItemId = a.OmsTemplateLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			

		UPDATE a SET a.ParentOmsTemplateLineItemId = (SELECT TOP 1 OmsTemplateLineItemId FROM  #Cte_newData  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsTemplateLineItem a  
		INNER JOIN #InsertNewBundleSaveForLaterLineitem b ON (a.OmsTemplateId = b.OmsTemplateId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
		AND a.ParentOmsTemplateLineItemId IS nULL  
		AND  EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsTemplateLineItemId = a.OmsTemplateLineItemId ) 
  
		--------------------------------------------------------------------------------------------------------

		SELECT  MIN(a.OmsTemplateLineItemId ) OmsTemplateLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU  
		INTO #ParentOmsTemplateId
		FROM ZnodeOmsTemplateLineItem a  
		INNER JOIN #InsertNewBundleSaveForLaterLineitem b ON (a.OmsTemplateId = b.OmsTemplateId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsTemplateLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsTemplateLineItemId = a.OmsTemplateLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			

		UPDATE a SET a.ParentOmsTemplateLineItemId = (SELECT TOP 1 OmsTemplateLineItemId FROM  #ParentOmsTemplateId  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsTemplateLineItem a  
		INNER JOIN #InsertNewBundleSaveForLaterLineitem b ON (a.OmsTemplateId = b.OmsTemplateId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon   
		AND  EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsTemplateLineItemId = a.OmsTemplateLineItemId ) 
		AND  a.sequence in (SELECT  MIN(ab.sequence) FROM ZnodeOmsTemplateLineItem ab WHERE a.OmsTemplateId = ab.OmsTemplateId and 
		 a.SKU = ab.sku and ab.OrderLineItemRelationshipTypeId is not null  ) 

		-----------------------------------------------------------------------------------------------------

		SELECT a.OmsTemplateLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(Order BY c.OmsTemplateLineItemId )RowIdNo
		INTO #NewBuldleProduct
		FROM ZnodeOmsTemplateLineItem a  
		INNER JOIN #InsertNewBundleSaveForLaterLineitem b ON (a.OmsTemplateId = b.OmsTemplateId AND a.SKU = b.ParentSKU AND ( CASE WHEN EXISTS (SELECT TOP 1 1 FROM #NewBundleSaveForLaterLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle) THEN 0 ELSE 1 END = b.id OR b.Id = 1  ))  
		INNER JOIN ZnodeOmsTemplateLineItem c on b.sku = c.sku and b.OmsTemplateId=c.OmsTemplateId and b.Id = 1
		WHERE ( CASE WHEN EXISTS (SELECT TOP 1 1 FROM #NewBundleSaveForLaterLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle) THEN 0 ELSE 1 END = ISNULL(a.ParentOmsTemplateLineItemId,0) OR ISNULL(a.ParentOmsTemplateLineItemId,0) <> 0   )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  AND c.ParentOmsTemplateLineItemId IS NULL
			AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewBundleSaveForLaterLineitem ty WHERE ty.OmsTemplateId = a.OmsTemplateId)  
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsTemplateLineItemId = a.OmsTemplateLineItemId)

	   ;WITH table_update AS 
	   (
		 SELECT * , ROW_NUMBER()Over(Order BY OmsTemplateLineItemId  ) RowIdNo
		 FROM ZnodeOmsTemplateLineItem a
		 WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		 AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
		 AND a.ParentOmsTemplateLineItemId IS NULL  
		 AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewBundleSaveForLaterLineitem ty WHERE ty.OmsTemplateId = a.OmsTemplateId )
		 AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsTemplateLineItemId = a.OmsTemplateLineItemId )
	   )
		UPDATE a SET a.ParentOmsTemplateLineItemId = (SELECT TOP 1 max(OmsTemplateLineItemId) 
		FROM #NewBuldleProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewBundleSaveForLaterLineitem b ON (a.OmsTemplateId = b.OmsTemplateId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsTemplateLineItemId) 
			FROM #NewBuldleProduct  r  
			WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )    IS NOT NULL 
	 
  
		;WITH Cte_Th AS   
		(             
			  SELECT RowId    
			 FROM #InsertNewBundleSaveForLaterLineitem a   
			 GROUP BY RowId   
			 HAVING COUNT(NewRowId) <= 1   
		)   
		UPDATE a SET a.Quantity =  NULL,
			a.ModifiedDate = @GetDate   
		FROM ZnodeOmsTemplateLineItem a  
		INNER JOIN #InsertNewBundleSaveForLaterLineitem b ON (a.OmsTemplateId = b.OmsTemplateId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		 AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE Ab SET ab.Quantity = a.Quantity,
			ab.ModifiedDate = @GetDate, ab.CustomUnitPrice = b.CustomUnitPrice   
		FROM ZnodeOmsTemplateLineItem a  
		INNER JOIN ZnodeOmsTemplateLineItem ab ON (ab.OmsTemplateLineItemId = a.ParentOmsTemplateLineItemId)  
		INNER JOIN @SaveForLaterLineItemType b ON (a.OmsTemplateId = b.OmsTemplateId  )   
		WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle  

		UPDATE  ZnodeOmsTemplateLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewBundleSaveForLaterLineitem RT WHERE RT.OmsTemplateId = ZnodeOmsTemplateLineItem.OmsTemplateId )  
		AND OrderLineItemRelationshipTypeId IS NOT NULL     
       
	   ;WITH Cte_UpdateSequence AS   
		 (  
		   SELECT OmsTemplateLineItemId ,Row_Number()Over(Order By OmsTemplateLineItemId) RowId , Sequence   
		   FROM ZnodeOmsTemplateLineItem   
		   WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewBundleSaveForLaterLineitem TH WHERE TH.OmsTemplateId = ZnodeOmsTemplateLineItem.OmsTemplateId )  
		 )   
		UPDATE Cte_UpdateSequence  
		SET  Sequence = RowId  
			
		UPDATE @TBL_Personalise
		SET OmsTemplateLineItemId = b.OmsTemplateLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN ZnodeOmsTemplateLineItem b ON (a.OmsTemplateLineItemId = b.OmsTemplateLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsTemplateLineItemId IS not nULL
		and b.OmsTemplateLineItemId = (select min(OmsTemplateLineItemId) FROM @OmsInsertedData d WHERE b.OmsTemplateLineItemId = d.OmsTemplateLineItemId)
	 
		DELETE FROM ZnodeOmsTemplatePersonalizeCartItem	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsTemplateLineItemId = ZnodeOmsTemplatePersonalizeCartItem.OmsTemplateLineItemId )
			
		----Inserting saved cart item personalise value FROM given line item
		MERGE INTO ZnodeOmsTemplatePersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
			   ON (TARGET.OmsTemplateLineItemId = SOURCE.OmsTemplateLineItemId ) 
			   WHEN NOT MATCHED THEN 
				INSERT  ( OmsTemplateLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL, PersonalizeName )
				VALUES (  SOURCE.OmsTemplateLineItemId,  @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL, SOURCE.PersonalizeName) ;
  
		
		END 
END TRY
BEGIN CATCH 
  SELECT ERROR_MESSAGE()
END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveForLaterLineItemConfigurable')
	DROP PROC Znode_InsertUpdateSaveForLaterLineItemConfigurable
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveForLaterLineItemConfigurable]
(
	 @SaveForLaterLineItemType SaveForLaterLineitems READONLY
	,@Userid INT = 0 
	,@OrderLineItemRelationshipTypeIdConfigurable INT
	,@OrderLineItemRelationshipTypeIdAddon INT	
)
AS 
BEGIN 
	BEGIN TRY
	SET NOCOUNT ON 
	--Declared the variables
	DECLARE @GetDate datetime= dbo.Fn_GetDate(); 

	DECLARE @OmsInsertedData TABLE (OmsTemplateLineItemId INT, OmsTemplateId INT,SKU NVARCHAr(max),GroupId NVARCHAr(max),ParentOmsTemplateLineItemId INT,OrderLineItemRelationshipTypeId INT ) 
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise TABLE (OmsTemplateLineItemId INT, ParentOmsTemplateLineItemId INT,ConfigurableProductIds VARCHAR(600) ,PersonalizeCode NVARCHAR(MAX),PersonalizeValue NVARCHAR(MAX),DesignId NVARCHAR(MAX), ThumbnailURL NVARCHAR(MAX),PersonalizeName NVARCHAR(max))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsTemplateLineItemId,a.ConfigurableProductIds
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(MAX)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(MAX)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(MAX)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(MAX)' ) AS ThumbnailURL
			,Tbl.Col.value( 'PersonalizeName[1]', 'NVARCHAR(MAX)' ) AS PersonalizeName
	FROM @SaveForLaterLineItemType a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)

	 CREATE TABLE #NewConfigSaveForLaterLineitemDetails 
	 (
		 GenId INT IDENTITY(1,1), RowId	INT, OmsTemplateLineItemId	INT, ParentOmsTemplateLineItemId INT,OmsTemplateId INT
		,SKU NVARCHAR(MAX) ,Quantity	NUMERIC(28,6), OrderLineItemRelationshipTypeID	INT	,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	INT	,AutoAddon	VARCHAR(MAX)	,OmsOrderId	INT	,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX), Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX),
		CustomUnitPrice NUMERIC(28,6)
	)
	 
	--Getting new save cart data(configurable product)
	INSERT INTO #NewConfigSaveForLaterLineitemDetails
	SELECT MIN(RowId )RowId ,OmsTemplateLineItemId, ParentOmsTemplateLineItemId, OmsTemplateId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5, GroupId ,ProductName,MIN(Description) Description, 0 Id,NULL ParentSKU ,
		CustomUnitPrice
	FROM @SaveForLaterLineItemType a 
	GROUP BY OmsTemplateLineItemId, ParentOmsTemplateLineItemId, OmsTemplateId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,CustomUnitPrice
	 
	--Getting new configurable product save cart data
	INSERT INTO #NewConfigSaveForLaterLineitemDetails 
	SELECT MIN(RowId )RowId ,OmsTemplateLineItemId, ParentOmsTemplateLineItemId, OmsTemplateId, ConfigurableProductIds
		,Quantity, @OrderLineItemRelationshipTypeIdConfigurable, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU,
		CustomUnitPrice
	FROM @SaveForLaterLineItemType a 
	WHERE ConfigurableProductIds <> ''
	GROUP BY OmsTemplateLineItemId, ParentOmsTemplateLineItemId, OmsTemplateId, ConfigurableProductIds
		,Quantity, CustomText, CartAddOnDetails, Sequence ,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU,
		CustomUnitPrice
	
	--Getting new configurable products save cart data if addon is present for any line item
	INSERT INTO #NewConfigSaveForLaterLineitemDetails
	SELECT MIN(RowId )RowId ,OmsTemplateLineItemId, ParentOmsTemplateLineItemId, OmsTemplateId, AddOnValueIds
		,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
		,CASE WHEN ConfigurableProductIds <> '' THEN ConfigurableProductIds
			WHEN GroupProductIds <> '' THEN GroupProductIds 
			WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END ParentSKU ,CustomUnitPrice
	FROM @SaveForLaterLineItemType a 
	WHERE AddOnValueIds <> ''
	GROUP BY OmsTemplateLineItemId, ParentOmsTemplateLineItemId, OmsTemplateId, AddOnValueIds
		,AddOnQuantity, CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU,CustomUnitPrice
		 
	SELECT * 
	INTO #ZnodeOmsTemplateLineItem_NT
	FROM ZnodeOmsTemplateLineItem a 
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveForLaterLineItemType TY WHERE TY.OmsTemplateId = a.OmsTemplateId)

	CREATE TABLE #OldConfigSaveForLaterLineitemDetails (OmsTemplateId INT ,OmsTemplateLineItemId INT,ParentOmsTemplateLineItemId INT , SKU NVARCHAr(2000),OrderLineItemRelationshipTypeID INT )
	--Getting the old configurable save cart data if present for same SKU in the new save cart data for configurable product	 
	INSERT INTO #OldConfigSaveForLaterLineitemDetails
	SELECT a.OmsTemplateId,a.OmsTemplateLineItemId,a.ParentOmsTemplateLineItemId , a.SKU ,a.OrderLineItemRelationshipTypeID 
	FROM #ZnodeOmsTemplateLineItem_NT a
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveForLaterLineItemType TY WHERE TY.OmsTemplateId = a.OmsTemplateId AND ISNULL(a.SKU,'') = ISNULL(TY.ConfigurableProductIds,''))
		AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable

	--Getting the old save cart Parent data
	INSERT INTO #OldConfigSaveForLaterLineitemDetails 
	SELECT DISTINCT b.OmsTemplateId,b.OmsTemplateLineItemId,b.ParentOmsTemplateLineItemId , b.SKU, b.OrderLineItemRelationshipTypeID
	FROM #ZnodeOmsTemplateLineItem_NT b 
	INNER JOIN #OldConfigSaveForLaterLineitemDetails c ON (c.ParentOmsTemplateLineItemId = b.OmsTemplateLineItemId AND c.OmsTemplateId = b.OmsTemplateId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveForLaterLineItemType TY WHERE TY.OmsTemplateId = b.OmsTemplateId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-') )
		AND b.OrderLineItemRelationshipTypeID IS NULL 
		
	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldConfigSaveForLaterLineitemDetails

	DELETE a 
	FROM #OldConfigSaveForLaterLineitemDetails a 
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM #OldConfigSaveForLaterLineitemDetails b WHERE b.ParentOmsTemplateLineItemId IS NULL AND b.OmsTemplateLineItemId = a.ParentOmsTemplateLineItemId)
		AND a.ParentOmsTemplateLineItemId IS NOT NULL 

	INSERT INTO #OldConfigSaveForLaterLineitemDetails 
	SELECT b.OmsTemplateId,b.OmsTemplateLineItemId,b.ParentOmsTemplateLineItemId , b.SKU, b.OrderLineItemRelationshipTypeID
	FROM #ZnodeOmsTemplateLineItem_NT b 
	INNER JOIN #OldConfigSaveForLaterLineitemDetails c ON (c.OmsTemplateLineItemId = b.ParentOmsTemplateLineItemId AND c.OmsTemplateId = b.OmsTemplateId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveForLaterLineItemType TY WHERE TY.OmsTemplateId = b.OmsTemplateId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon
		
	------Merge Addon for same product
	IF EXISTS(SELECT * FROM @SaveForLaterLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
	BEGIN		
		INSERT INTO #OldValueForAddon 
		SELECT b.OmsTemplateId,b.OmsTemplateLineItemId,b.ParentOmsTemplateLineItemId , b.SKU, b.OrderLineItemRelationshipTypeID
		FROM #ZnodeOmsTemplateLineItem_NT b 
		INNER JOIN #OldValueForAddon c ON (c.OmsTemplateLineItemId = b.ParentOmsTemplateLineItemId AND c.OmsTemplateId = b.OmsTemplateId)
		WHERE EXISTS (SELECT TOP 1 1 FROM @SaveForLaterLineItemType TY WHERE TY.OmsTemplateId = b.OmsTemplateId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT DISTINCT SKU, STUFF(
									( SELECT ', ' + SKU FROM
										( SELECT DISTINCT SKU FROM #OldValueForAddon b 
											where a.OmsTemplateLineItemId=b.ParentOmsTemplateLineItemId AND OrderLineItemRelationshipTypeID = 1 ) x 
											FOR XML PATH('')
									), 1, 2, ''
									) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a
		WHERE a.ParentOmsTemplateLineItemId IS NOT NULL AND OrderLineItemRelationshipTypeID<>1

		SELECT DISTINCT a.ConfigurableProductIds SKU, STUFF(
										( SELECT ', ' + x.AddOnValueIds FROM
										( SELECT DISTINCT b.AddOnValueIds FROM @SaveForLaterLineItemType b
											where a.SKU=b.SKU ) x
											FOR XML PATH('')
										), 1, 2, ''
									) AddOns
		INTO #AddOnAdded
		FROM @SaveForLaterLineItemType a

		IF NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b ON a.SKU = b.SKU AND a.AddOns = b.AddOns )
		BEGIN
			DELETE FROM #OldConfigSaveForLaterLineitemDetails
		END
	END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSaveForLaterLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1 FROM @SaveForLaterLineItemType ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldConfigSaveForLaterLineitemDetails a WHERE	
		ISNULL(TY.AddOnValueIds,'') = a.SKU AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
		AND EXISTS (SELECT TOP 1 1 FROM @SaveForLaterLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
	BEGIN
		DELETE FROM #OldConfigSaveForLaterLineitemDetails 
	END
	ELSE 
	BEGIN
		 IF EXISTS (SELECT TOP 1 1 FROM @SaveForLaterLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
		 BEGIN 
			 DECLARE @parenTofAddon TABLE( ParentOmsTemplateLineItemId INT)
			 INSERT INTO @parenTofAddon 
			 SELECT ParentOmsTemplateLineItemId 
			 FROM #OldConfigSaveForLaterLineitemDetails a 
			 WHERE a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
				AND (SELECT COUNT (DISTINCT SKU ) FROM #ZnodeOmsTemplateLineItem_NT t WHERE t.ParentOmsTemplateLineItemId = a.ParentOmsTemplateLineItemId AND t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM #NewConfigSaveForLaterLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon)

			 DELETE 
			 FROM #OldConfigSaveForLaterLineitemDetails 
			 WHERE OmsTemplateLineItemId NOT IN (SELECT ParentOmsTemplateLineItemId FROM @parenTofAddon)
				AND ParentOmsTemplateLineItemId IS NOT NULL 
				AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

			 DELETE 
			 FROM #OldConfigSaveForLaterLineitemDetails 
			 WHERE OmsTemplateLineItemId NOT IN (SELECT ISNULL(m.ParentOmsTemplateLineItemId,0) FROM #OldConfigSaveForLaterLineitemDetails m)
				AND ParentOmsTemplateLineItemId IS NULL 
		 
			 IF (SELECT COUNT (DISTINCT SKU ) FROM #OldConfigSaveForLaterLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM #NewConfigSaveForLaterLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon )
			 BEGIN 
				DELETE FROM #OldConfigSaveForLaterLineitemDetails 
			 END 
			 IF (SELECT COUNT (DISTINCT SKU ) FROM #ZnodeOmsTemplateLineItem_NT WHERE ParentOmsTemplateLineItemId IN (SELECT ParentOmsTemplateLineItemId FROM @parenTofAddon)AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM #NewConfigSaveForLaterLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon )
			 BEGIN 
				DELETE FROM #OldConfigSaveForLaterLineitemDetails 
			 END 
		 END 
		 ELSE IF (SELECT COUNT (OmsTemplateLineItemId) FROM #OldConfigSaveForLaterLineitemDetails WHERE ParentOmsTemplateLineItemId IS NULL ) > 1 
		 BEGIN 
			-- SELECT 3
			DECLARE @TBL_deleteParentOmsTemplateLineItemId TABLE (OmsTemplateLineItemId INT )

			INSERT INTO @TBL_deleteParentOmsTemplateLineItemId 
			SELECT ParentOmsTemplateLineItemId
			FROM #ZnodeOmsTemplateLineItem_NT a
			WHERE ParentOmsTemplateLineItemId IN (SELECT OmsTemplateLineItemId FROM #OldConfigSaveForLaterLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable )
				AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

			DELETE 
			FROM #OldConfigSaveForLaterLineitemDetails WHERE OmsTemplateLineItemId IN (SELECT OmsTemplateLineItemId FROM @TBL_deleteParentOmsTemplateLineItemId)
				OR ParentOmsTemplateLineItemId IN (SELECT OmsTemplateLineItemId FROM @TBL_deleteParentOmsTemplateLineItemId)
		 
			 DELETE 
			 FROM #OldConfigSaveForLaterLineitemDetails 
			 WHERE OmsTemplateLineItemId NOT IN (SELECT ISNULL(m.ParentOmsTemplateLineItemId,0) FROM #OldConfigSaveForLaterLineitemDetails m)
				AND ParentOmsTemplateLineItemId IS NULL
		 END
		 ELSE IF (SELECT COUNT (DISTINCT SKU ) FROM #OldConfigSaveForLaterLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM #NewConfigSaveForLaterLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon )
		 BEGIN 
			DELETE FROM #OldConfigSaveForLaterLineitemDetails 
		 END 
		 ELSE IF EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsTemplateLineItem_NT Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldConfigSaveForLaterLineitemDetails ty WHERE ty.OmsTemplateId = wt.OmsTemplateId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable AND wt.ParentOmsTemplateLineItemId= ty.OmsTemplateLineItemId ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
			AND EXISTS (SELECT TOP 1 1 FROM @SaveForLaterLineItemType WHERE ISNULL(AddOnValueIds,'') = '' )
		 BEGIN 
			DELETE FROM #OldConfigSaveForLaterLineitemDetails 
		 END 
	END 

	DECLARE @TBL_Personaloldvalues TABLE (OmsTemplateLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	--Getting the personalise data for old save cart if present		
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsTemplateLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsTemplatePersonalizeCartItem a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldConfigSaveForLaterLineitemDetails TY WHERE TY.OmsTemplateLineItemId = a.OmsTemplateLineItemId)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
	IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		 DELETE FROM #OldConfigSaveForLaterLineitemDetails 
	END 
	ELSE 
	BEGIN 
		 IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
			AND (SELECT COUNT (DISTINCT OmsTemplateLineItemId ) FROM #OldConfigSaveForLaterLineitemDetails WHERE ParentOmsTemplateLineItemId IS nULL ) > 1 
		 BEGIN 
			 DELETE FROM #OldConfigSaveForLaterLineitemDetails WHERE OmsTemplateLineItemId IN (
			 SELECT OmsTemplateLineItemId 
			 FROM #OldConfigSaveForLaterLineitemDetails 
			 WHERE OmsTemplateLineItemId NOT IN (SELECT OmsTemplateLineItemId FROM @TBL_Personaloldvalues )
				 AND ParentOmsTemplateLineItemId NOT IN (SELECT OmsTemplateLineItemId FROM @TBL_Personaloldvalues ) ) 
				 OR OmsTemplateLineItemId IN ( SELECT ParentOmsTemplateLineItemId FROM #OldConfigSaveForLaterLineitemDetails WHERE OmsTemplateLineItemId NOT IN (SELECT OmsTemplateLineItemId FROM @TBL_Personaloldvalues )
				 AND ParentOmsTemplateLineItemId NOT IN (SELECT OmsTemplateLineItemId FROM @TBL_Personaloldvalues ))
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
			AND (SELECT COUNT (DISTINCT OmsTemplateLineItemId ) FROM #OldConfigSaveForLaterLineitemDetails WHERE ParentOmsTemplateLineItemId IS nULL ) > 1 
		BEGIN 
			 DELETE n
			 FROM #OldConfigSaveForLaterLineitemDetails n 
			 WHERE OmsTemplateLineItemId IN (SELECT OmsTemplateLineItemId FROM ZnodeOmsTemplatePersonalizeCartItem WHERE n.OmsTemplateLineItemId = ZnodeOmsTemplatePersonalizeCartItem.OmsTemplateLineItemId )
				OR ParentOmsTemplateLineItemId IN (SELECT OmsTemplateLineItemId FROM ZnodeOmsTemplatePersonalizeCartItem )
	
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise)
			 AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsTemplatePersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldConfigSaveForLaterLineitemDetails YU WHERE YU.OmsTemplateLineItemId = m.OmsTemplateLineItemId )) 
			 AND (SELECT COUNT (DISTINCT OmsTemplateLineItemId ) FROM #OldConfigSaveForLaterLineitemDetails WHERE ParentOmsTemplateLineItemId IS nULL ) = 1
		BEGIN 
			DELETE FROM #OldConfigSaveForLaterLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise)
		END 
	END 

	IF EXISTS (SELECT TOP 1 1 FROM #OldConfigSaveForLaterLineitemDetails )
	BEGIN
		--------If lineitem present in ZnodeOmsTemplatePersonalizeCartItem AND personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsTemplatePersonalizeCartItem AND personalize value is same for same line item then Quantity will added
		;WITH cte AS
		(
			SELECT b.OmsTemplateLineItemId ,a.ParentOmsTemplateLineItemId , a.ConfigurableProductIds AS SKU
					,a.PersonalizeCode
			 		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldConfigSaveForLaterLineitemDetails b ON a.ConfigurableProductIds = b.SKU
			INNER JOIN ZnodeOmsTemplatePersonalizeCartItem c ON b.OmsTemplateLineItemId = c.OmsTemplateLineItemId
			WHERE a.OmsTemplateLineItemId = 0
		)
		DELETE c1
		FROM cte a1		 
		INNER JOIN #OldConfigSaveForLaterLineitemDetails b1 ON a1.SKU = b1.SKU
		INNER JOIN #OldConfigSaveForLaterLineitemDetails c1 ON (b1.ParentOmsTemplateLineItemId = c1.OmsTemplateLineItemId OR b1.OmsTemplateLineItemId = c1.OmsTemplateLineItemId)
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsTemplatePersonalizeCartItem c where a1.OmsTemplateLineItemId = c.OmsTemplateLineItemId AND a1.PersonalizeValue = c.PersonalizeValue)
		-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsTemplateLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldConfigSaveForLaterLineitemDetails b ON a.ConfigurableProductIds = b.SKU
			INNER JOIN ZnodeOmsTemplatePersonalizeCartItem c ON b.OmsTemplateLineItemId = c.OmsTemplateLineItemId 
			--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsTemplateLineItemId,0) = 0
			GROUP BY b.OmsTemplateLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsTemplateLineItemId,0) as OmsTemplateLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewConfigSaveForLaterLineitemDetails b ON a.ConfigurableProductIds = b.SKU
			WHERE isnull(a.OmsTemplateLineItemId,0) = 0
			GROUP BY a.OmsTemplateLineItemId ,b.SKU
		)
		DELETE c
		FROM CTE_OldPersonalizeCodeCount a
		INNER JOIN CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		INNER JOIN #OldConfigSaveForLaterLineitemDetails c on b.SKU = c.SKU and a.OmsTemplateLineItemId = c.OmsTemplateLineItemId
		
		--Delete parent entry if child not present
		DELETE a FROM #OldConfigSaveForLaterLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldConfigSaveForLaterLineitemDetails b where a.OmsTemplateLineItemId = b.ParentOmsTemplateLineItemId)
		AND a.ParentOmsTemplateLineItemId IS NULL

		--Updating the cart if old and new cart data matches
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5,
		a.ModifiedDate = @GetDate ,
		a.CustomUnitPrice = ty.CustomUnitPrice
		FROM ZnodeOmsTemplateLineItem a
		INNER JOIN #OldConfigSaveForLaterLineitemDetails b ON (a.OmsTemplateLineItemId = b.OmsTemplateLineItemId)
		INNER JOIN #NewConfigSaveForLaterLineitemDetails ty ON (ty.SKU = b.SKU)
		WHERE a.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon
		 
		 UPDATE a
		 SET a.Quantity = a.Quantity+s.AddOnQuantity,
		 a.ModifiedDate = @GetDate
		 FROM ZnodeOmsTemplateLineItem a
		 INNER JOIN #OldConfigSaveForLaterLineitemDetails b ON (a.ParentOmsTemplateLineItemId = b.OmsTemplateLineItemId)
		 INNER JOIN @SaveForLaterLineItemType S ON a.OmsTemplateId = s.OmsTemplateId AND a.SKU = s.AddOnValueIds
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
	END

	--Added condition to add new product which is coming with existing product.
	IF OBJECT_ID('tempdb..#NewRowId') IS NOT NULL
		DROP TABLE #NewRowId;

	SELECT N.RowId
	INTO #NewRowId
	FROM #NewConfigSaveForLaterLineitemDetails N
	LEFT JOIN #OldConfigSaveForLaterLineitemDetails O ON N.OmsTemplateId=O.OmsTemplateId AND N.SKU=O.SKU
	WHERE O.SKU IS NULL

	--Inserting the new save cart data if old and new cart data not match
	IF NOT EXISTS (SELECT TOP 1 1 FROM #OldConfigSaveForLaterLineitemDetails)
		OR EXISTS (SELECT TOP 1 1 FROM #NewRowId) --Added condition to add new product which is coming with existing product.
	BEGIN
		--Getting the new save cart data and generating row no. for new save cart insert
		SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsTemplateLineItemId ,OmsTemplateId,SKU,Quantity,OrderLineItemRelationshipTypeId 
			 ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon 
			 ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description ,ParentSKU,CustomUnitPrice 
		INTO #InsertNewConfigSaveForLaterLineitem 
		FROM #NewConfigSaveForLaterLineitemDetails
		WHERE RowId IN (SELECT RowId FROM #NewRowId)
		GROUP BY ParentOmsTemplateLineItemId ,OmsTemplateId,SKU,Quantity,OrderLineItemRelationshipTypeId 
			,CustomText,CartAddOnDetails ,AutoAddon 
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU ,CustomUnitPrice 
		ORDER BY RowId, Id 
 	 
		--Removing the line item having Quantity <=0 
		DELETE 
		FROM #InsertNewConfigSaveForLaterLineitem 
		WHERE Quantity <=0 
 
		--Updating the rowid INTo new save cart line item as new line item is merged INTo existing save cart item
		 ;WITH VTTY AS 
		( 
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU 
			FROM #InsertNewConfigSaveForLaterLineitem m 
			INNER JOIN #InsertNewConfigSaveForLaterLineitem TY1 ON TY1.SKU = m.ParentSKU 
			WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
		) 
		UPDATE m1 
		SET m1.RowId = TYU.RowId 
		FROM #InsertNewConfigSaveForLaterLineitem m1 
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId) 
 
		;WITH VTRET AS 
		( 
			SELECT RowId,id,Min(NewRowId)NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID 
			FROM #InsertNewConfigSaveForLaterLineitem 
			GROUP BY RowId,id ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID 
			Having SKU = ParentSKU AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		) 
		DELETE FROM #InsertNewConfigSaveForLaterLineitem WHERE NewRowId IN (SELECT NewRowId FROM VTRET) 
 
	 --Inserting the new cart line item if not merged in existing save cart line item
		INSERT INTO ZnodeOmsTemplateLineItem (ParentOmsTemplateLineItemId ,OmsTemplateId,SKU,Quantity,OrderLineItemRelationshipTypeId 
			,CustomText,CartAddOnDetails,Sequence,	CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon 
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description,CustomUnitPrice ) 
		OUTPUT INSERTED.OmsTemplateLineItemId,INSERTED.OmsTemplateId,inserted.SKU,inserted.GroupId,INSERTED.ParentOmsTemplateLineItemId,INSERTED.OrderLineItemRelationshipTypeId INTO @OmsInsertedData 
		SELECT NULL ,OmsTemplateId,SKU,Quantity,OrderLineItemRelationshipTypeId 
			,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId) sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon 
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description ,CustomUnitPrice 
		FROM #InsertNewConfigSaveForLaterLineitem TH 

		SELECT MAX(a.OmsTemplateLineItemId ) OmsTemplateLineItemId 
			, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU
		INTO #Cte_newData
		FROM @OmsInsertedData a 
		INNER JOIN #InsertNewConfigSaveForLaterLineitem b ON (a.OmsTemplateId = b.OmsTemplateId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-') ) 
		WHERE ISNULL(a.ParentOmsTemplateLineItemId,0) =0 
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			 
	
		UPDATE a 
		SET a.ParentOmsTemplateLineItemId = (SELECT TOP 1 OmsTemplateLineItemId FROM #Cte_newData r 
		WHERE r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-') Order by b.RowId ) 
		FROM ZnodeOmsTemplateLineItem a 
		INNER JOIN #InsertNewConfigSaveForLaterLineitem b ON (a.OmsTemplateId = b.OmsTemplateId AND a.SKU = b.SKU AND b.id =1 ) 
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL 
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon 
			AND a.ParentOmsTemplateLineItemId IS nULL 
			AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsTemplateLineItemId = a.OmsTemplateLineItemId )

	---------------------------------------------------------------------------------------------------------------------

		SELECT MIN(a.OmsTemplateLineItemId ) OmsTemplateLineItemId 
			, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU 
		INTO #Cte_newData1 
		FROM @OmsInsertedData a 
		INNER JOIN #InsertNewConfigSaveForLaterLineitem b ON (a.OmsTemplateId = b.OmsTemplateId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-') ) 
		WHERE ISNULL(a.ParentOmsTemplateLineItemId,0) =0 
			AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsTemplateLineItemId = a.OmsTemplateLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			

		UPDATE a SET a.ParentOmsTemplateLineItemId = (SELECT TOP 1 OmsTemplateLineItemId FROM #Cte_newData1 r 
		WHERE r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-') Order by b.RowId ) 
		FROM ZnodeOmsTemplateLineItem a 
		INNER JOIN #InsertNewConfigSaveForLaterLineitem b ON (a.OmsTemplateId = b.OmsTemplateId AND a.SKU = b.SKU AND b.id =1 ) 
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL 
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon 
			AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsTemplateLineItemId = a.OmsTemplateLineItemId )
			AND a.sequence in (SELECT MIN(ab.sequence) FROM ZnodeOmsTemplateLineItem ab where a.OmsTemplateId = ab.OmsTemplateId AND 
			a.SKU = ab.sku AND ab.OrderLineItemRelationshipTypeId is not null ) 
 
	---------------------------------------------------------------------------------------------------------------------------

		SELECT a.OmsTemplateLineItemId , b.RowId ,b.SKU ,b.ParentSKU ,Row_number()Over(Order BY c.OmsTemplateLineItemId )RowIdNo
		INTO #NewConfigProduct
		FROM ZnodeOmsTemplateLineItem a with (nolock) 
		INNER JOIN #InsertNewConfigSaveForLaterLineitem b ON (a.OmsTemplateId = b.OmsTemplateId AND a.SKU = b.ParentSKU AND ( b.Id = 1 )) 
		INNER JOIN ZnodeOmsTemplateLineItem c with (nolock) ON b.sku = c.sku AND b.OmsTemplateId=c.OmsTemplateId AND b.Id = 1 
		WHERE ( ISNULL(a.ParentOmsTemplateLineItemId,0) <> 0 )
			AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
			AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsTemplateLineItemId = a.OmsTemplateLineItemId ) AND c.ParentOmsTemplateLineItemId is null
 
		 ;WITH table_update AS 
		 (
			 SELECT * , ROW_NUMBER()Over(Order BY OmsTemplateLineItemId ) RowIdNo
			 FROM ZnodeOmsTemplateLineItem a with (nolock)
			 WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL 
			 AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
			 AND a.ParentOmsTemplateLineItemId IS NULL 
			 AND EXISTS (SELECT TOP 1 1 FROM #InsertNewConfigSaveForLaterLineitem ty WHERE ty.OmsTemplateId = a.OmsTemplateId )
			 AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsTemplateLineItemId = a.OmsTemplateLineItemId )
		 )
		UPDATE a 
		SET a.ParentOmsTemplateLineItemId = (SELECT TOP 1 max(OmsTemplateLineItemId) 
		FROM #NewConfigProduct r 
		WHERE r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo GROUP BY r.ParentSKU, r.SKU ) 
		FROM table_update a 
		INNER JOIN #InsertNewConfigSaveForLaterLineitem b ON (a.OmsTemplateId = b.OmsTemplateId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND b.id =1 ) 
		WHERE (SELECT TOP 1 max(OmsTemplateLineItemId) 
		FROM #NewConfigProduct r 
		WHERE r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo GROUP BY r.ParentSKU, r.SKU ) IS nOT NULL 

		;WITH Cte_Th AS 
		( 
			 SELECT RowId 
			 FROM #InsertNewConfigSaveForLaterLineitem a 
			 GROUP BY RowId 
			 HAVING COUNT(NewRowId) <= 1 
		) 
		UPDATE a 
		SET a.Quantity = NULL,a.ModifiedDate = @GetDate 
		FROM ZnodeOmsTemplateLineItem a 
		INNER JOIN #InsertNewConfigSaveForLaterLineitem b ON (a.OmsTemplateId = b.OmsTemplateId AND a.SKU = b.SKU AND b.id =0) 
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM Cte_Th TY WHERE TY.RowId = b.RowId ) 
			AND a.OrderLineItemRelationshipTypeId IS NULL 
 
		UPDATE ZnodeOmsTemplateLineItem 
		SET GROUPID = NULL 
		WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewConfigSaveForLaterLineitem RT WHERE RT.OmsTemplateId = ZnodeOmsTemplateLineItem.OmsTemplateId ) 
		AND OrderLineItemRelationshipTypeId IS NOT NULL 
 
		;WITH Cte_UpdateSequence AS 
		( 
			 SELECT OmsTemplateLineItemId ,Row_Number()Over(Order By OmsTemplateLineItemId) RowId , Sequence 
			 FROM ZnodeOmsTemplateLineItem 
			 WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewConfigSaveForLaterLineitem TH WHERE TH.OmsTemplateId = ZnodeOmsTemplateLineItem.OmsTemplateId ) 
		) 
		UPDATE Cte_UpdateSequence 
		SET Sequence = RowId 

		UPDATE @TBL_Personalise
		SET OmsTemplateLineItemId = b.OmsTemplateLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN @TBL_Personalise c ON a.SKU = c.ConfigurableProductIds
		INNER JOIN ZnodeOmsTemplateLineItem b with (nolock) ON (a.OmsTemplateLineItemId = b.OmsTemplateLineItemId AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsTemplateLineItemId IS not nULL 
	
		DELETE 
		FROM ZnodeOmsTemplatePersonalizeCartItem 
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsTemplateLineItemId = ZnodeOmsTemplatePersonalizeCartItem.OmsTemplateLineItemId )
		
		----Inserting saved cart item personalise value FROM given line item
		MERGE INTO ZnodeOmsTemplatePersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
			 ON (TARGET.OmsTemplateLineItemId = SOURCE.OmsTemplateLineItemId ) 
			 WHEN NOT MATCHED THEN 
				INSERT ( OmsTemplateLineItemId, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL, PersonalizeName )
				VALUES ( SOURCE.OmsTemplateLineItemId, @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL, SOURCE.PersonalizeName ) ;
	END
	END TRY
	BEGIN CATCH 
		SELECT ERROR_MESSAGE()
	END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveForLaterLineItemGroup')
	DROP PROC Znode_InsertUpdateSaveForLaterLineItemGroup
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveForLaterLineItemGroup]
(
	 @SaveForLaterLineItemType SaveForLaterLineitems READONLY  
	,@Userid  INT = 0 
	,@OrderLineItemRelationshipTypeIdGroup INT
	,@OrderLineItemRelationshipTypeIdAddon INT
)
AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 
	--Declared the variables
	DECLARE @GetDate datetime= dbo.Fn_GetDate(); 
	
	DECLARE @OmsInsertedData TABLE (SKU varchar(600),OmsTemplateLineItemId INT ) 	
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise TABLE (OmsTemplateLineItemId INT, ParentOmsTemplateLineItemId INT,GroupProductIds VARCHAR(600) ,PersonalizeCode NVARCHAR(MAX),PersonalizeValue NVARCHAR(MAX),DesignId NVARCHAR(MAX), ThumbnailURL NVARCHAR(MAX),PersonalizeName NVARCHAR(max))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsTemplateLineItemId,a.GroupProductIds
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(MAX)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(MAX)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(MAX)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(MAX)' ) AS ThumbnailURL
			,Tbl.Col.value( 'PersonalizeName[1]', 'NVARCHAR(MAX)' ) AS PersonalizeName
	FROM @SaveForLaterLineItemType a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  

	CREATE TABLE #NewGroupSaveForLaterLineitemDetails 
	(
		GenId INT IDENTITY(1,1),RowId	INT ,OmsTemplateLineItemId	INT,ParentOmsTemplateLineItemId	INT,OmsTemplateId	int
		,SKU	NVARCHAR(MAX) ,Quantity	numeric(28,6)	,OrderLineItemRelationshipTypeID	INT ,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	INT ,AutoAddon	VARCHAR(MAX)	,OmsOrderId	INT ,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX),
		CustomUnitPrice NUMERIC(28,6)
	)
	 
	--Getting new save cart data(group product)
	INSERT INTO #NewGroupSaveForLaterLineitemDetails
	SELECT  Min(RowId )RowId ,OmsTemplateLineItemId, ParentOmsTemplateLineItemId, OmsTemplateId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU ,CustomUnitPrice
	FROM @SaveForLaterLineItemType a 
	GROUP BY  OmsTemplateLineItemId, ParentOmsTemplateLineItemId, OmsTemplateId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,CustomUnitPrice
	 
	--Getting new group product save cart data
	INSERT INTO #NewGroupSaveForLaterLineitemDetails 
	SELECT   Min(RowId )RowId ,OmsTemplateLineItemId, ParentOmsTemplateLineItemId, OmsTemplateId, GroupProductIds
				,Quantity, @OrderLineItemRelationshipTypeIdGroup, CustomText, CartAddOnDetails, Sequence
				,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU,CustomUnitPrice  
	FROM @SaveForLaterLineItemType  a 
	WHERE GroupProductIds <> ''
	GROUP BY  OmsTemplateLineItemId, ParentOmsTemplateLineItemId, OmsTemplateId, GroupProductIds
		,Quantity,  CustomText, CartAddOnDetails, Sequence ,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU,CustomUnitPrice
		
	--Getting new group products save cart data if addon is present for any line item
	INSERT INTO #NewGroupSaveForLaterLineitemDetails
	SELECT  Min(RowId )RowId ,OmsTemplateLineItemId, ParentOmsTemplateLineItemId, OmsTemplateId, AddOnValueIds
		,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
		,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
			WHEN  GroupProductIds <> '' THEN GroupProductIds 
			WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU ,CustomUnitPrice
	FROM @SaveForLaterLineItemType  a 
	WHERE AddOnValueIds <> ''
	GROUP BY  OmsTemplateLineItemId, ParentOmsTemplateLineItemId, OmsTemplateId, AddOnValueIds
		,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU,CustomUnitPrice
		 

	CREATE TABLE #OldGroupSaveForLaterLineitemDetails (OmsTemplateId INT ,OmsTemplateLineItemId INT,ParentOmsTemplateLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old group save cart data if present for same SKU in the new save cart data for group product	 	 
	INSERT INTO #OldGroupSaveForLaterLineitemDetails  
	SELECT  a.OmsTemplateId,a.OmsTemplateLineItemId,a.ParentOmsTemplateLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM ZnodeOmsTemplateLineItem a with (nolock)  
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveForLaterLineItemType  TY WHERE TY.OmsTemplateId = a.OmsTemplateId AND ISNULL(a.SKU,'') = ISNULL(TY.GroupProductIds,'')   )   
		AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup   

	--Getting the old save cart Parent data
	INSERT INTO #OldGroupSaveForLaterLineitemDetails 
	SELECT DISTINCT b.OmsTemplateId,b.OmsTemplateLineItemId,b.ParentOmsTemplateLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsTemplateLineItem b with (nolock)
	INNER JOIN #OldGroupSaveForLaterLineitemDetails c ON (c.ParentOmsTemplateLineItemId  = b.OmsTemplateLineItemId AND c.OmsTemplateId = b.OmsTemplateId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveForLaterLineItemType  TY WHERE TY.OmsTemplateId = b.OmsTemplateId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
		AND  b.OrderLineItemRelationshipTypeID IS NULL 

	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldGroupSaveForLaterLineitemDetails

	DELETE a FROM #OldGroupSaveForLaterLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldGroupSaveForLaterLineitemDetails b WHERE b.ParentOmsTemplateLineItemId IS NULL AND b.OmsTemplateLineItemId = a.ParentOmsTemplateLineItemId)
	AND a.ParentOmsTemplateLineItemId IS NOT NULL 

	--Getting the old config product save cart addon data for old line items if present
	INSERT INTO #OldGroupSaveForLaterLineitemDetails 
	SELECT b.OmsTemplateId,b.OmsTemplateLineItemId,b.ParentOmsTemplateLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsTemplateLineItem b with (nolock)
	INNER JOIN #OldGroupSaveForLaterLineitemDetails c ON (c.OmsTemplateLineItemId  = b.ParentOmsTemplateLineItemId AND c.OmsTemplateId = b.OmsTemplateId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveForLaterLineItemType  TY WHERE TY.OmsTemplateId = b.OmsTemplateId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

	------Merge Addon for same product
	IF EXISTS(SELECT * FROM @SaveForLaterLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
	BEGIN
		INSERT INTO #OldValueForAddon 
		SELECT b.OmsTemplateId,b.OmsTemplateLineItemId,b.ParentOmsTemplateLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
		FROM ZnodeOmsTemplateLineItem b 
		INNER JOIN #OldValueForAddon c ON (c.OmsTemplateLineItemId  = b.ParentOmsTemplateLineItemId AND c.OmsTemplateId = b.OmsTemplateId)
		WHERE EXISTS (SELECT TOP 1 1 FROM @SaveForLaterLineItemType  TY WHERE TY.OmsTemplateId = b.OmsTemplateId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
								( SELECT  ', ' + SKU FROM    
									( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
										where a.OmsTemplateLineItemId=b.ParentOmsTemplateLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
										FOR XML PATH('')
								), 1, 2, ''
								) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a where a.ParentOmsTemplateLineItemId is not null and OrderLineItemRelationshipTypeID<>1

		SELECT DISTINCT a.GroupProductIds SKU, STUFF(
									( SELECT  ', ' + x.AddOnValueIds FROM    
									( SELECT DISTINCT b.AddOnValueIds FROM @SaveForLaterLineItemType b
										where a.SKU=b.SKU ) x
										FOR XML PATH('')
									), 1, 2, ''
								) AddOns
		INTO #AddOnAdded
		FROM @SaveForLaterLineItemType a

		IF NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
		BEGIN
			DELETE FROM #OldGroupSaveForLaterLineitemDetails
		END
	END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSaveForLaterLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @SaveForLaterLineItemType ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldGroupSaveForLaterLineitemDetails a WHERE	
		ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
		AND EXISTS (SELECT TOP 1 1 FROM @SaveForLaterLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN
		DELETE FROM #OldGroupSaveForLaterLineitemDetails 
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @SaveForLaterLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
		BEGIN
			DECLARE @parenTofAddon  TABLE( ParentOmsTemplateLineItemId INT  )  
			INSERT INTO  @parenTofAddon 
			SELECT  ParentOmsTemplateLineItemId FROM #OldGroupSaveForLaterLineitemDetails a
			WHERE a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
			AND (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsTemplateLineItem  t with (nolock) WHERE t.ParentOmsTemplateLineItemId = a.ParentOmsTemplateLineItemId AND   t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSaveForLaterLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  
			DELETE 
			FROM #OldGroupSaveForLaterLineitemDetails 
			WHERE OmsTemplateLineItemId NOT IN (SELECT ParentOmsTemplateLineItemId FROM  @parenTofAddon)   
				AND ParentOmsTemplateLineItemId IS NOT NULL  
				AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

			 DELETE 
			 FROM #OldGroupSaveForLaterLineitemDetails 
			 WHERE OmsTemplateLineItemId NOT IN (SELECT ISNULL(m.ParentOmsTemplateLineItemId,0) FROM #OldGroupSaveForLaterLineitemDetails m)
				AND ParentOmsTemplateLineItemId IS  NULL  

			IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldGroupSaveForLaterLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSaveForLaterLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			BEGIN 
				DELETE FROM #OldGroupSaveForLaterLineitemDetails
			END 
			IF (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsTemplateLineItem with (nolock)  WHERE ParentOmsTemplateLineItemId IN (SELECT ParentOmsTemplateLineItemId FROM @parenTofAddon)AND   OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSaveForLaterLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			BEGIN 
				DELETE FROM #OldGroupSaveForLaterLineitemDetails
			END
		END 
		ELSE IF (SELECT COUNT (OmsTemplateLineItemId) FROM #OldGroupSaveForLaterLineitemDetails WHERE ParentOmsTemplateLineItemId IS NULL ) > 1 
		BEGIN 
			-- SELECT 3
		    DECLARE @TBL_deleteParentOmsTemplateLineItemId TABLE (OmsTemplateLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsTemplateLineItemId 
			SELECT ParentOmsTemplateLineItemId
			FROM ZnodeOmsTemplateLineItem a with (nolock)
			WHERE ParentOmsTemplateLineItemId IN (SELECT OmsTemplateLineItemId FROM #OldGroupSaveForLaterLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup  )
				AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE 
			FROM #OldGroupSaveForLaterLineitemDetails 
			WHERE OmsTemplateLineItemId IN (SELECT OmsTemplateLineItemId FROM @TBL_deleteParentOmsTemplateLineItemId)
				OR ParentOmsTemplateLineItemId IN (SELECT OmsTemplateLineItemId FROM @TBL_deleteParentOmsTemplateLineItemId)
		    
			DELETE 
			FROM #OldGroupSaveForLaterLineitemDetails 
			WHERE OmsTemplateLineItemId NOT IN (SELECT ISNULL(m.ParentOmsTemplateLineItemId,0) FROM #OldGroupSaveForLaterLineitemDetails m)
				AND ParentOmsTemplateLineItemId IS NULL
		END
		ELSE IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldGroupSaveForLaterLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSaveForLaterLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		BEGIN 
			DELETE FROM #OldGroupSaveForLaterLineitemDetails
		END 
		ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsTemplateLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldGroupSaveForLaterLineitemDetails ty WHERE ty.OmsTemplateId = wt.OmsTemplateId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup AND wt.ParentOmsTemplateLineItemId= ty.OmsTemplateLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
			AND EXISTS (SELECT TOP 1 1 FROM @SaveForLaterLineItemType WHERE ISNULL(AddOnValueIds,'')  = '' )
		BEGIN 
			DELETE FROM #OldGroupSaveForLaterLineitemDetails
		END  
	END

	DECLARE @TBL_Personaloldvalues TABLE (OmsTemplateLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	--Getting the personalise data for old save cart if present	
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsTemplateLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsTemplatePersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldGroupSaveForLaterLineitemDetails TY WHERE TY.OmsTemplateLineItemId = a.OmsTemplateLineItemId)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN
		DELETE FROM #OldGroupSaveForLaterLineitemDetails
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsTemplateLineItemId ) FROM #OldGroupSaveForLaterLineitemDetails WHERE ParentOmsTemplateLineItemId IS nULL ) > 1 
		BEGIN 
			DELETE 
			FROM #OldGroupSaveForLaterLineitemDetails 
			WHERE OmsTemplateLineItemId IN (
				SELECT OmsTemplateLineItemId FROM #OldGroupSaveForLaterLineitemDetails WHERE OmsTemplateLineItemId NOT IN (SELECT OmsTemplateLineItemId FROM @TBL_Personaloldvalues )
				AND ParentOmsTemplateLineItemId NOT IN (SELECT OmsTemplateLineItemId FROM @TBL_Personaloldvalues)) 
				OR OmsTemplateLineItemId IN ( SELECT ParentOmsTemplateLineItemId FROM #OldGroupSaveForLaterLineitemDetails WHERE OmsTemplateLineItemId NOT IN (SELECT OmsTemplateLineItemId FROM @TBL_Personaloldvalues )
				AND ParentOmsTemplateLineItemId NOT IN (SELECT OmsTemplateLineItemId FROM @TBL_Personaloldvalues))
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
			AND (SELECT COUNT (DISTINCT OmsTemplateLineItemId ) FROM #OldGroupSaveForLaterLineitemDetails WHERE ParentOmsTemplateLineItemId IS nULL ) > 1 
			AND (SELECT COUNT (DISTINCT OmsTemplateLineItemId ) FROM #OldGroupSaveForLaterLineitemDetails WHERE ParentOmsTemplateLineItemId IS nULL ) <>
				(SELECT COUNT (DISTINCT OmsTemplateLineItemId ) FROM ZnodeOmsTemplateLineItem WHERE ParentOmsTemplateLineItemId IS nULL and OmsTemplateLineItemId in (select OmsTemplateLineItemId FROM #OldGroupSaveForLaterLineitemDetails)  )
		BEGIN
			DELETE n 
			FROM #OldGroupSaveForLaterLineitemDetails n 
			WHERE OmsTemplateLineItemId  IN (SELECT OmsTemplateLineItemId FROM ZnodeOmsTemplatePersonalizeCartItem WHERE n.OmsTemplateLineItemId = ZnodeOmsTemplatePersonalizeCartItem.OmsTemplateLineItemId  )
			OR ParentOmsTemplateLineItemId  IN (SELECT OmsTemplateLineItemId FROM ZnodeOmsTemplatePersonalizeCartItem   )
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
			AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsTemplatePersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldGroupSaveForLaterLineitemDetails YU WHERE YU.OmsTemplateLineItemId = m.OmsTemplateLineItemId )) 
			AND (SELECT COUNT (DISTINCT OmsTemplateLineItemId ) FROM #OldGroupSaveForLaterLineitemDetails WHERE ParentOmsTemplateLineItemId IS nULL ) = 1
		BEGIN 
			DELETE FROM #OldGroupSaveForLaterLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		END 
	END
	
	IF EXISTS (SELECT TOP 1 1 FROM #OldGroupSaveForLaterLineitemDetails)
	BEGIN
		----DELETE old value FROM table which having personalise data in ZnodeOmsTemplatePersonalizeCartItem but same SKU not having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*
			FROM @SaveForLaterLineItemType a 
					INNER JOIN #OldGroupSaveForLaterLineitemDetails b on ( a.GroupProductIds = b.SKU or a.SKU = b.sku)
					where isnull(cast(a.PersonalisedAttribute AS varchar(max)),'') = ''
		)
		,cte2 AS
		(
			select a.ParentOmsTemplateLineItemId
			FROM #OldGroupSaveForLaterLineitemDetails a
			INNER JOIN ZnodeOmsTemplatePersonalizeCartItem b on b.OmsTemplateLineItemId = a.OmsTemplateLineItemId
		)
		DELETE a FROM #OldGroupSaveForLaterLineitemDetails a
		INNER JOIN cte b on a.OmsTemplateLineItemId = b.OmsTemplateLineItemId
		INNER JOIN cte2 c on (a.OmsTemplateLineItemId = c.ParentOmsTemplateLineItemId or a.ParentOmsTemplateLineItemId = c.ParentOmsTemplateLineItemId)

		----DELETE old value FROM table which having personalise data in ZnodeOmsTemplatePersonalizeCartItem but same SKU having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*, 
			a.PersonalizeCode
			,a.PersonalizeValue
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSaveForLaterLineitemDetails b on ( a.GroupProductIds = b.SKU)
			where isnull(a.PersonalizeValue,'') <> ''
		)
		,cte2 AS
		(
			select a.ParentOmsTemplateLineItemId, b.PersonalizeCode, b.PersonalizeValue
			FROM #OldGroupSaveForLaterLineitemDetails a
			INNER JOIN ZnodeOmsTemplatePersonalizeCartItem b on b.OmsTemplateLineItemId = a.OmsTemplateLineItemId
			WHERE NOT EXISTS(SELECT * FROM cte c where b.OmsTemplateLineItemId = c.OmsTemplateLineItemId and b.PersonalizeCode = c.PersonalizeCode 
								and b.PersonalizeValue = c.PersonalizeValue )
		)
		DELETE a FROM #OldGroupSaveForLaterLineitemDetails a
		INNER JOIN cte b on a.OmsTemplateLineItemId = b.OmsTemplateLineItemId
		INNER JOIN cte2 c on (a.OmsTemplateLineItemId = c.ParentOmsTemplateLineItemId or a.ParentOmsTemplateLineItemId = c.ParentOmsTemplateLineItemId)

		;WITH cte AS
		(
			SELECT b.OmsTemplateLineItemId ,b.ParentOmsTemplateLineItemId , a.GroupProductIds
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSaveForLaterLineitemDetails b on a.GroupProductIds = b.SKU
			INNER JOIN ZnodeOmsTemplatePersonalizeCartItem c on b.OmsTemplateLineItemId = c.OmsTemplateLineItemId
			WHERE a.OmsTemplateLineItemId = 0
		)
		DELETE b1
		FROM #OldGroupSaveForLaterLineitemDetails b1 
		WHERE NOT EXISTS(SELECT * FROM cte c where (b1.OmsTemplateLineItemId = c.ParentOmsTemplateLineItemId or b1.ParentOmsTemplateLineItemId = c.ParentOmsTemplateLineItemId))
		AND EXISTS(SELECT * FROM cte)

		--------If lineitem present in ZnodeOmsTemplatePersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsTemplatePersonalizeCartItem and personalize value is same for same line item then Quantity will added
		;WITH cte AS
		(
			SELECT b.OmsTemplateLineItemId ,a.ParentOmsTemplateLineItemId , a.GroupProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSaveForLaterLineitemDetails b on a.GroupProductIds = b.SKU
			INNER JOIN ZnodeOmsTemplatePersonalizeCartItem c on b.OmsTemplateLineItemId = c.OmsTemplateLineItemId
			WHERE a.OmsTemplateLineItemId = 0
		)
		DELETE c1
		FROM cte a1		  
		INNER JOIN #OldGroupSaveForLaterLineitemDetails b1 on a1.SKU = b1.SKU
		INNER JOIN #OldGroupSaveForLaterLineitemDetails c1 on (b1.ParentOmsTemplateLineItemId = c1.OmsTemplateLineItemId OR b1.OmsTemplateLineItemId = c1.OmsTemplateLineItemId)
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsTemplatePersonalizeCartItem c where a1.OmsTemplateLineItemId = c.OmsTemplateLineItemId and a1.PersonalizeValue = c.PersonalizeValue)
		-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsTemplateLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSaveForLaterLineitemDetails b ON a.GroupProductIds = b.SKU
			INNER JOIN ZnodeOmsTemplatePersonalizeCartItem c ON b.OmsTemplateLineItemId = c.OmsTemplateLineItemId 
				--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsTemplateLineItemId,0) = 0
			GROUP BY b.OmsTemplateLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsTemplateLineItemId,0) as OmsTemplateLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewGroupSaveForLaterLineitemDetails b ON a.GroupProductIds = b.SKU
			WHERE ISNULL(a.OmsTemplateLineItemId,0) = 0
			GROUP BY a.OmsTemplateLineItemId ,b.SKU
		)
		DELETE c
		from CTE_OldPersonalizeCodeCount a
		INNER JOIN CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		INNER JOIN #OldGroupSaveForLaterLineitemDetails c on b.SKU = c.SKU and a.OmsTemplateLineItemId = c.OmsTemplateLineItemId
		
		--Delete parent entry if child not present
		DELETE a FROM #OldGroupSaveForLaterLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldGroupSaveForLaterLineitemDetails b where a.OmsTemplateLineItemId = b.ParentOmsTemplateLineItemId)
		AND a.ParentOmsTemplateLineItemId IS NULL

		--Updating the cart if old and new cart data matches
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
			a.Custom1 = ty.Custom1,
			a.Custom2 = ty.Custom2,
			a.Custom3 = ty.Custom3,
			a.Custom4 = ty.Custom4,
			a.Custom5 = ty.Custom5,
			a.ModifiedDate = @GetDate ,
			a.CustomUnitPrice = ty.CustomUnitPrice
		FROM ZnodeOmsTemplateLineItem a
		INNER JOIN #OldGroupSaveForLaterLineitemDetails b ON (a.OmsTemplateLineItemId = b.OmsTemplateLineItemId)
		INNER JOIN #NewGroupSaveForLaterLineitemDetails ty ON (ty.SKU = b.SKU)
		WHERE a.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon

		UPDATE a
		SET a.Quantity = a.Quantity+s.AddOnQuantity,
			a.ModifiedDate = @GetDate
		FROM ZnodeOmsTemplateLineItem a
		INNER JOIN #OldGroupSaveForLaterLineitemDetails b ON (a.ParentOmsTemplateLineItemId = b.OmsTemplateLineItemId)
		INNER JOIN @SaveForLaterLineItemType S on a.OmsTemplateId = s.OmsTemplateId and a.SKU = s.AddOnValueIds
		WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
	END

	--Added condition to add new product which is coming with existing product.
	IF OBJECT_ID('tempdb..#NewRowId') IS NOT NULL
		DROP TABLE #NewRowId;

	SELECT N.RowId
	INTO #NewRowId
	FROM #NewGroupSaveForLaterLineitemDetails N
	LEFT JOIN #OldGroupSaveForLaterLineitemDetails O ON N.OmsTemplateId=O.OmsTemplateId AND N.SKU=O.SKU
	WHERE O.SKU IS NULL

	--Inserting the new save cart data if old and new cart data not match
	IF NOT EXISTS (SELECT TOP 1 1 FROM #OldGroupSaveForLaterLineitemDetails)
		OR EXISTS (SELECT TOP 1 1 FROM #NewRowId) --Added condition to add new product which is coming with existing product.
	BEGIN
		SELECT RowId, Id ,Row_number()Over(ORDER BY RowId, Id,GenId) NewRowId , ParentOmsTemplateLineItemId ,OmsTemplateId,SKU,Quantity,OrderLineItemRelationshipTypeId  
			,CustomText,CartAddOnDetails,ROW_NUMBER()Over(ORDER BY NewId() ) Sequence ,AutoAddon  
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU ,CustomUnitPrice 
		INTO #InsertNewGroupSaveForLaterLineitem   
		FROM #NewGroupSaveForLaterLineitemDetails
		WHERE RowId IN (SELECT RowId FROM #NewRowId) OR ParentSKU IS NULL
		GROUP BY ParentOmsTemplateLineItemId ,OmsTemplateId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU, CustomUnitPrice
		ORDER BY RowId, Id

		--Removing the line item having Quantity <=0 
		DELETE 
		FROM #InsertNewGroupSaveForLaterLineitem
		WHERE Quantity <=0
  
		--Updating the rowid into new save cart line item as new line item is merged into existing save cart item
		;WITH VTTY AS
		(
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU
			FROM #InsertNewGroupSaveForLaterLineitem m
			INNER JOIN  #InsertNewGroupSaveForLaterLineitem TY1 ON TY1.SKU = m.ParentSKU
			WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon
		)
		UPDATE m1   
		SET m1.RowId = TYU.RowId
		FROM #InsertNewGroupSaveForLaterLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  

		;WITH VTRET AS   
		(
			SELECT RowId,id,Min(NewRowId)NewRowId ,SKU ,ParentSKU, OrderLineItemRelationshipTypeId 
			FROM #InsertNewGroupSaveForLaterLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU  ,OrderLineItemRelationshipTypeId
			HAVING SKU = ParentSKU AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		)
		DELETE 
		FROM #InsertNewGroupSaveForLaterLineitem 
		WHERE NewRowId  IN (SELECT NewRowId FROM VTRET)   
     
		--Inserting the new cart line item if not merged in existing save cart line item
		INSERT INTO  ZnodeOmsTemplateLineItem (ParentOmsTemplateLineItemId ,OmsTemplateId,SKU,Quantity,OrderLineItemRelationshipTypeId  
			,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description,CustomUnitPrice)  
		OUTPUT INSERTED.SKU,INSERTED.OmsTemplateLineItemId  INTO @OmsInsertedData 
		SELECT NULL ,OmsTemplateId,SKU,Quantity,OrderLineItemRelationshipTypeId  
			,CustomText,CartAddOnDetails,ROW_NUMBER()Over(ORDER BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description, CustomUnitPrice
		FROM  #InsertNewGroupSaveForLaterLineitem  TH  

		SELECT  MAX(a.OmsTemplateLineItemId ) OmsTemplateLineItemId 
			,b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU 
		INTO  #Cte_newData
		FROM ZnodeOmsTemplateLineItem a  with (nolock)
		INNER JOIN #InsertNewGroupSaveForLaterLineitem b ON (a.OmsTemplateId = b.OmsTemplateId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsTemplateLineItemId,0) =0  
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsTemplateLineItemId = a.OmsTemplateLineItemId )
				AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID	  

		UPDATE a 
		SET a.ParentOmsTemplateLineItemId = (SELECT TOP 1 OmsTemplateLineItemId FROM  #Cte_newData  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  ORDER BY b.RowId )   
		FROM ZnodeOmsTemplateLineItem a  
		INNER JOIN #InsertNewGroupSaveForLaterLineitem b ON (a.OmsTemplateId = b.OmsTemplateId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
			AND a.ParentOmsTemplateLineItemId IS nULL   
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsTemplateLineItemId = a.OmsTemplateLineItemId )
  
		-----------------------------------------------------------------------------------------------------------------------------------

		SELECT  MIN(a.OmsTemplateLineItemId ) OmsTemplateLineItemId
			,b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU
		INTO #Cte_newData1
		FROM ZnodeOmsTemplateLineItem a with (nolock)
		INNER JOIN #InsertNewGroupSaveForLaterLineitem b ON (a.OmsTemplateId = b.OmsTemplateId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsTemplateLineItemId,0) =0  
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsTemplateLineItemId = a.OmsTemplateLineItemId )
				AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID	  

		UPDATE a SET a.ParentOmsTemplateLineItemId = (SELECT TOP 1 OmsTemplateLineItemId FROM  #Cte_newData1  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  ORDER BY b.RowId )   
		FROM ZnodeOmsTemplateLineItem a  
		INNER JOIN #InsertNewGroupSaveForLaterLineitem b ON (a.OmsTemplateId = b.OmsTemplateId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon   
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsTemplateLineItemId = a.OmsTemplateLineItemId )
			AND  a.sequence in (SELECT  MIN(ab.sequence) FROM ZnodeOmsTemplateLineItem ab where a.OmsTemplateId = ab.OmsTemplateId and 
				a.SKU = ab.sku and ab.OrderLineItemRelationshipTypeId is not null  ) 

		----------------------------------------------------------------------------------------------------------------------------

		SELECT DISTINCT a.OmsTemplateLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(ORDER BY c.OmsTemplateLineItemId )RowIdNo
		INTO #Cte_newAddon
		FROM ZnodeOmsTemplateLineItem a with (nolock) 
		INNER JOIN #InsertNewGroupSaveForLaterLineitem b ON (a.OmsTemplateId = b.OmsTemplateId AND a.SKU = b.ParentSKU AND ( b.Id = 1  ))  
		INNER JOIN ZnodeOmsTemplateLineItem c with (nolock) on b.sku = c.sku and b.OmsTemplateId=c.OmsTemplateId and b.Id = 1
		WHERE ( ISNULL(a.ParentOmsTemplateLineItemId,0) <> 0   )
			AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon
			AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewGroupSaveForLaterLineitem ty WHERE ty.OmsTemplateId = a.OmsTemplateId )
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsTemplateLineItemId = a.OmsTemplateLineItemId ) and c.ParentOmsTemplateLineItemId is null

		---- Added to get distinct records.
		--SELECT *,ROW_NUMBER()OVER(ORDER BY OmsTemplateLineItemId) RowIdNo 
		--INTO #Cte_newAddon 
		--FROM #Cte_newAddon1

		;WITH table_update AS 
		(
			SELECT * , ROW_NUMBER()Over(ORDER BY OmsTemplateLineItemId  ) RowIdNo
			FROM ZnodeOmsTemplateLineItem a with (nolock)
			WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
				AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
				AND a.ParentOmsTemplateLineItemId IS NULL  
				AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewGroupSaveForLaterLineitem ty WHERE ty.OmsTemplateId = a.OmsTemplateId )
				AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsTemplateLineItemId = a.OmsTemplateLineItemId )
		)
		UPDATE a 
		SET a.ParentOmsTemplateLineItemId = (SELECT TOP 1 max(OmsTemplateLineItemId) 
		FROM #Cte_newAddon  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewGroupSaveForLaterLineitem b ON (a.OmsTemplateId = b.OmsTemplateId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsTemplateLineItemId)  FROM #Cte_newAddon  r  
			WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )    IS nOT NULL 

		;WITH Cte_Th AS   
		(             
			SELECT RowId    
			FROM #InsertNewGroupSaveForLaterLineitem a   
			GROUP BY RowId   
			HAVING COUNT(NewRowId) <= 1   
		 )
		UPDATE a 
		SET a.Quantity =  NULL,
			a.ModifiedDate = @GetDate   
		FROM ZnodeOmsTemplateLineItem a  
		INNER JOIN #InsertNewGroupSaveForLaterLineitem b ON (a.OmsTemplateId = b.OmsTemplateId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		 AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE  ZnodeOmsTemplateLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewGroupSaveForLaterLineitem RT WHERE RT.OmsTemplateId = ZnodeOmsTemplateLineItem.OmsTemplateId )  
			AND OrderLineItemRelationshipTypeId IS NOT NULL     
       
	   ;WITH Cte_UpdateSequence AS   
		(  
			SELECT OmsTemplateLineItemId ,Row_Number()Over(ORDER BY OmsTemplateLineItemId) RowId , Sequence   
			FROM ZnodeOmsTemplateLineItem with (nolock)  
			WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewGroupSaveForLaterLineitem TH WHERE TH.OmsTemplateId = ZnodeOmsTemplateLineItem.OmsTemplateId )  
		)   
		UPDATE Cte_UpdateSequence  
		SET Sequence = RowId  
			
		UPDATE @TBL_Personalise
		SET OmsTemplateLineItemId = b.OmsTemplateLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN @TBL_Personalise c ON a.SKU = c.GroupProductIds
		INNER JOIN ZnodeOmsTemplateLineItem b WITH (NOLOCK) ON (a.OmsTemplateLineItemId = b.OmsTemplateLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsTemplateLineItemId IS NOT NULL  

		DELETE FROM ZnodeOmsTemplatePersonalizeCartItem	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsTemplateLineItemId = ZnodeOmsTemplatePersonalizeCartItem.OmsTemplateLineItemId )
			
		----Inserting saved cart item personalise value FROM given line item
		MERGE INTO ZnodeOmsTemplatePersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
			   ON (TARGET.OmsTemplateLineItemId = SOURCE.OmsTemplateLineItemId ) 
			   WHEN NOT MATCHED THEN 
				INSERT  ( OmsTemplateLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL, PersonalizeName )
				VALUES (  SOURCE.OmsTemplateLineItemId,  @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL, SOURCE.PersonalizeName ) ;
	END 

	END TRY
	BEGIN CATCH 
		SELECT ERROR_MESSAGE()
	END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveForLaterLineItemQuantityWrapper')
	DROP PROC Znode_InsertUpdateSaveForLaterLineItemQuantityWrapper
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveForLaterLineItemQuantityWrapper]
(
	@TemplateLineItemXML XML,
    @UserId              INT,
    @Status              BIT = 0 OUT
)
AS 
   /* 
    Summary: THis Procedure is USed to save and edit the saved cart line item      
    Unit Testing 
	begin tran  
    Exec Znode_InsertUpdateSaveForLaterLineItem @TemplateLineItemXML= '<ArrayOfSavedCartLineItemModel>
  <SavedCartLineItemModel>
    <OmsTemplateLineItemId>0</OmsTemplateLineItemId>
    <ParentOmsTemplateLineItemId>0</ParentOmsTemplateLineItemId>
    <OmsTemplateId>1259</OmsTemplateId>
    <SKU>BlueGreenYellow</SKU>
    <Quantity>1.000000</Quantity>
    <OrderLineItemRelationshipTypeId>0</OrderLineItemRelationshipTypeId>
    <Sequence>1</Sequence>
    <AddonProducts>YELLOW</AddonProducts>
    <BundleProducts />
    <ConfigurableProducts>GREEN</ConfigurableProducts>
  </SavedCartLineItemModel>
  <SavedCartLineItemModel>
    <OmsTemplateLineItemId>0</OmsTemplateLineItemId>
    <ParentOmsTemplateLineItemId>0</ParentOmsTemplateLineItemId>
    <OmsTemplateId>1259</OmsTemplateId>
    <SKU>ap1534</SKU>
    <Quantity>1.0</Quantity>
    <OrderLineItemRelationshipTypeId>0</OrderLineItemRelationshipTypeId>
    <Sequence>2</Sequence>
    <AddonProducts >PINK</AddonProducts>
    <BundleProducts />
    <ConfigurableProducts />
    <PersonaliseValuesList>Address~Hello</PersonaliseValuesList>
  </SavedCartLineItemModel>
</ArrayOfSavedCartLineItemModel>' , @UserId=1 ,@Status=0
	rollback tran
*/
BEGIN
BEGIN TRAN InsertUpdateSaveForLaterLineItem;
BEGIN TRY
SET NOCOUNT ON;

	--Declared the variables
	DECLARE @GetDate datetime= dbo.Fn_GetDate();
	DECLARE @AddOnQuantity numeric(28, 6)= 0;
	DECLARE @IsAddProduct   BIT = 0 
	DECLARE @OmsTemplateLineItemId INT = 0
	
	DECLARE @TBL_SaveForLaterLineitems TABLE
	( 
		RowId int IDENTITY(1,1), OmsTemplateLineItemId int, ParentOmsTemplateLineItemId int, OmsTemplateId int, SKU nvarchar(600), Quantity numeric(28, 6), OrderLineItemRelationshipTypeID int, CustomText nvarchar(max), 
		CartAddOnDetails nvarchar(max), Sequence int, AddOnValueIds varchar(max), BundleProductIds varchar(max), ConfigurableProductIds varchar(max), GroupProductIds varchar(max), PersonalisedAttribute XML, 
		AutoAddon varchar(max), OmsOrderId int, ItemDetails nvarchar(max),
		Custom1	nvarchar(max),Custom2 nvarchar(max),Custom3 nvarchar(max),Custom4
		nvarchar(max),Custom5 nvarchar(max),GroupId NVARCHAR(max) ,ProductName Nvarchar(1000) , Description NVARCHAR(max),AddOnQuantity NVARCHAR(max), CustomUnitPrice numeric(28, 6)
	);

	--Set the OrderLineItemRelationshipTypeId for Addons product
	DECLARE @OrderLineItemRelationshipTypeIdAddon int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'AddOns'
	);
	--Set the OrderLineItemRelationshipTypeId for simple product
	DECLARE @OrderLineItemRelationshipTypeIdSimple int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Simple'
	);
	--Set the OrderLineItemRelationshipTypeId for group product
	DECLARE @OrderLineItemRelationshipTypeIdGroup int=
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Group'
	);
	--Set the OrderLineItemRelationshipTypeId for Configurable product
	DECLARE @OrderLineItemRelationshipTypeIdConfigurable int=
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Configurable'
	);
	--Set the OrderLineItemRelationshipTypeId for Bundles product	
	DECLARE @OrderLineItemRelationshipTypeIdBundle int=
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Bundles'
	);

	

	--Fetching data FROM xml to table format and inserted into table @TBL_SaveForLaterLineitems
	INSERT INTO @TBL_SaveForLaterLineitems( OmsTemplateLineItemId, ParentOmsTemplateLineItemId, OmsTemplateId, SKU, Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence, AddOnValueIds, BundleProductIds, ConfigurableProductIds, GroupProductIds, PersonalisedAttribute, AutoAddon, OmsOrderId, ItemDetails,
	Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,Description,AddOnQuantity, CustomUnitPrice )
	SELECT Tbl.Col.value( 'OmsTemplateLineItemId[1]', 'NVARCHAR(2000)' ) AS OmsTemplateLineItemId, Tbl.Col.value( 'ParentOmsTemplateLineItemId[1]', 'NVARCHAR(2000)' ) AS ParentOmsTemplateLineItemId, 
	Tbl.Col.value('OmsTemplateId[1]', 'NVARCHAR(2000)')  AS OmsTemplateId, Tbl.Col.value( 'SKU[1]', 'NVARCHAR(2000)' ) AS SKU, Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(2000)' ) AS Quantity
	, Tbl.Col.value( 'OrderLineItemRelationshipTypeID[1]', 'NVARCHAR(2000)' ) AS OrderLineItemRelationshipTypeID, Tbl.Col.value( 'CustomText[1]', 'NVARCHAR(2000)' ) AS CustomText, Tbl.Col.value( 'CartAddOnDetails[1]', 'NVARCHAR(2000)' ) AS CartAddOnDetails, Tbl.Col.value( 'Sequence[1]', 'NVARCHAR(2000)' ) AS Sequence, s.Item AS AddOnValueIds, ISNULL(Tbl.Col.value( 'BundleProducts[1]', 'NVARCHAR(2000)' ),'') AS BundleProductIds, ISNULL(Tbl.Col.value( 'ConfigurableProducts[1]', 'NVARCHAR(2000)' ),'') AS ConfigurableProductIds, ISNULL(Tbl.Col.value( 'GroupProducts[1]', 'NVARCHAR(Max)' ),'') AS GroupProductIds, 
			Tbl.Col.query('(PersonaliseValuesDetail/node())') AS PersonaliseValuesDetail, Tbl.Col.value( 'AutoAddon[1]', 'NVARCHAR(Max)' ) AS AutoAddon, Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(Max)' ) AS OmsOrderId,
			Tbl.Col.value( 'ItemDetails[1]', 'NVARCHAR(Max)' ) AS ItemDetails,
			Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
			Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
			Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
			Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
			Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
			Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
			Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(Max)' ) AS ProductName,
			Tbl.Col.value( 'Description[1]', 'NVARCHAR(Max)' ) AS Description, 
			Tbl.Col.value( 'AddOnQuantity[1]', 'NVARCHAR(2000)' ) AS AddOnQuantity,
			CASE WHEN ISNULL(Tbl.Col.value( 'CustomUnitPrice[1]', 'NVARCHAR(2000)' ),'') = '' THEN NULL ELSE Tbl.Col.value( 'CustomUnitPrice[1]', 'NVARCHAR(2000)' ) END AS CustomUnitPrice
	FROM @TemplateLineItemXML.nodes( '//ArrayOfAccountTemplateLineItemModel/AccountTemplateLineItemModel' ) AS Tbl(Col)
	CROSS APPLY dbo.split(Tbl.Col.value( 'AddonProducts[1]', 'NVARCHAR(2000)' ),',') as S;

	IF OBJECT_ID('tempdb..#TBL_SaveForLaterLineitems') is not null
		DROP TABLE #TBL_SaveForLaterLineitems

	IF OBJECT_ID('tempdb..#OldValueForAddon') is not null
		DROP TABLE #OldValueForAddon

	SELECT * INTO #TBL_SaveForLaterLineitems FROM @TBL_SaveForLaterLineitems
			
	UPDATE ZnodeOmsTemplate
	SET ModifiedDate = GETDATE()
	WHERE OmsTemplateId = (SELECT TOP 1  OmsTemplateId FROM @TBL_SaveForLaterLineitems)

	UPDATE  @TBL_SaveForLaterLineitems
	SET Description = ISNUll(Description,'') 

	--Save cart execution code for bundle product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SaveForLaterLineitems WHERE BundleProductIds <> '' )
	BEGIN 				
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SaveForLaterLineitems WHERE BundleProductIds <> '' AND OmsTemplateLineItemId <> 0  ) 
		BEGIN 
			SET @OmsTemplateLineItemId  = (SELECT TOP 1 OmsTemplateLineItemId FROM @TBL_SaveForLaterLineitems WHERE BundleProductIds <> '' AND OmsTemplateLineItemId <> 0 )

			UPDATE ZnodeOmsTemplateLineItem 
			SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SaveForLaterLineitems WHERE BundleProductIds <> '' AND OmsTemplateLineItemId <> 0)
			, ModifiedDate = @GetDate, CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SaveForLaterLineitems)
			WHERE ( OmsTemplateLineItemId = @OmsTemplateLineItemId  
			OR ParentOmsTemplateLineItemId =  @OmsTemplateLineItemId   ) 

			UPDATE ZnodeOmsTemplateLineItem 
			SET Quantity = AddOnQuantity, ModifiedDate = @GetDate,CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SaveForLaterLineitems)
			FROM ZnodeOmsTemplateLineItem ZOSCLI with (nolock)
			INNER JOIN @TBL_SaveForLaterLineitems SCLI ON ZOSCLI.ParentOmsTemplateLineItemId = SCLI.OmsTemplateLineItemId AND ZOSCLI.OmsTemplateId = SCLI.OmsTemplateId AND ZOSCLI.SKU = SCLI.AddOnValueIds
			WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
			AND SCLI.BundleProductIds <> ''

			--After update the existing cart with new save cart then deleting those records which are updated
			DELETE	FROM @TBL_SaveForLaterLineitems WHERE BundleProductIds <> '' AND OmsTemplateLineItemId <> 0
		END 

		--Getting bundle save cart line item entries into table to pass for bundle prodcut sp
		DECLARE @TBL_bundleProduct SaveForLaterLineitems 
		INSERT INTO @TBL_bundleProduct 
		SELECT *  
		FROM @TBL_SaveForLaterLineitems 
		WHERE ISNULL(BundleProductIds,'') <> '' 
				
		EXEC Znode_InsertUpdateSaveForLaterLineItemBundle @TBL_bundleProduct,@userId,@OrderLineItemRelationshipTypeIdBundle,@OrderLineItemRelationshipTypeIdAddon
				 
		DELETE FROM  @TBL_SaveForLaterLineitems WHERE ISNULL(BundleProductIds,'') <> '' 
		SET @OmsTemplateLineItemId = 0 
	END 
	--Save cart execution code for configurable product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SaveForLaterLineitems WHERE ConfigurableProductIds <> '' )
	BEGIN 				
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SaveForLaterLineitems WHERE ConfigurableProductIds <> '' AND OmsTemplateLineItemId <> 0  ) 
		BEGIN 

			SET @OmsTemplateLineItemId  = (SELECT TOP 1 OmsTemplateLineItemId FROM @TBL_SaveForLaterLineitems WHERE ConfigurableProductIds <> '' AND OmsTemplateLineItemId <> 0 )
				 
			UPDATE ZnodeOmsTemplateLineItem 
			SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SaveForLaterLineitems WHERE ConfigurableProductIds <> '' AND OmsTemplateLineItemId = @OmsTemplateLineItemId )
			, ModifiedDate = @GetDate,CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SaveForLaterLineitems)
			WHERE OmsTemplateLineItemId = @OmsTemplateLineItemId

			UPDATE ZnodeOmsTemplateLineItem 
			SET Quantity = AddOnQuantity, ModifiedDate = @GetDate, CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SaveForLaterLineitems)
			FROM ZnodeOmsTemplateLineItem ZOSCLI with (nolock)
			INNER JOIN @TBL_SaveForLaterLineitems SCLI ON ZOSCLI.ParentOmsTemplateLineItemId = SCLI.OmsTemplateLineItemId AND ZOSCLI.OmsTemplateId = SCLI.OmsTemplateId AND ZOSCLI.SKU = SCLI.AddOnValueIds
			WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
			AND SCLI.ConfigurableProductIds <> ''

			--After update the existing cart with new save cart then deleting those records which are updated
			DELETE	FROM @TBL_SaveForLaterLineitems WHERE ConfigurableProductIds <> '' AND OmsTemplateLineItemId <> 0
		END 
		--Getting bundle save cart line item entries into table to pass for configurable prodcut sp
		DECLARE @TBL_Configurable SaveForLaterLineitems 
		INSERT INTO @TBL_Configurable 
		SELECT *  
		FROM @TBL_SaveForLaterLineitems 
		WHERE ISNULL(ConfigurableProductIds,'') <> '' 
		  
		EXEC Znode_InsertUpdateSaveForLaterLineItemConfigurable @TBL_Configurable,@userId,@OrderLineItemRelationshipTypeIdConfigurable,@OrderLineItemRelationshipTypeIdAddon
				  
		DELETE FROM @TBL_SaveForLaterLineitems 
		WHERE ISNULL(ConfigurableProductIds,'') <> ''
		SET @OmsTemplateLineItemId = 0  
	END 
	--Save cart execution code for group product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SaveForLaterLineitems WHERE GroupProductIds <> '' )
	BEGIN 				
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SaveForLaterLineitems WHERE GroupProductIds <> '' AND OmsTemplateLineItemId <> 0  ) 
		BEGIN 
			--Updating the existing save cart for group product
			SET @OmsTemplateLineItemId  = (SELECT TOP 1 OmsTemplateLineItemId FROM @TBL_SaveForLaterLineitems WHERE GroupProductIds <> '' AND OmsTemplateLineItemId <> 0 )
			UPDATE ZnodeOmsTemplateLineItem 
			SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SaveForLaterLineitems WHERE GroupProductIds <> '' AND OmsTemplateLineItemId = @OmsTemplateLineItemId ), CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SaveForLaterLineitems)
			WHERE OmsTemplateLineItemId = @OmsTemplateLineItemId

			UPDATE ZnodeOmsTemplateLineItem 
			SET Quantity = AddOnQuantity, ModifiedDate = @GetDate, CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SaveForLaterLineitems)
			FROM ZnodeOmsTemplateLineItem ZOSCLI with (nolock)
			INNER JOIN @TBL_SaveForLaterLineitems SCLI ON ZOSCLI.ParentOmsTemplateLineItemId = SCLI.OmsTemplateLineItemId AND ZOSCLI.OmsTemplateId = SCLI.OmsTemplateId AND ZOSCLI.SKU = SCLI.AddOnValueIds
			WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
			AND SCLI.GroupProductIds <> ''

			--After update the existing cart with new save cart then deleting those records which are updated
			DELETE	FROM @TBL_SaveForLaterLineitems WHERE GroupProductIds <> '' AND OmsTemplateLineItemId <> 0
		END 
		--Getting bundle save cart line item entries into table to pass for group prodcut sp
		DECLARE @TBL_Group SaveForLaterLineitems 
		INSERT INTO @TBL_Group 
		SELECT *  
		FROM @TBL_SaveForLaterLineitems 
		WHERE ISNULL(GroupProductIds,'') <> '' 
		
		EXEC Znode_InsertUpdateSaveForLaterLineItemGroup @TBL_Group,@userId,@OrderLineItemRelationshipTypeIdGroup,@OrderLineItemRelationshipTypeIdAddon
		
		--After update the existing cart with new save cart then deleting those records which are updated
		DELETE FROM @TBL_SaveForLaterLineitems WHERE ISNULL(GroupProductIds,'') <> ''
		SET @OmsTemplateLineItemId = 0  
	END 
	
	--This part is for updating the cart for existing line items for simple product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SaveForLaterLineitems WHERE  OmsTemplateLineItemId <> 0  ) 
	BEGIN 
				 
		SET @OmsTemplateLineItemId  = (SELECT TOP 1 OmsTemplateLineItemId FROM @TBL_SaveForLaterLineitems WHERE  OmsTemplateLineItemId <> 0 )
		UPDATE ZnodeOmsTemplateLineItem 
		SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SaveForLaterLineitems WHERE  OmsTemplateLineItemId = @OmsTemplateLineItemId )
		, ModifiedDate = @GetDate , CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SaveForLaterLineitems)
		WHERE OmsTemplateLineItemId = @OmsTemplateLineItemId

		DECLARE @ParentOmsTemplateLineItemId INT = 0
		SET @ParentOmsTemplateLineItemId = (select ParentOmsTemplateLineItemId from ZnodeOmsTemplateLineItem WHERE OmsTemplateLineItemId = @OmsTemplateLineItemId)

		UPDATE ZnodeOmsTemplateLineItem 
		SET  CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SaveForLaterLineitems)
		WHERE OmsTemplateLineItemId = @ParentOmsTemplateLineItemId

		UPDATE ZnodeOmsTemplateLineItem 
		SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
		FROM ZnodeOmsTemplateLineItem ZOSCLI with (nolock)
		INNER JOIN @TBL_SaveForLaterLineitems SCLI ON ZOSCLI.ParentOmsTemplateLineItemId = @OmsTemplateLineItemId AND ZOSCLI.OmsTemplateId = SCLI.OmsTemplateId AND ZOSCLI.SKU = SCLI.AddOnValueIds
		WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					
		DELETE	FROM @TBL_SaveForLaterLineitems WHERE OmsTemplateLineItemId <> 0
	END 
	--Save cart execution code for Simple product
	DECLARE @OmsInsertedData TABLE (OmsTemplateLineItemId INT )
	--Inserting the personalise data into variable table @TBL_Personalise for inserting the personalise data for new products
	DECLARE @TBL_Personalise TABLE (OmsTemplateLineItemId INT, ParentOmsTemplateLineItemId int,SKU Varchar(600) ,PersonalizeCode NVARCHAr(max),PersonalizeValue NVARCHAr(max),DesignId NVARCHAr(max), ThumbnailURL NVARCHAr(max),PersonalizeName NVARCHAR(max))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsTemplateLineItemId,a.SKU
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(Max)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(Max)' ) AS ThumbnailURL
			,Tbl.Col.value( 'PersonalizeName[1]', 'NVARCHAR(Max)' ) AS PersonalizeName
	FROM @TBL_SaveForLaterLineitems a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col) 
			  
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise1 TABLE (OmsTemplateLineItemId INT ,PersonalizeCode NVARCHAr(max),PersonalizeValue NVARCHAr(max),DesignId NVARCHAr(max), ThumbnailURL NVARCHAr(max),PersonalizeName NVARCHAR(max))
	INSERT INTO @TBL_Personalise1
	SELECT DISTINCT a.OmsTemplateLineItemId 
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(Max)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(Max)' ) AS ThumbnailURL
			,Tbl.Col.value( 'PersonalizeName[1]', 'NVARCHAR(Max)' ) AS PersonalizeName
	FROM (SELECT TOP 1 OmsTemplateLineItemId,PersonalisedAttribute Valuex FROM  #TBL_SaveForLaterLineitems TRTR ) a 
	CROSS APPLY	a.Valuex.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  
		    
			
	CREATE TABLE #NewSaveForLaterLineitemDetails 
	(
		GenId INT IDENTITY(1,1),RowId	INT	,OmsTemplateLineItemId	INT	 ,ParentOmsTemplateLineItemId	INT,OmsTemplateId	INT
		,SKU	NVARCHAR(MAX) ,Quantity	NUMERIC(28,6)	,OrderLineItemRelationshipTypeID	INT	,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	int	,AutoAddon	varchar(MAX)	,OmsOrderId	INT	,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX)
	)
	
	--Getting new save cart data
	INSERT INTO #NewSaveForLaterLineitemDetails
	SELECT  Min(RowId )RowId ,OmsTemplateLineItemId, ParentOmsTemplateLineItemId, OmsTemplateId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU 
	FROM @TBL_SaveForLaterLineitems a 
	GROUP BY  OmsTemplateLineItemId, ParentOmsTemplateLineItemId, OmsTemplateId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
	
	--Getting new simple product save cart data
	INSERT INTO #NewSaveForLaterLineitemDetails
	SELECT  Min(RowId )RowId ,OmsTemplateLineItemId, ParentOmsTemplateLineItemId, OmsTemplateId, SKU
		,Quantity, @OrderLineItemRelationshipTypeIdSimple, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU 
	FROM @TBL_SaveForLaterLineitems  a 
	WHERE ISNULL(BundleProductIds,'') =  '' 
	AND  ISNULL(GroupProductIds,'') = ''	AND ISNULL(	ConfigurableProductIds,'') = ''
		GROUP BY  OmsTemplateLineItemId, ParentOmsTemplateLineItemId, OmsTemplateId, SKU
		,Quantity,  CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
			
	--Getting new Group,Bundle and Configurable products save cart data if addon is present for any line item
	INSERT INTO #NewSaveForLaterLineitemDetails
	SELECT  Min(RowId )RowId ,OmsTemplateLineItemId, ParentOmsTemplateLineItemId, OmsTemplateId, AddOnValueIds
		,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
		,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
		WHEN  GroupProductIds <> '' THEN GroupProductIds 
		WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU 
	FROM @TBL_SaveForLaterLineitems  a 
	WHERE AddOnValueIds <> ''
	GROUP BY  OmsTemplateLineItemId, ParentOmsTemplateLineItemId, OmsTemplateId, AddOnValueIds
	,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
	
	CREATE TABLE #OldSaveForLaterLineitemDetails (OmsTemplateId INT ,OmsTemplateLineItemId INT,ParentOmsTemplateLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old save cart data if present for same SKU in the new save cart data for simple product	 
	INSERT INTO #OldSaveForLaterLineitemDetails  
	SELECT  a.OmsTemplateId,a.OmsTemplateLineItemId,a.ParentOmsTemplateLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM ZnodeOmsTemplateLineItem a with (nolock)  
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SaveForLaterLineitems  TY WHERE TY.OmsTemplateId = a.OmsTemplateId AND ISNULL(a.SKU,'') = ISNULL(TY.SKU,'')   )   
	AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple   

	--Getting the old save cart Parent data 
	INSERT INTO #OldSaveForLaterLineitemDetails 
	SELECT DISTINCT b.OmsTemplateId,b.OmsTemplateLineItemId,b.ParentOmsTemplateLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsTemplateLineItem b with (nolock)
	INNER JOIN #OldSaveForLaterLineitemDetails c ON (c.ParentOmsTemplateLineItemId  = b.OmsTemplateLineItemId AND c.OmsTemplateId = b.OmsTemplateId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SaveForLaterLineitems  TY WHERE TY.OmsTemplateId = b.OmsTemplateId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
	AND  b.OrderLineItemRelationshipTypeID IS NULL 
		 
	DELETE a FROM #OldSaveForLaterLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldSaveForLaterLineitemDetails b WHERE b.ParentOmsTemplateLineItemId IS NULL AND b.OmsTemplateLineItemId = a.ParentOmsTemplateLineItemId)
	AND a.ParentOmsTemplateLineItemId IS NOT NULL 
		
	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldSaveForLaterLineitemDetails
		
	--Getting the old save cart addon data for old line items if present
	INSERT INTO #OldSaveForLaterLineitemDetails 
	SELECT b.OmsTemplateId,b.OmsTemplateLineItemId,b.ParentOmsTemplateLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsTemplateLineItem b with (nolock)
	INNER JOIN #OldSaveForLaterLineitemDetails c ON (c.OmsTemplateLineItemId  = b.ParentOmsTemplateLineItemId AND c.OmsTemplateId = b.OmsTemplateId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SaveForLaterLineitems  TY WHERE TY.OmsTemplateId = b.OmsTemplateId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
	AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

	------Merge Addon for same product
	IF EXISTS(SELECT * FROM @TBL_SaveForLaterLineitems WHERE ISNULL(AddOnValueIds,'') <> '' )
	BEGIN

		INSERT INTO #OldValueForAddon 
		SELECT b.OmsTemplateId,b.OmsTemplateLineItemId,b.ParentOmsTemplateLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
		FROM ZnodeOmsTemplateLineItem b with (nolock)
		INNER JOIN #OldValueForAddon c ON (c.OmsTemplateLineItemId  = b.ParentOmsTemplateLineItemId AND c.OmsTemplateId = b.OmsTemplateId)
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SaveForLaterLineitems  TY WHERE TY.OmsTemplateId = b.OmsTemplateId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
								( SELECT  ', ' + SKU FROM    
									( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
										where a.OmsTemplateLineItemId=b.ParentOmsTemplateLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
										FOR XML PATH('')
								), 1, 2, ''
								) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a where a.ParentOmsTemplateLineItemId is not null and OrderLineItemRelationshipTypeID<>1

		SELECT distinct a.SKU, STUFF(
									( SELECT  ', ' + x.AddOnValueIds FROM    
									( SELECT DISTINCT b.AddOnValueIds FROM @TBL_SaveForLaterLineitems b
										where a.SKU=b.SKU ) x
										FOR XML PATH('')
									), 1, 2, ''
								) AddOns
		INTO #AddOnAdded
		FROM @TBL_SaveForLaterLineitems a

		IF NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
		BEGIN
			DELETE FROM #OldSaveForLaterLineitemDetails
		END

	END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSaveForLaterLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_SaveForLaterLineitems ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldSaveForLaterLineitemDetails a WHERE	
	ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_SaveForLaterLineitems WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN 
		
		DELETE FROM #OldSaveForLaterLineitemDetails 
	END 
	ELSE 
	BEGIN 
	    
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SaveForLaterLineitems WHERE ISNULL(AddOnValueIds,'')  <> '' )
		BEGIN 
		 
			DECLARE @parenTofAddon  TABLE( ParentOmsTemplateLineItemId INT  )  
			INSERT INTO  @parenTofAddon 
			SELECT  ParentOmsTemplateLineItemId FROM #OldSaveForLaterLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  

			DELETE FROM #OldSaveForLaterLineitemDetails WHERE OmsTemplateLineItemId NOT IN (SELECT ParentOmsTemplateLineItemId FROM  @parenTofAddon)   
				AND ParentOmsTemplateLineItemId IS NOT NULL  
				AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

			DELETE FROM #OldSaveForLaterLineitemDetails WHERE OmsTemplateLineItemId NOT IN (SELECT ISNULL(m.ParentOmsTemplateLineItemId,0) FROM #OldSaveForLaterLineitemDetails m)
			AND ParentOmsTemplateLineItemId IS  NULL  
		 
		END 
		ELSE IF (SELECT COUNT (OmsTemplateLineItemId) FROM #OldSaveForLaterLineitemDetails WHERE ParentOmsTemplateLineItemId IS NULL ) > 1 
		BEGIN 

			DECLARE @TBL_deleteParentOmsTemplateLineItemId TABLE (OmsTemplateLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsTemplateLineItemId 
			SELECT ParentOmsTemplateLineItemId
			FROM ZnodeOmsTemplateLineItem a with (nolock)
			WHERE ParentOmsTemplateLineItemId IN (SELECT OmsTemplateLineItemId FROM #OldSaveForLaterLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple  )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldSaveForLaterLineitemDetails WHERE OmsTemplateLineItemId IN (SELECT OmsTemplateLineItemId FROM @TBL_deleteParentOmsTemplateLineItemId)
			OR ParentOmsTemplateLineItemId IN (SELECT OmsTemplateLineItemId FROM @TBL_deleteParentOmsTemplateLineItemId)
		    
			DELETE FROM #OldSaveForLaterLineitemDetails WHERE OmsTemplateLineItemId NOT IN (SELECT ISNULL(m.ParentOmsTemplateLineItemId,0) FROM #OldSaveForLaterLineitemDetails m)
			AND ParentOmsTemplateLineItemId IS  NULL  

		END
		ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsTemplateLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldSaveForLaterLineitemDetails ty WHERE ty.OmsTemplateId = wt.OmsTemplateId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple AND wt.ParentOmsTemplateLineItemId= ty.OmsTemplateLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_SaveForLaterLineitems WHERE ISNULL(AddOnValueIds,'')  = '' )
		BEGIN 

			DELETE FROM #OldSaveForLaterLineitemDetails
		END 
	END 

	--Getting the personalise data for old save cart if present
	DECLARE @TBL_Personaloldvalues TABLE (OmsTemplateLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsTemplateLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsTemplatePersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldSaveForLaterLineitemDetails TY WHERE TY.OmsTemplateLineItemId = a.OmsTemplateLineItemId)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)

	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		DELETE FROM #OldSaveForLaterLineitemDetails
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsTemplateLineItemId ) FROM #OldSaveForLaterLineitemDetails WHERE ParentOmsTemplateLineItemId IS nULL ) > 1 
		BEGIN 
		   
			DELETE FROM #OldSaveForLaterLineitemDetails WHERE OmsTemplateLineItemId IN (
			SELECT OmsTemplateLineItemId FROM #OldSaveForLaterLineitemDetails WHERE OmsTemplateLineItemId NOT IN (SELECT OmsTemplateLineItemId FROM @TBL_Personaloldvalues )
			AND ParentOmsTemplateLineItemId NOT IN (SELECT OmsTemplateLineItemId FROM @TBL_Personaloldvalues ) ) 
			OR OmsTemplateLineItemId IN ( SELECT ParentOmsTemplateLineItemId FROM #OldSaveForLaterLineitemDetails WHERE OmsTemplateLineItemId NOT IN (SELECT OmsTemplateLineItemId FROM @TBL_Personaloldvalues )
			AND ParentOmsTemplateLineItemId NOT IN (SELECT OmsTemplateLineItemId FROM @TBL_Personaloldvalues ))
		      
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsTemplateLineItemId ) FROM #OldSaveForLaterLineitemDetails WHERE ParentOmsTemplateLineItemId IS nULL ) > 1 
		BEGIN 

			DELETE n FROM #OldSaveForLaterLineitemDetails n WHERE OmsTemplateLineItemId  IN (SELECT OmsTemplateLineItemId FROM ZnodeOmsTemplatePersonalizeCartItem WHERE n.OmsTemplateLineItemId = ZnodeOmsTemplatePersonalizeCartItem.OmsTemplateLineItemId  )
			OR ParentOmsTemplateLineItemId  IN (SELECT OmsTemplateLineItemId FROM ZnodeOmsTemplatePersonalizeCartItem   )
	   
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsTemplatePersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldSaveForLaterLineitemDetails YU WHERE YU.OmsTemplateLineItemId = m.OmsTemplateLineItemId )) 
		AND (SELECT COUNT (DISTINCT OmsTemplateLineItemId ) FROM #OldSaveForLaterLineitemDetails WHERE ParentOmsTemplateLineItemId IS nULL ) = 1
		BEGIN 
			DELETE FROM #OldSaveForLaterLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		END 
	  
	END 

	--If already exists cart 
	IF EXISTS (SELECT TOP 1 1 FROM #OldSaveForLaterLineitemDetails )
	BEGIN
		----DELETE old value FROM table which having personalise data in ZnodeOmsTemplatePersonalizeCartItem but same SKU not having personalise value for new cart item
		;WITH cte AS
		(
			SELECT distinct b.*
			FROM @TBL_SaveForLaterLineitems a 
			INNER JOIN #OldSaveForLaterLineitemDetails b on ( a.SKU = b.sku)
			where isnull(cast(a.PersonalisedAttribute AS varchar(max)),'') = ''
		)
		,cte2 AS
		(
			SELECT c.ParentOmsTemplateLineItemId
			FROM #OldSaveForLaterLineitemDetails a
			INNER JOIN ZnodeOmsTemplateLineItem c on a.OmsTemplateLineItemId = c.ParentOmsTemplateLineItemId
			INNER JOIN ZnodeOmsTemplatePersonalizeCartItem b on b.OmsTemplateLineItemId = c.OmsTemplateLineItemId
		)
		DELETE a FROM #OldSaveForLaterLineitemDetails a
		INNER JOIN cte b on a.OmsTemplateLineItemId = b.OmsTemplateLineItemId
		INNER JOIN cte2 c on (a.OmsTemplateLineItemId = c.ParentOmsTemplateLineItemId or a.ParentOmsTemplateLineItemId = c.ParentOmsTemplateLineItemId)

		----DELETE old value FROM table which having personalise data in ZnodeOmsTemplatePersonalizeCartItem but same SKU having personalise value for new cart item
		;WITH cte AS
		(
			SELECT distinct b.*, 
				a.PersonalizeCode
				,a.PersonalizeValue
			FROM @TBL_Personalise a 
			INNER JOIN #OldSaveForLaterLineitemDetails b on ( a.SKU = b.sku)
			where a.PersonalizeValue <> ''
		)
		,cte2 AS
		(
			SELECT a.ParentOmsTemplateLineItemId, b.PersonalizeCode, b.PersonalizeValue
			FROM #OldSaveForLaterLineitemDetails a
			INNER JOIN ZnodeOmsTemplatePersonalizeCartItem b on b.OmsTemplateLineItemId = a.OmsTemplateLineItemId
			WHERE NOT EXISTS(SELECT * FROM cte c where b.OmsTemplateLineItemId = c.OmsTemplateLineItemId and b.PersonalizeCode = c.PersonalizeCode 
						and b.PersonalizeValue = c.PersonalizeValue )
		)
		DELETE a FROM #OldSaveForLaterLineitemDetails a
		INNER JOIN cte b on a.OmsTemplateLineItemId = b.OmsTemplateLineItemId
		INNER JOIN cte2 c on (a.OmsTemplateLineItemId = c.ParentOmsTemplateLineItemId or a.ParentOmsTemplateLineItemId = c.ParentOmsTemplateLineItemId)

		;WITH cte AS
		(
			SELECT b.OmsTemplateLineItemId ,b.ParentOmsTemplateLineItemId , a.SKU AS SKU
				,a.PersonalizeCode
				,a.PersonalizeValue
				,a.DesignId
				,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldSaveForLaterLineitemDetails b on a.SKU = b.SKU
			INNER JOIN ZnodeOmsTemplatePersonalizeCartItem c on b.OmsTemplateLineItemId = c.OmsTemplateLineItemId
			WHERE a.OmsTemplateLineItemId = 0
		)
		DELETE b1
		FROM #OldSaveForLaterLineitemDetails b1 
		WHERE NOT EXISTS(SELECT * FROM cte c where (b1.OmsTemplateLineItemId = c.ParentOmsTemplateLineItemId or b1.ParentOmsTemplateLineItemId = c.ParentOmsTemplateLineItemId))
		AND EXISTS(SELECT * FROM cte)

		--------If lineitem present in ZnodeOmsTemplatePersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsTemplatePersonalizeCartItem and personalize value is same for same line item then Quantity will added
	-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsTemplateLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldSaveForLaterLineitemDetails b ON a.SKU = b.SKU
			INNER JOIN ZnodeOmsTemplatePersonalizeCartItem c ON b.OmsTemplateLineItemId = c.OmsTemplateLineItemId 
			--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsTemplateLineItemId,0) = 0
			GROUP BY b.OmsTemplateLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsTemplateLineItemId,0) as OmsTemplateLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewSaveForLaterLineitemDetails  b ON a.SKU = b.SKU
			WHERE isnull(a.OmsTemplateLineItemId,0) = 0 AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple
			GROUP BY a.OmsTemplateLineItemId ,b.SKU
		)
		DELETE c
		from CTE_OldPersonalizeCodeCount a
		inner join CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		inner join #OldSaveForLaterLineitemDetails c on b.SKU = c.SKU and a.OmsTemplateLineItemId = c.OmsTemplateLineItemId
		
		--Delete parent entry if child not present
		DELETE a FROM #OldSaveForLaterLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldSaveForLaterLineitemDetails b where a.OmsTemplateLineItemId = b.ParentOmsTemplateLineItemId)
		AND a.ParentOmsTemplateLineItemId IS NULL

	--------If lineitem present in ZnodeOmsTemplatePersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
	--------If lineitem present in ZnodeOmsTemplatePersonalizeCartItem and personalize value is same for same line item then Quantity will added
	
		;WITH cte AS
		(
			SELECT b.OmsTemplateLineItemId ,a.ParentOmsTemplateLineItemId , a.SKU
						,d.PersonalizeCode
				,d.PersonalizeValue
				,d.DesignId
				,d.ThumbnailURL
				FROM @TBL_SaveForLaterLineitems a 
				INNER JOIN #OldSaveForLaterLineitemDetails b on a.SKU = b.SKU
				INNER JOIN @TBL_Personalise d on d.SKU = a.SKU
				INNER JOIN ZnodeOmsTemplatePersonalizeCartItem  c  with (nolock)  on b.OmsTemplateLineItemId = c.OmsTemplateLineItemId
				WHERE a.OmsTemplateLineItemId = 0
		)
		DELETE b1
		FROM cte a1		  
		INNER JOIN #OldSaveForLaterLineitemDetails b1 on a1.sku = b1.SKU
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsTemplatePersonalizeCartItem c where a1.OmsTemplateLineItemId = c.OmsTemplateLineItemId and a1.PersonalizeValue = c.PersonalizeValue)

		--Updating the cart if old and new cart data matches 
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5, 
		a.ModifiedDate = @GetDate
		FROM ZnodeOmsTemplateLineItem a
		INNER JOIN #OldSaveForLaterLineitemDetails b ON (a.OmsTemplateLineItemId = b.OmsTemplateLineItemId)
		INNER JOIN #NewSaveForLaterLineitemDetails ty ON (ty.SKU = b.SKU)

	END 
	--Inserting the new save cart data if old and new cart data not match
	IF NOT EXISTS (SELECT TOP 1 1 FROM #OldSaveForLaterLineitemDetails )
	BEGIN 
	    --Getting the new save cart data and generating row no. for new save cart insert
		SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsTemplateLineItemId ,OmsTemplateId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU  
		INTO #InsertNewSaveForLaterLineitem   
		FROM  #NewSaveForLaterLineitemDetails  
		GROUP BY ParentOmsTemplateLineItemId ,OmsTemplateId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails ,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU   
		ORDER BY RowId, Id   
       	
		--Removing the line item having Quantity <=0	     
		DELETE FROM #InsertNewSaveForLaterLineitem WHERE Quantity <=0  
  
		--Updating the rowid into new save cart line item as new line item is merged into existing save cart item
		;WITH VTTY AS   
		(  
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
			FROM #InsertNewSaveForLaterLineitem m  
			INNER JOIN  #InsertNewSaveForLaterLineitem TY1 ON TY1.SKU = m.ParentSKU   
			WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon   
		)   
		UPDATE m1   
		SET m1.RowId = TYU.RowId  
		FROM #InsertNewSaveForLaterLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  
        
		--Deleting the new save cart line item if cart line item is merged
		;WITH VTRET AS   
		(  
			SELECT RowId,id,Min(NewRowId) NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID  
			FROM #InsertNewSaveForLaterLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID
			Having  SKU = ParentSKU  AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdSimple
		)   
		DELETE FROM #InsertNewSaveForLaterLineitem WHERE NewRowId IN (SELECT NewRowId FROM VTRET)  


		--Inserting the new cart line item if not merged in existing save cart line item
		INSERT INTO  ZnodeOmsTemplateLineItem (ParentOmsTemplateLineItemId ,OmsTemplateId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description)  
		OUTPUT INSERTED.OmsTemplateLineItemId  INTO @OmsInsertedData 
		SELECT NULL ,OmsTemplateId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description   
		FROM  #InsertNewSaveForLaterLineitem  TH  
		
		SELECT  MAX(a.OmsTemplateLineItemId ) OmsTemplateLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU  
		INTO #ParentOmsTemplateId
		FROM ZnodeOmsTemplateLineItem a with (nolock) 
		INNER JOIN #InsertNewSaveForLaterLineitem b ON (a.OmsTemplateId = b.OmsTemplateId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsTemplateLineItemId,0) =0  
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		AND CASE WHEN EXISTS (SELECT TOP 1 1 FROM #InsertNewSaveForLaterLineitem TU WHERE TU.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple)  THEN ISNULL(a.OrderLineItemRelationshipTypeID,0) ELSE 0 END = 0 
		GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID

		UPDATE a SET a.ParentOmsTemplateLineItemId = (SELECT TOP 1 OmsTemplateLineItemId FROM  #ParentOmsTemplateId  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsTemplateLineItem a  
		INNER JOIN #InsertNewSaveForLaterLineitem b ON (a.OmsTemplateId = b.OmsTemplateId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
		AND a.ParentOmsTemplateLineItemId IS nULL   

		SELECT a.OmsTemplateLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(Order BY c.OmsTemplateLineItemId )RowIdNo
		INTO #NewSimpleProduct
		FROM ZnodeOmsTemplateLineItem a with (nolock) 
		INNER JOIN #InsertNewSaveForLaterLineitem b ON (a.OmsTemplateId = b.OmsTemplateId AND a.SKU = b.ParentSKU AND ( b.Id = 1  ))  
		INNER JOIN ZnodeOmsTemplateLineItem c on b.sku = c.sku and b.OmsTemplateId=c.OmsTemplateId and b.Id = 1 
		WHERE ( ISNULL(a.ParentOmsTemplateLineItemId,0) <> 0   )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  and c.ParentOmsTemplateLineItemId is null

		--Updating ParentOmsTemplateLineItemId for newly added save cart line item
		;WITH table_update AS 
		(
			SELECT * , ROW_NUMBER()Over(Order BY OmsTemplateLineItemId  ) RowIdNo
			FROM ZnodeOmsTemplateLineItem a with (nolock)
			WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
			AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
			AND a.ParentOmsTemplateLineItemId IS NULL  
			AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewSaveForLaterLineitem ty WHERE ty.OmsTemplateId = a.OmsTemplateId )
			AND EXISTS (SELECT TOP 1 1 FROM #NewSimpleProduct TI WHERE TI.SKU = a.SKU)
		)
		UPDATE a SET  
		a.ParentOmsTemplateLineItemId =(SELECT TOP 1 max(OmsTemplateLineItemId) 
		FROM #NewSimpleProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewSaveForLaterLineitem b ON (a.OmsTemplateId = b.OmsTemplateId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsTemplateLineItemId) 
		FROM #NewSimpleProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU   GROUP BY r.ParentSKU, r.SKU  )    IS NOT NULL 
	 
		;WITH Cte_Th AS   
		(             
			SELECT RowId    
			FROM #InsertNewSaveForLaterLineitem a   
			GROUP BY RowId   
			HAVING COUNT(NewRowId) <= 1   
		)   
		UPDATE a SET a.Quantity =  NULL , a.ModifiedDate = @GetDate  
		FROM ZnodeOmsTemplateLineItem a  
		INNER JOIN #InsertNewSaveForLaterLineitem b ON (a.OmsTemplateId = b.OmsTemplateId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE  ZnodeOmsTemplateLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewSaveForLaterLineitem RT WHERE RT.OmsTemplateId = ZnodeOmsTemplateLineItem.OmsTemplateId )  
		AND OrderLineItemRelationshipTypeId IS NOT NULL     

		;WITH Cte_UpdateSequence AS   
		(  
			SELECT OmsTemplateLineItemId ,Row_Number()Over(Order By OmsTemplateLineItemId) RowId , Sequence   
			FROM ZnodeOmsTemplateLineItem with (nolock)  
			WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewSaveForLaterLineitem TH WHERE TH.OmsTemplateId = ZnodeOmsTemplateLineItem.OmsTemplateId )  
		)   
		UPDATE Cte_UpdateSequence  
		SET  Sequence = RowId  
	
		----To update saved cart item personalise value FROM given line item	
		IF EXISTS(SELECT * FROM @TBL_Personalise1 where isnull(PersonalizeValue,'') <> '' and isnull(OmsTemplateLineItemId,0) <> 0)
		BEGIN
			DELETE FROM ZnodeOmsTemplatePersonalizeCartItem 
			WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise1 yu WHERE yu.OmsTemplateLineItemId = ZnodeOmsTemplatePersonalizeCartItem.OmsTemplateLineItemId )

			MERGE INTO ZnodeOmsTemplatePersonalizeCartItem TARGET 
			USING @TBL_Personalise1 SOURCE
			ON (TARGET.OmsTemplateLineItemId = SOURCE.OmsTemplateLineItemId ) 
			WHEN NOT MATCHED THEN 
			INSERT  ( OmsTemplateLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
							,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL, PersonalizeName )
			VALUES (  SOURCE.OmsTemplateLineItemId,  @userId, @getdate, @userId, @getdate
							,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL, SOURCE.PersonalizeName ) ;
		END		
	
		UPDATE @TBL_Personalise
		SET OmsTemplateLineItemId = b.OmsTemplateLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN ZnodeOmsTemplateLineItem b ON (a.OmsTemplateLineItemId = b.OmsTemplateLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsTemplateLineItemId IS NOT NULL 
	
		DELETE FROM ZnodeOmsTemplatePersonalizeCartItem 
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsTemplateLineItemId = ZnodeOmsTemplatePersonalizeCartItem.OmsTemplateLineItemId )
						
		MERGE INTO ZnodeOmsTemplatePersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
		ON (TARGET.OmsTemplateLineItemId = SOURCE.OmsTemplateLineItemId ) 
		WHEN NOT MATCHED THEN 
		INSERT  ( OmsTemplateLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
					,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL, PersonalizeName )
		VALUES (  SOURCE.OmsTemplateLineItemId,  @userId, @getdate, @userId, @getdate
					,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL, SOURCE.PersonalizeName ) ;
  
		
		 
	END 
	SET @Status = 1
COMMIT TRAN InsertUpdateSaveForLaterLineItem;
END TRY
BEGIN CATCH
	SET @Status = 0
	SELECT ERROR_MESSAGE()	
	DECLARE @Error_procedure varchar(1000)= ERROR_PROCEDURE(), @ErrorMessage nvarchar(max)= ERROR_MESSAGE(), @ErrorLine varchar(100)= ERROR_LINE(), @ErrorCall nvarchar(max)= 'EXEC Znode_InsertUpdateSaveForLaterLineItemQuantityWrapper @TemplateLineItemXML = '+CAST(@TemplateLineItemXML
	AS varchar(max))+',@UserId = '+CAST(@UserId AS varchar(50));

	SELECT 0 AS ID, CAST(0 AS bit) AS Status,ERROR_MESSAGE();
	ROLLBACK TRAN InsertUpdateSaveForLaterLineItem;
	EXEC Znode_InsertProcedureErrorLog @ProcedureName = 'Znode_InsertUpdateSaveForLaterLineItemQuantityWrapper', @ErrorInProcedure = @Error_procedure, @ErrorMessage = @ErrorMessage, @ErrorLine = @ErrorLine, @ErrorCall = @ErrorCall;
END CATCH;
END;

GO

UPDATE ZnodeApplicationSetting
SET Setting ='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>OmsTemplateId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>TemplateName</name><headertext>Template Name</headertext><width>0</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl>/SavedCart/EditSavedCartItem</islinkactionurl><islinkparamfield>omsTemplateId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>Items</name><headertext>Items</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>CreatedDate</name><headertext>Created Date</headertext><width>30</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>ModifiedDate</name><headertext>Modified Date</headertext><width>30</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>Edit|Orders|Delete</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|MoveToCart|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/SavedCart/EditSavedCartItem|/SavedCart/AddProductToCartForSaveCart|/User/DeleteTemplate</manageactionurl><manageparamfield>omsTemplateId|omsTemplateId|omsTemplateId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
WHERE ItemName='ZnodeSavedCart'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetQuoteOrderTemplateDetail')
	DROP PROC Znode_GetQuoteOrderTemplateDetail
GO

CREATE PROCEDURE [dbo].[Znode_GetQuoteOrderTemplateDetail]
(   
	@WhereClause NVARCHAR(MAX),
	@Rows        INT           = 100,
	@PageNo      INT           = 1,
	@Order_BY    VARCHAR(100)  = '',
	@UserId		 INT,										 
	@RowsCount   INT OUT
)
AS 
/*
		Summary :- this procedure is used to find QuoteOrderTemplate details 
	    SELECT * FROM ZnodeUser  WHERE AspNeTUSerId = 'ae464cfc-95d3-40de-bf71-47993fabb41f'
		SELECT * FROM AspNetUserRoles WHERE RoleID = 'A529A670-F446-45EC-BBCB-C00D64D7C964' Userid = '50fe1032-e810-4606-b522-ebf1559e81cf'
		SELECT * FROM AspNetRoles WHERE ID = '8622E90D-7652-41E7-8563-5DED4CC671DE'

		Unit Testing 
		EXEC Znode_GetQuoteOrderTemplateDetail '',@RowsCount = 0, @Order_BY = '', @UserId = 85
*/
BEGIN
    BEGIN TRY
        SET NOCOUNT ON;
		DECLARE @SQL NVARCHAR(MAX);
		DECLARE @TBL_QuoteOrderTemplate TABLE (OmsTemplateId INT,PortalId INT,UserId INT,TemplateName NVARCHAR(1000),CreatedBy INT,CreatedDate DATETIME
		,ModifiedBy INT,ModifiedDate DATETIME,Items INT,RowId INT,CountNo INT )
		DECLARE @AccountId VARCHAR(2000) ,@UsersId VARCHAR(2000), @ProcessType  varchar(50)='Template'
		-- SELECT * FROM aspnetRoles
			
		--SET @UsersId = SUBSTRING (( SELECT ','+CAST(userId AS VARCHAr(50))  FROM Fn_GetRecurciveUserId(@UserId,@ProcessType) FOR XML PATH ('')),2,4000)
			
		SELECT distinct ZPAVL.AttributeValue as SKU, ZPADV.AttributeDefaultValueCode  
		INTO #SKU_ProductType
		FROM ZnodePimAttributeValue ZPAV
		Inner Join ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		Inner Join ZnodePimAttribute ZPA ON ZPAV.PimAttributeId = ZPA.PimAttributeId
		Inner Join ZnodePimAttributeValue ZPAV1 ON ZPAV.PimProductId = ZPAV1.PimProductId
		Inner Join ZnodePimProductAttributeDefaultValue ZPPADV ON ZPAV1.PimAttributeValueId = ZPPADV.PimAttributeValueId
		Inner Join ZnodePimAttribute ZPA1 ON ZPAV1.PimAttributeId = ZPA1.PimAttributeId
		Inner Join ZnodePimAttributeDefaultValue ZPADV ON ZPPADV.PimAttributeDefaultValueId = ZPADV.PimAttributeDefaultValueId
		WHERE ZPA.AttributeCode = 'SKU' AND ZPA1.AttributeCode = 'ProductType'
		AND EXISTS (select * from ZnodeOmsTemplate ZOT
                        INNER JOIN ZnodeOmsTemplateLineItem ZOTL ON(ZOTL.OmsTemplateId = ZOT.OmsTemplateId)
						where ZOT.userid = @UserId AND ZPAVL.AttributeValue = ZOTL.SKU )

			SET @SQL = '
					; WITH CTE_GetOrderTemplate
						AS (
						    SELECT ZOT.OmsTemplateId,ZOT.PortalId,ZOT.UserId,ZOT.TemplateName,ZOT.CreatedBy,ZOT.CreatedDate,ZOT.ModifiedBy,ZOT.ModifiedDate,
							      SUM(case when AttributeDefaultValueCode in ( ''BundleProduct'') AND ParentOmsTemplateLineItemId IS nULL 
											then ZOTL.Quantity
											when AttributeDefaultValueCode in ( ''SimpleProduct'',''ConfigurableProduct'',''GroupProduct'') and  ZOOLIRT.Name  in 
											(''Simple'',''Group'',''Configurable'')and   ParentOmsTemplateLineItemId IS NOT NULL 
											then ZOTL.Quantity
											else 0
									end ) Items, ZOT.TemplateType 
							FROM ZnodeOmsTemplate ZOT
                            LEFT JOIN ZnodeOmsTemplateLineItem ZOTL ON(ZOTL.OmsTemplateId = ZOT.OmsTemplateId)
							Left Join #SKU_ProductType SP ON  ZOTL.SKU = SP.SKU
							left join ZnodeOmsOrderLineItemRelationshipType ZOOLIRT ON ZOTL.OrderLineItemRelationshipTypeId = ZOOLIRT.OrderLineItemRelationshipTypeId
							WHERE ZOT.userid = '+cast(@UserId as varchar(10))+'  
							GROUP BY ZOT.OmsTemplateId,ZOT.PortalId,ZOT.UserId,ZOT.TemplateName,ZOT.CreatedBy,ZOT.CreatedDate,ZOT.ModifiedBy,ZOT.ModifiedDate,ZOT.TemplateType 						  
						  
						    )
					, CTE_GetQuoteOrderDetails AS
					(
						SELECT DISTINCT  OmsTemplateId,PortalId,UserId,TemplateName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Items
						,'+dbo.Fn_GetPagingRowId(@Order_BY,'OmsTemplateId DESC,UserId')+',Count(*)Over() CountNo
						FROM CTE_GetOrderTemplate
						WHERE 1=1 
				        '+dbo.Fn_GetFilterWhereClause(@WhereClause)+'					  
						
					)

					SELECT OmsTemplateId,PortalId,UserId,TemplateName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Items,RowId,CountNo
					FROM CTE_GetQuoteOrderDetails
					'+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows)

					Print @sql
					INSERT INTO @TBL_QuoteOrderTemplate (OmsTemplateId,PortalId,UserId,TemplateName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Items,RowId,CountNo)
					EXEC(@SQL)

					SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM @TBL_QuoteOrderTemplate),0)
   
					SELECT OmsTemplateId,PortalId,UserId,TemplateName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Items
					FROM @TBL_QuoteOrderTemplate 
	END TRY
	BEGIN CATCH
		 
		DECLARE @Status BIT ;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetQuoteOrderTemplateDetail @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@UserId= '+CAST(@UserId AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
        SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
        EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_GetQuoteOrderTemplateDetail',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetImportProcessLog')
	DROP PROC Znode_GetImportProcessLog
GO

CREATE PROCEDURE [dbo].[Znode_GetImportProcessLog]
( @WhereClause VARCHAR(max),
  @Rows        INT           = 100,
  @PageNo      INT           = 1,
  @Order_BY    VARCHAR(1000)  = '',
  @RowsCount   INT OUT)
AS
  /*
    Summary : Get import process log details include rowwise errors in details.    	
	Unit Testing   
	begin tran 
	DECLARE @RowsCount INT;
    EXEC Znode_GetImportProcessLog @WhereClause = 'ImportProcessLogId = 1151',@Rows = 1000,@PageNo = 0,@Order_BY = '',@RowsCount = @RowsCount OUT;
	rollback tran
    SELECT @RowsCount;
    
  */
     BEGIN
         SET NOCOUNT ON;
         BEGIN TRY
             DECLARE @SQL NVARCHAR(MAX);
             DECLARE @TBL_ImportLog TABLE(ImportLogId INT,ImportProcessLogId INT,RowNumber BIgInt,ColumnName NVARCHAR(1000),ColumnValue NVARCHAR(max),ErrorDescription NVARCHAR(max)
										,RowId INt , CountNo Int )  ;
             SET @SQL = ' 
							;with Cte_ErrorLog AS 
							(
								SELECT zil.ImportLogId, zil.ImportProcessLogId, ISNULL(zil.RowNumber, 0) [RowNumber], ISNULL(zil.ColumnName, '''') [ColumnName],
								ISNULL(zil.Data, '''') [ColumnValue], zm.MessageName + 
								CASE 
								WHEN zm.MessageCode IN (17)	AND Name in (''Pricing'') AND ISNULL(zil.ColumnName, '''') NOT like ''%Quantity%'' THEN +''  ''+ dbo.Fn_GetDefaultPriceRoundOff(isnull(DefaultErrorValue,''0000000.00'') - 1)
								WHEN zm.MessageCode IN (17)	AND Name in (''Pricing'') AND ISNULL(zil.ColumnName, '''') like ''%Quantity%''  THEN +''  ''+ dbo.Fn_GetDefaultInventoryRoundOff(isnull(DefaultErrorValue,''0000000.00'') -1) 
								WHEN zm.MessageCode IN (17)	AND Name in (''Inventory'')  THEN +''  ''+ dbo.Fn_GetDefaultInventoryRoundOff(isnull(DefaultErrorValue,''0000000.00'') - 1) 
								WHEN zm.MessageCode IN (41) AND Name in (''Pricing'') AND ISNULL(zil.ColumnName, '''') NOT like ''%Quantity%'' THEN +''  ''+ dbo.Fn_GetDefaultPriceRoundOff(isnull(DefaultErrorValue,''0000000.00'' ))
								WHEN zm.MessageCode IN (41) AND Name in (''Pricing'') AND ISNULL(zil.ColumnName, '''')  like ''%Quantity%'' THEN +''  ''+ dbo.Fn_GetDefaultInventoryRoundOff(isnull(DefaultErrorValue,''0000000.00'' ))
								WHEN zm.MessageCode IN (41) AND Name in (''Inventory'') THEN +''  ''+ dbo.Fn_GetDefaultInventoryRoundOff(isnull(DefaultErrorValue,''0000000.00'' ))
								WHEN zm.MessageCode IN (44) AND Name in (''Pricing'') THEN +''  ''+ isnull(DefaultErrorValue,''0000000.00'' )
								WHEN zm.MessageCode IN (129) AND Name NOT IN (''Product'',''Category'') THEN +'' ''+ isnull(DefaultErrorValue,''0000000.00'' )
						

								ELSE ''''END ''ErrorDescription'' ,zil.ModifiedDate,zil.GUID
								FROM ZnodeImportLog AS zil WITH (NOLOCK) INNER JOIN ZnodeMessage AS zm WITH (NOLOCK) ON zil.ErrorDescription = CONVERT(VARCHAR(50) , zm.MessageCode)
								INNER JOIN ZnodeImportProcessLog zipl WITH (NOLOCK) ON zil.ImportProcessLogId = zipl.ImportProcessLogId
								LEFT Outer JOIN ZnodeImportTemplate zit WITH (NOLOCK) ON zipl.ImportTemplateId = zit.ImportTemplateId
								LEFT Outer JOIN ZnodeImportHead zih WITH (NOLOCK) ON zit.ImportHeadId =zih.ImportHeadId 
								)
								,Cte_ErrorLogFilter As ( SELECT ImportLogId,ImportProcessLogId,[RowNumber],[ColumnName],[ColumnValue],[ErrorDescription],[ModifiedDate],GUID
												,'+dbo.Fn_GetPagingRowId(@Order_BY , 'RowNumber,ImportLogId')+',Count(*)Over() CountNo 
								 FROM Cte_ErrorLog
								 WHERE 1 = 1 '+dbo.Fn_GetFilterWhereClause(@WhereClause)+' 
							 )

							SELECT ImportLogId,ImportProcessLogId,RowNumber,ColumnName,ColumnValue,ErrorDescription,RowId, CountNo 
							FROM Cte_ErrorLogFilter '+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows)

			 INSERT INTO @TBL_ImportLog (ImportLogId,ImportProcessLogId,RowNumber,ColumnName,ColumnValue,ErrorDescription,RowId, CountNo)
			 EXEC (@SQL)
				 SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM @TBL_ImportLog), 0);
             SELECT ImportLogId,ImportProcessLogId,RowNumber,ColumnName,ColumnValue,ErrorDescription
			 FROM @TBL_ImportLog
			

		 END TRY
         BEGIN CATCH
             DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetImportProcessLog @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetImportProcessLog',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;                                    
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportValidateManditoryText')
	DROP PROC Znode_ImportValidateManditoryText
GO

CREATE PROCEDURE [dbo].[Znode_ImportValidateManditoryText]
(
	@TableName          VARCHAR(200),
	@SourceColumnName   NVARCHAR(600),
	@CreateDateString   NVARCHAR(300),
	@ValidationName     VARCHAR(100),
	@ControlName        VARCHAR(300),
	@ValidationValue    VARCHAR(300),
	@NewGUID            NVARCHAR(200),
	@LocaleId           INT = 1 ,
	@DefaultLocaleId    INT,
	@AttributeId        INT,
	@ImportProcessLogId INT,
	@ImportHeadId     INT           = 0,
	@IsIgnoreProcess   BIT = 0 
)
AS
     
 /*
	Summary:  Text 
             --------------------------
              Control   Validation Rule
             --------------------------
             1 Select	ValidationRule
             2 Text	RegularExpression
             3 Number	MaxCharacters
             4 Yes/No	UniqueValue

	Unit Testing:
	EXEC Znode_ImportValidateManditoryText
	 */
	 
	 BEGIN
        BEGIN TRY 
            SET NOCOUNT ON


             DECLARE @SQLQuery NVARCHAR(MAX), @ImportHeadName NVARCHAR(100);
             SET @ImportHeadName = DBO.Fn_GetDefaultImportHead(@ImportHeadId);
			 
			 IF @ControlName = 'Number' AND @ValidationName IN('MaxCharacters')  AND ISNULL(@ValidationValue, '') <> ''
                 BEGIN
                     SET @SQLQuery = @TableName+'  WHERE LEN('+@SourceColumnName+') > ' +   @ValidationValue + ' AND Isnull('+@SourceColumnName+','''') <> ''''';
                    

					IF @ValidationName = 'MaxCharacters'
                         EXEC Znode_ImportGenerateErrorLog
                              @ImportHeadName = @ImportHeadName,
                              @QueryCriteria = @SQLQuery,
                              @SourceColumnName = @SourceColumnName,
                              @CreateDateString = @CreateDateString,
                              @ErrorCode = '129',
                              @ValidationValue = @ValidationValue;
                  END;
             IF @ControlName = 'Yes/No' AND @ValidationName IN('UniqueValue') AND @ValidationValue = 'true'
                 BEGIN
					-- Check duplicate value exist in global temporary table 
					SET @SQLQuery = 'SELECT ''53'' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], '+@SourceColumnName+' AS  AttributeValue,RowNumber ,GUID,  '+@CreateDateString+' 
					FROM '+@TableName+'   WHERE RowNumber in (Select RowNumber from '+@TableName+' where '+@SourceColumnName+' in (Select '+@SourceColumnName+' from '+@TableName+' GROUP BY '+@SourceColumnName+' having COUNT(*) > 1) 
					)
					AND '+CAST(@IsIgnoreProcess AS varchar(100))+' = 0  
					';
                     
					INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, RowNumber, GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
					EXEC sys.sp_sqlexec @SQLQuery;

					---- Check duplicate value exist in znode database
					--If (@ImportHeadName in  ('Product'))
					--BEGIN
					-- SET @SQLQuery = 'SELECT ''10 '' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], '+@SourceColumnName+' AS  AttributeValue,tlb.RowNumber ,GUID,  '+@CreateDateString+' 
					--				  FROM ZnodePimAttributeValue AS ZPAV INNER JOIN ZnodePimAttributeValueLocale AS ZPAVL ON 
					--				  (ZPAVL.PimAttributeValueId = ZPAV.PimAttributeValueId AND ZPAVL.LocaleId IN ('+CONVERT(VARCHAR(100), @LocaleId)+','+CONVERT(VARCHAR(100), @DefaultLocaleId)+')) 
					--				  INNER JOIN '+@TableName+' tlb ON ZPAVL.AttributeValue = tlb.'+@SourceColumnName+' 
					--				  WHERE ZPAV.PimAttributeId = '+CONVERT(VARCHAR(100), @AttributeId)+' AND ZPAVL.AttributeValue <> ''''';

					-- INSERT INTO ZnodeImportLog
					-- (ErrorDescription,ColumnName,Data,RowNumber,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
					-- EXEC sys.sp_sqlexec @SQLQuery;

					-- --Remove wrong data from table 
					-- --SET @SQLQuery = 'DELETE FROM '+@TableName+' WHERE RowNumber in (Select Isnull(RowNumber,0) FROM ZnodeImportLog 
					--	--			  WHERE ErrorDescription =10 AND ImportProcessLogId  = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+');';
					-- --EXEC sys.sp_sqlexec @SQLQuery;
					--END

					--If (@ImportHeadName in  ('Category'))
					--BEGIN
				
					--	SET @SQLQuery = 'SELECT ''10 '' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], '+@SourceColumnName+' AS  AttributeValue,tlb.RowNumber ,GUID,  '+@CreateDateString+' 
					--	FROM ZnodePimCategoryAttributeValue AS ZPAV INNER JOIN ZnodePimCategoryAttributeValueLocale AS ZPAVL ON 
					--	(ZPAVL.PimCategoryAttributeValueId = ZPAV.PimCategoryAttributeValueId AND ZPAVL.LocaleId IN ('+CONVERT(VARCHAR(100), @LocaleId)+','+CONVERT(VARCHAR(100), @DefaultLocaleId)+')) 
					--	INNER JOIN '+@TableName+' tlb ON ZPAVL.CategoryValue = tlb.'+@SourceColumnName+' 
					--	WHERE ZPAV.PimAttributeId = '+CONVERT(VARCHAR(100), @AttributeId)+' AND ZPAVL.CategoryValue <> ''''';
					
					--	INSERT INTO ZnodeImportLog
					--	(ErrorDescription,ColumnName,Data,RowNumber,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
					--	EXEC sys.sp_sqlexec @SQLQuery;
					
					-- END
					---- Check duplicate value exist in znode database
				
				     If (@ImportHeadName in  ('Category'))
					BEGIN
						SET @SQLQuery = 'SELECT ''102 '' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], '+@SourceColumnName+' AS  AttributeValue,tlb.RowNumber ,GUID,  '+@CreateDateString+' 
						FROM '+@TableName+' tlb
						WHERE ltrim(rtrim(isnull(tlb.CategoryCode,''''))) like ''% %'''
						;

						INSERT INTO ZnodeImportLog
						(ErrorDescription,ColumnName,Data,RowNumber,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
						EXEC sys.sp_sqlexec @SQLQuery;

						SET @SQLQuery = 'SELECT ''102 '' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], '+@SourceColumnName+' AS  AttributeValue,tlb.RowNumber ,GUID,  '+@CreateDateString+' 
						FROM '+@TableName+' tlb
						WHERE ltrim(rtrim(isnull(tlb.CategoryCode,''''))) like ''%[^0-9A-Za-z]%'''
						;

						INSERT INTO ZnodeImportLog
						(ErrorDescription,ColumnName,Data,RowNumber,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
						EXEC sys.sp_sqlexec @SQLQuery;

						SET @SQLQuery = 'SELECT ''102 '' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], '+@SourceColumnName+' AS  AttributeValue,tlb.RowNumber ,GUID,  '+@CreateDateString+' 
						FROM '+@TableName+' tlb
						WHERE ltrim(rtrim(isnull(tlb.CategoryCode,''''))) NOT LIKE ''%[^0-9]%'''
						;

						INSERT INTO ZnodeImportLog
						(ErrorDescription,ColumnName,Data,RowNumber,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
						EXEC sys.sp_sqlexec @SQLQuery;

						
					END

                 END;
         END TRY
         BEGIN CATCH
               DECLARE @Status BIT ;
		     SET @Status = 0;
			 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportValidateManditoryText @TableName = '+@TableName+',@SourceColumnName='+@SourceColumnName+',@CreateDateString='+@CreateDateString+',@ValidationName='+@ValidationName+',@ControlName = '+@ControlName+',@ValidationValue='+@ValidationValue+',@NewGUID='+@NewGUID+',@LocaleId='+CAST(@LocaleId AS VARCHAR(50))+',@DefaultLocaleId='+CAST(@DefaultLocaleId AS VARCHAR(50))+',@AttributeId='+CAST(@AttributeId AS VARCHAR(50))+',@ImportHeadId='+CAST(@ImportHeadId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_ImportValidateManditoryText',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

--UPDATE ZnodeImportAttributeValidation 
--SET ValidationValue=100, ValidationName = 'MaxCharacters' , ControlName = 'Number'
--WHERE AttributeCode='AttributeName' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='ProductAttribute' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

--UPDATE ZnodeImportAttributeValidation 
--SET ValidationValue=100, ValidationName = 'MaxCharacters' , ControlName = 'Number'
--WHERE AttributeCode='Attributecode' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='ProductAttribute' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

--UPDATE ZnodeImportAttributeValidation 
--SET ValidationValue=100, ValidationName = 'MaxCharacters',ControlName = 'Number'
--WHERE AttributeCode='VoucherName' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='Voucher' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

--UPDATE ZnodeImportAttributeValidation 
--SET ValidationValue=200, ValidationName = 'MaxCharacters',ControlName = 'Number'
--WHERE AttributeCode IN ('ProfileName','DepartmentName','AccountCode') AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='Customer' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

--UPDATE ZnodeImportAttributeValidation 
--SET ValidationValue=300, ValidationName = 'MaxCharacters',ControlName = 'Number'
--WHERE AttributeCode IN ('Address1','Address2') AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='CustomerAddress' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

--UPDATE ZnodeImportAttributeValidation 
--SET ValidationValue=600, ValidationName = 'MaxCharacters',ControlName = 'Number'
--WHERE AttributeCode IN ('DisplayName','CompanyName') AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='CustomerAddress' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

--UPDATE ZnodeImportAttributeValidation 
--SET ValidationValue=100, ValidationName = 'MaxCharacters',ControlName = 'Number'
--WHERE AttributeCode IN ('FirstName','LastName') AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='Customer' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

--UPDATE ZnodeImportAttributeValidation 
--SET ValidationValue=30, ValidationName = 'MaxCharacters',ControlName = 'Number'
--WHERE AttributeCode ='PhoneNumber' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='Customer' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

--UPDATE ZnodeImportAttributeValidation 
--SET ValidationValue=300, ValidationName = 'MaxCharacters',ControlName = 'Number'
--WHERE AttributeCode IN ('FirstName','LastName') AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='CustomerAddress' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

--UPDATE ZnodeImportAttributeValidation 
--SET ValidationValue=200, ValidationName = 'MaxCharacters',ControlName = 'Number'
--WHERE AttributeCode IN ('Address1','Address2') AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='CustomerAddress' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

--UPDATE ZnodeImportAttributeValidation 
--SET ValidationValue=100, ValidationName = 'MaxCharacters',ControlName = 'Number'
--WHERE AttributeCode IN ('CityName','PostalCode') AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='CustomerAddress' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

--UPDATE ZnodeImportAttributeValidation 
--SET ValidationValue=30, ValidationName = 'MaxCharacters',ControlName = 'Number'
--WHERE AttributeCode ='PhoneNumber' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='CustomerAddress' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

--UPDATE ZnodeImportAttributeValidation 
--SET ValidationValue=200, ValidationName = 'MaxCharacters',ControlName = 'Number'
--WHERE AttributeCode ='CanonicalURL' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='SEODetails' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

--UPDATE ZnodeImportAttributeValidation 
--SET ValidationValue=50, ValidationName = 'MaxCharacters',ControlName = 'Number'
--WHERE AttributeCode ='RobotTag' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='SEODetails' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

--UPDATE ZnodeImportAttributeValidation 
--SET ValidationValue=300, ValidationName = 'MaxCharacters',ControlName = 'Number'
--WHERE AttributeCode IN ('HighlightCode','ImageAltTag','HighlightName') AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='Highlight' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

--UPDATE ZnodeImportAttributeValidation 
--SET ValidationValue=300, ValidationName = 'MaxCharacters',ControlName = 'Number'
--WHERE AttributeCode ='AddonGroupName' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='AddonAssociation' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

--UPDATE ZnodeImportAttributeValidation 
--SET ValidationValue=300, ValidationName = 'MaxCharacters',ControlName = 'Number'
--WHERE AttributeCode IN ('AttributeCode','AttributeDefaultValueCode') AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='AttributeDefaultValue' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

--UPDATE ZnodeImportAttributeValidation 
--SET ValidationValue=300, ValidationName = 'MaxCharacters',ControlName = 'Number'
--WHERE AttributeCode IN ('AccountCode','AccountName','AddressName','CompanyName','Address1','Address2') AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='Account' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

--UPDATE ZnodeImportAttributeValidation 
--SET ValidationValue=300, ValidationName = 'MaxCharacters',ControlName = 'Number'
--WHERE AttributeCode ='IsBidirectional' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='Synonyms' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

--UPDATE ZnodeImportAttributeValidation 
--SET ValidationValue=300, ValidationName = 'MaxCharacters',ControlName = 'Number'
--WHERE AttributeCode ='BrandCode' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='Brands' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

--GO

INSERT INTO ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 129,'Text','Input must not exceed the maximum character limit of',2,getdate(),2,getdate()
WHERE NOT EXISTS(SELECT * FROM ZnodeMessage WHERE MessageCode = 129)

GO

--UPDATE ZnodeImportAttributeValidation 
--SET ValidationValue=200, ValidationName = 'MaxCharacters',ControlName = 'Number'
--WHERE AttributeCode ='HighlightType' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='Highlight' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

--GO

UPDATE ZnodeApplicationSetting
SET Setting ='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>OmsTemplateId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>TemplateName</name><headertext>Template Name</headertext><width>0</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl>/SavedCart/EditSavedCartItem</islinkactionurl><islinkparamfield>omsTemplateId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>Items</name><headertext>Items</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>z-items</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>CreatedDate</name><headertext>Created Date</headertext><width>30</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>ModifiedDate</name><headertext>Modified Date</headertext><width>30</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>Edit|Orders|Delete</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|MoveToCart|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/SavedCart/EditSavedCartItem|/SavedCart/AddProductToCartForSaveCart|/User/DeleteTemplate</manageactionurl><manageparamfield>omsTemplateId|omsTemplateId|omsTemplateId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
WHERE ItemName='ZnodeSavedCart'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetXmlProductFeedList')
	DROP PROC Znode_GetXmlProductFeedList
GO

CREATE PROCEDURE [dbo].[Znode_GetXmlProductFeedList]  
(
	@PortalId   VARCHAR(2000) = NULL,   
	@LocaleId   INT,  
	@FeedType   NVARCHAR(MAX) = NULL   
)
AS  
/*  
Summary: This Procedure is used to get effective keyword feeding of Product list  
 SELECT * FROM ZnodePublishProductDetail  
 SELECT * FROM ZnodePublishProduct WHERE PublishCatalogId = 3  
 SELECT * FROM ZnodePortalCatalog   
 Unit Testing:  
 EXEC [Znode_GetXmlProductFeedList] @PortalId='0',@ProductIds = '116,117,118'  
 ,@LocaleId=1,@FeedType='Bing'   
  
*/  
BEGIN  
BEGIN TRY  
SET NOCOUNT ON;        
           
		IF OBJECT_ID('tempdb..#TBL_DomainName') IS NOT NULL
		DROP TABLE #TBL_DomainName

		IF OBJECT_ID('tempdb..#TBL_SEODetails') IS NOT NULL
		DROP TABLE #TBL_SEODetails

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_PortalIds') IS NOT NULL
		DROP TABLE #TBL_PortalIds

		IF OBJECT_ID('tempdb..#TBL_PricePrecedence') IS NOT NULL
		DROP TABLE #TBL_PricePrecedence

		DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
		CREATE TABLE #TBL_DomainName 
		(PortalId   INT,
		DomainName NVARCHAR(300),
		RowId      INT
		);  	
         
		CREATE TABLE #TBL_SEODetails   
		(loc                   NVARCHAR(MAX),  
		lastmod               DATETIME,  
		[g:condition]         VARCHAR(1000),  
		[description]         NVARCHAR(MAX), 
		[SEOTitle]			  NVARCHAR(MAX),	
		[g:id]                INT,  
		link                  VARCHAR(1000),  
		[g:identifier_exists] VARCHAR(2000),  
		DomainName            NVARCHAR(3000),  
		PortalId              INT , 
		SEOCode             NVARCHAR(4000), 
		CanonicalURL        VARCHAR(2000), 
		RobotTag            VARCHAR(500)
		);  
		
		DECLARE @DefaultLocaleId INT=dbo.Fn_GetDefaultLocaleId()  ;
		CREATE TABLE #TBL_PortalIds (PortalId INT);  
		
		INSERT INTO #TBL_PortalIds  

		SELECT Zp.PortalId   
		FROM Znodeportal AS ZP   
		INNER JOIN ZnodePortalCatalog AS ZPC ON(ZPC.PortalId = Zp.PortalId)  
		INNER JOIN ZnodePublishCatalog AS ZPPC ON(ZPPC.PublishCatalogId = ZPC.PublishCatalogId)   
		INNER JOIN ZNodePublishProduct AS ZPP ON(ZPP.PublishCatalogId = ZPPC.PublishCatalogId)  
		INNER JOIN ZnodePublishProductDetail AS PPD ON (PPD.PublishProductId = ZPP.PublishProductId)  
		INNER JOIN ZnodePublishProductEntity AS ZPPE ON (PPD.SKU  = ZPPE.SKU)
		WHERE
		
		EXISTS(SELECT TOP 1 1 FROM DBO.Split(@PortalId, ',') AS Sp  
		WHERE(CAST(sp.Item AS INT)) = Zp.PortalId  OR @PortalId = '0')  
		AND EXISTS (SELECT TOP 1 1 FROM ZnodeDomain ZD WHERE ZP.PortalId = ZD.PortalId  
		AND IsActive = 1 AND ApplicationType = 'Webstore' AND IsDefault = 1)  
		GROUP BY Zp.PortalId;   
		
		INSERT INTO #TBL_DomainName   
		SELECT  PortalId,DomainName,ROW_NUMBER() OVER(PARTITION BY PortalId ORDER BY DomainName)   
		FROM ZnodeDomain AS ZD   
		WHERE EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZD.PortalId)  
		AND IsActive = 1 AND ApplicationType = 'Webstore' AND IsDefault = 1 
 
			SELECT DISTINCT ZCSD.CMSSEODetailId,ZCSD.SEOURL AS loc,ZCSD.ModifiedDate AS lastmod,'new' AS [g:condition],ZCSDL.SEODescription AS [description],ZCSDL.SEOTitle AS [SEOTitle], ZPCC.PublishProductId AS [g:id],  
            ZCSD.SEOUrl AS link,'false' AS [g:identifier_exists],TBDN.DomainName,ZPC.PortalId,ISNULL(ZCSDL.LocaleId, @DefaultLocaleId) AS LocaleId , ZCSD.SEOCode , ZCSDL.CanonicalURL, ZCSDL.RobotTag 
			INTO #Cte_SeoDetailsWithLocale
			FROM ZNodePublishProduct AS ZPCC   
			INNER JOIN ZnodePortalCatalog AS ZPC ON(ZPC.PublishCatalogId = ZPCC.PublishCatalogId)  
			LEFT JOIN ZnodePublishProductDetail AS PPD ON (PPD.PublishProductId = ZPCC.PublishProductId)  
			LEFT JOIN ZnodeCMSSEODetail AS ZCSD ON(PPD.SKU = ZCSD.SEOCode and ZCSD.PortalId = ZPC.PortalId)  
			LEFT JOIN ZnodeCMSSEOType AS ZCST ON(ZCST.CMSSEOTypeId = ZCSD.CMSSEOTypeId AND ZCST.Name = 'Product')  
			LEFT JOIN ZnodeCMSSEODetailLocale AS ZCSDL ON(ZCSDL.CMSSEODetailId = ZCSD.CMSSEODetailId AND ZCSDL.LocaleId IN(@LocaleId, @DefaultLocaleId))  
			LEFT JOIN #TBL_DomainName AS TBDN ON(TBDN.RowId = 1 AND TBDN.PortalId = zpc.PortalId)   
			WHERE EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZPC.PortalId)  
				
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[SEOTitle],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag  
			INTO #Cte_SeoDetailsWithFirstLocale
			FROM #Cte_SeoDetailsWithLocale   
			WHERE LocaleId = @LocaleId  
    
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[SEOTitle],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode , CanonicalURL, RobotTag 
			INTO #Cte_SeoDetailsWithDefaultLocale
			FROM #Cte_SeoDetailsWithFirstLocale  
			
			INSERT INTO #Cte_SeoDetailsWithDefaultLocale 
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[SEOTitle],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag  
			FROM #Cte_SeoDetailsWithLocale AS CTSDWL  
			WHERE LocaleId = @DefaultLocaleId   
			AND NOT EXISTS(SELECT TOP 1 1 FROM #Cte_SeoDetailsWithFirstLocale AS CTSDWDL WHERE CTSDWDL.CMSSEODetailId = CTSDWL.CMSSEODetailId)  
         
			INSERT INTO #TBL_SEODetails  
			SELECT DISTINCT loc,lastmod,[g:condition],[description],[SEOTitle],[g:id],link,[g:identifier_exists],DomainName,PortalId ,SEOCode, CanonicalURL, RobotTag  
			FROM #Cte_SeoDetailsWithDefaultLocale;  
			
			SELECT TBSD.loc,TBSD.lastmod,TBSD.[g:condition],TBSD.[description],TBSD.[SEOTitle],TBSD.[g:id],TBSD.link,TBSD.[g:identifier_exists],TBSD.DomainName,TBSD.PortalId,  
			CASE WHEN SUM(ZI.Quantity) > 0 THEN 'In Stock' ELSE CASE WHEN @FeedType = 'Xml' THEN 'Out Of Stock' ELSE 'Not In Stock' END  
			END AS [g:availability],
			ZPPD.SKU ,TBSD.SEOCode, TBSD.CanonicalURL, TBSD.RobotTag, ZPP.PublishProductId,ZPPD.ProductName
			INTO #TBL_CompleteDetailes  
			FROM ZnodePublishProduct AS ZPP   
			LEFT JOIN #TBL_SEODetails AS TBSD ON(ZPP.PublishProductId = TBSD.[g:id] )  
			LEFT JOIN ZnodePublishProductDetail AS ZPPD ON(ZPPD.PublishProductId = ZPP.PublishProductId AND ZPPD.LocaleId = @LocaleId)  
			LEFT JOIN ZnodePortalWarehouse AS ZPW ON(ZPW.PortalId = TBSD.PortalId)  
			LEFT JOIN ZnodePortalAlternateWarehouse AS ZAPW ON(ZAPW.PortalWarehouseId = ZPW.PortalWarehouseId)  
			LEFT JOIN ZnodeInventory AS ZI ON(ZI.SKU = ZPPD.SKU AND (ZI.WarehouseId = ZPW.WarehouseId OR ZI.WarehouseId = ZAPW.WarehouseId))  			
			GROUP BY loc,lastmod,[g:condition],[description],[SEOTitle],[g:id],link,[g:identifier_exists],DomainName,TBSD.PortalId,ZPPD.SKU,ZPPD.LocaleId, TBSD.SEOCode, TBSD.CanonicalURL, TBSD.RobotTag, ZPP.PublishProductId,ZPPD.ProductName;    
			
			DECLARE @MediaConfiguration NVARCHAR(2000)=((SELECT TOP 1 ISNULL(CASE WHEN CDNURL = '' THEN NULL ELSE CDNURL END,URL) FROM ZnodeMediaConfiguration WHERE IsActive = 1));    
  
			CREATE INDEX Idx_#TBL_CompleteDetailes ON #TBL_CompleteDetailes(PortalId,SKU)
			
			select * into #TBL_PricePrecedence from(
			select ROW_NUMBER() OVER(PARTITION BY sku ORDER BY Precedence) rnk_min, sku, RetailPrice,SalesPrice,znodeprice.PriceListId,ZnodePriceList.ListCode,
			ZnodePriceListPortal.Precedence
			from znodeprice
			left join ZnodePriceList on ZnodePriceList.PriceListId = znodeprice.PriceListId
			left join  ZnodePriceListPortal on ZnodePriceList.PriceListId= ZnodePriceListPortal.PriceListId where PortalId = @PortalId 
			)a
			order by a.sku,Precedence
			delete from #TBL_PricePrecedence where rnk_min<>1 
	
			SELECT zp.PortalId,round(isnull(Zps.SalesPrice,Zps.RetailPrice),2) as Price,Zps.SKU,tbcd.SEOCode,ROW_NUMBER() OVER(PARTITION BY Zps.SKU,zp.PortalId ORDER BY ZPS.RetailPrice) AS RowId  
			INTO #Cte_PortalList
			FROM ZnodePriceList AS ZPL   
			LEFT JOIN ZnodePriceListPortal AS ZPLP ON ZPL.PriceListId = ZPLP.PriceListId  
			LEFT JOIN ZnodeCulture AS zc ON ZPL.CultureId = zc.CultureId
			LEFT JOIN ZnodePortal AS zp ON ZPLP.PortalId = zp.PortalId  
		    LEFT JOIN #TBL_PricePrecedence Zps ON(Zps.PriceListId = ZPL.PriceListId) 
			--LEFT JOIN ZnodePrice AS Zps ON(Zps.PriceListId = ZPL.PriceListId)   
			LEFT JOIN #TBL_CompleteDetailes AS TBCD ON(TBCD.PortalId = Zp.PortalId AND TBCD.SKU = Zps.Sku)   
			WHERE CAST(@GetDate AS DATE) BETWEEN ZPL.ActivationDate AND ZPL.ExpirationDate   
			AND EXISTS( SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZPLP.PortalId)   
			GROUP BY zp.PortalId,ZPS.RetailPrice,Zps.SalesPrice,Zps.SKU ,TBCD.SEOCode  
			
			SELECT D.PublishProductId,C.AttributeDefaultValueCode AS Brand
			INTO #BrandDetails
			FROM ZnodePimAttributeValue A
			INNER JOIN ZnodePimProductAttributeDefaultValue B ON B.PimAttributeValueId=A.PimAttributeValueId
			INNER JOIN ZnodePimAttributeDefaultValue C ON C.PimAttributeDefaultValueId=A.PimAttributeDefaultValueId	
			INNER JOIN Znodepublishproduct D ON  A.PimProductId = D.PimProductId 
			WHERE EXISTS(SELECT * FROM ZnodePimAttribute D WHERE D.PimAttributeId=A.PimAttributeId AND D.AttributeCode='Brand' )
			AND EXISTS(SELECT * FROM #TBL_CompleteDetailes E Where E.PublishProductId = D.PublishProductId)		
			
			SELECT A.CategoryName , A.ZnodeProductId AS PublishProductId, ROW_NUMBER() OVER(PARTITION BY A.ZnodeProductId ORDER BY A.ZnodeProductId) AS RowId
			INTO #ProductCategories
			FROM ZnodePublishProductEntity A 
			WHERE EXISTS(SELECT * FROM #TBL_CompleteDetailes B WHERE A.ZnodeProductId = B.PublishProductId)
			AND ISNULL(A.CategoryName,'') <> ''

			DELETE FROM #ProductCategories WHERE RowId <> 1
 
			SELECT SKU,SUM(cast(Quantity as numeric(28,0)))AS Inventory 
			into #InventotyDetails 
			FROM ZnodeInventory A 
			WHERE EXISTS(SELECT * FROM #TBL_CompleteDetailes B where A.SKU=B.SKU)
			GROUP BY SKU  

			SELECT F.PublishProductId,[Path] AS ImagePath
			INTO #ProductImage
			FROM ZnodePimAttributeValue a
			INNER JOIN ZnodePimProductAttributeMedia b on a.PimAttributeValueId = b.PimAttributeValueId
			INNER JOIN ZnodeMedia d on b.MediaId = d.MediaId
			INNER JOIN Znodepublishproduct F ON  A.PimProductId = F.PimProductId 
			WHERE EXISTS(SELECT * FROM ZnodePimAttribute C WHERE C.PimAttributeId=A.PimAttributeId AND C.AttributeCode='PRODUCTIMAGE' )
			AND EXISTS(SELECT * FROM #TBL_CompleteDetailes E Where E.PublishProductId = F.PublishProductId)		

						 
			SELECT 
			DomainName AS DomainName,
			isnull(ProductName,SEOTitle) as [Title],
			--lastmod,
			--[g:condition],
			[description] AS [Description],
			CAST([g:id] AS nvarchar(50) ) AS ProductID,
			[g:availability] AS [Availability],
			--[g:identifier_exists],	
			--TBCD.PortalId,
			Cast(CAST(CTPL.Price AS numeric(28,3))as nvarchar(100)) AS Price,
			@MediaConfiguration AS MediaConfiguration,
			--TBCD.SEOCode,
			--TBCD.CanonicalURL,
			--TBCD.RobotTag,
			PC.CategoryName AS Category,
			CAST(ID.Inventory AS nvarchar(50) ) AS Inventory,
			BD.Brand AS Brand,
			ID.SKU AS ID,
			link AS Link,
			PM.IMAGEPATH AS Image_Link
			FROM #TBL_CompleteDetailes AS TBCD   
			LEFT JOIN #Cte_PortalList AS CTPL ON(CTPL.PortalId = TBCD.PortalId AND CTPL.SKU = TBCD.SKU AND CTPL.RowID = 1)  
			LEFT JOIN #ProductCategories PC ON TBCD.PublishProductId = PC.PublishProductId
			LEFT JOIN #InventotyDetails ID ON TBCD.SKU = ID.SKU 
			LEFT JOIN #BrandDetails BD on TBCD.PublishProductId=BD.PublishProductId
			LEFT JOIN #ProductImage PM on TBCD.PublishProductId=PM.PublishProductId
			WHERE  EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = TBCD.PortalId)

		IF OBJECT_ID('tempdb..#TBL_DomainName') IS NOT NULL
		DROP TABLE #TBL_DomainName

		IF OBJECT_ID('tempdb..#TBL_SEODetails') IS NOT NULL
		DROP TABLE #TBL_SEODetails

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_PortalIds') IS NOT NULL
		DROP TABLE #TBL_PortalIds

		IF OBJECT_ID('tempdb..#TBL_PricePrecedence') IS NOT NULL
		DROP TABLE #TBL_PricePrecedence
		
END TRY  
BEGIN CATCH  
	DECLARE @Status BIT ;  
	SET @Status = 0;  
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetXmlProductFeedList @PortalId = '+@PortalId+',@LocaleId='+CAST(@LocaleId AS VARCHAR(50))+',@FeedType='+CAST(@FeedType AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));  
                 
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
     
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_GetXmlProductFeedList',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
   
END;

GO

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'Order','ReorderCompleteOrder',1,2,Getdate(),2,Getdate()
where not exists(select * from ZnodeActions where ControllerName = 'Order' and ActionName = 'ReorderCompleteOrder')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
 (select TOP 1 MenuId from ZnodeMenu where MenuName = 'ORDERS' AND ControllerName = 'Order')
,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Order' and ActionName= 'ReorderCompleteOrder') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'ORDERS' AND ControllerName = 'Order') and ActionId =
(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Order' and ActionName= 'ReorderCompleteOrder'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'ORDERS' AND ControllerName = 'Order')
,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Order' and ActionName= 'ReorderCompleteOrder')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'ORDERS' AND ControllerName = 'Order') and ActionId =
(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Order' and ActionName= 'ReorderCompleteOrder'))

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetCatalogCategorySEODetail')
	DROP PROC Znode_GetCatalogCategorySEODetail
GO

CREATE PROCEDURE [dbo].[Znode_GetCatalogCategorySEODetail]
(
	  @WhereClause      VARCHAR(MAX),
	  @Rows             INT           = 100,
	  @PageNo           INT           = 1,
	  @Order_BY         VARCHAR(1000) = '',
	  @RowsCount        INT OUT,
	  @LocaleId         INT           = 1,
	  @PortalId         INT
)
AS
BEGIN
	SET NOCOUNT ON;

	Declare @PimCatalogId INT, @SQL VARCHAR(MAX), @DefaultLocaleId VARCHAR(20)= dbo.Fn_GetDefaultLocaleId()

	SELECT @PimCatalogId = PimCatalogId 
	FROM ZnodePortalCatalog ZPC
	INNER JOIN ZnodePublishCatalog PC ON ZPC.PublishCatalogId = pc.PublishCatalogId WHERE PortalId = @PortalId


	IF OBJECT_ID('TEMPDB..#CategoryDetail') IS NOT NULL
		DROP TABLE #CategoryDetail

	IF OBJECT_ID('TEMPDB..##TempCategoryDetail') IS NOT NULL
		DROP TABLE ##TempCategoryDetail

		IF OBJECT_ID('TEMPDB..#znodeCatalogCategory') IS NOT NULL
		DROP TABLE #znodeCatalogCategory

	SELECT PimCategoryId, CategoryName, CategoryCode, LocaleId
	INTO #CategoryDetail
	FROM
	(
		SELECT ZPCAV.PimCategoryId,ZPA.AttributeCode,ZPCAVL.CategoryValue, ZPCAVL.LocaleId 
		FROM ZnodePimCategoryAttributeValue ZPCAV
		INNER JOIN ZnodePimCategoryAttributeValueLocale ZPCAVL on ZPCAV.PimCategoryAttributeValueId = ZPCAVL.PimCategoryAttributeValueId
		INNER JOIN ZnodePimAttribute ZPA on ZPCAV.PimAttributeId = ZPA.PimAttributeId
		where ZPA.AttributeCode in ( 'CategoryName', 'CategoryCode')
	)TB PIVOT(MAX(CategoryValue) FOR AttributeCode in ( CategoryName, CategoryCode))AS PVT
	
	

	SET @SQL = '

	select distinct ZPCH.PimCatalogId,ZPCP.PimCategoryId into #znodeCatalogCategory
	FROm ZnodePimCategoryProduct ZPCP
	Inner Join ZnodePimCategoryHierarchy ZPCH ON ZPCP.PimCategoryId = ZPCH.PimCategoryId AND ZPCH.PimCatalogId = '+CAST(@PimCatalogId AS VARCHAR(10))+'

	;With CTE_CategoryDetail AS
	(
		SELECT DISTINCT PC.PimCatalogId, PC.CatalogName, CD.PimCategoryId, CD.CategoryCode, CD.CategoryName , ISNULL(CSD.SEOCode,CD.CategoryCode) as SEOCode , CSD.SEOUrl, CSDL.SEOTitle, CSDL.SEODescription, CSDL.SEOKeywords,
		case when  ZPPO.DisplayName IS NULL THEN '''' ELSE ZPPO.DisplayName END IsPublish , ActivationDate , ExpirationDate, 
		CH.IsActive, CD.LocaleId, CSDL.CanonicalURL, CSDL.RobotTag
		FROM #CategoryDetail CD
		INNER JOIN ZnodePimCategory ZPC ON (ZPC.PimCategoryId = CD.PimCategoryId)
		INNER JOIN  #znodeCatalogCategory PCC on CD.PimCategoryId = PCC.PimCategoryId
		INNER JOIN ZnodePimCatalog PC on PCC.PimCatalogId = PC.PimCatalogId
		LEFT JOIN ZnodePimCategoryHierarchy CH ON (CH.PimCategoryId = CD.PimCategoryId)
		LEFT JOIN ZnodeCMSSEOType CST ON CST.Name = ''Category''
		LEFT JOIN ZnodeCMSSEODetail CSD on CD.CategoryCode = CSD.SEOCode and CSD.CMSSEOTypeId = CST.CMSSEOTypeId AND CSD.PortalId = '+CAST(@PortalId AS VARCHAR(10))+'
		LEFT JOIN ZnodeCMSSEODetailLocale CSDL ON  CSD.CMSSEODetailId = CSDL.CMSSEODetailId AND CSDL.LocaleId =  '+CAST(@LocaleId AS VARCHAR(10))+'
		LEFT JOIN ZnodePublishState ZPPO ON (ZPPO.PublishStateId = CSD.PublishStateId)
		WHERE PCC.PimCatalogId = '+CAST(@PimCatalogId AS VARCHAR(10))+' AND CD.LocaleId IN ('+CAST(@LocaleId AS VARCHAR(50))+', '+CAST(@DefaultLocaleId AS VARCHAR(50))+') 
			AND PC.PortalId = '+CAST(@PortalId AS VARCHAR(10))+'
	)
	,CTE_CategoryDetail_SEO AS
	(
		SELECT DISTINCT null as PimCatalogId, '''' CatalogName, CD.PimCategoryId, CD.CategoryCode, CD.CategoryName , ISNULL(CSD.SEOCode,CD.CategoryCode) as SEOCode , CSD.SEOUrl, CSDL.SEOTitle, CSDL.SEODescription, CSDL.SEOKeywords,
		case when  ZPPO.DisplayName IS NULL THEN '''' ELSE ZPPO.DisplayName END IsPublish , ActivationDate , ExpirationDate, 
		CH.IsActive, CD.LocaleId, CSDL.CanonicalURL, CSDL.RobotTag
		FROM #CategoryDetail CD
		INNER JOIN ZnodePimCategory ZPC ON (ZPC.PimCategoryId = CD.PimCategoryId)
		LEFT JOIN ZnodePimCategoryHierarchy CH ON (CH.PimCategoryId = CD.PimCategoryId)
		LEFT JOIN ZnodeCMSSEOType CST ON CST.Name = ''Category''
		LEFT JOIN ZnodeCMSSEODetail CSD on CD.CategoryCode = CSD.SEOCode and CSD.CMSSEOTypeId = CST.CMSSEOTypeId AND CSD.PortalId = '+CAST(@PortalId AS VARCHAR(10))+'
		LEFT JOIN ZnodeCMSSEODetailLocale CSDL ON  CSD.CMSSEODetailId = CSDL.CMSSEODetailId AND CSDL.LocaleId =  '+CAST(@LocaleId AS VARCHAR(10))+'
		LEFT JOIN ZnodePublishState ZPPO ON (ZPPO.PublishStateId = CSD.PublishStateId)
		WHERE CD.LocaleId IN ('+CAST(@LocaleId AS VARCHAR(50))+', '+CAST(@DefaultLocaleId AS VARCHAR(50))+') AND CH.PimCatalogId = '+CAST(@PimCatalogId AS VARCHAR(10))+'
		AND NOT EXISTS(select * from CTE_CategoryDetail CDC where CD.PimCategoryId = CDC.PimCategoryId )
	)
	,CTE_CategoryDetail_Locale as
	(
		SELECT PimCatalogId, CatalogName, PimCategoryId, CategoryCode,CategoryName, SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords,IsPublish,ActivationDate,ExpirationDate,IsActive, LocaleId, CanonicalURL, RobotTag
		FROM CTE_CategoryDetail CD
		WHERE CD.LocaleId ='+CAST(@LocaleId AS VARCHAR(50))+'
		union ALL
		SELECT PimCatalogId, CatalogName, PimCategoryId, CategoryCode,CategoryName, SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords,IsPublish,ActivationDate,ExpirationDate,IsActive, LocaleId, CanonicalURL, RobotTag
		FROM CTE_CategoryDetail_SEO CD
		WHERE CD.LocaleId ='+CAST(@LocaleId AS VARCHAR(50))+'
	)
	,CTE_CategoryDetail_BothLocale as
	(
		SELECT PimCatalogId, CatalogName, PimCategoryId, CategoryCode,CategoryName, SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords,IsPublish,ActivationDate,ExpirationDate,IsActive, CanonicalURL, RobotTag
		FROM CTE_CategoryDetail_Locale
		Union All
		SELECT PimCatalogId, CatalogName, PimCategoryId, CategoryCode,CategoryName, SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords,IsPublish,ActivationDate,ExpirationDate,IsActive, CanonicalURL, RobotTag
		FROM CTE_CategoryDetail CDS
		WHERE LocaleId ='+CAST(@DefaultLocaleId AS VARCHAR(50))+' AND
			NOT EXISTS( SELECT TOP 1 1 FROM CTE_CategoryDetail_Locale CSD1
						WHERE CDS.PimCategoryId = CSD1.PimCategoryId AND CDS.CatalogName = CSD1.CatalogName )
		Union All
		SELECT PimCatalogId, CatalogName, PimCategoryId, CategoryCode,CategoryName, SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords,IsPublish,ActivationDate,ExpirationDate,IsActive, CanonicalURL, RobotTag
		FROM CTE_CategoryDetail_SEO CDS2
		WHERE LocaleId ='+CAST(@DefaultLocaleId AS VARCHAR(50))+' AND
			NOT EXISTS( SELECT TOP 1 1 FROM CTE_CategoryDetail_Locale CSD1
						WHERE CDS2.PimCategoryId = CSD1.PimCategoryId AND CDS2.CatalogName = CSD1.CatalogName )
	)
	,CTE_CategoryDetail_WhereClause AS
	(
		SELECT PimCatalogId, CatalogName, PimCategoryId, CategoryCode,CategoryName, SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords,IsPublish,ActivationDate,ExpirationDate,IsActive, CanonicalURL, RobotTag, '+[dbo].[Fn_GetPagingRowId](@Order_BY, 'PimCategoryId')+',Count(*)Over() CountId
		FROM CTE_CategoryDetail_BothLocale CD
		WHERE 1 = 1 '+CASE WHEN @WhereClause = '' THEN '' ELSE ' AND '+@WhereClause END +'
	)
	SELECT PimCatalogId, CatalogName, PimCategoryId, CategoryCode,CategoryName, SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords,IsPublish,ActivationDate,ExpirationDate,IsActive, CanonicalURL, RobotTag, CountId
	INTO ##TempCategoryDetail
	FROM CTE_CategoryDetail_WhereClause
	'+[dbo].[Fn_GetPaginationWhereClause](@PageNo, @Rows);
	print @SQL
	EXEC (@SQL)

	SET @RowsCount = ISNULL((SELECT TOP 1 CountId FROM ##TempCategoryDetail ),0)

	SELECT  PimCategoryId, CategoryName, SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords,IsPublish, ActivationDate,ExpirationDate,IsActive, CanonicalURL, RobotTag 
	FROM ##TempCategoryDetail

	IF OBJECT_ID('TEMPDB..#CategoryDetail') IS NOT NULL
		DROP TABLE #CategoryDetail

	IF OBJECT_ID('TEMPDB..##TempCategoryDetail') IS NOT NULL
		DROP TABLE ##TempCategoryDetail

	IF OBJECT_ID('TEMPDB..#znodeCatalogCategory') IS NOT NULL
	DROP TABLE #znodeCatalogCategory

END

GO

--UPDATE ZnodeImportAttributeValidation 
--SET ValidationValue=200, ValidationName = 'MaxCharacters',ControlName = 'Number'
--WHERE AttributeCode IN ('ChildSKU','ParentSKU') AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='ProductAssociation' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

--UPDATE ZnodeImportAttributeValidation 
--SET ValidationValue=200, ValidationName = 'MaxCharacters',ControlName = 'Number'
--WHERE AttributeCode IN ('CityName','CountyCode','StateCode') AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='ZipCode' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

--UPDATE ZnodeImportAttributeValidation 
--SET ValidationValue=50, ValidationName = 'MaxCharacters',ControlName = 'Number'
--WHERE AttributeCode IN ('CityType','ZIPType','CountyFIPS','StateFIPS','MSACode','TimeZone') AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='ZipCode' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

--UPDATE ZnodeImportAttributeValidation 
--SET ValidationValue=1, ValidationName = 'MaxCharacters',ControlName = 'Number'
--WHERE AttributeCode ='DST' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='ZipCode' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

--GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishPortalEntity')
	DROP PROC Znode_PublishPortalEntity
GO

CREATE PROCEDURE [dbo].[Znode_PublishPortalEntity]
(
   @PortalId  INT = 0 
  ,@LocaleId  INT = 0 
  ,@RevisionState varchar(50) = '' 
  ,@UserId int = 0
  ,@Status Bit =0 OUTPUT 
  ,@IsContentType Bit= 1
  ,@NewGUID nvarchar(500)  
)
AS
/*
  To publish all Contenet pages and their mapping into their respective entities 
	ZnodePublishContentPageConfigEntity
	ZnodePublishSEOEntity
	ZnodePublishWidgetProductEntity
	ZnodePublishMediaWidgetEntity
	ZnodePublishSearchWidgetEntity
	ZnodePublishTextWidgetEntity
	ZnodePublishWidgetSliderBannerEntity
	ZnodePublishWidgetTitleEntity

	Unit Testing : 
	Declare @Status bit 
	

	Declare @Status bit 
	Exec [dbo].[Znode_PublishPortalEntity]
     @PortalId  = 1 
	,@LocaleId  = 0 
	,@RevisionState = 'PRODUCTION' 
	,@UserId = 2
	,@Status = @Status 
	--Select @Status 


*/
BEGIN
BEGIN TRY 
SET NOCOUNT ON
	Declare @PortalCode Varchar(100)
	Declare @Type varchar(50) = '',	@CMSSEOCode varchar(300),@UserName Varchar(50);
	SET @Status = 1 
	Declare @IsPreviewEnable int,@PreviewVersionId INT = 0  ,@ProductionVersionId INT = 0
	
	Select TOP 1  @UserName = aspNetZnodeUser.UserName from ZnodeUser Inner Join aspNetUsers ON ZnodeUser.aspNetUserId = aspNetUsers.Id 
	Inner Join aspNetZnodeUser on aspNetUsers.UserName = aspNetZnodeUser.AspNetZnodeUserId
	where ZnodeUser.UserId = @userId
            


 		If Exists (SELECT  * from ZnodePublishStateApplicationTypeMapping PSA where PSA.IsEnabled =1 and  
		Exists (select TOP 1 1  from ZnodePublishState PS where PS.PublishStateId = PSA.PublishStateId ) and ApplicationType =  'WebstorePreview')
			SET @IsPreviewEnable = 1 
		else 
			SET @IsPreviewEnable = 0 

		--Genrate preview entry 
		DECLARE @SetLocaleId INT , @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleId(), @MaxCount INT =0 , @IncrementalId INT = 1  
		DECLARE @TBL_Locale TABLE (LocaleId INT , RowId INT IDENTITY(1,1))
		
		DECLARE @TBL_StoreEntity TABLE 
		(
			 PortalThemeId	int,PortalId	int,ThemeId	int,ThemeName	varchar(200),CSSId	int,CSSName	nvarchar(2000),
			 WebsiteLogo	varchar(300),WebsiteTitle	nvarchar(400),FaviconImage	varchar(300),WebsiteDescription	nvarchar(MAX),
			 PublishState	varchar(100),LocaleId	int	
		)
		
		IF object_id('tempdb..[#Tbl_VersionEntity]') IS NOT NULL
			drop table tempdb..#Tbl_VersionEntity
		Create Table #Tbl_VersionEntity(PortalId int , VersionId int , LocaleId int , PublishType varchar(50) )

		IF object_id('tempdb..[#Tbl_OldVersionEntity]') IS NOT NULL
			drop table tempdb..#Tbl_OldVersionEntity
		Create Table #Tbl_OldVersionEntity(PortalId int , NewVersionId int ,OldVersionId int , LocaleId int , PublishType varchar(50) )

	
		DECLARE @WebStoreEntityId int 
		
		select @PortalCode  = StoreName  from ZnodePortal where PortalId = @PortalId 
		
		INSERT INTO @TBL_Locale (LocaleId) SELECT LocaleId FROM ZnodeLocale WHERE IsActive =1 AND (LocaleId  = @LocaleId OR @LocaleId = 0 )
		
		---managed brand seo data
		delete ZCSDL from ZnodeCMSSEODetailLocale ZCSDL
		where exists(select *  from ZnodeCMSSEODetail ZCSD1
		where not exists(select * from ZnodeBrandDetails ZBD
		inner join ZnodePortalBrand ZPB ON ZBD.BrandId = ZPB.BrandId and ZCSD1.PortalId = ZPB.PortalId
		and ZBD.BrandCode = ZCSD1.SEOCode) and ZCSDL.CMSSEODetailId = ZCSD1.CMSSEODetailId
		and ZCSD1.CMSSEOTypeId = (select top 1 CMSSEOTypeId from ZnodeCMSSEOType where Name = 'Brand'))


		delete ZCSD1 from ZnodeCMSSEODetail ZCSD1
		where not exists(select * from ZnodeBrandDetails ZBD
		inner join ZnodePortalBrand ZPB ON ZBD.BrandId = ZPB.BrandId and ZCSD1.PortalId = ZPB.PortalId
		and ZBD.BrandCode = ZCSD1.SEOCode)
		and ZCSD1.CMSSEOTypeId = (select top 1 CMSSEOTypeId from ZnodeCMSSEOType where Name = 'Brand')

		insert into ZnodeCMSSEODetail(CMSSEOTypeId,SEOId,IsRedirect,MetaInformation,PortalId,SEOUrl,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		,IsPublish,SEOCode,PublishStateId)
		select distinct (select top 1 CMSSEOTypeId from ZnodeCMSSEOType where Name = 'Brand'),null,null,null,ZPB.PortalId,isnull(ZBDL.SEOFriendlyPageName,ZBD.BrandCode),@userId,
		getdate(),@userId,getdate(),null,ZBD.BrandCode,3
		from ZnodeBrandDetails ZBD
		inner join ZnodePortalBrand ZPB ON ZBD.BrandId = ZPB.BrandId
		inner join ZnodeBrandDetailLocale ZBDL on ZBD.BrandId = ZBDL.BrandId
		where not exists(select * from ZnodeCMSSEODetail ZCSD1 where ZCSD1.CMSSEOTypeId = (select top 1 CMSSEOTypeId from ZnodeCMSSEOType where Name = 'Brand')
		and ZCSD1.PortalId = ZPB.PortalId
		and ZBD.BrandCode = ZCSD1.SEOCode) and ZPB.PortalId = @PortalId

		insert into ZnodeCMSSEODetailLocale(CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CanonicalURL,RobotTag)
		select distinct ZCSD.CMSSEODetailId,L.LocaleId,ZBDL.BrandName,ZBDL.BrandName,ZBDL.BrandName,@userId,getdate(),@userId,getdate(),null,null
		from ZnodeCMSSEODetail ZCSD
		inner join ZnodeBrandDetails ZBD on ZCSD.SEOCode = ZBD.BrandCode
		inner join ZnodeBrandDetailLocale ZBDL on ZBD.BrandId = ZBDL.BrandId
		inner join ZnodePortalBrand ZPB ON ZBD.BrandId = ZPB.BrandId
		cross apply @TBL_Locale L
		where CMSSEOTypeId = (select top 1 CMSSEOTypeId from ZnodeCMSSEOType where Name = 'Brand')
		and not exists(select * from ZnodeCMSSEODetailLocale ZCSDL where ZCSDL.CMSSEODetailId = ZCSD.CMSSEODetailId)
		 ---managed brand seo data
		
		SET @MaxCount = ISNULL((SELECT MAx(RowId) FROM @TBL_Locale),0)
		WHILE @IncrementalId <= @MaxCount
		BEGIN 
			SET @SetLocaleId = (SELECT Top 1 LocaleId FROM @TBL_locale WHERE RowId = @IncrementalId)
			if (@IsPreviewEnable = 1 AND ( @RevisionState like '%Preview%'  OR @RevisionState like '%Production%' ) ) 
			Begin
				Insert into ZnodePublishPortalLog
				(PortalId,IsPortalPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,PublishStateId)
				Select @PortalId ,1 , @UserId , Getdate(),@UserId ,Getdate() ,@UserId ,Getdate(), NULL, DBO.Fn_GetPublishStateIdForProcessing()
				
				insert into #Tbl_VersionEntity (PortalId,VersionId,LocaleId,PublishType)
				select @PortalId, @@Identity , @SetLocaleId ,'PREVIEW'
				
			End
			If (@RevisionState like '%Production%' OR @RevisionState = 'None')
			Begin
				--Genrate production entry 
				Insert into ZnodePublishPortalLog
				(PortalId,IsPortalPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,PublishStateId)
				Select @PortalId ,1 , @UserId , Getdate(),@UserId ,Getdate() ,@UserId ,Getdate(), NULL, DBO.Fn_GetPublishStateIdForProcessing()
			
				insert into #Tbl_VersionEntity (PortalId,VersionId,LocaleId,PublishType)
				select @PortalId, @@Identity , @SetLocaleId ,'PRODUCTION'
			End 
	   	SET @IncrementalId = @IncrementalId +1 
		END 

	Truncate table ZnodePublishPortalErrorLogEntity

	Declare @IsFirstTimeContentPublish bit 
	If Exists (Select TOP 1 1  from ZnodePublishWebStoreEntity where PortalId = @PortalId)
		SET @IsFirstTimeContentPublish =1 
	else 
		SET @IsFirstTimeContentPublish =0
    
	Declare @Tbl_PreviewVersionId  TABLE (VersionId int , PortalId int , LocaleId int )
	Declare @Tbl_ProductionVersionId  TABLE (VersionId int , PortalId int , LocaleId int )

	If @IsContentType = 0 AND @IsFirstTimeContentPublish =1 
	Begin 
		Insert into #Tbl_OldVersionEntity (PortalId,NewVersionId,OldVersionId, LocaleId, PublishType)
		Select A.PortalId , A.VersionId, B.VersionId, a.LocaleId,a.PublishType from #Tbl_VersionEntity A Inner join ZnodePublishWebStoreEntity B on 
		A.PortalId = B.PortalId and A.LocaleId = B.LocaleId AND A.PublishType= B.PublishState  
	End
	Delete from ZnodePublishProgressNotifierEntity where JobName  = @PortalCode 
	
	INSERT INTO ZnodePublishProgressNotifierEntity
	(VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriendlyName)
	Values(0,@NewGUID , Isnull(@PortalCode,'') + ' Store' , 0 , 0 , 0 , '' , @UserId, @UserName)

	if @Type = 'ZnodePublishWebStoreEntity' OR @Type = ''
	Begin
		 Declare  @PreviewVersionIdString varchar(1000)= ''  ,@ProductionVersionIdString varchar(1000) = '' 
		 SELECT   @PreviewVersionIdString = STUFF((SELECT ',' + cast (VersionId as varchar(50))  FROM #Tbl_VersionEntity   where PublishType = 'PREVIEW'  FOR XML PATH ('')), 1, 1, '') 
		 SELECT   @ProductionVersionIdString = STUFF((SELECT ',' + cast (VersionId as varchar(50))  FROM #Tbl_VersionEntity   where PublishType = 'PRODUCTION'  FOR XML PATH ('')), 1, 1, '') 
		 
		 EXEC [dbo].[Znode_SetPublishWebStoreEntity]
			 @PortalId  = @PortalId 
			,@LocaleId   = @LocaleId 
			,@IsPreviewEnable =@IsPreviewEnable 
			,@PreviewVersionId  = @PreviewVersionIdString 
			,@ProductionVersionId = @ProductionVersionIdString 
			,@RevisionState = @RevisionState 
			,@UserId = @UserId	
			,@Status = @Status Output 

			INSERT INTO ZnodePublishPortalErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ZnodePublishWebStoreEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =5 , 
			IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
			IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
			where  JobId = @NewGUID
	End
	
	if (@Type = 'ZnodePublishPortalBrandEntity' OR @Type = '' ) AND @Status = 1 
	Begin
			Exec [Znode_SetPublishPortalBrandEntity]
			 @PortalId  = @PortalId
			,@IsPreviewEnable =@IsPreviewEnable 
			,@PreviewVersionId  = 0 
			,@ProductionVersionId = 0
			,@RevisionState = @RevisionState 
			,@UserId = @UserId  
			,@Status = @Status Output 

			INSERT INTO ZnodePublishPortalErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ZnodePublishPortalBrandEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
			
			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark = CASE When (@IsContentType = 1 OR (@IsFirstTimeContentPublish = 0 AND @IsContentType = 0 ) ) THEN 10 Else 100 End , 
			IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
			IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
			where  JobId = @NewGUID
	End 

	if (@Type = 'ZnodePublishSEOEntity' OR @Type = '') AND @Status = 1 and (@IsContentType = 0 or @PortalId > 0)
			Begin
					Exec [Znode_SetPublishSEOEntity]
					 @PortalId  = @PortalId
					,@LocaleId  = @LocaleId 
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = 0 
					,@ProductionVersionId = 0
					,@RevisionState = @RevisionState 
					,@CMSSEOTypeId = '4'
					,@CMSSEOCode = ''
					,@UserId = @UserId  
					,@Status = @Status Output 

			End 
	If (@IsContentType = 1 OR (@IsFirstTimeContentPublish = 0 AND @IsContentType = 0 ) ) AND @Status = 1  
	Begin
			if @Type = 'ZnodePublishBlogNewsEntity' OR @Type = '' 
			Begin
				 EXEC [dbo].[Znode_SetPublishBlogNewsEntity]
					 @PortalId  = @PortalId 
					,@LocaleId   = @LocaleId 
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@UserId = @UserId	
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishBlogNewsEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 15 , 
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID

			End
			if (@Type = 'ZnodePublishPortalCustomCssEntity' OR @Type = '' ) AND @Status = 1  
			Begin
				 EXEC [dbo].[Znode_SetPublishPortalCustomCssEntity]
					 @PortalId  = @PortalId 
					,@LocaleId   = @LocaleId 
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@UserId = @UserId	
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishPortalCustomCssEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 20  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID


			End
			if (@Type = 'ZnodePublishWidgetCategoryEntity' OR @Type = '' ) AND @Status = 1 
			Begin
				 EXEC [dbo].[Znode_SetPublishWidgetCategoryEntity]
					 @PortalId  = @PortalId 
					,@LocaleId   = @LocaleId 
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@UserId = @UserId	
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishWidgetCategoryEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 25  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID
			End
	
			if (@Type = 'ZnodePublishWidgetProductEntity' OR @Type = '') AND @Status = 1  
			Begin
					EXEC Znode_SetPublishWidgetProductEntity
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSMappingId = 0
					,@UserId = @UserId 
					,@Status = @Status  Output
			
					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishWidgetProductEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 30  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID
			END 

			if (@Type = 'ZnodePublishWidgetTitleEntity' OR @Type = '') AND @Status = 1  
			Begin
					EXEC Znode_SetPublishWidgetTitleEntity
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSContentPagesId = 0
					,@UserId = @UserId 
					,@Status = @Status  Output

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishWidgetTitleEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 35  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID

			END 
			if (@Type = 'ZnodePublishWidgetSliderBannerEntity' OR @Type = '')AND @Status = 1  
			Begin
					EXEC Znode_SetPublishWidgetSliderBannerEntity
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSContentPagesId = 0
					,@CMSSliderId = 0 
					,@UserId = @UserId 
					,@Status = @Status  Output
			
					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishWidgetSliderBannerEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
					
					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 40  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			
			END 
			if (@Type = 'ZnodePublishTextWidgetEntity' OR @Type = '' ) AND @Status = 1  
			Begin
					EXEC Znode_SetPublishTextWidgetEntity
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSMappingId = 0
					,@UserId = @UserId 
					,@Status = @Status  Output
			
					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishTextWidgetEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 45  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			

			END 
			if (@Type = 'ZnodeSetPublishMediaWidgetEntity' OR @Type = '') AND @Status = 1
			Begin
					EXEC Znode_SetPublishMediaWidgetEntity
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSMappingId = 0
					,@UserId = @UserId 
					,@Status = @Status  Output
			
					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishMediaWidgetEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
										
					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 50  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			
			END 
			if (@Type = 'ZnodePublishSearchWidgetEntity' OR @Type = '') AND @Status = 1
			Begin
					EXEC Znode_SetPublishSearchWidgetEntity
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSMappingId = 0
					,@UserId = @UserId 
					,@Status = @Status  Output
			
					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishSearchWidgetEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
					
					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 55  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			
			END 

			if (@Type = 'ZnodePublishContentPageConfigEntity' OR @Type = '') AND @Status = 1
			Begin
				 EXEC [dbo].[Znode_SetPublishContentPageConfigEntity]
					 @PortalId  = @PortalId 
					,@LocaleId   = @LocaleId 
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSContentPagesId = 0
					,@UserId = @UserId	
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishContentPageConfigEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
					
					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 60,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			
			End

			if (@Type = 'ZnodePublishSEOEntity' OR @Type = '') AND @Status = 1
			Begin
					Exec [Znode_SetPublishSEOEntity]
					 @PortalId  = @PortalId
					,@LocaleId  = @LocaleId 
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = 0 
					,@ProductionVersionId = 0
					,@RevisionState = @RevisionState 
					,@CMSSEOTypeId = '3,5'
					,@CMSSEOCode = ''
					,@UserId = @UserId  
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishSEOEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					
					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 60,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			

			End 
			if (@Type = 'ZnodePublishMessageEntity' OR @Type = '') AND @Status = 1
			Begin
					Exec [Znode_SetPublishMessageEntity]
					 @PortalId  = @PortalId
					,@LocaleId  = @LocaleId 
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = 0 
					,@ProductionVersionId = 0
					,@RevisionState = @RevisionState 
					,@UserId = @UserId  
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishMessageEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 65,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			

			End 

		   if (@Type = 'ZnodePublishPortalGlobalAttributeEntity' OR @Type = '') AND @Status = 1
			Begin
					Exec [Znode_SetPublishPortalGlobalAttributeEntity]
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = 0 
					,@ProductionVersionId = 0
					,@RevisionState = @RevisionState 
					,@UserId = @UserId  
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishPortalGlobalAttributeEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
					
					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 67,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			

			End 
 
		   if (@Type = 'ZnodePublishProductPageEntity' OR @Type = '') AND @Status = 1
			Begin
					Exec [Znode_SetPublishProductPageEntity]
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = 0 
					,@ProductionVersionId = 0
					,@RevisionState = @RevisionState 
					,@UserId = @UserId  
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishProductPageEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 73,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			


			End 
			
			if (@Type = 'ZnodePublishWidgetBrandEntity' OR @Type = '') AND @Status = 1
			Begin
					Exec [Znode_SetPublishWidgetBrandEntity]
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = 0 
					,@ProductionVersionId = 0
					,@RevisionState = @RevisionState 
					,@UserId = @UserId  
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishWidgetBrandEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 80,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			

			End 

			if (@Type = 'ZnodePublishContainerWidgetEntity' OR @Type = '' ) AND @Status = 1  
			Begin
					EXEC Znode_SetPublishContainerWidgetEntity
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSMappingId = 0
					,@UserId = @UserId 
					,@Status = @Status  Output
			
					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishContainerWidgetEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 90  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			

			END 

	End
		IF Exists (select TOP 1 1  from ZnodePublishPortalErrorLogEntity where  ProcessStatus = 'Fail') 
		Begin
			SET @Status  =0 
			SELECT 1 AS ID,@Status AS Status;
			INSERT INTO ZnodePublishPortalErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ZnodePublishPortalEntity', @RevisionState , 'Fail' , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
			
			Delete  From ZnodePublishWebStoreEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId
			Delete  From ZnodePublishBlogNewsEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishPortalCustomCssEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishWidgetCategoryEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishWidgetProductEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishWidgetTitleEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishWidgetSliderBannerEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishTextWidgetEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishMediaWidgetEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishSearchWidgetEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishContentPageConfigEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishSEOEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId and CMSSEOTypeId in (3,5)
			Delete  From ZnodePublishMessageEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishPortalGlobalAttributeEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishPortalBrandEntity Where  VersionId  in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishProductPageEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishWidgetBrandEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
		
			Update ZnodePublishPortalLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed(),ModifiedDate=GETDATE()  where  PublishPortalLogId in  (Select VersionId from #Tbl_VersionEntity Where PublishType = 'PREVIEW' )
			Update ZnodePublishPortalLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed(),ModifiedDate=GETDATE()  where  PublishPortalLogId in (Select VersionId from #Tbl_VersionEntity Where PublishType = 'PRODUCTION' )

		End
	Else 
		Begin
			Update ZnodePublishPortalLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPreview(),ModifiedDate=GETDATE()  where  PublishPortalLogId in 
			(Select VersionId from #Tbl_VersionEntity Where PublishType = 'PREVIEW' )
			Update ZnodePublishPortalLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublish(),ModifiedDate=GETDATE()  where  PublishPortalLogId in
			(Select VersionId from #Tbl_VersionEntity Where PublishType = 'PRODUCTION' )
			 
			Insert into ZnodePublishPreviewLogEntity
			(VersionId,PublishStartTime,IsDisposed,SourcePublishState,EntityId,EntityType,LogMessage,LogCreatedDate,PreviousVersionId,LocaleId,LocaleDisplayValue)
				Select A.VersionId,NULL,NULL,A.PublishType,@PortalId,'portal','portal has been published successfully' , Getdate(),  
				(select TOP 1 VersionId   from ZnodePublishWebStoreEntity where LocaleId = A.LocaleId AND PublishState = A.PublishType
				 and PortalId = @PortalId),A.LocaleId,B.Name
				from #Tbl_VersionEntity  A  Inner join ZnodeLocale B on A.LocaleId = B.LocaleId

			If @RevisionState = 'PREVIEW'
			Begin
				update ZnodeCMSContentPages SET  IsPublished = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPreview() where (PortalId = @PortalId OR @PortalId  =0 ) 
				update ZnodeCMSSEODEtail SET  IsPublish = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPreview() where 
				(PortalId = @PortalId OR @PortalId  =0 )  AND CMSSEOTypeId = 3 
			End 
			Else 
			Begin
				update ZnodeCMSContentPages SET  IsPublished = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublish() where (PortalId = @PortalId OR @PortalId  =0 ) 
				update ZnodeCMSSEODEtail SET  IsPublish = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublish() where 
				(PortalId = @PortalId OR @PortalId  =0 )  AND CMSSEOTypeId = 3 
			End
			
			if (@IsContentType =1  OR (@IsContentType = 0 AND @IsFirstTimeContentPublish =0))
			Begin
				If @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  ) 
				Begin
					Delete  From ZnodePublishWebStoreEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishBlogNewsEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishPortalCustomCssEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetCategoryEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetProductEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetTitleEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetSliderBannerEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishTextWidgetEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishMediaWidgetEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishSearchWidgetEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishContentPageConfigEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishSEOEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId) And CMSSEOTypeId in (3,5) 
					Delete  From ZnodePublishMessageEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishPortalGlobalAttributeEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishPortalBrandEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishProductPageEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetBrandEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
				End
				If (@RevisionState like '%Production%' OR @RevisionState = 'None')
				Begin
					Delete  From ZnodePublishWebStoreEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishBlogNewsEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishPortalCustomCssEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetCategoryEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetProductEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetTitleEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetSliderBannerEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishTextWidgetEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishMediaWidgetEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishSearchWidgetEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishContentPageConfigEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishSEOEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId) And CMSSEOTypeId in (3,5) 
					Delete  From ZnodePublishMessageEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishPortalGlobalAttributeEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishPortalBrandEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishProductPageEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetBrandEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
				End
			End
			Else 
			Begin
				
				If @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  ) 
				Begin
					Delete  From ZnodePublishWebStoreEntity           Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Delete  From ZnodePublishPortalBrandEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
				
					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishBlogNewsEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishPortalCustomCssEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					
					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetCategoryEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetProductEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetTitleEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetSliderBannerEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishTextWidgetEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishMediaWidgetEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishSearchWidgetEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId =6)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishContentPageConfigEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishSEOEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					And CMSSEOTypeId in (3,5) 

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishMessageEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishPortalGlobalAttributeEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishProductPageEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetBrandEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
				End
				If (@RevisionState like '%Production%' OR @RevisionState = 'None')
				Begin
					Delete  From ZnodePublishWebStoreEntity           Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Delete  From ZnodePublishPortalBrandEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
				
					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishBlogNewsEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishPortalCustomCssEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					
					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetCategoryEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetProductEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetTitleEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetSliderBannerEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishTextWidgetEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishMediaWidgetEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishSearchWidgetEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishContentPageConfigEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishSEOEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					And CMSSEOTypeId in (3,5)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishMessageEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishPortalGlobalAttributeEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishProductPageEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetBrandEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
				End 
			End

			--update ZnodeCMSContentPages SET  IsPublished = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublish() where @CMSContentPagesId = CMSContentPagesId and  (PortalId = @PortalId OR @PortalId  =0 ) 
			--update ZnodeCMSSEODEtail SET  IsPublish = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublish() where 
			--SEOCode = @CMSSEOCode and  (PortalId = @PortalId OR @PortalId  =0 )  AND CMSSEOTypeId = 3 
		 SET @Status = 1
		End
	SELECT 1 AS ID,@Status AS Status;   

END TRY 
BEGIN CATCH 
	SET @Status =0  
	 SELECT 1 AS ID,@Status AS Status;   

	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishPortalEntity 
		@PortalId = '+CAST(@PortalId AS VARCHAR	(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))
		+',@PreviewVersionId = ' + CAST(@PreviewVersionId  AS varchar(20))
		+',@ProductionVersionId = ' + CAST(@ProductionVersionId  AS varchar(20))
		+',@RevisionState = ''' + CAST(@RevisionState  AS varchar(50))
		+',@UserId = ' + CAST(@UserId AS varchar(20));	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
	
			
	INSERT INTO ZnodePublishPortalErrorLogEntity
	(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
	SELECT 'ZnodePublishPortalEntity', @RevisionState + isnull(@ErrorMessage,'') , 'Fail' , Getdate(), 
	@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

		                			 
	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_PublishPortalEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCatalogCategoryHierarchyAssociation')
	DROP PROC Znode_ImportCatalogCategoryHierarchyAssociation
GO

CREATE PROCEDURE [dbo].[Znode_ImportCatalogCategoryHierarchyAssociation]
(
	@TableName NVARCHAR(100), 
	@Status BIT OUT, 
	@UserId INT, 
	@ImportProcessLogId INT, 
	@NewGUId NVARCHAR(200),
	@PimCatalogId INT
)
AS
BEGIN 
BEGIN TRAN A;
BEGIN TRY
SET NOCOUNT ON;

	DECLARE @GetDate datetime= dbo.Fn_GetDate()
	DECLARE @SSQL VARCHAR(1000)

	IF OBJECT_ID('tempdb..#Category') IS NOT NULL
		DROP TABLE #Category;

	Declare @FeatureValue VARCHAR(500)
	--If the CatalogCategoryHierarchyAssociationAutoCreate value is true, 1 or Yes then input parent code hierarchy will be generate thogh the import
	--If the CatalogCategoryHierarchyAssociationAutoCreate value is false, 0 or No then input parent code hierarchy is not present in the database then it will give an error log
	SELECT TOP 1 @FeatureValue = FeatureValues FROM ZnodeGlobalSetting WHERE FeatureName = 'CatalogCategoryHierarchyAssociationAutoCreate'

	--Getting existing categories
	SELECT A.PimCategoryId,B.CategoryValue CategoryCode 
	INTO #Category 
	FROM ZnodePimCategoryAttributeValue A 
	INNER JOIN ZnodePimCategoryAttributeValueLocale B ON A.PimCategoryAttributeValueId = b.PimCategoryAttributeValueId 
	WHERE EXISTS(SELECT TOP 1 1 FROM ZnodePimAttribute X WHERE X.IsCategory =1 and X.AttributeCode = 'CategoryCode' and A.PimAttributeId = X.PimAttributeId )

	IF OBJECT_ID('tempdb..#HierarchyImportData') IS NOT NULL
		DROP TABLE #HierarchyImportData;

	CREATE TABLE #HierarchyImportData (RowNumber INT,ParentCode NVARCHAR(MAX),CategoryCode NVARCHAR(MAX), DisplayOrder VARCHAR(10),Action VARCHAR(100),GUID VARCHAR(100));

	SET @SSQL = 'Select RowNumber,LTRIM(RTRIM(ParentCode)), LTRIM(RTRIM(CategoryCode)), DisplayOrder, Action ,GUID FROM '+@TableName;
	INSERT INTO #HierarchyImportData( RowNumber,ParentCode, CategoryCode, DisplayOrder,Action ,GUID)
	EXEC sys.sp_sqlexec @SSQL;

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '131', 'CategoryCode', CategoryCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
	FROM #HierarchyImportData AS ii
	WHERE ISNULL(CategoryCode,'') = ''

	DELETE FROM #HierarchyImportData WHERE RowNumber IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )

	IF OBJECT_ID('tempdb..#SplitedCategoryHierarchy') IS NOT NULL
		DROP TABLE #SplitedCategoryHierarchy

	--Created table for category hierarchy split
	CREATE TABLE #SplitedCategoryHierarchy (PimCategoryHierarchyId INT, ParentPimCategoryHierarchyId INT
	,PimCatalogId INT, PimCategoryId INT,RowNumber INT ,PimCategoryCode VARCHAR(300),RowId INT,Action varchar(100),DisplayOrder VARCHAR(10), ParentCategoryId INT)

	DECLARE @RecordCount INT=(SELECT COUNT(1) FROM #HierarchyImportData) , @Cnt INT = 1 ,@FirstCategoryId  INT 
	WHILE @Cnt <= @RecordCount  
	BEGIN
		SET @FirstCategoryId = 0 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '122', 'ParentCode / CategoryCode', '', @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNULL(ParentCode,'') = '' AND ISNULL(CategoryCode,'') = '' AND ii.RowNumber  = @Cnt 

		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--SELECT '102', 'CategoryCode', CategoryCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		--FROM #HierarchyImportData AS ii
		--WHERE ltrim(rtrim(isnull(ii.CategoryCode,''))) like '% %' AND ii.RowNumber  = @Cnt 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '115', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE (ii.DisplayOrder > 999 OR ii.DisplayOrder <= 0) AND ISNULL(ii.DisplayOrder,'') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '115', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNUMERIC(ii.DisplayOrder)=0 AND ISNULL(ii.DisplayOrder,'') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '125', 'Action', Action, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE isnull(Action,'') NOT IN ('ADD','DELETE')
		
		IF OBJECT_ID('tempdb..#ExistingHierarchy') IS NOT NULL
			DROP TABLE #ExistingHierarchy;
	
		TRUNCATE TABLE #SplitedCategoryHierarchy

		--Splitting category hierarchy and inserted into temp table #SplitedCategoryHierarchy
		INSERT INTO #SplitedCategoryHierarchy (PimCatalogId , PimCategoryCode ,RowNumber,RowId,Action,DisplayOrder)
		SELECT @PimCatalogId, LTRIM(RTRIM(B.item)) as PimCategoyHierarchyCode , Id, RowNumber, Action, CASE WHEN ISNULL(DisplayOrder,'') = '' THEN 0 ELSE DisplayOrder END
		FROM #HierarchyImportData A 
		CROSS APPLY  dbo.split(isnull(A.ParentCode,'')+CASE WHEN isnull(A.ParentCode,'') = '' THEN '' ELSE '/' END+A.CategoryCode,'/') B 
		Where A.RowNumber  = @Cnt  

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '127', 'ParentCode / CategoryCode', PimCategoryCode, @NewGUId, RowId, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #SplitedCategoryHierarchy AS ii
		WHERE NOT EXISTS(SELECT * FROM #Category C WHERE LTRIM(RTRIM(ii.PimCategoryCode)) = c.CategoryCode)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '123', 'ParentCode / CategoryCode', PimCategoryCode, @NewGUId, RowId, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #SplitedCategoryHierarchy AS ii
		GROUP BY PimCategoryCode ,RowId
		HAVING COUNT(*) > 1

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '124', 'ParentCode', ParentCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNULL(replace(ii.ParentCode,' ',''),'') like '%//%'
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '128', 'CategoryCode', CategoryCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNULL(replace(LTRIM(RTRIM(ii.CategoryCode)),' ',''),'') like '%[^a-zA-Z0-9]%'

		--Deleting the records which was invalid and added into error log
		DELETE FROM #SplitedCategoryHierarchy WHERE RowId IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )
		DELETE FROM #HierarchyImportData WHERE RowNumber IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )

		IF OBJECT_ID('tempdb..#CategoryCodeCheck') IS NOT NULL
			DROP TABLE #CategoryCodeCheck;

		IF EXISTS(SELECT * FROM #SplitedCategoryHierarchy)
		BEGIN
			Update A SET A.PimCategoryId = D.PimCategoryId FROM #SplitedCategoryHierarchy A INNER JOIN #Category D ON LTRIM(RTRIM(A.PimCategoryCode)) = LTRIM(RTRIM(D.CategoryCode))

			Select TOP 1 @FirstCategoryId = X.PimCategoryId FROM #SplitedCategoryHierarchy X
	
			--Getting existing category hierarchy
			;WITH CTE_ZnodePimCategoryHierarchy as 
			(
				SELECT PimCategoryHierarchyId,ParentPimCategoryHierarchyId,PimCategoryId,PimCatalogId
				FROM ZnodePimCategoryHierarchy 
				WHERE PimCatalogId = @PimCatalogId 
			)
			,Hierarchy AS
			(
				-- Anchor
				SELECT  A.PimCategoryHierarchyId,A.ParentPimCategoryHierarchyId,A.PimCategoryId,A.PimCatalogId --, dense_rank() over(order by a.ParentPimCategoryHierarchyId) as RowNumber
				FROM CTE_ZnodePimCategoryHierarchy A
				WHERE A.ParentPimCategoryHierarchyId IS NULL AND  
				A.PimCategoryId =@FirstCategoryId 	AND A.PimCatalogId = @PimCatalogId
				UNION ALL
				-- Recursive query
				SELECT  E.PimCategoryHierarchyId,E.ParentPimCategoryHierarchyId,E.PimCategoryId,E.PimCatalogId--, ROW_NUMBER() over(order by E.ParentPimCategoryHierarchyId,E.PimCategoryHierarchyId) as RowNumber
				FROM CTE_ZnodePimCategoryHierarchy E
				JOIN Hierarchy H ON E.ParentPimCategoryHierarchyId = H.PimCategoryHierarchyId
				WHERE  Exists(Select * FROM #SplitedCategoryHierarchy X WHERE E.PimCategoryId = X.PimCategoryId)
			)
			SELECT * INTO #ExistingHierarchy FROM Hierarchy --Where RowNumber  = @Cnt  --
			--order by PimCategoryHierarchyId

			--Adding required columns into temp table
			Alter table #ExistingHierarchy Add Id INT Identity(1,1), RowNumber INT, ParentCategoryId INT

			--Updating the row number for parent category
			UPDATE #ExistingHierarchy SET RowNumber = 1 WHERE ParentPimCategoryHierarchyId IS NULL

			DECLARE @RecordCount1 INT=(SELECT COUNT(1) FROM #ExistingHierarchy) , @Cnt1 INT = 1 --,@FirstCategoryId1  INT 
			DECLARE @ParentPimCategoryHierarchyId1 INT , @RowNumber INT

			--Updating the row number according to category hierarhcy level
			WHILE @Cnt1 <= @RecordCount1  
			BEGIN
				
				SELECT @ParentPimCategoryHierarchyId1 = PimCategoryHierarchyId FROM #ExistingHierarchy WHERE Id = @Cnt1
				SET @RowNumber = (SELECT TOP 1 RowNumber FROM #ExistingHierarchy WHERE PimCategoryHierarchyId = @ParentPimCategoryHierarchyId1) 

				UPDATE #ExistingHierarchy SET RowNumber = @RowNumber + 1
				WHERE ParentPimCategoryHierarchyId = @ParentPimCategoryHierarchyId1
				
				SET @ParentPimCategoryHierarchyId1 = 0
				SET @RowNumber = 0
				SET @Cnt1 = @Cnt1+1
			END

			--Updating the parent category on existing category hierarchy
			UPDATE b SET ParentCategoryId = a.PimCategoryId
			from #ExistingHierarchy a
			inner join #ExistingHierarchy b on b.ParentPimCategoryHierarchyId = a.PimCategoryHierarchyId
			
			--Updating the parent category on input record
			UPDATE  A SET A.ParentCategoryId = B.PimCategoryId
			FROM #SplitedCategoryHierarchy A  
			INNER JOIN #SplitedCategoryHierarchy B ON B.RowNumber = A.RowNumber-1
						
			--Existing Hierarchy has been updated on the input categories
			Update B SET B.PimCategoryHierarchyId= A.PimCategoryHierarchyId, 
			B.ParentPimCategoryHierarchyId = A.ParentPimCategoryHierarchyId
			FROM #ExistingHierarchy  A INNER JOIN #SplitedCategoryHierarchy B ON ISNULL(A.PimCategoryId,0) = ISNULL(B.PimCategoryId,0) AND ISNULL(A.ParentCategoryId,0) = ISNULL(B.ParentCategoryId,0) and A.RowNumber = B.RowNumber 

			--Removing hierarchy ids of categoris if its parent dont have any hierarchy for input	
			UPDATE CH SET PimCategoryHierarchyId = NULL ,ParentPimCategoryHierarchyId = NULL
			FROM #SplitedCategoryHierarchy CH
			WHERE CH.PimCategoryHierarchyId IS NOT NULL AND EXISTS(SELECT * FROM #SplitedCategoryHierarchy CH1 WHERE CH1.PimCategoryHierarchyId IS NULL AND CH.RowNumber-1 = CH1.RowNumber)

			--Removing hierarchy ids of categories if its parent doesent present in the input hierarchy
			UPDATE A SET PimCategoryHierarchyId = NULL ,ParentPimCategoryHierarchyId = NULL 
			FROM #SplitedCategoryHierarchy A 
			WHERE NOT EXISTS(SELECT * FROM #SplitedCategoryHierarchy X WHERE X.PimCategoryHierarchyId = A.ParentPimCategoryHierarchyId)
			AND A.ParentPimCategoryHierarchyId IS NOT NULL 
			
			IF isnull(@FeatureValue,'') IN ('False','0','No','')
			BEGIN
				--If root level category is not present
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '130', 'ParentCode', ParentCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #HierarchyImportData h
				WHERE RowNumber IN (
					SELECT RowId FROM #SplitedCategoryHierarchy a
					WHERE NOT EXISTS(SELECT * FROM #HierarchyImportData b WHERE LTRIM(RTRIM(A.PimCategoryCode)) = LTRIM(RTRIM(b.CategoryCode)) AND a.RowId = b.RowNumber)
					AND A.ParentCategoryId IS NULL AND A.PimCategoryHierarchyId IS NULL)
				
				--If child level category is not present
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '130', 'ParentCode', ParentCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #HierarchyImportData H
				WHERE RowNumber IN (
					SELECT RowId FROM #SplitedCategoryHierarchy a
					WHERE NOT EXISTS(SELECT * FROM #HierarchyImportData b WHERE LTRIM(RTRIM(A.PimCategoryCode)) = LTRIM(RTRIM(b.CategoryCode)) AND a.RowId = b.RowNumber)
					AND A.ParentCategoryId IS NOT NULL AND A.ParentPimCategoryHierarchyId IS NULL)
				AND NOT EXISTS(SELECT * FROM ZnodeImportLog X WHERE H.RowNumber = X.RowNumber AND X.ImportProcessLogId=@ImportProcessLogId)
				
				--Deleting the records which was invalid and added into error log
				DELETE FROM #SplitedCategoryHierarchy WHERE RowId IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )
				DELETE FROM #HierarchyImportData WHERE RowNumber IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )
			END

			--Adding new hierarchy into ZnodePimCategoryHierarchy if input having Add action
			IF EXISTS(SELECT * FROM #SplitedCategoryHierarchy WHERE Action = 'Add')
			BEGIN
				
				DROP TABLE IF EXISTS #InsertedPimCategoryHierarchy

				CREATE TABLE #InsertedPimCategoryHierarchy (PimCategoryHierarchyId INT, PimCategoryId INT);

				--Inserting new category hierarchy if not present
				INSERT INTO ZnodePimCategoryHierarchy (PimCatalogId,ParentPimCategoryHierarchyId,PimCategoryId,DisplayOrder,IsActive,
					ActivationDate,ExpirationDate,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PimParentCategoryId)
				OUTPUT inserted.PimCategoryHierarchyId,inserted.PimCategoryId
				INTO #InsertedPimCategoryHierarchy (PimCategoryHierarchyId, PimCategoryId)
				Select PimCatalogId,ParentPimCategoryHierarchyId,PimCategoryId,DisplayOrder,1,NULL,NULL,2,GETDATE(),2,GETDATE(),NULL
				FROM #SplitedCategoryHierarchy WHERE PimCategoryHierarchyId is null 

				-- Newly created Hierarchy has been updated into input category hierarchy
				UPDATE A 
				SET A.PimCategoryHierarchyId=B.PimCategoryHierarchyId
				FROM #SplitedCategoryHierarchy A INNER JOIN #InsertedPimCategoryHierarchy B
					ON A.PimCategoryId=B.PimCategoryId
				WHERE A.PimCategoryHierarchyId IS NULL

				-- Updating new parent hierarchy has been updated into input category hierarchy
				UPDATE A SET A.ParentPimCategoryHierarchyId =(Select PimCategoryHierarchyId FROM #SplitedCategoryHierarchy X WHERE X.RowNumber = A.RowNumber -1 )
				FROM #SplitedCategoryHierarchy A 
		
				-- Updating new parent hierarchy has been updated newly added input category hierarchy into table ZnodePimCategoryHierarchy
				UPDATE ZnodePimCategoryHierarchy SET ParentPimCategoryHierarchyId = A.ParentPimCategoryHierarchyId
				FROM #SplitedCategoryHierarchy A WHERE ZnodePimCategoryHierarchy.PimCategoryHierarchyId = A.PimCategoryHierarchyId
				AND EXISTS(SELECT * FROM #InsertedPimCategoryHierarchy B WHERE A.PimCategoryHierarchyId = B.PimCategoryHierarchyId)
			END
			ELSE
			BEGIN
			
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '126', 'ParentCode / CategoryCode', ParentCode + case when isnull(ParentCode,'') <> '' then '/' else '' end + CategoryCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #HierarchyImportData AS ii
				WHERE ii.RowNumber = (SELECT TOP 1 RowId FROM #SplitedCategoryHierarchy where PimCategoryHierarchyId is null ORDER BY RowNumber DESC)

				DELETE FROM #SplitedCategoryHierarchy WHERE RowId IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )
				DELETE FROM #HierarchyImportData WHERE RowNumber IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )

				--Delete the category hierarchy and its child category 
				DECLARE @PimCategoryHierarchyId INT
				SET @PimCategoryHierarchyId = (SELECT TOP 1 PimCategoryHierarchyId FROM #SplitedCategoryHierarchy ORDER BY RowNumber DESC)
				EXECUTE [Znode_DeletePimCategoryHierarchy] @PimCategoryHierarchyId = @PimCategoryHierarchyId, @PimCatalogId = @PimCatalogId, @Status = 0
			END
		END

		SET @Cnt = @Cnt + 1 
	END

	DECLARE @FailedRecordCount BIGINT
	DECLARE @SuccessRecordCount BIGINT

	SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
	SELECT @SuccessRecordCount = COUNT(DISTINCT RowNumber) FROM #HierarchyImportData

	--Updating the import process status
	UPDATE ZnodeImportProcessLog
	SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
						WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
						WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
					END, 
		ProcessCompletedDate = getdate()
	WHERE ImportProcessLogId = @ImportProcessLogId;

	UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
	WHERE ImportProcessLogId = @ImportProcessLogId;

COMMIT TRAN A;
END TRY
BEGIN CATCH
ROLLBACK TRAN A;

	SET @Status = 0;
	SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

	DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCatalogCategoryHierarchyAssociation @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(200));


	---Import process updating fail due to database error
	UPDATE ZnodeImportProcessLog
	SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
	WHERE ImportProcessLogId = @ImportProcessLogId;

	---Loging error for Import process due to database error
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

	--Updating total and fail record count
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
	TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
	WHERE ImportProcessLogId = @ImportProcessLogId;

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_ImportCatalogCategoryHierarchyAssociation',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
		
		
END CATCH;
END;

go
insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 130,'Text','Invalid input, parent category to child category association is required.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 130)

insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 131,'Text','Invalid input, to associate/disassociate parent category, the input must only be added to the Category Code and Parent Code should be empty.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 131)
GO
insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 132,'Text','Catalog association already exists hence no new associations are saved in the Database.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 132)
GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetImportProcessLog')
	DROP PROC Znode_GetImportProcessLog
GO

CREATE PROCEDURE [dbo].[Znode_GetImportProcessLog]
( @WhereClause VARCHAR(max),
  @Rows        INT           = 100,
  @PageNo      INT           = 1,
  @Order_BY    VARCHAR(1000)  = '',
  @RowsCount   INT OUT)
AS
  /*
    Summary : Get import process log details include rowwise errors in details.    	
	Unit Testing   
	begin tran 
	DECLARE @RowsCount INT;
    EXEC Znode_GetImportProcessLog @WhereClause = 'ImportProcessLogId = 1151',@Rows = 1000,@PageNo = 0,@Order_BY = '',@RowsCount = @RowsCount OUT;
	rollback tran
    SELECT @RowsCount;
    
  */
     BEGIN
         SET NOCOUNT ON;
         BEGIN TRY
             DECLARE @SQL NVARCHAR(MAX);
             DECLARE @TBL_ImportLog TABLE(ImportLogId INT,ImportProcessLogId INT,RowNumber BIgInt,ColumnName NVARCHAR(1000),ColumnValue NVARCHAR(max),ErrorDescription NVARCHAR(max)
										,RowId INt , CountNo Int )  ;
             SET @SQL = ' 
							;with Cte_ErrorLog AS 
							(
								SELECT zil.ImportLogId, zil.ImportProcessLogId, ISNULL(zil.RowNumber, 0) [RowNumber], ISNULL(zil.ColumnName, '''') [ColumnName],
								ISNULL(zil.Data, '''') [ColumnValue], zm.MessageName + 
								CASE 
								WHEN zm.MessageCode IN (17)	AND Name in (''Pricing'') AND ISNULL(zil.ColumnName, '''') NOT like ''%Quantity%'' THEN +''  ''+ dbo.Fn_GetDefaultPriceRoundOff(isnull(DefaultErrorValue,''0000000.00'') - 1)
								WHEN zm.MessageCode IN (17)	AND Name in (''Pricing'') AND ISNULL(zil.ColumnName, '''') like ''%Quantity%''  THEN +''  ''+ dbo.Fn_GetDefaultInventoryRoundOff(isnull(DefaultErrorValue,''0000000.00'') -1) 
								WHEN zm.MessageCode IN (17)	AND Name in (''Inventory'')  THEN +''  ''+ dbo.Fn_GetDefaultInventoryRoundOff(isnull(DefaultErrorValue,''0000000.00'') - 1) 
								WHEN zm.MessageCode IN (41) AND Name in (''Pricing'') AND ISNULL(zil.ColumnName, '''') NOT like ''%Quantity%'' THEN +''  ''+ dbo.Fn_GetDefaultPriceRoundOff(isnull(DefaultErrorValue,''0000000.00'' ))
								WHEN zm.MessageCode IN (41) AND Name in (''Pricing'') AND ISNULL(zil.ColumnName, '''')  like ''%Quantity%'' THEN +''  ''+ dbo.Fn_GetDefaultInventoryRoundOff(isnull(DefaultErrorValue,''0000000.00'' ))
								WHEN zm.MessageCode IN (41) AND Name in (''Inventory'') THEN +''  ''+ dbo.Fn_GetDefaultInventoryRoundOff(isnull(DefaultErrorValue,''0000000.00'' ))
								WHEN zm.MessageCode IN (44) AND Name in (''Pricing'') THEN +''  ''+ isnull(DefaultErrorValue,''0000000.00'' )
								WHEN zm.MessageCode IN (129) AND Name NOT IN (''Product'',''Category'') THEN +'' ''+ isnull(DefaultErrorValue,''0000000.00'')+''.''
						

								ELSE ''''END ''ErrorDescription'' ,zil.ModifiedDate,zil.GUID
								FROM ZnodeImportLog AS zil WITH (NOLOCK) INNER JOIN ZnodeMessage AS zm WITH (NOLOCK) ON zil.ErrorDescription = CONVERT(VARCHAR(50) , zm.MessageCode)
								INNER JOIN ZnodeImportProcessLog zipl WITH (NOLOCK) ON zil.ImportProcessLogId = zipl.ImportProcessLogId
								LEFT Outer JOIN ZnodeImportTemplate zit WITH (NOLOCK) ON zipl.ImportTemplateId = zit.ImportTemplateId
								LEFT Outer JOIN ZnodeImportHead zih WITH (NOLOCK) ON zit.ImportHeadId =zih.ImportHeadId 
								)
								,Cte_ErrorLogFilter As ( SELECT ImportLogId,ImportProcessLogId,[RowNumber],[ColumnName],[ColumnValue],[ErrorDescription],[ModifiedDate],GUID
												,'+dbo.Fn_GetPagingRowId(@Order_BY , 'RowNumber,ImportLogId')+',Count(*)Over() CountNo 
								 FROM Cte_ErrorLog
								 WHERE 1 = 1 '+dbo.Fn_GetFilterWhereClause(@WhereClause)+' 
							 )

							SELECT ImportLogId,ImportProcessLogId,RowNumber,ColumnName,ColumnValue,ErrorDescription,RowId, CountNo 
							FROM Cte_ErrorLogFilter '+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows)

			 INSERT INTO @TBL_ImportLog (ImportLogId,ImportProcessLogId,RowNumber,ColumnName,ColumnValue,ErrorDescription,RowId, CountNo)
			 EXEC (@SQL)
				 SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM @TBL_ImportLog), 0);
             SELECT ImportLogId,ImportProcessLogId,RowNumber,ColumnName,ColumnValue,ErrorDescription
			 FROM @TBL_ImportLog
			

		 END TRY
         BEGIN CATCH
             DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetImportProcessLog @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetImportProcessLog',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;                                    
         END CATCH;
     END;


Go

--UPDATE ZnodeImportAttributeValidation 
--SET ValidationValue=300, ValidationName = 'MaxCharacters',ControlName = 'Number'  
--WHERE AttributeCode ='ParentCode' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='CatalogCategoryAssociation' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

--GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetCategoryFeedList')
	DROP PROC Znode_GetCategoryFeedList
GO

  
CREATE PROCEDURE [dbo].[Znode_GetCategoryFeedList]
( @PortalId         NVARCHAR(MAX) = NULL,
  @LocaleId         INT,
  --will be used for CategoryId
  @CommaSeparatedId NVARCHAR(MAX) = NULL 
)
AS
/*
 Summary:This procedure is used to get effective keyword feeding of category list
 Unit Testing:
 EXEC Znode_GetCategoryFeedList 1 

*/

	BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
		DECLARE @DefaultLocaleId INT= dbo.Fn_GetDefaultValue('Locale');

		DECLARE @TBL_DomainName TABLE
		(PortalId   INT,
		DomainName NVARCHAR(300),
		RowId      INT
		);

		DECLARE @TBL_PortalIds TABLE(PortalId INT);
		DECLARE @TBL_SEODetails TABLE
		(loc                   NVARCHAR(MAX),
		lastmod               DATETIME,
		[g:condition]         VARCHAR(100),
		[description]         NVARCHAR(MAX),
		[g:id]                INT,
		link                  VARCHAR(100),
		[g:identifier_exists] VARCHAR(200),
		DomainName            NVARCHAR(300),
		PortalId              INT,
		SEOCode               NVARCHAR(4000),
		CanonicalURL        VARCHAR(200), 
		RobotTag            VARCHAR(50)
		);

		INSERT INTO @TBL_PortalIds(PortalId)
		SELECT Zp.PortalId
		FROM Znodeportal AS ZP
		INNER JOIN ZnodePortalCatalog AS ZPC ON(ZPC.PortalId = Zp.PortalId)
		INNER JOIN ZnodePublishCatalog AS ZPPC ON(ZPPC.PublishCatalogId = ZPC.PublishCatalogId)
		INNER JOIN ZnodePublishCategory AS ZPP ON(ZPP.PublishCatalogId = ZPPC.PublishCatalogId)
		WHERE EXISTS
			(
			SELECT TOP 1 1
			FROM DBO.Split(@PortalID, ',') AS Sp
			WHERE(CAST(sp.Item AS INT) = ZP.PortalId
			OR @PortalID = '0' )
			)
		GROUP BY Zp.PortalId;
	
		INSERT INTO @TBL_DomainName(PortalId,DomainName,RowId)
		SELECT TOP 1 ZD.PortalId,ZD.DomainName,    
		ROW_NUMBER() OVER(Partition BY ZD.DomainName,ZD.PortalId ORDER BY ZD.DomainName,ZD.PortalId) RowId                               
		FROM ZnodeDomain ZD
		WHERE EXISTS
			(
			SELECT TOP 1 1
			FROM @TBL_PortalIds TBP
			WHERE TBP.PortalId = ZD.PortalId
			)
		AND ApplicationType = 'Webstore'
		AND IsActive =1 
		AND IsDefault = 1;

		If Not Exists (Select TOP 1 1 from @TBL_DomainName)
        Begin
            INSERT INTO @TBL_DomainName(PortalId,DomainName,RowId)
            SELECT TOP 1 ZD.PortalId,ZD.DomainName,    
            ROW_NUMBER() OVER(Partition BY ZD.DomainName,ZD.PortalId ORDER BY ZD.DomainName,ZD.PortalId) RowId                               
            FROM ZnodeDomain ZD
            WHERE EXISTS
                (
                SELECT TOP 1 1
                FROM @TBL_PortalIds TBP
                WHERE TBP.PortalId = ZD.PortalId
                )
            AND ApplicationType = 'Webstore'
            AND IsActive =1 
            AND IsDefault = 0;
        End

		
		;WITH Cte_SeoDetailsWithLocale
		AS (
			SELECT DISTINCT ZCSD.CMSSEODetailId,ZCSD.SEOURL AS loc,ZCSD.ModifiedDate AS lastmod,'new' AS [g:condition],
			ZCSDL.SEODescription AS [description],ZPCC.PublishCategoryId AS [g:id],'' AS link,'false' AS [g:identifier_exists],TBDN.DomainName,ZPC.PortalId,ISNULL(ZCSDL.LocaleId, @DefaultLocaleId) AS LocaleId ,ZCSD.SEOCode, ZCSDL.CanonicalURL, ZCSDL.RobotTag
			FROM ZnodePublishCategory AS ZPCC 
			LEFT JOIN ZnodePublishCatalog AS ZPPC ON(ZPPC.PublishCatalogId = ZPCC.PublishCatalogId)
			LEFT JOIN ZnodePortalCatalog AS ZPC ON(ZPC.PublishCatalogId = ZPPC.PublishCatalogId)
			LEFT JOIN ZnodePublishcategorydetail PCD ON (PCD.PublishCategoryId = ZPCC.PublishCategoryId)
			LEFT JOIN @TBL_DomainName AS TBDN ON(TBDN.RowId = 1 AND TBDN.PortalId = ZPC.PortalId)
			LEFT JOIN ZnodeCMSSEODetail AS ZCSD ON(PCD.CategoryCode = ZCSD.SEOCode AND ZPC.PortalId = ZCSD.PortalId
			AND EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEOType AS ZCST
			WHERE ZCST.CMSSEOTypeId = ZCSD.CMSSEOTypeId  AND ZCST.Name = 'Category')) 
			LEFT  JOIN ZnodeCMSSEODetailLocale AS ZCSDL ON(ZCSDL.CMSSEODetailId = ZCSD.CMSSEODetailId
			AND ZCSDL.LocaleId IN(@LocaleId, @DefaultLocaleId))
			WHERE EXISTS
					(
					SELECT TOP 1 1
					FROM @TBL_PortalIds TBP
					WHERE ZPC.PortalId = TBP.PortalId
					)
			AND EXISTS (SELECT TOP 1 1 FROM  dbo.split(@CommaSeparatedId,',' ) SP WHERE SP.Item = PCD.CategoryCode)
		),

		Cte_SeoDetailsWithFirstLocale
		AS (SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName
		,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag
		FROM Cte_SeoDetailsWithLocale
		WHERE LocaleId = @LocaleId),

		Cte_SeoDetailsWithDefaultLocale
		AS (SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName
		,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag
		FROM Cte_SeoDetailsWithFirstLocale
		UNION ALL
		SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName
		,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag
		FROM Cte_SeoDetailsWithLocale AS CTSDWL
		WHERE LocaleId = @DefaultLocaleId
		AND NOT EXISTS
		(
		SELECT TOP 1 1
		FROM Cte_SeoDetailsWithFirstLocale AS CTSDWDL
		WHERE CTSDWDL.CMSSEODetailId = CTSDWL.CMSSEODetailId
		))

		INSERT INTO @TBL_SEODetails (loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName
		,PortalId,SEOCode, CanonicalURL, RobotTag)
		SELECT loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId,SEOCode, CanonicalURL, RobotTag
		FROM Cte_SeoDetailsWithDefaultLocale;
		

		SELECT DISTINCT loc,lastmod,DomainName,[g:id] AS id,PortalId,b.PublishCategoryName AS Name,SEOCode, CanonicalURL, RobotTag
		FROM @TBL_SEODetails a
		left JOIN ZnodePublishCategoryDetail b ON(b.PublishCategoryId = a.[g:id] AND b.LOcaleId = @LocaleId)
		WHERE DomainName IS NOT NULL
		
		END TRY
		BEGIN CATCH
		DECLARE @Status BIT ;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetCategoryFeedList @PortalId = '+@PortalId+',@LocaleId='+CAST(@LocaleId AS VARCHAR(10))+',@CommaSeparatedId='+@CommaSeparatedId+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		   
		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_GetCategoryFeedList',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetContentFeedList')
	DROP PROC Znode_GetContentFeedList
GO

CREATE PROCEDURE [dbo].[Znode_GetContentFeedList]
( @PortalId NVARCHAR(MAX) = NULL,
  @LocaleId INT)
AS
/*
	Summary : This procedure is used to get effective keyword feeding of content list
	Unit Testing:
	EXEC Znode_GetContentFeedList 4,1
	
*/
     BEGIN
         SET NOCOUNT ON;
		 BEGIN TRY
         DECLARE @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId();
         DECLARE @TBL_DomainName TABLE
         (PortalId   INT,
          DomainName NVARCHAR(300),
          RowId      INT
         );

         DECLARE @TBL_PortalIds TABLE(PortalId INT);
         DECLARE @TBL_SEODetails TABLE
         (loc                   NVARCHAR(MAX),
          lastmod               DATETIME,
          [g:condition]         VARCHAR(100),
          [description]         NVARCHAR(MAX),
          [g:id]                INT,
          link                  VARCHAR(100),
          [g:identifier_exists] VARCHAR(200),
          DomainName            NVARCHAR(300),
          PortalId              INT,
		  SEOCode               NVARCHAR(4000),
		  CanonicalURL          NVARCHAR(200),
		  RobotTag              NVARCHAR(50)
         );

		 if object_id('tempdb..#CMSSEOData') is not null
			drop table #CMSSEOData

		 CREATE TABLE #CMSSEOData 
		 (loc varchar(max),lastmod DateTime,DomainName varchar(200),[image] varchar(1000),Name varchar(500), CMSContentPagesId Int,PortalId Int, SEOCode NVARCHAR(4000)
		 , CanonicalURL NVARCHAR(200), RobotTag NVARCHAR(50))

         INSERT INTO @TBL_PortalIds
                SELECT Zp.PortalId
                FROM Znodeportal AS ZP
                INNER JOIN ZnodeCMSContentPages AS ZPC ON(ZPC.PortalId = Zp.PortalId)
                WHERE EXISTS
                (
                    SELECT TOP 1 1
                    FROM DBO.Split(@PortalID, ',') AS Sp
                    WHERE(CAST(sp.Item AS INT) = ZP.PortalId
                          OR @PortalID = '0' )
                )
                GROUP BY Zp.PortalId;

				
         INSERT INTO @TBL_DomainName
                SELECT TOP 1 ZD.PortalId,ZD.DomainName,                     
                       ROW_NUMBER() OVER(PArtition BY ZD.DomainName,
                                                  ZD.PortalId ORDER BY ZD.DomainName,
                                                  ZD.PortalId) RowId
                FROM ZnodeDomain ZD
                WHERE EXISTS
                (
                    SELECT TOP 1 1
                    FROM @TBL_PortalIds TBP
                    WHERE TBP.PortalId = ZD.PortalId
                )
			AND IsActive =1 
			AND applicationType = 'Webstore'
			AND ZD.IsDefault = 1


			if not exists(select top 1 1 from @TBL_DomainName) 
			INSERT INTO @TBL_DomainName
                SELECT TOP 1 ZD.PortalId,ZD.DomainName,                     
                       ROW_NUMBER() OVER(PArtition BY ZD.DomainName,
                                                  ZD.PortalId ORDER BY ZD.DomainName,
                                                  ZD.PortalId) RowId
                FROM ZnodeDomain ZD
                WHERE EXISTS
                (
                    SELECT TOP 1 1
                    FROM @TBL_PortalIds TBP
                    WHERE TBP.PortalId = ZD.PortalId
                )
			AND IsActive =1 
			AND applicationType = 'Webstore'
			AND ZD.IsDefault = 0

         ;WITH Cte_SeoDetailsWithLocale
              AS (SELECT DISTINCT ZCSD.CMSSEODetailId,  ZCSD.SEOURL AS loc,ZCSD.ModifiedDate AS lastmod,'new' AS [g:condition],ZCSDL.SEODescription AS [description],ZPCC.CMSContentPagesId AS [g:id],'' AS link,'false' AS [g:identifier_exists],TBDN.DomainName,ZPCC.PortalId,ISNULL(ZCSDL.LocaleId, @DefaultLocaleId) AS LocaleId,ZCSD.SEOCode
			      , ZCSDL.CanonicalURL, ZCSDL.RobotTag
                 FROM ZnodeCMSContentPages AS ZPCC 
                 LEFT JOIN ZnodeCMSSEODetail AS ZCSD ON(ZPCC.PageName = ZCSD.SEOCode AND EXISTS ( SELECT TOP 1 1 FROM ZnodeCMSSEOType AS ZCST WHERE ZCST.CMSSEOTypeId = ZCSD.CMSSEOTypeId
                                                   AND ZCST.Name = 'Content Page') AND ZCSD.PortalId = ZPCC.PortalId )
                 LEFT JOIN ZnodeCMSSEODetailLocale AS ZCSDL ON(ZCSDL.CMSSEODetailId = ZCSD.CMSSEODetailId
                                                            AND LocaleId IN(@LocaleId, @DefaultLocaleId))
                 LEFT JOIN @TBL_DomainName AS TBDN ON(TBDN.RowId = 1 AND TBDN.PortalId = ZPCC.PortalId )
                  WHERE  ZPCC.IsActive = 1 AND exists (select top 1 1 from ZnodePublishState ZPS where ZPS.StateName in ( 'Publish','Preview') and ZPCC.PublishStateId= ZPS.PublishStateId)
				  AND EXISTS
                  (
                      SELECT TOP 1 1
                      FROM @TBL_PortalIds TBP
                      WHERE ZPCC.PortalId = TBP.PortalId
                  )
				  AND EXISTS (SELECT TOP 1 1 FROM   @TBL_PortalIds TBPL
                      WHERE ZCSD.PortalId = TBPL.PortalId  
					  )
				  )
				   
				  --select  * from Cte_SeoDetailsWithLocale

             ,Cte_SeoDetailsWithFirstLocale
              AS (SELECT *
                  FROM Cte_SeoDetailsWithLocale
                  WHERE LocaleId = @LocaleId),

              Cte_SeoDetailsWithDefaultLocale
              AS (
              SELECT *
              FROM Cte_SeoDetailsWithFirstLocale
              UNION ALL
              SELECT *
              FROM Cte_SeoDetailsWithLocale AS CTSDWL
              WHERE LocaleId = @DefaultLocaleId
                    AND NOT EXISTS
              (
                  SELECT TOP 1 1
                  FROM Cte_SeoDetailsWithFirstLocale AS CTSDWDL
                  WHERE CTSDWDL.CMSSEODetailId = CTSDWL.CMSSEODetailId
              ))

              INSERT INTO @TBL_SEODetails
                     SELECT loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId,SEOCode,CanonicalURL,RobotTag
                     FROM Cte_SeoDetailsWithDefaultLocale;

         WITH Cte_ContentPages
              AS (SELECT ZCCP.CMSContentPagesId,ZCCPl.PageTitle,ZCCPL.LocaleId,ZCCP.PageName
                  FROM ZnodeCMSContentPages ZCCP
                  INNER JOIN ZnodeCMSContentPagesLocale ZCCPL ON(ZCCPL.CMSContentPagesId = ZCCP.CMSContentPagesId)
                  WHERE ZCCP.IsActive = 1 AND exists (select top 1 1 from ZnodePublishState ZPS where ZPS.PublishStateCode in ( 'Publish','Preview') and ZCCP.PublishStateId= ZPS.PublishStateId)				  
				  AND EXISTS
                  (
                      SELECT TOP 1 1
                      FROM @TBL_SEODetails TBSD
                      WHERE TBSD.[g:id] = ZCCP.CMSContentPagesId
                  )
                        AND LocaleID IN(@LocaleId, @DefaultLocaleId)),

              Cte_ContentPageFirstLocale
              AS (SELECT *
                  FROM Cte_ContentPages CTCP
                  WHERE LocaleId = @LocaleId),

              Cte_ContentPageSecondLocale
              AS (
              SELECT *
              FROM Cte_ContentPageFirstLocale CTPFL
              UNION ALL
              SELECT *
              FROM Cte_ContentPages CTCP
              WHERE LocaleId = @LocaleId
                    AND NOT EXISTS
              (
                  SELECT TOP 1 1
                  FROM Cte_ContentPageFirstLocale CTCPFL
                  WHERE CTCPFL.CMSContentPagesId = CTCP.CMSContentPagesId
              ))
			  INSERT INTO #CMSSEOData(loc,lastmod,DomainName,[image], Name, CMSContentPagesId,PortalId,SEOCode,CanonicalURL,RobotTag)
              SELECT loc,lastmod,DomainName,'' AS [image],PageName Name,[g:id] CMSContentPagesId,PortalId,SEOCode,CanonicalURL,RobotTag
              FROM @TBL_SEODetails TBSD
              LEFT JOIN Cte_ContentPageSecondLocale CTCPSL ON(TBSD.[g:id] = CTCPSL.CMSContentPagesId);

			  ---- CMS SEO Blog News Details
			  INSERT INTO #CMSSEOData(loc,lastmod,DomainName,[image], Name, CMSContentPagesId,PortalId,SEOCode,CanonicalURL,RobotTag)
			  EXEC [Znode_GetBlogFeedList] @PortalId, @LocaleId

			  SELECT loc, REPLACE(CONVERT(VARCHAR(30),lastmod,102),'.','-') AS lastmod,DomainName,[image], Name, CMSContentPagesId,PortalId,CanonicalURL,RobotTag FROM #CMSSEOData

		END TRY
		BEGIN CATCH
		  DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetContentFeedList @PortalId = '+@PortalId+',@LocaleId='+CAST(@LocaleId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetContentFeedList',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
		END CATCH
     END;


GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetProductFeedList')
	DROP PROC Znode_GetProductFeedList
GO

CREATE PROCEDURE [dbo].[Znode_GetProductFeedList]  
		(
		@PortalId   VARCHAR(2000) = NULL,  
		@SKU  SelectColumnList READONLY,  
		@LocaleId   INT,  
		@FeedType   NVARCHAR(MAX) = NULL   
		)
		AS  
/*  
Summary: This Procedure is used to get effective keyword feeding of Product list  
 SELECT * FROM ZnodePublishProductDetail  
 SELECT * FROM ZnodePublishProduct WHERE PublishCatalogId = 3  
 SELECT * FROM ZnodePortalCatalog   
 Unit Testing:  
 EXEC [Znode_GetProductFeedList] @PortalId='0',@ProductIds = '116,117,118'  
 ,@LocaleId=1,@FeedType='Bing'   
  
		*/  
		BEGIN  
		BEGIN TRY  
		SET NOCOUNT ON;        
           
		IF OBJECT_ID('tempdb..#TBL_DomainName') IS NOT NULL
		DROP TABLE #TBL_DomainName

		IF OBJECT_ID('tempdb..#TBL_SEODetails') IS NOT NULL
		DROP TABLE #TBL_SEODetails

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_PortalIds') IS NOT NULL
		DROP TABLE #TBL_PortalIds

		DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
		CREATE TABLE #TBL_DomainName 
		(PortalId   INT,
		DomainName NVARCHAR(300),
		RowId      INT
		);  	
         
		CREATE TABLE #TBL_SEODetails   
		(loc                   NVARCHAR(MAX),  
		lastmod               DATETIME,  
		[g:condition]         VARCHAR(100),  
		[description]         NVARCHAR(MAX),  
		[g:id]                INT,  
		link                  VARCHAR(100),  
		[g:identifier_exists] VARCHAR(200),  
		DomainName            NVARCHAR(300),  
		PortalId              INT , 
		SEOCode             NVARCHAR(4000), 
		CanonicalURL        VARCHAR(200), 
		RobotTag            VARCHAR(50)
		);  
		--CREATE TABLE #TBL_CompleteDetailes   
		--(loc                   NVARCHAR(MAX),  
		--lastmod               DATETIME,  
		--[g:condition]         VARCHAR(100),  
		--[description]         NVARCHAR(MAX),  
		--[g:id]                INT,  
		--link                  VARCHAR(100),  
		--[g:identifier_exists] VARCHAR(200),  
		--DomainName            NVARCHAR(300),  
		--PortalId              INT,  
		--[g:availability]      NVARCHAR(1000),  
		--SKU                   NVARCHAR(1000),  
		--SEOCode               NVARCHAR(4000),
		--CanonicalURL        VARCHAR(200), 
		--RobotTag            VARCHAR(50) 
		--);  
		DECLARE @DefaultLocaleId INT=dbo.Fn_GetDefaultLocaleId()  ;
		CREATE TABLE #TBL_PortalIds (PortalId INT);  
			
		select * into #SKU from @SKU
		create index IDX_#SKU on #SKU(StringColumn)
		
		INSERT INTO #TBL_PortalIds  
		SELECT Zp.PortalId   
		FROM Znodeportal AS ZP   
		INNER JOIN ZnodePortalCatalog AS ZPC ON(ZPC.PortalId = Zp.PortalId)  
		INNER JOIN ZnodePublishCatalog AS ZPPC ON(ZPPC.PublishCatalogId = ZPC.PublishCatalogId)   
		INNER JOIN ZNodePublishProduct AS ZPP ON(ZPP.PublishCatalogId = ZPPC.PublishCatalogId)  
		INNER JOIN ZnodePublishProductDetail AS PPD ON (PPD.PublishProductId = ZPP.PublishProductId)  
		WHERE EXISTS(SELECT TOP 1 1 FROM #SKU AS Sp WHERE sp.StringColumn  = PPD.SKU OR StringColumn = '0')  
		AND EXISTS(SELECT TOP 1 1 FROM DBO.Split(@PortalId, ',') AS Sp  
		WHERE(CAST(sp.Item AS INT)) = Zp.PortalId  OR @PortalId = '0')  
		AND EXISTS (SELECT TOP 1 1 FROM ZnodeDomain ZD WHERE ZP.PortalId = ZD.PortalId  
		AND IsActive = 1 AND ApplicationType = 'Webstore' )  
		GROUP BY Zp.PortalId;   
		
		INSERT INTO #TBL_DomainName   
		SELECT  TOP 1  PortalId,DomainName,ROW_NUMBER() OVER(PARTITION BY PortalId ORDER BY DomainName)   
		FROM ZnodeDomain AS ZD   
		WHERE EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZD.PortalId)  
		AND IsActive = 1 AND ApplicationType = 'Webstore' AND IsDefault = 1 

		if not exists (select top 1 1 from #TBL_DomainName)
		INSERT INTO #TBL_DomainName   
		SELECT  TOP 1 PortalId,DomainName,ROW_NUMBER() OVER(PARTITION BY PortalId ORDER BY DomainName)   
		FROM ZnodeDomain AS ZD   
		WHERE EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZD.PortalId)  
		AND IsActive = 1 AND ApplicationType = 'Webstore' AND IsDefault = 0 
 
		IF EXISTS(SELECT * FROM #SKU)
        BEGIN
		    --INSERT INTO #Cte_SeoDetailsWithLocale(CMSSEODetailId ,loc ,lastmod ,[g:condition] ,[description] ,[g:id] ,link ,[g:identifier_exists] ,DomainName ,PortalId,LocaleId ,SEOCode ,CanonicalURL ,RobotTag)
			SELECT DISTINCT ZCSD.CMSSEODetailId,ZCSD.SEOURL AS loc,ZCSD.ModifiedDate AS lastmod,'new' AS [g:condition],ZCSDL.SEODescription AS [description],ZPCC.PublishProductId AS [g:id],  
            '' AS link,'false' AS [g:identifier_exists],TBDN.DomainName,ZPC.PortalId,ISNULL(ZCSDL.LocaleId, @DefaultLocaleId) AS LocaleId , ZCSD.SEOCode , ZCSDL.CanonicalURL, ZCSDL.RobotTag 
			INTO #Cte_SeoDetailsWithLocale
			FROM ZNodePublishProduct AS ZPCC   
			INNER JOIN ZnodePortalCatalog AS ZPC ON(ZPC.PublishCatalogId = ZPCC.PublishCatalogId)  
			LEFT JOIN ZnodePublishProductDetail AS PPD ON (PPD.PublishProductId = ZPCC.PublishProductId)  
			--INNER JOIN @TBL_PortalIds TBLP ON (TBLP.PortalId = ZPC.PortalId)  
			LEFT JOIN ZnodeCMSSEODetail AS ZCSD ON(PPD.SKU = ZCSD.SEOCode and ZCSD.PortalId = ZPC.PortalId)  
			LEFT JOIN ZnodeCMSSEOType AS ZCST ON(ZCST.CMSSEOTypeId = ZCSD.CMSSEOTypeId AND ZCST.Name = 'Product')  
			LEFT JOIN ZnodeCMSSEODetailLocale AS ZCSDL ON(ZCSDL.CMSSEODetailId = ZCSD.CMSSEODetailId AND ZCSDL.LocaleId IN(@LocaleId, @DefaultLocaleId))  
			LEFT JOIN #TBL_DomainName AS TBDN ON(TBDN.RowId = 1 AND TBDN.PortalId = zpc.PortalId )   
			WHERE EXISTS(SELECT TOP 1 1 FROM #SKU AS Sp  
			WHERE (sp.StringColumn  = PPD.SKU) )--OR StringColumn = '0')  
			AND EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZPC.PortalId)  
				
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag  
			INTO #Cte_SeoDetailsWithFirstLocale
			FROM #Cte_SeoDetailsWithLocale   
			WHERE LocaleId = @LocaleId  
    
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode , CanonicalURL, RobotTag 
			INTO #Cte_SeoDetailsWithDefaultLocale
			FROM #Cte_SeoDetailsWithFirstLocale  
			
			INSERT INTO #Cte_SeoDetailsWithDefaultLocale 
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag  
			FROM #Cte_SeoDetailsWithLocale AS CTSDWL  
			WHERE LocaleId = @DefaultLocaleId   
			AND NOT EXISTS(SELECT TOP 1 1 FROM #Cte_SeoDetailsWithFirstLocale AS CTSDWDL WHERE CTSDWDL.CMSSEODetailId = CTSDWL.CMSSEODetailId)  
          
			INSERT INTO #TBL_SEODetails  
			SELECT DISTINCT loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId ,SEOCode, CanonicalURL, RobotTag  
			FROM #Cte_SeoDetailsWithDefaultLocale;  

			--CREATE INDEX Idx_#TBL_SEODetails ON #TBL_SEODetails([g:id])

			SELECT TBSD.loc,TBSD.lastmod,TBSD.[g:condition],TBSD.[description],TBSD.[g:id],TBSD.link,TBSD.[g:identifier_exists],TBSD.DomainName,TBSD.PortalId,  
			CASE WHEN SUM(ZI.Quantity) > 0 THEN 'In Stock' ELSE CASE WHEN @FeedType = 'Google' THEN 'Out Of Stock' ELSE 'Not In Stock' END  
			END AS [g:availability],
			ZPPD.SKU ,TBSD.SEOCode, TBSD.CanonicalURL, TBSD.RobotTag
			INTO #TBL_CompleteDetailes  
			FROM ZnodePublishProduct AS ZPP   
			LEFT JOIN #TBL_SEODetails AS TBSD ON(ZPP.PublishProductId = TBSD.[g:id] )  
			LEFT JOIN ZnodePublishProductDetail AS ZPPD ON(ZPPD.PublishProductId = ZPP.PublishProductId AND ZPPD.LocaleId = @LocaleId)  
			LEFT JOIN ZnodePortalWarehouse AS ZPW ON(ZPW.PortalId = TBSD.PortalId)  
			LEFT JOIN ZnodePortalAlternateWarehouse AS ZAPW ON(ZAPW.PortalWarehouseId = ZPW.PortalWarehouseId)  
			LEFT JOIN ZnodeInventory AS ZI ON(ZI.SKU = ZPPD.SKU AND (ZI.WarehouseId = ZPW.WarehouseId OR ZI.WarehouseId = ZAPW.WarehouseId))  
			WHERE EXISTS(SELECT TOP 1 1 FROM #SKU AS Sp WHERE (sp.StringColumn  = ZPPD.SKU))-- OR sp.StringColumn = '0')
			AND EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = TBSD.PortalId)	
			GROUP BY loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,TBSD.PortalId,ZPPD.SKU,ZPPD.LocaleId, TBSD.SEOCode, TBSD.CanonicalURL, TBSD.RobotTag;    
			
			DECLARE @MediaConfiguration NVARCHAR(2000)=((SELECT TOP 1 ISNULL(CASE WHEN CDNURL = '' THEN NULL ELSE CDNURL END,URL) FROM ZnodeMediaConfiguration WHERE IsActive = 1));    
  
			CREATE INDEX Idx_#TBL_CompleteDetailes ON #TBL_CompleteDetailes(PortalId,SKU)
	
	
			SELECT zp.PortalId,round(ZPS.RetailPrice,2) as RetailPrice,Zps.SKU,tbcd.SEOCode,ROW_NUMBER() OVER(PARTITION BY Zps.SKU,zp.PortalId ORDER BY ZPS.RetailPrice) AS RowId  
			INTO #Cte_PortalList
			FROM ZnodePriceList AS ZPL   
			LEFT JOIN ZnodePriceListPortal AS ZPLP ON ZPL.PriceListId = ZPLP.PriceListId  
			LEFT JOIN ZnodeCulture AS zc ON ZPL.CultureId = zc.CultureId
			LEFT JOIN ZnodePortal AS zp ON ZPLP.PortalId = zp.PortalId  
			LEFT JOIN ZnodePrice AS Zps ON(Zps.PriceListId = ZPL.PriceListId)   
			LEFT JOIN #TBL_CompleteDetailes AS TBCD ON(TBCD.PortalId = Zp.PortalId AND TBCD.SKU = Zps.Sku)   
			WHERE CAST(@GetDate AS DATE) BETWEEN ZPL.ActivationDate AND ZPL.ExpirationDate   
			AND EXISTS( SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZPLP.PortalId)   
			GROUP BY zp.PortalId,ZPS.RetailPrice,Zps.SKU ,TBCD.SEOCode  
 
			SELECT loc,lastmod,[g:condition],[description],[g:id],link,[g:availability],[g:identifier_exists],DomainName,TBCD.PortalId  
			,CTPL.RetailPrice AS [g:price],@MediaConfiguration AS MediaConfiguration, TBCD.SEOCode, TBCD.CanonicalURL, TBCD.RobotTag 
			FROM #TBL_CompleteDetailes AS TBCD   
			LEFT JOIN #Cte_PortalList AS CTPL ON(CTPL.PortalId = TBCD.PortalId AND CTPL.SKU = TBCD.SKU AND CTPL.RowID = 1)  
			WHERE  EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = TBCD.PortalId )  


		END
     	ELSE
		BEGIN
		    --INSERT INTO #Cte_SeoDetailsWithLocale(CMSSEODetailId ,loc ,lastmod ,[g:condition] ,[description] ,[g:id] ,link ,[g:identifier_exists] ,DomainName ,PortalId,LocaleId ,SEOCode ,CanonicalURL ,RobotTag)
			SELECT DISTINCT ZCSD.CMSSEODetailId,ZCSD.SEOURL AS loc,ZCSD.ModifiedDate AS lastmod,'new' AS [g:condition],ZCSDL.SEODescription AS [description],ZPCC.PublishProductId AS [g:id],  
			'' AS link,'false' AS [g:identifier_exists],TBDN.DomainName,ZPC.PortalId,ISNULL(ZCSDL.LocaleId, @DefaultLocaleId) AS LocaleId , ZCSD.SEOCode , ZCSDL.CanonicalURL, ZCSDL.RobotTag 
			INTO #Cte_SeoDetailsWithLocale1
			FROM ZNodePublishProduct AS ZPCC   
			INNER JOIN ZnodePortalCatalog AS ZPC ON(ZPC.PublishCatalogId = ZPCC.PublishCatalogId)  
			LEFT JOIN ZnodePublishProductDetail AS PPD ON (PPD.PublishProductId = ZPCC.PublishProductId)  
			-- INNER JOIN @TBL_PortalIds TBLP ON (TBLP.PortalId = ZPC.PortalId)  
			LEFT JOIN ZnodeCMSSEODetail AS ZCSD ON(PPD.SKU = ZCSD.SEOCode and ZCSD.PortalId = ZPC.PortalId)  
			LEFT JOIN ZnodeCMSSEOType AS ZCST ON(ZCST.CMSSEOTypeId = ZCSD.CMSSEOTypeId AND ZCST.Name = 'Product')  
			LEFT JOIN ZnodeCMSSEODetailLocale AS ZCSDL ON(ZCSDL.CMSSEODetailId = ZCSD.CMSSEODetailId AND ZCSDL.LocaleId IN(@LocaleId, @DefaultLocaleId))  
			LEFT JOIN #TBL_DomainName AS TBDN ON(TBDN.RowId = 1 AND TBDN.PortalId = zpc.PortalId )   
			WHERE EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZPC.PortalId)
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag  
			INTO #Cte_SeoDetailsWithFirstLocale1
			FROM #Cte_SeoDetailsWithLocale1   
			WHERE LocaleId = @LocaleId  
    
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode , CanonicalURL, RobotTag 
			INTO #Cte_SeoDetailsWithDefaultLocale1
			FROM #Cte_SeoDetailsWithFirstLocale1  
			
			INSERT INTO #Cte_SeoDetailsWithDefaultLocale1 
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag  
			FROM #Cte_SeoDetailsWithLocale1 AS CTSDWL  
			WHERE LocaleId = @DefaultLocaleId   
			AND NOT EXISTS(SELECT TOP 1 1 FROM #Cte_SeoDetailsWithFirstLocale AS CTSDWDL WHERE CTSDWDL.CMSSEODetailId = CTSDWL.CMSSEODetailId)  
          
			INSERT INTO #TBL_SEODetails  
			SELECT DISTINCT loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId ,SEOCode, CanonicalURL, RobotTag  
			FROM #Cte_SeoDetailsWithDefaultLocale1;  
		  
			SELECT TBSD.loc,TBSD.lastmod,TBSD.[g:condition],TBSD.[description],TBSD.[g:id],TBSD.link,TBSD.[g:identifier_exists],TBSD.DomainName,TBSD.PortalId,  
			CASE WHEN SUM(ZI.Quantity) > 0 THEN 'In Stock' ELSE CASE WHEN @FeedType = 'Google' THEN 'Out Of Stock' ELSE 'Not In Stock' END  
			END AS [g:availability],
			ZPPD.SKU ,TBSD.SEOCode, TBSD.CanonicalURL, TBSD.RobotTag  
			INTO #TBL_CompleteDetailes1
			FROM ZnodePublishProduct AS ZPP   
			LEFT JOIN #TBL_SEODetails AS TBSD ON(ZPP.PublishProductId = TBSD.[g:id] )  
			LEFT JOIN ZnodePublishProductDetail AS ZPPD ON(ZPPD.PublishProductId = ZPP.PublishProductId AND ZPPD.LocaleId = @LocaleId )  
			LEFT JOIN ZnodePortalWarehouse AS ZPW ON(ZPW.PortalId = TBSD.PortalId)  
			LEFT JOIN ZnodePortalAlternateWarehouse AS ZAPW ON(ZAPW.PortalWarehouseId = ZPW.PortalWarehouseId)  
			LEFT JOIN ZnodeInventory AS ZI ON(ZI.SKU = ZPPD.SKU AND (ZI.WarehouseId = ZPW.WarehouseId OR ZI.WarehouseId = ZAPW.WarehouseId))  
			WHERE EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = TBSD.PortalId )	
			GROUP BY loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,TBSD.PortalId,ZPPD.SKU,ZPPD.LocaleId, TBSD.SEOCode, TBSD.CanonicalURL, TBSD.RobotTag;    
			

			DECLARE @MediaConfiguration1 NVARCHAR(2000)=((SELECT TOP 1 ISNULL(CASE WHEN CDNURL = '' THEN NULL ELSE CDNURL END,URL) FROM ZnodeMediaConfiguration WHERE IsActive = 1));    
  
			CREATE INDEX Idx_#TBL_CompleteDetailes1 ON #TBL_CompleteDetailes(PortalId,SKU)
	
	
			SELECT zp.PortalId,round(ZPS.RetailPrice,2) as RetailPrice,Zps.SKU,tbcd.SEOCode,ROW_NUMBER() OVER(PARTITION BY Zps.SKU,zp.PortalId ORDER BY ZPS.RetailPrice) AS RowId  
			INTO #Cte_PortalList1
			FROM ZnodePriceList AS ZPL   
			LEFT JOIN ZnodePriceListPortal AS ZPLP ON ZPL.PriceListId = ZPLP.PriceListId  
			LEFT JOIN ZnodeCulture AS zc ON ZPL.CultureId = zc.CultureId
			LEFT JOIN ZnodePortal AS zp ON ZPLP.PortalId = zp.PortalId  
			LEFT JOIN ZnodePrice AS Zps ON(Zps.PriceListId = ZPL.PriceListId)   
			LEFT JOIN #TBL_CompleteDetailes AS TBCD ON(TBCD.PortalId = Zp.PortalId AND TBCD.SKU = Zps.Sku)   
			WHERE CAST(@GetDate AS DATE) BETWEEN ZPL.ActivationDate AND ZPL.ExpirationDate   
			AND EXISTS( SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZPLP.PortalId)   
			GROUP BY zp.PortalId,ZPS.RetailPrice,Zps.SKU ,TBCD.SEOCode  
 
			SELECT loc,lastmod,[g:condition],[description],[g:id],link,[g:availability],[g:identifier_exists],DomainName,TBCD.PortalId  
			,CTPL.RetailPrice AS [g:price],@MediaConfiguration AS MediaConfiguration, TBCD.SEOCode, TBCD.CanonicalURL, TBCD.RobotTag 
			FROM #TBL_CompleteDetailes1 AS TBCD   
			LEFT JOIN #Cte_PortalList1 AS CTPL ON(CTPL.PortalId = TBCD.PortalId AND CTPL.SKU = TBCD.SKU AND CTPL.RowID = 1)  
			WHERE  EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = TBCD.PortalId )  

		END
 
		IF OBJECT_ID('tempdb..#TBL_DomainName') IS NOT NULL
		DROP TABLE #TBL_DomainName

		IF OBJECT_ID('tempdb..#TBL_SEODetails') IS NOT NULL
		DROP TABLE #TBL_SEODetails

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_PortalIds') IS NOT NULL
		DROP TABLE #TBL_PortalIds
		
		END TRY  
		BEGIN CATCH  
			DECLARE @Status BIT ;  
			SET @Status = 0;  
			DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetProductFeedList @PortalId = '+@PortalId+',@LocaleId='+CAST(@LocaleId AS VARCHAR(50))+',@FeedType='+CAST(@FeedType AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));  
                 
			SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
     
			EXEC Znode_InsertProcedureErrorLog  
			@ProcedureName = 'Znode_GetProductFeedList',  
			@ErrorInProcedure = @Error_procedure,  
			@ErrorMessage = @ErrorMessage,  
			@ErrorLine = @ErrorLine,  
			@ErrorCall = @ErrorCall;  
		END CATCH  
		END
		;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetBlogFeedList')
	DROP PROC Znode_GetBlogFeedList
GO

   
CREATE PROCEDURE [dbo].[Znode_GetBlogFeedList]
( 
	@PortalId NVARCHAR(MAX) = NULL,
	@LocaleId INT
)
AS
/*
	Summary : This procedure is used to get effective keyword feeding of content list
	Unit Testing:
	EXEC [Znode_GetBlogFeedList] 2,1
	R
*/
     BEGIN
         SET NOCOUNT ON;
		 BEGIN TRY
         DECLARE @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId();
         DECLARE @TBL_DomainName TABLE
         (PortalId   INT,
          DomainName NVARCHAR(300),
          RowId      INT
         );

         DECLARE @TBL_PortalIds TABLE(PortalId INT);
         DECLARE @TBL_SEODetails TABLE
         (loc                   NVARCHAR(MAX),
          lastmod               DATETIME,
          [g:condition]         VARCHAR(100),
          [description]         NVARCHAR(MAX),
          [g:id]                INT,
          link                  VARCHAR(100),
          [g:identifier_exists] VARCHAR(200),
          DomainName            NVARCHAR(300),
          PortalId              INT,
		  SEOCode               NVARCHAR(4000),
		  CanonicalURL          NVARCHAR(200),
		  RobotTag              NVARCHAR(50)
         );

         INSERT INTO @TBL_PortalIds
                SELECT Zp.PortalId
                FROM Znodeportal AS ZP
                INNER JOIN ZnodeBlogNews AS ZBN ON(ZBN.PortalId = Zp.PortalId)
                WHERE EXISTS
                (
                    SELECT TOP 1 1
                    FROM DBO.Split(@PortalID, ',') AS Sp
                    WHERE(CAST(sp.Item AS INT) = ZP.PortalId
                          OR @PortalID = '0' )
                )
                GROUP BY Zp.PortalId;

   INSERT INTO @TBL_DomainName
                SELECT TOP 1 ZD.PortalId,ZD.DomainName,                     
                       ROW_NUMBER() OVER(PArtition BY ZD.DomainName,
                                                  ZD.PortalId ORDER BY ZD.DomainName,
                                                  ZD.PortalId) RowId
                FROM ZnodeDomain ZD
                WHERE EXISTS
                (
                    SELECT TOP 1 1
                    FROM @TBL_PortalIds TBP
                    WHERE TBP.PortalId = ZD.PortalId
                )
			AND IsActive =1 
			AND applicationType = 'Webstore'
			AND ZD.IsDefault = 1


			if not exists(select top 1 1 from @TBL_DomainName) 
			INSERT INTO @TBL_DomainName
                SELECT TOP 1 ZD.PortalId,ZD.DomainName,                     
                       ROW_NUMBER() OVER(PArtition BY ZD.DomainName,
                                                  ZD.PortalId ORDER BY ZD.DomainName,
                                                  ZD.PortalId) RowId
                FROM ZnodeDomain ZD
                WHERE EXISTS
                (
                    SELECT TOP 1 1
                    FROM @TBL_PortalIds TBP
                    WHERE TBP.PortalId = ZD.PortalId
                )
			AND IsActive =1 
			AND applicationType = 'Webstore'
			AND ZD.IsDefault = 0


		 ---------- CMS Content Page Details
         ;WITH Cte_SeoDetailsWithLocale AS 
		 (
				SELECT DISTINCT ZCSD.CMSSEODetailId,ZCSD.SEOURL AS loc,ZCSD.ModifiedDate AS lastmod,'new' AS [g:condition],ZCSDL.SEODescription AS [description],ZBN.BlogNewsId AS [g:id],'' AS link,'false' AS [g:identifier_exists],TBDN.DomainName,ZBN.PortalId,ISNULL(ZCSDL.LocaleId, @DefaultLocaleId) AS LocaleId, ZCSD.SEOCode
				,ZCSDL.CanonicalURL, ZCSDL.RobotTag
                FROM ZnodeBlogNews AS ZBN 
                LEFT JOIN ZnodeCMSSEODetail AS ZCSD ON(cast(ZBN.BlogNewsId as varchar(100)) = ZCSD.SEOCode AND EXISTS ( SELECT TOP 1 1 FROM ZnodeCMSSEOType AS ZCST WHERE ZCST.CMSSEOTypeId = ZCSD.CMSSEOTypeId
                                                AND ZCST.Name = 'BlogNews'))
                LEFT JOIN ZnodeCMSSEODetailLocale AS ZCSDL ON(ZCSDL.CMSSEODetailId = ZCSD.CMSSEODetailId
                                                        AND LocaleId IN(@LocaleId, @DefaultLocaleId))
                LEFT JOIN @TBL_DomainName AS TBDN ON(TBDN.RowId = 1 AND TBDN.PortalId = ZBN.PortalId )
                WHERE EXISTS
                (
                    SELECT TOP 1 1
                    FROM @TBL_PortalIds TBP
                    WHERE ZBN.PortalId = TBP.PortalId
                )
				AND ZBN.IsBlogNewsActive =1 
			),
			Cte_SeoDetailsWithFirstLocale AS 
			(
				SELECT * FROM Cte_SeoDetailsWithLocale WHERE LocaleId = @LocaleId
			),
			Cte_SeoDetailsWithDefaultLocale AS 
			(
				  SELECT * FROM Cte_SeoDetailsWithFirstLocale
				  UNION ALL
				  SELECT * FROM Cte_SeoDetailsWithLocale AS CTSDWL
				  WHERE LocaleId = @DefaultLocaleId
				  AND NOT EXISTS
				  (
					  SELECT TOP 1 1
					  FROM Cte_SeoDetailsWithFirstLocale AS CTSDWDL
					  WHERE CTSDWDL.CMSSEODetailId = CTSDWL.CMSSEODetailId
				  )
			)
			INSERT INTO @TBL_SEODetails
            SELECT loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId, SEOCode,CanonicalURL,RobotTag
            FROM Cte_SeoDetailsWithDefaultLocale

         ;WITH Cte_BlogNews AS 
		 (
			SELECT ZBN.BlogNewsId,ZBNL.BlogNewsTitle,ZBNL.LocaleId,ZBNL.BlogNewsTitle Name
            FROM ZnodeBlogNews ZBN
            INNER JOIN ZnodeBlogNewsLocale ZBNL ON(ZBN.BlogNewsId = ZBNL.BlogNewsId)
            WHERE EXISTS
            (
                SELECT TOP 1 1
                FROM @TBL_SEODetails TBSD
                WHERE TBSD.[g:id] = ZBN.BlogNewsId
            )
            AND LocaleID IN(@LocaleId, @DefaultLocaleId)
		),
		Cte_BlogNewsFirstLocale AS 
		(
			SELECT *
            FROM Cte_BlogNews CTCP
            WHERE LocaleId = @LocaleId
		),
		Cte_BlogNewsSecondLocale AS 
		(
              SELECT *
              FROM Cte_BlogNewsFirstLocale CTPFL
              UNION ALL
              SELECT *
              FROM Cte_BlogNews CTCP
              WHERE LocaleId = @LocaleId
                    AND NOT EXISTS
              (
                  SELECT TOP 1 1
                  FROM Cte_BlogNewsFirstLocale CTCPFL
                  WHERE CTCPFL.BlogNewsId = CTCP.BlogNewsId
              )
		)
        SELECT loc,lastmod,DomainName,'' AS [image], Name,[g:id] BlogNewsId,PortalId,SEOCode, CanonicalURL, RobotTag
        FROM @TBL_SEODetails TBSD
        LEFT JOIN Cte_BlogNewsSecondLocale CTCPSL ON(TBSD.[g:id] = CTCPSL.BlogNewsId);

		END TRY
		BEGIN CATCH
		  DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetBlogFeedList @PortalId = '+@PortalId+',@LocaleId='+CAST(@LocaleId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetBlogFeedList',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
		END CATCH

     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetXmlProductFeedList')
	DROP PROC Znode_GetXmlProductFeedList
GO

CREATE PROCEDURE [dbo].[Znode_GetXmlProductFeedList]  
(
	@PortalId   VARCHAR(2000) = NULL,   
	@LocaleId   INT,  
	@FeedType   NVARCHAR(MAX) = NULL   
)
AS  
/*  
Summary: This Procedure is used to get effective keyword feeding of Product list  
 SELECT * FROM ZnodePublishProductDetail  
 SELECT * FROM ZnodePublishProduct WHERE PublishCatalogId = 3  
 SELECT * FROM ZnodePortalCatalog   
 Unit Testing:  
 EXEC [Znode_GetXmlProductFeedList] @PortalId='0',@ProductIds = '116,117,118'  
 ,@LocaleId=1,@FeedType='Bing'   
  
*/  
BEGIN  
BEGIN TRY  
SET NOCOUNT ON;        
           
		IF OBJECT_ID('tempdb..#TBL_DomainName') IS NOT NULL
		DROP TABLE #TBL_DomainName

		IF OBJECT_ID('tempdb..#TBL_SEODetails') IS NOT NULL
		DROP TABLE #TBL_SEODetails

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_PortalIds') IS NOT NULL
		DROP TABLE #TBL_PortalIds

		IF OBJECT_ID('tempdb..#TBL_PricePrecedence') IS NOT NULL
		DROP TABLE #TBL_PricePrecedence

		DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
		CREATE TABLE #TBL_DomainName 
		(PortalId   INT,
		DomainName NVARCHAR(300),
		RowId      INT
		);  	
         
		CREATE TABLE #TBL_SEODetails   
		(loc                   NVARCHAR(MAX),  
		lastmod               DATETIME,  
		[g:condition]         VARCHAR(1000),  
		[description]         NVARCHAR(MAX), 
		[SEOTitle]			  NVARCHAR(MAX),	
		[g:id]                INT,  
		link                  VARCHAR(1000),  
		[g:identifier_exists] VARCHAR(2000),  
		DomainName            NVARCHAR(3000),  
		PortalId              INT , 
		SEOCode             NVARCHAR(4000), 
		CanonicalURL        VARCHAR(2000), 
		RobotTag            VARCHAR(500)
		);  
		
		DECLARE @DefaultLocaleId INT=dbo.Fn_GetDefaultLocaleId()  ;
		CREATE TABLE #TBL_PortalIds (PortalId INT);  
		
		INSERT INTO #TBL_PortalIds  

		SELECT Zp.PortalId   
		FROM Znodeportal AS ZP   
		INNER JOIN ZnodePortalCatalog AS ZPC ON(ZPC.PortalId = Zp.PortalId)  
		INNER JOIN ZnodePublishCatalog AS ZPPC ON(ZPPC.PublishCatalogId = ZPC.PublishCatalogId)   
		INNER JOIN ZNodePublishProduct AS ZPP ON(ZPP.PublishCatalogId = ZPPC.PublishCatalogId)  
		INNER JOIN ZnodePublishProductDetail AS PPD ON (PPD.PublishProductId = ZPP.PublishProductId)  
		INNER JOIN ZnodePublishProductEntity AS ZPPE ON (PPD.SKU  = ZPPE.SKU)
		WHERE
		
		EXISTS(SELECT TOP 1 1 FROM DBO.Split(@PortalId, ',') AS Sp  
		WHERE(CAST(sp.Item AS INT)) = Zp.PortalId  OR @PortalId = '0')  
		AND EXISTS (SELECT TOP 1 1 FROM ZnodeDomain ZD WHERE ZP.PortalId = ZD.PortalId  
		AND IsActive = 1 AND ApplicationType = 'Webstore' AND IsDefault = 1 )  
		GROUP BY Zp.PortalId;   
		
		INSERT INTO #TBL_DomainName   
		SELECT  PortalId,DomainName,ROW_NUMBER() OVER(PARTITION BY PortalId ORDER BY DomainName)   
		FROM ZnodeDomain AS ZD   
		WHERE EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZD.PortalId)  
		AND IsActive = 1 AND ApplicationType = 'Webstore' AND IsDefault = 1 
 
			SELECT DISTINCT ZCSD.CMSSEODetailId,ZCSD.SEOURL AS loc,ZCSD.ModifiedDate AS lastmod,'new' AS [g:condition],ZCSDL.SEODescription AS [description],ZCSDL.SEOTitle AS [SEOTitle], ZPCC.PublishProductId AS [g:id],  
            ZCSD.SEOUrl AS link,'false' AS [g:identifier_exists],TBDN.DomainName,ZPC.PortalId,ISNULL(ZCSDL.LocaleId, @DefaultLocaleId) AS LocaleId , ZCSD.SEOCode , ZCSDL.CanonicalURL, ZCSDL.RobotTag 
			INTO #Cte_SeoDetailsWithLocale
			FROM ZNodePublishProduct AS ZPCC   
			INNER JOIN ZnodePortalCatalog AS ZPC ON(ZPC.PublishCatalogId = ZPCC.PublishCatalogId)  
			LEFT JOIN ZnodePublishProductDetail AS PPD ON (PPD.PublishProductId = ZPCC.PublishProductId)  
			LEFT JOIN ZnodeCMSSEODetail AS ZCSD ON(PPD.SKU = ZCSD.SEOCode and ZCSD.PortalId = ZPC.PortalId)  
			LEFT JOIN ZnodeCMSSEOType AS ZCST ON(ZCST.CMSSEOTypeId = ZCSD.CMSSEOTypeId AND ZCST.Name = 'Product')  
			LEFT JOIN ZnodeCMSSEODetailLocale AS ZCSDL ON(ZCSDL.CMSSEODetailId = ZCSD.CMSSEODetailId AND ZCSDL.LocaleId IN(@LocaleId, @DefaultLocaleId))  
			LEFT JOIN #TBL_DomainName AS TBDN ON(TBDN.RowId = 1 AND TBDN.PortalId = zpc.PortalId)   
			WHERE EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZPC.PortalId)  
				
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[SEOTitle],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag  
			INTO #Cte_SeoDetailsWithFirstLocale
			FROM #Cte_SeoDetailsWithLocale   
			WHERE LocaleId = @LocaleId  
    
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[SEOTitle],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode , CanonicalURL, RobotTag 
			INTO #Cte_SeoDetailsWithDefaultLocale
			FROM #Cte_SeoDetailsWithFirstLocale  
			
			INSERT INTO #Cte_SeoDetailsWithDefaultLocale 
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[SEOTitle],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag  
			FROM #Cte_SeoDetailsWithLocale AS CTSDWL  
			WHERE LocaleId = @DefaultLocaleId   
			AND NOT EXISTS(SELECT TOP 1 1 FROM #Cte_SeoDetailsWithFirstLocale AS CTSDWDL WHERE CTSDWDL.CMSSEODetailId = CTSDWL.CMSSEODetailId)  
         
			INSERT INTO #TBL_SEODetails  
			SELECT DISTINCT loc,lastmod,[g:condition],[description],[SEOTitle],[g:id],link,[g:identifier_exists],DomainName,PortalId ,SEOCode, CanonicalURL, RobotTag  
			FROM #Cte_SeoDetailsWithDefaultLocale;
			
			select a.PublishProductId, d.AttributeDefaultValueCode as OutOfStockOptions
			into #TempProduct_OutOfStockOptions
			from ZnodePublishProduct a
			inner join ZnodePimAttributeValue b on a.PimProductId = b.PimProductId
			inner join ZnodePimProductAttributeDefaultValue c on b.PimAttributeValueId = c.PimAttributeValueId
			inner join ZnodePimAttributeDefaultValue d on c.PimAttributeDefaultValueId = d.PimAttributeDefaultValueId
			where EXISTS(select top 1 1 from ZnodePimAttribute ZPA where AttributeCode = 'OutOfStockOptions' AND b.PimAttributeId = ZPA.PimAttributeId)
			
			SELECT TBSD.loc,TBSD.lastmod,TBSD.[g:condition],TBSD.[description],TBSD.[SEOTitle],TBSD.[g:id],TBSD.link,TBSD.[g:identifier_exists],TBSD.DomainName,TBSD.PortalId,OOS.OutOfStockOptions,
			CASE WHEN SUM(ISNULL(ZI.Quantity,0)) > 0 THEN 'In Stock'
			     WHEN SUM(ISNULL(ZI.Quantity,0)) = 0 AND ISNULL(OOS.OutOfStockOptions,'') <> 'DisablePurchasing'  THEN 'In Stock'
                 WHEN @FeedType = 'Xml'THEN 'Out Of Stock' 
                 ELSE 'Not In Stock'  END AS [g:availability],
				 
			ZPPD.SKU ,TBSD.SEOCode, TBSD.CanonicalURL, TBSD.RobotTag, ZPP.PublishProductId,ZPPD.ProductName
			INTO #TBL_CompleteDetailes  
			FROM ZnodePublishProduct AS ZPP   
			inner join #TempProduct_OutOfStockOptions OOS ON ZPP.PublishProductId = OOS.PublishProductId
			LEFT JOIN #TBL_SEODetails AS TBSD ON(ZPP.PublishProductId = TBSD.[g:id] )  
			LEFT JOIN ZnodePublishProductDetail AS ZPPD ON(ZPPD.PublishProductId = ZPP.PublishProductId AND ZPPD.LocaleId = @LocaleId)  
			LEFT JOIN ZnodePortalWarehouse AS ZPW ON(ZPW.PortalId = TBSD.PortalId)  
			LEFT JOIN ZnodePortalAlternateWarehouse AS ZAPW ON(ZAPW.PortalWarehouseId = ZPW.PortalWarehouseId)  
			LEFT JOIN ZnodeInventory AS ZI ON(ZI.SKU = ZPPD.SKU AND (ZI.WarehouseId = ZPW.WarehouseId OR ZI.WarehouseId = ZAPW.WarehouseId))  			
			GROUP BY loc,lastmod,[g:condition],[description],[SEOTitle],[g:id],link,[g:identifier_exists],DomainName,TBSD.PortalId,ZPPD.SKU,ZPPD.LocaleId, TBSD.SEOCode, TBSD.CanonicalURL, TBSD.RobotTag, ZPP.PublishProductId,ZPPD.ProductName,OOS.OutOfStockOptions;    
			
			DECLARE @MediaConfiguration NVARCHAR(2000)=((SELECT TOP 1 ISNULL(CASE WHEN CDNURL = '' THEN NULL ELSE CDNURL END,URL) FROM ZnodeMediaConfiguration WHERE IsActive = 1));    
  
			CREATE INDEX Idx_#TBL_CompleteDetailes ON #TBL_CompleteDetailes(PortalId,SKU)
			
			select * into #TBL_PricePrecedence from(
			select ROW_NUMBER() OVER(PARTITION BY sku ORDER BY Precedence) rnk_min, sku, RetailPrice,SalesPrice,znodeprice.PriceListId,ZnodePriceList.ListCode,
			ZnodePriceListPortal.Precedence
			from znodeprice
			left join ZnodePriceList on ZnodePriceList.PriceListId = znodeprice.PriceListId
			left join  ZnodePriceListPortal on ZnodePriceList.PriceListId= ZnodePriceListPortal.PriceListId where PortalId = @PortalId 
			)a
			order by a.sku,Precedence
			delete from #TBL_PricePrecedence where rnk_min<>1 
	
			SELECT zp.PortalId,round(isnull(Zps.SalesPrice,Zps.RetailPrice),2) as Price,Zps.SKU,tbcd.SEOCode,ROW_NUMBER() OVER(PARTITION BY Zps.SKU,zp.PortalId ORDER BY ZPS.RetailPrice) AS RowId  
			INTO #Cte_PortalList
			FROM ZnodePriceList AS ZPL   
			LEFT JOIN ZnodePriceListPortal AS ZPLP ON ZPL.PriceListId = ZPLP.PriceListId  
			LEFT JOIN ZnodeCulture AS zc ON ZPL.CultureId = zc.CultureId
			LEFT JOIN ZnodePortal AS zp ON ZPLP.PortalId = zp.PortalId  
		    LEFT JOIN #TBL_PricePrecedence Zps ON(Zps.PriceListId = ZPL.PriceListId) 
			--LEFT JOIN ZnodePrice AS Zps ON(Zps.PriceListId = ZPL.PriceListId)   
			LEFT JOIN #TBL_CompleteDetailes AS TBCD ON(TBCD.PortalId = Zp.PortalId AND TBCD.SKU = Zps.Sku)   
			WHERE CAST(@GetDate AS DATE) BETWEEN ZPL.ActivationDate AND ZPL.ExpirationDate   
			AND EXISTS( SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZPLP.PortalId)   
			GROUP BY zp.PortalId,ZPS.RetailPrice,Zps.SalesPrice,Zps.SKU ,TBCD.SEOCode  
			
			SELECT D.PublishProductId,C.AttributeDefaultValueCode AS Brand
			INTO #BrandDetails
			FROM ZnodePimAttributeValue A
			INNER JOIN ZnodePimProductAttributeDefaultValue B ON B.PimAttributeValueId=A.PimAttributeValueId
			INNER JOIN ZnodePimAttributeDefaultValue C ON C.PimAttributeDefaultValueId=A.PimAttributeDefaultValueId	
			INNER JOIN Znodepublishproduct D ON  A.PimProductId = D.PimProductId 
			WHERE EXISTS(SELECT * FROM ZnodePimAttribute D WHERE D.PimAttributeId=A.PimAttributeId AND D.AttributeCode='Brand' )
			AND EXISTS(SELECT * FROM #TBL_CompleteDetailes E Where E.PublishProductId = D.PublishProductId)		
			
			SELECT A.CategoryName , A.ZnodeProductId AS PublishProductId, ROW_NUMBER() OVER(PARTITION BY A.ZnodeProductId ORDER BY A.ZnodeProductId) AS RowId
			INTO #ProductCategories
			FROM ZnodePublishProductEntity A 
			WHERE EXISTS(SELECT * FROM #TBL_CompleteDetailes B WHERE A.ZnodeProductId = B.PublishProductId)
			AND ISNULL(A.CategoryName,'') <> ''

			DELETE FROM #ProductCategories WHERE RowId <> 1
 
			SELECT SKU,SUM(cast(Quantity as numeric(28,0)))AS Inventory 
			into #InventotyDetails 
			FROM ZnodeInventory A 
			WHERE EXISTS(SELECT * FROM #TBL_CompleteDetailes B where A.SKU=B.SKU)
			GROUP BY SKU  

			SELECT F.PublishProductId,[Path] AS ImagePath
			INTO #ProductImage
			FROM ZnodePimAttributeValue a
			INNER JOIN ZnodePimProductAttributeMedia b on a.PimAttributeValueId = b.PimAttributeValueId
			INNER JOIN ZnodeMedia d on b.MediaId = d.MediaId
			INNER JOIN Znodepublishproduct F ON  A.PimProductId = F.PimProductId 
			WHERE EXISTS(SELECT * FROM ZnodePimAttribute C WHERE C.PimAttributeId=A.PimAttributeId AND C.AttributeCode='PRODUCTIMAGE' )
			AND EXISTS(SELECT * FROM #TBL_CompleteDetailes E Where E.PublishProductId = F.PublishProductId)		

						 
			SELECT 
			DomainName AS DomainName,
			isnull(ProductName,SEOTitle) as [Title],
			--lastmod,
			--[g:condition],
			[description] AS [Description],
			CAST([g:id] AS nvarchar(50) ) AS ProductID,
			[g:availability] AS [Availability],
			--[g:identifier_exists],	
			--TBCD.PortalId,
			Cast(CAST(CTPL.Price AS numeric(28,3))as nvarchar(100)) AS Price,
			@MediaConfiguration AS MediaConfiguration,
			--TBCD.SEOCode,
			--TBCD.CanonicalURL,
			--TBCD.RobotTag,
			PC.CategoryName AS Category,
			CAST(ID.Inventory AS nvarchar(50) ) AS Inventory,
			BD.Brand AS Brand,
			ID.SKU AS ID,
			link AS Link,
			PM.IMAGEPATH AS Image_Link
			FROM #TBL_CompleteDetailes AS TBCD   
			LEFT JOIN #Cte_PortalList AS CTPL ON(CTPL.PortalId = TBCD.PortalId AND CTPL.SKU = TBCD.SKU AND CTPL.RowID = 1)  
			LEFT JOIN #ProductCategories PC ON TBCD.PublishProductId = PC.PublishProductId
			LEFT JOIN #InventotyDetails ID ON TBCD.SKU = ID.SKU 
			LEFT JOIN #BrandDetails BD on TBCD.PublishProductId=BD.PublishProductId
			LEFT JOIN #ProductImage PM on TBCD.PublishProductId=PM.PublishProductId
			WHERE  EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = TBCD.PortalId)

		IF OBJECT_ID('tempdb..#TBL_DomainName') IS NOT NULL
		DROP TABLE #TBL_DomainName

		IF OBJECT_ID('tempdb..#TBL_SEODetails') IS NOT NULL
		DROP TABLE #TBL_SEODetails

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_PortalIds') IS NOT NULL
		DROP TABLE #TBL_PortalIds

		IF OBJECT_ID('tempdb..#TBL_PricePrecedence') IS NOT NULL
		DROP TABLE #TBL_PricePrecedence
		
END TRY  
BEGIN CATCH  
	DECLARE @Status BIT ;  
	SET @Status = 0;  
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetXmlProductFeedList @PortalId = '+@PortalId+',@LocaleId='+CAST(@LocaleId AS VARCHAR(50))+',@FeedType='+CAST(@FeedType AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));  
                 
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
     
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_GetXmlProductFeedList',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
   
END;

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodeManageConditionalDefaultData')
BEGIN
		CREATE TABLE [dbo].[ZnodeManageConditionalDefaultData] 
	(
		[ZnodeManageConditionalDefaultDataId]	INT	IDENTITY (1, 1) NOT NULL,
		[ConditionalCode]						NVARCHAR (100)  NOT NULL,
		[ConditionalName]						NVARCHAR (MAX) NULL,
		[DataSource]							NVARCHAR (20) NULL,
		[IsActive]								BIT NOT NULL DEFAULT (1),
		[CreatedBy]								INT NOT NULL,
		[CreatedDate]							DATETIME NOT NULL,
		[ModifiedBy]							INT NOT NULL,
		[ModifiedDate]							DATETIME        NOT NULL,
		CONSTRAINT [PK_ZnodeManageConditionalDefaultData] PRIMARY KEY CLUSTERED ([ZnodeManageConditionalDefaultDataId] ASC),
		CONSTRAINT [UK_ZnodeManageConditionalDefaultData] UNIQUE (ConditionalCode),
	);
END

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodePublishSearchProfileEntity')
BEGIN
		CREATE TABLE [dbo].[ZnodePublishSearchProfileEntity](
		[PublishSearchProfileEntityId] [int] IDENTITY(1,1) NOT NULL,
		[SearchProfileId] [int] NULL,
		[SearchProfileName] [nvarchar](800) NULL,
		[ZnodeCatalogId] [int] NULL,
		[FeaturesList] [nvarchar](max) NULL,
		[QueryTypeName] [nvarchar](800) NULL,
		[SearchQueryType] [nvarchar](800) NULL,
		[QueryBuilderClassName] [nvarchar](800) NULL,
		[SubQueryType] [nvarchar](800) NULL,
		[FieldValueFactor] [nvarchar](max) NULL,
		[Operator] [varchar](20) NULL,
		[PublishStateId] [int] NULL,
		[SearchProfileAttributeMappingJson] [nvarchar](max) NULL,
		[CreatedBy] [int] NOT NULL,
		[CreatedDate] [datetime] NOT NULL,
		[ModifiedBy] [int] NOT NULL,
		[ModifiedDate] [datetime] NOT NULL,
		[SearchProfilePublishLogId] [int] NOT NULL,
	 CONSTRAINT [PK_ZnodePublishSearchProfileEntity] PRIMARY KEY CLUSTERED 
	(
		[PublishSearchProfileEntityId] ASC
	)
	) ON [PRIMARY];
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'PublishStateId' AND Object_ID = Object_ID(N'dbo.ZnodeSearchProfile'))
BEGIN
	ALTER TABLE ZnodeSearchProfile ADD [PublishStateId] INT  NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'IsNgramEnabled' AND Object_ID = Object_ID(N'dbo.ZnodeSearchProfileAttributeMapping'))
BEGIN
	ALTER TABLE ZnodeSearchProfileAttributeMapping ADD [IsNgramEnabled] BIT NULL;
END

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodeSearchProfilePublishLog')
BEGIN
	CREATE TABLE [dbo].[ZnodeSearchProfilePublishLog](
		[SearchProfilePublishLogId] [int] IDENTITY(1,1) NOT NULL,
		[SearchProfileId] [int] NOT NULL,
		[PublishstateId] [int] NOT NULL,
		[PublishStartDate] [datetime] NOT NULL,
		[CreatedBy] [int] NOT NULL,
		[CreatedDate] [datetime] NOT NULL,
		[ModifiedBy] [int] NOT NULL,
		[ModifiedDate] [datetime] NOT NULL,
	 CONSTRAINT [PK_ZnodeSearchProfilePublishLog] PRIMARY KEY CLUSTERED 
	(
		[SearchProfilePublishLogId] ASC
	)
	) ON [PRIMARY];
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSearchProfile')
	DROP PROC Znode_InsertUpdateSearchProfile
GO

IF EXISTS(SELECT 1 FROM sys.types WHERE is_table_type = 1 AND name = 'SearchProfileAttributeList')
	DROP TYPE SearchProfileAttributeList;
GO
	CREATE TYPE [dbo].[SearchProfileAttributeList] AS TABLE (
    [AttributeCode] VARCHAR (300) NULL,
    [IsFacets]      BIT           NULL,
    [IsUseInSearch] BIT           NULL,
    [BoostValue]    INT           NULL,
    [IsNgramEnabled] BIT           Null);
GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPortalSearchProfile')
	DROP PROC Znode_GetPortalSearchProfile
GO

CREATE PROCEDURE [dbo].[Znode_GetPortalSearchProfile]
(   @WhereClause NVARCHAR(MAX),
    @Rows        INT           = 100,
    @PageNo      INT           = 1,
    @Order_BY    VARCHAR(100)  = '',
    @RowsCount   INT OUT
)
AS 
/* 
   SUMMARY : Stored Procedure to Get list of PortalsearchProfileid 
   Unit Testing:

   -- EXEC Znode_GetPortalSearchProfile @WhereClause = 'searchprofileid = 2',@RowsCount = 0,@UserId=2
*/
BEGIN
    BEGIN TRY

	SET NOCOUNT ON 

	DECLARE @SQL  NVARCHAR(max) 
		
	DECLARE @TBL_PortalSearchProfile TABLE 
		(PublishCatalogId INT,SearchProfileId INT,PortalName nvarchar(400),PortalId INT,ProfileName NVARCHAR(400), CatalogName nvarchar(400), RowId INT, CountNo INT)

	SET @SQL = '
		;With Cte_GetPortalSearchProfileList 
		AS  (
			SELECT DISTINCT	ZSCP.PublishCatalogId,ZSP.SearchProfileId,ZP.StoreName as PortalName,
				ZP.PortalId,ZSP.ProfileName,ZPC.CatalogName
			FROM ZnodeSearchProfile ZSP
			INNER JOIN ZnodePublishCatalogSearchProfile ZSCP ON (ZSP.SearchProfileId = ZSCP.SearchProfileId)
			INNER JOIN ZnodePortalCatalog ZPSP ON (ZSCP.PublishCatalogId = ZPSP.PublishCatalogId)
			INNER JOIN ZnodePortal ZP ON (ZP.PortalId = ZPSP.PortalId)
			INNER JOIN ZnodePublishCatalog ZPC ON (ZPC.PublishCatalogId = ZSCP.PublishCatalogId)
			)
			,Cte_GetFilterPortalSearchProfile
			AS (
			SELECT PublishCatalogId,SearchProfileId,PortalName,PortalId,ProfileName,CatalogName,
			'+dbo.Fn_GetPagingRowId(@Order_BY,'PublishCatalogId DESC')+',Count(*)Over() CountNo 
			FROM  Cte_GetPortalSearchProfileList CGPTL 
			WHERE 1=1 '+dbo.Fn_GetFilterWhereClause(@WhereClause)+'	
			)																			
			SELECT PublishCatalogId,SearchProfileId,PortalName,PortalId,ProfileName,CatalogName,RowId,CountNo
			FROM Cte_GetFilterPortalSearchProfile
			'+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows)
		
			INSERT INTO @TBL_PortalSearchProfile(PublishCatalogId,SearchProfileId,PortalName,PortalId,ProfileName,CatalogName,RowId,CountNo)
			EXEC(@SQL)

			SET @RowsCount =ISNULL((SELECT TOP 1 CountNo FROM @TBL_PortalSearchProfile ),0)
			
			SELECT PublishCatalogId,SearchProfileId,PortalName,PortalId,ProfileName,CatalogName
			FROM @TBL_PortalSearchProfile
	END TRY
	BEGIN CATCH
		DECLARE @Status BIT ;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), 
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPortalSearchProfile @WhereClause = '''+ISNULL(@WhereClause,'''''')+''',@Rows='+ISNULL(CAST(@Rows AS VARCHAR(50)),'''''')+',@PageNo='+ISNULL(CAST(@PageNo AS VARCHAR(50)),'''')+',@Order_BY='''+ISNULL(@Order_BY,'''''')+''',@RowsCount='+ISNULL(CAST(@RowsCount AS VARCHAR(50)),'''');
              			 
        SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
        EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_GetPortalSearchProfile',
			@ErrorInProcedure = 'Znode_GetPortalSearchProfile',
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetSearchProfileDetails')
	DROP PROC Znode_GetSearchProfileDetails

GO

CREATE PROCEDURE [dbo].[Znode_GetSearchProfileDetails]
(
	@SearchProfileId int 
)
AS 
/*
	 Summary :- This Procedure is used to get the publish status of the catalog 
	 Unit Testig 
	 EXEC  Znode_GetCatalogList '',100,1,'',0
*/
   BEGIN 
		BEGIN TRY 
		SET NOCOUNT ON 

		   Declare @SearchQueryTypeId int 

				Select @SearchQueryTypeId=SearchQueryTypeId 
				from ZnodeSearchProfile
				Where  SearchProfileId=@SearchProfileId	

				Exec [dbo].[Znode_GetSearchQueryTypeWiseFeatureDetails] @SearchProfileId=@SearchProfileId,@SearchQueryTypeId=@SearchQueryTypeId
						

				Select b.SearchProfileId,b.AttributeCode,b.BoostValue,b.IsNgramEnabled,b.IsUseInSearch,b.IsFacets
				from ZnodeSearchProfileAttributeMapping b
				Where  b.SearchProfileId=@SearchProfileId AND IsUseInSearch=1

				Select b.SearchProfileId,b.AttributeCode,b.BoostValue,b.IsNgramEnabled,b.IsFacets,b.IsUseInSearch
				from ZnodeSearchProfileAttributeMapping b
				Where  b.SearchProfileId=@SearchProfileId AND IsFacets=1

				Select b.SearchQueryTypeId , b.SearchQueryTypeId ,b.ProfileName,b.Operator,
				c.QueryTypeName,c.QueryBuilderClassName,
				b.SearchSubQueryTypeId,d.QueryTypeName SubQueryTypeName,d.QueryBuilderClassName SubQueryBuilderClassName,
				pc.PublishCatalogId,pc.CatalogName, b.SearchProfileId
				from  ZnodeSearchProfile B 
				left join dbo.ZnodePublishCatalogSearchProfile cc on cc.SearchProfileId=b.SearchProfileId
				left join dbo.ZnodePublishCatalog pc on pc.PublishCatalogId=cc.PublishCatalogId
				inner join ZnodeSearchQueryType C on b.SearchQueryTypeId=C.SearchQueryTypeId 
				Left join ZnodeSearchQueryType d on  d.SearchQueryTypeId =b.SearchSubQueryTypeId
				Where  b.SearchProfileId=@SearchProfileId	 

				select pfv.FieldName,pfv.FieldValueFactor 
				from ZnodeSearchProfileFieldValueFactor pfv
				WHERE pfv.SearchProfileId = @SearchProfileId

		 END TRY 
		 BEGIN CATCH 
			DECLARE @Status BIT ;
			SET @Status = 0;
			DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
			@ErrorLine VARCHAR(100)= ERROR_LINE(), 
			@ErrorCall NVARCHAR(MAX)
	--		= 'EXEC Znode_GetCatalogList @WhereClause = '+@WhereClause+',@Rows='+CAST(@Rows AS
 --VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
			SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
			EXEC Znode_InsertProcedureErrorLog
					@ProcedureName = 'Znode_GetZnodeSearchProfileList',
					@ErrorInProcedure = @Error_procedure,
					@ErrorMessage = @ErrorMessage,
					@ErrorLine = @ErrorLine,
					@ErrorCall = @ErrorCall;
		 END CATCH 
   END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetSearchProfileList')
	DROP PROC Znode_GetSearchProfileList
GO


CREATE PROCEDURE [dbo].[Znode_GetSearchProfileList]
(
	@WhereClause NVARCHAR(MAX),
    @Rows        INT           = 100,
    @PageNo      INT           = 1,
    @Order_BY    VARCHAR(100)  = '',
    @RowsCount   INT OUT
)
AS 
/*
	 Summary :- This Procedure is used to get the publish status of the catalog 
	 Unit Testig 
	 EXEC  Znode_GetSearchProfileList '',100,1,'',0
*/
   BEGIN 
		BEGIN TRY 
		SET NOCOUNT ON 

		 DECLARE @SQL  NVARCHAR(max) 
		 DECLARE @TBL_CatalogId TABLE 
		 (PublishCatalogId int ,CatalogName NVARCHAR(2000), SearchProfileId INT , SearchQueryTypeId INT , ProfileName NVARCHAR(2000),QueryTypeName  NVARCHAR(2000),QueryBuilderClassName  NVARCHAR(2000),SearchSubQueryTypeId INT,SubQueryTypeName  NVARCHAR(2000),
		SubQueryBuilderClassName  NVARCHAR(2000),--RowId INT ,
		PortalId INT,PortalName NVARCHAR(MAX),IsDefault BIT,CountId INT,CreatedDate Datetime,PublishStateId INT,CatalogCode VARCHAR(300) )
		
	 
		 SET @SQL = '
		;With Cte_CatalogLog AS (
		Select dd.PublishCatalogId,pc.CatalogName,B.SearchProfileId,  b.SearchQueryTypeId ,b.ProfileName,
		c.QueryTypeName,c.QueryBuilderClassName,
		b.SearchSubQueryTypeId,d.QueryTypeName SubQueryTypeName,d.QueryBuilderClassName SubQueryBuilderClassName,ZPSP.PortalId,ZP.StoreName as PortalName,isnull(ZPSP.IsDefault,0) as Isdefault, B.CreatedDate,B.PublishStateId,
		ZPC.CatalogCode
		from  ZnodeSearchProfile B 
		INNER JOIN ZnodePublishCatalogSearchProfile dd on  dd.SearchProfileId=b.SearchProfileId
		inner join ZnodePublishCatalog pc on pc.PublishCatalogId=dd.PublishCatalogId
		inner join ZnodePimCatalog zpc on ZPC.PimCatalogId = PC.PimCatalogId
		inner join ZnodeSearchQueryType C on b.SearchQueryTypeId=C.SearchQueryTypeId 
		Left join ZnodeSearchQueryType d on  d.SearchQueryTypeId =b.SearchSubQueryTypeId
		LEFT Join ZnodePortalSearchProfile ZPSP ON (ZPSP.SearchProfileId = B.SearchProfileId AND ZPSP.PublishCatalogId = DD.PublishCatalogId)
		LEFT JOIN ZnodePortal ZP ON (ZP.PortalId = ZPSP.PortalId)
			
		)	 
	     ,Cte_PublishStatus 
		 AS (
		 SELECT PublishCatalogId,CatalogName,SearchProfileId , SearchQueryTypeId ,ProfileName,   
		QueryTypeName,QueryBuilderClassName,
		SearchSubQueryTypeId,SubQueryTypeName,
		SubQueryBuilderClassName,PortalId,PortalName	,IsDefault,	PublishStateId,
		 '+[dbo].[Fn_GetPagingRowId](@Order_BY,'SearchProfileId DESC')+' , Count(*)Over() CountId ,CreatedDate,CatalogCode
		 FROM Cte_CatalogLog
         WHERE 1=1 '+[dbo].[Fn_GetFilterWhereClause](@WhereClause)+' )
	 
		 SELECT PublishCatalogId,CatalogName,SearchProfileId , SearchQueryTypeId ,
		 ProfileName,QueryTypeName,QueryBuilderClassName, SearchSubQueryTypeId,SubQueryTypeName,
		SubQueryBuilderClassName,PortalId,PortalName	,IsDefault,CountId, CreatedDate,PublishStateId,CatalogCode
		 FROM Cte_PublishStatus 
		 '+[dbo].[Fn_GetPaginationWhereClause](@PageNo,@Rows)+' '
	

	     PRINT @sql 
		 INSERT INTO @TBL_CatalogId 
		 EXEC (@SQL)
		 declare @PublishStateIdForForNotPublishedState int= dbo.Fn_GetPublishStateIdForForNotPublishedState()
		 SELECT   PublishCatalogId,CatalogName,SearchProfileId , SearchQueryTypeId ,
		 ProfileName,QueryTypeName,QueryBuilderClassName,SearchSubQueryTypeId,SubQueryTypeName,
		SubQueryBuilderClassName,PortalId,PortalName	,IsDefault,CountId, a.CreatedDate,b.DisplayName as PublishStatus,a.CatalogCode
		 FROM @TBL_CatalogId a
		 INNER JOIN ZnodePublishState b on isnull(a.PublishStateId,@PublishStateIdForForNotPublishedState) = b.PublishStateId
		 SET @RowsCount = ISNULL((SELECT TOP 1 COUNTID 
		 FROM @TBL_CatalogId),0)

		 END TRY 
		 BEGIN CATCH 
			DECLARE @Status BIT ;
			SET @Status = 0;
			DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
			@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetSearchProfileList @WhereClause = '''+ISNULL(@WhereClause,'''''')+''',@Rows='+ISNULL(CAST(@Rows AS
			VARCHAR(50)),'''''')+',@PageNo='+ISNULL(CAST(@PageNo AS VARCHAR(50)),'''')+',@Order_BY='''+ISNULL(@Order_BY,'''''')+''',@RowsCount='+ISNULL(CAST(@RowsCount AS VARCHAR(50)),'''');
              			 
			SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
			EXEC Znode_InsertProcedureErrorLog
					@ProcedureName = 'Znode_GetSearchProfileList',
					@ErrorInProcedure = 'Znode_GetSearchProfileList',
					@ErrorMessage = @ErrorMessage,
					@ErrorLine = @ErrorLine,
					@ErrorCall = @ErrorCall;
		 END CATCH 
   END




GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetWebStoreSearchProfileTrigger')
	DROP PROC Znode_GetWebStoreSearchProfileTrigger
GO

CREATE PROCEDURE [dbo].[Znode_GetWebStoreSearchProfileTrigger]
(
	@Keyword NVARCHAR(100) = '',
    @ProfileId INT = '',
	@PublishCatalogId INT,
	@PortalId INT 
)
AS 
/*
	 Summary :- This Procedure is used to get the published search profile details. 
	 Unit Testig 
	 EXEC [Znode_GetWebStoreSearchProfileTrigger] 'Apple','1',3,1
*/
BEGIN 
	BEGIN TRY
	SET NOCOUNT ON 
		DECLARE @SearchProfileId INT 

		--Select @SearchProfileId=d.SearchProfileId 
		--from [ZnodeSearchProfileTrigger] d
		--inner join ZnodePublishCatalogSearchProfile c on c.SearchProfileId=d.SearchProfileId
		--Where d.Keyword=@Keyword
		--and d.ProfileId=@ProfileId
		--and c.PublishCatalogId=@PublishCatalogId

		--If isnull(@SearchProfileId,0)=0
		--Begin
		--Select @SearchProfileId=d.SearchProfileId 
		--from [ZnodeSearchProfileTrigger] d
		--inner join ZnodePublishCatalogSearchProfile c on c.SearchProfileId=d.SearchProfileId
		--Where d.Keyword=@Keyword
		--and c.PublishCatalogId=@PublishCatalogId
		--and d.ProfileId is null
		--eND

		--If isnull(@SearchProfileId,0)=0
		--Begin
		--Select @SearchProfileId=d.SearchProfileId 
		--from [ZnodeSearchProfileTrigger] d
		--inner join ZnodePublishCatalogSearchProfile c on c.SearchProfileId=d.SearchProfileId
		--Where d.ProfileId=@ProfileId
		--and c.PublishCatalogId=@PublishCatalogId
		--and d.Keyword is null
		--eND

		IF ISNULL(@SearchProfileId,0)=0
		BEGIN
			SELECT @SearchProfileId=a.SearchProfileId 
			FROM ZnodePortalSearchProfile a
			INNER JOIN ZnodePublishCatalogSearchProfile c on c.SearchProfileId=a.SearchProfileId
			WHERE a.PortalId =@PortalId 
				AND a.IsDefault=1
				AND c.PublishCatalogId=@PublishCatalogId
		END 

		--If isnull(@SearchProfileId,0)=0
		-- Begin
		--	Select @SearchProfileId=min(a.SearchProfileId)
		--	from ZnodePortalSearchProfile a
		--	inner join ZnodePublishCatalogSearchProfile c on c.SearchProfileId=a.SearchProfileId
		--	Where a.PortalId =@PortalId 
		--	and a.IsDefault=0
		--	and c.PublishCatalogId=@PublishCatalogId
		--End 

		IF ISNULL(@SearchProfileId,0)=0
		BEGIN
			SELECT @SearchProfileId=a.SearchProfileId
			FROM ZnodeSearchProfile a
			----inner join ZnodePublishCatalogSearchProfile c on c.SearchProfileId=a.SearchProfileId
			WHERE a.IsDefault=1
			--and c.PublishCatalogId=@PublishCatalogId
		END 

		SELECT PublishSearchProfileEntityId,SearchProfileId,SearchProfileName,ZnodeCatalogId,FeaturesList,QueryTypeName,SearchQueryType,
			QueryBuilderClassName,SubQueryType,FieldValueFactor,[Operator],PublishStateId,SearchProfileAttributeMappingJson,CreatedBy,
			CreatedDate,ModifiedBy,ModifiedDate,SearchProfilePublishLogId
		FROM ZnodePublishSearchProfileEntity
		WHERE SearchProfileId = @SearchProfileId 

		--If Isnull(@SearchProfileId,0)>0
		--exec [dbo].[Znode_GetSearchProfileDetails] @SearchProfileId=@SearchProfileId

		----To get SearchRule Item Details
		EXEC [Znode_GetSearchTriggerItemRuleDetails] @Keyword = @Keyword, @PublishCatalogId = @PublishCatalogId

	END TRY 
	BEGIN CATCH
		DECLARE @Status BIT;

		SET @Status = 0;

		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), 
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
				@ErrorLine VARCHAR(100)= ERROR_LINE(), 
				@ErrorCall NVARCHAR(MAX)= 
					'EXEC Znode_GetWebStoreSearchProfileTrigger 
						@Keyword = '''+ISNULL(@Keyword,'''''')+''',
						@ProfileId='+ISNULL(CAST(@ProfileId AS VARCHAR(50)),'''''')+',
						@PublishCatalogId='+ISNULL(CAST(@PublishCatalogId AS	VARCHAR(50)),'''''')+',
						@PortalId='+ISNULL(CAST(@PortalId AS	VARCHAR(50)),'''''');
              			 
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;
		  
		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_GetWebStoreSearchProfileTrigger',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSearchProfile')
	DROP PROC Znode_InsertUpdateSearchProfile

GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSearchProfile]
(   @SearchProfileId       int,
    @ProfileName           nvarchar(200),
	@SearchQueryTypeId     int,
	@SearchSubQueryTypeId  int,
    @SearchProfileFeatureList SearchProfileFeatureList readonly ,
    @SearchProfileAttributeList SearchProfileAttributeList readonly ,
    @UserId                INT,
	@PublishCatalogId      int,
	@Operator			   nvarchar(20),	
	@IsDefault             bit=0 ,
	@SearchProfileFieldValue  SearchProfileFieldValueFactor  readonly
	 )
AS 
   /* 
    Summary: This Procedure is used to save and edit the quote line item      
    Unit Testing   
    Exec Znode_InsertUpdateQuoteLineItem 
	Unit Testing

	 GO 
	declare @p7 dbo.SearchProfileFetureList
	insert into @p7 values(N'0',1)

	declare @p8 dbo.SearchProfileAttributeList
	insert into @p8 values(N'ProductSpecification',0,0,1)
	insert into @p8 values(N'ShortDescription',0,0,3)
	insert into @p8 values(N'ProductName',0,0,2)
	insert into @p8 values(N'FeatureDescription',0,0,4)
	insert into @p8 values(N'SKU',0,0,5)

	exec sp_executesql N'Znode_InsertUpdateSearchProfile  @SearchProfileId,@ProfileName,@SearchQueryTypeId,@SearchSubQueryTypeId,@SearchProfileFeatureList,@SearchProfileAttributeList,@UserId,@PublishCatalogId,@Operator,@IsDefault',N'@SearchProfileId int,@Prof
ileName nvarchar(17),@SearchQueryTypeId int,@SearchSubQueryTypeId int,@SearchProfileFeatureList [dbo].[SearchProfileFetureList] READONLY,@SearchProfileAttributeList [dbo].[SearchProfileAttributeList] READONLY,@UserId int,@PublishCatalogId int,@Operator nva
rchar(2),@IsDefault bit',@SearchProfileId=0,@ProfileName=N'FineFoodsProfile1',@SearchQueryTypeId=2,@SearchSubQueryTypeId=0,@SearchProfileFeatureList=@p7,@SearchProfileAttributeList=@p8,@UserId=0,@PublishCatalogId=3,@Operator=N'OR',@IsDefault=0
   
	*/
	   BEGIN
	DECLARE @GetDate DATETIME = dbo.Fn_GetDate(),@PublishCatalogSearchProfileId int ,@ReturnMessage  NVARCHAR(max)= ''
  
         BEGIN TRAN A;
         BEGIN TRY


	


		  If Isnull(@SearchProfileId,0)=0  
		  Begin
			IF EXISTS (SELECT TOP 1 1 from ZnodeSearchProfile ZSP WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogSearchProfile PCP WHERE PCP.PublishCatalogId =@PublishCatalogId AND PCP.SearchProfileId =ZSP.SearchProfileId   ) AND ProfileName = @ProfileName  )
			BEGIN 
				SELECT @SearchProfileId AS ID,'ProfileName Already Exists' As MessageDetails,CAST(0 AS BIT) AS Status;   	  
				Return ; 
			END 
			INSERT INTO [dbo].[ZnodeSearchProfile] ([ProfileName],[SearchQueryTypeId],[SearchSubQueryTypeId],[Operator],[CreatedBy],[CreatedDate],[ModifiedBy],[ModifiedDate])
			Select @ProfileName,@SearchQueryTypeId,@SearchSubQueryTypeId,@Operator,@UserId,@GetDate,@UserId,@GetDate
			Set @SearchProfileId=SCOPE_IDENTITY()
		  End
		  else 
		  Begin
			IF EXISTS (SELECT TOP 1 1  FROM [ZnodeSearchProfile] ZSP WHERE [ProfileName] = @ProfileName AND 
			EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogSearchProfile PCP WHERE PCP.PublishCatalogId =@PublishCatalogId AND PCP.SearchProfileId =ZSP.SearchProfileId   ) AND 
			 ZSP.SearchProfileId <>  Isnull(@SearchProfileId,0)  )
			BEGIN 
				SELECT @SearchProfileId AS ID,'ProfileName Already Exists' As MessageDetails,CAST(0 AS BIT) AS Status;   	  
				Return ; 
			END 

		    Update a
			Set a.[ProfileName]=@ProfileName,
			a.SearchQueryTypeId=@SearchQueryTypeId,
			a.SearchSubQueryTypeId=@SearchSubQueryTypeId,
			a.Operator = @Operator,
			a.ModifiedBy=@UserId,
			a.ModifiedDate=@GetDate
			from [dbo].[ZnodeSearchProfile] a
			Where SearchProfileId=@SearchProfileId
		    
		  End 

		  delete f
		  from ZnodeSearchProfileAttributeMapping f
		  Where SearchProfileId=@SearchProfileId
		  and not exists(Select 1 from @SearchProfileAttributeList d
		  where f.AttributeCode=d.AttributeCode )
		  AND f.IsFacets = 0

		  INSERT INTO [dbo].ZnodeSearchProfileAttributeMapping([SearchProfileId],[AttributeCode],[IsFacets],[IsUseInSearch],[BoostValue],[IsNgramEnabled],[CreatedBy],[CreatedDate],[ModifiedBy],[ModifiedDate])
		  Select @SearchProfileId,[AttributeCode],[IsFacets],[IsUseInSearch],[BoostValue],[IsNgramEnabled],@UserId [CreatedBy],@GetDate[CreatedDate],@UserId [ModifiedBy],@GetDate [ModifiedDate]
		   from @SearchProfileAttributeList d
		  where  not exists(Select 1 from ZnodeSearchProfileAttributeMapping f
		  where f.AttributeCode=d.AttributeCode 
		  and f.SearchProfileId=@SearchProfileId)

		  Update f
		  Set f.[IsFacets]=(CASE WHEN d.[IsFacets]=0 THEN f.[IsFacets] ELSE d.[IsFacets] END),f.[IsUseInSearch]=d.[IsUseInSearch],
		  f.[BoostValue]=d.[BoostValue],
		  f.[IsNgramEnabled] = d.[IsNgramEnabled]
		  From [dbo].ZnodeSearchProfileAttributeMapping f
		  inner join @SearchProfileAttributeList d
		  on f.AttributeCode=d.AttributeCode
		   and f.SearchProfileId=@SearchProfileId
		   --WHERE f.IsUseInSearch = 1

		    UPDATE f
			SET f.[IsUseInSearch]=0
			FROM [dbo].ZnodeSearchProfileAttributeMapping f
			LEFT JOIN @SearchProfileAttributeList d ON f.AttributeCode=d.AttributeCode AND f.SearchProfileId=@SearchProfileId
			WHERE f.SearchProfileId=@SearchProfileId AND d.[IsUseInSearch] IS NULL

		   delete f
		  from [ZnodeSearchProfileFeatureMapping] f
		  Where SearchProfileId=@SearchProfileId
		  and not exists(Select 1 from @SearchProfileFeatureList d
		  where f.SearchFeatureId=d.SearchProfileFeatureId )

		  INSERT INTO [dbo].[ZnodeSearchProfileFeatureMapping]([SearchProfileId],SearchFeatureId,[SearchFeatureValue],[CreatedBy],[CreatedDate],[ModifiedBy],[ModifiedDate])
		  Select @SearchProfileId,d.SearchProfileFeatureId,[SearchFeatureValue]
		  ,@UserId [CreatedBy],@GetDate[CreatedDate],@UserId [ModifiedBy],@GetDate [ModifiedDate]
		   from @SearchProfileFeatureList d
		  where  not exists(Select 1 from [ZnodeSearchProfileFeatureMapping] f
		  where f.SearchFeatureId=d.SearchProfileFeatureId 
		  and f.SearchProfileId=@SearchProfileId)

		  Update f
		  Set f.[SearchFeatureValue]=d.SearchFeatureValue,
		  f.ModifiedBy=@UserId,
		  f.ModifiedDate=@GetDate
		  From [dbo].[ZnodeSearchProfileFeatureMapping] f
		  inner join @SearchProfileFeatureList d
		  on f.SearchFeatureId=d.SearchProfileFeatureId  and f.SearchProfileId=@SearchProfileId
          
		   Select @PublishCatalogSearchProfileId=PublishCatalogSearchProfileId
		   From  [dbo].[ZnodePublishCatalogSearchProfile]
		   Where [PublishCatalogId]=@PublishCatalogId and  SearchProfileId = @SearchProfileId 


		   If @IsDefault=1
		      update [ZnodePublishCatalogSearchProfile]
			  set [IsDefault]=@IsDefault,
			  ModifiedBy=@UserId,
		      ModifiedDate=@GetDate
			  From  [ZnodePublishCatalogSearchProfile]
			  Where PublishCatalogSearchProfileId!=@PublishCatalogSearchProfileId
			  and [PublishCatalogId]=@PublishCatalogId

		   If Isnull(@PublishCatalogSearchProfileId,0)>0
		   Begin
		      update [ZnodePublishCatalogSearchProfile]
			  set [IsDefault]=@IsDefault,
			  ModifiedBy=@UserId,
		      ModifiedDate=@GetDate
			  From  [ZnodePublishCatalogSearchProfile]
			  Where PublishCatalogSearchProfileId=@PublishCatalogSearchProfileId
		   End
		   Else
		   INSERT INTO [dbo].[ZnodePublishCatalogSearchProfile] ([PublishCatalogId],[SearchProfileId],[IsDefault],[CreatedBy],[CreatedDate],[ModifiedBy],[ModifiedDate])
		   Select @PublishCatalogId,@SearchProfileId,@IsDefault,@UserId,@GetDate,@UserId,@GetDate

		   DELETE VF
		   FROM ZnodeSearchProfileFieldValueFactor VF
		   WHERE VF.SearchProfileId = @SearchProfileId
		   AND NOT EXISTS (SELECT 1 FROM @SearchProfileFieldValue SFP WHERE SFP.FieldName = VF.FieldName)


		   INSERT INTO ZnodeSearchProfileFieldValueFactor (SearchProfileId,FieldName,FieldValueFactor,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		   SELECT @SearchProfileId,SPF.FieldName,SPF.FieldValueFactor,@UserId,@GetDate,@UserId,@GetDate
		   FROM @SearchProfileFieldValue SPF
		   WHERE NOT EXISTS (SELECT 1 FROM ZnodeSearchProfileFieldValueFactor pf WHERE pf.FieldName = SPF.FieldName AND pf.SearchProfileId = @SearchProfileId)

		   UPDATE VF
		   SET FieldValueFactor = SPF.FieldValueFactor
		   FROM ZnodeSearchProfileFieldValueFactor VF
		   INNER JOIN @SearchProfileFieldValue SPF ON (SPF.FieldName = VF.FieldName) AND VF.SearchProfileId = @SearchProfileId


		  SELECT @SearchProfileId AS ID,'Successfull' MessageDetails,CAST(1 AS BIT) AS Status;   			
			 COMMIT TRAN A;
         END TRY
         BEGIN CATCH
        
		    -- SET @Status = 0;
		  ----   DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			 ----@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertUpdateQuoteLineItem @CartLineItemXML = '+CAST(@CartLineItemXML AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,'UnSuccessfull' MessageDetails,CAST(0 AS BIT) AS Status;                    
			 ROLLBACK TRAN A;
    --         EXEC Znode_InsertProcedureErrorLog
				--@ProcedureName = 'Znode_InsertUpdateQuoteLineItem',
				--@ErrorInProcedure = @Error_procedure,
				--@ErrorMessage = @ErrorMessage,
				--@ErrorLine = @ErrorLine,
				--@ErrorCall = @ErrorCall;
         END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishSearchProfileEntity')
	DROP PROC Znode_PublishSearchProfileEntity
GO

CREATE PROCEDURE [dbo].[Znode_PublishSearchProfileEntity] 
(
	@SearchProfileId INT,
	@UserId INT
)
AS
BEGIN
	BEGIN TRY			
		SET NOCOUNT ON
		DECLARE @SearchProfilePublishLogId INT;

		INSERT INTO ZnodeSearchProfilePublishLog
			(SearchProfileId,PublishstateId,PublishStartDate,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
		SELECT @SearchProfileId, dbo.Fn_GetPublishStateIdForProcessing(),Getdate(),@UserId , GETDATE(),@UserId , GETDATE()

		SET @SearchProfilePublishLogId = @@IDENTITY

		SELECT a.SearchProfileId,A.SearchFeatureValue,B.FeatureCode,b.FeatureName,b.IsAdvanceFeature,B.HelpDescription  
		INTO #ZnodeSearchFeature
		FROM ZnodeSearchProfileFeatureMapping A 
		INNER JOIN ZnodeSearchFeature B ON A.SearchFeatureId = B.SearchFeatureId
		WHERE A.SearchProfileId = @SearchProfileId
				
		SELECT B.SearchProfileId,
			'['+(SELECT A.SearchFeatureValue,A.FeatureCode,A.FeatureName,A.IsAdvanceFeature
		From #ZnodeSearchFeature A
		WHERE A.SearchProfileId = b.SearchProfileId 
		For Json path, Without_Array_Wrapper)+']' as FeatureValueJson
		INTO #ZnodeSearchFeatureJson
		FROM #ZnodeSearchFeature B 
		GROUP BY B.SearchProfileId

		SELECT A.SearchProfileId,
			'['+(	SELECT B.AttributeCode, B.IsFacets,B.IsUseInSearch,B.BoostValue,B.IsNgramEnabled
					FROM ZnodeSearchProfileAttributeMapping B  
					WHERE A.SearchProfileId = B.SearchProfileId
					For Json Path, Without_Array_Wrapper)
			+']' as SearchProfileAttributeMappingJson
		INTO #ZnodeSearchProfileAttributeMappingJson 
		FROM ZnodeSearchProfileAttributeMapping A
		WHERE A.SearchProfileId = @SearchProfileId
		GROUP BY A.SearchProfileId

		SELECT A.SearchProfileId,
			'['+(	select B.FieldName, B.FieldValueFactor
					from ZnodeSearchProfileFieldValueFactor B  
					Where A.SearchProfileId = B.SearchProfileId
					For Json Path, Without_Array_Wrapper)
			+']' as FieldValueFactor
		INTO #ZnodeSearchProfileFieldValueFactor 
        FROM ZnodeSearchProfileFieldValueFactor A
        WHERE A.SearchProfileId = @SearchProfileId
        GROUP BY A.SearchProfileId

		SELECT @SearchProfilePublishLogId SearchProfilePublishLogId,  b.SearchProfileId,
			b.ProfileName,pc.PublishCatalogId,ZSFJ.FeatureValueJson FeaturesList
			,c.QueryTypeName,b.SearchQueryTypeId  
			,c.QueryBuilderClassName,d.QueryTypeName SubQueryTypeName,vf.FieldValueFactor,
			b.Operator,ZSPAMJ.SearchProfileAttributeMappingJson SearchProfileAttributeMappingJson,
			@UserId CreatedBy, GETDATE() CreatedDate,@UserId Modifiedby, GETDATE() ModifiedDate
		INTO #ZnodeSearchProfile
		FROM  ZnodeSearchProfile B 
		LEFT JOIN dbo.ZnodePublishCatalogSearchProfile cc on cc.SearchProfileId=b.SearchProfileId
		LEFT JOIN dbo.ZnodePublishCatalog pc on pc.PublishCatalogId=cc.PublishCatalogId
		INNER JOIN ZnodeSearchQueryType C on b.SearchQueryTypeId=C.SearchQueryTypeId 
		--LEFT JOIN ZnodeSearchProfileFieldValueFactor ZSPF on ZSPF.SearchProfileId = b.SearchProfileId
		LEFT JOIN #ZnodeSearchFeatureJson ZSFJ on ZSFJ.SearchProfileId = b.SearchProfileId
		LEFT JOIN  #ZnodeSearchProfileAttributeMappingJson ZSPAMJ on  ZSPAMJ.SearchProfileId = b.SearchProfileId
		LEFT JOIN ZnodeSearchQueryType d on  d.SearchQueryTypeId =b.SearchSubQueryTypeId
		LEFT JOIN #ZnodeSearchProfileFieldValueFactor vf on vf.SearchProfileId =b.SearchProfileId
		WHERE b.SearchProfileId=@SearchProfileId

		IF EXISTS (SELECT TOP 1 1 FROM #ZnodeSearchProfile)
		BEGIN 
			INSERT INTO ZnodePublishSearchProfileEntity(
				SearchProfilePublishLogId,SearchProfileId,SearchProfileName,ZnodeCatalogId,FeaturesList,
				QueryTypeName,SearchQueryType,
				QueryBuilderClassName,SubQueryType,FieldValueFactor,Operator,SearchProfileAttributeMappingJson,
				CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT SearchProfilePublishLogId,SearchProfileId,ProfileName,PublishCatalogId,FeaturesList,
				QueryTypeName,SearchQueryTypeId  ,
				QueryBuilderClassName,SubQueryTypeName,FieldValueFactor,Operator,SearchProfileAttributeMappingJson,
				CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
			FROM #ZnodeSearchProfile 
		
			UPDATE ZnodeSearchProfilePublishLog
			SET PublishstateId = dbo.Fn_GetPublishStateIdForPublish()
			WHERE SearchProfilePublishLogId = @SearchProfilePublishLogId

			UPDATE ZnodeSearchProfile
			SET PublishStateId = dbo.Fn_GetPublishStateIdForPublish() 
			WHERE SearchProfileId = @SearchProfileId

		    UPDATE ZnodePublishSearchProfileEntity 
			SET PublishstateId = dbo.Fn_GetPublishStateIdForPublish() 
			WHERE SearchProfileId = @SearchProfileId 

			DELETE
			FROM ZnodePublishSearchProfileEntity
			WHERE SearchProfilePublishLogId  < @SearchProfilePublishLogId AND SearchProfileId = @SearchProfileId
			SELECT CAST(1 AS BIT) Status
		END
		ELSE
		BEGIN
			UPDATE ZnodeSearchProfilePublishLog 
			SET PublishstateId = dbo.Fn_GetPublishStateIdForPublishFailed() 
			WHERE SearchProfilePublishLogId = @SearchProfilePublishLogId 

			SELECT CAST(0 AS BIT) Status 

			UPDATE ZnodeSearchProfile 
			SET PublishstateId = dbo.Fn_GetPublishStateIdForPublishFailed() 
			WHERE SearchProfileId = @SearchProfileId 
		
	     	UPDATE ZnodePublishSearchProfileEntity 
			SET PublishstateId = dbo.Fn_GetPublishStateIdForPublishFailed() 
			WHERE SearchProfileId = @SearchProfileId
		END
	END TRY

	BEGIN CATCH
		UPDATE ZnodeSearchProfile 
		SET PublishstateId = dbo.Fn_GetPublishStateIdForPublishFailed() 
		WHERE SearchProfileId = @SearchProfileId 

		UPDATE ZnodeSearchProfilePublishLog 
		SET PublishstateId = dbo.Fn_GetPublishStateIdForPublishFailed() 
		WHERE SearchProfilePublishLogId = @SearchProfilePublishLogId AND SearchProfileId = @SearchProfileId
		
		UPDATE ZnodePublishSearchProfileEntity 
		SET PublishstateId = dbo.Fn_GetPublishStateIdForPublishFailed() 
		WHERE SearchProfileId = @SearchProfileId 

		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(),
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
				@ErrorLine VARCHAR(100)= ERROR_LINE(), 
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishSearchProfileEntity @SearchProfileId = '+CAST(@SearchProfileId AS VARCHAR(10))+',@UserId='+CAST(@UserId AS VARCHAR(10));

		SELECT CAST(0 AS BIT) Status

		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_PublishSearchProfileEntity',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH
END

GO

update ZnodeApplicationSetting
set setting='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>PortalSearchProfileId</name><headertext>Checkbox</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>ProfileName</name><headertext>Search Profile Name</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>PortalName</name><headertext>Store</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName='ZnodeSearchPortalProfile'

update ZnodeApplicationSetting
set setting='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>SearchProfileId</name><headertext>Checkbox</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>ProfileName</name><headertext>Search Profile Name</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl>/Search/Search/GetTabStructureForProfile</islinkactionurl><islinkparamfield>searchProfileId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>CatalogName</name><headertext>Catalog Name</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>PublishStatus</name><headertext>Publish Status</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>CreatedDate</name><headertext>Created Date</headertext><width>60</width><datatype>DateTime</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>Edit|Publish|Delete</format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Publish|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/Search/Search/GetTabStructureForProfile|/Search/Search/PublishSearchProfile|/Search/Search/Delete</manageactionurl><manageparamfield>searchProfileId|searchProfileId|searchProfileId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName='ZnodeSearchProfile'

update ZnodeApplicationSetting
SET Setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>SearchProfileId</name><headertext>Checkbox</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>ProfileName</name><headertext>Search Profile Name</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl>/Search/Search/GetTabStructureForProfile</islinkactionurl><islinkparamfield>searchProfileId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>CatalogCode</name><headertext>Catalog Code</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>CatalogName</name><headertext>Catalog Name</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>PublishStatus</name><headertext>Publish Status</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>CreatedDate</name><headertext>Created Date</headertext><width>60</width><datatype>DateTime</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>Edit|Publish|Delete</format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Publish|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/Search/Search/GetTabStructureForProfile|/Search/Search/PublishSearchProfile|/Search/Search/Delete</manageactionurl><manageparamfield>searchProfileId|searchProfileId|searchProfileId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>' 
where ItemName='ZnodeSearchProfile'

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM ZnodeManageConditionalDefaultData WHERE ConditionalCode = 'DeleteOldSearchProfileDuringDatabaseUpgradeOneTime' AND IsActive=1)
BEGIN
	IF OBJECT_ID('tempdb..#SearchProfileId') IS NOT NULL
		DROP TABLE #SearchProfileId;

	SELECT SearchProfileId 
	INTO #SearchProfileId
	FROM ZnodeSearchProfile WHERE ProfileName<>'ZnodeSearchProfile';

	DELETE FROM ZnodePortalSearchProfile WHERE SearchProfileId IN (SELECT SearchProfileId FROM #SearchProfileId)
	--DELETE FROM ZnodeSearchActivity WHERE SearchProfileId IN (SELECT SearchProfileId FROM #SearchProfileId)
	DELETE FROM ZnodePublishCatalogSearchProfile WHERE SearchProfileId IN (SELECT SearchProfileId FROM #SearchProfileId)
	DELETE FROM ZnodeSearchProfileAttributeMapping WHERE SearchProfileId IN (SELECT SearchProfileId FROM #SearchProfileId)
	DELETE FROM ZnodeSearchProfileFeatureMapping WHERE SearchProfileId IN (SELECT SearchProfileId FROM #SearchProfileId)
	DELETE FROM ZnodeSearchProfileFieldValueFactor WHERE SearchProfileId IN (SELECT SearchProfileId FROM #SearchProfileId)
	DELETE FROM ZnodeSearchProfileProductMapping WHERE SearchProfileId IN (SELECT SearchProfileId FROM #SearchProfileId)
	DELETE FROM ZnodeSearchProfileTrigger WHERE SearchProfileId IN (SELECT SearchProfileId FROM #SearchProfileId)
	UPDATE ZnodeSearchActivity SET SearchProfileId = NULL WHERE SearchProfileId IN (SELECT SearchProfileId FROM #SearchProfileId)
	DELETE FROM ZnodeSearchProfile WHERE SearchProfileId IN (SELECT SearchProfileId FROM #SearchProfileId)
END

GO

INSERT INTO ZnodeManageConditionalDefaultData (ConditionalCode,ConditionalName,DataSource,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 'DeleteOldSearchProfileDuringDatabaseUpgradeOneTime',
	'This is only for delete old search profile and its references data from respective tables during upgrade of existing database & this will execute only one time. This record will used to ignore delete records during fresh database creation.'
		,'Upgrade Database',1,2, GETDATE(),2 , GETDATE()
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeManageConditionalDefaultData WHERE ConditionalCode = 'DeleteOldSearchProfileDuringDatabaseUpgradeOneTime' AND IsActive=1);

GO

insert into ZnodeSearchFeature(ParentSearchFeatureId,FeatureCode,FeatureName,IsAdvanceFeature,ControlType,HelpDescription
,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select null,'MinGram','Min Gram',0,'Text','Used to break a text into words, this is helpful to create tokens(set of words) that can be used to search the desired output in search results. 
Define minimum character length for the search tokens to be generated here. Default N-gram setting should be used for better results. In case if the default setting is changed then unexpected results can occur.',
2,getdate(),2,getdate()
where not exists(select * from ZnodeSearchFeature where FeatureCode = 'MinGram' )

insert into ZnodeSearchQueryTypeFeature (SearchFeatureId,SearchQueryTypeId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select (select top 1 SearchFeatureId from ZnodeSearchFeature where FeatureCode = 'MinGram'),
(select top 1 SearchQueryTypeId from ZnodeSearchQueryType where QueryTypeName = 'Multi Match'),
2,getdate(),2,GETDATE()
where not exists(select * from ZnodeSearchQueryTypeFeature
where SearchFeatureId = (select top 1 SearchFeatureId from ZnodeSearchFeature where FeatureCode = 'MinGram')
and SearchQueryTypeId = (select top 1 SearchQueryTypeId from ZnodeSearchQueryType where QueryTypeName = 'Multi Match')
)

insert into ZnodeSearchFeature(ParentSearchFeatureId,FeatureCode,FeatureName,IsAdvanceFeature,ControlType,HelpDescription
,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select null,'MaxGram','Max Gram',0,'Text','Used to break a text into words, this is helpful to create tokens(set of words) that can be used to search the desired output in search results. 
Define maximum character length for the search tokens to be generated here. Default N-gram setting should be used for better results. In case if the default setting is changed then unexpected results can occur.',
2,getdate(),2,getdate()
where not exists(select * from ZnodeSearchFeature where FeatureCode = 'MaxGram' )

insert into ZnodeSearchQueryTypeFeature (SearchFeatureId,SearchQueryTypeId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select (select top 1 SearchFeatureId from ZnodeSearchFeature where FeatureCode = 'MaxGram'),
(select top 1 SearchQueryTypeId from ZnodeSearchQueryType where QueryTypeName = 'Multi Match'),
2,getdate(),2,GETDATE()
where not exists(select * from ZnodeSearchQueryTypeFeature
where SearchFeatureId = (select top 1 SearchFeatureId from ZnodeSearchFeature where FeatureCode = 'MaxGram')
and SearchQueryTypeId = (select top 1 SearchQueryTypeId from ZnodeSearchQueryType where QueryTypeName = 'Multi Match')
)

insert into ZnodeSearchFeature(ParentSearchFeatureId,FeatureCode,FeatureName,IsAdvanceFeature,ControlType,HelpDescription
,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select null,'CharacterFilter','Character Filter',0,'Text','Define a mapping for special characters where the format should be original special character => alternate/replaced by character, i.e. - => &',
2,getdate(),2,getdate()
where not exists(select * from ZnodeSearchFeature where FeatureCode = 'CharacterFilter' )

insert into ZnodeSearchQueryTypeFeature (SearchFeatureId,SearchQueryTypeId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select (select top 1 SearchFeatureId from ZnodeSearchFeature where FeatureCode = 'CharacterFilter'),
(select top 1 SearchQueryTypeId from ZnodeSearchQueryType where QueryTypeName = 'Multi Match'),
2,getdate(),2,GETDATE()
where not exists(select * from ZnodeSearchQueryTypeFeature
where SearchFeatureId = (select top 1 SearchFeatureId from ZnodeSearchFeature where FeatureCode = 'CharacterFilter')
and SearchQueryTypeId = (select top 1 SearchQueryTypeId from ZnodeSearchQueryType where QueryTypeName = 'Multi Match')
)

SET IDENTITY_INSERT dbo.ZnodeSearchProfile ON
INSERT INTO dbo.ZnodeSearchProfile (SearchProfileId, ProfileName, SearchQueryTypeId, SearchSubQueryTypeId, 
	Operator, IsDefault, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate) 
SELECT 1, N'ZnodeSearchProfile', 5, 7, N'AND', 1, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeSearchProfile WHERE ProfileName='ZnodeSearchProfile')
SET IDENTITY_INSERT dbo.ZnodeSearchProfile OFF

INSERT INTO ZnodeSearchProfileFeatureMapping (SearchProfileId,SearchFeatureId,SearchFeatureValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 SearchProfileId FROM ZnodeSearchProfile WHERE ProfileName='ZnodeSearchProfile'),
(SELECT TOP 1 SearchFeatureId FROM ZnodeSearchFeature WHERE FeatureCode='AutoCorrect'),
'False',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS (	SELECT TOP 1 1 FROM ZnodeSearchProfileFeatureMapping
					WHERE SearchProfileId=(SELECT TOP 1 SearchProfileId FROM ZnodeSearchProfile WHERE ProfileName='ZnodeSearchProfile')
						AND SearchFeatureId=(SELECT TOP 1 SearchFeatureId FROM ZnodeSearchFeature WHERE FeatureCode='AutoCorrect')
				)
	AND EXISTS (SELECT TOP 1 SearchFeatureId FROM ZnodeSearchFeature WHERE FeatureCode='AutoCorrect')

INSERT INTO ZnodeSearchProfileFeatureMapping (SearchProfileId,SearchFeatureId,SearchFeatureValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 SearchProfileId FROM ZnodeSearchProfile WHERE ProfileName='ZnodeSearchProfile'),
(SELECT TOP 1 SearchFeatureId FROM ZnodeSearchFeature WHERE FeatureCode='MinGram'),
'1',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS (	SELECT TOP 1 1 FROM ZnodeSearchProfileFeatureMapping
					WHERE SearchProfileId=(SELECT TOP 1 SearchProfileId FROM ZnodeSearchProfile WHERE ProfileName='ZnodeSearchProfile')
						AND SearchFeatureId=(SELECT TOP 1 SearchFeatureId FROM ZnodeSearchFeature WHERE FeatureCode='MinGram')
				)
	AND EXISTS (SELECT TOP 1 SearchFeatureId FROM ZnodeSearchFeature WHERE FeatureCode='MinGram')

INSERT INTO ZnodeSearchProfileFeatureMapping (SearchProfileId,SearchFeatureId,SearchFeatureValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 SearchProfileId FROM ZnodeSearchProfile WHERE ProfileName='ZnodeSearchProfile'),
(SELECT TOP 1 SearchFeatureId FROM ZnodeSearchFeature WHERE FeatureCode='MaxGram'),
'40',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS (	SELECT TOP 1 1 FROM ZnodeSearchProfileFeatureMapping
					WHERE SearchProfileId=(SELECT TOP 1 SearchProfileId FROM ZnodeSearchProfile WHERE ProfileName='ZnodeSearchProfile')
						AND SearchFeatureId=(SELECT TOP 1 SearchFeatureId FROM ZnodeSearchFeature WHERE FeatureCode='MaxGram')
				)
	AND EXISTS (SELECT TOP 1 SearchFeatureId FROM ZnodeSearchFeature WHERE FeatureCode='MaxGram')

INSERT INTO ZnodeSearchProfileFeatureMapping (SearchProfileId,SearchFeatureId,SearchFeatureValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 SearchProfileId FROM ZnodeSearchProfile WHERE ProfileName='ZnodeSearchProfile'),
(SELECT TOP 1 SearchFeatureId FROM ZnodeSearchFeature WHERE FeatureCode='CharacterFilter'),
'"_ => ", "- => "',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS (	SELECT TOP 1 1 FROM ZnodeSearchProfileFeatureMapping
					WHERE SearchProfileId=(SELECT TOP 1 SearchProfileId FROM ZnodeSearchProfile WHERE ProfileName='ZnodeSearchProfile')
						AND SearchFeatureId=(SELECT TOP 1 SearchFeatureId FROM ZnodeSearchFeature WHERE FeatureCode='CharacterFilter')
				)
	AND EXISTS (SELECT TOP 1 SearchFeatureId FROM ZnodeSearchFeature WHERE FeatureCode='CharacterFilter')

DECLARE @SearchProfileId INT= (SELECT TOP 1 SearchProfileId FROM ZnodeSearchProfile WHERE ProfileName='ZnodeSearchProfile');
IF NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishSearchProfileEntity WHERE SearchProfileId = @SearchProfileId)
BEGIN
	EXEC Znode_PublishSearchProfileEntity @SearchProfileId=@SearchProfileId, @UserId=2;
END

GO

update ZnodeSearchProfile set SearchSubQueryTypeId=(select SearchQueryTypeId from ZnodeSearchQueryType where QueryTypeName='Cross'), Operator='AND'
where IsDefault=1 and ProfileName='ZnodeSearchProfile'
and not exists (select * from ZnodeSearchProfile where ProfileName='ZnodeSearchProfile' and SearchSubQueryTypeId = 7)

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportBrands')
	DROP PROC Znode_ImportBrands
GO

CREATE PROCEDURE [dbo].[Znode_ImportBrands](
	  @TableName			NVARCHAR(100), 
	  @Status				BIT OUT, 
	  @UserId				INT, 
	  @ImportProcessLogId	INT, 
	  @NewGUId				NVARCHAR(200),
	  @LocaleId	            INT= 1,
	  @CsvColumnString		NVARCHAR(max)
	  )
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Made a provision to import Brand details.
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN Brands;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate();
		IF isnull(@LocaleId,0)=0
		BEGIN
			SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		END
		-- Retrive RoundOff Value from global setting 

		Create TABLE #InsertBrandData 
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY,RowNumber int, BrandCode varchar(max),IsActive varchar(max), BrandDescription varchar(max) default null,
			SEOKeyword varchar(max) default null,SEODescription varchar(max) default null, BrandLogo varchar(max) default null,SEOTitle varchar(max) default null,
			SEOFriendlyPageName varchar(max) default null,URLKey varchar(max) default null, Custom1 varchar(max) default null,Custom2 varchar(max) default null,
			Custom3 varchar(max) default null,Custom4 varchar(max) default null,Custom5 varchar(max) default null, GUID nvarchar(400)
		);	
			
		SET @SSQL = 'INSERT INTO #InsertBrandData( RowNumber,' + @CsvColumnString + ',GUID)
		             SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+ @TableName;		
		EXEC sys.sp_sqlexec @SSQL;

		SELECT BrandCode 
		INTO #DuplicateBrandData 
		FROM #InsertBrandData 
		Group BY BrandCode  having count(*) > 1
		
		-- Start Functional Validation 
		-----------------------------------------------
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '53', 'BrandCode', BrandCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertBrandData AS ii
			   WHERE exists(SELECT * FROM #DuplicateBrandData bd where bd.BrandCode=ii.BrandCode)
			   And not exists(select * from  ZnodeBrandDetails zbd 
							  INNER JOIN #DuplicateBrandData bd on bd.BrandCode=zbd.BrandCode) 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '8', 'BrandCode', BrandCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertBrandData AS ii
			   WHERE isnull(BrandCode,'')=''			   
			  

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '121', 'BrandCode', BrandCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertBrandData AS ii
			   WHERE  not exists 
				   (
						select * from ZnodePimAttributeDefaultValue zpadv
						inner join ZnodePimAttribute zpa on zpa.PimAttributeId=zpadv.PimAttributeId
						where AttributeCode='Brand' and AttributeDefaultValueCode=ii.BrandCode
				   );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '8', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM #InsertBrandData AS ii  
			WHERE isnull(ii.IsActive,'')=''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM #InsertBrandData AS ii  
			WHERE isnull(ii.IsActive,'') not in ('True','1','Yes','FALSE','0','No')
			
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '82', 'SEOKeyword', SEOKeyword, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertBrandData AS ii
			  WHERE len(ltrim(rtrim(ii.SEOKeyword))) > 300 and isnull(ii.SEOKeyword,'')<>''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '82', 'SEODescription', SEODescription, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertBrandData AS ii
			   WHERE len(ltrim(rtrim(ii.SEODescription))) > 300 and isnull(ii.SEODescription,'')<>''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '45', 'BrandLogo', BrandLogo, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertBrandData AS ii			 
			   WHERE reverse(left(reverse(ii.BrandLogo),charindex('.',reverse(ii.BrandLogo)))) 
			   not in (select ValidationName from View_FamilyExtensions where FamilyCode='Image')
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '45', 'BrandLogo', BrandLogo, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertBrandData AS ii			 
			   WHERE isnull(BrandLogo,'')<>'' and not exists (select * from ZnodeMedia where FileName=ii.BrandLogo)

  
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '81', 'SEOTitle', SEOTitle, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertBrandData AS ii
			   WHERE len(ltrim(rtrim(ii.SEOTitle))) > 200 and isnull(ii.SEOTitle,'')<>''		
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '102', 'SEOFriendlyPageName', SEOFriendlyPageName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM #InsertBrandData AS ii  
			WHERE (isnull(ii.SEOFriendlyPageName,'') LIKE '%[^a-zA-Z0-9]%' and  isnull(ii.SEOFriendlyPageName,'') NOT LIKE '%[_-]%' )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '81', 'URLKey', URLKey, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM #InsertBrandData AS ii  
			WHERE len(ltrim(rtrim(ii.URLKey))) > 200 and isnull(ii.URLKey,'')<>''			


		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ Brand - ' + ISNULL(BrandCode,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN #InsertBrandData IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM #InsertBrandData
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertBrandData
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;
		
		--<Begin Data Updation>
		CREATE TABLE #InsertedBrands (BrandId INT,BrandCode nvarchar(100),CMSSEODetailId int ) 
		
		UPDATE zbd set WebsiteLink=isnull(ibd.URLKey,WebsiteLink),IsActive=isnull(ibd.IsActive,zbd.IsActive),ModifiedBy=@UserId,
					   ModifiedDate=Getdate(),Custom1=isnull(ibd.Custom1,zbd.custom1),Custom2=isnull(ibd.Custom2,zbd.custom2),Custom3=isnull(ibd.Custom3,zbd.custom3),Custom4=isnull(ibd.Custom4,zbd.custom4),
					   Custom5=ISNULL(ibd.Custom5, zbd.Custom5)      
		OUTPUT INSERTED.BrandId ,INSERTED.BrandCode INTO  #InsertedBrands (BrandId, BrandCode)
		from ZnodeBrandDetails zbd
		inner join #InsertBrandData IBD on ibd.BrandCode=zbd.BrandCode
		where ibd.RowNumber=(select max(RowNumber) from #InsertBrandData a where a.BrandCode=zbd.BrandCode)

		UPDATE zbdl set zbdl.BrandId=zbd.BrandId,zbdl.Description=isnull(ibd.BrandDescription,zbdl.Description),SEOFriendlyPageName=isnull(IBD.SEOFriendlyPageName,zbdl.SEOFriendlyPageName),
		LocaleId=@LocaleId,ModifiedBy=@UserId,ModifiedDate=getdate(),BrandName=isnull(ibd.BrandCode,zbdl.BrandName)
		FROM ZnodeBrandDetailLocale zbdl
		inner join ZnodeBrandDetails zbd on zbd.BrandId=zbdl.BrandId
		inner join #InsertBrandData IBD on ibd.BrandCode=zbd.BrandCode
		inner join #InsertedBrands ib on ib.BrandId=zbdl.BrandId
		where ibd.RowNumber=(select max(RowNumber) from #InsertBrandData a where a.BrandCode=zbd.BrandCode)

		UPDATE ZCD set SEOId=ib.BrandId,SEOUrl=isnull(ibd.SEOFriendlyPageName,zcd.SEOUrl),ModifiedBy=@UserId,ModifiedDate=getdate(),
					   SEOCode=isnull(ibd.BrandCode,zcd.SEOCode)
		OUTPUT INSERTED.SEOId ,INSERTED.SEOCode, INSERTED.CMSSEODetailId INTO  #InsertedBrands (BrandId, BrandCode,CMSSEODetailId) 
		FROM ZnodeCMSSEODetail ZCD		
		inner join #InsertedBrands ib on ib.BrandId=ZCD.SEOId
		inner join #InsertBrandData IBD on ibd.BrandCode=zcd.SEOCode
		where exists (select null from ZnodeBrandDetailLocale zbdl where zbdl.BrandId=ZCD.SEOId)
		and ibd.RowNumber=(select max(RowNumber) from #InsertBrandData a where a.BrandCode=zcd.SEOCode)
		
		--<Delete Records Having Null Value>
		Delete from #InsertedBrands where isnull(CMSSEODetailId,0)=0
		--</Delete Records Having Null Value>
		
		UPDATE zcdl set CMSSEODetailId =isnull(ib.CMSSEODetailId,zcdl.CMSSEODetailId),LocaleId=@LocaleId,SEOTitle=isnull(ibd.SEOTitle,zcdl.SEOTitle),
						SEODescription=isnull(ibd.SEODescription,zcdl.SEODescription),SEOKeywords=isnull(ibd.SEOKeyword,zcdl.SEOKeywords),ModifiedBy=@UserId,ModifiedDate=getdate()
		FROM ZnodeCMSSEODetailLocale zcdl
		inner join #InsertedBrands ib on ib.CMSSEODetailId=zcdl.CMSSEODetailId
		inner join #InsertBrandData IBD on ibd.BrandCode=ib.BrandCode
		and ibd.RowNumber=(select max(RowNumber) from #InsertBrandData a 
		inner join ZnodeBrandDetails zcd on  a.BrandCode=zcd.BrandCode)

		--</End Data Updation>

		--<Begin Data Insert>
		insert into ZnodeBrandDetails(BrandCode,MediaId,WebsiteLink,DisplayOrder,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Custom1,Custom2,Custom3,
										Custom4,Custom5)
		OUTPUT INSERTED.BrandId ,INSERTED.BrandCode INTO  #InsertedBrands (BrandId, BrandCode) 		
		Select ibd.BrandCode,(select top 1 MediaId from ZnodeMedia where FileName=ibd.BrandLogo order by CreatedDate desc),ibd.URLKey,0,ibd.IsActive,@UserId,GETDATE(),@UserId,Getdate(),ibd.Custom1,ibd.Custom2,ibd.Custom3,ibd.Custom4,ibd.Custom5
		from #InsertBrandData IBD	
		WHERE NOT EXISTS(SELECT * FROM ZnodeBrandDetails ZBD WHERE ZBD.BrandCode = IBD.BrandCode )		

		insert into ZnodeBrandDetailLocale (BrandId,Description,SEOFriendlyPageName,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,BrandName)
		select ac.BrandId,ibdl.BrandDescription,ibdl.SEOFriendlyPageName,@LocaleId,@UserId,getdate(),@UserId,GETDATE(),ibdl.BrandCode 
		from #InsertBrandData IBDL
		INNER JOIN #InsertedBrands ac on ac.BrandCode=ibdl.BrandCode
		WHERE NOT EXISTS(SELECT * FROM ZnodeBrandDetailLocale a 
							INNER JOIN ZnodeBrandDetails b on  b.BrandCode=ibdl.BrandCode AND a.BrandId=b.BrandId )	

		insert into ZnodeCMSSEODetail (CMSSEOTypeId,SEOId,SEOUrl,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SEOCode,PublishStateId)
		OUTPUT INSERTED.SEOId ,INSERTED.SEOCode, INSERTED.CMSSEODetailId INTO  #InsertedBrands (BrandId, BrandCode,CMSSEODetailId)
		select (select CMSSEOTypeId  from ZnodeCMSSEOType where Name = 'Brand'),ac.BrandId,ibdl.SEOFriendlyPageName,@UserId,getdate(),@UserId,getdate(),ibdl.BrandCode,'2'
		from #InsertBrandData IBDL
		INNER JOIN #InsertedBrands ac on ac.BrandCode=ibdl.BrandCode
		WHERE NOT EXISTS(SELECT * FROM ZnodeCMSSEODetail a 
							INNER JOIN ZnodeBrandDetails b on b.BrandCode=ibdl.BrandCode 
							where a.SEOCode=ibdl.BrandCode
							AND a.CMSSEOTypeId=(select CMSSEOTypeId  from ZnodeCMSSEOType where Name = 'Brand')  )
		
		--<Delete Records Having Null Value>
		Delete from #InsertedBrands where isnull(CMSSEODetailId,0)=0
		--</Delete Records Having Null Value>

		insert into ZnodeCMSSEODetailLocale (CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		select ac.CMSSEODetailId ,@LocaleId,ibdl.SEOTitle,ibdl.SEODescription,ibdl.SEOKeyword,@UserId,GETDATE(),@UserId,Getdate()
		from #InsertBrandData IBDL
		INNER JOIN #InsertedBrands ac on ac.BrandCode=ibdl.BrandCode
		WHERE NOT EXISTS(SELECT * FROM ZnodeCMSSEODetailLocale a 
							INNER JOIN ZnodeCMSSEODetail b on a.CMSSEODetailId=b.CMSSEODetailId and b.SEOCode=ibdl.BrandCode
							INNER JOIN ZnodeBrandDetails c on c.BrandCode=ibdl.BrandCode 
							AND b.CMSSEOTypeId=(select CMSSEOTypeId  from ZnodeCMSSEOType where Name = 'Brand')  )		
        --<End Data Insert>

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN Brands;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN Brands

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		 DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportBrands @TableName = '+CAST(@TableName AS VARCHAR(max)) +',
		 @Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@LocaleId='+CAST(@LocaleId AS VARCHAR(200))+',
		 @CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max)) ;

		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportBrands',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportValidatePimProductData')
	DROP PROC Znode_ImportValidatePimProductData
GO

CREATE PROCEDURE [dbo].[Znode_ImportValidatePimProductData]
(   @ImportHeadName     VARCHAR(200),
    @TableName          VARCHAR(200),
    @NewGUID            NVARCHAR(200),
    @TemplateId         INT,
    @UserId             INT,
    @LocaleId           INT           = 1,
    @IsCategory         INT           = 0,
    @DefaultFamilyId    INT           = 0,
    @ImportProcessLogId INT,
    @PriceListId        INT,
	@CountryCode VARCHAR(100) = '',
	@PimCatalogId         INT    = 0 ,
	@PortalId int = 0,
	@IsAccountAddress bit = 0 )
AS
     SET NOCOUNT ON;

/*
    Summary :   Import PimProduct / Price / Inventory / Category / Category Associated Data 
    Process :   Admin site will upload excel / csv file in database and create global temporary table
				Procedure Znode_ImportValidatePimProductData will validate data with attribute validation rule
				If datatype validation issue found in input daata will logged into table "ZnodeImportLog"
				If Data is correct and record count in table ZnodeImportLog will be 0 then process for import data into Base tables
				To import data call procedure "Znode_ImportPimProductData"
    		  
				SourceColumnName: CSV file column headers
				TargetColumnName: Attributecode from ZnodePimAttribute Table (Consider those Attributecodes configured with default family only)
*/

     BEGIN
         BEGIN TRY
             SET NOCOUNT ON;
             --BEGIN TRAN TRN_ImportValidProductData;
             DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
             DECLARE @SQLQuery NVARCHAR(MAX), @AttributeTypeName NVARCHAR(100), @AttributeCode NVARCHAR(300), @AttributeId INT, @IsRequired BIT, @SourceColumnName NVARCHAR(600), @ControlName VARCHAR(300), @ValidationName VARCHAR(100), @SubValidationName VARCHAR(300), @ValidationValue VARCHAR(300), @RegExp VARCHAR(300), @CreateDateString NVARCHAR(300), @DefaultLocaleId INT, @ImportHeadId INT, @CheckedSourceColumn NVARCHAR(600)= '', @Status BIT= 0,
			    @CsvColumnString nvarchar(max),
				@FailedRecordCount BIGINT,
				@SuccessRecordCount BIGINT
            --To get the total record count for update purpose in catch block
            SET @SQLQuery = 'SELECT '+CAST(@ImportProcessLogId AS VARCHAR(10))+',COUNT(*) FROM '+@TableName
			INSERT INTO Znode_ImportCsvRowCount
			EXEC (@SQLQuery) 

             DECLARE @FamilyAttributeDetail TABLE
             (PimAttributeId       INT,
              AttributeTypeName    VARCHAR(300),
              AttributeCode        VARCHAR(300),
              SourceColumnName     NVARCHAR(600),
              IsRequired           BIT,
              PimAttributeFamilyId INT
             );
             DECLARE @AttributeDetail TABLE
             (PimAttributeId    INT,
              AttributeTypeName VARCHAR(300),
              AttributeCode     VARCHAR(300),
              SourceColumnName  NVARCHAR(600),
              IsRequired        BIT,
              ControlName       VARCHAR(300),
              ValidationName    VARCHAR(100),
              SubValidationName VARCHAR(300),
              ValidationValue   VARCHAR(300),
              RegExp            VARCHAR(300)
             );

			CREATE TABLE #DefaultAttributeCode
			(AttributeTypeName          VARCHAR(300),
			PimAttributeDefaultValueId INT,
			PimAttributeId             INT,
			AttributeDefaultValueCode  VARCHAR(100)
			);

			IF( @ImportHeadName = 'B2BCustomer' )
			BEGIN
				EXEC ZnodeB2BCustomerMapping @ImportHeadName = @ImportHeadName, @TableName = @TableName
			END
		
             DECLARE @GlobalTempTableColumns TABLE(ColumnName NVARCHAR);
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM INFORMATION_SCHEMA.TABLES
                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#InvalidDefaultData'
             )
                 CREATE TABLE #InvalidDefaultData
                 (RowNumber  INT,
                  Value      NVARCHAR(MAX),
                  ColumnName NVARCHAR(600)
                 );
             ELSE
             DROP TABLE #InvalidDefaultData;
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM INFORMATION_SCHEMA.TABLES
                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#GlobalTempTableColumns'
             )
                 BEGIN

                     SET @SQLQuery = 'SELECT Column_Name, '''+@ImportHeadName+''' AS ImportHeadName  from tempdb.INFORMATION_SCHEMA.COLUMNS	where table_name = object_name(object_id('''+@TableName+'''),
					(select database_id from sys.databases where name = ''tempdb''))';
                     CREATE TABLE #GlobalTempTableColumns
                     (ColumnName   NVARCHAR(MAX),
                      TypeOfImport NVARCHAR(100)
                     );
                     INSERT INTO #GlobalTempTableColumns
                     (ColumnName,
                      TypeOfImport
                     )
                     EXEC sys.sp_sqlexec
                          @SQLQuery;
                 END;

             IF EXISTS
             (
                 SELECT TOP 1 1
                 FROM #GlobalTempTableColumns
                 WHERE ColumnName IN('PimCategoryId', 'PimProductId', 'RowNumber')
             )
                 BEGIN
                     INSERT INTO ZnodeImportLog
                     (ErrorDescription,
                      ColumnName,
                      Data,
                      GUID,
                      CreatedBy,
                      CreatedDate,
                      ModifiedBy,
                      ModifiedDate,
                      ImportProcessLogId
                     )
                     VALUES
                     (43,
                      '',
                      '',
                      @newGUID,
                      @UserId,
                      @GetDate,
                      @UserId,
                      @GetDate,
                      @ImportProcessLogId
                     );
                 END;
             SET @DefaultLocaleId = dbo.Fn_GetDefaultLocaleId();

             IF NOT EXISTS
             (
                 SELECT TOP 1 1  FROM ZnodeImportLog
                 WHERE Guid = @NewGUID
                       AND ErrorDescription IN(43, 42)
                 AND ImportProcessLogId = @ImportProcessLogId
             )
                 BEGIN
                     IF @ImportHeadName = 'Product'
                      BEGIN
						  IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
							  SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimProductId int null ';
						  ELSE 
							 SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimProductId int null Primary KEY CLUSTERED(RowNumber)';
						 
						  EXEC sys.sp_sqlexec @SQLQuery;
			         END;
                     ELSE
                     IF @ImportHeadName = 'Category'
                         BEGIN
							  IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimCategoryId int null ';
							  ElSE
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimCategoryId int null Primary KEY CLUSTERED(RowNumber) ';
						  
							  EXEC sys.sp_sqlexec @SQLQuery;
                         END;
                     ELSE
                         BEGIN
							IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1) ';
							Else 
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1) Primary KEY CLUSTERED(RowNumber)';
							
							EXEC sys.sp_sqlexec @SQLQuery;
                         END;;
                 END;

             SET @CreateDateString = CONVERT(VARCHAR(100), @UserId)+','''+CONVERT(VARCHAR(100), @GetDate)+''','+CONVERT(VARCHAR(100), @UserId)+','''+CONVERT(VARCHAR(100), @GetDate)+''', '+CONVERT(VARCHAR(100), @ImportProcessLogId);

             SELECT TOP 1 @ImportHeadId = ImportHeadId FROM ZnodeImportTemplate WHERE ImportTemplateId = @TemplateId;
             IF @DefaultFamilyId = 0
                AND @ImportHeadName IN('Product', 'Category')
                 BEGIN 
                     --Get all default attribute values in attribute 
                     INSERT INTO @FamilyAttributeDetail
                     (PimAttributeId,
                      AttributeTypeName,
                      AttributeCode,
                      SourceColumnName,
                      IsRequired,
                      PimAttributeFamilyId
                     )
                     --Call Process to insert data of defeult family with source column name and target column name 
                     EXEC Znode_ImportGetTemplateDetails
                          @TemplateId = @TemplateId,
                          @IsValidationRules = 0,
                          @IsIncludeRespectiveFamily = 1,
                          @IsCategory = @IsCategory,
                          @DefaultFamilyId = @DefaultFamilyId;

					---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;
             ELSE
             IF @ImportHeadName IN('Product', 'Category')
                 BEGIN
				 
                     --Get all default attribute values in attribute 
                     INSERT INTO @FamilyAttributeDetail
                     (PimAttributeId,
                      AttributeTypeName,
                      AttributeCode,
                      SourceColumnName,
                      IsRequired,
                      PimAttributeFamilyId
                     )
                     --Call Process to insert data of defeult family with source column name and target column name 
                     EXEC Znode_ImportGetTemplateDetails
                          @TemplateId = @TemplateId,
                          @IsValidationRules = 0,
                          @IsIncludeRespectiveFamily = 1,
                          @IsCategory = @IsCategory,
                          @DefaultFamilyId = @DefaultFamilyId;

					---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;      
             -- Check attributes are manditory and not provided with source table
		   	 
			if @TABLENAME	like '%tempdb..%'
				SET @SQLQuery = 'SELECT 42 AS ErrorDescription , SourceColumnName , '''' , '''+@NewGUID+''','+@CreateDateString+' from ZnodeImportTemplateMapping where ImportTemplateId = '+CONVERT(VARCHAR(100), @TemplateId)+' and ltrim(rtrim(SourceColumnName)) <> '''' AND ltrim(rtrim(SourceColumnName)) not in ( select isnull(Name ,'''') from tempdb.sys.columns where object_id = object_id('''+@TABLENAME+'''));';
			else 
				SET @SQLQuery = 'SELECT 42 AS ErrorDescription , SourceColumnName , '''' , '''+@NewGUID+''','+@CreateDateString+' from ZnodeImportTemplateMapping where ImportTemplateId = '+CONVERT(VARCHAR(100), @TemplateId)+' and ltrim(rtrim(SourceColumnName)) <> '''' AND ltrim(rtrim(SourceColumnName)) not in ( select isnull(Name ,'''') from sys.columns where object_id = object_id('''+@TABLENAME+'''));';
		 
			Declare @Tbl_CsvDynamicColulmns TABLE (ColumnName nvarchar(300), SequenceNumber int, DataType nvarchar(50),IsRequired bit )

			INSERT INTO @Tbl_CsvDynamicColulmns(ColumnName , SequenceNumber , DataType ,IsRequired)
			SELECT DISTINCT ZITM.SourceColumnName ,ZIAV.SequenceNumber, ZIAV.AttributeTypeName, ZIAV.IsRequired
			FROM ZnodeImportAttributeValidation ZIAV LEFT OUTER JOIN 
			ZnodeImportTemplate  ZIT ON ZIT.ImportHeadId =  ZIAV.ImportHeadId AND ZIT.ImportTemplateId  = @TemplateId
			LEFT OUTER JOIN ZnodeImportTemplateMapping  ZITM ON ZITM.ImportTemplateId = ZIT.ImportTemplateId  
			and ZIAV.AttributeCode = ZITM.TargetColumnName
			AND ZITM.ImportTemplateId  = @TemplateId
			WHERE ZIAV.ImportHeadId = @ImportHeadId
			AND ISNULL(ZITM.SourceColumnName,'') <> ''--ORDER BY ZIAV.SequenceNumber


		    SELECT @CsvColumnString = SUBSTRING ((Select ',' +  ISNULL(ColumnName ,'NULL') from @Tbl_CsvDynamicColulmns ORDER BY SequenceNumber FOR XML PATH ('')),2,4000) 


     		INSERT INTO ZnodeImportLog(ErrorDescription, ColumnName, Data, GUID,CreatedBy, CreatedDate,  ModifiedBy,ModifiedDate,ImportProcessLogId
             )
             EXEC sys.sp_sqlexec  @SQLQuery;
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM ZnodeImportLog
                 WHERE Guid = @NewGUID
                       AND ErrorDescription IN(43, 42)
                 AND ImportProcessLogId = @ImportProcessLogId
             )
                 BEGIN
                     --Get all default attribute values in attribute 
                     IF @ImportHeadName IN('Product', 'Category')
                         BEGIN
                             -- Check attributes are manditory and not provided with source table
                             INSERT INTO ZnodeImportLog
                             (ErrorDescription,
                              ColumnName,
                              Data,
                              GUID,
                              CreatedBy,
                              CreatedDate,
                              ModifiedBy,
                              ModifiedDate,
                              ImportProcessLogId
                             )
                                    SELECT '14' AS ErrorDescription,
                                           AttributeCode,
                                           '',
                                           @NewGUID,
                                           @UserId,
                                           @GetDate,
                                           @UserId,
                                           @GetDate,
                                           @ImportProcessLogId
                                    FROM @FamilyAttributeDetail
                                    WHERE ISNULL(SourceColumnName, '') = ''
                                          AND IsRequired = 1;  

                             -- Read all attribute details with their datatype
                             INSERT INTO @AttributeDetail
                             (PimAttributeId,
                              AttributeTypeName,
                              AttributeCode,
                              SourceColumnName,
                              IsRequired,
                              ControlName,
                              ValidationName,
                              SubValidationName,
                              ValidationValue,
                              RegExp
                             )
                             EXEC Znode_ImportGetTemplateDetails
                                  @TemplateId=@TemplateId,
								  @DefaultFamilyId=@DefaultFamilyId;

							---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
							Delete FAD from @AttributeDetail FAD
							where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
							and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
										   inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode) 

                             DELETE FROM @AttributeDetail
                             WHERE AttributeTypeName = 'Image'
                                   AND ValidationName <> 'IsAllowMultiUpload';
							DELETE FROM @AttributeDetail
                             WHERE AttributeTypeName = 'File'
                                   AND ValidationName <> 'IsAllowMultiUpload';

                                     INSERT INTO #DefaultAttributeCode
                                     (AttributeTypeName,
                                      PimAttributeDefaultValueId,
                                      PimAttributeId,
                                      AttributeDefaultValueCode
                                     )
                                     --Call Process to insert default data value 
                                     EXEC Znode_ImportGetPimAttributeDefaultValue;

                                     DELETE FROM #DefaultAttributeCode
                                     WHERE AttributeTypeName = 'Yes/No';

                         END;
                     ELSE
                         BEGIN
					
					
                             --Read all attribute details with their datatype
                             INSERT INTO @AttributeDetail
                             (AttributeTypeName,
                              AttributeCode,
                              SourceColumnName,
                              IsRequired,
                              ControlName,
                              ValidationName,
                              SubValidationName,
                              ValidationValue,
                              RegExp
                             )
                             EXEC [Znode_ImportGetOtherTemplateDetails]
                                  @TemplateId = @TemplateId,
                                  @ImportHeadId = @ImportHeadId;

							IF @ImportHeadName IN('B2BCustomer')
							BEGIN

								INSERT INTO @AttributeDetail
								 (PimAttributeId,
								 AttributeTypeName,
								  AttributeCode,
								  SourceColumnName,
								  IsRequired,
								  ControlName,
								  ValidationName,
								  SubValidationName,
								  ValidationValue,
								  RegExp
								 )
								 EXEC [Znode_ImportGetGlobalTemplateDetails]
									  @TemplateId = @TemplateId,
									  @ImportHeadId = @ImportHeadId;

								
								INSERT INTO #DefaultAttributeCode
								(AttributeTypeName,
								PimAttributeDefaultValueId,
								PimAttributeId,
								AttributeDefaultValueCode
								)
								--Call Process to insert default data value 
								EXEC Znode_ImportGetGlobalAttributeDefaultValue;

								DELETE FROM #DefaultAttributeCode
								WHERE AttributeTypeName = 'Yes/No';

							END
						
                             --Check attributes are not mapped with any family of Pim Product
                             INSERT INTO ZnodeImportLog
                             (ErrorDescription,
                              ColumnName,
                              Data,
                              GUID,
                              CreatedBy,
                              CreatedDate,
                              ModifiedBy,
                              ModifiedDate,
                              ImportProcessLogId
                             )
                                    SELECT DISTINCT
                                           '14' AS ErrorDescription,
                                           AttributeCode,
                                           '',
                                           @NewGUID,
                                           @UserId,
                                           @GetDate,
                                           @UserId,
                                           @GetDate,
                                           @ImportProcessLogId
                                    FROM @AttributeDetail
                                    WHERE ISNULL(SourceColumnName, '') = ''   AND IsRequired = 1;  ;

                         END;
						
                     --	Check attributes are not mapped with (Default / Other) family of Pim Product
                     --	INSERT INTO ZnodeImportLog ( ErrorDescription , ColumnName , Data , GUID , CreatedBy , CreatedDate , ModifiedBy , ModifiedDate , ImportProcessLogId)
                     --	SELECT '1' AS ErrorDescription , SourceColumnName , '' , @NewGUID , @UserId , @GetDate , @UserId , @GetDate , @ImportProcessLogId
                     --	FROM @AttributeDetail WHERE PimAttributeId NOT IN ( SELECT zpfgm.PimAttributeId FROM dbo.ZnodePimFamilyGroupMapper AS zpfgm);
                     --	Verify data in global temporary table (column wise)
					
                     DECLARE Cr_Attribute CURSOR LOCAL FAST_FORWARD
                     FOR SELECT PimAttributeId,
                                AttributeTypeName,
                                AttributeCode,
                                IsRequired,
                                SourceColumnName,
                                ControlName,
                                ValidationName,
                                SubValidationName,
                                ValidationValue,
                                RegExp
                         FROM @AttributeDetail
                         WHERE ISNULL(SourceColumnName, '') <> '';
                     OPEN Cr_Attribute;
                     FETCH NEXT FROM Cr_Attribute INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @ControlName, @ValidationName, @SubValidationName, @ValidationValue, @RegExp;
                     WHILE @@FETCH_STATUS = 0
                         BEGIN
				             IF @AttributeTypeName = 'Number'
                                 BEGIN
							      EXEC Znode_ImportValidateNumber
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @ImportHeadId = @ImportHeadId,
                                          @ImportProcessLogId = @ImportProcessLogId;
                                 END;
							 -- Check invalid date
							
                             IF @AttributeTypeName = 'Date'
                                 BEGIN
                                     EXEC Znode_ImportValidateDate
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @ImportHeadId = @ImportHeadId,
                                          @ImportProcessLogId = @ImportProcessLogId;
                                 END;
							 -- Check Manditory Data
		 					 IF @IsRequired = 1 AND @CheckedSourceColumn <> @SourceColumnName
								BEGIN
									SET @CheckedSourceColumn = @SourceColumnName;
									EXEC Znode_ImportValidateManditoryData
									@TableName = @TableName,
									@SourceColumnName = @SourceColumnName,
									@CreateDateString = @CreateDateString,
									@ValidationName = @ValidationName,
									@ControlName = @ControlName,
									@ValidationValue = @ValidationValue,
									@NewGUID = @NewGUID,
									@ImportHeadId = @ImportHeadId;
								END;
							 --END 
							
                             IF @AttributeTypeName = 'Text'
                                 BEGIN
								 
						              EXEC Znode_ImportValidateManditoryText
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @LocaleId = @LocaleId,
                                          @DefaultLocaleId = @DefaultLocaleId,
                                          @AttributeId = @AttributeId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @ImportHeadId = @ImportHeadId;
                                 END;
                             IF @AttributeTypeName in ( 'Image','File')
                                 BEGIN
                                     EXEC Znode_ImportValidateImageData
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @LocaleId = @LocaleId,
                                          @DefaultLocaleId = @DefaultLocaleId,
                                          @AttributeId = @AttributeId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @ImportHeadId = @ImportHeadId;
                                 END;

					

                             --Check Default data value is valid 
                             IF @ImportHeadName IN('Product', 'Category','B2BCustomer')
                                 BEGIN
                                     IF @AttributeId IN
                                     (
                                         SELECT PimAttributeId
                                         FROM #DefaultAttributeCode
                                     )
                                         BEGIN
							
                                            IF  @AttributeTypeName = 'Multi Select'
											 BEGIN
										 		 ---Verify Image file is exists in media table or not 
												 SET @SQLQuery = ' INSERT INTO #InvalidDefaultData (RowNumber, Value, ColumnName) 
												 SELECT ROWNUMBER , (Select TOP 1 Item from dbo.split(' + @SourceColumnName + ','','')  SP WHERE NOT EXISTS 
												 (Select ToP 1 1 FROM #DefaultAttributeCode DAC WHERE 
												  DAC.AttributeTypeName <> ''Yes/No'' AND DAC.AttributeDefaultValueCode IS NOT NULL AND DAC.PimAttributeId = 
												 ' + CONVERT(VARCHAR(100), @AttributeId) + ' AND ltrim(rtrim(SP.Item) ) = DAC.AttributeDefaultValueCode
												 )), ''' + @SourceColumnName + ''' as [ColumnName]  FROM ' + @TableName
												 + ' Where ISnull(' + @SourceColumnName +  ','''') <> '''''
												EXEC sys.sp_sqlexec @SQLQuery;
											  END
											  ELSE IF @AttributeTypeName = 'Simple Select'
											  BEGIN
						
												---Verify Image file is exists in media table or not 
												 SET @SQLQuery = ' INSERT INTO #InvalidDefaultData (RowNumber, Value, ColumnName) 
												 SELECT ROWNUMBER , ' + @SourceColumnName + ' , ''' + @SourceColumnName + ''' as [ColumnName]  FROM ' + @TableName
												 + ' SP Where ISnull(' + @SourceColumnName +  ','''') <> '''' AND 
												  NOT EXISTS 
												 (Select TOP 1 1 FROM #DefaultAttributeCode DAC WHERE 
												  DAC.AttributeTypeName <> ''Yes/No'' AND DAC.AttributeDefaultValueCode IS NOT NULL AND DAC.PimAttributeId = 
												 ' + CONVERT(VARCHAR(100), @AttributeId) + ' AND ltrim(rtrim(SP.' + @SourceColumnName + ') ) = DAC.AttributeDefaultValueCode ) '
							
												EXEC sys.sp_sqlexec @SQLQuery;
											  END   
												-- Check Invalid Image 
												 SET @SQLQuery = 'SELECT ''9 '' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], 
												 Value AS  AttributeValue,RowNumber ,'''+@NewGUID+''',  '+@CreateDateString+' FROM #InvalidDefaultData Where Value IS NOT NULL'
												 INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, RowNumber, GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
												 EXEC sys.sp_sqlexec @SQLQuery;
												 Delete from #InvalidDefaultData

       
                                         END;
                                 END;
							
                             FETCH NEXT FROM Cr_Attribute INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @ControlName, @ValidationName, @SubValidationName, @ValidationValue, @RegExp;
                         END;
                     CLOSE Cr_Attribute;
                     DEALLOCATE Cr_Attribute;
                     --SELECT top 1 1 FROM @FamilyAttributeDetail where  iSNULL(SourceColumnName,'') = ''  and IsRequired = 1
                 END;
             
			 
			  
------------------------------------------------------------------------------------------
		 Declare @SQLQueryNew NVARCHAR(4000)
		 Declare @SourceColumnNameProduct nvarchar(4000) 
         IF @ImportHeadName IN('Product','Pricing','ProductAssociation','Inventory')
		 BEGIN
		 	 
		 SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'SKU'
		 AND ImportTemplateId = @TemplateId


			SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  SKU - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;			
		END
		ELSE IF @ImportHeadName IN('ProductAttribute')
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'AttributeCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  Attribute - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'ZipCode'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'ZIP'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  ZIPCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'Category'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'CategoryCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  CategoryCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'CategoryAssociation'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'CategoryName'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  CategoryName - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;

		END
		ELSE IF @ImportHeadName IN ('Customer','CustomerAddress')
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'UserName'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  UserName - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'SEODetails'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'Code'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  Code - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'Highlight'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'HighlightCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  HighlightCode - '' + ' + ' cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'AddonAssociation'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'SKU'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  SKU - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'AttributeDefaultValue'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'AttributeDefaultValueCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  AttributeDefaultValueCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
        ELSE IF @ImportHeadName = 'Brands'  
        BEGIN  
        SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'BrandCode'  
        AND ImportTemplateId = @TemplateId  
  
            SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  BrandCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''   
            FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber   
            WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';  
            PRINT @SQLQueryNew  
           EXEC sys.sp_sqlexec  @SQLQueryNew;  
        END  
	-------------------------------------------------------------------------------------------------------------
	
	--------------------------------------------------------------------------------------------------------------------
			 
  		SET @SQLQuery = 'Delete FROM  '+@TableName+' Where Rownumber IN (Select Rownumber FROM ZnodeImportLog  WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND Rownumber IS NOT NULL)';
        EXEC sys.sp_sqlexec  @SQLQuery;
			 			
   
             IF @ImportHeadName IN('Product', 'Category')
                 BEGIN
                     IF NOT EXISTS
                     (
                         SELECT TOP 1 1
                         FROM @FamilyAttributeDetail
                         WHERE ISNULL(SourceColumnName, '') = ''
                               AND IsRequired = 1
                     ) AND NOT EXISTS
					 (
						 SELECT TOP 1 1
						 FROM ZnodeImportLog
						 WHERE Guid = @NewGUID
							   AND ErrorDescription IN(43, 42)
						 AND ImportProcessLogId = @ImportProcessLogId
					 )
                         BEGIN
                             IF @IsCategory = 0
                                 BEGIN

                                     EXEC Znode_ImportPimProductData
                                          @TableName = @TableName,
                                          @NewGUID = @NewGUID,
                                          @TemplateId = @TemplateId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @UserId = @UserId,
                                          @LocaleId = @LocaleId,
                                          @DefaultFamilyId = @DefaultFamilyId;

                                 END;
                             ELSE
                                 BEGIN
                                     EXEC Znode_ImportPimCategoryData
                                          @TableName = @TableName,
                                          @NewGUID = @NewGUID,
                                          @TemplateId = @TemplateId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @UserId = @UserId,
                                          @LocaleId = @LocaleId,
                                          @DefaultFamilyId = @DefaultFamilyId;
                                 END;
                         END
						 ELSE
							BEGIN
								-- Update Record count in log 
								
							
								--SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
								--EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount out
								--UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
								--WHERE ImportProcessLogId = @ImportProcessLogId;

								SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
								SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
								EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount out
								UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
								WHERE ImportProcessLogId = @ImportProcessLogId;
							END

                 END;
				IF NOT EXISTS
					 (
						 SELECT TOP 1 1
						 FROM ZnodeImportLog
						 WHERE Guid = @NewGUID
							   AND ErrorDescription IN(43, 42)
						 AND ImportProcessLogId = @ImportProcessLogId
					 )
             BEGIN
                 IF @ImportHeadName = 'Pricing'
                     BEGIN
                         EXEC [Znode_ImportPriceList]
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
                              @PriceListId = @PriceListId;
                     END;

                 IF @ImportHeadName = 'Inventory'
                     BEGIN
				
                         EXEC Znode_ImportInventory_Ver1
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID;
                     END;
                 IF @ImportHeadName = 'ZipCode'
                     BEGIN
						 EXEC Znode_ImportZipCode
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
							  @CountryCode = @CountryCode;
                     END;
					 IF @ImportHeadName = 'CategoryAssociation'
                     BEGIN
						 EXEC Znode_ImportCatalogCategory
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
							  @PimCatalogId = @PimCatalogId;
                     END;
					 IF @ImportHeadName = 'ProductAssociation'
                     BEGIN
						 EXEC Znode_ImportAssociateProducts
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID
                     END;
			
					 IF @ImportHeadName = 'SEODetails' AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportSEODetails
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
							  @LocaleId = @LocaleId,
							  @PortalId =@PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
							  @CsvColumnString = @CsvColumnString 

				
                     END;
				
					 IF @ImportHeadName = 'ProductAttribute' 
                     BEGIN
						 EXEC Znode_ImportAttributes
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
							  @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID
				
                     END;

					 IF @ImportHeadName = 'Customer' AND @PortalId > 0 
                     BEGIN
					
						 EXEC Znode_ImportCustomer
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = @PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
				
                     END;
					 
					 IF @ImportHeadName = 'UserApprovers' AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportUserApproval
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = @PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
				
                     END;

					 IF @ImportHeadName = 'B2BCustomer' AND @PortalId > 0 
                     BEGIN

							 EXEC Znode_ImportB2BCustomer
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = @PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
				
                     END;

					 IF @ImportHeadName = 'CustomerAddress' --AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportCustomerAddress
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = 7, -- not implemented from forntend 
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString,
							  @IsAccountAddress = @IsAccountAddress
				
                     END;
					 IF @ImportHeadName = 'ShippingAddress' --AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportCustomerAddress
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = 7, -- not implemented from forntend 
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString,
							  @IsAccountAddress = @IsAccountAddress
				
                     END;
					 IF @ImportHeadName = 'StoreLocator' --AND @PortalId > 0 
                     BEGIN
					 	 EXEC Znode_ImportStoreLocatorAddress
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
                     END;

					IF @ImportHeadName = 'Highlight'
					BEGIN
					EXEC Znode_ImportHighlight 
					@TableName = @TableName, 
					@Status = @Status, 
					@UserId = @UserId, 
					@ImportProcessLogId = @ImportProcessLogId, 
					@NewGUID = @NewGUID 
					END;

					IF @ImportHeadName = 'AddonAssociation'
					BEGIN
					EXEC Znode_ImportAddonAssociation 
					@TableName = @TableName, 
					@Status = @Status, 
					@UserId = @UserId, 
					@ImportProcessLogId = @ImportProcessLogId, 
					@NewGUID = @NewGUID,
					@PimCatalogId = @PimCatalogId
					END;

					IF @ImportHeadName = 'AttributeDefaultValue'
					BEGIN
					EXEC Znode_ImportAttributeDefaultValue 
					@TableName = @TableName, 
					@Status = @Status, 
					@UserId = @UserId, 
					@ImportProcessLogId = @ImportProcessLogId, 
					@NewGUID = @NewGUID
					
					END;

					IF @ImportHeadName = 'Voucher'
					BEGIN
						EXEC Znode_ImportVoucher 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID
					
					END;

					IF @ImportHeadName = 'Account'
					BEGIN
						
						EXEC Znode_ImportAccount 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID,
						@CsvColumnString = @CsvColumnString,
						@PortalId = @PortalId
					
					END;

					IF @ImportHeadName = 'Synonyms'
					BEGIN
						EXEC Znode_ImportSynonyms 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID
					END

					IF @ImportHeadName = 'CatalogCategoryAssociation'
					BEGIN
						EXEC Znode_ImportCatalogCategoryHierarchyAssociation 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID,
						@PimCatalogId = @PimCatalogId
					END
				 

                    IF @ImportHeadName = 'Brands'
					BEGIN
						EXEC Znode_ImportBrands 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID,
						@LocaleId	 = @LocaleId,
                        @CsvColumnString = @CsvColumnString
					END;
				 
             END
			 ELSE 
				 BEGIN
					-- Update Record count in log 	
					SET @SQLQuery = ' Select @FailedRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
					EXEC	sp_executesql @SQLQuery , N'@FailedRecordCount BIGINT out' , @FailedRecordCount =@FailedRecordCount out
					SELECT @SuccessRecordCount = 0
									
					UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
					WHERE ImportProcessLogId = @ImportProcessLogId;

				 END

             EXEC Znode_ImportReadErrorLog
                  @ImportProcessLogId = @ImportProcessLogId,
                  @NewGUID = @NewGUID;
             DROP TABLE #GlobalTempTableColumns;

             -- Finally call product insert process if error not found in error log table 
             IF EXISTS
             (
                 SELECT TOP 1 1
                 FROM ZnodeImportLog
                 WHERE ImportProcessLogId = @ImportProcessLogId
                       AND Guid = @NewGUID
             )
                 BEGIN
                    --Updating the import process status
					UPDATE ZnodeImportProcessLog
					SET Status = CASE WHEN ISNULL(FailedRecordcount,0) > 0 AND ISNULL(SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
										WHEN ISNULL(FailedRecordcount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
										WHEN ISNULL(FailedRecordcount,0) > 0 AND ISNULL(FailedRecordcount,0) = ISNULL(TotalProcessedRecords,0) THEN dbo.Fn_GetImportStatus( 3 )
									END, 
						ProcessCompletedDate = getdate()
					WHERE ImportProcessLogId = @ImportProcessLogId;
                 END;
				 SET @SQLQuery = 'IF Object_id(''+@TableName+'') IS NOT NULL  DROP TABLE ' + @TableName
                 EXEC sys.sp_sqlexec @SQLQuery;

				 print 'end';
         END TRY
         BEGIN CATCH
			DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE()
			DECLARE @TempCount TABLE (Id INT)

			Declare @SQL Varchar(max) = 'Select Count(*) As Id From '+@TableName
			INSERT INTO @TempCount
			EXEC (@SQL)

             SELECT ERROR_MESSAGE(),
                    ERROR_LINE(),
                    ERROR_PROCEDURE();
             EXEC Znode_ImportReadErrorLog
                  @ImportProcessLogId = @ImportProcessLogId,
                  @NewGUID = @NewGUID; 
             
			 ---Import process updating fail due to database error
			UPDATE ZnodeImportProcessLog
			SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
			WHERE ImportProcessLogId = @ImportProcessLogId;

			---Loging error for Import process due to database error
		    INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		    SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

			--Updating total and fail record count
		    UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		    TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		    WHERE ImportProcessLogId = @ImportProcessLogId;

			SET @SQLQuery = 'Drop Table ' + @TableName
            EXEC sys.sp_sqlexec @SQLQuery;
             --ROLLBACK TRAN TRN_ImportValidProductData;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeleteSearchProfile')
	DROP PROC Znode_DeleteSearchProfile
GO

CREATE PROCEDURE [dbo].[Znode_DeleteSearchProfile] 
(
	@SearchProfileId INT
) 
AS
/*
	Unit Testing
	EXEC dbo.Znode_DeleteSearchProfile @SearchProfileId=5
*/
BEGIN
	BEGIN TRAN DeleteSearchProfile;
		--DECLARE @Status BIT;
	BEGIN TRY
		SET NOCOUNT ON

		IF EXISTS (SELECT TOP 1 1 FROM ZnodeSearchProfile WHERE SearchProfileId=@SearchProfileId)
		BEGIN
			DELETE FROM ZnodePortalSearchProfile WHERE SearchProfileId=@SearchProfileId
			DELETE FROM ZnodePublishCatalogSearchProfile WHERE SearchProfileId=@SearchProfileId
			DELETE FROM ZnodeSearchProfileAttributeMapping WHERE SearchProfileId=@SearchProfileId
			DELETE FROM ZnodeSearchProfileFeatureMapping WHERE SearchProfileId=@SearchProfileId
			DELETE FROM ZnodeSearchProfileFieldValueFactor WHERE SearchProfileId=@SearchProfileId
			DELETE FROM ZnodeSearchProfileProductMapping WHERE SearchProfileId=@SearchProfileId
			DELETE FROM ZnodeSearchProfileTrigger WHERE SearchProfileId=@SearchProfileId
			DELETE FROM ZnodeSearchActivity WHERE SearchProfileId=@SearchProfileId
			DELETE FROM ZnodePublishSearchProfileEntity WHERE SearchProfileId=@SearchProfileId
			DELETE FROM ZnodeSearchProfile WHERE SearchProfileId=@SearchProfileId

			SELECT 1 As [Status];
		END
		ELSE
		BEGIN
			SELECT 0 As [Status];
		END

	COMMIT TRAN DeleteSearchProfile
	END TRY
	BEGIN CATCH
		SELECT 0 As [Status];

		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), 
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeleteSearchProfile @SearchProfileId='+ISNULL(CAST(@SearchProfileId AS VARCHAR(50)),'''');

		ROLLBACK TRAN DeleteSearchProfile 

		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_DeleteSearchProfile',
			@ErrorInProcedure = 'Znode_DeleteSearchProfile',
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetWebStoreSearchProfileTrigger')
	DROP PROC Znode_GetWebStoreSearchProfileTrigger
GO

CREATE PROCEDURE [dbo].[Znode_GetWebStoreSearchProfileTrigger]
(
	@Keyword NVARCHAR(100) = '',
    @ProfileId INT = '',
	@PublishCatalogId INT,
	@PortalId INT 
)
AS 
/*
	 Summary :- This Procedure is used to get the published search profile details. 
	 Unit Testig 
	 EXEC [Znode_GetWebStoreSearchProfileTrigger] 'Apple','1',3,1
*/
BEGIN 
	BEGIN TRY
	SET NOCOUNT ON 
		DECLARE @SearchProfileId INT , @DefaultSearchProfileId int  

		--Select @SearchProfileId=d.SearchProfileId 
		--from [ZnodeSearchProfileTrigger] d
		--inner join ZnodePublishCatalogSearchProfile c on c.SearchProfileId=d.SearchProfileId
		--Where d.Keyword=@Keyword
		--and d.ProfileId=@ProfileId
		--and c.PublishCatalogId=@PublishCatalogId

		--If isnull(@SearchProfileId,0)=0
		--Begin
		--Select @SearchProfileId=d.SearchProfileId 
		--from [ZnodeSearchProfileTrigger] d
		--inner join ZnodePublishCatalogSearchProfile c on c.SearchProfileId=d.SearchProfileId
		--Where d.Keyword=@Keyword
		--and c.PublishCatalogId=@PublishCatalogId
		--and d.ProfileId is null
		--eND

		--If isnull(@SearchProfileId,0)=0
		--Begin
		--Select @SearchProfileId=d.SearchProfileId 
		--from [ZnodeSearchProfileTrigger] d
		--inner join ZnodePublishCatalogSearchProfile c on c.SearchProfileId=d.SearchProfileId
		--Where d.ProfileId=@ProfileId
		--and c.PublishCatalogId=@PublishCatalogId
		--and d.Keyword is null
		--eND

		IF ISNULL(@SearchProfileId,0)=0
		BEGIN
			SELECT @SearchProfileId=SearchProfileId 
			FROM ZnodePublishCatalogSearchProfile Where PublishCatalogId=@PublishCatalogId
		END 
		--If isnull(@SearchProfileId,0)=0
		-- Begin
		--	Select @SearchProfileId=min(a.SearchProfileId)
		--	from ZnodePortalSearchProfile a
		--	inner join ZnodePublishCatalogSearchProfile c on c.SearchProfileId=a.SearchProfileId
		--	Where a.PortalId =@PortalId 
		--	and a.IsDefault=0
		--	and c.PublishCatalogId=@PublishCatalogId
		--End 

		
		SELECT @DefaultSearchProfileId = a.SearchProfileId
		FROM ZnodeSearchProfile a
		WHERE ProfileName = 'ZnodeSearchProfile'
		
		If Not exists (Select TOP 1 1 from ZnodePublishSearchProfileEntity where SearchProfileId = @SearchProfileId  )
			SELECT PublishSearchProfileEntityId,SearchProfileId,SearchProfileName,ZnodeCatalogId,FeaturesList,QueryTypeName,SearchQueryType,
				QueryBuilderClassName,SubQueryType,FieldValueFactor,[Operator],PublishStateId,SearchProfileAttributeMappingJson,CreatedBy,
				CreatedDate,ModifiedBy,ModifiedDate,SearchProfilePublishLogId
			FROM ZnodePublishSearchProfileEntity
			WHERE ( SearchProfileId = @DefaultSearchProfileId )  
		Else 
			SELECT PublishSearchProfileEntityId,SearchProfileId,SearchProfileName,ZnodeCatalogId,FeaturesList,QueryTypeName,SearchQueryType,
				QueryBuilderClassName,SubQueryType,FieldValueFactor,[Operator],PublishStateId,SearchProfileAttributeMappingJson,CreatedBy,
				CreatedDate,ModifiedBy,ModifiedDate,SearchProfilePublishLogId
			FROM ZnodePublishSearchProfileEntity
			WHERE ( SearchProfileId = @SearchProfileId  )  


		----To get SearchRule Item Details
		EXEC [Znode_GetSearchTriggerItemRuleDetails] @Keyword = @Keyword, @PublishCatalogId = @PublishCatalogId

	END TRY 
	BEGIN CATCH
		DECLARE @Status BIT;

		SET @Status = 0;

		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), 
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
				@ErrorLine VARCHAR(100)= ERROR_LINE(), 
				@ErrorCall NVARCHAR(MAX)= 
					'EXEC Znode_GetWebStoreSearchProfileTrigger 
						@Keyword = '''+ISNULL(@Keyword,'''''')+''',
						@ProfileId='+ISNULL(CAST(@ProfileId AS VARCHAR(50)),'''''')+',
						@PublishCatalogId='+ISNULL(CAST(@PublishCatalogId AS	VARCHAR(50)),'''''')+',
						@PortalId='+ISNULL(CAST(@PortalId AS	VARCHAR(50)),'''''');
              			 
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;
		  
		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_GetWebStoreSearchProfileTrigger',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportBrands')
	DROP PROC Znode_ImportBrands
GO

CREATE PROCEDURE [dbo].[Znode_ImportBrands](
	  @TableName			NVARCHAR(100), 
	  @Status				BIT OUT, 
	  @UserId				INT, 
	  @ImportProcessLogId	INT, 
	  @NewGUId				NVARCHAR(200),
	  @LocaleId	            INT= 1,
	  @CsvColumnString		NVARCHAR(max)
	  )
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Made a provision to import Brand details.
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN Brands;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate();
		IF isnull(@LocaleId,0)=0
		BEGIN
			SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		END
		-- Retrive RoundOff Value from global setting 

		Create TABLE #InsertBrandData 
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY,RowNumber int, BrandCode varchar(max),IsActive varchar(max), BrandDescription varchar(max) default null,
			SEOKeyword varchar(max) default null,SEODescription varchar(max) default null, BrandLogo varchar(max) default null,SEOTitle varchar(max) default null,
			SEOFriendlyPageName varchar(max) default null,URLKey varchar(max) default null, Custom1 varchar(max) default null,Custom2 varchar(max) default null,
			Custom3 varchar(max) default null,Custom4 varchar(max) default null,Custom5 varchar(max) default null, GUID nvarchar(400)
		);	
			
		SET @SSQL = 'INSERT INTO #InsertBrandData( RowNumber,' + @CsvColumnString + ',GUID)
		             SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+ @TableName;		
		EXEC sys.sp_sqlexec @SSQL;

		SELECT BrandCode 
		INTO #DuplicateBrandData 
		FROM #InsertBrandData 
		Group BY BrandCode  having count(*) > 1
		
		-- Start Functional Validation 
		-----------------------------------------------
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '53', 'BrandCode', BrandCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertBrandData AS ii
			   WHERE exists(SELECT * FROM #DuplicateBrandData bd where bd.BrandCode=ii.BrandCode)
			   And not exists(select * from  ZnodeBrandDetails zbd 
							  INNER JOIN #DuplicateBrandData bd on bd.BrandCode=zbd.BrandCode) 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '8', 'BrandCode', BrandCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertBrandData AS ii
			   WHERE isnull(BrandCode,'')=''			   
			  

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '121', 'BrandCode', BrandCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertBrandData AS ii
			   WHERE  not exists 
				   (
						select * from ZnodePimAttributeDefaultValue zpadv
						inner join ZnodePimAttribute zpa on zpa.PimAttributeId=zpadv.PimAttributeId
						where AttributeCode='Brand' and AttributeDefaultValueCode=ii.BrandCode
				   );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '8', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM #InsertBrandData AS ii  
			WHERE isnull(ii.IsActive,'')=''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM #InsertBrandData AS ii  
			WHERE isnull(ii.IsActive,'') not in ('True','1','Yes','FALSE','0','No')
			
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '82', 'SEOKeyword', SEOKeyword, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertBrandData AS ii
			  WHERE len(ltrim(rtrim(ii.SEOKeyword))) > 300 and isnull(ii.SEOKeyword,'')<>''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '82', 'SEODescription', SEODescription, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertBrandData AS ii
			   WHERE len(ltrim(rtrim(ii.SEODescription))) > 300 and isnull(ii.SEODescription,'')<>''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '45', 'BrandLogo', BrandLogo, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertBrandData AS ii			 
			   WHERE isnull(BrandLogo,'')<>'' AND reverse(left(reverse(ii.BrandLogo),charindex('.',reverse(ii.BrandLogo)))) 
			   not in (select ValidationName from View_FamilyExtensions where FamilyCode='Image')
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '45', 'BrandLogo', BrandLogo, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertBrandData AS ii			 
			   WHERE isnull(BrandLogo,'')<>'' and not exists (select * from ZnodeMedia where FileName=ii.BrandLogo)

  
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '81', 'SEOTitle', SEOTitle, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertBrandData AS ii
			   WHERE len(ltrim(rtrim(ii.SEOTitle))) > 200 and isnull(ii.SEOTitle,'')<>''		
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '102', 'SEOFriendlyPageName', SEOFriendlyPageName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM #InsertBrandData AS ii  
			WHERE (isnull(ii.SEOFriendlyPageName,'') LIKE '%[^a-zA-Z0-9]%' and  isnull(ii.SEOFriendlyPageName,'') NOT LIKE '%[_-]%' )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '81', 'URLKey', URLKey, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM #InsertBrandData AS ii  
			WHERE len(ltrim(rtrim(ii.URLKey))) > 200 and isnull(ii.URLKey,'')<>''			


		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ Brand - ' + ISNULL(BrandCode,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN #InsertBrandData IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM #InsertBrandData
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertBrandData
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;
		
		--<Begin Data Updation>
		CREATE TABLE #InsertedBrands (BrandId INT,BrandCode nvarchar(100),CMSSEODetailId int ) 
		
		UPDATE zbd set WebsiteLink=isnull(ibd.URLKey,WebsiteLink),IsActive=isnull(ibd.IsActive,zbd.IsActive),ModifiedBy=@UserId,
					   ModifiedDate=Getdate(),Custom1=isnull(ibd.Custom1,zbd.custom1),Custom2=isnull(ibd.Custom2,zbd.custom2),Custom3=isnull(ibd.Custom3,zbd.custom3),Custom4=isnull(ibd.Custom4,zbd.custom4),
					   Custom5=ISNULL(ibd.Custom5, zbd.Custom5)      
		OUTPUT INSERTED.BrandId ,INSERTED.BrandCode INTO  #InsertedBrands (BrandId, BrandCode)
		from ZnodeBrandDetails zbd
		inner join #InsertBrandData IBD on ibd.BrandCode=zbd.BrandCode
		where ibd.RowNumber=(select max(RowNumber) from #InsertBrandData a where a.BrandCode=zbd.BrandCode)

		UPDATE zbdl set zbdl.BrandId=zbd.BrandId,zbdl.Description=isnull(ibd.BrandDescription,zbdl.Description),SEOFriendlyPageName=isnull(IBD.SEOFriendlyPageName,zbdl.SEOFriendlyPageName),
		LocaleId=@LocaleId,ModifiedBy=@UserId,ModifiedDate=getdate(),BrandName=isnull(ibd.BrandCode,zbdl.BrandName)
		FROM ZnodeBrandDetailLocale zbdl
		inner join ZnodeBrandDetails zbd on zbd.BrandId=zbdl.BrandId
		inner join #InsertBrandData IBD on ibd.BrandCode=zbd.BrandCode
		inner join #InsertedBrands ib on ib.BrandId=zbdl.BrandId
		where ibd.RowNumber=(select max(RowNumber) from #InsertBrandData a where a.BrandCode=zbd.BrandCode)

		UPDATE ZCD set SEOId=ib.BrandId,SEOUrl=isnull(ibd.SEOFriendlyPageName,zcd.SEOUrl),ModifiedBy=@UserId,ModifiedDate=getdate(),
					   SEOCode=isnull(ibd.BrandCode,zcd.SEOCode)
		OUTPUT INSERTED.SEOId ,INSERTED.SEOCode, INSERTED.CMSSEODetailId INTO  #InsertedBrands (BrandId, BrandCode,CMSSEODetailId) 
		FROM ZnodeCMSSEODetail ZCD		
		inner join #InsertedBrands ib on ib.BrandId=ZCD.SEOId
		inner join #InsertBrandData IBD on ibd.BrandCode=zcd.SEOCode
		where exists (select null from ZnodeBrandDetailLocale zbdl where zbdl.BrandId=ZCD.SEOId)
		and ibd.RowNumber=(select max(RowNumber) from #InsertBrandData a where a.BrandCode=zcd.SEOCode)
		
		--<Delete Records Having Null Value>
		Delete from #InsertedBrands where isnull(CMSSEODetailId,0)=0
		--</Delete Records Having Null Value>
		
		UPDATE zcdl set CMSSEODetailId =isnull(ib.CMSSEODetailId,zcdl.CMSSEODetailId),LocaleId=@LocaleId,SEOTitle=isnull(ibd.SEOTitle,zcdl.SEOTitle),
						SEODescription=isnull(ibd.SEODescription,zcdl.SEODescription),SEOKeywords=isnull(ibd.SEOKeyword,zcdl.SEOKeywords),ModifiedBy=@UserId,ModifiedDate=getdate()
		FROM ZnodeCMSSEODetailLocale zcdl
		inner join #InsertedBrands ib on ib.CMSSEODetailId=zcdl.CMSSEODetailId
		inner join #InsertBrandData IBD on ibd.BrandCode=ib.BrandCode
		and ibd.RowNumber=(select max(RowNumber) from #InsertBrandData a 
		inner join ZnodeBrandDetails zcd on  a.BrandCode=zcd.BrandCode)

		--</End Data Updation>

		--<Begin Data Insert>
		insert into ZnodeBrandDetails(BrandCode,MediaId,WebsiteLink,DisplayOrder,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Custom1,Custom2,Custom3,
										Custom4,Custom5)
		OUTPUT INSERTED.BrandId ,INSERTED.BrandCode INTO  #InsertedBrands (BrandId, BrandCode) 		
		Select ibd.BrandCode,(select top 1 MediaId from ZnodeMedia where FileName=ibd.BrandLogo order by CreatedDate desc),ibd.URLKey,0,ibd.IsActive,@UserId,GETDATE(),@UserId,Getdate(),ibd.Custom1,ibd.Custom2,ibd.Custom3,ibd.Custom4,ibd.Custom5
		from #InsertBrandData IBD	
		WHERE NOT EXISTS(SELECT * FROM ZnodeBrandDetails ZBD WHERE ZBD.BrandCode = IBD.BrandCode )		

		insert into ZnodeBrandDetailLocale (BrandId,Description,SEOFriendlyPageName,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,BrandName)
		select ac.BrandId,ibdl.BrandDescription,ibdl.SEOFriendlyPageName,@LocaleId,@UserId,getdate(),@UserId,GETDATE(),ibdl.BrandCode 
		from #InsertBrandData IBDL
		INNER JOIN #InsertedBrands ac on ac.BrandCode=ibdl.BrandCode
		WHERE NOT EXISTS(SELECT * FROM ZnodeBrandDetailLocale a 
							INNER JOIN ZnodeBrandDetails b on  b.BrandCode=ibdl.BrandCode AND a.BrandId=b.BrandId )	

		insert into ZnodeCMSSEODetail (CMSSEOTypeId,SEOId,SEOUrl,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SEOCode,PublishStateId)
		OUTPUT INSERTED.SEOId ,INSERTED.SEOCode, INSERTED.CMSSEODetailId INTO  #InsertedBrands (BrandId, BrandCode,CMSSEODetailId)
		select (select CMSSEOTypeId  from ZnodeCMSSEOType where Name = 'Brand'),ac.BrandId,ibdl.SEOFriendlyPageName,@UserId,getdate(),@UserId,getdate(),ibdl.BrandCode,'2'
		from #InsertBrandData IBDL
		INNER JOIN #InsertedBrands ac on ac.BrandCode=ibdl.BrandCode
		WHERE NOT EXISTS(SELECT * FROM ZnodeCMSSEODetail a 
							INNER JOIN ZnodeBrandDetails b on b.BrandCode=ibdl.BrandCode 
							where a.SEOCode=ibdl.BrandCode
							AND a.CMSSEOTypeId=(select CMSSEOTypeId  from ZnodeCMSSEOType where Name = 'Brand')  )
		
		--<Delete Records Having Null Value>
		Delete from #InsertedBrands where isnull(CMSSEODetailId,0)=0
		--</Delete Records Having Null Value>

		insert into ZnodeCMSSEODetailLocale (CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		select ac.CMSSEODetailId ,@LocaleId,ibdl.SEOTitle,ibdl.SEODescription,ibdl.SEOKeyword,@UserId,GETDATE(),@UserId,Getdate()
		from #InsertBrandData IBDL
		INNER JOIN #InsertedBrands ac on ac.BrandCode=ibdl.BrandCode
		WHERE NOT EXISTS(SELECT * FROM ZnodeCMSSEODetailLocale a 
							INNER JOIN ZnodeCMSSEODetail b on a.CMSSEODetailId=b.CMSSEODetailId and b.SEOCode=ibdl.BrandCode
							INNER JOIN ZnodeBrandDetails c on c.BrandCode=ibdl.BrandCode 
							AND b.CMSSEOTypeId=(select CMSSEOTypeId  from ZnodeCMSSEOType where Name = 'Brand')  )		
        --<End Data Insert>

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN Brands;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN Brands

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		 DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportBrands @TableName = '+CAST(@TableName AS VARCHAR(max)) +',
		 @Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@LocaleId='+CAST(@LocaleId AS VARCHAR(200))+',
		 @CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max)) ;

		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportBrands',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetDynamicReport')
	DROP PROC Znode_GetDynamicReport
GO

CREATE PROCEDURE [dbo].[Znode_GetDynamicReport]
( @WhereClause nvarchar(max),
  @Columns varchar(max),
  @ReportType varchar(600), 
  @LocaleId int,
  @CatalogId    int = 0,
  @PriceListId  int = 0,
  @WarehouseId  int = 0,
  @CategoreyId  nvarchar(max) = '',
  @Isdebug bit = 0 , 
  @IscallforTest BIT =0 
  )

AS 
/*
	 Summary:-  This Procedure is Used to get the dynamic report data of product
	 Unit Testing
	 begin tran
	 EXEC Znode_GetDynamicReport '','SKU','Product',1,@CatalogId =1 
	 
	 EXEC Znode_GetDynamicReport '','ProductType,ProductName,SKU,ProductCode,ShortDescription,LongDescription,Assortment,Brand,Vendor,Highlights,Tags,FeatureDescription,ProductSpecification,File,IsActive,UOM,MinimumQuantity,MaximumQuantity,NewProduct,OutOfStockOptions,IsFeatured,CallForPricing,VideoURL,Calories,SpecialFeatures,PriceRange,Family,Specials,Sharp,Mild,GrapeColor,Season,Shelled,Salted,Color,testAttribute,testAttributeMultiSelect,Size,FreeShipping,ShippingCostRules,Weight,Height,Width,Length,ShippingInformation,testNumber,testCode,xbv,ShipSeparately','Product',1,@CatalogId =1 

	 EXEC Znode_GetDynamicReport '','CategoryName,ShortDescription,LongDescription,CategoryTitle,DisplayOrderCategory,AdditionalDescription,CategoryBanner,CategoryImage,ImageAltText','Category',1

      EXEC Znode_GetDynamicReport '', 'OmsOrderDetailsId,OmsOrderId,PortalId,UserId,OrderDate,OmsOrderStateId,ShippingId,PaymentTypeId,BillingFirstName
      ,BillingLastName,BillingCompanyName,BillingStreet1,BillingStreet2,BillingCity,BillingStateCode,BillingPostalCode,BillingCountry,BillingPhoneNumber
      ,BillingEmailId,TaxCost,ShippingCost,Total,subTotal,DiscountAmount,CurrencyCode,OverDueAmount,ShippingNumber,TrackingNumber,CouponCode,PromoDescription
      ,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId
      ,PoDocument,IsActive,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate','Orders',1
	 
	  EXEC Znode_GetDynamicReport '','UserId,AccountId,AspNetUserId,FirstName,LastName,MiddleName,CustomerPaymentGUID,BudgetAmount,Email
	  ,PhoneNumber,EmailOptIn,ReferralStatus,ReferralCommission,ReferralCommissionTypeId,IsActive,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate','User',1
 
	 rollback tran
	 
*/
BEGIN
	BEGIN TRY
		SET NOCOUNT ON;
		DECLARE @SQL NVARCHAR(max),
				@PimProductId TransferId,
				@OutPimProductIds VARCHAR(max),
				@RowsCount INT  = 0 ,
				@SubTotalString nvarchar(100),
				@PimProductIds VARCHAR(max),
				@IsProductNotIn bit

		DECLARE @DefaultLocaleId INT = dbo.FN_GetDefaultLocaleId() 
		DECLARE @TransferPimProductId TransferId 
		DECLARE @TBL_CatalogDetails TABLE (PimCatalogId INT,CatalogName NVARCHAR(max) )	
		DECLARE @CategoryNameAttributeId INT = dbo.Fn_GetCategoryNameAttributeId()
		
		INSERT INTO @TBL_CatalogDetails (PimCatalogId,CatalogName)
		SELECT PimCatalogId , CatalogName
		FROM ZnodePimCatalog  ZPC
		WHERE (ZPC.PimCatalogId = Isnull(@CatalogId ,0) OR Isnull(@CatalogId,0)  =0 )
	
	    SELECT PimCategoryId , CategoryValue CategoryName
		INTO #TBL_CategoryDetails
		FROM ZnodePimCategoryAttributeValue ZPCAV 
		INNER JOIN ZnodePimCategoryAttributeValueLocale ZPCAVL ON (ZPCAVL.PimCategoryAttributeValueId = ZPCAV.PimCategoryAttributeValueId AND ZPCAVL.LocaleId = @DefaultLocaleId)
		INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = ZPCAV.PimAttributeId AND IsCategory = 1 AND ZPA.PimAttributeId = @CategoryNameAttributeId)
		WHERE (EXISTS (SELECT TOP 1 1 FROM dbo.split(@CategoreyId,',') SP WHERE SP.Item= ZPCAV.PimCategoryId) OR @CategoreyId ='')

		DECLARE @TBL_DetailTable TABLE
		( 
			Id int, 
			CountId int, 
			RowId int 
		);

	   DECLARE @TBL_AttributeValue TABLE
        (	    PimProductId   INT,
              AttributeValue NVARCHAR(MAX),
              AttributeCode  varchar(300),
              PimAttributeId INT,
		    DisplayOrder Bigint
        );
		DECLARE @TBL_AttributeCode TABLE(AttributeCode varchar(300),DisplayOrder Bigint )
		
		DECLARE @ProductData TABLE 
		(AttributeValue Nvarchar(Max), AttributeCode varchar(300), PimProductId  Bigint)

		IF @ReportType = 'Product'
		BEGIN
		      
			 IF Isnull(@CatalogId,0) <> 0 
			 BEGIN 
				Insert into @TransferPimProductId 
				    SELECT  Distinct ZPCC.PimProductId  
				    FROM ZnodePimCategoryProduct ZPCC
					inner join ZnodePimCategoryHierarchy ZPCH ON ZPCC.PimCategoryId = ZPCH.PimCategoryId
				    WHERE (EXISTS (SELECT TOP 1 1 FROM @TBL_CatalogDetails TBCD WHERE TBCD.PimCatalogId = ZPCH.PimCatalogId ) OR Isnull(@CatalogId,0) =0 ) and PimProductId Is not null 
					AND (PimProductId =  @IscallforTest OR @IscallforTest = 0) 
			
				SET @IsProductNotIn  = 0 
			 END 
			 ELSE 
			 BEGIN 
			  Insert into @TransferPimProductId 
			  SELECT 1 
			  WHERE @IscallforTest = 1
			   
			  SET @PimProductIds = CASE WHEN @IscallforTest = 1 THEN 1 ELSE  '' END 
			  SET @IsProductNotIn  = 0 
			 END 
			 
			 EXEC Znode_GetProductIdForPaging
                  @whereClauseXML = @WhereClause,
                  @Rows = 10000000,
                  @PageNo = 1,
                  @Order_BY = '',
                  @RowsCount = @RowsCount OUT,
                  @LocaleId = @LocaleId,
                  @AttributeCode = '',
                  @PimProductId = @TransferPimProductId ,
                  @IsProductNotIn = @IsProductNotIn  ,
			   @OutProductId = @OutPimProductIds OUT;
			
	
			 INSERT INTO @TBL_DetailTable (Id ,RowId,CountId)             
			 SELECT item,Id,@RowsCount
			 FROM  dbo.split(@OutPimProductIds,',') SP 
			
			 --SET @SQL = SUBSTRING((SELECT ','+CAST(Id AS VARCHAR(50)) FROM  @TBL_DetailTable FOR XML PATH('') ),2,4000)
			 INSERT INTO @PimProductId ( Id )
			 SELECT Id FROM  @TBL_DetailTable
		
			 INSERT INTO @TBL_AttributeValue (PimProductId,AttributeValue,AttributeCode,PimAttributeId)
			 EXEC [dbo].[Znode_GetProductsAttributeValue] @PimProductId,@Columns,@LocaleId
		
			 UPDATE A SET A.AttributeValue 
					= SUBSTRING ((SELECT ','+CAST([FileName] AS VARCHAR(50)) FROM ZnodeMedia ZM WHERE EXISTS
					(SELECT TOP 1 1 FROM dbo.split(A.AttributeValue ,',') SP WHERE ltrim(rtrim(sp.Item)) = ZM.MediaId) FOR XML PATH ('') ) ,2,4000)   
					FROM @TBL_AttributeValue   A   where A.AttributeCode in ('ProductImage','GalleryImages','SwatchImage') 

			
			 INSERT INTO @TBL_AttributeCode (AttributeCode ,DisplayOrder )
			 select ltrim(rtrim(SPL.item)),SPL.Id
			 from DBO.Split(@Columns,',') SPL
			 where NOT EXISTS (SELECT TOP 1  1 FROM @TBL_AttributeValue TBAV WHERE TBAV.AttributeCode = SPL.item)
	           
			 SET @Columns = 'CatalogName,CategoryName,' + @Columns 
	           ;With CTE_ProductData AS 
			 (
				SELECT tblAv.AttributeValue, tblAv.AttributeCode, tblAv.PimProductId  
				FROM @TBL_AttributeValue  tblAv 
				UNION All 
				select NULL  AttributeValue, SPL.AttributeCode , AV.PimProductId   
				from @TBL_AttributeCode SPL
				CROSS APPLY @TBL_AttributeValue AV 
				UNION ALL 
				SELECT Distinct  TBCD.CatalogName,'CatalogName' AttributeCode ,  ZPCC.PimProductId 
				FROM ZnodePimCategoryProduct ZPCC
				inner join ZnodePimCategoryHierarchy ZPCH ON ZPCC.PimCategoryId = ZPCH.PimCategoryId
				INNER JOIN @TBL_CatalogDetails TBCD ON TBCD.PimCatalogId = ZPCH.PimCatalogId 
				WHERE ZPCC.PimProductId IS NOT NULL 
				AND EXISTS (SELECT TOP 1 1 FROM @TBL_AttributeValue TBL WHERE TBL.PimProductId = ZPCC.PimProductId )
				GROUP BY  ZPCC.PimProductId ,TBCD.CatalogName
				UNION ALL 
				SELECT SUBSTRING(( SELECT DISTINCT ','+TBCD.CategoryName 
							FROM #TBL_CategoryDetails TBCD 
							INNER JOIN ZnodePimCategoryProduct ZPCCI ON (ZPCCI.PimCategoryId = TBCD.PimCategoryId )
							inner join ZnodePimCategoryHierarchy ZPCH ON ZPCCI.PimCategoryId = ZPCH.PimCategoryId
						WHERE  ZPCH.PimCatalogId = ZPCH.PimCatalogId AND ZPCC.PimProductId = ZPCCI.PimProductId  FOR XML PATH('')),2,8000)   ,'CategoryName' AttributeCode ,  ZPCC.PimProductId 
				FROM ZnodePimCategoryProduct ZPCC
				INNER JOIN ZnodePimCategoryHierarchy ZPCH ON ZPCC.PimCategoryId = ZPCH.PimCategoryId
				WHERE ZPCC.PimProductId IS NOT NULL  
				AND (PimCatalogId in (Select PimCatalogId FROM @TBL_CatalogDetails) OR Isnull(@CatalogId,0)  =0)
				AND EXISTS (SELECT TOP 1 1 FROM @TBL_AttributeValue TBL WHERE TBL.PimProductId = ZPCC.PimProductId )
				GROUP BY ZPCC.PimProductId ,ZPCH.PimCatalogId 
			 )
			 	Select  AttributeValue, AttributeCode, PimProductId  AS Id
				from CTE_ProductData INNER JOIN DBO.Split(@Columns,',') SPLORD  ON CTE_ProductData.AttributeCode = SPLORD.Item 
				order by PimProductId,SPLORD.id
		END;
		ELSE IF @ReportType = 'Category'
			 BEGIN

			  IF Isnull(@CatalogId,0) <> 0  
			 BEGIN 

			 SET @PimProductIds = SUBSTRING ((SELECT  ','+CAST(ZPCC.PimCategoryId AS VARCHAr(50)) 
												FROM ZnodePimCategoryProduct ZPCC
												INNER JOIN ZnodePimCategoryHierarchy ZPCH ON ZPCC.PimCategoryId = ZPCH.PimCategoryId
												WHERE (EXISTS (SELECT TOP 1 1 FROM @TBL_CatalogDetails TBCD WHERE TBCD.PimCatalogId = ZPCH.PimCatalogId ) OR Isnull(@CatalogId,0) =0 )
												FOR XML PATH('')
											),2,4000)
			
			 END 
			 ELSE 
			 BEGIN 
			  SET @PimProductIds = ''
			 END 

				INSERT INTO @TBL_DetailTable( Id, CountId, RowId )
				EXEC Znode_GetCategoryIdForPaging 
				@WhereClauseXML = @WhereClause, 
				@Rows = 10000000, 
				@PageNo = 1, 
				@Order_BY = '', 
				@RowsCount = 0, 
				@LocaleId = @LocaleId, 
				@AttributeCode = '', 
				@PimCategoryId = @PimProductIds,
				@IsAssociated = 1;
				
				Insert into @TBL_AttributeValue (AttributeValue,AttributeCode,PimProductId)
				SELECT CategoryValue AS AttributeValue, AttributeCode, PimCategoryId AS Id
				FROM View_PimCategoryAttributeValue AS VICAV
				WHERE EXISTS
				(
					SELECT TOP 1 1
					FROM @TBL_DetailTable AS TBP
					WHERE VICAV.PimCategoryId = TBP.Id
				) AND 
					  EXISTS
				(
					SELECT TOP 1 1
					FROM dbo.split( @Columns, ',' ) AS SP
					WHERE SP.Item = VICAV.AttributeCode
				) AND  LocaleId = @LocaleId;

						
				Insert into @TBL_AttributeValue (AttributeValue,AttributeCode,PimProductId)
				SELECT CategoryValue AS AttributeValue, AttributeCode, PimCategoryId AS Id
				FROM View_PimCategoryAttributeValue AS VICAV
				WHERE EXISTS
				(
					SELECT TOP 1 1
					FROM @TBL_DetailTable AS TBP
					WHERE VICAV.PimCategoryId = TBP.Id
				) AND 
					  EXISTS
				(
					SELECT TOP 1 1
					FROM dbo.split( @Columns, ',' ) AS SP
					WHERE SP.Item = VICAV.AttributeCode
				) AND  LocaleId = @DefaultLocaleId
				AND NOT EXISTS (SELECT TOP 1 1 FROM @TBL_AttributeValue RTRR WHERE VICAV.PimCategoryId = RTRR.PimProductId AND VICAV.AttributeCode = RTRR.AttributeCode)
				;


					
				UPDATE A SET A.AttributeValue 
				= SUBSTRING ((SELECT ','+CAST([FileName] AS VARCHAR(50)) FROM ZnodeMedia ZM WHERE EXISTS
				(SELECT TOP 1 1 FROM dbo.split(A.AttributeValue ,',') SP WHERE ltrim(rtrim(sp.Item)) = ZM.MediaId) FOR XML PATH ('') ) ,2,4000)   
				FROM @TBL_AttributeValue   A   where A.AttributeCode in ('CategoryImage') 

			
				;With CTE_CategoryData AS 
				(
				    select AttributeValue  ,AttributeCode,PimProductId  from @TBL_AttributeValue
				    UNION All 
				    select  NULL  AttributeValue, SPL.item , AV.PimProductId  from DBO.Split(@Columns,',') SPL
				    CROSS JOIN @TBL_AttributeValue AV
				    where SPL.item Not in (Select Distinct AttributeCode from @TBL_AttributeValue)
				    UNION ALL
				    SELECT DISTINCT TBCD.CatalogName,'CatalogName' AttributeCode ,  ZPCC.PimCategoryId 
				    FROM ZnodePimCategoryHierarchy ZPCC
				    INNER JOIN @TBL_CatalogDetails TBCD ON TBCD.PimCatalogId = ZPCC.PimCatalogId 
				)
				Select  AttributeValue, AttributeCode, PimProductId  AS Id  from CTE_CategoryData LEft Outer JOIN DBO.Split(@Columns,',') SPLORD  
				ON CTE_CategoryData.AttributeCode = SPLORD.Item 
				Order by CTE_CategoryData.PimProductId, SPLORD.Id



	    END
	    ELSE IF @ReportType = 'Inventory' 
	    BEGIN 
		SET @Columns = Replace (@Columns, 'Quantity','dbo.Fn_GetDefaultInventoryRoundOff(Quantity) Quantity')   
		SET @Columns = Replace (@Columns, 'ReOrderLevel','dbo.Fn_GetDefaultInventoryRoundOff(ReOrderLevel) ReOrderLevel')   
		SET @SQL = 
		'
					;With Cte_Inventory AS (
					SELECT '+@Columns+' FROM ZnodeInventory ZI Inner join ZnodeWarehouse ZW on ZI.WarehouseId  = ZW.WarehouseId  
					WHERE 1=1 '+[dbo].[Fn_GetFilterWhereClause](@WhereClause)  
					+' AND ( ZI.WarehouseId =  ' + CONVERT(Varchar(300), Isnull(@WarehouseId,0)) + ' OR ' + CONVERT(Varchar(300), Isnull( @WarehouseId,0) ) + '  = 0 ))

					SELECT * FROM Cte_Inventory '
		EXEC (@SQL)
		END 
		ELSE IF @ReportType = 'Orders' 
		BEGIN 
		    if (Charindex('SubTotal',@Columns) > 0 )
				SET @Columns = Replace (@Columns, 'SubTotal','[SBT]')  

		    SET @Columns = Replace (@Columns, 'TaxCost','dbo.Fn_GetDefaultPriceRoundOff(TaxCost) TaxCost')   
		    SET @Columns = Replace (@Columns, 'ShippingCost','dbo.Fn_GetDefaultPriceRoundOff(ShippingCost) ShippingCost')
		    SET @Columns = Replace (@Columns, 'Total','dbo.Fn_GetDefaultPriceRoundOff(Total) Total')   
		    SET @Columns = Replace (@Columns, 'DiscountAmount','dbo.Fn_GetDefaultPriceRoundOff(DiscountAmount) DiscountAmount')   
		    SET @Columns = Replace (@Columns, 'OverDueAmount','dbo.Fn_GetDefaultPriceRoundOff(OverDueAmount) OverDueAmount')   
		    SET @Columns = Replace (@Columns, '[SBT]','dbo.Fn_GetDefaultPriceRoundOff(SubTotal) SubTotal')   
		   	    
		    SET @SQL = '
					    ;With Cte_Orders AS (
					    SELECT '+@Columns+'
					    FROM ZnodeOmsOrderDetails
					    WHERE 1=1
					    '+[dbo].[Fn_GetFilterWhereClause](@WhereClause)+'
						) 
					    SELECT * 
					    FROM Cte_Orders '
		    EXEC (@SQL)
		END 
		ELSE IF @ReportType = 'User' 
		BEGIN 
		SET @Columns = Replace (@Columns, 'BudgetAmount','dbo.Fn_GetDefaultPriceRoundOff(BudgetAmount) BudgetAmount')   
		SET @SQL = '
					;With Cte_User AS (
					SELECT '+@Columns+'
					FROM ZnodeUser 
					WHERE 1=1
					'+[dbo].[Fn_GetFilterWhereClause](@WhereClause)+'
					 ) 
					SELECT * 
					FROM Cte_User '
		EXEC (@SQL)
		END 
		ELSE IF @ReportType = 'Pricing' 
		BEGIN 

			 SET @Columns = Replace (@Columns, 'SalesPrice','dbo.Fn_GetDefaultPriceRoundOff(SalesPrice) SalesPrice')   
			 SET @Columns = Replace (@Columns, 'RetailPrice','dbo.Fn_GetDefaultPriceRoundOff(RetailPrice) RetailPrice')
			 SET @Columns = Replace (@Columns, 'ActivationDate','ZP.ActivationDate ActivationDate')
			 SET @Columns = Replace (@Columns, 'ExpirationDate','ZP.ExpirationDate ExpirationDate')
			 SET @Columns = Replace (@Columns, 'PriceListCode','ZPL.ListCode PriceListCode')   

		

		SET @SQL = '
					;With Cte_Pricing AS (
					SELECT '+@Columns+'
					FROM ZnodePrice ZP Inner join ZnodePriceList ZPL ON ZP.PriceListId = ZPL.PriceListId
					WHERE 1=1
					'+[dbo].[Fn_GetFilterWhereClause](@WhereClause)+' AND (ZP.PriceListId =  ' + CONVERT(Varchar(300), Isnull(@PriceListId ,0) ) + ' OR ' + CONVERT(Varchar(300), Isnull( @PriceListId,0) ) + '  = 0 ) 
					 ) 
					SELECT * 
					FROM Cte_Pricing '
		EXEC (@SQL)
		--print @SQL
		END 

	END TRY
	BEGIN CATCH
		  DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
			 @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetDynamicReport @WhereClause = '+@WhereClause+',@Columns='+@Columns+',@ReportType='+@ReportType+',@LocaleId='+CAST(@LocaleId AS VARCHAR(50))+',@CatalogId='+CAST(isnull(@CatalogId,0) AS VARCHAR(50)) +',@PriceListId='+@PriceListId+',@WarehouseId='+@WarehouseId+',@CategoreyId='+@CategoreyId+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		    
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetDynamicReport',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetProductIdForPaging')
	DROP PROC Znode_GetProductIdForPaging
GO

CREATE PROCEDURE [dbo].[Znode_GetProductIdForPaging]
(
	@WhereClauseXML  XML           = NULL,
	@Rows            INT           = 10,
	@PageNo          INT           = 1,
	@Order_BY        VARCHAR(1000) = '',
	@RowsCount       INT OUT,
	@LocaleId        INT           = 1,
	@AttributeCode   VARCHAR(MAX)  = '',
	@PimProductId    TransferId READONLY , 
	@IsProductNotIn  BIT           = 0,
	@OutProductId    VARCHAR(MAX)	= 0 OUT )
AS	
 /* Summary :- This procedure is used to find the product ids with paging 
     Unit Testing
	 begin tran
	 DECLARE @ttr NVARCHAR(max)
	 DECLARE @PimProductId TransferId 
	 INSERT INTO @PimProductId
	 SELECT -1
     EXEC Znode_GetProductIdForPaging   N'' ,  10 ,  2 ,'productname desc',0, 1, '',@PimProductId ,0 ,@ttr OUT SELECT @ttr
	 rollback tran

	 begin tran

	 DECLARE @ttr NVARCHAR(max)
	 DECLARE @PimProductId TransferId 
	 INSERT INTO @PimProductId
	 SELECT 1
	EXEC Znode_GetProductIdForPaging N'', 50,1,'productname desc',0,1,'',@PimProductId,0,@ttr OUT SELECT @ttr
  rollback tran





	Create Index ZnodePimAttributeValue_ForPaging_Include ON  ZnodePimAttributeValue(PimAttributeId) include (PimAttributeValueId  ,PimProductId,CreatedDate,ModifiedDate )
	Create Index ZnodePimProductAttributeDefaultValue_ForPaging_Include ON  ZnodePimProductAttributeDefaultValue(PimAttributeValueId) include (PimAttributeDefaultValueId)
	Create Index ZnodePimFamilyGroupMapper_PimAttributeFamilyId ON ZnodePimFamilyGroupMapper(PimAttributeFamilyId,PimAttributeId)

	create  index IDX_ZnodePimAttributeValue_PimAttributeId on ZnodePimAttributeValue(PimAttributeId)
*/
BEGIN
 BEGIN TRY 

  SET NOCOUNT ON 

       DECLARE @SQL NVARCHAR(MAX) = '',
			   @InternalSQL NVARCHAR(MAX) = ''
	   DECLARE @UseCtePart VARCHAR(1000) = ''
	   DECLARE @InternalOrderby VARCHAR(1000) = ''
	   DECLARE @InternalWhereClause NVARCHAR(MAX) = '',
			   @InternalProductWhereClause NVARCHAR(MAX) = '',
			   @InternalUpperWhereClause NVARCHAR(MAX)='',
			   @InternaleProductJoin NVARCHAR(MAX) = ''

	   DECLARE @TBL_PimProductId  TABLE (PimProductId INT  , CountNo INT)
	   DECLARE @TBL_DefaultAttributeId TABLE (PimAttributeId INT PRIMARY KEY , AttributeCode VARCHAR(600))
	  
	   DECLARE @DefaultLocaleId INT = dbo.FN_GetDefaultLocaleId()
	   DECLARE @PimProductIds TransferId 
	   INSERT INTO @TBL_DefaultAttributeId (PimAttributeId,AttributeCode)
	   SELECT PimAttributeId,AttributeCode FROM  [dbo].[Fn_GetDefaultAttributeId] ()

	   DECLARE @TBL_Attributeids TABLE(PimAttributeId INT , AttributeCode VARCHAr(600))

	  
	   INSERT INTO @PimProductIds (id)
	   SELECT Id
	   FROM @PimProductId 


	   IF  EXISTS (SELECT TOP 1 1 FROM @PimProductId )  AND @IsProductNotIn = 1 
	   BEGIN 
	    	     SET @InternalWhereClause = ' WHERE NOT EXISTS ( SELECT TOP 1 1 FROM @TBL_ProductFilter TBLFP WHERE  TBLFP.PimProductId = ZPP.PimProductId )'
	   END 
	   ELSE IF @IsProductNotIn = 0 AND EXISTS (SELECT TOP 1 1 FROM @PimProductId )  
	   BEGIN 
		  SET @InternalWhereClause = ''
		  SET @InternalUpperWhereClause = ' A '
	   END 	  

	
	   SET @SQl = ' 
				DECLARE @TBL_ProductFilter TABLE (PimProductId INT PRIMARY KEY,RowId INT IDENTITY(1,1)  ) '

				IF (@AttributeCode like  '%highlights%' or @AttributeCode like '%brand%' or @AttributeCode like '%vendor%' )
				BEGIN
			
					SET @SQl = @SQl + 'INSERT INTO @TBL_ProductFilter  (PimProductId )
										SELECT a.Id 
										FROM @TransferId a
										INNER JOIN ZnodePimAttributeValue ZPAV ON a.Id = ZPAV.PimProductId
										LEFT JOIN ZnodePimAttribute PA ON ( PA.PimAttributeId = ZPAV.PimAttributeId ) 
										WHERE PA.AttributeCode in (select top 1 item from dbo.Split ('''+@AttributeCode+''','',''))
										ORDER BY ZPAV.ModifiedDate desc;'

				END
				ELSE
				BEGIN 

					SET @SQl = @SQl + 'INSERT INTO @TBL_ProductFilter  (PimProductId )
										SELECT Id 
										FROM @TransferId '
				END

				
				SET @SQl = @SQl+'							
								DECLARE @TBL_PimProductId TABLE (PimProductId  INT PRIMARY KEY,RowId INT, CountNo INT)
								  
										SELECT ZPP.PimProductId , ZPP.PimAttributeFamilyId , '+CASE WHEN @InternalUpperWhereClause <> '' THEN ' TBPF.RowId ' ELSE ' 1 ' END+'  DisplayOrder 
										INTO #Cte_PimProductId 
										FROM ZnodePimProduct ZPP 
									'+CASE WHEN @InternalUpperWhereClause <> '' AND @InternalWhereClause = '' THEN ' INNER JOIN @TBL_ProductFilter TBPF ON (TBPF.PimProductId = ZPP.PimProductId ) ' ELSE '' END +'
										'+@InternalWhereClause+' 
								  '
	
	 SET @AttributeCode = @AttributeCode +CASE WHEN @Order_By <> '' THEN ','+ REPLACE(REPLACE(RTRIM(LTRIM(@Order_By)),'DESC',''),'ASC','') ELSE '' END 
	 
	 IF @AttributeCode = ''
	 BEGIN 
	 SET @AttributeCode = SUBSTRING( (SELECT ','+AttributeCode  FROM [dbo].[Fn_GetProductGridAttributes]() FOR XML PATH ('') ),2,4000)	
	 END 

	   INSERT INTO @TBL_Attributeids (PimAttributeId, AttributeCode )
	   SELECT PimAttributeId,AttributeCode
	   FROM [dbo].[Fn_GetProductGridAttributes]() FNGA  
	   WHERE EXISTS (SELECT Top 1 1 FROM dbo.split(@AttributeCode , ',') SP WHERE sp.Item = FNGA.AttributeCode   )

	  -- 	 SELECT @AttributeCode

	   

	    DECLARE @PimAttributeIds VARCHAR(MAX) = SUBSTRING((SELECT ','+CAST(PimAttributeId AS VARCHAR(50)) 
																		FROM @TBL_Attributeids FNGA  
																		FOR XML PATH ('') ) ,2,4000)


	SET @InternalOrderby = dbo.FN_trim(REPLACE(REPLACE(@Order_By,'DESC',''),'ASC',''))
	
	IF EXISTS (SELECT TOP 1 1 FROM [dbo].[Fn_GetProductGridAttributes]() FN WHERE FN.AttributeCode = @InternalOrderby) OR @InternalOrderby = 'AttributeFamily'
	BEGIN
		
		SET @InternalWhereClause = 'AttributeCode = '''+@InternalOrderby+''''
		SET @InternalOrderby = 'AttributeValue '+CASE WHEN @Order_By LIKE '% DESC' THEN 'DESC' ELSE 'ASC' END
				
	END
	ELSE IF  @InternalOrderby IN ('CreatedDate','ModifiedDate')
	
	BEGIN
	
	 SET @InternalOrderby = @Order_By
	 SET @InternalWhereClause = ' AttributeCode = ''SKU'' ' 
	END 
	ELSE 
	BEGIN 
	 SET @InternalOrderby = CASE WHEN @InternalOrderby = 'DisplayOrder' THEN @Order_By ELSE ' CTLA.PimProductId DESC ' END  
	 SET @InternalWhereClause = '' 
	END    

  
    IF CAST(@WhereClauseXML AS NVARCHAR(max)) NOT LIKE '%AttributeCode%' AND @InternalWhereClause = '' 
	BEGIN 
	
	 SET @SQL = @SQL + '  SELECT PimProductId ,'+[dbo].[Fn_GetPagingRowId](@InternalOrderby,'PimProductId DESC')+',Count(*)Over() CountNo
								   INTO #Cte_FilterData 
								   FROM #Cte_PimProductId CTLA
								 
								 INSERT INTO  @TBL_PimProductId  (PimProductId,RowId,CountNo )
								 SELECT DISTINCT PimProductId,RowId ,CountNo
								 FROM #Cte_FilterData 
								 '+[dbo].[Fn_GetPaginationWhereClause](@PageNo,@Rows)


	END 
	ELSE IF CAST(@WhereClauseXML AS NVARCHAR(max)) NOT LIKE '%AttributeCode%' AND @InternalWhereClause <> '' 
	BEGIN

						 
	   SET @InternalSQL = '
						   DECLARE @TBL_FamilyLocale  TABLE(PimAttributeFamilyId INT PRIMARY KEY ,FamilyCode NVARCHAR(600),IsSystemDefined BIT,IsDefaultFamily BIT,IsCategory BIT ,AttributeFamilyName NVARCHAR(max) ) 
						   DECLARE @TBL_DefaultValue  TABLE(PimAttributeId INT,AttributeDefaultValueCode NVARCHAR(600),IsEditable BIT,AttributeDefaultValue NVARCHAR(max),DisplayOrder INT,PimAttributeDefaultValueId INT )
						   
						   INSERT INTO @TBL_FamilyLocale(PimAttributeFamilyId,FamilyCode,IsSystemDefined,IsDefaultFamily,IsCategory,AttributeFamilyName)
						   EXEC [dbo].[Znode_GetFamilyValueLocale] '''','+CAST(@LocaleId AS VARCHAR(50))+'	
						   
						   INSERT INTO @TBL_DefaultValue(PimAttributeId,AttributeDefaultValueCode,IsEditable,AttributeDefaultValue,DisplayOrder,PimAttributeDefaultValueId)
						   EXEC [dbo].[Znode_GetAttributeDefaultValueLocaleNew] '''+@PimAttributeIds+''','+CAST(@LocaleId AS VARCHAR(50))+''

							SET @SQL = @SQL + '  
										SELECT CTP.PimProductId , ZPA.AttributeCode  ,ZPAV.PimAttributeValueId  ,ZPA.PimAttributeId
										,ZPAV.CreatedDate,ZPAV.ModifiedDate,CTP.DisplayOrder     
										INTO #Cte_getAttributeValue
										FROM #Cte_PimProductId CTP             
										INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimProductId = CTP.PimProductId)             
										INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = ZPAV.PimAttributeId)    
										INNER JOIN ZnodePimFamilyGroupMapper ZPFGM ON (ZPFGM.PimAttributeFamilyId = CTP.PimAttributeFamilyId                      
										AND ZPFGM.PimAttributeId = ZPA.PimAttributeId)   
									 
										SELECT ZPA.PimProductId , ZPA.AttributeCode  ,  ZPAVL.AttributeValue ,ZPA.CreatedDate,ZPA.ModifiedDate,ZPA.DisplayOrder             
										INTO #Cte_CollectData
										FROM #Cte_getAttributeValue   ZPA INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON (ZPA.PimAttributeValueId = ZPAVL.PimAttributeValueId ) 
										WHERE  ZPA.PimAttributeId IN ('+@PimAttributeIds+') AND ZPAVL.LocaleId in  (' + CAST(@DefaultLocaleId AS VARCHAR(50)) +')
										
										UNION ALL 
										
										SELECT CTP.PimProductId , ''AttributeFamily'', TBFM.AttributeFamilyName AttributeValue,NULL,NULL,CTP.DisplayOrder
										FROM #Cte_PimProductId CTP INNER JOIN @TBL_FamilyLocale  TBFM ON (TBFM.PimAttributeFamilyId = CTP.PimAttributeFamilyId)
										

										UNION ALL 
										
										SELECT DISTINCT PimProductId, AttributeCode , SUBSTRING((SELECT '',''+AttributeDefaultValue 
										FROM @TBL_DefaultValue TBDV WHERE (TBDV.PimAttributeDefaultValueId = ZPPADV.PimAttributeDefaultValueId )                            
										FOR XML PATH ('''')),2,4000) AttributeValue  , CTETY.CreatedDate,CTETY.ModifiedDate,DisplayOrder         
										FROM ZnodePimProductAttributeDefaultValue ZPPADV INNER JOIN Cte_getAttributeValue CTETY 
										ON (CTETY.PimAttributeValueId = ZPPADV.PimAttributeValueId)
										WHERE  CTETY.PimAttributeId IN ('+@PimAttributeIds+')
								 
									SELECT PimProductId,'+CASE WHEN @InternalOrderby LIKE '%DisplayOrder%' THEN 'DisplayOrder' ELSE   'AttributeValue'  END+'  , 1 DefaultOrderBy      
									INTO #Cte_GetAttributeValueI
									FROM  #Cte_CollectData CTCD
									WHERE '+@InternalWhereClause+'
									UNION ALL 
									SELECT CTP.PimProductId , NULL , 2 
									FROM #Cte_PimProductId CTP 	
									where NOT EXISTS (SELECT TOP 1 1 FROM  #Cte_CollectData CTCD
									WHERE '+@InternalWhereClause+' AND CTCD.PimProductId = CTP.PimProductId  )				  
								 
									SELECT DISTINCT PimProductId,'+[dbo].[Fn_GetPagingRowId](' DefaultOrderBy , '+@InternalOrderby+' ','PimProductId DESC')+'
									INTO #Cte_FilterData
									FROM Cte_GetAttributeValueI CTCD
								 
									SELECT PimProductId ,RowId ,Count(*)Over() CountNo
									INTO #Cte_GetAllData
									FROM #Cte_FilterData
									GROUP BY PimProductId ,RowId 
								 
								INSERT INTO  @TBL_PimProductId  (PimProductId,RowId,CountNo )
								SELECT  PimProductId,RowId ,CountNo
								FROM  #Cte_GetAllData
								'+[dbo].[Fn_GetPaginationWhereClause](@PageNo,@Rows)

		SET @SQL =  @InternalSQL + @SQL
			
	    END
		ELSE 
		BEGIN 
		 
		  SET @InternalSQL = ''
		  DECLARE @AttachINDefault  VARCHAr(max) = ''
		  SET  @InternalProductWhereClause = 
							STUFF( (  SELECT ' INNER JOIN #Cte_AttributeValueLocale AS CTAL'+CAST(ID AS VARCHAR(50))
							+' ON ( CTAL'+CAST(ID AS VARCHAR(50))+'.PimProductId = CTAL'+CASE WHEN ID-1= 0 THEN '' ELSE CAST(ID-1 AS VARCHAR(50)) END +'.PimProductId AND '+
							REPLACE(REPLACE(WhereClause,'AttributeCode ',' CTAL'+CAST(ID AS VARCHAR(50))+'.AttributeCode '),' AttributeValue ',' CTAL'+CAST(ID AS VARCHAR(50))+'.AttributeValue ')+' )'
							FROM dbo.Fn_GetWhereClauseXML(@WhereClauseXML)      
							FOR XML PATH (''), TYPE).value('.', ' Nvarchar(max)'), 1, 0, '')

          SET @SQL = @SQL + '   	
										SELECT CTP.PimProductId , ZPA.AttributeCode  ,ZPAV.PimAttributeValueId  ,ZPA.PimAttributeId
														,ZPAV.CreatedDate,ZPAV.ModifiedDate,CTP.DisplayOrder     
										INTO #Cte_getAttributeValue
										FROM #Cte_PimProductId CTP             
										INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimProductId = CTP.PimProductId)       
										INNER JOIN ZnodePimAttribute ZPA ON (ZPAV.PimAttributeId = ZPA.PimAttributeId)    
										INNER JOIN ZnodePimFamilyGroupMapper ZPFGM ON 
										(CTP.PimAttributeFamilyId = ZPFGM.PimAttributeFamilyId AND ZPFGM.PimAttributeId = ZPA.PimAttributeId) 
										WHERE (EXISTS (SELECT TOP 1 1 FROM dbo.split('''+@AttributeCode+''','','') SP WHERE Sp.Item = ZPA.AttributeCode )  OR NOT EXISTS (SELECT TOP 1 1 FROM dbo.split('''+@AttributeCode+''','','') ))
								 '
		  IF EXISTS (SELECT Top 1 1 FROM @TBL_Attributeids TBH WHERE NOT EXISTS (SELECT Top 1 1 FROM @TBL_DefaultAttributeId TBL WHERE TBL.PimAttributeId = TBH.PimAttributeId)
		  AND TBH.AttributeCode <> 'AttributeFamily' )
         BEGIN 
		    SET @SQL = @SQL+'   
									SELECT ZPA.PimProductId , ZPA.AttributeCode  ,  ZPAVL.AttributeValue,ZPAVL.LocaleId ,
											ZPA.PimAttributeId,ZPA.CreatedDate,ZPA.ModifiedDate,ZPA.DisplayOrder             
									INTO #Cte_CollectData
									FROM #Cte_getAttributeValue ZPA          
									INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON (ZPA.PimAttributeValueId  = ZPAVL.PimAttributeValueId )
									where ZPA.PimAttributeId IN ('+@PimAttributeIds+')
									AND  ZPAVL.LocaleId IN ( '+CAST(@LocaleId AS VARCHAR(50))+','+CAST(@DefaultLocaleId AS VARCHAR(50))+')
								 
								 
										SELECT PimProductId,AttributeCode,AttributeValue,PimAttributeId,CreatedDate,ModifiedDate,DisplayOrder
										INTO #Cte_FilterDataLocale 
										FROM #Cte_CollectData
										WHERE LocaleId = '+CAST(@LocaleId AS VARCHAR(50))+'
										UNION All 
										SELECT M.PimProductId,M.AttributeCode,M.AttributeValue ,M.PimAttributeId,M.CreatedDate,M.ModifiedDate,M.DisplayOrder
										FROM #Cte_CollectData M 
										WHERE LocaleId = '+CAST(@DefaultLocaleId AS VARCHAR(50))+'
										AND NOT Exists (Select TOP 1 1  from #Cte_CollectData X where  M.PimProductId = X.PimProductId AND M.AttributeCode = X.AttributeCode And X.localeId =  '+CAST(@LocaleId AS VARCHAR(50))+' )
								 '

						SET @AttachINDefault =			'SELECT PimProductId,AttributeCode,CTFD.AttributeValue ,CreatedDate,ModifiedDate,CTFD.DisplayOrder	 
										INTO #Cte_AttributeValueLocale FROM #Cte_FilterDataLocale CTFD'

		 END 
		 
		 IF EXISTS (SELECT Top 1 1 FROM @TBL_Attributeids TBH WHERE EXISTS (SELECT Top 1 1 FROM @TBL_DefaultAttributeId TBL WHERE TBL.PimAttributeId = TBH.PimAttributeId))
         BEGIN 
		 SET  @InternalSQL = 'DECLARE @TBL_DefaultValue  TABLE(PimAttributeId INT,AttributeDefaultValueCode NVARCHAR(600),IsEditable BIT,AttributeDefaultValue NVARCHAR(max),DisplayOrder INT,PimAttributeDefaultValueId INT  ) 
		                     INSERT INTO @TBL_DefaultValue(PimAttributeId,AttributeDefaultValueCode,IsEditable,AttributeDefaultValue,DisplayOrder,PimAttributeDefaultValueId)
						     EXEC [dbo].[Znode_GetAttributeDefaultValueLocaleNew] '''+@PimAttributeIds+''','+CAST(@LocaleId AS VARCHAR(50))
	   
			  SET @AttachINDefault = CASE WHEN @AttachINDefault = '' THEN '' ELSE @AttachINDefault+' UNION ALL ' END + ' SELECT PimProductId, AttributeCode , 
										SUBSTRING(
											(SELECT '',''+AttributeDefaultValue FROM @TBL_DefaultValue TBDV 
											WHERE (TBDV.PimAttributeDefaultValueId = ZPPADV.PimAttributeDefaultValueId )                            
											FOR XML PATH (''''))
										,2,4000) 
										AttributeValue  , CTETY.CreatedDate,CTETY.ModifiedDate,DisplayOrder         
										FROM #Cte_getAttributeValue CTETY
										INNER JOIN  ZnodePimProductAttributeDefaultValue ZPPADV ON (CTETY.PimAttributeValueId =ZPPADV.PimAttributeValueId  )
										WHERE  CTETY.PimAttributeId IN ('+@PimAttributeIds+') '

		 END
		 IF EXISTS (SELECT Top 1 1 FROM @TBL_Attributeids TBH WHERE AttributeCode = 'attributefamily')
         BEGIN 
		 


		 SET  @InternalSQL = @InternalSQL +' DECLARE @TBL_FamilyLocale  TABLE(PimAttributeFamilyId INT PRIMARY KEY ,FamilyCode NVARCHAR(600),IsSystemDefined BIT,IsDefaultFamily BIT,IsCategory BIT ,AttributeFamilyName NVARCHAR(max) ) 
		                    INSERT INTO @TBL_FamilyLocale(PimAttributeFamilyId,FamilyCode,IsSystemDefined,IsDefaultFamily,IsCategory,AttributeFamilyName)
						   EXEC [dbo].[Znode_GetFamilyValueLocale] '''','+CAST(@LocaleId AS VARCHAR(50))
						   
			SET @AttachINDefault = CASE WHEN @AttachINDefault = '' THEN '' ELSE @AttachINDefault+' UNION ALL '	END + 'SELECT CTP.PimProductId , ''AttributeFamily'' AttributeCode, TBFM.AttributeFamilyName AttributeValue,NULL CreatedDate, NULL ModifiedDate,DisplayOrder	
										FROM #Cte_PimProductId CTP 
										INNER JOIN @TBL_FamilyLocale  TBFM ON (TBFM.PimAttributeFamilyId = CTP.PimAttributeFamilyId)'
		 END
		
								--Print '---------3--------'
									SET @SQL = @SQL + ' 
									 '+@AttachINDefault+'										
									 '
									  

									--Print '---------4--------'
									SET @SQL = @SQL + ' 

									 
										 SELECT CTAL.PimProductId 
										 INTO #Cte_AttributeLocale 
										 FROM #Cte_AttributeValueLocale  CTAL
										 '+@InternalProductWhereClause+'
										 GROUP BY CTAL.PimProductId 
									 
									
										SELECT DISTINCT CTLA.PimProductId, 1 DefaultOrderBy  ,'+[dbo].[Fn_GetPagingRowId](@InternalOrderby,' CTLA.PimProductId DESC')+' 
										INTO #Cte_FinalProductData 
										FROM #Cte_AttributeValueLocale  CTAVL
										INNER JOIN #Cte_AttributeLocale CTLA ON (CTLA.PimProductId = CTAVL.PimProductId)
							        	'+CASE WHEN @InternalWhereClause <> '' THEN  ' WHERE CTAVL.'+dbo.FN_Trim(@InternalWhereClause) ELSE '' END +'
									

										  SELECT PimProductId, DefaultOrderBy,RowId
										  INTO #Cte_GEtSortingProduct 
										  FROM #Cte_FinalProductData 
										  UNION ALL 
										  SELECT PimProductId ,2 DefaultOrderBy,'+[dbo].[Fn_GetPagingRowId]( 'DERE.PimProductId',' DERE.PimProductId ')+'
										  FROM #Cte_AttributeLocale DERE 
										  WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Cte_FinalProductData TTRR WHERE TTRR.PimProductId = DERE.PimProductId  ) 
									  
									  
										  SELECT PimProductId ,'+[dbo].[Fn_GetPagingRowId](' DefaultOrderBy ',' RowId ')+' ,Count(*)Over() CountNo
										  INTO #Cte_getPagingData
										  FROM #Cte_GEtSortingProduct
									  


										  SELECT PimProductId ,RowId ,CountNo
										  INTO #Cte_GetAllData 
										  FROM #Cte_getPagingData
										  GROUP BY PimProductId ,RowId ,CountNo
									
									'
									--Print @SQL
									--Print '---------5--------'
									SET @SQL = @SQL + ' 

								 INSERT INTO  @TBL_PimProductId  (PimProductId,RowId,CountNo )
								 SELECT  PimProductId,RowId , CountNo
								 FROM #Cte_GetAllData '
								 +[dbo].[Fn_GetPaginationWhereClause](@PageNo,@Rows)

			SET @SQl = @InternalSQL+@SQL
     		END
			SET @SQl = @SQl + ' 
								SET @OutProductId = ISNULL(SUBSTRING((SELECT '',''+CAST(PimProductid AS VARCHAR(50)) 
										FROM @TBL_PimProductId TBPP
										ORDER BY RowId
										FOR XML PATH ('''')   ),2,4000),'''')
								SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM  @TBL_PimProductId TBPP),0)
							 
								IF OBJECT_ID(''#Cte_PimProductId'', ''U'') IS NOT NULL DROP TABLE #Cte_PimProductId
								IF OBJECT_ID(''#Cte_getAttributeValue'', ''U'') IS NOT NULL DROP TABLE #Cte_getAttributeValue
								IF OBJECT_ID(''#Cte_CollectData'', ''U'') IS NOT NULL DROP TABLE #Cte_CollectData
								IF OBJECT_ID(''#Cte_FilterDataLocale'', ''U'') IS NOT NULL DROP TABLE #Cte_FilterDataLocale
								IF OBJECT_ID(''#Cte_AttributeValueLocale'', ''U'') IS NOT NULL DROP TABLE #Cte_AttributeValueLocale
								IF OBJECT_ID(''#Cte_AttributeLocale'', ''U'') IS NOT NULL DROP TABLE #Cte_AttributeLocale
								IF OBJECT_ID(''#Cte_FinalProductData'', ''U'') IS NOT NULL DROP TABLE #Cte_FinalProductData
								IF OBJECT_ID(''#Cte_GEtSortingProduct'', ''U'') IS NOT NULL DROP TABLE #Cte_GEtSortingProduct
								IF OBJECT_ID(''#Cte_GetAllData'', ''U'') IS NOT NULL DROP TABLE #Cte_GetAllData
								IF OBJECT_ID(''#Cte_getPagingData'', ''U'') IS NOT NULL DROP TABLE #Cte_getPagingData
							 '
 
			EXEC SP_EXECUTESQl  @SQL ,N' @OutProductId VARCHAR(max) OUT ,@RowsCount INT OUT ,@TransferId TransferId READONLY  ',  @OutProductId = @OutProductId OUT, @RowsCount = @RowsCount OUT ,@TransferId  = @PimProductIds
		
     END TRY 
    BEGIN CATCH
	 DECLARE @Status BIT ;
		     SET @Status = 0;
			 SELECT ERROR_MESSAGE()
		  --   DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetProductIdForPaging @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@AccountList='+CAST(@AccountList AS VARCHAR(50))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
    --         SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
    --         EXEC Znode_InsertProcedureErrorLog
				--@ProcedureName = 'Znode_GetProductIdForPaging',
				--@ErrorInProcedure = @Error_procedure,
				--@ErrorMessage = @ErrorMessage,
				--@ErrorLine = @ErrorLine,
				--@ErrorCall = @ErrorCall;
	 END CATCH 
     END

GO

DELETE FROM ZnodeSearchProfileAttributeMapping
WHERE SearchProfileId=(SELECT TOP 1 SearchProfileId FROM ZnodeSearchProfile WHERE ProfileName='ZnodeSearchProfile')
	AND AttributeCode NOT IN ('ProductName','Brand','SKU')

INSERT INTO ZnodeSearchProfileAttributeMapping 
	(SearchProfileId,AttributeCode,IsFacets,IsUseInSearch,BoostValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsNgramEnabled)
SELECT 
(SELECT TOP 1 SearchProfileId FROM ZnodeSearchProfile WHERE ProfileName='ZnodeSearchProfile'),
'ProductName','false','true',NULL,2,GETDATE(),2,GETDATE(),'true'
WHERE NOT EXISTS (	SELECT TOP 1 1 FROM ZnodeSearchProfileAttributeMapping
					WHERE SearchProfileId=(SELECT TOP 1 SearchProfileId FROM ZnodeSearchProfile WHERE ProfileName='ZnodeSearchProfile')
						AND AttributeCode='ProductName'
				)

INSERT INTO ZnodeSearchProfileAttributeMapping 
	(SearchProfileId,AttributeCode,IsFacets,IsUseInSearch,BoostValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsNgramEnabled)
SELECT 
(SELECT TOP 1 SearchProfileId FROM ZnodeSearchProfile WHERE ProfileName='ZnodeSearchProfile'),
'Brand','true','false',NULL,2,GETDATE(),2,GETDATE(),'true'
WHERE NOT EXISTS (	SELECT TOP 1 1 FROM ZnodeSearchProfileAttributeMapping
					WHERE SearchProfileId=(SELECT TOP 1 SearchProfileId FROM ZnodeSearchProfile WHERE ProfileName='ZnodeSearchProfile')
						AND AttributeCode='Brand'
				)

INSERT INTO ZnodeSearchProfileAttributeMapping 
	(SearchProfileId,AttributeCode,IsFacets,IsUseInSearch,BoostValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsNgramEnabled)
SELECT 
(SELECT TOP 1 SearchProfileId FROM ZnodeSearchProfile WHERE ProfileName='ZnodeSearchProfile'),
'SKU','false','true',NULL,2,GETDATE(),2,GETDATE(),'true'
WHERE NOT EXISTS (	SELECT TOP 1 1 FROM ZnodeSearchProfileAttributeMapping
					WHERE SearchProfileId=(SELECT TOP 1 SearchProfileId FROM ZnodeSearchProfile WHERE ProfileName='ZnodeSearchProfile')
						AND AttributeCode='SKU'
				)

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSearchProfile')
	DROP PROC Znode_InsertUpdateSearchProfile
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSearchProfile]
(   
	@SearchProfileId       int,
    @ProfileName           nvarchar(200),
	@SearchQueryTypeId     int,
	@SearchSubQueryTypeId  int,
    @SearchProfileFeatureList SearchProfileFeatureList readonly ,
    @SearchProfileAttributeList SearchProfileAttributeList readonly ,
    @UserId                INT,
	@PublishCatalogId      int,
	@Operator			   nvarchar(20),	
	@IsDefault             bit=0,
	@SearchProfileFieldValue  SearchProfileFieldValueFactor  readonly
)
AS 
   /* 
    Summary: This Procedure is used to save and edit the quote line item      
    Unit Testing   
    Exec Znode_InsertUpdateQuoteLineItem 
	Unit Testing

	 GO 
	declare @p7 dbo.SearchProfileFetureList
	insert into @p7 values(N'0',1)

	declare @p8 dbo.SearchProfileAttributeList
	insert into @p8 values(N'ProductSpecification',0,0,1)
	insert into @p8 values(N'ShortDescription',0,0,3)
	insert into @p8 values(N'ProductName',0,0,2)
	insert into @p8 values(N'FeatureDescription',0,0,4)
	insert into @p8 values(N'SKU',0,0,5)

	exec sp_executesql N'Znode_InsertUpdateSearchProfile  @SearchProfileId,@ProfileName,@SearchQueryTypeId,@SearchSubQueryTypeId,@SearchProfileFeatureList,@SearchProfileAttributeList,@UserId,@PublishCatalogId,@Operator,@IsDefault',N'@SearchProfileId int,
		@ProfileName nvarchar(17),@SearchQueryTypeId int,@SearchSubQueryTypeId int,@SearchProfileFeatureList [dbo].[SearchProfileFetureList] READONLY,@SearchProfileAttributeList [dbo].[SearchProfileAttributeList] READONLY,@UserId int,@PublishCatalogId int,
		@Operator nvarchar(2),@IsDefault bit',@SearchProfileId=0,@ProfileName=N'FineFoodsProfile1',@SearchQueryTypeId=2,@SearchSubQueryTypeId=0,@SearchProfileFeatureList=@p7,@SearchProfileAttributeList=@p8,@UserId=0,@PublishCatalogId=3,@Operator=N'OR',@IsDefault=0
	*/
BEGIN
	DECLARE @GetDate DATETIME = dbo.Fn_GetDate(),@PublishCatalogSearchProfileId int ,@ReturnMessage  NVARCHAR(max)= ''
  
         BEGIN TRAN A;
         BEGIN TRY
		  IF ISNULL(@SEARCHPROFILEID,0)=0  
		  BEGIN
			IF EXISTS (SELECT TOP 1 1 from ZnodeSearchProfile ZSP WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogSearchProfile PCP WHERE PCP.PublishCatalogId =@PublishCatalogId AND PCP.SearchProfileId =ZSP.SearchProfileId   ) AND ProfileName = @ProfileName  )
			BEGIN 
				SELECT @SearchProfileId AS ID,'ProfileName Already Exists' As MessageDetails,CAST(0 AS BIT) AS Status;   	  
				Return ; 
			END 
			INSERT INTO [dbo].[ZnodeSearchProfile] ([ProfileName],[SearchQueryTypeId],[SearchSubQueryTypeId],[Operator],[CreatedBy],[CreatedDate],[ModifiedBy],[ModifiedDate],[PublishStateId])
			Select @ProfileName,@SearchQueryTypeId,@SearchSubQueryTypeId,@Operator,@UserId,@GetDate,@UserId,@GetDate,
				(SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE StateName='Not Published')
			Set @SearchProfileId=SCOPE_IDENTITY()
		  End
		  else 
		  Begin
			IF EXISTS (SELECT TOP 1 1  FROM [ZnodeSearchProfile] ZSP WHERE [ProfileName] = @ProfileName AND 
			EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogSearchProfile PCP WHERE PCP.PublishCatalogId =@PublishCatalogId AND PCP.SearchProfileId =ZSP.SearchProfileId   ) AND 
			 ZSP.SearchProfileId <>  Isnull(@SearchProfileId,0)  )
			BEGIN 
				SELECT @SearchProfileId AS ID,'ProfileName Already Exists' As MessageDetails,CAST(0 AS BIT) AS Status;   	  
				Return ; 
			END 

		    Update a
			Set a.[ProfileName]=@ProfileName,
			a.SearchQueryTypeId=@SearchQueryTypeId,
			a.SearchSubQueryTypeId=@SearchSubQueryTypeId,
			a.Operator = @Operator,
			a.PublishStateId=(SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE StateName='Draft'),
			a.ModifiedBy=@UserId,
			a.ModifiedDate=@GetDate
			from [dbo].[ZnodeSearchProfile] a
			Where SearchProfileId=@SearchProfileId
		    
		  End 

		  delete f
		  from ZnodeSearchProfileAttributeMapping f
		  Where SearchProfileId=@SearchProfileId
		  and not exists(Select 1 from @SearchProfileAttributeList d
		  where f.AttributeCode=d.AttributeCode )
		  AND f.IsFacets = 0

		  INSERT INTO [dbo].ZnodeSearchProfileAttributeMapping([SearchProfileId],[AttributeCode],[IsFacets],[IsUseInSearch],[BoostValue],[IsNgramEnabled],[CreatedBy],[CreatedDate],[ModifiedBy],[ModifiedDate])
		  Select @SearchProfileId,[AttributeCode],[IsFacets],[IsUseInSearch],[BoostValue],[IsNgramEnabled],@UserId [CreatedBy],@GetDate[CreatedDate],@UserId [ModifiedBy],@GetDate [ModifiedDate]
		   from @SearchProfileAttributeList d
		  where  not exists(Select 1 from ZnodeSearchProfileAttributeMapping f
		  where f.AttributeCode=d.AttributeCode 
		  and f.SearchProfileId=@SearchProfileId)

		  Update f
		  Set f.[IsFacets]=(CASE WHEN d.[IsFacets]=0 THEN f.[IsFacets] ELSE d.[IsFacets] END),f.[IsUseInSearch]=d.[IsUseInSearch],
		  f.[BoostValue]=d.[BoostValue],
		  f.[IsNgramEnabled] = d.[IsNgramEnabled]
		  From [dbo].ZnodeSearchProfileAttributeMapping f
		  inner join @SearchProfileAttributeList d
		  on f.AttributeCode=d.AttributeCode
		   and f.SearchProfileId=@SearchProfileId
		   --WHERE f.IsUseInSearch = 1

		    UPDATE f
			SET f.[IsUseInSearch]=0
			FROM [dbo].ZnodeSearchProfileAttributeMapping f
			LEFT JOIN @SearchProfileAttributeList d ON f.AttributeCode=d.AttributeCode AND f.SearchProfileId=@SearchProfileId
			WHERE f.SearchProfileId=@SearchProfileId AND d.[IsUseInSearch] IS NULL

		   delete f
		  from [ZnodeSearchProfileFeatureMapping] f
		  Where SearchProfileId=@SearchProfileId
		  and not exists(Select 1 from @SearchProfileFeatureList d
		  where f.SearchFeatureId=d.SearchProfileFeatureId )

		  INSERT INTO [dbo].[ZnodeSearchProfileFeatureMapping]([SearchProfileId],SearchFeatureId,[SearchFeatureValue],[CreatedBy],[CreatedDate],[ModifiedBy],[ModifiedDate])
		  Select @SearchProfileId,d.SearchProfileFeatureId,[SearchFeatureValue]
		  ,@UserId [CreatedBy],@GetDate[CreatedDate],@UserId [ModifiedBy],@GetDate [ModifiedDate]
		   from @SearchProfileFeatureList d
		  where  not exists(Select 1 from [ZnodeSearchProfileFeatureMapping] f
		  where f.SearchFeatureId=d.SearchProfileFeatureId 
		  and f.SearchProfileId=@SearchProfileId)

		  Update f
		  Set f.[SearchFeatureValue]=d.SearchFeatureValue,
		  f.ModifiedBy=@UserId,
		  f.ModifiedDate=@GetDate
		  From [dbo].[ZnodeSearchProfileFeatureMapping] f
		  inner join @SearchProfileFeatureList d
		  on f.SearchFeatureId=d.SearchProfileFeatureId  and f.SearchProfileId=@SearchProfileId
          
		   Select @PublishCatalogSearchProfileId=PublishCatalogSearchProfileId
		   From  [dbo].[ZnodePublishCatalogSearchProfile]
		   Where [PublishCatalogId]=@PublishCatalogId and  SearchProfileId = @SearchProfileId 


		   If @IsDefault=1
		      update [ZnodePublishCatalogSearchProfile]
			  set [IsDefault]=@IsDefault,
			  ModifiedBy=@UserId,
		      ModifiedDate=@GetDate
			  From  [ZnodePublishCatalogSearchProfile]
			  Where PublishCatalogSearchProfileId!=@PublishCatalogSearchProfileId
			  and [PublishCatalogId]=@PublishCatalogId

		   If Isnull(@PublishCatalogSearchProfileId,0)>0
		   Begin
		      update [ZnodePublishCatalogSearchProfile]
			  set [IsDefault]=@IsDefault,
			  ModifiedBy=@UserId,
		      ModifiedDate=@GetDate
			  From  [ZnodePublishCatalogSearchProfile]
			  Where PublishCatalogSearchProfileId=@PublishCatalogSearchProfileId
		   End
		   Else
		   INSERT INTO [dbo].[ZnodePublishCatalogSearchProfile] ([PublishCatalogId],[SearchProfileId],[IsDefault],[CreatedBy],[CreatedDate],[ModifiedBy],[ModifiedDate])
		   Select @PublishCatalogId,@SearchProfileId,@IsDefault,@UserId,@GetDate,@UserId,@GetDate

		   DELETE VF
		   FROM ZnodeSearchProfileFieldValueFactor VF
		   WHERE VF.SearchProfileId = @SearchProfileId
		   AND NOT EXISTS (SELECT 1 FROM @SearchProfileFieldValue SFP WHERE SFP.FieldName = VF.FieldName)


		   INSERT INTO ZnodeSearchProfileFieldValueFactor (SearchProfileId,FieldName,FieldValueFactor,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		   SELECT @SearchProfileId,SPF.FieldName,SPF.FieldValueFactor,@UserId,@GetDate,@UserId,@GetDate
		   FROM @SearchProfileFieldValue SPF
		   WHERE NOT EXISTS (SELECT 1 FROM ZnodeSearchProfileFieldValueFactor pf WHERE pf.FieldName = SPF.FieldName AND pf.SearchProfileId = @SearchProfileId)

		   UPDATE VF
		   SET FieldValueFactor = SPF.FieldValueFactor
		   FROM ZnodeSearchProfileFieldValueFactor VF
		   INNER JOIN @SearchProfileFieldValue SPF ON (SPF.FieldName = VF.FieldName) AND VF.SearchProfileId = @SearchProfileId


		  SELECT @SearchProfileId AS ID,'Successfull' MessageDetails,CAST(1 AS BIT) AS Status;   			
			 COMMIT TRAN A;
         END TRY
         BEGIN CATCH
        
		    -- SET @Status = 0;
		  ----   DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			 ----@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertUpdateQuoteLineItem @CartLineItemXML = '+CAST(@CartLineItemXML AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,'UnSuccessfull' MessageDetails,CAST(0 AS BIT) AS Status;                    
			 ROLLBACK TRAN A;
    --         EXEC Znode_InsertProcedureErrorLog
				--@ProcedureName = 'Znode_InsertUpdateQuoteLineItem',
				--@ErrorInProcedure = @Error_procedure,
				--@ErrorMessage = @ErrorMessage,
				--@ErrorLine = @ErrorLine,
				--@ErrorCall = @ErrorCall;
         END CATCH;
END;

GO

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'Customer','UpdateUsernameForRegisteredUser',1,2,Getdate(),2,Getdate()
where not exists(select * from ZnodeActions where ControllerName = 'Customer' and ActionName = 'UpdateUsernameForRegisteredUser')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
 (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Users' AND ControllerName = 'Customer')
    ,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Customer' and ActionName= 'UpdateUsernameForRegisteredUser') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
     (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Users' AND ControllerName = 'Customer') and ActionId =
     (select TOP 1 ActionId from ZnodeActions where ControllerName = 'Customer' and ActionName= 'UpdateUsernameForRegisteredUser'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Users' AND ControllerName = 'Customer')
,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Customer' and ActionName= 'UpdateUsernameForRegisteredUser')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Users' AND ControllerName = 'Customer') and ActionId =
     (select TOP 1 ActionId from ZnodeActions where ControllerName = 'Customer' and ActionName= 'UpdateUsernameForRegisteredUser'))

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'Custom1' AND Object_ID = Object_ID(N'dbo.ZnodeCaseRequest'))
BEGIN
	ALTER TABLE ZnodeCaseRequest ADD Custom1 NVARCHAR (MAX)  NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'Custom2' AND Object_ID = Object_ID(N'dbo.ZnodeCaseRequest'))
BEGIN
	ALTER TABLE ZnodeCaseRequest ADD Custom2 NVARCHAR (MAX)  NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'Custom3' AND Object_ID = Object_ID(N'dbo.ZnodeCaseRequest'))
BEGIN
	ALTER TABLE ZnodeCaseRequest ADD Custom3 NVARCHAR (MAX)  NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'Custom4' AND Object_ID = Object_ID(N'dbo.ZnodeCaseRequest'))
BEGIN
	ALTER TABLE ZnodeCaseRequest ADD Custom4 NVARCHAR (MAX)  NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'Custom5' AND Object_ID = Object_ID(N'dbo.ZnodeCaseRequest'))
BEGIN
	ALTER TABLE ZnodeCaseRequest ADD Custom5 NVARCHAR (MAX)  NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'Custom1' AND Object_ID = Object_ID(N'dbo.ZnodeFormBuilder'))
BEGIN
	ALTER TABLE ZnodeFormBuilder ADD Custom1 NVARCHAR (MAX)  NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'Custom2' AND Object_ID = Object_ID(N'dbo.ZnodeFormBuilder'))
BEGIN
	ALTER TABLE ZnodeFormBuilder ADD Custom2 NVARCHAR (MAX)  NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'Custom3' AND Object_ID = Object_ID(N'dbo.ZnodeFormBuilder'))
BEGIN
	ALTER TABLE ZnodeFormBuilder ADD Custom3 NVARCHAR (MAX)  NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'Custom4' AND Object_ID = Object_ID(N'dbo.ZnodeFormBuilder'))
BEGIN
	ALTER TABLE ZnodeFormBuilder ADD Custom4 NVARCHAR (MAX)  NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'Custom5' AND Object_ID = Object_ID(N'dbo.ZnodeFormBuilder'))
BEGIN
	ALTER TABLE ZnodeFormBuilder ADD Custom5 NVARCHAR (MAX)  NULL;
END

GO

--UPDATE ZnodeImportAttributeValidation 
--SET ValidationValue=300, ValidationName = 'MaxCharacters',ControlName = 'Number'  
--WHERE AttributeCode ='CategoryCode' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='CatalogCategoryAssociation' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

--GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCustomer')
	DROP PROC Znode_ImportCustomer
GO

CREATE PROCEDURE [dbo].[Znode_ImportCustomer]
(
	  @TableName NVARCHAR(100), 
	  @Status BIT OUT, 
	  @UserId INT, 
	  @ImportProcessLogId INT, 
	  @NewGUId NVARCHAR(200), 
	  @LocaleId INT= 0,
	  @PortalId INT ,
	  @CsvColumnString NVARCHAR(max)
)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Customer Details
	
	-- Unit Testing : 
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(max),@AspNetZnodeUserId NVARCHAR(256),@ASPNetUsersId NVARCHAR(256),
		@PasswordHash NVARCHAR(max),@SecurityStamp NVARCHAR(max),@RoleId NVARCHAR(256),@IsAllowGlobalLevelUserCreation NVARCHAR(10)
		Declare @ProfileId  INT
		DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		 
		SET @SecurityStamp = '0wVYOZNK4g4kKz9wNs-UHw2'
		SET @PasswordHash = 'APy4Tm1KbRG6oy7h3r85UDh/lCW4JeOi2O2Mfsb3OjkpWTp1YfucMAvvcmUqNaSOlA==';

		SELECT  @RoleId  = Id FROM AspNetRoles WHERE   NAME = 'User'  

		SELECT @IsAllowGlobalLevelUserCreation = FeatureValues FROM ZnodeGlobalsetting WHERE FeatureName = 'AllowGlobalLevelUserCreation'

		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
		-- Retrive RoundOff Value FROM global setting 
		Delete from ZnodeImportLog where ErrorDescription = '42' and ColumnName like '%AccountCode%' and  ImportProcessLogId= @ImportProcessLogId
		
		
		
		-- Three type of import required three table varible for product , category and brand
		CREATE TABLE #InsertCustomer 
		( 
			RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, UserName NVARCHAR(512) ,FirstName	NVARCHAR(200),
			LastName NVARCHAR(200), BudgetAmount	NUMERIC,Email	NVARCHAR(100),PhoneNumber	NVARCHAR(100),
		    EmailOptIn	varchar(100)	,ReferralStatus	NVARCHAR(40),IsActive	varchar(100)	,ExternalId	NVARCHAR(max),CreatedDate DATETIME,
			ProfileName varchar(200),AccountCode NVARCHAR(100),DepartmentName varchar(300),RoleName NVARCHAR(256), GUID NVARCHAR(400)
			,PerOrderLimit INT,	PerOrderAnnualLimit NVARCHAR(100),BillingAccountNumber NVARCHAR(100),EnableUserShippingAddressSuggestion  NVARCHAR(100),
			EnablePowerBIReportOnWebStore BIT,Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),
			Custom4 NVARCHAR(max),Custom5 NVARCHAR(max), SMSOptIn varchar(100)
		);

		SET @SSQL = 'INSERT INTO #InsertCustomer( RowNumber,' + @CsvColumnString + ',GUID)
		             SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+ @TableName;
		
		EXEC sys.sp_sqlexec @SSQL;

	    --If Account Code Exists then it will update as it is and if not exists then it will show error.
		UPDATE IC set AccountCode = ZA.AccountCode 
		FROM ZnodeUser a
		inner join ZnodeAccount ZA on (ZA.AccountId = a.AccountId)
		INNER JOIN #InsertCustomer IC on (IC.UserName = a.UserName)
		WHERE ISNULL(IC.AccountCode,'') = '' AND ISNULL(IC.RoleName,'') <> ''

		if @CsvColumnString not like '%AccountCode%'
		begin
			--If Acount Code Exists then it will update as it is and if not exists then it will show error.
			update IC set AccountCode = ZA.AccountCode
			FROM ZnodeUser a
			inner join ZnodeAccount ZA on (ZA.AccountId = a.AccountId)
			INNER JOIN #InsertCustomer IC on (IC.UserName = a.UserName)
			WHERE isnull(IC.AccountCode,'') = '' --and isnull(IC.RoleName,'') <> ''
		end
		
		SELECT TOP 1 @ProfileId   =  ProfileId FROM ZnodePortalprofile WHERE Portalid = @Portalid and IsDefaultRegistedProfile=1
		IF( Isnull(@ProfileId ,0) = 0 ) 
		Begin
		
		
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '62', 'Default Portal Profile', '', @NewGUId, 1 , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
							
				UPDATE ZnodeImportProcessLog
				SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
				WHERE ImportProcessLogId = @ImportProcessLogId;
			

				SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog 
				WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
				SELECT @SuccessRecordCount = 0

				UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
				TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
				WHERE ImportProcessLogId = @ImportProcessLogId;

				DELETE FROM #InsertCustomer 
				SET @Status = 0;

				COMMIT TRAN A;
				Return 0 
		End

		--If @IsAllowGlobalLevelUserCreation = 'false'  
		--BEGIN
		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		--SELECT '10', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		--FROM #InsertCustomer AS ii  
		--WHERE ltrim(rtrim(ii.UserName)) in   
		--(  
		--SELECT UserName FROM AspNetZnodeUser   where PortalId = @PortalId  
		--);  
		--END
		--Else   
		IF @IsAllowGlobalLevelUserCreation = 'true'
		BEGIN
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '10', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM #InsertCustomer AS ii  
			WHERE ltrim(rtrim(ii.UserName)) in   
			(  
			SELECT UserName FROM AspNetZnodeUser     
			);  
		END


		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '104', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName not like '%_@_%_.__%' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '35', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName like '%;%'
				
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '30', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ltrim(rtrim(ii.UserName)) IN 
		(SELECT ltrim(rtrim(UserName))  FROM #InsertCustomer GROUP BY ltrim(rtrim(UserName))  having count(*) > 1 )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '104', 'Email', Email, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.Email not like '%_@_%_.__%' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'IsActive',  IsActive , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '77', 'AccountCode', ii.AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer ii 
		WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !='' 
		AND NOT EXISTS(SELECT * FROM ZnodeAccount za INNER JOIN ZnodePortalAccount zpa on za.AccountId = zpa.AccountId
			WHERE  ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za.AccountCode and zpa.PortalId = @PortalId )
		AND EXISTS(SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount za1 WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za1.AccountCode );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '73', 'AccountCode', AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !=''   and ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') not IN 
		(
			SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount   
		);


		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '75', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') ='' and ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '74', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE --ltrim(rtrim(ii.RoleName)) not IN ('User','Manager','Administrator') and ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and
			ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and not exists (SELECT top 1 1 FROM  AspNetRoles ANR WHERE name IN ('User','Manager','Administrator') and  ANR.name =ii.RoleName)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '76', 'DepartmentName', DepartmentName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') <> ''
		AND NOT EXISTS(SELECT * FROM  ZnodeAccount ZA INNER JOIN ZnodeDepartment ZD on ZA.AccountId = ZD.AccountId
			WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = ltrim(rtrim(za.AccountCode))
			and ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') = ltrim(rtrim(ZD.DepartmentName)))

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'EmailOptIn',  EmailOptIn , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.EmailOptIn NOT IN ('True','1','Yes','FALSE','0','No','');

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'SMSOptIn',  SMSOptIn , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.SMSOptIn NOT IN ('True','1','Yes','FALSE','0','No','');

		UPDATE ZIL
		SET ZIL.ColumnName =   ZIL.ColumnName + ' [ UserName - ' + ISNULL(UserName,'') + ' ] '
		FROM ZnodeImportLog ZIL 
		INNER JOIN #InsertCustomer IPA ON (ZIL.RowNumber = IPA.RowNumber)
		WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		--Note : Content page import is not required 
		
		-- END Function Validation 	
		-----------------------------------------------
		--- Delete Invalid Data after functional validatin  

		DELETE FROM #InsertCustomer
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
			--AND GUID = @NewGUID
		);


		-- Update Record count IN log 
        
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		SELECT @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertCustomer
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- END

		-- Insert Product Data 
				
				
				DECLARE @InsertedAspNetZnodeUser TABLE (AspNetZnodeUserId NVARCHAR(256) ,UserName NVARCHAR(512),PortalId INT )
				DECLARE @InsertedASPNetUsers TABLE (Id NVARCHAR(256) ,UserName NVARCHAR(512))
				DECLARE @InsertZnodeUser TABLE (UserId INT,AspNetUserId NVARCHAR(256),CreatedDate DATETIME )

				UPDATE ANU SET 
				ANU.PhoneNumber	= IC.PhoneNumber, 
					ANU.LockoutEndDateUtc = case when IC.IsActive IN('0','No','False') then @GetDate when IC.IsActive IN('1','Yes','True') then null else ANU.LockoutEndDateUtc END
				FROM AspNetZnodeUser ANZU 
				INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
				WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
				----Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

				UPDATE ZU SET 
				ZU.FirstName	= IC.FirstName,
				ZU.LastName		= IC.LastName,
				--ZU.MiddleName	= IC.MiddleName,
				ZU.BudgetAmount = IC.BudgetAmount,
				ZU.Email		= IC.Email,
				ZU.PhoneNumber	= IC.PhoneNumber,
				ZU.EmailOptIn	= (CASE IC.EmailOptIn WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.EmailOptIn,0) As BIT) END),
				ZU.IsActive		= (CASE IC.IsActive WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.IsActive,0) As BIT) END),
				ZU.Custom1 = IC.Custom1,
				ZU.Custom2 = IC.Custom2,
				ZU.Custom3 = IC.Custom3,
				ZU.Custom4 = IC.Custom4,
				ZU.Custom5 = IC.Custom5,
				ZU.SMSOptIn	= (CASE IC.SMSOptIn WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 WHEN ISNULL(IC.SMSOptIn,'') THEN ZU.SMSOptIn ELSE CAST(ISNULL(IC.SMSOptIn,0) As BIT) END)
				--ZU.ExternalId = ExternalId
				FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
				WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
				--WHERE Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

				INSERT INTO AspNetZnodeUser (AspNetZnodeUserId, UserName, PortalId)		
				OUTPUT INSERTED.AspNetZnodeUserId, INSERTED.UserName, INSERTED.PortalId	INTO  @InsertedAspNetZnodeUser 			 
				SELECT NEWID(),IC.UserName, @PortalId FROM #InsertCustomer IC 
				WHERE NOT EXISTS (SELECT TOP 1 1  FROM AspNetZnodeUser ANZ 
					WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZ.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END 
					AND ANZ.UserName = IC.UserName)

				INSERT INTO ASPNetUsers (Id,Email,EmailConfirmed,PasswordHash,SecurityStamp,PhoneNumber,PhoneNumberConfirmed,TwoFactorEnabled,
				LockoutEndDateUtc,LockOutEnabled,AccessFailedCount,PasswordChangedDate,UserName)
				OUTPUT inserted.Id, inserted.UserName INTO @InsertedASPNetUsers
				SELECT NewId(), Email,0 ,@PasswordHash,@SecurityStamp,PhoneNumber,0,0,case when A.IsActive IN ('0','False','No') then @GetDate else null END LockoutEndDateUtc,1 LockoutEnabled,
				0,@GetDate,AspNetZnodeUserId FROM #InsertCustomer A INNER JOIN @InsertedAspNetZnodeUser  B 
				ON A.UserName = B.UserName
			
				INSERT INTO  ZnodeUser(AspNetUserId,FirstName,LastName,CustomerPaymentGUID,Email,PhoneNumber,EmailOptIn,
				IsActive,ExternalId, CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,UserName,Custom1,Custom2,Custom3,Custom4,Custom5,SMSOptIn)
				OUTPUT Inserted.UserId, Inserted.AspNetUserId,Inserted.CreatedDate INTO @InsertZnodeUser
				SELECT IANU.Id AspNetUserId ,IC.FirstName,IC.LastName,null CustomerPaymentGUID,IC.Email
				,IC.PhoneNumber,
				(CASE IC.EmailOptIn WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.EmailOptIn,0) As BIT) END),
				(CASE IC.IsActive WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.IsActive,0) As BIT) END),
				IC.ExternalId, @UserId,
				CASE WHEN IC.CreatedDate IS NULL OR IC.CreatedDate = '' THEN  @Getdate ELSE IC.CreatedDate END,
				@UserId,@Getdate,IC.UserName,IC.Custom1,IC.Custom2,IC.Custom3,IC.Custom4,IC.Custom5,
					(CASE IC.SMSOptIn WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.SMSOptIn,0) As BIT) END)
				FROM #InsertCustomer IC INNER JOIN 
				@InsertedAspNetZnodeUser IANZU ON IC.UserName = IANZU.UserName  INNER JOIN 
				@InsertedASPNetUsers IANU ON IANZU.AspNetZnodeUserId = IANU.UserName 
	  	     
				INSERT INTO AspNetUserRoles (UserId,RoleId)  SELECT AspNetUserId, @RoleID FROM @InsertZnodeUser 
				INSERT INTO ZnodeUserPortal (UserId,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
				SELECT UserId, @PortalId , @UserId, IZU.CreatedDate,@UserId,@Getdate 
				FROM @InsertZnodeUser IZU

				INSERT INTO ZnodeAccountUserPermission(UserId,AccountPermissionAccessId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT UserId, 4 , @UserId, @Getdate,@UserId,@Getdate 
				FROM @InsertZnodeUser IZU
		
				------------INSERT INTO ZnodeUserGlobalAttributeValue
	
				IF OBJECT_ID('tempdb..#globaldata') IS NOT NULL 
					DROP TABLE #globaldata
				
				SELECT ZU.userid,PerOrderLimit,
					PerOrderAnnualLimit,
					BillingAccountNumber,
					EnableUserShippingAddressSuggestion,
					EnablePowerBIReportOnWebStore 
				INTO #globaldata
				FROM znodeuser ZU INNER JOIN  #InsertCustomer IC on IC.Email =ZU.EMAIL
				WHERE ZU.userid IN (SELECT userid FROM @InsertZnodeUser)
				GROUP BY ZU.userid,PerOrderLimit,
									PerOrderAnnualLimit,
									BillingAccountNumber,
									EnableUserShippingAddressSuggestion,
									EnablePowerBIReportOnWebStore 

				IF OBJECT_ID('tempdb..#globaldata1') IS NOT NULL DROP TABLE #globaldata1
				SELECT * INTO #globaldata1 FROM (SELECT userid, Cast(PerOrderLimit as varchar(100)) PerOrderLimit,
				 Cast(PerOrderAnnualLimit as varchar(100)) PerOrderAnnualLimit,
				 Cast(BillingAccountNumber as varchar(100)) BillingAccountNumber,
				 Cast(case when cast(EnableUserShippingAddressSuggestion as varchar(10))= '1' or cast(EnableUserShippingAddressSuggestion as varchar(10)) ='YES' or  cast(EnableUserShippingAddressSuggestion as varchar(10)) ='True' then 'True' else 'False'  END  as varchar(100)) EnableUserShippingAddressSuggestion,
				 Cast(case when cast(EnablePowerBIReportOnWebStore as varchar(10))= '1'  or cast(EnablePowerBIReportOnWebStore as varchar(10)) ='YES' or  cast(EnablePowerBIReportOnWebStore as varchar(10)) ='True' then 'True' else 'False' END  as varchar(100)) EnablePowerBIReportOnWebStore FROM #globaldata) ab
				UNPIVOT  
				   (avalue FOR acode IN   
					  (PerOrderLimit,
				PerOrderAnnualLimit,
				BillingAccountNumber,
				EnableUserShippingAddressSuggestion,
				EnablePowerBIReportOnWebStore)  
				)AS unpvt;  

				INSERT INTO ZnodeUserGlobalAttributeValue (UserId,	GlobalAttributeId,	GlobalAttributeDefaultValueId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
				SELECT g.Userid,ZGA.GlobalAttributeId,null,null,@UserId,@Getdate,@UserId,@Getdate
					FROM #globaldata1 g INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.acode
					WHERE NOT EXISTS (SELECT top 1 1 FROM ZnodeUserGlobalAttributeValue ZGAV WHERE ZGAV.Userid =g.Userid and ZGA.GlobalAttributeId=ZGAV.GlobalAttributeId)

				INSERT INTO ZnodeUserGlobalAttributeValuelocale(UserGlobalAttributeValueId,	LocaleId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate,	GlobalAttributeDefaultValueId,	MediaId,	MediaPath)
				SELECT UserGlobalAttributeValueId, @LocaleId,avalue ,@UserId,@Getdate,@UserId,@Getdate,null,null,null
					FROM ZnodeUserGlobalAttributeValue ZUGAV INNER JOIN #globaldata1 g on ZUGAV.userid =g.userid
						INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.acode and ZGA.GlobalAttributeId = ZUGAV.GlobalAttributeId
						WHERE NOT EXISTS (SELECT Top 1 1 FROM ZnodeUserGlobalAttributeValuelocale z WHERE z.UserGlobalAttributeValueId = ZUGAV.UserGlobalAttributeValueId)

				---------------------------------------------------------------------------------

				declare @Profile table (ProfileId INT)

				INSERT INTO ZnodeProfile (ProfileName,ShowOnPartnerSignup,Weighting,TaxExempt,DefaultExternalAccountNo,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ParentProfileId)
				OUTPUT inserted.ProfileId INTO @Profile(ProfileId)
				SELECT Distinct ProfileName, 0, null,0, replace(ltrim(rtrim(ProfileName)),' ','') as DefaultExternalAccountNo, @UserId,@Getdate, @UserId,@Getdate, null as ParentProfileId				
				FROM #InsertCustomer IC
				WHERE NOT EXISTS(SELECT * FROM ZnodeProfile ZP WHERE IC.ProfileName = ZP.ProfileName )
				AND ISNULL(ic.ProfileName,'') <> ''

				INSERT INTO ZnodePortalProfile (PortalId,	ProfileId,	IsDefaultAnonymousProfile,	IsDefaultRegistedProfile,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
				SELECT @PortalId, ProfileId, 0 AS IsDefaultAnonymousProfile, 0 AS IsDefaultRegistedProfile, @UserId,@Getdate, @UserId,@Getdate
				FROM @Profile

				UPDATE ZnodeUserProfile 
				SET ProfileId = COALESCE(ZP.ProfileId,@ProfileId)
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeUserProfile u ON u.UserId = a.UserId
				LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
				--WHERE IC.ProfileName <> ''
				
				INSERT INTO ZnodeUserProfile (ProfileId,UserId,IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT COALESCE(ZP.ProfileId,@ProfileId)  , a.UserId, 1 , @UserId,a.CreatedDate,@UserId,@Getdate 
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeUserProfile u WHERE u.UserId = a.UserId )
				AND EXISTS(SELECT * FROM @InsertZnodeUser IZU WHERE A.UserId = IZU.UserId)

				--Updating RoleName if customer has changed the account and RoleName left blank then by default User role assigned to the customer
				UPDATE u set u.RoleId = @RoleId
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN AspNetUserRoles u on u.UserId = b.Id
				WHERE isnull(IC.AccountCode,'') <> '' AND isnull(IC.RoleName,'') = ''
				AND EXISTS(SELECT * FROM ZnodeAccount ZA WHERE ISNULL(a.AccountId,0) = ZA.AccountId AND ZA.AccountCode <> IC.AccountCode)

				---to update accountid agaist user
				UPDATE ZU SET ZU.AccountId = ZA.AccountId 
				FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	 
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName
				INNER JOIN ZnodeAccount ZA ON ZA.AccountCode = IC.AccountCode 
				--INNER JOIN @InsertZnodeUser IZU on IZU.UserId =ZU.UserId
				WHERE Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0) and isnull(IC.AccountCode,'') <> '' 
				--EXISTS (SELECT * FROM #InsertCustomer IC WHERE IC.AccountCode = ZA.AccountCode AND ISNULL(IC.AccountCode,'') = '' AND ISNULL(IC.RoleName,'') <> '' )

				
				update ZDU set ZDU.DepartmentId = ZD.DepartmentId, ModifiedBy = @UserId, ModifiedDate = @Getdate
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
				INNER JOIN ZnodeDepartmentUser ZDU on ZDU.UserId = a.UserId
				WHERE isnull(IC.DepartmentName,'') <> ''


				INSERT INTO ZnodeDepartmentUser(UserId,DepartmentId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT a.UserId, ZD.DepartmentId, @UserId,a.CreatedDate,@UserId,@Getdate 
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeDepartmentUser u WHERE u.UserId = a.UserId)
				AND isnull(IC.DepartmentName,'') <> ''
		
				update u set u.RoleId = ZD.Id
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
				INNER JOIN AspNetUserRoles u on u.UserId = b.Id
				WHERE isnull(IC.RoleName,'') <> '' 


				--when RoleName and AccountCode is null in update file then If a value was available previously, then it should be removed (along with Department and Role Name) 
				--after the update process is complete.
				DELETE UR FROM AspNetUserRoles UR 
				INNER JOIN ZnodeUser ZC	ON  ZC.AspNetUserId = UR.UserId
				WHERE EXISTS (SELECT * FROM #InsertCustomer IC WHERE IC.UserName = ZC.UserName AND (ISNULL(IC.RoleName,'') = '' AND ISNULL(IC.AccountCode,'') = ''))


				UPDATE ZnodeUser SET AccountId = NULL 
				WHERE EXISTS (SELECT * FROM #InsertCustomer IC WHERE IC.UserName = ZnodeUser.UserName AND ISNULL(IC.AccountCode,'') = '' AND ISNULL(IC.RoleName,'') = '' )		

		
				INSERT INTO AspNetUserRoles(UserId,RoleId)
				SELECT b.Id as ASPNetUserId, case when ZD.Id is null then @RoleId else ZD.Id end  as RoleId
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				LEFT JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM AspNetUserRoles u WHERE u.UserId = b.Id)
				AND ISNULL(IC.AccountCode,'') <> ''
			
				--If no value was available previously then no value should be saved after the update process is complete.
				--If a value was available previously, then it should be removed after the update process is complete.
				DELETE DU FROM ZnodeDepartmentUser DU
				INNER JOIN ZnodeUser ZU ON DU.UserId = ZU.UserId
				INNER JOIN ZnodeDepartment ZC ON  ZC.DepartmentId = DU.DepartmentId
				WHERE EXISTS (SELECT * FROM #INSERTCUSTOMER IC WHERE IC.UserName = ZU.UserName AND (ISNULL(IC.DepartmentName,'') = '' OR ISNULL(IC.ACCOUNTCODE,'') = ''))


		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
		 DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCustomer @TableName = '+CAST(@TableName AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@PortalId='+CAST(@PortalId AS VARCHAR(10))+',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max));
              	
		 ---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

        EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportCustomer',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeletePublishCatalogEntity')
	DROP PROC Znode_DeletePublishCatalogEntity
GO

CREATE PROCEDURE [dbo].[Znode_DeletePublishCatalogEntity]
(
    @PublishCatalogId  INT = 0 
   ,@UserId int = 0
   ,@IsRevertPublish bit = 0 
   ,@NewGUID nvarchar(500) 

)
AS
/*
	To Remove all publish catalog details from related entities
	Unit Testing : 
	Declare @Status bit 
	Exec [dbo].[ZnodePublishPortalEntity]
     @PortalId  = 1 
	,@LocaleId  = 0 
	,@RevisionState = 'PRODUCTION' 
	,@UserId = 2
	,@Status = @Status 
	--Select @Status 
*/
BEGIN
SET NOCOUNT ON
BEGIN TRY 
Begin Transaction 
--SET NOCOUNT ON
		Declare @Status Bit =0, @IsPreviewEnable  int,  @Batch INT;
		IF object_id('tempdb..[#Tbl_VersionEntity]') IS NOT NULL
			drop table tempdb..#Tbl_VersionEntity
		
		Create Table #Tbl_VersionEntity(PublishCatalogId int , VersionId int , LocaleId int , PublishType varchar(50))
		Insert into #Tbl_VersionEntity (PublishCatalogId , VersionId , LocaleId , PublishType )
			select ZnodeCatalogId , VersionId , LocaleId , RevisionType  from ZnodePublishVersionEntity   where ZnodeCatalogId = @PublishCatalogId 
			and  IsPublishSuccess =0  

		IF object_id('tempdb..[#Tbl_VersionEntityforCatalog]') IS NOT NULL
			drop table tempdb..#Tbl_VersionEntityforCatalog
		
		Create Table #Tbl_VersionEntityforCatalog(PublishCatalogId int , VersionId int , LocaleId int , PublishType varchar(50))
		Insert into #Tbl_VersionEntityforCatalog(PublishCatalogId , VersionId , LocaleId , PublishType )
		select ZnodeCatalogId , VersionId , LocaleId , RevisionType  from ZnodePublishVersionEntity   where ZnodeCatalogId = @PublishCatalogId 
		and  IsPublishSuccess = 0  

		IF object_id('tempdb..[#Tbl_OldVersionEntityforCatalog]') IS NOT NULL
			drop table tempdb..#Tbl_OldVersionEntityforCatalog
		
		Create Table #Tbl_OldVersionEntityforCatalog(PublishCatalogId int , VersionId int , LocaleId int , PublishType varchar(50),IsPublishSuccess bit )
		Insert into #Tbl_OldVersionEntityforCatalog(PublishCatalogId , VersionId , LocaleId , PublishType ,IsPublishSuccess)
		select ZnodeCatalogId , VersionId , LocaleId, RevisionType  ,IsPublishSuccess from ZnodePublishVersionEntity   where ZnodeCatalogId = @PublishCatalogId 
		and  IsPublishSuccess = 1  

		IF object_id('tempdb..[#Tbl_OldVersionEntityforDeletion]') IS NOT NULL
		drop table tempdb..#Tbl_OldVersionEntityforDeletion

		Create Table #Tbl_OldVersionEntityforDeletion(PublishCatalogId int , VersionId int , LocaleId int , PublishType varchar(50),IsPublishSuccess bit )
		Insert into #Tbl_OldVersionEntityforDeletion(PublishCatalogId , VersionId , LocaleId , PublishType ,IsPublishSuccess)
		select ZnodeCatalogId , VersionId , LocaleId, RevisionType  ,IsPublishSuccess from ZnodePublishVersionEntity   where ZnodeCatalogId = @PublishCatalogId 
		and  IsPublishSuccess = 1  and RevisionType  in 
		(Select distinct PublishType from #Tbl_VersionEntity where ZnodeCatalogId = #Tbl_VersionEntity.PublishCatalogId  )

		If @IsRevertPublish = 0 AND @PublishCatalogId > 0 AND Exists (Select Top 1 1 from #Tbl_VersionEntity ) 
		Begin 
			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =90, 
			IsCompleted  = 1,
			IsFailed =0
			where  JobId = @NewGUID

			Delete  From ZnodePublishCatalogEntity Where  VersionId NOT IN  (Select VersionId from #Tbl_VersionEntity) AND ZnodeCatalogId = @PublishCatalogId  
				AND VersionId IN  (SELECT VersionId from #Tbl_OldVersionEntityforDeletion) 
			SET @Batch= 1;
			WHILE @Batch > 0
			BEGIN 
				Delete  TOP (10000) From ZnodePublishProductEntity Where ElasticSearchEvent = 2
				SET @Batch= @@ROWCOUNT;
				-- CHECKPOINT;    -- if simple
				-- BACKUP LOG ... -- if full
			END

			Delete  From ZnodePublishAddOnEntity Where  ElasticSearchEvent = 2 

			
			Delete  From ZnodePublishCategoryEntity Where ElasticSearchEvent = 2

			Delete  From ZnodePublishBundleProductEntity Where ElasticSearchEvent = 2

			Delete  From ZnodePublishGroupProductEntity Where ElasticSearchEvent = 2

			Delete  From ZnodePublishConfigurableProductEntity Where ElasticSearchEvent = 2

			Delete  From ZnodePublishSEOEntity Where CMSSEOTypeId in (1,2,4) 
			and ElasticSearchEvent = 2

			--Delete  From ZnodePublishVersionEntity Where  VersionId NOT IN (Select VersionId from #Tbl_VersionEntity) AND ZnodeCatalogId = @PublishCatalogId 
			--AND VersionId IN  (SELECT VersionId from #Tbl_OldVersionEntityforDeletion) 

			Update ZnodePublishVersionEntity  SET IsPublishSuccess= 1 where IsPublishSuccess = 0
			and ZnodeCatalogId  = @PublishCatalogId   

						
			Update a SET IsCatalogPublished =1,  PublishStateId = DBO.Fn_GetPublishStateIdForPublish(), ModifiedDate = Getdate()  
			from ZnodePublishCatalogLog a
			where  PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()
			and PublishCatalogLogId = (select max(PublishCatalogLogId) from ZnodePublishCatalogLog b where a.PimCatalogId = b.PimCatalogId and a.LocaleId = b.LocaleId and b.PublishStateId = DBO.Fn_GetPublishStateIdForProcessing())

			Update a SET IsCatalogPublished =1,  PublishStateId = DBO.Fn_GetPublishStateIdForPreview(), ModifiedDate = Getdate()  
			from ZnodePublishCatalogLog a
			where  PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()
			and PublishCatalogLogId = (select min(PublishCatalogLogId) from ZnodePublishCatalogLog b where a.PimCatalogId = b.PimCatalogId and a.LocaleId = b.LocaleId and b.PublishStateId = DBO.Fn_GetPublishStateIdForProcessing())


			Insert into ZnodePublishPreviewLogEntity
			(VersionId,PublishStartTime,IsDisposed,SourcePublishState,EntityId,EntityType,LogMessage,LogCreatedDate,PreviousVersionId,LocaleId,LocaleDisplayValue)
				Select A.VersionId,NULL,NULL,A.PublishType,@PublishCatalogId,'catalog','catalog has been published successfully' , Getdate(),  
				(select TOP 1 VersionId   from #Tbl_OldVersionEntityforCatalog where LocaleId = A.LocaleId AND PublishType = A.PublishType
				AND  PublishCatalogId = A.PublishCatalogId and  IsPublishSuccess =1 ),
				A.LocaleId,B.Name
				from #Tbl_VersionEntity  A  Inner join ZnodeLocale B on A.LocaleId = B.LocaleId 

			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =100, 
			IsCompleted  = 1,
			IsFailed =0
			where  JobId = @NewGUID

			--UPDATE ZnodePimProduct SET IsProductPublish = 1,PublishStateId =  DBO.Fn_GetPublishStateIdForPublish()  
			--WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishProduct ZPP WHERE ZPP.PimProductId = ZnodePimProduct.PimProductId AND ZPP.PublishCatalogId = @PublishCatalogId)

			--UPDATE ZnodePublishCatalogLog 
			--SET IsProductPublished = 1 
			--,PublishProductId = (SELECT  COUNT(DISTINCT PublishProductId) FROM ZnodePublishCategoryProduct ZPP WHERE ZPP.PublishCatalogId = ZnodePublishCatalogLog.PublishCatalogId AND ZPP.PublishCategoryId IS NOT NULL) 
			--WHERE EXISTS (SELECT TOP 1 1 FROM #Tbl_VersionEntity TY  WHERE  TY.VersionId =ZnodePublishCatalogLog.PublishCatalogLogId )  

		End
		Else If @IsRevertPublish = 1 AND @PublishCatalogId > 0 
		Begin 
			
			Delete  From ZnodePublishCatalogEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
			SET @Batch= 1;
			WHILE @Batch > 0
			BEGIN 
				Delete  TOP (10000) From ZnodePublishProductEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
				SET @Batch= @@ROWCOUNT;
				-- CHECKPOINT;    -- if simple
				-- BACKUP LOG ... -- if full
			END
			Delete  From ZnodePublishAddOnEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
			Delete  From ZnodePublishCategoryEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
			Delete  From ZnodePublishBundleProductEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
			Delete  From ZnodePublishGroupProductEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
			Delete  From ZnodePublishConfigurableProductEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
			Delete  From ZnodePublishSEOEntity Where CMSSEOTypeId in (1,2,4) and  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) 
			--AND PortalId in 
			--	(Select ZPC.PortalId  from ZnodePublishVersionEntity  ZPVE inner join ZnodePortalCatalog  
			--		ZPC ON ZPVE.ZnodeCatalogId = ZPC.PublishCatalogId where  (ZPC.PublishCatalogId = @PublishCatalogId ))

			Delete  From ZnodePublishVersionEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 

			INSERT INTO ZnodePublishCatalogErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'Elastic-index genration get failed : ', '' , 'Fail' , Getdate(), 
			@UserId , '' 
			
			Update ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed() ,
			IsCatalogPublished = 0  , ModifiedDate = Getdate()
			where PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()

			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =100, 
			IsCompleted  = 1,
			IsFailed =1
			where  JobId = @NewGUID

		END 
		Else If @IsRevertPublish = 1 AND Isnull(@PublishCatalogId,0) = 0 
		Begin 
			INSERT INTO ZnodePublishCatalogErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'Publish failed, Check connection failure ', '' , 'Fail' , Getdate(), @UserId , '' 
			
			Update ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed() ,
			IsCatalogPublished =0, IsCategoryPublished = 0 ,IsProductPublished = 0 , ModifiedDate = Getdate()
			where PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()
						
			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =80, 
			IsCompleted  = 0,
			IsFailed =1
			where  JobId = @NewGUID

		end

		-- Added to call nested sp if PublishCatalogId found.
		IF EXISTS (	SELECT TOP 1 1 FROM ZnodePublishCatalogSearchProfile PCSP
					INNER JOIN ZnodeSearchProfile SP ON PCSP.SearchProfileId=SP.SearchProfileId
					WHERE PCSP.PublishCatalogId=@PublishCatalogId) AND @IsRevertPublish=1
		BEGIN
			EXEC dbo.Znode_UpdateSearchProfileStateOnIndexCreationFailure @PublishCatalogId=@PublishCatalogId, @UserId=@UserId
		END

		ELSE IF EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogSearchProfile PCSP
						INNER JOIN ZnodeSearchProfile SP ON PCSP.SearchProfileId=SP.SearchProfileId
						WHERE PCSP.PublishCatalogId=@PublishCatalogId) AND @IsRevertPublish=0
		BEGIN
			DECLARE @PublishStateId TINYINT;
			SET @PublishStateId=(SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE StateName='Publish');

			UPDATE SP
			SET SP.PublishStateId=@PublishStateId, SP.ModifiedBy=@UserId, SP.ModifiedDate=GETDATE()
			FROM ZnodePublishCatalogSearchProfile PCSP
			INNER JOIN ZnodeSearchProfile SP ON PCSP.SearchProfileId=SP.SearchProfileId
			WHERE PCSP.PublishCatalogId=@PublishCatalogId;
		END
		SET @Status = 1
		Commit Transaction 
		SELECT @PublishCatalogId AS id,@Status AS Status;   
END TRY 
BEGIN CATCH 
	SET @Status =0  
	 SELECT 1 AS ID,@Status AS Status;   
	 Rollback transaction
	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeletePublishCatalogEntity 
		@PublishCatalogId = '+CAST(@PublishCatalogId  AS VARCHAR	(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@IsRevertPublish='+CAST(@IsRevertPublish AS VARCHAR(10))
		+',@UserId = ' + CAST(@UserId AS varchar(20));	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
	
	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_DeletePublishCatalogEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeleteSearchProfile')
	DROP PROC Znode_DeleteSearchProfile
GO

CREATE PROCEDURE [dbo].[Znode_DeleteSearchProfile] 
(
	@SearchProfileId INT
) 
AS
/*
	Unit Testing
	EXEC dbo.Znode_DeleteSearchProfile @SearchProfileId=5
*/
BEGIN
	BEGIN TRAN DeleteSearchProfile;
		--DECLARE @Status BIT;
	BEGIN TRY
		SET NOCOUNT ON

		IF EXISTS (SELECT TOP 1 1 FROM ZnodeSearchProfile WHERE SearchProfileId=@SearchProfileId)
		BEGIN
			DELETE FROM ZnodePortalSearchProfile WHERE SearchProfileId=@SearchProfileId
			DELETE FROM ZnodePublishCatalogSearchProfile WHERE SearchProfileId=@SearchProfileId
			DELETE FROM ZnodeSearchProfileAttributeMapping WHERE SearchProfileId=@SearchProfileId
			DELETE FROM ZnodeSearchProfileFeatureMapping WHERE SearchProfileId=@SearchProfileId
			DELETE FROM ZnodeSearchProfileFieldValueFactor WHERE SearchProfileId=@SearchProfileId
			DELETE FROM ZnodeSearchProfileProductMapping WHERE SearchProfileId=@SearchProfileId
			DELETE FROM ZnodeSearchProfileTrigger WHERE SearchProfileId=@SearchProfileId
			DELETE FROM ZnodeSearchActivity WHERE SearchProfileId=@SearchProfileId
			DELETE FROM ZnodePublishSearchProfileEntity WHERE SearchProfileId=@SearchProfileId
			DELETE FROM ZnodeSearchProfile WHERE SearchProfileId=@SearchProfileId

			SELECT 1 As [Status];
		END
		ELSE
		BEGIN
			SELECT 0 As [Status];
		END

	COMMIT TRAN DeleteSearchProfile
	END TRY
	BEGIN CATCH
		SELECT 0 As [Status];

		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), 
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeleteSearchProfile @SearchProfileId='+ISNULL(CAST(@SearchProfileId AS VARCHAR(50)),'''');

		ROLLBACK TRAN DeleteSearchProfile 

		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_DeleteSearchProfile',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetSearchProfileList')
	DROP PROC Znode_GetSearchProfileList
GO

CREATE PROCEDURE [dbo].[Znode_GetSearchProfileList]
(
	@WhereClause NVARCHAR(MAX),
    @Rows        INT           = 100,
    @PageNo      INT           = 1,
    @Order_BY    VARCHAR(100)  = '',
    @RowsCount   INT OUT
)
AS 
/*
	 Summary :- This Procedure is used to get the publish status of the catalog 
	 Unit Testig 
	 EXEC  Znode_GetSearchProfileList '',100,1,'',0
*/
BEGIN 
	BEGIN TRY 
	SET NOCOUNT ON 

		DECLARE @SQL  NVARCHAR(MAX);

		DECLARE @PublishStateIdForForNotPublishedState INT = dbo.Fn_GetPublishStateIdForForNotPublishedState()

		DECLARE @TBL_CatalogId TABLE 
		(PublishCatalogId int ,CatalogName NVARCHAR(2000), SearchProfileId INT , SearchQueryTypeId INT , ProfileName NVARCHAR(2000),
			QueryTypeName NVARCHAR(2000),QueryBuilderClassName  NVARCHAR(2000),SearchSubQueryTypeId INT,SubQueryTypeName  NVARCHAR(2000),
			SubQueryBuilderClassName  NVARCHAR(2000),--RowId INT ,
			PortalId INT,PortalName NVARCHAR(MAX),IsDefault BIT,CountId INT,CreatedDate Datetime,PublishStateId INT,CatalogCode VARCHAR(300), 
			PublishStatus VARCHAR(50)
		)
		
	 
		SET @SQL = '
		;With Cte_CatalogLog AS 
		(
		Select dd.PublishCatalogId,pc.CatalogName,B.SearchProfileId,  b.SearchQueryTypeId ,b.ProfileName,c.QueryTypeName,c.QueryBuilderClassName,
			b.SearchSubQueryTypeId,d.QueryTypeName SubQueryTypeName,d.QueryBuilderClassName SubQueryBuilderClassName,ZPSP.PortalId,ZP.StoreName as PortalName,
			isnull(ZPSP.IsDefault,0) as Isdefault, B.CreatedDate,B.PublishStateId,ZPC.CatalogCode, PS.DisplayName As PublishStatus
		FROM ZnodeSearchProfile B 
		INNER JOIN ZnodePublishCatalogSearchProfile dd on  dd.SearchProfileId=b.SearchProfileId
		INNER JOIN ZnodePublishCatalog pc on pc.PublishCatalogId=dd.PublishCatalogId
		LEFT JOIN ZnodePimCatalog zpc on ZPC.PimCatalogId = PC.PimCatalogId
		INNER JOIN ZnodeSearchQueryType C on b.SearchQueryTypeId=C.SearchQueryTypeId 
		LEFT JOIN ZnodeSearchQueryType d on  d.SearchQueryTypeId =b.SearchSubQueryTypeId
		LEFT JOIN ZnodePortalSearchProfile ZPSP ON (ZPSP.SearchProfileId = B.SearchProfileId AND ZPSP.PublishCatalogId = DD.PublishCatalogId)
		LEFT JOIN ZnodePortal ZP ON (ZP.PortalId = ZPSP.PortalId)
		LEFT JOIN ZnodePublishState PS ON ISNULL(B.PublishStateId,'+CAST(@PublishStateIdForForNotPublishedState AS VARCHAR(10))+') = PS.PublishStateId
		)	 
			,Cte_PublishStatus AS 
		(
		SELECT PublishCatalogId,CatalogName,SearchProfileId , SearchQueryTypeId ,ProfileName,QueryTypeName,QueryBuilderClassName,SearchSubQueryTypeId,
			SubQueryTypeName,SubQueryBuilderClassName,PortalId,PortalName,IsDefault,PublishStateId,
			'+[dbo].[Fn_GetPagingRowId](@Order_BY,'SearchProfileId DESC')+' , Count(*) Over () CountId ,CreatedDate,CatalogCode,PublishStatus
		FROM Cte_CatalogLog
		WHERE 1=1 '+[dbo].[Fn_GetFilterWhereClause](@WhereClause)+' )
	 
		SELECT PublishCatalogId,CatalogName,SearchProfileId , SearchQueryTypeId ,ProfileName,QueryTypeName,QueryBuilderClassName, SearchSubQueryTypeId,
			SubQueryTypeName,SubQueryBuilderClassName,PortalId,PortalName,IsDefault,CountId, CreatedDate,PublishStateId,CatalogCode,PublishStatus
		FROM Cte_PublishStatus 
		'+[dbo].[Fn_GetPaginationWhereClause](@PageNo,@Rows)+' '
	
		PRINT @sql

		INSERT INTO @TBL_CatalogId 
		EXEC (@SQL)

		SELECT PublishCatalogId,CatalogName,SearchProfileId, SearchQueryTypeId,	ProfileName,QueryTypeName,QueryBuilderClassName,SearchSubQueryTypeId,
			SubQueryTypeName,SubQueryBuilderClassName,PortalId,PortalName,IsDefault,CountId, a.CreatedDate,a.PublishStatus,a.CatalogCode
		FROM @TBL_CatalogId a
		
		SET @RowsCount = ISNULL((SELECT TOP 1 COUNTID FROM @TBL_CatalogId),0)

	END TRY
	BEGIN CATCH
		DECLARE @Status BIT;
		SET @Status = 0;

		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), 
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
				@ErrorLine VARCHAR(100)= ERROR_LINE(), 
				@ErrorCall NVARCHAR(MAX)= 
					'EXEC Znode_GetSearchProfileList 
						@WhereClause = '''+ISNULL(@WhereClause,'''''')+''',
						@Rows='+ISNULL(CAST(@Rows AS VARCHAR(50)),'''''')+',
						@PageNo='+ISNULL(CAST(@PageNo AS VARCHAR(50)),'''')+',
						@Order_BY='''+ISNULL(@Order_BY,'''''')+''',
						@RowsCount='+ISNULL(CAST(@RowsCount AS VARCHAR(50)),'''');
              			 
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_GetSearchProfileList',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_UpdateSearchProfileStateOnIndexCreationFailure')
	DROP PROC Znode_UpdateSearchProfileStateOnIndexCreationFailure
GO

CREATE PROCEDURE [dbo].[Znode_UpdateSearchProfileStateOnIndexCreationFailure] 
(
	@PublishCatalogId INT,
	@UserId INT = 0
) 
AS
/*
	Unit Testing
	EXEC dbo.Znode_UpdateSearchProfileStateOnIndexCreationFailure @PublishCatalogId=5
*/
BEGIN
	BEGIN TRAN UpdateSearchProfileState;
	BEGIN TRY
		SET NOCOUNT ON
		DECLARE @PublishStateId TINYINT;
		SET @PublishStateId=(SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE StateName='Publish Failed');

		UPDATE SP
		SET SP.PublishStateId=@PublishStateId, SP.ModifiedBy=@UserId, SP.ModifiedDate=GETDATE()
		FROM ZnodePublishCatalogSearchProfile PCSP
		INNER JOIN ZnodeSearchProfile SP ON PCSP.SearchProfileId=SP.SearchProfileId
		WHERE PCSP.PublishCatalogId=@PublishCatalogId;

	COMMIT TRAN UpdateSearchProfileState
	END TRY
	BEGIN CATCH
			DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), 
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeleteSearchProfile @PublishCatalogId='+ISNULL(CAST(@PublishCatalogId AS VARCHAR(50)),'''');

		ROLLBACK TRAN UpdateSearchProfileState 

		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_UpdateSearchProfileStateOnIndexCreationFailure',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH
END

GO

IF EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'Title' AND Object_ID = Object_ID(N'dbo.ZnodeProductFeed'))
BEGIN
	ALTER TABLE ZnodeProductFeed ALTER COLUMN [Title] NVARCHAR (MAX) NULL;
END

GO

IF EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'Link' AND Object_ID = Object_ID(N'dbo.ZnodeProductFeed'))
BEGIN
	ALTER TABLE ZnodeProductFeed ALTER COLUMN [Link] NVARCHAR (MAX) NULL;
END

GO

IF EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'Description' AND Object_ID = Object_ID(N'dbo.ZnodeProductFeed'))
BEGIN
	ALTER TABLE ZnodeProductFeed ALTER COLUMN [Description] NVARCHAR (MAX) NULL;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetXmlProductFeedList')
	DROP PROC Znode_GetXmlProductFeedList
GO

CREATE PROCEDURE [dbo].[Znode_GetXmlProductFeedList]  
(
	@PortalId   VARCHAR(2000) = NULL,   
	@LocaleId   INT,  
	@FeedType   NVARCHAR(MAX) = NULL   
)
AS  
/*  
Summary: This Procedure is used to get effective keyword feeding of Product list  
 SELECT * FROM ZnodePublishProductDetail  
 SELECT * FROM ZnodePublishProduct WHERE PublishCatalogId = 3  
 SELECT * FROM ZnodePortalCatalog   
 Unit Testing:  
 EXEC [Znode_GetXmlProductFeedList] @PortalId='0',@ProductIds = '116,117,118'  
 ,@LocaleId=1,@FeedType='Bing'   
  
*/  
BEGIN  
BEGIN TRY  
SET NOCOUNT ON;        
           
		IF OBJECT_ID('tempdb..#TBL_DomainName') IS NOT NULL
		DROP TABLE #TBL_DomainName

		IF OBJECT_ID('tempdb..#TBL_SEODetails') IS NOT NULL
		DROP TABLE #TBL_SEODetails

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_PortalIds') IS NOT NULL
		DROP TABLE #TBL_PortalIds

		IF OBJECT_ID('tempdb..#TBL_PricePrecedence') IS NOT NULL
		DROP TABLE #TBL_PricePrecedence

		DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
		CREATE TABLE #TBL_DomainName 
		(PortalId   INT,
		DomainName NVARCHAR(300),
		RowId      INT
		);  	
         
		CREATE TABLE #TBL_SEODetails   
		(loc                   NVARCHAR(MAX),  
		lastmod               DATETIME,  
		[g:condition]         VARCHAR(1000),  
		[description]         NVARCHAR(MAX), 
		[SEOTitle]			  NVARCHAR(MAX),	
		[g:id]                INT,  
		link                  VARCHAR(1000),  
		[g:identifier_exists] VARCHAR(2000),  
		DomainName            NVARCHAR(3000),  
		PortalId              INT , 
		SEOCode             NVARCHAR(4000), 
		CanonicalURL        VARCHAR(2000), 
		RobotTag            VARCHAR(500)
		);  
		
		DECLARE @DefaultLocaleId INT=dbo.Fn_GetDefaultLocaleId()  ;
		CREATE TABLE #TBL_PortalIds (PortalId INT);  
		
		INSERT INTO #TBL_PortalIds  

		SELECT Zp.PortalId   
		FROM Znodeportal AS ZP   
		INNER JOIN ZnodePortalCatalog AS ZPC ON(ZPC.PortalId = Zp.PortalId)  
		INNER JOIN ZnodePublishCatalog AS ZPPC ON(ZPPC.PublishCatalogId = ZPC.PublishCatalogId)   
		INNER JOIN ZNodePublishProduct AS ZPP ON(ZPP.PublishCatalogId = ZPPC.PublishCatalogId)  
		INNER JOIN ZnodePublishProductDetail AS PPD ON (PPD.PublishProductId = ZPP.PublishProductId)  
		INNER JOIN ZnodePublishProductEntity AS ZPPE ON (PPD.SKU  = ZPPE.SKU)
		WHERE
		
		EXISTS(SELECT TOP 1 1 FROM DBO.Split(@PortalId, ',') AS Sp  
		WHERE(CAST(sp.Item AS INT)) = Zp.PortalId  OR @PortalId = '0')  
		AND EXISTS (SELECT TOP 1 1 FROM ZnodeDomain ZD WHERE ZP.PortalId = ZD.PortalId  
		AND IsActive = 1 AND ApplicationType = 'Webstore')  
		GROUP BY Zp.PortalId;   
		
		INSERT INTO #TBL_DomainName   
		SELECT  PortalId,DomainName,ROW_NUMBER() OVER(PARTITION BY PortalId ORDER BY DomainName)   
		FROM ZnodeDomain AS ZD   
		WHERE EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZD.PortalId)  
		AND IsActive = 1 AND ApplicationType = 'Webstore' AND IsDefault = 1 

		if not exists (select top 1 1 from #TBL_DomainName)
		INSERT INTO #TBL_DomainName   
		SELECT  PortalId,DomainName,ROW_NUMBER() OVER(PARTITION BY PortalId ORDER BY DomainName)   
		FROM ZnodeDomain AS ZD   
		WHERE EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZD.PortalId)  
		AND IsActive = 1 AND ApplicationType = 'Webstore'
 
			SELECT DISTINCT ZCSD.CMSSEODetailId,ZCSD.SEOURL AS loc,ZCSD.ModifiedDate AS lastmod,'new' AS [g:condition],ZCSDL.SEODescription AS [description],ZCSDL.SEOTitle AS [SEOTitle], ZPCC.PublishProductId AS [g:id],  
            ZCSD.SEOUrl AS link,'false' AS [g:identifier_exists],TBDN.DomainName,ZPC.PortalId,ISNULL(ZCSDL.LocaleId, @DefaultLocaleId) AS LocaleId , ZCSD.SEOCode , ZCSDL.CanonicalURL, ZCSDL.RobotTag 
			INTO #Cte_SeoDetailsWithLocale
			FROM ZNodePublishProduct AS ZPCC   
			INNER JOIN ZnodePortalCatalog AS ZPC ON(ZPC.PublishCatalogId = ZPCC.PublishCatalogId)  
			LEFT JOIN ZnodePublishProductDetail AS PPD ON (PPD.PublishProductId = ZPCC.PublishProductId)  
			LEFT JOIN ZnodeCMSSEODetail AS ZCSD ON(PPD.SKU = ZCSD.SEOCode and ZCSD.PortalId = ZPC.PortalId)  
			LEFT JOIN ZnodeCMSSEOType AS ZCST ON(ZCST.CMSSEOTypeId = ZCSD.CMSSEOTypeId AND ZCST.Name = 'Product')  
			LEFT JOIN ZnodeCMSSEODetailLocale AS ZCSDL ON(ZCSDL.CMSSEODetailId = ZCSD.CMSSEODetailId AND ZCSDL.LocaleId IN(@LocaleId, @DefaultLocaleId))  
			LEFT JOIN #TBL_DomainName AS TBDN ON(TBDN.RowId = 1 AND TBDN.PortalId = zpc.PortalId)   
			WHERE EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZPC.PortalId)  
				
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[SEOTitle],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag  
			INTO #Cte_SeoDetailsWithFirstLocale
			FROM #Cte_SeoDetailsWithLocale   
			WHERE LocaleId = @LocaleId  
    
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[SEOTitle],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode , CanonicalURL, RobotTag 
			INTO #Cte_SeoDetailsWithDefaultLocale
			FROM #Cte_SeoDetailsWithFirstLocale  
			
			INSERT INTO #Cte_SeoDetailsWithDefaultLocale 
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[SEOTitle],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag  
			FROM #Cte_SeoDetailsWithLocale AS CTSDWL  
			WHERE LocaleId = @DefaultLocaleId   
			AND NOT EXISTS(SELECT TOP 1 1 FROM #Cte_SeoDetailsWithFirstLocale AS CTSDWDL WHERE CTSDWDL.CMSSEODetailId = CTSDWL.CMSSEODetailId)  
         
			INSERT INTO #TBL_SEODetails  
			SELECT DISTINCT loc,lastmod,[g:condition],[description],[SEOTitle],[g:id],link,[g:identifier_exists],DomainName,PortalId ,SEOCode, CanonicalURL, RobotTag  
			FROM #Cte_SeoDetailsWithDefaultLocale;
			
			select a.PublishProductId, d.AttributeDefaultValueCode as OutOfStockOptions
			into #TempProduct_OutOfStockOptions
			from ZnodePublishProduct a
			inner join ZnodePimAttributeValue b on a.PimProductId = b.PimProductId
			inner join ZnodePimProductAttributeDefaultValue c on b.PimAttributeValueId = c.PimAttributeValueId
			inner join ZnodePimAttributeDefaultValue d on c.PimAttributeDefaultValueId = d.PimAttributeDefaultValueId
			where EXISTS(select top 1 1 from ZnodePimAttribute ZPA where AttributeCode = 'OutOfStockOptions' AND b.PimAttributeId = ZPA.PimAttributeId)
			
			SELECT TBSD.loc,TBSD.lastmod,TBSD.[g:condition],TBSD.[description],TBSD.[SEOTitle],TBSD.[g:id],TBSD.link,TBSD.[g:identifier_exists],TBSD.DomainName,TBSD.PortalId,OOS.OutOfStockOptions,
			CASE WHEN SUM(ISNULL(ZI.Quantity,0)) > 0 THEN 'In Stock'
			     WHEN SUM(ISNULL(ZI.Quantity,0)) = 0 AND ISNULL(OOS.OutOfStockOptions,'') <> 'DisablePurchasing'  THEN 'In Stock'
                 WHEN @FeedType = 'Xml'THEN 'Out Of Stock' 
                 ELSE 'Not In Stock'  END AS [g:availability],
				 
			ZPPD.SKU ,TBSD.SEOCode, TBSD.CanonicalURL, TBSD.RobotTag, ZPP.PublishProductId,ZPPD.ProductName
			INTO #TBL_CompleteDetailes  
			FROM ZnodePublishProduct AS ZPP   
			inner join #TempProduct_OutOfStockOptions OOS ON ZPP.PublishProductId = OOS.PublishProductId
			LEFT JOIN #TBL_SEODetails AS TBSD ON(ZPP.PublishProductId = TBSD.[g:id] )  
			LEFT JOIN ZnodePublishProductDetail AS ZPPD ON(ZPPD.PublishProductId = ZPP.PublishProductId AND ZPPD.LocaleId = @LocaleId)  
			LEFT JOIN ZnodePortalWarehouse AS ZPW ON(ZPW.PortalId = TBSD.PortalId)  
			LEFT JOIN ZnodePortalAlternateWarehouse AS ZAPW ON(ZAPW.PortalWarehouseId = ZPW.PortalWarehouseId)  
			LEFT JOIN ZnodeInventory AS ZI ON(ZI.SKU = ZPPD.SKU AND (ZI.WarehouseId = ZPW.WarehouseId OR ZI.WarehouseId = ZAPW.WarehouseId))  			
			GROUP BY loc,lastmod,[g:condition],[description],[SEOTitle],[g:id],link,[g:identifier_exists],DomainName,TBSD.PortalId,ZPPD.SKU,ZPPD.LocaleId, TBSD.SEOCode, TBSD.CanonicalURL, TBSD.RobotTag, ZPP.PublishProductId,ZPPD.ProductName,OOS.OutOfStockOptions;    
			
			DECLARE @MediaConfiguration NVARCHAR(2000)=((SELECT TOP 1 ISNULL(CASE WHEN CDNURL = '' THEN NULL ELSE CDNURL END,URL) FROM ZnodeMediaConfiguration WHERE IsActive = 1));    
  
			CREATE INDEX Idx_#TBL_CompleteDetailes ON #TBL_CompleteDetailes(PortalId,SKU)
			
			select * into #TBL_PricePrecedence from(
			select ROW_NUMBER() OVER(PARTITION BY sku ORDER BY Precedence) rnk_min, sku, RetailPrice,SalesPrice,znodeprice.PriceListId,ZnodePriceList.ListCode,
			ZnodePriceListPortal.Precedence
			from znodeprice
			left join ZnodePriceList on ZnodePriceList.PriceListId = znodeprice.PriceListId
			left join  ZnodePriceListPortal on ZnodePriceList.PriceListId= ZnodePriceListPortal.PriceListId where PortalId = @PortalId 
			)a
			order by a.sku,Precedence
			delete from #TBL_PricePrecedence where rnk_min<>1 
	
			SELECT zp.PortalId,round(isnull(Zps.SalesPrice,Zps.RetailPrice),2) as Price,Zps.SKU,tbcd.SEOCode,ROW_NUMBER() OVER(PARTITION BY Zps.SKU,zp.PortalId ORDER BY ZPS.RetailPrice) AS RowId  
			INTO #Cte_PortalList
			FROM ZnodePriceList AS ZPL   
			LEFT JOIN ZnodePriceListPortal AS ZPLP ON ZPL.PriceListId = ZPLP.PriceListId  
			LEFT JOIN ZnodeCulture AS zc ON ZPL.CultureId = zc.CultureId
			LEFT JOIN ZnodePortal AS zp ON ZPLP.PortalId = zp.PortalId  
		    LEFT JOIN #TBL_PricePrecedence Zps ON(Zps.PriceListId = ZPL.PriceListId) 
			--LEFT JOIN ZnodePrice AS Zps ON(Zps.PriceListId = ZPL.PriceListId)   
			LEFT JOIN #TBL_CompleteDetailes AS TBCD ON(TBCD.PortalId = Zp.PortalId AND TBCD.SKU = Zps.Sku)   
			WHERE CAST(@GetDate AS DATE) BETWEEN ZPL.ActivationDate AND ZPL.ExpirationDate   
			AND EXISTS( SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZPLP.PortalId)   
			GROUP BY zp.PortalId,ZPS.RetailPrice,Zps.SalesPrice,Zps.SKU ,TBCD.SEOCode  
			
			SELECT D.PublishProductId,C.AttributeDefaultValueCode AS Brand
			INTO #BrandDetails
			FROM ZnodePimAttributeValue A
			INNER JOIN ZnodePimProductAttributeDefaultValue B ON B.PimAttributeValueId=A.PimAttributeValueId
			INNER JOIN ZnodePimAttributeDefaultValue C ON C.PimAttributeDefaultValueId=A.PimAttributeDefaultValueId	
			INNER JOIN Znodepublishproduct D ON  A.PimProductId = D.PimProductId 
			WHERE EXISTS(SELECT * FROM ZnodePimAttribute D WHERE D.PimAttributeId=A.PimAttributeId AND D.AttributeCode='Brand' )
			AND EXISTS(SELECT * FROM #TBL_CompleteDetailes E Where E.PublishProductId = D.PublishProductId)		
			
			SELECT A.CategoryName , A.ZnodeProductId AS PublishProductId, ROW_NUMBER() OVER(PARTITION BY A.ZnodeProductId ORDER BY A.ZnodeProductId) AS RowId
			INTO #ProductCategories
			FROM ZnodePublishProductEntity A 
			WHERE EXISTS(SELECT * FROM #TBL_CompleteDetailes B WHERE A.ZnodeProductId = B.PublishProductId)
			AND ISNULL(A.CategoryName,'') <> ''

			DELETE FROM #ProductCategories WHERE RowId <> 1
 
			SELECT SKU,SUM(cast(Quantity as numeric(28,0)))AS Inventory 
			into #InventotyDetails 
			FROM ZnodeInventory A 
			WHERE EXISTS(SELECT * FROM #TBL_CompleteDetailes B where A.SKU=B.SKU)
			GROUP BY SKU  

			SELECT F.PublishProductId,[Path] AS ImagePath
			INTO #ProductImage
			FROM ZnodePimAttributeValue a
			INNER JOIN ZnodePimProductAttributeMedia b on a.PimAttributeValueId = b.PimAttributeValueId
			INNER JOIN ZnodeMedia d on b.MediaId = d.MediaId
			INNER JOIN Znodepublishproduct F ON  A.PimProductId = F.PimProductId 
			WHERE EXISTS(SELECT * FROM ZnodePimAttribute C WHERE C.PimAttributeId=A.PimAttributeId AND C.AttributeCode='PRODUCTIMAGE' )
			AND EXISTS(SELECT * FROM #TBL_CompleteDetailes E Where E.PublishProductId = F.PublishProductId)		

						 
			SELECT 
			DomainName AS DomainName,
			isnull(ProductName,SEOTitle) as [Title],
			--lastmod,
			--[g:condition],
			[description] AS [Description],
			CAST([g:id] AS nvarchar(50) ) AS ProductID,
			[g:availability] AS [Availability],
			--[g:identifier_exists],	
			--TBCD.PortalId,
			Cast(CAST(CTPL.Price AS numeric(28,3))as nvarchar(100)) AS Price,
			@MediaConfiguration AS MediaConfiguration,
			--TBCD.SEOCode,
			--TBCD.CanonicalURL,
			--TBCD.RobotTag,
			PC.CategoryName AS Category,
			CAST(ID.Inventory AS nvarchar(50) ) AS Inventory,
			BD.Brand AS Brand,
			link AS Link,
			PM.IMAGEPATH AS Image_Link,
			ID.SKU AS ID
			FROM #TBL_CompleteDetailes AS TBCD   
			LEFT JOIN #Cte_PortalList AS CTPL ON(CTPL.PortalId = TBCD.PortalId AND CTPL.SKU = TBCD.SKU AND CTPL.RowID = 1)  
			LEFT JOIN #ProductCategories PC ON TBCD.PublishProductId = PC.PublishProductId
			LEFT JOIN #InventotyDetails ID ON TBCD.SKU = ID.SKU 
			LEFT JOIN #BrandDetails BD on TBCD.PublishProductId=BD.PublishProductId
			LEFT JOIN #ProductImage PM on TBCD.PublishProductId=PM.PublishProductId
			WHERE  EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = TBCD.PortalId)

		IF OBJECT_ID('tempdb..#TBL_DomainName') IS NOT NULL
		DROP TABLE #TBL_DomainName

		IF OBJECT_ID('tempdb..#TBL_SEODetails') IS NOT NULL
		DROP TABLE #TBL_SEODetails

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_PortalIds') IS NOT NULL
		DROP TABLE #TBL_PortalIds

		IF OBJECT_ID('tempdb..#TBL_PricePrecedence') IS NOT NULL
		DROP TABLE #TBL_PricePrecedence
		
END TRY  
BEGIN CATCH  
	DECLARE @Status BIT ;  
	SET @Status = 0;  
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetXmlProductFeedList @PortalId = '+@PortalId+',@LocaleId='+CAST(@LocaleId AS VARCHAR(50))+',@FeedType='+CAST(@FeedType AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));  
                 
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
     
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_GetXmlProductFeedList',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
   
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportSEODetails')
	DROP PROC Znode_ImportSEODetails
GO

CREATE PROCEDURE [dbo].[Znode_ImportSEODetails]
(  
   @TableName NVARCHAR(100), 
   @Status BIT OUT, 
   @UserId INT, 
   @ImportProcessLogId INT, 
   @NewGUId NVARCHAR(200), 
   @LocaleId INT= 1,
   @PortalId INT ,
   @CsvColumnString NVARCHAR(max)
)  
AS  
 --------------------------------------------------------------------------------------  
 -- Summary :  Import SEO Details  
   
 -- Unit Testing :   
 --------------------------------------------------------------------------------------  
  
BEGIN  
BEGIN TRAN A;  
BEGIN TRY  
   
	DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(max);  
	DECLARE @GetDate DATETIME= dbo.Fn_GetDate();  
    
    
	DECLARE @CMSSEOTypeProduct INT ,@CMSSEOTypeCategory INT  
  
	SELECT @CMSSEOTypeProduct = CMSSEOTypeId FROM ZnodeCMSSEOType WHERE Name = 'Product'  
	SELECT @CMSSEOTypeCategory = CMSSEOTypeId FROM ZnodeCMSSEOType WHERE Name = 'Category'  
  
  
	-- Three type of import required three table varible for product , category AND brAND  
	DECLARE @InsertSEODetails TABLE  
	(   
		RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, ImportType varchar(20), Code NVARCHAR(300),   
		IsRedirect BIT ,MetaInformation NVARCHAR(max),PortalId INT ,SEOUrl NVARCHAR(max),IsActive varchar(10),  
		SEOTitle NVARCHAR(max),SEODescription NVARCHAR(max),SEOKeywords NVARCHAR(max),   
		RedirectFROM NVARCHAR(max),RedirectTo NVARCHAR(max), EnableRedirection BIT, CanonicalURL VARCHAR(200),   
		RobotTag VARCHAR(50), GUID NVARCHAR(400)  
	);  
  
	DECLARE @InsertSEODetailsOFProducts TABLE  
	(   
		RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, ImportType varchar(20), Code NVARCHAR(300),   
		IsRedirect BIT ,MetaInformation NVARCHAR(max),PortalId INT ,SEOUrl NVARCHAR(max),IsActive varchar(10),  
		SEOTitle NVARCHAR(max),SEODescription NVARCHAR(max),SEOKeywords NVARCHAR(max),  
		RedirectFROM NVARCHAR(max),RedirectTo NVARCHAR(max), EnableRedirection BIT, CanonicalURL VARCHAR(200),  
		RobotTag VARCHAR(50),GUID NVARCHAR(400) 
	);  
  
	DECLARE @InsertSEODetailsOFCategory TABLE  
	(   
		RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, ImportType varchar(20), Code NVARCHAR(300),   
		IsRedirect BIT ,MetaInformation NVARCHAR(max),PortalId INT ,SEOUrl NVARCHAR(max),IsActive varchar(10),  
		SEOTitle NVARCHAR(max),SEODescription NVARCHAR(max),SEOKeywords NVARCHAR(max),  
		RedirectFROM NVARCHAR(max),RedirectTo NVARCHAR(max), EnableRedirection BIT, CanonicalURL VARCHAR(200), 
		RobotTag VARCHAR(50),GUID NVARCHAR(400)
	);  
  
	DECLARE @InsertSEODetailsOFBrAND TABLE  
	(   
		RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, ImportType varchar(20), Code NVARCHAR(300),   
		IsRedirect BIT ,MetaInformation NVARCHAR(max),PortalId INT ,SEOUrl NVARCHAR(max),IsActive varchar(10),  
		SEOTitle NVARCHAR(max),SEODescription NVARCHAR(max),SEOKeywords NVARCHAR(max),   
		RedirectFROM NVARCHAR(max),RedirectTo NVARCHAR(max), EnableRedirection BIT, CanonicalURL VARCHAR(200),  
		RobotTag VARCHAR(50),GUID NVARCHAR(400) 
	);  
  
    
	DECLARE @InsertedZnodeCMSSEODetail TABLE  
	(   
		CMSSEODetailId INT , SEOCode Varchar(4000), CMSSEOTypeId INT  
	);  
    
	--SET @SSQL = 'SELECT RowNumber,ImportType,Code,IsRedirect,MetaInformation,SEOUrl,IsActive,SEOTitle,SEODescription,SEOKeywords,GUID  FROM '+@TableName;  
	SET @SSQL = 'SELECT RowNumber,'+@CsvColumnString+',GUID  FROM '+@TableName;  
  
	INSERT INTO @InsertSEODetails(RowNumber,ImportType,Code,IsRedirect,MetaInformation,SEOUrl,IsActive,SEOTitle,SEODescription,SEOKeywords,RedirectFrom,RedirectTo,EnableRedirection,CanonicalURL,RobotTag,GUID )  
	EXEC sys.sp_sqlexec @SSQL;  
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '30', 'SEOUrl', SEOUrl, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii   
	WHERE ii.SEOURL IN (SELECT ISD.SEOURL FROM @InsertSEODetails ISD Group by ISD.SEOUrl having count(*) > 1 ) 
	    
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '10', 'SEOUrl', SEOUrl, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii   
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEODetail ZCSD WHERE ZCSD.SEOUrl = ii.SEOUrl AND ZCSD.PortalId = @PortalId
	AND ZCSD.SEOCode <> ii.Code  AND EXISTS  
	(SELECT TOP 1 1 FROM ZnodeCMSSEODetailLocale dl WHERE dl.CMSSEODetailId = ZCSD.CMSSEODetailId AND dl.LocaleId = @LocaleId  
	AND dl.SEODescription = ii.SEODescription AND dl.SEOTitle = ii.SEOTitle AND dl.SEOKeywords = ii.SEOKeywords))   
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '53', 'RedirectFrom', RedirectFrom, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii   
	WHERE ii.RedirectFROM IN (SELECT ISD.RedirectFROM FROM @InsertSEODetails ISD Group by ISD.RedirectFROM having count(*) > 1 )   
	AND (ii.RedirectFROM <> '' )

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '35', 'RedirectFrom\RedirectTo', RedirectFROM + '  ' + RedirectTo  , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii   
	WHERE ii.RedirectFROM = ii.RedirectTo  
	AND (ii.RedirectFROM <> '' AND ii.RedirectTo <> '' )
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '133', 'SEOUrl', SEOUrl, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii  
	WHERE LTRIM(RTRIM(ISNULL(ii.SEOUrl,''))) like '% %' -----space not allowed  
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '103', 'ImportType', ImportType, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii  
	WHERE ii.ImportType NOT IN   
	(  
		SELECT NAME FROM ZnodeCMSSEOType WHERE NAME NOT IN ('Content Page','BlogNews','Brand')  
	);  

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '68', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii  
	WHERE ii.IsActive not IN ('True','1','Yes','FALSE','0','No')
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '9', 'RobotTag', RobotTag, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii  
	WHERE ii.RobotTag not IN ( 'INDEX_FOLLOW','NOINDEX_NOFOLLOW','NOINDEX_FOLLOW','INDEX_NOFOLLOW','1','2','3','4') 
	AND ISNULL(ii.RobotTag,'')<>''

	UPDATE ZIL
	SET ZIL.ColumnName =   ZIL.ColumnName + ' [ SEOCode - ' + ISNULL(Code,'') + ' ] '
	FROM ZnodeImportLog ZIL 
	INNER JOIN @InsertSEODetails IPA ON (ZIL.RowNumber = IPA.RowNumber)
	WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

	
	-------------------------------------------------------------------------------------------------------------------------------  
  
	INSERT INTO @InsertSEODetailsOFProducts(  RowNumber , ImportType , Code ,   
	IsRedirect ,MetaInformation ,SEOUrl ,IsActive ,  
	SEOTitle ,SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag, GUID )  
	SELECT RowNumber , ImportType , Code , IsRedirect ,MetaInformation ,SEOUrl , 
	CASE WHEN IsActive IN ('True','1','Yes') 
	Then 1 
	ELSE 0
	END as IsActive, SEOTitle ,SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag, GUID  
	FROM @InsertSEODetails WHERE ImportType = 'Product'  
  
  
	INSERT INTO @InsertSEODetailsOFCategory( RowNumber , ImportType , Code ,   
	IsRedirect ,MetaInformation,SEOUrl ,IsActive ,  
	SEOTitle ,SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag , GUID )  
	SELECT RowNumber , ImportType , Code , IsRedirect ,MetaInformation ,SEOUrl , 
		CASE WHEN IsActive IN ('True','1','Yes') Then 1 ELSE 0 END as IsActive, SEOTitle ,
		SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag, GUID  
	FROM @InsertSEODetails WHERE ImportType = 'Category'  
  
	INSERT INTO @InsertSEODetailsOFBrand( RowNumber , ImportType , Code ,   
	IsRedirect ,MetaInformation ,SEOUrl ,IsActive ,  
	SEOTitle ,SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag , GUID )  
	SELECT RowNumber , ImportType , Code , IsRedirect ,MetaInformation ,SEOUrl ,
		CASE WHEN IsActive IN ('True','1','Yes') Then 1 ELSE 0 END as IsActive, SEOTitle ,
		SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag, GUID  
	FROM @InsertSEODetails WHERE ImportType = 'Brand'  
  
  
	-- start Functional Validation   
	--1. Product  
	--2. Category  
	--3. Content Page  
	--4. BrAND  
	-----------------------------------------------  
  
    
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '103', 'SKU', CODE, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetailsOFProducts AS ii  
	WHERE ii.CODE NOT IN   
	(  
		SELECT ZPAVL.AttributeValue  
		FROM ZnodePimAttributeValue ZPAV   
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId  
		INNER JOIN ZnodePimAttribute ZPA on ZPAV.PimAttributeId = ZPA.PimAttributeId  
		WHERE ZPA.AttributeCode = 'SKU' AND ZPAVL.AttributeValue IS NOT NULL   
	)  AND ImportType = 'Product';  
  

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '103', 'Category', CODE, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetailsOFCategory AS ii  
	WHERE ii.CODE NOT IN   
	(  
		SELECT ZPCAVL.CategoryValue  
		FROM ZnodePimCategoryAttributeValue ZPCAV   
		INNER JOIN ZnodePimCategoryAttributeValueLocale ZPCAVL on ZPCAV.PimCategoryAttributeValueId = ZPCAVL.PimCategoryAttributeValueId  
		INNER JOIN ZnodePimAttribute ZPA on ZPCAV.PimAttributeId = ZPA.PimAttributeId  
		WHERE ZPA.AttributeCode = 'CategoryCode' AND ZPCAVL.CategoryValue IS NOT NULL  
	)  AND ImportType = 'Category';  
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '103', 'Brand', CODE, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetailsOFBrAND AS ii  
	WHERE ii.CODE NOT IN   
	(  
		SELECT BrandCode FROM ZnodeBrandDetails WHERE BrandCode IS NOT NULL  
	)  AND ImportType = 'Brand';  
    
	
	--Note : Content page import is not required   
    
	-- End Function Validation    
	-----------------------------------------------  
	--- Delete Invalid Data after functional validatin    
 
	DELETE FROM @InsertSEODetails  
	WHERE RowNumber IN  
	(  
		SELECT DISTINCT   
		RowNumber  
		FROM ZnodeImportLog  
		WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber is not null   
	);  


	DELETE FROM @InsertSEODetailsOFProducts  
	WHERE RowNumber IN  
	(  
		SELECT DISTINCT   
		RowNumber  
		FROM ZnodeImportLog  
		WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber is not null   
	);  
  
	DELETE FROM @InsertSEODetailsOFCategory  
	WHERE RowNumber IN  
	(  
		SELECT DISTINCT   
		RowNumber  
		FROM ZnodeImportLog  
		WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber is not null   
	);  
  
	DELETE FROM @InsertSEODetailsOFBrAND  
	WHERE RowNumber IN  
	(  
		SELECT DISTINCT   
		RowNumber  
		FROM ZnodeImportLog  
		WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber is not null   
	);  
  
 
	-- Insert Product Data   
	IF EXISTS (SELECT TOP 1 1 FROM @InsertSEODetailsOFProducts)  
	BEGIN  
		UPDATE ZCSD SET ZCSD.IsRedirect = ISD.IsRedirect ,  
			ZCSD.MetaInformation =  ISD.MetaInformation,  
			ZCSD.SEOUrl=  ISD.SEOUrl,  
			ZCSD.IsPublish = 0  
		FROM @InsertSEODetailsOFProducts ISD    
		INNER JOIN ZnodeCMSSEODetail ZCSD ON  ZCSD.CMSSEOTypeId = @CMSSEOTypeProduct AND ZCSD.SEOCode = ISD.Code  
		INNER JOIN ZnodeCMSSEODetailLocale ZCSDL ON ZCSD.CMSSEODetailId = ZCSDL.CMSSEODetailId  
		WHERE  ZCSD.PortalId  =@PortalId;  
     
		UPDATE ZCSDL SET ZCSDL.SEOTitle = ISD.SEOTitle  
			,ZCSDL.SEODescription = ISD.SEODescription  
			,ZCSDL.SEOKeywords= ISD.SEOKeywords
			,ZCSDL.CanonicalURL = ISD.CanonicalURL
			,ZCSDL.RobotTag = ISD.RobotTag  
		FROM @InsertSEODetailsOFProducts ISD    
		INNER JOIN ZnodeCMSSEODetail ZCSD ON  ZCSD.CMSSEOTypeId = @CMSSEOTypeProduct AND ZCSD.SEOCode = ISD.Code  
		INNER JOIN ZnodeCMSSEODetailLocale ZCSDL ON ZCSD.CMSSEODetailId = ZCSDL.CMSSEODetailId  
		WHERE  ZCSD.PortalId = @PortalId AND ZCSDL.LocaleId = @LocaleId;   
  
		----Making product as draft if SEOUrl is changed for part of partial publish
		UPDATE ZPP SET ZPP.PublishStateId = (SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE StateName = 'Draft')
		FROM ZnodePimProduct ZPP
		INNER JOIN ZnodePimAttributeValue ZPAV ON ZPP.PimProductId = ZPAV.PimProductId
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		WHERE EXISTS (SELECT * FROM ZnodePimAttribute zpa WHERE zpa.AttributeCode = 'SKU' AND ZPAV.PimAttributeId = zpa.PimAttributeId)
		AND EXISTS(SELECT * FROM @InsertSEODetailsOFProducts ISD    
			INNER JOIN ZnodeCMSSEODetail ZCSD ON  ZCSD.CMSSEOTypeId = @CMSSEOTypeProduct AND ZCSD.SEOCode = ISD.Code
			WHERE ZPAVL.AttributeValue = ZCSD.SEOCode)
     
		INSERT INTO ZnodeCMSSEODetailLocale (CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CanonicalURL,RobotTag)  
		SELECT DISTINCT CSD.CMSSEODetailId,@LocaleId,ISD.SEOTitle,ISD.SEODescription,ISD.SEOKeywords,@USerId, @GetDate,@USerId, @GetDate, CanonicalURL,RobotTag  
		FROM ZnodeCMSSEODetail CSD  
		INNER JOIN @InsertSEODetailsOFProducts ISD ON CSD.SEOCode = ISD.Code AND CSD.CMSSEOTypeId = @CMSSEOTypeProduct   
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEODetailLocale CSDL WHERE CSDL.LocaleId = @LocaleId AND CSD.CMSSEODetailId = CSDL.CMSSEODetailId )  
		AND CSD.portalId = @PortalId  
  
     
		DELETE FROM @InsertedZnodeCMSSEODetail  

		INSERT INTO ZnodeCMSSEODetail(CMSSEOTypeId,SEOCode,IsRedirect,MetaInformation,PortalId,SEOUrl,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)    
		OUTPUT Inserted.CMSSEODetailId,Inserted.SEOCode,Inserted.CMSSEOTypeId INTO @InsertedZnodeCMSSEODetail    
		SELECT DISTINCT @CMSSEOTypeProduct,ISD.Code , ISD.IsRedirect,ISD.MetaInformation,@PortalId,ISD.SEOUrl,@USerId, @GetDate,@USerId, @GetDate FROM   
		@InsertSEODetailsOFProducts ISD    
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEODetail ZCSD WHERE ZCSD.CMSSEOTypeId = @CMSSEOTypeProduct AND ZCSD.SEOCode = ISD.Code AND  ZCSD.PortalId =@PortalId   );  
    
		INSERT INTO ZnodeCMSSEODetailLocale(CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CanonicalURL,RobotTag)  
		SELECT DISTINCT IZCSD.CMSSEODetailId,@LocaleId,ISD.SEOTitle,ISD.SEODescription,ISD.SEOKeywords,@USerId, @GetDate,@USerId, @GetDate,CanonicalURL,RobotTag   
		FROM @InsertedZnodeCMSSEODetail IZCSD   
		INNER JOIN @InsertSEODetailsOFProducts ISD ON IZCSD.SEOCode = ISD.Code   

		----Making product as draft if SEOUrl is inserted for part of partial publish
		UPDATE ZPP SET ZPP.PublishStateId = (SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE StateName = 'Draft')
		FROM ZnodePimProduct ZPP
		INNER JOIN ZnodePimAttributeValue ZPAV ON ZPP.PimProductId = ZPAV.PimProductId
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		WHERE EXISTS (SELECT * FROM ZnodePimAttribute zpa WHERE zpa.AttributeCode = 'SKU' AND ZPAV.PimAttributeId = zpa.PimAttributeId)
		AND EXISTS(SELECT * FROM @InsertedZnodeCMSSEODetail IZCSD WHERE ZPAVL.AttributeValue = IZCSD.SEOCode)
  
		-----RedirectUrlInsert  
		INSERT INTO ZnodeCMSUrlRedirect ( RedirectFrom,RedirectTo,IsActive,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)  
		SELECT RedirectFrom,RedirectTo,
		EnableRedirection,@PortalId as PortalId ,2 as CreatedBy,@GetDate as CreatedDate,2 as ModifiedBy,@GetDate as ModifiedDate  
		FROM @InsertSEODetailsOFProducts SDP  
		WHERE IsRedirect = 1
		AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSUrlRedirect ZCR 
			WHERE ZCR.RedirectFROM = SDP.RedirectFROM AND ZCR.RedirectTo = SDP.RedirectTo)
			AND (SDP.RedirectFROM <> '' AND SDP.RedirectTo <> '' )
  
	END  
  
	-- Insert Category Data   
	IF EXISTS (SELECT TOP 1 1 FROM @InsertSEODetailsOFCategory)  
	BEGIN  
  
		UPDATE ZCSD SET ZCSD.IsRedirect = ISD.IsRedirect ,  
			ZCSD.MetaInformation =  ISD.MetaInformation,  
			ZCSD.SEOUrl=  ISD.SEOUrl,  
			ZCSD.IsPublish = 0  
		FROM @InsertSEODetailsOFCategory ISD    
		INNER JOIN ZnodeCMSSEODetail ZCSD ON  ZCSD.CMSSEOTypeId = @CMSSEOTypeCategory AND ZCSD.SEOCode = ISD.Code  
		INNER JOIN ZnodeCMSSEODetailLocale ZCSDL ON ZCSD.CMSSEODetailId = ZCSDL.CMSSEODetailId  
		WHERE  ZCSD.PortalId  =@PortalId;  
     
     
		UPDATE ZCSDL SET ZCSDL.SEOTitle = ISD.SEOTitle  
			,ZCSDL.SEODescription = ISD.SEODescription  
			,ZCSDL.SEOKeywords= ISD.SEOKeywords 
			,CanonicalURL = ISD.CanonicalURL
			,RobotTag = ISD.RobotTag
		FROM @InsertSEODetailsOFCategory ISD    
		INNER JOIN ZnodeCMSSEODetail ZCSD ON  ZCSD.CMSSEOTypeId = @CMSSEOTypeCategory AND ZCSD.SEOCode = ISD.Code  
		INNER JOIN ZnodeCMSSEODetailLocale ZCSDL ON ZCSD.CMSSEODetailId = ZCSDL.CMSSEODetailId  
		WHERE  ZCSD.PortalId  =@PortalId AND ZCSDL.LocaleId = @LocaleId;   
  
		INSERT INTO ZnodeCMSSEODetailLocale (CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CanonicalURL,RobotTag)  
		SELECT DISTINCT CSD.CMSSEODetailId,@LocaleId,ISD.SEOTitle,ISD.SEODescription,ISD.SEOKeywords,@USerId, @GetDate,@USerId, @GetDate,CanonicalURL,RobotTag  
		FROM ZnodeCMSSEODetail CSD  
		INNER JOIN @InsertSEODetailsOFProducts ISD ON CSD.SEOCode = ISD.Code AND CSD.CMSSEOTypeId = @CMSSEOTypeCategory   
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEODetailLocale CSDL WHERE CSDL.LocaleId = @LocaleId AND CSD.CMSSEODetailId = CSDL.CMSSEODetailId )  
		AND CSD.portalId = @PortalId  
  
  
		DELETE FROM @InsertedZnodeCMSSEODetail  

		INSERT INTO ZnodeCMSSEODetail(CMSSEOTypeId,SEOCode,IsRedirect,MetaInformation,PortalId,SEOUrl,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)    
		OUTPUT Inserted.CMSSEODetailId,Inserted.SEOCode,Inserted.CMSSEOTypeId INTO @InsertedZnodeCMSSEODetail    
		SELECT DISTINCT @CMSSEOTypeCategory,ISD.Code , ISD.IsRedirect,ISD.MetaInformation,@PortalId,ISD.SEOUrl,@USerId, @GetDate,@USerId, @GetDate   
		FROM @InsertSEODetailsOFCategory ISD    
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEODetail ZCSD WHERE ZCSD.CMSSEOTypeId = @CMSSEOTypeCategory AND ZCSD.SEOCode  = ISD.Code AND ZCSD.PortalId = @PortalId );  
  
		INSERT INTO ZnodeCMSSEODetailLocale(CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CanonicalURL,RobotTag)  
		SELECT DISTINCT IZCSD.CMSSEODetailId,@LocaleId,ISD.SEOTitle,ISD.SEODescription,ISD.SEOKeywords,@USerId, @GetDate,@USerId, @GetDate,CanonicalURL,RobotTag   
		FROM @InsertedZnodeCMSSEODetail IZCSD   
		INNER JOIN @InsertSEODetailsOFCategory ISD ON IZCSD.SEOCode = ISD.Code   
		WHERE IZCSD.CMSSEOTypeId =@CMSSEOTypeCategory    

		-----RedirectUrlInsert  
		INSERT INTO ZnodeCMSUrlRedirect ( RedirectFrom,RedirectTo,IsActive,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)  
		SELECT RedirectFrom,RedirectTo,
		EnableRedirection,@PortalId as PortalId ,2 as CreatedBy,@GetDate as CreatedDate,2 as ModifiedBy,@GetDate as ModifiedDate  
		FROM @InsertSEODetailsOFCategory SDP  
		WHERE IsRedirect = 1 
		AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSUrlRedirect ZCR 
			WHERE ZCR.RedirectFROM = SDP.RedirectFROM AND ZCR.RedirectTo = SDP.RedirectTo)
			AND (SDP.RedirectFROM <> '' AND SDP.RedirectTo <> '' )
	END  

	-- UPDATE Record count IN log 
	DECLARE @FailedRecordCount BIGINT
	DECLARE @SuccessRecordCount BIGINT
	SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
	SELECT @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertSEODetails
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
	WHERE ImportProcessLogId = @ImportProcessLogId;
	


	--Updating the import process status
	UPDATE ZnodeImportProcessLog
	SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
						WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
						WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
					END, 
		ProcessCompletedDate = getdate()
	WHERE ImportProcessLogId = @ImportProcessLogId; 
  
COMMIT TRAN A;  
END TRY  
BEGIN CATCH  
ROLLBACK TRAN A;

	SET @Status = 0;  
	SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE(); 

	DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportSEODetails @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@LocaleId='+CAST(@LocaleId AS VARCHAR(max)) +',@PortalId='+CAST(@PortalId AS VARCHAR(max)) +',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max)) ;

	---Import process updating fail due to database error
	UPDATE ZnodeImportProcessLog
	SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
	WHERE ImportProcessLogId = @ImportProcessLogId;

	---Loging error for Import process due to database error
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

	--Updating total AND fail record count
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
	TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
	WHERE ImportProcessLogId = @ImportProcessLogId;

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_ImportSEODetails',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
    
END CATCH;  
END;

GO

INSERT INTO ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 133,'Text','Input value is required in alphanumeric format without spaces.Hyphen or Underscore can be used.',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeMessage WHERE MessageCode = 133)

GO

Update ZnodeProductFeedType
set ProductFeedTypeName='XML Site Map'
Where ProductFeedTypeName='Xml Site Map'

GO

IF EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'IndexName' AND Object_ID = Object_ID(N'dbo.ZnodeCatalogIndex'))
BEGIN
	ALTER TABLE ZnodeCatalogIndex ALTER COLUMN [IndexName] NVARCHAR (200) NOT NULL;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetXmlProductFeedList')
	DROP PROC Znode_GetXmlProductFeedList
GO

CREATE PROCEDURE [dbo].[Znode_GetXmlProductFeedList]  
(
	@PortalId   VARCHAR(2000) = NULL,   
	@LocaleId   INT,  
	@FeedType   NVARCHAR(MAX) = NULL   
)
AS  
/*  
Summary: This Procedure is used to get effective keyword feeding of Product list  
 SELECT * FROM ZnodePublishProductDetail  
 SELECT * FROM ZnodePublishProduct WHERE PublishCatalogId = 3  
 SELECT * FROM ZnodePortalCatalog   
 Unit Testing:  
 EXEC [Znode_GetXmlProductFeedList] @PortalId='0',@ProductIds = '116,117,118'  
 ,@LocaleId=1,@FeedType='Bing'   
  
*/  
BEGIN  
BEGIN TRY  
SET NOCOUNT ON;        
           
		IF OBJECT_ID('tempdb..#TBL_DomainName') IS NOT NULL
		DROP TABLE #TBL_DomainName

		IF OBJECT_ID('tempdb..#TBL_SEODetails') IS NOT NULL
		DROP TABLE #TBL_SEODetails

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_PortalIds') IS NOT NULL
		DROP TABLE #TBL_PortalIds

		IF OBJECT_ID('tempdb..#TBL_PricePrecedence') IS NOT NULL
		DROP TABLE #TBL_PricePrecedence

		DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
		CREATE TABLE #TBL_DomainName 
		(PortalId   INT,
		DomainName NVARCHAR(300),
		RowId      INT
		);  	
         
		CREATE TABLE #TBL_SEODetails   
		(loc                   NVARCHAR(MAX),  
		lastmod               DATETIME,  
		[g:condition]         VARCHAR(1000),  
		[description]         NVARCHAR(MAX), 
		[SEOTitle]			  NVARCHAR(MAX),	
		[g:id]                INT,  
		link                  VARCHAR(1000),  
		[g:identifier_exists] VARCHAR(2000),  
		DomainName            NVARCHAR(3000),  
		PortalId              INT , 
		SEOCode             NVARCHAR(4000), 
		CanonicalURL        VARCHAR(2000), 
		RobotTag            VARCHAR(500)
		);  
		
		DECLARE @DefaultLocaleId INT=dbo.Fn_GetDefaultLocaleId()  ;
		CREATE TABLE #TBL_PortalIds (PortalId INT);  
		
		INSERT INTO #TBL_PortalIds  

		SELECT Zp.PortalId   
		FROM Znodeportal AS ZP   
		INNER JOIN ZnodePortalCatalog AS ZPC ON(ZPC.PortalId = Zp.PortalId)  
		INNER JOIN ZnodePublishCatalog AS ZPPC ON(ZPPC.PublishCatalogId = ZPC.PublishCatalogId)   
		INNER JOIN ZNodePublishProduct AS ZPP ON(ZPP.PublishCatalogId = ZPPC.PublishCatalogId)  
		INNER JOIN ZnodePublishProductDetail AS PPD ON (PPD.PublishProductId = ZPP.PublishProductId)  
		INNER JOIN ZnodePublishProductEntity AS ZPPE ON (PPD.SKU  = ZPPE.SKU)
		WHERE
		
		EXISTS(SELECT TOP 1 1 FROM DBO.Split(@PortalId, ',') AS Sp  
		WHERE(CAST(sp.Item AS INT)) = Zp.PortalId  OR @PortalId = '0')  
		AND EXISTS (SELECT TOP 1 1 FROM ZnodeDomain ZD WHERE ZP.PortalId = ZD.PortalId  
		AND IsActive = 1 AND ApplicationType = 'Webstore')  
		GROUP BY Zp.PortalId;   
		
		INSERT INTO #TBL_DomainName   
		SELECT  PortalId,DomainName,ROW_NUMBER() OVER(PARTITION BY PortalId ORDER BY DomainName)   
		FROM ZnodeDomain AS ZD   
		WHERE EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZD.PortalId)  
		AND IsActive = 1 AND ApplicationType = 'Webstore' AND IsDefault = 1 

		if not exists (select top 1 1 from #TBL_DomainName)
		INSERT INTO #TBL_DomainName   
		SELECT  PortalId,DomainName,ROW_NUMBER() OVER(PARTITION BY PortalId ORDER BY DomainName)   
		FROM ZnodeDomain AS ZD   
		WHERE EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZD.PortalId)  
		AND IsActive = 1 AND ApplicationType = 'Webstore'
 
			SELECT DISTINCT ZCSD.CMSSEODetailId,ZCSD.SEOURL AS loc,ZCSD.ModifiedDate AS lastmod,'new' AS [g:condition],ZCSDL.SEODescription AS [description],ZCSDL.SEOTitle AS [SEOTitle], ZPCC.PublishProductId AS [g:id],  
            ZCSD.SEOUrl AS link,'false' AS [g:identifier_exists],TBDN.DomainName,ZPC.PortalId,ISNULL(ZCSDL.LocaleId, @DefaultLocaleId) AS LocaleId , ZCSD.SEOCode , ZCSDL.CanonicalURL, ZCSDL.RobotTag 
			INTO #Cte_SeoDetailsWithLocale
			FROM ZNodePublishProduct AS ZPCC   
			INNER JOIN ZnodePortalCatalog AS ZPC ON(ZPC.PublishCatalogId = ZPCC.PublishCatalogId)  
			LEFT JOIN ZnodePublishProductDetail AS PPD ON (PPD.PublishProductId = ZPCC.PublishProductId)  
			LEFT JOIN ZnodeCMSSEODetail AS ZCSD ON(PPD.SKU = ZCSD.SEOCode and ZCSD.PortalId = ZPC.PortalId)  
			LEFT JOIN ZnodeCMSSEOType AS ZCST ON(ZCST.CMSSEOTypeId = ZCSD.CMSSEOTypeId AND ZCST.Name = 'Product')  
			LEFT JOIN ZnodeCMSSEODetailLocale AS ZCSDL ON(ZCSDL.CMSSEODetailId = ZCSD.CMSSEODetailId AND ZCSDL.LocaleId IN(@LocaleId, @DefaultLocaleId))  
			LEFT JOIN #TBL_DomainName AS TBDN ON(TBDN.RowId = 1 AND TBDN.PortalId = zpc.PortalId)   
			WHERE EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZPC.PortalId)  
				
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[SEOTitle],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag  
			INTO #Cte_SeoDetailsWithFirstLocale
			FROM #Cte_SeoDetailsWithLocale   
			WHERE LocaleId = @LocaleId  
    
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[SEOTitle],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode , CanonicalURL, RobotTag 
			INTO #Cte_SeoDetailsWithDefaultLocale
			FROM #Cte_SeoDetailsWithFirstLocale  
			
			INSERT INTO #Cte_SeoDetailsWithDefaultLocale 
			SELECT CMSSEODetailId,loc,lastmod,[g:condition],[description],[SEOTitle],[g:id],link,[g:identifier_exists],DomainName,PortalId,LocaleId,SEOCode, CanonicalURL, RobotTag  
			FROM #Cte_SeoDetailsWithLocale AS CTSDWL  
			WHERE LocaleId = @DefaultLocaleId   
			AND NOT EXISTS(SELECT TOP 1 1 FROM #Cte_SeoDetailsWithFirstLocale AS CTSDWDL WHERE CTSDWDL.CMSSEODetailId = CTSDWL.CMSSEODetailId)  
         
			INSERT INTO #TBL_SEODetails  
			SELECT DISTINCT loc,lastmod,[g:condition],[description],[SEOTitle],[g:id],link,[g:identifier_exists],DomainName,PortalId ,SEOCode, CanonicalURL, RobotTag  
			FROM #Cte_SeoDetailsWithDefaultLocale;
			
			select a.PublishProductId, d.AttributeDefaultValueCode as OutOfStockOptions
			into #TempProduct_OutOfStockOptions
			from ZnodePublishProduct a
			inner join ZnodePimAttributeValue b on a.PimProductId = b.PimProductId
			inner join ZnodePimProductAttributeDefaultValue c on b.PimAttributeValueId = c.PimAttributeValueId
			inner join ZnodePimAttributeDefaultValue d on c.PimAttributeDefaultValueId = d.PimAttributeDefaultValueId
			where EXISTS(select top 1 1 from ZnodePimAttribute ZPA where AttributeCode = 'OutOfStockOptions' AND b.PimAttributeId = ZPA.PimAttributeId)
			
			SELECT TBSD.loc,TBSD.lastmod,TBSD.[g:condition],TBSD.[description],TBSD.[SEOTitle],TBSD.[g:id],TBSD.link,TBSD.[g:identifier_exists],TBSD.DomainName,TBSD.PortalId,OOS.OutOfStockOptions,
			CASE WHEN SUM(ISNULL(ZI.Quantity,0)) > 0 THEN 'In Stock'
			     WHEN SUM(ISNULL(ZI.Quantity,0)) = 0 AND ISNULL(OOS.OutOfStockOptions,'') <> 'DisablePurchasing'  THEN 'In Stock'
                 WHEN @FeedType = 'Xml'THEN 'Out Of Stock' 
                 ELSE 'Not In Stock'  END AS [g:availability],
				 
			ZPPD.SKU ,TBSD.SEOCode, TBSD.CanonicalURL, TBSD.RobotTag, ZPP.PublishProductId,ZPPD.ProductName
			INTO #TBL_CompleteDetailes  
			FROM ZnodePublishProduct AS ZPP   
			inner join #TempProduct_OutOfStockOptions OOS ON ZPP.PublishProductId = OOS.PublishProductId
			LEFT JOIN #TBL_SEODetails AS TBSD ON(ZPP.PublishProductId = TBSD.[g:id] )  
			LEFT JOIN ZnodePublishProductDetail AS ZPPD ON(ZPPD.PublishProductId = ZPP.PublishProductId AND ZPPD.LocaleId = @LocaleId)  
			LEFT JOIN ZnodePortalWarehouse AS ZPW ON(ZPW.PortalId = TBSD.PortalId)  
			LEFT JOIN ZnodePortalAlternateWarehouse AS ZAPW ON(ZAPW.PortalWarehouseId = ZPW.PortalWarehouseId)  
			LEFT JOIN ZnodeInventory AS ZI ON(ZI.SKU = ZPPD.SKU AND (ZI.WarehouseId = ZPW.WarehouseId OR ZI.WarehouseId = ZAPW.WarehouseId))  			
			GROUP BY loc,lastmod,[g:condition],[description],[SEOTitle],[g:id],link,[g:identifier_exists],DomainName,TBSD.PortalId,ZPPD.SKU,ZPPD.LocaleId, TBSD.SEOCode, TBSD.CanonicalURL, TBSD.RobotTag, ZPP.PublishProductId,ZPPD.ProductName,OOS.OutOfStockOptions;    
			
			DECLARE @MediaConfiguration NVARCHAR(2000)=((SELECT TOP 1 ISNULL(CASE WHEN CDNURL = '' THEN NULL ELSE CDNURL END,URL) FROM ZnodeMediaConfiguration WHERE IsActive = 1));    
  
			CREATE INDEX Idx_#TBL_CompleteDetailes ON #TBL_CompleteDetailes(PortalId,SKU)
			
			select * into #TBL_PricePrecedence from(
			select ROW_NUMBER() OVER(PARTITION BY sku ORDER BY Precedence) rnk_min, sku, RetailPrice,SalesPrice,znodeprice.PriceListId,ZnodePriceList.ListCode,
			ZnodePriceListPortal.Precedence
			from znodeprice
			left join ZnodePriceList on ZnodePriceList.PriceListId = znodeprice.PriceListId
			left join  ZnodePriceListPortal on ZnodePriceList.PriceListId= ZnodePriceListPortal.PriceListId where PortalId = @PortalId 
			)a
			order by a.sku,Precedence
			delete from #TBL_PricePrecedence where rnk_min<>1 
	
			SELECT zp.PortalId,round(isnull(Zps.SalesPrice,Zps.RetailPrice),2) as Price,Zps.SKU,tbcd.SEOCode,ROW_NUMBER() OVER(PARTITION BY Zps.SKU,zp.PortalId ORDER BY ZPS.RetailPrice) AS RowId  
			INTO #Cte_PortalList
			FROM ZnodePriceList AS ZPL   
			LEFT JOIN ZnodePriceListPortal AS ZPLP ON ZPL.PriceListId = ZPLP.PriceListId  
			LEFT JOIN ZnodeCulture AS zc ON ZPL.CultureId = zc.CultureId
			LEFT JOIN ZnodePortal AS zp ON ZPLP.PortalId = zp.PortalId  
		    LEFT JOIN #TBL_PricePrecedence Zps ON(Zps.PriceListId = ZPL.PriceListId) 
			--LEFT JOIN ZnodePrice AS Zps ON(Zps.PriceListId = ZPL.PriceListId)   
			LEFT JOIN #TBL_CompleteDetailes AS TBCD ON(TBCD.PortalId = Zp.PortalId AND TBCD.SKU = Zps.Sku)   
			WHERE CAST(@GetDate AS DATE) BETWEEN ZPL.ActivationDate AND ZPL.ExpirationDate   
			AND EXISTS( SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = ZPLP.PortalId)   
			GROUP BY zp.PortalId,ZPS.RetailPrice,Zps.SalesPrice,Zps.SKU ,TBCD.SEOCode  
			
			SELECT D.PublishProductId,C.AttributeDefaultValueCode AS Brand
			INTO #BrandDetails
			FROM ZnodePimAttributeValue A
			INNER JOIN ZnodePimProductAttributeDefaultValue B ON B.PimAttributeValueId=A.PimAttributeValueId
			INNER JOIN ZnodePimAttributeDefaultValue C ON C.PimAttributeDefaultValueId=A.PimAttributeDefaultValueId	
			INNER JOIN Znodepublishproduct D ON  A.PimProductId = D.PimProductId 
			WHERE EXISTS(SELECT * FROM ZnodePimAttribute D WHERE D.PimAttributeId=A.PimAttributeId AND D.AttributeCode='Brand' )
			AND EXISTS(SELECT * FROM #TBL_CompleteDetailes E Where E.PublishProductId = D.PublishProductId)		
			
			SELECT A.CategoryName , A.ZnodeProductId AS PublishProductId, ROW_NUMBER() OVER(PARTITION BY A.ZnodeProductId ORDER BY A.ZnodeProductId) AS RowId
			INTO #ProductCategories
			FROM ZnodePublishProductEntity A 
			WHERE EXISTS(SELECT * FROM #TBL_CompleteDetailes B WHERE A.ZnodeProductId = B.PublishProductId)
			AND ISNULL(A.CategoryName,'') <> ''

			DELETE FROM #ProductCategories WHERE RowId <> 1
 
			SELECT SKU,SUM(cast(Quantity as numeric(28,0)))AS Inventory 
			into #InventotyDetails 
			FROM ZnodeInventory A 
			WHERE EXISTS(SELECT * FROM #TBL_CompleteDetailes B where A.SKU=B.SKU)
			GROUP BY SKU  

			SELECT F.PublishProductId,[Path] AS ImagePath
			INTO #ProductImage
			FROM ZnodePimAttributeValue a
			INNER JOIN ZnodePimProductAttributeMedia b on a.PimAttributeValueId = b.PimAttributeValueId
			INNER JOIN ZnodeMedia d on b.MediaId = d.MediaId
			INNER JOIN Znodepublishproduct F ON  A.PimProductId = F.PimProductId 
			WHERE EXISTS(SELECT * FROM ZnodePimAttribute C WHERE C.PimAttributeId=A.PimAttributeId AND C.AttributeCode='PRODUCTIMAGE' )
			AND EXISTS(SELECT * FROM #TBL_CompleteDetailes E Where E.PublishProductId = F.PublishProductId)		

						 
			SELECT 
			DomainName AS DomainName,
			isnull(ProductName,SEOTitle) as [Title],
			--lastmod,
			--[g:condition],
			[description] AS [Description],
			CAST([g:id] AS nvarchar(50) ) AS ProductID,
			[g:availability] AS [Availability],
			--[g:identifier_exists],	
			--TBCD.PortalId,
			Cast(CAST(CTPL.Price AS numeric(28,3))as nvarchar(100)) AS Price,
			@MediaConfiguration AS MediaConfiguration,
			--TBCD.SEOCode,
			--TBCD.CanonicalURL,
			--TBCD.RobotTag,
			PC.CategoryName AS Category,
			CAST(ID.Inventory AS nvarchar(50) ) AS Inventory,
			BD.Brand AS Brand,
			link AS Link,
			PM.IMAGEPATH AS Image_Link,
			CTPL.SKU AS ID
			FROM #TBL_CompleteDetailes AS TBCD   
			LEFT JOIN #Cte_PortalList AS CTPL ON(CTPL.PortalId = TBCD.PortalId AND CTPL.SKU = TBCD.SKU AND CTPL.RowID = 1)  
			LEFT JOIN #ProductCategories PC ON TBCD.PublishProductId = PC.PublishProductId
			LEFT JOIN #InventotyDetails ID ON TBCD.SKU = ID.SKU 
			LEFT JOIN #BrandDetails BD on TBCD.PublishProductId=BD.PublishProductId
			LEFT JOIN #ProductImage PM on TBCD.PublishProductId=PM.PublishProductId
			WHERE  EXISTS(SELECT TOP 1 1 FROM #TBL_PortalIds AS TBP WHERE TBP.PortalId = TBCD.PortalId)

		IF OBJECT_ID('tempdb..#TBL_DomainName') IS NOT NULL
		DROP TABLE #TBL_DomainName

		IF OBJECT_ID('tempdb..#TBL_SEODetails') IS NOT NULL
		DROP TABLE #TBL_SEODetails

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_CompleteDetailes') IS NOT NULL
		DROP TABLE #TBL_CompleteDetailes

		IF OBJECT_ID('tempdb..#TBL_PortalIds') IS NOT NULL
		DROP TABLE #TBL_PortalIds

		IF OBJECT_ID('tempdb..#TBL_PricePrecedence') IS NOT NULL
		DROP TABLE #TBL_PricePrecedence
		
END TRY  
BEGIN CATCH  
	DECLARE @Status BIT ;  
	SET @Status = 0;  
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetXmlProductFeedList @PortalId = '+@PortalId+',@LocaleId='+CAST(@LocaleId AS VARCHAR(50))+',@FeedType='+CAST(@FeedType AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));  
                 
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
     
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_GetXmlProductFeedList',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
   
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_AdminUserDetailsByUserId')
	DROP PROC Znode_AdminUserDetailsByUserId
GO

CREATE PROCEDURE [dbo].[Znode_AdminUserDetailsByUserId]
(	
	@UserId INT
)
AS
/* 
    Summary: SP used to get the User details using UserId
    EXEC [Znode_AdminUserDetailsByUserId] @UserId = 1005
*/
BEGIN
BEGIN TRY
SET NOCOUNT ON;
	if OBJECT_ID('tempdb..#View_CustomerUserAddDetail') is not null
		drop table #View_CustomerUserAddDetail

	SELECT top 1 a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
			a.Email,a.EmailOptIn,a.CreatedBy,a.SMSOptIn,CONVERT( DATE, a.CreatedDate) CreatedDate,A.ModifiedBy,
			CONVERT( DATE, a.ModifiedDate) ModifiedDate,ur.RoleId,r.Name RoleName,
			CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
			e.Name+' | '+e.AccountCode AccountName,a.AccountId,a.ExternalId,
			CAST(CASE WHEN a.AccountId IS NULL THEN 0 ELSE 1 END AS    BIT) AS IsAccountCustomer,
			a.BudgetAmount,r.TypeOfRole,CAST(CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END AS    BIT) AS IsGuestUser,
			a.CustomerPaymentGUID,
			(ISNULL(RTRIM(LTRIM(a.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(a.MiddleName)), '')
			+CASE
				WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '') = ''
				THEN ''
				ELSE ' '
			END+ISNULL(RTRIM(LTRIM(a.LastName)), '')) FullName
	,CASE WHEN zp.StoreName IS NULL THEN 'ALL' ELSE zp.StoreName END StoreName,
	CASE WHEN a.AccountId IS NULL THEN up.PortalId ELSE ZPA.PortalId END as PortalId
	into #View_CustomerUserAddDetail
	FROM ZnodeUser a
	left JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
	LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
	LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
	LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)                       
	LEFT JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
	LEFT JOIN ZnodeUserPortal up ON(up.UserId = a.UserId)  
	LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
	LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = a.AccountId) 
	WHERE a.UserId = @UserId


	alter table #View_CustomerUserAddDetail 
	Add DepartmentId int, AccountPermissionAccessId int,SalesRepUserName varchar(600),SalesRepId Int,
	PermissionsName varchar(200), PermissionCode varchar(200),SalesRepFullName varchar(1000)

	--To get data for DepartmentId
	update CUD SET DepartmentId = i.DepartmentId
	from #View_CustomerUserAddDetail cud
	INNER JOIN ZnodeDepartmentUser i ON(i.UserId = cud.UserId)

	--To get data for AccountPermissionAccessId
	update CUD SET AccountPermissionAccessId = f.AccountPermissionAccessId
	from #View_CustomerUserAddDetail cud
	INNER JOIN ZnodeAccountUserPermission f ON(f.UserId = cud.UserId)

	----Updating SalesRep for user if any 
	update CUAD
	set CUAD.SalesRepUserName = azu.UserName, SalesRepId = SRCUP.SalesRepUserId,
	CUAD.SalesRepFullName = (ISNULL(RTRIM(LTRIM(ZU.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '')
								+CASE
									WHEN ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '') = ''
									THEN ''
									ELSE ' '
								END+ISNULL(RTRIM(LTRIM(ZU.LastName)), '')) 
	from #View_CustomerUserAddDetail CUAD
	inner join ZnodeSalesRepCustomerUserPortal SRCUP ON CUAD.UserId = SRCUP.CustomerUserid 
	inner join ZnodeUser ZU ON SRCUP.SalesRepUserId = ZU.UserId
	inner join ASPNetUsers ANU ON(ZU.AspNetuserId = ANU.Id)
	inner join AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = ANU.UserName)

	--To get data for PermissionsName
	update CUD SET PermissionsName = h.PermissionsName, PermissionCode = h.PermissionCode
	from #View_CustomerUserAddDetail cud
    INNER JOIN ZnodeAccountUserPermission f ON(f.UserId = cud.UserId)
    INNER JOIN ZnodeAccountPermissionAccess g ON(g.AccountPermissionAccessId = f.AccountPermissionAccessId)
    INNER JOIN ZnodeAccessPermission h ON(h.AccessPermissionId = g.AccessPermissionId)

	SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,FullName,PhoneNumber, Email,EmailOptIn,SMSOptIn,CreatedBy,CreatedDate,
		   ModifiedBy, ModifiedDate,RoleId,RoleName,IsLock,AccountName,AccountId,ExternalId,IsAccountCustomer,BudgetAmount,
		   TypeOfRole,IsGuestUser,CustomerPaymentGUID,StoreName, PortalId,DepartmentId, AccountPermissionAccessId,
		   SalesRepUserName,SalesRepFullName,isnull(SalesRepId,0) as SalesRepId, PermissionsName, PermissionCode
	FROM #View_CustomerUserAddDetail

	if OBJECT_ID('tempdb..#View_CustomerUserAddDetail') is not null
		drop table #View_CustomerUserAddDetail

END TRY
BEGIN CATCH
	DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_AdminUserDetailsByUserId @UserId ='+CAST(@UserId AS VARCHAR(10));
	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName    = 'Znode_AdminUserDetailsByUserId',
	@ErrorInProcedure = @ERROR_PROCEDURE,
	@ErrorMessage     = @ErrorMessage,
	@ErrorLine        = @ErrorLine,
	@ErrorCall        = @ErrorCall;
END CATCH;
END;

GO

UPDATE ZnodeApplicationSetting
SET Setting ='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>OmsTemplateId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>TemplateName</name><headertext>Template Name</headertext><width>0</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl>/SavedCart/EditSavedCartItem</islinkactionurl><islinkparamfield>omsTemplateId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>Items</name><headertext>Items</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>z-items</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>CreatedDate</name><headertext>Created Date</headertext><width>30</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>ModifiedDate</name><headertext>Modified Date</headertext><width>30</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>Edit|Orders|Delete</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|MoveToCart|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/SavedCart/EditSavedCartItem|/SavedCart/AddProductToCartForSaveCart|/SavedCart/DeleteSavedCartTemplate</manageactionurl><manageparamfield>omsTemplateId|omsTemplateId|omsTemplateId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
WHERE ItemName='ZnodeSavedCart'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdatePimProduct')
	DROP PROC Znode_InsertUpdatePimProduct
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdatePimProduct]
(   @ProductXml NVARCHAR(max),
    @UserId     INT,
    @status     BIT OUT,
	@CopyPimProductId INT =0 )
AS
/*
     Summary : To Insert / Update single Product with multiple attribute values 
     Update Logic: 
*/
     BEGIN

         BEGIN TRY

		     DECLARE @ConvertedXML XML = REPLACE(REPLACE(REPLACE(@ProductXml,' & ', '&amp;'),'"', '&quot;'),'''', '&apos;')
             DECLARE @PimProductId INT= 0;
             DECLARE @PimProductDetail_xml PIMPRODUCTDETAIL;
             INSERT INTO @pimProductDetail_xml
                    SELECT Tbl.Col.value('ProductAttributeId[1]', 'int') AS ProductAttributeId,
                           Tbl.Col.value('ProductAttributeFamilyId[1]', 'int') AS ProductAttributeFamilyId,
                           Tbl.Col.value('ProductAttributeCode[1]', 'NVARCHAR(300)') AS ProductAttributeCode,
                           Tbl.Col.value('ProductAttributeDefaultValueId[1]', 'int') AS ProductAttributeDefaultValueId,
                           Tbl.Col.value('ProductAttributeValueId[1]', 'int') AS ProductAttributeValueId,
                           Tbl.Col.value('LocaleId[1]', 'INT') AS LocaleId,
                           Tbl.Col.value('ProductId[1]', 'INT') AS ProductId,
                           Tbl.Col.value('ProductAttributeValue[1]', 'NVARCHAR(Max)') AS ProductAttributeValue,
                           Tbl.Col.value('AssociatedProducts[1]', 'NVARCHAR(2000)') AS AssociatedProducts,
                           Tbl.Col.value('ConfigureAttributeIds[1]', 'NVARCHAR(2000)') AS ConfigureAttributeIds,
                           Tbl.Col.value('ConfigureFamilyIds[1]', 'NVARCHAR(2000)') AS ConfigureFamilyIds
                    FROM @ConvertedXML.nodes('//ArrayOfProductAttributeModel/ProductAttributeModel') AS Tbl(Col);
					--Validating SKU is present or not  
					 SET @PimProductId=(SELECT top 1 ZPAV.PimProductId FROM ZnodePimAttributeValue ZPAV     
										INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId    
										WHERE EXISTS(SELECT * FROM ZnodePimAttribute ZPA WHERE ZPA.PimAttributeId = ZPAV.PimAttributeId AND ZPA.AttributeCode = 'SKU')    
										AND EXISTS(SELECT * FROM @pimProductDetail_xml Z WHERE ProductAttributeCode = 'SKU' AND ZPAVL.AttributeValue = Z.AttributeValue AND ISNULL(Z.PimProductId,0) = 0)    )
     
					IF (@PimProductId  <> 0) 
					BEGIN  
						SET @status = 0  
						SELECT @PimProductId AS ID,CAST(0 AS BIT) AS Status;     
						RETURN;  
					END  
             -- Retrieve input productId from @PimProductDetail table ( having multiple attribute values with common productId) 
         BEGIN TRAN A;
             SET @PimProductId =
             (
                 SELECT TOP 1 PimProductId
                 FROM @PimProductDetail_xml
             );
             EXEC [dbo].[Znode_ImportInsertUpdatePimProduct]
                  @PimProductDetail_xml,
                  @UserId,
                  @status OUT,0
				  ,@CopyPimProductId ; 

			DECLARE @PublishStateIdForDraftState INT = [dbo].[Fn_GetPublishStateIdForDraftState]()
			UPDATE ZCSD set PublishStateId = @PublishStateIdForDraftState
			FROM ZnodeCMSSeoDetail ZCSD
			WHERE EXISTS(select 1 from @PimProductDetail_xml x where x.ProductAttributeCode = 'SKU' AND ZCSD.SEOCode = LTRIM(RTRIM(x.AttributeValue)))
			
             SET @status = 1;
             COMMIT TRAN A;
         END TRY
         BEGIN CATCH
             SELECT ERROR_MESSAGE()
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertUpdatePimProduct @ProductXml = '+CAST(@ProductXml AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@CopyPimProductId='+CAST(@CopyPimProductId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
			 ROLLBACK TRAN A;
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_InsertUpdatePimProduct',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCustomerAddress')
	DROP PROC Znode_ImportCustomerAddress
GO

CREATE PROCEDURE [dbo].[Znode_ImportCustomerAddress]
(
	@TableName NVARCHAR(100), 
	@Status BIT OUT, 
	@UserId INT, 
	@ImportProcessLogId INT, 
	@NewGUId NVARCHAR(200), 
	@LocaleId INT= 0,
	@CsvColumnString NVARCHAR(MAX),
	@IsAccountAddress BIT = 0 
)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Customer Address
	
	-- Unit Testing : 
	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(max),@IsAllowGlobalLevelUserCreation NVARCHAR(10)

		DECLARE @GETDATE DATETIME= dbo.Fn_GETDATE();
		-- Retrive Value FROM global setting 
		SELECT @IsAllowGlobalLevelUserCreation = FeatureValues FROM ZnodeGlobalsetting WHERE FeatureName = 'AllowGlobalLevelUserCreation'
		-- Three type of import required three table varible for product , category AND brand

		CREATE TABLE #InsertCustomerAddress 
		( 
			RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT,UserName NVARCHAR(512),FirstName VARCHAR(300),
			LastName VARCHAR(300),DisplayName NVARCHAR(1200),Address1 VARCHAR(300),Address2 VARCHAR(300),
			CountryName VARCHAR(3000),StateName VARCHAR(3000),CityName VARCHAR(3000),PostalCode VARCHAR(50),
			PhoneNumber VARCHAR(50),IsDefaultBilling BIT,IsDefaultShipping BIT	,IsActive BIT,ExternalId NVARCHAR(2000),
			CompanyName NVARCHAR(2000), GUID NVARCHAR(400), PortalId INT
		);
	
		SET @SSQL = ' INSERT INTO #InsertCustomerAddress ( RowNumber, ' + @CsvColumnString + ' ,GUID )
		SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+ @TableName;
		EXEC sys.sp_sqlexec @SSQL;

		UPDATE ICA
		SET ICA.PortalId=ZUP.PortalId
		FROM #InsertCustomerAddress ICA
		INNER JOIN ZnodeUser ZU ON ICA.UserName=ZU.UserName
		INNER JOIN ZnodeUserPortal ZUP ON ZU.UserId=ZUP.UserId
		-- start Functional Validation 
		----------------------------------------------

		IF (@IsAccountAddress = 0)
		BEGIN
			IF @IsAllowGlobalLevelUserCreation = 'true'
			BEGIN
				INSERT INTO ZnodeImportLog
					(ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '106', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
				FROM #InsertCustomerAddress AS ii
				WHERE ii.UserName NOT IN 
				(
					SELECT UserName FROM AspNetZnodeUser WHERE PortalId = ii.PortalId
				);
			END
			ELSE
			BEGIN
				INSERT INTO ZnodeImportLog
					(ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '106', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
				FROM #InsertCustomerAddress AS ii
				WHERE ii.UserName NOT IN 
				(
					SELECT UserName FROM AspNetZnodeUser   
				);

				INSERT INTO ZnodeImportLog
					(ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '8', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
				FROM #InsertCustomerAddress AS ii
				WHERE ISNULL(ltrim(rtrim(ii.UserName)), '') = ''
			END
		END

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '8', 'StateName', StateName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
		FROM #InsertCustomerAddress AS ii
		WHERE NOT EXISTS(SELECT * FROM ZnodeState ZS INNER JOIN ZnodeCountry ZC ON ZS.CountryCode = ZC.CountryCode
						WHERE ii.CountryName = ZC.CountryName AND ZS.StateName = ISNULL(LTRIM(RTRIM(ii.StateName)), ''))

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '8', 'CountryName', CountryName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
		FROM #InsertCustomerAddress AS ii
		WHERE NOT EXISTS(SELECT * FROM ZnodeCountry ZC WHERE ZC.CountryName = ISNULL(LTRIM(RTRIM(ii.CountryName)), '') )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '90', 'CountryName', CountryName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
		FROM #InsertCustomerAddress AS ii
		WHERE ISNULL(ltrim(rtrim(ii.CountryName)), '') <> ''
			AND NOT EXISTS(SELECT * FROM ZnodePortalCountry ZPC INNER JOIN ZnodeCountry ZC ON ZPC.CountryCode = ZC.CountryCode
				WHERE PortalId = ii.PortalId AND LTRIM(RTRIM(ii.CountryName)) = LTRIM(RTRIM(ZC.CountryName)))
				AND ii.PortalId IS NOT NULL

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '134', 'CountryName', CountryName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
		FROM #InsertCustomerAddress AS ii
		WHERE ISNULL(LTRIM(RTRIM(ii.CountryName)), '') <> ''
			AND NOT EXISTS(SELECT * FROM ZnodePortalCountry ZPC INNER JOIN ZnodeCountry ZC ON ZPC.CountryCode = ZC.CountryCode
				WHERE LTRIM(RTRIM(ii.CountryName)) = LTRIM(RTRIM(ZC.CountryName)))
			AND ii.PortalId IS NULL

		 -- error log when atleast db have 
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '63', 'IsDefaultBilling/IsDefaultShipping', IsDefaultBilling, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
		FROM #InsertCustomerAddress IC WHERE EXISTS
			(
				SELECT TOP 1 1  FROM AspNetZnodeUser ANZU 
				INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN ZnodeUserAddress ZUA ON ZUA.UserId = ZU.UserId
				INNER JOIN ZnodeAddress ZA ON ZUA.AddressId = ZA.AddressId
				WHERE ANZU.UserName = IC.UserName AND ZA.IsDefaultBilling =IC.IsDefaultBilling 
					AND ZA.IsDefaultShipping =IC.IsDefaultShipping
			)

		--Note : Content page import is not required 
		
		-- End Function Validation 	
		-----------------------------------------------
		UPDATE ZIL
		SET ZIL.ColumnName =   ZIL.ColumnName + ' [ UserName - ' + ISNULL(UserName,'') + ' ] '
		FROM ZnodeImportLog ZIL 
		INNER JOIN #InsertCustomerAddress IPA ON (ZIL.RowNumber = IPA.RowNumber)
		WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		DELETE FROM #InsertCustomerAddress
		WHERE RowNumber IN
		(
			SELECT DISTINCT RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber IS NOT NULL 
			--AND GUID = @NewGUID
		);

		UPDATE ZA SET ZA.IsDefaultBilling = 0
		FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
		INNER JOIN ZnodeUserAddress ZUA ON ZUA.UserId = ZU.UserId
		INNER JOIN ZnodeAddress ZA ON ZUA.AddressId = ZA.AddressId
		INNER JOIN #InsertCustomerAddress IC ON ANZU.UserName = IC.UserName --and IC.IsDefaultBilling <> ZA.IsDefaultBilling 
		WHERE IC.IsDefaultBilling = 1 

		UPDATE ZA SET ZA.IsDefaultShipping = 0
		FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
		INNER JOIN ZnodeUserAddress ZUA ON ZUA.UserId = ZU.UserId
		INNER JOIN ZnodeAddress ZA ON ZUA.AddressId = ZA.AddressId
		INNER JOIN #InsertCustomerAddress IC ON ANZU.UserName = IC.UserName
		WHERE IC.IsDefaultShipping = 1 

		--DELETE FROM ZnodeImportLog  WHERE ImportProcessLogId = @ImportProcessLogId AND  ErrorDescription = '63'
		-- UPDATE Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT

		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;

		SELECT @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertCustomerAddress

		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
			TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- End
	
		DELETE FROM #InsertCustomerAddress 
		WHERE NOT EXISTS
			(SELECT TOP 1 1 FROM 
				(
					SELECT ROW_NUMBER() OVER(PARTITION BY UserName,FirstName,LastName,DisplayName,Address1,Address2,CountryName,StateName,CityName,PostalCode	
						,PhoneNumber,IsDefaultBilling,IsDefaultShipping,ExternalId,CompanyName ORDER BY RowId DESC)	AS rw_nmbr,RowId
					FROM #InsertCustomerAddress
				) abc WHERE rw_nmbr =1 AND abc.RowId = #InsertCustomerAddress.RowId
			)

		----------UPDATE ZnodeAddress
		DECLARE @AddressColumnString VARCHAR(1000), @WhereConditionString VARCHAR(1000), @UpdateColumnString VARCHAR(1000)

		SELECT @AddressColumnString = COALESCE(@AddressColumnString + ',', '')+a.ColumnName --COALESCE(@CsvColumnString + ' AND ', '') +'ZA.'+ColumnName+' =  IC.'+ColumnName
		FROM ZnodeImportUpdatableColumns a
		INNER JOIN INFORMATION_SCHEMA.COLUMNS b ON a.ColumnName = b.COLUMN_NAME  
		INNER JOIN dbo.Split(@CsvColumnString,',')C ON b.COLUMN_NAME = c.Item
		WHERE b.TABLE_NAME = 'ZnodeAddress' 
		AND EXISTS(SELECT * FROM ZnodeImportHead IH WHERE a.ImportHeadId = IH.ImportHeadId AND IH.Name in ('CustomerAddress','ShippingAddress'))

		SELECT @UpdateColumnString = COALESCE(@UpdateColumnString + ' , ', '') +'ZA.'+a.COLUMN_NAME+' =  IC.'+a.COLUMN_NAME  
		FROM INFORMATION_SCHEMA.COLUMNS a
		INNER JOIN dbo.Split(@CsvColumnString,',')b ON a.COLUMN_NAME = b.Item
		WHERE NOT EXISTS (SELECT * FROM dbo.Split(@AddressColumnString,',') c WHERE a.COLUMN_NAME = c.Item )
		AND a.TABLE_NAME = 'ZnodeAddress'

		SELECT @WhereConditionString = COALESCE(@WhereConditionString + ' AND ', '') +'ZA.'+item+' =  IC.'+item FROM dbo.split(@AddressColumnString,',')
		SET @WhereConditionString = Replace(@WhereConditionString , 'ZA.Address2 =  IC.Address2', 'ISNULL(ZA.Address2 ,'''')=  ISNULL(IC.Address2 ,'''')') 
	
		UPDATE a SET a.StateName =c.StateCode  
		FROM #InsertCustomerAddress a 
		INNER JOIN ZnodeCountry b ON a.CountryName = b.CountryName 
		INNER JOIN ZnodeState c ON b.CountryCode = c.CountryCode AND C.StateName = a.StateName
		
		UPDATE a SET a.CountryName= b.CountryCode FROM  #InsertCustomerAddress a INNER JOIN ZnodeCountry b ON a.CountryName = b.CountryName 
		
		CREATE TABLE #InsertedUserAddress (AddressId  NVARCHAR(256), UserId NVARCHAR(max),UserName nvarchar(300)) 

		IF ( @IsAccountAddress = 1 )
		BEGIN
			UPDATE ZnodeAddress SET IsDefaultBilling = 0,  IsDefaultShipping = 0
			FROM AspNetZnodeUser ANZU 
			INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
			INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
			INNER JOIN ZnodeUserAddress ZUA ON ZUA.UserId = ZU.UserId
			INNER JOIN ZnodeAddress ZA ON ZUA.AddressId = ZA.AddressId
			INNER JOIN #InsertCustomerAddress IC ON ANZU.UserName = IC.UserName AND ZA.IsDefaultBilling =IC.IsDefaultBilling 
													AND ZA.IsDefaultShipping =IC.IsDefaultShipping

			SET @SSQL = '
				UPDATE ZA set ModifiedBy = '+CONVERT(VARCHAR(10), @UserId)+', ModifiedDate = getdate() '+CASE WHEN ISNULL(@UpdateColumnString,'') = '' THEN '' ELSE ','+@UpdateColumnString END+' 
				FROM ZnodeAddress ZA
				INNER JOIN #InsertCustomerAddress IC ON '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END

			EXEC (@SSQL)

			SET @SSQL = '
				Insert into ZnodeAddress (FirstName,LastName,DisplayName,Address1,Address2,Address3,CountryName,
										StateName,CityName,PostalCode,PhoneNumber,
										IsDefaultBilling,IsDefaultShipping,IsActive,ExternalId,CompanyName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsShipping,IsBilling)		
				OUTPUT INSERTED.AddressId INTO  #InsertedUserAddress (AddressId) 			 
				SELECT IC.FirstName,IC.LastName,IC.DisplayName,IC.Address1,IC.Address2,null,IC.CountryName ,
				IC.StateName,
				,IC.CityName,IC.PostalCode,IC.PhoneNumber,
				isnull(IC.IsDefaultBilling,0),isnull(IC.IsDefaultShipping,0),isnull(IC.IsActive,0),IC.ExternalId,IC.CompanyName, '+CONVERT(VARCHAR(10), @UserId)+' , getdate() , '+CONVERT(VARCHAR(10), @UserId)+' ,getdate(), 1, 1
				FROM  #InsertCustomerAddress IC
				WHERE NOT EXISTS(SELECT * FROM ZnodeAddress ZA WHERE '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END +')'

			EXEC (@SSQL)

			DECLARE @AccountId INT
			SELECT @AccountId = AccountId FROM ZnodeUser WHERE UserId = @UserId
			INSERT INTO ZnodeAccountAddress ( AccountId, AddressId, CreatedBy, CreatedDate,	ModifiedBy,	ModifiedDate )
			SELECT @AccountId, Addressid ,  @UserId , @GETDATE, @UserId , @GETDATE FROM #InsertedUserAddress UA
			WHERE NOT EXISTS ( SELECT * FROM ZnodeAccountAddress AA WHERE AccountId = @AccountId AND AA.Addressid = UA.Addressid )
		END
		ELSE
		BEGIN
			UPDATE ZnodeAddress SET IsDefaultBilling = 0,  IsDefaultShipping = 0
			FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
			INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
			INNER JOIN ZnodeUserAddress ZUA ON ZUA.UserId = ZU.UserId
			INNER JOIN ZnodeAddress ZA ON ZUA.AddressId = ZA.AddressId
			INNER JOIN #InsertCustomerAddress IC ON ANZU.UserName = IC.UserName AND ZA.IsDefaultBilling =IC.IsDefaultBilling 
			AND ZA.IsDefaultShipping =IC.IsDefaultShipping
					
			SET @SSQL = '
				UPDATE ZA set ModifiedBy = '+CONVERT(VARCHAR(10), @UserId)+',ModifiedDate = getdate(),Address3 = IC.UserName '+
				CASE WHEN ISNULL(@UpdateColumnString,'') = '' THEN '' ELSE ','+@UpdateColumnString END+' 
				OUTPUT INSERTED.AddressId,INSERTED.Address3 INTO  #InsertedUserAddress (AddressId,UserName) 
				FROM ZnodeAddress ZA 
				INNER JOIN #InsertCustomerAddress IC ON '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END
			
			EXEC (@SSQL)

			UPDATE a SET a.UserId = b.UserId
			FROM #InsertedUserAddress a
			INNER JOIN ZnodeUser b ON LTRIM(RTRIM(A.UserName)) = LTRIM(RTRIM(b.UserName))

			SET @SSQL = '
				Insert into ZnodeAddress (FirstName,LastName,DisplayName,Address1,Address2,Address3,CountryName,
											StateName,CityName,PostalCode,PhoneNumber,
											IsDefaultBilling,IsDefaultShipping,IsActive,ExternalId,CompanyName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsShipping,IsBilling)		
				OUTPUT INSERTED.AddressId, INSERTED.Address3 INTO  #InsertedUserAddress (AddressId, UserId ) 			 
				SELECT IC.FirstName,IC.LastName,IC.DisplayName,IC.Address1,IC.Address2,convert(nvarchar(100),ZU.UserId),IC.CountryName ,
				IC.StateName 
				,IC.CityName,IC.PostalCode,IC.PhoneNumber,
				isnull(IC.IsDefaultBilling,0),isnull(IC.IsDefaultShipping,0),isnull(IC.IsActive,0),IC.ExternalId,IC.CompanyName, '+CONVERT(VARCHAR(10), @UserId)+' , getdate() , '+CONVERT(VARCHAR(10), @UserId)+' ,getdate(),1,1
				FROM #InsertCustomerAddress IC INNER JOIN ZnodeUser ZU ON ZU.UserName= IC.UserName
				WHERE NOT EXISTS(SELECT * FROM ZnodeAddress ZA WHERE '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END +')'
			
			print @SSQL

			EXEC (@SSQL)
			INSERT INTO ZnodeUserAddress(UserId,AddressId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT CAST( UserId AS INT ) , Addressid , @UserId , @GETDATE, @UserId , @GETDATE FROM  #InsertedUserAddress
		END
				
		UPDATE ZA SET ZA.CountryName = ZC.CountryCode
		FROM ZnodeAddress ZA
		INNER JOIN ZnodeCountry ZC ON LTRIM(RTRIM(ZA.CountryName)) = LTRIM(RTRIM(ZC.CountryName))

		UPDATE ZA SET ZA.Address3 = null 
		FROM ZnodeAddress ZA INNER JOIN #InsertedUserAddress IUA ON ZA.AddressId = IUA.AddressId 

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;
		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), 
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
				@ErrorLine VARCHAR(100)= ERROR_LINE(), 
				@ErrorCall NVARCHAR(MAX)= 
					'EXEC Znode_ImportCustomerAddress 
						@TableName = '+CAST(@TableName AS VARCHAR(max)) +',
						@Status='+ CAST(@Status AS VARCHAR(10))+',
						@UserId = '+CAST(@UserId AS VARCHAR(50))+',
						@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',
						@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',
						@LocaleId='+CAST(@LocaleId AS VARCHAR(max)) +',
						@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max)) +',
						@IsAccountAddress='+CAST(@IsAccountAddress AS VARCHAR(max));

		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GETDATE
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId

		--Updating total AND fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
			TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportCustomerAddress',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportValidatePimProductData')
	DROP PROC Znode_ImportValidatePimProductData
GO

CREATE PROCEDURE [dbo].[Znode_ImportValidatePimProductData]
(   @ImportHeadName     VARCHAR(200),
    @TableName          VARCHAR(200),
    @NewGUID            NVARCHAR(200),
    @TemplateId         INT,
    @UserId             INT,
    @LocaleId           INT           = 1,
    @IsCategory         INT           = 0,
    @DefaultFamilyId    INT           = 0,
    @ImportProcessLogId INT,
    @PriceListId        INT,
	@CountryCode VARCHAR(100) = '',
	@PimCatalogId         INT    = 0 ,
	@PortalId int = 0,
	@IsAccountAddress bit = 0 )
AS
     SET NOCOUNT ON;

/*
    Summary :   Import PimProduct / Price / Inventory / Category / Category Associated Data 
    Process :   Admin site will upload excel / csv file in database and create global temporary table
				Procedure Znode_ImportValidatePimProductData will validate data with attribute validation rule
				If datatype validation issue found in input daata will logged into table "ZnodeImportLog"
				If Data is correct and record count in table ZnodeImportLog will be 0 then process for import data into Base tables
				To import data call procedure "Znode_ImportPimProductData"
    		  
				SourceColumnName: CSV file column headers
				TargetColumnName: Attributecode from ZnodePimAttribute Table (Consider those Attributecodes configured with default family only)
*/

     BEGIN
         BEGIN TRY
             SET NOCOUNT ON;
             --BEGIN TRAN TRN_ImportValidProductData;
             DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
             DECLARE @SQLQuery NVARCHAR(MAX), @AttributeTypeName NVARCHAR(100), @AttributeCode NVARCHAR(300), @AttributeId INT, @IsRequired BIT, @SourceColumnName NVARCHAR(600), @ControlName VARCHAR(300), @ValidationName VARCHAR(100), @SubValidationName VARCHAR(300), @ValidationValue VARCHAR(300), @RegExp VARCHAR(300), @CreateDateString NVARCHAR(300), @DefaultLocaleId INT, @ImportHeadId INT, @CheckedSourceColumn NVARCHAR(600)= '', @Status BIT= 0,
			    @CsvColumnString nvarchar(max),
				@FailedRecordCount BIGINT,
				@SuccessRecordCount BIGINT
            --To get the total record count for update purpose in catch block
            SET @SQLQuery = 'SELECT '+CAST(@ImportProcessLogId AS VARCHAR(10))+',COUNT(*) FROM '+@TableName
			INSERT INTO Znode_ImportCsvRowCount
			EXEC (@SQLQuery) 

             DECLARE @FamilyAttributeDetail TABLE
             (PimAttributeId       INT,
              AttributeTypeName    VARCHAR(300),
              AttributeCode        VARCHAR(300),
              SourceColumnName     NVARCHAR(600),
              IsRequired           BIT,
              PimAttributeFamilyId INT
             );
             DECLARE @AttributeDetail TABLE
             (PimAttributeId    INT,
              AttributeTypeName VARCHAR(300),
              AttributeCode     VARCHAR(300),
              SourceColumnName  NVARCHAR(600),
              IsRequired        BIT,
              ControlName       VARCHAR(300),
              ValidationName    VARCHAR(100),
              SubValidationName VARCHAR(300),
              ValidationValue   VARCHAR(300),
              RegExp            VARCHAR(300)
             );

			CREATE TABLE #DefaultAttributeCode
			(AttributeTypeName          VARCHAR(300),
			PimAttributeDefaultValueId INT,
			PimAttributeId             INT,
			AttributeDefaultValueCode  VARCHAR(100)
			);

			IF( @ImportHeadName = 'B2BCustomer' )
			BEGIN
				EXEC ZnodeB2BCustomerMapping @ImportHeadName = @ImportHeadName, @TableName = @TableName
			END
		
             DECLARE @GlobalTempTableColumns TABLE(ColumnName NVARCHAR);
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM INFORMATION_SCHEMA.TABLES
                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#InvalidDefaultData'
             )
                 CREATE TABLE #InvalidDefaultData
                 (RowNumber  INT,
                  Value      NVARCHAR(MAX),
                  ColumnName NVARCHAR(600)
                 );
             ELSE
             DROP TABLE #InvalidDefaultData;
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM INFORMATION_SCHEMA.TABLES
                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#GlobalTempTableColumns'
             )
                 BEGIN

                     SET @SQLQuery = 'SELECT Column_Name, '''+@ImportHeadName+''' AS ImportHeadName  from tempdb.INFORMATION_SCHEMA.COLUMNS	where table_name = object_name(object_id('''+@TableName+'''),
					(select database_id from sys.databases where name = ''tempdb''))';
                     CREATE TABLE #GlobalTempTableColumns
                     (ColumnName   NVARCHAR(MAX),
                      TypeOfImport NVARCHAR(100)
                     );
                     INSERT INTO #GlobalTempTableColumns
                     (ColumnName,
                      TypeOfImport
                     )
                     EXEC sys.sp_sqlexec
                          @SQLQuery;
                 END;

             IF EXISTS
             (
                 SELECT TOP 1 1
                 FROM #GlobalTempTableColumns
                 WHERE ColumnName IN('PimCategoryId', 'PimProductId', 'RowNumber')
             )
                 BEGIN
                     INSERT INTO ZnodeImportLog
                     (ErrorDescription,
                      ColumnName,
                      Data,
                      GUID,
                      CreatedBy,
                      CreatedDate,
                      ModifiedBy,
                      ModifiedDate,
                      ImportProcessLogId
                     )
                     VALUES
                     (43,
                      '',
                      '',
                      @newGUID,
                      @UserId,
                      @GetDate,
                      @UserId,
                      @GetDate,
                      @ImportProcessLogId
                     );
                 END;
             SET @DefaultLocaleId = dbo.Fn_GetDefaultLocaleId();

             IF NOT EXISTS
             (
                 SELECT TOP 1 1  FROM ZnodeImportLog
                 WHERE Guid = @NewGUID
                       AND ErrorDescription IN(43, 42)
                 AND ImportProcessLogId = @ImportProcessLogId
             )
                 BEGIN
                     IF @ImportHeadName = 'Product'
                      BEGIN
						  IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
							  SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimProductId int null ';
						  ELSE 
							 SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimProductId int null Primary KEY CLUSTERED(RowNumber)';
						 
						  EXEC sys.sp_sqlexec @SQLQuery;
			         END;
                     ELSE
                     IF @ImportHeadName = 'Category'
                         BEGIN
							  IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimCategoryId int null ';
							  ElSE
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimCategoryId int null Primary KEY CLUSTERED(RowNumber) ';
						  
							  EXEC sys.sp_sqlexec @SQLQuery;
                         END;
                     ELSE
                         BEGIN
							IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1) ';
							Else 
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1) Primary KEY CLUSTERED(RowNumber)';
							
							EXEC sys.sp_sqlexec @SQLQuery;
                         END;;
                 END;

             SET @CreateDateString = CONVERT(VARCHAR(100), @UserId)+','''+CONVERT(VARCHAR(100), @GetDate)+''','+CONVERT(VARCHAR(100), @UserId)+','''+CONVERT(VARCHAR(100), @GetDate)+''', '+CONVERT(VARCHAR(100), @ImportProcessLogId);

             SELECT TOP 1 @ImportHeadId = ImportHeadId FROM ZnodeImportTemplate WHERE ImportTemplateId = @TemplateId;
             IF @DefaultFamilyId = 0
                AND @ImportHeadName IN('Product', 'Category')
                 BEGIN 
                     --Get all default attribute values in attribute 
                     INSERT INTO @FamilyAttributeDetail
                     (PimAttributeId,
                      AttributeTypeName,
                      AttributeCode,
                      SourceColumnName,
                      IsRequired,
                      PimAttributeFamilyId
                     )
                     --Call Process to insert data of defeult family with source column name and target column name 
                     EXEC Znode_ImportGetTemplateDetails
                          @TemplateId = @TemplateId,
                          @IsValidationRules = 0,
                          @IsIncludeRespectiveFamily = 1,
                          @IsCategory = @IsCategory,
                          @DefaultFamilyId = @DefaultFamilyId;

					---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;
             ELSE
             IF @ImportHeadName IN('Product', 'Category')
                 BEGIN
				 
                     --Get all default attribute values in attribute 
                     INSERT INTO @FamilyAttributeDetail
                     (PimAttributeId,
                      AttributeTypeName,
                      AttributeCode,
                      SourceColumnName,
                      IsRequired,
                      PimAttributeFamilyId
                     )
                     --Call Process to insert data of defeult family with source column name and target column name 
                     EXEC Znode_ImportGetTemplateDetails
                          @TemplateId = @TemplateId,
                          @IsValidationRules = 0,
                          @IsIncludeRespectiveFamily = 1,
                          @IsCategory = @IsCategory,
                          @DefaultFamilyId = @DefaultFamilyId;

					---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;      
             -- Check attributes are manditory and not provided with source table
		   	 
			if @TABLENAME	like '%tempdb..%'
				SET @SQLQuery = 'SELECT 42 AS ErrorDescription , SourceColumnName , '''' , '''+@NewGUID+''','+@CreateDateString+' from ZnodeImportTemplateMapping where ImportTemplateId = '+CONVERT(VARCHAR(100), @TemplateId)+' and ltrim(rtrim(SourceColumnName)) <> '''' AND ltrim(rtrim(SourceColumnName)) not in ( select isnull(Name ,'''') from tempdb.sys.columns where object_id = object_id('''+@TABLENAME+'''));';
			else 
				SET @SQLQuery = 'SELECT 42 AS ErrorDescription , SourceColumnName , '''' , '''+@NewGUID+''','+@CreateDateString+' from ZnodeImportTemplateMapping where ImportTemplateId = '+CONVERT(VARCHAR(100), @TemplateId)+' and ltrim(rtrim(SourceColumnName)) <> '''' AND ltrim(rtrim(SourceColumnName)) not in ( select isnull(Name ,'''') from sys.columns where object_id = object_id('''+@TABLENAME+'''));';
		 
			Declare @Tbl_CsvDynamicColulmns TABLE (ColumnName nvarchar(300), SequenceNumber int, DataType nvarchar(50),IsRequired bit )

			INSERT INTO @Tbl_CsvDynamicColulmns(ColumnName , SequenceNumber , DataType ,IsRequired)
			SELECT DISTINCT ZITM.SourceColumnName ,ZIAV.SequenceNumber, ZIAV.AttributeTypeName, ZIAV.IsRequired
			FROM ZnodeImportAttributeValidation ZIAV LEFT OUTER JOIN 
			ZnodeImportTemplate  ZIT ON ZIT.ImportHeadId =  ZIAV.ImportHeadId AND ZIT.ImportTemplateId  = @TemplateId
			LEFT OUTER JOIN ZnodeImportTemplateMapping  ZITM ON ZITM.ImportTemplateId = ZIT.ImportTemplateId  
			and ZIAV.AttributeCode = ZITM.TargetColumnName
			AND ZITM.ImportTemplateId  = @TemplateId
			WHERE ZIAV.ImportHeadId = @ImportHeadId
			AND ISNULL(ZITM.SourceColumnName,'') <> ''--ORDER BY ZIAV.SequenceNumber


		    SELECT @CsvColumnString = SUBSTRING ((Select ',' +  ISNULL(ColumnName ,'NULL') from @Tbl_CsvDynamicColulmns ORDER BY SequenceNumber FOR XML PATH ('')),2,4000) 


     		INSERT INTO ZnodeImportLog(ErrorDescription, ColumnName, Data, GUID,CreatedBy, CreatedDate,  ModifiedBy,ModifiedDate,ImportProcessLogId
             )
             EXEC sys.sp_sqlexec  @SQLQuery;
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM ZnodeImportLog
                 WHERE Guid = @NewGUID
                       AND ErrorDescription IN(43, 42)
                 AND ImportProcessLogId = @ImportProcessLogId
             )
                 BEGIN
                     --Get all default attribute values in attribute 
                     IF @ImportHeadName IN('Product', 'Category')
                         BEGIN
                             -- Check attributes are manditory and not provided with source table
                             INSERT INTO ZnodeImportLog
                             (ErrorDescription,
                              ColumnName,
                              Data,
                              GUID,
                              CreatedBy,
                              CreatedDate,
                              ModifiedBy,
                              ModifiedDate,
                              ImportProcessLogId
                             )
                                    SELECT '14' AS ErrorDescription,
                                           AttributeCode,
                                           '',
                                           @NewGUID,
                                           @UserId,
                                           @GetDate,
                                           @UserId,
                                           @GetDate,
                                           @ImportProcessLogId
                                    FROM @FamilyAttributeDetail
                                    WHERE ISNULL(SourceColumnName, '') = ''
                                          AND IsRequired = 1;  

                             -- Read all attribute details with their datatype
                             INSERT INTO @AttributeDetail
                             (PimAttributeId,
                              AttributeTypeName,
                              AttributeCode,
                              SourceColumnName,
                              IsRequired,
                              ControlName,
                              ValidationName,
                              SubValidationName,
                              ValidationValue,
                              RegExp
                             )
                             EXEC Znode_ImportGetTemplateDetails
                                  @TemplateId=@TemplateId,
								  @DefaultFamilyId=@DefaultFamilyId;

							---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
							Delete FAD from @AttributeDetail FAD
							where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
							and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
										   inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode) 

                             DELETE FROM @AttributeDetail
                             WHERE AttributeTypeName = 'Image'
                                   AND ValidationName <> 'IsAllowMultiUpload';
							DELETE FROM @AttributeDetail
                             WHERE AttributeTypeName = 'File'
                                   AND ValidationName <> 'IsAllowMultiUpload';

                                     INSERT INTO #DefaultAttributeCode
                                     (AttributeTypeName,
                                      PimAttributeDefaultValueId,
                                      PimAttributeId,
                                      AttributeDefaultValueCode
                                     )
                                     --Call Process to insert default data value 
                                     EXEC Znode_ImportGetPimAttributeDefaultValue;

                                     DELETE FROM #DefaultAttributeCode
                                     WHERE AttributeTypeName = 'Yes/No';

                         END;
                     ELSE
                         BEGIN
					
					
                             --Read all attribute details with their datatype
                             INSERT INTO @AttributeDetail
                             (AttributeTypeName,
                              AttributeCode,
                              SourceColumnName,
                              IsRequired,
                              ControlName,
                              ValidationName,
                              SubValidationName,
                              ValidationValue,
                              RegExp
                             )
                             EXEC [Znode_ImportGetOtherTemplateDetails]
                                  @TemplateId = @TemplateId,
                                  @ImportHeadId = @ImportHeadId;

							IF @ImportHeadName IN('B2BCustomer')
							BEGIN

								INSERT INTO @AttributeDetail
								 (PimAttributeId,
								 AttributeTypeName,
								  AttributeCode,
								  SourceColumnName,
								  IsRequired,
								  ControlName,
								  ValidationName,
								  SubValidationName,
								  ValidationValue,
								  RegExp
								 )
								 EXEC [Znode_ImportGetGlobalTemplateDetails]
									  @TemplateId = @TemplateId,
									  @ImportHeadId = @ImportHeadId;

								
								INSERT INTO #DefaultAttributeCode
								(AttributeTypeName,
								PimAttributeDefaultValueId,
								PimAttributeId,
								AttributeDefaultValueCode
								)
								--Call Process to insert default data value 
								EXEC Znode_ImportGetGlobalAttributeDefaultValue;

								DELETE FROM #DefaultAttributeCode
								WHERE AttributeTypeName = 'Yes/No';

							END
						
                             --Check attributes are not mapped with any family of Pim Product
                             INSERT INTO ZnodeImportLog
                             (ErrorDescription,
                              ColumnName,
                              Data,
                              GUID,
                              CreatedBy,
                              CreatedDate,
                              ModifiedBy,
                              ModifiedDate,
                              ImportProcessLogId
                             )
                                    SELECT DISTINCT
                                           '14' AS ErrorDescription,
                                           AttributeCode,
                                           '',
                                           @NewGUID,
                                           @UserId,
                                           @GetDate,
                                           @UserId,
                                           @GetDate,
                                           @ImportProcessLogId
                                    FROM @AttributeDetail
                                    WHERE ISNULL(SourceColumnName, '') = ''   AND IsRequired = 1;  ;

                         END;
						
                     --	Check attributes are not mapped with (Default / Other) family of Pim Product
                     --	INSERT INTO ZnodeImportLog ( ErrorDescription , ColumnName , Data , GUID , CreatedBy , CreatedDate , ModifiedBy , ModifiedDate , ImportProcessLogId)
                     --	SELECT '1' AS ErrorDescription , SourceColumnName , '' , @NewGUID , @UserId , @GetDate , @UserId , @GetDate , @ImportProcessLogId
                     --	FROM @AttributeDetail WHERE PimAttributeId NOT IN ( SELECT zpfgm.PimAttributeId FROM dbo.ZnodePimFamilyGroupMapper AS zpfgm);
                     --	Verify data in global temporary table (column wise)
					
                     DECLARE Cr_Attribute CURSOR LOCAL FAST_FORWARD
                     FOR SELECT PimAttributeId,
                                AttributeTypeName,
                                AttributeCode,
                                IsRequired,
                                SourceColumnName,
                                ControlName,
                                ValidationName,
                                SubValidationName,
                                ValidationValue,
                                RegExp
                         FROM @AttributeDetail
                         WHERE ISNULL(SourceColumnName, '') <> '';
                     OPEN Cr_Attribute;
                     FETCH NEXT FROM Cr_Attribute INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @ControlName, @ValidationName, @SubValidationName, @ValidationValue, @RegExp;
                     WHILE @@FETCH_STATUS = 0
                         BEGIN
				             IF @AttributeTypeName = 'Number'
                                 BEGIN
							      EXEC Znode_ImportValidateNumber
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @ImportHeadId = @ImportHeadId,
                                          @ImportProcessLogId = @ImportProcessLogId;
                                 END;
							 -- Check invalid date
							
                             IF @AttributeTypeName = 'Date'
                                 BEGIN
                                     EXEC Znode_ImportValidateDate
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @ImportHeadId = @ImportHeadId,
                                          @ImportProcessLogId = @ImportProcessLogId;
                                 END;
							 -- Check Manditory Data
		 					 IF @IsRequired = 1 AND @CheckedSourceColumn <> @SourceColumnName
								BEGIN
									SET @CheckedSourceColumn = @SourceColumnName;
									EXEC Znode_ImportValidateManditoryData
									@TableName = @TableName,
									@SourceColumnName = @SourceColumnName,
									@CreateDateString = @CreateDateString,
									@ValidationName = @ValidationName,
									@ControlName = @ControlName,
									@ValidationValue = @ValidationValue,
									@NewGUID = @NewGUID,
									@ImportHeadId = @ImportHeadId;
								END;
							 --END 
							
                             IF @AttributeTypeName = 'Text'
                                 BEGIN
								 
						              EXEC Znode_ImportValidateManditoryText
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @LocaleId = @LocaleId,
                                          @DefaultLocaleId = @DefaultLocaleId,
                                          @AttributeId = @AttributeId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @ImportHeadId = @ImportHeadId;
                                 END;
                             IF @AttributeTypeName in ( 'Image','File')
                                 BEGIN
                                     EXEC Znode_ImportValidateImageData
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @LocaleId = @LocaleId,
                                          @DefaultLocaleId = @DefaultLocaleId,
                                          @AttributeId = @AttributeId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @ImportHeadId = @ImportHeadId;
                                 END;

					

                             --Check Default data value is valid 
                             IF @ImportHeadName IN('Product', 'Category','B2BCustomer')
                                 BEGIN
                                     IF @AttributeId IN
                                     (
                                         SELECT PimAttributeId
                                         FROM #DefaultAttributeCode
                                     )
                                         BEGIN
							
                                            IF  @AttributeTypeName = 'Multi Select'
											 BEGIN
										 		 ---Verify Image file is exists in media table or not 
												 SET @SQLQuery = ' INSERT INTO #InvalidDefaultData (RowNumber, Value, ColumnName) 
												 SELECT ROWNUMBER , (Select TOP 1 Item from dbo.split(' + @SourceColumnName + ','','')  SP WHERE NOT EXISTS 
												 (Select ToP 1 1 FROM #DefaultAttributeCode DAC WHERE 
												  DAC.AttributeTypeName <> ''Yes/No'' AND DAC.AttributeDefaultValueCode IS NOT NULL AND DAC.PimAttributeId = 
												 ' + CONVERT(VARCHAR(100), @AttributeId) + ' AND ltrim(rtrim(SP.Item) ) = DAC.AttributeDefaultValueCode
												 )), ''' + @SourceColumnName + ''' as [ColumnName]  FROM ' + @TableName
												 + ' Where ISnull(' + @SourceColumnName +  ','''') <> '''''
												EXEC sys.sp_sqlexec @SQLQuery;
											  END
											  ELSE IF @AttributeTypeName = 'Simple Select'
											  BEGIN
						
												---Verify Image file is exists in media table or not 
												 SET @SQLQuery = ' INSERT INTO #InvalidDefaultData (RowNumber, Value, ColumnName) 
												 SELECT ROWNUMBER , ' + @SourceColumnName + ' , ''' + @SourceColumnName + ''' as [ColumnName]  FROM ' + @TableName
												 + ' SP Where ISnull(' + @SourceColumnName +  ','''') <> '''' AND 
												  NOT EXISTS 
												 (Select TOP 1 1 FROM #DefaultAttributeCode DAC WHERE 
												  DAC.AttributeTypeName <> ''Yes/No'' AND DAC.AttributeDefaultValueCode IS NOT NULL AND DAC.PimAttributeId = 
												 ' + CONVERT(VARCHAR(100), @AttributeId) + ' AND ltrim(rtrim(SP.' + @SourceColumnName + ') ) = DAC.AttributeDefaultValueCode ) '
							
												EXEC sys.sp_sqlexec @SQLQuery;
											  END   
												-- Check Invalid Image 
												 SET @SQLQuery = 'SELECT ''9 '' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], 
												 Value AS  AttributeValue,RowNumber ,'''+@NewGUID+''',  '+@CreateDateString+' FROM #InvalidDefaultData Where Value IS NOT NULL'
												 INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, RowNumber, GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
												 EXEC sys.sp_sqlexec @SQLQuery;
												 Delete from #InvalidDefaultData

       
                                         END;
                                 END;
							
                             FETCH NEXT FROM Cr_Attribute INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @ControlName, @ValidationName, @SubValidationName, @ValidationValue, @RegExp;
                         END;
                     CLOSE Cr_Attribute;
                     DEALLOCATE Cr_Attribute;
                     --SELECT top 1 1 FROM @FamilyAttributeDetail where  iSNULL(SourceColumnName,'') = ''  and IsRequired = 1
                 END;
             
			 
			  
------------------------------------------------------------------------------------------
		 Declare @SQLQueryNew NVARCHAR(4000)
		 Declare @SourceColumnNameProduct nvarchar(4000) 
         IF @ImportHeadName IN('Product','Pricing','ProductAssociation','Inventory')
		 BEGIN
		 	 
		 SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'SKU'
		 AND ImportTemplateId = @TemplateId


			SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  SKU - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;			
		END
		ELSE IF @ImportHeadName IN('ProductAttribute')
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'AttributeCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  Attribute - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'ZipCode'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'ZIP'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  ZIPCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'Category'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'CategoryCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  CategoryCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'CategoryAssociation'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'CategoryName'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  CategoryName - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;

		END
		ELSE IF @ImportHeadName IN ('Customer','CustomerAddress')
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'UserName'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  UserName - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'SEODetails'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'Code'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  Code - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'Highlight'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'HighlightCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  HighlightCode - '' + ' + ' cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'AddonAssociation'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'SKU'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  SKU - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'AttributeDefaultValue'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'AttributeDefaultValueCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  AttributeDefaultValueCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
        ELSE IF @ImportHeadName = 'Brands'  
        BEGIN  
        SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'BrandCode'  
        AND ImportTemplateId = @TemplateId  
  
            SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  BrandCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''   
            FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber   
            WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';  
            PRINT @SQLQueryNew  
           EXEC sys.sp_sqlexec  @SQLQueryNew;  
        END  
	-------------------------------------------------------------------------------------------------------------
	
	--------------------------------------------------------------------------------------------------------------------
			 
  		SET @SQLQuery = 'Delete FROM  '+@TableName+' Where Rownumber IN (Select Rownumber FROM ZnodeImportLog  WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND Rownumber IS NOT NULL)';
        EXEC sys.sp_sqlexec  @SQLQuery;
			 			
   
             IF @ImportHeadName IN('Product', 'Category')
                 BEGIN
                     IF NOT EXISTS
                     (
                         SELECT TOP 1 1
                         FROM @FamilyAttributeDetail
                         WHERE ISNULL(SourceColumnName, '') = ''
                               AND IsRequired = 1
                     ) AND NOT EXISTS
					 (
						 SELECT TOP 1 1
						 FROM ZnodeImportLog
						 WHERE Guid = @NewGUID
							   AND ErrorDescription IN(43, 42)
						 AND ImportProcessLogId = @ImportProcessLogId
					 )
                         BEGIN
                             IF @IsCategory = 0
                                 BEGIN

                                     EXEC Znode_ImportPimProductData
                                          @TableName = @TableName,
                                          @NewGUID = @NewGUID,
                                          @TemplateId = @TemplateId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @UserId = @UserId,
                                          @LocaleId = @LocaleId,
                                          @DefaultFamilyId = @DefaultFamilyId;

                                 END;
                             ELSE
                                 BEGIN
                                     EXEC Znode_ImportPimCategoryData
                                          @TableName = @TableName,
                                          @NewGUID = @NewGUID,
                                          @TemplateId = @TemplateId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @UserId = @UserId,
                                          @LocaleId = @LocaleId,
                                          @DefaultFamilyId = @DefaultFamilyId;
                                 END;
                         END
						 ELSE
							BEGIN
								-- Update Record count in log 
								
							
								--SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
								--EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount out
								--UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
								--WHERE ImportProcessLogId = @ImportProcessLogId;

								SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
								SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
								EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount out
								UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
								WHERE ImportProcessLogId = @ImportProcessLogId;
							END

                 END;
				IF NOT EXISTS
					 (
						 SELECT TOP 1 1
						 FROM ZnodeImportLog
						 WHERE Guid = @NewGUID
							   AND ErrorDescription IN(43, 42)
						 AND ImportProcessLogId = @ImportProcessLogId
					 )
             BEGIN
                 IF @ImportHeadName = 'Pricing'
                     BEGIN
                         EXEC [Znode_ImportPriceList]
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
                              @PriceListId = @PriceListId;
                     END;

                 IF @ImportHeadName = 'Inventory'
                     BEGIN
				
                         EXEC Znode_ImportInventory_Ver1
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID;
                     END;
                 IF @ImportHeadName = 'ZipCode'
                     BEGIN
						 EXEC Znode_ImportZipCode
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
							  @CountryCode = @CountryCode;
                     END;
					 IF @ImportHeadName = 'CategoryAssociation'
                     BEGIN
						 EXEC Znode_ImportCatalogCategory
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
							  @PimCatalogId = @PimCatalogId;
                     END;
					 IF @ImportHeadName = 'ProductAssociation'
                     BEGIN
						 EXEC Znode_ImportAssociateProducts
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID
                     END;
			
					 IF @ImportHeadName = 'SEODetails' AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportSEODetails
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
							  @LocaleId = @LocaleId,
							  @PortalId =@PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
							  @CsvColumnString = @CsvColumnString 

				
                     END;
				
					 IF @ImportHeadName = 'ProductAttribute' 
                     BEGIN
						 EXEC Znode_ImportAttributes
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
							  @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID
				
                     END;

					 IF @ImportHeadName = 'Customer' AND @PortalId > 0 
                     BEGIN
					
						 EXEC Znode_ImportCustomer
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = @PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
				
                     END;
					 
					 IF @ImportHeadName = 'UserApprovers' AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportUserApproval
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = @PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
				
                     END;

					 IF @ImportHeadName = 'B2BCustomer' AND @PortalId > 0 
                     BEGIN

							 EXEC Znode_ImportB2BCustomer
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = @PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
				
                     END;

					 IF @ImportHeadName = 'CustomerAddress' --AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportCustomerAddress
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  --@PortalId  = 7, -- not implemented from forntend 
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString,
							  @IsAccountAddress = @IsAccountAddress
				
                     END;
					 IF @ImportHeadName = 'ShippingAddress' --AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportCustomerAddress
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  --@PortalId  = 7, -- not implemented from forntend 
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString,
							  @IsAccountAddress = @IsAccountAddress
				
                     END;
					 IF @ImportHeadName = 'StoreLocator' --AND @PortalId > 0 
                     BEGIN
					 	 EXEC Znode_ImportStoreLocatorAddress
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
                     END;

					IF @ImportHeadName = 'Highlight'
					BEGIN
					EXEC Znode_ImportHighlight 
					@TableName = @TableName, 
					@Status = @Status, 
					@UserId = @UserId, 
					@ImportProcessLogId = @ImportProcessLogId, 
					@NewGUID = @NewGUID 
					END;

					IF @ImportHeadName = 'AddonAssociation'
					BEGIN
					EXEC Znode_ImportAddonAssociation 
					@TableName = @TableName, 
					@Status = @Status, 
					@UserId = @UserId, 
					@ImportProcessLogId = @ImportProcessLogId, 
					@NewGUID = @NewGUID,
					@PimCatalogId = @PimCatalogId
					END;

					IF @ImportHeadName = 'AttributeDefaultValue'
					BEGIN
					EXEC Znode_ImportAttributeDefaultValue 
					@TableName = @TableName, 
					@Status = @Status, 
					@UserId = @UserId, 
					@ImportProcessLogId = @ImportProcessLogId, 
					@NewGUID = @NewGUID
					
					END;

					IF @ImportHeadName = 'Voucher'
					BEGIN
						EXEC Znode_ImportVoucher 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID
					
					END;

					IF @ImportHeadName = 'Account'
					BEGIN
						
						EXEC Znode_ImportAccount 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID,
						@CsvColumnString = @CsvColumnString,
						@PortalId = @PortalId
					
					END;

					IF @ImportHeadName = 'Synonyms'
					BEGIN
						EXEC Znode_ImportSynonyms 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID
					END

					IF @ImportHeadName = 'CatalogCategoryAssociation'
					BEGIN
						EXEC Znode_ImportCatalogCategoryHierarchyAssociation 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID,
						@PimCatalogId = @PimCatalogId
					END
				 

                    IF @ImportHeadName = 'Brands'
					BEGIN
						EXEC Znode_ImportBrands 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID,
						@LocaleId	 = @LocaleId,
                        @CsvColumnString = @CsvColumnString
					END;
				 
             END
			 ELSE 
				 BEGIN
					-- Update Record count in log 	
					SET @SQLQuery = ' Select @FailedRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
					EXEC	sp_executesql @SQLQuery , N'@FailedRecordCount BIGINT out' , @FailedRecordCount =@FailedRecordCount out
					SELECT @SuccessRecordCount = 0
									
					UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
					WHERE ImportProcessLogId = @ImportProcessLogId;

				 END

             EXEC Znode_ImportReadErrorLog
                  @ImportProcessLogId = @ImportProcessLogId,
                  @NewGUID = @NewGUID;
             DROP TABLE #GlobalTempTableColumns;

             -- Finally call product insert process if error not found in error log table 
             IF EXISTS
             (
                 SELECT TOP 1 1
                 FROM ZnodeImportLog
                 WHERE ImportProcessLogId = @ImportProcessLogId
                       AND Guid = @NewGUID
             )
                 BEGIN
                    --Updating the import process status
					UPDATE ZnodeImportProcessLog
					SET Status = CASE WHEN ISNULL(FailedRecordcount,0) > 0 AND ISNULL(SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
										WHEN ISNULL(FailedRecordcount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
										WHEN ISNULL(FailedRecordcount,0) > 0 AND ISNULL(FailedRecordcount,0) = ISNULL(TotalProcessedRecords,0) THEN dbo.Fn_GetImportStatus( 3 )
									END, 
						ProcessCompletedDate = getdate()
					WHERE ImportProcessLogId = @ImportProcessLogId;
                 END;
				 SET @SQLQuery = 'IF Object_id(''+@TableName+'') IS NOT NULL  DROP TABLE ' + @TableName
                 EXEC sys.sp_sqlexec @SQLQuery;

				 print 'end';
         END TRY
         BEGIN CATCH
			DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE()
			DECLARE @TempCount TABLE (Id INT)

			Declare @SQL Varchar(max) = 'Select Count(*) As Id From '+@TableName
			INSERT INTO @TempCount
			EXEC (@SQL)

             SELECT ERROR_MESSAGE(),
                    ERROR_LINE(),
                    ERROR_PROCEDURE();
             EXEC Znode_ImportReadErrorLog
                  @ImportProcessLogId = @ImportProcessLogId,
                  @NewGUID = @NewGUID; 
             
			 ---Import process updating fail due to database error
			UPDATE ZnodeImportProcessLog
			SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
			WHERE ImportProcessLogId = @ImportProcessLogId;

			---Loging error for Import process due to database error
		    INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		    SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

			--Updating total and fail record count
		    UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		    TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		    WHERE ImportProcessLogId = @ImportProcessLogId;

			SET @SQLQuery = 'Drop Table ' + @TableName
            EXEC sys.sp_sqlexec @SQLQuery;
             --ROLLBACK TRAN TRN_ImportValidProductData;
         END CATCH;
     END;

GO

INSERT INTO ZnodeMessage (MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 134,'Other','Input must be available as a Username saved against any existing User who belongs to the same Store as that of the Country.',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeMessage WHERE MessageCode = 134);

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPaymentSettingByUserDetails')
	DROP PROC Znode_GetPaymentSettingByUserDetails
GO

CREATE PROCEDURE [dbo].[Znode_GetPaymentSettingByUserDetails]
(
	@PortalId	INT,
	@UserId		INT,
	@RowsCount  INT OUT
)
AS
/*
	Summary: This Procedure is used to get payment details according to associated profile or portal.

	Unit Testing:

	EXEC [Znode_GetPaymentSettingByUserDetails] @PortalId=1, @UserId=1, @RowsCount=0
*/	
BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
		DECLARE @GuestProfileId INT;

		SELECT TOP 1 @GuestProfileId=ProfileId FROM ZnodeProfile WHERE ProfileName = 'Anonymous' AND @UserId = -1;

		IF OBJECT_ID('tempdb..#ZnodePortalPaymentApprovers') IS NOT NULL
			DROP TABLE #ZnodePortalPaymentApprovers
		--Getting the payment portal approver details
		SELECT PaymentSettingId ,ZPPG.PortalPaymentGroupId,ZPA.PortalId 
		INTO #ZnodePortalPaymentApprovers
		FROM ZnodePortalPaymentApprovers ZPPA 
		INNER JOIN [ZnodePortalPaymentGroup] ZPPG ON( ZPPA.PortalPaymentGroupId = ZPPG.PortalPaymentGroupId)
		INNER JOIN [ZnodePortalApproval] ZPA ON (ZPA.PortalApprovalId = ZPPG.PortalApprovalId) 
		WHERE ZPA.EnableApprovalManagement =1 AND ZPA.PortalId = @PortalId AND ZPPG.isActive = 1;
	
		--When any User Profile is associated with the user account
		--OR When User is associated with single Profile.
		--OR When two or more User Profiles are associated with the user account
		IF (EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP 
					INNER JOIN ZnodePortalProfile ZPP ON ZUP.ProfileId=ZPP.ProfileId
					INNER JOIN ZnodeProfilePaymentSetting ZPS ON ZUP.ProfileId=ZPS.ProfileId
					INNER JOIN ZnodePortalPaymentSetting ZPS1 ON ZPP.PortalId=ZPS1.PortalId AND ZPS.PaymentSettingId=ZPS1.PaymentSettingId
					WHERE ZUP.UserId=@UserId AND ZPP.PortalId=@PortalId)

			OR EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP 
					INNER JOIN ZnodePortalProfile ZPP ON ZUP.ProfileId=ZPP.ProfileId
					INNER JOIN ZnodeProfilePaymentSetting ZPS ON ZUP.ProfileId=ZPS.ProfileId
					INNER JOIN ZnodePortalPaymentSetting ZPS1 ON ZPP.PortalId=ZPS1.PortalId AND ZPS.PaymentSettingId=ZPS1.PaymentSettingId
					WHERE ZUP.ProfileId=@GuestProfileId AND ZPP.PortalId=@PortalId)
			)
		BEGIN
			IF EXISTS (	SELECT TOP 1 1 
						FROM ZnodePaymentSetting ZPS
						INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
						LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
						INNER JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId )
						INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
						INNER JOIN ZnodeProfile ZP ON ZP.ProfileId = YOPU.ProfileId
						INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
						WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1 AND
							(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId AND YOPU.ProfileId = ZUP.ProfileId)
							OR EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE @UserId = -1 AND ZUP.ProfileId = @GuestProfileId)))
			BEGIN
				SELECT DISTINCT ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,
					ZPS.IsActive,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,
					ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate,ZPPS.PortalId,ZP1.StoreName, 
					NULL IsAssociated ,NULL As ProfileId,NULL As ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName,
						CASE WHEN @PortalId > 0 AND ZPPS.PaymentDisplayName IS NOT NULL
							THEN ZPPS.PaymentDisplayName ELSE ZPS.PaymentDisplayName END PaymentDisplayName, 
					NULL PaymentExternalId, CAST(CASE WHEN YU.PaymentSettingId IS NOT NULL THEN 1 ELSE 0 END As BIT) AS IsApprovalRequired,
					ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,
					YU.PortalPaymentGroupId,'' AS PublishState
				FROM ZnodePaymentSetting ZPS
				INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				INNER JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId )
				INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
				INNER JOIN ZnodeProfile ZP ON ZP.ProfileId = YOPU.ProfileId
				INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
				LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId) 
				WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1 AND
					(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId AND YOPU.ProfileId = ZUP.ProfileId)
					OR EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE @UserId = -1 AND ZUP.ProfileId = @GuestProfileId));

				SET @RowsCount=@@ROWCOUNT;
			END
			ELSE
			BEGIN
				SELECT DISTINCT ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,
					ZPS.IsActive,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,
					ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate,ZPPS.PortalId,ZP1.StoreName, 
					NULL IsAssociated ,NULL As ProfileId,NULL As ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName,
						CASE WHEN @PortalId > 0 AND ZPPS.PaymentDisplayName IS NOT NULL
							THEN ZPPS.PaymentDisplayName ELSE ZPS.PaymentDisplayName END PaymentDisplayName, 
					NULL PaymentExternalId, CAST(CASE WHEN YU.PaymentSettingId IS NOT NULL THEN 1 ELSE 0 END As BIT) AS IsApprovalRequired,
					ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,
					YU.PortalPaymentGroupId,'' AS PublishState
				FROM ZnodePaymentSetting ZPS
				INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				LEFT JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId )
				INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
				LEFT JOIN ZnodeProfile ZP ON ZP.ProfileId = YOPU.ProfileId
				INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
				LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
				WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1 AND
					(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId)
					OR EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE @UserId = -1 AND ZUP.ProfileId = @GuestProfileId));

				SET @RowsCount=@@ROWCOUNT;
			END
		END
		--When User is associated with Profile but this Profile is not associated with any portal.
		ELSE IF EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE ((ZUP.UserId = @UserId AND ZUP.ProfileId IS NOT NULL) OR (@UserId = -1 AND ZUP.ProfileId = @GuestProfileId))
							AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalProfile WHERE ProfileId=ZUP.ProfileId AND PortalId=@PortalId))
		BEGIN
			SELECT DISTINCT ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,
				ZPS.IsActive,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,
				ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate,ZPPS.PortalId,ZP1.StoreName, 
				NULL IsAssociated, NULL As ProfileId,NULL As ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName,
					CASE WHEN @PortalId > 0 AND ZPPS.PaymentDisplayName IS NOT NULL
						THEN ZPPS.PaymentDisplayName ELSE ZPS.PaymentDisplayName END PaymentDisplayName, 
				NULL PaymentExternalId, CAST(CASE WHEN YU.PaymentSettingId IS NOT NULL THEN 1 ELSE 0 END As BIT) AS IsApprovalRequired,
				ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,
				YU.PortalPaymentGroupId,'' AS PublishState
			FROM ZnodePaymentSetting ZPS
			INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
			LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
			LEFT JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId )
			INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
			LEFT JOIN ZnodeProfile ZP ON ZP.ProfileId = YOPU.ProfileId
			INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
			LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId) 
			WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1 AND
				(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId)
				OR EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE @UserId = -1 AND ZUP.ProfileId = @GuestProfileId));

			SET @RowsCount=@@ROWCOUNT;
		END
		--When User is not associated with any Profile.
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE (ZUP.UserId = @UserId OR (@UserId = -1 AND ZUP.ProfileId = @GuestProfileId)))
		BEGIN
			SELECT DISTINCT ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,
				ZPS.IsActive,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,
				ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate,ZPPS.PortalId,ZP1.StoreName, 
				NULL IsAssociated ,NULL ProfileId, NULL As ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName,
					CASE WHEN @PortalId > 0 AND ZPPS.PaymentDisplayName IS NOT NULL
						THEN ZPPS.PaymentDisplayName ELSE ZPS.PaymentDisplayName END PaymentDisplayName, 
				NULL PaymentExternalId, CAST(CASE WHEN YU.PaymentSettingId IS NOT NULL THEN 1 ELSE 0 END As BIT) AS IsApprovalRequired,
				ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,
				YU.PortalPaymentGroupId,'' AS PublishState
			FROM ZnodePaymentSetting ZPS
			INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
			LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
			LEFT JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId )
			INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
			LEFT JOIN ZnodeProfile ZP ON ZP.ProfileId = YOPU.ProfileId
			INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
			LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId) 
			WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1;

			SET @RowsCount=@@ROWCOUNT;
		END

		ELSE
		BEGIN
			SELECT DISTINCT ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,
				ZPS.IsActive,ZPS.DisplayOrder AS DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,
				ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate,ZPPS.PortalId,ZP1.StoreName, NULL IsAssociated ,NULL AS ProfileId,
				NULL AS ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName,
				CASE WHEN @PortalId > 0 AND ZPPS.PaymentDisplayName IS NOT NULL
					THEN ZPPS.PaymentDisplayName ELSE ZPS.PaymentDisplayName END PaymentDisplayName, 
				NULL PaymentExternalId, CAST(CASE WHEN YU.PaymentSettingId IS NOT NULL THEN 1 ELSE 0 END As BIT) AS IsApprovalRequired,
				ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,
				YU.PortalPaymentGroupId,'' AS PublishState
			FROM ZnodePaymentSetting ZPS
			INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
			LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
			INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
			INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
			LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
			WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1;

			SET @RowsCount=@@ROWCOUNT;
		END
	END TRY
	BEGIN CATCH
		DECLARE @Status BIT;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(),
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPaymentSettingByUserDetails @PortalId='+CAST(@PortalId AS VARCHAR(50))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50));

		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_GetPaymentSettingByUserDetails',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetImportProcessLog')
	DROP PROC Znode_GetImportProcessLog
GO

CREATE PROCEDURE [dbo].[Znode_GetImportProcessLog]
( @WhereClause VARCHAR(max),
  @Rows        INT           = 100,
  @PageNo      INT           = 1,
  @Order_BY    VARCHAR(1000)  = '',
  @RowsCount   INT OUT)
AS
  /*
    Summary : Get import process log details include rowwise errors in details.    	
	Unit Testing   
	begin tran 
	DECLARE @RowsCount INT;
    EXEC Znode_GetImportProcessLog @WhereClause = 'ImportProcessLogId = 1151',@Rows = 1000,@PageNo = 0,@Order_BY = '',@RowsCount = @RowsCount OUT;
	rollback tran
    SELECT @RowsCount;
    
  */
     BEGIN
         SET NOCOUNT ON;
         BEGIN TRY
             DECLARE @SQL NVARCHAR(MAX);
             DECLARE @TBL_ImportLog TABLE(ImportLogId INT,ImportProcessLogId INT,RowNumber BIgInt,ColumnName NVARCHAR(1000),ColumnValue NVARCHAR(max),ErrorDescription NVARCHAR(max)
										,RowId INt , CountNo Int )  ;
             SET @SQL = ' 
							;with Cte_ErrorLog AS 
							(
								SELECT zil.ImportLogId, zil.ImportProcessLogId, ISNULL(zil.RowNumber, 0) [RowNumber], ISNULL(zil.ColumnName, '''') [ColumnName],
								ISNULL(zil.Data, '''') [ColumnValue], zm.MessageName + 
								CASE 
								WHEN zm.MessageCode IN (17)	AND Name in (''Pricing'') AND ISNULL(zil.ColumnName, '''') NOT like ''%Quantity%'' THEN +''  ''+ dbo.Fn_GetDefaultPriceRoundOff(isnull(DefaultErrorValue,''0000000.00'') - 1)
								WHEN zm.MessageCode IN (17)	AND Name in (''Pricing'') AND ISNULL(zil.ColumnName, '''') like ''%Quantity%''  THEN +''  ''+ dbo.Fn_GetDefaultInventoryRoundOff(isnull(DefaultErrorValue,''0000000.00'') -1) 
								WHEN zm.MessageCode IN (17)	AND Name in (''Inventory'')  THEN +''  ''+ dbo.Fn_GetDefaultInventoryRoundOff(isnull(DefaultErrorValue,''0000000.00'') - 1) 
								WHEN zm.MessageCode IN (41) AND Name in (''Pricing'') AND ISNULL(zil.ColumnName, '''') NOT like ''%Quantity%'' THEN +''  ''+ dbo.Fn_GetDefaultPriceRoundOff(isnull(DefaultErrorValue,''0000000.00'' ))
								WHEN zm.MessageCode IN (41) AND Name in (''Pricing'') AND ISNULL(zil.ColumnName, '''')  like ''%Quantity%'' THEN +''  ''+ dbo.Fn_GetDefaultInventoryRoundOff(isnull(DefaultErrorValue,''0000000.00'' ))
								WHEN zm.MessageCode IN (41) AND Name in (''Inventory'') THEN +''  ''+ dbo.Fn_GetDefaultInventoryRoundOff(isnull(DefaultErrorValue,''0000000.00'' ))
								WHEN zm.MessageCode IN (44) AND Name in (''Pricing'') THEN +''  ''+ isnull(DefaultErrorValue,''0000000.00'' )
								WHEN zm.MessageCode IN (129) AND Name NOT IN (''Product'') THEN +'' ''+ isnull(DefaultErrorValue,''0000000.00'')+''.''
						

								ELSE ''''END ''ErrorDescription'' ,zil.ModifiedDate,zil.GUID
								FROM ZnodeImportLog AS zil WITH (NOLOCK) INNER JOIN ZnodeMessage AS zm WITH (NOLOCK) ON zil.ErrorDescription = CONVERT(VARCHAR(50) , zm.MessageCode)
								INNER JOIN ZnodeImportProcessLog zipl WITH (NOLOCK) ON zil.ImportProcessLogId = zipl.ImportProcessLogId
								LEFT Outer JOIN ZnodeImportTemplate zit WITH (NOLOCK) ON zipl.ImportTemplateId = zit.ImportTemplateId
								LEFT Outer JOIN ZnodeImportHead zih WITH (NOLOCK) ON zit.ImportHeadId =zih.ImportHeadId 
								)
								,Cte_ErrorLogFilter As ( SELECT ImportLogId,ImportProcessLogId,[RowNumber],[ColumnName],[ColumnValue],[ErrorDescription],[ModifiedDate],GUID
												,'+dbo.Fn_GetPagingRowId(@Order_BY , 'RowNumber,ImportLogId')+',Count(*)Over() CountNo 
								 FROM Cte_ErrorLog
								 WHERE 1 = 1 '+dbo.Fn_GetFilterWhereClause(@WhereClause)+' 
							 )

							SELECT ImportLogId,ImportProcessLogId,RowNumber,ColumnName,ColumnValue,ErrorDescription,RowId, CountNo 
							FROM Cte_ErrorLogFilter '+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows)

			 INSERT INTO @TBL_ImportLog (ImportLogId,ImportProcessLogId,RowNumber,ColumnName,ColumnValue,ErrorDescription,RowId, CountNo)
			 EXEC (@SQL)
				 SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM @TBL_ImportLog), 0);
             SELECT ImportLogId,ImportProcessLogId,RowNumber,ColumnName,ColumnValue,ErrorDescription
			 FROM @TBL_ImportLog
			

		 END TRY
         BEGIN CATCH
             DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetImportProcessLog @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetImportProcessLog',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;                                    
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportPimProductData')
	DROP PROC Znode_ImportPimProductData
GO



CREATE PROCEDURE [dbo].[Znode_ImportPimProductData]
(   @TableName          VARCHAR(200),
    @NewGUID            NVARCHAR(200),
    @TemplateId         NVARCHAR(200),
    @ImportProcessLogId INT,
    @UserId             INT,
    @LocaleId           INT,
    @DefaultFamilyId    INT)
AS
    
	/*
      Summary : Finally Import data into ZnodePimProduct, ZnodePimAttributeValue and ZnodePimAttributeValueLocale Table 
      Process : Flat global temporary table will split into cloumn wise and associted with Znode Attributecodes,
    		      Create group of product with their attribute code and values and inserted one by one products. 	   
    
      SourceColumnName : CSV file column headers
      TargetColumnName : Attributecode from ZnodePimAttribute Table 

	 ***  Need to log error if transaction failed during insertion of records into table.
    */

     BEGIN
		 SET NOCOUNT ON
         BEGIN TRY
             BEGIN TRAN ImportProducts;
             DECLARE @SQLQuery NVARCHAR(MAX);
			 DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
             DECLARE @AttributeTypeName NVARCHAR(10), @AttributeCode NVARCHAR(300), @AttributeId INT, @IsRequired BIT, @SourceColumnName NVARCHAR(600), @PimAttributeFamilyId INT, @NewProductId INT, @PimAttributeValueId INT, @status BIT= 0; 
             --Declare error Log Table 

			
			 DECLARE @FamilyAttributeDetail TABLE
			 ( 
				PimAttributeId int, AttributeTypeName varchar(300), AttributeCode varchar(300), SourceColumnName nvarchar(600), IsRequired bit, PimAttributeFamilyId int
			 );
             IF @DefaultFamilyId = 0
                 BEGIN
					INSERT INTO @FamilyAttributeDetail( PimAttributeId, AttributeTypeName, AttributeCode, SourceColumnName, IsRequired, PimAttributeFamilyId )
					--Call Process to insert data of defeult family with cource column name and target column name 
					EXEC Znode_ImportGetTemplateDetails @TemplateId = @TemplateId, @IsValidationRules = 0, @IsIncludeRespectiveFamily = 1,@DefaultFamilyId = @DefaultFamilyId;
                    UPDATE @FamilyAttributeDetail SET PimAttributeFamilyId = DBO.Fn_GetCategoryDefaultFamilyId();

					---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;
             ELSE
                 BEGIN
                     INSERT INTO @FamilyAttributeDetail(PimAttributeId,AttributeTypeName,AttributeCode,SourceColumnName,IsRequired,PimAttributeFamilyId)
                     --Call Process to insert data of defeult family with cource column name and target column name 
                     EXEC Znode_ImportGetTemplateDetails @TemplateId = @TemplateId,@IsValidationRules = 0,@IsIncludeRespectiveFamily = 1,@DefaultFamilyId = @DefaultFamilyId;

					 ---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;  
				
            -- Retrive PimProductId on the basis of SKU for update product 
			SET @SQLQuery = 'UPDATE tlb SET tlb.PimProductId = ZPAV.PimProductId 
							FROM ZnodePimAttributeValue AS ZPAV INNER JOIN ZnodePimAttributeValueLocale AS ZPAVL ON 
							(ZPAVL.PimAttributeValueId = ZPAV.PimAttributeValueId) 
							INNER JOIN [dbo].[ZnodePimAttribute] ZPA on ZPAV.PimAttributeId = ZPA.PimAttributeId AND ZPA.AttributeCode= ''SKU'' 
							INNER JOIN '+@TableName+' tlb ON ZPAVL.AttributeValue = ltrim(rtrim(tlb.SKU)) ';
			EXEC sys.sp_sqlexec	@SQLQuery	 	
				 	
					
             --Read all attribute details with their datatype 
			 IF NOT EXISTS(SELECT TOP 1 1 FROM INFORMATION_SCHEMA.TABLES WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#DefaultAttributeValue')
				BEGIN
					   CREATE TABLE #DefaultAttributeValue (AttributeTypeName  VARCHAR(300),PimAttributeDefaultValueId INT,PimAttributeId INT,
					   AttributeDefaultValueCode  VARCHAR(100));
					 
					INSERT INTO #DefaultAttributeValue(AttributeTypeName,PimAttributeDefaultValueId,PimAttributeId,AttributeDefaultValueCode)
					--Call Process to insert default data value 
					EXEC Znode_ImportGetPimAttributeDefaultValue;
				END;
             ELSE
                BEGIN
                    DROP TABLE #DefaultAttributeValue;
                END;
             EXEC sys.sp_sqlexec
                  @SQLQuery;
       
			DECLARE @PimProductDetail TABLE 
			 (
			      
				  PimAttributeId INT, PimAttributeFamilyId INT,ProductAttributeCode VARCHAR(300) NULL,
				  ProductAttributeDefaultValueId INT NULL,PimAttributeValueId  INT NULL,LocaleId INT,
				  PimProductId INT NULL,AttributeValue NVARCHAR(MAX) NULL,AssociatedProducts NVARCHAR(4000) NULL,ConfigureAttributeIds VARCHAR(2000) NULL,
				  ConfigureFamilyIds VARCHAR(2000) NULL,RowNumber INT  
                );

		-- Update Record count in log 
       DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
		EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount OUTPUT
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- End

			
             -- Column wise split data from source table ( global temporary table ) and inserted into temporary table variable @PimProductDetail
             -- Add PimAttributeDefaultValue 
             DECLARE Cr_AttributeDetails CURSOR LOCAL FAST_FORWARD
             FOR SELECT PimAttributeId,AttributeTypeName,AttributeCode,IsRequired,SourceColumnName,PimAttributeFamilyId FROM @FamilyAttributeDetail  WHERE ISNULL(SourceColumnName, '') <> '';
             OPEN Cr_AttributeDetails;
             FETCH NEXT FROM Cr_AttributeDetails INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @PimAttributeFamilyId;
             WHILE @@FETCH_STATUS = 0
                 BEGIN
                    SET @NewProductId = 0;
                    SET @SQLQuery = ' SELECT '''+CONVERT(VARCHAR(100), @PimAttributeFamilyId)+''' PimAttributeFamilyId , PimProductId PimProductId,'''+'['+@AttributeCode+']'+''' ProductAttributeCode ,'''+CONVERT(VARCHAR(100), @AttributeId)+''' AttributeId ,
									(SELECT TOP 1  PimAttributeDefaultValueId FROM #DefaultAttributeValue Where PimAttributeId =  '
									+ CONVERT(VARCHAR(100), @AttributeId)+'AND  AttributeDefaultValueCode = TN.['+@SourceColumnName+'] ) PimAttributeDefaultValueId ,['
									+ @SourceColumnName+'],'+CONVERT(VARCHAR(100), @LocaleId)+'LocaleId
								, RowNumber FROM '+@TableName+' TN';
								print @SQLQuery
                    INSERT INTO @PimProductDetail( PimAttributeFamilyId, PimProductId,ProductAttributeCode, PimAttributeId, ProductAttributeDefaultValueId, AttributeValue, LocaleId, RowNumber )
					
					EXEC sys.sp_sqlexec @SQLQuery;
                    FETCH NEXT FROM Cr_AttributeDetails INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @PimAttributeFamilyId;
                 END;
             CLOSE Cr_AttributeDetails;
             DEALLOCATE Cr_AttributeDetails;
			 
			
			 if object_id('tempdb..#PimProductDetail1') is not null
				drop table #PimProductDetail1

			 Select * into #PimProductDetail1 from @PimProductDetail

			 UPDATE a 
			 SET ConfigureAttributeIds =  SUBSTRING((SELECT ','+CAST(c.PimAttributeId As VARCHAR(100)) 
			 FROM #PimProductDetail1 c 
			 INNER JOIN ZnodePimAttribute b ON (b.PimAttributeId = c.PimAttributeId)
			 WHERE IsConfigurable =1  AND c.RowNumber = a.RowNumber  FOR XML PATH('')),2,4000) 
			 FROM #PimProductDetail1 a 
			WHERE EXISTS (SELECT TOP 1 1 FROM #PimProductDetail1 ab  WHERE ab.RowNumber = a.RowNumber AND	ab.ProductAttributeCode = '[ProductType]' 
			 AND ab.AttributeValue = 'ConfigurableProduct' )
				
             -- In case of Yes/No : If value is not TRUE OR  1 then it will be  False else True
			 --If default Value set not need of hard code for IsActive
			 UPDATE ppdti SET ppdti.AttributeValue = CASE WHEN Upper(ISNULL(ppdti.AttributeValue, '')) in ( 'TRUE','1')  THEN 'true'  ELSE 'false' END FROM #PimProductDetail1 ppdti
                INNER JOIN #DefaultAttributeValue dav ON ppdti.PimAttributeId = dav.PimAttributeId WHERE   dav.AttributeTypeName = 'Yes/No';
            
		
		-----------Added Performance patch 
		DECLARE @PublishStateIdForDraft INT= [dbo].[Fn_GetPublishStateIdForDraftState]();
		DECLARE @PimDefaultFamily INT= dbo.Fn_GetDefaultPimProductFamilyId();
        DECLARE @pimSkuAttributeId VARCHAR(50)= [dbo].[Fn_GetProductSKUAttributeId]();
        DECLARE @PimIsDownlodableAttributeId VARCHAR(50)= [dbo].[Fn_GetIsDownloadableAttributeId]();
        DECLARE @PublishStateIdForNotPublished INT= [dbo].[Fn_GetPublishStateIdForForNotPublishedState]();

		DELETE FROM #PimProductDetail1 WHERE RTRIM(LTRIM(ISNULL(AttributeValue, ''))) = '';
        
		CREATE INDEX Inx_PimProductDetail_Bulk1 ON #PimProductDetail1(RowNumber);

        ------------------------------------Bulk Row Process
        DECLARE @MaxCount INT, @MinRow INT, @MaxRow INT, @Rows numeric(10,2);
        ---- Count of total rows for import
		SELECT @MaxCount = COUNT(*) FROM #PimProductDetail1;
		
		---- Count of rows in loop for import
		SELECT @Rows = (select top 1 FeatureValues from ZnodeGlobalSetting where FeatureName = 'ProductImportBulk')  --ceiling(@MaxCount/100.0)
        
		SELECT @MaxCount = CEILING(@MaxCount / @Rows);

        IF OBJECT_ID('tempdb..#Temp_ImportLoop') IS NOT NULL
            DROP TABLE #Temp_ImportLoop;
        
		---- To get the min and max rows for import in loop
		;WITH cte AS 
		(
			SELECT RowId = 1, 
				   MinRow = 1, 
                   MaxRow = cast(@Rows as int)
            UNION ALL
            SELECT RowId + 1, 
                   MinRow + cast(@Rows as int), 
                   MaxRow + cast(@Rows as int)
            FROM cte
            WHERE RowId + 1 <= @MaxCount
		)
        SELECT RowId, MinRow, MaxRow
        INTO #Temp_ImportLoop
        FROM cte
		option (maxrecursion 0);

        --while @MaxCount <= @minRow
        DECLARE cur_BulkData CURSOR LOCAL FAST_FORWARD
        FOR SELECT MinRow, MaxRow FROM #Temp_ImportLoop;

        OPEN cur_BulkData;
        FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow;

        WHILE @@FETCH_STATUS = 0
        BEGIN
		
		BEGIN TRAN ImportProducts;

			if object_id ('tempdb..#PimProductDetail_Bulk_Process')is not null
					drop table tempdb..#PimProductDetail_Bulk_Process

			CREATE TABLE #PimProductDetail_Bulk_Process
			([PimAttributeId]                 [INT] NULL, 
				[PimAttributeFamilyId]           [INT] NULL, 
				[ProductAttributeCode]           [VARCHAR](300) NULL, 
				[ProductAttributeDefaultValueId] [INT] NULL, 
				[PimAttributeValueId]            [INT] NULL, 
				[LocaleId]                       [INT] NULL, 
				[PimProductId]                   [INT] NULL, 
				[AttributeValue]                 [NVARCHAR](MAX) NULL, 
				[AssociatedProducts]             [NVARCHAR](4000) NULL, 
				[ConfigureAttributeIds]          [VARCHAR](2000) NULL, 
				[ConfigureFamilyIds]             [VARCHAR](2000) NULL, 
				[RowNumber]                      [INT] NULL, 
				SKU1                             VARCHAR(600),
				Id Int Identity(1,1)Primary Key
			);

			CREATE INDEX Inx_PimProductDetail_Bulk_Process ON #PimProductDetail_Bulk_Process(ProductAttributeCode, PimProductId);
			CREATE INDEX Inx_PimProductDetail_Bulk_Process1 ON #PimProductDetail_Bulk_Process(RowNumber);
			CREATE INDEX Inx_PimProductDetail_Bulk_Process2 ON #PimProductDetail_Bulk_Process(ProductAttributeCode)
			CREATE INDEX Inx_PimProductDetail_Bulk_Process3 ON #PimProductDetail_Bulk_Process(PimAttributeId, PimProductId);

			---- Insert rows for import in bulk
            INSERT INTO #PimProductDetail_Bulk_Process
            ([PimAttributeId], 
                [PimAttributeFamilyId], 
                [ProductAttributeCode], 
                [ProductAttributeDefaultValueId], 
                [PimAttributeValueId], 
                [LocaleId], 
                [PimProductId], 
                [AttributeValue], 
                [AssociatedProducts], 
                [ConfigureAttributeIds], 
                [ConfigureFamilyIds], 
                [RowNumber]
            )
            SELECT [PimAttributeId], 
                    [PimAttributeFamilyId], 
                    [ProductAttributeCode], 
                    [ProductAttributeDefaultValueId], 
                    [PimAttributeValueId], 
                    [LocaleId], 
                    [PimProductId], 
                    ltrim(rtrim([AttributeValue])), 
                    [AssociatedProducts], 
                    [ConfigureAttributeIds], 
                    [ConfigureFamilyIds], 
                    [RowNumber]
            FROM #PimProductDetail1 a
            WHERE a.[RowNumber] BETWEEN @MinRow AND @MaxRow;

			--select * from @PimProductDetail

			--select * from #PimProductDetail1



            ---------------------------Start Importing 
			if object_id ('tempdb..#TBL_DefaultAttributeId')is not null
				drop table #TBL_DefaultAttributeId

			if object_id ('tempdb..#TBL_MediaAttributeId')is not null
				drop table #TBL_MediaAttributeId

			if object_id ('tempdb..#TBL_TextAreaAttributeId')is not null
				drop table #TBL_TextAreaAttributeId

			if object_id ('tempdb..#TBL_MediaAttributeValue')is not null
				drop table #TBL_MediaAttributeValue

			if object_id ('tempdb..#TBL_DefaultAttributeValue')is not null
				drop table #TBL_DefaultAttributeValue

			if object_id ('tempdb..#ZnodePimAttributeValue')is not null
				drop table #ZnodePimAttributeValue

				
            CREATE TABLE #TBL_DefaultAttributeId ( PimAttributeId INT PRIMARY KEY, AttributeCode  VARCHAR(600) );

            CREATE TABLE #TBL_MediaAttributeId ( PimAttributeId INT PRIMARY KEY, AttributeCode  VARCHAR(600) );

            CREATE TABLE #TBL_TextAreaAttributeId ( PimAttributeId INT PRIMARY KEY, AttributeCode  VARCHAR(600) );
           
		    CREATE TABLE #TBL_MediaAttributeValue ( PimAttributeValueId INT, LocaleId INT, AttributeValue VARCHAR(300), MediaId INT );

            CREATE TABLE #TBL_DefaultAttributeValue ( PimAttributeValueId INT, LocaleId INT, AttributeValue INT );

            CREATE TABLE #ZnodePimAttributeValue (PimAttributeValueId  INT, PimAttributeFamilyId INT, PimAttributeId INT, PimProductId INT );

            DECLARE @ConfigureFamilyId VARCHAR(4000);

            INSERT INTO #TBL_DefaultAttributeId ( PimAttributeId, AttributeCode )
            SELECT PimAttributeId, AttributeCode
            FROM [dbo].[Fn_GetDefaultAttributeId]();

			INSERT INTO #TBL_MediaAttributeId (PimAttributeId, AttributeCode )
			SELECT PimAttributeId, AttributeCode
			FROM [dbo].[Fn_GetProductMediaAttributeId]();

            INSERT INTO #TBL_TextAreaAttributeId ( PimAttributeId, AttributeCode )
            SELECT PimAttributeId, AttributeCode
            FROM [dbo].[Fn_GetTextAreaAttributeId]();

            SELECT TOP 1 @PimAttributeFamilyId = PimAttributeFamilyId FROM #PimProductDetail_Bulk_Process;

			if object_id ('tempdb..#cte')is not null
				drop table #cte

            SELECT AttributeValue AS SKU, RowNumber
            INTO #cte
            FROM #PimProductDetail_Bulk_Process
            WHERE ProductAttributeCode = '[SKU]';
              
			

            CREATE INDEX Inx_cte_RowNumber ON #cte(RowNumber);
            UPDATE a SET a.SKU1 = B.SKU
            FROM #PimProductDetail_Bulk_Process a
            INNER JOIN #cte b ON a.RowNumber = b.RowNumber;

		
			
            SELECT TOP 1 @LocaleId = LocaleId FROM #PimProductDetail_Bulk_Process;

            ----Update ZNodePimProduct 
            UPDATE ZNodePimProduct
            SET PimAttributeFamilyId = DP.PimAttributeFamilyId, 
                PublishStateId = @PublishStateIdForDraft, 
                ModifiedBy = @UserId, 
                ModifiedDate = @GetDate
            FROM ZNodePimProduct ZPP
            INNER JOIN #PimProductDetail_Bulk_Process DP ON ZPP.PimProductId = DP.PimProductId;
      
			if object_id ('tempdb..#ZnodePimProduct')is not null
				drop table #ZnodePimProduct

			CREATE TABLE #ZnodePimProduct(PimProductId INT,ExternalId INT  Primary key)

			--create index Idx_ZnodePimProduct_ExternalId on #ZnodePimProduct(ExternalId)


			 

			----Insert into ZNodePimProduct 
            INSERT INTO ZnodePimProduct
            (PimAttributeFamilyId, 
                ExternalId, 
                CreatedBy, 
                CreatedDate, 
                ModifiedBy, 
                ModifiedDate, 
                PublishStateId
            )
			output inserted.PimProductId, inserted.ExternalId into #ZnodePimProduct(PimProductId,ExternalId)
            SELECT PimAttributeFamilyId, 
                    RowNumber, 
                    @UserId, 
                    @GetDate, 
                    @UserId, 
                    @GetDate, 
                    @PublishStateIdForNotPublished
            FROM #PimProductDetail_Bulk_Process
            WHERE ProductAttributeCode = '[SKU]'
            AND PimProductId IS NULL;
            
			----Update newly created productIds
            UPDATE a SET a.PimProductId = b.PimProductId
            FROM #PimProductDetail_Bulk_Process a
            INNER JOIN #ZnodePimProduct b ON a.RowNumber = b.ExternalId;

            ----Insert Downloadable products into ZnodePimDownloadableProduct
            INSERT INTO ZnodePimDownloadableProduct (SKU, ProductName, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate )
            SELECT PDSKU.AttributeValue, PDProdName.AttributeValue, @UserId, @GetDate, @UserId, @GetDate
            FROM #PimProductDetail_Bulk_Process PDSKU
            INNER JOIN #PimProductDetail_Bulk_Process PDProdName ON PDProdName.RowNumber = PDSKU.RowNumber
            INNER JOIN #PimProductDetail_Bulk_Process PDDownload ON PDDownload.RowNumber = PDSKU.RowNumber
            WHERE PDSKU.ProductAttributeCode = @pimSkuAttributeId
            AND PDProdName.ProductAttributeCode = '[SKU]'
            AND PDDownload.PimAttributeId = @PimIsDownlodableAttributeId
            AND PDDownload.AttributeValue = 'true'
            AND NOT EXISTS ( SELECT TOP 1 1 FROM ZnodePimDownloadableProduct WHERE ZnodePimDownloadableProduct.SKU = PDSKU.AttributeValue );

            ---- update ZnodePimAttributeValue : attribute data for Product
            UPDATE TARGET
            SET TARGET.PimAttributeFamilyId = CASE
                                                    WHEN Source.PimAttributeFamilyId = 0
                                                    THEN NULL
                                                    ELSE Source.PimAttributeFamilyId
                                                END, 
                    TARGET.ModifiedBy = @UserId, 
                    TARGET.ModifiedDate = @GetDate, 
                    TARGET.PimProductId = SOURCE.PimProductId
            OUTPUT INSERTED.PimAttributeValueId, 
                    INSERTED.PimAttributeFamilyId, 
                    INSERTED.PimAttributeId, 
                    INSERTED.PimProductId
                    INTO #ZnodePimAttributeValue
            FROM ZnodePimAttributeValue TARGET
            INNER JOIN #PimProductDetail_Bulk_Process SOURCE ON TARGET.PimProductId = SOURCE.PimProductId AND TARGET.PimAttributeId = SOURCE.PimAttributeId;
             
			---- Inserting attribute data for Product 
			INSERT INTO ZnodePimAttributeValue 
			( 
				PimAttributeFamilyId, 
				PimProductId, PimAttributeId, 
				PimAttributeDefaultValueId, 
				CreatedBy, 
				CreatedDate, 
				ModifiedBy, 
				ModifiedDate 
			)
            OUTPUT INSERTED.PimAttributeValueId, 
                    INSERTED.PimAttributeFamilyId, 
                    INSERTED.PimAttributeId, 
                    INSERTED.PimProductId
                    INTO #ZnodePimAttributeValue
            SELECT 
				CASE
                    WHEN Source.PimAttributeFamilyId = 0
                    THEN @PimDefaultFamily
                    ELSE Source.PimAttributeFamilyId
                END, 
                SOURCE.PimProductId, 
                ISNULL(SOURCE.PimAttributeId, 0),
                CASE
                    WHEN SOURCE.ProductAttributeDefaultValueId = 0
                    THEN NULL
                    ELSE SOURCE.ProductAttributeDefaultValueId
                END, 
                @UserId, 
                @GetDate, 
                @UserId, 
                @GetDate
            FROM #PimProductDetail_Bulk_Process SOURCE
            WHERE NOT EXISTS
            (
                SELECT *
                FROM ZnodePimAttributeValue TARGET
                WHERE TARGET.PimProductId = SOURCE.PimProductId
                        AND TARGET.PimAttributeId = SOURCE.PimAttributeId
            );

            -------------------------
			if object_id ('tempdb..#MediaData')is not null
				drop table #MediaData

            CREATE TABLE #MediaData (MediaId INT, PimProductId INT, PimAttributeId INT, PimAttributeFamilyId INT, LocaleId INT );

			---- Get Product Media Data
            INSERT INTO #MediaData ( MediaId , PimProductId , PimAttributeId , PimAttributeFamilyId , LocaleId )
            SELECT SP.Item, a.PimProductId, a.PimAttributeId, PimAttributeFamilyId, a.LocaleId
            FROM #PimProductDetail_Bulk_Process a
            INNER JOIN #TBL_MediaAttributeId c ON(c.PimAttributeId = a.PimAttributeId)
            CROSS APPLY dbo.split(a.AttributeValue, ',') SP;

			---- Get product media attribute data
            INSERT INTO #TBL_MediaAttributeValue ( PimAttributeValueId, LocaleId, AttributeValue, MediaId )
            SELECT a.PimAttributeValueId, b.LocaleId, zm.Path AttributeValue, ZM.MediaId
            FROM #ZnodePimAttributeValue AS a
            INNER JOIN #MediaData AS b ON(a.PimAttributeId = b.PimAttributeId
                                            AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0)
                                            AND a.PimProductId = b.PimProductId)
            INNER JOIN ZnodeMedia ZM ON(b.MediaId = ZM.MediaId);
     
			---- Deleting product media attribute
            DELETE FROM ZnodePimProductAttributeMedia
            WHERE EXISTS
            (
                SELECT TOP 1 1
                FROM #TBL_MediaAttributeValue TBLM
                WHERE ZnodePimProductAttributeMedia.PimAttributeValueId = TBLM.PimAttributeValueId
                        AND TBLM.MediaId <> ZnodePimProductAttributeMedia.MediaId
                        AND ZnodePimProductAttributeMedia.Localeid = @LocaleId
            );

            ---- update ZnodePimProductAttributeMedia : attribute data for Product
            UPDATE TARGET
                SET 
                    TARGET.MediaPath = SOURCE.AttributeValue, 
                    TARGET.MediaId = SOURCE.MediaId, 
                    TARGET.ModifiedBy = @UserId, 
                    TARGET.ModifiedDate = @GetDate
            FROM ZnodePimProductAttributeMedia TARGET
            INNER JOIN #TBL_MediaAttributeValue SOURCE ON TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                                                        AND TARGET.MediaPAth = SOURCE.AttributeValue
                                                        AND TARGET.LocaleId = SOURCE.LocaleId;
    
            ---- inserting Media attribute data for Product
            INSERT INTO ZnodePimProductAttributeMedia 
			( 
				PimAttributeValueId, 
				LocaleId, MediaPath, 
				MediaId, 
				CreatedBy, 
				CreatedDate, 
				ModifiedBy, 
                ModifiedDate
            )
            SELECT SOURCE.PimAttributeValueId, 
                    SOURCE.LocaleId, 
                    SOURCE.AttributeValue, 
                    SOURCE.MediaId, 
                    @UserId, 
                    @GetDate, 
                    @UserId, 
                    @GetDate
            FROM #TBL_MediaAttributeValue SOURCE
            WHERE NOT EXISTS
            (
                SELECT *
                FROM ZnodePimProductAttributeMedia TARGET
                WHERE TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                        AND TARGET.MediaPAth = SOURCE.AttributeValue
                        AND TARGET.LocaleId = SOURCE.LocaleId
            );

            --------------------------
			if object_id ('tempdb..#Cte_TextAreaAttributeValue')is not null
				drop table #Cte_TextAreaAttributeValue

			---- Getting text area data in temp #Cte_TextAreaAttributeValue
            SELECT a.PimAttributeValueId, 
                    b.LocaleId, 
                    AttributeValue
            INTO #Cte_TextAreaAttributeValue
            FROM #ZnodePimAttributeValue AS a
            INNER JOIN #PimProductDetail_Bulk_Process AS b ON(a.PimAttributeId = b.PimAttributeId
                                                            AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0)
                                                            AND a.PimProductId = b.PimProductId)
            INNER JOIN #TBL_TextAreaAttributeId c ON(c.PimAttributeId = b.PimAttributeId);

            ---- update ZnodePimProductAttributeTextAreaValue : attribute data for Product
            UPDATE TARGET
            SET TARGET.AttributeValue = SOURCE.AttributeValue, 
                TARGET.CreatedBy = @UserId, 
                TARGET.ModifiedBy = @UserId, 
                TARGET.ModifiedDate = @GetDate
            FROM ZnodePimProductAttributeTextAreaValue TARGET
            INNER JOIN #Cte_TextAreaAttributeValue SOURCE ON TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                                                                      AND TARGET.LocaleId = SOURCE.LocaleId;

            ---- inserting TextAreaValue attribute data for Product
            INSERT INTO ZnodePimProductAttributeTextAreaValue
            (
				PimAttributeValueId, 
                LocaleId, 
                AttributeValue, 
                CreatedBy, 
                CreatedDate, 
                ModifiedBy, 
                ModifiedDate
            )
            SELECT SOURCE.PimAttributeValueId, 
                    SOURCE.LocaleId, 
                    SOURCE.AttributeValue, 
                    @UserId, 
                    @GetDate, 
                    @UserId, 
                    @GetDate
            FROM #Cte_TextAreaAttributeValue SOURCE
            WHERE NOT EXISTS
            (
                SELECT *
                FROM ZnodePimProductAttributeTextAreaValue TARGET
                WHERE TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                        AND TARGET.LocaleId = SOURCE.LocaleId
            );
           
		    ---- Getting attribute default values for product
            INSERT INTO #TBL_DefaultAttributeValue ( PimAttributeValueId, LocaleId, AttributeValue )
            SELECT a.PimAttributeValueId, b.LocaleId, d.PimAttributeDefaultValueId AttributeValue
            FROM #ZnodePimAttributeValue AS a
            INNER JOIN #PimProductDetail_Bulk_Process AS b ON(a.PimAttributeId = b.PimAttributeId
                                                                AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0)
                                                                AND a.PimProductId = b.PimProductId)
            INNER JOIN #TBL_DefaultAttributeId c ON(c.PimAttributeId = b.PimAttributeId)
            CROSS APPLY dbo.split(b.AttributeValue, ',') SP
            INNER JOIN ZnodePimAttributeDefaultValue d ON d.PimAttributeId = b.PimAttributeId
                                                            AND SP.Item = d.AttributeDefaultValueCode;
			---- Deleting prodyuct attribute default value
            DELETE FROM ZnodePimProductAttributeDefaultValue
            WHERE EXISTS
            (
                SELECT TOP 1 1
                FROM #TBL_DefaultAttributeValue TBLAV
                WHERE TBLAV.PimAttributeValueId = ZnodePimProductAttributeDefaultValue.PimAttributeValueId
                        AND TBLAV.AttributeValue <> ZnodePimProductAttributeDefaultValue.PimAttributeDefaultValueId
                        AND ZnodePimProductAttributeDefaultValue.LocaleId = @LocaleId
            );

			---- update ZnodePimProductAttributeDefaultValue : attribute data for Product
			UPDATE TARGET
			SET TARGET.PimAttributeDefaultValueId = SOURCE.AttributeValue, 
				TARGET.ModifiedBy = @UserId, 
				TARGET.ModifiedDate = @GetDate
			FROM ZnodePimProductAttributeDefaultValue TARGET
					INNER JOIN #TBL_DefaultAttributeValue SOURCE ON TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
																	AND TARGET.PimAttributeDefaultValueId = SOURCE.AttributeValue
																	AND TARGET.LocaleId = SOURCE.LocaleId;

            ---- insert ZnodePimProductAttributeDefaultValue : attribute data for Product
            INSERT INTO ZnodePimProductAttributeDefaultValue
            (
				PimAttributeValueId, 
                LocaleId, 
                PimAttributeDefaultValueId, 
                CreatedBy, 
                CreatedDate, 
                ModifiedBy, 
                ModifiedDate
            )
            SELECT 
				SOURCE.PimAttributeValueId, 
                SOURCE.LocaleId, 
                SOURCE.AttributeValue, 
                @UserId, 
                @GetDate, 
                @UserId, 
                @GetDate
            FROM #TBL_DefaultAttributeValue SOURCE
            WHERE NOT EXISTS
            (
                SELECT *
                FROM ZnodePimProductAttributeDefaultValue TARGET
                WHERE TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                        AND TARGET.PimAttributeDefaultValueId = SOURCE.AttributeValue
                        AND TARGET.LocaleId = SOURCE.LocaleId
            );
               

            IF OBJECT_ID('tempdb..#cte_ZnodePimAttributeValue') IS NOT NULL
                DROP TABLE #cte_ZnodePimAttributeValue;

			CREATE TABLE #cte_ZnodePimAttributeValue(PimAttributeValueId int, LocaleId int, AttributeValue nvarchar(max))

			CREATE INDEX Idx_cte_ZnodePimAttributeValue on #cte_ZnodePimAttributeValue(PimAttributeValueId, LocaleId)

			INSERT INTO #cte_ZnodePimAttributeValue (PimAttributeValueId, LocaleId, AttributeValue)
            SELECT a.PimAttributeValueId, b.LocaleId,AttributeValue                
            FROM #ZnodePimAttributeValue AS a
            INNER JOIN #PimProductDetail_Bulk_Process AS b ON(a.PimAttributeId = b.PimAttributeId
                                                                AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0)
                                                                AND a.PimProductId = b.PimProductId)
            WHERE NOT EXISTS ( SELECT TOP 1 1 FROM #TBL_DefaultAttributeId TBLDA WHERE TBLDA.PimAttributeId = b.PimAttributeId )
            AND NOT EXISTS ( SELECT TOP 1 1 FROM #TBL_MediaAttributeId TBLMA WHERE TBLMA.PimAttributeId = b.PimAttributeId )
            AND NOT EXISTS ( SELECT TOP 1 1 FROM #TBL_TextAreaAttributeId TBLTA WHERE TBLTA.PimAttributeId = b.PimAttributeId );

            ---- update ZnodePimAttributeValueLocale : attribute data for Product
            UPDATE TARGET
            SET TARGET.AttributeValue = SOURCE.AttributeValue, 
                TARGET.ModifiedBy = @UserId, 
                TARGET.ModifiedDate = @GetDate
            FROM ZnodePimAttributeValueLocale TARGET
            INNER JOIN #cte_ZnodePimAttributeValue SOURCE ON TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                                                           AND TARGET.LocaleId = SOURCE.LocaleId;

            ---- inserting AttributeDefaultValue : attribute data for Product
            INSERT INTO ZnodePimAttributeValueLocale
            (
				PimAttributeValueId, 
                LocaleId, 
                AttributeValue, 
                CreatedBy, 
                CreatedDate, 
                ModifiedBy, 
                ModifiedDate
            )
            SELECT 
				SOURCE.PimAttributeValueId, 
                SOURCE.LocaleId, 
                SOURCE.AttributeValue, 
                @UserId, 
                @GetDate, 
                @UserId, 
                @GetDate
            FROM #cte_ZnodePimAttributeValue SOURCE
            WHERE NOT EXISTS
            (
                SELECT *
                FROM ZnodePimAttributeValueLocale TARGET
                WHERE TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                        AND TARGET.LocaleId = SOURCE.LocaleId
            );

			---- Inserting configurable products into ZnodePimConfigureProductAttribute
            INSERT INTO [ZnodePimConfigureProductAttribute]
            (PimProductId, 
                PimFamilyId, 
                PimAttributeId, 
                CreatedBy, 
                CreatedDate, 
                ModifiedBy, 
                ModifiedDate
            )
            SELECT DISTINCT PD.PimProductId, 
                    NULL, 
                    q.PimAttributeId, 
                    @UserId, 
                    @GetDate, 
                    @UserId, 
                    @GetDate
            FROM #PimProductDetail_Bulk_Process PD
                CROSS APPLY dbo.Split([ConfigureAttributeIds], ',') AS b
                INNER JOIN ZnodePimAttribute AS q ON(q.PimAttributeId = b.Item)
            WHERE NOT EXISTS
            (
                SELECT TOP 1 1
                FROM ZnodePimConfigureProductAttribute RTR
                WHERE RTR.PimProductId = PD.PimProductId
                        AND RTR.PimAttributeId = q.PimAttributeId
            );


			COMMIT TRAN ImportProducts;

            FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow;
        END;
    CLOSE cur_BulkData;
    DEALLOCATE cur_BulkData;

	-----------Added Performance patch end

		---- Update family of Product in table ZnodePimConfigureProductAttribute 
		UPDATE ZnodePimConfigureProductAttribute
		SET PimFamilyId = b.PimAttributeFamilyId
		FROM ZnodePimConfigureProductAttribute a
				INNER JOIN ZnodePimProduct b ON a.PimProductId = b.PimProductId;

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

             COMMIT TRAN ImportProducts;


			 
	 DELETE FROM ZnodePimConfigureProductAttribute  
            WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePimAttributeValue  a WHERE a.PimProductId = ZnodePimConfigureProductAttribute.PimProductId
            AND a.PimAttributeID = ZnodePimConfigureProductAttribute.PimAttributeID )
            --AND EXISTS (SELECT TOP 1 1 FROM ZnodePimAttributeValue a 
            --INNER JOIN ZnodePimAttribute ty ON (ty.PimAttributeId = a.PimAttributeId)
            --INNER JOIN ZnodePimProductAttributeDefaultValue t ON (t.PimAttributeValueId = a.PimAttributeValueId )
            --INNER JOIN ZnodePimAttributeDefaultValue y ON (y.PimAttributeDefaultValueId = t.PimAttributeDefaultValueId)
            --INNER JOIN View_loadmanageProductInternal  TU ON (TU.AttributeCode = 'SKU' AND TU.PimProductId = a.PimProductId  )
            --WHERE ty.AttributeCode = 'ProductType' AND y.AttributeDefaultValueCode = 'ConfigurableProduct'
            --AND a.PimProductId = ZnodePimConfigureProductAttribute.PimProductId
            AND EXISTS (SELECT TOP 1 1 FROM #PimProductDetail1 TM WHERE TM.PimProductId = ZnodePimConfigureProductAttribute.PimProductId )
   
						
		----Delete simple products if inserted in table ZnodePimConfigureProductAttribute 
		DELETE FROM ZnodePimConfigureProductAttribute
		WHERE EXISTS
		(
			SELECT TOP 1 1
			FROM ZnodePimAttributeValue a
					INNER JOIN ZnodePimAttribute ty ON(ty.PimAttributeId = a.PimAttributeId)
					INNER JOIN ZnodePimProductAttributeDefaultValue t ON(t.PimAttributeValueId = a.PimAttributeValueId)
					INNER JOIN ZnodePimAttributeDefaultValue y ON(y.PimAttributeDefaultValueId = t.PimAttributeDefaultValueId)
			WHERE ty.AttributeCode = 'ProductType'
					AND y.AttributeDefaultValueCode = 'SimpleProduct'
					AND a.PimProductId = ZnodePimConfigureProductAttribute.PimProductId
		);

         END TRY
         BEGIN CATCH
		 ROLLBACK TRAN ImportProducts;

		

		  INSERT INTO ZnodeImportLog(ErrorDescription,ColumnName,Data,RowNumber,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
                 Select  46,ERROR_PROCEDURE(),ERROR_MESSAGE(),ERROR_LINE(),@newGUID,@UserId,@GetDate,@UserId,@GetDate, @ImportProcessLogId  
		
		SET @SQLQuery = ' Select @FailedRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
					EXEC	sp_executesql @SQLQuery , N'@FailedRecordCount BIGINT out' , @FailedRecordCount =@FailedRecordCount out
					--SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS  NULL AND  ImportProcessLogId = @ImportProcessLogId;
					SELECT @SuccessRecordCount = 0
									
					UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
					WHERE ImportProcessLogId = @ImportProcessLogId;

		 UPDATE ZnodeImportProcessLog
			SET 
				STATUS = dbo.Fn_GetImportStatus(3), 
				ProcessCompletedDate = GETDATE()
		WHERE ImportProcessLogId = @ImportProcessLogId;
             SELECT ERROR_MESSAGE(),ERROR_LINE(),ERROR_PROCEDURE();
            -- UPDATE ZnodeImportProcessLog SET Status = dbo.Fn_GetImportStatus(3), ProcessCompletedDate = @GetDate WHERE ImportProcessLogId = @ImportProcessLogId;
            -- ROLLBACK TRAN ImportProducts;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCatalogCategoryHierarchyAssociation')
	DROP PROC Znode_ImportCatalogCategoryHierarchyAssociation
GO

CREATE PROCEDURE [dbo].[Znode_ImportCatalogCategoryHierarchyAssociation]
(
	@TableName NVARCHAR(100), 
	@Status BIT OUT, 
	@UserId INT, 
	@ImportProcessLogId INT, 
	@NewGUId NVARCHAR(200),
	@PimCatalogId INT
)
AS
BEGIN 
BEGIN TRAN A;
BEGIN TRY
SET NOCOUNT ON;

	DECLARE @GetDate datetime= dbo.Fn_GetDate()
	DECLARE @SSQL VARCHAR(1000)

	IF OBJECT_ID('tempdb..#Category') IS NOT NULL
		DROP TABLE #Category;

	Declare @FeatureValue VARCHAR(500)
	--If the CatalogCategoryHierarchyAssociationAutoCreate value is true, 1 or Yes then input parent code hierarchy will be generate thogh the import
	--If the CatalogCategoryHierarchyAssociationAutoCreate value is false, 0 or No then input parent code hierarchy is not present in the database then it will give an error log
	SELECT TOP 1 @FeatureValue = FeatureValues FROM ZnodeGlobalSetting WHERE FeatureName = 'CatalogCategoryHierarchyAssociationAutoCreate'

	--Getting existing categories
	SELECT A.PimCategoryId,B.CategoryValue CategoryCode 
	INTO #Category 
	FROM ZnodePimCategoryAttributeValue A 
	INNER JOIN ZnodePimCategoryAttributeValueLocale B ON A.PimCategoryAttributeValueId = b.PimCategoryAttributeValueId 
	WHERE EXISTS(SELECT TOP 1 1 FROM ZnodePimAttribute X WHERE X.IsCategory =1 and X.AttributeCode = 'CategoryCode' and A.PimAttributeId = X.PimAttributeId )

	IF OBJECT_ID('tempdb..#HierarchyImportData') IS NOT NULL
		DROP TABLE #HierarchyImportData;

	CREATE TABLE #HierarchyImportData (RowNumber INT,ParentCode NVARCHAR(MAX),CategoryCode NVARCHAR(MAX), DisplayOrder VARCHAR(10),Action VARCHAR(100),GUID VARCHAR(100));

	SET @SSQL = 'Select RowNumber,LTRIM(RTRIM(ParentCode)), LTRIM(RTRIM(CategoryCode)), DisplayOrder, Action ,GUID FROM '+@TableName;
	INSERT INTO #HierarchyImportData( RowNumber,ParentCode, CategoryCode, DisplayOrder,Action ,GUID)
	EXEC sys.sp_sqlexec @SSQL;

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '131', 'CategoryCode', CategoryCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
	FROM #HierarchyImportData AS ii
	WHERE ISNULL(CategoryCode,'') = ''

	DELETE FROM #HierarchyImportData WHERE RowNumber IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )

	IF OBJECT_ID('tempdb..#SplitedCategoryHierarchy') IS NOT NULL
		DROP TABLE #SplitedCategoryHierarchy

	--Created table for category hierarchy split
	CREATE TABLE #SplitedCategoryHierarchy (PimCategoryHierarchyId INT, ParentPimCategoryHierarchyId INT
	,PimCatalogId INT, PimCategoryId INT,RowNumber INT ,PimCategoryCode VARCHAR(300),RowId INT,Action varchar(100),DisplayOrder VARCHAR(10), ParentCategoryId INT)

	DECLARE @RecordCount INT=(SELECT COUNT(1) FROM #HierarchyImportData) , @Cnt INT = 1 ,@FirstCategoryId  INT 
	WHILE @Cnt <= @RecordCount  
	BEGIN
		SET @FirstCategoryId = 0 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '122', 'ParentCode / CategoryCode', '', @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNULL(ParentCode,'') = '' AND ISNULL(CategoryCode,'') = '' AND ii.RowNumber  = @Cnt 

		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--SELECT '102', 'CategoryCode', CategoryCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		--FROM #HierarchyImportData AS ii
		--WHERE ltrim(rtrim(isnull(ii.CategoryCode,''))) like '% %' AND ii.RowNumber  = @Cnt 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '16', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE (ii.DisplayOrder > 99999 OR ii.DisplayOrder <= 0) AND ISNULL(ii.DisplayOrder,'') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '115', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNUMERIC(ii.DisplayOrder)=0 AND ISNULL(ii.DisplayOrder,'') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '125', 'Action', Action, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE isnull(Action,'') NOT IN ('ADD','DELETE')
		
		IF OBJECT_ID('tempdb..#ExistingHierarchy') IS NOT NULL
			DROP TABLE #ExistingHierarchy;
	
		TRUNCATE TABLE #SplitedCategoryHierarchy

		--Splitting category hierarchy and inserted into temp table #SplitedCategoryHierarchy
		INSERT INTO #SplitedCategoryHierarchy (PimCatalogId , PimCategoryCode ,RowNumber,RowId,Action,DisplayOrder)
		SELECT @PimCatalogId, LTRIM(RTRIM(B.item)) as PimCategoyHierarchyCode , Id, RowNumber, Action, CASE WHEN ISNULL(DisplayOrder,'') = '' THEN 0 ELSE DisplayOrder END
		FROM #HierarchyImportData A 
		CROSS APPLY  dbo.split(isnull(A.ParentCode,'')+CASE WHEN isnull(A.ParentCode,'') = '' THEN '' ELSE '/' END+A.CategoryCode,'/') B 
		Where A.RowNumber  = @Cnt  

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '127', 'ParentCode / CategoryCode', PimCategoryCode, @NewGUId, RowId, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #SplitedCategoryHierarchy AS ii
		WHERE NOT EXISTS(SELECT * FROM #Category C WHERE LTRIM(RTRIM(ii.PimCategoryCode)) = c.CategoryCode)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '123', 'ParentCode / CategoryCode', PimCategoryCode, @NewGUId, RowId, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #SplitedCategoryHierarchy AS ii
		GROUP BY PimCategoryCode ,RowId
		HAVING COUNT(*) > 1

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '124', 'ParentCode', ParentCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNULL(replace(ii.ParentCode,' ',''),'') like '%//%'
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '128', 'CategoryCode', CategoryCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNULL(replace(LTRIM(RTRIM(ii.CategoryCode)),' ',''),'') like '%[^a-zA-Z0-9]%'

		--Deleting the records which was invalid and added into error log
		DELETE FROM #SplitedCategoryHierarchy WHERE RowId IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )
		DELETE FROM #HierarchyImportData WHERE RowNumber IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )

		IF OBJECT_ID('tempdb..#CategoryCodeCheck') IS NOT NULL
			DROP TABLE #CategoryCodeCheck;

		IF EXISTS(SELECT * FROM #SplitedCategoryHierarchy)
		BEGIN
			Update A SET A.PimCategoryId = D.PimCategoryId FROM #SplitedCategoryHierarchy A INNER JOIN #Category D ON LTRIM(RTRIM(A.PimCategoryCode)) = LTRIM(RTRIM(D.CategoryCode))

			Select TOP 1 @FirstCategoryId = X.PimCategoryId FROM #SplitedCategoryHierarchy X
	
			--Getting existing category hierarchy
			;WITH CTE_ZnodePimCategoryHierarchy as 
			(
				SELECT PimCategoryHierarchyId,ParentPimCategoryHierarchyId,PimCategoryId,PimCatalogId
				FROM ZnodePimCategoryHierarchy 
				WHERE PimCatalogId = @PimCatalogId 
			)
			,Hierarchy AS
			(
				-- Anchor
				SELECT  A.PimCategoryHierarchyId,A.ParentPimCategoryHierarchyId,A.PimCategoryId,A.PimCatalogId --, dense_rank() over(order by a.ParentPimCategoryHierarchyId) as RowNumber
				FROM CTE_ZnodePimCategoryHierarchy A
				WHERE A.ParentPimCategoryHierarchyId IS NULL AND  
				A.PimCategoryId =@FirstCategoryId 	AND A.PimCatalogId = @PimCatalogId
				UNION ALL
				-- Recursive query
				SELECT  E.PimCategoryHierarchyId,E.ParentPimCategoryHierarchyId,E.PimCategoryId,E.PimCatalogId--, ROW_NUMBER() over(order by E.ParentPimCategoryHierarchyId,E.PimCategoryHierarchyId) as RowNumber
				FROM CTE_ZnodePimCategoryHierarchy E
				JOIN Hierarchy H ON E.ParentPimCategoryHierarchyId = H.PimCategoryHierarchyId
				WHERE  Exists(Select * FROM #SplitedCategoryHierarchy X WHERE E.PimCategoryId = X.PimCategoryId)
			)
			SELECT * INTO #ExistingHierarchy FROM Hierarchy --Where RowNumber  = @Cnt  --
			--order by PimCategoryHierarchyId

			--Adding required columns into temp table
			Alter table #ExistingHierarchy Add Id INT Identity(1,1), RowNumber INT, ParentCategoryId INT

			--Updating the row number for parent category
			UPDATE #ExistingHierarchy SET RowNumber = 1 WHERE ParentPimCategoryHierarchyId IS NULL

			DECLARE @RecordCount1 INT=(SELECT COUNT(1) FROM #ExistingHierarchy) , @Cnt1 INT = 1 --,@FirstCategoryId1  INT 
			DECLARE @ParentPimCategoryHierarchyId1 INT , @RowNumber INT

			--Updating the row number according to category hierarhcy level
			WHILE @Cnt1 <= @RecordCount1  
			BEGIN
				
				SELECT @ParentPimCategoryHierarchyId1 = PimCategoryHierarchyId FROM #ExistingHierarchy WHERE Id = @Cnt1
				SET @RowNumber = (SELECT TOP 1 RowNumber FROM #ExistingHierarchy WHERE PimCategoryHierarchyId = @ParentPimCategoryHierarchyId1) 

				UPDATE #ExistingHierarchy SET RowNumber = @RowNumber + 1
				WHERE ParentPimCategoryHierarchyId = @ParentPimCategoryHierarchyId1
				
				SET @ParentPimCategoryHierarchyId1 = 0
				SET @RowNumber = 0
				SET @Cnt1 = @Cnt1+1
			END

			--Updating the parent category on existing category hierarchy
			UPDATE b SET ParentCategoryId = a.PimCategoryId
			from #ExistingHierarchy a
			inner join #ExistingHierarchy b on b.ParentPimCategoryHierarchyId = a.PimCategoryHierarchyId
			
			--Updating the parent category on input record
			UPDATE  A SET A.ParentCategoryId = B.PimCategoryId
			FROM #SplitedCategoryHierarchy A  
			INNER JOIN #SplitedCategoryHierarchy B ON B.RowNumber = A.RowNumber-1
						
			--Existing Hierarchy has been updated on the input categories
			Update B SET B.PimCategoryHierarchyId= A.PimCategoryHierarchyId, 
			B.ParentPimCategoryHierarchyId = A.ParentPimCategoryHierarchyId
			FROM #ExistingHierarchy  A INNER JOIN #SplitedCategoryHierarchy B ON ISNULL(A.PimCategoryId,0) = ISNULL(B.PimCategoryId,0) AND ISNULL(A.ParentCategoryId,0) = ISNULL(B.ParentCategoryId,0) and A.RowNumber = B.RowNumber 

			--Removing hierarchy ids of categoris if its parent dont have any hierarchy for input	
			UPDATE CH SET PimCategoryHierarchyId = NULL ,ParentPimCategoryHierarchyId = NULL
			FROM #SplitedCategoryHierarchy CH
			WHERE CH.PimCategoryHierarchyId IS NOT NULL AND EXISTS(SELECT * FROM #SplitedCategoryHierarchy CH1 WHERE CH1.PimCategoryHierarchyId IS NULL AND CH.RowNumber-1 = CH1.RowNumber)

			--Removing hierarchy ids of categories if its parent doesent present in the input hierarchy
			UPDATE A SET PimCategoryHierarchyId = NULL ,ParentPimCategoryHierarchyId = NULL 
			FROM #SplitedCategoryHierarchy A 
			WHERE NOT EXISTS(SELECT * FROM #SplitedCategoryHierarchy X WHERE X.PimCategoryHierarchyId = A.ParentPimCategoryHierarchyId)
			AND A.ParentPimCategoryHierarchyId IS NOT NULL 
			
			IF isnull(@FeatureValue,'') IN ('False','0','No','')
			BEGIN
				--If root level category is not present
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '130', 'ParentCode', ParentCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #HierarchyImportData h
				WHERE RowNumber IN (
					SELECT RowId FROM #SplitedCategoryHierarchy a
					WHERE NOT EXISTS(SELECT * FROM #HierarchyImportData b WHERE LTRIM(RTRIM(A.PimCategoryCode)) = LTRIM(RTRIM(b.CategoryCode)) AND a.RowId = b.RowNumber)
					AND A.ParentCategoryId IS NULL AND A.PimCategoryHierarchyId IS NULL)
				
				--If child level category is not present
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '130', 'ParentCode', ParentCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #HierarchyImportData H
				WHERE RowNumber IN (
					SELECT RowId FROM #SplitedCategoryHierarchy a
					WHERE NOT EXISTS(SELECT * FROM #HierarchyImportData b WHERE LTRIM(RTRIM(A.PimCategoryCode)) = LTRIM(RTRIM(b.CategoryCode)) AND a.RowId = b.RowNumber)
					AND A.ParentCategoryId IS NOT NULL AND A.ParentPimCategoryHierarchyId IS NULL)
				AND NOT EXISTS(SELECT * FROM ZnodeImportLog X WHERE H.RowNumber = X.RowNumber AND X.ImportProcessLogId=@ImportProcessLogId)
				
				--Deleting the records which was invalid and added into error log
				DELETE FROM #SplitedCategoryHierarchy WHERE RowId IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )
				DELETE FROM #HierarchyImportData WHERE RowNumber IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )
			END

			--Adding new hierarchy into ZnodePimCategoryHierarchy if input having Add action
			IF EXISTS(SELECT * FROM #SplitedCategoryHierarchy WHERE Action = 'Add')
			BEGIN
				
				DROP TABLE IF EXISTS #InsertedPimCategoryHierarchy

				CREATE TABLE #InsertedPimCategoryHierarchy (PimCategoryHierarchyId INT, PimCategoryId INT);

				--Inserting new category hierarchy if not present
				INSERT INTO ZnodePimCategoryHierarchy (PimCatalogId,ParentPimCategoryHierarchyId,PimCategoryId,DisplayOrder,IsActive,
					ActivationDate,ExpirationDate,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PimParentCategoryId)
				OUTPUT inserted.PimCategoryHierarchyId,inserted.PimCategoryId
				INTO #InsertedPimCategoryHierarchy (PimCategoryHierarchyId, PimCategoryId)
				Select PimCatalogId,ParentPimCategoryHierarchyId,PimCategoryId,DisplayOrder,1,NULL,NULL,2,GETDATE(),2,GETDATE(),NULL
				FROM #SplitedCategoryHierarchy WHERE PimCategoryHierarchyId is null 

				-- Newly created Hierarchy has been updated into input category hierarchy
				UPDATE A 
				SET A.PimCategoryHierarchyId=B.PimCategoryHierarchyId
				FROM #SplitedCategoryHierarchy A INNER JOIN #InsertedPimCategoryHierarchy B
					ON A.PimCategoryId=B.PimCategoryId
				WHERE A.PimCategoryHierarchyId IS NULL

				-- Updating new parent hierarchy has been updated into input category hierarchy
				UPDATE A SET A.ParentPimCategoryHierarchyId =(Select PimCategoryHierarchyId FROM #SplitedCategoryHierarchy X WHERE X.RowNumber = A.RowNumber -1 )
				FROM #SplitedCategoryHierarchy A 
		
				-- Updating new parent hierarchy has been updated newly added input category hierarchy into table ZnodePimCategoryHierarchy
				UPDATE ZnodePimCategoryHierarchy SET ParentPimCategoryHierarchyId = A.ParentPimCategoryHierarchyId
				FROM #SplitedCategoryHierarchy A WHERE ZnodePimCategoryHierarchy.PimCategoryHierarchyId = A.PimCategoryHierarchyId
				AND EXISTS(SELECT * FROM #InsertedPimCategoryHierarchy B WHERE A.PimCategoryHierarchyId = B.PimCategoryHierarchyId)
			END
			ELSE
			BEGIN
			
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '126', 'ParentCode / CategoryCode', ParentCode + case when isnull(ParentCode,'') <> '' then '/' else '' end + CategoryCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #HierarchyImportData AS ii
				WHERE ii.RowNumber = (SELECT TOP 1 RowId FROM #SplitedCategoryHierarchy where PimCategoryHierarchyId is null ORDER BY RowNumber DESC)

				DELETE FROM #SplitedCategoryHierarchy WHERE RowId IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )
				DELETE FROM #HierarchyImportData WHERE RowNumber IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )

				--Delete the category hierarchy and its child category 
				DECLARE @PimCategoryHierarchyId INT
				SET @PimCategoryHierarchyId = (SELECT TOP 1 PimCategoryHierarchyId FROM #SplitedCategoryHierarchy ORDER BY RowNumber DESC)
				EXECUTE [Znode_DeletePimCategoryHierarchy] @PimCategoryHierarchyId = @PimCategoryHierarchyId, @PimCatalogId = @PimCatalogId, @Status = 0
			END
		END

		SET @Cnt = @Cnt + 1 
	END

	DECLARE @FailedRecordCount BIGINT
	DECLARE @SuccessRecordCount BIGINT

	SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
	SELECT @SuccessRecordCount = COUNT(DISTINCT RowNumber) FROM #HierarchyImportData

	--Updating the import process status
	UPDATE ZnodeImportProcessLog
	SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
						WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
						WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
					END, 
		ProcessCompletedDate = getdate()
	WHERE ImportProcessLogId = @ImportProcessLogId;

	UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
	WHERE ImportProcessLogId = @ImportProcessLogId;

COMMIT TRAN A;
END TRY
BEGIN CATCH
ROLLBACK TRAN A;

	SET @Status = 0;
	SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

	DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCatalogCategoryHierarchyAssociation @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(200));


	---Import process updating fail due to database error
	UPDATE ZnodeImportProcessLog
	SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
	WHERE ImportProcessLogId = @ImportProcessLogId;

	---Loging error for Import process due to database error
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

	--Updating total and fail record count
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
	TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
	WHERE ImportProcessLogId = @ImportProcessLogId;

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_ImportCatalogCategoryHierarchyAssociation',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
		
		
END CATCH;
END;

GO

UPDATE ZnodePimAttributeValidation SET Name = 1
WHERE PimAttributeId = (SELECT TOP 1 PimAttributeId FROM ZnodePimAttribute WHERE AttributeCode = 'DisplayOrderCategory')
and InputValidationId = (select top 1 InputValidationId from ZnodeAttributeInputValidation where Name = 'MinNumber'
and AttributeTypeId = (select top 1  AttributeTypeId from ZnodeAttributeType WHERE AttributeTypeName = 'Number'))

UPDATE ZnodePimAttributeValidation SET Name = 99999
WHERE PimAttributeId = (SELECT TOP 1 PimAttributeId FROM ZnodePimAttribute WHERE AttributeCode = 'DisplayOrderCategory')
and InputValidationId = (select top 1 InputValidationId from ZnodeAttributeInputValidation where Name = 'MaxNumber'
and AttributeTypeId = (select top 1 AttributeTypeId from ZnodeAttributeType WHERE AttributeTypeName = 'Number'))

GO

UPDATE ZnodeApplicationSetting
SET Setting ='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>OmsTemplateId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>TemplateName</name><headertext>Saved Cart Name</headertext><width>0</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl>/SavedCart/EditSavedCartItem</islinkactionurl><islinkparamfield>omsTemplateId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>Items</name><headertext>Items</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>z-items</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>CreatedDate</name><headertext>Created Date</headertext><width>30</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>ModifiedDate</name><headertext>Modified Date</headertext><width>30</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>Edit|Orders|Delete</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|MoveToCart|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/SavedCart/EditSavedCartItem|/SavedCart/AddProductToCartForSaveCart|/SavedCart/DeleteSavedCartTemplate</manageactionurl><manageparamfield>omsTemplateId|omsTemplateId|omsTemplateId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
WHERE ItemName='ZnodeSavedCart'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportPimProductData')
	DROP PROC Znode_ImportPimProductData
GO



CREATE PROCEDURE [dbo].[Znode_ImportPimProductData]
(   @TableName          VARCHAR(200),
    @NewGUID            NVARCHAR(200),
    @TemplateId         NVARCHAR(200),
    @ImportProcessLogId INT,
    @UserId             INT,
    @LocaleId           INT,
    @DefaultFamilyId    INT)
AS
    
	/*
      Summary : Finally Import data into ZnodePimProduct, ZnodePimAttributeValue and ZnodePimAttributeValueLocale Table 
      Process : Flat global temporary table will split into cloumn wise and associted with Znode Attributecodes,
    		      Create group of product with their attribute code and values and inserted one by one products. 	   
    
      SourceColumnName : CSV file column headers
      TargetColumnName : Attributecode from ZnodePimAttribute Table 

	 ***  Need to log error if transaction failed during insertion of records into table.
    */

     BEGIN
		 SET NOCOUNT ON
         BEGIN TRY
             BEGIN TRAN ImportProducts;
             DECLARE @SQLQuery NVARCHAR(MAX);
			 DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
             DECLARE @AttributeTypeName NVARCHAR(10), @AttributeCode NVARCHAR(300), @AttributeId INT, @IsRequired BIT, @SourceColumnName NVARCHAR(600), @PimAttributeFamilyId INT, @NewProductId INT, @PimAttributeValueId INT, @status BIT= 0; 
             --Declare error Log Table 

			
			 DECLARE @FamilyAttributeDetail TABLE
			 ( 
				PimAttributeId int, AttributeTypeName varchar(300), AttributeCode varchar(300), SourceColumnName nvarchar(600), IsRequired bit, PimAttributeFamilyId int
			 );
             IF @DefaultFamilyId = 0
                 BEGIN
					INSERT INTO @FamilyAttributeDetail( PimAttributeId, AttributeTypeName, AttributeCode, SourceColumnName, IsRequired, PimAttributeFamilyId )
					--Call Process to insert data of defeult family with cource column name and target column name 
					EXEC Znode_ImportGetTemplateDetails @TemplateId = @TemplateId, @IsValidationRules = 0, @IsIncludeRespectiveFamily = 1,@DefaultFamilyId = @DefaultFamilyId;
                    UPDATE @FamilyAttributeDetail SET PimAttributeFamilyId = DBO.Fn_GetCategoryDefaultFamilyId();

					---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;
             ELSE
                 BEGIN
                     INSERT INTO @FamilyAttributeDetail(PimAttributeId,AttributeTypeName,AttributeCode,SourceColumnName,IsRequired,PimAttributeFamilyId)
                     --Call Process to insert data of defeult family with cource column name and target column name 
                     EXEC Znode_ImportGetTemplateDetails @TemplateId = @TemplateId,@IsValidationRules = 0,@IsIncludeRespectiveFamily = 1,@DefaultFamilyId = @DefaultFamilyId;

					 ---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;  
				
            -- Retrive PimProductId on the basis of SKU for update product 
			SET @SQLQuery = 'UPDATE tlb SET tlb.PimProductId = ZPAV.PimProductId 
							FROM ZnodePimAttributeValue AS ZPAV INNER JOIN ZnodePimAttributeValueLocale AS ZPAVL ON 
							(ZPAVL.PimAttributeValueId = ZPAV.PimAttributeValueId) 
							INNER JOIN [dbo].[ZnodePimAttribute] ZPA on ZPAV.PimAttributeId = ZPA.PimAttributeId AND ZPA.AttributeCode= ''SKU'' 
							INNER JOIN '+@TableName+' tlb ON ZPAVL.AttributeValue = ltrim(rtrim(tlb.SKU)) ';
			EXEC sys.sp_sqlexec	@SQLQuery	
			
			SET @SQLQuery='
				INSERT INTO ZnodeImportLog( ErrorDescription,ColumnName, Data, GUID,RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT ''135'',''SKU'', SKU, '''+@NewGUId+''',RowNumber, '+cast(@UserId as varchar(10))+', getdate(), '+cast(@UserId as varchar(10))+', getdate(), '+cast(@ImportProcessLogId as varchar(10))+'
				FROM '+@TableName +' WHERE LEN(SKU)>600';
				EXEC sys.sp_sqlexec @SQLQuery;

				DELETE FROM ZnodeImportLog 
				WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
				 	
					
             --Read all attribute details with their datatype 
			 IF NOT EXISTS(SELECT TOP 1 1 FROM INFORMATION_SCHEMA.TABLES WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#DefaultAttributeValue')
				BEGIN
					   CREATE TABLE #DefaultAttributeValue (AttributeTypeName  VARCHAR(300),PimAttributeDefaultValueId INT,PimAttributeId INT,
					   AttributeDefaultValueCode  VARCHAR(100));
					 
					INSERT INTO #DefaultAttributeValue(AttributeTypeName,PimAttributeDefaultValueId,PimAttributeId,AttributeDefaultValueCode)
					--Call Process to insert default data value 
					EXEC Znode_ImportGetPimAttributeDefaultValue;
				END;
             ELSE
                BEGIN
                    DROP TABLE #DefaultAttributeValue;
                END;
             EXEC sys.sp_sqlexec
                  @SQLQuery;
       
			DECLARE @PimProductDetail TABLE 
			 (
			      
				  PimAttributeId INT, PimAttributeFamilyId INT,ProductAttributeCode VARCHAR(300) NULL,
				  ProductAttributeDefaultValueId INT NULL,PimAttributeValueId  INT NULL,LocaleId INT,
				  PimProductId INT NULL,AttributeValue NVARCHAR(MAX) NULL,AssociatedProducts NVARCHAR(4000) NULL,ConfigureAttributeIds VARCHAR(2000) NULL,
				  ConfigureFamilyIds VARCHAR(2000) NULL,RowNumber INT  
                );

		-- Update Record count in log 
       DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
		EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount OUTPUT
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- End

			
             -- Column wise split data from source table ( global temporary table ) and inserted into temporary table variable @PimProductDetail
             -- Add PimAttributeDefaultValue 
             DECLARE Cr_AttributeDetails CURSOR LOCAL FAST_FORWARD
             FOR SELECT PimAttributeId,AttributeTypeName,AttributeCode,IsRequired,SourceColumnName,PimAttributeFamilyId FROM @FamilyAttributeDetail  WHERE ISNULL(SourceColumnName, '') <> '';
             OPEN Cr_AttributeDetails;
             FETCH NEXT FROM Cr_AttributeDetails INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @PimAttributeFamilyId;
             WHILE @@FETCH_STATUS = 0
                 BEGIN
                    SET @NewProductId = 0;
                    SET @SQLQuery = ' SELECT '''+CONVERT(VARCHAR(100), @PimAttributeFamilyId)+''' PimAttributeFamilyId , PimProductId PimProductId,'''+'['+@AttributeCode+']'+''' ProductAttributeCode ,'''+CONVERT(VARCHAR(100), @AttributeId)+''' AttributeId ,
									(SELECT TOP 1  PimAttributeDefaultValueId FROM #DefaultAttributeValue Where PimAttributeId =  '
									+ CONVERT(VARCHAR(100), @AttributeId)+'AND  AttributeDefaultValueCode = TN.['+@SourceColumnName+'] ) PimAttributeDefaultValueId ,['
									+ @SourceColumnName+'],'+CONVERT(VARCHAR(100), @LocaleId)+'LocaleId
								, RowNumber FROM '+@TableName+' TN';
								print @SQLQuery
                    INSERT INTO @PimProductDetail( PimAttributeFamilyId, PimProductId,ProductAttributeCode, PimAttributeId, ProductAttributeDefaultValueId, AttributeValue, LocaleId, RowNumber )
					
					EXEC sys.sp_sqlexec @SQLQuery;
                    FETCH NEXT FROM Cr_AttributeDetails INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @PimAttributeFamilyId;
                 END;
             CLOSE Cr_AttributeDetails;
             DEALLOCATE Cr_AttributeDetails;
			 
			
			 if object_id('tempdb..#PimProductDetail1') is not null
				drop table #PimProductDetail1

			 Select * into #PimProductDetail1 from @PimProductDetail

			 UPDATE a 
			 SET ConfigureAttributeIds =  SUBSTRING((SELECT ','+CAST(c.PimAttributeId As VARCHAR(100)) 
			 FROM #PimProductDetail1 c 
			 INNER JOIN ZnodePimAttribute b ON (b.PimAttributeId = c.PimAttributeId)
			 WHERE IsConfigurable =1  AND c.RowNumber = a.RowNumber  FOR XML PATH('')),2,4000) 
			 FROM #PimProductDetail1 a 
			WHERE EXISTS (SELECT TOP 1 1 FROM #PimProductDetail1 ab  WHERE ab.RowNumber = a.RowNumber AND	ab.ProductAttributeCode = '[ProductType]' 
			 AND ab.AttributeValue = 'ConfigurableProduct' )
				
             -- In case of Yes/No : If value is not TRUE OR  1 then it will be  False else True
			 --If default Value set not need of hard code for IsActive
			 UPDATE ppdti SET ppdti.AttributeValue = CASE WHEN Upper(ISNULL(ppdti.AttributeValue, '')) in ( 'TRUE','1')  THEN 'true'  ELSE 'false' END FROM #PimProductDetail1 ppdti
                INNER JOIN #DefaultAttributeValue dav ON ppdti.PimAttributeId = dav.PimAttributeId WHERE   dav.AttributeTypeName = 'Yes/No';
            
		
		-----------Added Performance patch 
		DECLARE @PublishStateIdForDraft INT= [dbo].[Fn_GetPublishStateIdForDraftState]();
		DECLARE @PimDefaultFamily INT= dbo.Fn_GetDefaultPimProductFamilyId();
        DECLARE @pimSkuAttributeId VARCHAR(50)= [dbo].[Fn_GetProductSKUAttributeId]();
        DECLARE @PimIsDownlodableAttributeId VARCHAR(50)= [dbo].[Fn_GetIsDownloadableAttributeId]();
        DECLARE @PublishStateIdForNotPublished INT= [dbo].[Fn_GetPublishStateIdForForNotPublishedState]();

		DELETE FROM #PimProductDetail1 WHERE RTRIM(LTRIM(ISNULL(AttributeValue, ''))) = '';
        
		CREATE INDEX Inx_PimProductDetail_Bulk1 ON #PimProductDetail1(RowNumber);

        ------------------------------------Bulk Row Process
        DECLARE @MaxCount INT, @MinRow INT, @MaxRow INT, @Rows numeric(10,2);
        ---- Count of total rows for import
		SELECT @MaxCount = COUNT(*) FROM #PimProductDetail1;
		
		---- Count of rows in loop for import
		SELECT @Rows = (select top 1 FeatureValues from ZnodeGlobalSetting where FeatureName = 'ProductImportBulk')  --ceiling(@MaxCount/100.0)
        
		SELECT @MaxCount = CEILING(@MaxCount / @Rows);

        IF OBJECT_ID('tempdb..#Temp_ImportLoop') IS NOT NULL
            DROP TABLE #Temp_ImportLoop;
        
		---- To get the min and max rows for import in loop
		;WITH cte AS 
		(
			SELECT RowId = 1, 
				   MinRow = 1, 
                   MaxRow = cast(@Rows as int)
            UNION ALL
            SELECT RowId + 1, 
                   MinRow + cast(@Rows as int), 
                   MaxRow + cast(@Rows as int)
            FROM cte
            WHERE RowId + 1 <= @MaxCount
		)
        SELECT RowId, MinRow, MaxRow
        INTO #Temp_ImportLoop
        FROM cte
		option (maxrecursion 0);

        --while @MaxCount <= @minRow
        DECLARE cur_BulkData CURSOR LOCAL FAST_FORWARD
        FOR SELECT MinRow, MaxRow FROM #Temp_ImportLoop;

        OPEN cur_BulkData;
        FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow;

        WHILE @@FETCH_STATUS = 0
        BEGIN
		
		BEGIN TRAN ImportProducts;

			if object_id ('tempdb..#PimProductDetail_Bulk_Process')is not null
					drop table tempdb..#PimProductDetail_Bulk_Process

			CREATE TABLE #PimProductDetail_Bulk_Process
			([PimAttributeId]                 [INT] NULL, 
				[PimAttributeFamilyId]           [INT] NULL, 
				[ProductAttributeCode]           [VARCHAR](300) NULL, 
				[ProductAttributeDefaultValueId] [INT] NULL, 
				[PimAttributeValueId]            [INT] NULL, 
				[LocaleId]                       [INT] NULL, 
				[PimProductId]                   [INT] NULL, 
				[AttributeValue]                 [NVARCHAR](MAX) NULL, 
				[AssociatedProducts]             [NVARCHAR](4000) NULL, 
				[ConfigureAttributeIds]          [VARCHAR](2000) NULL, 
				[ConfigureFamilyIds]             [VARCHAR](2000) NULL, 
				[RowNumber]                      [INT] NULL, 
				SKU1                             VARCHAR(MAX),
				Id Int Identity(1,1)Primary Key
			);

			CREATE INDEX Inx_PimProductDetail_Bulk_Process ON #PimProductDetail_Bulk_Process(ProductAttributeCode, PimProductId);
			CREATE INDEX Inx_PimProductDetail_Bulk_Process1 ON #PimProductDetail_Bulk_Process(RowNumber);
			CREATE INDEX Inx_PimProductDetail_Bulk_Process2 ON #PimProductDetail_Bulk_Process(ProductAttributeCode)
			CREATE INDEX Inx_PimProductDetail_Bulk_Process3 ON #PimProductDetail_Bulk_Process(PimAttributeId, PimProductId);

			---- Insert rows for import in bulk
            INSERT INTO #PimProductDetail_Bulk_Process
            ([PimAttributeId], 
                [PimAttributeFamilyId], 
                [ProductAttributeCode], 
                [ProductAttributeDefaultValueId], 
                [PimAttributeValueId], 
                [LocaleId], 
                [PimProductId], 
                [AttributeValue], 
                [AssociatedProducts], 
                [ConfigureAttributeIds], 
                [ConfigureFamilyIds], 
                [RowNumber]
            )
            SELECT [PimAttributeId], 
                    [PimAttributeFamilyId], 
                    [ProductAttributeCode], 
                    [ProductAttributeDefaultValueId], 
                    [PimAttributeValueId], 
                    [LocaleId], 
                    [PimProductId], 
                    ltrim(rtrim([AttributeValue])), 
                    [AssociatedProducts], 
                    [ConfigureAttributeIds], 
                    [ConfigureFamilyIds], 
                    [RowNumber]
            FROM #PimProductDetail1 a
            WHERE a.[RowNumber] BETWEEN @MinRow AND @MaxRow;

			--select * from @PimProductDetail

			--select * from #PimProductDetail1



            ---------------------------Start Importing 
			if object_id ('tempdb..#TBL_DefaultAttributeId')is not null
				drop table #TBL_DefaultAttributeId

			if object_id ('tempdb..#TBL_MediaAttributeId')is not null
				drop table #TBL_MediaAttributeId

			if object_id ('tempdb..#TBL_TextAreaAttributeId')is not null
				drop table #TBL_TextAreaAttributeId

			if object_id ('tempdb..#TBL_MediaAttributeValue')is not null
				drop table #TBL_MediaAttributeValue

			if object_id ('tempdb..#TBL_DefaultAttributeValue')is not null
				drop table #TBL_DefaultAttributeValue

			if object_id ('tempdb..#ZnodePimAttributeValue')is not null
				drop table #ZnodePimAttributeValue

				
            CREATE TABLE #TBL_DefaultAttributeId ( PimAttributeId INT PRIMARY KEY, AttributeCode  VARCHAR(600) );

            CREATE TABLE #TBL_MediaAttributeId ( PimAttributeId INT PRIMARY KEY, AttributeCode  VARCHAR(600) );

            CREATE TABLE #TBL_TextAreaAttributeId ( PimAttributeId INT PRIMARY KEY, AttributeCode  VARCHAR(600) );
           
		    CREATE TABLE #TBL_MediaAttributeValue ( PimAttributeValueId INT, LocaleId INT, AttributeValue VARCHAR(300), MediaId INT );

            CREATE TABLE #TBL_DefaultAttributeValue ( PimAttributeValueId INT, LocaleId INT, AttributeValue INT );

            CREATE TABLE #ZnodePimAttributeValue (PimAttributeValueId  INT, PimAttributeFamilyId INT, PimAttributeId INT, PimProductId INT );

            DECLARE @ConfigureFamilyId VARCHAR(4000);

            INSERT INTO #TBL_DefaultAttributeId ( PimAttributeId, AttributeCode )
            SELECT PimAttributeId, AttributeCode
            FROM [dbo].[Fn_GetDefaultAttributeId]();

			INSERT INTO #TBL_MediaAttributeId (PimAttributeId, AttributeCode )
			SELECT PimAttributeId, AttributeCode
			FROM [dbo].[Fn_GetProductMediaAttributeId]();

            INSERT INTO #TBL_TextAreaAttributeId ( PimAttributeId, AttributeCode )
            SELECT PimAttributeId, AttributeCode
            FROM [dbo].[Fn_GetTextAreaAttributeId]();

            SELECT TOP 1 @PimAttributeFamilyId = PimAttributeFamilyId FROM #PimProductDetail_Bulk_Process;

			if object_id ('tempdb..#cte')is not null
				drop table #cte

            SELECT AttributeValue AS SKU, RowNumber
            INTO #cte
            FROM #PimProductDetail_Bulk_Process
            WHERE ProductAttributeCode = '[SKU]';
              
			

            CREATE INDEX Inx_cte_RowNumber ON #cte(RowNumber);
            UPDATE a SET a.SKU1 = B.SKU
            FROM #PimProductDetail_Bulk_Process a
            INNER JOIN #cte b ON a.RowNumber = b.RowNumber;

		
			
            SELECT TOP 1 @LocaleId = LocaleId FROM #PimProductDetail_Bulk_Process;

            ----Update ZNodePimProduct 
            UPDATE ZNodePimProduct
            SET PimAttributeFamilyId = DP.PimAttributeFamilyId, 
                PublishStateId = @PublishStateIdForDraft, 
                ModifiedBy = @UserId, 
                ModifiedDate = @GetDate
            FROM ZNodePimProduct ZPP
            INNER JOIN #PimProductDetail_Bulk_Process DP ON ZPP.PimProductId = DP.PimProductId;
      
			if object_id ('tempdb..#ZnodePimProduct')is not null
				drop table #ZnodePimProduct

			CREATE TABLE #ZnodePimProduct(PimProductId INT,ExternalId INT  Primary key)

			--create index Idx_ZnodePimProduct_ExternalId on #ZnodePimProduct(ExternalId)


			 

			----Insert into ZNodePimProduct 
            INSERT INTO ZnodePimProduct
            (PimAttributeFamilyId, 
                ExternalId, 
                CreatedBy, 
                CreatedDate, 
                ModifiedBy, 
                ModifiedDate, 
                PublishStateId
            )
			output inserted.PimProductId, inserted.ExternalId into #ZnodePimProduct(PimProductId,ExternalId)
            SELECT PimAttributeFamilyId, 
                    RowNumber, 
                    @UserId, 
                    @GetDate, 
                    @UserId, 
                    @GetDate, 
                    @PublishStateIdForNotPublished
            FROM #PimProductDetail_Bulk_Process
            WHERE ProductAttributeCode = '[SKU]'
            AND PimProductId IS NULL;
            
			----Update newly created productIds
            UPDATE a SET a.PimProductId = b.PimProductId
            FROM #PimProductDetail_Bulk_Process a
            INNER JOIN #ZnodePimProduct b ON a.RowNumber = b.ExternalId;

            ----Insert Downloadable products into ZnodePimDownloadableProduct
            INSERT INTO ZnodePimDownloadableProduct (SKU, ProductName, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate )
            SELECT PDSKU.AttributeValue, PDProdName.AttributeValue, @UserId, @GetDate, @UserId, @GetDate
            FROM #PimProductDetail_Bulk_Process PDSKU
            INNER JOIN #PimProductDetail_Bulk_Process PDProdName ON PDProdName.RowNumber = PDSKU.RowNumber
            INNER JOIN #PimProductDetail_Bulk_Process PDDownload ON PDDownload.RowNumber = PDSKU.RowNumber
            WHERE PDSKU.ProductAttributeCode = @pimSkuAttributeId
            AND PDProdName.ProductAttributeCode = '[SKU]'
            AND PDDownload.PimAttributeId = @PimIsDownlodableAttributeId
            AND PDDownload.AttributeValue = 'true'
            AND NOT EXISTS ( SELECT TOP 1 1 FROM ZnodePimDownloadableProduct WHERE ZnodePimDownloadableProduct.SKU = PDSKU.AttributeValue );

            ---- update ZnodePimAttributeValue : attribute data for Product
            UPDATE TARGET
            SET TARGET.PimAttributeFamilyId = CASE
                                                    WHEN Source.PimAttributeFamilyId = 0
                                                    THEN NULL
                                                    ELSE Source.PimAttributeFamilyId
                                                END, 
                    TARGET.ModifiedBy = @UserId, 
                    TARGET.ModifiedDate = @GetDate, 
                    TARGET.PimProductId = SOURCE.PimProductId
            OUTPUT INSERTED.PimAttributeValueId, 
                    INSERTED.PimAttributeFamilyId, 
                    INSERTED.PimAttributeId, 
                    INSERTED.PimProductId
                    INTO #ZnodePimAttributeValue
            FROM ZnodePimAttributeValue TARGET
            INNER JOIN #PimProductDetail_Bulk_Process SOURCE ON TARGET.PimProductId = SOURCE.PimProductId AND TARGET.PimAttributeId = SOURCE.PimAttributeId;
             
			---- Inserting attribute data for Product 
			INSERT INTO ZnodePimAttributeValue 
			( 
				PimAttributeFamilyId, 
				PimProductId, PimAttributeId, 
				PimAttributeDefaultValueId, 
				CreatedBy, 
				CreatedDate, 
				ModifiedBy, 
				ModifiedDate 
			)
            OUTPUT INSERTED.PimAttributeValueId, 
                    INSERTED.PimAttributeFamilyId, 
                    INSERTED.PimAttributeId, 
                    INSERTED.PimProductId
                    INTO #ZnodePimAttributeValue
            SELECT 
				CASE
                    WHEN Source.PimAttributeFamilyId = 0
                    THEN @PimDefaultFamily
                    ELSE Source.PimAttributeFamilyId
                END, 
                SOURCE.PimProductId, 
                ISNULL(SOURCE.PimAttributeId, 0),
                CASE
                    WHEN SOURCE.ProductAttributeDefaultValueId = 0
                    THEN NULL
                    ELSE SOURCE.ProductAttributeDefaultValueId
                END, 
                @UserId, 
                @GetDate, 
                @UserId, 
                @GetDate
            FROM #PimProductDetail_Bulk_Process SOURCE
            WHERE NOT EXISTS
            (
                SELECT *
                FROM ZnodePimAttributeValue TARGET
                WHERE TARGET.PimProductId = SOURCE.PimProductId
                        AND TARGET.PimAttributeId = SOURCE.PimAttributeId
            );

            -------------------------
			if object_id ('tempdb..#MediaData')is not null
				drop table #MediaData

            CREATE TABLE #MediaData (MediaId INT, PimProductId INT, PimAttributeId INT, PimAttributeFamilyId INT, LocaleId INT );

			---- Get Product Media Data
            INSERT INTO #MediaData ( MediaId , PimProductId , PimAttributeId , PimAttributeFamilyId , LocaleId )
            SELECT SP.Item, a.PimProductId, a.PimAttributeId, PimAttributeFamilyId, a.LocaleId
            FROM #PimProductDetail_Bulk_Process a
            INNER JOIN #TBL_MediaAttributeId c ON(c.PimAttributeId = a.PimAttributeId)
            CROSS APPLY dbo.split(a.AttributeValue, ',') SP;

			---- Get product media attribute data
            INSERT INTO #TBL_MediaAttributeValue ( PimAttributeValueId, LocaleId, AttributeValue, MediaId )
            SELECT a.PimAttributeValueId, b.LocaleId, zm.Path AttributeValue, ZM.MediaId
            FROM #ZnodePimAttributeValue AS a
            INNER JOIN #MediaData AS b ON(a.PimAttributeId = b.PimAttributeId
                                            AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0)
                                            AND a.PimProductId = b.PimProductId)
            INNER JOIN ZnodeMedia ZM ON(b.MediaId = ZM.MediaId);
     
			---- Deleting product media attribute
            DELETE FROM ZnodePimProductAttributeMedia
            WHERE EXISTS
            (
                SELECT TOP 1 1
                FROM #TBL_MediaAttributeValue TBLM
                WHERE ZnodePimProductAttributeMedia.PimAttributeValueId = TBLM.PimAttributeValueId
                        AND TBLM.MediaId <> ZnodePimProductAttributeMedia.MediaId
                        AND ZnodePimProductAttributeMedia.Localeid = @LocaleId
            );

            ---- update ZnodePimProductAttributeMedia : attribute data for Product
            UPDATE TARGET
                SET 
                    TARGET.MediaPath = SOURCE.AttributeValue, 
                    TARGET.MediaId = SOURCE.MediaId, 
                    TARGET.ModifiedBy = @UserId, 
                    TARGET.ModifiedDate = @GetDate
            FROM ZnodePimProductAttributeMedia TARGET
            INNER JOIN #TBL_MediaAttributeValue SOURCE ON TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                                                        AND TARGET.MediaPAth = SOURCE.AttributeValue
                                                        AND TARGET.LocaleId = SOURCE.LocaleId;
    
            ---- inserting Media attribute data for Product
            INSERT INTO ZnodePimProductAttributeMedia 
			( 
				PimAttributeValueId, 
				LocaleId, MediaPath, 
				MediaId, 
				CreatedBy, 
				CreatedDate, 
				ModifiedBy, 
                ModifiedDate
            )
            SELECT SOURCE.PimAttributeValueId, 
                    SOURCE.LocaleId, 
                    SOURCE.AttributeValue, 
                    SOURCE.MediaId, 
                    @UserId, 
                    @GetDate, 
                    @UserId, 
                    @GetDate
            FROM #TBL_MediaAttributeValue SOURCE
            WHERE NOT EXISTS
            (
                SELECT *
                FROM ZnodePimProductAttributeMedia TARGET
                WHERE TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                        AND TARGET.MediaPAth = SOURCE.AttributeValue
                        AND TARGET.LocaleId = SOURCE.LocaleId
            );

            --------------------------
			if object_id ('tempdb..#Cte_TextAreaAttributeValue')is not null
				drop table #Cte_TextAreaAttributeValue

			---- Getting text area data in temp #Cte_TextAreaAttributeValue
            SELECT a.PimAttributeValueId, 
                    b.LocaleId, 
                    AttributeValue
            INTO #Cte_TextAreaAttributeValue
            FROM #ZnodePimAttributeValue AS a
            INNER JOIN #PimProductDetail_Bulk_Process AS b ON(a.PimAttributeId = b.PimAttributeId
                                                            AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0)
                                                            AND a.PimProductId = b.PimProductId)
            INNER JOIN #TBL_TextAreaAttributeId c ON(c.PimAttributeId = b.PimAttributeId);

            ---- update ZnodePimProductAttributeTextAreaValue : attribute data for Product
            UPDATE TARGET
            SET TARGET.AttributeValue = SOURCE.AttributeValue, 
                TARGET.CreatedBy = @UserId, 
                TARGET.ModifiedBy = @UserId, 
                TARGET.ModifiedDate = @GetDate
            FROM ZnodePimProductAttributeTextAreaValue TARGET
            INNER JOIN #Cte_TextAreaAttributeValue SOURCE ON TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                                                                      AND TARGET.LocaleId = SOURCE.LocaleId;

            ---- inserting TextAreaValue attribute data for Product
            INSERT INTO ZnodePimProductAttributeTextAreaValue
            (
				PimAttributeValueId, 
                LocaleId, 
                AttributeValue, 
                CreatedBy, 
                CreatedDate, 
                ModifiedBy, 
                ModifiedDate
            )
            SELECT SOURCE.PimAttributeValueId, 
                    SOURCE.LocaleId, 
                    SOURCE.AttributeValue, 
                    @UserId, 
                    @GetDate, 
                    @UserId, 
                    @GetDate
            FROM #Cte_TextAreaAttributeValue SOURCE
            WHERE NOT EXISTS
            (
                SELECT *
                FROM ZnodePimProductAttributeTextAreaValue TARGET
                WHERE TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                        AND TARGET.LocaleId = SOURCE.LocaleId
            );
           
		    ---- Getting attribute default values for product
            INSERT INTO #TBL_DefaultAttributeValue ( PimAttributeValueId, LocaleId, AttributeValue )
            SELECT a.PimAttributeValueId, b.LocaleId, d.PimAttributeDefaultValueId AttributeValue
            FROM #ZnodePimAttributeValue AS a
            INNER JOIN #PimProductDetail_Bulk_Process AS b ON(a.PimAttributeId = b.PimAttributeId
                                                                AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0)
                                                                AND a.PimProductId = b.PimProductId)
            INNER JOIN #TBL_DefaultAttributeId c ON(c.PimAttributeId = b.PimAttributeId)
            CROSS APPLY dbo.split(b.AttributeValue, ',') SP
            INNER JOIN ZnodePimAttributeDefaultValue d ON d.PimAttributeId = b.PimAttributeId
                                                            AND SP.Item = d.AttributeDefaultValueCode;
			---- Deleting prodyuct attribute default value
            DELETE FROM ZnodePimProductAttributeDefaultValue
            WHERE EXISTS
            (
                SELECT TOP 1 1
                FROM #TBL_DefaultAttributeValue TBLAV
                WHERE TBLAV.PimAttributeValueId = ZnodePimProductAttributeDefaultValue.PimAttributeValueId
                        AND TBLAV.AttributeValue <> ZnodePimProductAttributeDefaultValue.PimAttributeDefaultValueId
                        AND ZnodePimProductAttributeDefaultValue.LocaleId = @LocaleId
            );

			---- update ZnodePimProductAttributeDefaultValue : attribute data for Product
			UPDATE TARGET
			SET TARGET.PimAttributeDefaultValueId = SOURCE.AttributeValue, 
				TARGET.ModifiedBy = @UserId, 
				TARGET.ModifiedDate = @GetDate
			FROM ZnodePimProductAttributeDefaultValue TARGET
					INNER JOIN #TBL_DefaultAttributeValue SOURCE ON TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
																	AND TARGET.PimAttributeDefaultValueId = SOURCE.AttributeValue
																	AND TARGET.LocaleId = SOURCE.LocaleId;

            ---- insert ZnodePimProductAttributeDefaultValue : attribute data for Product
            INSERT INTO ZnodePimProductAttributeDefaultValue
            (
				PimAttributeValueId, 
                LocaleId, 
                PimAttributeDefaultValueId, 
                CreatedBy, 
                CreatedDate, 
                ModifiedBy, 
                ModifiedDate
            )
            SELECT 
				SOURCE.PimAttributeValueId, 
                SOURCE.LocaleId, 
                SOURCE.AttributeValue, 
                @UserId, 
                @GetDate, 
                @UserId, 
                @GetDate
            FROM #TBL_DefaultAttributeValue SOURCE
            WHERE NOT EXISTS
            (
                SELECT *
                FROM ZnodePimProductAttributeDefaultValue TARGET
                WHERE TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                        AND TARGET.PimAttributeDefaultValueId = SOURCE.AttributeValue
                        AND TARGET.LocaleId = SOURCE.LocaleId
            );
               

            IF OBJECT_ID('tempdb..#cte_ZnodePimAttributeValue') IS NOT NULL
                DROP TABLE #cte_ZnodePimAttributeValue;

			CREATE TABLE #cte_ZnodePimAttributeValue(PimAttributeValueId int, LocaleId int, AttributeValue nvarchar(max))

			CREATE INDEX Idx_cte_ZnodePimAttributeValue on #cte_ZnodePimAttributeValue(PimAttributeValueId, LocaleId)

			INSERT INTO #cte_ZnodePimAttributeValue (PimAttributeValueId, LocaleId, AttributeValue)
            SELECT a.PimAttributeValueId, b.LocaleId,AttributeValue                
            FROM #ZnodePimAttributeValue AS a
            INNER JOIN #PimProductDetail_Bulk_Process AS b ON(a.PimAttributeId = b.PimAttributeId
                                                                AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0)
                                                                AND a.PimProductId = b.PimProductId)
            WHERE NOT EXISTS ( SELECT TOP 1 1 FROM #TBL_DefaultAttributeId TBLDA WHERE TBLDA.PimAttributeId = b.PimAttributeId )
            AND NOT EXISTS ( SELECT TOP 1 1 FROM #TBL_MediaAttributeId TBLMA WHERE TBLMA.PimAttributeId = b.PimAttributeId )
            AND NOT EXISTS ( SELECT TOP 1 1 FROM #TBL_TextAreaAttributeId TBLTA WHERE TBLTA.PimAttributeId = b.PimAttributeId );

            ---- update ZnodePimAttributeValueLocale : attribute data for Product
            UPDATE TARGET
            SET TARGET.AttributeValue = SOURCE.AttributeValue, 
                TARGET.ModifiedBy = @UserId, 
                TARGET.ModifiedDate = @GetDate
            FROM ZnodePimAttributeValueLocale TARGET
            INNER JOIN #cte_ZnodePimAttributeValue SOURCE ON TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                                                           AND TARGET.LocaleId = SOURCE.LocaleId;

            ---- inserting AttributeDefaultValue : attribute data for Product
            INSERT INTO ZnodePimAttributeValueLocale
            (
				PimAttributeValueId, 
                LocaleId, 
                AttributeValue, 
                CreatedBy, 
                CreatedDate, 
                ModifiedBy, 
                ModifiedDate
            )
            SELECT 
				SOURCE.PimAttributeValueId, 
                SOURCE.LocaleId, 
                SOURCE.AttributeValue, 
                @UserId, 
                @GetDate, 
                @UserId, 
                @GetDate
            FROM #cte_ZnodePimAttributeValue SOURCE
            WHERE NOT EXISTS
            (
                SELECT *
                FROM ZnodePimAttributeValueLocale TARGET
                WHERE TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                        AND TARGET.LocaleId = SOURCE.LocaleId
            );

			---- Inserting configurable products into ZnodePimConfigureProductAttribute
            INSERT INTO [ZnodePimConfigureProductAttribute]
            (PimProductId, 
                PimFamilyId, 
                PimAttributeId, 
                CreatedBy, 
                CreatedDate, 
                ModifiedBy, 
                ModifiedDate
            )
            SELECT DISTINCT PD.PimProductId, 
                    NULL, 
                    q.PimAttributeId, 
                    @UserId, 
                    @GetDate, 
                    @UserId, 
                    @GetDate
            FROM #PimProductDetail_Bulk_Process PD
                CROSS APPLY dbo.Split([ConfigureAttributeIds], ',') AS b
                INNER JOIN ZnodePimAttribute AS q ON(q.PimAttributeId = b.Item)
            WHERE NOT EXISTS
            (
                SELECT TOP 1 1
                FROM ZnodePimConfigureProductAttribute RTR
                WHERE RTR.PimProductId = PD.PimProductId
                        AND RTR.PimAttributeId = q.PimAttributeId
            );


			COMMIT TRAN ImportProducts;

            FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow;
        END;
    CLOSE cur_BulkData;
    DEALLOCATE cur_BulkData;

	-----------Added Performance patch end

		---- Update family of Product in table ZnodePimConfigureProductAttribute 
		UPDATE ZnodePimConfigureProductAttribute
		SET PimFamilyId = b.PimAttributeFamilyId
		FROM ZnodePimConfigureProductAttribute a
				INNER JOIN ZnodePimProduct b ON a.PimProductId = b.PimProductId;

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

             COMMIT TRAN ImportProducts;


			 
	 DELETE FROM ZnodePimConfigureProductAttribute  
            WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePimAttributeValue  a WHERE a.PimProductId = ZnodePimConfigureProductAttribute.PimProductId
            AND a.PimAttributeID = ZnodePimConfigureProductAttribute.PimAttributeID )
            --AND EXISTS (SELECT TOP 1 1 FROM ZnodePimAttributeValue a 
            --INNER JOIN ZnodePimAttribute ty ON (ty.PimAttributeId = a.PimAttributeId)
            --INNER JOIN ZnodePimProductAttributeDefaultValue t ON (t.PimAttributeValueId = a.PimAttributeValueId )
            --INNER JOIN ZnodePimAttributeDefaultValue y ON (y.PimAttributeDefaultValueId = t.PimAttributeDefaultValueId)
            --INNER JOIN View_loadmanageProductInternal  TU ON (TU.AttributeCode = 'SKU' AND TU.PimProductId = a.PimProductId  )
            --WHERE ty.AttributeCode = 'ProductType' AND y.AttributeDefaultValueCode = 'ConfigurableProduct'
            --AND a.PimProductId = ZnodePimConfigureProductAttribute.PimProductId
            AND EXISTS (SELECT TOP 1 1 FROM #PimProductDetail1 TM WHERE TM.PimProductId = ZnodePimConfigureProductAttribute.PimProductId )
   
						
		----Delete simple products if inserted in table ZnodePimConfigureProductAttribute 
		DELETE FROM ZnodePimConfigureProductAttribute
		WHERE EXISTS
		(
			SELECT TOP 1 1
			FROM ZnodePimAttributeValue a
					INNER JOIN ZnodePimAttribute ty ON(ty.PimAttributeId = a.PimAttributeId)
					INNER JOIN ZnodePimProductAttributeDefaultValue t ON(t.PimAttributeValueId = a.PimAttributeValueId)
					INNER JOIN ZnodePimAttributeDefaultValue y ON(y.PimAttributeDefaultValueId = t.PimAttributeDefaultValueId)
			WHERE ty.AttributeCode = 'ProductType'
					AND y.AttributeDefaultValueCode = 'SimpleProduct'
					AND a.PimProductId = ZnodePimConfigureProductAttribute.PimProductId
		);

         END TRY
         BEGIN CATCH
		 ROLLBACK TRAN ImportProducts;

		

		  INSERT INTO ZnodeImportLog(ErrorDescription,ColumnName,Data,RowNumber,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
                 Select  46,ERROR_PROCEDURE(),ERROR_MESSAGE(),ERROR_LINE(),@newGUID,@UserId,@GetDate,@UserId,@GetDate, @ImportProcessLogId  
		
		SET @SQLQuery = ' Select @FailedRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
					EXEC	sp_executesql @SQLQuery , N'@FailedRecordCount BIGINT out' , @FailedRecordCount =@FailedRecordCount out
					--SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS  NULL AND  ImportProcessLogId = @ImportProcessLogId;
					SELECT @SuccessRecordCount = 0
									
					UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
					WHERE ImportProcessLogId = @ImportProcessLogId;

		 UPDATE ZnodeImportProcessLog
			SET 
				STATUS = dbo.Fn_GetImportStatus(3), 
				ProcessCompletedDate = GETDATE()
		WHERE ImportProcessLogId = @ImportProcessLogId;
             SELECT ERROR_MESSAGE(),ERROR_LINE(),ERROR_PROCEDURE();
            -- UPDATE ZnodeImportProcessLog SET Status = dbo.Fn_GetImportStatus(3), ProcessCompletedDate = @GetDate WHERE ImportProcessLogId = @ImportProcessLogId;
            -- ROLLBACK TRAN ImportProducts;
         END CATCH;
     END;

GO

Insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 135,'Text','Input must not exceed the maximum character limit of 600.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 135)

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodeEmailProvider')
BEGIN
	CREATE TABLE [dbo].[ZnodeEmailProvider](
	[EmailProviderId] [int] IDENTITY(1,1) NOT NULL,
	[ProviderCode] [nvarchar](300) NULL,
	[ProviderName] [nvarchar](300) NULL,
	[ClassName] [nvarchar](300) NULL,
	[CreatedBy] [int] NOT NULL,
	[CreatedDate] [datetime] NOT NULL,
	[ModifiedBy] [int] NOT NULL,
	[ModifiedDate] [datetime] NOT NULL,
	[Description] [nvarchar](max) NULL,
	CONSTRAINT [PK_ZnodeEmailProvider] PRIMARY KEY CLUSTERED (	[EmailProviderId] ASC)
) 
END

GO

INSERT [dbo].[ZnodeEmailProvider] ( [ProviderCode], [ProviderName], [ClassName], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [Description]) 
SELECT 'Klaviyo_Email', N'Klaviyo', N'KlaviyoProvider', 2,getdate(), 2, getdate() , N'Klaviyo_Email'
WHERE NOT EXISTS(SELECT * FROM [ZnodeEmailProvider] WHERE [ProviderCode] = 'Klaviyo_Email')

GO

UPDATE ZnodeApplicationSetting
SET Setting ='<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>OmsQuoteId</name>      <headertext>Checkbox</headertext>      <width>0</width>      <datatype>Int32</datatype>      <columntype>Int32</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>OmsQuoteId</name>      <headertext>Pending Order ID</headertext>      <width>0</width>      <datatype>Int32</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>y</isallowlink>      <islinkactionurl>/Account/UpdateAccountQuote</islinkactionurl>      <islinkparamfield>omsQuoteId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>UserName</name>      <headertext>Customer Name</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>AccountName</name>      <headertext>Account Name</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>StoreName</name>      <headertext>Store Name</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>OrderStatus</name>      <headertext>Pending Order Status</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>QuoteOrderTotal</name>      <headertext>Pending Order Amount</headertext>      <width>0</width>      <datatype>Decimal</datatype>      <columntype>Decimal</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>CreatedDate</name>      <headertext>Created Date</headertext>      <width>0</width>      <datatype>Date</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>9</id>      <name>CreatedByName</name>      <headertext>Created By</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>10</id>      <name>ModifiedByName</name>      <headertext>Modified By</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>11</id>      <name>PublishState</name>      <headertext>Publish Status</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>12</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>View|orders</format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>View|Convert to Order</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/Account/UpdateAccountQuote|/Quote/ConvertToOrder</manageactionurl>      <manageparamfield>omsQuoteId,orderStatus|omsQuoteId</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>13</id>      <name>AccountId</name>      <headertext>Account Id</headertext>      <width>0</width>      <datatype>Int32</datatype>      <columntype>Int32</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>14</id>      <name>IsConvertedToOrder</name>      <headertext>      </headertext>      <width>0</width>      <datatype>Boolean</datatype>      <columntype>Boolean</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>d-none</format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Is Converted To Order</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>IsConvertedToOrder</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
WHERE ItemName='ZnodeOmsQuote'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishAssociatedProductsJson')
	DROP PROC Znode_GetPublishAssociatedProductsJson
GO


CREATE PROCEDURE [dbo].[Znode_GetPublishAssociatedProductsJson]    
(       
     @PublishCatalogId VARCHAR(MAX) = '',    
     @PimProductId     TransferId Readonly,    
     @ProductType      VARCHAR(300) = 'BundleProduct',    
     @VersionId        INT          = 0,    
     @UserId           INT,    
     @PimCategoryHierarchyId int = 0,    
     @PublishStateId INT = 0  ,    
     @VersionIdString  VARCHAR(2000)= '',    
     @Status  BIT  Output,    
     @RevisionType Varchar(50) = ''    
)    
AS    
  /*    
    Summary : If PimcatalogId is provided then get all  Bundles / Group / Configurable product and  provide above mentioned data    
              If PimProductId is provided then get all Bundles / Group / Configurable if associated with given product id and provide above mentioned data    
       Input: @PublishCatalogId or @PimProductId    
       Output should be in XML format    
             Required o/p    
       <BundleProductEntity>    
       <ZnodeProductId></ZnodeProductId>    
       <ZnodeCatalogId></ZnodeCatalogId>    
       <AsscociadedZnodeProductIds></AsscociadedZnodeProductIds>    
       </BundleProductEntity>    
    Unit Testing     
    BundleProduct    
 DECLARE     
    EXEC [dbo].[Znode_GetPublishAssociatedProducts] @PublishCatalogId = 1  , @ProductType = 'BundleProduct' ,@userId = 2     
    EXEC [dbo].[Znode_GetPublishAssociatedProducts] @PublishCatalogId =2 , @ProductType = 'ConfigurableProduct',@userId = 2 ,@PimCategoryHierarchyId = 7     
    Group Product    
    EXEC [dbo].[Znode_GetPublishAssociatedProducts]  @PublishCatalogId ='2',@PimProductIdh =''  , @PimProducttType = 'GroupedProduct'    
    EXEC [dbo].[Znode_GetPublishAssociatedProducts]  @PublishCatalogId ='',@PimProductId ='200066'  , @PimProducttType = 'GroupedProduct'    
    EXEC [dbo].[Znode_GetPublishAssociatedProducts] @PimProductId ='200066'  , @PimProducttType = 'GroupedProduct'    
   */    
BEGIN    
BEGIN TRAN GetPublishAssociatedProducts;    
BEGIN TRY    
SET NOCOUNT ON;    
      
    IF OBJECT_ID('tempdb..#VesionIds') is not null    
    DROP TABLE #VesionIds    
    Create Table #VesionIds(ZnodeCatalogId int , VersionId int , LocaleId int , RevisionType varchar(50) )    
    
      If @VersionIdString <> ''       
    Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)     
    SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV Inner join Split(@VersionIdString,',') S ON PV.VersionId = S.Item    
    Else     
    Begin    
     If  (@RevisionType like '%Preview%'  OR @RevisionType like '%Production%' )    
      Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)     
      SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV  where PV.IsPublishSuccess =1     
      AND PV.RevisionType ='Preview'    
    
     If  (@RevisionType like '%Production%' OR @RevisionType = 'None')    
      Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)     
      SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV  where PV.IsPublishSuccess =1     
      AND PV.RevisionType ='Production'    
     end     
    
   IF OBJECT_ID('tempdb..#TBL_PublishCatalogId') is not null    
    DROP TABLE #TBL_PublishCatalogId    
       
   CREATE TABLE #TBL_PublishCatalogId (PublishCatalogId INT,PublishProductId INT,PimProductId  INT , VersionId INT,LocaleId INT  );    
   DECLARE  @PimAttributeId INT = [dbo].[Fn_GetProductTypeAttributeId]()    
     ,@PimAttributeDefaultValueId INT = (SELECT TOP 1 PimAttributeDefaultValueId FROM ZnodePimAttributeDefaultValue WHERE AttributeDefaultValueCode = @ProductType)    
     ,@DefaultLocaleId INT = dbo.fn_getDefaultlocaleId()     
   DECLARE @GetDate DATETIME =dbo.Fn_GetDate()    
        
   IF OBJECT_ID('tempdb..#TBL_PublisshIds') is not null    
   DROP TABLE #TBL_PublisshIds    
   Create TABLE #TBL_PublisshIds (PublishProductId INT , PimProductId INT , PublishCatalogId INT)    
    
   DECLARE  @PimProductId_New TransferId    
          
    IF  @PublishCatalogId IS NULL  OR @PublishCatalogId = 0     
    BEGIN     
    INSERT INTO #TBL_PublisshIds     
    Select ZPP.PublishProductId ,ZPP.PimProductId , ZPP.PublishCatalogId from ZnodePublishProduct ZPP Inner join @PimProductId  PPI on ZPP.PimProductId = PPI.ID    
      --EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId,@userid,@PimProductId,1    
          
      INSERT INTO @PimProductId_New    
      SELECT DISTINCT PimProductId FROM #TBL_PublisshIds    
    
     -- SELECT  @PimProductId     
    END     
        
    IF  ISnull(@PimCategoryHierarchyId,0) <> 0     
    BEGIN     
        
      INSERT INTO #TBL_PublisshIds     
      EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId,@userid,@PimProductId,1,@PimCategoryHierarchyId    
          
      --SET @PimProductId = SUBSTRING((SELECT DISTINCT ','+CAST(PimProductId AS VARCHAr(50)) FROM #TBL_PublisshIds FOR XML PATH ('')),2,8000 )    
    
      INSERT INTO @PimProductId_New    
      SELECT PimProductId FROM #TBL_PublisshIds    
    
          
    END     
    
    IF  ISnull(@PimCategoryHierarchyId,0) <> 0     
    BEGIN     
     INSERT INTO #TBL_PublishCatalogId     
     SELECT ZPP.PublishCatalogId , ZPP.PublishProductId,ZPP.PimProductId,MAX(ZPCP.PublishCatalogLogId) ,ZPCP.LocaleID      
     FROM ZnodePublishProduct ZPP     
     INNER JOIN ZnodePimAttributeValue ZPV ON (ZPV.PimProductId = ZPP.PimProductId )    
     INNER JOIN ZnodePimProductAttributeDefaultValue ZPAVL ON (ZPAVL.PimAttributeValueId = ZPV.PimAttributeValueId)    
     LEFT JOIN  ZnodePublishCatalogLog ZPCP ON (ZPCP.PublishCatalogId  = ZPP.PublishCatalogId)    
     WHERE (EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId   )     
     AND  (ZPP.PublishCatalogId =  @PublishCatalogId ))    
     AND ZPV.PimAttributeId  = @PimAttributeId    
     AND ZPAVL.PimAttributeDefaultValueId= @PimAttributeDefaultValueId    
     AND ZPAVL.LocaleId = @DefaultLocaleId    
     AND ISNULL(ZPCP.LocaleId,0) <> 0     
     AND ZPCP.PublishStateId= @PublishStateId    
     AND EXISTS(SELECT * FROM ZnodeLocale ZL where ZL.IsActive = 1  and ZPCP.LocaleId = ZL.LocaleId )    
     GROUP BY ZPP.PublishCatalogId , ZPP.PublishProductId,ZPP.PimProductId,ZPCP.LocaleID     
         
    END    
    ELSE     
    BEGIN     
        
    IF NOT EXISTS (SELECT TOP 1 1 FROM @PimProductId ) AND @PublishCatalogId <> 0    
    BEGIN    
      INSERT INTO #TBL_PublishCatalogId     
      SELECT distinct ZPP.PublishCatalogId , ZPP.PublishProductId,ZPP.PimProductId,  ZPCP.VersionId PublishCatalogLogId ,ZPCP.LocaleID     
      FROM ZnodePublishProduct ZPP     
      INNER JOIN ZnodePimAttributeValue ZPV ON (ZPV.PimProductId = ZPP.PimProductId )    
      INNER JOIN ZnodePimProductAttributeDefaultValue ZPAVL ON (ZPAVL.PimAttributeValueId = ZPV.PimAttributeValueId)    
      INNER JOIN  #VesionIds  ZPCP ON (ZPCP.ZnodeCatalogId  = ZPP.PublishCatalogId AND ISNULL(ZPCP.LocaleId,0) <> 0 )            
      WHERE     
      --(EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId  AND  @PublishCatalogId = '' )     
      --OR     
      (ZPP.PublishCatalogId =  @PublishCatalogId )    
      AND ZPV.PimAttributeId  = @PimAttributeId    
      AND ZPAVL.PimAttributeDefaultValueId= @PimAttributeDefaultValueId    
      AND ZPAVL.LocaleId = @DefaultLocaleId    
      AND EXISTS(SELECT * FROM ZnodeLocale ZL where ZL.IsActive = 1  and ZPCP.LocaleId = ZL.LocaleId )    
    END    
    ELSE    
    BEGIN    
      INSERT INTO #TBL_PublishCatalogId     
          
      SELECT distinct ZPP.PublishCatalogId , ZPP.PublishProductId,ZPP.PimProductId,  ZPCP.VersionId PublishCatalogLogId ,ZPCP.LocaleID     
      FROM ZnodePublishProduct ZPP     
      INNER JOIN ZnodePimAttributeValue ZPV ON (ZPV.PimProductId = ZPP.PimProductId )    
      INNER JOIN ZnodePimProductAttributeDefaultValue ZPAVL ON (ZPAVL.PimAttributeValueId = ZPV.PimAttributeValueId)    
      LEFT JOIN  #VesionIds ZPCP ON (ZPCP.ZnodeCatalogId  = ZPP.PublishCatalogId AND ISNULL(ZPCP.LocaleId,0) <> 0 )            
      WHERE (EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId  AND ZPP.PublishCatalogId = SP.PublishCatalogId) )    
      AND ZPV.PimAttributeId  = @PimAttributeId    
      AND ZPAVL.PimAttributeDefaultValueId= @PimAttributeDefaultValueId    
      AND ZPAVL.LocaleId = @DefaultLocaleId    
      AND EXISTS(SELECT * FROM ZnodeLocale ZL where ZL.IsActive = 1  and ZPCP.LocaleId = ZL.LocaleId )    
      --GROUP BY ZPP.PublishCatalogId , ZPP.PublishProductId,ZPP.PimProductId,ZPCP.LocaleID,    
    
    END     
         
    END    
        
             DECLARE @TBL_ProductTypeXML TABLE    
             (PublishProductId INT,    
			  PublishCatalogId INT,    
              ReturnXML        XML,    
              VersionId        INT    
             );    
             DECLARE @TBL_PimProductId TABLE    
             ([PimProductId]   INT,    
              PublishCatalogId INT,    
			  PublishProductId INT    
             );    
                
             DECLARE @TBL_PimAssociatedEntity TABLE    
             (    
				ZnodeProductId INT,    
				ZnodeCatalogId INT,    
				AsscociadedZnodeProductIds VARCHAR(MAX),    
				ConfigurableProductEntity NVARCHAR(MAX),    
				LocaleId INT,    
				DisplayOrder INT,    
				VersionId INT    
             );    
    
    If @ProductType = 'BundleProduct' AND Exists (Select TOP 1 1 from #TBL_PublishCatalogId)    
    Begin    
               IF OBJECT_ID('tempdb..#BundleProductPublishedXML') is not null    
					drop table #BundleProductPublishedXML    
    
		 IF (isnull(@PublishCatalogId ,'') = '' or isnull(@PublishCatalogId,0) = 0) and @VersionIdString = ''    
		 Begin     
			  UPDATE ZnodePublishBundleProductEntity SET ElasticSearchEvent = 2 
			  where not exists(select * from ZnodePublishProduct where ZnodePublishBundleProductEntity.ZnodeProductId = ZnodePublishProduct.PublishProductId)    
			  AND EXISTS(SELECT * FROM #VesionIds V WHERE V.VersionId = ZnodePublishBundleProductEntity.VersionId)

			  UPDATE ZnodePublishBundleProductEntity SET ElasticSearchEvent = 2 
			  where Exists ( Select TOP 1 1 from     
			  #TBL_PublishCatalogId A where ZnodePublishBundleProductEntity.ZnodeCatalogId =A.PublishCatalogId AND     
			  ZnodePublishBundleProductEntity.ZnodeProductId  = A.PublishProductId )    
			  AND Exists (SELECT TOP 1 1 FRoM #VesionIds     
			  Where ZnodePublishBundleProductEntity.VersionId =  #VesionIds.VersionId)    
		END     
    
		 UPDATE ZPBP SET AssociatedProductDisplayOrder = ISNULL(ZPTA.DisplayOrder,0),AssociatedProductBundleQuantity = ISNULL(ZPTA.BundleQuantity,1)
		 FROM #TBL_PublishCatalogId TBP    
		 INNER JOIN ZnodePimProductTypeAssociation ZPTA ON(ZPTA.PimParentProductId = TBP.PimProductId)    
		 INNER JOIN ZnodePublishProduct TBPU ON (TBPU.PimProductId = ZPTA.PimProductId AND TBPU.PublishCatalogId = TBP.PublishCatalogId )
		 INNER JOIN ZnodePublishBundleProductEntity ZPBP on  TBP.VersionId = ZPBP.VersionId AND TBP.PublishProductId = ZPBP.ZnodeProductId
			AND TBP.PublishCatalogId = ZPBP.ZnodeCatalogId AND TBPU.PublishProductId = ZPBP.AssociatedZnodeProductId
		 WHERE ZPBP.ElasticSearchEvent <> 2 
		 AND EXISTS(SELECT * FROM #VesionIds V WHERE V.VersionId = ZPBP.VersionId)


		 INSERT INTO ZnodePublishBundleProductEntity     
		 (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,AssociatedProductBundleQuantity)    
		 SELECT DISTINCT TBP.VersionId, TBP.PublishProductId, TBP.PublishCatalogId ,    
		 TBPU.PublishProductId AssociatedZnodeProductId,ISNULL(ZPTA.DisplayOrder,0)  AssociatedProductDisplayOrder,ISNULL(ZPTA.BundleQuantity,1)  AS AssociatedProductBundleQuantity  
		 FROM #TBL_PublishCatalogId TBP    
		 INNER JOIN ZnodePimProductTypeAssociation ZPTA ON(ZPTA.PimParentProductId = TBP.PimProductId)    
		 INNER JOIN ZnodePublishProduct TBPU ON (TBPU.PimProductId = ZPTA.PimProductId AND TBPU.PublishCatalogId = TBP.PublishCatalogId )
		 WHERE NOT EXISTS(SELECT * FROM ZnodePublishBundleProductEntity ZPBP WHERE  TBP.VersionId = ZPBP.VersionId AND TBP.PublishProductId = ZPBP.ZnodeProductId
			AND TBP.PublishCatalogId = ZPBP.ZnodeCatalogId AND TBPU.PublishProductId = ZPBP.AssociatedZnodeProductId AND ZPBP.ElasticSearchEvent <> 2 )
		
   End     
   
   If @ProductType = 'GroupedProduct' AND Exists (Select TOP 1 1 from #TBL_PublishCatalogId)    
   Begin    
		 IF (isnull(@PublishCatalogId ,'') = '' or isnull(@PublishCatalogId,0) = 0) and @VersionIdString = ''    
		 Begin     
			  UPDATE ZnodePublishGroupProductEntity SET ElasticSearchEvent = 2     
			  WHERE NOT EXISTS(SELECT * FROM ZnodePublishProduct WHERE ZnodePublishGroupProductEntity.ZnodeProductId = ZnodePublishProduct.PublishProductId)    
              AND EXISTS(SELECT * FROM #VesionIds V WHERE V.VersionId = ZnodePublishGroupProductEntity.VersionId)

			  UPDATE ZnodePublishGroupProductEntity SET ElasticSearchEvent = 2  
			  where Exists ( Select TOP 1 1 from     
				  #TBL_PublishCatalogId A where ZnodePublishGroupProductEntity.ZnodeCatalogId =A.PublishCatalogId AND     
				  ZnodePublishGroupProductEntity.ZnodeProductId  = A.PublishProductId )    
				  AND Exists (SELECT TOP 1 1 FRoM #VesionIds     
			   Where ZnodePublishGroupProductEntity.VersionId =  #VesionIds.VersionId)    
		 end     
    
	  UPDATE ZPGP SET AssociatedProductDisplayOrder = ISNULL(ZPTA.DisplayOrder,0),ElasticSearchEvent = 1
	  FROM #TBL_PublishCatalogId TBP    
      INNER JOIN ZnodePimProductTypeAssociation ZPTA ON(ZPTA.PimParentProductId = TBP.PimProductId)    
      INNER JOIN ZnodePublishProduct TBPU ON (TBPU.PimProductId = ZPTA.PimProductId AND TBPU.PublishCatalogId = TBP.PublishCatalogId )    
	  INNER JOIN ZnodePublishGroupProductEntity ZPGP ON ZPGP.VersionId = TBP.VersionId AND ZPGP.ZnodeProductId = TBP.PublishProductId 
		AND ZPGP.ZnodeCatalogId = TBP.PublishCatalogId AND ZPGP.AssociatedZnodeProductId = TBPU.PublishProductId AND ZPGP.ElasticSearchEvent <> 2  
	  AND EXISTS(SELECT * FROM #VesionIds V WHERE V.VersionId = ZPGP.VersionId)

      INSERT INTO ZnodePublishGroupProductEntity(VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder)    
      SELECT TBP.VersionId, TBP.PublishProductId ,TBP.PublishCatalogId ,TBPU.PublishProductId ,ISNULL(ZPTA.DisplayOrder,0)    
      FROM #TBL_PublishCatalogId TBP    
      INNER JOIN ZnodePimProductTypeAssociation ZPTA ON(ZPTA.PimParentProductId = TBP.PimProductId)    
      INNER JOIN ZnodePublishProduct TBPU ON (TBPU.PimProductId = ZPTA.PimProductId AND TBPU.PublishCatalogId = TBP.PublishCatalogId )    
	  WHERE NOT EXISTS(SELECT * FROM ZnodePublishGroupProductEntity ZPGP WHERE ZPGP.VersionId = TBP.VersionId AND ZPGP.ZnodeProductId = TBP.PublishProductId 
		AND ZPGP.ZnodeCatalogId = TBP.PublishCatalogId AND ZPGP.AssociatedZnodeProductId = TBPU.PublishProductId AND ZPGP.ElasticSearchEvent <> 2  )
   End     
            
			
   If @ProductType = 'ConfigurableProduct' AND Exists (Select TOP 1 1 from #TBL_PublishCatalogId)    
   Begin    
		 If (isnull(@PublishCatalogId ,'') = '' or isnull(@PublishCatalogId,0) = 0) and @VersionIdString = ''    
		 Begin    
			  UPDATE ZnodePublishConfigurableProductEntity SET ElasticSearchEvent = 2       
			  where not exists(select * from ZnodePublishProduct where ZnodePublishConfigurableProductEntity.ZnodeProductId = ZnodePublishProduct.PublishProductId)    
              AND EXISTS(SELECT * FROM #VesionIds V WHERE V.VersionId = ZnodePublishConfigurableProductEntity.VersionId)

			  UPDATE ZnodePublishConfigurableProductEntity SET ElasticSearchEvent = 2  
			  where Exists ( Select TOP 1 1 from     
			  #TBL_PublishCatalogId A where ZnodePublishConfigurableProductEntity.ZnodeCatalogId =A.PublishCatalogId AND     
			  ZnodePublishConfigurableProductEntity.ZnodeProductId  = A.PublishProductId )     
			  AND Exists (SELECT TOP 1 1 FRoM #VesionIds     
			   Where ZnodePublishConfigurableProductEntity.VersionId =  #VesionIds.VersionId)    
		 end     
    
		SELECT DISTINCT TBP.VersionId, TBP.PublishProductId ,    
			  TBP.PublishCatalogId ,    
			  Isnull(TBPU.PublishProductId,0) AssociatedZnodeProductId,     
			  ISNULL(ZPTA.DisplayOrder,0) DisplayOrder,'[]' SelectValues,          
			  '[' + Isnull(SUBSTRING((SELECT Distinct ','+ +'"'+CAST(ZPA.AttributeCode AS VARCHAR(50)) +'"'     
			  FROM ZnodePimConfigureProductAttribute ZPCPA     
			  LEFT JOIN ZnodePimAttribute ZPA ON Zpa.PimAttributeId = ZPCPA.PimAttributeId 
			  WHERE ZPTA.PimParentProductId = ZPCPA.PimProductId
			  FOR XML PATH ('') ),2,2000),Null) +']' as ConfigurableAttributeCodes    
			  , ZPTA.IsDefault  
		  INTO #TempConfigurableProductEntity 
		 FROM #TBL_PublishCatalogId TBP    
		 INNER JOIN ZnodePimProductTypeAssociation ZPTA ON(ZPTA.PimParentProductId = TBP.PimProductId)    
		 INNER JOIN ZnodePublishProduct TBPU ON (TBPU.PimProductId = ZPTA.PimProductId AND TBPU.PublishCatalogId = TBP.PublishCatalogId )    
    
		 UPDATE ZPCP SET ZPCP.AssociatedProductDisplayOrder = AssociatedProductDisplayOrder,
			ConfigurableAttributeCodes = TBP.ConfigurableAttributeCodes,IsDefault = TBP.IsDefault,ZPCP.ElasticSearchEvent =1
		 FROM #TempConfigurableProductEntity TBP    
		 INNER JOIN ZnodePublishConfigurableProductEntity ZPCP ON ZPCP.VersionId = TBP.VersionId 
			AND ZPCP.ZnodeProductId = TBP.PublishProductId AND ZPCP.ZnodeCatalogId = TBP.PublishCatalogId AND ZPCP.AssociatedZnodeProductId = TBP.AssociatedZnodeProductId
		 AND EXISTS(SELECT * FROM #VesionIds V WHERE V.VersionId = ZPCP.VersionId)

		  Insert into ZnodePublishConfigurableProductEntity 
		  (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,    
		  SelectValues,ConfigurableAttributeCodes, IsDefault,ElasticSearchEvent )    
		  SELECT DISTINCT TBP.VersionId, TBP.PublishProductId ,    
			  TBP.PublishCatalogId , TBP.AssociatedZnodeProductId,TBP.DisplayOrder ,TBP.SelectValues,          
			  TBP.ConfigurableAttributeCodes, TBP.IsDefault  ,1 as ElasticSearchEvent
		 FROM #TempConfigurableProductEntity TBP    
		 WHERE NOT EXISTS(SELECT * FROM ZnodePublishConfigurableProductEntity ZPCP WHERE ZPCP.VersionId = TBP.VersionId 
			AND ZPCP.ZnodeProductId = TBP.PublishProductId AND ZPCP.ZnodeCatalogId = TBP.PublishCatalogId AND ZPCP.AssociatedZnodeProductId = TBP.AssociatedZnodeProductId and isnull(ZPCP.ElasticSearchEvent,0) <> 2)
		 

		 Update ZPC SET ZPC.ElasticSearchEvent =2 from ZnodePublishConfigurableProductEntity  ZPC  Where Exists 
		 (Select TOP 1 1 From #TempConfigurableProductEntity X Where ZPC.ZnodeProductId = X.PublishProductId and ZPC.ZnodeCatalogId = X.PublishCatalogId)
		 AND NOT Exists 
		(Select TOP 1 1 From #TempConfigurableProductEntity XP Where ZPC.ZnodeProductId = XP.PublishProductId and ZPC.ZnodeCatalogId = XP.PublishCatalogId
		 and XP.AssociatedZnodeProductId = ZPC.AssociatedZnodeProductId)
		 AND EXISTS(SELECT * FROM #VesionIds V WHERE V.VersionId = ZPC.VersionId)

      IF OBJECT_ID('tempdb..#TBL_PublishCatalogId') is not null    
       drop table #TBL_PublishCatalogId    
    
      IF OBJECT_ID('tempdb..#ConfigurableProductPublishedXML') is not null    
       drop table #ConfigurableProductPublishedXML    
    
End 

	  DELETE FROM ZnodePublishBundleProductEntity WHERE ISNULL(ElasticSearchEvent,0) = 2  
	  DELETE FROM ZnodePublishGroupProductEntity WHERE ISNULL(ElasticSearchEvent,0) = 2    
	  DELETE FROM ZnodePublishConfigurableProductEntity WHERE ISNULL(ElasticSearchEvent,0) = 2 

COMMIT TRAN GetPublishAssociatedProducts;    
SET @Status = 1;    
END TRY    
	BEGIN CATCH    
	SELECT ERROR_MESSAGE()    
	SET @Status = 0;    
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishAssociatedProductsJson @PublishCatalogId = '+@PublishCatalogId+',@ProductType= '+@ProductType+',@VersionId='+CAST(@VersionId AS VARCHAR(50))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));    
                      
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                        
	ROLLBACK TRANSACTION GetPublishAssociatedProducts;    
	EXEC Znode_InsertProcedureErrorLog    
	@ProcedureName = 'Znode_GetPublishAssociatedProductsJson',    
	@ErrorInProcedure = @Error_procedure,    
	@ErrorMessage = @ErrorMessage,    
	@ErrorLine = @ErrorLine,    
	@ErrorCall = @ErrorCall;    
END CATCH;    
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCustomer')
	DROP PROC Znode_ImportCustomer
GO

CREATE PROCEDURE [dbo].[Znode_ImportCustomer]
(
	  @TableName NVARCHAR(100), 
	  @Status BIT OUT, 
	  @UserId INT, 
	  @ImportProcessLogId INT, 
	  @NewGUId NVARCHAR(200), 
	  @LocaleId INT= 0,
	  @PortalId INT ,
	  @CsvColumnString NVARCHAR(max)
)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Customer Details
	
	-- Unit Testing : 
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(max),@AspNetZnodeUserId NVARCHAR(256),@ASPNetUsersId NVARCHAR(256),
		@PasswordHash NVARCHAR(max),@SecurityStamp NVARCHAR(max),@RoleId NVARCHAR(256),@IsAllowGlobalLevelUserCreation NVARCHAR(10)
		Declare @ProfileId  INT
		DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		 
		SET @SecurityStamp = '0wVYOZNK4g4kKz9wNs-UHw2'
		SET @PasswordHash = 'APy4Tm1KbRG6oy7h3r85UDh/lCW4JeOi2O2Mfsb3OjkpWTp1YfucMAvvcmUqNaSOlA==';

		SELECT  @RoleId  = Id FROM AspNetRoles WHERE   NAME = 'User'  

		SELECT @IsAllowGlobalLevelUserCreation = FeatureValues FROM ZnodeGlobalsetting WHERE FeatureName = 'AllowGlobalLevelUserCreation'

		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
		-- Retrive RoundOff Value FROM global setting 
		Delete from ZnodeImportLog where ErrorDescription = '42' and ColumnName like '%AccountCode%' and  ImportProcessLogId= @ImportProcessLogId
		
		
		
		-- Three type of import required three table varible for product , category and brand
		CREATE TABLE #InsertCustomer 
		( 
			RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, UserName NVARCHAR(512) ,FirstName	NVARCHAR(200),
			LastName NVARCHAR(200), BudgetAmount	NUMERIC,Email	NVARCHAR(100),PhoneNumber	NVARCHAR(100),
		    EmailOptIn	varchar(100)	,ReferralStatus	NVARCHAR(40),IsActive	varchar(100)	,ExternalId	NVARCHAR(max),CreatedDate DATETIME,
			ProfileName varchar(200),AccountCode NVARCHAR(100),DepartmentName varchar(300),RoleName NVARCHAR(256), GUID NVARCHAR(400)
			,PerOrderLimit INT,	PerOrderAnnualLimit NVARCHAR(100),BillingAccountNumber NVARCHAR(100),EnableUserShippingAddressSuggestion  NVARCHAR(100),
			EnablePowerBIReportOnWebStore BIT,Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),
			Custom4 NVARCHAR(max),Custom5 NVARCHAR(max), SMSOptIn varchar(100)
		);

		SET @SSQL = 'INSERT INTO #InsertCustomer( RowNumber,' + @CsvColumnString + ',GUID)
		             SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+ @TableName;
		
		EXEC sys.sp_sqlexec @SSQL;

	    --If Account Code Exists then it will update as it is and if not exists then it will show error.
		UPDATE IC set AccountCode = ZA.AccountCode 
		FROM ZnodeUser a
		inner join ZnodeAccount ZA on (ZA.AccountId = a.AccountId)
		INNER JOIN #InsertCustomer IC on (IC.UserName = a.UserName)
		WHERE ISNULL(IC.AccountCode,'') = '' AND ISNULL(IC.RoleName,'') <> ''

		if @CsvColumnString not like '%AccountCode%'
		begin
			--If Acount Code Exists then it will update as it is and if not exists then it will show error.
			update IC set AccountCode = ZA.AccountCode
			FROM ZnodeUser a
			inner join ZnodeAccount ZA on (ZA.AccountId = a.AccountId)
			INNER JOIN #InsertCustomer IC on (IC.UserName = a.UserName)
			WHERE isnull(IC.AccountCode,'') = '' --and isnull(IC.RoleName,'') <> ''
		end
		
		SELECT TOP 1 @ProfileId   =  ProfileId FROM ZnodePortalprofile WHERE Portalid = @Portalid and IsDefaultRegistedProfile=1
		IF( Isnull(@ProfileId ,0) = 0 ) 
		Begin
		
		
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '62', 'Default Portal Profile', '', @NewGUId, 1 , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
							
				UPDATE ZnodeImportProcessLog
				SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
				WHERE ImportProcessLogId = @ImportProcessLogId;
			

				SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog 
				WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
				SELECT @SuccessRecordCount = 0

				UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
				TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
				WHERE ImportProcessLogId = @ImportProcessLogId;

				DELETE FROM #InsertCustomer 
				SET @Status = 0;

				COMMIT TRAN A;
				Return 0 
		End

		--If @IsAllowGlobalLevelUserCreation = 'false'  
		--BEGIN
		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		--SELECT '10', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		--FROM #InsertCustomer AS ii  
		--WHERE ltrim(rtrim(ii.UserName)) in   
		--(  
		--SELECT UserName FROM AspNetZnodeUser   where PortalId = @PortalId  
		--);  
		--END
		--Else   
		IF @IsAllowGlobalLevelUserCreation = 'true'
		BEGIN
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '10', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM #InsertCustomer AS ii  
			WHERE ltrim(rtrim(ii.UserName)) in   
			(  
			SELECT UserName FROM AspNetZnodeUser     
			);  
		END


		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '104', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName not like '%_@_%_.__%' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '35', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName like '%;%'
				
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '30', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ltrim(rtrim(ii.UserName)) IN 
		(SELECT ltrim(rtrim(UserName))  FROM #InsertCustomer GROUP BY ltrim(rtrim(UserName))  having count(*) > 1 )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '104', 'Email', Email, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.Email not like '%_@_%_.__%' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'IsActive',  IsActive , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '77', 'AccountCode', ii.AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer ii 
		WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !='' 
		AND NOT EXISTS(SELECT * FROM ZnodeAccount za INNER JOIN ZnodePortalAccount zpa on za.AccountId = zpa.AccountId
			WHERE  ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za.AccountCode and zpa.PortalId = @PortalId )
		AND EXISTS(SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount za1 WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za1.AccountCode );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '73', 'AccountCode', AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !=''   and ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') not IN 
		(
			SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount   
		);


		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '75', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') ='' and ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '74', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE --ltrim(rtrim(ii.RoleName)) not IN ('User','Manager','Administrator') and ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and
			ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and not exists (SELECT top 1 1 FROM  AspNetRoles ANR WHERE name IN ('User','Manager','Administrator') and  ANR.name =ii.RoleName)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '76', 'DepartmentName', DepartmentName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') <> ''
		AND NOT EXISTS(SELECT * FROM  ZnodeAccount ZA INNER JOIN ZnodeDepartment ZD on ZA.AccountId = ZD.AccountId
			WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = ltrim(rtrim(za.AccountCode))
			and ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') = ltrim(rtrim(ZD.DepartmentName)))

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'EmailOptIn',  EmailOptIn , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.EmailOptIn NOT IN ('True','1','Yes','FALSE','0','No','');

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'SMSOptIn',  SMSOptIn , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.SMSOptIn NOT IN ('True','1','Yes','FALSE','0','No','');

		UPDATE ZIL
		SET ZIL.ColumnName =   ZIL.ColumnName + ' [ UserName - ' + ISNULL(UserName,'') + ' ] '
		FROM ZnodeImportLog ZIL 
		INNER JOIN #InsertCustomer IPA ON (ZIL.RowNumber = IPA.RowNumber)
		WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		--Note : Content page import is not required 
		
		-- END Function Validation 	
		-----------------------------------------------
		--- Delete Invalid Data after functional validatin  

		DELETE FROM #InsertCustomer
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
			--AND GUID = @NewGUID
		);


		-- Update Record count IN log 
        
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		SELECT @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertCustomer
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- END

		-- Insert Product Data 
				
				
				DECLARE @InsertedAspNetZnodeUser TABLE (AspNetZnodeUserId NVARCHAR(256) ,UserName NVARCHAR(512),PortalId INT )
				DECLARE @InsertedASPNetUsers TABLE (Id NVARCHAR(256) ,UserName NVARCHAR(512))
				DECLARE @InsertZnodeUser TABLE (UserId INT,AspNetUserId NVARCHAR(256),CreatedDate DATETIME )

				UPDATE ANU SET 
				ANU.PhoneNumber	= IC.PhoneNumber, 
					ANU.LockoutEndDateUtc = case when IC.IsActive IN('0','No','False') then @GetDate when IC.IsActive IN('1','Yes','True') then null else ANU.LockoutEndDateUtc END
				FROM AspNetZnodeUser ANZU 
				INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
				WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
				----Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

				UPDATE ZU SET 
				ZU.FirstName	= IC.FirstName,
				ZU.LastName		= IC.LastName,
				--ZU.MiddleName	= IC.MiddleName,
				ZU.BudgetAmount = IC.BudgetAmount,
				ZU.Email		= IC.Email,
				ZU.PhoneNumber	= IC.PhoneNumber,
				ZU.EmailOptIn	= (CASE ISNULL(IC.EmailOptIn,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.EmailOptIn,0) As BIT) END),
				ZU.IsActive		= (CASE ISNULL(IC.IsActive,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.IsActive,0) As BIT) END),
				ZU.Custom1 = IC.Custom1,
				ZU.Custom2 = IC.Custom2,
				ZU.Custom3 = IC.Custom3,
				ZU.Custom4 = IC.Custom4,
				ZU.Custom5 = IC.Custom5,
				ZU.SMSOptIn	= (CASE ISNULL(IC.SMSOptIn,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 WHEN '' THEN ZU.SMSOptIn ELSE CAST(ISNULL(IC.SMSOptIn,0) As BIT) END)
				--ZU.ExternalId = ExternalId
				FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
				WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
				--WHERE Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

				INSERT INTO AspNetZnodeUser (AspNetZnodeUserId, UserName, PortalId)		
				OUTPUT INSERTED.AspNetZnodeUserId, INSERTED.UserName, INSERTED.PortalId	INTO  @InsertedAspNetZnodeUser 			 
				SELECT NEWID(),IC.UserName, @PortalId FROM #InsertCustomer IC 
				WHERE NOT EXISTS (SELECT TOP 1 1  FROM AspNetZnodeUser ANZ 
					WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZ.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END 
					AND ANZ.UserName = IC.UserName)

				INSERT INTO ASPNetUsers (Id,Email,EmailConfirmed,PasswordHash,SecurityStamp,PhoneNumber,PhoneNumberConfirmed,TwoFactorEnabled,
				LockoutEndDateUtc,LockOutEnabled,AccessFailedCount,PasswordChangedDate,UserName)
				OUTPUT inserted.Id, inserted.UserName INTO @InsertedASPNetUsers
				SELECT NewId(), Email,0 ,@PasswordHash,@SecurityStamp,PhoneNumber,0,0,case when A.IsActive IN ('0','False','No') then @GetDate else null END LockoutEndDateUtc,1 LockoutEnabled,
				0,@GetDate,AspNetZnodeUserId FROM #InsertCustomer A INNER JOIN @InsertedAspNetZnodeUser  B 
				ON A.UserName = B.UserName
			
				INSERT INTO  ZnodeUser(AspNetUserId,FirstName,LastName,CustomerPaymentGUID,Email,PhoneNumber,EmailOptIn,
				IsActive,ExternalId, CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,UserName,Custom1,Custom2,Custom3,Custom4,Custom5,SMSOptIn)
				OUTPUT Inserted.UserId, Inserted.AspNetUserId,Inserted.CreatedDate INTO @InsertZnodeUser
				SELECT IANU.Id AspNetUserId ,IC.FirstName,IC.LastName,null CustomerPaymentGUID,IC.Email
				,IC.PhoneNumber,
				(CASE ISNULL(IC.EmailOptIn,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.EmailOptIn,0) As BIT) END),
				(CASE ISNULL(IC.IsActive,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.IsActive,0) As BIT) END),
				IC.ExternalId, @UserId,
				CASE WHEN IC.CreatedDate IS NULL OR IC.CreatedDate = '' THEN  @Getdate ELSE IC.CreatedDate END,
				@UserId,@Getdate,IC.UserName,IC.Custom1,IC.Custom2,IC.Custom3,IC.Custom4,IC.Custom5,
					(CASE ISNULL(IC.SMSOptIn,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.SMSOptIn,0) As BIT) END)
				FROM #InsertCustomer IC INNER JOIN 
				@InsertedAspNetZnodeUser IANZU ON IC.UserName = IANZU.UserName  INNER JOIN 
				@InsertedASPNetUsers IANU ON IANZU.AspNetZnodeUserId = IANU.UserName 
	  	     
				INSERT INTO AspNetUserRoles (UserId,RoleId)  SELECT AspNetUserId, @RoleID FROM @InsertZnodeUser 
				INSERT INTO ZnodeUserPortal (UserId,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
				SELECT UserId, @PortalId , @UserId, IZU.CreatedDate,@UserId,@Getdate 
				FROM @InsertZnodeUser IZU

				INSERT INTO ZnodeAccountUserPermission(UserId,AccountPermissionAccessId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT UserId, 4 , @UserId, @Getdate,@UserId,@Getdate 
				FROM @InsertZnodeUser IZU
		
				------------INSERT INTO ZnodeUserGlobalAttributeValue
	
				IF OBJECT_ID('tempdb..#globaldata') IS NOT NULL 
					DROP TABLE #globaldata
				
				SELECT ZU.userid,PerOrderLimit,
					PerOrderAnnualLimit,
					BillingAccountNumber,
					EnableUserShippingAddressSuggestion,
					EnablePowerBIReportOnWebStore 
				INTO #globaldata
				FROM znodeuser ZU INNER JOIN  #InsertCustomer IC on IC.Email =ZU.EMAIL
				WHERE ZU.userid IN (SELECT userid FROM @InsertZnodeUser)
				GROUP BY ZU.userid,PerOrderLimit,
									PerOrderAnnualLimit,
									BillingAccountNumber,
									EnableUserShippingAddressSuggestion,
									EnablePowerBIReportOnWebStore 

				IF OBJECT_ID('tempdb..#globaldata1') IS NOT NULL DROP TABLE #globaldata1
				SELECT * INTO #globaldata1 FROM (SELECT userid, Cast(PerOrderLimit as varchar(100)) PerOrderLimit,
				 Cast(PerOrderAnnualLimit as varchar(100)) PerOrderAnnualLimit,
				 Cast(BillingAccountNumber as varchar(100)) BillingAccountNumber,
				 Cast(case when cast(EnableUserShippingAddressSuggestion as varchar(10))= '1' or cast(EnableUserShippingAddressSuggestion as varchar(10)) ='YES' or  cast(EnableUserShippingAddressSuggestion as varchar(10)) ='True' then 'True' else 'False'  END  as varchar(100)) EnableUserShippingAddressSuggestion,
				 Cast(case when cast(EnablePowerBIReportOnWebStore as varchar(10))= '1'  or cast(EnablePowerBIReportOnWebStore as varchar(10)) ='YES' or  cast(EnablePowerBIReportOnWebStore as varchar(10)) ='True' then 'True' else 'False' END  as varchar(100)) EnablePowerBIReportOnWebStore FROM #globaldata) ab
				UNPIVOT  
				   (avalue FOR acode IN   
					  (PerOrderLimit,
				PerOrderAnnualLimit,
				BillingAccountNumber,
				EnableUserShippingAddressSuggestion,
				EnablePowerBIReportOnWebStore)  
				)AS unpvt;  

				INSERT INTO ZnodeUserGlobalAttributeValue (UserId,	GlobalAttributeId,	GlobalAttributeDefaultValueId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
				SELECT g.Userid,ZGA.GlobalAttributeId,null,null,@UserId,@Getdate,@UserId,@Getdate
					FROM #globaldata1 g INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.acode
					WHERE NOT EXISTS (SELECT top 1 1 FROM ZnodeUserGlobalAttributeValue ZGAV WHERE ZGAV.Userid =g.Userid and ZGA.GlobalAttributeId=ZGAV.GlobalAttributeId)

				INSERT INTO ZnodeUserGlobalAttributeValuelocale(UserGlobalAttributeValueId,	LocaleId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate,	GlobalAttributeDefaultValueId,	MediaId,	MediaPath)
				SELECT UserGlobalAttributeValueId, @LocaleId,avalue ,@UserId,@Getdate,@UserId,@Getdate,null,null,null
					FROM ZnodeUserGlobalAttributeValue ZUGAV INNER JOIN #globaldata1 g on ZUGAV.userid =g.userid
						INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.acode and ZGA.GlobalAttributeId = ZUGAV.GlobalAttributeId
						WHERE NOT EXISTS (SELECT Top 1 1 FROM ZnodeUserGlobalAttributeValuelocale z WHERE z.UserGlobalAttributeValueId = ZUGAV.UserGlobalAttributeValueId)

				---------------------------------------------------------------------------------

				declare @Profile table (ProfileId INT)

				INSERT INTO ZnodeProfile (ProfileName,ShowOnPartnerSignup,Weighting,TaxExempt,DefaultExternalAccountNo,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ParentProfileId)
				OUTPUT inserted.ProfileId INTO @Profile(ProfileId)
				SELECT Distinct ProfileName, 0, null,0, replace(ltrim(rtrim(ProfileName)),' ','') as DefaultExternalAccountNo, @UserId,@Getdate, @UserId,@Getdate, null as ParentProfileId				
				FROM #InsertCustomer IC
				WHERE NOT EXISTS(SELECT * FROM ZnodeProfile ZP WHERE IC.ProfileName = ZP.ProfileName )
				AND ISNULL(ic.ProfileName,'') <> ''

				INSERT INTO ZnodePortalProfile (PortalId,	ProfileId,	IsDefaultAnonymousProfile,	IsDefaultRegistedProfile,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
				SELECT @PortalId, ProfileId, 0 AS IsDefaultAnonymousProfile, 0 AS IsDefaultRegistedProfile, @UserId,@Getdate, @UserId,@Getdate
				FROM @Profile

				UPDATE ZnodeUserProfile 
				SET ProfileId = COALESCE(ZP.ProfileId,@ProfileId)
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeUserProfile u ON u.UserId = a.UserId
				LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
				--WHERE IC.ProfileName <> ''
				
				INSERT INTO ZnodeUserProfile (ProfileId,UserId,IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT COALESCE(ZP.ProfileId,@ProfileId)  , a.UserId, 1 , @UserId,a.CreatedDate,@UserId,@Getdate 
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeUserProfile u WHERE u.UserId = a.UserId )
				AND EXISTS(SELECT * FROM @InsertZnodeUser IZU WHERE A.UserId = IZU.UserId)

				--Updating RoleName if customer has changed the account and RoleName left blank then by default User role assigned to the customer
				UPDATE u set u.RoleId = @RoleId
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN AspNetUserRoles u on u.UserId = b.Id
				WHERE isnull(IC.AccountCode,'') <> '' AND isnull(IC.RoleName,'') = ''
				AND EXISTS(SELECT * FROM ZnodeAccount ZA WHERE ISNULL(a.AccountId,0) = ZA.AccountId AND ZA.AccountCode <> IC.AccountCode)

				---to update accountid agaist user
				UPDATE ZU SET ZU.AccountId = ZA.AccountId 
				FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	 
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName
				INNER JOIN ZnodeAccount ZA ON ZA.AccountCode = IC.AccountCode 
				--INNER JOIN @InsertZnodeUser IZU on IZU.UserId =ZU.UserId
				WHERE Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0) and isnull(IC.AccountCode,'') <> '' 
				--EXISTS (SELECT * FROM #InsertCustomer IC WHERE IC.AccountCode = ZA.AccountCode AND ISNULL(IC.AccountCode,'') = '' AND ISNULL(IC.RoleName,'') <> '' )

				
				update ZDU set ZDU.DepartmentId = ZD.DepartmentId, ModifiedBy = @UserId, ModifiedDate = @Getdate
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
				INNER JOIN ZnodeDepartmentUser ZDU on ZDU.UserId = a.UserId
				WHERE isnull(IC.DepartmentName,'') <> ''


				INSERT INTO ZnodeDepartmentUser(UserId,DepartmentId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT a.UserId, ZD.DepartmentId, @UserId,a.CreatedDate,@UserId,@Getdate 
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeDepartmentUser u WHERE u.UserId = a.UserId)
				AND isnull(IC.DepartmentName,'') <> ''
		
				update u set u.RoleId = ZD.Id
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
				INNER JOIN AspNetUserRoles u on u.UserId = b.Id
				WHERE isnull(IC.RoleName,'') <> '' 


				--when RoleName and AccountCode is null in update file then If a value was available previously, then it should be removed (along with Department and Role Name) 
				--after the update process is complete.
				DELETE UR FROM AspNetUserRoles UR 
				INNER JOIN ZnodeUser ZC	ON  ZC.AspNetUserId = UR.UserId
				WHERE EXISTS (SELECT * FROM #InsertCustomer IC WHERE IC.UserName = ZC.UserName AND (ISNULL(IC.RoleName,'') = '' AND ISNULL(IC.AccountCode,'') = ''))


				UPDATE ZnodeUser SET AccountId = NULL 
				WHERE EXISTS (SELECT * FROM #InsertCustomer IC WHERE IC.UserName = ZnodeUser.UserName AND ISNULL(IC.AccountCode,'') = '' AND ISNULL(IC.RoleName,'') = '' )		

		
				INSERT INTO AspNetUserRoles(UserId,RoleId)
				SELECT b.Id as ASPNetUserId, case when ZD.Id is null then @RoleId else ZD.Id end  as RoleId
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				LEFT JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM AspNetUserRoles u WHERE u.UserId = b.Id)
				AND ISNULL(IC.AccountCode,'') <> ''
			
				--If no value was available previously then no value should be saved after the update process is complete.
				--If a value was available previously, then it should be removed after the update process is complete.
				DELETE DU FROM ZnodeDepartmentUser DU
				INNER JOIN ZnodeUser ZU ON DU.UserId = ZU.UserId
				INNER JOIN ZnodeDepartment ZC ON  ZC.DepartmentId = DU.DepartmentId
				WHERE EXISTS (SELECT * FROM #INSERTCUSTOMER IC WHERE IC.UserName = ZU.UserName AND (ISNULL(IC.DepartmentName,'') = '' OR ISNULL(IC.ACCOUNTCODE,'') = ''))


		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
		 DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCustomer @TableName = '+CAST(@TableName AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@PortalId='+CAST(@PortalId AS VARCHAR(10))+',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max));
              	
		 ---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

        EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportCustomer',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportPimProductData')
	DROP PROC Znode_ImportPimProductData
GO



CREATE PROCEDURE [dbo].[Znode_ImportPimProductData]
(   @TableName          VARCHAR(200),
    @NewGUID            NVARCHAR(200),
    @TemplateId         NVARCHAR(200),
    @ImportProcessLogId INT,
    @UserId             INT,
    @LocaleId           INT,
    @DefaultFamilyId    INT)
AS
    
	/*
      Summary : Finally Import data into ZnodePimProduct, ZnodePimAttributeValue and ZnodePimAttributeValueLocale Table 
      Process : Flat global temporary table will split into cloumn wise and associted with Znode Attributecodes,
    		      Create group of product with their attribute code and values and inserted one by one products. 	   
    
      SourceColumnName : CSV file column headers
      TargetColumnName : Attributecode from ZnodePimAttribute Table 

	 ***  Need to log error if transaction failed during insertion of records into table.
    */

     BEGIN
		 SET NOCOUNT ON
         BEGIN TRY
             BEGIN TRAN ImportProducts;
             DECLARE @SQLQuery NVARCHAR(MAX);
			 DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
             DECLARE @AttributeTypeName NVARCHAR(10), @AttributeCode NVARCHAR(300), @AttributeId INT, @IsRequired BIT, @SourceColumnName NVARCHAR(600), @PimAttributeFamilyId INT, @NewProductId INT, @PimAttributeValueId INT, @status BIT= 0; 
             --Declare error Log Table 

			
			 DECLARE @FamilyAttributeDetail TABLE
			 ( 
				PimAttributeId int, AttributeTypeName varchar(300), AttributeCode varchar(300), SourceColumnName nvarchar(600), IsRequired bit, PimAttributeFamilyId int
			 );
             IF @DefaultFamilyId = 0
                 BEGIN
					INSERT INTO @FamilyAttributeDetail( PimAttributeId, AttributeTypeName, AttributeCode, SourceColumnName, IsRequired, PimAttributeFamilyId )
					--Call Process to insert data of defeult family with cource column name and target column name 
					EXEC Znode_ImportGetTemplateDetails @TemplateId = @TemplateId, @IsValidationRules = 0, @IsIncludeRespectiveFamily = 1,@DefaultFamilyId = @DefaultFamilyId;
                    UPDATE @FamilyAttributeDetail SET PimAttributeFamilyId = DBO.Fn_GetCategoryDefaultFamilyId();

					---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;
             ELSE
                 BEGIN
                     INSERT INTO @FamilyAttributeDetail(PimAttributeId,AttributeTypeName,AttributeCode,SourceColumnName,IsRequired,PimAttributeFamilyId)
                     --Call Process to insert data of defeult family with cource column name and target column name 
                     EXEC Znode_ImportGetTemplateDetails @TemplateId = @TemplateId,@IsValidationRules = 0,@IsIncludeRespectiveFamily = 1,@DefaultFamilyId = @DefaultFamilyId;

					 ---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;  
				
            -- Retrive PimProductId on the basis of SKU for update product 
			SET @SQLQuery = 'UPDATE tlb SET tlb.PimProductId = ZPAV.PimProductId 
							FROM ZnodePimAttributeValue AS ZPAV INNER JOIN ZnodePimAttributeValueLocale AS ZPAVL ON 
							(ZPAVL.PimAttributeValueId = ZPAV.PimAttributeValueId) 
							INNER JOIN [dbo].[ZnodePimAttribute] ZPA on ZPAV.PimAttributeId = ZPA.PimAttributeId AND ZPA.AttributeCode= ''SKU'' 
							INNER JOIN '+@TableName+' tlb ON ZPAVL.AttributeValue = ltrim(rtrim(tlb.SKU)) ';
			EXEC sys.sp_sqlexec	@SQLQuery	
			
			SET @SQLQuery='
				INSERT INTO ZnodeImportLog( ErrorDescription,ColumnName, Data, GUID,RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT ''135'',''SKU'', SKU, '''+@NewGUId+''',RowNumber, '+cast(@UserId as varchar(10))+', getdate(), '+cast(@UserId as varchar(10))+', getdate(), '+cast(@ImportProcessLogId as varchar(10))+'
				FROM '+@TableName +' WHERE LEN(SKU)>600';
				EXEC sys.sp_sqlexec @SQLQuery;

				SET @SQLQuery='Delete B from '+@TableName +' B WHERE EXISTS (SELECT TOP 1 1 FROM ZnodeImportLog A where B.RowNumber=A.RowNumber and A.ImportProcessLogId 
				='+cast(@ImportProcessLogId as varchar(10))+')'
				EXEC (@SQLQuery)
				 	
					
             --Read all attribute details with their datatype 
			 IF NOT EXISTS(SELECT TOP 1 1 FROM INFORMATION_SCHEMA.TABLES WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#DefaultAttributeValue')
				BEGIN
					   CREATE TABLE #DefaultAttributeValue (AttributeTypeName  VARCHAR(300),PimAttributeDefaultValueId INT,PimAttributeId INT,
					   AttributeDefaultValueCode  VARCHAR(100));
					 
					INSERT INTO #DefaultAttributeValue(AttributeTypeName,PimAttributeDefaultValueId,PimAttributeId,AttributeDefaultValueCode)
					--Call Process to insert default data value 
					EXEC Znode_ImportGetPimAttributeDefaultValue;
				END;
             ELSE
                BEGIN
                    DROP TABLE #DefaultAttributeValue;
                END;
             EXEC sys.sp_sqlexec
                  @SQLQuery;
       
			DECLARE @PimProductDetail TABLE 
			 (
			      
				  PimAttributeId INT, PimAttributeFamilyId INT,ProductAttributeCode VARCHAR(300) NULL,
				  ProductAttributeDefaultValueId INT NULL,PimAttributeValueId  INT NULL,LocaleId INT,
				  PimProductId INT NULL,AttributeValue NVARCHAR(MAX) NULL,AssociatedProducts NVARCHAR(4000) NULL,ConfigureAttributeIds VARCHAR(2000) NULL,
				  ConfigureFamilyIds VARCHAR(2000) NULL,RowNumber INT  
                );

		-- Update Record count in log 
       DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
		EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount OUTPUT
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- End

			
             -- Column wise split data from source table ( global temporary table ) and inserted into temporary table variable @PimProductDetail
             -- Add PimAttributeDefaultValue 
             DECLARE Cr_AttributeDetails CURSOR LOCAL FAST_FORWARD
             FOR SELECT PimAttributeId,AttributeTypeName,AttributeCode,IsRequired,SourceColumnName,PimAttributeFamilyId FROM @FamilyAttributeDetail  WHERE ISNULL(SourceColumnName, '') <> '';
             OPEN Cr_AttributeDetails;
             FETCH NEXT FROM Cr_AttributeDetails INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @PimAttributeFamilyId;
             WHILE @@FETCH_STATUS = 0
                 BEGIN
                    SET @NewProductId = 0;
                    SET @SQLQuery = ' SELECT '''+CONVERT(VARCHAR(100), @PimAttributeFamilyId)+''' PimAttributeFamilyId , PimProductId PimProductId,'''+'['+@AttributeCode+']'+''' ProductAttributeCode ,'''+CONVERT(VARCHAR(100), @AttributeId)+''' AttributeId ,
									(SELECT TOP 1  PimAttributeDefaultValueId FROM #DefaultAttributeValue Where PimAttributeId =  '
									+ CONVERT(VARCHAR(100), @AttributeId)+'AND  AttributeDefaultValueCode = TN.['+@SourceColumnName+'] ) PimAttributeDefaultValueId ,['
									+ @SourceColumnName+'],'+CONVERT(VARCHAR(100), @LocaleId)+'LocaleId
								, RowNumber FROM '+@TableName+' TN';
								print @SQLQuery
                    INSERT INTO @PimProductDetail( PimAttributeFamilyId, PimProductId,ProductAttributeCode, PimAttributeId, ProductAttributeDefaultValueId, AttributeValue, LocaleId, RowNumber )
					
					EXEC sys.sp_sqlexec @SQLQuery;
                    FETCH NEXT FROM Cr_AttributeDetails INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @PimAttributeFamilyId;
                 END;
             CLOSE Cr_AttributeDetails;
             DEALLOCATE Cr_AttributeDetails;
			 
			
			 if object_id('tempdb..#PimProductDetail1') is not null
				drop table #PimProductDetail1

			 Select * into #PimProductDetail1 from @PimProductDetail

			 UPDATE a 
			 SET ConfigureAttributeIds =  SUBSTRING((SELECT ','+CAST(c.PimAttributeId As VARCHAR(100)) 
			 FROM #PimProductDetail1 c 
			 INNER JOIN ZnodePimAttribute b ON (b.PimAttributeId = c.PimAttributeId)
			 WHERE IsConfigurable =1  AND c.RowNumber = a.RowNumber  FOR XML PATH('')),2,4000) 
			 FROM #PimProductDetail1 a 
			WHERE EXISTS (SELECT TOP 1 1 FROM #PimProductDetail1 ab  WHERE ab.RowNumber = a.RowNumber AND	ab.ProductAttributeCode = '[ProductType]' 
			 AND ab.AttributeValue = 'ConfigurableProduct' )
				
             -- In case of Yes/No : If value is not TRUE OR  1 then it will be  False else True
			 --If default Value set not need of hard code for IsActive
			 UPDATE ppdti SET ppdti.AttributeValue = CASE WHEN Upper(ISNULL(ppdti.AttributeValue, '')) in ( 'TRUE','1')  THEN 'true'  ELSE 'false' END FROM #PimProductDetail1 ppdti
                INNER JOIN #DefaultAttributeValue dav ON ppdti.PimAttributeId = dav.PimAttributeId WHERE   dav.AttributeTypeName = 'Yes/No';
            
		
		-----------Added Performance patch 
		DECLARE @PublishStateIdForDraft INT= [dbo].[Fn_GetPublishStateIdForDraftState]();
		DECLARE @PimDefaultFamily INT= dbo.Fn_GetDefaultPimProductFamilyId();
        DECLARE @pimSkuAttributeId VARCHAR(50)= [dbo].[Fn_GetProductSKUAttributeId]();
        DECLARE @PimIsDownlodableAttributeId VARCHAR(50)= [dbo].[Fn_GetIsDownloadableAttributeId]();
        DECLARE @PublishStateIdForNotPublished INT= [dbo].[Fn_GetPublishStateIdForForNotPublishedState]();

		DELETE FROM #PimProductDetail1 WHERE RTRIM(LTRIM(ISNULL(AttributeValue, ''))) = '';
        
		CREATE INDEX Inx_PimProductDetail_Bulk1 ON #PimProductDetail1(RowNumber);

        ------------------------------------Bulk Row Process
        DECLARE @MaxCount INT, @MinRow INT, @MaxRow INT, @Rows numeric(10,2);
        ---- Count of total rows for import
		SELECT @MaxCount = COUNT(*) FROM #PimProductDetail1;
		
		---- Count of rows in loop for import
		SELECT @Rows = (select top 1 FeatureValues from ZnodeGlobalSetting where FeatureName = 'ProductImportBulk')  --ceiling(@MaxCount/100.0)
        
		SELECT @MaxCount = CEILING(@MaxCount / @Rows);

        IF OBJECT_ID('tempdb..#Temp_ImportLoop') IS NOT NULL
            DROP TABLE #Temp_ImportLoop;
        
		---- To get the min and max rows for import in loop
		;WITH cte AS 
		(
			SELECT RowId = 1, 
				   MinRow = 1, 
                   MaxRow = cast(@Rows as int)
            UNION ALL
            SELECT RowId + 1, 
                   MinRow + cast(@Rows as int), 
                   MaxRow + cast(@Rows as int)
            FROM cte
            WHERE RowId + 1 <= @MaxCount
		)
        SELECT RowId, MinRow, MaxRow
        INTO #Temp_ImportLoop
        FROM cte
		option (maxrecursion 0);

        --while @MaxCount <= @minRow
        DECLARE cur_BulkData CURSOR LOCAL FAST_FORWARD
        FOR SELECT MinRow, MaxRow FROM #Temp_ImportLoop;

        OPEN cur_BulkData;
        FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow;

        WHILE @@FETCH_STATUS = 0
        BEGIN
		
		BEGIN TRAN ImportProducts;

			if object_id ('tempdb..#PimProductDetail_Bulk_Process')is not null
					drop table tempdb..#PimProductDetail_Bulk_Process

			CREATE TABLE #PimProductDetail_Bulk_Process
			([PimAttributeId]                 [INT] NULL, 
				[PimAttributeFamilyId]           [INT] NULL, 
				[ProductAttributeCode]           [VARCHAR](300) NULL, 
				[ProductAttributeDefaultValueId] [INT] NULL, 
				[PimAttributeValueId]            [INT] NULL, 
				[LocaleId]                       [INT] NULL, 
				[PimProductId]                   [INT] NULL, 
				[AttributeValue]                 [NVARCHAR](MAX) NULL, 
				[AssociatedProducts]             [NVARCHAR](4000) NULL, 
				[ConfigureAttributeIds]          [VARCHAR](2000) NULL, 
				[ConfigureFamilyIds]             [VARCHAR](2000) NULL, 
				[RowNumber]                      [INT] NULL, 
				SKU1                             VARCHAR(600),
				Id Int Identity(1,1)Primary Key
			);

			CREATE INDEX Inx_PimProductDetail_Bulk_Process ON #PimProductDetail_Bulk_Process(ProductAttributeCode, PimProductId);
			CREATE INDEX Inx_PimProductDetail_Bulk_Process1 ON #PimProductDetail_Bulk_Process(RowNumber);
			CREATE INDEX Inx_PimProductDetail_Bulk_Process2 ON #PimProductDetail_Bulk_Process(ProductAttributeCode)
			CREATE INDEX Inx_PimProductDetail_Bulk_Process3 ON #PimProductDetail_Bulk_Process(PimAttributeId, PimProductId);

			---- Insert rows for import in bulk
            INSERT INTO #PimProductDetail_Bulk_Process
            ([PimAttributeId], 
                [PimAttributeFamilyId], 
                [ProductAttributeCode], 
                [ProductAttributeDefaultValueId], 
                [PimAttributeValueId], 
                [LocaleId], 
                [PimProductId], 
                [AttributeValue], 
                [AssociatedProducts], 
                [ConfigureAttributeIds], 
                [ConfigureFamilyIds], 
                [RowNumber]
            )
            SELECT [PimAttributeId], 
                    [PimAttributeFamilyId], 
                    [ProductAttributeCode], 
                    [ProductAttributeDefaultValueId], 
                    [PimAttributeValueId], 
                    [LocaleId], 
                    [PimProductId], 
                    ltrim(rtrim([AttributeValue])), 
                    [AssociatedProducts], 
                    [ConfigureAttributeIds], 
                    [ConfigureFamilyIds], 
                    [RowNumber]
            FROM #PimProductDetail1 a
            WHERE a.[RowNumber] BETWEEN @MinRow AND @MaxRow;

			--select * from @PimProductDetail

			--select * from #PimProductDetail1



            ---------------------------Start Importing 
			if object_id ('tempdb..#TBL_DefaultAttributeId')is not null
				drop table #TBL_DefaultAttributeId

			if object_id ('tempdb..#TBL_MediaAttributeId')is not null
				drop table #TBL_MediaAttributeId

			if object_id ('tempdb..#TBL_TextAreaAttributeId')is not null
				drop table #TBL_TextAreaAttributeId

			if object_id ('tempdb..#TBL_MediaAttributeValue')is not null
				drop table #TBL_MediaAttributeValue

			if object_id ('tempdb..#TBL_DefaultAttributeValue')is not null
				drop table #TBL_DefaultAttributeValue

			if object_id ('tempdb..#ZnodePimAttributeValue')is not null
				drop table #ZnodePimAttributeValue

				
            CREATE TABLE #TBL_DefaultAttributeId ( PimAttributeId INT PRIMARY KEY, AttributeCode  VARCHAR(600) );

            CREATE TABLE #TBL_MediaAttributeId ( PimAttributeId INT PRIMARY KEY, AttributeCode  VARCHAR(600) );

            CREATE TABLE #TBL_TextAreaAttributeId ( PimAttributeId INT PRIMARY KEY, AttributeCode  VARCHAR(600) );
           
		    CREATE TABLE #TBL_MediaAttributeValue ( PimAttributeValueId INT, LocaleId INT, AttributeValue VARCHAR(300), MediaId INT );

            CREATE TABLE #TBL_DefaultAttributeValue ( PimAttributeValueId INT, LocaleId INT, AttributeValue INT );

            CREATE TABLE #ZnodePimAttributeValue (PimAttributeValueId  INT, PimAttributeFamilyId INT, PimAttributeId INT, PimProductId INT );

            DECLARE @ConfigureFamilyId VARCHAR(4000);

            INSERT INTO #TBL_DefaultAttributeId ( PimAttributeId, AttributeCode )
            SELECT PimAttributeId, AttributeCode
            FROM [dbo].[Fn_GetDefaultAttributeId]();

			INSERT INTO #TBL_MediaAttributeId (PimAttributeId, AttributeCode )
			SELECT PimAttributeId, AttributeCode
			FROM [dbo].[Fn_GetProductMediaAttributeId]();

            INSERT INTO #TBL_TextAreaAttributeId ( PimAttributeId, AttributeCode )
            SELECT PimAttributeId, AttributeCode
            FROM [dbo].[Fn_GetTextAreaAttributeId]();

            SELECT TOP 1 @PimAttributeFamilyId = PimAttributeFamilyId FROM #PimProductDetail_Bulk_Process;

			if object_id ('tempdb..#cte')is not null
				drop table #cte

            SELECT AttributeValue AS SKU, RowNumber
            INTO #cte
            FROM #PimProductDetail_Bulk_Process
            WHERE ProductAttributeCode = '[SKU]';
              
			

            CREATE INDEX Inx_cte_RowNumber ON #cte(RowNumber);
            UPDATE a SET a.SKU1 = B.SKU
            FROM #PimProductDetail_Bulk_Process a
            INNER JOIN #cte b ON a.RowNumber = b.RowNumber;

		
			
            SELECT TOP 1 @LocaleId = LocaleId FROM #PimProductDetail_Bulk_Process;

            ----Update ZNodePimProduct 
            UPDATE ZNodePimProduct
            SET PimAttributeFamilyId = DP.PimAttributeFamilyId, 
                PublishStateId = @PublishStateIdForDraft, 
                ModifiedBy = @UserId, 
                ModifiedDate = @GetDate
            FROM ZNodePimProduct ZPP
            INNER JOIN #PimProductDetail_Bulk_Process DP ON ZPP.PimProductId = DP.PimProductId;
      
			if object_id ('tempdb..#ZnodePimProduct')is not null
				drop table #ZnodePimProduct

			CREATE TABLE #ZnodePimProduct(PimProductId INT,ExternalId INT  Primary key)

			--create index Idx_ZnodePimProduct_ExternalId on #ZnodePimProduct(ExternalId)


			 

			----Insert into ZNodePimProduct 
            INSERT INTO ZnodePimProduct
            (PimAttributeFamilyId, 
                ExternalId, 
                CreatedBy, 
                CreatedDate, 
                ModifiedBy, 
                ModifiedDate, 
                PublishStateId
            )
			output inserted.PimProductId, inserted.ExternalId into #ZnodePimProduct(PimProductId,ExternalId)
            SELECT PimAttributeFamilyId, 
                    RowNumber, 
                    @UserId, 
                    @GetDate, 
                    @UserId, 
                    @GetDate, 
                    @PublishStateIdForNotPublished
            FROM #PimProductDetail_Bulk_Process
            WHERE ProductAttributeCode = '[SKU]'
            AND PimProductId IS NULL;
            
			----Update newly created productIds
            UPDATE a SET a.PimProductId = b.PimProductId
            FROM #PimProductDetail_Bulk_Process a
            INNER JOIN #ZnodePimProduct b ON a.RowNumber = b.ExternalId;

            ----Insert Downloadable products into ZnodePimDownloadableProduct
            INSERT INTO ZnodePimDownloadableProduct (SKU, ProductName, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate )
            SELECT PDSKU.AttributeValue, PDProdName.AttributeValue, @UserId, @GetDate, @UserId, @GetDate
            FROM #PimProductDetail_Bulk_Process PDSKU
            INNER JOIN #PimProductDetail_Bulk_Process PDProdName ON PDProdName.RowNumber = PDSKU.RowNumber
            INNER JOIN #PimProductDetail_Bulk_Process PDDownload ON PDDownload.RowNumber = PDSKU.RowNumber
            WHERE PDSKU.ProductAttributeCode = @pimSkuAttributeId
            AND PDProdName.ProductAttributeCode = '[SKU]'
            AND PDDownload.PimAttributeId = @PimIsDownlodableAttributeId
            AND PDDownload.AttributeValue = 'true'
            AND NOT EXISTS ( SELECT TOP 1 1 FROM ZnodePimDownloadableProduct WHERE ZnodePimDownloadableProduct.SKU = PDSKU.AttributeValue );

            ---- update ZnodePimAttributeValue : attribute data for Product
            UPDATE TARGET
            SET TARGET.PimAttributeFamilyId = CASE
                                                    WHEN Source.PimAttributeFamilyId = 0
                                                    THEN NULL
                                                    ELSE Source.PimAttributeFamilyId
                                                END, 
                    TARGET.ModifiedBy = @UserId, 
                    TARGET.ModifiedDate = @GetDate, 
                    TARGET.PimProductId = SOURCE.PimProductId
            OUTPUT INSERTED.PimAttributeValueId, 
                    INSERTED.PimAttributeFamilyId, 
                    INSERTED.PimAttributeId, 
                    INSERTED.PimProductId
                    INTO #ZnodePimAttributeValue
            FROM ZnodePimAttributeValue TARGET
            INNER JOIN #PimProductDetail_Bulk_Process SOURCE ON TARGET.PimProductId = SOURCE.PimProductId AND TARGET.PimAttributeId = SOURCE.PimAttributeId;
             
			---- Inserting attribute data for Product 
			INSERT INTO ZnodePimAttributeValue 
			( 
				PimAttributeFamilyId, 
				PimProductId, PimAttributeId, 
				PimAttributeDefaultValueId, 
				CreatedBy, 
				CreatedDate, 
				ModifiedBy, 
				ModifiedDate 
			)
            OUTPUT INSERTED.PimAttributeValueId, 
                    INSERTED.PimAttributeFamilyId, 
                    INSERTED.PimAttributeId, 
                    INSERTED.PimProductId
                    INTO #ZnodePimAttributeValue
            SELECT 
				CASE
                    WHEN Source.PimAttributeFamilyId = 0
                    THEN @PimDefaultFamily
                    ELSE Source.PimAttributeFamilyId
                END, 
                SOURCE.PimProductId, 
                ISNULL(SOURCE.PimAttributeId, 0),
                CASE
                    WHEN SOURCE.ProductAttributeDefaultValueId = 0
                    THEN NULL
                    ELSE SOURCE.ProductAttributeDefaultValueId
                END, 
                @UserId, 
                @GetDate, 
                @UserId, 
                @GetDate
            FROM #PimProductDetail_Bulk_Process SOURCE
            WHERE NOT EXISTS
            (
                SELECT *
                FROM ZnodePimAttributeValue TARGET
                WHERE TARGET.PimProductId = SOURCE.PimProductId
                        AND TARGET.PimAttributeId = SOURCE.PimAttributeId
            );

            -------------------------
			if object_id ('tempdb..#MediaData')is not null
				drop table #MediaData

            CREATE TABLE #MediaData (MediaId INT, PimProductId INT, PimAttributeId INT, PimAttributeFamilyId INT, LocaleId INT );

			---- Get Product Media Data
            INSERT INTO #MediaData ( MediaId , PimProductId , PimAttributeId , PimAttributeFamilyId , LocaleId )
            SELECT SP.Item, a.PimProductId, a.PimAttributeId, PimAttributeFamilyId, a.LocaleId
            FROM #PimProductDetail_Bulk_Process a
            INNER JOIN #TBL_MediaAttributeId c ON(c.PimAttributeId = a.PimAttributeId)
            CROSS APPLY dbo.split(a.AttributeValue, ',') SP;

			---- Get product media attribute data
            INSERT INTO #TBL_MediaAttributeValue ( PimAttributeValueId, LocaleId, AttributeValue, MediaId )
            SELECT a.PimAttributeValueId, b.LocaleId, zm.Path AttributeValue, ZM.MediaId
            FROM #ZnodePimAttributeValue AS a
            INNER JOIN #MediaData AS b ON(a.PimAttributeId = b.PimAttributeId
                                            AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0)
                                            AND a.PimProductId = b.PimProductId)
            INNER JOIN ZnodeMedia ZM ON(b.MediaId = ZM.MediaId);
     
			---- Deleting product media attribute
            DELETE FROM ZnodePimProductAttributeMedia
            WHERE EXISTS
            (
                SELECT TOP 1 1
                FROM #TBL_MediaAttributeValue TBLM
                WHERE ZnodePimProductAttributeMedia.PimAttributeValueId = TBLM.PimAttributeValueId
                        AND TBLM.MediaId <> ZnodePimProductAttributeMedia.MediaId
                        AND ZnodePimProductAttributeMedia.Localeid = @LocaleId
            );

            ---- update ZnodePimProductAttributeMedia : attribute data for Product
            UPDATE TARGET
                SET 
                    TARGET.MediaPath = SOURCE.AttributeValue, 
                    TARGET.MediaId = SOURCE.MediaId, 
                    TARGET.ModifiedBy = @UserId, 
                    TARGET.ModifiedDate = @GetDate
            FROM ZnodePimProductAttributeMedia TARGET
            INNER JOIN #TBL_MediaAttributeValue SOURCE ON TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                                                        AND TARGET.MediaPAth = SOURCE.AttributeValue
                                                        AND TARGET.LocaleId = SOURCE.LocaleId;
    
            ---- inserting Media attribute data for Product
            INSERT INTO ZnodePimProductAttributeMedia 
			( 
				PimAttributeValueId, 
				LocaleId, MediaPath, 
				MediaId, 
				CreatedBy, 
				CreatedDate, 
				ModifiedBy, 
                ModifiedDate
            )
            SELECT SOURCE.PimAttributeValueId, 
                    SOURCE.LocaleId, 
                    SOURCE.AttributeValue, 
                    SOURCE.MediaId, 
                    @UserId, 
                    @GetDate, 
                    @UserId, 
                    @GetDate
            FROM #TBL_MediaAttributeValue SOURCE
            WHERE NOT EXISTS
            (
                SELECT *
                FROM ZnodePimProductAttributeMedia TARGET
                WHERE TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                        AND TARGET.MediaPAth = SOURCE.AttributeValue
                        AND TARGET.LocaleId = SOURCE.LocaleId
            );

            --------------------------
			if object_id ('tempdb..#Cte_TextAreaAttributeValue')is not null
				drop table #Cte_TextAreaAttributeValue

			---- Getting text area data in temp #Cte_TextAreaAttributeValue
            SELECT a.PimAttributeValueId, 
                    b.LocaleId, 
                    AttributeValue
            INTO #Cte_TextAreaAttributeValue
            FROM #ZnodePimAttributeValue AS a
            INNER JOIN #PimProductDetail_Bulk_Process AS b ON(a.PimAttributeId = b.PimAttributeId
                                                            AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0)
                                                            AND a.PimProductId = b.PimProductId)
            INNER JOIN #TBL_TextAreaAttributeId c ON(c.PimAttributeId = b.PimAttributeId);

            ---- update ZnodePimProductAttributeTextAreaValue : attribute data for Product
            UPDATE TARGET
            SET TARGET.AttributeValue = SOURCE.AttributeValue, 
                TARGET.CreatedBy = @UserId, 
                TARGET.ModifiedBy = @UserId, 
                TARGET.ModifiedDate = @GetDate
            FROM ZnodePimProductAttributeTextAreaValue TARGET
            INNER JOIN #Cte_TextAreaAttributeValue SOURCE ON TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                                                                      AND TARGET.LocaleId = SOURCE.LocaleId;

            ---- inserting TextAreaValue attribute data for Product
            INSERT INTO ZnodePimProductAttributeTextAreaValue
            (
				PimAttributeValueId, 
                LocaleId, 
                AttributeValue, 
                CreatedBy, 
                CreatedDate, 
                ModifiedBy, 
                ModifiedDate
            )
            SELECT SOURCE.PimAttributeValueId, 
                    SOURCE.LocaleId, 
                    SOURCE.AttributeValue, 
                    @UserId, 
                    @GetDate, 
                    @UserId, 
                    @GetDate
            FROM #Cte_TextAreaAttributeValue SOURCE
            WHERE NOT EXISTS
            (
                SELECT *
                FROM ZnodePimProductAttributeTextAreaValue TARGET
                WHERE TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                        AND TARGET.LocaleId = SOURCE.LocaleId
            );
           
		    ---- Getting attribute default values for product
            INSERT INTO #TBL_DefaultAttributeValue ( PimAttributeValueId, LocaleId, AttributeValue )
            SELECT a.PimAttributeValueId, b.LocaleId, d.PimAttributeDefaultValueId AttributeValue
            FROM #ZnodePimAttributeValue AS a
            INNER JOIN #PimProductDetail_Bulk_Process AS b ON(a.PimAttributeId = b.PimAttributeId
                                                                AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0)
                                                                AND a.PimProductId = b.PimProductId)
            INNER JOIN #TBL_DefaultAttributeId c ON(c.PimAttributeId = b.PimAttributeId)
            CROSS APPLY dbo.split(b.AttributeValue, ',') SP
            INNER JOIN ZnodePimAttributeDefaultValue d ON d.PimAttributeId = b.PimAttributeId
                                                            AND SP.Item = d.AttributeDefaultValueCode;
			---- Deleting prodyuct attribute default value
            DELETE FROM ZnodePimProductAttributeDefaultValue
            WHERE EXISTS
            (
                SELECT TOP 1 1
                FROM #TBL_DefaultAttributeValue TBLAV
                WHERE TBLAV.PimAttributeValueId = ZnodePimProductAttributeDefaultValue.PimAttributeValueId
                        AND TBLAV.AttributeValue <> ZnodePimProductAttributeDefaultValue.PimAttributeDefaultValueId
                        AND ZnodePimProductAttributeDefaultValue.LocaleId = @LocaleId
            );

			---- update ZnodePimProductAttributeDefaultValue : attribute data for Product
			UPDATE TARGET
			SET TARGET.PimAttributeDefaultValueId = SOURCE.AttributeValue, 
				TARGET.ModifiedBy = @UserId, 
				TARGET.ModifiedDate = @GetDate
			FROM ZnodePimProductAttributeDefaultValue TARGET
					INNER JOIN #TBL_DefaultAttributeValue SOURCE ON TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
																	AND TARGET.PimAttributeDefaultValueId = SOURCE.AttributeValue
																	AND TARGET.LocaleId = SOURCE.LocaleId;

            ---- insert ZnodePimProductAttributeDefaultValue : attribute data for Product
            INSERT INTO ZnodePimProductAttributeDefaultValue
            (
				PimAttributeValueId, 
                LocaleId, 
                PimAttributeDefaultValueId, 
                CreatedBy, 
                CreatedDate, 
                ModifiedBy, 
                ModifiedDate
            )
            SELECT 
				SOURCE.PimAttributeValueId, 
                SOURCE.LocaleId, 
                SOURCE.AttributeValue, 
                @UserId, 
                @GetDate, 
                @UserId, 
                @GetDate
            FROM #TBL_DefaultAttributeValue SOURCE
            WHERE NOT EXISTS
            (
                SELECT *
                FROM ZnodePimProductAttributeDefaultValue TARGET
                WHERE TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                        AND TARGET.PimAttributeDefaultValueId = SOURCE.AttributeValue
                        AND TARGET.LocaleId = SOURCE.LocaleId
            );
               

            IF OBJECT_ID('tempdb..#cte_ZnodePimAttributeValue') IS NOT NULL
                DROP TABLE #cte_ZnodePimAttributeValue;

			CREATE TABLE #cte_ZnodePimAttributeValue(PimAttributeValueId int, LocaleId int, AttributeValue nvarchar(max))

			CREATE INDEX Idx_cte_ZnodePimAttributeValue on #cte_ZnodePimAttributeValue(PimAttributeValueId, LocaleId)

			INSERT INTO #cte_ZnodePimAttributeValue (PimAttributeValueId, LocaleId, AttributeValue)
            SELECT a.PimAttributeValueId, b.LocaleId,AttributeValue                
            FROM #ZnodePimAttributeValue AS a
            INNER JOIN #PimProductDetail_Bulk_Process AS b ON(a.PimAttributeId = b.PimAttributeId
                                                                AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0)
                                                                AND a.PimProductId = b.PimProductId)
            WHERE NOT EXISTS ( SELECT TOP 1 1 FROM #TBL_DefaultAttributeId TBLDA WHERE TBLDA.PimAttributeId = b.PimAttributeId )
            AND NOT EXISTS ( SELECT TOP 1 1 FROM #TBL_MediaAttributeId TBLMA WHERE TBLMA.PimAttributeId = b.PimAttributeId )
            AND NOT EXISTS ( SELECT TOP 1 1 FROM #TBL_TextAreaAttributeId TBLTA WHERE TBLTA.PimAttributeId = b.PimAttributeId );

            ---- update ZnodePimAttributeValueLocale : attribute data for Product
            UPDATE TARGET
            SET TARGET.AttributeValue = SOURCE.AttributeValue, 
                TARGET.ModifiedBy = @UserId, 
                TARGET.ModifiedDate = @GetDate
            FROM ZnodePimAttributeValueLocale TARGET
            INNER JOIN #cte_ZnodePimAttributeValue SOURCE ON TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                                                           AND TARGET.LocaleId = SOURCE.LocaleId;

            ---- inserting AttributeDefaultValue : attribute data for Product
            INSERT INTO ZnodePimAttributeValueLocale
            (
				PimAttributeValueId, 
                LocaleId, 
                AttributeValue, 
                CreatedBy, 
                CreatedDate, 
                ModifiedBy, 
                ModifiedDate
            )
            SELECT 
				SOURCE.PimAttributeValueId, 
                SOURCE.LocaleId, 
                SOURCE.AttributeValue, 
                @UserId, 
                @GetDate, 
                @UserId, 
                @GetDate
            FROM #cte_ZnodePimAttributeValue SOURCE
            WHERE NOT EXISTS
            (
                SELECT *
                FROM ZnodePimAttributeValueLocale TARGET
                WHERE TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                        AND TARGET.LocaleId = SOURCE.LocaleId
            );

			---- Inserting configurable products into ZnodePimConfigureProductAttribute
            INSERT INTO [ZnodePimConfigureProductAttribute]
            (PimProductId, 
                PimFamilyId, 
                PimAttributeId, 
                CreatedBy, 
                CreatedDate, 
                ModifiedBy, 
                ModifiedDate
            )
            SELECT DISTINCT PD.PimProductId, 
                    NULL, 
                    q.PimAttributeId, 
                    @UserId, 
                    @GetDate, 
                    @UserId, 
                    @GetDate
            FROM #PimProductDetail_Bulk_Process PD
                CROSS APPLY dbo.Split([ConfigureAttributeIds], ',') AS b
                INNER JOIN ZnodePimAttribute AS q ON(q.PimAttributeId = b.Item)
            WHERE NOT EXISTS
            (
                SELECT TOP 1 1
                FROM ZnodePimConfigureProductAttribute RTR
                WHERE RTR.PimProductId = PD.PimProductId
                        AND RTR.PimAttributeId = q.PimAttributeId
            );


			COMMIT TRAN ImportProducts;

            FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow;
        END;
    CLOSE cur_BulkData;
    DEALLOCATE cur_BulkData;

	-----------Added Performance patch end

		---- Update family of Product in table ZnodePimConfigureProductAttribute 
		UPDATE ZnodePimConfigureProductAttribute
		SET PimFamilyId = b.PimAttributeFamilyId
		FROM ZnodePimConfigureProductAttribute a
				INNER JOIN ZnodePimProduct b ON a.PimProductId = b.PimProductId;

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

             COMMIT TRAN ImportProducts;


			 
	 DELETE FROM ZnodePimConfigureProductAttribute  
            WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePimAttributeValue  a WHERE a.PimProductId = ZnodePimConfigureProductAttribute.PimProductId
            AND a.PimAttributeID = ZnodePimConfigureProductAttribute.PimAttributeID )
            --AND EXISTS (SELECT TOP 1 1 FROM ZnodePimAttributeValue a 
            --INNER JOIN ZnodePimAttribute ty ON (ty.PimAttributeId = a.PimAttributeId)
            --INNER JOIN ZnodePimProductAttributeDefaultValue t ON (t.PimAttributeValueId = a.PimAttributeValueId )
            --INNER JOIN ZnodePimAttributeDefaultValue y ON (y.PimAttributeDefaultValueId = t.PimAttributeDefaultValueId)
            --INNER JOIN View_loadmanageProductInternal  TU ON (TU.AttributeCode = 'SKU' AND TU.PimProductId = a.PimProductId  )
            --WHERE ty.AttributeCode = 'ProductType' AND y.AttributeDefaultValueCode = 'ConfigurableProduct'
            --AND a.PimProductId = ZnodePimConfigureProductAttribute.PimProductId
            AND EXISTS (SELECT TOP 1 1 FROM #PimProductDetail1 TM WHERE TM.PimProductId = ZnodePimConfigureProductAttribute.PimProductId )
   
						
		----Delete simple products if inserted in table ZnodePimConfigureProductAttribute 
		DELETE FROM ZnodePimConfigureProductAttribute
		WHERE EXISTS
		(
			SELECT TOP 1 1
			FROM ZnodePimAttributeValue a
					INNER JOIN ZnodePimAttribute ty ON(ty.PimAttributeId = a.PimAttributeId)
					INNER JOIN ZnodePimProductAttributeDefaultValue t ON(t.PimAttributeValueId = a.PimAttributeValueId)
					INNER JOIN ZnodePimAttributeDefaultValue y ON(y.PimAttributeDefaultValueId = t.PimAttributeDefaultValueId)
			WHERE ty.AttributeCode = 'ProductType'
					AND y.AttributeDefaultValueCode = 'SimpleProduct'
					AND a.PimProductId = ZnodePimConfigureProductAttribute.PimProductId
		);

         END TRY
         BEGIN CATCH
		 ROLLBACK TRAN ImportProducts;

		

		  INSERT INTO ZnodeImportLog(ErrorDescription,ColumnName,Data,RowNumber,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
                 Select  46,ERROR_PROCEDURE(),ERROR_MESSAGE(),ERROR_LINE(),@newGUID,@UserId,@GetDate,@UserId,@GetDate, @ImportProcessLogId  
		
		SET @SQLQuery = ' Select @FailedRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
					EXEC	sp_executesql @SQLQuery , N'@FailedRecordCount BIGINT out' , @FailedRecordCount =@FailedRecordCount out
					--SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS  NULL AND  ImportProcessLogId = @ImportProcessLogId;
					SELECT @SuccessRecordCount = 0
									
					UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
					WHERE ImportProcessLogId = @ImportProcessLogId;

		 UPDATE ZnodeImportProcessLog
			SET 
				STATUS = dbo.Fn_GetImportStatus(3), 
				ProcessCompletedDate = GETDATE()
		WHERE ImportProcessLogId = @ImportProcessLogId;
             SELECT ERROR_MESSAGE(),ERROR_LINE(),ERROR_PROCEDURE();
            -- UPDATE ZnodeImportProcessLog SET Status = dbo.Fn_GetImportStatus(3), ProcessCompletedDate = @GetDate WHERE ImportProcessLogId = @ImportProcessLogId;
            -- ROLLBACK TRAN ImportProducts;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishAssociatedAddonsJson')
	DROP PROC Znode_GetPublishAssociatedAddonsJson
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishAssociatedAddonsJson]
(
	@PublishCatalogId NVARCHAR(MAX) = 0,
	@PimProductId    TransferId Readonly,
	@VersionId        INT           = 0,
	@UserId           INT,														 
	@PimCategoryHierarchyId int = 0, 
	@LocaleId       TransferId READONLY,
	@PublishStateId INT = 0, 
	@VersionIdString  VARCHAR(2000)= '',
	@Status		   Bit  OutPut,
	@RevisionType Varchar(50)
)
AS 
   
/*
    Summary : If PimcatalogId is provided get all products with Addons and provide above mentioned data
       If PimProductId is provided get all Addons if associated with given product id and provide above mentioned data
    			Input: @PublishCatalogId or @PimProductId
    		    output should be in XML format
       sample xml5
    Begin transaction  
	 declare  @PimProductId TransferId 
	 Declare @Status bit 
	 INSERT INTO @PimProductId  values (768)

			Exec [_Znode_GetPublishAssociatedAddonsJson]
				@PublishCatalogId = 5 ,
				--@PimProductId   = @PimProductId,
				@UserId =2,														 
				@VersionIdString = '',--'1662,1664,1663,1665',
				@Status	 =@Status Out,
				@RevisionType= 'Production'
				rollback transaction
				--SELECT * from ZnodePublishVersionEntity 
   
	*/

BEGIN
    BEGIN TRY
    SET NOCOUNT ON 
		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
        DECLARE @LocaleIdIn INT, @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId()
		, @Counter INT= 1
		, @MaxRowId INT= 0;

	UPDATE ZnodePublishAddonEntity SET ElasticSearchEvent = 0
    -- DECLARE @PimAddOnGroupId VARCHAR(MAX);

		CREATE TABLE #TBL_PublisshIds  (PublishProductId INT , PimProductId INT , PublishCatalogId INT)
		DECLARE @TBL_LocaleId TABLE (RowId    INT IDENTITY(1, 1),LocaleId INT);
		IF OBJECT_ID('tempdb..#VesionIds') is not null
		DROP TABLE #VesionIds
		Create Table #VesionIds(ZnodeCatalogId int , VersionId int , LocaleId int , RevisionType varchar(50) )

  		If @VersionIdString <> ''
		BEGIN
		
			Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)	
			SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType
			FROM ZnodePublishVersionEntity PV Inner join Split(@VersionIdString,',') S ON PV.VersionId = S.Item
		END
		Else 
		Begin
			If  (@RevisionType like '%Preview%'  OR @RevisionType like '%Production%')
			BEGIN
				Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)	
				SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV  where PV.IsPublishSuccess =1 
				AND PV.RevisionType ='Preview'
			END
			If  (@RevisionType like '%Production%' OR @RevisionType = 'None')
			BEGIN
				Insert into #VesionIds (ZnodeCatalogId, VersionId, LocaleId, RevisionType)	
				SELECT PV.ZnodeCatalogId, PV.VersionId, PV.LocaleId, PV.RevisionType FROM ZnodePublishVersionEntity PV  where PV.IsPublishSuccess =1 
				AND PV.RevisionType ='Production'
			END					
		End 

	
		IF (@PublishCatalogId IS NULL OR @PublishCatalogId = 0)
		BEGIN 
			INSERT INTO #TBL_PublisshIds 
			EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId,@userid,@PimProductId,1
		END 
		IF ISnull(@PimCategoryHierarchyId,0) <> 0 
		BEGIN 
			INSERT INTO #TBL_PublisshIds 
			EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId,@userid,@PimProductId,1,@PimCategoryHierarchyId 
		END 

		CREATE TABLE #TBL_PublishCatalogId (PublishCatalogId INT,PublishProductId INT,PimProductId  INT , VersionId INT ,LocaleId INT  );

		IF  ISnull(@PimCategoryHierarchyId,0) <> 0 
		BEGIN 
			INSERT INTO #TBL_PublishCatalogId 
			SELECT ZPP.PublishCatalogId , ZPP.PublishProductId,PimProductId, MAX(ZPCP.PublishCatalogLogId)  ,LocaleId 
			FROM ZnodePublishProduct ZPP 
			INNER JOIN ZnodePublishCatalogLog ZPCP ON (ZPCP.PublishCatalogId  = ZPP.PublishCatalogId)
			WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId   ) 
			AND ZPCP.Publishstateid = @PublishStateId
			GROUP BY ZPP.PublishCatalogId,ZPP.PublishProductId,PimProductId,LocaleId 
		END 
		ELSE 
		Begin
			INSERT INTO #TBL_PublishCatalogId  
			SELECT ZPP.PublishCatalogId , ZPP.PublishProductId,PimProductId,0  VersionId  ,0 LocaleId 
			FROM ZnodePublishProduct ZPP  
			WHERE EXISTS  (SELECT TOP 1 1 FROM #VesionIds ZPCP WHERE (ZPCP.ZnodeCatalogId  = ZPP.PublishCatalogId)) AND
			(EXISTS (SELECT TOP 1 1 FROM #TBL_PublisshIds SP WHERE SP.PublishProductId = ZPP.PublishProductId  
			AND  @PublishCatalogId = '0' )  OR (ZPP.PublishCatalogId =  @PublishCatalogId ))
		END
        DECLARE @TBL_AddonGroupLocale TABLE( PimAddonGroupId INT, DisplayType NVARCHAR(400),AddonGroupName NVARCHAR(MAX),LocaleId INT );
        INSERT INTO @TBL_LocaleId(LocaleId)
        SELECT LocaleId FROM ZnodeLocale MT  WHERE IsActive = 1 AND (EXISTS (SELECT TOP 1 1  FROM @LocaleId RT WHERE RT.Id = MT.LocaleId )
			OR NOT EXISTS (SELECT TOP 1 1 FROM @LocaleId ));
        SET @MaxRowId = ISNULL(( SELECT MAX(RowId) FROM @TBL_LocaleId ), 0);
    
        WHILE (@Counter <= @MaxRowId)
        BEGIN
            SET @LocaleIdIn =( SELECT LocaleId FROM @TBL_LocaleId WHERE RowId = @Counter );
            INSERT INTO @TBL_AddonGroupLocale (PimAddonGroupId, DisplayType, AddonGroupName)
            EXEC Znode_GetAddOnGroupLocale '', @LocaleIdIn;
	   		UPDATE @TBL_AddonGroupLocale SET LocaleId = @LocaleIdIn WHERE LocaleId IS NULL 
            SET @Counter = @Counter + 1;
        END;
		
		IF OBJECT_ID('tempdb..#AddonProductPublishedXML') is not null
		drop table #AddonProductPublishedXML
						
		SELECT  ZPPP.PublishProductId,ZPPP.PublishCatalogId,V.LocaleId,v.VersionId,
		ZPPP.[PublishProductId]  ZnodeProductId,
		ZPPP.[PublishCatalogId] ZnodeCatalogId,
		ZPP.PublishProductId  AssociatedZnodeProductId,
		ZPAOP.DisplayOrder DisplayOrder,
		ZPOPD.DisplayOrder AssociatedProductDisplayOrder,
		RequiredType ,
		DisplayType, 
		ISNULL((select ''+AddonGroupName for xml path('')),'') GroupName,
		ISnull(IsDefault,0) IsDefault
		INTO #AddonProductPublishedXML
		FROM [ZnodePimAddOnProductDetail] AS ZPOPD
		INNER JOIN [ZnodePimAddOnProduct] AS ZPAOP ON ZPOPD.[PimAddOnProductId] = ZPAOP.[PimAddOnProductId]
		INNER JOIN #TBL_PublishCatalogId ZPPP ON (ZPPP.PimProductId = ZPAOP.PimProductId )
		INNER JOIN #TBL_PublishCatalogId ZPP ON(ZPP.PimProductId = ZPOPD.[PimChildProductId] AND ZPP.PublishCatalogId = ZPPP.PublishCatalogId  )
		INNER JOIN #VesionIds V ON ZPPP.PublishCatalogId  = V.ZnodeCataLogId
		INNER JOIN @TBL_AddonGroupLocale TBAG ON (TBAG.PimAddonGroupId   = ZPAOP.PimAddonGroupId AND TBAG.LocaleId = V.LocaleId )
	
		If (isnull(@PublishCatalogId ,'') = '' and @VersionIdString = '') OR 
			(isnull(@PublishCatalogId ,'') = 0 and @VersionIdString = '')
		Begin 
			UPDATE ZnodePublishAddonEntity 
			SET ElasticSearchEvent = 2
			WHERE PublishAddonEntityId  IN (
											SELECT PublishAddonEntityId
											FROM ZnodePublishAddonEntity BP
											INNER JOIN #AddonProductPublishedXML A ON BP.ZnodeProductId =A.PublishProductId
												AND BP.ZnodeCatalogId = A.PublishCatalogId AND BP.VersionId = A.VersionId
											) 
			AND EXISTS(SELECT * FROM #VesionIds V WHERE V.VersionId = ZnodePublishAddonEntity.VersionId) 

			----Delete addon entries having parent data removed
			UPDATE ZPAE 
			SET ElasticSearchEvent = 2
			FROM ZnodePublishAddonEntity ZPAE
			WHERE NOT EXISTS (SELECT * from [ZnodePimAddOnProduct] ZPAOP 
					INNER JOIN ZnodePublishProduct ZPPP ON (ZPPP.PimProductId = ZPAOP.PimProductId )
					WHERE ZPAE.ZnodeProductId = ZPPP.PublishProductId AND ZPAE.ZnodeCatalogId = ZPPP.PublishCatalogId)
			AND EXISTS(SELECT * FROM #VesionIds V WHERE V.VersionId = ZPAE.VersionId)
		End 

		IF NOT EXISTS(SELECT * FROM @PimProductId)
		BEGIN
			----Delete addon entries having parent data present but all addon removed
			SELECT zppp1.PublishCatalogId,ZPPP1.PublishProductId,ZPPP.PublishProductId as AssociatedZnodeProductId  
			INTO #TempAddonProduct
			FROM [ZnodePimAddOnProductDetail] AS ZPOPD
			INNER JOIN [ZnodePimAddOnProduct] AS ZPAOP ON ZPOPD.[PimAddOnProductId] = ZPAOP.[PimAddOnProductId]
			INNER JOIN ZnodePublishProduct ZPPP1 ON (ZPPP1.PimProductId = ZPAOP.PimProductId )
			INNER JOIN ZnodePublishProduct ZPPP ON (ZPPP.PimProductId = ZPOPD.PimChildProductId )

			UPDATE ZPAE 
			SET ElasticSearchEvent = 2
			FROM ZnodePublishAddonEntity ZPAE
			WHERE not EXISTS (SELECT * from #TempAddonProduct ZPPP
					WHERE ZPAE.ZnodeProductId = ZPPP.PublishProductId AND ZPAE.ZnodeCatalogId = ZPPP.PublishCatalogId)
			AND EXISTS(SELECT * FROM #VesionIds V WHERE V.VersionId = ZPAE.VersionId)

			UPDATE ZPAE 
			SET ElasticSearchEvent = 2
			FROM ZnodePublishAddonEntity ZPAE
			WHERE EXISTS (SELECT * from #TempAddonProduct ZPPP
					WHERE ZPAE.ZnodeProductId = ZPPP.PublishProductId AND ZPAE.ZnodeCatalogId = ZPPP.PublishCatalogId)
			AND not EXISTS (SELECT * from #TempAddonProduct ZPPP1
					WHERE ZPAE.AssociatedZnodeProductId = ZPPP1.AssociatedZnodeProductId AND ZPAE.ZnodeProductId = ZPPP1.PublishProductId  AND ZPAE.ZnodeCatalogId = ZPPP1.PublishCatalogId)
			AND EXISTS(SELECT * FROM #VesionIds V WHERE V.VersionId = ZPAE.VersionId)
				
			UPDATE PCE SET PCE.AssociatedProductDisplayOrder = Isnull(CE.AssociatedProductDisplayOrder,0),
				PCE.GroupName = CE.GroupName,PCE.DisplayType = CE.DisplayType,
				PCE.DisplayOrder = CE.DisplayOrder,
				PCE.IsRequired = 1 ,PCE.RequiredType = CE.RequiredType,PCE.IsDefault = CE.IsDefault,
				PCE.ElasticSearchEvent = 2
			FROM #AddonProductPublishedXML CE
			INNER JOIN ZnodePublishAddonEntity PCE ON CE.VersionId = PCE.VersionId
			AND PCE.LocaleId = CE.LocaleId AND PCE.ZnodeCatalogId = CE.PublishCatalogId AND CE.ZnodeProductId = PCE.ZnodeProductId
			AND PCE.AssociatedZnodeProductId = CE.AssociatedZnodeProductId AND PCE.ElasticSearchEvent <> 2
			AND EXISTS(SELECT * FROM #VesionIds V WHERE V.VersionId = PCE.VersionId)
		END
		ELSE
		BEGIN
			----Delete addon entries having parent data present but all addon removed
			SELECT zppp1.PublishCatalogId,ZPPP1.PublishProductId,ZPPP.PublishProductId as AssociatedZnodeProductId  
			INTO #TempAddonProductSingleProduct
			FROM [ZnodePimAddOnProductDetail] AS ZPOPD
			INNER JOIN [ZnodePimAddOnProduct] AS ZPAOP ON ZPOPD.[PimAddOnProductId] = ZPAOP.[PimAddOnProductId]
			INNER JOIN ZnodePublishProduct ZPPP1 ON (ZPPP1.PimProductId = ZPAOP.PimProductId )
			INNER JOIN ZnodePublishProduct ZPPP ON (ZPPP.PimProductId = ZPOPD.PimChildProductId )
			where EXISTS(SELECT * FROM @PimProductId x WHERE ZPAOP.PimProductId = X.Id)

			DELETE ZPAE FROM ZnodePublishAddonEntity ZPAE
			WHERE not EXISTS (SELECT * from #TempAddonProductSingleProduct)
			AND EXISTS(SELECT * FROM @PimProductId x INNER JOIN ZnodePublishProduct ZP ON ZP.PimProductId = x.Id WHERE ZPAE.ZnodeProductId = ZP.PublishProductId) 
			AND EXISTS(SELECT * FROM #VesionIds V WHERE V.VersionId = ZPAE.VersionId)
			
			DELETE ZPAE  
			FROM ZnodePublishAddonEntity ZPAE
			WHERE EXISTS (SELECT * from #TempAddonProductSingleProduct ZPPP
					WHERE ZPAE.ZnodeProductId = ZPPP.PublishProductId AND ZPAE.ZnodeCatalogId = ZPPP.PublishCatalogId)
			AND not EXISTS (SELECT * from #TempAddonProductSingleProduct ZPPP1
					WHERE ZPAE.AssociatedZnodeProductId = ZPPP1.AssociatedZnodeProductId AND ZPAE.ZnodeProductId = ZPPP1.PublishProductId  AND ZPAE.ZnodeCatalogId = ZPPP1.PublishCatalogId)
			AND EXISTS(SELECT * FROM #VesionIds V WHERE V.VersionId = ZPAE.VersionId)
			
		END

			Insert into  ZnodePublishAddonEntity
			(VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,
				LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault,ElasticSearchEvent)
			Select 
				VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,Isnull(AssociatedProductDisplayOrder,0),
				LocaleId,GroupName,DisplayType,DisplayOrder,1 IsRequired,RequiredType,IsDefault, 1 AS ElasticSearchEvent
			from #AddonProductPublishedXML CE
			WHERE NOT EXISTS(SELECT * FROM ZnodePublishAddonEntity PCE WHERE CE.VersionId = PCE.VersionId
			AND PCE.LocaleId = CE.LocaleId AND PCE.ZnodeCatalogId = CE.PublishCatalogId AND CE.ZnodeProductId = PCE.ZnodeProductId
			AND PCE.AssociatedZnodeProductId = CE.AssociatedZnodeProductId AND PCE.ElasticSearchEvent <> 2)
		
		SET @Status = 1;
            
    END TRY
    BEGIN CATCH
		SELECT ERROR_MESSAGE(),ERROR_PROCEDURE()
            
        SET @Status = 0;
        DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishAssociatedAddonsJson @PublishCatalogId = '+@PublishCatalogId+',@VersionId='+CAST(@VersionId AS VARCHAR(50))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
        SELECT 0 AS ID,
            CAST(0 AS BIT) AS Status;
        EXEC Znode_InsertProcedureErrorLog
            @ProcedureName = 'Znode_GetPublishAssociatedAddonsJson',
            @ErrorInProcedure = @Error_procedure,
            @ErrorMessage = @ErrorMessage,
            @ErrorLine = @ErrorLine,
            @ErrorCall = @ErrorCall;
    END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportValidateManditoryData')
	DROP PROC Znode_ImportValidateManditoryData
GO


IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportValidateMandatoryData')
	DROP PROC Znode_ImportValidateMandatoryData
GO

CREATE PROCEDURE [dbo].[Znode_ImportValidateMandatoryData]
   (@TableName        VARCHAR(200),
    @SourceColumnName NVARCHAR(600),
    @CreateDateString NVARCHAR(300),
    @ValidationName   VARCHAR(100),
    @ControlName      VARCHAR(300),
    @ValidationValue  VARCHAR(300),
    @NewGUID          NVARCHAR(200),
    @ImportHeadId     INT           = 0)
AS

/* 
Summary: Validate Manditory data for import process , Also generate error log
Unit Testing:
EXEC Znode_ImportValidateMandatoryData

*/
     BEGIN
         BEGIN TRY
		 SET NOCOUNT ON
             DECLARE @SQLQuery NVARCHAR(MAX), @ImportHeadName NVARCHAR(100);
             SET @ImportHeadName = DBO.Fn_GetDefaultImportHead(@ImportHeadId);
             SET @SQLQuery = @TableName+' WHERE '+DBO.Fn_Trim(@SourceColumnName)+'= '''' OR '+@SourceColumnName+' Is Null ;';

             EXEC Znode_ImportGenerateErrorLog
                  @ImportHeadName = @ImportHeadName,
                  @QueryCriteria = @SQLQuery,
                  @SourceColumnName = @SourceColumnName,
                  @CreateDateString = @CreateDateString,
                  @ErrorCode = '8';
         END TRY
         BEGIN CATCH
				DECLARE @Status BIT ;
				SET @Status = 0;
				DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportValidateMandatoryData @TableName = '+@TableName+',@SourceColumnName='+@SourceColumnName+',@CreateDateString='+@CreateDateString+',@ValidationName='+@ValidationName+',@ControlName = '+@ControlName+',@ValidationValue='+@ValidationValue+',@NewGUID='+@NewGUID+',@ImportHeadId='+CAST(@ImportHeadId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
				SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
				EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_ImportValidateMandatoryData',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportPartialValidatePimProductData')
	DROP PROC Znode_ImportPartialValidatePimProductData
GO

CREATE PROCEDURE [dbo].[Znode_ImportPartialValidatePimProductData]
(   @ImportHeadName     VARCHAR(200),
    @TableName          VARCHAR(200),
    @NewGUID            NVARCHAR(200),
    @TemplateId         INT,
    @UserId             INT,
    @LocaleId           INT           = 1,
    @IsCategory         INT           = 0,
    @DefaultFamilyId    INT           = 0,
    @ImportProcessLogId INT,
    @PriceListId        INT,
	@CountryCode VARCHAR(100) = '',
	@PimCatalogId         INT    = 0 ,
	@PortalId int = 0,
	@IsAccountAddress bit = 0  
)
AS
     SET NOCOUNT ON;

/*
    Summary :   Import PimProduct ( for partial attribute import ) 
    Process :   Admin site will upload excel / csv file in database and create global temporary table
				Procedure Znode_ImportValidatePimProductData will validate data with attribute validation rule
				If datatype validation issue found in input daata will logged into table "ZnodeImportLog"
				If Data is correct and record count in table ZnodeImportLog will be 0 then process for import data into Base tables
				To import data call procedure "Znode_ImportPimProductData"
    		  
				SourceColumnName: CSV file column headers
				TargetColumnName: Attributecode from ZnodePimAttribute Table (Consider those Attributecodes configured with default family only)
*/

     BEGIN
         BEGIN TRY
             SET NOCOUNT ON;
             --BEGIN TRAN TRN_ImportValidProductData;
             DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
             DECLARE @SQLQuery NVARCHAR(MAX), @AttributeTypeName NVARCHAR(10), @AttributeCode NVARCHAR(300), @AttributeId INT, @IsRequired BIT, @SourceColumnName NVARCHAR(600), @ControlName VARCHAR(300), @ValidationName VARCHAR(100), @SubValidationName VARCHAR(300), @ValidationValue VARCHAR(300), @RegExp VARCHAR(300), @CreateDateString NVARCHAR(300), @DefaultLocaleId INT, @ImportHeadId INT, @CheckedSourceColumn NVARCHAR(600)= '', @Status BIT= 0,
			    @CsvColumnString nvarchar(max), @FailedRecordCount BIGINT,
				@SuccessRecordCount BIGINT
              --To get the total record count for update purpose in catch block
             SET @SQLQuery = 'SELECT '+CAST(@ImportProcessLogId AS VARCHAR(10))+',COUNT(*) FROM '+@TableName
			 INSERT INTO Znode_ImportCsvRowCount
			 EXEC (@SQLQuery) 

			UPDATE ZnodeImportProcessLog
			SET Status = dbo.Fn_GetImportStatus(0)
			WHERE ImportProcessLogId = @ImportProcessLogId AND Status IS NULL;

             DECLARE @FamilyAttributeDetail TABLE
             (PimAttributeId       INT,
              AttributeTypeName    VARCHAR(300),
              AttributeCode        VARCHAR(300),
              SourceColumnName     NVARCHAR(600),
              IsRequired           BIT,
              PimAttributeFamilyId INT
             );
             DECLARE @AttributeDetail TABLE
             (PimAttributeId    INT,
              AttributeTypeName VARCHAR(300),
              AttributeCode     VARCHAR(300),
              SourceColumnName  NVARCHAR(600),
              IsRequired        BIT,
              ControlName       VARCHAR(300),
              ValidationName    VARCHAR(100),
              SubValidationName VARCHAR(300),
              ValidationValue   VARCHAR(300),
              RegExp            VARCHAR(300)
             );

             DECLARE @GlobalTempTableColumns TABLE(ColumnName NVARCHAR);
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM INFORMATION_SCHEMA.TABLES
                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#InvalidDefaultData'
             )
                 CREATE TABLE #InvalidDefaultData
                 (RowNumber  INT,
                  Value      NVARCHAR(MAX),
                  ColumnName NVARCHAR(600)
                 );
             ELSE
             DROP TABLE #InvalidDefaultData;
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM INFORMATION_SCHEMA.TABLES
                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#GlobalTempTableColumns'
             )
                 BEGIN

                     SET @SQLQuery = 'SELECT Column_Name, '''+@ImportHeadName+''' AS ImportHeadName  from tempdb.INFORMATION_SCHEMA.COLUMNS	where table_name = object_name(object_id('''+@TableName+'''),
					(select database_id from sys.databases where name = ''tempdb''))';
                     CREATE TABLE #GlobalTempTableColumns
                     (ColumnName   NVARCHAR(MAX),
                      TypeOfImport NVARCHAR(100)
                     );
                     INSERT INTO #GlobalTempTableColumns
                     (ColumnName,
                      TypeOfImport
                     )
                     EXEC sys.sp_sqlexec
                          @SQLQuery;
                 END;
		  -- If Exists ( Select  count(1)  from #GlobalTempTableColumns GROUP BY ColumnName  Having count(1) > 1 )
		  -- Begin
			 --   INSERT INTO ZnodeImportLog(ErrorDescription,ColumnName,Data,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
    --               Select  46,ColumnName,'',@newGUID,@UserId,@GetDate,@UserId,@GetDate, @ImportProcessLogId  from #GlobalTempTableColumns GROUP BY ColumnName  Having count(1) > 1 
				
				----'Multiple occurance of column are not allow for'
		  -- END

             IF EXISTS
             (
                 SELECT TOP 1 1
                 FROM #GlobalTempTableColumns
                 WHERE ColumnName IN('PimCategoryId', 'PimProductId', 'RowNumber')
             )
                 BEGIN
                     INSERT INTO ZnodeImportLog
                     (ErrorDescription,
                      ColumnName,
                      Data,
                      GUID,
                      CreatedBy,
                      CreatedDate,
                      ModifiedBy,
                      ModifiedDate,
                      ImportProcessLogId
                     )
                     VALUES
                     (43,
                      '',
                      '',
                      @newGUID,
                      @UserId,
                      @GetDate,
                      @UserId,
                      @GetDate,
                      @ImportProcessLogId
                     );
                 END;
             SET @DefaultLocaleId = dbo.Fn_GetDefaultLocaleId();
             --Remove old error log 
             --DELETE FROM ZnodeImportLog WHERE ImportProcessLogId in (select ImportProcessLogId  FROM ZnodeImportProcessLog  WHERE ImportTemplateId  = @TemplateId )
             --GUID = @NewGUID;
             --Delete FROM ZnodeImportProcessLog  WHERE ImportTemplateId  = @TemplateId 
		
             IF NOT EXISTS
             (
                 SELECT TOP 1 1  FROM ZnodeImportLog
                 WHERE Guid = @NewGUID
                       AND ErrorDescription IN(43, 42)
                 AND ImportProcessLogId = @ImportProcessLogId
             )
                 BEGIN
                     IF @ImportHeadName = 'ProductUpdate'
                      BEGIN
						  IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
							  SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimProductId int null ';
						  ELSE 
							 SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimProductId int null Primary KEY CLUSTERED(RowNumber)';
						 
						  EXEC sys.sp_sqlexec @SQLQuery;
			         END;
                     ELSE
                     IF @ImportHeadName = 'Category'
                         BEGIN
							  IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimCategoryId int null ';
							  ElSE
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimCategoryId int null Primary KEY CLUSTERED(RowNumber) ';
						  
							  EXEC sys.sp_sqlexec @SQLQuery;
                         END;
                     ELSE
                         BEGIN
							IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1) ';
							Else 
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1) Primary KEY CLUSTERED(RowNumber)';
							
							EXEC sys.sp_sqlexec @SQLQuery;
                         END;;
                 END



			--Retrive PimProductId on the basis of SKU for update product 
			SET @SQLQuery = 'UPDATE tlb SET tlb.PimProductId = ZPAV.PimProductId 
							FROM ZnodePimAttributeValue AS ZPAV INNER JOIN ZnodePimAttributeValueLocale AS ZPAVL ON 
							(ZPAVL.PimAttributeValueId = ZPAV.PimAttributeValueId) 
							INNER JOIN [dbo].[ZnodePimAttribute] ZPA on ZPAV.PimAttributeId = ZPA.PimAttributeId AND ZPA.AttributeCode= ''SKU'' 
							INNER JOIN '+@TableName+' tlb ON ZPAVL.AttributeValue = ltrim(rtrim(tlb.SKU)) ';
			EXEC sys.sp_sqlexec	@SQLQuery	 	
	
			SET @SQLQuery = 'Select 98 ,''SKU'', SKU, '''+ @newGUID + ''',' + Convert(nvarchar(100),@UserId) + ',''' +  Convert(nvarchar(100),@GetDate) + ''',' + Convert(nvarchar(100),@UserId) + ',''' + Convert(nvarchar(100),@GetDate) + ''',' +  Convert(nvarchar(100),@ImportProcessLogId)  + ',RowNumber   from  '+ @TableName + ' where PimProductId Is null ';
			INSERT INTO ZnodeImportLog
                     (ErrorDescription,ColumnName,Data,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId,RowNumber )
        	EXEC sys.sp_sqlexec	@SQLQuery	 	


			--SET @SQLQuery = '
			--INSERT INTO ZnodeImportLog
			--		(ErrorDescription,ColumnName,Data,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId,RowNumber )
			--Select 98 ,''Attribute '', a.Name , '''+ @NewGUID + ''',' + Convert(nvarchar(100),@UserId) + ',''' +  Convert(nvarchar(100),@GetDate) + ''',' + Convert(nvarchar(100),@UserId) + ',''' + Convert(nvarchar(100),@GetDate) + ''',' +  Convert(nvarchar(100),@ImportProcessLogId)  + ',' +
			--' NULL  from tempdb.sys.columns a
			--inner join tempdb.sys.tables b on a.object_id = b.object_id 
			--where b.name in (''##ProductUpdate_' + @NewGUID +''') 
			--and NOT EXISTS (Select TOP 1 1 FROM ZnodePimAttribute PA WHERE a.name = PA.AttributeCode) AND a.Name <> ''guid''' 

   --     	EXEC sys.sp_sqlexec	@SQLQuery	 	

			SET @SQLQuery = 'Delete from  '+@TableName+ ' where PimProductId Is null ';
			EXEC sys.sp_sqlexec	@SQLQuery	 	
			
			DECLARE @RecordCount Bigint 
			SET @SQLQuery = ' Select @RecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
			EXEC sp_executesql @SQLQuery, N'@RecordCount BIGINT out' , @RecordCount=@RecordCount out


			--Generate new process for current import 
            --INSERT INTO ZnodeImportProcessLog(ImportTemplateId,Status,ProcessStartedDate,ProcessCompletedDate,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
            --SELECT @TemplateId,dbo.Fn_GetImportStatus(0),@GetDate,NULL,@UserId,@GetDate,@UserId,@GetDate;
            --SET @ImportProcessLogId = @@IDENTITY;

             SET @CreateDateString = CONVERT(VARCHAR(100), @UserId)+','''+CONVERT(VARCHAR(100), @GetDate)+''','+CONVERT(VARCHAR(100), @UserId)+','''+CONVERT(VARCHAR(100), @GetDate)+''', '+CONVERT(VARCHAR(100), @ImportProcessLogId);

             SELECT TOP 1 @ImportHeadId = ImportHeadId FROM ZnodeImportTemplate WHERE ImportTemplateId = @TemplateId;
             IF @ImportHeadName IN('ProductUpdate') AND @RecordCount > 0  
                 BEGIN 
					SET @IsCategory = 0 
				    --Get all default attribute values in attribute 
                    INSERT INTO @FamilyAttributeDetail
                    (PimAttributeId,AttributeTypeName,AttributeCode,SourceColumnName,IsRequired,PimAttributeFamilyId)
                    --Call Process to insert data of defeult family with source column name and target column name 
					SELECT distinct zpa.PimAttributeId, zat.AttributeTypeName, zpa.AttributeCode, zitm.SourceColumnName, zpa.IsRequired ,0
					FROM dbo.ZnodePimAttribute AS zpa INNER JOIN dbo.ZnodeAttributeType AS zat ON zat.AttributeTypeId = zpa.AttributeTypeId 
					LEFT OUTER JOIN dbo.ZnodeImportTemplateMapping AS zitm
					ON zpa.AttributeCode = zitm.SourceColumnName AND zitm.ImportTemplateId = @TemplateId
					WHERE zpa.IsCategory = 0 
	             END;
            -- Check attributes are manditory and not provided with source table
		   	if @TABLENAME	like '%tempdb..%'
				SET @SQLQuery = 'SELECT 42 AS ErrorDescription , SourceColumnName , '''' , '''+@NewGUID+''','+@CreateDateString+' from ZnodeImportTemplateMapping where ImportTemplateId = '+CONVERT(VARCHAR(100), @TemplateId)+' and ltrim(rtrim(SourceColumnName)) <> '''' AND ltrim(rtrim(SourceColumnName)) not in ( select isnull(Name ,'''') from tempdb.sys.columns where object_id = object_id('''+@TABLENAME+'''));';
			else 
				SET @SQLQuery = 'SELECT 42 AS ErrorDescription , SourceColumnName , '''' , '''+@NewGUID+''','+@CreateDateString+' from ZnodeImportTemplateMapping where ImportTemplateId = '+CONVERT(VARCHAR(100), @TemplateId)+' and ltrim(rtrim(SourceColumnName)) <> '''' AND ltrim(rtrim(SourceColumnName)) not in ( select isnull(Name ,'''') from sys.columns where object_id = object_id('''+@TABLENAME+'''));';
		 
		 
     		INSERT INTO ZnodeImportLog(ErrorDescription, ColumnName, Data, GUID,CreatedBy, CreatedDate,  ModifiedBy,ModifiedDate,ImportProcessLogId )
            EXEC sys.sp_sqlexec  @SQLQuery;
            IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM ZnodeImportLog
                 WHERE Guid = @NewGUID
                       AND ErrorDescription IN(43, 42)
                 AND ImportProcessLogId = @ImportProcessLogId
             )  AND @RecordCount > 0  
                 BEGIN
                     --Get all default attribute values in attribute 
                     IF @ImportHeadName IN('ProductUpdate', 'Category')
                         BEGIN
                             -- Check attributes are manditory and not provided with source table
                             --INSERT INTO ZnodeImportLog
                             --(ErrorDescription,
                             -- ColumnName,
                             -- Data,
                             -- GUID,
                             -- CreatedBy,
                             -- CreatedDate,
                             -- ModifiedBy,
                             -- ModifiedDate,
                             -- ImportProcessLogId
                             --)
                             --       SELECT '14' AS ErrorDescription,
                             --              AttributeCode,
                             --              '',
                             --              @NewGUID,
                             --              @UserId,
                             --              @GetDate,
                             --              @UserId,
                             --              @GetDate,
                             --              @ImportProcessLogId
                             --       FROM @FamilyAttributeDetail
                             --       WHERE ISNULL(SourceColumnName, '') = ''
                             --             AND IsRequired = 1;  

                             -- Read all attribute details with their datatype
                             INSERT INTO @AttributeDetail
                             (PimAttributeId,
                              AttributeTypeName,
                              AttributeCode,
                              SourceColumnName,
                              IsRequired,
                              ControlName,
                              ValidationName,
                              SubValidationName,
                              ValidationValue,
                              RegExp
                             )
                             EXEC Znode_ImportGetTemplateDetails
                                  @TemplateId=@TemplateId,
								  @DefaultFamilyId=@DefaultFamilyId;

							 ---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
							 Delete FAD from @AttributeDetail FAD
							 where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
							 and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
										   inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)

                             DELETE FROM @AttributeDetail
                             WHERE AttributeTypeName = 'Image'
                                   AND ValidationName <> 'IsAllowMultiUpload';
                             IF NOT EXISTS
                             (
                                 SELECT TOP 1 1
                                 FROM INFORMATION_SCHEMA.TABLES
                                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#DefaultAttributeCode'
                             )
                                 BEGIN
                                     CREATE TABLE #DefaultAttributeCode
                                     (AttributeTypeName          VARCHAR(300),
                                      PimAttributeDefaultValueId INT,
                                      PimAttributeId             INT,
                                      AttributeDefaultValueCode  VARCHAR(100)
                                     );
                                     INSERT INTO #DefaultAttributeCode
                                     (AttributeTypeName,
                                      PimAttributeDefaultValueId,
                                      PimAttributeId,
                                      AttributeDefaultValueCode
                                     )
                                     --Call Process to insert default data value 
                                     EXEC Znode_ImportGetPimAttributeDefaultValue;
                                     DELETE FROM #DefaultAttributeCode
                                     WHERE AttributeTypeName = 'Yes/No';
                                 END;
                             ELSE
                                 BEGIN
                                     DROP TABLE #DefaultAttributeCode;
                                 END;
                         END;

                     --	Check attributes are not mapped with (Default / Other) family of Pim Product
                     --	INSERT INTO ZnodeImportLog ( ErrorDescription , ColumnName , Data , GUID , CreatedBy , CreatedDate , ModifiedBy , ModifiedDate , ImportProcessLogId)
                     --	SELECT '1' AS ErrorDescription , SourceColumnName , '' , @NewGUID , @UserId , @GetDate , @UserId , @GetDate , @ImportProcessLogId
                     --	FROM @AttributeDetail WHERE PimAttributeId NOT IN ( SELECT zpfgm.PimAttributeId FROM dbo.ZnodePimFamilyGroupMapper AS zpfgm);
                     --	Verify data in global temporary table (column wise)
						
                     DECLARE Cr_Attribute CURSOR LOCAL FAST_FORWARD
                     FOR SELECT PimAttributeId,
                                AttributeTypeName,
                                AttributeCode,
                                IsRequired,
                                SourceColumnName,
                                ControlName,
                                ValidationName,
                                SubValidationName,
                                ValidationValue,
                                RegExp
                         FROM @AttributeDetail
                         WHERE ISNULL(SourceColumnName, '') <> '';
                     OPEN Cr_Attribute;
                     FETCH NEXT FROM Cr_Attribute INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @ControlName, @ValidationName, @SubValidationName, @ValidationValue, @RegExp;
                     WHILE @@FETCH_STATUS = 0
                         BEGIN
				             IF @AttributeTypeName = 'Number'
                                 BEGIN
							      EXEC Znode_ImportValidateNumber
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @ImportHeadId = @ImportHeadId,
                                          @ImportProcessLogId = @ImportProcessLogId;
                                 END;
							 -- Check invalid date
							
                             IF @AttributeTypeName = 'Date'
                                 BEGIN
                                     EXEC Znode_ImportValidateDate
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @ImportHeadId = @ImportHeadId,
                                          @ImportProcessLogId = @ImportProcessLogId;
                                 END;
							 -- Check Manditory Data
		 					 IF @IsRequired = 1 AND @CheckedSourceColumn <> @SourceColumnName
								BEGIN
									SET @CheckedSourceColumn = @SourceColumnName;
									EXEC Znode_ImportValidateMandatoryData
									@TableName = @TableName,
									@SourceColumnName = @SourceColumnName,
									@CreateDateString = @CreateDateString,
									@ValidationName = @ValidationName,
									@ControlName = @ControlName,
									@ValidationValue = @ValidationValue,
									@NewGUID = @NewGUID,
									@ImportHeadId = @ImportHeadId;
								END;
							 --END 
							
                             IF @AttributeTypeName = 'Text'
                                 BEGIN
									--For link product
									DECLARE @IsIgnoreProcess BIT = CASE WHEN EXISTS (SELECT TOP 1 1 FROM ZnodePimAttribute WHERE AttributeCode = (SELECT TOP 1 TargetColumnName
								    FROM ZnodeImportTemplateMapping a 
									INNER JOIN ZnodeImportTemplate b ON (b.ImportTemplateId = a.ImportTemplateId )
									WHERE TemplateName = 'ProductUpdate'
									AND a.TargetColumnName <> 'SKU'
								   )
								    AND AttributeTypeId = (SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE  AttributeTypeName = 'link' )
								   ) THEN 1 ELSE 0 END 
								 
						              EXEC Znode_ImportValidateManditoryText
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @LocaleId = @LocaleId,
                                          @DefaultLocaleId = @DefaultLocaleId,
                                          @AttributeId = @AttributeId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @ImportHeadId = @ImportHeadId,
										  @IsIgnoreProcess = @IsIgnoreProcess;
                                 END;
                             IF @AttributeTypeName = 'Image'
                                 BEGIN
                                     EXEC Znode_ImportValidateImageData
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @LocaleId = @LocaleId,
                                          @DefaultLocaleId = @DefaultLocaleId,
                                          @AttributeId = @AttributeId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @ImportHeadId = @ImportHeadId;
                                 END;

								 --For link product
								 IF @AttributeTypeName = 'Link'
                                 BEGIN
										--To get the product SKU in temp table
										SELECT ZPAV.PimProductId, ZPAVL.AttributeValue as SKU
										INTO #ProductSKU
										FROM ZnodePimAttributeValue ZPAV
										INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId 
										WHERE EXISTS(SELECT * FROM ZnodePimAttribute ZPA WHERE ZPAV.PimAttributeId = zpa.PimAttributeId AND ZPA.AttributeCode = 'SKU')

                                     	SET @SQLQuery = 'SELECT ''98'' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], '+@SourceColumnName+' AS  AttributeValue,RowNumber ,GUID,  '+@CreateDateString+' 
											FROM '+@TableName+' a 
											CROSS APPLY DBO.SPLIT('+@SourceColumnName+','','')S WHERE RowNumber in (SELECT RowNumber FROM '+@TableName+' WHERE  NOT EXISTS  (Select TOP 1 1  FROM #ProductSKU WHERE SKU = S.Item ) 
											)
											';
                     
											INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, RowNumber, GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
											EXEC sys.sp_sqlexec @SQLQuery;
				
                                 END;

                             --Check Default data value is valid 
                             IF @ImportHeadName IN('ProductUpdate', 'Category')
                                 BEGIN
                                     IF @AttributeId IN
                                     (
                                         SELECT PimAttributeId
                                         FROM #DefaultAttributeCode
                                     )
                                         BEGIN
							
                                                   ---Verify Image file is exists in media table or not 
                                             SET @SQLQuery = ' INSERT INTO #InvalidDefaultData (RowNumber, Value, ColumnName) 
                                             SELECT ROWNUMBER , (Select TOP 1 Item from dbo.split(' + @SourceColumnName + ','','')  SP WHERE NOT EXISTS 
                                             (Select ToP 1 1 FROM #DefaultAttributeCode DAC WHERE 
                                              DAC.AttributeTypeName <> ''Yes/No'' AND DAC.AttributeDefaultValueCode IS NOT NULL AND DAC.PimAttributeId = 
                                             ' + CONVERT(VARCHAR(100), @AttributeId) + ' AND ltrim(rtrim(SP.Item) ) = DAC.AttributeDefaultValueCode
                                             )), ''' + @SourceColumnName + ''' as [ColumnName]  FROM ' + @TableName
                                             + ' Where ISnull(' + @SourceColumnName +  ','''') <> '''''

						
                                             EXEC sys.sp_sqlexec @SQLQuery;
                                             -- Check Invalid Image 
                                             
											 SET @SQLQuery = 'SELECT ''9 '' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], 
                                             Value AS  AttributeValue,RowNumber ,'''+@NewGUID+''',  '+@CreateDateString+' FROM #InvalidDefaultData Where Value IS NOT NULL'
                                             INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, RowNumber, GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
                                             EXEC sys.sp_sqlexec @SQLQuery;

											 Delete from #InvalidDefaultData

       
                                         END;
                                 END;
							
                             FETCH NEXT FROM Cr_Attribute INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @ControlName, @ValidationName, @SubValidationName, @ValidationValue, @RegExp;
                         END;
                     CLOSE Cr_Attribute;
                     DEALLOCATE Cr_Attribute;
                     --SELECT top 1 1 FROM @FamilyAttributeDetail where  iSNULL(SourceColumnName,'') = ''  and IsRequired = 1
                 END;
            --COMMIT TRAN TRN_ImportValidProductData;
			 

		IF @ImportHeadName IN('ProductUpdate')
		 BEGIN
		 Declare @SQLQueryNew NVARCHAR(4000)
		 Declare @SourceColumnNameProduct nvarchar(4000)   	 
		 SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'SKU'
		 AND ImportTemplateId = @TemplateId

		
  	--	 SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName = ''SKU  '' + ' + '  ' +@SourceColumnNameProduct + ' ' + ' + ' + ' '  + ' ZIL.ColumnName + ''  Attribute''
		 --FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			--  WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber is not null';
            
			--SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  SKU - '' + ' + '  ' +@SourceColumnNameProduct+ '+' + ''' ]'' 
		 --   FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			--WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
   --         PRINT @SQLQueryNew

            SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  SKU - '' + ' + '  ' +@SourceColumnNameProduct+ '+' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew

			EXEC sys.sp_sqlexec  @SQLQueryNew;
			
		END 

					 	 		 
  			 SET @SQLQuery = 'Delete FROM  '+@TableName+' Where Rownumber in (Select Rownumber from ZnodeImportLog  WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND Rownumber is not null)';
             EXEC sys.sp_sqlexec  @SQLQuery;

			 ---------------------------------------------------------------------------

		--	 Declare @SourceColumnNameProduct nvarchar(4000)  
		--	 Declare @SQLQueryNew NVARCHAR(4000) 	 
		-- SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'SKU'
		-- AND ImportTemplateId = @TemplateId


		--INSERT INTO ZnodeImportLog  (ErrorDescription,ColumnName, Data, GUID,CreatedBy,
  --          CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
		--	EXEC sys.sp_sqlexec  @SQLQueryNew;

		--	SET @SQLQueryNew = 'SELECT ''Successfully Imported '' ErrorDescription,''SKU'',
		--	'''+@SourceColumnNameProduct+''' AS [Data], 
  --          RowNumber ,'''+@NewGUID+''',  '+@CreateDateString+' FROM '+@TableName+' WHERE Rownumber IS NOT NULL'

------------------------------------------------------------------------------------------------

		 --SET @SQLQuery = 'Select *  FROM  '+@TableName
   --          EXEC sys.sp_sqlexec  @SQLQuery;

             IF @ImportHeadName IN('ProductUpdate')
                 BEGIN
                     IF NOT EXISTS
                
					 (
						 SELECT TOP 1 1
						 FROM ZnodeImportLog
						 WHERE Guid = @NewGUID
							   AND ErrorDescription IN (43, 42)
						 AND ImportProcessLogId = @ImportProcessLogId
					 ) AND @RecordCount > 0 
                         BEGIN
                             IF @IsCategory = 0
                                 BEGIN
                                     EXEC Znode_ImportPartialPimProductData
                                          @TableName = @TableName,
                                          @NewGUID = @NewGUID,
                                          @TemplateId = @TemplateId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @UserId = @UserId,
                                          @LocaleId = @LocaleId,
                                          @DefaultFamilyId = @DefaultFamilyId;
	
                                 END;
                            
                         END;

					ELSE 
					BEGIN
					-- Update Record count in log 					
					SET @SQLQuery = ' Select @FailedRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
					EXEC	sp_executesql @SQLQuery , N'@FailedRecordCount BIGINT out' , @FailedRecordCount =@FailedRecordCount out
					
					SELECT @SuccessRecordCount = 0
					UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
					WHERE ImportProcessLogId = @ImportProcessLogId;
					END

                 END
				
			SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
			SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
			
			EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount out

			UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
			WHERE ImportProcessLogId = @ImportProcessLogId;

		   EXEC Znode_ImportReadErrorLog
                  @ImportProcessLogId = @ImportProcessLogId,
                  @NewGUID = @NewGUID;
             DROP TABLE #GlobalTempTableColumns;

             ---- Finally call product insert process if error not found in error log table 
             --IF EXISTS
             --(
             --    SELECT TOP 1 1
             --    FROM ZnodeImportLog
             --    WHERE ImportProcessLogId = @ImportProcessLogId
             --          AND Guid = @NewGUID
             --)
             --    BEGIN
                    --Updating the import process status
					UPDATE ZnodeImportProcessLog
					SET Status = CASE WHEN ISNULL(FailedRecordcount,0) > 0 AND ISNULL(SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
										WHEN ISNULL(FailedRecordcount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
										WHEN ISNULL(FailedRecordcount,0) > 0 AND ISNULL(FailedRecordcount,0) = ISNULL(TotalProcessedRecords,0) THEN dbo.Fn_GetImportStatus( 3 )
									END, 
						ProcessCompletedDate = getdate()
					WHERE ImportProcessLogId = @ImportProcessLogId;
                 --END;
		
				--SET @SQLQuery = 'select TOP 1 * from  ' + @TableName
				--EXEC sys.sp_sqlexec @SQLQuery;
        END TRY
      
		BEGIN CATCH 
		DECLARE @TempCount TABLE (Id INT)

		Declare @SQL Varchar(max) = 'Select Count(*) As Id From '+@TableName
		INSERT INTO @TempCount
		EXEC (@SQL)

			SET @Status = 0;
			DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
			@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportPartialValidatePimProductData @ImportHeadName = '''+ISNULL(@ImportHeadName,'''''')+''',@TableName='''+ISNULL(CAST(@TableName AS
			VARCHAR(50)),'''''')+''',@TemplateId='+ISNULL(CAST(@TemplateId AS VARCHAR(50)),'''')+',@NewGUID='''+ISNULL(@NewGUID,'''''')+''',@UserId='+ISNULL(CAST(@UserId AS VARCHAR(50)),'''')+',@LocaleId='+ISNULL(CAST(@LocaleId AS VARCHAR(50)),'''')+',
			@IsCategory='+ISNULL(CAST(@IsCategory AS VARCHAR(50)),'''')+',@DefaultFamilyId='+ISNULL(CAST(@DefaultFamilyId AS VARCHAR(50)),'''')+',@ImportProcessLogId='+ISNULL(CAST(@ImportProcessLogId AS VARCHAR(50)),'''')+',
			@PriceListId='+ISNULL(CAST(@PriceListId AS VARCHAR(50)),'''')+',@CountryCode='''+ISNULL(CAST(@CountryCode AS VARCHAR(50)),'''''')+''',@PimCatalogId='+ISNULL(CAST(@PimCatalogId AS VARCHAR(50)),'''')+',
			@PortalId='+ISNULL(CAST(@PortalId AS VARCHAR(50)),'''')+',@IsAccountAddress='+ISNULL(CAST(@IsAccountAddress AS VARCHAR(50)),'''')

			SELECT 0 AS ID,CAST(0 AS BIT) AS Status;       
			
			---Import process updating fail due to database error
			UPDATE ZnodeImportProcessLog
			SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
			WHERE ImportProcessLogId = @ImportProcessLogId;

			---Loging error for Import process due to database error
		    INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		    SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

			--Updating total and fail record count
		    UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		    TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		    WHERE ImportProcessLogId = @ImportProcessLogId;

			EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_ImportPartialValidatePimProductData',
			@ErrorInProcedure = 'Znode_ImportPartialValidatePimProductData',
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
		END CATCH 

     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportValidatePimProductData')
	DROP PROC Znode_ImportValidatePimProductData
GO

CREATE PROCEDURE [dbo].[Znode_ImportValidatePimProductData]
(   @ImportHeadName     VARCHAR(200),
    @TableName          VARCHAR(200),
    @NewGUID            NVARCHAR(200),
    @TemplateId         INT,
    @UserId             INT,
    @LocaleId           INT           = 1,
    @IsCategory         INT           = 0,
    @DefaultFamilyId    INT           = 0,
    @ImportProcessLogId INT,
    @PriceListId        INT,
	@CountryCode VARCHAR(100) = '',
	@PimCatalogId         INT    = 0 ,
	@PortalId int = 0,
	@IsAccountAddress bit = 0 )
AS
     SET NOCOUNT ON;

/*
    Summary :   Import PimProduct / Price / Inventory / Category / Category Associated Data 
    Process :   Admin site will upload excel / csv file in database and create global temporary table
				Procedure Znode_ImportValidatePimProductData will validate data with attribute validation rule
				If datatype validation issue found in input daata will logged into table "ZnodeImportLog"
				If Data is correct and record count in table ZnodeImportLog will be 0 then process for import data into Base tables
				To import data call procedure "Znode_ImportPimProductData"
    		  
				SourceColumnName: CSV file column headers
				TargetColumnName: Attributecode from ZnodePimAttribute Table (Consider those Attributecodes configured with default family only)
*/

     BEGIN
         BEGIN TRY
             SET NOCOUNT ON;
             --BEGIN TRAN TRN_ImportValidProductData;
             DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
             DECLARE @SQLQuery NVARCHAR(MAX), @AttributeTypeName NVARCHAR(100), @AttributeCode NVARCHAR(300), @AttributeId INT, @IsRequired BIT, @SourceColumnName NVARCHAR(600), @ControlName VARCHAR(300), @ValidationName VARCHAR(100), @SubValidationName VARCHAR(300), @ValidationValue VARCHAR(300), @RegExp VARCHAR(300), @CreateDateString NVARCHAR(300), @DefaultLocaleId INT, @ImportHeadId INT, @CheckedSourceColumn NVARCHAR(600)= '', @Status BIT= 0,
			    @CsvColumnString nvarchar(max),
				@FailedRecordCount BIGINT,
				@SuccessRecordCount BIGINT
            --To get the total record count for update purpose in catch block
            SET @SQLQuery = 'SELECT '+CAST(@ImportProcessLogId AS VARCHAR(10))+',COUNT(*) FROM '+@TableName
			INSERT INTO Znode_ImportCsvRowCount
			EXEC (@SQLQuery) 

             DECLARE @FamilyAttributeDetail TABLE
             (PimAttributeId       INT,
              AttributeTypeName    VARCHAR(300),
              AttributeCode        VARCHAR(300),
              SourceColumnName     NVARCHAR(600),
              IsRequired           BIT,
              PimAttributeFamilyId INT
             );
             DECLARE @AttributeDetail TABLE
             (PimAttributeId    INT,
              AttributeTypeName VARCHAR(300),
              AttributeCode     VARCHAR(300),
              SourceColumnName  NVARCHAR(600),
              IsRequired        BIT,
              ControlName       VARCHAR(300),
              ValidationName    VARCHAR(100),
              SubValidationName VARCHAR(300),
              ValidationValue   VARCHAR(300),
              RegExp            VARCHAR(300)
             );

			CREATE TABLE #DefaultAttributeCode
			(AttributeTypeName          VARCHAR(300),
			PimAttributeDefaultValueId INT,
			PimAttributeId             INT,
			AttributeDefaultValueCode  VARCHAR(100)
			);

			IF( @ImportHeadName = 'B2BCustomer' )
			BEGIN
				EXEC ZnodeB2BCustomerMapping @ImportHeadName = @ImportHeadName, @TableName = @TableName
			END
		
             DECLARE @GlobalTempTableColumns TABLE(ColumnName NVARCHAR);
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM INFORMATION_SCHEMA.TABLES
                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#InvalidDefaultData'
             )
                 CREATE TABLE #InvalidDefaultData
                 (RowNumber  INT,
                  Value      NVARCHAR(MAX),
                  ColumnName NVARCHAR(600)
                 );
             ELSE
             DROP TABLE #InvalidDefaultData;
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM INFORMATION_SCHEMA.TABLES
                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#GlobalTempTableColumns'
             )
                 BEGIN

                     SET @SQLQuery = 'SELECT Column_Name, '''+@ImportHeadName+''' AS ImportHeadName  from tempdb.INFORMATION_SCHEMA.COLUMNS	where table_name = object_name(object_id('''+@TableName+'''),
					(select database_id from sys.databases where name = ''tempdb''))';
                     CREATE TABLE #GlobalTempTableColumns
                     (ColumnName   NVARCHAR(MAX),
                      TypeOfImport NVARCHAR(100)
                     );
                     INSERT INTO #GlobalTempTableColumns
                     (ColumnName,
                      TypeOfImport
                     )
                     EXEC sys.sp_sqlexec
                          @SQLQuery;
                 END;

             IF EXISTS
             (
                 SELECT TOP 1 1
                 FROM #GlobalTempTableColumns
                 WHERE ColumnName IN('PimCategoryId', 'PimProductId', 'RowNumber')
             )
                 BEGIN
                     INSERT INTO ZnodeImportLog
                     (ErrorDescription,
                      ColumnName,
                      Data,
                      GUID,
                      CreatedBy,
                      CreatedDate,
                      ModifiedBy,
                      ModifiedDate,
                      ImportProcessLogId
                     )
                     VALUES
                     (43,
                      '',
                      '',
                      @newGUID,
                      @UserId,
                      @GetDate,
                      @UserId,
                      @GetDate,
                      @ImportProcessLogId
                     );
                 END;
             SET @DefaultLocaleId = dbo.Fn_GetDefaultLocaleId();

             IF NOT EXISTS
             (
                 SELECT TOP 1 1  FROM ZnodeImportLog
                 WHERE Guid = @NewGUID
                       AND ErrorDescription IN(43, 42)
                 AND ImportProcessLogId = @ImportProcessLogId
             )
                 BEGIN
                     IF @ImportHeadName = 'Product'
                      BEGIN
						  IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
							  SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimProductId int null ';
						  ELSE 
							 SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimProductId int null Primary KEY CLUSTERED(RowNumber)';
						 
						  EXEC sys.sp_sqlexec @SQLQuery;
			         END;
                     ELSE
                     IF @ImportHeadName = 'Category'
                         BEGIN
							  IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimCategoryId int null ';
							  ElSE
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimCategoryId int null Primary KEY CLUSTERED(RowNumber) ';
						  
							  EXEC sys.sp_sqlexec @SQLQuery;
                         END;
                     ELSE
                         BEGIN
							IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1) ';
							Else 
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1) Primary KEY CLUSTERED(RowNumber)';
							
							EXEC sys.sp_sqlexec @SQLQuery;
                         END;;
                 END;

             SET @CreateDateString = CONVERT(VARCHAR(100), @UserId)+','''+CONVERT(VARCHAR(100), @GetDate)+''','+CONVERT(VARCHAR(100), @UserId)+','''+CONVERT(VARCHAR(100), @GetDate)+''', '+CONVERT(VARCHAR(100), @ImportProcessLogId);

             SELECT TOP 1 @ImportHeadId = ImportHeadId FROM ZnodeImportTemplate WHERE ImportTemplateId = @TemplateId;
             IF @DefaultFamilyId = 0
                AND @ImportHeadName IN('Product', 'Category')
                 BEGIN 
                     --Get all default attribute values in attribute 
                     INSERT INTO @FamilyAttributeDetail
                     (PimAttributeId,
                      AttributeTypeName,
                      AttributeCode,
                      SourceColumnName,
                      IsRequired,
                      PimAttributeFamilyId
                     )
                     --Call Process to insert data of defeult family with source column name and target column name 
                     EXEC Znode_ImportGetTemplateDetails
                          @TemplateId = @TemplateId,
                          @IsValidationRules = 0,
                          @IsIncludeRespectiveFamily = 1,
                          @IsCategory = @IsCategory,
                          @DefaultFamilyId = @DefaultFamilyId;

					---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;
             ELSE
             IF @ImportHeadName IN('Product', 'Category')
                 BEGIN
				 
                     --Get all default attribute values in attribute 
                     INSERT INTO @FamilyAttributeDetail
                     (PimAttributeId,
                      AttributeTypeName,
                      AttributeCode,
                      SourceColumnName,
                      IsRequired,
                      PimAttributeFamilyId
                     )
                     --Call Process to insert data of defeult family with source column name and target column name 
                     EXEC Znode_ImportGetTemplateDetails
                          @TemplateId = @TemplateId,
                          @IsValidationRules = 0,
                          @IsIncludeRespectiveFamily = 1,
                          @IsCategory = @IsCategory,
                          @DefaultFamilyId = @DefaultFamilyId;

					---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;      
             -- Check attributes are manditory and not provided with source table
		   	 
			if @TABLENAME	like '%tempdb..%'
				SET @SQLQuery = 'SELECT 42 AS ErrorDescription , SourceColumnName , '''' , '''+@NewGUID+''','+@CreateDateString+' from ZnodeImportTemplateMapping where ImportTemplateId = '+CONVERT(VARCHAR(100), @TemplateId)+' and ltrim(rtrim(SourceColumnName)) <> '''' AND ltrim(rtrim(SourceColumnName)) not in ( select isnull(Name ,'''') from tempdb.sys.columns where object_id = object_id('''+@TABLENAME+'''));';
			else 
				SET @SQLQuery = 'SELECT 42 AS ErrorDescription , SourceColumnName , '''' , '''+@NewGUID+''','+@CreateDateString+' from ZnodeImportTemplateMapping where ImportTemplateId = '+CONVERT(VARCHAR(100), @TemplateId)+' and ltrim(rtrim(SourceColumnName)) <> '''' AND ltrim(rtrim(SourceColumnName)) not in ( select isnull(Name ,'''') from sys.columns where object_id = object_id('''+@TABLENAME+'''));';
		 
			Declare @Tbl_CsvDynamicColulmns TABLE (ColumnName nvarchar(300), SequenceNumber int, DataType nvarchar(50),IsRequired bit )

			INSERT INTO @Tbl_CsvDynamicColulmns(ColumnName , SequenceNumber , DataType ,IsRequired)
			SELECT DISTINCT ZITM.SourceColumnName ,ZIAV.SequenceNumber, ZIAV.AttributeTypeName, ZIAV.IsRequired
			FROM ZnodeImportAttributeValidation ZIAV LEFT OUTER JOIN 
			ZnodeImportTemplate  ZIT ON ZIT.ImportHeadId =  ZIAV.ImportHeadId AND ZIT.ImportTemplateId  = @TemplateId
			LEFT OUTER JOIN ZnodeImportTemplateMapping  ZITM ON ZITM.ImportTemplateId = ZIT.ImportTemplateId  
			and ZIAV.AttributeCode = ZITM.TargetColumnName
			AND ZITM.ImportTemplateId  = @TemplateId
			WHERE ZIAV.ImportHeadId = @ImportHeadId
			AND ISNULL(ZITM.SourceColumnName,'') <> ''--ORDER BY ZIAV.SequenceNumber


		    SELECT @CsvColumnString = SUBSTRING ((Select ',' +  ISNULL(ColumnName ,'NULL') from @Tbl_CsvDynamicColulmns ORDER BY SequenceNumber FOR XML PATH ('')),2,4000) 


     		INSERT INTO ZnodeImportLog(ErrorDescription, ColumnName, Data, GUID,CreatedBy, CreatedDate,  ModifiedBy,ModifiedDate,ImportProcessLogId
             )
             EXEC sys.sp_sqlexec  @SQLQuery;
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM ZnodeImportLog
                 WHERE Guid = @NewGUID
                       AND ErrorDescription IN(43, 42)
                 AND ImportProcessLogId = @ImportProcessLogId
             )
                 BEGIN
                     --Get all default attribute values in attribute 
                     IF @ImportHeadName IN('Product', 'Category')
                         BEGIN
                             -- Check attributes are manditory and not provided with source table
                             INSERT INTO ZnodeImportLog
                             (ErrorDescription,
                              ColumnName,
                              Data,
                              GUID,
                              CreatedBy,
                              CreatedDate,
                              ModifiedBy,
                              ModifiedDate,
                              ImportProcessLogId
                             )
                                    SELECT '14' AS ErrorDescription,
                                           AttributeCode,
                                           '',
                                           @NewGUID,
                                           @UserId,
                                           @GetDate,
                                           @UserId,
                                           @GetDate,
                                           @ImportProcessLogId
                                    FROM @FamilyAttributeDetail
                                    WHERE ISNULL(SourceColumnName, '') = ''
                                          AND IsRequired = 1;  

                             -- Read all attribute details with their datatype
                             INSERT INTO @AttributeDetail
                             (PimAttributeId,
                              AttributeTypeName,
                              AttributeCode,
                              SourceColumnName,
                              IsRequired,
                              ControlName,
                              ValidationName,
                              SubValidationName,
                              ValidationValue,
                              RegExp
                             )
                             EXEC Znode_ImportGetTemplateDetails
                                  @TemplateId=@TemplateId,
								  @DefaultFamilyId=@DefaultFamilyId;

							---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
							Delete FAD from @AttributeDetail FAD
							where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
							and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
										   inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode) 

                             DELETE FROM @AttributeDetail
                             WHERE AttributeTypeName = 'Image'
                                   AND ValidationName <> 'IsAllowMultiUpload';
							DELETE FROM @AttributeDetail
                             WHERE AttributeTypeName = 'File'
                                   AND ValidationName <> 'IsAllowMultiUpload';

                                     INSERT INTO #DefaultAttributeCode
                                     (AttributeTypeName,
                                      PimAttributeDefaultValueId,
                                      PimAttributeId,
                                      AttributeDefaultValueCode
                                     )
                                     --Call Process to insert default data value 
                                     EXEC Znode_ImportGetPimAttributeDefaultValue;

                                     DELETE FROM #DefaultAttributeCode
                                     WHERE AttributeTypeName = 'Yes/No';

                         END;
                     ELSE
                         BEGIN
					
					
                             --Read all attribute details with their datatype
                             INSERT INTO @AttributeDetail
                             (AttributeTypeName,
                              AttributeCode,
                              SourceColumnName,
                              IsRequired,
                              ControlName,
                              ValidationName,
                              SubValidationName,
                              ValidationValue,
                              RegExp
                             )
                             EXEC [Znode_ImportGetOtherTemplateDetails]
                                  @TemplateId = @TemplateId,
                                  @ImportHeadId = @ImportHeadId;

							IF @ImportHeadName IN('B2BCustomer')
							BEGIN

								INSERT INTO @AttributeDetail
								 (PimAttributeId,
								 AttributeTypeName,
								  AttributeCode,
								  SourceColumnName,
								  IsRequired,
								  ControlName,
								  ValidationName,
								  SubValidationName,
								  ValidationValue,
								  RegExp
								 )
								 EXEC [Znode_ImportGetGlobalTemplateDetails]
									  @TemplateId = @TemplateId,
									  @ImportHeadId = @ImportHeadId;

								
								INSERT INTO #DefaultAttributeCode
								(AttributeTypeName,
								PimAttributeDefaultValueId,
								PimAttributeId,
								AttributeDefaultValueCode
								)
								--Call Process to insert default data value 
								EXEC Znode_ImportGetGlobalAttributeDefaultValue;

								DELETE FROM #DefaultAttributeCode
								WHERE AttributeTypeName = 'Yes/No';

							END
						
                             --Check attributes are not mapped with any family of Pim Product
                             INSERT INTO ZnodeImportLog
                             (ErrorDescription,
                              ColumnName,
                              Data,
                              GUID,
                              CreatedBy,
                              CreatedDate,
                              ModifiedBy,
                              ModifiedDate,
                              ImportProcessLogId
                             )
                                    SELECT DISTINCT
                                           '14' AS ErrorDescription,
                                           AttributeCode,
                                           '',
                                           @NewGUID,
                                           @UserId,
                                           @GetDate,
                                           @UserId,
                                           @GetDate,
                                           @ImportProcessLogId
                                    FROM @AttributeDetail
                                    WHERE ISNULL(SourceColumnName, '') = ''   AND IsRequired = 1;  ;

                         END;
						
                     --	Check attributes are not mapped with (Default / Other) family of Pim Product
                     --	INSERT INTO ZnodeImportLog ( ErrorDescription , ColumnName , Data , GUID , CreatedBy , CreatedDate , ModifiedBy , ModifiedDate , ImportProcessLogId)
                     --	SELECT '1' AS ErrorDescription , SourceColumnName , '' , @NewGUID , @UserId , @GetDate , @UserId , @GetDate , @ImportProcessLogId
                     --	FROM @AttributeDetail WHERE PimAttributeId NOT IN ( SELECT zpfgm.PimAttributeId FROM dbo.ZnodePimFamilyGroupMapper AS zpfgm);
                     --	Verify data in global temporary table (column wise)
					
                     DECLARE Cr_Attribute CURSOR LOCAL FAST_FORWARD
                     FOR SELECT PimAttributeId,
                                AttributeTypeName,
                                AttributeCode,
                                IsRequired,
                                SourceColumnName,
                                ControlName,
                                ValidationName,
                                SubValidationName,
                                ValidationValue,
                                RegExp
                         FROM @AttributeDetail
                         WHERE ISNULL(SourceColumnName, '') <> '';
                     OPEN Cr_Attribute;
                     FETCH NEXT FROM Cr_Attribute INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @ControlName, @ValidationName, @SubValidationName, @ValidationValue, @RegExp;
                     WHILE @@FETCH_STATUS = 0
                         BEGIN
				             IF @AttributeTypeName = 'Number'
                                 BEGIN
							      EXEC Znode_ImportValidateNumber
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @ImportHeadId = @ImportHeadId,
                                          @ImportProcessLogId = @ImportProcessLogId;
                                 END;
							 -- Check invalid date
							
                             IF @AttributeTypeName = 'Date'
                                 BEGIN
                                     EXEC Znode_ImportValidateDate
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @ImportHeadId = @ImportHeadId,
                                          @ImportProcessLogId = @ImportProcessLogId;
                                 END;
							 -- Check Manditory Data
		 					 IF @IsRequired = 1 AND @CheckedSourceColumn <> @SourceColumnName
								BEGIN
									SET @CheckedSourceColumn = @SourceColumnName;
									EXEC Znode_ImportValidateMandatoryData
									@TableName = @TableName,
									@SourceColumnName = @SourceColumnName,
									@CreateDateString = @CreateDateString,
									@ValidationName = @ValidationName,
									@ControlName = @ControlName,
									@ValidationValue = @ValidationValue,
									@NewGUID = @NewGUID,
									@ImportHeadId = @ImportHeadId;
								END;
							 --END 
							
                             IF @AttributeTypeName = 'Text'
                                 BEGIN
								 
						              EXEC Znode_ImportValidateManditoryText
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @LocaleId = @LocaleId,
                                          @DefaultLocaleId = @DefaultLocaleId,
                                          @AttributeId = @AttributeId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @ImportHeadId = @ImportHeadId;
                                 END;
                             IF @AttributeTypeName in ( 'Image','File')
                                 BEGIN
                                     EXEC Znode_ImportValidateImageData
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @LocaleId = @LocaleId,
                                          @DefaultLocaleId = @DefaultLocaleId,
                                          @AttributeId = @AttributeId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @ImportHeadId = @ImportHeadId;
                                 END;

					

                             --Check Default data value is valid 
                             IF @ImportHeadName IN('Product', 'Category','B2BCustomer')
                                 BEGIN
                                     IF @AttributeId IN
                                     (
                                         SELECT PimAttributeId
                                         FROM #DefaultAttributeCode
                                     )
                                         BEGIN
							
                                            IF  @AttributeTypeName = 'Multi Select'
											 BEGIN
										 		 ---Verify Image file is exists in media table or not 
												 SET @SQLQuery = ' INSERT INTO #InvalidDefaultData (RowNumber, Value, ColumnName) 
												 SELECT ROWNUMBER , (Select TOP 1 Item from dbo.split(' + @SourceColumnName + ','','')  SP WHERE NOT EXISTS 
												 (Select ToP 1 1 FROM #DefaultAttributeCode DAC WHERE 
												  DAC.AttributeTypeName <> ''Yes/No'' AND DAC.AttributeDefaultValueCode IS NOT NULL AND DAC.PimAttributeId = 
												 ' + CONVERT(VARCHAR(100), @AttributeId) + ' AND ltrim(rtrim(SP.Item) ) = DAC.AttributeDefaultValueCode
												 )), ''' + @SourceColumnName + ''' as [ColumnName]  FROM ' + @TableName
												 + ' Where ISnull(' + @SourceColumnName +  ','''') <> '''''
												EXEC sys.sp_sqlexec @SQLQuery;
											  END
											  ELSE IF @AttributeTypeName = 'Simple Select'
											  BEGIN
						
												---Verify Image file is exists in media table or not 
												 SET @SQLQuery = ' INSERT INTO #InvalidDefaultData (RowNumber, Value, ColumnName) 
												 SELECT ROWNUMBER , ' + @SourceColumnName + ' , ''' + @SourceColumnName + ''' as [ColumnName]  FROM ' + @TableName
												 + ' SP Where ISnull(' + @SourceColumnName +  ','''') <> '''' AND 
												  NOT EXISTS 
												 (Select TOP 1 1 FROM #DefaultAttributeCode DAC WHERE 
												  DAC.AttributeTypeName <> ''Yes/No'' AND DAC.AttributeDefaultValueCode IS NOT NULL AND DAC.PimAttributeId = 
												 ' + CONVERT(VARCHAR(100), @AttributeId) + ' AND ltrim(rtrim(SP.' + @SourceColumnName + ') ) = DAC.AttributeDefaultValueCode ) '
							
												EXEC sys.sp_sqlexec @SQLQuery;
											  END   
												-- Check Invalid Image 
												 SET @SQLQuery = 'SELECT ''9 '' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], 
												 Value AS  AttributeValue,RowNumber ,'''+@NewGUID+''',  '+@CreateDateString+' FROM #InvalidDefaultData Where Value IS NOT NULL'
												 INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, RowNumber, GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
												 EXEC sys.sp_sqlexec @SQLQuery;
												 Delete from #InvalidDefaultData

       
                                         END;
                                 END;
							
                             FETCH NEXT FROM Cr_Attribute INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @ControlName, @ValidationName, @SubValidationName, @ValidationValue, @RegExp;
                         END;
                     CLOSE Cr_Attribute;
                     DEALLOCATE Cr_Attribute;
                     --SELECT top 1 1 FROM @FamilyAttributeDetail where  iSNULL(SourceColumnName,'') = ''  and IsRequired = 1
                 END;
             
			 
			  
------------------------------------------------------------------------------------------
		 Declare @SQLQueryNew NVARCHAR(4000)
		 Declare @SourceColumnNameProduct nvarchar(4000) 
         IF @ImportHeadName IN('Product','Pricing','ProductAssociation','Inventory')
		 BEGIN
		 	 
		 SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'SKU'
		 AND ImportTemplateId = @TemplateId


			SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  SKU - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;			
		END
		ELSE IF @ImportHeadName IN('ProductAttribute')
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'AttributeCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  Attribute - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'ZipCode'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'ZIP'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  ZIPCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'Category'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'CategoryCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  CategoryCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'CategoryAssociation'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'CategoryName'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  CategoryName - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;

		END
		ELSE IF @ImportHeadName IN ('Customer','CustomerAddress')
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'UserName'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  UserName - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'SEODetails'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'Code'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  Code - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'Highlight'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'HighlightCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  HighlightCode - '' + ' + ' cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'AddonAssociation'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'SKU'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  SKU - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'AttributeDefaultValue'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'AttributeDefaultValueCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  AttributeDefaultValueCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
        ELSE IF @ImportHeadName = 'Brands'  
        BEGIN  
        SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'BrandCode'  
        AND ImportTemplateId = @TemplateId  
  
            SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  BrandCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''   
            FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber   
            WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';  
            PRINT @SQLQueryNew  
           EXEC sys.sp_sqlexec  @SQLQueryNew;  
        END  
	-------------------------------------------------------------------------------------------------------------
	
	--------------------------------------------------------------------------------------------------------------------
			 
  		SET @SQLQuery = 'Delete FROM  '+@TableName+' Where Rownumber IN (Select Rownumber FROM ZnodeImportLog  WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND Rownumber IS NOT NULL)';
        EXEC sys.sp_sqlexec  @SQLQuery;
			 			
   
             IF @ImportHeadName IN('Product', 'Category')
                 BEGIN
                     IF NOT EXISTS
                     (
                         SELECT TOP 1 1
                         FROM @FamilyAttributeDetail
                         WHERE ISNULL(SourceColumnName, '') = ''
                               AND IsRequired = 1
                     ) AND NOT EXISTS
					 (
						 SELECT TOP 1 1
						 FROM ZnodeImportLog
						 WHERE Guid = @NewGUID
							   AND ErrorDescription IN(43, 42)
						 AND ImportProcessLogId = @ImportProcessLogId
					 )
                         BEGIN
                             IF @IsCategory = 0
                                 BEGIN

                                     EXEC Znode_ImportPimProductData
                                          @TableName = @TableName,
                                          @NewGUID = @NewGUID,
                                          @TemplateId = @TemplateId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @UserId = @UserId,
                                          @LocaleId = @LocaleId,
                                          @DefaultFamilyId = @DefaultFamilyId;

                                 END;
                             ELSE
                                 BEGIN
                                     EXEC Znode_ImportPimCategoryData
                                          @TableName = @TableName,
                                          @NewGUID = @NewGUID,
                                          @TemplateId = @TemplateId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @UserId = @UserId,
                                          @LocaleId = @LocaleId,
                                          @DefaultFamilyId = @DefaultFamilyId;
                                 END;
                         END
						 ELSE
							BEGIN
								-- Update Record count in log 
								
							
								--SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
								--EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount out
								--UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
								--WHERE ImportProcessLogId = @ImportProcessLogId;

								SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
								SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
								EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount out
								UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
								WHERE ImportProcessLogId = @ImportProcessLogId;
							END

                 END;
				IF NOT EXISTS
					 (
						 SELECT TOP 1 1
						 FROM ZnodeImportLog
						 WHERE Guid = @NewGUID
							   AND ErrorDescription IN(43, 42)
						 AND ImportProcessLogId = @ImportProcessLogId
					 )
             BEGIN
                 IF @ImportHeadName = 'Pricing'
                     BEGIN
                         EXEC [Znode_ImportPriceList]
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
                              @PriceListId = @PriceListId;
                     END;

                 IF @ImportHeadName = 'Inventory'
                     BEGIN
				
                         EXEC Znode_ImportInventory_Ver1
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID;
                     END;
                 IF @ImportHeadName = 'ZipCode'
                     BEGIN
						 EXEC Znode_ImportZipCode
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
							  @CountryCode = @CountryCode;
                     END;
					 IF @ImportHeadName = 'CategoryAssociation'
                     BEGIN
						 EXEC Znode_ImportCatalogCategory
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
							  @PimCatalogId = @PimCatalogId;
                     END;
					 IF @ImportHeadName = 'ProductAssociation'
                     BEGIN
						 EXEC Znode_ImportAssociateProducts
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID
                     END;
			
					 IF @ImportHeadName = 'SEODetails' AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportSEODetails
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
							  @LocaleId = @LocaleId,
							  @PortalId =@PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
							  @CsvColumnString = @CsvColumnString 

				
                     END;
				
					 IF @ImportHeadName = 'ProductAttribute' 
                     BEGIN
						 EXEC Znode_ImportAttributes
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
							  @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID
				
                     END;

					 IF @ImportHeadName = 'Customer' AND @PortalId > 0 
                     BEGIN
					
						 EXEC Znode_ImportCustomer
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = @PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
				
                     END;
					 
					 IF @ImportHeadName = 'UserApprovers' AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportUserApproval
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = @PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
				
                     END;

					 IF @ImportHeadName = 'B2BCustomer' AND @PortalId > 0 
                     BEGIN

							 EXEC Znode_ImportB2BCustomer
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = @PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
				
                     END;

					 IF @ImportHeadName = 'CustomerAddress' --AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportCustomerAddress
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  --@PortalId  = 7, -- not implemented from forntend 
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString,
							  @IsAccountAddress = @IsAccountAddress
				
                     END;
					 IF @ImportHeadName = 'ShippingAddress' --AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportCustomerAddress
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  --@PortalId  = 7, -- not implemented from forntend 
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString,
							  @IsAccountAddress = @IsAccountAddress
				
                     END;
					 IF @ImportHeadName = 'StoreLocator' --AND @PortalId > 0 
                     BEGIN
					 	 EXEC Znode_ImportStoreLocatorAddress
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
                     END;

					IF @ImportHeadName = 'Highlight'
					BEGIN
					EXEC Znode_ImportHighlight 
					@TableName = @TableName, 
					@Status = @Status, 
					@UserId = @UserId, 
					@ImportProcessLogId = @ImportProcessLogId, 
					@NewGUID = @NewGUID 
					END;

					IF @ImportHeadName = 'AddonAssociation'
					BEGIN
					EXEC Znode_ImportAddonAssociation 
					@TableName = @TableName, 
					@Status = @Status, 
					@UserId = @UserId, 
					@ImportProcessLogId = @ImportProcessLogId, 
					@NewGUID = @NewGUID,
					@PimCatalogId = @PimCatalogId
					END;

					IF @ImportHeadName = 'AttributeDefaultValue'
					BEGIN
					EXEC Znode_ImportAttributeDefaultValue 
					@TableName = @TableName, 
					@Status = @Status, 
					@UserId = @UserId, 
					@ImportProcessLogId = @ImportProcessLogId, 
					@NewGUID = @NewGUID
					
					END;

					IF @ImportHeadName = 'Voucher'
					BEGIN
						EXEC Znode_ImportVoucher 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID
					
					END;

					IF @ImportHeadName = 'Account'
					BEGIN
						
						EXEC Znode_ImportAccount 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID,
						@CsvColumnString = @CsvColumnString,
						@PortalId = @PortalId
					
					END;

					IF @ImportHeadName = 'Synonyms'
					BEGIN
						EXEC Znode_ImportSynonyms 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID
					END

					IF @ImportHeadName = 'CatalogCategoryAssociation'
					BEGIN
						EXEC Znode_ImportCatalogCategoryHierarchyAssociation 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID,
						@PimCatalogId = @PimCatalogId
					END
				 

                    IF @ImportHeadName = 'Brands'
					BEGIN
						EXEC Znode_ImportBrands 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID,
						@LocaleId	 = @LocaleId,
                        @CsvColumnString = @CsvColumnString
					END;
				 
             END
			 ELSE 
				 BEGIN
					-- Update Record count in log 	
					SET @SQLQuery = ' Select @FailedRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
					EXEC	sp_executesql @SQLQuery , N'@FailedRecordCount BIGINT out' , @FailedRecordCount =@FailedRecordCount out
					SELECT @SuccessRecordCount = 0
									
					UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
					WHERE ImportProcessLogId = @ImportProcessLogId;

				 END

             EXEC Znode_ImportReadErrorLog
                  @ImportProcessLogId = @ImportProcessLogId,
                  @NewGUID = @NewGUID;
             DROP TABLE #GlobalTempTableColumns;

             -- Finally call product insert process if error not found in error log table 
             IF EXISTS
             (
                 SELECT TOP 1 1
                 FROM ZnodeImportLog
                 WHERE ImportProcessLogId = @ImportProcessLogId
                       AND Guid = @NewGUID
             )
                 BEGIN
                    --Updating the import process status
					UPDATE ZnodeImportProcessLog
					SET Status = CASE WHEN ISNULL(FailedRecordcount,0) > 0 AND ISNULL(SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
										WHEN ISNULL(FailedRecordcount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
										WHEN ISNULL(FailedRecordcount,0) > 0 AND ISNULL(FailedRecordcount,0) = ISNULL(TotalProcessedRecords,0) THEN dbo.Fn_GetImportStatus( 3 )
									END, 
						ProcessCompletedDate = getdate()
					WHERE ImportProcessLogId = @ImportProcessLogId;
                 END;
				 SET @SQLQuery = 'IF Object_id(''+@TableName+'') IS NOT NULL  DROP TABLE ' + @TableName
                 EXEC sys.sp_sqlexec @SQLQuery;

				 print 'end';
         END TRY
         BEGIN CATCH
			DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE()
			DECLARE @TempCount TABLE (Id INT)

			Declare @SQL Varchar(max) = 'Select Count(*) As Id From '+@TableName
			INSERT INTO @TempCount
			EXEC (@SQL)

             SELECT ERROR_MESSAGE(),
                    ERROR_LINE(),
                    ERROR_PROCEDURE();
             EXEC Znode_ImportReadErrorLog
                  @ImportProcessLogId = @ImportProcessLogId,
                  @NewGUID = @NewGUID; 
             
			 ---Import process updating fail due to database error
			UPDATE ZnodeImportProcessLog
			SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
			WHERE ImportProcessLogId = @ImportProcessLogId;

			---Loging error for Import process due to database error
		    INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		    SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

			--Updating total and fail record count
		    UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		    TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		    WHERE ImportProcessLogId = @ImportProcessLogId;

			SET @SQLQuery = 'Drop Table ' + @TableName
            EXEC sys.sp_sqlexec @SQLQuery;
             --ROLLBACK TRAN TRN_ImportValidProductData;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCatalogCategoryHierarchyAssociation')
	DROP PROC Znode_ImportCatalogCategoryHierarchyAssociation
GO

CREATE PROCEDURE [dbo].[Znode_ImportCatalogCategoryHierarchyAssociation]
(
	@TableName NVARCHAR(100), 
	@Status BIT OUT, 
	@UserId INT, 
	@ImportProcessLogId INT, 
	@NewGUId NVARCHAR(200),
	@PimCatalogId INT
)
AS
BEGIN 
BEGIN TRAN A;
BEGIN TRY
SET NOCOUNT ON;

	DECLARE @GetDate datetime= dbo.Fn_GetDate()
	DECLARE @SSQL VARCHAR(1000)

	IF OBJECT_ID('tempdb..#Category') IS NOT NULL
		DROP TABLE #Category;

	Declare @FeatureValue VARCHAR(500)
	--If the CatalogCategoryHierarchyAssociationAutoCreate value is true, 1 or Yes then input parent code hierarchy will be generate thogh the import
	--If the CatalogCategoryHierarchyAssociationAutoCreate value is false, 0 or No then input parent code hierarchy is not present in the database then it will give an error log
	SELECT TOP 1 @FeatureValue = FeatureValues FROM ZnodeGlobalSetting WHERE FeatureName = 'CatalogCategoryHierarchyAssociationAutoCreate'

	--Getting existing categories
	SELECT A.PimCategoryId,B.CategoryValue CategoryCode 
	INTO #Category 
	FROM ZnodePimCategoryAttributeValue A 
	INNER JOIN ZnodePimCategoryAttributeValueLocale B ON A.PimCategoryAttributeValueId = b.PimCategoryAttributeValueId 
	WHERE EXISTS(SELECT TOP 1 1 FROM ZnodePimAttribute X WHERE X.IsCategory =1 and X.AttributeCode = 'CategoryCode' and A.PimAttributeId = X.PimAttributeId )

	IF OBJECT_ID('tempdb..#HierarchyImportData') IS NOT NULL
		DROP TABLE #HierarchyImportData;

	CREATE TABLE #HierarchyImportData (RowNumber INT,ParentCode NVARCHAR(MAX),CategoryCode NVARCHAR(MAX), DisplayOrder VARCHAR(10),Action VARCHAR(100),GUID VARCHAR(100));

	SET @SSQL = 'Select RowNumber,LTRIM(RTRIM(ParentCode)), LTRIM(RTRIM(CategoryCode)), DisplayOrder, Action ,GUID FROM '+@TableName;
	INSERT INTO #HierarchyImportData( RowNumber,ParentCode, CategoryCode, DisplayOrder,Action ,GUID)
	EXEC sys.sp_sqlexec @SSQL;

	
	IF OBJECT_ID('tempdb..#SplitedCategoryHierarchy') IS NOT NULL
		DROP TABLE #SplitedCategoryHierarchy

	--Created table for category hierarchy split
	CREATE TABLE #SplitedCategoryHierarchy (PimCategoryHierarchyId INT, ParentPimCategoryHierarchyId INT
	,PimCatalogId INT, PimCategoryId INT,RowNumber INT ,PimCategoryCode VARCHAR(300),RowId INT,Action varchar(100),DisplayOrder VARCHAR(10), ParentCategoryId INT)

	DECLARE @RecordCount INT=(SELECT COUNT(1) FROM #HierarchyImportData) , @Cnt INT = 1 ,@FirstCategoryId  INT 
	WHILE @Cnt <= @RecordCount  
	BEGIN
		SET @FirstCategoryId = 0 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '122', 'ParentCode / CategoryCode', '', @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNULL(ParentCode,'') = '' AND ISNULL(CategoryCode,'') = '' AND ii.RowNumber  = @Cnt 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '131', 'CategoryCode', CategoryCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNULL(CategoryCode,'') = ''

		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--SELECT '102', 'CategoryCode', CategoryCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		--FROM #HierarchyImportData AS ii
		--WHERE ltrim(rtrim(isnull(ii.CategoryCode,''))) like '% %' AND ii.RowNumber  = @Cnt 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '16', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE (ii.DisplayOrder > 99999 OR ii.DisplayOrder <= 0) AND ISNULL(ii.DisplayOrder,'') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '115', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNUMERIC(ii.DisplayOrder)=0 AND ISNULL(ii.DisplayOrder,'') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '125', 'Action', Action, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE isnull(Action,'') NOT IN ('ADD','DELETE')
		
		DELETE FROM #HierarchyImportData WHERE RowNumber IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )
		
		IF OBJECT_ID('tempdb..#ExistingHierarchy') IS NOT NULL
			DROP TABLE #ExistingHierarchy;
	
		TRUNCATE TABLE #SplitedCategoryHierarchy

		--Splitting category hierarchy and inserted into temp table #SplitedCategoryHierarchy
		INSERT INTO #SplitedCategoryHierarchy (PimCatalogId , PimCategoryCode ,RowNumber,RowId,Action,DisplayOrder)
		SELECT @PimCatalogId, LTRIM(RTRIM(B.item)) as PimCategoyHierarchyCode , Id, RowNumber, Action, CASE WHEN ISNULL(DisplayOrder,'') = '' THEN 0 ELSE DisplayOrder END
		FROM #HierarchyImportData A 
		CROSS APPLY  dbo.split(isnull(A.ParentCode,'')+CASE WHEN isnull(A.ParentCode,'') = '' THEN '' ELSE '/' END+A.CategoryCode,'/') B 
		Where A.RowNumber  = @Cnt  

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '127', 'ParentCode / CategoryCode', PimCategoryCode, @NewGUId, RowId, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #SplitedCategoryHierarchy AS ii
		WHERE NOT EXISTS(SELECT * FROM #Category C WHERE LTRIM(RTRIM(ii.PimCategoryCode)) = c.CategoryCode)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '123', 'ParentCode / CategoryCode', PimCategoryCode, @NewGUId, RowId, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #SplitedCategoryHierarchy AS ii
		GROUP BY PimCategoryCode ,RowId
		HAVING COUNT(*) > 1

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '124', 'ParentCode', ParentCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNULL(replace(ii.ParentCode,' ',''),'') like '%//%'
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '128', 'CategoryCode', CategoryCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #HierarchyImportData AS ii
		WHERE ISNULL(replace(LTRIM(RTRIM(ii.CategoryCode)),' ',''),'') like '%[^a-zA-Z0-9]%'

		--Deleting the records which was invalid and added into error log
		DELETE FROM #SplitedCategoryHierarchy WHERE RowId IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )
		DELETE FROM #HierarchyImportData WHERE RowNumber IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )

		IF OBJECT_ID('tempdb..#CategoryCodeCheck') IS NOT NULL
			DROP TABLE #CategoryCodeCheck;

		IF EXISTS(SELECT * FROM #SplitedCategoryHierarchy)
		BEGIN
			Update A SET A.PimCategoryId = D.PimCategoryId FROM #SplitedCategoryHierarchy A INNER JOIN #Category D ON LTRIM(RTRIM(A.PimCategoryCode)) = LTRIM(RTRIM(D.CategoryCode))

			Select TOP 1 @FirstCategoryId = X.PimCategoryId FROM #SplitedCategoryHierarchy X
	
			--Getting existing category hierarchy
			;WITH CTE_ZnodePimCategoryHierarchy as 
			(
				SELECT PimCategoryHierarchyId,ParentPimCategoryHierarchyId,PimCategoryId,PimCatalogId
				FROM ZnodePimCategoryHierarchy 
				WHERE PimCatalogId = @PimCatalogId 
			)
			,Hierarchy AS
			(
				-- Anchor
				SELECT  A.PimCategoryHierarchyId,A.ParentPimCategoryHierarchyId,A.PimCategoryId,A.PimCatalogId --, dense_rank() over(order by a.ParentPimCategoryHierarchyId) as RowNumber
				FROM CTE_ZnodePimCategoryHierarchy A
				WHERE A.ParentPimCategoryHierarchyId IS NULL AND  
				A.PimCategoryId =@FirstCategoryId 	AND A.PimCatalogId = @PimCatalogId
				UNION ALL
				-- Recursive query
				SELECT  E.PimCategoryHierarchyId,E.ParentPimCategoryHierarchyId,E.PimCategoryId,E.PimCatalogId--, ROW_NUMBER() over(order by E.ParentPimCategoryHierarchyId,E.PimCategoryHierarchyId) as RowNumber
				FROM CTE_ZnodePimCategoryHierarchy E
				JOIN Hierarchy H ON E.ParentPimCategoryHierarchyId = H.PimCategoryHierarchyId
				WHERE  Exists(Select * FROM #SplitedCategoryHierarchy X WHERE E.PimCategoryId = X.PimCategoryId)
			)
			SELECT * INTO #ExistingHierarchy FROM Hierarchy --Where RowNumber  = @Cnt  --
			--order by PimCategoryHierarchyId

			--Adding required columns into temp table
			Alter table #ExistingHierarchy Add Id INT Identity(1,1), RowNumber INT, ParentCategoryId INT

			--Updating the row number for parent category
			UPDATE #ExistingHierarchy SET RowNumber = 1 WHERE ParentPimCategoryHierarchyId IS NULL

			DECLARE @RecordCount1 INT=(SELECT COUNT(1) FROM #ExistingHierarchy) , @Cnt1 INT = 1 --,@FirstCategoryId1  INT 
			DECLARE @ParentPimCategoryHierarchyId1 INT , @RowNumber INT

			--Updating the row number according to category hierarhcy level
			WHILE @Cnt1 <= @RecordCount1  
			BEGIN
				
				SELECT @ParentPimCategoryHierarchyId1 = PimCategoryHierarchyId FROM #ExistingHierarchy WHERE Id = @Cnt1
				SET @RowNumber = (SELECT TOP 1 RowNumber FROM #ExistingHierarchy WHERE PimCategoryHierarchyId = @ParentPimCategoryHierarchyId1) 

				UPDATE #ExistingHierarchy SET RowNumber = @RowNumber + 1
				WHERE ParentPimCategoryHierarchyId = @ParentPimCategoryHierarchyId1
				
				SET @ParentPimCategoryHierarchyId1 = 0
				SET @RowNumber = 0
				SET @Cnt1 = @Cnt1+1
			END

			--Updating the parent category on existing category hierarchy
			UPDATE b SET ParentCategoryId = a.PimCategoryId
			from #ExistingHierarchy a
			inner join #ExistingHierarchy b on b.ParentPimCategoryHierarchyId = a.PimCategoryHierarchyId
			
			--Updating the parent category on input record
			UPDATE  A SET A.ParentCategoryId = B.PimCategoryId
			FROM #SplitedCategoryHierarchy A  
			INNER JOIN #SplitedCategoryHierarchy B ON B.RowNumber = A.RowNumber-1
						
			--Existing Hierarchy has been updated on the input categories
			Update B SET B.PimCategoryHierarchyId= A.PimCategoryHierarchyId, 
			B.ParentPimCategoryHierarchyId = A.ParentPimCategoryHierarchyId
			FROM #ExistingHierarchy  A INNER JOIN #SplitedCategoryHierarchy B ON ISNULL(A.PimCategoryId,0) = ISNULL(B.PimCategoryId,0) AND ISNULL(A.ParentCategoryId,0) = ISNULL(B.ParentCategoryId,0) and A.RowNumber = B.RowNumber 

			--Removing hierarchy ids of categoris if its parent dont have any hierarchy for input	
			UPDATE CH SET PimCategoryHierarchyId = NULL ,ParentPimCategoryHierarchyId = NULL
			FROM #SplitedCategoryHierarchy CH
			WHERE CH.PimCategoryHierarchyId IS NOT NULL AND EXISTS(SELECT * FROM #SplitedCategoryHierarchy CH1 WHERE CH1.PimCategoryHierarchyId IS NULL AND CH.RowNumber-1 = CH1.RowNumber)

			--Removing hierarchy ids of categories if its parent doesent present in the input hierarchy
			UPDATE A SET PimCategoryHierarchyId = NULL ,ParentPimCategoryHierarchyId = NULL 
			FROM #SplitedCategoryHierarchy A 
			WHERE NOT EXISTS(SELECT * FROM #SplitedCategoryHierarchy X WHERE X.PimCategoryHierarchyId = A.ParentPimCategoryHierarchyId)
			AND A.ParentPimCategoryHierarchyId IS NOT NULL 
			
			IF isnull(@FeatureValue,'') IN ('False','0','No','')
			BEGIN
				--If root level category is not present
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '130', 'ParentCode', ParentCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #HierarchyImportData h
				WHERE RowNumber IN (
					SELECT RowId FROM #SplitedCategoryHierarchy a
					WHERE NOT EXISTS(SELECT * FROM #HierarchyImportData b WHERE LTRIM(RTRIM(A.PimCategoryCode)) = LTRIM(RTRIM(b.CategoryCode)) AND a.RowId = b.RowNumber)
					AND A.ParentCategoryId IS NULL AND A.PimCategoryHierarchyId IS NULL)
				
				--If child level category is not present
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '130', 'ParentCode', ParentCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #HierarchyImportData H
				WHERE RowNumber IN (
					SELECT RowId FROM #SplitedCategoryHierarchy a
					WHERE NOT EXISTS(SELECT * FROM #HierarchyImportData b WHERE LTRIM(RTRIM(A.PimCategoryCode)) = LTRIM(RTRIM(b.CategoryCode)) AND a.RowId = b.RowNumber)
					AND A.ParentCategoryId IS NOT NULL AND A.ParentPimCategoryHierarchyId IS NULL)
				AND NOT EXISTS(SELECT * FROM ZnodeImportLog X WHERE H.RowNumber = X.RowNumber AND X.ImportProcessLogId=@ImportProcessLogId)
				
				--Deleting the records which was invalid and added into error log
				DELETE FROM #SplitedCategoryHierarchy WHERE RowId IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )
				DELETE FROM #HierarchyImportData WHERE RowNumber IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )
			END

			--Adding new hierarchy into ZnodePimCategoryHierarchy if input having Add action
			IF EXISTS(SELECT * FROM #SplitedCategoryHierarchy WHERE Action = 'Add')
			BEGIN
				
				DROP TABLE IF EXISTS #InsertedPimCategoryHierarchy

				CREATE TABLE #InsertedPimCategoryHierarchy (PimCategoryHierarchyId INT, PimCategoryId INT);

				--Inserting new category hierarchy if not present
				INSERT INTO ZnodePimCategoryHierarchy (PimCatalogId,ParentPimCategoryHierarchyId,PimCategoryId,DisplayOrder,IsActive,
					ActivationDate,ExpirationDate,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PimParentCategoryId)
				OUTPUT inserted.PimCategoryHierarchyId,inserted.PimCategoryId
				INTO #InsertedPimCategoryHierarchy (PimCategoryHierarchyId, PimCategoryId)
				Select PimCatalogId,ParentPimCategoryHierarchyId,PimCategoryId,DisplayOrder,1,NULL,NULL,2,GETDATE(),2,GETDATE(),NULL
				FROM #SplitedCategoryHierarchy WHERE PimCategoryHierarchyId is null 

				-- Newly created Hierarchy has been updated into input category hierarchy
				UPDATE A 
				SET A.PimCategoryHierarchyId=B.PimCategoryHierarchyId
				FROM #SplitedCategoryHierarchy A INNER JOIN #InsertedPimCategoryHierarchy B
					ON A.PimCategoryId=B.PimCategoryId
				WHERE A.PimCategoryHierarchyId IS NULL

				-- Updating new parent hierarchy has been updated into input category hierarchy
				UPDATE A SET A.ParentPimCategoryHierarchyId =(Select PimCategoryHierarchyId FROM #SplitedCategoryHierarchy X WHERE X.RowNumber = A.RowNumber -1 )
				FROM #SplitedCategoryHierarchy A 
		
				-- Updating new parent hierarchy has been updated newly added input category hierarchy into table ZnodePimCategoryHierarchy
				UPDATE ZnodePimCategoryHierarchy SET ParentPimCategoryHierarchyId = A.ParentPimCategoryHierarchyId
				FROM #SplitedCategoryHierarchy A WHERE ZnodePimCategoryHierarchy.PimCategoryHierarchyId = A.PimCategoryHierarchyId
				AND EXISTS(SELECT * FROM #InsertedPimCategoryHierarchy B WHERE A.PimCategoryHierarchyId = B.PimCategoryHierarchyId)
			END
			ELSE
			BEGIN
			
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '126', 'ParentCode / CategoryCode', ParentCode + case when isnull(ParentCode,'') <> '' then '/' else '' end + CategoryCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #HierarchyImportData AS ii
				WHERE ii.RowNumber = (SELECT TOP 1 RowId FROM #SplitedCategoryHierarchy where PimCategoryHierarchyId is null ORDER BY RowNumber DESC)

				DELETE FROM #SplitedCategoryHierarchy WHERE RowId IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )
				DELETE FROM #HierarchyImportData WHERE RowNumber IN (SELECT RowNumber FROM ZnodeImportLog WHERE ImportProcessLogId = @ImportProcessLogId )

				--Delete the category hierarchy and its child category 
				DECLARE @PimCategoryHierarchyId INT
				SET @PimCategoryHierarchyId = (SELECT TOP 1 PimCategoryHierarchyId FROM #SplitedCategoryHierarchy ORDER BY RowNumber DESC)
				EXECUTE [Znode_DeletePimCategoryHierarchy] @PimCategoryHierarchyId = @PimCategoryHierarchyId, @PimCatalogId = @PimCatalogId, @Status = 0
			END
		END

		SET @Cnt = @Cnt + 1 
	END

	DECLARE @FailedRecordCount BIGINT
	DECLARE @SuccessRecordCount BIGINT

	SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
	SELECT @SuccessRecordCount = COUNT(DISTINCT RowNumber) FROM #HierarchyImportData

	--Updating the import process status
	UPDATE ZnodeImportProcessLog
	SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
						WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
						WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
					END, 
		ProcessCompletedDate = getdate()
	WHERE ImportProcessLogId = @ImportProcessLogId;

	UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
	WHERE ImportProcessLogId = @ImportProcessLogId;

COMMIT TRAN A;
END TRY
BEGIN CATCH
ROLLBACK TRAN A;

	SET @Status = 0;
	SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

	DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCatalogCategoryHierarchyAssociation @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(200));


	---Import process updating fail due to database error
	UPDATE ZnodeImportProcessLog
	SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
	WHERE ImportProcessLogId = @ImportProcessLogId;

	---Loging error for Import process due to database error
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

	--Updating total and fail record count
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
	TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
	WHERE ImportProcessLogId = @ImportProcessLogId;

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_ImportCatalogCategoryHierarchyAssociation',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
		
		
END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity
GO


CREATE PROCEDURE [dbo].[Znode_PublishCatalogEntity]  
(  
	@PimCatalogId  INT = 0   
	,@RevisionState VARCHAR(50) = ''   
	,@UserId INT = 0  
	,@NewGUID NVARCHAR(500)   
	,@IsDraftProductsOnly BIT = 1  
)  
AS  
/*  
To publish all catalog product and their details  
Unit Testing :   
Exec [dbo].[Znode_PublishCatalogEntity]  
@PimCatalogId  = 3  
,@RevisionState = 'PRODUCTION'   
,@UserId = 2  
,@NewGUID = '123'  
   
EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,  
@NewGUID ='123'   
  
*/  
BEGIN  
BEGIN TRY   
	SET NOCOUNT ON  

	DECLARE @Status Bit =0 , @PublishCatalogId INT=0  
	IF (@PimCatalogId=0)  
	BEGIN  
	--SET @Status =0  
		SELECT 0 AS ID,@Status AS Status;  
		SET @PublishCatalogId=0  
		SELECT @PublishCatalogId;  
	END  
	ELSE  
	BEGIN  
   
		DECLARE @Type VARCHAR(50) = '', @CMSSEOCode VARCHAR(300);  
		SET @Status = 1   
		DECLARE @IsPreviewEnable INT  
		,@PreviewVersionId INT = 0    
		,@ProductionVersionId INT = 0  
		,@CatalogProfileId VARCHAR(1000)  
   
		IF OBJECT_ID('tempdb..#CatalogAttributeDetails') IS NOT NULL  
		DROP TABLE #CatalogAttributeDetails  
		CREATE TABLE [dbo].[#CatalogAttributeDetails]  
		(  
			[ZnodeCatalogId] [INT] NULL,  
			[AttributeCode] [NVARCHAR](300) NULL,  
			[AttributeTypeName] [VARCHAR](300) NULL,  
			[IsComparable] [bit] NOT NULL,  
			[IsHtmlTags] [bit] NOT NULL,  
			[IsFacets] [bit] NOT NULL,  
			[IsUseInSearch] [bit] NOT NULL,  
			[IsPersonalizable] [bit] NOT NULL,  
			[IsConfigurable] [bit] NOT NULL,  
			[AttributeName] [NVARCHAR](300) NULL,  
			[LocaleId] [INT] NULL,  
			[DisplayOrder] [INT] NULL,  
			[DefaultValueDisplayOrder] [INT] NULL,  
			[AttributeDefaultValue] [NVARCHAR](max) NULL  
		) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY] 
		
		DECLARE @CatalogName VARCHAR(100),@UserName VARCHAR(50)  
		SET @PublishCatalogId = ISNULL((SELECT TOP 1 PublishCatalogId FROM ZnodePublishCatalog ZPC WHERE ZPC.PimCatalogId = @PimCatalogId), 0)  
    
	SELECT TOP 1  @UserName = UserName 
	FROM ZnodeUser 
	WHERE ZnodeUser.UserId = @userId  
  
	SELECT @CatalogName = CatalogName FROM ZnodePimCatalog WHERE PimCatalogId = @PimCatalogId
	
	DELETE FROM ZnodePublishProgressNotifierEntity WHERE JOBName =@CatalogName   

	INSERT INTO ZnodePublishProgressNotifierEntity  
	(VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriENDlyName)  
	VALUES(0,@NewGUID , Isnull(@CatalogName,'') + ' Catalog ', 0 , 0 , 0 , '' , @UserId, @UserName )  
  
	IF EXISTS (SELECT  * FROM ZnodePublishStateApplicationTypeMapping PSA WHERE PSA.IsEnabled =1 AND    
	EXISTS (SELECT TOP 1 1  FROM ZnodePublishState PS WHERE PS.PublishStateId = PSA.PublishStateId ) AND ApplicationType =  'WebstorePreview')  
		SET @IsPreviewEnable = 1   
	ELSE   
		SET @IsPreviewEnable = 0   
  
	--Genrate preview entry   
	DECLARE @SetLocaleId INT , @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleId(), @MaxCount INT =0 , @IncrementalId INT = 1    
	DECLARE @TBL_Locale TABLE (LocaleId INT , RowId INT IDENTITY(1,1))  
    
	IF OBJECT_ID('tempdb..[#Tbl_NewVersionEntity]') IS NOT NULL  
		DROP TABLE tempdb..#Tbl_NewVersionEntity  
	
	CREATE TABLE #Tbl_NewVersionEntity(PublishCatalogId INT , VersionId INT , LocaleId INT , PublishType VARCHAR(50) )  
  
	--IF OBJECT_ID('tempdb..[#Tbl_OldVersionEntity]') IS NOT NULL  
	--	DROP TABLE tempdb..#Tbl_OldVersionEntity  
	
	--CREATE TABLE #Tbl_OldVersionEntity(PublishCatalogId INT , NewVersionId INT ,OldVersionId INT , LocaleId INT , PublishType VARCHAR(50) )  
    
    
	IF @PublishCatalogId > 0   
    BEGIN
		UPDATE ZPC SET CatalogName = ZC.CatalogName,ExternalId = ZC.ExternalId,PimCatalogId= @PimCatalogId,CreatedBy = @UserId,  
		CreatedDate = Getdate(),ModifiedBy = @UserId,ModifiedDate = Getdate()  
		FROM ZnodePublishCatalog ZPC   
		INNER JOIN ZnodePimCatalog ZC ON(ZC.PimCatalogId = ZPC.PimCatalogId)  
		WHERE ZPC.PimCatalogId = @PimCatalogId;  
	END
	ELSE  
	BEGIN  
		INSERT INTO ZnodePublishCatalog (PimCatalogId,CatalogName,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)  
		SELECT PimCatalogId,CatalogName,ExternalId,@UserId,Getdate(),@UserId,Getdate() FROM ZnodePimCatalog AS ZPC   
		WHERE ZPC.PimCatalogId = @PimCatalogId;  
                        
		SET @PublishCatalogId = SCOPE_IDENTITY();  
	END  
  
	--Getting active local for catalog which are associated to store
	INSERT INTO @TBL_Locale (LocaleId) 
	SELECT LocaleId FROM DBO.FN_GetCatalogPortalActiveLocale(@PublishCatalogId)
  
	SET @MaxCount = ISNULL((SELECT MAx(RowId) FROM @TBL_Locale),0)  

	WHILE @IncrementalId <= @MaxCount  
	BEGIN   
		SET @SetLocaleId = (SELECT Top 1 LocaleId FROM @TBL_locale WHERE RowId = @IncrementalId)  

		IF @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  )    
		BEGIN  
			
			INSERT INTO ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId)  
			SELECT @PublishCatalogId,  @PimCatalogId,NULL,0,  
			NULL,0,  
			NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(), null ,@SetLocaleId ,DBO.Fn_GetPublishStateIdForProcessing()   
  
			INSERT INTO #Tbl_NewVersionEntity (PublishCatalogId,VersionId,LocaleId,PublishType)  
			SELECT @PublishCatalogId, @@Identity , @SetLocaleId ,'PREVIEW'  
      
		END  

		IF (@RevisionState like '%Production%' OR @RevisionState = 'None')  
		BEGIN  
			UPDATE B
            SET IsPublishSuccess = 0
            FROM ZnodePublishVersionEntity B
            WHERE EXISTS(SELECT * FROM #Tbl_NewVersionEntity A WHERE A.PublishCatalogId = B.ZnodeCatalogId 
                AND A.PublishType = 'PRODUCTION' AND A.LocaleId = B.LocaleId) 
            AND B.RevisionType = 'PRODUCTION'

			--Genrate production entry   
			INSERT INTO ZnodePublishCatalogLog  
			(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId)  
			SELECT @PublishCatalogId,  @PimCatalogId,NULL,0,  
			NULL,0,  
			NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(), null ,@SetLocaleId ,DBO.Fn_GetPublishStateIdForProcessing()   
     
			INSERT INTO #Tbl_NewVersionEntity (PublishCatalogId,VersionId,LocaleId,PublishType)  
			SELECT @PublishCatalogId, @@Identity , @SetLocaleId ,'PRODUCTION'  
		END   
			SET @IncrementalId = @IncrementalId +1   
	END  
	
	DECLARE  @VersionIdString VARCHAR(2000)= ''    
     
	TRUNCATE TABLE ZnodePublishCatalogErrorLogEntity  

	UPDATE ZnodePublishProgressNotifierEntity SET   
	ProgressMark =5,   
	IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
	IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
	WHERE  JobId = @NewGUID  
   
	--EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = @PublishCatalogId,@UserId = @UserId , @IsRevertPublish = 0 ,  
	--@NewGUID =@NewGUID   
  
	IF @Type = 'ZnodePublishCatalogEntity' OR @Type = ''  
	BEGIN  
   
		INSERT INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing)  
		SELECT Distinct VE.VersionId, ZPC.PublishCatalogId, PC.CatalogName,VE.PublishType, VE.LocaleId, isnull(PC.IsAllowIndexing,0)  
		FROM ZnodePublishCatalog ZPC  
		INNER JOIN  #Tbl_NewVersionEntity VE ON (VE.PublishCatalogId = ZPC.PublishCatalogId)  
		INNER JOIN ZnodePimCatalog PC on ZPC.PimCatalogId = PC.PimCatalogId  
		-- Data inserted INTo flat table ZnodeWebStoreEntity (Replica of MongoDB Collection )    
    
		IF @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  )   
		BEGIN  
			UPDATE B
            SET IsPublishSuccess = 0
            FROM ZnodePublishVersionEntity B
            WHERE EXISTS(SELECT * FROM #Tbl_NewVersionEntity A WHERE A.PublishCatalogId = B.ZnodeCatalogId 
                AND A.PublishType = 'PREVIEW' AND A.LocaleId = B.LocaleId) 
            AND B.RevisionType = 'PREVIEW'

			INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
			SELECT VersionId,PublishCatalogId,PublishType,LocaleId,0 FROM  #Tbl_NewVersionEntity A
			WHERE A.PublishType = 'PREVIEW'  
			AND NOT EXISTS(SELECT * FROM ZnodePublishVersionEntity B WHERE A.PublishCatalogId = B.ZnodeCatalogId 
			AND B.RevisionType = 'PREVIEW' AND A.LocaleId = B.LocaleId )
		END  

		IF (@RevisionState like '%Production%' OR @RevisionState = 'None')  
		BEGIN  
			UPDATE B
            SET IsPublishSuccess = 0
            FROM ZnodePublishVersionEntity B
            WHERE EXISTS(SELECT * FROM #Tbl_NewVersionEntity A WHERE A.PublishCatalogId = B.ZnodeCatalogId 
                AND A.PublishType = 'PRODUCTION' AND A.LocaleId = B.LocaleId) 
            AND B.RevisionType = 'PRODUCTION'

			INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
			SELECT VersionId,PublishCatalogId,PublishType,LocaleId,0 FROM  #Tbl_NewVersionEntity A
			WHERE PublishType = 'PRODUCTION'  
			AND NOT EXISTS(SELECT * FROM ZnodePublishVersionEntity B WHERE A.PublishCatalogId = B.ZnodeCatalogId 
			AND B.RevisionType = 'PRODUCTION' AND A.LocaleId = B.LocaleId )
		END  
  
		INSERT INTO ZnodePublishCatalogErrorLogEntity  
		(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishCatalogEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
	END  
  
    IF @RevisionState = 'Preview'
	BEGIN
		SELECT @VersionIdString = STUFF((SELECT ',' + cast (VersionId as VARCHAR(50))  
		FROM ZnodePublishVersionEntity WHERE RevisionType = 'Preview' AND ZnodeCatalogId = @PublishCatalogId FOR XML PATH ('')), 1, 1, '')   
	END
	ELSE
	BEGIN
		SELECT @VersionIdString = STUFF((SELECT ',' + cast (VersionId as VARCHAR(50))  
		FROM ZnodePublishVersionEntity WHERE ZnodeCatalogId = @PublishCatalogId FOR XML PATH ('')), 1, 1, '') 
	END


	IF @Type = 'ZnodePublishCategoryEntity' OR @Type = ''  
	BEGIN  
		EXEC [Znode_GetPublishCategoryJson]  
		@PublishCatalogId = @PublishCatalogId ,  
		@UserId =@UserId,                 
		@VersionIdString = @VersionIdString,  
		@Status  =@Status Out,  
		@RevisionState = @RevisionState   
   
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishCategoryEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
     
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =30,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
  
		IF @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END   
   
	IF @Type = 'ZnodePublishProductEntity' OR @Type = ''  
	BEGIN  
		-- Process call catalog publish (include category, products with multiple types)  
		DECLARE @PimProductId TransferId   
		EXEC [Znode_PublishLatestAssociatedProduct] @PublishCatalogId = @PublishCatalogId, @PimProductId = @PimProductId  , @UserId = @UserId , @PublishStateId =0   
		EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId= @PublishCatalogId ,@userid =@userid ,@PimProductId = @PimProductId   
		EXEC Znode_GetPublishProductJson   
		@PublishCatalogId =@PublishCatalogId   
		,@PimProductId = @PimProductId   
		,@UserId = @userid  
		,@PimCatalogId = @PimCatalogId   
		,@VersionIdString = @VersionIdString  
		,@Status  =@Status  Out  
		,@RevisionState = @RevisionState   
		,@IsDraftProductsOnly = @IsDraftProductsOnly  
   
		EXECUTE [Znode_PublishCategoryHierarchyParentIds] @PimCatalogId = @PimCatalogId
    
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishProductEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =50,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
		If @Status  = 1  
		BEGIN  
			UPDATE ZPCE SET ZPCE.ProductIds =   
			'[' +SUBSTRING((SELECT ','+CAST(PublishProductId AS VARCHAR(50))  
			FROM ZnodePublishCategoryProduct ZPCP   
			WHERE ZPCP.PublishCategoryId = ZPCE.ZnodeCategoryId  
			AND ZPCP.PublishCatalogId = ZPCE.ZnodeCatalogId  FOR XML PATH('')), 2, 8000) + ']'   
			FROM ZnodePublishCategoryEntity  ZPCE WHERE ZPCE.ProductIds is null   
		END  
  
  
		If @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END  

	IF @Type = 'ZnodePublishAddOnEntity' OR @Type = ''  
	BEGIN  
		Exec [Znode_GetPublishAssociatedAddonsJson]  
		@PublishCatalogId = @PublishCatalogId ,  
		@PimProductId   = @PimProductId ,  
		@UserId =@UserId,                 
		@VersionIdString = @VersionIdString,  
		@RevisionType='',  
		@Status  =@Status Out  
  
    
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishAddOnEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =52,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
     
		If @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END   
   
	If @Type = 'BundleAssociatedProducts' OR @Type = ''  
	BEGIN  
		Exec [Znode_GetPublishAssociatedProductsJson]  
		@PublishCatalogId = @PublishCatalogId ,  
		@UserId =@UserId,                 
		@VersionIdString = @VersionIdString,  
		@RevisionType = '',  
		@Status  =@Status Out,  
		@ProductType    = 'BundleProduct'  
    
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'BundleAssociatedProducts', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =54,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
     
		If @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END   

	IF @Type = 'GroupedAssociatedProducts' OR @Type = ''  
	BEGIN  
		Exec [Znode_GetPublishAssociatedProductsJson]  
		@PublishCatalogId = @PublishCatalogId ,  
		@UserId =@UserId,                 
		@VersionIdString = @VersionIdString,  
		@RevisionType = '',  
		@Status  =@Status Out,  
		@ProductType    = 'GroupedProduct'  

		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'GroupedAssociatedProducts', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
     
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =56,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  

		IF @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END   

	IF @Type = 'ConfigurableAssociatedProducts' OR @Type = ''  
	BEGIN  
		Exec [Znode_GetPublishAssociatedProductsJson]  
		@PublishCatalogId = @PublishCatalogId ,  
		@UserId =@UserId,                 
		@VersionIdString = @VersionIdString,  
		@RevisionType = '',  
		@Status  =@Status Out,  
		@ProductType= 'ConfigurableProduct'  
  
      
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ConfigurableAssociatedProducts', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =58,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
     
		IF @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END   

	IF @Type = 'CatalogAttributeaDetail' OR @Type = ''  
	BEGIN  
	BEGIN TRY  
		--INSERT INTO #Tbl_VersionEntity (LocaleId,VersionId,RevisionType)  
		SELECT PV.LocaleId , PV.VersionId , PV.RevisionType  
		into #Tbl_VersionEntity
		FROM ZnodePublishVersionEntity PV INNER JOIN Split(@VersionIdString,',') S ON PV.VersionId = S.Item

		INSERT INTO [dbo].[#CatalogAttributeDetails]([ZnodeCatalogId],[AttributeCode],[AttributeTypeName],[IsComparable],  
		[IsHtmlTags],[IsFacets],[IsUseInSearch],[IsPersonalizable],[IsConfigurable],[AttributeName],  
		[LocaleId],[DisplayOrder],[DefaultValueDisplayOrder],[AttributeDefaultValue] )  
		EXEC Znode_GetPublishProductAttribute @PublishCatalogId   

		SELECT Distinct   
		B.VersionId, A.[ZnodeCatalogId],A.[AttributeCode],A.[AttributeTypeName],0 IsPromoRuleCondition,[IsComparable],  
		[IsHtmlTags],[IsFacets],[IsUseInSearch],[IsPersonalizable],[IsConfigurable],  
		[AttributeName],A.[LocaleId],[DisplayOrder] ,  
		(SELECT Isnull(IA.AttributeDefaultValue,'') Value , Isnull(IA.[DefaultValueDisplayOrder],'') DisplayOrder    
		from [dbo].[#CatalogAttributeDetails] IA  WHERE IA.AttributeCode = A.AttributeCode AND IA.LocaleId = A.LocaleId   
		For JSON PATH) SELECTValues  
		INTO #Temp_PublishCatalogAttribute
		FROM [dbo].[#CatalogAttributeDetails] A INNER JOIN #Tbl_VersionEntity B on A.LocaleId = B.LocaleId

		DELETE X  
		FROM [dbo].ZnodePublishCatalogAttributeEntity X
		WHERE NOT EXISTS(SELECT * FROM #Temp_PublishCatalogAttribute A
			WHERE A.VersionId=X.VersionId AND A.[ZnodeCatalogId]=X.ZnodeCatalogId 
			AND A.[AttributeCode]=X.AttributeCode AND A.LocaleId = X.LocaleId)
		AND X.ZnodeCatalogId = @PublishCatalogId


		UPDATE X SET    
		X.AttributeTypeName = A.[AttributeTypeName] ,X.IsComparable = A.[IsComparable],  
		X.IsHtmlTags = A.[IsHtmlTags],X.IsFacets = A.[IsFacets], X.IsUseInSearch = A.[IsUseInSearch],
		X.IsPersonalizable = A.[IsPersonalizable],X.IsConfigurable = A.[IsConfigurable],  
		X.AttributeName = A.[AttributeName],X.DisplayOrder = A.[DisplayOrder] , X.SELECTValues = A.SELECTValues
		FROM [dbo].#Temp_PublishCatalogAttribute A   
		INNER JOIN ZnodePublishCatalogAttributeEntity X ON A.VersionId=X.VersionId AND A.[ZnodeCatalogId]=X.ZnodeCatalogId 
		AND A.[AttributeCode]=X.AttributeCode AND A.LocaleId = X.LocaleId
		AND X.ZnodeCatalogId = @PublishCatalogId

     
		INSERT INTO ZnodePublishCatalogAttributeEntity  
		(VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition,IsComparable,  
		IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,  
		AttributeName,LocaleId,DisplayOrder,SELECTValues)  
		SELECT Distinct   
		a.VersionId, A.[ZnodeCatalogId],A.[AttributeCode],A.[AttributeTypeName],0 IsPromoRuleCondition,[IsComparable],  
		[IsHtmlTags],[IsFacets],[IsUseInSearch],[IsPersonalizable],[IsConfigurable],  
		[AttributeName],A.[LocaleId],[DisplayOrder] ,  a.SELECTValues
		FROM [dbo].#Temp_PublishCatalogAttribute A   
		WHERE NOT EXISTS(SELECT * FROM ZnodePublishCatalogAttributeEntity X WHERE a.VersionId=X.VersionId AND A.[ZnodeCatalogId]=X.ZnodeCatalogId 
		AND A.[AttributeCode]=X.AttributeCode AND A.LocaleId = X.LocaleId)
   
		SET @Status =1   
    
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'CatalogAttributeaDetail', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =60,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
     
  
	END TRY   
	BEGIN CATCH   
		SET @Status   = 0   
     
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'CatalogAttributeaDetail', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		IF @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END CATCH    
	END   
  
	IF @Type = 'ZnodePublishSEOEntity' OR @Type = ''  
	BEGIN  
		EXEC [Znode_SetPublishSEOEntity]  
		@RevisionState = @RevisionState   
		,@CMSSEOTypeId  = '1,2'   
		,@UserId  = @UserId   
		,@Status  = @Status  OUTPUT   
		,@IsCatalogPublish = 1    
		,@VersionIdString  = @VersionIdString   
		,@IsPreviewEnable  = @IsPreviewEnable   
     
   
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishSEOEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =70,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
  
		If @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
  
	END   
  
	IF EXISTS (SELECT TOP 1 1  FROM ZnodePublishCatalogErrorLogEntity WHERE  ProcessStatus = 'Fail')   
	BEGIN  
    
		SET @Status  =0   
		SELECT 1 AS ID,@Status AS Status;  
		INSERT INTO ZnodePublishCatalogErrorLogEntity  
		(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishPortalEntity', @RevisionState , 'Fail' , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
     
		--EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = @PublishCatalogId,@UserId = @UserId , @IsRevertPublish = 0 ,  
		--@NewGUID =@NewGUID   
  
		UPDATE ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed(),  
		IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0, ModifiedDate = Getdate()  
		WHERE PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()
		
		UPDATE ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed(),  
		IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0  
		, ModifiedDate = Getdate()  
		WHERE PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()
		Return 0   
	END  
  
	SET @Status = 1  
  
    
	SELECT @PublishCatalogId AS id,@Status AS Status;     
END  
END TRY   
BEGIN CATCH   
	SET @Status =0    
	SELECT 1 AS ID,@Status AS Status;     
   
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	@ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity   
	@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))  
	+',@PreviewVersionId = ' + CAST(@PreviewVersionId  AS VARCHAR(20))  
	+',@ProductionVersionId = ' + CAST(@ProductionVersionId  AS VARCHAR(20))  
	+',@RevisionState = ''' + CAST(@RevisionState  AS VARCHAR(50))  
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20)); SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
   
     
	INSERT INTO ZnodePublishCatalogErrorLogEntity  
	(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
	SELECT 'Znode_PublishCatalogEntity', @RevisionState + isnull(@ErrorMessage,'') , 'Fail' , Getdate(),   
	@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
   
	EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = @PublishCatalogId,@UserId = @UserId , @IsRevertPublish = 0 ,  
	@NewGUID =@NewGUID   
  
	UPDATE ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed(),  
	IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0 , ModifiedDate = Getdate()   WHERE  PublishCatalogLogId in   
	(SELECT VersionId FROM #Tbl_NewVersionEntity WHERE PublishType = 'PREVIEW' )  
	UPDATE ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed() ,  
	IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0 , ModifiedDate = Getdate() WHERE  PublishCatalogLogId in  
	(SELECT VersionId FROM #Tbl_NewVersionEntity WHERE PublishType = 'PRODUCTION' )  
                        
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_PublishCatalogEntity',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
END

GO

UPDATE ZnodeApplicationSetting
SET Setting ='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>OmsTemplateId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>TemplateName</name><headertext>Saved Cart Name</headertext><width>0</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl>/SavedCart/EditSavedCartItem</islinkactionurl><islinkparamfield>omsTemplateId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>Items</name><headertext>Quantity</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>z-items</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>CreatedDate</name><headertext>Created Date</headertext><width>30</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>ModifiedDate</name><headertext>Modified Date</headertext><width>30</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>Edit|Orders|Delete</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|MoveToCart|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/SavedCart/EditSavedCartItem|/SavedCart/AddProductToCartForSaveCart|/SavedCart/DeleteSavedCartTemplate</manageactionurl><manageparamfield>omsTemplateId|omsTemplateId|omsTemplateId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
WHERE ItemName='ZnodeSavedCart'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemBundle')
	DROP PROC Znode_InsertUpdateSaveCartLineItemBundle
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemBundle]
 (
	 @SaveCartLineItemType TT_SavecartLineitems READONLY  
	,@Userid  INT = 0
	,@OrderLineItemRelationshipTypeIdBundle INT
	,@OrderLineItemRelationshipTypeIdAddon INT
 )
AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 
    --Declared the variables
    DECLARE @GetDate datetime= dbo.Fn_GetDate(); 
   
	DECLARE @OmsInsertedData TABLE (OmsSavedCartLineItemId INT ) 	
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId INT,BundleProductIds VARCHAR(600) ,PersonalizeCode NVARCHAR(MAX),PersonalizeValue NVARCHAR(MAX),DesignId NVARCHAR(MAX), ThumbnailURL NVARCHAR(MAX))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.BundleProductIds
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(MAX)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(MAX)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(MAX)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(MAX)' ) AS ThumbnailURL
	FROM @SaveCartLineItemType a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col) 

	CREATE TABLE #NewBundleSavecartLineitemDetails 
	(
		GenId INT IDENTITY(1,1),RowId	INT	,OmsSavedCartLineItemId	INT	 ,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	INT
		,SKU	NVARCHAR(MAX) ,Quantity	NUMERIC(28,6)	,OrderLineItemRelationshipTypeID	INT	,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	INT	,AutoAddon	VARCHAR(MAX)	,OmsOrderId	INT	,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX),
		CustomUnitPrice NUMERIC(28,6)
	)
	
	--Getting new save cart data(bundle product)
	INSERT INTO #NewBundleSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU ,
		CustomUnitPrice
	FROM @SaveCartLineItemType a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,CustomUnitPrice
	 
	--Getting new bundle product save cart data
	INSERT INTO #NewBundleSavecartLineitemDetails 
	SELECT   Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, BundleProductIds
				,Quantity, @OrderLineItemRelationshipTypeIdBundle, CustomText, CartAddOnDetails, Sequence
				,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU,
				CustomUnitPrice
	FROM @SaveCartLineItemType  a 
	WHERE BundleProductIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, BundleProductIds
	,Quantity,  CustomText, CartAddOnDetails, Sequence ,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU,CustomUnitPrice
		
	--Getting new Bundle products save cart data if addon is present for any line item
	INSERT INTO #NewBundleSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
	,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
			WHEN  GroupProductIds <> '' THEN GroupProductIds 
			WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU , CustomUnitPrice
	FROM @SaveCartLineItemType  a 
	WHERE AddOnValueIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU,CustomUnitPrice

    CREATE TABLE #OldBundleSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old bundle save cart data if present for same SKU in the new save cart data for bundle product		 
	INSERT INTO #OldBundleSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM ZnodeOmsSavedCartLineItem a   
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.BundleProductIds,'')   )   
    AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle   

	--Getting the old save cart Parent data
	INSERT INTO #OldBundleSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b 
	INNER JOIN #OldBundleSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
	AND  b.OrderLineItemRelationshipTypeID IS NULL 

	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldBundleSavecartLineitemDetails

	DELETE a FROM #OldBundleSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldBundleSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 

	--Getting the old bundle product save cart addon data for old line items if present
	INSERT INTO #OldBundleSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b 
	INNER JOIN #OldBundleSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
	AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon	

		------Merge Addon for same product
		IF EXISTS(SELECT * FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
		BEGIN

			INSERT INTO #OldValueForAddon 
			SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
			FROM ZnodeOmsSavedCartLineItem b 
			INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
			WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
			AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
									( SELECT  ', ' + SKU FROM    
										( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
											WHERE a.ParentOmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
											FOR XML PATH('')
									), 1, 2, ''
									) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a WHERE a.ParentOmsSavedCartLineItemId is not null and OrderLineItemRelationshipTypeID<>1

		SELECT distinct a.BundleProductIds SKU, STUFF(
										( SELECT  ', ' + x.AddOnValueIds FROM    
										( SELECT DISTINCT b.AddOnValueIds FROM @SaveCartLineItemType b
											WHERE a.SKU=b.SKU ) x
											FOR XML PATH('')
										), 1, 2, ''
									) AddOns
		INTO #AddOnAdded
		FROM @SaveCartLineItemType a

		if NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
		begin
			DELETE FROM #OldBundleSavecartLineitemDetails
		end

		END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @SaveCartLineItemType ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldBundleSavecartLineitemDetails a WHERE	
	ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
	AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN 
		
		DELETE FROM #OldBundleSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
		BEGIN 

			 DECLARE @parenTofAddon INT  = 0 
			IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise)
			BEGIN
				 SET @parenTofAddon = (SELECT TOP 1 MAX(ParentOmsSavedCartLineItemId) 
				 FROM #OldBundleSavecartLineitemDetails a
				 WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
				 AND (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem  t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId AND   t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
					)
			END
			ELSE
			BEGIN
				SET @parenTofAddon = (SELECT TOP 1 ParentOmsSavedCartLineItemId
				 FROM #OldBundleSavecartLineitemDetails a
				 WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
				 AND (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem  t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId AND   t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
					)
			END
			 DELETE FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId <> @parenTofAddon  AND ParentOmsSavedCartLineItemId IS NOT NULL  

			 DELETE FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldBundleSavecartLineitemDetails m)
			 AND ParentOmsSavedCartLineItemId IS  NULL  
		 
			 IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			  BEGIN 
				DELETE FROM #OldBundleSavecartLineitemDetails
			  END 
			IF (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem   WHERE ParentOmsSavedCartLineItemId =@parenTofAddon AND   OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			BEGIN 
				DELETE FROM #OldBundleSavecartLineitemDetails
			END 

		 END 
		 ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) >= 1 
		 BEGIN 
		    DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM ZnodeOmsSavedCartLineItem a 
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
			OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		 END 
		 ELSE IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  BEGIN 
		    DELETE FROM #OldBundleSavecartLineitemDetails
		  END 
		   ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		      AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  = '' )
		 BEGIN 
		   DELETE FROM #OldBundleSavecartLineitemDetails
		 END 

	END 
	
	--Getting the personalise data for old save cart if present
	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		DELETE FROM #OldBundleSavecartLineitemDetails
	END 
	ELSE 
	BEGIN 
		 IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) <>
		     (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM ZnodeOmsSavedCartLineItem WHERE ParentOmsSavedCartLineItemId IS nULL and OmsSavedCartLineItemId in (select OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails)  )
		 BEGIN 
		   
			   DELETE FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
			   SELECT OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			   AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
			   OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			   AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		 
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) <>
		     (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM ZnodeOmsSavedCartLineItem WHERE ParentOmsSavedCartLineItemId IS nULL and OmsSavedCartLineItemId in (select OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails)  )
		 BEGIN 
		   
			   DELETE n FROM #OldBundleSavecartLineitemDetails n WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
			   OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
		
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		        AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldBundleSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
		       AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		 BEGIN 
		     DELETE FROM #OldBundleSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		 END 
		END 

	IF EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails )
	BEGIN 
		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU not having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*
			FROM @SaveCartLineItemType a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on ( a.BundleProductIds = b.SKU or a.SKU = b.sku)
			WHERE isnull(cast(a.PersonalisedAttribute AS varchar(max)),'') = ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId
			FROM #OldBundleSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
		)
		DELETE a FROM #OldBundleSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*, 
				a.PersonalizeCode
				,a.PersonalizeValue
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on ( a.BundleProductIds = b.SKU )
			WHERE isnull(a.PersonalizeValue,'') <> ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId, b.PersonalizeCode, b.PersonalizeValue
			FROM #OldBundleSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
			WHERE NOT EXISTS(SELECT * FROM cte c WHERE b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and b.PersonalizeCode = c.PersonalizeCode 
								and b.PersonalizeValue = c.PersonalizeValue )
		)
		DELETE a FROM #OldBundleSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)


		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,b.ParentOmsSavedCartLineItemId , a.BundleProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on a.BundleProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM #OldBundleSavecartLineitemDetails b1 
		WHERE NOT EXISTS(SELECT * FROM cte c WHERE (b1.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or b1.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId))
		AND EXISTS(SELECT * FROM cte)
		-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b ON a.BundleProductIds = b.SKU
			LEFT JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
			--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewBundleSavecartLineitemDetails b ON a.BundleProductIds = b.SKU
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		from CTE_OldPersonalizeCodeCount a
		inner join CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		inner join #OldBundleSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
	
		--Delete parent entry if child not present
		DELETE a FROM #OldBundleSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldBundleSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.BundleProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on a.BundleProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE c1
		FROM cte a1		  
		INNER JOIN #OldBundleSavecartLineitemDetails b1 on a1.SKU = b1.SKU
		INNER JOIN #OldBundleSavecartLineitemDetails c1 on (b1.ParentOmsSavedCartLineItemId = c1.OmsSavedCartLineItemId OR b1.OmsSavedCartLineItemId = c1.OmsSavedCartLineItemId)
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c WHERE a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and a1.PersonalizeValue = c.PersonalizeValue)

		--Updating the cart if old and new cart data matches	
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5,
		a.ModifiedDate = @GetDate,
		a.CustomUnitPrice = ty.CustomUnitPrice
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldBundleSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewBundleSavecartLineitemDetails ty ON (ty.SKU = b.SKU)
		WHERE a.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon

		 UPDATE a
		 SET a.Quantity = a.Quantity+s.AddOnQuantity,
		 a.ModifiedDate = @GetDate
		 FROM ZnodeOmsSavedCartLineItem a
		 INNER JOIN #OldBundleSavecartLineitemDetails b ON (a.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		 INNER JOIN @SaveCartLineItemType S on a.OmsSavedCartId = s.OmsSavedCartId and a.SKU = s.AddOnValueIds
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon

		 --UPDATE Ab SET ab.Quantity = a.Quantity   
   --      FROM ZnodeOmsSavedCartLineItem a  
   --      INNER JOIN ZnodeOmsSavedCartLineItem ab ON (ab.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)  
   --      INNER JOIN @SaveCartLineItemType b ON (a.OmsSavedCartId = b.OmsSavedCartId  )   
		 --WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle  

		 UPDATE Ab 
		 SET Ab.Quantity = Ab.Quantity+ty.Quantity,
		 Ab.Custom1 = ty.Custom1,
		 Ab.Custom2 = ty.Custom2,
		 Ab.Custom3 = ty.Custom3,
		 Ab.Custom4 = ty.Custom4,
		 Ab.Custom5 = ty.Custom5,
		 ab.ModifiedDate = @GetDate, 
		 ab.CustomUnitPrice = ty.CustomUnitPrice  
         FROM ZnodeOmsSavedCartLineItem a  
         INNER JOIN ZnodeOmsSavedCartLineItem ab ON (ab.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)  
         INNER JOIN @SaveCartLineItemType b ON (a.OmsSavedCartId = b.OmsSavedCartId  ) 
		 INNER JOIN #NewBundleSavecartLineitemDetails ty ON (ty.SKU = b.SKU)  
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle  
		 AND EXISTS(SELECT * FROM #OldBundleSavecartLineitemDetails ov WHERE a.OmsSavedCartLineItemId = ov.OmsSavedCartLineItemId)  

	END 
	IF NOT EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails )
	BEGIN 
			
		UPDATE #NewBundleSavecartLineitemDetails
		SET ParentSKU = (SELECT TOP 1 SKU FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID IS NULL )
		WHERE OrderLineItemRelationshipTypeID  = @OrderLineItemRelationshipTypeIdAddon 
		AND EXISTS (SELECT TOP 1 1 FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle) 
		
		--Getting the new save cart data and generating row no. for new save cart insert
		SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU ,CustomUnitPrice 
		 INTO #InsertNewBundleSavecartLineitem   
		 FROM  #NewBundleSavecartLineitemDetails  
		 GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU ,CustomUnitPrice
		 ORDER BY RowId, Id   
   
		--Removing the line item having Quantity <=0 
		DELETE FROM #InsertNewBundleSavecartLineitem WHERE Quantity <=0  

		;WITH Add_Dup AS
		(
			SELECT  Min(NewRowId)NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID 
			FROM  #InsertNewBundleSavecartLineitem
			GROUP BY SKU ,ParentSKU  ,OrderLineItemRelationshipTypeID
			HAVING OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon	
		)
		DELETE FROM #InsertNewBundleSavecartLineitem
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM Add_Dup WHERE Add_Dup.NewRowId = #InsertNewBundleSavecartLineitem.NewRowId)
		AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		--Updating the rowid INTo new save cart line item AS new line item is merged INTo existing save cart item
		 ;WITH VTTY AS   
		(  
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
			   FROM #InsertNewBundleSavecartLineitem m  
			INNER JOIN  #InsertNewBundleSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU   
			WHERE m.OrderLineItemRelationshipTypeID IN ( @OrderLineItemRelationshipTypeIdAddon , @OrderLineItemRelationshipTypeIdBundle)   
		)   
		UPDATE m1   
		SET m1.RowId = TYU.RowId  
		FROM #InsertNewBundleSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  
      
		--Deleting the new save cart line item if cart line item is merged
		;WITH VTRET AS   
		(  
			SELECT RowId,id,Min(NewRowId)NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID   
			FROM #InsertNewBundleSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU  ,OrderLineItemRelationshipTypeID  
			Having  SKU = ParentSKU  AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		)   
		DELETE FROM #InsertNewBundleSavecartLineitem WHERE NewRowId  IN (SELECT NewRowId FROM VTRET)   
     
	   --Inserting the new cart line item if not merged in existing save cart line item
       INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description,CustomUnitPrice)  
       OUTPUT INSERTED.OmsSavedCartLineItemId  INTO @OmsInsertedData 
	   SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description , CustomUnitPrice 
       FROM  #InsertNewBundleSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU 
		INTO #Cte_newData 
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
		AND a.ParentOmsSavedCartLineItemId IS nULL  
		AND  EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) 
  
		--------------------------------------------------------------------------------------------------------

		SELECT  MIN(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU  
		INTO #ParentOmsSavedCartId
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #ParentOmsSavedCartId  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon   
		AND  EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) 
		AND  a.sequence in (SELECT  MIN(ab.sequence) FROM ZnodeOmsSavedCartLineItem ab WHERE a.OmsSavedCartId = ab.OmsSavedCartId and 
		 a.SKU = ab.sku and ab.OrderLineItemRelationshipTypeId is not null  ) 

		-----------------------------------------------------------------------------------------------------

		SELECT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(Order BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #NewBuldleProduct
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( CASE WHEN EXISTS (SELECT TOP 1 1 FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle) THEN 0 ELSE 1 END = b.id OR b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c on b.sku = c.sku and b.OmsSavedCartId=c.OmsSavedCartId and b.Id = 1
		WHERE ( CASE WHEN EXISTS (SELECT TOP 1 1 FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle) THEN 0 ELSE 1 END = ISNULL(a.ParentOmsSavedCartLineItemId,0) OR ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  AND c.ParentOmsSavedCartLineItemId IS NULL
			AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewBundleSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId)  
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)

	   ;WITH table_update AS 
	   (
		 SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId  ) RowIdNo
		 FROM ZnodeOmsSavedCartLineItem a
		 WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		 AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
		 AND a.ParentOmsSavedCartLineItemId IS NULL  
		 AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewBundleSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
		 AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
	   )
		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewBuldleProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId) 
			FROM #NewBuldleProduct  r  
			WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )    IS NOT NULL 
	 
  
		;WITH Cte_Th AS   
		(             
			  SELECT RowId    
			 FROM #InsertNewBundleSavecartLineitem a   
			 GROUP BY RowId   
			 HAVING COUNT(NewRowId) <= 1   
		)   
		UPDATE a SET a.Quantity =  NULL,
			a.ModifiedDate = @GetDate   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		 AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE Ab SET ab.Quantity = a.Quantity,
			ab.ModifiedDate = @GetDate, ab.CustomUnitPrice = b.CustomUnitPrice   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN ZnodeOmsSavedCartLineItem ab ON (ab.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)  
		INNER JOIN @SaveCartLineItemType b ON (a.OmsSavedCartId = b.OmsSavedCartId  )   
		WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle  

		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewBundleSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		AND OrderLineItemRelationshipTypeId IS NOT NULL     
       
	   ;WITH Cte_UpdateSequence AS   
		 (  
		   SELECT OmsSavedCartLineItemId ,Row_Number()Over(Order By OmsSavedCartLineItemId) RowId , Sequence   
		   FROM ZnodeOmsSavedCartLineItem   
		   WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewBundleSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		 )   
		UPDATE Cte_UpdateSequence  
		SET  Sequence = RowId  
			
		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN ZnodeOmsSavedCartLineItem b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS not nULL
		and b.OmsSavedCartLineItemId = (select min(OmsSavedCartLineItemId) FROM @OmsInsertedData d WHERE b.OmsSavedCartLineItemId = d.OmsSavedCartLineItemId)
	 
		DELETE FROM ZnodeOmsPersonalizeCartItem	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
			
		----Inserting saved cart item personalise value FROM given line item
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
			   ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			   WHEN NOT MATCHED THEN 
				INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
				VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
  
		
		END 
END TRY
BEGIN CATCH 
  SELECT ERROR_MESSAGE()
END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateMoveToCartWrapper')
	DROP PROC Znode_InsertUpdateMoveToCartWrapper
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateMoveToCartWrapper]
(
	@OmsTemplateId INT, 
	@UserId INT,
	@PortalId INT,
	@Status INT  = 0 OUT
)
AS 
   /* 
    Summary: THis Procedure is USed to save AND edit the saved cart line item      
    Unit Testing 
	BEGIN tran  
    Exec Znode_InsertUpdateSaveCartLineItem @CartLineItemXML= '<ArrayOfSavedCartLineItemModel>
  <SavedCartLineItemModel>
    <OmsSavedCartLineItemId>0</OmsSavedCartLineItemId>
    <ParentOmsSavedCartLineItemId>0</ParentOmsSavedCartLineItemId>
    <OmsSavedCartId>1259</OmsSavedCartId>
    <SKU>BlueGreenYellow</SKU>
    <Quantity>1.000000</Quantity>
    <OrderLineItemRelationshipTypeId>0</OrderLineItemRelationshipTypeId>
    <Sequence>1</Sequence>
    <AddonProducts>YELLOW</AddonProducts>
    <BundleProducts />
    <ConfigurableProducts>GREEN</ConfigurableProducts>
  </SavedCartLineItemModel>
  <SavedCartLineItemModel>
    <OmsSavedCartLineItemId>0</OmsSavedCartLineItemId>
    <ParentOmsSavedCartLineItemId>0</ParentOmsSavedCartLineItemId>
    <OmsSavedCartId>1259</OmsSavedCartId>
    <SKU>ap1534</SKU>
    <Quantity>1.0</Quantity>
    <OrderLineItemRelationshipTypeId>0</OrderLineItemRelationshipTypeId>
    <Sequence>2</Sequence>
    <AddonProducts >PINK</AddonProducts>
    <BundleProducts />
    <ConfigurableProducts />
    <PersonaliseValuesList>Address~Hello</PersonaliseValuesList>
  </SavedCartLineItemModel>
</ArrayOfSavedCartLineItemModel>' , @UserId=1 ,@Status=0
	rollback tran
*/
BEGIN
BEGIN TRAN InsertUpdateSaveCartLineItem;
BEGIN TRY
SET NOCOUNT ON;
	--Declared the variables
	DECLARE @GetDate datetime= dbo.Fn_GetDate();
	DECLARE @AddOnQuantity numeric(28, 6)= 0;
	DECLARE @IsAddProduct   BIT = 0 
	DECLARE @OmsSavedCartLineItemId INT = 0
	DECLARE @CartLineItemXML XML
    DECLARE @OmsSavedCartId int
	DECLARE @OmsCookieMappingId int

	--Set the OrderLineItemRelationshipTypeId for Addons product
	DECLARE @OrderLineItemRelationshipTypeIdAddon int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'AddOns'  
	);
	--Set the OrderLineItemRelationshipTypeId for simple product
	DECLARE @OrderLineItemRelationshipTypeIdSimple int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Simple'  
	);
	--Set the OrderLineItemRelationshipTypeId for group product
	DECLARE @OrderLineItemRelationshipTypeIdGroup int=
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Group'  
	);
	--Set the OrderLineItemRelationshipTypeId for Configurable product
	DECLARE @OrderLineItemRelationshipTypeIdConfigurable int=
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Configurable'
	);
	--Set the OrderLineItemRelationshipTypeId for Bundles product	
	DECLARE @OrderLineItemRelationshipTypeIdBundle int=
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Bundles'
	);

	IF isNULL(@UserId,0) <> 0  
	BEGIN
		SET @OmsCookieMappingId = (SELECT top 1 OmsCookieMappingId FROM ZnodeOmsCookieMapping WITH (NOLOCK) WHERE isNULL(UserId,0) = @UserID AND isNULL(PortalId,0) = @PortalId)
	END

	IF NOT EXISTS(SELECT top 1 OmsCookieMappingId FROM ZnodeOmsCookieMapping WITH (NOLOCK) WHERE OmsCookieMappingId = @OmsCookieMappingId)
	BEGIN
		INSERT INTO ZnodeOmsCookieMapping (UserId,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT case when @UserId = 0 then NULL else @UserId END ,@PortalId,@UserId,@GetDate,@UserId,@GetDate

		SET @OmsCookieMappingId = @@IDENTITY
	END
	----To get the oms savecartid on basis of @OmsCookieMappingId 
	SET @OmsSavedCartId = (SELECT top 1 OmsSavedCartId FROM ZnodeOmsSavedCart WITH (NOLOCK) WHERE OmsCookieMappingId = @OmsCookieMappingId)
	
	----If omssavecartid not present in ZnodeOmsSavedCart table then inserting new record to generated omssavecartid 
	IF isNULL(@OmsSavedCartId,0) = 0
	BEGIN
		INSERT INTO ZnodeOmsSavedCart(OmsCookieMappingId,SalesTax,RecurringSalesTax,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT @OmsCookieMappingId,NULL,NULL,@UserId,@GetDate,@UserId,@GetDate

		SET @OmsSavedCartId = @@IDENTITY
	END
	

DECLARE @TBL_SavecartLineitems TABLE
	( 
		RowId int IDENTITY(1,1), OmsSavedCartLineItemId int, ParentOmsSavedCartLineItemId int, OmsSavedCartId int, SKU nvarchar(600), Quantity numeric(28, 6), OrderLineItemRelationshipTypeID int, CustomText nvarchar(max), 
		CartAddOnDetails nvarchar(max), Sequence int, AddOnValueIds varchar(max), BundleProductIds varchar(max), ConfigurableProductIds varchar(max), GroupProductIds varchar(max), PersonalisedAttribute XML, 
		AutoAddon varchar(max), OmsOrderId int, ItemDetails nvarchar(max),
		Custom1	nvarchar(max),Custom2 nvarchar(max),Custom3 nvarchar(max),Custom4
		nvarchar(max),Custom5 nvarchar(max),GroupId NVARCHAR(max) ,ProductName Nvarchar(1000) , Description NVARCHAR(max),AddOnQuantity NVARCHAR(max), CustomUnitPrice numeric(28, 6)
	);

	INSERT INTO @TBL_SavecartLineitems(OmsSavedCartLineItemId,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeID,CustomText,CartAddOnDetails,Sequence,AutoAddon,Custom1,Custom2,Custom3,Custom4
			  ,Custom5,GroupId,ProductName,Description,CustomUnitPrice)

	SELECT OmsTemplateLineItemId,@OmsSavedCartId as OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeID,CustomText,CartAddOnDetails,
			Sequence,AutoAddon,Custom1,Custom2,Custom3,Custom4
			,Custom5,GroupId,ProductName,Description,CustomUnitPrice 
	FROM ZnodeOmsTemplateLineItem WHERE OmsTemplateId = @Omstemplateid AND ParentOmsTemplateLineItemId IS NULL

	INSERT INTO @TBL_SavecartLineitems(OmsSavedCartLineItemId,ParentOmsSavedCartLineItemId,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeID,CustomText,CartAddOnDetails,
			Sequence , AutoAddon,
		
			 Custom1	,Custom2 ,Custom3,Custom4
			,Custom5 ,GroupId ,ProductName  , Description ,CustomUnitPrice )
	SELECT a.OmsTemplateLineItemId,a.ParentOmsTemplateLineItemId,@OmsSavedCartId as OmsSavedCartId,a.SKU , a.Quantity , a.OrderLineItemRelationshipTypeID , a.CustomText , a.CartAddOnDetails,
			a.Sequence , a.AutoAddon,
		
			a.Custom1	,a.Custom2 ,a.Custom3,a.Custom4
			,a.Custom5 ,a.GroupId ,a.ProductName  , a.Description ,a.CustomUnitPrice 
	FROM ZnodeOmsTemplateLineItem a
	INNER JOIN @TBL_SavecartLineitems b on a.ParentOmsTemplateLineItemId = b.OmsSavedCartLineItemId
	WHERE OmsTemplateId = @Omstemplateid AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple

	INSERT INTO @TBL_SavecartLineitems(OmsSavedCartLineItemId,ParentOmsSavedCartLineItemId,OmsSavedCartId,SKU , Quantity , OrderLineItemRelationshipTypeID , CustomText , CartAddOnDetails,
			Sequence , AutoAddon,
		
			Custom1	,Custom2 ,Custom3,Custom4
			,Custom5 ,GroupId ,ProductName  , Description ,CustomUnitPrice,BundleProductIds )
	SELECT a.OmsTemplateLineItemId,a.ParentOmsTemplateLineItemId,@OmsSavedCartId as OmsSavedCartId,b.SKU , a.Quantity , a.OrderLineItemRelationshipTypeID , a.CustomText , a.CartAddOnDetails,
			a.Sequence , a.AutoAddon,
		
			a.Custom1	,a.Custom2 ,a.Custom3,a.Custom4
			,a.Custom5 ,a.GroupId ,a.ProductName  , a.Description ,a.CustomUnitPrice, c.Item
	FROM ZnodeOmsTemplateLineItem a
	INNER JOIN @TBL_SavecartLineitems b on a.ParentOmsTemplateLineItemId = b.OmsSavedCartLineItemId
	cross apply dbo.split(a.sku,',')c 
	WHERE OmsTemplateId = @Omstemplateid AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle

	INSERT INTO @TBL_SavecartLineitems(OmsSavedCartLineItemId,ParentOmsSavedCartLineItemId,OmsSavedCartId,SKU , Quantity , OrderLineItemRelationshipTypeID , CustomText , CartAddOnDetails,
			Sequence , AutoAddon,
		
			Custom1	,Custom2 ,Custom3,Custom4
			,Custom5 ,GroupId ,ProductName  , Description ,CustomUnitPrice,ConfigurableProductIds )
	SELECT a.OmsTemplateLineItemId,a.ParentOmsTemplateLineItemId,@OmsSavedCartId as OmsSavedCartId,b.SKU , a.Quantity , a.OrderLineItemRelationshipTypeID , a.CustomText , a.CartAddOnDetails,
			a.Sequence , a.AutoAddon,
		
			a.Custom1	,a.Custom2 ,a.Custom3,a.Custom4
			,a.Custom5 ,a.GroupId ,a.ProductName  , a.Description ,a.CustomUnitPrice, a.SKU
	FROM ZnodeOmsTemplateLineItem a
	INNER JOIN @TBL_SavecartLineitems b on a.ParentOmsTemplateLineItemId = b.OmsSavedCartLineItemId
	WHERE OmsTemplateId = @Omstemplateid AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable

	INSERT INTO @TBL_SavecartLineitems(OmsSavedCartLineItemId,ParentOmsSavedCartLineItemId,OmsSavedCartId,SKU , Quantity , OrderLineItemRelationshipTypeID , CustomText , CartAddOnDetails,
			Sequence , AutoAddon,
		
			Custom1	,Custom2 ,Custom3,Custom4
			,Custom5 ,GroupId ,ProductName  , Description ,CustomUnitPrice,GroupProductIds )
	SELECT a.OmsTemplateLineItemId,a.ParentOmsTemplateLineItemId,@OmsSavedCartId as OmsSavedCartId,b.SKU , a.Quantity , a.OrderLineItemRelationshipTypeID , a.CustomText , a.CartAddOnDetails,
			a.Sequence , a.AutoAddon,
		
			a.Custom1	,a.Custom2 ,a.Custom3,a.Custom4
			,a.Custom5 ,a.GroupId ,a.ProductName  , a.Description ,a.CustomUnitPrice, a.SKU
	FROM ZnodeOmsTemplateLineItem a
	INNER JOIN @TBL_SavecartLineitems b on a.ParentOmsTemplateLineItemId = b.OmsSavedCartLineItemId
	WHERE OmsTemplateId = @Omstemplateid AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup

	update a set a.OrderLineItemRelationshipTypeID = b.OrderLineItemRelationshipTypeID from @TBL_SavecartLineitems a
	inner join @TBL_SavecartLineitems b on a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId
	where a.OrderLineItemRelationshipTypeID is null and a.ParentOmsSavedCartLineItemId is null and b.OrderLineItemRelationshipTypeID is not null


	INSERT INTO @TBL_SavecartLineitems(OmsSavedCartLineItemId,ParentOmsSavedCartLineItemId,OmsSavedCartId,SKU , Quantity , OrderLineItemRelationshipTypeID , CustomText , CartAddOnDetails,
			Sequence , AutoAddon,
		
			Custom1	,Custom2 ,Custom3,Custom4
			,Custom5 ,GroupId ,ProductName  , Description ,CustomUnitPrice,AddOnValueIds ,AddOnQuantity,ConfigurableProductIds,BundleProductIds,GroupProductIds)
	SELECT a.OmsTemplateLineItemId,a.ParentOmsTemplateLineItemId, @OmsSavedCartId as OmsSavedCartId,B.SKU , a.Quantity , a.OrderLineItemRelationshipTypeID , a.CustomText , a.CartAddOnDetails,
			a.Sequence , a.AutoAddon,
		
			a.Custom1	,a.Custom2 ,a.Custom3,a.Custom4
			,a.Custom5 ,a.GroupId ,a.ProductName  , a.Description ,a.CustomUnitPrice, a.SKU,a.Quantity,ConfigurableProductIds,BundleProductIds,GroupProductIds
	FROM ZnodeOmsTemplateLineItem a
	INNER JOIN @TBL_SavecartLineitems b on a.ParentOmsTemplateLineItemId = b.OmsSavedCartLineItemId
	WHERE OmsTemplateId = @Omstemplateid AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND B.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdBundle

	INSERT INTO @TBL_SavecartLineitems(OmsSavedCartLineItemId,ParentOmsSavedCartLineItemId,OmsSavedCartId,SKU , Quantity , OrderLineItemRelationshipTypeID , CustomText , CartAddOnDetails,
			Sequence , AutoAddon,
		
			Custom1	,Custom2 ,Custom3,Custom4
			,Custom5 ,GroupId ,ProductName  , Description ,CustomUnitPrice,AddOnValueIds ,AddOnQuantity,ConfigurableProductIds,BundleProductIds,GroupProductIds)
	SELECT a.OmsTemplateLineItemId,a.ParentOmsTemplateLineItemId, @OmsSavedCartId as OmsSavedCartId,B.SKU , a.Quantity , a.OrderLineItemRelationshipTypeID , a.CustomText , a.CartAddOnDetails,
			a.Sequence , a.AutoAddon,
		
			a.Custom1	,a.Custom2 ,a.Custom3,a.Custom4
			,a.Custom5 ,a.GroupId ,a.ProductName  , a.Description ,a.CustomUnitPrice, a.SKU,a.Quantity,ConfigurableProductIds,BundleProductIds,GroupProductIds
	FROM ZnodeOmsTemplateLineItem a
	INNER JOIN @TBL_SavecartLineitems b on a.ParentOmsTemplateLineItemId = b.ParentOmsSavedCartLineItemId
	WHERE OmsTemplateId = @Omstemplateid AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND B.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle

	--update personalize text
	SELECT  OmsTemplateLineItemId,'<PersonaliseValueModel> <PersonalizeCode>'+isnull(ltrim(rtrim(PersonalizeCode)),'')+'</PersonalizeCode><PersonalizeValue>'+isnull(ltrim(rtrim(PersonalizeValue)),'')
	+'</PersonalizeValue><DesignId>'+isnull(DesignId,'')+'</DesignId><ThumbnailURL>'+isnull(ThumbnailURL,'')+'</ThumbnailURL><PersonalizeName>'
	+isnull(PersonalizeName,'')+'</PersonalizeName><OmsSavedCartLineItemId>0</OmsSavedCartLineItemId></PersonaliseValueModel>' 
	AS PersonalisedAttribute
	INTO #PersonalisedData
	FROM ZnodeOmsTemplatePersonalizeCartItem WHERE OmsTemplateLineItemId IN (
	SELECT OmsTemplateLineItemId FROM ZnodeOmsTemplateLineItem  WHERE OmsTemplateId =@Omstemplateid )

	
	SELECT  OmsTemplateLineItemId, STUFF((SELECT  ',' + PersonalisedAttribute 
	FROM #PersonalisedData B WHERE A.OmsTemplateLineItemId=B.OmsTemplateLineItemId
	FOR XML PATH ('')
	), 1, 1, '')  AS PersonalisedAttribute
	into #MergePersonalizeData
	FROM #PersonalisedData A
	GROUP BY OmsTemplateLineItemId
	

	update #MergePersonalizeData set PersonalisedAttribute = replace(replace(PersonalisedAttribute,'&lt;','<'),'&gt;','>') where PersonalisedAttribute is not null

	Update B set PersonalisedAttribute=A.PersonalisedAttribute
	from #MergePersonalizeData A 
	inner join @TBL_SavecartLineitems B on (A.OmsTemplateLineItemId=B.OmsSavedCartLineItemId )

	--Updating personalize xml string in parent product for simple product
	UPDATE A SET PersonalisedAttribute = B.PersonalisedAttribute
	FROM @TBL_SavecartLineitems A
	INNER JOIN @TBL_SavecartLineitems B ON A.OmsSavedCartLineItemId = B.ParentOmsSavedCartLineItemId 
	AND B.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple
	
	--Updating personalize xml string in parent product for group and configurable product
	UPDATE A SET PersonalisedAttribute = B.PersonalisedAttribute
	FROM @TBL_SavecartLineitems A
	INNER JOIN @TBL_SavecartLineitems B ON A.ParentOmsSavedCartLineItemId = B.OmsSavedCartLineItemId 
	AND B.OrderLineItemRelationshipTypeID in ( @OrderLineItemRelationshipTypeIdGroup, @OrderLineItemRelationshipTypeIdConfigurable) and a.PersonalisedAttribute is null

	--Inserting the personalise data into variable table @TBL_Personalise for inserting the personalise data for new products
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId int,SKU Varchar(600) ,PersonalizeCode NVARCHAr(max),PersonalizeValue NVARCHAr(max),DesignId NVARCHAr(max), ThumbnailURL NVARCHAr(max))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.SKU
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(Max)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(Max)' ) AS ThumbnailURL
	FROM @TBL_SavecartLineitems a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col) 
	where a.ParentOmsSavedCartLineItemId is not null

	DELETE FROM @TBL_SavecartLineitems 
	WHERE OmsSavedCartLineItemId in (SELECT ParentOmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE OrderLineItemRelationshipTypeID 
	IN (@OrderLineItemRelationshipTypeIdBundle,@OrderLineItemRelationshipTypeIdConfigurable,@OrderLineItemRelationshipTypeIdGroup,@OrderLineItemRelationshipTypeIdSimple) AND ParentOmsSavedCartLineItemId IS NOT NULL)

	--Removed the save cart product to add in the cart which are not associated with the catalog
	DELETE A FROM @TBL_SavecartLineitems A
	WHERE NOT EXISTS(SELECT TOP 1 1 FROM ZnodePublishProductEntity B WHERE A.SKU = B.SKU AND ISNULL(B.ZnodeCategoryIds,0) <> 0)

	UPDATE @TBL_SavecartLineitems SET OmsSavedCartLineItemId = 0 ,ParentOmsSavedCartLineItemId = 0 where OrderLineItemRelationshipTypeID is null
	UPDATE @TBL_SavecartLineitems SET OmsSavedCartLineItemId = 0 ,ParentOmsSavedCartLineItemId = 0 
	where OrderLineItemRelationshipTypeID NOT IN (@OrderLineItemRelationshipTypeIdBundle,@OrderLineItemRelationshipTypeIdConfigurable,@OrderLineItemRelationshipTypeIdGroup)
	UPDATE @TBL_SavecartLineitems SET OmsSavedCartLineItemId = 0 ,ParentOmsSavedCartLineItemId = 0,OrderLineItemRelationshipTypeID=null,Sequence = null 
	where OrderLineItemRelationshipTypeID in (@OrderLineItemRelationshipTypeIdBundle,@OrderLineItemRelationshipTypeIdConfigurable,@OrderLineItemRelationshipTypeIdGroup)

	delete a from @TBL_SavecartLineitems a where A.AddOnValueIds IS NULL
	and exists(select * from @TBL_SavecartLineitems b where b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon and  isnull(a.ConfigurableProductIds,'') = isnull(b.ConfigurableProductIds,'')
	and isnull(a.BundleProductIds,'') = isnull(b.BundleProductIds,'') and isnull(a.GroupProductIds,'') = isnull(b.GroupProductIds,'') and isnull(a.SKU,'') = isnull(b.SKU,'')
	)

	update @TBL_SavecartLineitems set OrderLineItemRelationshipTypeID = null,Sequence = NULL

	--Save cart execution code for bundle product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' )
	BEGIN 				
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
		BEGIN 
			SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0 )

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0)
			, ModifiedDate = @GetDate, CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SavecartLineitems)
			WHERE ( OmsSavedCartLineItemId = @OmsSavedCartLineItemId  
			OR ParentOmsSavedCartLineItemId =  @OmsSavedCartLineItemId   ) 

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = AddOnQuantity, ModifiedDate = @GetDate,CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SavecartLineitems)
			FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
			INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
			WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
			AND SCLI.BundleProductIds <> ''

			--After update the existing cart with new save cart then deleting those records which are updated
			DELETE	FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0
		END 

		--Getting bundle save cart line item entries into table to pass for bundle prodcut sp
		DECLARE @TBL_bundleProduct TT_SavecartLineitems 
		INSERT INTO @TBL_bundleProduct 
		SELECT *  
		FROM @TBL_SavecartLineitems 
		WHERE ISNULL(BundleProductIds,'') <> '' 
				
		EXEC Znode_InsertUpdateSaveCartLineItemBundle @TBL_bundleProduct,@userId,@OrderLineItemRelationshipTypeIdBundle,@OrderLineItemRelationshipTypeIdAddon
				 
		DELETE FROM  @TBL_SavecartLineitems WHERE ISNULL(BundleProductIds,'') <> '' 
		SET @OmsSavedCartLineItemId = 0 
	END 
	--Save cart execution code for configurable product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' )
	BEGIN 				
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
		BEGIN 

			SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0 )
				 
			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
			, ModifiedDate = @GetDate,CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SavecartLineitems)
			WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = AddOnQuantity, ModifiedDate = @GetDate, CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SavecartLineitems)
			FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
			INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
			WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
			AND SCLI.ConfigurableProductIds <> ''

			--After update the existing cart with new save cart then deleting those records which are updated
			DELETE	FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0
		END 
		--Getting bundle save cart line item entries into table to pass for configurable prodcut sp
		DECLARE @TBL_Configurable TT_SavecartLineitems 
		INSERT INTO @TBL_Configurable 
		SELECT *  
		FROM @TBL_SavecartLineitems 
		WHERE ISNULL(ConfigurableProductIds,'') <> '' 

		EXEC Znode_InsertUpdateSaveCartLineItemConfigurable @TBL_Configurable,@userId,@OrderLineItemRelationshipTypeIdConfigurable,@OrderLineItemRelationshipTypeIdAddon
	  
		DELETE FROM @TBL_SavecartLineitems 
		WHERE ISNULL(ConfigurableProductIds,'') <> ''
		SET @OmsSavedCartLineItemId = 0  
	END 
	--Save cart execution code for group product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' )
	BEGIN 				
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
		BEGIN 
			--Updating the existing save cart for group product
			SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0 )
			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId = @OmsSavedCartLineItemId ), CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SavecartLineitems)
			WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = AddOnQuantity, ModifiedDate = @GetDate, CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SavecartLineitems)
			FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
			INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
			WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
			AND SCLI.GroupProductIds <> ''

			--After update the existing cart with new save cart then deleting those records which are updated
			DELETE	FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0
		END 
		--Getting bundle save cart line item entries into table to pass for group prodcut sp
		DECLARE @TBL_Group TT_SavecartLineitems 
		INSERT INTO @TBL_Group 
		SELECT *  
		FROM @TBL_SavecartLineitems 
		WHERE ISNULL(GroupProductIds,'') <> '' 

		EXEC Znode_InsertUpdateSaveCartLineItemGroup @TBL_Group,@userId,@OrderLineItemRelationshipTypeIdGroup,@OrderLineItemRelationshipTypeIdAddon
		
		--After update the existing cart with new save cart then deleting those records which are updated
		DELETE FROM @TBL_SavecartLineitems WHERE ISNULL(GroupProductIds,'') <> ''
		SET @OmsSavedCartLineItemId = 0  
	END 
	
	--This part is for updating the cart for existing line items for simple product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId <> 0  ) 
	BEGIN 
				 
		SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId <> 0 )
		UPDATE ZnodeOmsSavedCartLineItem 
		SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
		, ModifiedDate = @GetDate , CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SavecartLineitems)
		WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId

		DECLARE @ParentOmsSavedCartLineItemId INT = 0
		SET @ParentOmsSavedCartLineItemId = (select ParentOmsSavedCartLineItemId from ZnodeOmsSavedCartLineItem WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId)

		UPDATE ZnodeOmsSavedCartLineItem 
		SET  CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SavecartLineitems)
		WHERE OmsSavedCartLineItemId = @ParentOmsSavedCartLineItemId

		UPDATE ZnodeOmsSavedCartLineItem 
		SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
		INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = @OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
		WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					
		DELETE	FROM @TBL_SavecartLineitems WHERE OmsSavedCartLineItemId <> 0
	END 
	--Save cart execution code for Simple product
	DECLARE @OmsInsertedData TABLE (OmsSavedCartLineItemId INT )
				
	CREATE TABLE #NewSavecartLineitemDetails 
	(
		GenId INT IDENTITY(1,1),RowId	INT	,OmsSavedCartLineItemId	INT	 ,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	INT
		,SKU	NVARCHAR(MAX) ,Quantity	NUMERIC(28,6)	,OrderLineItemRelationshipTypeID	INT	,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	int	,AutoAddon	varchar(MAX)	,OmsOrderId	INT	,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX)
	)
	
	--Getting new save cart data
	INSERT INTO #NewSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU 
	FROM @TBL_SavecartLineitems a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
		
	--Getting new simple product save cart data
	INSERT INTO #NewSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, @OrderLineItemRelationshipTypeIdSimple, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU 
	FROM @TBL_SavecartLineitems  a 
	WHERE ISNULL(BundleProductIds,'') =  '' 
	AND  ISNULL(GroupProductIds,'') = ''	AND ISNULL(	ConfigurableProductIds,'') = ''
		GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity,  CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
	
	--Getting new Group,Bundle and Configurable products save cart data if addon is present for any line item
	INSERT INTO #NewSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
		,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
		WHEN  GroupProductIds <> '' THEN GroupProductIds 
		WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU 
	FROM @TBL_SavecartLineitems  a 
	WHERE AddOnValueIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU

	CREATE TABLE #OldSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old save cart data if present for same SKU in the new save cart data for simple product	 
	INSERT INTO #OldSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM ZnodeOmsSavedCartLineItem a with (nolock)  
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.SKU,'')   )   
	AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple   

	--Getting the old save cart Parent data 
	INSERT INTO #OldSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
	AND  b.OrderLineItemRelationshipTypeID IS NULL 
		 
	DELETE a FROM #OldSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 
		
	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldSavecartLineitemDetails
		
	--Getting the old save cart addon data for old line items if present
	INSERT INTO #OldSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
	AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

	------Merge Addon for same product
	IF EXISTS(SELECT * FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'') <> '' )
	BEGIN

		INSERT INTO #OldValueForAddon 
		SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
		FROM ZnodeOmsSavedCartLineItem b with (nolock)
		INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
								( SELECT  ', ' + SKU FROM    
									( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
										where a.OmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
										FOR XML PATH('')
								), 1, 2, ''
								) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a where a.ParentOmsSavedCartLineItemId is not null and OrderLineItemRelationshipTypeID<>1

		SELECT distinct a.SKU, STUFF(
									( SELECT  ', ' + x.AddOnValueIds FROM    
									( SELECT DISTINCT b.AddOnValueIds FROM @TBL_SavecartLineitems b
										where a.SKU=b.SKU ) x
										FOR XML PATH('')
									), 1, 2, ''
								) AddOns
		INTO #AddOnAdded
		FROM @TBL_SavecartLineitems a

		IF NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
		BEGIN
			DELETE FROM #OldSavecartLineitemDetails
		END

	END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_SavecartLineitems ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldSavecartLineitemDetails a WHERE	
	ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN 
		
		DELETE FROM #OldSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
	    
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  <> '' )
		BEGIN 
		 
			DECLARE @parenTofAddon  TABLE( ParentOmsSavedCartLineItemId INT  )  
			INSERT INTO  @parenTofAddon 
			SELECT  ParentOmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  

			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ParentOmsSavedCartLineItemId FROM  @parenTofAddon)   
				AND ParentOmsSavedCartLineItemId IS NOT NULL  
				AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldSavecartLineitemDetails m)
			AND ParentOmsSavedCartLineItemId IS  NULL  
		 
		END 
		ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		BEGIN 

			DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple  )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
			OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		    
			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldSavecartLineitemDetails m)
			AND ParentOmsSavedCartLineItemId IS  NULL  

		END
		ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  = '' )
		BEGIN 

			DELETE FROM #OldSavecartLineitemDetails
		END 
	END 

	--Getting the personalise data for old save cart if present
	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)

	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		DELETE FROM #OldSavecartLineitemDetails
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 
		   
			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
			SELECT OmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
			OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		      
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 

			DELETE n FROM #OldSavecartLineitemDetails n WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
			OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
	   
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		BEGIN 
			DELETE FROM #OldSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		END 
	  
	END 
	
	--If already exists cart 
	IF EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails )
	BEGIN

		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU not having personalise value for new cart item
		;WITH cte AS
		(
			SELECT distinct b.*
			FROM @TBL_SavecartLineitems a 
			INNER JOIN #OldSavecartLineitemDetails b on ( a.SKU = b.sku)
			where isnull(cast(a.PersonalisedAttribute AS varchar(max)),'') = '' and a.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		)
		,cte2 AS
		(
			SELECT c.ParentOmsSavedCartLineItemId
			FROM #OldSavecartLineitemDetails a
			INNER JOIN ZnodeOmsSavedCartLineItem c on a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		)
		DELETE a FROM #OldSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU having personalise value for new cart item
		;WITH cte AS
		(
			SELECT distinct b.*, 
				a.PersonalizeCode
				,a.PersonalizeValue
			FROM @TBL_Personalise a 
			INNER JOIN #OldSavecartLineitemDetails b on ( a.SKU = b.sku)
			where a.PersonalizeValue <> ''
		)
		,cte2 AS
		(
			SELECT a.ParentOmsSavedCartLineItemId, b.PersonalizeCode, b.PersonalizeValue
			FROM #OldSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
			WHERE NOT EXISTS(SELECT * FROM cte c where b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and b.PersonalizeCode = c.PersonalizeCode 
						and b.PersonalizeValue = c.PersonalizeValue )
		)
		DELETE a FROM #OldSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,b.ParentOmsSavedCartLineItemId , a.SKU AS SKU
				,a.PersonalizeCode
				,a.PersonalizeValue
				,a.DesignId
				,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldSavecartLineitemDetails b on a.SKU = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM #OldSavecartLineitemDetails b1 
		WHERE NOT EXISTS(SELECT * FROM cte c where (b1.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or b1.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId))
		AND EXISTS(SELECT * FROM cte)

		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
	-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldSavecartLineitemDetails b ON a.SKU = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
			--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewSavecartLineitemDetails  b ON a.SKU = b.SKU
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0 AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		from CTE_OldPersonalizeCodeCount a
		inner join CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		inner join #OldSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		
		--Delete parent entry if child not present
		DELETE a FROM #OldSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

	--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
	--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
	
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.SKU
						,d.PersonalizeCode
				,d.PersonalizeValue
				,d.DesignId
				,d.ThumbnailURL
				FROM @TBL_SavecartLineitems a 
				INNER JOIN #OldSavecartLineitemDetails b on a.SKU = b.SKU
				INNER JOIN @TBL_Personalise d on d.SKU = a.SKU
				INNER JOIN ZnodeOmsPersonalizeCartItem  c  with (nolock)  on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
				WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM cte a1		  
		INNER JOIN #OldSavecartLineitemDetails b1 on a1.sku = b1.SKU
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c where a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and a1.PersonalizeValue = c.PersonalizeValue)

		--Updating the cart if old and new cart data matches 
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5, 
		a.ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewSavecartLineitemDetails ty ON (ty.SKU = b.SKU)

	END 
	
	--Inserting the new save cart data if old and new cart data not match
	IF NOT EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails )
	BEGIN 
	    --Getting the new save cart data and generating row no. for new save cart insert
		SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU  
		INTO #InsertNewSavecartLineitem   
		FROM  #NewSavecartLineitemDetails  
		GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails ,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU   
		ORDER BY RowId, Id   
       	
		--Removing the line item having Quantity <=0	     
		DELETE FROM #InsertNewSavecartLineitem WHERE Quantity <=0  
  
		--Updating the rowid into new save cart line item as new line item is merged into existing save cart item
		;WITH VTTY AS   
		(  
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
			FROM #InsertNewSavecartLineitem m  
			INNER JOIN  #InsertNewSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU   
			WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon   
		)   
		UPDATE m1   
		SET m1.RowId = TYU.RowId  
		FROM #InsertNewSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  
        
		--Deleting the new save cart line item if cart line item is merged
		;WITH VTRET AS   
		(  
			SELECT RowId,id,Min(NewRowId) NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID  
			FROM #InsertNewSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID
			Having  SKU = ParentSKU  AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdSimple
		)   
		DELETE FROM #InsertNewSavecartLineitem WHERE NewRowId IN (SELECT NewRowId FROM VTRET)  

		--Inserting the new cart line item if not merged in existing save cart line item
		INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description)  
		OUTPUT INSERTED.OmsSavedCartLineItemId  INTO @OmsInsertedData 
		SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description   
		FROM  #InsertNewSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU  
		INTO #ParentOmsSavedCartId
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		AND CASE WHEN EXISTS (SELECT TOP 1 1 FROM #InsertNewSavecartLineitem TU WHERE TU.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple)  THEN ISNULL(a.OrderLineItemRelationshipTypeID,0) ELSE 0 END = 0 
		GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #ParentOmsSavedCartId  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
		AND a.ParentOmsSavedCartLineItemId IS nULL   

		SELECT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(Order BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #NewSimpleProduct
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c on b.sku = c.sku and b.OmsSavedCartId=c.OmsSavedCartId and b.Id = 1 
		WHERE ( ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  and c.ParentOmsSavedCartLineItemId is null

		--Updating ParentOmsSavedCartLineItemId for newly added save cart line item
		;WITH table_update AS 
		(
			SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId  ) RowIdNo
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
			AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
			AND a.ParentOmsSavedCartLineItemId IS NULL  
			AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
			AND EXISTS (SELECT TOP 1 1 FROM #NewSimpleProduct TI WHERE TI.SKU = a.SKU)
		)
		UPDATE a SET  
		a.ParentOmsSavedCartLineItemId =(SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewSimpleProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewSimpleProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU   GROUP BY r.ParentSKU, r.SKU  )    IS NOT NULL 
	 
		;WITH Cte_Th AS   
		(             
			SELECT RowId    
			FROM #InsertNewSavecartLineitem a   
			GROUP BY RowId   
			HAVING COUNT(NewRowId) <= 1   
		)   
		UPDATE a SET a.Quantity =  NULL , a.ModifiedDate = @GetDate  
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		AND OrderLineItemRelationshipTypeId IS NOT NULL     

		;WITH Cte_UpdateSequence AS   
		(  
			SELECT OmsSavedCartLineItemId ,Row_Number()Over(Order By OmsSavedCartLineItemId) RowId , Sequence   
			FROM ZnodeOmsSavedCartLineItem with (nolock)  
			WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		)   
		UPDATE Cte_UpdateSequence  
		SET  Sequence = RowId  
	
		------To update saved cart item personalise value FROM given line item	
		--IF EXISTS(SELECT * FROM @TBL_Personalise1 where isnull(PersonalizeValue,'') <> '' and isnull(OmsSavedCartLineItemId,0) <> 0)
		--BEGIN
		--	DELETE FROM ZnodeOmsPersonalizeCartItem 
		--	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise1 yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )

		--	MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		--	USING @TBL_Personalise1 SOURCE
		--	ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
		--	WHEN NOT MATCHED THEN 
		--	INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
		--					,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
		--	VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
		--					,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
		--END		
	
		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN ZnodeOmsSavedCartLineItem b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS NOT NULL 
	
		DELETE FROM ZnodeOmsPersonalizeCartItem 
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
						
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
		ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
		WHEN NOT MATCHED THEN 
		INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
					,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
		VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
					,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
  
		
		 
	END 

	--Declare @OutputTable Table (CartCount numeric(28,6))

	--INSERT INTO @OutputTable
	--EXEC [Znode_GetOmsSavedCartLineItemCount] @OmsCookieMappingId = @OmsCookieMappingId,@UserId=@UserId,@PortalId=@UserId
	

	--SELECT CAST(1 AS bit) AS Status,@OmsSavedCartId AS SavedCartId,@OmsCookieMappingId AS CookieMappingId,CartCount
	--FROM @OutputTable

	SELECT @Status = 1
	SELECT cast( 1 as int )as Id, Cast(@Status as bit) Status;
COMMIT TRAN InsertUpdateSaveCartLineItem;
END TRY
BEGIN CATCH
SELECT @Status = 0
	SELECT ERROR_MESSAGE()	
	DECLARE @Error_procedure varchar(1000)= ERROR_PROCEDURE(), @ErrorMessage nvarchar(max)= ERROR_MESSAGE(), @ErrorLine varchar(100)= ERROR_LINE(), @ErrorCall nvarchar(max)= 'EXEC Znode_InsertUpdateSaveCartLineItem @CartLineItemXML = '+CAST(@CartLineItemXML
	AS varchar(max))+',@UserId = '+CAST(@UserId AS varchar(50))+',@PortalId='+CAST(@PortalId AS varchar(10))+',@OmsCookieMappingId='+CAST(@OmsCookieMappingId AS varchar(10));

	SELECT cast( 0 as int ) Id, Cast(@Status as bit) Status;
	ROLLBACK TRAN InsertUpdateSaveCartLineItem;
	EXEC Znode_InsertProcedureErrorLog @ProcedureName = 'Znode_InsertUpdateSaveCartLineItemQuantityWrapper', @ErrorInProcedure = @Error_procedure, @ErrorMessage = @ErrorMessage, @ErrorLine = @ErrorLine, @ErrorCall = @ErrorCall;
END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPaymentSettingByUserDetails')
	DROP PROC Znode_GetPaymentSettingByUserDetails
GO

CREATE PROCEDURE [dbo].[Znode_GetPaymentSettingByUserDetails]
(
	@PortalId	INT,
	@UserId		INT,
	@RowsCount  INT OUT
)
AS
/*
	Summary: This Procedure is used to get payment details according to associated profile or portal.

	Unit Testing:

	EXEC [Znode_GetPaymentSettingByUserDetails] @PortalId=1, @UserId=1, @RowsCount=0
*/	
BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
		DECLARE @GuestProfileId INT;

		SELECT TOP 1 @GuestProfileId=ProfileId FROM ZnodeProfile WHERE ProfileName = 'Anonymous' AND @UserId = -1;

		IF OBJECT_ID('tempdb..#ZnodePortalPaymentApprovers') IS NOT NULL
			DROP TABLE #ZnodePortalPaymentApprovers
		--Getting the payment portal approver details
		SELECT PaymentSettingId ,ZPPG.PortalPaymentGroupId,ZPA.PortalId 
		INTO #ZnodePortalPaymentApprovers
		FROM ZnodePortalPaymentApprovers ZPPA 
		INNER JOIN [ZnodePortalPaymentGroup] ZPPG ON( ZPPA.PortalPaymentGroupId = ZPPG.PortalPaymentGroupId)
		INNER JOIN [ZnodePortalApproval] ZPA ON (ZPA.PortalApprovalId = ZPPG.PortalApprovalId) 
		WHERE ZPA.EnableApprovalManagement =1 AND ZPA.PortalId = @PortalId AND ZPPG.isActive = 1;
	
		--When any User Profile is associated with the user account
		--OR When User is associated with single Profile.
		--OR When two or more User Profiles are associated with the user account
		IF (EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP 
					INNER JOIN ZnodePortalProfile ZPP ON ZUP.ProfileId=ZPP.ProfileId
					INNER JOIN ZnodeProfilePaymentSetting ZPS ON ZUP.ProfileId=ZPS.ProfileId
					INNER JOIN ZnodePortalPaymentSetting ZPS1 ON ZPP.PortalId=ZPS1.PortalId AND ZPS.PaymentSettingId=ZPS1.PaymentSettingId
					WHERE ZUP.UserId=@UserId AND ZPP.PortalId=@PortalId AND ZPS1.IsUsedForOfflinePayment=0)

			OR EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP 
					INNER JOIN ZnodePortalProfile ZPP ON ZUP.ProfileId=ZPP.ProfileId
					INNER JOIN ZnodeProfilePaymentSetting ZPS ON ZUP.ProfileId=ZPS.ProfileId
					INNER JOIN ZnodePortalPaymentSetting ZPS1 ON ZPP.PortalId=ZPS1.PortalId AND ZPS.PaymentSettingId=ZPS1.PaymentSettingId
					WHERE ZUP.ProfileId=@GuestProfileId AND ZPP.PortalId=@PortalId AND ZPS1.IsUsedForOfflinePayment=0)
			)
		BEGIN
			IF EXISTS (	SELECT TOP 1 1 
						FROM ZnodePaymentSetting ZPS
						INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
						LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
						INNER JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId )
						INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
						INNER JOIN ZnodeProfile ZP ON ZP.ProfileId = YOPU.ProfileId
						INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
						WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1 AND
							(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId AND YOPU.ProfileId = ZUP.ProfileId AND ZPPS.IsUsedForOfflinePayment=0)
							OR EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE @UserId = -1 AND ZUP.ProfileId = @GuestProfileId AND ZPPS.IsUsedForOfflinePayment=0)))
			BEGIN
				SELECT DISTINCT ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,
					ZPS.IsActive,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,
					ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate,ZPPS.PortalId,ZP1.StoreName, 
					NULL IsAssociated ,NULL As ProfileId,NULL As ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName,
						CASE WHEN @PortalId > 0 AND ZPPS.PaymentDisplayName IS NOT NULL
							THEN ZPPS.PaymentDisplayName ELSE ZPS.PaymentDisplayName END PaymentDisplayName, 
					NULL PaymentExternalId, CAST(CASE WHEN YU.PaymentSettingId IS NOT NULL THEN 1 ELSE 0 END As BIT) AS IsApprovalRequired,
					ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,
					YU.PortalPaymentGroupId,'' AS PublishState
				FROM ZnodePaymentSetting ZPS
				INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				INNER JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId )
				INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
				INNER JOIN ZnodeProfile ZP ON ZP.ProfileId = YOPU.ProfileId
				INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
				LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId) 
				WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1 AND
					(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId AND YOPU.ProfileId = ZUP.ProfileId AND ZPPS.IsUsedForOfflinePayment=0)
					OR EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE @UserId = -1 AND ZUP.ProfileId = @GuestProfileId AND ZPPS.IsUsedForOfflinePayment=0));

				SET @RowsCount=@@ROWCOUNT;
			END
			ELSE
			BEGIN
				SELECT DISTINCT ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,
					ZPS.IsActive,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,
					ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate,ZPPS.PortalId,ZP1.StoreName, 
					NULL IsAssociated ,NULL As ProfileId,NULL As ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName,
						CASE WHEN @PortalId > 0 AND ZPPS.PaymentDisplayName IS NOT NULL
							THEN ZPPS.PaymentDisplayName ELSE ZPS.PaymentDisplayName END PaymentDisplayName, 
					NULL PaymentExternalId, CAST(CASE WHEN YU.PaymentSettingId IS NOT NULL THEN 1 ELSE 0 END As BIT) AS IsApprovalRequired,
					ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,
					YU.PortalPaymentGroupId,'' AS PublishState
				FROM ZnodePaymentSetting ZPS
				INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				LEFT JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId )
				INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
				LEFT JOIN ZnodeProfile ZP ON ZP.ProfileId = YOPU.ProfileId
				INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
				LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
				WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1 AND
					(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId AND ZPPS.IsUsedForOfflinePayment=0)
					OR EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE @UserId = -1 AND ZUP.ProfileId = @GuestProfileId AND ZPPS.IsUsedForOfflinePayment=0));

				SET @RowsCount=@@ROWCOUNT;
			END
		END
		--When User is associated with Profile but this Profile is not associated with any portal.
		ELSE IF EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE ((ZUP.UserId = @UserId AND ZUP.ProfileId IS NOT NULL) OR (@UserId = -1 AND ZUP.ProfileId = @GuestProfileId))
							AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalProfile WHERE ProfileId=ZUP.ProfileId AND PortalId=@PortalId))
		BEGIN
			SELECT DISTINCT ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,
				ZPS.IsActive,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,
				ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate,ZPPS.PortalId,ZP1.StoreName, 
				NULL IsAssociated, NULL As ProfileId,NULL As ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName,
					CASE WHEN @PortalId > 0 AND ZPPS.PaymentDisplayName IS NOT NULL
						THEN ZPPS.PaymentDisplayName ELSE ZPS.PaymentDisplayName END PaymentDisplayName, 
				NULL PaymentExternalId, CAST(CASE WHEN YU.PaymentSettingId IS NOT NULL THEN 1 ELSE 0 END As BIT) AS IsApprovalRequired,
				ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,
				YU.PortalPaymentGroupId,'' AS PublishState
			FROM ZnodePaymentSetting ZPS
			INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
			LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
			LEFT JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId )
			INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
			LEFT JOIN ZnodeProfile ZP ON ZP.ProfileId = YOPU.ProfileId
			INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
			LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId) 
			WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1 AND
				(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId AND ZPPS.IsUsedForOfflinePayment=0)
				OR EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE @UserId = -1 AND ZUP.ProfileId = @GuestProfileId AND ZPPS.IsUsedForOfflinePayment=0));

			SET @RowsCount=@@ROWCOUNT;
		END
		--When User is not associated with any Profile.
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE (ZUP.UserId = @UserId OR (@UserId = -1 AND ZUP.ProfileId = @GuestProfileId)))
		BEGIN
			SELECT DISTINCT ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,
				ZPS.IsActive,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,
				ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate,ZPPS.PortalId,ZP1.StoreName, 
				NULL IsAssociated ,NULL ProfileId, NULL As ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName,
					CASE WHEN @PortalId > 0 AND ZPPS.PaymentDisplayName IS NOT NULL
						THEN ZPPS.PaymentDisplayName ELSE ZPS.PaymentDisplayName END PaymentDisplayName, 
				NULL PaymentExternalId, CAST(CASE WHEN YU.PaymentSettingId IS NOT NULL THEN 1 ELSE 0 END As BIT) AS IsApprovalRequired,
				ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,
				YU.PortalPaymentGroupId,'' AS PublishState
			FROM ZnodePaymentSetting ZPS
			INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
			LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
			LEFT JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId )
			INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
			LEFT JOIN ZnodeProfile ZP ON ZP.ProfileId = YOPU.ProfileId
			INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
			LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId) 
			WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1 AND ZPPS.IsUsedForOfflinePayment=0;

			SET @RowsCount=@@ROWCOUNT;
		END

		ELSE
		BEGIN
			SELECT DISTINCT ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,
				ZPS.IsActive,ZPS.DisplayOrder AS DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,
				ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate,ZPPS.PortalId,ZP1.StoreName, NULL IsAssociated ,NULL AS ProfileId,
				NULL AS ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName,
				CASE WHEN @PortalId > 0 AND ZPPS.PaymentDisplayName IS NOT NULL
					THEN ZPPS.PaymentDisplayName ELSE ZPS.PaymentDisplayName END PaymentDisplayName, 
				NULL PaymentExternalId, CAST(CASE WHEN YU.PaymentSettingId IS NOT NULL THEN 1 ELSE 0 END As BIT) AS IsApprovalRequired,
				ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,
				YU.PortalPaymentGroupId,'' AS PublishState
			FROM ZnodePaymentSetting ZPS
			INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
			LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
			INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
			INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
			LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
			WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1 AND ZPPS.IsUsedForOfflinePayment=0;

			SET @RowsCount=@@ROWCOUNT;
		END
	END TRY
	BEGIN CATCH
		DECLARE @Status BIT;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(),
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPaymentSettingByUserDetails @PortalId='+CAST(@PortalId AS VARCHAR(50))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50));

		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_GetPaymentSettingByUserDetails',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH
END

GO

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=100, ValidationName = 'MaxCharacters' , ControlName = 'Number'
WHERE AttributeCode='AttributeName' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='ProductAttribute' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=100, ValidationName = 'MaxCharacters' , ControlName = 'Number'
WHERE AttributeCode='Attributecode' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='ProductAttribute' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=100, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode='VoucherName' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='Voucher' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=200, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode IN ('ProfileName','DepartmentName','AccountCode') AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='Customer' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=300, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode IN ('Address1','Address2') AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='CustomerAddress' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=600, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode IN ('DisplayName','CompanyName') AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='CustomerAddress' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=100, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode IN ('FirstName','LastName') AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='Customer' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=30, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode ='PhoneNumber' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='Customer' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=300, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode IN ('FirstName','LastName') AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='CustomerAddress' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=200, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode IN ('Address1','Address2') AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='CustomerAddress' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=100, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode IN ('CityName','PostalCode') AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='CustomerAddress' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=30, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode ='PhoneNumber' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='CustomerAddress' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=200, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode ='CanonicalURL' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='SEODetails' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=50, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode ='RobotTag' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='SEODetails' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=300, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode IN ('HighlightCode','ImageAltTag','HighlightName') AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='Highlight' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=300, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode ='AddonGroupName' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='AddonAssociation' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=300, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode IN ('AttributeCode','AttributeDefaultValueCode') AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='AttributeDefaultValue' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=300, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode IN ('AccountCode','AccountName','AddressName','CompanyName','Address1','Address2') AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='Account' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=300, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode ='IsBidirectional' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='Synonyms' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=300, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode ='BrandCode' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='Brands' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=200, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode ='HighlightType' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='Highlight' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=200, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode IN ('ChildSKU','ParentSKU') AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='ProductAssociation' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=200, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode IN ('CityName','CountyCode','StateCode') AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='ZipCode' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=50, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode IN ('CityType','ZIPType','CountyFIPS','StateFIPS','MSACode','TimeZone') AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='ZipCode' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=1, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode ='DST' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='ZipCode' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)


UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=300, ValidationName = 'MaxCharacters',ControlName = 'Number'  
WHERE AttributeCode ='ParentCode' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='CatalogCategoryAssociation' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)


UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=300, ValidationName = 'MaxCharacters',ControlName = 'Number'  
WHERE AttributeCode ='CategoryCode' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='CatalogCategoryAssociation' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=100, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode ='ImportType' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='SEODetails' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=2000, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode ='Code' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='SEODetails' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=50, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode ='IsActive' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='SEODetails' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=300, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode IN ('SEOKeyword','SEODescription') AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='Brands' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=200, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode IN ('SEOTitle','URLKey') AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='Brands' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=200, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode ='DisplayName' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='CustomerAddress' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)


UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=300, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode = 'CompanyName' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='CustomerAddress' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

--ZPD-20693 Dt.23-June-2022
DELETE A 
FROM 
(
SELECT *, ROW_NUMBER() OVER (PARTITION BY AttributeCode,ImportHeadId,AttributeTypeName,IsRequired,ControlName,ValidationName ORDER BY CreatedDate ASC) As Rn
FROM ZnodeImportAttributeValidation 
WHERE ImportHeadId IN (SELECT ImportHeadId FROM ZnodeImportHead WHERE Name IN ('Customer','Account'))
	AND AttributeCode IN ('ProfileName','DepartmentName','AccountCode','AccountCode','AccountName','AddressName','CompanyName','Address1','Address2')
) A WHERE A.Rn<>1


UPDATE ZnodeImportAttributeValidation 
SET ValidationValue='', ValidationName = 'RegularExpression',ControlName = 'Text'
WHERE AttributeCode IN ('ProfileName','DepartmentName','AccountCode')
	AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='Customer' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)
	AND (SELECT COUNT(1) FROM ZnodeImportAttributeValidation WHERE AttributeCode IN ('ProfileName','DepartmentName','AccountCode')
			AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='Customer' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId))=3

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue='', ValidationName = 'RegularExpression',ControlName = 'Text'
WHERE AttributeCode IN ('AccountCode','AccountName','AddressName','CompanyName','Address1','Address2')
	AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='Account' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)
	AND (SELECT COUNT(1) FROM ZnodeImportAttributeValidation WHERE AttributeCode IN ('ProfileName','DepartmentName','AccountCode','AccountCode','AccountName','AddressName','CompanyName','Address1','Address2')
			AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='Account' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId))=6


INSERT INTO ZnodeImportAttributeValidation (AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,
	ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Text','ProfileName',
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Customer'),0,'Number','MaxCharacters',
	NULL,'200','',NULL,2,GETDATE(),2,GETDATE(),12
WHERE NOT EXISTS(SELECT * FROM ZnodeImportAttributeValidation 
				WHERE AttributeTypeName ='Text' AND AttributeCode = 'ProfileName'
					AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Customer')
					AND ControlName = 'Number' AND ValidationName = 'MaxCharacters'
				)

INSERT INTO ZnodeImportAttributeValidation (AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,
	ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Text','DepartmentName',
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Customer'),0,'Number','MaxCharacters',
	NULL,'200','',NULL,2,GETDATE(),2,GETDATE(),14
WHERE NOT EXISTS(SELECT * FROM ZnodeImportAttributeValidation 
				WHERE AttributeTypeName ='Text' AND AttributeCode = 'DepartmentName'
					AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Customer')
					AND ControlName = 'Number' AND ValidationName = 'MaxCharacters'
				)

INSERT INTO ZnodeImportAttributeValidation (AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,
	ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Text','AccountCode',
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Customer'),0,'Number','MaxCharacters',
	NULL,'200','',NULL,2,GETDATE(),2,GETDATE(),13
WHERE NOT EXISTS(SELECT * FROM ZnodeImportAttributeValidation 
				WHERE AttributeTypeName ='Text' AND AttributeCode = 'AccountCode'
					AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Customer')
					AND ControlName = 'Number' AND ValidationName = 'MaxCharacters'
				)



INSERT INTO ZnodeImportAttributeValidation (AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,
	ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Text','AccountCode',
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Account'),0,'Number','MaxCharacters',
	NULL,'300','',NULL,2,GETDATE(),2,GETDATE(),3
WHERE NOT EXISTS(SELECT * FROM ZnodeImportAttributeValidation 
				WHERE AttributeTypeName ='Text' AND AttributeCode = 'AccountCode'
					AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Account')
					AND ControlName = 'Number' AND ValidationName = 'MaxCharacters'
				)

INSERT INTO ZnodeImportAttributeValidation (AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,
	ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Text','AccountName',
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Account'),0,'Number','MaxCharacters',
	NULL,'300','',NULL,2,GETDATE(),2,GETDATE(),2
WHERE NOT EXISTS(SELECT * FROM ZnodeImportAttributeValidation 
				WHERE AttributeTypeName ='Text' AND AttributeCode = 'AccountName'
					AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Account')
					AND ControlName = 'Number' AND ValidationName = 'MaxCharacters'
				)

INSERT INTO ZnodeImportAttributeValidation (AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,
	ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Text','AddressName',
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Account'),0,'Number','MaxCharacters',
	NULL,'300','',NULL,2,GETDATE(),2,GETDATE(),6
WHERE NOT EXISTS(SELECT * FROM ZnodeImportAttributeValidation 
				WHERE AttributeTypeName ='Text' AND AttributeCode = 'AddressName'
					AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Account')
					AND ControlName = 'Number' AND ValidationName = 'MaxCharacters'
				)

INSERT INTO ZnodeImportAttributeValidation (AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,
	ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Text','CompanyName',
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Account'),0,'Number','MaxCharacters',
	NULL,'300','',NULL,2,GETDATE(),2,GETDATE(),9
WHERE NOT EXISTS(SELECT * FROM ZnodeImportAttributeValidation 
				WHERE AttributeTypeName ='Text' AND AttributeCode = 'CompanyName'
					AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Account')
					AND ControlName = 'Number' AND ValidationName = 'MaxCharacters'
				)

INSERT INTO ZnodeImportAttributeValidation (AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,
	ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Text','Address1',
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Account'),0,'Number','MaxCharacters',
	NULL,'300','',NULL,2,GETDATE(),2,GETDATE(),10
WHERE NOT EXISTS(SELECT * FROM ZnodeImportAttributeValidation 
				WHERE AttributeTypeName ='Text' AND AttributeCode = 'Address1'
					AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Account')
					AND ControlName = 'Number' AND ValidationName = 'MaxCharacters'
				)

INSERT INTO ZnodeImportAttributeValidation (AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,
	ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Text','Address2',
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Account'),0,'Number','MaxCharacters',
	NULL,'300','',NULL,2,GETDATE(),2,GETDATE(),11
WHERE NOT EXISTS(SELECT * FROM ZnodeImportAttributeValidation 
				WHERE AttributeTypeName ='Text' AND AttributeCode = 'Address2'
					AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Account')
					AND ControlName = 'Number' AND ValidationName = 'MaxCharacters'
				)

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishSearchProfileEntity')
	DROP PROC Znode_PublishSearchProfileEntity
GO

CREATE PROCEDURE [dbo].[Znode_PublishSearchProfileEntity] 
(
	@SearchProfileId INT,
	@UserId INT
)
AS
BEGIN
	BEGIN TRY			
		SET NOCOUNT ON
		DECLARE @SearchProfilePublishLogId INT;

		IF NOT EXISTS 
		(SELECT TOP 1 1 FROM ZnodePimCatalog 
		WHERE PimCatalogId =(SELECT TOP 1 PimCatalogId FROM ZnodePublishCatalog
							WHERE PublishCatalogId=(SELECT TOP 1 PublishCatalogId FROM ZnodePublishCatalogSearchProfile 
													WHERE SearchProfileId = @SearchProfileId
													)
							)
		)
		BEGIN
			SELECT CAST(0 AS BIT) Status 
		END
		ELSE
		BEGIN
			INSERT INTO ZnodeSearchProfilePublishLog
				(SearchProfileId,PublishstateId,PublishStartDate,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
			SELECT @SearchProfileId, dbo.Fn_GetPublishStateIdForProcessing(),Getdate(),@UserId , GETDATE(),@UserId , GETDATE()

			SET @SearchProfilePublishLogId = @@IDENTITY

			SELECT a.SearchProfileId,A.SearchFeatureValue,B.FeatureCode,b.FeatureName,b.IsAdvanceFeature,B.HelpDescription  
			INTO #ZnodeSearchFeature
			FROM ZnodeSearchProfileFeatureMapping A 
			INNER JOIN ZnodeSearchFeature B ON A.SearchFeatureId = B.SearchFeatureId
			WHERE A.SearchProfileId = @SearchProfileId
				
			SELECT B.SearchProfileId,
				'['+(SELECT A.SearchFeatureValue,A.FeatureCode,A.FeatureName,A.IsAdvanceFeature
			From #ZnodeSearchFeature A
			WHERE A.SearchProfileId = b.SearchProfileId 
			For Json path, Without_Array_Wrapper)+']' as FeatureValueJson
			INTO #ZnodeSearchFeatureJson
			FROM #ZnodeSearchFeature B 
			GROUP BY B.SearchProfileId

			SELECT A.SearchProfileId,
				'['+(	SELECT B.AttributeCode, B.IsFacets,B.IsUseInSearch,B.BoostValue,B.IsNgramEnabled
						FROM ZnodeSearchProfileAttributeMapping B  
						WHERE A.SearchProfileId = B.SearchProfileId
						For Json Path, Without_Array_Wrapper)
				+']' as SearchProfileAttributeMappingJson
			INTO #ZnodeSearchProfileAttributeMappingJson 
			FROM ZnodeSearchProfileAttributeMapping A
			WHERE A.SearchProfileId = @SearchProfileId
			GROUP BY A.SearchProfileId

			SELECT A.SearchProfileId,
				'['+(	select B.FieldName, B.FieldValueFactor
						from ZnodeSearchProfileFieldValueFactor B  
						Where A.SearchProfileId = B.SearchProfileId
						For Json Path, Without_Array_Wrapper)
				+']' as FieldValueFactor
			INTO #ZnodeSearchProfileFieldValueFactor 
			FROM ZnodeSearchProfileFieldValueFactor A
			WHERE A.SearchProfileId = @SearchProfileId
			GROUP BY A.SearchProfileId

			SELECT @SearchProfilePublishLogId SearchProfilePublishLogId,  b.SearchProfileId,
				b.ProfileName,pc.PublishCatalogId,ZSFJ.FeatureValueJson FeaturesList
				,c.QueryTypeName,b.SearchQueryTypeId  
				,c.QueryBuilderClassName,d.QueryTypeName SubQueryTypeName,vf.FieldValueFactor,
				b.Operator,ZSPAMJ.SearchProfileAttributeMappingJson SearchProfileAttributeMappingJson,
				@UserId CreatedBy, GETDATE() CreatedDate,@UserId Modifiedby, GETDATE() ModifiedDate
			INTO #ZnodeSearchProfile
			FROM  ZnodeSearchProfile B 
			LEFT JOIN dbo.ZnodePublishCatalogSearchProfile cc on cc.SearchProfileId=b.SearchProfileId
			LEFT JOIN dbo.ZnodePublishCatalog pc on pc.PublishCatalogId=cc.PublishCatalogId
			INNER JOIN ZnodeSearchQueryType C on b.SearchQueryTypeId=C.SearchQueryTypeId 
			--LEFT JOIN ZnodeSearchProfileFieldValueFactor ZSPF on ZSPF.SearchProfileId = b.SearchProfileId
			LEFT JOIN #ZnodeSearchFeatureJson ZSFJ on ZSFJ.SearchProfileId = b.SearchProfileId
			LEFT JOIN  #ZnodeSearchProfileAttributeMappingJson ZSPAMJ on  ZSPAMJ.SearchProfileId = b.SearchProfileId
			LEFT JOIN ZnodeSearchQueryType d on  d.SearchQueryTypeId =b.SearchSubQueryTypeId
			LEFT JOIN #ZnodeSearchProfileFieldValueFactor vf on vf.SearchProfileId =b.SearchProfileId
			WHERE b.SearchProfileId=@SearchProfileId

			IF EXISTS (SELECT TOP 1 1 FROM #ZnodeSearchProfile)
			BEGIN 
				INSERT INTO ZnodePublishSearchProfileEntity(
					SearchProfilePublishLogId,SearchProfileId,SearchProfileName,ZnodeCatalogId,FeaturesList,
					QueryTypeName,SearchQueryType,
					QueryBuilderClassName,SubQueryType,FieldValueFactor,Operator,SearchProfileAttributeMappingJson,
					CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT SearchProfilePublishLogId,SearchProfileId,ProfileName,PublishCatalogId,FeaturesList,
					QueryTypeName,SearchQueryTypeId  ,
					QueryBuilderClassName,SubQueryTypeName,FieldValueFactor,Operator,SearchProfileAttributeMappingJson,
					CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
				FROM #ZnodeSearchProfile 
		
				UPDATE ZnodeSearchProfilePublishLog
				SET PublishstateId = dbo.Fn_GetPublishStateIdForPublish()
				WHERE SearchProfilePublishLogId = @SearchProfilePublishLogId

				UPDATE ZnodeSearchProfile
				SET PublishStateId = dbo.Fn_GetPublishStateIdForPublish() 
				WHERE SearchProfileId = @SearchProfileId

				UPDATE ZnodePublishSearchProfileEntity 
				SET PublishstateId = dbo.Fn_GetPublishStateIdForPublish() 
				WHERE SearchProfileId = @SearchProfileId 

				DELETE
				FROM ZnodePublishSearchProfileEntity
				WHERE SearchProfilePublishLogId  < @SearchProfilePublishLogId AND SearchProfileId = @SearchProfileId
				SELECT CAST(1 AS BIT) Status
			END
			ELSE
			BEGIN
				UPDATE ZnodeSearchProfilePublishLog 
				SET PublishstateId = dbo.Fn_GetPublishStateIdForPublishFailed() 
				WHERE SearchProfilePublishLogId = @SearchProfilePublishLogId 

				SELECT CAST(0 AS BIT) Status 

				UPDATE ZnodeSearchProfile 
				SET PublishstateId = dbo.Fn_GetPublishStateIdForPublishFailed() 
				WHERE SearchProfileId = @SearchProfileId 
		
	     		UPDATE ZnodePublishSearchProfileEntity 
				SET PublishstateId = dbo.Fn_GetPublishStateIdForPublishFailed() 
				WHERE SearchProfileId = @SearchProfileId
			END
		END
	END TRY

	BEGIN CATCH
		UPDATE ZnodeSearchProfile 
		SET PublishstateId = dbo.Fn_GetPublishStateIdForPublishFailed() 
		WHERE SearchProfileId = @SearchProfileId 

		UPDATE ZnodeSearchProfilePublishLog 
		SET PublishstateId = dbo.Fn_GetPublishStateIdForPublishFailed() 
		WHERE SearchProfilePublishLogId = @SearchProfilePublishLogId AND SearchProfileId = @SearchProfileId
		
		UPDATE ZnodePublishSearchProfileEntity 
		SET PublishstateId = dbo.Fn_GetPublishStateIdForPublishFailed() 
		WHERE SearchProfileId = @SearchProfileId 

		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(),
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
				@ErrorLine VARCHAR(100)= ERROR_LINE(), 
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishSearchProfileEntity @SearchProfileId = '+CAST(@SearchProfileId AS VARCHAR(10))+',@UserId='+CAST(@UserId AS VARCHAR(10));

		SELECT CAST(0 AS BIT) Status

		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_PublishSearchProfileEntity',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPaymentSettingByUserDetails')
	DROP PROC Znode_GetPaymentSettingByUserDetails
GO

CREATE PROCEDURE [dbo].[Znode_GetPaymentSettingByUserDetails]
(
	@PortalId	INT,
	@UserId		INT,
	@RowsCount  INT OUT
)
AS
/*
	Summary: This Procedure is used to get payment details according to associated profile or portal.

	Unit Testing:

	EXEC [Znode_GetPaymentSettingByUserDetails] @PortalId=1, @UserId=1, @RowsCount=0
*/	
BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
		DECLARE @GuestProfileId INT;

		SELECT TOP 1 @GuestProfileId=ProfileId FROM ZnodeProfile WHERE ProfileName = 'Anonymous' AND @UserId = -1;

		IF OBJECT_ID('tempdb..#ZnodePortalPaymentApprovers') IS NOT NULL
			DROP TABLE #ZnodePortalPaymentApprovers
		--Getting the payment portal approver details
		SELECT PaymentSettingId ,ZPPG.PortalPaymentGroupId,ZPA.PortalId 
		INTO #ZnodePortalPaymentApprovers
		FROM ZnodePortalPaymentApprovers ZPPA 
		INNER JOIN [ZnodePortalPaymentGroup] ZPPG ON( ZPPA.PortalPaymentGroupId = ZPPG.PortalPaymentGroupId)
		INNER JOIN [ZnodePortalApproval] ZPA ON (ZPA.PortalApprovalId = ZPPG.PortalApprovalId) 
		WHERE ZPA.EnableApprovalManagement =1 AND ZPA.PortalId = @PortalId AND ZPPG.isActive = 1;
	
		--When any User Profile is associated with the user account
		--OR When User is associated with single Profile.
		--OR When two or more User Profiles are associated with the user account
		IF (EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP 
					INNER JOIN ZnodePortalProfile ZPP ON ZUP.ProfileId=ZPP.ProfileId
					INNER JOIN ZnodeProfilePaymentSetting ZPS ON ZUP.ProfileId=ZPS.ProfileId
					INNER JOIN ZnodePortalPaymentSetting ZPS1 ON ZPP.PortalId=ZPS1.PortalId AND ZPS.PaymentSettingId=ZPS1.PaymentSettingId
					WHERE ZUP.UserId=@UserId AND ZPP.PortalId=@PortalId AND ZPS1.IsUsedForWebStorePayment=1)

			OR EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP 
					INNER JOIN ZnodePortalProfile ZPP ON ZUP.ProfileId=ZPP.ProfileId
					INNER JOIN ZnodeProfilePaymentSetting ZPS ON ZUP.ProfileId=ZPS.ProfileId
					INNER JOIN ZnodePortalPaymentSetting ZPS1 ON ZPP.PortalId=ZPS1.PortalId AND ZPS.PaymentSettingId=ZPS1.PaymentSettingId
					WHERE ZUP.ProfileId=@GuestProfileId AND ZPP.PortalId=@PortalId AND ZPS1.IsUsedForWebStorePayment=1)
			)
		BEGIN
			IF EXISTS (	SELECT TOP 1 1 
						FROM ZnodePaymentSetting ZPS
						INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
						LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
						INNER JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId )
						INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
						INNER JOIN ZnodeProfile ZP ON ZP.ProfileId = YOPU.ProfileId
						INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
						WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1 AND
							(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId AND YOPU.ProfileId = ZUP.ProfileId AND ZPPS.IsUsedForWebStorePayment=1)
							OR EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE @UserId = -1 AND ZUP.ProfileId = @GuestProfileId AND ZPPS.IsUsedForWebStorePayment=1)))
			BEGIN
				SELECT DISTINCT ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,
					ZPS.IsActive,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,
					ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate,ZPPS.PortalId,ZP1.StoreName, 
					NULL IsAssociated ,NULL As ProfileId,NULL As ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName,
						CASE WHEN @PortalId > 0 AND ZPPS.PaymentDisplayName IS NOT NULL
							THEN ZPPS.PaymentDisplayName ELSE ZPS.PaymentDisplayName END PaymentDisplayName, 
					NULL PaymentExternalId, CAST(CASE WHEN YU.PaymentSettingId IS NOT NULL THEN 1 ELSE 0 END As BIT) AS IsApprovalRequired,
					ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,
					YU.PortalPaymentGroupId,'' AS PublishState
				FROM ZnodePaymentSetting ZPS
				INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				INNER JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId )
				INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
				INNER JOIN ZnodeProfile ZP ON ZP.ProfileId = YOPU.ProfileId
				INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
				LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId) 
				WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1 AND
					(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId AND YOPU.ProfileId = ZUP.ProfileId AND ZPPS.IsUsedForWebStorePayment=1)
					OR EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE @UserId = -1 AND ZUP.ProfileId = @GuestProfileId AND ZPPS.IsUsedForWebStorePayment=1));

				SET @RowsCount=@@ROWCOUNT;
			END
			ELSE
			BEGIN
				SELECT DISTINCT ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,
					ZPS.IsActive,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,
					ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate,ZPPS.PortalId,ZP1.StoreName, 
					NULL IsAssociated ,NULL As ProfileId,NULL As ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName,
						CASE WHEN @PortalId > 0 AND ZPPS.PaymentDisplayName IS NOT NULL
							THEN ZPPS.PaymentDisplayName ELSE ZPS.PaymentDisplayName END PaymentDisplayName, 
					NULL PaymentExternalId, CAST(CASE WHEN YU.PaymentSettingId IS NOT NULL THEN 1 ELSE 0 END As BIT) AS IsApprovalRequired,
					ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,
					YU.PortalPaymentGroupId,'' AS PublishState
				FROM ZnodePaymentSetting ZPS
				INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				LEFT JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId )
				INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
				LEFT JOIN ZnodeProfile ZP ON ZP.ProfileId = YOPU.ProfileId
				INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
				LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
				WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1 AND
					(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId AND ZPPS.IsUsedForWebStorePayment=1)
					OR EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE @UserId = -1 AND ZUP.ProfileId = @GuestProfileId AND ZPPS.IsUsedForWebStorePayment=1));

				SET @RowsCount=@@ROWCOUNT;
			END
		END
		--When User is associated with Profile but this Profile is not associated with any portal.
		ELSE IF EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE ((ZUP.UserId = @UserId AND ZUP.ProfileId IS NOT NULL) OR (@UserId = -1 AND ZUP.ProfileId = @GuestProfileId))
							AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalProfile WHERE ProfileId=ZUP.ProfileId AND PortalId=@PortalId))
		BEGIN
			SELECT DISTINCT ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,
				ZPS.IsActive,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,
				ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate,ZPPS.PortalId,ZP1.StoreName, 
				NULL IsAssociated, NULL As ProfileId,NULL As ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName,
					CASE WHEN @PortalId > 0 AND ZPPS.PaymentDisplayName IS NOT NULL
						THEN ZPPS.PaymentDisplayName ELSE ZPS.PaymentDisplayName END PaymentDisplayName, 
				NULL PaymentExternalId, CAST(CASE WHEN YU.PaymentSettingId IS NOT NULL THEN 1 ELSE 0 END As BIT) AS IsApprovalRequired,
				ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,
				YU.PortalPaymentGroupId,'' AS PublishState
			FROM ZnodePaymentSetting ZPS
			INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
			LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
			LEFT JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId )
			INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
			LEFT JOIN ZnodeProfile ZP ON ZP.ProfileId = YOPU.ProfileId
			INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
			LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId) 
			WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1 AND
				(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId AND ZPPS.IsUsedForWebStorePayment=1)
				OR EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE @UserId = -1 AND ZUP.ProfileId = @GuestProfileId AND ZPPS.IsUsedForWebStorePayment=1));

			SET @RowsCount=@@ROWCOUNT;
		END
		--When User is not associated with any Profile.
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE (ZUP.UserId = @UserId OR (@UserId = -1 AND ZUP.ProfileId = @GuestProfileId)))
		BEGIN
			SELECT DISTINCT ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,
				ZPS.IsActive,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,
				ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate,ZPPS.PortalId,ZP1.StoreName, 
				NULL IsAssociated ,NULL ProfileId, NULL As ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName,
					CASE WHEN @PortalId > 0 AND ZPPS.PaymentDisplayName IS NOT NULL
						THEN ZPPS.PaymentDisplayName ELSE ZPS.PaymentDisplayName END PaymentDisplayName, 
				NULL PaymentExternalId, CAST(CASE WHEN YU.PaymentSettingId IS NOT NULL THEN 1 ELSE 0 END As BIT) AS IsApprovalRequired,
				ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,
				YU.PortalPaymentGroupId,'' AS PublishState
			FROM ZnodePaymentSetting ZPS
			INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
			LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
			LEFT JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId )
			INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
			LEFT JOIN ZnodeProfile ZP ON ZP.ProfileId = YOPU.ProfileId
			INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
			LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId) 
			WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1 AND ZPPS.IsUsedForWebStorePayment=1;

			SET @RowsCount=@@ROWCOUNT;
		END

		ELSE
		BEGIN
			SELECT DISTINCT ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,
				ZPS.IsActive,ZPS.DisplayOrder AS DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,
				ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate,ZPPS.PortalId,ZP1.StoreName, NULL IsAssociated ,NULL AS ProfileId,
				NULL AS ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName,
				CASE WHEN @PortalId > 0 AND ZPPS.PaymentDisplayName IS NOT NULL
					THEN ZPPS.PaymentDisplayName ELSE ZPS.PaymentDisplayName END PaymentDisplayName, 
				NULL PaymentExternalId, CAST(CASE WHEN YU.PaymentSettingId IS NOT NULL THEN 1 ELSE 0 END As BIT) AS IsApprovalRequired,
				ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,
				YU.PortalPaymentGroupId,'' AS PublishState
			FROM ZnodePaymentSetting ZPS
			INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
			LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
			INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
			INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
			LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
			WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1 AND ZPPS.IsUsedForWebStorePayment=1;

			SET @RowsCount=@@ROWCOUNT;
		END
	END TRY
	BEGIN CATCH
		DECLARE @Status BIT;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(),
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPaymentSettingByUserDetails @PortalId='+CAST(@PortalId AS VARCHAR(50))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50));

		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_GetPaymentSettingByUserDetails',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportValidateManditoryText')
	DROP PROC Znode_ImportValidateManditoryText
GO

CREATE PROCEDURE [dbo].[Znode_ImportValidateManditoryText]
(
	@TableName          VARCHAR(200),
	@SourceColumnName   NVARCHAR(600),
	@CreateDateString   NVARCHAR(300),
	@ValidationName     VARCHAR(100),
	@ControlName        VARCHAR(300),
	@ValidationValue    VARCHAR(300),
	@NewGUID            NVARCHAR(200),
	@LocaleId           INT = 1 ,
	@DefaultLocaleId    INT,
	@AttributeId        INT,
	@ImportProcessLogId INT,
	@ImportHeadId     INT           = 0,
	@IsIgnoreProcess   BIT = 0 
)
AS
     
 /*
	Summary:  Text 
             --------------------------
              Control   Validation Rule
             --------------------------
             1 Select	ValidationRule
             2 Text	RegularExpression
             3 Number	MaxCharacters
             4 Yes/No	UniqueValue

	Unit Testing:
	EXEC Znode_ImportValidateManditoryText
	 */
	 
	 BEGIN
        BEGIN TRY 
            SET NOCOUNT ON


             DECLARE @SQLQuery NVARCHAR(MAX), @ImportHeadName NVARCHAR(100);
             SET @ImportHeadName = DBO.Fn_GetDefaultImportHead(@ImportHeadId);
			 
			 IF @ControlName = 'Number' AND @ValidationName IN('MaxCharacters')  AND ISNULL(@ValidationValue, '') <> ''
                 BEGIN
                     SET @SQLQuery = @TableName+'  WHERE LEN('+@SourceColumnName+') > ' +   @ValidationValue + ' AND Isnull('+@SourceColumnName+','''') <> ''''';
                    

					IF @ValidationName = 'MaxCharacters'
                         EXEC Znode_ImportGenerateErrorLog
                              @ImportHeadName = @ImportHeadName,
                              @QueryCriteria = @SQLQuery,
                              @SourceColumnName = @SourceColumnName,
                              @CreateDateString = @CreateDateString,
                              @ErrorCode = '129',
                              @ValidationValue = @ValidationValue;
                  END;
             IF @ControlName = 'Yes/No' AND @ValidationName IN('UniqueValue') AND @ValidationValue = 'true'
                 BEGIN
					-- Check duplicate value exist in global temporary table 
					SET @SQLQuery = 'SELECT ''53'' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], '+@SourceColumnName+' AS  AttributeValue,RowNumber ,GUID,  '+@CreateDateString+' 
					FROM '+@TableName+'   WHERE RowNumber in (Select RowNumber from '+@TableName+' where '+@SourceColumnName+' in (Select '+@SourceColumnName+' from '+@TableName+' GROUP BY '+@SourceColumnName+' having COUNT(*) > 1) 
					)
					AND '+CAST(@IsIgnoreProcess AS varchar(100))+' = 0  
					';
                     
					INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, RowNumber, GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
					EXEC sys.sp_sqlexec @SQLQuery;

					---- Check duplicate value exist in znode database
					--If (@ImportHeadName in  ('Product'))
					--BEGIN
					-- SET @SQLQuery = 'SELECT ''10 '' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], '+@SourceColumnName+' AS  AttributeValue,tlb.RowNumber ,GUID,  '+@CreateDateString+' 
					--				  FROM ZnodePimAttributeValue AS ZPAV INNER JOIN ZnodePimAttributeValueLocale AS ZPAVL ON 
					--				  (ZPAVL.PimAttributeValueId = ZPAV.PimAttributeValueId AND ZPAVL.LocaleId IN ('+CONVERT(VARCHAR(100), @LocaleId)+','+CONVERT(VARCHAR(100), @DefaultLocaleId)+')) 
					--				  INNER JOIN '+@TableName+' tlb ON ZPAVL.AttributeValue = tlb.'+@SourceColumnName+' 
					--				  WHERE ZPAV.PimAttributeId = '+CONVERT(VARCHAR(100), @AttributeId)+' AND ZPAVL.AttributeValue <> ''''';

					-- INSERT INTO ZnodeImportLog
					-- (ErrorDescription,ColumnName,Data,RowNumber,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
					-- EXEC sys.sp_sqlexec @SQLQuery;

					-- --Remove wrong data from table 
					-- --SET @SQLQuery = 'DELETE FROM '+@TableName+' WHERE RowNumber in (Select Isnull(RowNumber,0) FROM ZnodeImportLog 
					--	--			  WHERE ErrorDescription =10 AND ImportProcessLogId  = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+');';
					-- --EXEC sys.sp_sqlexec @SQLQuery;
					--END

					--If (@ImportHeadName in  ('Category'))
					--BEGIN
				
					--	SET @SQLQuery = 'SELECT ''10 '' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], '+@SourceColumnName+' AS  AttributeValue,tlb.RowNumber ,GUID,  '+@CreateDateString+' 
					--	FROM ZnodePimCategoryAttributeValue AS ZPAV INNER JOIN ZnodePimCategoryAttributeValueLocale AS ZPAVL ON 
					--	(ZPAVL.PimCategoryAttributeValueId = ZPAV.PimCategoryAttributeValueId AND ZPAVL.LocaleId IN ('+CONVERT(VARCHAR(100), @LocaleId)+','+CONVERT(VARCHAR(100), @DefaultLocaleId)+')) 
					--	INNER JOIN '+@TableName+' tlb ON ZPAVL.CategoryValue = tlb.'+@SourceColumnName+' 
					--	WHERE ZPAV.PimAttributeId = '+CONVERT(VARCHAR(100), @AttributeId)+' AND ZPAVL.CategoryValue <> ''''';
					
					--	INSERT INTO ZnodeImportLog
					--	(ErrorDescription,ColumnName,Data,RowNumber,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
					--	EXEC sys.sp_sqlexec @SQLQuery;
					
					-- END
					---- Check duplicate value exist in znode database
				
				     If (@ImportHeadName in  ('Category'))
					BEGIN
						SET @SQLQuery = 'SELECT ''79 '' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], '+@SourceColumnName+' AS  AttributeValue,tlb.RowNumber ,GUID,  '+@CreateDateString+' 
						FROM '+@TableName+' tlb
						WHERE ltrim(rtrim(isnull(tlb.CategoryCode,''''))) like ''% %'''
						;

						INSERT INTO ZnodeImportLog
						(ErrorDescription,ColumnName,Data,RowNumber,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
						EXEC sys.sp_sqlexec @SQLQuery;

						SET @SQLQuery = 'SELECT ''79 '' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], '+@SourceColumnName+' AS  AttributeValue,tlb.RowNumber ,GUID,  '+@CreateDateString+' 
						FROM '+@TableName+' tlb
						WHERE ltrim(rtrim(isnull(tlb.CategoryCode,''''))) like ''%[^0-9A-Za-z]%'''
						;

						INSERT INTO ZnodeImportLog
						(ErrorDescription,ColumnName,Data,RowNumber,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
						EXEC sys.sp_sqlexec @SQLQuery;

						SET @SQLQuery = 'SELECT ''79 '' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], '+@SourceColumnName+' AS  AttributeValue,tlb.RowNumber ,GUID,  '+@CreateDateString+' 
						FROM '+@TableName+' tlb
						WHERE ltrim(rtrim(isnull(tlb.CategoryCode,''''))) NOT LIKE ''%[^0-9]%'''
						;

						INSERT INTO ZnodeImportLog
						(ErrorDescription,ColumnName,Data,RowNumber,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
						EXEC sys.sp_sqlexec @SQLQuery;

						
					END

                 END;
         END TRY
         BEGIN CATCH
               DECLARE @Status BIT ;
		     SET @Status = 0;
			 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportValidateManditoryText @TableName = '+@TableName+',@SourceColumnName='+@SourceColumnName+',@CreateDateString='+@CreateDateString+',@ValidationName='+@ValidationName+',@ControlName = '+@ControlName+',@ValidationValue='+@ValidationValue+',@NewGUID='+@NewGUID+',@LocaleId='+CAST(@LocaleId AS VARCHAR(50))+',@DefaultLocaleId='+CAST(@DefaultLocaleId AS VARCHAR(50))+',@AttributeId='+CAST(@AttributeId AS VARCHAR(50))+',@ImportHeadId='+CAST(@ImportHeadId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_ImportValidateManditoryText',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

INSERT INTO ZnodeImportAttributeValidation (AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,
	ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Text','FirstName',
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Account'),0,'Number','MaxCharacters',
	NULL,'300','',NULL,2,GETDATE(),2,GETDATE(),10
WHERE NOT EXISTS(SELECT * FROM ZnodeImportAttributeValidation 
				WHERE AttributeTypeName ='Text' AND AttributeCode = 'FirstName'
					AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Account')
					AND ControlName = 'Number' AND ValidationName = 'MaxCharacters'
				)

INSERT INTO ZnodeImportAttributeValidation (AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,
	ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Text','LastName',
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Account'),0,'Number','MaxCharacters',
	NULL,'300','',NULL,2,GETDATE(),2,GETDATE(),11
WHERE NOT EXISTS(SELECT * FROM ZnodeImportAttributeValidation 
				WHERE AttributeTypeName ='Text' AND AttributeCode = 'LastName'
					AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Account')
					AND ControlName = 'Number' AND ValidationName = 'MaxCharacters'
                )

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_UpdateUserProfileBasedOnAccountProfile')
	DROP PROC Znode_UpdateUserProfileBasedOnAccountProfile
GO

CREATE PROCEDURE [dbo].[Znode_UpdateUserProfileBasedOnAccountProfile]
(
	@AccountId Int,
	@UserIds Varchar(2000),
	@Status bit = 0 out 
)
as
BEGIN
	SET NOCOUNT ON
	DECLARE @UserIds_Tbl TABLE(UserId int)
	DECLARE @GetDate DATETIME =dbo.Fn_GetDate()
	DECLARE @ProfileIdByAccountId INT;

	BEGIN TRY
	BEGIN TRAN
		INSERT INTO @UserIds_Tbl(UserId)
		SELECT Item FROM dbo.Split(@UserIds,',')

		--Getting Default Profile Id Based on Account Id
		SELECT @ProfileIdByAccountId = ProfileId FROM ZnodeAccountProfile WHERE AccountId = @AccountId and IsDefault = 1;

		 IF isnull(@UserIds,'0') <> '0' or  ISNULL(@UserIds,'') <> ''
		BEGIN
			
			DELETE FROM ZnodeUserProfile  WHERE EXISTS (SELECT TOP 1 1 FROM @UserIds_Tbl UIT
			WHERE UIT.UserId = ZnodeUserProfile.UserId);

			INSERT INTO ZnodeUserProfile(ProfileId,UserId,IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT @ProfileIdByAccountId,UserId,1,@AccountId,@GetDate,@AccountId,@GetDate
			FROM @UserIds_Tbl;
		
		END
		IF ISNULL(@AccountId,0)<>0
		BEGIN
			DECLARE @UserRoleId NVARCHAR(128)=(SELECT TOP 1 Id FROM AspNetRoles WHERE Name='User');
			DECLARE @CustomerRoleId NVARCHAR(128)=(SELECT TOP 1 Id FROM AspNetRoles WHERE Name='Customer');

			UPDATE ANUR
			SET ANUR.RoleId=@UserRoleId
			FROM ZnodeUser ZU 
			INNER JOIN AspNetUsers ANU on ZU.AspNetUserId=ANU.Id
			INNER JOIN AspNetUserRoles ANUR ON ANU.Id=ANUR.UserId
			WHERE ZU.UserId IN (SELECT UserId FROM @UserIds_Tbl)
			AND ANUR.RoleId=@CustomerRoleId;
		END

		SET @Status = 1;
		SELECT 1 AS ID,@Status AS STATUS;    
	COMMIT TRAN
	END TRY
	BEGIN CATCH
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_UpdateUserProfileBasedOnAccountProfile @AccountId='+CAST(@AccountId AS VARCHAR(50))+',@UserIds='+CAST(@UserIds AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,@Status AS STATUS;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName    = 'Znode_UpdateUserProfileBasedOnAccountProfile',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage     = @ErrorMessage,
				@ErrorLine        = @ErrorLine,
				@ErrorCall        = @ErrorCall;
			ROLLBACK TRAN
	END CATCH
END

GO

UPDATE ZnodeImportAttributeValidation 
SET ControlName='Yes/No' 
WHERE AttributeCode='Displayorder' AND ValidationName IN ('MinNumber','MaxNumber') 
AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='CategoryAssociation' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishSearchProfileEntity')
	DROP PROC Znode_PublishSearchProfileEntity
GO

CREATE PROCEDURE [dbo].[Znode_PublishSearchProfileEntity] 
(
	@SearchProfileId INT,
	@UserId INT
)
AS
BEGIN
	BEGIN TRY			
		SET NOCOUNT ON
		DECLARE @SearchProfilePublishLogId INT, @ProfileName NVARCHAR(200);

		SELECT TOP 1 @ProfileName=ProfileName FROM ZnodeSearchProfile WHERE SearchProfileId=@SearchProfileId;

		IF NOT EXISTS 
		(SELECT TOP 1 1 FROM ZnodePimCatalog 
		WHERE PimCatalogId =(SELECT TOP 1 PimCatalogId FROM ZnodePublishCatalog
							WHERE PublishCatalogId=(SELECT TOP 1 PublishCatalogId FROM ZnodePublishCatalogSearchProfile 
													WHERE SearchProfileId = @SearchProfileId
													)
							)
		) AND @ProfileName<>'ZnodeSearchProfile'
		BEGIN
			SELECT CAST(0 AS BIT) Status 
		END
		ELSE
		BEGIN
			INSERT INTO ZnodeSearchProfilePublishLog
				(SearchProfileId,PublishstateId,PublishStartDate,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
			SELECT @SearchProfileId, dbo.Fn_GetPublishStateIdForProcessing(),Getdate(),@UserId , GETDATE(),@UserId , GETDATE()

			SET @SearchProfilePublishLogId = @@IDENTITY

			SELECT a.SearchProfileId,A.SearchFeatureValue,B.FeatureCode,b.FeatureName,b.IsAdvanceFeature,B.HelpDescription  
			INTO #ZnodeSearchFeature
			FROM ZnodeSearchProfileFeatureMapping A 
			INNER JOIN ZnodeSearchFeature B ON A.SearchFeatureId = B.SearchFeatureId
			WHERE A.SearchProfileId = @SearchProfileId
				
			SELECT B.SearchProfileId,
				'['+(SELECT A.SearchFeatureValue,A.FeatureCode,A.FeatureName,A.IsAdvanceFeature
			From #ZnodeSearchFeature A
			WHERE A.SearchProfileId = b.SearchProfileId 
			For Json path, Without_Array_Wrapper)+']' as FeatureValueJson
			INTO #ZnodeSearchFeatureJson
			FROM #ZnodeSearchFeature B 
			GROUP BY B.SearchProfileId

			SELECT A.SearchProfileId,
				'['+(	SELECT B.AttributeCode, B.IsFacets,B.IsUseInSearch,B.BoostValue,B.IsNgramEnabled
						FROM ZnodeSearchProfileAttributeMapping B  
						WHERE A.SearchProfileId = B.SearchProfileId
						For Json Path, Without_Array_Wrapper)
				+']' as SearchProfileAttributeMappingJson
			INTO #ZnodeSearchProfileAttributeMappingJson 
			FROM ZnodeSearchProfileAttributeMapping A
			WHERE A.SearchProfileId = @SearchProfileId
			GROUP BY A.SearchProfileId

			SELECT A.SearchProfileId,
				'['+(	select B.FieldName, B.FieldValueFactor
						from ZnodeSearchProfileFieldValueFactor B  
						Where A.SearchProfileId = B.SearchProfileId
						For Json Path, Without_Array_Wrapper)
				+']' as FieldValueFactor
			INTO #ZnodeSearchProfileFieldValueFactor 
			FROM ZnodeSearchProfileFieldValueFactor A
			WHERE A.SearchProfileId = @SearchProfileId
			GROUP BY A.SearchProfileId

			SELECT @SearchProfilePublishLogId SearchProfilePublishLogId,  b.SearchProfileId,
				b.ProfileName,pc.PublishCatalogId,ZSFJ.FeatureValueJson FeaturesList
				,c.QueryTypeName,b.SearchQueryTypeId  
				,c.QueryBuilderClassName,d.QueryTypeName SubQueryTypeName,vf.FieldValueFactor,
				b.Operator,ZSPAMJ.SearchProfileAttributeMappingJson SearchProfileAttributeMappingJson,
				@UserId CreatedBy, GETDATE() CreatedDate,@UserId Modifiedby, GETDATE() ModifiedDate
			INTO #ZnodeSearchProfile
			FROM  ZnodeSearchProfile B 
			LEFT JOIN dbo.ZnodePublishCatalogSearchProfile cc on cc.SearchProfileId=b.SearchProfileId
			LEFT JOIN dbo.ZnodePublishCatalog pc on pc.PublishCatalogId=cc.PublishCatalogId
			INNER JOIN ZnodeSearchQueryType C on b.SearchQueryTypeId=C.SearchQueryTypeId 
			--LEFT JOIN ZnodeSearchProfileFieldValueFactor ZSPF on ZSPF.SearchProfileId = b.SearchProfileId
			LEFT JOIN #ZnodeSearchFeatureJson ZSFJ on ZSFJ.SearchProfileId = b.SearchProfileId
			LEFT JOIN  #ZnodeSearchProfileAttributeMappingJson ZSPAMJ on  ZSPAMJ.SearchProfileId = b.SearchProfileId
			LEFT JOIN ZnodeSearchQueryType d on  d.SearchQueryTypeId =b.SearchSubQueryTypeId
			LEFT JOIN #ZnodeSearchProfileFieldValueFactor vf on vf.SearchProfileId =b.SearchProfileId
			WHERE b.SearchProfileId=@SearchProfileId

			IF EXISTS (SELECT TOP 1 1 FROM #ZnodeSearchProfile)
			BEGIN 
				INSERT INTO ZnodePublishSearchProfileEntity(
					SearchProfilePublishLogId,SearchProfileId,SearchProfileName,ZnodeCatalogId,FeaturesList,
					QueryTypeName,SearchQueryType,
					QueryBuilderClassName,SubQueryType,FieldValueFactor,Operator,SearchProfileAttributeMappingJson,
					CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT SearchProfilePublishLogId,SearchProfileId,ProfileName,PublishCatalogId,FeaturesList,
					QueryTypeName,SearchQueryTypeId  ,
					QueryBuilderClassName,SubQueryTypeName,FieldValueFactor,Operator,SearchProfileAttributeMappingJson,
					CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
				FROM #ZnodeSearchProfile 
		
				UPDATE ZnodeSearchProfilePublishLog
				SET PublishstateId = dbo.Fn_GetPublishStateIdForPublish()
				WHERE SearchProfilePublishLogId = @SearchProfilePublishLogId

				UPDATE ZnodeSearchProfile
				SET PublishStateId = dbo.Fn_GetPublishStateIdForPublish() 
				WHERE SearchProfileId = @SearchProfileId

				UPDATE ZnodePublishSearchProfileEntity 
				SET PublishstateId = dbo.Fn_GetPublishStateIdForPublish() 
				WHERE SearchProfileId = @SearchProfileId 

				DELETE
				FROM ZnodePublishSearchProfileEntity
				WHERE SearchProfilePublishLogId  < @SearchProfilePublishLogId AND SearchProfileId = @SearchProfileId
				SELECT CAST(1 AS BIT) Status
			END
			ELSE
			BEGIN
				UPDATE ZnodeSearchProfilePublishLog 
				SET PublishstateId = dbo.Fn_GetPublishStateIdForPublishFailed() 
				WHERE SearchProfilePublishLogId = @SearchProfilePublishLogId 

				SELECT CAST(0 AS BIT) Status 

				UPDATE ZnodeSearchProfile 
				SET PublishstateId = dbo.Fn_GetPublishStateIdForPublishFailed() 
				WHERE SearchProfileId = @SearchProfileId 
		
	     		UPDATE ZnodePublishSearchProfileEntity 
				SET PublishstateId = dbo.Fn_GetPublishStateIdForPublishFailed() 
				WHERE SearchProfileId = @SearchProfileId
			END
		END
	END TRY

	BEGIN CATCH
		UPDATE ZnodeSearchProfile 
		SET PublishstateId = dbo.Fn_GetPublishStateIdForPublishFailed() 
		WHERE SearchProfileId = @SearchProfileId 

		UPDATE ZnodeSearchProfilePublishLog 
		SET PublishstateId = dbo.Fn_GetPublishStateIdForPublishFailed() 
		WHERE SearchProfilePublishLogId = @SearchProfilePublishLogId AND SearchProfileId = @SearchProfileId
		
		UPDATE ZnodePublishSearchProfileEntity 
		SET PublishstateId = dbo.Fn_GetPublishStateIdForPublishFailed() 
		WHERE SearchProfileId = @SearchProfileId 

		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(),
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
				@ErrorLine VARCHAR(100)= ERROR_LINE(), 
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishSearchProfileEntity @SearchProfileId = '+CAST(@SearchProfileId AS VARCHAR(10))+',@UserId='+CAST(@UserId AS VARCHAR(10));

		SELECT CAST(0 AS BIT) Status

		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_PublishSearchProfileEntity',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH
END

GO

UPDATE ZnodeSearchProfileAttributeMapping
SET IsNgramEnabled='true', ModifiedDate=GETDATE()
WHERE SearchProfileId=(SELECT TOP 1 SearchProfileId FROM ZnodeSearchProfile WHERE ProfileName='ZnodeSearchProfile')
	AND AttributeCode IN ('ProductName','Brand','SKU')

GO

insert into ZnodeCMSContentPages(PortalId,CMSTemplateId,PageName,ActivationDate,ExpirationDate,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsPublished,PublishStateId) 
select ZP.PortalId , (select top 1 CMSTemplateId from ZnodeCMSTemplate where name = '404'),'404', null,null,1,2,getdate(),2,getdate(),0,1 
from ZnodePortal ZP 
where StoreCode in ('MaxwellsHardware','MaxwellsPowerTools','MaxwellsSafetyGear')
and not exists(select * from ZnodeCMSContentPages x where x.PortalId = ZP.PortalId and x.CMSTemplateId = (select top 1 CMSTemplateId from ZnodeCMSTemplate where name = '404') 
and x.PageName = '404' ) 

insert into ZnodeCMSContentPagesLocale(CMSContentPagesId,LocaleId,PageTitle,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
select CMSContentPagesId,1,'404',2,getdate(),2,getdate() 
from ZnodeCMSContentPages a 
where a.PageName = '404' and not exists(select * from ZnodeCMSContentPagesLocale x where x.CMSContentPagesId = a.CMSContentPagesId and x.LocaleId = 1 )
and PortalId in (select PortalId from ZnodePortal where StoreCode in ('MaxwellsHardware','MaxwellsPowerTools','MaxwellsSafetyGear'))

insert into ZnodeCMSContentPageGroupMapping(CMSContentPageGroupId,CMSContentPagesId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
select (select top 1 CMSContentPageGroupId from ZnodeCMSContentPageGroup where ParentCMSContentPageGroupId = (select top 1 CMSContentPageGroupId from ZnodeCMSContentPageGroup where Code = 'Root') and Code = 'Maxwell Hardware'),     
(select top 1 CMSContentPagesId from ZnodeCMSContentPages where PortalId = (select top 1 PortalId from ZnodePortal where StoreCode = 'MaxwellsHardware') and     
CMSTemplateId = (select top 1 CMSTemplateId from ZnodeCMSTemplate where name = '404')     and PageName = '404' ),     2,getdate(),2,getdate() 
where not exists(select * from ZnodeCMSContentPageGroupMapping where CMSContentPageGroupId = (select top 1 CMSContentPageGroupId from ZnodeCMSContentPageGroup where ParentCMSContentPageGroupId = (select top 1 CMSContentPageGroupId from ZnodeCMSContentPageGroup where Code = 'Root') and Code = 'Maxwell Hardware')     
and CMSContentPagesId = (select top 1 CMSContentPagesId from ZnodeCMSContentPages where PortalId = (select top 1 PortalId from ZnodePortal where StoreCode = 'MaxwellsHardware') 
and     CMSTemplateId = (select top 1 CMSTemplateId from ZnodeCMSTemplate where name = '404')     and PageName = '404' ))
and exists(select top 1 CMSContentPageGroupId from ZnodeCMSContentPageGroup where ParentCMSContentPageGroupId = (select top 1 CMSContentPageGroupId from ZnodeCMSContentPageGroup where Code = 'Root') and Code = 'Maxwell Hardware')
and exists(select top 1 CMSContentPagesId from ZnodeCMSContentPages where PortalId = (select top 1 PortalId from ZnodePortal where StoreCode = 'MaxwellsHardware') and     
CMSTemplateId = (select top 1 CMSTemplateId from ZnodeCMSTemplate where name = '404')     and PageName = '404' )

insert into ZnodeCMSContentPageGroupMapping(CMSContentPageGroupId,CMSContentPagesId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
select (select top 1 CMSContentPageGroupId from ZnodeCMSContentPageGroup where ParentCMSContentPageGroupId = (select top 1 CMSContentPageGroupId from ZnodeCMSContentPageGroup where Code = 'Root') and Code = 'Maxwell Hardware'),     
(select top 1 CMSContentPagesId from ZnodeCMSContentPages where PortalId = (select top 1 PortalId from ZnodePortal where StoreCode = 'MaxwellsPowerTools') and     
CMSTemplateId = (select top 1 CMSTemplateId from ZnodeCMSTemplate where name = '404')     and PageName = '404' ),     2,getdate(),2,getdate() 
where not exists(select * from ZnodeCMSContentPageGroupMapping where CMSContentPageGroupId = (select top 1 CMSContentPageGroupId from ZnodeCMSContentPageGroup where ParentCMSContentPageGroupId = (select top 1 CMSContentPageGroupId from ZnodeCMSContentPageGroup where Code = 'Root') and Code = 'Maxwell Hardware')     
and CMSContentPagesId = (select top 1 CMSContentPagesId from ZnodeCMSContentPages where PortalId = (select top 1 PortalId from ZnodePortal where StoreCode = 'MaxwellsPowerTools') 
and     CMSTemplateId = (select top 1 CMSTemplateId from ZnodeCMSTemplate where name = '404')     and PageName = '404' ))
and exists(select top 1 CMSContentPageGroupId from ZnodeCMSContentPageGroup where ParentCMSContentPageGroupId = (select top 1 CMSContentPageGroupId from ZnodeCMSContentPageGroup where Code = 'Root') and Code = 'Maxwell Hardware')
and exists(select top 1 CMSContentPagesId from ZnodeCMSContentPages where PortalId = (select top 1 PortalId from ZnodePortal where StoreCode = 'MaxwellsPowerTools') and     
CMSTemplateId = (select top 1 CMSTemplateId from ZnodeCMSTemplate where name = '404')     and PageName = '404' )

insert into ZnodeCMSContentPageGroupMapping(CMSContentPageGroupId,CMSContentPagesId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
select (select top 1 CMSContentPageGroupId from ZnodeCMSContentPageGroup where ParentCMSContentPageGroupId = (select top 1 CMSContentPageGroupId from ZnodeCMSContentPageGroup where Code = 'Root') and Code = 'Maxwell Hardware'),     
(select top 1 CMSContentPagesId from ZnodeCMSContentPages where PortalId = (select top 1 PortalId from ZnodePortal where StoreCode = 'MaxwellsSafetyGear') and     
CMSTemplateId = (select top 1 CMSTemplateId from ZnodeCMSTemplate where name = '404')     and PageName = '404' ),     2,getdate(),2,getdate() 
where not exists(select * from ZnodeCMSContentPageGroupMapping where CMSContentPageGroupId = (select top 1 CMSContentPageGroupId from ZnodeCMSContentPageGroup where ParentCMSContentPageGroupId = (select top 1 CMSContentPageGroupId from ZnodeCMSContentPageGroup where Code = 'Root') and Code = 'Maxwell Hardware')     
and CMSContentPagesId = (select top 1 CMSContentPagesId from ZnodeCMSContentPages where PortalId = (select top 1 PortalId from ZnodePortal where StoreCode = 'MaxwellsSafetyGear') 
and     CMSTemplateId = (select top 1 CMSTemplateId from ZnodeCMSTemplate where name = '404')     and PageName = '404' ))
and exists(select top 1 CMSContentPageGroupId from ZnodeCMSContentPageGroup where ParentCMSContentPageGroupId = (select top 1 CMSContentPageGroupId from ZnodeCMSContentPageGroup where Code = 'Root') and Code = 'Maxwell Hardware')
and exists(select top 1 CMSContentPagesId from ZnodeCMSContentPages where PortalId = (select top 1 PortalId from ZnodePortal where StoreCode = 'MaxwellsPowerTools') and     
CMSTemplateId = (select top 1 CMSTemplateId from ZnodeCMSTemplate where name = '404')     and PageName = '404' )

insert into [ZnodeCMSTextWidgetConfiguration]
(LocaleId
,CMSWidgetsId
,WidgetsKey
,CMSMappingId
,TypeOFMapping
,Text
,CreatedBy
,CreatedDate
,ModifiedBy
,ModifiedDate)
select 1,(select top 1 CMSWidgetsId from ZnodeCMSWidgets where code = 'TextEditor'),'7771123',CMSContentPagesId,'ContentPageMapping'
,'<div>&nbsp; &nbsp; &lt;div &gt;<br>&nbsp; &nbsp; &nbsp; &nbsp; &lt;h3 class="text-center"&gt;Page not found&lt;/h3&gt;<br>&nbsp; &nbsp; &lt;/div&gt;</div>',2,getdate(),2,getdate()
from ZnodeCMSContentPages a where PageName = '404'
and PortalId in (select PortalId from ZnodePortal where StoreCode in ('MaxwellsHardware','MaxwellsPowerTools','MaxwellsSafetyGear'))
and not exists(select * from [ZnodeCMSTextWidgetConfiguration] b where b.CMSMappingId = a.CMSContentPagesId and b.LocaleId=1 and WidgetsKey = '7771123'
and b.CMSWidgetsId = (select top 1 CMSWidgetsId from ZnodeCMSWidgets where code = 'TextEditor')
and TypeOFMapping = 'ContentPageMapping')

insert into ZnodeCMSSeoDetail(CMSSEOTypeId
,SEOId
,IsRedirect
,MetaInformation
,PortalId
,SEOUrl
,CreatedBy
,CreatedDate
,ModifiedBy
,ModifiedDate
,IsPublish
,SEOCode
,PublishStateId)
select (select top 1 CMSSEOTypeId from ZnodeCMSSEOType WHERE Name = 'Content Page'),null,0,null,PortalId,'404',2,getdate(),2,getdate(),0,'404',2
from ZnodePortal a
where StoreCode in ('MaxwellsHardware','MaxwellsPowerTools','MaxwellsSafetyGear') and
not exists(select * from ZnodeCMSSeoDetail b where CMSSEOTypeId = (select top 1 CMSSEOTypeId from ZnodeCMSSEOType WHERE Name = 'Content Page')
and a.PortalId = b.PortalId and SEOUrl = '404')

insert into ZnodeCMSSeoDetailLocale(CMSSEODetailId
,LocaleId
,SEOTitle
,SEODescription
,SEOKeywords
,CreatedBy
,CreatedDate
,ModifiedBy
,ModifiedDate
,CanonicalURL
,RobotTag)
select a.CMSSEODetailId,1,null,null,null,2,getdate(),2,getdate(),'404','None'
from ZnodeCMSSeoDetail A WHERE CMSSEOTypeId = (select top 1 CMSSEOTypeId from ZnodeCMSSEOType WHERE Name = 'Content Page')
and SEOUrl = '404'
and not exists(select * from ZnodeCMSSeoDetailLocale b where a.CMSSEODetailId = b.CMSSEODetailId and b.LocaleId = 1)
and a.PortalId in (select PortalId from ZnodePortal where StoreCode in ('MaxwellsHardware','MaxwellsPowerTools','MaxwellsSafetyGear'))


GO

Update ZnodePaymentSetting set IsActive = 0
where isnull(PaymentGatewayId,0) in (select PaymentGatewayId from ZnodePaymentGateway WHERE GatewayCode = 'cybersource')

GO

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=200, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode IN ('AccountCode','AccountName','AddressName','CompanyName','Address1','Address2') AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='Account' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=100, ValidationName = 'MaxCharacters',ControlName = 'Number'  
WHERE AttributeCode ='CategoryCode' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='CatalogCategoryAssociation' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)


insert into ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
select 'Text','SEOFriendlyPageName',(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Brands'),0,'Number','MaxCharacters',
null,'100','',null,2,getdate(),2,getdate(),8
where not exists(select * from ZnodeImportAttributeValidation where AttributeTypeName ='Text' and AttributeCode = 'SEOFriendlyPageName' 
      and ControlName = 'Number' and ImportHeadId=(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Brands')
      and ValidationName = 'MaxCharacters')

 INSERT INTO ZnodeImportAttributeValidation (AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,
	ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Text','Phonenumber',
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Account'),0,'Number','MaxCharacters',
	NULL,'30','',NULL,2,GETDATE(),2,GETDATE(),16
WHERE NOT EXISTS(SELECT * FROM ZnodeImportAttributeValidation 
				WHERE AttributeTypeName ='Text' AND AttributeCode = 'Phonenumber'
					AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Account')
					AND ControlName = 'Number' AND ValidationName = 'MaxCharacters'
				)

INSERT INTO ZnodeImportAttributeValidation (AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,
	ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Text','SynonymCode',
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Synonyms'),0,'Number','MaxCharacters',
	NULL,'100','',NULL,2,GETDATE(),2,GETDATE(),2
WHERE NOT EXISTS(SELECT * FROM ZnodeImportAttributeValidation 
				WHERE AttributeTypeName ='Text' AND AttributeCode = 'SynonymCode'
					AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Synonyms')
					AND ControlName = 'Number' AND ValidationName = 'MaxCharacters'
				)

				

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=100, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode ='AccountCode'
AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='Customer' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)


UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=100, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode ='AccountCode'
AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='Account' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)


UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=100, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode ='AccountName' 
AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='Account' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetQuoteOrderTemplateDetail')
	DROP PROC Znode_GetQuoteOrderTemplateDetail
GO

CREATE PROCEDURE [dbo].[Znode_GetQuoteOrderTemplateDetail]
(   
	@WhereClause NVARCHAR(MAX),
	@Rows        INT           = 100,
	@PageNo      INT           = 1,
	@Order_BY    VARCHAR(100)  = '',
	@UserId		 INT,										 
	@RowsCount   INT OUT
)
AS 
/*
		Summary :- this procedure is used to find QuoteOrderTemplate details 
	    SELECT * FROM ZnodeUser  WHERE AspNeTUSerId = 'ae464cfc-95d3-40de-bf71-47993fabb41f'
		SELECT * FROM AspNetUserRoles WHERE RoleID = 'A529A670-F446-45EC-BBCB-C00D64D7C964' Userid = '50fe1032-e810-4606-b522-ebf1559e81cf'
		SELECT * FROM AspNetRoles WHERE ID = '8622E90D-7652-41E7-8563-5DED4CC671DE'

		Unit Testing 
		EXEC Znode_GetQuoteOrderTemplateDetail '',@RowsCount = 0, @Order_BY = '', @UserId = 85
*/
BEGIN
    BEGIN TRY
        SET NOCOUNT ON;
		DECLARE @SQL NVARCHAR(MAX);
		DECLARE @TBL_QuoteOrderTemplate TABLE (OmsTemplateId INT,PortalId INT,UserId INT,TemplateName NVARCHAR(1000),CreatedBy INT,CreatedDate DATETIME
		,ModifiedBy INT,ModifiedDate DATETIME,Items INT,RowId INT,CountNo INT )
		DECLARE @AccountId VARCHAR(2000) ,@UsersId VARCHAR(2000), @ProcessType  varchar(50)='Template'
		-- SELECT * FROM aspnetRoles
			
		--SET @UsersId = SUBSTRING (( SELECT ','+CAST(userId AS VARCHAr(50))  FROM Fn_GetRecurciveUserId(@UserId,@ProcessType) FOR XML PATH ('')),2,4000)
			
		SELECT distinct ZPAVL.AttributeValue as SKU, ZPADV.AttributeDefaultValueCode  
		INTO #SKU_ProductType
		FROM ZnodePimAttributeValue ZPAV
		Inner Join ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		Inner Join ZnodePimAttribute ZPA ON ZPAV.PimAttributeId = ZPA.PimAttributeId
		Inner Join ZnodePimAttributeValue ZPAV1 ON ZPAV.PimProductId = ZPAV1.PimProductId
		Inner Join ZnodePimProductAttributeDefaultValue ZPPADV ON ZPAV1.PimAttributeValueId = ZPPADV.PimAttributeValueId
		Inner Join ZnodePimAttribute ZPA1 ON ZPAV1.PimAttributeId = ZPA1.PimAttributeId
		Inner Join ZnodePimAttributeDefaultValue ZPADV ON ZPPADV.PimAttributeDefaultValueId = ZPADV.PimAttributeDefaultValueId
		WHERE ZPA.AttributeCode = 'SKU' AND ZPA1.AttributeCode = 'ProductType'
		AND EXISTS (select * from ZnodeOmsTemplate ZOT
                        INNER JOIN ZnodeOmsTemplateLineItem ZOTL ON(ZOTL.OmsTemplateId = ZOT.OmsTemplateId)
						where ZOT.userid = @UserId AND ZPAVL.AttributeValue = ZOTL.SKU )

			SET @SQL = '
					; WITH CTE_GetOrderTemplate
						AS (
						    SELECT ZOT.OmsTemplateId,ZOT.PortalId,ZOT.UserId,ZOT.TemplateName,ZOT.CreatedBy,ZOT.CreatedDate,ZOT.ModifiedBy,ZOT.ModifiedDate,
							      SUM(case when AttributeDefaultValueCode in ( ''BundleProduct'') AND ParentOmsTemplateLineItemId IS nULL 
											then ZOTL.Quantity
											when AttributeDefaultValueCode in ( ''SimpleProduct'') AND ParentOmsTemplateLineItemId IS nULL 
											then ZOTL.Quantity
											when AttributeDefaultValueCode in ( ''SimpleProduct'',''ConfigurableProduct'',''GroupProduct'') and  ZOOLIRT.Name  in 
											(''Simple'',''Group'',''Configurable'')and   ParentOmsTemplateLineItemId IS NOT NULL 
											then ZOTL.Quantity
											else 0
									end ) Items, ZOT.TemplateType 
							FROM ZnodeOmsTemplate ZOT
                            LEFT JOIN ZnodeOmsTemplateLineItem ZOTL ON(ZOTL.OmsTemplateId = ZOT.OmsTemplateId)
							Left Join #SKU_ProductType SP ON  ZOTL.SKU = SP.SKU
							left join ZnodeOmsOrderLineItemRelationshipType ZOOLIRT ON ZOTL.OrderLineItemRelationshipTypeId = ZOOLIRT.OrderLineItemRelationshipTypeId
							WHERE ZOT.userid = '+cast(@UserId as varchar(10))+'  
							GROUP BY ZOT.OmsTemplateId,ZOT.PortalId,ZOT.UserId,ZOT.TemplateName,ZOT.CreatedBy,ZOT.CreatedDate,ZOT.ModifiedBy,ZOT.ModifiedDate,ZOT.TemplateType 						  
						  
						    )
					, CTE_GetQuoteOrderDetails AS
					(
						SELECT DISTINCT  OmsTemplateId,PortalId,UserId,TemplateName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Items
						,'+dbo.Fn_GetPagingRowId(@Order_BY,'OmsTemplateId DESC,UserId')+',Count(*)Over() CountNo
						FROM CTE_GetOrderTemplate
						WHERE 1=1 
				        '+dbo.Fn_GetFilterWhereClause(@WhereClause)+'					  
						
					)

					SELECT OmsTemplateId,PortalId,UserId,TemplateName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Items,RowId,CountNo
					FROM CTE_GetQuoteOrderDetails
					'+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows)

					Print @sql
					INSERT INTO @TBL_QuoteOrderTemplate (OmsTemplateId,PortalId,UserId,TemplateName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Items,RowId,CountNo)
					EXEC(@SQL)

					SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM @TBL_QuoteOrderTemplate),0)
   
					SELECT OmsTemplateId,PortalId,UserId,TemplateName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Items
					FROM @TBL_QuoteOrderTemplate 
	END TRY
	BEGIN CATCH
		 
		DECLARE @Status BIT ;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetQuoteOrderTemplateDetail @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@UserId= '+CAST(@UserId AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
        SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
        EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_GetQuoteOrderTemplateDetail',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH
END

GO

INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'Search','PublishSearchProfile',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'Search' and ActionName = 'PublishSearchProfile')

INSERT INTO ZnodeActionMenu ( MenuId,        ActionId,        CreatedBy ,CreatedDate,        ModifiedBy, ModifiedDate )
SELECT 
 (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'SITE SEARCH' AND ControllerName = 'SearchReport')        
    ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Search' and ActionName = 'PublishSearchProfile') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = 
     (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'SITE SEARCH' AND ControllerName = 'SearchReport') and ActionId = 
     (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Search' and ActionName = 'PublishSearchProfile'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId,        ActionId, AccessPermissionId,        CreatedBy ,CreatedDate,        ModifiedBy, ModifiedDate )
SELECT 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'SITE SEARCH' AND ControllerName = 'SearchReport'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Search' and ActionName = 'PublishSearchProfile')        
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS 
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'SITE SEARCH' AND ControllerName = 'SearchReport') and ActionId = 
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Search' and ActionName = 'PublishSearchProfile'))


INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'Search','GetUnassociatedCatalogList',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'Search' and ActionName = 'GetUnassociatedCatalogList')

INSERT INTO ZnodeActionMenu ( MenuId,        ActionId,        CreatedBy ,CreatedDate,        ModifiedBy, ModifiedDate )
SELECT 
 (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'SITE SEARCH' AND ControllerName = 'SearchReport')        
    ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Search' and ActionName = 'GetUnassociatedCatalogList') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = 
     (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'SITE SEARCH' AND ControllerName = 'SearchReport') and ActionId = 
     (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Search' and ActionName = 'GetUnassociatedCatalogList'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId,        ActionId, AccessPermissionId,        CreatedBy ,CreatedDate,        ModifiedBy, ModifiedDate )
SELECT 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'SITE SEARCH' AND ControllerName = 'SearchReport'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Search' and ActionName = 'GetUnassociatedCatalogList')        
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS 
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'SITE SEARCH' AND ControllerName = 'SearchReport') and ActionId = 
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Search' and ActionName = 'GetUnassociatedCatalogList'))

